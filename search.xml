<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>éšè¯­Secretflowâ€”æºç ç¼–è¯‘å®‰è£…ä½“éªŒ</title>
      <link href="/2025/09/24/%E9%9A%90%E8%AF%ADSecretflow%E2%80%94%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85%E4%BD%93%E9%AA%8C/"/>
      <url>/2025/09/24/%E9%9A%90%E8%AF%ADSecretflow%E2%80%94%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85%E4%BD%93%E9%AA%8C/</url>
      
        <content type="html"><![CDATA[<h1 id="éšè¯­Secretflowâ€”æºç ç¼–è¯‘å®‰è£…ä½“éªŒ"><a href="#éšè¯­Secretflowâ€”æºç ç¼–è¯‘å®‰è£…ä½“éªŒ" class="headerlink" title="éšè¯­Secretflowâ€”æºç ç¼–è¯‘å®‰è£…ä½“éªŒ"></a>éšè¯­Secretflowâ€”æºç ç¼–è¯‘å®‰è£…ä½“éªŒ</h1><blockquote><p>å®˜æ–¹å¿«é€Ÿå¼€å§‹æ–‡æ¡£ï¼š<a href="https://www.secretflow.org.cn/zh-CN/docs/secretflow/v1.12.0b0/getting_started/installation#option-3-from-source">https://www.secretflow.org.cn/zh-CN/docs/secretflow/v1.12.0b0/getting_started/installation#option-3-from-source</a></p></blockquote><p>å®˜æ–¹æä¾›å››ç§æ–¹å¼å®‰è£…SecretFlowã€‚æˆ‘ä½¿ç”¨çš„è®¾å¤‡æ˜¯ï¼šMac M4ï½œmacOS Sequoia15.6.1ï¼Œå·²å®‰è£…anacondaã€‚</p><p>æˆ‘æœ€æ—©æ˜¯å¸Œæœ›å°è¯•ä½¿ç”¨æºç æ–¹å¼å®‰è£…çš„ï¼Œç„¶åå‡ºç°äº†äº›é—®é¢˜ï¼Œè™½ç„¶è§£å†³äº†ä½†æ˜¯éœ€è¦å®‰è£…ä¸€äº›å…¶ä»–è½¯ä»¶å·¥å…·ï¼Œæ‰€ä»¥è¿˜æ˜¯æ¯”è¾ƒéº»çƒ¦çš„ã€‚</p><p>æˆ‘ä¹Ÿè¯•äº† pypi æ–¹å¼ï¼Œè¿™ç§æ–¹å¼æœ€ç®€å•ã€‚å¦‚æœä¸æ”¹æºç çš„æƒ…å†µï¼Œç”¨è¿™ç§æ–¹å¼å®Œå…¨å¯ä»¥ã€‚ä¸‹é¢æˆ‘ä¸¤ç§æ–¹å¼éƒ½å†™äº†ã€‚</p><h2 id="1-ä»pypiå®‰è£…"><a href="#1-ä»pypiå®‰è£…" class="headerlink" title="1.ä»pypiå®‰è£…"></a>1.ä»pypiå®‰è£…</h2><p>è¿™å—ç›´æ¥å‚ç…§å®˜æ–¹çš„å®‰è£…è¯´æ˜å³å¯ï¼Œéå¸¸ç®€å•ã€‚</p><blockquote><p><a href="https://www.secretflow.org.cn/zh-CN/docs/secretflow/v1.12.0b0/getting_started/installation#option-3-from-source">https://www.secretflow.org.cn/zh-CN/docs/secretflow/v1.12.0b0/getting_started/installation#option-3-from-source</a></p><p>è¯·æ³¨æ„pythonç‰ˆæœ¬éœ€è¦æ˜¯3.10ï¼Œä½ å¯ä»¥ç”¨condaæ„å»ºä¸€ä¸ªè™šæ‹Ÿç¯å¢ƒã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;conda create -n sf python=3.10</span><br><span class="line">&gt;conda activate sf</span><br></pre></td></tr></table></figure><p>ä¹‹åï¼Œè¯·ä½¿ç”¨pipå®‰è£…SecretFlowã€‚</p><ul><li>å®Œå…¨ç‰ˆæœ¬</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;pip install -U secretflow</span><br></pre></td></tr></table></figure><ul><li>Liteç‰ˆæœ¬</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;pip install -U secretflow-lite</span><br></pre></td></tr></table></figure></blockquote><p>å®‰è£…è¿‡ç¨‹ä¸­ï¼Œæˆ‘æ²¡æœ‰é‡åˆ°ä»»ä½•é—®é¢˜ã€‚ç„¶åæˆ‘ä¹Ÿä½¿ç”¨å®˜æ–¹æä¾›çš„æµ‹è¯•æ¡ˆä¾‹ï¼Œå¼•å…¥ä½¿ç”¨äº†secretflowåŒ…ã€‚</p><blockquote><p>ä½ çš„ç¬¬ä¸€ä¸ªSecretFlowç¨‹åºã€‚</p><p>å¯¼å…¥secretflowåŒ…ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import secretflow as sf</span><br></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ªåŒ…å«Aliceã€Bobå’ŒCarolçš„æœ¬åœ°é›†ç¾¤ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; sf.init(parties=[&#x27;alice&#x27;, &#x27;bob&#x27;, &#x27;carol&#x27;], address=&#x27;local&#x27;)</span><br></pre></td></tr></table></figure><p>åˆ›å»ºAliceçš„PYUè®¾å¤‡ï¼Œå¯ä»¥å¤„ç†å¥¹çš„æ•°æ®ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; alice_device = sf.PYU(&#x27;alice&#x27;)</span><br></pre></td></tr></table></figure><p>è®©Aliceè¯´â€œHello Worldâ€ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; message_from_alice = alice_device(lambda x:x)(&quot;Hello World!&quot;)</span><br></pre></td></tr></table></figure><p>æ‰“å°æ¶ˆæ¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; message_from_alice</span><br><span class="line">&lt;secretflow.device.device.pyu.PYUObject object at 0x7fdec24a15b0&gt;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çœ‹åˆ°Aliceè®¾å¤‡ä¸Šçš„æ¶ˆæ¯æ˜¯ä¸€ä¸ªPYUå¯¹è±¡ï¼Œåœ¨æ§åˆ¶ç¨‹åºä¸­ã€‚</p><p>é€šè¿‡æ­ç¤ºæ¶ˆæ¯ï¼Œåœ¨æ§åˆ¶ç¨‹åºä¸­æ‰“å°æ–‡æœ¬ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; print(sf.reveal(message_from_alice))</span><br><span class="line">Hello World!</span><br></pre></td></tr></table></figure></blockquote><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/image-20250924140004853.png" alt="image-20250924140004853"></p><p>åœ¨æˆ‘ä»¬åˆ›å»ºçš„sfç¯å¢ƒä¸­ï¼Œä½¿ç”¨ jupyter ç„¶åè¾“å…¥æ¡ˆä¾‹ä»£ç ï¼Œå‘ç°å‡ ä¸ªå…³é”®è¾“å‡ºéƒ½æ˜¯ç¬¦åˆå®˜æ–¹æ–‡æ¡£çš„ã€‚ä¸è¿‡å¤šäº†ä¸¤ä¸ªæŠ¥é”™ï¼š</p><ul><li><p>ç¼ºå°‘ <code>ipywidgets</code> åŒ…å¯¼è‡´è¿›åº¦æ¡ï¼ˆtqdmï¼‰å’Œ Notebook äº¤äº’åŠŸèƒ½å—é™ï¼›</p></li><li><p><code>os.fork()</code> ä¸ JAX å¤šçº¿ç¨‹å­˜åœ¨å…¼å®¹æ€§è­¦å‘Šï¼ˆæš‚ä¸å½±å“æ ¸å¿ƒåŠŸèƒ½ï¼‰</p></li></ul><p>  <code>os.fork()</code>ï¼ˆåˆ›å»ºå­è¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨ï¼‰ä¸ JAX çš„å¤šçº¿ç¨‹æœºåˆ¶å¯èƒ½å†²çªï¼Œç†è®ºä¸Šå¯èƒ½å¯¼è‡´æ­»é”ï¼Œä½†åœ¨å¤§å¤šæ•° SecretFlow çš„å¸¸è§„ä½¿ç”¨åœºæ™¯ä¸­ï¼ˆå¦‚æœ¬åœ°æ¨¡æ‹Ÿã€ç®€å•åˆ†å¸ƒå¼ä»»åŠ¡ï¼‰ï¼Œè¿™ä¸ªè­¦å‘Šä¸ä¼šå½±å“å®é™…åŠŸèƒ½ï¼Œæš‚æ—¶å¯ä»¥å¿½ç•¥ã€‚å¦‚æœåç»­å‡ºç°æ­»é”é—®é¢˜ï¼Œå†é’ˆå¯¹æ€§è°ƒæ•´ JAX çš„çº¿ç¨‹é…ç½®ï¼ˆå¦‚ <code>JAX_THREADS=1</code> é™åˆ¶å•çº¿ç¨‹ï¼‰ã€‚</p><p>ç¬¬ä¸€ä¸ªé—®é¢˜å¾ˆå¥½è§£å†³ï¼Œå®‰è£… ipywidgetsä¸‹å°±å¯ä»¥ã€‚ç¬¬äºŒä¸ªæš‚æ—¶å¿½ç•¥ï¼Œä¸å½±å“ç›®å‰ä½¿ç”¨ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… ipywidgetsï¼ˆåŒæ—¶æ›´æ–°ä¾èµ–ï¼‰</span></span><br><span class="line">pip install -U ipywidgets</span><br></pre></td></tr></table></figure><h2 id="2-ä»æºç å®‰è£…"><a href="#2-ä»æºç å®‰è£…" class="headerlink" title="2.ä»æºç å®‰è£…"></a>2.ä»æºç å®‰è£…</h2><p>è¿™å—å…ˆåˆ—ä¸€ä¸‹å®˜æ–¹çš„å®‰è£…è¯´æ˜</p><blockquote><p>1.ä¸‹è½½æºç å¹¶å»ºç«‹Pythonè™šæ‹Ÿç¯å¢ƒ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/secretflow/secretflow.git</span><br><span class="line">cd secretflow</span><br><span class="line"></span><br><span class="line">conda create -n secretflow python=3.10</span><br><span class="line">conda activate secretflow</span><br></pre></td></tr></table></figure><p>2.å®‰è£…SecretFlow</p><ul><li>å®Œå…¨ç‰ˆæœ¬</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python setup.py bdist_wheel</span><br><span class="line"></span><br><span class="line">pip install dist/*.whl</span><br></pre></td></tr></table></figure><ul><li>ç²¾ç®€ç‰ˆæœ¬</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python setup.py bdist_wheel --lite</span><br><span class="line"></span><br><span class="line">pip install dist/*.whl</span><br></pre></td></tr></table></figure></blockquote><h3 id="2-1-æ„å»ºå®‰è£…æ‰©å±•çŸ¥è¯†äº†è§£"><a href="#2-1-æ„å»ºå®‰è£…æ‰©å±•çŸ¥è¯†äº†è§£" class="headerlink" title="2.1 æ„å»ºå®‰è£…æ‰©å±•çŸ¥è¯†äº†è§£"></a>2.1 æ„å»ºå®‰è£…æ‰©å±•çŸ¥è¯†äº†è§£</h3><p>æ‰©å±•è¯´ä¸€ä¸‹secretflowæ„å»ºçš„ä¸€äº›çŸ¥è¯†ï¼Œå¯ä»¥å¸®åŠ©ä¸äº†è§£pythonæ„å»ºçš„åŒå­¦äº†è§£ä¸‹ã€‚</p><p>æ„å»ºè¿‡ç¨‹ï¼š</p><ul><li>Python åŒ…çš„æ„å»ºæ˜¯é€šè¿‡ setup.py æ–‡ä»¶é…ç½®çš„ï¼Œè¿™ä¸ªæ–‡ä»¶ä½¿ç”¨ setuptools åº“æ¥å®šä¹‰åŒ…çš„å…ƒæ•°æ®å’Œæ„å»ºè§„åˆ™</li><li>å½“æ‰§è¡Œ python setup.py bdist_wheel æ—¶ï¼Œsetuptools ä¼šæ ¹æ® setup.py ä¸­çš„é…ç½®åˆ›å»ºä¸€ä¸ª wheel æ ¼å¼çš„åˆ†å‘åŒ…</li></ul><p>SecretFlow é¡¹ç›®çš„æ„å»ºç‰¹ç‚¹ ï¼š</p><ul><li>ä» setup.py å¯ä»¥çœ‹å‡ºï¼ŒSecretFlow æœ‰ä¸¤ç§æ„å»ºæ¨¡å¼ï¼šå®Œæ•´ç‰ˆå’Œç²¾ç®€ç‰ˆï¼ˆliteï¼‰</li><li>æ„å»ºæ—¶ä¼šåŠ¨æ€æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ—¥æœŸã€æ„å»ºæ—¶é—´å’Œ Git æäº¤ ID</li><li>é¡¹ç›®ä½¿ç”¨ <strong>Bazel æ¥æ„å»º C&#x2F;C++ æ‰©å±•</strong>ï¼ˆext_modulesï¼‰</li><li>æ ¹æ®ä¸åŒå¹³å°ï¼ˆmacOSã€Linuxï¼‰ä¼šç”Ÿæˆä¸åŒçš„ wheel åŒ…</li></ul><p>æ„å»ºæ­¥éª¤ ï¼š</p><ul><li>è§£æå‘½ä»¤è¡Œå‚æ•°ï¼ˆå¦‚ â€“lite é€‰é¡¹ï¼‰</li><li>è¯»å–å¹¶è¿‡æ»¤ä¾èµ–é¡¹ï¼ˆrequirements.txtï¼‰</li><li>æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶</li><li>ç¼–è¯‘ C&#x2F;C++ æ‰©å±•ï¼ˆå¦‚æœæœ‰ï¼‰</li><li>æ”¶é›† Python æ¨¡å—å’ŒåŒ…</li><li>ç”Ÿæˆ wheel æ–‡ä»¶åˆ° dist ç›®å½•</li></ul><p>å®‰è£…è¿‡ç¨‹ ï¼š</p><ul><li>å½“æ‰§è¡Œ pip install dist&#x2F;*.whl æ—¶ï¼Œpip ä¼šå®‰è£… dist ç›®å½•ä¸‹çš„ wheel åŒ…</li><li>å®‰è£…è¿‡ç¨‹ä¸éœ€è¦å†æ¬¡ç¼–è¯‘ï¼Œç›´æ¥å¤åˆ¶æ–‡ä»¶åˆ° Python ç¯å¢ƒä¸­</li><li>å®‰è£…åï¼Œå¯ä»¥ç›´æ¥å¯¼å…¥å’Œä½¿ç”¨è¿™ä¸ªåŒ…</li></ul><h3 id="2-2-å®æ“"><a href="#2-2-å®æ“" class="headerlink" title="2.2 å®æ“"></a>2.2 å®æ“</h3><p>å‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/secretflow/secretflow.git</span><br><span class="line"><span class="built_in">cd</span> secretflow</span><br><span class="line"></span><br><span class="line">conda create -n secretflow python=3.10</span><br><span class="line">conda activate secretflow</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™äº›éƒ½æ­£å¸¸æ“ä½œï¼Œæ²¡æœ‰é—®é¢˜ã€‚ç„¶åè®°å¾—é€‰æ‹© è¿œç¨‹ä»“åº“releaseä¸‹çš„1.13.xåˆ†æ”¯æˆ–è€…1.14.xï¼ˆæˆ‘æœ¬æ¬¡ä½¿ç”¨çš„æ˜¯mainåˆ†æ”¯ï¼Œå®ƒæ˜¯1.14.xç‰ˆæœ¬çš„ï¼‰ã€‚ä¸åŒç‰ˆæœ¬å¯èƒ½å¯¹pythonç‰ˆæœ¬è¦æ±‚ä¸ä¸€æ ·ï¼Œæ‰€ä»¥è¿™å—æ³¨æ„ä¸‹ã€‚</p><p>ç„¶åæ‰§è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python setup.py bdist_wheel</span><br></pre></td></tr></table></figure><p>æˆ‘è¿™é‡ŒæŠ¥é”™äº†ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">running build_ext</span><br><span class="line">bazel build //secretflow_lib/binding:_lib.so --symlink_prefix=build/temp.macosx-11.1-arm64-cpython-310/bazel- --compilation_mode=opt</span><br><span class="line">error: <span class="built_in">command</span> <span class="string">&#x27;bazel&#x27;</span> failed: No such file or directory</span><br></pre></td></tr></table></figure><p>å› ä¸ºé¡¹ç›®ä½¿ç”¨Bazelæ¥æ„å»ºçš„C&#x2F;C++ æ‰©å±•ï¼Œè€Œæˆ‘å¹¶æ²¡æœ‰å®‰è£…è¿‡Bazelã€‚</p><h3 id="2-3-å®‰è£…Bazel"><a href="#2-3-å®‰è£…Bazel" class="headerlink" title="2.3 å®‰è£…Bazel"></a>2.3 å®‰è£…Bazel</h3><blockquote><p>Bazelå®˜æ–¹æ–‡æ¡£ï¼š<a href="https://bazel.build/install/os-x?hl=zh-cn#install-on-mac-os-x-homebrew">https://bazel.build/install/os-x?hl=zh-cn#install-on-mac-os-x-homebrew</a></p></blockquote><p>Bazelå®˜æ–¹æ˜¯å»ºè®®ä½¿ç”¨ bazelisk æ¥å®‰è£…ä½¿ç”¨bazelçš„ï¼Œè¿™ä¸ªç¡®å®æ˜¯æ¯”è¾ƒæ–¹ä¾¿çš„ã€‚æˆ‘æœ‰è¯•è¿‡å…¶ä»–ä¸¤ç§æ–¹å¼çš„ï¼š</p><ul><li>ä½¿ç”¨äºŒè¿›åˆ¶å®‰è£…ç¨‹åºè¿›è¡Œå®‰è£…ï¼Œå¯¹æ¯”ç¡®å®è¦éº»çƒ¦ä¸€äº›ï¼Œç„¶åè¿˜éœ€è¦ä¸‹è½½Xcode</li><li>ä½¿ç”¨Homebrew å®‰è£… Bazel è½¯ä»¶åŒ…ã€‚çœ‹ç€ç®€å•ï¼Œä½†æ˜¯ brew é‡Œçš„ç‰ˆæœ¬éƒ½æ˜¯æ¯”è¾ƒæ–°çš„ï¼Œsecretflow 1.14.x éœ€è¦ä½¿ç”¨çš„æ˜¯bazel 6.5.0æ²¡æ‰¾åˆ°ã€‚ç„¶åå¤ªé«˜ç‰ˆæœ¬çš„bazelï¼Œæˆ‘æ„å»ºçš„æ—¶å€™æŠ¥é”™ã€‚</li></ul><p>å®‰è£…bazeliskï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install bazelisk</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(secretflow) kxr@Mac secretflow % brew install bazelisk</span><br><span class="line">==&gt; Fetching downloads <span class="keyword">for</span>: bazelisk</span><br><span class="line">==&gt; Fetching bazelisk</span><br><span class="line">==&gt; Downloading https://mirrors.aliyun.com/homebrew/homebrew-bottles/bazelisk-</span><br><span class="line">Already downloaded: /Users/kxr/Library/Caches/Homebrew/downloads/74dd8be5821f56d64883464d891016635439cc387c71e3164e242feee80e5d23--bazelisk-1.26.0.arm64_sequoia.bottle.tar.gz</span><br><span class="line">==&gt; Pouring bazelisk-1.26.0.arm64_sequoia.bottle.tar.gz</span><br><span class="line">ğŸº  /opt/homebrew/Cellar/bazelisk/1.26.0: 8 files, 5.9MB</span><br><span class="line">==&gt; Running `brew cleanup bazelisk`...</span><br><span class="line">Disable this behaviour by setting `HOMEBREW_NO_INSTALL_CLEANUP=1`.</span><br><span class="line">Hide these hints with `HOMEBREW_NO_ENV_HINTS=1` (see `man brew`).</span><br><span class="line">==&gt; No outdated dependents to upgrade!</span><br><span class="line">==&gt; Caveats</span><br><span class="line">zsh completions have been installed to:</span><br><span class="line">  /opt/homebrew/share/zsh/site-functions</span><br></pre></td></tr></table></figure><p>å®‰è£…å¥½ä¹‹åï¼Œåœ¨Secretflowé¡¹ç›®æ–‡ä»¶å¤¹å†…å…¶å®æœ‰ä¸€ä¸ª<code>.bazelversion</code>æ–‡ä»¶ï¼Œbazeliskä¼šè‡ªå·±è¯†åˆ«è¿™ä¸ªæ–‡ä»¶ï¼Œç„¶åé€‰æ‹©ä½¿ç”¨å“ªä¸ªç‰ˆæœ¬çš„Bazelã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(secretflow) kxr@Mac secretflow % bazel --version      </span><br><span class="line">bazel 6.5.0</span><br></pre></td></tr></table></figure><p>bazelå®‰è£…å¥½ä¹‹åï¼Œé‡æ–°è¿›è¡Œæ„å»ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python setup.py bdist_wheel</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°è¾“å‡ºæœ‰å¦‚ä¸‹å†…å®¹ï¼Œå°±æ²¡æœ‰é—®é¢˜å•¦ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Installing collected packages: secretflow</span><br><span class="line">Successfully installed secretflow-1.14.0.dev20250924</span><br></pre></td></tr></table></figure><p>ç„¶åå°±å¯ä»¥æ­£å¸¸åœ¨jupyterä¸­ä½¿ç”¨çš„äº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> éšç§è®¡ç®— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> éšç§è®¡ç®— </tag>
            
            <tag> SecretFlow </tag>
            
            <tag> Python </tag>
            
            <tag> Bazel </tag>
            
            <tag> æºç ç¼–è¯‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Zeppelin æºç ç¼–è¯‘æ„å»ºä¸æ‰“åŒ…éƒ¨ç½²</title>
      <link href="/2025/09/17/Zeppelin%20%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91%E6%9E%84%E5%BB%BA%E4%B8%8E%E6%89%93%E5%8C%85%E9%83%A8%E7%BD%B2/"/>
      <url>/2025/09/17/Zeppelin%20%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91%E6%9E%84%E5%BB%BA%E4%B8%8E%E6%89%93%E5%8C%85%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<h1 id="Zeppelin-æºç ç¼–è¯‘æ„å»ºä¸æ‰“åŒ…éƒ¨ç½²"><a href="#Zeppelin-æºç ç¼–è¯‘æ„å»ºä¸æ‰“åŒ…éƒ¨ç½²" class="headerlink" title="Zeppelin æºç ç¼–è¯‘æ„å»ºä¸æ‰“åŒ…éƒ¨ç½²"></a>Zeppelin æºç ç¼–è¯‘æ„å»ºä¸æ‰“åŒ…éƒ¨ç½²</h1><blockquote><p>å®˜æ–¹ç½‘ç«™ï¼š<a href="https://zeppelin.apache.org/">https://zeppelin.apache.org/</a></p><p>githubä»“åº“ï¼š<a href="https://github.com/apache/zeppelin">https://github.com/apache/zeppelin</a></p><p>å®˜æ–¹æ„å»ºè¯´æ˜æ–‡æ¡£ï¼š<a href="https://zeppelin.apache.org/docs/0.12.0/setup/basics/how_to_build.html">https://zeppelin.apache.org/docs/0.12.0/setup/basics/how_to_build.html</a></p></blockquote><h2 id="ä¸€ã€èƒŒæ™¯ï¼š"><a href="#ä¸€ã€èƒŒæ™¯ï¼š" class="headerlink" title="ä¸€ã€èƒŒæ™¯ï¼š"></a>ä¸€ã€èƒŒæ™¯ï¼š</h2><p>æœ¬æ–‡æ˜¯ä¸ºäº†è®°å½•å­¦ä¹  Zeppelin çš„ç¼–è¯‘æ„å»ºä»¥åŠdebugçš„è¿‡ç¨‹çš„ã€‚è¿‡ç¨‹ä¸­é‡åˆ°äº†ä¸å°‘é—®é¢˜ï¼Œè™½ç„¶æœ€ç»ˆéƒ½è§£å†³äº†ï¼Œä½†æ˜¯æˆ‘å»ºè®®åœ¨çœŸæ­£å¼€å§‹æ„å»ºä¸äº†è§£æºç ä¹‹å‰ï¼Œä¸€å®šå…ˆè¯»è¯» Zeppelinçš„æä¾›çš„è¿™ä¸¤ä¸ªæ–‡æ¡£ï¼Œè€Œä¸ä»…æ˜¯æ„å»ºæ–‡æ¡£ã€‚</p><ul><li><a href="https://zeppelin.apache.org/docs/0.12.0/usage/interpreter/interpreter_binding_mode.html">https://zeppelin.apache.org/docs/0.12.0/usage/interpreter/interpreter_binding_mode.html</a></li><li><a href="https://zeppelin.apache.org/docs/0.12.0/interpreter/spark.html#zeppelincontext">https://zeppelin.apache.org/docs/0.12.0/interpreter/spark.html#zeppelincontext</a></li></ul><p>é‡Œé¢æœ‰ä»‹ç»äº† interpreterè¿è¡Œæœºåˆ¶ã€Zeppelin Configurationç­‰ç­‰ã€‚</p><h2 id="äºŒã€ç¼–è¯‘æ„å»º"><a href="#äºŒã€ç¼–è¯‘æ„å»º" class="headerlink" title="äºŒã€ç¼–è¯‘æ„å»º"></a>äºŒã€ç¼–è¯‘æ„å»º</h2><h3 id="2-1-æ­¥éª¤"><a href="#2-1-æ­¥éª¤" class="headerlink" title="2.1 æ­¥éª¤"></a>2.1 æ­¥éª¤</h3><p>1ï¼‰å‡†å¤‡è¦æ±‚ï¼š</p><table><thead><tr><th align="center">Name</th><th align="center">Value</th></tr></thead><tbody><tr><td align="center">Git</td><td align="center">(Any Version)</td></tr><tr><td align="center">Maven</td><td align="center">3.6.3 or higher</td></tr><tr><td align="center">OpenJDK or Oracle JDK</td><td align="center">1.8 (151+) (set JAVA_HOME)</td></tr></tbody></table><p>æˆ‘ä½¿ç”¨çš„æ˜¯ <code>jdk11</code>ã€‚jdkç‰ˆæœ¬æœ€å¥½ä¸è¦å¤ªé«˜äº†ï¼Œæˆ‘ä¸€å¼€å§‹ç”¨çš„jdk21å°±ç¼–è¯‘å‡ºé—®é¢˜äº†ã€‚</p><p>2ï¼‰ä¸‹æ‹‰æºç </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/apache/zeppelin.git</span><br></pre></td></tr></table></figure><p>3ï¼‰ç¼–è¯‘æºç </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./mvnw clean package -DskipTests </span><br></pre></td></tr></table></figure><p>4ï¼‰å¯åŠ¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/zeppelin-daemon.sh start</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šæ˜¯ä»€ä¹ˆéƒ½ä¸å‡ºé—®é¢˜çš„æ­¥éª¤ ğŸ˜‚ï¼Œå®é™…ä¸Šå¯èƒ½ä¼šå‡ºç°é—®é¢˜</p><h3 id="2-2-é‡åˆ°çš„é—®é¢˜"><a href="#2-2-é‡åˆ°çš„é—®é¢˜" class="headerlink" title="2.2 é‡åˆ°çš„é—®é¢˜"></a>2.2 é‡åˆ°çš„é—®é¢˜</h3><p>1ï¼‰spark-3.5.3-bin-without-hadoop.tgz æŸå</p><p>æŠ¥é”™ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[ERROR] Failed to execute goal com.googlecode.maven-download-plugin:download-maven-plugin:1.6.0:wget (download-sparkr-files) on project r: IO Error: Error while expanding /Users/kxr/learning/zeppelin/rlang/target/spark-3.5.3-bin-without-hadoop.tgz: Unexpected end of ZLIB input stream -&gt; [Help 1]</span><br><span class="line">[ERROR] </span><br><span class="line">[ERROR] To see the full stack trace of the errors, re-run Maven with the -e switch.</span><br><span class="line">[ERROR] Re-run Maven using the -X switch to enable full debug logging.</span><br><span class="line">[ERROR] </span><br><span class="line">[ERROR] For more information about the errors and possible solutions, please read the following articles:</span><br><span class="line">[ERROR] [Help 1] http://cwiki.apache.org/confluence/display/MAVEN/MojoExecutionException</span><br><span class="line">[ERROR] </span><br><span class="line">[ERROR] After correcting the problems, you can resume the build with the command</span><br><span class="line">[ERROR]   mvn &lt;args&gt; -rf :r</span><br></pre></td></tr></table></figure><p>åŸå› ï¼šmavençš„ä¸‹è½½æ’ä»¶ä¸‹è½½ä¸‹æ¥çš„ spark-3.5.3-bin-without-hadoop.tgz æ˜¯æŸåçš„ã€‚åº”è¯¥æ˜¯mavenä¸‹è½½ä¸­é€”åœæ­¢äº†ï¼Œå¯¼è‡´å…¶å®ä¸‹è½½ä¸‹æ¥çš„ä¸å®Œæ•´ï¼ˆ233MBï¼‰ï¼Œå®Œæ•´çš„åº”è¯¥æ˜¯300MBå·¦å³ã€‚</p><p>Mavenä¸‹è½½æ’ä»¶çš„ç¼“å­˜ç›®å½•ä½äº <code>/Users/kxr/.m2/repository/.cache/download-maven-plugin/</code></p><p>å°†åŸå…ˆmavenç¼“å­˜çš„æŸåçš„spark-3.5.3-bin-without-hadoop.tgzç»™åˆ é™¤æ‰ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -f /Users/kxr/.m2/repository/.cache/download-maven-plugin/spark-3.5.3-bin-without-hadoop.tgz_cab0a2ce6ec48d96124c50359f3fb6a1</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ç”¨æµè§ˆå™¨å•ç‹¬ä¸‹è½½äº†spark-3.5.3-bin-without-hadoop.tgzï¼Œç„¶åå°†å¤åˆ¶å¹¶é‡å‘½åä¸º <code>/Users/kxr/.m2/repository/.cache/download-maven-plugin/spark-3.5.3-bin-without-hadoop.tgz_cab0a2ce6ec48d96124c50359f3fb6a1</code></p><p>å°±è¿™æ ·æ¥äº†ä¸€ä¸ªå·æ¢æ¢æŸ±å“ˆå“ˆã€‚ç„¶åå°±å¯ä»¥å•ç‹¬æ„å»ºä¸€ä¸‹å‡ºé—®é¢˜çš„ rlangæ¨¡å—è¯•ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./mvnw clean install -pl rlang -DskipTests</span><br></pre></td></tr></table></figure><p>å‘ç°æ²¡é—®é¢˜äº†ï¼</p><p>ç„¶åç»§ç»­ä»rlangæ¨¡å—å¼€å§‹ç»§ç»­å®Œæˆå…¨éƒ¨æ„å»º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./mvnw clean install -DskipTests -Dmaven.wagon.http.ssl.insecure=true -Dmaven.wagon.http.ssl.allowall=true -rf rlang</span><br></pre></td></tr></table></figure><p>2ï¼‰jdkç‰ˆæœ¬å¯¼è‡´çš„ç¼–è¯‘æŠ¥é”™</p><p>ç„¶åç„¶ååˆå‡ºç°æ–°çš„æŠ¥é”™äº†ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">INFO] ------------------------------------------------------------------------</span><br><span class="line">[ERROR] Failed to execute goal net.alchim31.maven:scala-maven-plugin:4.9.2:compile (scala-compile-first) on project flink1.15-shims: scala compilation failed -&gt; [Help 1]</span><br><span class="line">[ERROR] </span><br><span class="line">[ERROR] To see the full stack trace of the errors, re-run Maven with the -e switch.</span><br><span class="line">[ERROR] Re-run Maven using the -X switch to enable full debug logging.</span><br><span class="line">[ERROR] </span><br><span class="line">[ERROR] For more information about the errors and possible solutions, please read the following articles:</span><br><span class="line">[ERROR] [Help 1] http://cwiki.apache.org/confluence/display/MAVEN/MojoFailureException</span><br><span class="line">[ERROR] </span><br><span class="line">[ERROR] After correcting the problems, you can resume the build with the command</span><br><span class="line">[ERROR]   mvn &lt;args&gt; -rf :flink1.15-shims</span><br></pre></td></tr></table></figure><p>è¿›ä¸€æ­¥è·å–ç»†èŠ‚æŠ¥é”™ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./mvnw clean install -pl flink/flink1.15-shims -e</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">[ERROR] Failed to execute goal net.alchim31.maven:scala-maven-plugin:4.9.2:compile (scala-compile-first) on project flink1.15-shims: scala compilation failed -&gt; [Help 1]</span><br><span class="line">org.apache.maven.lifecycle.LifecycleExecutionException: Failed to execute goal net.alchim31.maven:scala-maven-plugin:4.9.2:compile (scala-compile-first) on project flink1.15-shims: scala compilation failed</span><br><span class="line">    at org.apache.maven.lifecycle.internal.MojoExecutor.doExecute2 (MojoExecutor.java:333)</span><br><span class="line">    at org.apache.maven.lifecycle.internal.MojoExecutor.doExecute (MojoExecutor.java:316)</span><br><span class="line">    at org.apache.maven.lifecycle.internal.MojoExecutor.execute (MojoExecutor.java:212)</span><br><span class="line">    at org.apache.maven.lifecycle.internal.MojoExecutor.execute (MojoExecutor.java:174)</span><br><span class="line">    at org.apache.maven.lifecycle.internal.MojoExecutor.access$000 (MojoExecutor.java:75)</span><br><span class="line">    at org.apache.maven.lifecycle.internal.MojoExecutor$1.run (MojoExecutor.java:162)</span><br><span class="line">    at org.apache.maven.plugin.DefaultMojosExecutionStrategy.execute (DefaultMojosExecutionStrategy.java:39)</span><br><span class="line">    at org.apache.maven.lifecycle.internal.MojoExecutor.execute (MojoExecutor.java:159)</span><br><span class="line">    at org.apache.maven.lifecycle.internal.LifecycleModuleBuilder.buildProject (LifecycleModuleBuilder.java:105)</span><br><span class="line">    at org.apache.maven.lifecycle.internal.LifecycleModuleBuilder.buildProject (LifecycleModuleBuilder.java:73)</span><br><span class="line">    at org.apache.maven.lifecycle.internal.builder.singlethreaded.SingleThreadedBuilder.build (SingleThreadedBuilder.java:53)</span><br><span class="line">    at org.apache.maven.lifecycle.internal.LifecycleStarter.execute (LifecycleStarter.java:118)</span><br><span class="line">    at org.apache.maven.DefaultMaven.doExecute (DefaultMaven.java:261)</span><br><span class="line">    at org.apache.maven.DefaultMaven.doExecute (DefaultMaven.java:173)</span><br><span class="line">    at org.apache.maven.DefaultMaven.execute (DefaultMaven.java:101)</span><br><span class="line">    at org.apache.maven.cli.MavenCli.execute (MavenCli.java:906)</span><br><span class="line">    at org.apache.maven.cli.MavenCli.doMain (MavenCli.java:283)</span><br><span class="line">    at org.apache.maven.cli.MavenCli.main (MavenCli.java:206)</span><br><span class="line">    at jdk.internal.reflect.DirectMethodHandleAccessor.invoke (DirectMethodHandleAccessor.java:103)</span><br><span class="line">    at java.lang.reflect.Method.invoke (Method.java:580)</span><br><span class="line">    at org.codehaus.plexus.classworlds.launcher.Launcher.launchEnhanced (Launcher.java:255)</span><br><span class="line">    at org.codehaus.plexus.classworlds.launcher.Launcher.launch (Launcher.java:201)</span><br><span class="line">    at org.codehaus.plexus.classworlds.launcher.Launcher.mainWithExitCode (Launcher.java:361)</span><br><span class="line">    at org.codehaus.plexus.classworlds.launcher.Launcher.main (Launcher.java:314)</span><br><span class="line">    at jdk.internal.reflect.DirectMethodHandleAccessor.invoke (DirectMethodHandleAccessor.java:103)</span><br><span class="line">    at java.lang.reflect.Method.invoke (Method.java:580)</span><br><span class="line">    at org.apache.maven.wrapper.BootstrapMainStarter.start (BootstrapMainStarter.java:52)</span><br><span class="line">    at org.apache.maven.wrapper.WrapperExecutor.execute (WrapperExecutor.java:161)</span><br><span class="line">    at org.apache.maven.wrapper.MavenWrapperMain.main (MavenWrapperMain.java:73)</span><br><span class="line">Caused by: org.apache.maven.plugin.MojoFailureException: scala compilation failed</span><br><span class="line">    at scala_maven.ScalaCompilerSupport.doExecute (ScalaCompilerSupport.java:89)</span><br><span class="line">    at scala_maven.ScalaMojoSupport.execute (ScalaMojoSupport.java:310)</span><br><span class="line">    at scala_maven.ScalaCompileMojo.execute (ScalaCompileMojo.java:108)</span><br><span class="line">    at org.apache.maven.plugin.DefaultBuildPluginManager.executeMojo (DefaultBuildPluginManager.java:126)</span><br><span class="line">    at org.apache.maven.lifecycle.internal.MojoExecutor.doExecute2 (MojoExecutor.java:328)</span><br><span class="line">    at org.apache.maven.lifecycle.internal.MojoExecutor.doExecute (MojoExecutor.java:316)</span><br><span class="line">    at org.apache.maven.lifecycle.internal.MojoExecutor.execute (MojoExecutor.java:212)</span><br><span class="line">    at org.apache.maven.lifecycle.internal.MojoExecutor.execute (MojoExecutor.java:174)</span><br><span class="line">    at org.apache.maven.lifecycle.internal.MojoExecutor.access$000 (MojoExecutor.java:75)</span><br><span class="line">    at org.apache.maven.lifecycle.internal.MojoExecutor$1.run (MojoExecutor.java:162)</span><br><span class="line">    at org.apache.maven.plugin.DefaultMojosExecutionStrategy.execute (DefaultMojosExecutionStrategy.java:39)</span><br><span class="line">    at org.apache.maven.lifecycle.internal.MojoExecutor.execute (MojoExecutor.java:159)</span><br><span class="line">    at org.apache.maven.lifecycle.internal.LifecycleModuleBuilder.buildProject (LifecycleModuleBuilder.java:105)</span><br><span class="line">    at org.apache.maven.lifecycle.internal.LifecycleModuleBuilder.buildProject (LifecycleModuleBuilder.java:73)</span><br><span class="line">    at org.apache.maven.lifecycle.internal.builder.singlethreaded.SingleThreadedBuilder.build (SingleThreadedBuilder.java:53)</span><br><span class="line">    at org.apache.maven.lifecycle.internal.LifecycleStarter.execute (LifecycleStarter.java:118)</span><br><span class="line">    at org.apache.maven.DefaultMaven.doExecute (DefaultMaven.java:261)</span><br><span class="line">    at org.apache.maven.DefaultMaven.doExecute (DefaultMaven.java:173)</span><br><span class="line">    at org.apache.maven.DefaultMaven.execute (DefaultMaven.java:101)</span><br><span class="line">    at org.apache.maven.cli.MavenCli.execute (MavenCli.java:906)</span><br><span class="line">    at org.apache.maven.cli.MavenCli.doMain (MavenCli.java:283)</span><br><span class="line">    at org.apache.maven.cli.MavenCli.main (MavenCli.java:206)</span><br><span class="line">    at jdk.internal.reflect.DirectMethodHandleAccessor.invoke (DirectMethodHandleAccessor.java:103)</span><br><span class="line">    at java.lang.reflect.Method.invoke (Method.java:580)</span><br><span class="line">    at org.codehaus.plexus.classworlds.launcher.Launcher.launchEnhanced (Launcher.java:255)</span><br><span class="line">    at org.codehaus.plexus.classworlds.launcher.Launcher.launch (Launcher.java:201)</span><br><span class="line">    at org.codehaus.plexus.classworlds.launcher.Launcher.mainWithExitCode (Launcher.java:361)</span><br><span class="line">    at org.codehaus.plexus.classworlds.launcher.Launcher.main (Launcher.java:314)</span><br><span class="line">    at jdk.internal.reflect.DirectMethodHandleAccessor.invoke (DirectMethodHandleAccessor.java:103)</span><br><span class="line">    at java.lang.reflect.Method.invoke (Method.java:580)</span><br><span class="line">    at org.apache.maven.wrapper.BootstrapMainStarter.start (BootstrapMainStarter.java:52)</span><br><span class="line">    at org.apache.maven.wrapper.WrapperExecutor.execute (WrapperExecutor.java:161)</span><br><span class="line">    at org.apache.maven.wrapper.MavenWrapperMain.main (MavenWrapperMain.java:73)</span><br></pre></td></tr></table></figure><p>å‘ç°é”™è¯¯çš„æ ¹æœ¬åŸå› æ˜¯ Java ç‰ˆæœ¬ä¸å…¼å®¹ ã€‚</p><ul><li><p>1.é”™è¯¯ä¿¡æ¯ scala.reflect.internal.MissingRequirementError: object java.lang.Object in compiler mirror not found è¡¨æ˜ Scala ç¼–è¯‘å™¨æ— æ³•æ‰¾åˆ° Java å¯¹è±¡ï¼Œè¿™é€šå¸¸æ˜¯ç”±äº Java ç‰ˆæœ¬ä¸å…¼å®¹å¯¼è‡´çš„ã€‚</p></li><li><p>2.é€šè¿‡æŸ¥çœ‹é¡¹ç›®çš„ POM æ–‡ä»¶ï¼Œæˆ‘å‘ç°ï¼š</p><p>é¡¹ç›®çš„æ ¹ POM æ–‡ä»¶ä¸­æŒ‡å®šäº† Java ç‰ˆæœ¬ä¸º 11 ( &lt;java.version&gt;11&lt;&#x2F;java.version&gt; )</p><p>Flink æ¨¡å—ä½¿ç”¨çš„ Scala ç‰ˆæœ¬ä¸º 2.12.7</p><p>ä½¿ç”¨çš„ scala-maven-plugin ç‰ˆæœ¬ä¸º 4.9.2</p></li></ul><p>é¢ï¼Œæ˜¯æˆ‘å¿˜è®°è°ƒ Java SDKäº†ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export JAVA_HOME=$(/usr/libexec/java_home -v 11)</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./mvnw clean install -pl flink/flink1.15-shims -DskipTests</span><br></pre></td></tr></table></figure><p>å‘ç°ç¼–è¯‘æ²¡é—®é¢˜ï¼Œç»§ç»­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./mvnw clean install -DskipTests -Dmaven.wagon.http.ssl.insecure=true -Dmaven.wagon.http.ssl.allowall=true -rf flink/flink1.15-shims</span><br></pre></td></tr></table></figure><p>3ï¼‰flink&#x2F;flink-scala-2.12 ç¼–è¯‘æŠ¥é”™</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[ERROR] Failed to execute goal net.alchim31.maven:scala-maven-plugin:4.9.2:compile (scala-compile-first) on project flink-scala-2.12: scala compilation failed -&gt; [Help 1]</span><br><span class="line">[ERROR] </span><br><span class="line">[ERROR] To see the full stack trace of the errors, re-run Maven with the -e switch.</span><br><span class="line">[ERROR] Re-run Maven using the -X switch to enable full debug logging.</span><br><span class="line">[ERROR] </span><br><span class="line">[ERROR] For more information about the errors and possible solutions, please read the following articles:</span><br><span class="line">[ERROR] [Help 1] http://cwiki.apache.org/confluence/display/MAVEN/MojoFailureException</span><br><span class="line">[ERROR] </span><br><span class="line">[ERROR] After correcting the problems, you can resume the build with the command</span><br><span class="line">[ERROR]   mvn &lt;args&gt; -rf :flink-scala-2.12</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæŠ¥é”™ï¼Œæˆ‘å½“æ—¶ä¹Ÿæ²¡æ³¨æ„å…·ä½“æ’æŸ¥ï¼Œå°±æ˜¯æ‰§è¡Œäº†ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># å®‰è£… Flink çˆ¶çº§ POM</span><br><span class="line">cd flink &amp;&amp; ../mvnw install -N</span><br></pre></td></tr></table></figure><p>å¥½åƒå°±ä¿®å¤å¥½äº†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./mvnw clean install -DskipTests -Dmaven.wagon.http.ssl.insecure=true -Dmaven.wagon.http.ssl.allowall=true -rf flink/flink-scala-2.12</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./mvnw clean install -DskipTests</span><br></pre></td></tr></table></figure><p>4ï¼‰ç±»æ‰¾ä¸åˆ°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">WARN [2025-09-16 22:04:50,334] (&#123;FIFO-RemoteInterpreter-spark-shared_process-shared_session-1&#125; NotebookServer.java[onStatusChange]:1963) - Job paragraph_1758022969766_1777889232 is finished, status: ERROR, exception: null, result: %text org.apache.zeppelin.interpreter.InterpreterException: org.apache.zeppelin.interpreter.InterpreterException: Fail to open SparkInterpreter</span><br><span class="line">at org.apache.zeppelin.interpreter.LazyOpenInterpreter.open(LazyOpenInterpreter.java:77)</span><br><span class="line">at org.apache.zeppelin.interpreter.remote.RemoteInterpreterServer$InterpretJob.jobRun(RemoteInterpreterServer.java:808)</span><br><span class="line">at org.apache.zeppelin.interpreter.remote.RemoteInterpreterServer$InterpretJob.jobRun(RemoteInterpreterServer.java:716)</span><br><span class="line">at org.apache.zeppelin.scheduler.Job.run(Job.java:187)</span><br><span class="line">at org.apache.zeppelin.scheduler.AbstractScheduler.runJob(AbstractScheduler.java:136)</span><br><span class="line">at org.apache.zeppelin.scheduler.FIFOScheduler.lambda$runJobInScheduler$0(FIFOScheduler.java:42)</span><br><span class="line">at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)</span><br><span class="line">at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)</span><br><span class="line">at java.base/java.lang.Thread.run(Thread.java:834)</span><br><span class="line">Caused by: org.apache.zeppelin.interpreter.InterpreterException: Fail to open SparkInterpreter</span><br><span class="line">at org.apache.zeppelin.spark.SparkInterpreter.open(SparkInterpreter.java:140)</span><br><span class="line">at org.apache.zeppelin.interpreter.LazyOpenInterpreter.open(LazyOpenInterpreter.java:71)</span><br><span class="line">... 8 more</span><br><span class="line">Caused by: java.lang.NullPointerException</span><br><span class="line">at org.apache.zeppelin.spark.SparkInterpreter.loadSparkScalaInterpreter(SparkInterpreter.java:171)</span><br><span class="line">at org.apache.zeppelin.spark.SparkInterpreter.open(SparkInterpreter.java:123)</span><br><span class="line">... 9 more</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./mvnw clean package -pl spark/scala-2.12 -DskipTests</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Users/kxr/learning/zeppelin/zeppelin-server/src/main/java/org/apache/zeppelin/rest/CredentialRestApi.java:36:32</span><br><span class="line">æ‰¾ä¸åˆ°ç¬¦å·</span><br><span class="line">ç¬¦å·:   ç±» Credentials</span><br><span class="line">ä½ç½®: ç¨‹åºåŒ… org.apache.zeppelin.user</span><br><span class="line">org.apache.zeppelin.user.Credentials</span><br></pre></td></tr></table></figure><p>ä¾èµ–å­˜åœ¨é—®é¢˜ï¼Œæˆ‘å°è¯•çš„è§£å†³æ–¹æ³•æ˜¯ï¼šæ‰¾åˆ°Credentialså±äºå“ªä¸ªæ¨¡å—ï¼Œç„¶åé‡æ–°ç¼–è¯‘ä¸‹é‚£ä¸ªæ¨¡å—ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd zeppelin-zengine</span><br><span class="line">mvn clean install -DskipTests</span><br></pre></td></tr></table></figure><p>ç¡®å®è§£å†³é—®é¢˜ã€‚</p><p>ä»¥ä¸Šå°±æ˜¯æˆ‘é‡åˆ°è¿‡çš„ç¼–è¯‘é—®é¢˜ã€‚è¿™é‡Œåªæ˜¯è®°å½•ä¸‹ï¼Œä¸ä¸€å®šä¼šé‡åˆ°â€”â€”æˆ‘åé¢å‡ æ¬¡ç¼–è¯‘éƒ½æ˜¯ä¸€æ¬¡æ­£å¸¸å®Œæˆã€‚</p><h2 id="ä¸‰ã€IDEAè¿è¡Œä¸Debug"><a href="#ä¸‰ã€IDEAè¿è¡Œä¸Debug" class="headerlink" title="ä¸‰ã€IDEAè¿è¡Œä¸Debug"></a>ä¸‰ã€IDEAè¿è¡Œä¸Debug</h2><p>é—®é¢˜ä¸ä»…ä»…åœ¨ç¼–è¯‘å“¦ğŸ˜‚ å’±ä»¬ç»§ç»­ä¸‹é¢ä¹Ÿæœ‰å‘</p><h3 id="3-1-IDEAè¿è¡Œ"><a href="#3-1-IDEAè¿è¡Œ" class="headerlink" title="3.1 IDEAè¿è¡Œ"></a>3.1 IDEAè¿è¡Œ</h3><p>å¯åŠ¨ç±»ï¼š<code>org.apache.zeppelin.server.ZeppelinServer</code></p><p>ç¯å¢ƒå˜é‡ï¼š<code>ZEPPELIN_LOCAL_IP=127.0.0.1</code></p><p>VMå‚æ•°ï¼š<code>-Dzeppelin.server.rpc.port=12345</code>ï¼ˆè¿™ä¸ªå¯ä»¥ä¸å¡«ï¼Œè¿™ä¸ªæ˜¯æˆ‘æ’æŸ¥é—®é¢˜æµ‹è¯•ç”¨çš„ï¼‰</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/image-20250918163659733.png" alt="image-20250918163659733"></p><p>ç¼–è¾‘å¥½å¯åŠ¨é…ç½®ï¼Œå°±å¯ä»¥å¼€å§‹è¿è¡Œï¼Œç³»ç»Ÿå¯åŠ¨èµ·æ¥ä¹‹åè®¿é—®ï¼š<a href="http://localhost:8080/">http://localhost:8080/</a></p><p>webé¡µé¢ä¸Šæ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹å’Œç¬”è®°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">%spark</span><br><span class="line">// æŸ¥çœ‹ Spark é›†ç¾¤ä¿¡æ¯</span><br><span class="line">println(sc.master)  // åº”è¾“å‡ºè¿œç¨‹ Spark ä¸»èŠ‚ç‚¹åœ°å€</span><br><span class="line"></span><br><span class="line">// æ‰§è¡Œç®€å•è®¡ç®—ï¼ŒéªŒè¯æ˜¯å¦èƒ½æ­£å¸¸ä½¿ç”¨é›†ç¾¤èµ„æº</span><br><span class="line">val rdd = sc.parallelize(1 to 111)</span><br><span class="line">println(s&quot;RDD åˆ†åŒºæ•°ï¼š$&#123;rdd.getNumPartitions&#125;&quot;)</span><br><span class="line">println(s&quot;è®¡ç®—ç»“æœï¼š$&#123;rdd.sum()&#125;&quot;)</span><br></pre></td></tr></table></figure><p>å¯ä»¥è®¾ç½®æ–­ç‚¹ï¼š</p><ul><li>org.apache.zeppelin.scheduler.RemoteScheduler#runJobInScheduler</li><li>org.apache.zeppelin.notebook.Paragraph#jobRun</li></ul><p>ç„¶åé¡µé¢ç‚¹å‡»è¿è¡Œå›¾æ ‡ï¼Œä½ å°±å¯ä»¥debugåˆ°äº†ã€‚</p><blockquote><p>å¤‡æ³¨ï¼šè¿™é‡Œæé†’ä¸€ä¸‹ webé¡µé¢éœ€è¦é…ç½®ä¸‹sparkè§£é‡Šå™¨çš„ SPARK_HOMEï¼Œå³éœ€è¦æå‰ä¸‹è½½ä¸€ä¸ªsparkï¼ˆzeppelin0.12.0 é€‚é…spark3.3åˆ°spark3.5ï¼‰ã€‚ä½†æ˜¯å¦‚æœæˆåŠŸç¼–è¯‘ï¼Œå…¶å®zeppeliné¡¹ç›®ä¹Ÿä¼šè‡ªå·±ä¸‹è½½ä¸€ä¸ªsparkï¼Œå­˜æ”¾çš„è·¯å¾„ï¼š spark&#x2F;interpreter&#x2F;target&#x2F;spark-3.4.3-bin-without-hadoopã€‚å¯ä»¥é…ç½®è¿™ä¸ªä¹Ÿè¡Œã€‚</p><p>å¦‚æœæœ‰è‡ªå·±ä¹‹åæƒ³è¦å¯¹æ¥çš„sparké›†ç¾¤ï¼Œå¯ä»¥å•ç‹¬ä¸‹è½½å¯¹åº”çš„sparkç‰ˆæœ¬ï¼Œæ¯”å¦‚æˆ‘ç”¨çš„æ˜¯spark3.5.6</p></blockquote><h3 id="3-2-ç½‘ç»œé—®é¢˜"><a href="#3-2-ç½‘ç»œé—®é¢˜" class="headerlink" title="3.2 ç½‘ç»œé—®é¢˜"></a>3.2 ç½‘ç»œé—®é¢˜</h3><h4 id="1ï¼‰é—®é¢˜ç°è±¡ä¸è§£å†³"><a href="#1ï¼‰é—®é¢˜ç°è±¡ä¸è§£å†³" class="headerlink" title="1ï¼‰é—®é¢˜ç°è±¡ä¸è§£å†³"></a>1ï¼‰é—®é¢˜ç°è±¡ä¸è§£å†³</h4><p>åœ¨ä¸Šé¢æˆ‘debugåˆ°æ–­ç‚¹ä¹‹åï¼Œæ”¾è¡Œã€‚ä½†æ˜¯é¡µé¢ä¸€ç›´å¡åœ¨pendingçŠ¶æ€</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INFO [2025-09-17 10:14:13,663] (&#123;FIFO-RemoteInterpreter-spark-shared_process-shared_session-1&#125; ProcessLauncher.java[launch]:96) - Process is launched: [.//bin/interpreter.sh, -d, .//interpreter/spark, -c, 0.0.1.1, -p, 58194, -r, :, -i, spark-shared_process, -l, .//local-repo/spark, -g, spark]</span><br><span class="line"> INFO [2025-09-17 10:14:13,905] (&#123;Exec Stream Pumper&#125; ProcessLauncher.java[processLine]:193) - [INFO] Interpreter launch command: /Users/kxr/learning/spark/spark-3.5.6-bin-hadoop3/bin/spark-submit --class org.apache.zeppelin.interpreter.remote.RemoteInterpreterServer --driver-class-path :.//local-repo/spark/*:.//interpreter/spark/*:/Users/kxr/learning/zeppelin/zeppelin-interpreter-shaded/target/*:/Users/kxr/learning/zeppelin/zeppelin-zengine/target/test-classes/*:::/Users/kxr/learning/zeppelin/interpreter/zeppelin-interpreter-shaded-0.12.0.jar:/Users/kxr/learning/zeppelin/zeppelin-interpreter/target/classes:/Users/kxr/learning/zeppelin/zeppelin-zengine/target/test-classes:/Users/kxr/learning/zeppelin/interpreter/spark/spark-interpreter-0.12.0.jar:/Users/kxr/learning/spark/spark-3.5.6-bin-hadoop3/conf --driver-java-options   -Dfile.encoding=UTF-8 -Dlog4j.configuration=file:///Users/kxr/learning/zeppelin/conf/log4j.properties -Dlog4j.configurationFile=file:///Users/kxr/learning/zeppelin/conf/log4j2.properties -Dzeppelin.log.file=/Users/kxr/learning/zeppelin/logs/zeppelin-interpreter-spark-shared_process-kxr-kxrdeMacBook-Pro.local.log --conf spark.executor.memory=1g --conf spark.master=local[*] --conf spark.driver.memory=1g --conf spark.driver.cores=1 --conf spark.executor.cores=1 --conf spark.app.name=spark-shared_process --conf spark.executor.instances=2 --conf spark.webui.yarn.useProxy=false /Users/kxr/learning/zeppelin/interpreter/spark/spark-interpreter-0.12.0.jar 0.0.1.1 58194 spark-shared_process :</span><br><span class="line"> WARN [2025-09-17 10:14:15,677] (&#123;Exec Default Executor&#125; ExecRemoteInterpreterProcess.java[onProcessComplete]:231) - Process is exited with exit value 0</span><br><span class="line"> INFO [2025-09-17 10:14:15,677] (&#123;Exec Default Executor&#125; ProcessLauncher.java[transition]:109) - Process state is transitioned to COMPLETED</span><br></pre></td></tr></table></figure><p>ç„¶åç­‰å¾…ä¸€æ®µæ—¶é—´ä¹‹åï¼Œæœ¬åœ°logsç›®å½•ä¸‹ï¼Œå¯ä»¥å‘ç°è¿™æ ·çš„æŠ¥é”™ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">WARN [2025-09-17 16:09:13,170] (&#123;main&#125; Logging.scala[logWarning]:72) - Your hostname, kxrdeMacBook-Pro.local resolves to a loopback address: 127.0.0.1; using 192.168.231.196 instead (on interface en0)</span><br><span class="line"> WARN [2025-09-17 16:09:13,170] (&#123;main&#125; Logging.scala[logWarning]:72) - Set SPARK_LOCAL_IP if you need to bind to another address</span><br><span class="line"> INFO [2025-09-17 16:09:13,392] (&#123;RegisterThread&#125; RemoteInterpreterServer.java[run]:583) - Start registration</span><br><span class="line"> INFO [2025-09-17 16:09:13,393] (&#123;RemoteInterpreterServer-Thread&#125; RemoteInterpreterServer.java[run]:193) - Launching ThriftServer at 0.0.1.1:56799</span><br><span class="line"> INFO [2025-09-17 16:09:14,449] (&#123;RegisterThread&#125; RemoteInterpreterServer.java[run]:597) - Registering interpreter process</span><br><span class="line">ERROR [2025-09-17 16:09:14,451] (&#123;RegisterThread&#125; RemoteInterpreterServer.java[run]:601) - Error while registering interpreter: RegisterInfo(host:0.0.1.1, port:56799, interpreterGroupId:spark-shared_process), cause: &#123;&#125;</span><br><span class="line">java.lang.RuntimeException</span><br><span class="line">at org.apache.zeppelin.interpreter.remote.PooledRemoteClient.callRemoteFunction(PooledRemoteClient.java:123)</span><br><span class="line">at org.apache.zeppelin.interpreter.remote.RemoteInterpreterEventClient.callRemoteFunction(RemoteInterpreterEventClient.java:80)</span><br><span class="line">at org.apache.zeppelin.interpreter.remote.RemoteInterpreterEventClient.registerInterpreterProcess(RemoteInterpreterEventClient.java:88)</span><br><span class="line">at org.apache.zeppelin.interpreter.remote.RemoteInterpreterServer$RegisterRunnable.run(RemoteInterpreterServer.java:598)</span><br><span class="line">at java.base/java.lang.Thread.run(Thread.java:834)</span><br><span class="line"> INFO [2025-09-17 16:09:14,452] (&#123;RegisterThread&#125; RemoteInterpreterServer.java[shutdown]:233) - Unregister interpreter process</span><br><span class="line">ERROR [2025-09-17 16:09:14,452] (&#123;RegisterThread&#125; RemoteInterpreterServer.java[shutdown]:236) - Fail to unregister remote interpreter process</span><br><span class="line">java.lang.RuntimeException</span><br><span class="line">at org.apache.zeppelin.interpreter.remote.PooledRemoteClient.callRemoteFunction(PooledRemoteClient.java:123)</span><br><span class="line">at org.apache.zeppelin.interpreter.remote.RemoteInterpreterEventClient.callRemoteFunction(RemoteInterpreterEventClient.java:80)</span><br><span class="line">at org.apache.zeppelin.interpreter.remote.RemoteInterpreterEventClient.unRegisterInterpreterProcess(RemoteInterpreterEventClient.java:95)</span><br><span class="line">at org.apache.zeppelin.interpreter.remote.RemoteInterpreterServer.shutdown(RemoteInterpreterServer.java:234)</span><br><span class="line">at org.apache.zeppelin.interpreter.remote.RemoteInterpreterServer$RegisterRunnable.run(RemoteInterpreterServer.java:603)</span><br><span class="line">at java.base/java.lang.Thread.run(Thread.java:834)</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªé—®é¢˜åŸå› æ˜¯ï¼šç½‘ç»œé…ç½®é—®é¢˜ï¼Œä½¿ç”¨äº† 0.0.1.1 è¿™ä¸ªç‰¹æ®Šçš„ IP åœ°å€</p><p>è¡¨ç°ï¼šè§£é‡Šå™¨è¿›ç¨‹å¯åŠ¨ä½†æ— æ³•æ³¨å†Œåˆ° Zeppelin æœåŠ¡å™¨</p><p>ä¿®å¤ï¼šè¿™ä¸ªé—®é¢˜æˆ‘é—®äº†claude4ã€claude3.7 ã€‚ç»è¿‡å‡ æ¬¡æ‹·æ‰“ï¼Œå®ƒä»¬åŠ äº†å¾ˆå¤šçš„é…ç½®ï¼Œä¹Ÿä¿®å¤äº†é—®é¢˜ã€‚ç„¶åæˆ‘å°±æƒ³çŸ¥é“æ˜¯å“ªä¸ªé…ç½®çœŸæ­£è§£å†³äº†é—®é¢˜ã€‚</p><p>aiåŠ äº† VMå‚æ•°ã€ç¯å¢ƒå˜é‡ã€spark-env.shã€zeppelin-env.shã€zeppelin-site.xmlé…ç½®æ–‡ä»¶ç­‰ã€‚ä½†æ˜¯å®è´¨ä¸ŠçœŸæ­£è§£å†³é—®é¢˜çš„æ˜¯è¿™ä¸ªå‚æ•°ï¼š<code>ZEPPELIN_LOCAL_IP</code></p><blockquote><p>AIç»™çš„ç¯å¢ƒå˜é‡ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">JAVA_HOME=/Library/Java/JavaVirtualMachines/jdk-11.jdk/Contents/Home;</span><br><span class="line">SPARK_HOME=/Users/kxr/learning/spark/spark-3.5.6-bin-hadoop3;</span><br><span class="line">HADOOP_CONF_DIR=$SPARK_HOME/conf;</span><br><span class="line">USE_HADOOP=false;</span><br><span class="line">ZEPPELIN_ADDR=&quot;127.0.0.1&quot;;</span><br><span class="line">ZEPPELIN_PORT=8080;</span><br><span class="line">ZEPPELIN_LOCAL_IP=&quot;127.0.0.1&quot;;</span><br><span class="line">SPARK_LOCAL_IP=&quot;127.0.0.1&quot;;</span><br><span class="line">SPARK_PUBLIC_DNS=&quot;127.0.0.1&quot;;</span><br><span class="line">ZEPPELIN_JAVA_OPTS=&quot;-Dfile.encoding=UTF-8 -XX:+UseG1GC&quot;;</span><br><span class="line">ZEPPELIN_MEM=&quot;-Xms1024m -Xmx2048m -XX:MaxMetaspaceSize=512m&quot;;</span><br><span class="line">PYSPARK_PYTHON=python3;</span><br><span class="line">PYSPARK_DRIVER_PYTHON=python3;</span><br></pre></td></tr></table></figure></blockquote><p>åœ¨IDEAå¯åŠ¨é…ç½®ä¸Š æ–°å¢ç¯å¢ƒå˜é‡ï¼š<code>ZEPPELIN_LOCAL_IP=127.0.0.1</code>ï¼Œé—®é¢˜å°±ä¿®å¤å¥½äº†ã€‚</p><h4 id="2ï¼‰æ‰©å±•çŸ¥è¯†"><a href="#2ï¼‰æ‰©å±•çŸ¥è¯†" class="headerlink" title="2ï¼‰æ‰©å±•çŸ¥è¯†"></a>2ï¼‰æ‰©å±•çŸ¥è¯†</h4><p>ZEPPELIN_LOCAL_IPä¸ZEPPELIN_ADDRçš„ä½œç”¨ä¸åŒºåˆ«ï¼š</p><ol><li>zeppelin.server.addr (ZEPPELIN_ADDR):</li></ol><ul><li><p>æ§åˆ¶Zeppelin WebæœåŠ¡å™¨ç»‘å®šçš„åœ°å€</p></li><li><p>å†³å®šç”¨æˆ·é€šè¿‡å“ªä¸ªIPè®¿é—®Zeppelin Web UI</p></li><li><p>ä¸»è¦å½±å“çš„æ˜¯å¤–éƒ¨è®¿é—®ZeppelinæœåŠ¡å™¨çš„åœ°å€</p></li></ul><ol start="2"><li>zeppelin.local.ip (ZEPPELIN_LOCAL_IP):</li></ol><ul><li><p>æ§åˆ¶ZeppelinæœåŠ¡å™¨å’Œè§£é‡Šå™¨ä¹‹é—´é€šä¿¡ä½¿ç”¨çš„æœ¬åœ°IPåœ°å€</p></li><li><p>è¿™ä¸ªIPåœ°å€ä¼šè¢«ä¼ é€’ç»™è§£é‡Šå™¨è¿›ç¨‹ï¼Œç”¨äºè§£é‡Šå™¨è¿›ç¨‹å›è¿åˆ°ZeppelinæœåŠ¡å™¨</p></li><li><p>ä¸»è¦å½±å“çš„æ˜¯è§£é‡Šå™¨è¿›ç¨‹å’ŒZeppelinæœåŠ¡å™¨ä¹‹é—´çš„å†…éƒ¨é€šä¿¡</p></li></ul><p>åœ¨è°ƒè¯•è§£é‡Šå™¨è¿›ç¨‹æ—¶ï¼ŒZEPPELIN_LOCAL_IPå¾ˆé‡è¦ï¼Œå› ä¸ºå®ƒå†³å®šäº†è§£é‡Šå™¨è¿›ç¨‹å¦‚ä½•è¿æ¥å›ZeppelinæœåŠ¡å™¨ã€‚å¦‚æœè®¾ç½®ä¸æ­£ç¡®ï¼Œè§£é‡Šå™¨è¿›ç¨‹å¯èƒ½æ— æ³•è¿æ¥åˆ°ZeppelinæœåŠ¡å™¨ï¼Œå¯¼è‡´ä»£ç æ‰§è¡Œå¤±è´¥ã€‚</p><p>å®é™…ä¸Šï¼Œæ—¥å¿—ä¸­çš„InterpreterEventServer is starting at 0.0.1.1:52889ï¼Œè¿™ä¸ªIPåœ°å€å°±æ˜¯ç”±zeppelin.local.ipé…ç½®çš„ï¼Œæˆ–è€…åœ¨æ²¡æœ‰æ˜ç¡®é…ç½®æ—¶ç”±ç³»ç»Ÿè‡ªåŠ¨é€‰æ‹©çš„æœ¬åœ°IPåœ°å€ã€‚</p><h4 id="3ï¼‰åˆ¨æ ¹é—®åº•"><a href="#3ï¼‰åˆ¨æ ¹é—®åº•" class="headerlink" title="3ï¼‰åˆ¨æ ¹é—®åº•"></a>3ï¼‰åˆ¨æ ¹é—®åº•</h4><p>ä¸‹ä¸€ä¸ªé—®é¢˜æ¥äº†ï¼Ÿä¸ºä»€ä¹ˆç”¨äº† 0.0.1.1 è¿™ä¹ˆä¸ªç‰¹æ®Šip</p><p>ipç”±æ¥ï¼š</p><p>ä½¿ç”¨ <code>ifconfig</code> çœ‹åˆ°äº†çœŸçš„æœ‰ä¸ªç½‘ç»œæ¥å£æœ‰ä¸ªipæ˜¯ 0.0.1.1</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">utun7: flags=8051&lt;UP,POINTOPOINT,RUNNING,MULTICAST&gt; mtu 1500</span><br><span class="line">inet 0.0.1.1 --&gt; 28.30.0.0 netmask 0xff000000</span><br><span class="line">inet6 fe80::ac67:e0e4:5044:be4e%utun7 prefixlen 64 scopeid 0x16 </span><br><span class="line">inet6 fd0a:b001:c002:d003:c9ca:2bf3:c3e6:d3a9 prefixlen 64 </span><br><span class="line">nd6 options=201&lt;PERFORMNUD,DAD&gt;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kxr@kxrdeMacBook-Pro ~ % lsof -i | grep <span class="string">&quot;0.0.1.1&quot;</span></span><br><span class="line">aTrustAge   721            kxr   74u  IPv4 0x3c4e05689bf20a17      0t0    TCP 0.0.1.1:55224-&gt;198.18.0.2:https (ESTABLISHED)</span><br></pre></td></tr></table></figure><p>çœŸçš„æ˜¯å†¤æœ‰å¤´å€ºæœ‰ä¸»â€”â€”VPNè½¯ä»¶å¯¼è‡´çš„ã€‚é‚£ä¹ˆæ€ä¹ˆå°±ç”¨äº†è¿™ä¸ªipï¼Œä»¥åŠä¸ºä»€ä¹ˆé…ç½® ZEPPELIN_LOCAL_IP å°±å¥½äº†ã€‚</p><p>Zeppelinæºç ï¼š</p><p><code>org.apache.zeppelin.interpreter.remote.RemoteInterpreterUtils#findAvailableHostAddress</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">findAvailableHostAddress</span><span class="params">()</span> <span class="keyword">throws</span> UnknownHostException, SocketException &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">zeppelinServerIP</span> <span class="operator">=</span> System.getenv(<span class="string">&quot;ZEPPELIN_LOCAL_IP&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (zeppelinServerIP != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> zeppelinServerIP;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">InetAddress</span> <span class="variable">address</span> <span class="operator">=</span> InetAddress.getLocalHost();</span><br><span class="line">    <span class="keyword">if</span> (address.isLoopbackAddress()) &#123;</span><br><span class="line">      <span class="keyword">for</span> (NetworkInterface networkInterface : Collections</span><br><span class="line">          .list(NetworkInterface.getNetworkInterfaces())) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!networkInterface.isLoopback()) &#123;</span><br><span class="line">          <span class="keyword">for</span> (InterfaceAddress interfaceAddress : networkInterface.getInterfaceAddresses()) &#123;</span><br><span class="line">            <span class="type">InetAddress</span> <span class="variable">a</span> <span class="operator">=</span> interfaceAddress.getAddress();</span><br><span class="line">            <span class="keyword">if</span> (a <span class="keyword">instanceof</span> Inet4Address) &#123;</span><br><span class="line">              <span class="keyword">return</span> a.getHostAddress();</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> address.getHostAddress();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h3 id="3-3-debug-zeppelin-è§£é‡Šå™¨è¿›ç¨‹"><a href="#3-3-debug-zeppelin-è§£é‡Šå™¨è¿›ç¨‹" class="headerlink" title="3.3 debug zeppelin è§£é‡Šå™¨è¿›ç¨‹"></a>3.3 debug zeppelin è§£é‡Šå™¨è¿›ç¨‹</h3><h4 id="1ï¼‰èƒŒæ™¯çŸ¥è¯†"><a href="#1ï¼‰èƒŒæ™¯çŸ¥è¯†" class="headerlink" title="1ï¼‰èƒŒæ™¯çŸ¥è¯†"></a>1ï¼‰èƒŒæ™¯çŸ¥è¯†</h4><p>åœ¨ debug ç†Ÿæ‚‰ zeppelinæºç çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘å‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘debugä¸åˆ° zeppelin è§£é‡Šå™¨ çœŸæ­£æ‰§è¡Œä½œä¸šçš„ä»£ç ã€‚</p><p>è¿™ä¸ªå°±æ˜¯æˆ‘è¯´è¦å…ˆçœ‹çœ‹ zeppelinçš„æ–‡æ¡£çš„åŸå› ã€‚å¦‚æœä½ çœ‹è¿‡äº†zeppelinè§£é‡Šå™¨ç›¸å…³å†…å®¹ï¼Œå°±ä¼šå‘ç°å…¶å®zeppelinè§£é‡Šå™¨è¿è¡Œåœ¨å•ç‹¬çš„JVMè¿›ç¨‹é‡Œçš„ã€‚è€Œä¸”ä½ å¤šæ‰§è¡Œå‡ æ¬¡é¡µé¢ä½œä¸šï¼Œå°±å‘ç°ç±»ä¼¼æ—¥å¿—ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INFO [2025-09-18 17:19:28,473] (&#123;Exec Stream Pumper&#125; ProcessLauncher.java[processLine]:193) - [INFO] Interpreter launch command: /Users/kxr/learning/spark/spark-3.5.6-bin-hadoop3/bin/spark-submit --class org.apache.zeppelin.interpreter.remote.RemoteInterpreterServer --driver-class-path :.//local-repo/spark/*:.//interpreter/spark/*:/Users/kxr/learning/zeppelin/zeppelin-interpreter-shaded/target/*:/Users/kxr/learning/zeppelin/zeppelin-zengine/target/test-classes/*:::/Users/kxr/learning/zeppelin/interpreter/zeppelin-interpreter-shaded-0.12.0.jar:/Users/kxr/learning/zeppelin/zeppelin-interpreter/target/classes:/Users/kxr/learning/zeppelin/zeppelin-zengine/target/test-classes:/Users/kxr/learning/zeppelin/interpreter/spark/spark-interpreter-0.12.0.jar:/Users/kxr/learning/spark/spark-3.5.6-bin-hadoop3/conf --driver-java-options   -Dfile.encoding=UTF-8 -Dlog4j.configuration=file:///Users/kxr/learning/zeppelin/conf/log4j.properties -Dlog4j.configurationFile=file:///Users/kxr/learning/zeppelin/conf/log4j2.properties -Dzeppelin.log.file=/Users/kxr/learning/zeppelin/logs/zeppelin-interpreter-spark-shared_process-kxr-kxrdeMacBook-Pro.local.log -agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=8000 --conf spark.executor.memory=1g --conf spark.master=local[*] --conf spark.driver.memory=1g --conf spark.driver.cores=1 --conf spark.executor.cores=1 --conf spark.app.name=spark-shared_process --conf spark.executor.instances=2 --conf spark.webui.yarn.useProxy=false /Users/kxr/learning/zeppelin/interpreter/spark/spark-interpreter-0.12.0.jar 127.0.0.1 12345 spark-shared_process :</span><br></pre></td></tr></table></figure><p>é€šè¿‡è¿™ä¸ªæ—¥å¿—å…¶å®å¯ä»¥å­¦åˆ°å¾ˆå¤šä¸œè¥¿ã€‚</p><ol><li><p><code>/Users/kxr/learning/spark/spark-3.5.6-bin-hadoop3/bin/spark-submit</code>ï¼šæœ¬åœ° Spark çš„ <code>spark-submit</code> å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ã€‚<br><code>--class org.apache.zeppelin.interpreter.remote.RemoteInterpreterServer</code>ï¼šæŒ‡å®šå¯åŠ¨çš„ä¸»ç±»ï¼Œè¿™æ˜¯ Zeppelin è¿œç¨‹è§£é‡Šå™¨çš„æœåŠ¡ç±»ï¼Œç”¨äº Zeppelin ä¸ Spark ä¹‹é—´çš„é€šä¿¡ã€‚</p></li><li><p><code>--driver-class-path</code> åé¢çš„ä¸€ä¸²è·¯å¾„ï¼šæŒ‡å®š Spark Driver éœ€è¦åŠ è½½çš„ Java ç±»è·¯å¾„ï¼ŒåŒ…å« Zeppelin è§£é‡Šå™¨ç›¸å…³çš„ JAR åŒ…ã€Spark é…ç½®æ–‡ä»¶è·¯å¾„ç­‰ï¼Œç¡®ä¿è§£é‡Šå™¨èƒ½æ­£ç¡®æ‰¾åˆ°ä¾èµ–çš„ç±»ã€‚</p></li><li><p><code>--driver-java-options</code> åçš„å‚æ•°ï¼šç»™ Spark Driver çš„ JVM ä¼ é€’çš„å‚æ•°ï¼š</p><ul><li><code>-Dfile.encoding=UTF-8</code>ï¼šè®¾ç½®æ–‡ä»¶ç¼–ç ä¸º UTF-8ã€‚</li><li><code>-Dlog4j.configuration=...</code>ï¼šæŒ‡å®š log4j æ—¥å¿—é…ç½®æ–‡ä»¶è·¯å¾„ï¼Œæ§åˆ¶æ—¥å¿—è¾“å‡ºæ ¼å¼å’Œçº§åˆ«ã€‚</li><li><code>-Dzeppelin.log.file=...</code>ï¼šæŒ‡å®š Zeppelin è§£é‡Šå™¨çš„æ—¥å¿—æ–‡ä»¶è·¯å¾„ï¼ˆè®°å½•è§£é‡Šå™¨è¿è¡Œæ—¥å¿—ï¼‰ã€‚</li><li><code>-agentlib:jdwp=...</code>ï¼šå¯ç”¨ JVM è°ƒè¯•åŠŸèƒ½ï¼ˆ<code>suspend=y</code> è¡¨ç¤ºå¯åŠ¨æ—¶æš‚åœç­‰å¾…è°ƒè¯•å™¨è¿æ¥ï¼Œ<code>address=8000</code> æ˜¯è°ƒè¯•ç«¯å£ï¼‰ã€‚</li></ul></li><li><p><strong>Spark æ ¸å¿ƒé…ç½®ï¼ˆâ€“conf å‚æ•°ï¼‰</strong><br>è¿™äº›æ˜¯ Spark ä½œä¸šçš„èµ„æºå’Œè¿è¡Œå‚æ•°ï¼š</p></li></ol><ul><li><code>spark.executor.memory=1g</code>ï¼šæ¯ä¸ª Executor åˆ†é… 1GB å†…å­˜ã€‚</li><li><code>spark.master=local[*]</code>ï¼šSpark è¿è¡Œæ¨¡å¼ä¸ºæœ¬åœ°æ¨¡å¼ï¼Œ<code>[*]</code> è¡¨ç¤ºä½¿ç”¨æ‰€æœ‰å¯ç”¨ CPU æ ¸å¿ƒã€‚</li><li><code>spark.driver.memory=1g</code>ï¼šDriver è¿›ç¨‹åˆ†é… 1GB å†…å­˜ã€‚</li><li><code>spark.app.name=spark-shared_process</code>ï¼šä½œä¸šåç§°ä¸º <code>spark-shared_process</code>ï¼ˆZeppelin çš„å…±äº« Spark è¿›ç¨‹ï¼‰ã€‚</li><li><code>spark.executor.instances=2</code>ï¼šå¯åŠ¨ 2 ä¸ª Executor å®ä¾‹ã€‚</li></ul><ol start="5"><li><code>/Users/kxr/learning/zeppelin/interpreter/spark/spark-interpreter-0.12.0.jar</code>ï¼šZeppelin Spark è§£é‡Šå™¨çš„ JAR åŒ…è·¯å¾„ã€‚<br><code>127.0.0.1 12345 spark-shared_process</code>ï¼šè§£é‡Šå™¨æœåŠ¡ç»‘å®šçš„æœ¬åœ°åœ°å€ï¼ˆ127.0.0.1ï¼‰ã€ç«¯å£ï¼ˆ12345ï¼‰åŠè¿›ç¨‹åç§°ã€‚</li></ol><p>è¿™æ¡æ—¥å¿—æœ¬è´¨ä¸Šæ˜¯ Zeppelin å¯åŠ¨ Spark è§£é‡Šå™¨çš„è¯¦ç»†å‘½ä»¤è®°å½•ï¼ŒåŒ…å«äº† Spark çš„è¿è¡Œæ¨¡å¼ã€èµ„æºé…ç½®ã€ç±»è·¯å¾„ã€æ—¥å¿—è®¾ç½®ç­‰ä¿¡æ¯ã€‚é€šè¿‡è¿™äº›å‚æ•°ï¼ŒZeppelin æˆåŠŸå¯åŠ¨äº†ä¸€ä¸ªæœ¬åœ°æ¨¡å¼çš„ Spark è¿›ç¨‹ï¼Œå¹¶å»ºç«‹äº†ä¸ Spark çš„é€šä¿¡é€šé“ï¼Œä»¥ä¾¿ç”¨æˆ·åœ¨ Zeppelin ä¸­ç¼–å†™å’Œæ‰§è¡Œ Spark ä»£ç ã€‚</p><p>è§£é‡Šå™¨çš„è¿›ç¨‹æ˜¯ç‹¬ç«‹äº zeppelinæœåŠ¡çš„ï¼Œæ‰€ä»¥debugä¸åˆ°ã€‚</p><h4 id="2ï¼‰æ€ä¹ˆdebug"><a href="#2ï¼‰æ€ä¹ˆdebug" class="headerlink" title="2ï¼‰æ€ä¹ˆdebug"></a>2ï¼‰æ€ä¹ˆdebug</h4><p>å¦‚æœæƒ³è¦debugåˆ°ï¼Œå¾—ç”¨ä¸Š è¿œç¨‹JVMè°ƒè¯•ã€‚</p><ol><li><p>ä¿®æ”¹ <code>bin/interpreter.sh</code> ï¼Œè¿™ä¸ªè„šæœ¬æ˜¯ç”¨æ¥æ§åˆ¶å¯åŠ¨ è§£é‡Šå™¨çš„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">if [[ -n &quot;$&#123;SPARK_SUBMIT&#125;&quot; ]]; then</span><br><span class="line">  IFS=&#x27; &#x27; read -r -a SPARK_SUBMIT_OPTIONS_ARRAY &lt;&lt;&lt; &quot;$&#123;SPARK_SUBMIT_OPTIONS&#125;&quot;</span><br><span class="line">  IFS=&#x27;|&#x27; read -r -a ZEPPELIN_SPARK_CONF_ARRAY &lt;&lt;&lt; &quot;$&#123;ZEPPELIN_SPARK_CONF&#125;&quot;</span><br><span class="line">  if [[ &quot;$&#123;ZEPPELIN_SPARK_YARN_CLUSTER&#125;&quot; == &quot;true&quot;  ]]; then</span><br><span class="line">    INTERPRETER_RUN_COMMAND+=(&quot;$&#123;SPARK_SUBMIT&#125;&quot; &quot;--class&quot; &quot;$&#123;ZEPPELIN_SERVER&#125;&quot; &quot;--driver-java-options&quot; &quot;$&#123;SPARK_DRIVER_EXTRAJAVAOPTIONS_CONF&#125; $&#123;JAVA_INTP_OPTS&#125;&quot; &quot;$&#123;SPARK_SUBMIT_OPTIONS_ARRAY[@]&#125;&quot; &quot;$&#123;ZEPPELIN_SPARK_CONF_ARRAY[@]&#125;&quot; &quot;$&#123;SPARK_APP_JAR&#125;&quot; &quot;$&#123;CALLBACK_HOST&#125;&quot; &quot;$&#123;PORT&#125;&quot; &quot;$&#123;INTP_GROUP_ID&#125;&quot; &quot;$&#123;INTP_PORT&#125;&quot;)</span><br><span class="line">  else</span><br><span class="line">    INTERPRETER_RUN_COMMAND+=(&quot;$&#123;SPARK_SUBMIT&#125;&quot; &quot;--class&quot; &quot;$&#123;ZEPPELIN_SERVER&#125;&quot; &quot;--driver-class-path&quot; &quot;$&#123;ZEPPELIN_INTP_CLASSPATH_OVERRIDES&#125;:$&#123;ZEPPELIN_INTP_CLASSPATH&#125;&quot; &quot;--driver-java-options&quot; &quot;$&#123;SPARK_DRIVER_EXTRAJAVAOPTIONS_CONF&#125; $&#123;JAVA_INTP_OPTS&#125;&quot; &quot;$&#123;SPARK_SUBMIT_OPTIONS_ARRAY[@]&#125;&quot; &quot;$&#123;ZEPPELIN_SPARK_CONF_ARRAY[@]&#125;&quot; &quot;$&#123;SPARK_APP_JAR&#125;&quot; &quot;$&#123;CALLBACK_HOST&#125;&quot; &quot;$&#123;PORT&#125;&quot; &quot;$&#123;INTP_GROUP_ID&#125;&quot; &quot;$&#123;INTP_PORT&#125;&quot;)</span><br><span class="line">  fi</span><br><span class="line">elif [[ -n &quot;$&#123;ZEPPELIN_FLINK_APPLICATION_MODE&#125;&quot; ]]; then</span><br><span class="line">  IFS=&#x27;|&#x27; read -r -a ZEPPELIN_FLINK_APPLICATION_MODE_CONF_ARRAY &lt;&lt;&lt; &quot;$&#123;ZEPPELIN_FLINK_APPLICATION_MODE_CONF&#125;&quot;</span><br><span class="line">  INTERPRETER_RUN_COMMAND+=(&quot;$&#123;FLINK_HOME&#125;/bin/flink&quot; &quot;run-application&quot; &quot;-c&quot; &quot;$&#123;ZEPPELIN_SERVER&#125;&quot; &quot;-t&quot; &quot;$&#123;ZEPPELIN_FLINK_APPLICATION_MODE&#125;&quot; &quot;$&#123;ZEPPELIN_FLINK_APPLICATION_MODE_CONF_ARRAY[@]&#125;&quot; &quot;$&#123;FLINK_APP_JAR&#125;&quot; &quot;$&#123;CALLBACK_HOST&#125;&quot; &quot;$&#123;PORT&#125;&quot; &quot;$&#123;INTP_GROUP_ID&#125;&quot; &quot;$&#123;INTP_PORT&#125;&quot;)</span><br><span class="line">else</span><br><span class="line">  IFS=&#x27; &#x27; read -r -a JAVA_INTP_OPTS_ARRAY &lt;&lt;&lt; &quot;$&#123;JAVA_INTP_OPTS&#125;&quot;</span><br><span class="line">  IFS=&#x27; &#x27; read -r -a ZEPPELIN_INTP_MEM_ARRAY &lt;&lt;&lt; &quot;$&#123;ZEPPELIN_INTP_MEM&#125;&quot;</span><br><span class="line">  INTERPRETER_RUN_COMMAND+=(&quot;$&#123;ZEPPELIN_RUNNER&#125;&quot; &quot;$&#123;JAVA_INTP_OPTS_ARRAY[@]&#125;&quot; &quot;$&#123;ZEPPELIN_INTP_MEM_ARRAY[@]&#125;&quot; &quot;-cp&quot; &quot;$&#123;ZEPPELIN_INTP_CLASSPATH_OVERRIDES&#125;:$&#123;ZEPPELIN_INTP_CLASSPATH&#125;&quot; &quot;$&#123;ZEPPELIN_SERVER&#125;&quot; &quot;$&#123;CALLBACK_HOST&#125;&quot; &quot;$&#123;PORT&#125;&quot; &quot;$&#123;INTP_GROUP_ID&#125;&quot; &quot;$&#123;INTP_PORT&#125;&quot;)</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹è°ƒæ•´ï¼Œå¢åŠ ï¼š-agentlib:jdwp&#x3D;transport&#x3D;dt_socket,server&#x3D;y,suspend&#x3D;y,address&#x3D;8000</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">if [[ -n &quot;$&#123;SPARK_SUBMIT&#125;&quot; ]]; then</span><br><span class="line">  # å°†ç©ºæ ¼åˆ†éš”çš„ Spark æäº¤é€‰é¡¹æ‹†åˆ†ä¸ºæ•°ç»„</span><br><span class="line">  IFS=&#x27; &#x27; read -r -a SPARK_SUBMIT_OPTIONS_ARRAY &lt;&lt;&lt; &quot;$&#123;SPARK_SUBMIT_OPTIONS&#125;&quot;</span><br><span class="line">  # å°† | åˆ†éš”çš„ Zeppelin Spark é…ç½®æ‹†åˆ†ä¸ºæ•°ç»„</span><br><span class="line">  IFS=&#x27;|&#x27; read -r -a ZEPPELIN_SPARK_CONF_ARRAY &lt;&lt;&lt; &quot;$&#123;ZEPPELIN_SPARK_CONF&#125;&quot;</span><br><span class="line">  </span><br><span class="line">  # åˆ¤æ–­æ˜¯å¦ä¸º YARN é›†ç¾¤æ¨¡å¼</span><br><span class="line">  if [[ &quot;$&#123;ZEPPELIN_SPARK_YARN_CLUSTER&#125;&quot; == &quot;true&quot;  ]]; then</span><br><span class="line">    # YARN é›†ç¾¤æ¨¡å¼çš„å¯åŠ¨å‘½ä»¤</span><br><span class="line">    INTERPRETER_RUN_COMMAND+=(&quot;$&#123;SPARK_SUBMIT&#125;&quot; &quot;--class&quot; &quot;$&#123;ZEPPELIN_SERVER&#125;&quot; </span><br><span class="line">      &quot;--driver-java-options&quot; &quot;$&#123;SPARK_DRIVER_EXTRAJAVAOPTIONS_CONF&#125; $&#123;JAVA_INTP_OPTS&#125;&quot; </span><br><span class="line">      &quot;$&#123;SPARK_SUBMIT_OPTIONS_ARRAY[@]&#125;&quot; &quot;$&#123;ZEPPELIN_SPARK_CONF_ARRAY[@]&#125;&quot; </span><br><span class="line">      &quot;$&#123;SPARK_APP_JAR&#125;&quot; &quot;$&#123;CALLBACK_HOST&#125;&quot; &quot;$&#123;PORT&#125;&quot; &quot;$&#123;INTP_GROUP_ID&#125;&quot; &quot;$&#123;INTP_PORT&#125;&quot;)</span><br><span class="line">  else</span><br><span class="line">    # é YARN æ¨¡å¼ï¼ˆå¦‚æœ¬åœ°æ¨¡å¼ï¼‰çš„å¯åŠ¨å‘½ä»¤ï¼Œé¢å¤–æ·»åŠ ï¼š</span><br><span class="line">    # - driver-class-pathï¼šæŒ‡å®šé©±åŠ¨ç±»è·¯å¾„</span><br><span class="line">    # - è°ƒè¯•å‚æ•°ï¼š-agentlib:jdwp=...ï¼ˆå…è®¸è¿œç¨‹è°ƒè¯•ï¼‰</span><br><span class="line">    INTERPRETER_RUN_COMMAND+=(&quot;$&#123;SPARK_SUBMIT&#125;&quot; &quot;--class&quot; &quot;$&#123;ZEPPELIN_SERVER&#125;&quot; </span><br><span class="line">      &quot;--driver-class-path&quot; &quot;$&#123;ZEPPELIN_INTP_CLASSPATH_OVERRIDES&#125;:$&#123;ZEPPELIN_INTP_CLASSPATH&#125;&quot; </span><br><span class="line">      &quot;--driver-java-options&quot; &quot;$&#123;SPARK_DRIVER_EXTRAJAVAOPTIONS_CONF&#125; $&#123;JAVA_INTP_OPTS&#125; -agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=8000&quot; </span><br><span class="line">      &quot;$&#123;SPARK_SUBMIT_OPTIONS_ARRAY[@]&#125;&quot; &quot;$&#123;ZEPPELIN_SPARK_CONF_ARRAY[@]&#125;&quot; </span><br><span class="line">      &quot;$&#123;SPARK_APP_JAR&#125;&quot; &quot;$&#123;CALLBACK_HOST&#125;&quot; &quot;$&#123;PORT&#125;&quot; &quot;$&#123;INTP_GROUP_ID&#125;&quot; &quot;$&#123;INTP_PORT&#125;&quot;)</span><br><span class="line">  fi</span><br><span class="line">elif [[ -n &quot;$&#123;ZEPPELIN_FLINK_APPLICATION_MODE&#125;&quot; ]]; then</span><br><span class="line">  # å°† | åˆ†éš”çš„ Flink é…ç½®æ‹†åˆ†ä¸ºæ•°ç»„</span><br><span class="line">  IFS=&#x27;|&#x27; read -r -a ZEPPELIN_FLINK_APPLICATION_MODE_CONF_ARRAY &lt;&lt;&lt; &quot;$&#123;ZEPPELIN_FLINK_APPLICATION_MODE_CONF&#125;&quot;</span><br><span class="line">  # ç»„è£… Flink åº”ç”¨æ¨¡å¼å¯åŠ¨å‘½ä»¤</span><br><span class="line">  INTERPRETER_RUN_COMMAND+=(&quot;$&#123;FLINK_HOME&#125;/bin/flink&quot; &quot;run-application&quot; </span><br><span class="line">    &quot;-c&quot; &quot;$&#123;ZEPPELIN_SERVER&#125;&quot; &quot;-t&quot; &quot;$&#123;ZEPPELIN_FLINK_APPLICATION_MODE&#125;&quot; </span><br><span class="line">    &quot;$&#123;ZEPPELIN_FLINK_APPLICATION_MODE_CONF_ARRAY[@]&#125;&quot; </span><br><span class="line">    &quot;$&#123;FLINK_APP_JAR&#125;&quot; &quot;$&#123;CALLBACK_HOST&#125;&quot; &quot;$&#123;PORT&#125;&quot; &quot;$&#123;INTP_GROUP_ID&#125;&quot; &quot;$&#123;INTP_PORT&#125;&quot;)</span><br><span class="line">else</span><br><span class="line">  # æ‹†åˆ† Java é€‰é¡¹å’Œå†…å­˜é…ç½®ä¸ºæ•°ç»„</span><br><span class="line">  IFS=&#x27; &#x27; read -r -a JAVA_INTP_OPTS_ARRAY &lt;&lt;&lt; &quot;$&#123;JAVA_INTP_OPTS&#125;&quot;</span><br><span class="line">  IFS=&#x27; &#x27; read -r -a ZEPPELIN_INTP_MEM_ARRAY &lt;&lt;&lt; &quot;$&#123;ZEPPELIN_INTP_MEM&#125;&quot;</span><br><span class="line">  # ç»„è£…é»˜è®¤è§£é‡Šå™¨å¯åŠ¨å‘½ä»¤ï¼ˆç›´æ¥ç”¨ Java è¿è¡Œï¼‰</span><br><span class="line">  INTERPRETER_RUN_COMMAND+=(&quot;$&#123;ZEPPELIN_RUNNER&#125;&quot; </span><br><span class="line">    &quot;$&#123;JAVA_INTP_OPTS_ARRAY[@]&#125;&quot; &quot;$&#123;ZEPPELIN_INTP_MEM_ARRAY[@]&#125;&quot; </span><br><span class="line">    &quot;-agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=8000&quot;  # è°ƒè¯•å‚æ•°</span><br><span class="line">    &quot;-cp&quot; &quot;$&#123;ZEPPELIN_INTP_CLASSPATH_OVERRIDES&#125;:$&#123;ZEPPELIN_INTP_CLASSPATH&#125;&quot;  # ç±»è·¯å¾„</span><br><span class="line">    &quot;$&#123;ZEPPELIN_SERVER&#125;&quot; &quot;$&#123;CALLBACK_HOST&#125;&quot; &quot;$&#123;PORT&#125;&quot; &quot;$&#123;INTP_GROUP_ID&#125;&quot; &quot;$&#123;INTP_PORT&#125;&quot;)</span><br><span class="line">fi</span><br></pre></td></tr></table></figure></li><li><p>é…ç½®idea è¿œç¨‹JVMè°ƒè¯•</p><p>é€‰æ‹©8000ç«¯å£å³å¯ï¼Œå› ä¸ºåœ¨è§£é‡Šå™¨å¯åŠ¨è„šæœ¬é‚£é…ç½®çš„å°±æ˜¯8000ã€‚ç„¶åå¾—åœ¨é¡µé¢æ‰§è¡Œä½œä¸šä¹‹åï¼Œæ‰å¯åŠ¨è§£é‡Šå™¨è¿›ç¨‹å“ˆï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿä¸ç”¨æå‰debugã€‚æˆ‘ä»¬è°ƒè¯•å‚æ•°ä¸­æœ‰ <code>suspend=y</code>,<strong>å¯åŠ¨ JVM æ—¶ä¼šæš‚åœç¨‹åºæ‰§è¡Œï¼Œç›´åˆ°è¿œç¨‹è°ƒè¯•å™¨è¿æ¥æˆåŠŸåæ‰ç»§ç»­è¿è¡Œ</strong>ï¼Œæ‰€ä»¥ä¸ç”¨æ‹…å¿ƒã€‚</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/image-20250918173209955.png" alt="image-20250918173209955"></p></li></ol><h2 id="å››ã€æ‰“åŒ…éƒ¨ç½²"><a href="#å››ã€æ‰“åŒ…éƒ¨ç½²" class="headerlink" title="å››ã€æ‰“åŒ…éƒ¨ç½²"></a>å››ã€æ‰“åŒ…éƒ¨ç½²</h2><h3 id="4-1-æ ‡å‡†éƒ¨ç½²æ–¹å¼"><a href="#4-1-æ ‡å‡†éƒ¨ç½²æ–¹å¼" class="headerlink" title="4.1 æ ‡å‡†éƒ¨ç½²æ–¹å¼"></a>4.1 æ ‡å‡†éƒ¨ç½²æ–¹å¼</h3><p>ä¸ºäº†ä½“ç°æ‰“åŒ…çš„æ˜¯æˆ‘ä»¬è‡ªå·±ç¼–è¯‘çš„æºç ï¼Œå¯ä»¥ç•™ä¸ªç—•è¿¹ï¼š</p><p>æˆ‘åœ¨æ–¹æ³•<code>org.apache.zeppelin.notebook.Paragraph#jobRun</code> ç¬¬ä¸€è¡ŒåŠ äº†ä¸€ä¸ªæ—¥å¿—æ‰“å°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOGGER.info(<span class="string">&quot;KXR just passing through&quot;</span>);</span><br></pre></td></tr></table></figure><p>å¦‚æœæ‰“åŒ…ä¹‹åçš„ zeppelin åœ¨è¿è¡Œä½œä¸šæ—¶ï¼Œæ—¥å¿—å‡ºç°è¿™æ¡æ—¥å¿—ï¼Œé‚£ä¹ˆè¯æ˜å°±æˆåŠŸäº†ã€‚</p><p>1ï¼‰ç¼–è¯‘æ‰“åŒ…</p><p>ä½¿ç”¨ <code>./mvnw clean package -Pbuild-distr</code> æ¥è¿›è¡Œæ‰“åŒ…ã€‚</p><p>æ‰“åŒ…å®Œæˆä¹‹åï¼Œåœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹ä¼šç”Ÿæˆä¸€ä¸ªæ‰“åŒ…å¥½çš„åˆ†å‘ç‰ˆæœ¬ï¼Œä½äºé¡¹ç›®çš„ï¼š</p><p><code>zeppelin-distribution/target/zeppelin-0.12.0-bin/zeppelin-0.12.0-bin</code></p><p>2ï¼‰éƒ¨ç½²æ‰§è¡Œ</p><p>å¯ä»¥å°†è¿™ä¸ªæ–‡ä»¶å¤¹ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œç„¶åæ‰§è¡Œ <code>./bin/zeppelin-daemon.sh start</code></p><p>3ï¼‰è¿è¡Œç¬”è®°ï¼Œè§‚å¯Ÿæ—¥å¿—ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INFO [2025-09-18 21:02:02,360] (&#123;FIFO-RemoteInterpreter-spark-shared_process-shared_session-1&#125; AbstractScheduler.java[runJob]:131) - Job paragraph_1758022969766_1777889232 started by scheduler RemoteInterpreter-spark-shared_process-shared_session</span><br><span class="line">INFO [2025-09-18 21:02:02,360] (&#123;FIFO-RemoteInterpreter-spark-shared_process-shared_session-1&#125; Paragraph.java[jobRun]:396) - KXR just passing through</span><br><span class="line">INFO [2025-09-18 21:02:02,361] (&#123;FIFO-RemoteInterpreter-spark-shared_process-shared_session-1&#125; Paragraph.java[jobRun]:405) - Run paragraph [paragraph_id: paragraph_1758022969766_1777889232, interpreter: org.apache.zeppelin.spark.SparkInterpreter, note_id: 2M5RT8PVM, user: anonymous]</span><br></pre></td></tr></table></figure><p>æˆåŠŸå•¦</p><h3 id="4-2-Dockeréƒ¨ç½²"><a href="#4-2-Dockeréƒ¨ç½²" class="headerlink" title="4.2 Dockeréƒ¨ç½²"></a>4.2 Dockeréƒ¨ç½²</h3><blockquote><p>å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://zeppelin.apache.org/docs/0.12.0/setup/deployment/docker">https://zeppelin.apache.org/docs/0.12.0/setup/deployment/docker</a></p></blockquote><p>Zeppelinæä¾›äº†å¤šç§Dockeré•œåƒæ„å»ºå’Œéƒ¨ç½²æ–¹å¼ï¼Œè¿™æ˜¯å› ä¸ºä»0.9ç‰ˆæœ¬å¼€å§‹ï¼ŒZeppelinæ”¯æŒåœ¨Kubernetesæˆ–Dockerä¸­è¿è¡Œï¼Œå¹¶ä¸”é‡‡ç”¨äº†æœåŠ¡å™¨å’Œè§£é‡Šå™¨åˆ†ç¦»çš„æ¶æ„è®¾è®¡ã€‚</p><p>1ï¼‰æœåŠ¡å™¨å’Œè§£é‡Šå™¨åˆ†ç¦»éƒ¨ç½²æ–¹å¼</p><p>è¿™ç§æ–¹å¼ä¸‹æœ‰ä¸‰ç§é•œåƒï¼š</p><ul><li><p>åŸºç¡€åˆ†å‘é•œåƒï¼ˆzeppelin-distributionï¼‰</p><ul><li><p>ä½œç”¨ ï¼šè¿™æ˜¯ä¸€ä¸ªä¸­é—´é•œåƒï¼Œä¸»è¦ç”¨äºæ„å»ºå’Œæ‰“åŒ…Zeppelinçš„æ‰€æœ‰ç»„ä»¶</p></li><li><p>å†…å®¹ ï¼šåŒ…å«å®Œæ•´çš„Zeppelinæºä»£ç ã€æ„å»ºå·¥å…·å’Œæ„å»ºè¿‡ç¨‹ä¸­ç”Ÿæˆçš„æ‰€æœ‰JARåŒ…</p></li><li><p>ç‰¹ç‚¹ ï¼šä½“ç§¯è¾ƒå¤§ï¼ŒåŒ…å«ç¼–è¯‘ç¯å¢ƒå’Œæ„å»ºå·¥å…·</p></li><li><p>ç”¨é€” ï¼šä¸ç›´æ¥ç”¨äºéƒ¨ç½²ï¼Œè€Œæ˜¯ä½œä¸ºå…¶ä»–é•œåƒçš„åŸºç¡€</p></li></ul></li><li><p>ZeppelinæœåŠ¡å™¨é•œåƒ</p><ul><li>ä½œç”¨ ï¼šè¿™æ˜¯å®é™…è¿è¡ŒZeppelinæœåŠ¡å™¨çš„é•œåƒ</li><li>å†…å®¹ ï¼šåªåŒ…å«è¿è¡ŒZeppelinæœåŠ¡å™¨æ‰€éœ€çš„ç»„ä»¶ï¼Œä¸åŒ…å«æ„å»ºå·¥å…·</li><li>ç‰¹ç‚¹ ï¼šä½“ç§¯ç›¸å¯¹è¾ƒå°ï¼Œä¼˜åŒ–ç”¨äºç”Ÿäº§ç¯å¢ƒ</li><li>ç”¨é€” ï¼šç›´æ¥ç”¨äºéƒ¨ç½²ZeppelinæœåŠ¡å™¨</li></ul></li><li><p>è§£é‡Šå™¨åŸºç¡€é•œåƒ</p></li></ul><p>æ„å»ºæµç¨‹å…³ç³»</p><ol><li><p>é¦–å…ˆæ„å»ºåŸºç¡€åˆ†å‘é•œåƒï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å®ŒæˆZeppelinçš„ç¼–è¯‘å’Œæ‰“åŒ…</p></li><li><p>ç„¶ååŸºäºè¿™ä¸ªåˆ†å‘é•œåƒï¼Œæå–å‡ºæœåŠ¡å™¨éƒ¨åˆ†åˆ›å»ºæœåŠ¡å™¨é•œåƒ</p></li><li><p>åŒæ ·åŸºäºåˆ†å‘é•œåƒï¼Œæå–å‡ºè§£é‡Šå™¨éƒ¨åˆ†åˆ›å»ºè§£é‡Šå™¨é•œåƒã€‚</p></li></ol><p>è¿™ç§å¤šé˜¶æ®µæ„å»ºæ–¹å¼çš„å¥½å¤„æ˜¯ï¼š</p><ol><li><p>åˆ†ç¦»æ„å»ºç¯å¢ƒå’Œè¿è¡Œç¯å¢ƒï¼Œå‡å°æœ€ç»ˆé•œåƒå¤§å°</p></li><li><p>å…è®¸æœåŠ¡å™¨å’Œè§£é‡Šå™¨åˆ†åˆ«éƒ¨ç½²ï¼Œå®ç°å¾®æœåŠ¡æ¶æ„</p></li><li><p>ä¾¿äºå•ç‹¬æ›´æ–°æˆ–æ‰©å±•æŸä¸ªç»„ä»¶</p></li></ol><p>å®æ“é•œåƒæ„å»ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#é¦–å…ˆæ„å»ºåŸºç¡€åˆ†å‘é•œåƒ</span><br><span class="line">cd $ZEPPELIN_HOME</span><br><span class="line">docker build -t zeppelin-distribution .</span><br><span class="line"></span><br><span class="line">#ç„¶åæ„å»ºæœåŠ¡å™¨é•œåƒ</span><br><span class="line">cd $ZEPPELIN_HOME/scripts/docker/zeppelin-server</span><br><span class="line">docker build -t zeppelin-server:0.12.0 .</span><br><span class="line"></span><br><span class="line">#æ„å»ºè§£é‡Šå™¨åŸºç¡€é•œåƒ</span><br><span class="line">cd $ZEPPELIN_HOME/scripts/docker/zeppelin-interpreter</span><br><span class="line">docker build -t zeppelin-interpreter-base:0.12.0 .</span><br></pre></td></tr></table></figure><p>docker compose éƒ¨ç½²</p><p>ç¼–å†™ <code>docker-compose.yml</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">version: &#x27;3&#x27;</span><br><span class="line">services:</span><br><span class="line">  zeppelin-server:</span><br><span class="line">    image: zeppelin-server:0.12.0</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;8080:8080&quot;</span><br><span class="line">    environment:</span><br><span class="line">      - ZEPPELIN_RUN_MODE=docker</span><br><span class="line">      - ZEPPELIN_IN_DOCKER=true</span><br><span class="line">      - ZEPPELIN_DOCKER_CONTAINER_IMAGE=zeppelin-interpreter-base:latest</span><br><span class="line">    volumes:</span><br><span class="line">      - ./logs:/logs</span><br><span class="line">      - ./notebook:/notebook</span><br><span class="line">      - /var/run/docker.sock:/var/run/docker.sock</span><br><span class="line">    networks:</span><br><span class="line">      - zeppelin-net</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  zeppelin-net:</span><br><span class="line">    driver: bridge</span><br></pre></td></tr></table></figure><p>ç›´æ¥dockeréƒ¨ç½²ï¼š</p><p>è¦è®©zeppelin-serverä½¿ç”¨å•ç‹¬çš„å®¹å™¨è¿è¡Œè§£é‡Šå™¨ï¼Œéœ€è¦ï¼š</p><ol><li>åœ¨å¯åŠ¨å®¹å™¨æ—¶è®¾ç½®ç¯å¢ƒå˜é‡ï¼š ZEPPELIN_RUN_MODE&#x3D;docker</li><li>æŒ‡å®šè§£é‡Šå™¨å®¹å™¨é•œåƒï¼š ZEPPELIN_DOCKER_CONTAINER_IMAGE&#x3D;zeppelin-interpreter-base:latest</li><li>ç¡®ä¿æŒ‚è½½Dockerå¥—æ¥å­—ï¼š -v &#x2F;var&#x2F;run&#x2F;docker.sock:&#x2F;var&#x2F;run&#x2F;docker.sock</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 8080:8080 \</span><br><span class="line">  -e ZEPPELIN_RUN_MODE=docker \</span><br><span class="line">  -e ZEPPELIN_IN_DOCKER=true \</span><br><span class="line">  -e ZEPPELIN_DOCKER_CONTAINER_IMAGE=zeppelin-interpreter-base:latest \</span><br><span class="line">  -v /var/run/docker.sock:/var/run/docker.sock \</span><br><span class="line">  zeppelin-server:0.12.0</span><br></pre></td></tr></table></figure><p>2ï¼‰æœåŠ¡å™¨å’Œè§£é‡Šå™¨ä¸€ä½“åŒ–éƒ¨ç½²</p><p>å¦‚æœä½ æ˜¯å¿«é€Ÿæ­å»ºå¼€å‘ä¸æµ‹è¯•ç¯å¢ƒï¼Œå¯ä»¥æ¥å—zeppelinæœåŠ¡ç«¯ä¸è§£é‡Šå™¨è¿è¡Œåœ¨ä¸€ä¸ªå®¹å™¨å†…ã€‚åˆ™æœ‰ä¸€ç§æ›´åŠ ç®€å•çš„é•œåƒæ„å»ºæ–¹å¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd $ZEPPELIN_HOME</span><br><span class="line">cd scripts/docker/zeppelin/bin</span><br><span class="line">docker build -t my-zeppelin:my-tag ./</span><br></pre></td></tr></table></figure><p>è¿™ç§æ–¹å¼é€‚åˆä»¥ä¸‹åœºæ™¯ï¼š</p><ul><li>å¿«é€Ÿå¼€å§‹ä½¿ç”¨Zeppelinè¿›è¡Œå¼€å‘æˆ–æµ‹è¯•</li><li>ä¸éœ€è¦æœåŠ¡å™¨å’Œè§£é‡Šå™¨åˆ†ç¦»éƒ¨ç½²</li><li>æƒ³è¦ä¸€ä¸ªæ›´è½»é‡çº§çš„é•œåƒ</li><li>éœ€è¦å¯¹é•œåƒè¿›è¡Œç®€å•å®šåˆ¶</li></ul>]]></content>
      
      
      <categories>
          
          <category> å¤§æ•°æ® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spark </tag>
            
            <tag> å¤§æ•°æ® </tag>
            
            <tag> Zeppelin </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¸€ç«™å¼æ­å»ºSpark-Hadoopé›†ç¾¤åŠZeppelin</title>
      <link href="/2025/09/13/%E4%B8%80%E7%AB%99%E5%BC%8F%E6%90%AD%E5%BB%BASpark-Hadoop%E9%9B%86%E7%BE%A4%E5%8F%8AZeppelin/"/>
      <url>/2025/09/13/%E4%B8%80%E7%AB%99%E5%BC%8F%E6%90%AD%E5%BB%BASpark-Hadoop%E9%9B%86%E7%BE%A4%E5%8F%8AZeppelin/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ç«™å¼æ­å»ºSpark-Hadoopé›†ç¾¤åŠZeppelin"><a href="#ä¸€ç«™å¼æ­å»ºSpark-Hadoopé›†ç¾¤åŠZeppelin" class="headerlink" title="ä¸€ç«™å¼æ­å»ºSpark-Hadoopé›†ç¾¤åŠZeppelin"></a>ä¸€ç«™å¼æ­å»ºSpark-Hadoopé›†ç¾¤åŠZeppelin</h1><p>åœ¨ä½¿ç”¨ zeppelin çš„æ—¶å€™ï¼Œå¯èƒ½æƒ³è¦ä½¿ç”¨çœŸå®çš„ sparkã€hadoopé›†ç¾¤ã€‚ä½†æ˜¯æ— è®ºæ˜¯ä¸Šæ˜¯sparké›†ç¾¤ã€è¿˜æ˜¯hadoopé›†ç¾¤éƒ½æ˜¯æ¯”è¾ƒéº»çƒ¦ã€‚</p><p>zeppelin 0.12.0 è¦æ±‚sparkç‰ˆæœ¬é«˜äº3.2ï¼Œæˆ‘ä»¥å‰ä¸€ç¯‡æ–‡ç« é‡Œæ¨¡ä»¿æ•™ç¨‹çš„åšçš„spark-hadoopé•œåƒï¼Œå…¶ä¸­sparkç‰ˆæœ¬æ¯”è¾ƒä½ï¼Œzeppelinä½¿ç”¨ä¸äº†ã€‚æ‰€ä»¥æˆ‘åˆåˆ¶ä½œäº†ä¸€ä¸ªé•œåƒï¼Œå†…ç½®äº†spark3.5.6ã€hadoop3.4.0ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿éƒ¨ç½²sparkã€hadoopé›†ç¾¤ã€‚</p><p>å¦‚æœæƒ³è¦zeppelinå®¹å™¨èƒ½é…åˆä½¿ç”¨è¿™ä¸ªsparkã€hadoopé›†ç¾¤ï¼Œè¿˜éœ€è¦åšä¸€äº›ç½‘ç»œä¸Šçš„è”é€šã€é…ç½®å…±äº«ç­‰å¤„ç†çš„ã€‚</p><p>ï¼ˆ1ï¼‰ docker-compose-with-zeppelin.yml æ–‡ä»¶å†…å®¹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;2&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">spark:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">kongxr7/spark-hadoop:3.5.6-hadoop3.4.0</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">master</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_MODE=master</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_RPC_AUTHENTICATION_ENABLED=no</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_RPC_ENCRYPTION_ENABLED=no</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED=no</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_SSL_ENABLED=no</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="comment"># ç›´æ¥å°†Hadoopé…ç½®ç›®å½•æŒ‚è½½åˆ°å…±äº«å·</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">hadoop_conf:/opt/hadoop/etc/hadoop</span></span><br><span class="line">      <span class="comment"># å°†å®¹å™¨å†…çš„Sparkåº“æŒ‚è½½åˆ°å…±äº«å·</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">spark_lib:/opt/bitnami/spark</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;8090:8080&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;4040:4040&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;8088:8088&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;8042:8042&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;9870:9870&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;19888:19888&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;7077:7077&#x27;</span></span><br><span class="line">  <span class="attr">spark-worker-1:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">kongxr7/spark-hadoop:3.5.6-hadoop3.4.0</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">worker1</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_MODE=worker</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_MASTER_URL=spark://master:7077</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_WORKER_MEMORY=1G</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_WORKER_CORES=1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_RPC_AUTHENTICATION_ENABLED=no</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_RPC_ENCRYPTION_ENABLED=no</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED=no</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_SSL_ENABLED=no</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;8081:8081&#x27;</span></span><br><span class="line">  <span class="attr">spark-worker-2:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">kongxr7/spark-hadoop:3.5.6-hadoop3.4.0</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">worker2</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_MODE=worker</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_MASTER_URL=spark://master:7077</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_WORKER_MEMORY=1G</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_WORKER_CORES=1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_RPC_AUTHENTICATION_ENABLED=no</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_RPC_ENCRYPTION_ENABLED=no</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED=no</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_SSL_ENABLED=no</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;8082:8081&#x27;</span></span><br><span class="line">  <span class="attr">zeppelin:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">apache/zeppelin:0.12.0</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">zeppelin</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">spark</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_HOME=/opt/spark</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">HADOOP_CONF_DIR=/opt/hadoop/etc/hadoop</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">YARN_CONF_DIR=/opt/hadoop/etc/hadoop</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="comment"># ä½¿ç”¨å…±äº«å·ä¸­çš„Sparkåº“</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">spark_lib:/opt/spark</span></span><br><span class="line">      <span class="comment"># æŒ‚è½½Hadoopé…ç½®ç›®å½•ï¼Œä»sparkå®¹å™¨å…±äº«</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">hadoop_conf:/opt/hadoop/etc/hadoop:ro</span></span><br><span class="line">      <span class="comment"># æŒä¹…åŒ–Zeppelin notebookæ•°æ®</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">zeppelin_notebooks:/opt/zeppelin/notebook</span></span><br><span class="line">      <span class="comment"># æŒä¹…åŒ–Zeppeliné…ç½®</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">zeppelin_conf:/opt/zeppelin/conf</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;8089:8080&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="comment"># åˆ›å»ºä¸€ä¸ªå‘½åå·æ¥å…±äº«Hadoopé…ç½®</span></span><br><span class="line">  <span class="attr">hadoop_conf:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">local</span></span><br><span class="line">  <span class="comment"># åˆ›å»ºä¸€ä¸ªå‘½åå·æ¥å…±äº«Sparkåº“</span></span><br><span class="line">  <span class="attr">spark_lib:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">local</span></span><br><span class="line">  <span class="comment"># Zeppelin notebookæŒä¹…åŒ–å·</span></span><br><span class="line">  <span class="attr">zeppelin_notebooks:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">local</span></span><br><span class="line">  <span class="comment"># Zeppeliné…ç½®æŒä¹…åŒ–å·</span></span><br><span class="line">  <span class="attr">zeppelin_conf:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">local</span></span><br></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰ä¸€é”®å¯åŠ¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose -f docker-compose-with-zeppelin.yml up -d</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/image-20250913223334195.png" alt="image-20250913223334195"></p><p>å¯åŠ¨ä¹‹åï¼Œå°±å¯ä»¥è®¿é—®å„ç»„ä»¶äº†ã€‚</p><p>Spark UI: <a href="http://localhost:8090/">http://localhost:8090</a></p><p>HDFS UI: <a href="http://localhost:9870/">http://localhost:9870</a></p><p>YARN UI: <a href="http://localhost:8088/">http://localhost:8088</a></p><p>Zeppelin UI: <a href="http://localhost:8089/">http://localhost:8089</a></p>]]></content>
      
      
      <categories>
          
          <category> å¤§æ•°æ® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spark </tag>
            
            <tag> Hadoop </tag>
            
            <tag> Zeppelin </tag>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Sparkã€Hadoopé›†ç¾¤åŠZeppelinçš„é•œåƒå…·ä½“æ„å»ºè¿‡ç¨‹</title>
      <link href="/2025/09/11/Spark%E3%80%81Hadoop%E9%9B%86%E7%BE%A4%E5%8F%8AZeppelin%E7%9A%84%E9%95%9C%E5%83%8F%E5%85%B7%E4%BD%93%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B/"/>
      <url>/2025/09/11/Spark%E3%80%81Hadoop%E9%9B%86%E7%BE%A4%E5%8F%8AZeppelin%E7%9A%84%E9%95%9C%E5%83%8F%E5%85%B7%E4%BD%93%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<h1 id="Sparkã€Hadoopé›†ç¾¤åŠZeppelinçš„é•œåƒå…·ä½“æ„å»ºè¿‡ç¨‹"><a href="#Sparkã€Hadoopé›†ç¾¤åŠZeppelinçš„é•œåƒå…·ä½“æ„å»ºè¿‡ç¨‹" class="headerlink" title="Sparkã€Hadoopé›†ç¾¤åŠZeppelinçš„é•œåƒå…·ä½“æ„å»ºè¿‡ç¨‹"></a>Sparkã€Hadoopé›†ç¾¤åŠZeppelinçš„é•œåƒå…·ä½“æ„å»ºè¿‡ç¨‹</h1><blockquote><p>zeppelinå®˜æ–¹æ–‡æ¡£ï¼š<a href="https://zeppelin.apache.org/docs/0.12.0/interpreter/spark.html">https://zeppelin.apache.org/docs/0.12.0/interpreter/spark.html</a><br>é˜¿é‡Œäº‘hadoopé•œåƒç«™ï¼š<a href="https://mirrors.aliyun.com/apache/hadoop/common/?spm=a2c6h.25603864.0.0.25594c98Zq721o">https://mirrors.aliyun.com/apache/hadoop/common/?spm=a2c6h.25603864.0.0.25594c98Zq721o</a><br>sparkä¸‹è½½åœ°å€ï¼š<a href="https://spark.apache.org/downloads.html">https://spark.apache.org/downloads.html</a><br>hadoopå®˜æ–¹ä¸‹è½½ï¼š<a href="https://hadoop.apache.org/release/3.4.0.html">https://hadoop.apache.org/release/3.4.0.html</a></p></blockquote><p>æœ¬æ–‡æ¡£è¯¦ç»†è®°å½•äº†å¦‚ä½•æ„å»ºå’Œéƒ¨ç½²ä¸€ä¸ªé›†æˆäº†Sparkã€Hadoopå’ŒZeppelinçš„DockeråŒ–ç¯å¢ƒã€‚è¯¥ç¯å¢ƒæ—¨åœ¨ä¸ºæ•°æ®å·¥ç¨‹å¸ˆæä¾›ä¸€ä¸ªå¼€ç®±å³ç”¨çš„å¤§æ•°æ®åˆ†æå¹³å°ã€‚</p><p>å¦‚æœåªæ˜¯å¸Œæœ›èƒ½ç›´æ¥éƒ¨ç½²ï¼Œè¯·ç›´æ¥çœ‹æœ¬æ–‡ä¸­ docker-compose-with-zeppelin.yml å†…å®¹ï¼Œç„¶åç›´æ¥ <code>docker-compose -f docker-compose-with-zeppelin.yml up -d</code> ã€‚å¦‚æœå¸Œæœ›çŸ¥é“è¿™ä¸ªé›†æˆçš„é•œåƒæ˜¯æ€ä¹ˆæ„å»ºèµ·æ¥çš„ï¼Œå¯ä»¥è¯¦ç»†çœ‹å…¨æ–‡ã€‚</p><h2 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h2><p>é€šè¿‡Dockerå®¹å™¨åŒ–æŠ€æœ¯ï¼Œå°†Sparkã€Hadoopå’ŒZeppelinä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶æ‰“åŒ…åœ¨ä¸€èµ·ï¼Œå½¢æˆä¸€ä¸ªç»Ÿä¸€ã€å¯ç§»æ¤çš„å¼€å‘å’Œåˆ†æç¯å¢ƒã€‚ä¸»è¦ä¼˜åŠ¿åŒ…æ‹¬ï¼š</p><ul><li><strong>ç¯å¢ƒä¸€è‡´æ€§</strong>: é¿å…äº†åœ¨ä¸åŒæœºå™¨ä¸Šå› ç¯å¢ƒå·®å¼‚å¯¼è‡´çš„é—®é¢˜ã€‚</li><li><strong>å¿«é€Ÿéƒ¨ç½²</strong>: é€šè¿‡Docker Composeå¯ä»¥ä¸€é”®å¯åŠ¨æ•´ä¸ªé›†ç¾¤ã€‚</li><li><strong>èµ„æºéš”ç¦»</strong>: æ¯ä¸ªç»„ä»¶éƒ½åœ¨ç‹¬ç«‹çš„å®¹å™¨ä¸­è¿è¡Œï¼Œäº’ä¸å¹²æ‰°ã€‚</li><li><strong>æ˜“äºæ‰©å±•</strong>: å¯ä»¥è½»æ¾åœ°å¢åŠ æˆ–å‡å°‘Sparkå·¥ä½œèŠ‚ç‚¹ã€‚</li></ul><h3 id="1-1-æ ¸å¿ƒç»„ä»¶"><a href="#1-1-æ ¸å¿ƒç»„ä»¶" class="headerlink" title="1.1. æ ¸å¿ƒç»„ä»¶"></a>1.1. æ ¸å¿ƒç»„ä»¶</h3><ul><li><strong>Spark-3.5.6</strong>: ä¸€ä¸ªå¿«é€Ÿã€é€šç”¨çš„å¤§æ•°æ®å¤„ç†å¼•æ“ï¼Œæ”¯æŒæ‰¹å¤„ç†ã€æµå¤„ç†ã€æœºå™¨å­¦ä¹ å’Œå›¾è®¡ç®—ã€‚</li><li><strong>Hadoop-3.4.0</strong>: ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»ŸåŸºç¡€æ¶æ„ï¼Œä¸»è¦ä½¿ç”¨å…¶HDFSï¼ˆåˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿï¼‰å’ŒYARNï¼ˆèµ„æºç®¡ç†å™¨ï¼‰ã€‚</li><li><strong>Zeppelin-0.12.0</strong>: ä¸€ä¸ªåŸºäºWebçš„ç¬”è®°æœ¬ï¼Œæ”¯æŒäº¤äº’å¼æ•°æ®åˆ†æå’Œå¯è§†åŒ–ã€‚</li></ul><h3 id="1-2-æ¶æ„å›¾"><a href="#1-2-æ¶æ„å›¾" class="headerlink" title="1.2. æ¶æ„å›¾"></a>1.2. æ¶æ„å›¾</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    subgraph &quot;Docker ç¯å¢ƒ&quot;        subgraph &quot;Docker Compose&quot;            A[Zeppelin] --&gt; B{Spark Master};            B --&gt; C[Spark Worker 1];            B --&gt; D[Spark Worker 2];            B --&gt; E{Hadoop&#x2F;YARN};            E --&gt; F[HDFS NameNode];            E --&gt; G[HDFS DataNode];        end    end    subgraph &quot;å…±äº«å·&quot;        H[Hadoop é…ç½®] --æŒ‚è½½åˆ°--&gt; A;        H --æŒ‚è½½åˆ°--&gt; B;        I[Spark åº“] --æŒ‚è½½åˆ°--&gt; A;    end    A --æäº¤ä»»åŠ¡--&gt; E;  </pre></div><h2 id="2-ç¯å¢ƒå‡†å¤‡"><a href="#2-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="2. ç¯å¢ƒå‡†å¤‡"></a>2. ç¯å¢ƒå‡†å¤‡</h2><p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‚¨çš„ç³»ç»Ÿå·²å®‰è£…ä»¥ä¸‹è½¯ä»¶ï¼š</p><ul><li><strong>Docker</strong>: <a href="https://www.docker.com/get-started">https://www.docker.com/get-started</a></li><li><strong>Docker Compose</strong>: é€šå¸¸éšDockerä¸€åŒå®‰è£…ã€‚</li><li><strong>ä¸‹è½½hadoop-3.4.0.tar.gz</strong>ï¼š<a href="https://hadoop.apache.org/release/3.4.0.html">https://hadoop.apache.org/release/3.4.0.html</a></li></ul><h2 id="3-ç›®å½•ç»“æ„"><a href="#3-ç›®å½•ç»“æ„" class="headerlink" title="3. ç›®å½•ç»“æ„"></a>3. ç›®å½•ç»“æ„</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ Dockerfile</span><br><span class="line">â”œâ”€â”€ config</span><br><span class="line">â”‚   â”œâ”€â”€ core-site.xml</span><br><span class="line">â”‚   â”œâ”€â”€ hadoop-env.sh</span><br><span class="line">â”‚   â”œâ”€â”€ hdfs-site.xml</span><br><span class="line">â”‚   â”œâ”€â”€ mapred-site.xml</span><br><span class="line">â”‚   â”œâ”€â”€ ssh_config</span><br><span class="line">â”‚   â”œâ”€â”€ workers</span><br><span class="line">â”‚   â””â”€â”€ yarn-site.xml</span><br><span class="line">â”œâ”€â”€ custom-entrypoint.sh</span><br><span class="line">â”œâ”€â”€ docker-compose.yml</span><br><span class="line">â”œâ”€â”€ hadoop-3.4.0.tar.gz</span><br><span class="line">â”œâ”€â”€ share</span><br><span class="line">â”‚   â”œâ”€â”€ my_script.py</span><br><span class="line">â”‚   â””â”€â”€ words.txt</span><br><span class="line">â””â”€â”€ spark-hadoop</span><br><span class="line">    â”œâ”€â”€ README.md</span><br><span class="line">    â”œâ”€â”€ docker-compose-with-zeppelin.yml</span><br><span class="line">    â”œâ”€â”€ docker-compose.yml</span><br><span class="line">    â””â”€â”€ start-cluster.sh</span><br></pre></td></tr></table></figure><ul><li><code>Dockerfile</code>: ç”¨äºæ„å»ºåŒ…å«Sparkå’ŒHadoopçš„è‡ªå®šä¹‰Dockeré•œåƒã€‚</li><li><code>config/</code>: å­˜æ”¾Hadoopçš„é…ç½®æ–‡ä»¶ã€‚</li><li><code>custom-entrypoint.sh</code>: è‡ªå®šä¹‰çš„å®¹å™¨å…¥å£è„šæœ¬ï¼Œç”¨äºåˆå§‹åŒ–HadoopæœåŠ¡ã€‚</li><li><code>docker-compose.yml</code>: ç”¨äºå¯åŠ¨ä¸€ä¸ªåŸºç¡€çš„Sparkå’ŒHadoopé›†ç¾¤ã€‚</li><li><code>hadoop-3.4.0.tar.gz</code>: Hadoopçš„äºŒè¿›åˆ¶åŒ…ã€‚</li><li><code>share/</code>: ç”¨äºä¸å®¹å™¨å…±äº«æ–‡ä»¶çš„æœ¬åœ°ç›®å½•ã€‚</li><li><code>spark-hadoop/</code>: å­˜æ”¾ä¸Zeppeliné›†æˆçš„ç›¸å…³æ–‡ä»¶ã€‚<ul><li><code>docker-compose-with-zeppelin.yml</code>: ç”¨äºå¯åŠ¨åŒ…å«Zeppelinçš„å®Œæ•´é›†ç¾¤ã€‚</li><li><code>start-cluster.sh</code>: å¯åŠ¨é›†ç¾¤çš„ä¾¿æ·è„šæœ¬ã€‚</li></ul></li></ul><h2 id="4-æ„å»ºDockeré•œåƒ"><a href="#4-æ„å»ºDockeré•œåƒ" class="headerlink" title="4. æ„å»ºDockeré•œåƒ"></a>4. æ„å»ºDockeré•œåƒ</h2><p>é•œåƒæ˜¯æ•´ä¸ªç¯å¢ƒçš„åŸºç¡€ã€‚<code>Dockerfile</code>åŸºäº<code>bitnami/spark</code>é•œåƒï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šæ·»åŠ äº†Hadoopã€‚</p><h3 id="4-1-Dockerfileåˆ¶ä½œ"><a href="#4-1-Dockerfileåˆ¶ä½œ" class="headerlink" title="4.1. Dockerfileåˆ¶ä½œ"></a>4.1. Dockerfileåˆ¶ä½œ</h3><ol><li><strong>åŸºç¡€é•œåƒ</strong>: <code>FROM docker.io/bitnami/spark:3.5.6</code></li><li><strong>å®‰è£…ä¾èµ–</strong>: å®‰è£…<code>openssh-server</code>ç­‰Hadoopè¿è¡Œæ‰€éœ€çš„ä¾èµ–ã€‚</li><li><strong>é…ç½®SSH</strong>: ä¸ºHadoopçš„Masterå’ŒWorkerèŠ‚ç‚¹ä¹‹é—´çš„å…å¯†ç™»å½•ç”ŸæˆSSHå¯†é’¥ã€‚</li><li><strong>å®‰è£…Hadoop</strong>:<ul><li>å°†<code>hadoop-3.4.0.tar.gz</code>å¤åˆ¶åˆ°å®¹å™¨ä¸­å¹¶è§£å‹ã€‚</li><li>è®¾ç½®Hadoopç›¸å…³çš„ç¯å¢ƒå˜é‡ï¼Œå¦‚<code>HADOOP_HOME</code>ã€‚</li></ul></li><li><strong>å¤åˆ¶Hadoopé…ç½®</strong>: å°†<code>config/</code>ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶å¤åˆ¶åˆ°å®¹å™¨çš„Hadoopé…ç½®ç›®å½•ä¸­ã€‚</li><li><strong>è‡ªå®šä¹‰å…¥å£ç‚¹</strong>:<ul><li>å°†<code>custom-entrypoint.sh</code>å¤åˆ¶åˆ°å®¹å™¨ä¸­ã€‚</li><li>è®¾ç½®è¯¥è„šæœ¬ä¸ºå®¹å™¨çš„<code>ENTRYPOINT</code>ï¼Œä»¥ç¡®ä¿åœ¨å®¹å™¨å¯åŠ¨æ—¶é¦–å…ˆæ‰§è¡ŒHadoopçš„åˆå§‹åŒ–æ“ä½œã€‚</li></ul></li></ol><p>Dockerfileå†…å®¹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">FROM</span> <span class="string">docker.io/bitnami/spark:3.5.6</span></span><br><span class="line"><span class="string">LABEL</span> <span class="string">maintainer=&quot;kxr</span> <span class="string">&lt;kongxiaoranx@gmail.com&gt;&quot;</span></span><br><span class="line"><span class="string">LABEL</span> <span class="string">description=&quot;Docker</span> <span class="string">image</span> <span class="string">with</span> <span class="string">Spark</span> <span class="string">(3.5.6)</span> <span class="string">and</span> <span class="string">Hadoop</span> <span class="string">(3.4.0),</span> <span class="string">based</span> <span class="string">on</span> <span class="string">bitnami/spark:3.5.6</span> <span class="string">\</span></span><br><span class="line"><span class="string">For</span> <span class="string">more</span> <span class="string">information,</span> <span class="string">please</span> <span class="string">visit</span> <span class="string">https://github.com/kongxiaoran/spark-hadoop-docker.&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">USER</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line"><span class="string">ENV</span> <span class="string">HADOOP_HOME=&quot;/opt/hadoop&quot;</span></span><br><span class="line"><span class="string">ENV</span> <span class="string">HADOOP_CONF_DIR=&quot;$HADOOP_HOME/etc/hadoop&quot;</span></span><br><span class="line"><span class="string">ENV</span> <span class="string">HADOOP_LOG_DIR=&quot;/var/log/hadoop&quot;</span></span><br><span class="line"><span class="string">ENV</span> <span class="string">PATH=&quot;$HADOOP_HOME/hadoop/sbin:$HADOOP_HOME/bin:$PATH&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">WORKDIR</span> <span class="string">/opt</span></span><br><span class="line"></span><br><span class="line"><span class="string">RUN</span> <span class="string">apt-get</span> <span class="string">update</span> <span class="string">&amp;&amp;</span> <span class="string">apt-get</span> <span class="string">install</span> <span class="string">-y</span> <span class="string">\</span></span><br><span class="line">    <span class="string">openssh-server</span> <span class="string">\</span></span><br><span class="line">    <span class="string">curl</span> <span class="string">\</span></span><br><span class="line">    <span class="string">tar</span> <span class="string">\</span></span><br><span class="line">    <span class="string">gzip</span> <span class="string">\</span></span><br><span class="line">    <span class="string">sudo</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">RUN</span> <span class="string">ssh-keygen</span> <span class="string">-t</span> <span class="string">rsa</span> <span class="string">-f</span> <span class="string">/root/.ssh/id_rsa</span> <span class="string">-P</span> <span class="string">&#x27;&#x27;</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">cat</span> <span class="string">/root/.ssh/id_rsa.pub</span> <span class="string">&gt;&gt;</span> <span class="string">/root/.ssh/authorized_keys</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">COPY</span> <span class="string">./hadoop-3.4.0.tar.gz</span> <span class="string">/opt/</span></span><br><span class="line"></span><br><span class="line"><span class="string">RUN</span> <span class="string">tar</span> <span class="string">-xzvf</span> <span class="string">hadoop-3.4.0.tar.gz</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">  <span class="string">mv</span> <span class="string">hadoop-3.4.0</span> <span class="string">hadoop</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">  <span class="string">rm</span> <span class="string">-rf</span> <span class="string">hadoop-3.4.0.tar.gz</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">  <span class="string">mkdir</span> <span class="string">/var/log/hadoop</span></span><br><span class="line"></span><br><span class="line"><span class="string">RUN</span> <span class="string">mkdir</span> <span class="string">-p</span> <span class="string">/root/hdfs/namenode</span> <span class="string">&amp;&amp;</span> <span class="string">\</span> </span><br><span class="line">    <span class="string">mkdir</span> <span class="string">-p</span> <span class="string">/root/hdfs/datanode</span> </span><br><span class="line"></span><br><span class="line"><span class="string">COPY</span> <span class="string">config/*</span> <span class="string">/tmp/</span></span><br><span class="line"></span><br><span class="line"><span class="string">RUN</span> <span class="string">mv</span> <span class="string">/tmp/ssh_config</span> <span class="string">/root/.ssh/config</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">mv</span> <span class="string">/tmp/hadoop-env.sh</span> <span class="string">$HADOOP_CONF_DIR/hadoop-env.sh</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">mv</span> <span class="string">/tmp/hdfs-site.xml</span> <span class="string">$HADOOP_CONF_DIR/hdfs-site.xml</span> <span class="string">&amp;&amp;</span> <span class="string">\</span> </span><br><span class="line">    <span class="string">mv</span> <span class="string">/tmp/core-site.xml</span> <span class="string">$HADOOP_CONF_DIR/core-site.xml</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">mv</span> <span class="string">/tmp/mapred-site.xml</span> <span class="string">$HADOOP_CONF_DIR/mapred-site.xml</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">mv</span> <span class="string">/tmp/yarn-site.xml</span> <span class="string">$HADOOP_CONF_DIR/yarn-site.xml</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">mv</span> <span class="string">/tmp/workers</span> <span class="string">$HADOOP_CONF_DIR/workers</span></span><br><span class="line"></span><br><span class="line"><span class="string">RUN</span> <span class="string">chmod</span> <span class="string">+x</span> <span class="string">$HADOOP_HOME/sbin/start-dfs.sh</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">chmod</span> <span class="string">+x</span> <span class="string">$HADOOP_HOME/sbin/start-yarn.sh</span></span><br><span class="line"><span class="comment">#    sed -i &#x27;s/renice &quot;\$&#123;HADOOP_NICENESS&#125;&quot; \$\$/echo &quot;Skipping renice for \$\$&quot; \&amp;\&amp; true/g&#x27; $HADOOP_HOME/libexec/hadoop-functions.sh </span></span><br><span class="line"></span><br><span class="line"><span class="string">RUN</span> <span class="string">hdfs</span> <span class="string">namenode</span> <span class="string">-format</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨è‡ªå®šä¹‰entrypointè„šæœ¬ï¼ˆä¼˜é›…æ–¹æ¡ˆï¼‰</span></span><br><span class="line"><span class="string">COPY</span> <span class="string">custom-entrypoint.sh</span> <span class="string">/opt/custom-entrypoint.sh</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">chmod</span> <span class="string">+x</span> <span class="string">/opt/custom-entrypoint.sh</span></span><br><span class="line"></span><br><span class="line"><span class="string">ENTRYPOINT</span> [ <span class="string">&quot;/opt/custom-entrypoint.sh&quot;</span> ]</span><br><span class="line"><span class="string">CMD</span> [<span class="string">&quot;/opt/bitnami/scripts/spark/run.sh&quot;</span>]</span><br></pre></td></tr></table></figure><h3 id="4-2-æ„å»ºå‘½ä»¤"><a href="#4-2-æ„å»ºå‘½ä»¤" class="headerlink" title="4.2. æ„å»ºå‘½ä»¤"></a>4.2. æ„å»ºå‘½ä»¤</h3><p>åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥æ„å»ºé•œåƒï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t kongxr7/spark-hadoop:3.5.6-hadoop3.4.0 .</span><br></pre></td></tr></table></figure><h2 id="5-é…ç½®"><a href="#5-é…ç½®" class="headerlink" title="5. é…ç½®"></a>5. é…ç½®</h2><h3 id="5-1-Hadoopé…ç½®"><a href="#5-1-Hadoopé…ç½®" class="headerlink" title="5.1. Hadoopé…ç½®"></a>5.1. Hadoopé…ç½®</h3><p>Hadoopçš„é…ç½®æ–‡ä»¶ä½äº<code>config/</code>ç›®å½•ä¸‹ã€‚æ‚¨å¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹è¿™äº›æ–‡ä»¶ï¼Œä¾‹å¦‚è°ƒæ•´HDFSçš„å‰¯æœ¬æ•°æˆ–YARNçš„å†…å­˜åˆ†é…ã€‚</p><ul><li><code>core-site.xml</code>: é…ç½®HDFSçš„é»˜è®¤æ–‡ä»¶ç³»ç»Ÿã€‚</li><li><code>hdfs-site.xml</code>: é…ç½®HDFSçš„NameNodeå’ŒDataNodeã€‚</li><li><code>yarn-site.xml</code>: é…ç½®YARNçš„ResourceManagerå’ŒNodeManagerã€‚</li><li><code>mapred-site.xml</code>: é…ç½®MapReduceä½œä¸šã€‚</li><li><code>workers</code>: æŒ‡å®šHadoopé›†ç¾¤ä¸­çš„WorkerèŠ‚ç‚¹ã€‚</li><li><code>hadoop-env.sh</code>: Hadoopçš„æ ¸å¿ƒç¯å¢ƒå˜é‡é…ç½®æ–‡ä»¶ã€‚å®ƒç”¨äºè®¾ç½®Hadoopè¿è¡Œæ‰€éœ€çš„ç¯å¢ƒå˜é‡ï¼Œä¾‹å¦‚<code>JAVA_HOME</code>ï¼ˆæŒ‡å®šJavaå®‰è£…è·¯å¾„ï¼‰ã€<code>HADOOP_HOME</code>ï¼ˆæŒ‡å®šHadoopå®‰è£…è·¯å¾„ï¼‰ã€<code>HADOOP_CONF_DIR</code>ï¼ˆæŒ‡å®šHadoopé…ç½®ç›®å½•ï¼‰ç­‰ã€‚æ­¤å¤–ï¼Œè¯¥æ–‡ä»¶è¿˜å…è®¸é…ç½®Hadoopå®ˆæŠ¤è¿›ç¨‹ï¼ˆå¦‚NameNode, DataNode, ResourceManager, NodeManagerï¼‰çš„JVMé€‰é¡¹ã€æ—¥å¿—ç›®å½•ã€ç”¨æˆ·èº«ä»½ç­‰å…³é”®å‚æ•°ã€‚</li><li><code>ssh_config</code>: SSHå®¢æˆ·ç«¯é…ç½®æ–‡ä»¶ã€‚åœ¨æ­¤é¡¹ç›®ä¸­ï¼Œ<code>ssh_config</code>æ–‡ä»¶ç”¨äºå®šä¹‰SSHè¿æ¥çš„é»˜è®¤è¡Œä¸ºï¼Œç‰¹åˆ«æ˜¯ä¸ºäº†å®ç°Hadoopå’ŒSparké›†ç¾¤èŠ‚ç‚¹é—´çš„æ— å¯†ç SSHç™»å½•ã€‚é€šè¿‡é…ç½®<code>StrictHostKeyChecking no</code>å’Œ<code>UserKnownHostsFile=/dev/null</code>ï¼Œå¯ä»¥é¿å…åœ¨èŠ‚ç‚¹é—´é¦–æ¬¡å»ºç«‹SSHè¿æ¥æ—¶éœ€è¦æ‰‹åŠ¨ç¡®è®¤ä¸»æœºå¯†é’¥çš„æç¤ºï¼Œä»è€Œè‡ªåŠ¨åŒ–é›†ç¾¤çš„å¯åŠ¨å’Œç®¡ç†ã€‚</li></ul><blockquote><p>è¿™äº›é…ç½®æ–‡ä»¶çš„å†…å®¹éƒ½è®°å½•åœ¨æ–‡ç« æœ«å°¾çš„é™„å½•ä¸­</p></blockquote><h3 id="5-2-Docker-Composeé…ç½®"><a href="#5-2-Docker-Composeé…ç½®" class="headerlink" title="5.2. Docker Composeé…ç½®"></a>5.2. Docker Composeé…ç½®</h3><p><code>spark-hadoop/docker-compose-with-zeppelin.yml</code>æ–‡ä»¶å®šä¹‰äº†æ•´ä¸ªé›†ç¾¤çš„æœåŠ¡ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;2&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">spark:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">kongxr7/spark-hadoop:3.5.6-hadoop3.4.0</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">master</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_MODE=master</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_RPC_AUTHENTICATION_ENABLED=no</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_RPC_ENCRYPTION_ENABLED=no</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED=no</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_SSL_ENABLED=no</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/Users/kxr/learning/docker/spark/share:/opt/share</span></span><br><span class="line">      <span class="comment"># ç›´æ¥å°†Hadoopé…ç½®ç›®å½•æŒ‚è½½åˆ°å…±äº«å·</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">hadoop_conf:/opt/hadoop/etc/hadoop</span></span><br><span class="line">      <span class="comment"># å°†å®¹å™¨å†…çš„Sparkåº“æŒ‚è½½åˆ°å…±äº«å·</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">spark_lib:/opt/bitnami/spark</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;8090:8080&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;4040:4040&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;8088:8088&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;8042:8042&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;9870:9870&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;19888:19888&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;7077:7077&#x27;</span></span><br><span class="line">  <span class="attr">spark-worker-1:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">kongxr7/spark-hadoop:3.5.6-hadoop3.4.0</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">worker1</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_MODE=worker</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_MASTER_URL=spark://master:7077</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_WORKER_MEMORY=1G</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_WORKER_CORES=1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_RPC_AUTHENTICATION_ENABLED=no</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_RPC_ENCRYPTION_ENABLED=no</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED=no</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_SSL_ENABLED=no</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/Users/kxr/learning/docker/spark/share:/opt/share</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;8081:8081&#x27;</span></span><br><span class="line">  <span class="attr">spark-worker-2:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">kongxr7/spark-hadoop:3.5.6-hadoop3.4.0</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">worker2</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_MODE=worker</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_MASTER_URL=spark://master:7077</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_WORKER_MEMORY=1G</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_WORKER_CORES=1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_RPC_AUTHENTICATION_ENABLED=no</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_RPC_ENCRYPTION_ENABLED=no</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED=no</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_SSL_ENABLED=no</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/Users/kxr/learning/docker/spark/share:/opt/share</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;8082:8081&#x27;</span></span><br><span class="line">  <span class="attr">zeppelin:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">apache/zeppelin:0.12.0</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">zeppelin</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">spark</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPARK_HOME=/opt/spark</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">HADOOP_CONF_DIR=/opt/hadoop/etc/hadoop</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">YARN_CONF_DIR=/opt/hadoop/etc/hadoop</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="comment"># ä½¿ç”¨å…±äº«å·ä¸­çš„Sparkåº“</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">spark_lib:/opt/spark</span></span><br><span class="line">      <span class="comment"># æŒ‚è½½Hadoopé…ç½®ç›®å½•ï¼Œä»sparkå®¹å™¨å…±äº«</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">hadoop_conf:/opt/hadoop/etc/hadoop:ro</span></span><br><span class="line">      <span class="comment"># æŒä¹…åŒ–Zeppelin notebookæ•°æ®</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">zeppelin_notebooks:/opt/zeppelin/notebook</span></span><br><span class="line">      <span class="comment"># æŒä¹…åŒ–Zeppeliné…ç½®</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">zeppelin_conf:/opt/zeppelin/conf</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;8089:8080&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="comment"># åˆ›å»ºä¸€ä¸ªå‘½åå·æ¥å…±äº«Hadoopé…ç½®</span></span><br><span class="line">  <span class="attr">hadoop_conf:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">local</span></span><br><span class="line">  <span class="comment"># åˆ›å»ºä¸€ä¸ªå‘½åå·æ¥å…±äº«Sparkåº“</span></span><br><span class="line">  <span class="attr">spark_lib:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">local</span></span><br><span class="line">  <span class="comment"># Zeppelin notebookæŒä¹…åŒ–å·</span></span><br><span class="line">  <span class="attr">zeppelin_notebooks:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">local</span></span><br><span class="line">  <span class="comment"># Zeppeliné…ç½®æŒä¹…åŒ–å·</span></span><br><span class="line">  <span class="attr">zeppelin_conf:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">local</span></span><br></pre></td></tr></table></figure><h4 id="5-2-1-å…±äº«å·"><a href="#5-2-1-å…±äº«å·" class="headerlink" title="5.2.1. å…±äº«å·"></a>5.2.1. å…±äº«å·</h4><p>ä¸ºäº†å®ç°Zeppelinä¸Spark&#x2F;Hadoopçš„æ— ç¼é›†æˆï¼Œæˆ‘ä»¬ä½¿ç”¨äº†Dockerçš„å…±äº«å·ï¼š</p><ul><li><code>hadoop_conf</code>:<ul><li>åœ¨<code>spark</code>æœåŠ¡ä¸­ï¼Œæˆ‘ä»¬å°†å®¹å™¨å†…çš„Hadoopé…ç½®ç›®å½•<code>/opt/hadoop/etc/hadoop</code>æŒ‚è½½åˆ°è¯¥å·ã€‚</li><li>åœ¨<code>zeppelin</code>æœåŠ¡ä¸­ï¼Œæˆ‘ä»¬å°†è¯¥å·æŒ‚è½½åˆ°<code>/opt/hadoop/etc/hadoop</code>ï¼Œä»è€Œä½¿Zeppelinèƒ½å¤Ÿè®¿é—®Hadoopçš„é…ç½®ã€‚</li></ul></li><li><code>spark_lib</code>:<ul><li>åœ¨<code>spark</code>æœåŠ¡ä¸­ï¼Œæˆ‘ä»¬å°†Sparkçš„åº“ç›®å½•<code>/opt/bitnami/spark</code>æŒ‚è½½åˆ°è¯¥å·ã€‚</li><li>åœ¨<code>zeppelin</code>æœåŠ¡ä¸­ï¼Œæˆ‘ä»¬å°†è¯¥å·æŒ‚è½½åˆ°<code>/opt/spark</code>ï¼Œä»è€Œä½¿Zeppelinèƒ½å¤Ÿä½¿ç”¨ä¸é›†ç¾¤ç‰ˆæœ¬ä¸€è‡´çš„Sparkåº“ã€‚</li></ul></li></ul><p>è¿™ç§è®¾è®¡é¿å…äº†åœ¨Zeppelinå®¹å™¨ä¸­é‡å¤å®‰è£…Sparkå’ŒHadoopï¼Œä¹Ÿæ— éœ€æ‰‹åŠ¨å¤åˆ¶é…ç½®æ–‡ä»¶ï¼Œå¤§å¤§ç®€åŒ–äº†æ¶æ„ã€‚</p><h4 id="5-2-2-ç¯å¢ƒå˜é‡"><a href="#5-2-2-ç¯å¢ƒå˜é‡" class="headerlink" title="5.2.2. ç¯å¢ƒå˜é‡"></a>5.2.2. ç¯å¢ƒå˜é‡</h4><p>åœ¨<code>zeppelin</code>æœåŠ¡ä¸­ï¼Œæˆ‘ä»¬è®¾ç½®äº†ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼Œä»¥å‘ŠçŸ¥Zeppelinå¦‚ä½•æ‰¾åˆ°Sparkå’ŒHadoopï¼š</p><ul><li><code>SPARK_HOME=/opt/spark</code></li><li><code>HADOOP_CONF_DIR=/opt/hadoop/etc/hadoop</code></li><li><code>YARN_CONF_DIR=/opt/hadoop/etc/hadoop</code></li></ul><h2 id="6-éƒ¨ç½²"><a href="#6-éƒ¨ç½²" class="headerlink" title="6. éƒ¨ç½²"></a>6. éƒ¨ç½²</h2><p>è¿›å…¥<code>spark-hadoop/</code>ç›®å½•ï¼Œæ‰§è¡Œä»¥ä¸‹è„šæœ¬å³å¯ä¸€é”®å¯åŠ¨æ•´ä¸ªé›†ç¾¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> spark-hadoop</span><br><span class="line">./start-cluster.sh</span><br></pre></td></tr></table></figure><p>è¯¥è„šæœ¬ä¼šæ‰§è¡Œ<code>docker-compose -f docker-compose-with-zeppelin.yml up -d</code>å‘½ä»¤ï¼Œåœ¨åå°å¯åŠ¨æ‰€æœ‰æœåŠ¡ã€‚</p><h2 id="7-ä½¿ç”¨"><a href="#7-ä½¿ç”¨" class="headerlink" title="7. ä½¿ç”¨"></a>7. ä½¿ç”¨</h2><h3 id="7-1-è®¿é—®æœåŠ¡"><a href="#7-1-è®¿é—®æœåŠ¡" class="headerlink" title="7.1. è®¿é—®æœåŠ¡"></a>7.1. è®¿é—®æœåŠ¡</h3><ul><li><strong>Spark UI</strong>: <a href="http://localhost:8090/">http://localhost:8090</a></li><li><strong>YARN ResourceManager</strong>: <a href="http://localhost:8088/">http://localhost:8088</a></li><li><strong>HDFS NameNode</strong>: <a href="http://localhost:9870/">http://localhost:9870</a></li><li><strong>Zeppelin</strong>: <a href="http://localhost:8089/">http://localhost:8089</a></li></ul><h3 id="7-2-åœ¨Zeppelinä¸­ä½¿ç”¨Spark"><a href="#7-2-åœ¨Zeppelinä¸­ä½¿ç”¨Spark" class="headerlink" title="7.2. åœ¨Zeppelinä¸­ä½¿ç”¨Spark"></a>7.2. åœ¨Zeppelinä¸­ä½¿ç”¨Spark</h3><ol><li>æ‰“å¼€Zeppelinç•Œé¢ã€‚</li><li>åˆ›å»ºä¸€ä¸ªæ–°çš„ç¬”è®°æœ¬ã€‚</li><li>åœ¨ç¬”è®°æœ¬çš„è§£é‡Šå™¨è®¾ç½®ä¸­ï¼Œå°†<code>spark</code>è§£é‡Šå™¨çš„<code>master</code>å±æ€§è®¾ç½®ä¸º<code>yarn</code>ã€‚</li><li>ç°åœ¨ï¼Œå°±å¯ä»¥åœ¨ç¬”è®°æœ¬ä¸­ç¼–å†™Sparkä»£ç ï¼Œå¹¶å°†å…¶æäº¤åˆ°YARNé›†ç¾¤ä¸Šè¿è¡Œã€‚</li></ol><h3 id="7-3-ç¤ºä¾‹ï¼šWord-Count"><a href="#7-3-ç¤ºä¾‹ï¼šWord-Count" class="headerlink" title="7.3. ç¤ºä¾‹ï¼šWord Count"></a>7.3. ç¤ºä¾‹ï¼šWord Count</h3><p>åœ¨Zeppelinç¬”è®°æœ¬ä¸­è¿è¡Œä»¥ä¸‹ä»£ç ï¼Œä½“éªŒåœ¨HDFSä¸Šè¿›è¡Œå•è¯è®¡æ•°çš„å®Œæ•´æµç¨‹ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. å†™å…¥æ•°æ®åˆ°HDFS</span></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç›¸å¯¹è·¯å¾„ &quot;words&quot;ï¼Œæ–‡ä»¶å°†ä¿å­˜åœ¨Zeppelinç”¨æˆ·çš„HDFSä¸»ç›®å½• /user/zeppelin/words</span></span><br><span class="line"><span class="keyword">val</span> text = <span class="string">&quot;hello world hello spark hello hadoop&quot;</span></span><br><span class="line">sc.parallelize(text.split(<span class="string">&quot; &quot;</span>)).saveAsTextFile(<span class="string">&quot;words&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. ä»HDFSè¯»å–æ•°æ®å¹¶æ‰§è¡ŒWord Count</span></span><br><span class="line"><span class="keyword">val</span> wordCounts = sc.textFile(<span class="string">&quot;words&quot;</span>)</span><br><span class="line">    .flatMap(line =&gt; line.split(<span class="string">&quot; &quot;</span>))</span><br><span class="line">    .map(word =&gt; (word, <span class="number">1</span>))</span><br><span class="line">    .reduceByKey(_ + _)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. æ‰“å°ç»“æœ</span></span><br><span class="line">wordCounts.collect().foreach(println)</span><br></pre></td></tr></table></figure><blockquote><p><strong>é‡è¦æç¤ºï¼šHDFS æƒé™è¯´æ˜</strong></p><p>ä¸ºç¡®ä¿ <code>zeppelin</code> ç”¨æˆ·æ‹¥æœ‰å¿…è¦çš„ HDFS æ“ä½œæƒé™ï¼Œç³»ç»Ÿåœ¨å¯åŠ¨æ—¶å·²è‡ªåŠ¨åˆ›å»º <code>/user/zeppelin</code> ç›®å½•å¹¶å°†å…¶è®¾ç½®ä¸º <code>zeppelin</code> ç”¨æˆ·çš„ä¸»ç›®å½•ã€‚</p><p>å› æ­¤ï¼Œåœ¨ Zeppelin ä¸­è¯»å†™ HDFS æ—¶ï¼Œè¯·ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆå¦‚ <code>words</code>ï¼‰æˆ–ä»¥ <code>/user/zeppelin/</code> å¼€å¤´çš„ç»å¯¹è·¯å¾„ï¼Œä»¥é¿å…æƒé™é”™è¯¯ã€‚</p></blockquote><h2 id="é™„å½•ï¼šé…ç½®æ–‡ä»¶å†…å®¹"><a href="#é™„å½•ï¼šé…ç½®æ–‡ä»¶å†…å®¹" class="headerlink" title="é™„å½•ï¼šé…ç½®æ–‡ä»¶å†…å®¹"></a>é™„å½•ï¼šé…ç½®æ–‡ä»¶å†…å®¹</h2><h3 id="A-1-Hadoop-é…ç½®"><a href="#A-1-Hadoop-é…ç½®" class="headerlink" title="A.1 Hadoop é…ç½®"></a>A.1 Hadoop é…ç½®</h3><h4 id="core-site-xml"><a href="#core-site-xml" class="headerlink" title="core-site.xml"></a><code>core-site.xml</code></h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml-stylesheet type=<span class="string">&quot;text/xsl&quot;</span> href=<span class="string">&quot;configuration.xsl&quot;</span>?&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment">  you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment">  You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment">  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment">  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment">  See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment">  limitations under the License. See accompanying LICENSE file.</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Put site-specific property overrides in this file. --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>fs.defaultFS<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://master:9000<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="hadoop-env-sh"><a href="#hadoop-env-sh" class="headerlink" title="hadoop-env.sh"></a><code>hadoop-env.sh</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> JAVA_HOME=/opt/bitnami/java</span><br><span class="line"><span class="built_in">export</span> HADOOP_HOME=/opt/hadoop</span><br><span class="line"><span class="built_in">export</span> HADOOP_MAPRED_HOME=/opt/hadoop</span><br><span class="line"><span class="built_in">export</span> HADOOP_CONF_DIR=/opt/hadoop/etc/hadoop</span><br><span class="line"><span class="built_in">export</span> HADOOP_COMMON_LIB_NATIVE_DIR=<span class="variable">$HADOOP_HOME</span>/lib/native</span><br><span class="line"><span class="built_in">export</span> HADOOP_OPTS=<span class="string">&quot;-Djava.library.path=<span class="variable">$HADOOP_HOME</span>/lib --add-opens java.base/java.lang=ALL-UNNAMED --add-opens java.base/java.util=ALL-UNNAMED --add-opens java.base/java.lang.reflect=ALL-UNNAMED --add-opens java.base/java.text=ALL-UNNAMED --add-opens java.desktop/java.awt.font=ALL-UNNAMED&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> HDFS_NAMENODE_USER=<span class="string">&quot;root&quot;</span></span><br><span class="line"><span class="built_in">export</span> HDFS_DATANODE_USER=<span class="string">&quot;root&quot;</span></span><br><span class="line"><span class="built_in">export</span> HDFS_SECONDARYNAMENODE_USER=<span class="string">&quot;root&quot;</span></span><br><span class="line"><span class="built_in">export</span> YARN_RESOURCEMANAGER_USER=<span class="string">&quot;root&quot;</span></span><br><span class="line"><span class="built_in">export</span> YARN_NODEMANAGER_USER=<span class="string">&quot;root&quot;</span></span><br></pre></td></tr></table></figure><h4 id="hdfs-site-xml"><a href="#hdfs-site-xml" class="headerlink" title="hdfs-site.xml"></a><code>hdfs-site.xml</code></h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml-stylesheet type=<span class="string">&quot;text/xsl&quot;</span> href=<span class="string">&quot;configuration.xsl&quot;</span>?&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment">  you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment">  You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment">  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment">  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment">  See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment">  limitations under the License. See accompanying LICENSE file.</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Put site-specific property overrides in this file. --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.name.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>file:///root/hdfs/namenode<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>NameNode directory for namespace and transaction logs storage.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.datanode.data.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>file:///root/hdfs/datanode<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>DataNode directory<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.replication<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>2<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="mapred-site-xml"><a href="#mapred-site-xml" class="headerlink" title="mapred-site.xml"></a><code>mapred-site.xml</code></h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml-stylesheet type=<span class="string">&quot;text/xsl&quot;</span> href=<span class="string">&quot;configuration.xsl&quot;</span>?&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment">  you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment">  You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment">  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment">  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment">  See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment">  limitations under the License. See accompanying LICENSE file.</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Put site-specific property overrides in this file. --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.framework.name<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>yarn<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.app.mapreduce.am.env<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>HADOOP_MAPRED_HOME=/opt/hadoop<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.map.env<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>HADOOP_MAPRED_HOME=/opt/hadoop<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.reduce.env<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>HADOOP_MAPRED_HOME=/opt/hadoop<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span> </span><br><span class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.application.classpath<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">value</span>&gt;</span>$HADOOP_MAPRED_HOME/share/hadoop/mapreduce/*,$HADOOP_MAPRED_HOME/share/hadoop/mapreduce/lib/*,$HADOOP_MAPRED_HOME/share/hadoop/common/*,$HADOOP_MAPRED_HOME/share/hadoop/common/lib/*,$HADOOP_MAPRED_HOME/share/hadoop/yarn/*,$HADOOP_MAPRED_HOME/share/hadoop/yarn/lib/*,$HADOOP_MAPRED_HOME/share/hadoop/hdfs/*,$HADOOP_MAPRED_HOME/share/hadoop/hdfs/lib/*<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="yarn-site-xml"><a href="#yarn-site-xml" class="headerlink" title="yarn-site.xml"></a><code>yarn-site.xml</code></h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment">  you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment">  You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment">  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment">  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment">  See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment">  limitations under the License. See accompanying LICENSE file.</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Site specific YARN configuration properties --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.aux-services<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>mapreduce_shuffle<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.aux-services.mapreduce_shuffle.class<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>org.apache.hadoop.mapred.ShuffleHandler<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.hostname<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>master<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.env-whitelist<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>JAVA_HOME,HADOOP_COMMON_HOME,HADOOP_HDFS_HOME,HADOOP_CONF_DIR,CLASSPATH_PREPEND_DISTCACHE,HADOOP_YARN_HOME,HADOOP_MAPRED_HOME<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="workers"><a href="#workers" class="headerlink" title="workers"></a><code>workers</code></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">worker1</span><br><span class="line">worker2</span><br></pre></td></tr></table></figure><h4 id="ssh-config"><a href="#ssh-config" class="headerlink" title="ssh_config"></a><code>ssh_config</code></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Host localhost</span><br><span class="line">  StrictHostKeyChecking no</span><br><span class="line"></span><br><span class="line">Host 0.0.0.0</span><br><span class="line">  StrictHostKeyChecking no</span><br><span class="line">  </span><br><span class="line">Host hadoop-*</span><br><span class="line">   StrictHostKeyChecking no</span><br><span class="line">   UserKnownHostsFile=/dev/null</span><br></pre></td></tr></table></figure><h4 id="start-cluster-sh"><a href="#start-cluster-sh" class="headerlink" title="start-cluster.sh"></a><code>start-cluster.sh</code></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line"># å¯åŠ¨é›†ç¾¤çš„è„šæœ¬</span><br><span class="line"># æ­¤è„šæœ¬ç”¨äºå¯åŠ¨æ•´ä¸ªSpark-Hadoop-Zeppeliné›†ç¾¤</span><br><span class="line"></span><br><span class="line">echo &quot;=== å¯åŠ¨Spark-Hadoop-Zeppeliné›†ç¾¤ ===&quot;</span><br><span class="line"></span><br><span class="line"># ç¡®ä¿docker-composeå·²åœæ­¢</span><br><span class="line">docker-compose -f docker-compose-with-zeppelin.yml down</span><br><span class="line"></span><br><span class="line"># å¯åŠ¨docker-compose</span><br><span class="line">docker-compose -f docker-compose-with-zeppelin.yml up -d</span><br><span class="line"></span><br><span class="line">echo &quot;=== é›†ç¾¤å¯åŠ¨å®Œæˆ ===&quot;</span><br><span class="line">echo &quot;Spark UI: http://localhost:8090&quot;</span><br><span class="line">echo &quot;HDFS UI: http://localhost:9870&quot;</span><br><span class="line">echo &quot;YARN UI: http://localhost:8088&quot;</span><br><span class="line">echo &quot;Zeppelin UI: http://localhost:8089&quot;</span><br></pre></td></tr></table></figure><p><code>custom-entrypoint.sh</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line"># è‡ªå®šä¹‰entrypointè„šæœ¬ - ä¼˜é›…çš„å¯åŠ¨æ–¹æ¡ˆ</span><br><span class="line"># ä¸ä¿®æ”¹åŸå§‹entrypoint.shï¼Œå®Œå…¨è‡ªå®šä¹‰å¯åŠ¨æµç¨‹</span><br><span class="line"></span><br><span class="line">echo &quot;=== Starting Custom Entrypoint ===&quot;</span><br><span class="line"></span><br><span class="line"># å¯åŠ¨SSHæœåŠ¡</span><br><span class="line">echo &quot;Starting SSH service...&quot;</span><br><span class="line">service ssh start</span><br><span class="line"></span><br><span class="line"># å¯åŠ¨HadoopæœåŠ¡</span><br><span class="line">echo &quot;Starting Hadoop services...&quot;</span><br><span class="line"></span><br><span class="line"># è®¾ç½®Hadoopç¯å¢ƒå˜é‡</span><br><span class="line">export HADOOP_NICENESS=0</span><br><span class="line">export HADOOP_SECURE_DN_USER=&quot;&quot;</span><br><span class="line"></span><br><span class="line"># å¯åŠ¨HDFSæœåŠ¡ï¼ˆå¦‚æœæœªè¿è¡Œï¼‰</span><br><span class="line">if ! pgrep -f &quot;org.apache.hadoop.hdfs.server.namenode.NameNode&quot; &gt; /dev/null; then</span><br><span class="line">    echo &quot;Starting HDFS services...&quot;</span><br><span class="line">    $HADOOP_HOME/sbin/start-dfs.sh || true</span><br><span class="line">else</span><br><span class="line">    echo &quot;HDFS services already running&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># å¯åŠ¨YARNæœåŠ¡ï¼ˆå¦‚æœæœªè¿è¡Œï¼‰</span><br><span class="line">if ! pgrep -f &quot;org.apache.hadoop.yarn.server.resourcemanager.ResourceManager&quot; &gt; /dev/null; then</span><br><span class="line">    echo &quot;Starting YARN services...&quot;</span><br><span class="line">    $HADOOP_HOME/sbin/start-yarn.sh || true</span><br><span class="line">else</span><br><span class="line">    echo &quot;YARN services already running&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># ä¸ºZeppelinç”¨æˆ·åˆ›å»ºHDFSç›®å½•å¹¶æˆæƒ</span><br><span class="line">echo &quot;Creating HDFS directories for Zeppelin user...&quot;</span><br><span class="line"># ç­‰å¾…HDFSå®Œå…¨å¯åŠ¨</span><br><span class="line">sleep 5</span><br><span class="line"># åˆ›å»ºzeppelinç”¨æˆ·ç›®å½•</span><br><span class="line">hdfs dfs -mkdir -p /user/zeppelin || true</span><br><span class="line"># æ›´æ”¹ç›®å½•æ‰€æœ‰æƒ</span><br><span class="line">hdfs dfs -chown zeppelin:zeppelin /user/zeppelin || true</span><br><span class="line"># è®¾ç½®ç›®å½•æƒé™</span><br><span class="line">hdfs dfs -chmod 777 /user/zeppelin || true</span><br><span class="line"></span><br><span class="line">echo &quot;HDFS directories for Zeppelin user created and authorized.&quot;</span><br><span class="line"></span><br><span class="line">echo &quot;=== All services started successfully! ===&quot;</span><br><span class="line">echo &quot;=== Calling original Spark entrypoint ===&quot;</span><br><span class="line"></span><br><span class="line"># è°ƒç”¨åŸå§‹Spark entrypointï¼Œä¼ é€’æ‰€æœ‰å‚æ•°</span><br><span class="line">exec /opt/bitnami/scripts/spark/entrypoint.sh &quot;$@&quot;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> å¤§æ•°æ® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spark </tag>
            
            <tag> å¤§æ•°æ® </tag>
            
            <tag> Hadoop </tag>
            
            <tag> Zeppelin </tag>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Zeppelin ä½¿ç”¨ä½“éªŒ</title>
      <link href="/2025/09/07/Zeppelin%20%E4%BD%BF%E7%94%A8%E4%BD%93%E9%AA%8C/"/>
      <url>/2025/09/07/Zeppelin%20%E4%BD%BF%E7%94%A8%E4%BD%93%E9%AA%8C/</url>
      
        <content type="html"><![CDATA[<h1 id="Zeppelinéƒ¨ç½²ä½¿ç”¨"><a href="#Zeppelinéƒ¨ç½²ä½¿ç”¨" class="headerlink" title="Zeppelinéƒ¨ç½²ä½¿ç”¨"></a>Zeppelinéƒ¨ç½²ä½¿ç”¨</h1><blockquote><p>å®˜æ–¹ä¸‹è½½é¡µé¢ï¼š<a href="https://zeppelin.apache.org/download.html">https://zeppelin.apache.org/download.html</a><br>å®˜æ–¹æ–‡æ¡£é¡µé¢ï¼š<a href="https://zeppelin.apache.org/docs/0.12.0/">https://zeppelin.apache.org/docs/0.12.0/</a></p></blockquote><h2 id="1-èƒŒæ™¯ï¼š"><a href="#1-èƒŒæ™¯ï¼š" class="headerlink" title="1.èƒŒæ™¯ï¼š"></a>1.èƒŒæ™¯ï¼š</h2><p>å­¦ä¹ è¿™ä¸ªå·¥å…·çš„åŸå› ï¼Œæ˜¯å› ä¸ºåé¢æƒ³è¦è°ƒç ”â€”â€”æ˜¯å¦å¯ä»¥å°† zeppelin çš„sparkè§£é‡Šå™¨æ‹†è§£å‡ºæ¥é›†æˆåˆ°ç³»ç»Ÿä¸­ã€‚</p><h2 id="2-æ ¸å¿ƒåŠŸèƒ½ä¸ç”¨é€”"><a href="#2-æ ¸å¿ƒåŠŸèƒ½ä¸ç”¨é€”" class="headerlink" title="2.æ ¸å¿ƒåŠŸèƒ½ä¸ç”¨é€”"></a>2.æ ¸å¿ƒåŠŸèƒ½ä¸ç”¨é€”</h2><h4 id="1-æ”¯æŒå¤šè¯­è¨€çš„-â€œäº¤äº’å¼ç¬”è®°æœ¬ï¼ˆNotebookï¼‰â€"><a href="#1-æ”¯æŒå¤šè¯­è¨€çš„-â€œäº¤äº’å¼ç¬”è®°æœ¬ï¼ˆNotebookï¼‰â€" class="headerlink" title="1. æ”¯æŒå¤šè¯­è¨€çš„ â€œäº¤äº’å¼ç¬”è®°æœ¬ï¼ˆNotebookï¼‰â€"></a>1. æ”¯æŒå¤šè¯­è¨€çš„ â€œäº¤äº’å¼ç¬”è®°æœ¬ï¼ˆNotebookï¼‰â€</h4><p>è¿™æ˜¯ Zeppelin æœ€æ ¸å¿ƒçš„åŠŸèƒ½ï¼Œç±»ä¼¼ Jupyter Notebookï¼Œä½†å¯¹å¤§æ•°æ®å·¥å…·çš„é€‚é…æ›´æ·±å…¥ï¼š</p><ul><li><p>å¤šè¯­è¨€å†…æ ¸æ”¯æŒ</p><p>ï¼šè‡ªå¸¦å¯¹ä¸»æµæ•°æ®å¤„ç†è¯­è¨€ &#x2F; æ¡†æ¶çš„é›†æˆï¼Œæ— éœ€é¢å¤–å¤æ‚é…ç½®ï¼Œä¾‹å¦‚ï¼š</p><ul><li>å¤§æ•°æ®è®¡ç®—ï¼šSparkï¼ˆScala&#x2F;Python&#x2F;Javaï¼‰ã€Flinkã€Hiveã€Pigï¼›</li><li>è„šæœ¬è¯­è¨€ï¼šPythonã€Rã€Shellã€SQLï¼›</li><li>å…¶ä»–ï¼šMarkdownï¼ˆå†™æ³¨é‡Š &#x2F; æŠ¥å‘Šï¼‰ã€JDBCï¼ˆè¿æ¥ MySQL&#x2F;PostgreSQL ç­‰å…³ç³»å‹æ•°æ®åº“ï¼‰ã€‚</li></ul></li><li><p><strong>â€œä»£ç å— + å³æ—¶æ‰§è¡Œâ€ æ¨¡å¼</strong>ï¼šå°†ä»£ç æ‹†åˆ†ä¸ºå¤šä¸ª â€œæ®µè½ï¼ˆParagraphï¼‰â€ï¼Œæ¯ä¸ªæ®µè½å¯ç‹¬ç«‹æ‰§è¡Œï¼ˆæ— éœ€ç­‰å¾…æ•´ä¸ªè„šæœ¬è·‘å®Œï¼‰ï¼Œæ‰§è¡Œç»“æœï¼ˆæ–‡æœ¬ã€è¡¨æ ¼ã€å›¾è¡¨ï¼‰å®æ—¶æ˜¾ç¤ºåœ¨ä»£ç ä¸‹æ–¹ï¼Œæ–¹ä¾¿å¿«é€Ÿè°ƒè¯•å’Œè¿­ä»£ï¼ˆæ¯”å¦‚æ•°æ®æ¸…æ´—æ—¶ï¼Œæ¯ä¸€æ­¥éƒ½èƒ½éªŒè¯ç»“æœæ˜¯å¦æ­£ç¡®ï¼‰ã€‚</p></li></ul><h4 id="2-æ— ç¼é›†æˆå¤§æ•°æ®ç”Ÿæ€"><a href="#2-æ— ç¼é›†æˆå¤§æ•°æ®ç”Ÿæ€" class="headerlink" title="2. æ— ç¼é›†æˆå¤§æ•°æ®ç”Ÿæ€"></a>2. æ— ç¼é›†æˆå¤§æ•°æ®ç”Ÿæ€</h4><p>Zeppelin å¤©ç”Ÿä¸ºå¤§æ•°æ®åœºæ™¯è®¾è®¡ï¼Œèƒ½è½»æ¾å¯¹æ¥ Hadoop&#x2F;Spark é›†ç¾¤ï¼ˆè¿™ä¹Ÿé€‚é…ä½ ä¹‹å‰æåˆ°çš„ â€œZeppelin å•ç‹¬éƒ¨ç½²ã€Spark-Hadoop é›†ç¾¤å•ç‹¬éƒ¨ç½²â€ çš„æ¶æ„ï¼‰ï¼š</p><ul><li>æ— éœ€åœ¨æœ¬åœ°å®‰è£…å¤æ‚çš„å¤§æ•°æ®ç¯å¢ƒï¼Œåªéœ€åœ¨ Zeppelin ä¸­é…ç½® Spark&#x2F;Hadoop çš„è¿æ¥ä¿¡æ¯ï¼ˆå¦‚ YARN èµ„æºç®¡ç†å™¨åœ°å€ã€Spark Master åœ°å€ï¼‰ï¼Œå³å¯ç›´æ¥æäº¤ä»»åŠ¡åˆ°è¿œç¨‹é›†ç¾¤æ‰§è¡Œï¼›</li><li>æ”¯æŒè¯»å– HDFSã€Hive è¡¨ã€HBase ç­‰åˆ†å¸ƒå¼å­˜å‚¨ä¸­çš„æ•°æ®ï¼Œæ— éœ€æ‰‹åŠ¨å†™å¤æ‚çš„æ–‡ä»¶è·¯å¾„æˆ–è¿æ¥é€»è¾‘ã€‚</li></ul><h4 id="3-å†…ç½®å¯è§†åŒ–ä¸æŠ¥å‘Šç”Ÿæˆ"><a href="#3-å†…ç½®å¯è§†åŒ–ä¸æŠ¥å‘Šç”Ÿæˆ" class="headerlink" title="3. å†…ç½®å¯è§†åŒ–ä¸æŠ¥å‘Šç”Ÿæˆ"></a>3. å†…ç½®å¯è§†åŒ–ä¸æŠ¥å‘Šç”Ÿæˆ</h4><p>æ•°æ®åˆ†æçš„æ ¸å¿ƒæ˜¯ â€œè®©ç»“æœæ˜“æ‡‚â€ï¼ŒZeppelin ç®€åŒ–äº†å¯è§†åŒ–æµç¨‹ï¼š</p><ul><li>æ‰§è¡Œ SQL&#x2F;Spark ä»£ç åï¼Œç»“æœè¡¨æ ¼å¯ç›´æ¥ä¸€é”®è½¬æ¢ä¸º<strong>æŸ±çŠ¶å›¾ã€æŠ˜çº¿å›¾ã€é¥¼å›¾ã€åœ°å›¾</strong>ç­‰å¯è§†åŒ–å›¾è¡¨ï¼ˆæ— éœ€é¢å¤–å†™ Matplotlib&#x2F;Seaborn ä»£ç ï¼‰ï¼›</li><li>æ•´ä¸ª Notebookï¼ˆå«ä»£ç ã€æ³¨é‡Šã€å›¾è¡¨ï¼‰å¯å¯¼å‡ºä¸º HTML&#x2F;PDFï¼Œæˆ–ç›´æ¥åˆ†äº«é“¾æ¥ç»™å›¢é˜Ÿï¼Œæ–¹ä¾¿åä½œä¸æ±‡æŠ¥ï¼ˆæ¯”å¦‚æ•°æ®åˆ†ææŠ¥å‘Šå¯ç›´æ¥åœ¨ Zeppelin ä¸­å†™å®Œï¼Œæ— éœ€å†å¤åˆ¶åˆ° Word&#x2F;PPTï¼‰ã€‚</li></ul><h4 id="4-ä»»åŠ¡è°ƒåº¦ä¸å…±äº«åä½œ"><a href="#4-ä»»åŠ¡è°ƒåº¦ä¸å…±äº«åä½œ" class="headerlink" title="4. ä»»åŠ¡è°ƒåº¦ä¸å…±äº«åä½œ"></a>4. ä»»åŠ¡è°ƒåº¦ä¸å…±äº«åä½œ</h4><p>é™¤äº†äº¤äº’å¼åˆ†æï¼ŒZeppelin è¿˜æ”¯æŒè‡ªåŠ¨åŒ–ä¸å›¢é˜Ÿåä½œï¼š</p><ul><li>å¯å°† Notebook è®¾ç½®ä¸º<strong>å®šæ—¶ä»»åŠ¡</strong>ï¼ˆå¦‚æ¯å¤©å‡Œæ™¨æ‰§è¡Œæ•°æ®æ¸…æ´—è„šæœ¬ï¼Œç”Ÿæˆæ—¥æŠ¥å›¾è¡¨ï¼‰ï¼Œæ‰§è¡Œç»“æœå¯é€šè¿‡é‚®ä»¶æ¨é€ï¼›</li><li>æ”¯æŒå¤šç”¨æˆ·æƒé™ç®¡ç†ï¼ˆå¦‚ç®¡ç†å‘˜ã€åˆ†æå¸ˆã€åªè¯»ç”¨æˆ·ï¼‰ï¼Œå›¢é˜Ÿæˆå‘˜å¯å…±åŒç¼–è¾‘ä¸€ä¸ª Notebookï¼Œæˆ–æŸ¥çœ‹ä»–äººçš„åˆ†ææˆæœï¼Œé¿å…é‡å¤åŠ³åŠ¨ã€‚</li></ul><h4 id="5-å…¸å‹ä½¿ç”¨åœºæ™¯"><a href="#5-å…¸å‹ä½¿ç”¨åœºæ™¯" class="headerlink" title="5.å…¸å‹ä½¿ç”¨åœºæ™¯"></a>5.å…¸å‹ä½¿ç”¨åœºæ™¯</h4><ol><li><strong>å¤§æ•°æ®æ¢ç´¢ä¸è°ƒè¯•</strong>ï¼šæ•°æ®å·¥ç¨‹å¸ˆåœ¨å¼€å‘ Spark ä»»åŠ¡æ—¶ï¼Œç”¨ Zeppelin åˆ†æ®µæ‰§è¡Œä»£ç ï¼Œå®æ—¶æŸ¥çœ‹ä¸­é—´ç»“æœï¼Œå¿«é€Ÿå®šä½ bugï¼ˆæ¯”ç›´æ¥æäº¤å®Œæ•´ Jar åŒ…åˆ° YARN è°ƒè¯•æ•ˆç‡é«˜å¾—å¤šï¼‰ï¼›</li><li><strong>æ•°æ®åˆ†æä¸å¯è§†åŒ–</strong>ï¼šæ•°æ®åˆ†æå¸ˆç”¨ SQL æŸ¥è¯¢ Hive è¡¨ï¼Œæˆ–ç”¨ Python å¤„ç†æ•°æ®ï¼Œç›´æ¥åœ¨ Notebook ä¸­ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨ï¼Œå¿«é€Ÿè¾“å‡ºåˆ†æç»“è®ºï¼›</li><li><strong>æ•°æ®ç§‘å­¦å»ºæ¨¡</strong>ï¼šæ•°æ®ç§‘å­¦å®¶ç”¨ Spark MLlib æˆ– Python çš„ Scikit-learn æ„å»ºæ¨¡å‹ï¼Œåˆ†æ®µæ‰§è¡Œç‰¹å¾å·¥ç¨‹ã€æ¨¡å‹è®­ç»ƒã€æ•ˆæœè¯„ä¼°ä»£ç ï¼Œå®æ—¶è°ƒæ•´å‚æ•°ï¼›</li><li><strong>å›¢é˜ŸçŸ¥è¯†æ²‰æ·€</strong>ï¼šå°†å¸¸ç”¨çš„æ•°æ®åˆ†ææµç¨‹ã€è„šæœ¬æ¨¡æ¿ã€ä¸šåŠ¡æŠ¥å‘Šä»¥ Notebook å½¢å¼ä¿å­˜åœ¨ Zeppelin ä¸­ï¼Œæ–¹ä¾¿æ–°äººå¤ç”¨æˆ–å›¢é˜Ÿå…±äº«ç»éªŒã€‚</li></ol><h2 id="3-å®æ“éƒ¨ç½²"><a href="#3-å®æ“éƒ¨ç½²" class="headerlink" title="3.å®æ“éƒ¨ç½²"></a>3.å®æ“éƒ¨ç½²</h2><h4 id="ï¼ˆ1ï¼‰ä¸‹è½½sparkã€å¯åŠ¨zeppelin"><a href="#ï¼ˆ1ï¼‰ä¸‹è½½sparkã€å¯åŠ¨zeppelin" class="headerlink" title="ï¼ˆ1ï¼‰ä¸‹è½½sparkã€å¯åŠ¨zeppelin"></a>ï¼ˆ1ï¼‰ä¸‹è½½sparkã€å¯åŠ¨zeppelin</h4><p>zeppelinæœ€æ–°ç‰ˆæœ¬æ˜¯0.12.0ï¼Œç›®å‰æš‚æ—¶ä¸æ”¯æŒspark4ã€‚ä¸è¿‡æˆ‘çœ‹ä¸‹ä¸ªç‰ˆæœ¬å¯èƒ½å°±ä¼šæ”¯æŒï¼Œå·²ç»çœ‹åˆ°äº†å¯¹äºspark4.0å®˜æ–¹æ”¯æŒçš„ä»£ç æäº¤è®°å½•äº†ã€‚zeppelin 0.12.0 è¦æ±‚sparkç‰ˆæœ¬åœ¨spark-3.2ä»¥ä¸Šï¼Œè¿™é‡Œæˆ‘é€‰ç”¨çš„æ˜¯spark-3.5.6ã€‚</p><blockquote><p>sparkä¸‹è½½åœ°å€ï¼š<a href="https://spark.apache.org/downloads.html">https://spark.apache.org/downloads.html</a></p></blockquote><p>ä¸‹è½½ä¹‹åè§£å‹æ”¾åœ¨å½“å‰ç›®å½•ä¸‹ï¼Œç„¶ådockeréƒ¨ç½²ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 8089:8080 -v ./spark-3.5.6-bin-hadoop3:/opt/spark -e SPARK_HOME=/opt/spark --<span class="built_in">rm</span> --name zeppelin apache/zeppelin:0.12.0</span><br></pre></td></tr></table></figure><p>å¯åŠ¨èµ·æ¥å°±å¯ä»¥è®¿é—®ï¼š<a href="http://localhost:8089/">http://localhost:8089/</a></p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/image-20250910093320735.png" alt="image-20250910093320735"></p><h4 id="ï¼ˆ2ï¼‰æ–°å»º-new-Note"><a href="#ï¼ˆ2ï¼‰æ–°å»º-new-Note" class="headerlink" title="ï¼ˆ2ï¼‰æ–°å»º new Note"></a>ï¼ˆ2ï¼‰æ–°å»º new Note</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">%spark</span><br><span class="line">// æŸ¥çœ‹ Spark é›†ç¾¤ä¿¡æ¯</span><br><span class="line">println(sc.master)  // åº”è¾“å‡ºè¿œç¨‹ Spark ä¸»èŠ‚ç‚¹åœ°å€</span><br><span class="line"></span><br><span class="line">// æ‰§è¡Œç®€å•è®¡ç®—ï¼ŒéªŒè¯æ˜¯å¦èƒ½æ­£å¸¸ä½¿ç”¨é›†ç¾¤èµ„æº</span><br><span class="line">val rdd = sc.parallelize(1 to 1000)</span><br><span class="line">println(s&quot;RDD åˆ†åŒºæ•°ï¼š$&#123;rdd.getNumPartitions&#125;&quot;)</span><br><span class="line">println(s&quot;è®¡ç®—ç»“æœï¼š$&#123;rdd.sum()&#125;&quot;)</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/image-20250913102039849.png" alt="image-20250913102039849"></p><p>å°±å¯ä»¥ç‚¹å‡» æ‰§è¡Œå›¾æ ‡ï¼ˆRun paragraphï¼‰</p><p>çœ‹åˆ°æ­£ç¡®çš„è¾“å‡ºç»“æœï¼Œå…¶å®ä½ å°±å·²ç»å®Œæˆäº†ä¸€ä¸ªå°demoäº†ã€‚</p><h4 id="ï¼ˆ3ï¼‰é…ç½®sparkè§£é‡Šå™¨"><a href="#ï¼ˆ3ï¼‰é…ç½®sparkè§£é‡Šå™¨" class="headerlink" title="ï¼ˆ3ï¼‰é…ç½®sparkè§£é‡Šå™¨"></a>ï¼ˆ3ï¼‰é…ç½®sparkè§£é‡Šå™¨</h4><p>é¡µé¢å³ä¸Šè§’æœ‰å¯ä»¥é…ç½®zeppelin å„ç§è§£é‡Šå™¨å…¥å£ï¼š<a href="http://localhost:8089/#/interpreter">http://localhost:8089/#/interpreter</a></p><p>å¦‚ä¸‹æ˜¯é»˜è®¤çš„ zeppelin sparkè§£é‡Šå™¨é…ç½®ï¼š</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/image-20250913102207871.png" alt="image-20250913102207871"></p><p>å¦‚æœä½ å¸Œæœ›é…ç½®sparké›†ç¾¤ï¼š</p><table><thead><tr><th>name</th><th>value</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td>SPARK_HOME</td><td>&#x2F;opt&#x2F;spark</td><td>sparkå®‰è£…åœ°å€</td></tr><tr><td>spark.master</td><td>spark:&#x2F;&#x2F;master:7077</td><td>sparkä¸»èŠ‚ç‚¹åœ°å€</td></tr></tbody></table><p>å¦‚æœæƒ³è¦æäº¤åˆ°yarnä¸Šæ‰§è¡Œï¼š</p><table><thead><tr><th>name</th><th>value</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td>SPARK_HOME</td><td>&#x2F;opt&#x2F;spark</td><td>sparkå®‰è£…åœ°å€</td></tr><tr><td>spark.master</td><td>yarn</td><td>sparkä¸»èŠ‚ç‚¹åœ°å€</td></tr><tr><td>spark.submit.deployMode</td><td>client</td><td>å¯é€‰client&#x2F;clusterï¼Œä»£è¡¨ä¸¤ç§æäº¤æ¨¡å¼</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> å¤§æ•°æ® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spark </tag>
            
            <tag> å¤§æ•°æ® </tag>
            
            <tag> Zeppelin </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å­¦ä¹ Spark4.0æºç ã€1ã€‘â€”â€”ä¸‹è½½å¹¶è¿è¡Œsparkå¹¶è¿›è¡Œdebug</title>
      <link href="/2025/08/30/%E5%AD%A6%E4%B9%A0Spark4.0%E6%BA%90%E7%A0%81%E3%80%901%E3%80%91%E2%80%94%E2%80%94%E4%B8%8B%E8%BD%BD%E5%B9%B6%E8%BF%90%E8%A1%8C%20spark,%E5%B9%B6%E8%BF%9B%E8%A1%8Cdebug%20/"/>
      <url>/2025/08/30/%E5%AD%A6%E4%B9%A0Spark4.0%E6%BA%90%E7%A0%81%E3%80%901%E3%80%91%E2%80%94%E2%80%94%E4%B8%8B%E8%BD%BD%E5%B9%B6%E8%BF%90%E8%A1%8C%20spark,%E5%B9%B6%E8%BF%9B%E8%A1%8Cdebug%20/</url>
      
        <content type="html"><![CDATA[<h1 id="å­¦ä¹ Spark4-0æºç ã€1ã€‘â€”â€”ä¸‹è½½å¹¶è¿è¡Œsparkå¹¶è¿›è¡Œdebug"><a href="#å­¦ä¹ Spark4-0æºç ã€1ã€‘â€”â€”ä¸‹è½½å¹¶è¿è¡Œsparkå¹¶è¿›è¡Œdebug" class="headerlink" title="å­¦ä¹ Spark4.0æºç ã€1ã€‘â€”â€”ä¸‹è½½å¹¶è¿è¡Œsparkå¹¶è¿›è¡Œdebug"></a>å­¦ä¹ Spark4.0æºç ã€1ã€‘â€”â€”ä¸‹è½½å¹¶è¿è¡Œsparkå¹¶è¿›è¡Œdebug</h1><blockquote><p>å®˜ç½‘æ–‡æ¡£ï¼š<a href="https://spark.apache.org/docs/4.0.0/">https://spark.apache.org/docs/4.0.0/</a></p></blockquote><p>æƒ³è¦å­¦ä¹ Spark4.0æºç ï¼Œç¬¬ä¸€æ­¥æ˜¯æ­å»ºæºç å­¦ä¹ ç¯å¢ƒï¼Œç„¶åå­¦ä¼šå¦‚ä½•å°†sparkè·‘èµ·æ¥ï¼Œå¹¶debugã€‚</p><h2 id="1-ä¸‹è½½-Apache-Spark-4-0-0"><a href="#1-ä¸‹è½½-Apache-Spark-4-0-0" class="headerlink" title="1.ä¸‹è½½ Apache Spark 4.0.0"></a>1.ä¸‹è½½ Apache Spark 4.0.0</h2><blockquote><p>githubåœ°å€ï¼š<a href="https://github.com/apache/spark">https://github.com/apache/spark</a></p><p>äºŒè¿›åˆ¶å‘è¡Œç‰ˆä¸‹è½½é¡µé¢ï¼š<a href="https://spark.apache.org/downloads.html">https://spark.apache.org/downloads.html</a></p></blockquote><p>å¦‚æœä½ åªéœ€è¦ä½¿ç”¨sparkï¼Œè€Œä¸éœ€è¦å­¦ä¹ å’Œä¿®æ”¹æºç  ä»…ä½¿ç”¨äºŒè¿›åˆ¶å‘è¡Œç‰ˆ å³å¯ã€‚</p><p>å¦‚æœæƒ³è¦å­¦ä¹ æºç ï¼Œé‚£å°±ä»githubä¸Šæ‹‰å–</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/apache/spark</span><br></pre></td></tr></table></figure><p>å¹¶ç”¨IDEAæ‰“å¼€é¡¹ç›®å°±å¯ä»¥å¾—åˆ° Spark 4.0.0 å•¦ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">spark/</span><br><span class="line">â”œâ”€â”€ core/                    # æ ¸å¿ƒå¼•æ“</span><br><span class="line">â”œâ”€â”€ sql/                     # SQLå¼•æ“</span><br><span class="line">â”œâ”€â”€ mllib/                   # æœºå™¨å­¦ä¹ </span><br><span class="line">â”œâ”€â”€ graphx/                  # å›¾è®¡ç®—</span><br><span class="line">â”œâ”€â”€ streaming/               # æµå¤„ç†</span><br><span class="line">â”œâ”€â”€ python/pyspark/          # Python API</span><br><span class="line">â”œâ”€â”€ R/                       # R API</span><br><span class="line">â”œâ”€â”€ examples/                # ç¤ºä¾‹ç¨‹åº</span><br><span class="line">â”œâ”€â”€ connector/               # å¤–éƒ¨è¿æ¥å™¨</span><br><span class="line">â”œâ”€â”€ resource-managers/       # èµ„æºç®¡ç†å™¨</span><br><span class="line">â”œâ”€â”€ assembly/                # æ‰“åŒ…æ„å»º</span><br><span class="line">â”œâ”€â”€ bin/                     # å¯åŠ¨è„šæœ¬</span><br><span class="line">â”œâ”€â”€ sbin/                    # å®ˆæŠ¤è¿›ç¨‹è„šæœ¬</span><br><span class="line">â””â”€â”€ dev/                     # å¼€å‘å·¥å…·</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€æ¬¡åŠ è½½mavenä¾èµ–å¯èƒ½æœ‰äº›ä¹…ï¼Œè€å¿ƒç­‰å¾…ä¸€ä¸‹ã€‚</p><h2 id="2-ç¼–è¯‘spark"><a href="#2-ç¼–è¯‘spark" class="headerlink" title="2.ç¼–è¯‘spark"></a>2.ç¼–è¯‘spark</h2><h3 id="2-1-jdkç¯å¢ƒè¦æ±‚"><a href="#2-1-jdkç¯å¢ƒè¦æ±‚" class="headerlink" title="2.1 jdkç¯å¢ƒè¦æ±‚"></a>2.1 jdkç¯å¢ƒè¦æ±‚</h3><p>éœ€è¦æå‰è¯´çš„æ˜¯ sparkæœ€ä½è¦æ±‚jdk17åŠä»¥ä¸Šç‰ˆæœ¬ï¼Œæ‰å¯ä»¥è¿è¡Œã€‚å¦‚æœæ²¡æœ‰å®‰è£…é«˜ç‰ˆæœ¬jdkæˆ–è€…æœ¬åœ°é»˜è®¤javaç¯å¢ƒæ˜¯å…¶ä»–ç‰ˆæœ¬çš„ï¼Œéœ€è¦è°ƒæ•´åˆ°java17ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kxr@kxrdeMacBook-Pro spark-4.0.0-bin-hadoop3 % /usr/libexec/java_home -V</span><br><span class="line">Matching Java Virtual Machines (4):</span><br><span class="line">    21.0.7 (arm64) <span class="string">&quot;Azul Systems, Inc.&quot;</span> - <span class="string">&quot;Zulu 21.42.19&quot;</span> /Users/kxr/Library/Java/JavaVirtualMachines/azul-21.0.7/Contents/Home</span><br><span class="line">    17.0.15 (arm64) <span class="string">&quot;Azul Systems, Inc.&quot;</span> - <span class="string">&quot;Zulu 17.58.21&quot;</span> /Library/Java/JavaVirtualMachines/zulu-17.jdk/Contents/Home</span><br><span class="line">    11.0.26 (arm64) <span class="string">&quot;Oracle Corporation&quot;</span> - <span class="string">&quot;Java SE 11.0.26&quot;</span> /Library/Java/JavaVirtualMachines/jdk-11.jdk/Contents/Home</span><br><span class="line">    1.8.0_452 (arm64) <span class="string">&quot;Azul Systems, Inc.&quot;</span> - <span class="string">&quot;Zulu 8.86.0.25&quot;</span> /Users/kxr/Library/Java/JavaVirtualMachines/azul-1.8.0_452/Contents/Home</span><br></pre></td></tr></table></figure><p>æˆ‘æœ‰å®‰è£…è¿‡17ï¼Œä½†æ˜¯æˆ‘é»˜è®¤æ˜¯ç”¨jdk8çš„ã€‚æ‰€ä»¥è¿™é‡Œæˆ‘ä½¿ç”¨jenvåˆ‡æ¢ä¸€ä¸‹é»˜è®¤javaç‰ˆæœ¬</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kxr@kxrdeMacBook-Pro ~ % jenv global 17</span><br><span class="line">kxr@kxrdeMacBook-Pro ~ % java -version</span><br><span class="line">openjdk version <span class="string">&quot;17.0.15&quot;</span> 2025-04-15 LTS</span><br><span class="line">OpenJDK Runtime Environment Zulu17.58+21-CA (build 17.0.15+6-LTS)</span><br><span class="line">OpenJDK 64-Bit Server VM Zulu17.58+21-CA (build 17.0.15+6-LTS, mixed mode, sharing)</span><br></pre></td></tr></table></figure><p>å¦‚æœæ²¡æœ‰ä½¿ç”¨è¿‡å¤šç‰ˆæœ¬jdkç®¡ç†çš„ï¼Œå¯ä»¥çœ‹ä¸‹è¿™ç¯‡æ–‡ç« ï¼š<a href="https://kongxiaoran.github.io/2025/07/01/%E4%BD%BF%E7%94%A8Jenv%E7%AE%A1%E7%90%86%E5%A4%9A%E7%89%88%E6%9C%ACJDK%E7%8E%AF%E5%A2%83/">ä½¿ç”¨ Jenv ç®¡ç†å¤šç‰ˆæœ¬ JDK ç¯å¢ƒ</a></p><h3 id="2-2-ç¼–è¯‘"><a href="#2-2-ç¼–è¯‘" class="headerlink" title="2.2 ç¼–è¯‘"></a>2.2 ç¼–è¯‘</h3><h4 id="2-2-1-ä½¿ç”¨ç¼–è¯‘è„šæœ¬ç¼–è¯‘"><a href="#2-2-1-ä½¿ç”¨ç¼–è¯‘è„šæœ¬ç¼–è¯‘" class="headerlink" title="2.2.1 ä½¿ç”¨ç¼–è¯‘è„šæœ¬ç¼–è¯‘"></a>2.2.1 ä½¿ç”¨ç¼–è¯‘è„šæœ¬ç¼–è¯‘</h4><p>ä½¿ç”¨Sparké¡¹ç›®æä¾›çš„<strong>MavenåŒ…è£…è„šæœ¬</strong> ï¼Œå¹¶ä¸”è·³è¿‡æµ‹è¯•æ‰§è¡Œï¼ˆsparkå†…éƒ¨æµ‹è¯•ç”¨ä¾‹å¾ˆå¤šï¼Œè¿™äº›å¯ä»¥ä¸ç”¨ç¼–è¯‘ï¼‰ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./build/mvn -DskipTests clean package</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿™ä¸ªå‘½ä»¤å¯ä»¥å¹¶è¡Œæ„å»ºï¼Œè¦å¿«ä¸€ç‚¹ å°±æ˜¯å¯¹ç”µè„‘å‹åŠ›å¤§ä¸€äº›</span></span><br><span class="line"><span class="built_in">export</span> MAVEN_OPTS=<span class="string">&quot;-Xmx6g -XX:MaxMetaspaceSize=4g&quot;</span> &amp;&amp; ./build/mvn -DskipTests clean package -T 2C</span><br></pre></td></tr></table></figure><p>è¿™å—æœ‰ç‚¹ä¹…ï¼Œæœ‰35ä¸ªæ¨¡å—ã€‚</p><p>æ„å»ºå®Œæˆåä¼šç”Ÿæˆï¼š</p><ul><li><p><strong>å„æ¨¡å—çš„jaråŒ…</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">core/target/spark-core_2.13-4.1.0-SNAPSHOT.jar</span><br><span class="line">sql/core/target/spark-sql_2.13-4.1.0-SNAPSHOT.jar</span><br><span class="line">mllib/target/spark-mllib_2.13-4.1.0-SNAPSHOT.jar</span><br></pre></td></tr></table></figure></li><li><p><strong>AssemblyåŒ…</strong>ï¼ˆè¿™æ˜¯å…³é”®ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">assembly/target/scala-2.13/jars/</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç›®å½•åŒ…å«è¿è¡ŒSparkæ‰€éœ€çš„æ‰€æœ‰JARæ–‡ä»¶</p></li></ul><h4 id="2-2-2-å„æ¨¡å—JARåŒ…-vs-AssemblyåŒ…"><a href="#2-2-2-å„æ¨¡å—JARåŒ…-vs-AssemblyåŒ…" class="headerlink" title="2.2.2 å„æ¨¡å—JARåŒ… vs AssemblyåŒ…"></a>2.2.2 å„æ¨¡å—JARåŒ… vs AssemblyåŒ…</h4><p>è¿™å—åŠ å…¥ç‚¹ç†è®ºå†…å®¹ï¼Œè®©å¤§å®¶äº†è§£æˆ‘ä»¬ç¼–è¯‘åˆ°åº•ç¼–è¯‘å‡ºä»€ä¹ˆä¸œè¥¿ï¼Œæœ‰ä»€ä¹ˆä½œç”¨ã€‚</p><p><strong>å„æ¨¡å—JARåŒ…ï¼ˆIndividual Module JARsï¼‰</strong></p><p><strong>ç‰¹ç‚¹</strong></p><ul><li><strong>å•ä¸€åŠŸèƒ½</strong>ï¼šæ¯ä¸ªJARåªåŒ…å«å¯¹åº”æ¨¡å—çš„ä»£ç </li><li><strong>ä¾èµ–åˆ†ç¦»</strong>ï¼šä¸åŒ…å«ç¬¬ä¸‰æ–¹ä¾èµ–åº“</li><li><strong>ä½“ç§¯å°</strong>ï¼šé€šå¸¸å‡ MBåˆ°å‡ åMB</li><li><strong>çº¯å‡€æ€§</strong>ï¼šåªæœ‰è¯¥æ¨¡å—çš„classæ–‡ä»¶</li></ul><p><strong>ä½œç”¨</strong></p><ol><li><strong>å¼€å‘é˜¶æ®µ</strong>ï¼šæ¨¡å—åŒ–å¼€å‘å’Œæµ‹è¯•</li><li><strong>ä¾èµ–ç®¡ç†</strong>ï¼šä½œä¸ºMavenä¾èµ–è¢«å…¶ä»–é¡¹ç›®å¼•ç”¨</li><li><strong>éƒ¨ç½²ä¼˜åŒ–</strong>ï¼šåœ¨å·²æœ‰Sparkç¯å¢ƒä¸­åªæ›´æ–°ç‰¹å®šæ¨¡å—</li></ol><p><strong>ğŸ¯ AssemblyåŒ…ï¼ˆAssembly JARï¼‰</strong></p><p><strong>ç‰¹ç‚¹</strong></p><ul><li><strong>å®Œæ•´æ€§</strong>ï¼šåŒ…å«è¿è¡ŒSparkæ‰€éœ€çš„<strong>æ‰€æœ‰</strong>JARæ–‡ä»¶</li><li><strong>ä¾èµ–åŒ…å«</strong>ï¼šåŒ…å«æ‰€æœ‰ç¬¬ä¸‰æ–¹ä¾èµ–åº“</li><li><strong>ä½“ç§¯å¤§</strong>ï¼šé€šå¸¸å‡ ç™¾MB</li><li><strong>å³ç”¨æ€§</strong>ï¼šå¯ä»¥ç›´æ¥è¿è¡ŒSparkåº”ç”¨</li></ul><p><strong>ä½œç”¨</strong></p><ol><li><strong>è¿è¡Œæ—¶ç¯å¢ƒ</strong>ï¼šæä¾›å®Œæ•´çš„Sparkè¿è¡Œæ—¶</li><li><strong>åˆ†å‘éƒ¨ç½²</strong>ï¼šç”¨äºé›†ç¾¤éƒ¨ç½²å’Œåˆ†å‘</li><li><strong>è„šæœ¬ä¾èµ–</strong>ï¼šspark-shellã€spark-submitç­‰è„šæœ¬ä¾èµ–æ­¤ç›®å½•</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># è¿è¡Œspark-shell</span><br><span class="line">./bin/spark-shell --version</span><br><span class="line"></span><br><span class="line"># å¯åŠ¨Spark Shell</span><br><span class="line">./bin/spark-shell</span><br></pre></td></tr></table></figure><h2 id="2-è¿è¡Œspark"><a href="#2-è¿è¡Œspark" class="headerlink" title="2.è¿è¡Œspark"></a>2.è¿è¡Œspark</h2><p>å…ˆæ£€æŸ¥ä¸€ä¸‹è£…å¤‡</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/spark-shell --version</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">WARNING: Using incubator modules: jdk.incubator.vector</span><br><span class="line">Using Spark&#x27;s default log4j profile: org/apache/spark/log4j2-defaults.properties</span><br><span class="line">25/08/29 14:36:56 WARN Utils: Your hostname, kxrdeMacBook-Pro.local, resolves to a loopback address: 127.0.0.1; using 192.168.231.196 instead (on interface en0)</span><br><span class="line">25/08/29 14:36:56 WARN Utils: Set SPARK_LOCAL_IP if you need to bind to another address</span><br><span class="line">Welcome to</span><br><span class="line">      ____              __</span><br><span class="line">     / __/__  ___ _____/ /__</span><br><span class="line">    _\ \/ _ \/ _ `/ __/  &#x27;_/</span><br><span class="line">   /___/ .__/\_,_/_/ /_/\_\   version 4.0.0</span><br><span class="line">      /_/</span><br><span class="line">                        </span><br><span class="line">Using Scala version 2.13.16, OpenJDK 64-Bit Server VM, 17.0.15</span><br><span class="line">Branch HEAD</span><br><span class="line">Compiled by user wenchen on 2025-05-19T07:58:03Z</span><br><span class="line">Revision fa33ea000a0bda9e5a3fa1af98e8e85b8cc5e4d4</span><br><span class="line">Url https://github.com/apache/spark</span><br><span class="line">Type --help for more information.</span><br></pre></td></tr></table></figure><p>æ²¡é—®é¢˜ï¼Œå¼€ç©ï¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/spark-shell --master &#x27;local[2]&#x27;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">WARNING: Using incubator modules: jdk.incubator.vector</span><br><span class="line">Using Spark&#x27;s default log4j profile: org/apache/spark/log4j2-defaults.properties</span><br><span class="line">25/08/29 14:38:20 WARN Utils: Your hostname, kxrdeMacBook-Pro.local, resolves to a loopback address: 127.0.0.1; using 192.168.231.196 instead (on interface en0)</span><br><span class="line">25/08/29 14:38:20 WARN Utils: Set SPARK_LOCAL_IP if you need to bind to another address</span><br><span class="line">Using Spark&#x27;s default log4j profile: org/apache/spark/log4j2-defaults.properties</span><br><span class="line">Setting default log level to &quot;WARN&quot;.</span><br><span class="line">To adjust logging level use sc.setLogLevel(newLevel). For SparkR, use setLogLevel(newLevel).</span><br><span class="line">Welcome to</span><br><span class="line">      ____              __</span><br><span class="line">     / __/__  ___ _____/ /__</span><br><span class="line">    _\ \/ _ \/ _ `/ __/  &#x27;_/</span><br><span class="line">   /___/ .__/\_,_/_/ /_/\_\   version 4.0.0</span><br><span class="line">      /_/</span><br><span class="line">         </span><br><span class="line">Using Scala version 2.13.16 (OpenJDK 64-Bit Server VM, Java 17.0.15)</span><br><span class="line">Type in expressions to have them evaluated.</span><br><span class="line">Type :help for more information.</span><br><span class="line">25/08/29 14:38:26 WARN NativeCodeLoader: Unable to load native-hadoop library for your platform... using builtin-java classes where applicable</span><br><span class="line">25/08/29 14:38:26 WARN Utils: Service &#x27;SparkUI&#x27; could not bind on port 4040. Attempting port 4041.</span><br><span class="line">Spark context Web UI available at http://192.168.231.196:4041</span><br><span class="line">Spark context available as &#x27;sc&#x27; (master = local[2], app id = local-1756449506757).</span><br><span class="line">Spark session available as &#x27;spark&#x27;.</span><br><span class="line"></span><br><span class="line">scala&gt; </span><br></pre></td></tr></table></figure><p>å®Œç¾ï¼Spark Shellå·²ç»æˆåŠŸå¯åŠ¨ã€‚é€€å‡ºspark shellï¼ˆcontrol+cï¼‰</p><p>ç°åœ¨kå¯ä»¥æµ‹è¯•ä¸€äº›ç®€å•çš„Sparkç¨‹åºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/run-example SparkPi 10</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/run-example python/pi.py 10</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/spark-submit examples/src/main/python/pi.py 10</span><br></pre></td></tr></table></figure><p>è¿™äº›éƒ½æ˜¯å®˜æ–¹æä¾›çš„ä¸€äº›æµ‹è¯•ç¤ºä¾‹ã€‚</p><h2 id="3-å¦‚ä½•debug"><a href="#3-å¦‚ä½•debug" class="headerlink" title="3.å¦‚ä½•debug"></a>3.å¦‚ä½•debug</h2><h3 id="3-1æ–°å¢masterèŠ‚ç‚¹è¿è¡Œé…ç½®"><a href="#3-1æ–°å¢masterèŠ‚ç‚¹è¿è¡Œé…ç½®" class="headerlink" title="3.1æ–°å¢masterèŠ‚ç‚¹è¿è¡Œé…ç½®"></a>3.1æ–°å¢masterèŠ‚ç‚¹è¿è¡Œé…ç½®</h3><p>æ–°å¢ä¸€ä¸ªåº”ç”¨ç¨‹åºè¿è¡Œé…ç½®ï¼Œç„¶åç¼–è¾‘å¦‚ä¸‹ï¼š</p><p>å…¥å£ç±»é€‰æ‹©ï¼šorg.apache.spark.deploy.master.Master</p><p>-cpé€‰æ‹©ï¼šspark_core_2.13</p><p>æ³¨æ„ ä¿®æ”¹é€‰é¡¹ä¸­ä¸€å®šè¦é€‰æ‹© ä¸€ä¸ªé€‰é¡¹ï¼šå°†å¸¦æœ‰â€providedâ€ä½œç”¨åŸŸçš„ä¾èµ–é¡¹æ·»åŠ åˆ°ç±»è·¯å¾„</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/image-20250831005118672.png" alt="image-20250831005118672"></p><p>ç„¶åä¿å­˜å°±å¯ä»¥ç”¨è¿™ä¸ªé…ç½®å¯åŠ¨ä¸€ä¸ªmasterèŠ‚ç‚¹äº†ã€‚</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/image-20250831002742807.png" alt="image-20250831002742807"></p><p>å¦‚ä¸Šæ‰€ç¤ºï¼Œspark master èŠ‚ç‚¹è¿è¡Œåœ¨ipï¼š192.168.100.199ï¼Œå¹¶ä¸”webuiè¿è¡Œåœ¨8080ç«¯å£ã€‚é‚£ä¹ˆå°±å¯ä»¥è®¿é—®ï¼š</p><p><a href="http://192.168.100.199:8080/">http://192.168.100.199:8080/</a></p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/image-20250831155028623.png" alt="image-20250831155028623"></p><h3 id="3-2-æ–°å¢workèŠ‚ç‚¹è¿è¡Œé…ç½®"><a href="#3-2-æ–°å¢workèŠ‚ç‚¹è¿è¡Œé…ç½®" class="headerlink" title="3.2 æ–°å¢workèŠ‚ç‚¹è¿è¡Œé…ç½®"></a>3.2 æ–°å¢workèŠ‚ç‚¹è¿è¡Œé…ç½®</h3><p>å…¥å£ç±»é€‰æ‹©ï¼šorg.apache.spark.deploy.worker.Worker</p><p>-cpé€‰æ‹©ï¼šspark_core_2.13</p><p>ç¨‹åºå®å‚ï¼š<code>--webui-port 8081 spark://192.168.100.199:7077</code></p><p>æ³¨æ„ ä¿®æ”¹é€‰é¡¹ä¸­ä¸€å®šè¦é€‰æ‹© ä¸€ä¸ªé€‰é¡¹ï¼šå°†å¸¦æœ‰â€providedâ€ä½œç”¨åŸŸçš„ä¾èµ–é¡¹æ·»åŠ åˆ°ç±»è·¯å¾„</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/image-20250831155218977.png" alt="image-20250831155218977"></p><p>è¿™æ¬¡æˆ‘ä»¬å¯ä»¥åŠ ä¸ªæ–­ç‚¹ï¼ˆcore&#x2F;src&#x2F;main&#x2F;scala&#x2F;org&#x2F;apache&#x2F;spark&#x2F;deploy&#x2F;worker&#x2F;Worker.scalaï¼‰ï¼Œå¯ä»¥çœ‹ä¸‹workèŠ‚ç‚¹å¯åŠ¨è¿‡ç¨‹ã€‚</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/image-20250831155421544.png" alt="image-20250831155421544"></p><p>å¯ä»¥çœ‹åˆ°æˆåŠŸå•¦ï¼</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/image-20250831005009815.png" alt="image-20250831005009815"></p><p>.&#x2F;sbin&#x2F;start-master.sh</p><p>.&#x2F;sbin&#x2F;start-worker.sh spark:&#x2F;&#x2F;192.168.100.199:7077</p><p>.&#x2F;spark-submit â€“class org.apache.spark.examples.SparkPi â€“master spark:&#x2F;&#x2F;kxrdeMacBook-Pro.local:7077 â€“deploy-mode client â€“executor-memory 1g â€“total-executor-cores 4 &#x2F;Users&#x2F;kxr&#x2F;learning&#x2F;spark&#x2F;spark&#x2F;examples&#x2F;target&#x2F;original-spark-examples_2.13-4.1.0-SNAPSHOT.jar 100</p>]]></content>
      
      
      <categories>
          
          <category> å¤§æ•°æ® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spark </tag>
            
            <tag> æºç  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HDFS Kerberosè®¤è¯é—®é¢˜æ’æŸ¥ä¸è§£å†³</title>
      <link href="/2025/08/18/HDFS-Kerberos%E8%AE%A4%E8%AF%81%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E6%96%87%E6%A1%A3/"/>
      <url>/2025/08/18/HDFS-Kerberos%E8%AE%A4%E8%AF%81%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E6%96%87%E6%A1%A3/</url>
      
        <content type="html"><![CDATA[<h1 id="HDFS-Kerberosè®¤è¯é—®é¢˜æ’æŸ¥ä¸è§£å†³"><a href="#HDFS-Kerberosè®¤è¯é—®é¢˜æ’æŸ¥ä¸è§£å†³" class="headerlink" title="HDFS Kerberosè®¤è¯é—®é¢˜æ’æŸ¥ä¸è§£å†³"></a>HDFS Kerberosè®¤è¯é—®é¢˜æ’æŸ¥ä¸è§£å†³</h1><h2 id="ä¸€ã€-é—®é¢˜ç°è±¡"><a href="#ä¸€ã€-é—®é¢˜ç°è±¡" class="headerlink" title="ä¸€ã€ é—®é¢˜ç°è±¡"></a>ä¸€ã€ é—®é¢˜ç°è±¡</h2><p>é¡¹ç›®åœ¨é›†æˆHDFSï¼ˆå¸¦Kerberosè®¤è¯ï¼‰æ—¶ï¼Œå¯åŠ¨è¿‡ç¨‹ä¸­é‡åˆ°ä»¥ä¸‹æŠ¥é”™ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Caused by: java.lang.RuntimeException: HDFSé…ç½®åˆå§‹åŒ–å¤±è´¥</span><br><span class="line">at com.neutral.contract.config.HdfsConfig.buildConfiguration(HdfsConfig.java:<span class="number">112</span>)</span><br><span class="line">... <span class="number">90</span> common frames omitted</span><br><span class="line">Caused by: java.io.IOException: Login failure <span class="keyword">for</span> gdios<span class="meta">@ZLG</span>.COM from keytab /Users/kxr/IdeaProjects/gdios/javams-zlg-contract_service/src/main/resources/hdp/gdios<span class="meta">@ZLG</span>.COM.keytab: javax.security.auth.login.LoginException: Message stream <span class="title function_">modified</span> <span class="params">(<span class="number">41</span>)</span></span><br><span class="line">at org.apache.hadoop.security.UserGroupInformation.loginUserFromKeytab(UserGroupInformation.java:<span class="number">963</span>)</span><br><span class="line">at com.neutral.contract.config.HdfsConfig.buildConfiguration(HdfsConfig.java:<span class="number">101</span>)</span><br><span class="line">... <span class="number">95</span> common frames omitted</span><br><span class="line">Caused by: javax.security.auth.login.LoginException: Message stream <span class="title function_">modified</span> <span class="params">(<span class="number">41</span>)</span></span><br><span class="line">at jdk.security.auth/com.sun.security.auth.<span class="keyword">module</span>.Krb5LoginModule.attemptAuthentication(Krb5LoginModule.java:<span class="number">779</span>)</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>æ ¸å¿ƒé”™è¯¯ä¿¡æ¯ä¸º <code>javax.security.auth.login.LoginException: Message stream modified (41)</code>ï¼Œè¡¨æ˜Kerberosç™»å½•æ¨¡å—åœ¨è®¤è¯è¿‡ç¨‹ä¸­å¤±è´¥ã€‚</p><h2 id="äºŒã€-é—®é¢˜åˆ†æ"><a href="#äºŒã€-é—®é¢˜åˆ†æ" class="headerlink" title="äºŒã€ é—®é¢˜åˆ†æ"></a>äºŒã€ é—®é¢˜åˆ†æ</h2><h3 id="2-1-åˆæ­¥æ’æŸ¥"><a href="#2-1-åˆæ­¥æ’æŸ¥" class="headerlink" title="2.1 åˆæ­¥æ’æŸ¥"></a>2.1 åˆæ­¥æ’æŸ¥</h3><p>æ ¹æ®ç½‘ä¸Šå¸¸è§çš„ <code>Message stream modified (41)</code> é”™è¯¯åŸå› ï¼Œè¿›è¡Œäº†ä»¥ä¸‹æ’æŸ¥ï¼š</p><ol><li><strong>å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯æ—¶é—´åŒæ­¥</strong>ï¼šæ£€æŸ¥äº†åº”ç”¨æœåŠ¡å™¨ä¸KDCæœåŠ¡å™¨çš„æ—¶é—´ï¼Œç¡®ä¿ä¸€è‡´ã€‚</li><li><strong>keytabæ–‡ä»¶æŸå</strong>ï¼šé‡æ–°ç”Ÿæˆå¹¶åˆ†å‘äº†keytabæ–‡ä»¶ï¼Œç¡®ä¿å…¶å®Œæ•´æ€§ã€‚</li><li><strong>ä¸»ä½“ï¼ˆPrincipalï¼‰å¤±æ•ˆ</strong>ï¼šç¡®è®¤äº†Kerberosä¸»ä½“æ˜¯æœ‰æ•ˆçš„ã€‚</li></ol><p>ç„¶è€Œï¼Œä»¥ä¸Šå°è¯•å‡æœªèƒ½è§£å†³é—®é¢˜ã€‚å³ä½¿æ˜¯æ–°å»ºä¸€ä¸ªKerberosä¸»ä½“å¹¶ä½¿ç”¨å…¶keytabæ–‡ä»¶ï¼Œé—®é¢˜ä¾æ—§å¤ç°ã€‚è¿™è¡¨æ˜é—®é¢˜æ ¹æºå¯èƒ½ä¸åœ¨äºè¿™äº›å¸¸è§åŸå› ã€‚</p><h3 id="2-2-æ·±å…¥æ¢ç©¶"><a href="#2-2-æ·±å…¥æ¢ç©¶" class="headerlink" title="2.2 æ·±å…¥æ¢ç©¶"></a>2.2 æ·±å…¥æ¢ç©¶</h3><p>åœ¨æ’æŸ¥é™·å…¥åƒµå±€åï¼Œæˆ‘å†³å®šæŸ¥çœ‹Kerberosä¸»ä½“çš„è¯¦ç»†é…ç½®ä¿¡æ¯ï¼Œå‘ç°äº†å…³é”®çº¿ç´¢ã€‚é€šè¿‡ <code>kadmin.local</code> å·¥å…·çš„ <code>get_principal</code> å‘½ä»¤ï¼ŒæŸ¥çœ‹åˆ°ä¸»ä½“çš„å±æ€§å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Maximum renewable life: 0 days 00:00:00</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå±æ€§çš„å«ä¹‰æ˜¯ <strong>ç¥¨æ®ï¼ˆTicketï¼‰å¯ä»¥è¢«ç»­æœŸï¼ˆrenewï¼‰çš„æœ€é•¿æ€»æ—¶é—´</strong>ã€‚è®¾ç½®ä¸º <code>0</code> æ„å‘³ç€è¯¥ä¸»ä½“çš„ç¥¨æ® <strong>ä¸å…è®¸ç»­æœŸ</strong>ã€‚ä¸€æ—¦ç¥¨æ®è¿‡æœŸï¼ˆä¾‹å¦‚1å¤©åï¼‰ï¼Œå®¢æˆ·ç«¯å¿…é¡»é‡æ–°è¿›è¡Œå®Œæ•´çš„è®¤è¯æµç¨‹ä»¥è·å–æ–°ç¥¨æ®ï¼Œè€Œä¸èƒ½ç”³è¯·å»¶é•¿ç°æœ‰ç¥¨æ®çš„æœ‰æ•ˆæœŸã€‚</p><p>ç„¶è€Œï¼Œé¡¹ç›®å®¢æˆ·ç«¯ä½¿ç”¨çš„ <code>krb5.conf</code> é…ç½®æ–‡ä»¶ï¼ˆå–è‡ªHadoopé›†ç¾¤&#x2F;KDCæœåŠ¡å™¨ï¼‰ä¸­ï¼Œå´åŒ…å«äº†ä»¥ä¸‹é…ç½®ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[libdefaults]</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="attr">renew_lifetime</span> = <span class="number">7</span>d</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure><p>è¿™é‡Œäº§ç”Ÿäº† <strong>é…ç½®å†²çª</strong>ï¼š</p><ul><li>**å®¢æˆ·ç«¯é…ç½® (<code>krb5.conf</code>)**ï¼š<code>renew_lifetime = 7d</code>ï¼Œè¡¨æ˜å®¢æˆ·ç«¯ç¨‹åº <strong>æœŸæœ›</strong> ç¥¨æ®å¯ä»¥è¢«ç»­æœŸï¼Œä¸”æ€»æœ‰æ•ˆæœŸæœ€é•¿å¯è¾¾7å¤©ã€‚</li><li><strong>KDCä¸»ä½“é…ç½®</strong>ï¼š<code>Maximum renewable life = 0</code>ï¼Œè¡¨æ˜KDC <strong>ç¦æ­¢</strong> ä¸ºè¯¥ä¸»ä½“é¢å‘å¯ç»­æœŸçš„ç¥¨æ®ã€‚</li></ul><p>å½“å®¢æˆ·ç«¯æ ¹æ®å…¶é…ç½®å°è¯•å‘KDCç”³è¯·ä¸€ä¸ªå¯ç»­æœŸçš„ç¥¨æ®æ—¶ï¼ŒKDCä¼šå› ä¸ºä¸»ä½“ç­–ç•¥çš„é™åˆ¶è€Œæ‹’ç»è¯¥è¯·æ±‚ï¼Œæœ€ç»ˆå¯¼è‡´è®¤è¯å¤±è´¥ï¼Œå¹¶æŠ›å‡º <code>Message stream modified (41)</code> çš„å¼‚å¸¸ã€‚</p><h2 id="ä¸‰ã€-è§£å†³æ–¹æ¡ˆ"><a href="#ä¸‰ã€-è§£å†³æ–¹æ¡ˆ" class="headerlink" title="ä¸‰ã€ è§£å†³æ–¹æ¡ˆ"></a>ä¸‰ã€ è§£å†³æ–¹æ¡ˆ</h2><p>æ—¢ç„¶é—®é¢˜çš„æ ¹æºåœ¨äºå®¢æˆ·ç«¯ç”³è¯·äº†ä¸»ä½“ä¸æ”¯æŒçš„â€œç¥¨æ®ç»­æœŸâ€åŠŸèƒ½ï¼Œé‚£ä¹ˆè§£å†³æ–¹æ¡ˆå°±æ˜¯ <strong>è®©å®¢æˆ·ç«¯åœæ­¢ç”³è¯·ç»­æœŸ</strong>ã€‚</p><p>å…·ä½“æ“ä½œæ˜¯ä¿®æ”¹å®¢æˆ·ç«¯çš„ <code>krb5.conf</code> é…ç½®æ–‡ä»¶ï¼Œå°† <code>renew_lifetime = 7d</code> è¿™ä¸€è¡Œ <strong>åˆ é™¤æˆ–æ³¨é‡Šæ‰</strong>ã€‚</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[libdefaults]</span></span><br><span class="line">  <span class="attr">dns_lookup_realm</span> = <span class="literal">false</span></span><br><span class="line">  <span class="attr">ticket_lifetime</span> = <span class="number">24</span>h</span><br><span class="line">  <span class="comment"># renew_lifetime = 7d  &lt;-- åˆ é™¤æˆ–æ³¨é‡Šæ‰æ­¤è¡Œ</span></span><br><span class="line">  <span class="attr">forwardable</span> = <span class="literal">true</span></span><br><span class="line">  <span class="attr">rdns</span> = <span class="literal">false</span></span><br><span class="line">  ...</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹é…ç½®åï¼Œé‡å¯é¡¹ç›®ï¼ŒKerberosè®¤è¯æˆåŠŸé€šè¿‡ã€‚</p><h2 id="å››ã€-åç»­æ€è€ƒä¸åŸç†æ¢ç©¶"><a href="#å››ã€-åç»­æ€è€ƒä¸åŸç†æ¢ç©¶" class="headerlink" title="å››ã€ åç»­æ€è€ƒä¸åŸç†æ¢ç©¶"></a>å››ã€ åç»­æ€è€ƒä¸åŸç†æ¢ç©¶</h2><h3 id="4-1-ä¸ºä»€ä¹ˆHadoopä¸éœ€è¦é…ç½®renew-lifetimeï¼Ÿ"><a href="#4-1-ä¸ºä»€ä¹ˆHadoopä¸éœ€è¦é…ç½®renew-lifetimeï¼Ÿ" class="headerlink" title="4.1 ä¸ºä»€ä¹ˆHadoopä¸éœ€è¦é…ç½®renew_lifetimeï¼Ÿ"></a>4.1 ä¸ºä»€ä¹ˆHadoopä¸éœ€è¦é…ç½®<code>renew_lifetime</code>ï¼Ÿ</h3><p>ä¸€ä¸ªè‡ªç„¶çš„ç–‘é—®æ˜¯ï¼šHadoopé›†ç¾¤çš„å„ä¸ªç»„ä»¶ï¼ˆå¦‚HDFSã€YARNï¼‰ä¹Ÿéœ€è¦é•¿æœŸè¿è¡Œï¼Œå®ƒä»¬éš¾é“ä¸ä¾èµ–ç¥¨æ®ç»­æœŸå—ï¼Ÿ</p><p>æ·±å…¥äº†è§£åå‘ç°ï¼ŒHadoopç”Ÿæ€ç³»ç»Ÿå¯¹â€œé•¿æœŸè®¤è¯â€çš„å¤„ç†ï¼Œæ›´ä¾èµ– <strong>â€œè‡ªåŠ¨é‡æ–°è·å–ç¥¨æ®â€ï¼ˆRe-authenticationï¼‰</strong>ï¼Œè€Œéâ€œç»­æœŸâ€ï¼ˆRenewalï¼‰ã€‚</p><ul><li><p><strong>ç»­æœŸçš„å±€é™æ€§</strong>ï¼š</p><ul><li>éœ€è¦ä¸»ä½“å’Œç¥¨æ®éƒ½æ˜¾å¼å…è®¸ç»­æœŸã€‚</li><li>ç»­æœŸæœ‰æœ€å¤§æ€»æ—¶é•¿é™åˆ¶ï¼ˆå¦‚ <code>Maximum renewable life</code>ï¼‰ï¼Œè¶…è¿‡åä»éœ€é‡æ–°è®¤è¯ã€‚</li></ul></li><li><p><strong>Hadoopçš„è‡ªåŠ¨é‡è®¤è¯æœºåˆ¶</strong>ï¼š</p><ul><li>Hadoopçš„æ ¸å¿ƒå®¢æˆ·ç«¯ï¼ˆå¦‚HDFS Client, YARN Clientï¼‰å†…ç½®äº† <strong>è‡ªåŠ¨é‡è®¤è¯é€»è¾‘</strong>ã€‚</li><li>å½“å®ƒä»¬æ£€æµ‹åˆ°å½“å‰æŒæœ‰çš„ç¥¨æ®å³å°†è¿‡æœŸæ—¶ï¼Œä¼š <strong>ä½¿ç”¨keytabæ–‡ä»¶è‡ªåŠ¨é‡æ–°æ‰§è¡Œ <code>kinit</code> è¿‡ç¨‹</strong>ï¼Œä»¥è·å–ä¸€ä¸ªå…¨æ–°çš„ç¥¨æ®ã€‚</li><li>è¿™ä¸ªè¿‡ç¨‹å¯¹ä¸Šå±‚åº”ç”¨æ˜¯é€æ˜çš„ï¼Œæ— éœ€äººå·¥å¹²é¢„ã€‚è¿™ç§æ–¹å¼æ¯”ç»­æœŸæ›´å¥å£®ã€æ›´å¯é ï¼Œå› ä¸ºå®ƒä¸å—ç»­æœŸæ€»æ—¶é•¿çš„é™åˆ¶ã€‚</li></ul></li></ul><h3 id="4-2-Hadoopé›†ç¾¤Kerberosé…ç½®æœ€ä½³å®è·µ"><a href="#4-2-Hadoopé›†ç¾¤Kerberosé…ç½®æœ€ä½³å®è·µ" class="headerlink" title="4.2 Hadoopé›†ç¾¤Kerberosé…ç½®æœ€ä½³å®è·µ"></a>4.2 Hadoopé›†ç¾¤Kerberosé…ç½®æœ€ä½³å®è·µ</h3><p>åŸºäºä»¥ä¸ŠåŸç†ï¼Œå¯¹äºHadoopé›†ç¾¤çš„Kerberosé…ç½®ï¼Œå¾—å‡ºä»¥ä¸‹å»ºè®®ï¼š</p><ol><li><p><strong>æœåŠ¡ä¸»ä½“ï¼ˆService Principalsï¼‰</strong>ï¼š</p><ul><li>å¦‚ <code>hdfs/hostname@REALM</code>ã€<code>yarn/hostname@REALM</code> ç­‰ã€‚</li><li>è¿™äº›ä¸»ä½“ç”±HadoopæœåŠ¡è‡ªèº«ä½¿ç”¨ï¼Œé€šè¿‡keytabæ–‡ä»¶è¿›è¡Œè‡ªåŠ¨é‡è®¤è¯ã€‚</li><li><strong>å»ºè®®é…ç½®</strong>ï¼š<ul><li><code>Maximum renewable life</code>: <code>0</code> (ç¦æ­¢ç»­æœŸ)</li><li><code>Maximum ticket life</code>: <code>1 day</code> (ç¥¨æ®çŸ­æœŸæœ‰æ•ˆï¼Œé™ä½å®‰å…¨é£é™©)</li><li><code>Password expiration date</code>: <code>never</code> (ç¡®ä¿keytabé•¿æœŸæœ‰æ•ˆ)</li></ul></li></ul></li><li><p><strong>å®¢æˆ·ç«¯&#x2F;åº”ç”¨ï¼ˆClient&#x2F;Applicationï¼‰</strong>ï¼š</p><ul><li>å¯¹äºéœ€è¦é•¿æœŸè®¿é—®Hadoopé›†ç¾¤çš„åº”ç”¨ç¨‹åºï¼ˆå¦‚æµå¤„ç†ä½œä¸šã€è‡ªå®šä¹‰æœåŠ¡ï¼‰ã€‚</li><li><strong>å…³é”®é…ç½®</strong>ï¼š<ul><li><strong>ä½¿ç”¨keytabæ–‡ä»¶</strong>ï¼šç¨‹åºå¿…é¡»é€šè¿‡åŠ è½½keytabæ–‡ä»¶è¿›è¡Œè®¤è¯ï¼Œè¿™æ˜¯å®ç°è‡ªåŠ¨é‡è®¤è¯çš„å‰æã€‚</li><li><strong>å®¢æˆ·ç«¯ <code>krb5.conf</code> é…ç½®</strong>ï¼š<ul><li><code>ticket_lifetime</code>: ä¿æŒä¸æœåŠ¡ä¸»ä½“çš„ <code>Maximum ticket life</code> ä¸€è‡´ï¼ˆå¦‚ <code>24h</code>ï¼‰ã€‚</li><li><code>renew_lifetime</code>: <strong>å»ºè®®è®¾ç½®ä¸º <code>0</code> æˆ–ç›´æ¥åˆ é™¤è¯¥é…ç½®</strong>ï¼Œä»¥é¿å…ä¸æœåŠ¡ä¸»ä½“çš„ç­–ç•¥å†²çªã€‚</li></ul></li></ul></li></ul></li></ol><h2 id="äº”ã€-é™„å½•ï¼šå¸¸ç”¨Kerberosè°ƒè¯•å‘½ä»¤"><a href="#äº”ã€-é™„å½•ï¼šå¸¸ç”¨Kerberosè°ƒè¯•å‘½ä»¤" class="headerlink" title="äº”ã€ é™„å½•ï¼šå¸¸ç”¨Kerberosè°ƒè¯•å‘½ä»¤"></a>äº”ã€ é™„å½•ï¼šå¸¸ç”¨Kerberosè°ƒè¯•å‘½ä»¤</h2><h3 id="5-1-å®¢æˆ·ç«¯æ‰‹åŠ¨æµ‹è¯•"><a href="#5-1-å®¢æˆ·ç«¯æ‰‹åŠ¨æµ‹è¯•" class="headerlink" title="5.1 å®¢æˆ·ç«¯æ‰‹åŠ¨æµ‹è¯•"></a>5.1 å®¢æˆ·ç«¯æ‰‹åŠ¨æµ‹è¯•</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®krb5.confæ–‡ä»¶è·¯å¾„çš„ç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="built_in">export</span> KRB5_CONFIG=/path/to/your/krb5.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨keytabæ–‡ä»¶æ‰‹åŠ¨å‘èµ·è®¤è¯</span></span><br><span class="line">kinit -kt /path/to/your/principal.keytab principal_name@REALM</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å½“å‰ç¼“å­˜çš„ç¥¨æ®ä¿¡æ¯</span></span><br><span class="line">klist</span><br></pre></td></tr></table></figure><h3 id="5-2-æœåŠ¡ç«¯äº¤äº’å‘½ä»¤"><a href="#5-2-æœåŠ¡ç«¯äº¤äº’å‘½ä»¤" class="headerlink" title="5.2 æœåŠ¡ç«¯äº¤äº’å‘½ä»¤"></a>5.2 æœåŠ¡ç«¯äº¤äº’å‘½ä»¤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿›å…¥kadminç®¡ç†å°ï¼ˆé€šå¸¸åœ¨KDCæœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼‰</span></span><br><span class="line"><span class="built_in">sudo</span> kadmin.local</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ‰€æœ‰ä¸»ä½“åˆ—è¡¨</span></span><br><span class="line">list_principals</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç‰¹å®šä¸»ä½“çš„è¯¦ç»†ä¿¡æ¯</span></span><br><span class="line">get_principal &lt;principal_name@REALM&gt;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> å¤§æ•°æ® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HDFS </tag>
            
            <tag> Hadoop </tag>
            
            <tag> Kerberos </tag>
            
            <tag> æ•…éšœæ’æŸ¥ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥ç†è§£åˆ—å¼å­˜å‚¨ä¸å‘é‡åŒ–å¼•æ“</title>
      <link href="/2025/08/12/%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%E4%B8%8E%E5%90%91%E9%87%8F%E5%8C%96%E5%BC%95%E6%93%8E%E5%AD%A6%E4%B9%A0%E6%96%87%E6%A1%A3/"/>
      <url>/2025/08/12/%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%E4%B8%8E%E5%90%91%E9%87%8F%E5%8C%96%E5%BC%95%E6%93%8E%E5%AD%A6%E4%B9%A0%E6%96%87%E6%A1%A3/</url>
      
        <content type="html"><![CDATA[<h1 id="æ·±å…¥ç†è§£åˆ—å¼å­˜å‚¨ä¸å‘é‡åŒ–å¼•æ“"><a href="#æ·±å…¥ç†è§£åˆ—å¼å­˜å‚¨ä¸å‘é‡åŒ–å¼•æ“" class="headerlink" title="æ·±å…¥ç†è§£åˆ—å¼å­˜å‚¨ä¸å‘é‡åŒ–å¼•æ“"></a>æ·±å…¥ç†è§£åˆ—å¼å­˜å‚¨ä¸å‘é‡åŒ–å¼•æ“</h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åœ¨ç°ä»£æ•°æ®åˆ†æï¼ˆOLAPï¼‰é¢†åŸŸï¼Œæ€§èƒ½æ˜¯è‡³å…³é‡è¦çš„ã€‚ä¸ºäº†å¤„ç†æµ·é‡æ•°æ®å¹¶å®ç°è¿‘ä¹å®æ—¶çš„æŸ¥è¯¢å“åº”ï¼Œæ•°æ®åº“å’Œè®¡ç®—å¼•æ“çš„æŠ€æœ¯å·²ç»ä»ä¼ ç»Ÿçš„é¢å‘äº‹åŠ¡ï¼ˆOLTPï¼‰çš„è®¾è®¡ï¼Œæ¼”è¿›åˆ°äº†ä»¥<strong>åˆ—å¼å­˜å‚¨ï¼ˆColumnar Storageï¼‰</strong>ä¸ºåŸºç¡€ï¼Œä»¥<strong>å‘é‡åŒ–æ‰§è¡Œï¼ˆVectorized Executionï¼‰</strong>ä¸ºæ ¸å¿ƒçš„æ–°èŒƒå¼ã€‚</p><p>æœ¬æ–‡æ¡£å°†è¯¦ç»†æ‹†è§£è¿™ä¸¤é¡¹å…³é”®æŠ€æœ¯ï¼Œå¸®åŠ©ä½ ç†è§£å®ƒä»¬æ˜¯ä»€ä¹ˆã€ä¸ºä»€ä¹ˆéœ€è¦ã€ä»¥åŠå®ƒä»¬å¦‚ä½•ååŒå·¥ä½œï¼Œåˆ›é€ å‡ºæ•°é‡çº§çš„æ€§èƒ½æå‡ã€‚</p><h2 id="ä¸€ã€-åˆ—å¼å­˜å‚¨ï¼ˆColumnar-Storageï¼‰"><a href="#ä¸€ã€-åˆ—å¼å­˜å‚¨ï¼ˆColumnar-Storageï¼‰" class="headerlink" title="ä¸€ã€ åˆ—å¼å­˜å‚¨ï¼ˆColumnar Storageï¼‰"></a>ä¸€ã€ åˆ—å¼å­˜å‚¨ï¼ˆColumnar Storageï¼‰</h2><h3 id="1-1-ä»€ä¹ˆæ˜¯åˆ—å¼å­˜å‚¨ï¼Ÿ"><a href="#1-1-ä»€ä¹ˆæ˜¯åˆ—å¼å­˜å‚¨ï¼Ÿ" class="headerlink" title="1.1 ä»€ä¹ˆæ˜¯åˆ—å¼å­˜å‚¨ï¼Ÿ"></a>1.1 ä»€ä¹ˆæ˜¯åˆ—å¼å­˜å‚¨ï¼Ÿ</h3><p><strong>åˆ—å¼å­˜å‚¨</strong>æ˜¯ä¸€ç§æ•°æ®åœ¨ç£ç›˜æˆ–å†…å­˜ä¸­æŒ‰<strong>åˆ—ï¼ˆColumnï¼‰</strong>è¿ç»­ç»„ç»‡å’Œå­˜æ”¾çš„ç­–ç•¥ã€‚</p><p>ä¸ºäº†ç›´è§‚ç†è§£ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç®€å•çš„ç”¨æˆ·è¡¨ç¤ºä¾‹ï¼š</p><table><thead><tr><th align="left">UserID (æ•´å‹)</th><th align="left">Name (å­—ç¬¦ä¸²)</th><th align="left">Age (æ•´å‹)</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">Alice</td><td align="left">30</td></tr><tr><td align="left">2</td><td align="left">Bob</td><td align="left">25</td></tr><tr><td align="left">3</td><td align="left">Charlie</td><td align="left">35</td></tr></tbody></table><h4 id="å­˜å‚¨æ–¹å¼å¯¹æ¯”"><a href="#å­˜å‚¨æ–¹å¼å¯¹æ¯”" class="headerlink" title="å­˜å‚¨æ–¹å¼å¯¹æ¯”"></a>å­˜å‚¨æ–¹å¼å¯¹æ¯”</h4><ul><li><p><strong>è¡Œå¼å­˜å‚¨ï¼ˆRow-based &#x2F; OLTP å¸¸ç”¨ï¼‰</strong><br>æ•°æ®æŒ‰è¡Œè¿ç»­å­˜æ”¾ï¼Œä¸€è¡Œçš„æ•°æ®ç´§æŒ¨åœ¨ä¸€èµ·ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[1, &#x27;Alice&#x27;, 30], [2, &#x27;Bob&#x27;, 25], [3, &#x27;Charlie&#x27;, 35]</span><br></pre></td></tr></table></figure></li><li><p><strong>åˆ—å¼å­˜å‚¨ï¼ˆColumn-based &#x2F; OLAP å¸¸ç”¨ï¼‰</strong><br>æ•°æ®æŒ‰åˆ—è¿ç»­å­˜æ”¾ï¼ŒåŒä¸€åˆ—çš„æ‰€æœ‰æ•°æ®ç´§æŒ¨åœ¨ä¸€èµ·ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[1, 2, 3], [&#x27;Alice&#x27;, &#x27;Bob&#x27;, &#x27;Charlie&#x27;], [30, 25, 35]</span><br></pre></td></tr></table></figure></li></ul><h3 id="1-2-ä¸ºä»€ä¹ˆéœ€è¦åˆ—å¼å­˜å‚¨ï¼Ÿï¼ˆä¸è¡Œå¼å¯¹æ¯”ï¼‰"><a href="#1-2-ä¸ºä»€ä¹ˆéœ€è¦åˆ—å¼å­˜å‚¨ï¼Ÿï¼ˆä¸è¡Œå¼å¯¹æ¯”ï¼‰" class="headerlink" title="1.2 ä¸ºä»€ä¹ˆéœ€è¦åˆ—å¼å­˜å‚¨ï¼Ÿï¼ˆä¸è¡Œå¼å¯¹æ¯”ï¼‰"></a>1.2 ä¸ºä»€ä¹ˆéœ€è¦åˆ—å¼å­˜å‚¨ï¼Ÿï¼ˆä¸è¡Œå¼å¯¹æ¯”ï¼‰</h3><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">è¡Œå¼å­˜å‚¨ (Row-based)</th><th align="left">åˆ—å¼å­˜å‚¨ (Column-based)</th></tr></thead><tbody><tr><td align="left"><strong>é€‚ç”¨åœºæ™¯</strong></td><td align="left">**OLTP (åœ¨çº¿äº‹åŠ¡å¤„ç†)**ï¼šé¢‘ç¹çš„å¢ã€åˆ ã€æ”¹ã€æŸ¥ï¼ˆé€šå¸¸æŒ‰ä¸»é”®æŸ¥æ•´è¡Œï¼‰ã€‚ä¾‹å¦‚ï¼šè®¢å•ç³»ç»Ÿã€é“¶è¡Œäº¤æ˜“ã€‚</td><td align="left">**OLAP (åœ¨çº¿åˆ†æå¤„ç†)**ï¼šæµ·é‡æ•°æ®çš„å¤æ‚æŸ¥è¯¢ã€èšåˆã€ç»Ÿè®¡ã€‚ä¾‹å¦‚ï¼šæ•°æ®ä»“åº“ã€BI æŠ¥è¡¨ã€‚</td></tr><tr><td align="left"><strong>I&#x2F;O ç‰¹ç‚¹</strong></td><td align="left"><strong>è¯»å–æ•´è¡Œé«˜æ•ˆ</strong>ï¼šä¸€æ¬¡ I&#x2F;O å³å¯è·å–ä¸€è¡Œæ‰€æœ‰æ•°æ®ã€‚ä½†æŸ¥è¯¢è‹¥åªæ¶‰åŠå°‘æ•°å‡ åˆ—ï¼Œä¼šè¯»å–å¤§é‡æ— å…³æ•°æ®ã€‚</td><td align="left"><strong>è¯»å–å°‘æ•°åˆ—é«˜æ•ˆ</strong>ï¼šåªéœ€è¯»å–æŸ¥è¯¢æ‰€éœ€åˆ—çš„æ•°æ®ï¼Œæå¤§å‡å°‘äº† I&#x2F;O é‡ã€‚è¿™æ˜¯ OLAP åœºæ™¯æ€§èƒ½æå‡çš„å…³é”®ã€‚</td></tr><tr><td align="left"><strong>å‹ç¼©æ•ˆç‡</strong></td><td align="left"><strong>è¾ƒä½</strong>ï¼šä¸€è¡Œå†…æ•°æ®ç±»å‹å„å¼‚ï¼ˆå­—ç¬¦ä¸²ã€æ•°å­—ã€æ—¥æœŸï¼‰ï¼Œç›¸ä¼¼åº¦ä½ï¼Œéš¾ä»¥é«˜æ•ˆå‹ç¼©ã€‚</td><td align="left"><strong>æé«˜</strong>ï¼šåŒä¸€åˆ—æ•°æ®ç±»å‹ç›¸åŒã€ä¸šåŠ¡å«ä¹‰ç›¸ä¼¼ï¼Œæ•°æ®é‡å¤åº¦é«˜ï¼Œéå¸¸é€‚åˆå‹ç¼©ã€‚å¸¸ç”¨ç®—æ³•ï¼šå­—å…¸ç¼–ç ã€RLEã€Delta ç¼–ç ç­‰ã€‚</td></tr></tbody></table><h3 id="1-3-ä¸ºä»€ä¹ˆæ€§èƒ½é«˜ï¼Ÿ"><a href="#1-3-ä¸ºä»€ä¹ˆæ€§èƒ½é«˜ï¼Ÿ" class="headerlink" title="1.3 ä¸ºä»€ä¹ˆæ€§èƒ½é«˜ï¼Ÿ"></a>1.3 ä¸ºä»€ä¹ˆæ€§èƒ½é«˜ï¼Ÿ</h3><p>åˆ—å¼å­˜å‚¨çš„é«˜æ€§èƒ½ä¸»è¦æºäºä»¥ä¸‹ä¸‰ç‚¹ï¼š</p><ol><li><p><strong>æœ€å°åŒ– I&#x2F;O</strong>ï¼šè¿™æ˜¯æœ€æ ¸å¿ƒçš„ä¼˜åŠ¿ã€‚å¯¹äºåˆ†æç±»æŸ¥è¯¢ï¼Œå¦‚ <code>SELECT AVG(age) FROM users</code>ï¼Œåˆ—å¼å­˜å‚¨åªéœ€è¯»å– <code>Age</code> è¿™ä¸€åˆ—çš„æ•°æ®ï¼Œè€Œè¡Œå¼å­˜å‚¨åˆ™å¿…é¡»æ‰«ææ¯ä¸€è¡Œçš„æ‰€æœ‰æ•°æ®ï¼ˆåŒ…æ‹¬ UserID å’Œ Nameï¼‰ï¼ŒI&#x2F;O å¼€é”€å¯èƒ½ç›¸å·®æ•°åç”šè‡³æ•°ç™¾å€ã€‚</p></li><li><p><strong>é«˜å‹ç¼©ç‡</strong>ï¼šç”±äºåŒåˆ—æ•°æ®çš„é«˜åº¦åŒè´¨æ€§ï¼Œå¯ä»¥å®ç°éå¸¸é«˜çš„å‹ç¼©æ¯”ã€‚è¿™æ„å‘³ç€æ›´å°‘çš„ç£ç›˜ç©ºé—´å ç”¨å’Œæ›´ä½çš„ I&#x2F;O å¸¦å®½éœ€æ±‚ã€‚æ•°æ®ä»ç£ç›˜åŠ è½½åˆ°å†…å­˜çš„æ—¶é—´ä¹Ÿç›¸åº”å‡å°‘ã€‚</p></li><li><p><strong>ä¸ºå‘é‡åŒ–æ‰§è¡Œé“ºå¹³é“è·¯</strong>ï¼šæ•°æ®æŒ‰åˆ—è¿ç»­å­˜æ”¾åœ¨å†…å­˜ä¸­ï¼Œè¿™ä¸º CPU é«˜æ•ˆå¤„ç†æ•°æ®åˆ›é€ äº†å®Œç¾æ¡ä»¶ã€‚è¿™ç§å¸ƒå±€ä½¿å¾—åç»­çš„å‘é‡åŒ–æ‰§è¡Œæˆä¸ºå¯èƒ½ã€‚</p></li></ol><h2 id="äºŒã€-å‘é‡åŒ–æ‰§è¡Œå¼•æ“ï¼ˆVectorized-Execution-Engineï¼‰"><a href="#äºŒã€-å‘é‡åŒ–æ‰§è¡Œå¼•æ“ï¼ˆVectorized-Execution-Engineï¼‰" class="headerlink" title="äºŒã€ å‘é‡åŒ–æ‰§è¡Œå¼•æ“ï¼ˆVectorized Execution Engineï¼‰"></a>äºŒã€ å‘é‡åŒ–æ‰§è¡Œå¼•æ“ï¼ˆVectorized Execution Engineï¼‰</h2><p>å¦‚æœè¯´åˆ—å¼å­˜å‚¨è§£å†³äº† <strong>I&#x2F;O ç“¶é¢ˆ</strong>ï¼Œé‚£ä¹ˆå‘é‡åŒ–æ‰§è¡Œåˆ™è‡´åŠ›äºè§£å†³ <strong>CPU è®¡ç®—ç“¶é¢ˆ</strong>ã€‚</p><h3 id="2-1-ä»€ä¹ˆæ˜¯å‘é‡åŒ–æ‰§è¡Œï¼Ÿ"><a href="#2-1-ä»€ä¹ˆæ˜¯å‘é‡åŒ–æ‰§è¡Œï¼Ÿ" class="headerlink" title="2.1 ä»€ä¹ˆæ˜¯å‘é‡åŒ–æ‰§è¡Œï¼Ÿ"></a>2.1 ä»€ä¹ˆæ˜¯å‘é‡åŒ–æ‰§è¡Œï¼Ÿ</h3><p><strong>å‘é‡åŒ–æ‰§è¡Œ</strong>æ˜¯ä¸€ç§æ•°æ®å¤„ç†æ¨¡å‹ï¼Œå®ƒ<strong>ä¸€æ¬¡å¤„ç†ä¸€æ‰¹æ•°æ®ï¼ˆä¸€ä¸ªåˆ—çš„ç‰‡æ®µï¼Œç§°ä¸ºâ€œå‘é‡â€æˆ–â€œæ‰¹â€ï¼‰</strong>ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡å¤„ç†ä¸€è¡Œï¼ˆTuple-at-a-timeï¼‰ã€‚</p><h4 id="æ‰§è¡Œæ¨¡å‹å¯¹æ¯”ï¼šæ·±å…¥ç†è§£æ€§èƒ½å·®å¼‚"><a href="#æ‰§è¡Œæ¨¡å‹å¯¹æ¯”ï¼šæ·±å…¥ç†è§£æ€§èƒ½å·®å¼‚" class="headerlink" title="æ‰§è¡Œæ¨¡å‹å¯¹æ¯”ï¼šæ·±å…¥ç†è§£æ€§èƒ½å·®å¼‚"></a>æ‰§è¡Œæ¨¡å‹å¯¹æ¯”ï¼šæ·±å…¥ç†è§£æ€§èƒ½å·®å¼‚</h4><p>è¦ç†è§£ä¸¤ç§æ¨¡å‹çš„æ ¹æœ¬åŒºåˆ«ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦äº†è§£â€œ<strong>æŸ¥è¯¢è®¡åˆ’æ ‘ï¼ˆQuery Plan Treeï¼‰</strong>â€ã€‚å½“æ•°æ®åº“æ‰§è¡Œä¸€æ¡SQLæ—¶ï¼Œä¼šå…ˆç”Ÿæˆä¸€ä¸ªç”±å¤šä¸ª<strong>æ“ä½œç¬¦ï¼ˆOperatorsï¼‰</strong>ç»„æˆçš„æ‰§è¡Œè“å›¾ï¼Œæ•°æ®ä»æ ‘çš„å¶å­èŠ‚ç‚¹ï¼ˆå¦‚<code>Table Scan</code>ï¼‰æµå‘æ ¹èŠ‚ç‚¹ï¼ˆæœ€ç»ˆç»“æœï¼‰ã€‚</p><pre class="mermaid">graph TD    A[Aggregate] --> B[Filter]    B --> C[Table Scan]        subgraph æ•°æ®æµå‘        A        B        C    end        %% æ˜¾å¼å®šä¹‰å­å›¾å†…éƒ¨çš„è¿æ¥æ–¹å‘ï¼Œæé«˜å…¼å®¹æ€§    A --> B    B --> C</pre><p>ç°åœ¨ï¼Œæˆ‘ä»¬æ¥çœ‹æ•°æ®æ˜¯å¦‚ä½•åœ¨è¿™æ£µæ ‘ä¸ŠæµåŠ¨çš„ã€‚</p><ul><li><p><strong>ä¼ ç»Ÿè¡Œå¼&#x2F;ç«å±±æ¨¡å‹ (Tuple-at-a-time &#x2F; é›¶å”®æ¨¡å¼)</strong><br>è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„â€œ<strong>æ‹‰åŠ¨ï¼ˆPull-basedï¼‰</strong>â€æ¨¡å‹ï¼Œæ•°æ®<strong>ä¸€æ¬¡ä¸€è¡Œï¼ˆä¸€ä¸ªå…ƒç»„ï¼‰</strong>åœ°åœ¨æ ‘ä¸­è¢«â€œæ‹‰â€ç€å‘ä¸ŠæµåŠ¨ã€‚</p><ol><li>é¡¶å±‚ <code>Aggregate</code> æ“ä½œç¬¦è°ƒç”¨ <code>Filter.next()</code>ï¼Œè¯´ï¼šâ€œç»™æˆ‘ä¸‹ä¸€è¡Œç¬¦åˆæ¡ä»¶çš„æ•°æ®â€ã€‚</li><li><code>Filter</code> æ“ä½œç¬¦è°ƒç”¨ <code>Table Scan.next()</code>ï¼Œè¯´ï¼šâ€œç»™æˆ‘ä¸‹ä¸€è¡Œæ•°æ®â€ã€‚</li><li><code>Table Scan</code> ä»è¡¨ä¸­è¯»å‡º<strong>ä¸€è¡Œ</strong>æ•°æ®ï¼Œè¿”å›ç»™ <code>Filter</code>ã€‚</li><li><code>Filter</code> æ£€æŸ¥è¿™ä¸€è¡Œæ˜¯å¦æ»¡è¶³æ¡ä»¶ã€‚å¦‚æœæ»¡è¶³ï¼Œå°±å°†è¿™<strong>ä¸€è¡Œ</strong>è¿”å›ç»™ <code>Aggregate</code>ï¼›å¦‚æœä¸æ»¡è¶³ï¼Œåˆ™å›åˆ°ç¬¬2æ­¥ï¼Œç»§ç»­å‘ <code>Table Scan</code> è¦ä¸‹ä¸€è¡Œã€‚</li></ol><p>åœ¨è¿™ä¸ªæ¨¡å‹ä¸­ï¼Œ<strong>å¤„ç†æ¯ä¸€è¡Œæ•°æ®ï¼Œéƒ½ä¼šè§¦å‘ä¸€æ•´æ¡ä»ä¸Šåˆ°ä¸‹çš„æ–¹æ³•è°ƒç”¨é“¾</strong>ï¼Œæ§åˆ¶æµå¼€é”€å·¨å¤§ã€‚</p></li><li><p><strong>å‘é‡åŒ–æ‰§è¡Œæ¨¡å‹ (Block-at-a-time &#x2F; æ‰¹å‘æ¨¡å¼)</strong><br>å‘é‡åŒ–æ‰§è¡Œé‡‡ç”¨çš„ä¹Ÿæ˜¯â€œæ‹‰åŠ¨â€æ¨¡å‹ï¼Œä½†æ‹‰åŠ¨çš„æ˜¯<strong>â€œä¸€æ¬¡ä¸€å—ï¼ˆBlock-at-a-timeï¼‰â€</strong>æ•°æ®ã€‚</p><blockquote><p>â€œä¸€ä¸ªå—ç”±å›ºå®šçš„ä¸€ç»„å…ƒç»„ï¼ˆè®°å½•ï¼‰ç»„æˆï¼Œå®ƒä»£è¡¨ä¸€ç»„å‘é‡ï¼Œè¿™äº›å‘é‡å’Œåˆ— &#x2F; å­—æ®µæœ‰ä¸€ä¸€å¯¹åº”çš„å…³ç³»ã€‚å‘é‡å—æ˜¯æ•°æ®çš„åŸºæœ¬å•å…ƒï¼Œå®ƒç»ç”±æ‰§è¡Œè®¡åˆ’æ ‘ï¼Œä»ä¸€ä¸ªæ“ä½œç¬¦æµå‘å¦ä¸€ä¸ªæ“ä½œç¬¦ã€‚â€</p></blockquote><ol><li>é¡¶å±‚ <code>Aggregate</code> æ“ä½œç¬¦è°ƒç”¨ <code>Filter.nextBatch()</code>ï¼Œè¯´ï¼šâ€œç»™æˆ‘ä¸‹ä¸€æ‰¹ç¬¦åˆæ¡ä»¶çš„æ•°æ®â€ã€‚</li><li><code>Filter</code> æ“ä½œç¬¦è°ƒç”¨ <code>Table Scan.nextBatch()</code>ï¼Œè¯´ï¼šâ€œç»™æˆ‘ä¸‹ä¸€æ‰¹æ•°æ®â€ã€‚</li><li><code>Table Scan</code> ä»è¡¨ä¸­ä¸€æ¬¡æ€§è¯»å‡º<strong>ä¸€ä¸ªæ•°æ®å—</strong>ï¼ˆä¾‹å¦‚1024è¡Œï¼‰ï¼Œå½¢æˆä¸€ä¸ª <code>ColumnarBatch</code>ï¼Œè¿”å›ç»™ <code>Filter</code>ã€‚</li><li><code>Filter</code> å¯¹è¿™<strong>ä¸€æ•´å—æ•°æ®</strong>è¿›è¡Œæ‰¹é‡å¤„ç†ï¼ˆä¾‹å¦‚ä½¿ç”¨æ©ç ï¼‰ï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„ã€åªåŒ…å«ç¬¦åˆæ¡ä»¶æ•°æ®çš„<strong>æ•°æ®å—</strong>ï¼Œç„¶åè¿”å›ç»™ <code>Aggregate</code>ã€‚</li></ol><p>åœ¨è¿™ä¸ªæ¨¡å‹ä¸­ï¼Œæ–¹æ³•è°ƒç”¨çš„å¼€é”€è¢«<strong>å‡æ‘Š</strong>åˆ°äº†ä¸€ä¸ªæ‰¹æ¬¡çš„ä¸Šåƒè¡Œæ•°æ®ä¸Šï¼Œæå¤§åœ°é™ä½äº†å•ä½æ•°æ®çš„å¤„ç†æˆæœ¬ã€‚</p></li></ul><h4 id="ä¸ºä»€ä¹ˆä¼ ç»Ÿè¡Œå¼æ¨¡å‹å¼€é”€å¤§ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆä¼ ç»Ÿè¡Œå¼æ¨¡å‹å¼€é”€å¤§ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆä¼ ç»Ÿè¡Œå¼æ¨¡å‹å¼€é”€å¤§ï¼Ÿ"></a>ä¸ºä»€ä¹ˆä¼ ç»Ÿè¡Œå¼æ¨¡å‹å¼€é”€å¤§ï¼Ÿ</h4><p>çœ‹ä¼¼ç®€å•çš„ <code>while</code> å¾ªç¯èƒŒåï¼Œéšè—ç€å·¨å¤§çš„æ€§èƒ½å¼€é”€ï¼š</p><ol><li><p><strong>å¤§é‡çš„è™šæ–¹æ³•è°ƒç”¨ (Virtual Function Calls)<strong>ï¼šåœ¨ Java æˆ– C++ ä¸­ï¼Œç®—å­é€šå¸¸æ˜¯æ¥å£æˆ–åŸºç±»ï¼ˆå¦‚ <code>Operator</code>ï¼‰ï¼Œ<code>next()</code> æ˜¯ä¸€ä¸ªè™šæ–¹æ³•ã€‚å¯¹äºä¸€ä¸ªåŒ…å«å¤šä¸ªç®—å­ï¼ˆæ‰«æã€è¿‡æ»¤ã€æŠ•å½±ã€èšåˆï¼‰çš„å¤æ‚æŸ¥è¯¢ï¼Œ</strong>å¤„ç†æ¯ä¸€è¡Œæ•°æ®ï¼Œéƒ½ä¼šè§¦å‘ä¸€è¿ä¸²çš„è™šæ–¹æ³•è°ƒç”¨</strong>ã€‚è¿™ä¼šé˜»ç¢ JIT ç¼–è¯‘å™¨çš„å†…è”ä¼˜åŒ–ï¼Œå¹¶å¯¼è‡´é«˜æ˜‚çš„åŠ¨æ€åˆ†æ´¾å¼€é”€ã€‚</p></li><li><p><strong>é¢‘ç¹çš„åˆ†æ”¯é¢„æµ‹å¤±è´¥ (Branch Misprediction)<strong>ï¼šå¾ªç¯ä¸­çš„ <code>if</code> æ¡ä»¶ï¼ˆå¦‚ <code>WHERE amount &gt; 10</code>ï¼‰ä¼šå¼•å…¥å¤§é‡åˆ†æ”¯ã€‚ç°ä»£ CPU ä¸ºäº†æé«˜æ•ˆç‡ï¼Œä¼šè¿›è¡Œâ€œåˆ†æ”¯é¢„æµ‹â€ï¼Œæå‰æ‰§è¡Œå®ƒè®¤ä¸ºæœ€å¯èƒ½çš„åˆ†æ”¯ã€‚å¦‚æœæ•°æ®åˆ†å¸ƒä¸å‡ï¼ˆ<code>amount &gt; 10</code> çš„ç»“æœæ—¶çœŸæ—¶å‡ï¼‰ï¼ŒCPU å°±ä¼šé¢‘ç¹çŒœé”™ã€‚æ¯æ¬¡çŒœé”™ï¼Œéƒ½ä¼šå¯¼è‡´æ•´ä¸ª CPU æµæ°´çº¿è¢«æ¸…ç©ºå’Œé‡å»ºï¼Œè¿™ä¼š</strong>æµªè´¹å‡ åä¸ªç”šè‡³ä¸Šç™¾ä¸ª CPU å‘¨æœŸ</strong>ã€‚</p></li><li><p>**ç¼“å­˜æœªå‘½ä¸­ (Cache Miss)**ï¼šè¡Œå¼æ•°æ®åœ¨å†…å­˜ä¸­é€šå¸¸ä¸æ˜¯è¿ç»­çš„ï¼ˆç‰¹åˆ«æ˜¯åŒ…å«å˜é•¿å­—ç¬¦ä¸²æ—¶ï¼‰ï¼ŒCPU åœ¨å¤„ç†æ•°æ®æ—¶éœ€è¦è¿›è¡Œâ€œæŒ‡é’ˆè¿½é€â€ï¼Œè¿™ä¼šé¢‘ç¹å¯¼è‡´ç¼“å­˜æœªå‘½ä¸­ï¼Œè¢«è¿«ä»æ…¢å¾—å¤šçš„ä¸»å†…å­˜ä¸­è¯»å–æ•°æ®ã€‚</p></li></ol><h3 id="2-2-æ ¸å¿ƒæ¦‚å¿µè§£æï¼šå‘é‡åŒ–å¦‚ä½•æˆ˜èƒœæ€§èƒ½ç“¶é¢ˆ"><a href="#2-2-æ ¸å¿ƒæ¦‚å¿µè§£æï¼šå‘é‡åŒ–å¦‚ä½•æˆ˜èƒœæ€§èƒ½ç“¶é¢ˆ" class="headerlink" title="2.2 æ ¸å¿ƒæ¦‚å¿µè§£æï¼šå‘é‡åŒ–å¦‚ä½•æˆ˜èƒœæ€§èƒ½ç“¶é¢ˆ"></a>2.2 æ ¸å¿ƒæ¦‚å¿µè§£æï¼šå‘é‡åŒ–å¦‚ä½•æˆ˜èƒœæ€§èƒ½ç“¶é¢ˆ</h3><p>å‘é‡åŒ–æ‰§è¡Œé€šè¿‡ä¸€ç³»åˆ—ç²¾å¦™è®¾è®¡ï¼Œå®Œç¾åœ°è§„é¿äº†ä¸Šè¿°é—®é¢˜ã€‚</p><h4 id="2-2-1-SIMDï¼šç”¨ä¸€æ¡æŒ‡ä»¤å¹²å¤šä¸ªäººçš„æ´»"><a href="#2-2-1-SIMDï¼šç”¨ä¸€æ¡æŒ‡ä»¤å¹²å¤šä¸ªäººçš„æ´»" class="headerlink" title="2.2.1 SIMDï¼šç”¨ä¸€æ¡æŒ‡ä»¤å¹²å¤šä¸ªäººçš„æ´»"></a>2.2.1 SIMDï¼šç”¨ä¸€æ¡æŒ‡ä»¤å¹²å¤šä¸ªäººçš„æ´»</h4><p>**SIMD (Single Instruction, Multiple Data)**ï¼Œå³â€œå•æŒ‡ä»¤ï¼Œå¤šæ•°æ®â€ï¼Œæ˜¯ç°ä»£ CPU æä¾›çš„ä¸€ç§å¼ºå¤§çš„å¹¶è¡Œè®¡ç®—èƒ½åŠ›ã€‚</p><ul><li><strong>æ˜¯ä»€ä¹ˆ</strong>ï¼šå®ƒå…è®¸ CPU <strong>ç”¨ä¸€æ¡æŒ‡ä»¤åŒæ—¶å¯¹å¤šä¸ªæ•°æ®æ‰§è¡Œç›¸åŒçš„æ“ä½œ</strong>ã€‚ä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆ CPU å†…éƒ¨çš„ä¸€æ¡â€œæµæ°´çº¿â€ï¼Œä¸€æ¬¡å¯ä»¥å¤„ç†ä¸€æ•´â€œæ‰˜ç›˜â€çš„æ•°æ®ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªä¸€ä¸ªåœ°å¤„ç†ã€‚</li><li><strong>å¦‚ä½•å®ç°</strong>ï¼šCPU å†…éƒ¨æœ‰ç‰¹æ®Šçš„<strong>å‘é‡å¯„å­˜å™¨</strong>ï¼ˆå¦‚ 128ä½çš„ SSE å¯„å­˜å™¨ã€256ä½çš„ AVX å¯„å­˜å™¨ï¼‰ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ª 256 ä½çš„ AVX å¯„å­˜å™¨å¯ä»¥ä¸€æ¬¡æ€§è£…å…¥ <strong>8 ä¸ª</strong> 32ä½æ•´æ•°ï¼Œæˆ– <strong>4 ä¸ª</strong> 64ä½æµ®ç‚¹æ•°ã€‚CPU çš„ä¸€æ¡ SIMD åŠ æ³•æŒ‡ä»¤ï¼Œå°±å¯ä»¥ç¬é—´å®Œæˆè¿™ 8 ä¸ªæ•´æ•°å¯¹çš„ç›¸åŠ ã€‚</li><li><strong>ä¸å‘é‡åŒ–çš„å…³ç³»</strong>ï¼šåˆ—å¼æ•°æ®åœ¨å†…å­˜ä¸­è¿ç»­å­˜æ”¾ï¼Œå®Œç¾å¥‘åˆäº† SIMD çš„å·¥ä½œæ¨¡å¼ã€‚å¼•æ“å¯ä»¥ç›´æ¥å°†ä¸€ä¸ªåˆ—å‘é‡ï¼ˆæ•°ç»„ï¼‰çš„ä¸€éƒ¨åˆ†åŠ è½½åˆ°å‘é‡å¯„å­˜å™¨ä¸­ï¼Œç”¨ SIMD æŒ‡ä»¤è¿›è¡Œè®¡ç®—ï¼Œæ€§èƒ½æå‡æ˜¯æ•°é‡çº§çš„ã€‚</li></ul><h4 id="2-2-2-æ©ç -ä½å›¾ï¼šæ¶ˆç­-if-åˆ†æ”¯çš„è‰ºæœ¯"><a href="#2-2-2-æ©ç -ä½å›¾ï¼šæ¶ˆç­-if-åˆ†æ”¯çš„è‰ºæœ¯" class="headerlink" title="2.2.2 æ©ç &#x2F;ä½å›¾ï¼šæ¶ˆç­ if åˆ†æ”¯çš„è‰ºæœ¯"></a>2.2.2 æ©ç &#x2F;ä½å›¾ï¼šæ¶ˆç­ <code>if</code> åˆ†æ”¯çš„è‰ºæœ¯</h4><p>ä¸ºäº†é¿å…åˆ†æ”¯é¢„æµ‹å¤±è´¥å¸¦æ¥çš„å·¨å¤§æˆæœ¬ï¼Œå‘é‡åŒ–å¼•æ“é‡‡ç”¨<strong>æ©ç ï¼ˆMaskï¼‰æˆ–ä½å›¾ï¼ˆBitmapï¼‰</strong>æ¥å¤„ç†æ¡ä»¶é€»è¾‘ï¼Œè¿™æ˜¯ä¸€ç§å°†â€œæ§åˆ¶æµä¾èµ–â€è½¬æ¢ä¸ºâ€œæ•°æ®æµä¾èµ–â€çš„æŠ€å·§ã€‚</p><ul><li><p><strong>æ˜¯ä»€ä¹ˆ</strong>ï¼šä¸€ä¸ªæ©ç &#x2F;ä½å›¾å°±æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼æ•°ç»„æˆ–ä¸€ä¸ªæ¯”ç‰¹åºåˆ—ï¼Œç”¨äºè®°å½•ä¸€æ‰¹æ•°æ®ä¸­å“ªäº›è¡Œç¬¦åˆæ¡ä»¶ã€‚</p></li><li><p><strong>å¦‚ä½•å®ç°</strong>ï¼š</p><ol><li><strong>ç”Ÿæˆæ©ç </strong>ï¼šä¸å†ä½¿ç”¨ <code>if</code> æ¥é€ä¸ªåˆ¤æ–­ï¼Œè€Œæ˜¯æ‰§è¡Œä¸€ä¸ªå‘é‡åŒ–çš„æ¯”è¾ƒæ“ä½œï¼Œç”Ÿæˆä¸€ä¸ªæ©ç ã€‚ä¾‹å¦‚ï¼Œå¯¹äº <code>amount &gt; 10</code>ï¼Œå¼•æ“ä¼šä¸€æ¬¡æ€§æ¯”è¾ƒä¸€æ‰¹ <code>amount</code> æ•°æ®ï¼Œç”Ÿæˆä¸€ä¸ªç±»ä¼¼ <code>[true, false, true, ...]</code> çš„å¸ƒå°”æ©ç ã€‚</li><li><strong>åº”ç”¨æ©ç </strong>ï¼šåç»­çš„ç®—å­æ ¹æ®è¿™ä¸ªæ©ç æ¥åªå¤„ç†æœ‰æ•ˆçš„æ•°æ®ã€‚ä¾‹å¦‚ï¼Œèšåˆç®—å­ä¼šæ ¹æ®æ©ç ï¼Œåªç´¯åŠ é‚£äº›å¯¹åº”ä½ç½®ä¸º <code>true</code> çš„ <code>price</code> å€¼ã€‚</li></ol></li><li><p><strong>ä¸ºä»€ä¹ˆæ€§èƒ½é«˜</strong>ï¼š</p><ul><li><strong>æ— åˆ†æ”¯</strong>ï¼šæ•´ä¸ªè¿‡ç¨‹æ²¡æœ‰ <code>if</code> è·³è½¬ï¼ŒCPU æµæ°´çº¿å¯ä»¥é¡ºç•…åœ°æ‰§è¡Œï¼Œä¸ä¼šè¢«æ‰“æ–­ã€‚</li><li><strong>SIMD å‹å¥½</strong>ï¼šç”Ÿæˆæ©ç å’Œåº”ç”¨æ©ç çš„è¿‡ç¨‹ï¼Œæœ¬èº«ä¹Ÿå¯ä»¥è¢« SIMD æŒ‡ä»¤é«˜åº¦ä¼˜åŒ–ã€‚</li></ul></li></ul><h3 id="2-3-å‘é‡åŒ–å¼•æ“çš„è®¾è®¡åŸç†"><a href="#2-3-å‘é‡åŒ–å¼•æ“çš„è®¾è®¡åŸç†" class="headerlink" title="2.3 å‘é‡åŒ–å¼•æ“çš„è®¾è®¡åŸç†"></a>2.3 å‘é‡åŒ–å¼•æ“çš„è®¾è®¡åŸç†</h3><p>ä¸€ä¸ªç°ä»£çš„å‘é‡åŒ–å¼•æ“é€šå¸¸åŒ…å«ä»¥ä¸‹å…³é”®è®¾è®¡ï¼š</p><h4 id="2-3-1-æ ¸å¿ƒæŠ€æœ¯ï¼šå­—å…¸ç¼–ç ä¸å»¶è¿Ÿç‰©åŒ–"><a href="#2-3-1-æ ¸å¿ƒæŠ€æœ¯ï¼šå­—å…¸ç¼–ç ä¸å»¶è¿Ÿç‰©åŒ–" class="headerlink" title="2.3.1 æ ¸å¿ƒæŠ€æœ¯ï¼šå­—å…¸ç¼–ç ä¸å»¶è¿Ÿç‰©åŒ–"></a>2.3.1 æ ¸å¿ƒæŠ€æœ¯ï¼šå­—å…¸ç¼–ç ä¸å»¶è¿Ÿç‰©åŒ–</h4><p>è¿™ä¸¤é¡¹æŠ€æœ¯é€šå¸¸ç»“åˆä½¿ç”¨ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†å­—ç¬¦ä¸²ç­‰å˜é•¿ã€æ¯”è¾ƒè€—æ—¶çš„æ•°æ®ç±»å‹æ—¶ã€‚</p><ol><li><p><strong>å­—å…¸ç¼–ç  (Dictionary Encoding)</strong></p><ul><li><strong>æ˜¯ä»€ä¹ˆ</strong>ï¼šä¸€ç§é«˜æ•ˆçš„åˆ—å‹ç¼©æŠ€æœ¯ã€‚å®ƒä¼šæ‰«æä¸€åˆ—æ•°æ®ï¼ˆå¦‚å›½å®¶åç§°ï¼‰ï¼Œä¸ºæ‰€æœ‰ä¸é‡å¤çš„å€¼åˆ›å»ºä¸€ä¸ªâ€œå­—å…¸â€ï¼Œå¹¶ç”¨ç´§å‡‘çš„æ•´æ•°IDæ¥æ›¿æ¢åŸå§‹å€¼ã€‚</li><li><strong>ç¤ºä¾‹</strong>ï¼š<ul><li>åŸå§‹åˆ— <code>country</code>: <code>[&#39;ç¾å›½&#39;, &#39;ä¸­å›½&#39;, &#39;ç¾å›½&#39;, &#39;æ—¥æœ¬&#39;, &#39;ä¸­å›½&#39;]</code></li><li>å­—å…¸: <code>&#123;0: &#39;ç¾å›½&#39;, 1: &#39;ä¸­å›½&#39;, 2: &#39;æ—¥æœ¬&#39;&#125;</code></li><li>ç¼–ç åçš„æ•°æ®: <code>[0, 1, 0, 2, 1]</code></li></ul></li><li><strong>ä¼˜åŠ¿</strong>ï¼šæå¤§å‡å°‘äº†å†…å­˜å ç”¨ï¼›æ›´é‡è¦çš„æ˜¯ï¼Œå°†è€—æ—¶çš„å­—ç¬¦ä¸²æ¯”è¾ƒ&#x2F;å“ˆå¸Œæ“ä½œï¼Œè½¬æ¢æˆäº†æé€Ÿçš„æ•´æ•°æ“ä½œã€‚</li></ul></li><li><p><strong>å»¶è¿Ÿç‰©åŒ– (Late Materialization)</strong></p><ul><li><strong>æ˜¯ä»€ä¹ˆ</strong>ï¼šåœ¨æ•´ä¸ªæŸ¥è¯¢æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå°½å¯èƒ½åœ°æ¨è¿Ÿå°†æ•°æ®ä»å…¶å‹ç¼©æˆ–ç¼–ç å½¢å¼ï¼ˆå¦‚å­—å…¸IDï¼‰è½¬æ¢å›åŸå§‹å€¼çš„è¿‡ç¨‹ã€‚</li><li><strong>ç¤ºä¾‹</strong>ï¼šæ‰§è¡Œ <code>WHERE country = &#39;ç¾å›½&#39;</code> æ—¶ï¼Œå¼•æ“é¦–å…ˆå°† <code>&#39;ç¾å›½&#39;</code> åœ¨å­—å…¸ä¸­æŸ¥è¯¢åˆ°å…¶IDä¸º <code>0</code>ã€‚ç„¶åï¼Œå®ƒåœ¨ç¼–ç åçš„æ•´æ•°æ•°æ® <code>[0, 1, 0, 2, 1]</code> ä¸Šæ‰§è¡Œ <code>ID == 0</code> çš„è¿‡æ»¤æ“ä½œã€‚è¿™ä¸ªè¿‡ç¨‹å®Œå…¨æ˜¯æ•´æ•°æ¯”è¾ƒï¼Œé€Ÿåº¦æå¿«ã€‚</li><li><strong>ä¼˜åŠ¿</strong>ï¼šåªæœ‰åœ¨æŸ¥è¯¢çš„æœ€åä¸€æ­¥ï¼Œå½“éœ€è¦å‘ç”¨æˆ·å±•ç¤ºç»“æœæ—¶ï¼Œå¼•æ“æ‰ä¼šæ ¹æ®IDï¼ˆå¦‚ <code>0</code>ï¼‰å»å­—å…¸é‡ŒæŸ¥æ‰¾åŸå§‹å€¼ï¼ˆ<code>&#39;ç¾å›½&#39;</code>ï¼‰ã€‚æ‰€æœ‰ä¸­é—´çš„è¿‡æ»¤ã€èšåˆã€å…³è”æ“ä½œéƒ½åœ¨é«˜æ•ˆçš„ç¼–ç æ•°æ®ä¸Šå®Œæˆï¼Œé¿å…äº†å¯¹æµ·é‡åŸå§‹æ•°æ®çš„æ˜‚è´µæ“ä½œã€‚</li></ul></li></ol><h4 id="2-3-2-å…¶ä»–å…³é”®è®¾è®¡"><a href="#2-3-2-å…¶ä»–å…³é”®è®¾è®¡" class="headerlink" title="2.3.2 å…¶ä»–å…³é”®è®¾è®¡"></a>2.3.2 å…¶ä»–å…³é”®è®¾è®¡</h4><ul><li><p><strong>æ‰¹å¤„ç†æ¨¡å‹ï¼ˆBatch Modelï¼‰</strong></p><ul><li>æ•°æ®ä»¥ <code>ColumnarBatch</code> æˆ– <code>RecordBatch</code> çš„å½¢å¼åœ¨ç®—å­é—´æµåŠ¨ã€‚ä¸€ä¸ª Batch åŒ…å«å¤šåˆ—ï¼ˆ<code>ColumnVector</code>ï¼‰ï¼Œæ¯åˆ—åŒ…å«ä¸€æ‰¹æ•°æ®ï¼ˆå¦‚ 1024 æˆ– 4096 è¡Œï¼‰ã€‚</li></ul></li><li><p><strong>æ ‡å‡†åˆ—å¼å†…å­˜æ ¼å¼ï¼ˆå¦‚ Apache Arrowï¼‰</strong></p><ul><li>ä¸ºäº†å®ç°é«˜æ•ˆçš„è·¨è¯­è¨€ã€è·¨è¿›ç¨‹æ•°æ®äº¤æ¢ï¼ˆç”šè‡³æ˜¯é›¶æ‹·è´ï¼‰ï¼Œä¸šç•Œå¹¿æ³›é‡‡ç”¨ <strong>Apache Arrow</strong> ä½œä¸ºå†…å­˜ä¸­çš„åˆ—å¼æ ‡å‡†ã€‚</li></ul></li><li><p><strong>åŸç”Ÿç®—å­è®¾è®¡ (Native Operators)</strong></p><ul><li>æ‰€æœ‰çš„è®¡ç®—ç®—å­ï¼ˆå¦‚ Filter, Project, Aggregate, Joinï¼‰éƒ½å¿…é¡»é‡æ–°è®¾è®¡ï¼Œä½¿å…¶èƒ½ç›´æ¥æ“ä½œ <code>ColumnarBatch</code>ã€‚</li></ul></li></ul><h2 id="ä¸‰ã€æ€»ç»“ï¼š"><a href="#ä¸‰ã€æ€»ç»“ï¼š" class="headerlink" title="ä¸‰ã€æ€»ç»“ï¼š"></a>ä¸‰ã€æ€»ç»“ï¼š</h2><p><strong>åˆ—å¼å­˜å‚¨</strong>å’Œ<strong>å‘é‡åŒ–æ‰§è¡Œ</strong>æ˜¯ç°ä»£é«˜æ€§èƒ½åˆ†æå¼•æ“çš„ä¸¤ä¸ªæ ¸å¿ƒæ”¯æŸ±ï¼Œå®ƒä»¬ç›¸è¾…ç›¸æˆï¼Œç¼ºä¸€ä¸å¯ã€‚</p><ul><li><strong>åˆ—å¼å­˜å‚¨</strong>è´Ÿè´£åœ¨å®è§‚ä¸Šï¼ˆç£ç›˜ I&#x2F;Oï¼‰å‡å°‘æ•°æ®è¯»å–é‡ï¼Œå¹¶æä¾›ä¸€ç§å¯¹ CPU ç¼“å­˜å’Œ SIMD å‹å¥½çš„å†…å­˜å¸ƒå±€ã€‚</li><li><strong>å‘é‡åŒ–æ‰§è¡Œ</strong>åˆ™åœ¨å¾®è§‚ä¸Šï¼ˆCPU è®¡ç®—ï¼‰å……åˆ†åˆ©ç”¨è¿™ç§æ•°æ®å¸ƒå±€ï¼Œé€šè¿‡æ‰¹å¤„ç†ã€SIMD æŒ‡ä»¤ã€æ— åˆ†æ”¯è®¡ç®—å’Œå»¶è¿Ÿç‰©åŒ–ç­‰æŠ€æœ¯ï¼Œå°† CPU çš„è®¡ç®—èƒ½åŠ›å‹æ¦¨åˆ°æè‡´ã€‚</li></ul><p>æ­£æ˜¯è¿™ç§ä»å­˜å‚¨åˆ°è®¡ç®—çš„å…¨é“¾è·¯ä¼˜åŒ–ï¼Œæ‰ä½¿å¾—åƒ Spark (with AQE)ã€StarRocksã€ClickHouse ç­‰ç°ä»£æ•°æ®ç³»ç»Ÿèƒ½å¤Ÿå®ç°æƒŠäººçš„æŸ¥è¯¢æ€§èƒ½ã€‚</p><hr><h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><ol><li><a href="https://www.infoq.cn/article/columnar-databases-and-vectorization">ã€Šåˆ—å¼æ•°æ®åº“å’Œå‘é‡åŒ–ã€‹ - InfoQ</a></li><li><a href="https://www.modb.pro/db/1721344266176389120">ã€Šå‘é‡åŒ–å¼•æ“æ€ä¹ˆæå‡æ•°æ®åº“æ€§èƒ½ã€‹ - å¢¨å¤©è½®</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¯†ç å­¦ </tag>
            
            <tag> éå¯¹ç§°åŠ å¯† </tag>
            
            <tag> æ•°å­—ç­¾å </tag>
            
            <tag> æ•°å­—è¯ä¹¦ </tag>
            
            <tag> CA </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux ç£ç›˜ç©ºé—´å¼‚å¸¸å ç”¨æ’æŸ¥ï¼šè¢«åˆ é™¤æ–‡ä»¶ä»è¢«è¿›ç¨‹å ç”¨å¯¼è‡´ç©ºé—´æœªé‡Šæ”¾</title>
      <link href="/2025/08/10/Linux%20%E7%A3%81%E7%9B%98%E7%A9%BA%E9%97%B4%E5%BC%82%E5%B8%B8%E5%8D%A0%E7%94%A8%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E4%B8%8E%E8%A7%A3%E5%86%B3/"/>
      <url>/2025/08/10/Linux%20%E7%A3%81%E7%9B%98%E7%A9%BA%E9%97%B4%E5%BC%82%E5%B8%B8%E5%8D%A0%E7%94%A8%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E4%B8%8E%E8%A7%A3%E5%86%B3/</url>
      
        <content type="html"><![CDATA[<h1 id="Linux-ä¸­è¢«åˆ é™¤æ–‡ä»¶å› è¿›ç¨‹å ç”¨å¯¼è‡´ç£ç›˜ç©ºé—´æœªé‡Šæ”¾é—®é¢˜"><a href="#Linux-ä¸­è¢«åˆ é™¤æ–‡ä»¶å› è¿›ç¨‹å ç”¨å¯¼è‡´ç£ç›˜ç©ºé—´æœªé‡Šæ”¾é—®é¢˜" class="headerlink" title="Linux ä¸­è¢«åˆ é™¤æ–‡ä»¶å› è¿›ç¨‹å ç”¨å¯¼è‡´ç£ç›˜ç©ºé—´æœªé‡Šæ”¾é—®é¢˜"></a>Linux ä¸­è¢«åˆ é™¤æ–‡ä»¶å› è¿›ç¨‹å ç”¨å¯¼è‡´ç£ç›˜ç©ºé—´æœªé‡Šæ”¾é—®é¢˜</h1><h2 id="ä¸€ã€é—®é¢˜ç°è±¡-å‘ç°"><a href="#ä¸€ã€é—®é¢˜ç°è±¡-å‘ç°" class="headerlink" title="ä¸€ã€é—®é¢˜ç°è±¡ &#x2F; å‘ç°"></a>ä¸€ã€é—®é¢˜ç°è±¡ &#x2F; å‘ç°</h2><ol><li><p><strong>ç£ç›˜å ç”¨å‘Šè­¦</strong>ï¼šæ‰§è¡Œ <code>df -h</code> å‘½ä»¤æ˜¾ç¤ºæ ¹åˆ†åŒºï¼ˆ<code>/dev/sda1</code>ï¼‰æ€»å®¹é‡ 4.9Gï¼Œå·² 100% å ç”¨ï¼Œå¯ç”¨ç©ºé—´ä¸º 0ï¼Œå¯¼è‡´ç³»ç»Ÿæ— æ³•å†™å…¥æ–°æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sda1       4.9G  4.9G     0 100% /</span><br></pre></td></tr></table></figure></li><li><p><strong>ç£ç›˜ç»Ÿè®¡çŸ›ç›¾</strong>ï¼šæ‰§è¡Œ <code>du -h / --max-depth=1</code> ç»Ÿè®¡æ ¹ç›®å½•æ€»å ç”¨ä»… 1.3Gï¼Œä¸ <code>df</code> æ˜¾ç¤ºçš„ 4.9G å ç”¨ä¸¥é‡ä¸ç¬¦ï¼Œå­˜åœ¨ â€œéšè—å ç”¨â€ã€‚</p></li><li><p><strong>å…³é”®æ—¥å¿—æ–‡ä»¶å¼‚å¸¸</strong>ï¼šé€šè¿‡æ‰‹åŠ¨æ’æŸ¥è¿›ç¨‹æ–‡ä»¶æè¿°ç¬¦ï¼Œå‘ç° <code>/var/log</code> ä¸‹çš„å¤šä¸ªæ ¸å¿ƒæ—¥å¿—æ–‡ä»¶ï¼ˆ<code>messages</code>ã€<code>syslog</code>ã€<code>auth.log</code> ç­‰ï¼‰å·²è¢«åˆ é™¤ï¼Œä½†ä»è¢«è¿›ç¨‹å ç”¨ï¼ŒçŠ¶æ€æ ‡è®°ä¸º <code>(deleted)</code>ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">l-wx------ 1 root root 64 Aug  9 22:03 10 -&gt; /var/log/messages (deleted)</span><br><span class="line">l-wx------ 1 root root 64 Aug  9 22:03 7 -&gt; /var/log/syslog (deleted)</span><br></pre></td></tr></table></figure></li></ol><h2 id="äºŒã€é—®é¢˜åˆ†æ"><a href="#äºŒã€é—®é¢˜åˆ†æ" class="headerlink" title="äºŒã€é—®é¢˜åˆ†æ"></a>äºŒã€é—®é¢˜åˆ†æ</h2><ol><li><strong>è¢«åˆ é™¤æ–‡ä»¶çš„è¿›ç¨‹å ç”¨æœºåˆ¶</strong>ï¼š<br>Linux ç³»ç»Ÿä¸­ï¼Œå½“æ–‡ä»¶è¢« <code>rm</code> å‘½ä»¤åˆ é™¤åï¼Œè‹¥ä»æœ‰è¿›ç¨‹æŒæœ‰è¯¥æ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆå¦‚æ—¥å¿—æœåŠ¡æ­£åœ¨å†™å…¥ï¼‰ï¼Œå†…æ ¸ä¸ä¼šç«‹å³é‡Šæ”¾ç£ç›˜ç©ºé—´ï¼Œ<code>df</code> ä»ä¼šç»Ÿè®¡ä¸º â€œå·²å ç”¨â€ï¼Œä½† <code>du</code> æ— æ³•æ£€æµ‹åˆ°ï¼ˆå› æ–‡ä»¶å·²ä»ç›®å½•æ ‘ä¸­ç§»é™¤ï¼‰ï¼Œå¯¼è‡´ä¸¤è€…æ•°æ®çŸ›ç›¾ã€‚</li><li><strong>æ—¥å¿—æœåŠ¡çš„è§’è‰²</strong>ï¼š<br>è¢«å ç”¨çš„æ–‡ä»¶å‡ä¸ºç³»ç»Ÿæ—¥å¿—æ–‡ä»¶ï¼Œç”± <code>rsyslog</code> æœåŠ¡ï¼ˆç³»ç»Ÿæ—¥å¿—å®ˆæŠ¤è¿›ç¨‹ï¼‰ç®¡ç†ã€‚<code>rsyslog</code> æŒç»­å†™å…¥è¿™äº›æ—¥å¿—æ–‡ä»¶ï¼Œå³ä½¿æ–‡ä»¶è¢«æ‰‹åŠ¨åˆ é™¤ï¼Œè¿›ç¨‹ä»ä¿æŒå¯¹å…¶çš„å¼•ç”¨ï¼Œå¯¼è‡´ç©ºé—´æ— æ³•é‡Šæ”¾ã€‚</li><li><strong>ç£ç›˜æ»¡çš„ç›´æ¥åŸå› </strong>ï¼š<br>è¢«åˆ é™¤çš„æ—¥å¿—æ–‡ä»¶å®é™…å ç”¨äº†å¤§é‡ç©ºé—´ï¼ˆæ¨æµ‹ä¸ºå‡ ç™¾ MBï¼‰ï¼Œä½†å› è¿›ç¨‹å ç”¨æœªé‡Šæ”¾ï¼Œå¯¼è‡´æ ¹åˆ†åŒºè¢« â€œè™šå â€ è‡³ 100%ã€‚</li></ol><h2 id="ä¸‰ã€é—®é¢˜è§£å†³"><a href="#ä¸‰ã€é—®é¢˜è§£å†³" class="headerlink" title="ä¸‰ã€é—®é¢˜è§£å†³"></a>ä¸‰ã€é—®é¢˜è§£å†³</h2><h3 id="1-å®šä½é—®é¢˜æ ¹æº"><a href="#1-å®šä½é—®é¢˜æ ¹æº" class="headerlink" title="1. å®šä½é—®é¢˜æ ¹æº"></a>1. å®šä½é—®é¢˜æ ¹æº</h3><p>é€šè¿‡æ’æŸ¥è¿›ç¨‹æ–‡ä»¶æè¿°ç¬¦ï¼Œç¡®è®¤è¢«åˆ é™¤ä½†ä»è¢«å ç”¨çš„æ—¥å¿—æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‰‹åŠ¨éå†è¿›ç¨‹æ–‡ä»¶æè¿°ç¬¦ï¼ˆæ—  lsof æ—¶ï¼‰</span></span><br><span class="line"><span class="keyword">for</span> pid <span class="keyword">in</span> $(<span class="built_in">ls</span> /proc); <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">if</span> [ -d <span class="string">&quot;/proc/<span class="variable">$pid</span>/fd&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">ls</span> -l /proc/<span class="variable">$pid</span>/fd 2&gt;/dev/null | grep -i deleted</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¦‚æœæœ‰å®‰è£…lsofï¼Œå¯ä»¥ç”¨ï¼š</span></span><br><span class="line">lsof | grep deleted</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢ç»“æœï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">l-wx------ 1 root root 64 Aug  9 22:03 10 -&gt; /var/log/messages (deleted)</span><br><span class="line">l-wx------ 1 root root 64 Aug  9 22:03 11 -&gt; /var/log/daemon.log (deleted)</span><br><span class="line">l-wx------ 1 root root 64 Aug  9 22:03 12 -&gt; /var/log/auth.log (deleted)</span><br><span class="line">l-wx------ 1 root root 64 Aug  9 22:03 7 -&gt; /var/log/syslog (deleted)</span><br><span class="line">l-wx------ 1 root root 64 Aug  9 22:03 8 -&gt; /var/log/kern.log (deleted)</span><br><span class="line">l-wx------ 1 root root 64 Aug  9 22:03 9 -&gt; /var/log/debug (deleted)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="2-é‡Šæ”¾è¢«å ç”¨ç©ºé—´"><a href="#2-é‡Šæ”¾è¢«å ç”¨ç©ºé—´" class="headerlink" title="2. é‡Šæ”¾è¢«å ç”¨ç©ºé—´"></a>2. é‡Šæ”¾è¢«å ç”¨ç©ºé—´</h3><p>é‡å¯ <code>rsyslog</code> æœåŠ¡ï¼Œä½¿å…¶é‡Šæ”¾å¯¹å·²åˆ é™¤æ—¥å¿—æ–‡ä»¶çš„å¼•ç”¨ï¼Œå†…æ ¸éšå³å›æ”¶ç£ç›˜ç©ºé—´ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart rsyslog</span><br></pre></td></tr></table></figure><h3 id="3-éªŒè¯è§£å†³æ•ˆæœ"><a href="#3-éªŒè¯è§£å†³æ•ˆæœ" class="headerlink" title="3. éªŒè¯è§£å†³æ•ˆæœ"></a>3. éªŒè¯è§£å†³æ•ˆæœ</h3><p>æ‰§è¡Œ <code>df -h</code> ç¡®è®¤æ ¹åˆ†åŒºä½¿ç”¨ç‡ä¸‹é™ï¼Œå¯ç”¨ç©ºé—´æ¢å¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sda1       4.9G  1.2G  3.5G  26% /  <span class="comment"># ç¤ºä¾‹ç»“æœï¼Œå®é™…è§†é‡Šæ”¾ç©ºé—´è€Œå®š</span></span><br></pre></td></tr></table></figure><h2 id="å››ã€æ€»ç»“"><a href="#å››ã€æ€»ç»“" class="headerlink" title="å››ã€æ€»ç»“"></a>å››ã€æ€»ç»“</h2><ul><li><strong>æ ¸å¿ƒåŸå› </strong>ï¼šè¢«åˆ é™¤çš„æ—¥å¿—æ–‡ä»¶å›  <code>rsyslog</code> è¿›ç¨‹æŒç»­å ç”¨ï¼Œå¯¼è‡´ç£ç›˜ç©ºé—´æœªé‡Šæ”¾ã€‚</li><li><strong>è§£å†³å…³é”®</strong>ï¼šé‡å¯æŒæœ‰æ–‡ä»¶æè¿°ç¬¦çš„è¿›ç¨‹ï¼ˆæ­¤å¤„ä¸º <code>rsyslog</code>ï¼‰ï¼Œå¼ºåˆ¶é‡Šæ”¾è¢«å ç”¨ç©ºé—´ã€‚</li><li>é¢„é˜²å»ºè®®ï¼š<ol><li>é¿å…æ‰‹åŠ¨åˆ é™¤æ­£åœ¨å†™å…¥çš„æ—¥å¿—æ–‡ä»¶ï¼Œæ”¹ç”¨ <code>logrotate</code> å·¥å…·è‡ªåŠ¨è½®è½¬æ—¥å¿—ã€‚</li><li>å®šæœŸæ‰§è¡Œ <code>lsof | grep deleted</code> æ£€æŸ¥éšè—å ç”¨ï¼ŒåŠæ—¶é‡Šæ”¾æ— æ•ˆæ–‡ä»¶ã€‚</li></ol></li></ul>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç£ç›˜ç©ºé—´ </tag>
            
            <tag> æ—¥å¿— </tag>
            
            <tag> Linuxè¿ç»´ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ•°å­—ç­¾åä¸è¯ä¹¦å®æˆ˜ï¼šä½¿ç”¨OpenSSLäº²æ‰‹å®éªŒ</title>
      <link href="/2025/08/03/%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D%E4%B8%8E%E8%AF%81%E4%B9%A6%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97/"/>
      <url>/2025/08/03/%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D%E4%B8%8E%E8%AF%81%E4%B9%A6%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97/</url>
      
        <content type="html"><![CDATA[<h2 id="å¼•è¨€ï¼šä»ç†è®ºåˆ°å®è·µ"><a href="#å¼•è¨€ï¼šä»ç†è®ºåˆ°å®è·µ" class="headerlink" title="å¼•è¨€ï¼šä»ç†è®ºåˆ°å®è·µ"></a>å¼•è¨€ï¼šä»ç†è®ºåˆ°å®è·µ</h2><p>åœ¨ä¸Šä¸€ç¯‡æ–‡æ¡£ã€Š<a href="https://kongxiaoran.github.io/2025/08/02/%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D%E4%B8%8E%E6%95%B0%E5%AD%97%E8%AF%81%E4%B9%A6%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/">æ•°å­—ç­¾åä¸æ•°å­—è¯ä¹¦æ·±åº¦è§£æ</a>ã€‹ä¸­ï¼Œæˆ‘ä»¬æ·±å…¥æ¢è®¨äº†æ•°å­—ç­¾åä¸è¯ä¹¦èƒŒåçš„å¯†ç å­¦åŸç†ã€‚ä½†æ˜¯ç†è®ºæ˜¯ç†è®ºï¼Œå®é™…ä¸Šå¯†é’¥é•¿ä»€ä¹ˆæ ·ï¼Œæ€ä¹ˆç”Ÿæˆã€åŠ å¯†ä»¥åŠè¯ä¹¦å¦‚ä½•ç”Ÿæˆï¼Œè¿˜æ˜¯éœ€è¦è‡ªå·±å»å®è·µã€‚</p><p>æœ¬ç¯‡å°†æˆ‘é€šè¿‡ç»ˆç«¯ï¼Œä½¿ç”¨å¼ºå¤§çš„<code>openssl</code>å·¥å…·é›†ï¼Œäº²æ‰‹æ¨¡æ‹Ÿå’Œå¤ç°æ•°å­—ç­¾åä¸è¯ä¹¦çš„å…¨è¿‡ç¨‹ã€‚ä½ å°†ç›´è§‚åœ°çœ‹åˆ°ï¼š</p><ul><li>ä¸€ä¸ªåˆæ³•çš„ç­¾åå¦‚ä½•è¢«éªŒè¯é€šè¿‡ã€‚</li><li>å½“æ–‡ä»¶è¢«ç¯¡æ”¹æˆ–ç­¾åè¢«ä¼ªé€ æ—¶ï¼ŒéªŒè¯å¦‚ä½•å¤±è´¥ã€‚</li><li>ä¸€ä¸ªæƒå¨çš„CAæ˜¯å¦‚ä½•ä¸ºä»–äººç­¾å‘â€œæ•°å­—èº«ä»½è¯â€ï¼ˆè¯ä¹¦ï¼‰çš„ã€‚</li></ul><hr><h2 id="ä¸€ã€-å‡†å¤‡å·¥ä½œ"><a href="#ä¸€ã€-å‡†å¤‡å·¥ä½œ" class="headerlink" title="ä¸€ã€ å‡†å¤‡å·¥ä½œ"></a>ä¸€ã€ å‡†å¤‡å·¥ä½œ</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå·¥ä½œç›®å½•å’Œä¸€ä»½ç”¨äºç­¾åçš„åŸå§‹æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªåä¸º &quot;openssl_practice&quot; çš„å·¥ä½œç›®å½•å¹¶è¿›å…¥</span></span><br><span class="line"><span class="built_in">mkdir</span> -p openssl_practice</span><br><span class="line"><span class="built_in">cd</span> openssl_practice</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºä¸€ä»½æ¨¡æ‹Ÿçš„åˆåŒæ–‡ä»¶</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;è¿™æ˜¯ä¸€ä»½éå¸¸é‡è¦çš„åˆåŒæ–‡ä»¶ï¼Œå†…å®¹ä¸å¯ç¯¡æ”¹ã€‚&quot;</span> &gt; contract.txt</span><br></pre></td></tr></table></figure><hr><h2 id="äºŒã€-å®éªŒä¸€ï¼šæ ‡å‡†çš„æ•°å­—ç­¾åä¸éªŒè¯"><a href="#äºŒã€-å®éªŒä¸€ï¼šæ ‡å‡†çš„æ•°å­—ç­¾åä¸éªŒè¯" class="headerlink" title="äºŒã€ å®éªŒä¸€ï¼šæ ‡å‡†çš„æ•°å­—ç­¾åä¸éªŒè¯"></a>äºŒã€ å®éªŒä¸€ï¼šæ ‡å‡†çš„æ•°å­—ç­¾åä¸éªŒè¯</h2><p>æˆ‘ä»¬å°†æ¨¡æ‹Ÿå°æ˜ç”Ÿæˆå¯†é’¥å¯¹ï¼Œå¯¹<code>contract.txt</code>æ–‡ä»¶ç­¾åï¼Œç„¶åå°çº¢ä½¿ç”¨å…¶å…¬é’¥è¿›è¡ŒéªŒè¯ã€‚</p><h3 id="æ­¥éª¤1ï¼šç”Ÿæˆç§é’¥"><a href="#æ­¥éª¤1ï¼šç”Ÿæˆç§é’¥" class="headerlink" title="æ­¥éª¤1ï¼šç”Ÿæˆç§é’¥"></a>æ­¥éª¤1ï¼šç”Ÿæˆç§é’¥</h3><p>å°æ˜é¦–å…ˆéœ€è¦ä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„ç§é’¥ã€‚</p><p><strong>å‘½ä»¤ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl genpkey -algorithm RSA -out xiaoming_private_key.pem</span><br></pre></td></tr></table></figure><p><strong>ç»ˆç«¯è¾“å‡ºï¼š</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.....+++++++++++++++++++++++++++++++++++++++*..+...+...+.+......+++++++++++++++++++++++++++++++++++++++*..+..+............+.+.....+.+......+..+.......+.........+............+.....+...+....+..+...............+...+.+....+.............+.....+....+...+.....+...+........................+.+.....+....+.................+......+.......+.......................+.......+...+.....+.........+....+......+.....+.+..+...+.........+.+................+...............+.........+...+.....+...+..................+.+...+...+..+......+.+.....+.+..+.............+....+..+...+....+...+...+...........+............................+............+............+...+......+.....+.+.........+..+.....+...+..........................++++++</span><br><span class="line">..+..+.......+...+...+......+...+..+......+....+...+........+++++++++++++++++++++++++++++++++++++++*...+......+.......+...+.....+.+.....+...+.............+..+.+...........+.+.....+.......+..+....+.....+......+....+.........+...........+.........+.......+...+++++++++++++++++++++++++++++++++++++++*.....+.....++++++</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ï¼Œç›®å½•ä¸‹ç”Ÿæˆäº†<code>xiaoming_private_key.pem</code>æ–‡ä»¶ï¼Œè¿™å°±æ˜¯å°æ˜çš„â€œæ•°å­—å°ç« â€çš„æ ¹åŸºã€‚</p><h3 id="æ­¥éª¤2ï¼šæå–å…¬é’¥"><a href="#æ­¥éª¤2ï¼šæå–å…¬é’¥" class="headerlink" title="æ­¥éª¤2ï¼šæå–å…¬é’¥"></a>æ­¥éª¤2ï¼šæå–å…¬é’¥</h3><p>å°æ˜éœ€è¦ä»ç§é’¥ä¸­æå–å‡ºå…¬é’¥ï¼Œä»¥ä¾¿åˆ†å‘ç»™å…¶ä»–äººï¼ˆå¦‚å°çº¢ï¼‰ç”¨æ¥éªŒè¯ã€‚</p><p><strong>å‘½ä»¤ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl pkey -<span class="keyword">in</span> xiaoming_private_key.pem -pubout -out xiaoming_public_key.pem</span><br></pre></td></tr></table></figure><p>æ­¤å‘½ä»¤æ‰§è¡Œåæ²¡æœ‰å¤æ‚çš„è¾“å‡ºï¼Œå®ƒä¼šé™é»˜åœ°ç”Ÿæˆ<code>xiaoming_public_key.pem</code>æ–‡ä»¶ã€‚</p><h3 id="æ­¥éª¤3ï¼šè¿›è¡Œæ•°å­—ç­¾å"><a href="#æ­¥éª¤3ï¼šè¿›è¡Œæ•°å­—ç­¾å" class="headerlink" title="æ­¥éª¤3ï¼šè¿›è¡Œæ•°å­—ç­¾å"></a>æ­¥éª¤3ï¼šè¿›è¡Œæ•°å­—ç­¾å</h3><p>å°æ˜ç°åœ¨ä½¿ç”¨ä»–çš„ç§é’¥å¯¹åˆåŒæ–‡ä»¶è¿›è¡Œç­¾åã€‚è¿™ä¸ªè¿‡ç¨‹åŒ…å«<strong>è®¡ç®—å“ˆå¸Œ</strong>å’Œ<strong>ç”¨ç§é’¥åŠ å¯†å“ˆå¸Œ</strong>ä¸¤ä¸ªæ­¥éª¤ï¼Œ<code>openssl</code>ä¼šä¸€æ­¥å®Œæˆã€‚</p><p><strong>å‘½ä»¤ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl dgst -sha256 -sign xiaoming_private_key.pem -out contract.sig contract.txt</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œåï¼Œä¼šç”Ÿæˆä¸€ä¸ª<code>contract.sig</code>æ–‡ä»¶ï¼Œè¿™å°±æ˜¯æ•°å­—ç­¾åã€‚å®ƒæ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ— æ³•ç›´æ¥é˜…è¯»ã€‚</p><h3 id="æ­¥éª¤4ï¼šéªŒè¯æ•°å­—ç­¾å"><a href="#æ­¥éª¤4ï¼šéªŒè¯æ•°å­—ç­¾å" class="headerlink" title="æ­¥éª¤4ï¼šéªŒè¯æ•°å­—ç­¾å"></a>æ­¥éª¤4ï¼šéªŒè¯æ•°å­—ç­¾å</h3><p>å°æ˜å°†<code>contract.txt</code>ï¼ˆåŸæ–‡ï¼‰ã€<code>contract.sig</code>ï¼ˆç­¾åï¼‰ã€<code>xiaoming_public_key.pem</code>ï¼ˆå…¬é’¥ï¼‰ä¸‰è€…éƒ½äº¤ç»™äº†å°çº¢ã€‚å°çº¢å¼€å§‹éªŒè¯ã€‚</p><p><strong>å‘½ä»¤ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl dgst -sha256 -verify xiaoming_public_key.pem -signature contract.sig contract.txt</span><br></pre></td></tr></table></figure><p><strong>ç»ˆç«¯è¾“å‡ºï¼š</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Verified OK</span><br></pre></td></tr></table></figure><p><code>Verified OK</code>è¿™ä¸ªè¾“å‡ºæ˜ç¡®åœ°å‘Šè¯‰æˆ‘ä»¬ï¼š<strong>éªŒè¯é€šè¿‡ï¼</strong> å°çº¢å¯ä»¥ç¡®ä¿¡ï¼Œè¿™ä»½æ–‡ä»¶ç¡®å®æ¥è‡ªå°æ˜ï¼Œå¹¶ä¸”å†…å®¹å®Œå¥½æ— æŸã€‚</p><hr><h2 id="ä¸‰ã€-å®éªŒäºŒï¼šæ¨¡æ‹Ÿæ”»å‡»ï¼Œè§‚å¯ŸéªŒè¯å¤±è´¥"><a href="#ä¸‰ã€-å®éªŒäºŒï¼šæ¨¡æ‹Ÿæ”»å‡»ï¼Œè§‚å¯ŸéªŒè¯å¤±è´¥" class="headerlink" title="ä¸‰ã€ å®éªŒäºŒï¼šæ¨¡æ‹Ÿæ”»å‡»ï¼Œè§‚å¯ŸéªŒè¯å¤±è´¥"></a>ä¸‰ã€ å®éªŒäºŒï¼šæ¨¡æ‹Ÿæ”»å‡»ï¼Œè§‚å¯ŸéªŒè¯å¤±è´¥</h2><p>â€œå®‰å…¨â€çš„æœ€å¥½è¯æ˜ï¼Œå°±æ˜¯çœ‹å®ƒåœ¨â€œä¸å®‰å…¨â€çš„æƒ…å†µä¸‹å¦‚ä½•ååº”ã€‚</p><h3 id="åœºæ™¯1ï¼šæ–‡ä»¶å†…å®¹è¢«ç¯¡æ”¹"><a href="#åœºæ™¯1ï¼šæ–‡ä»¶å†…å®¹è¢«ç¯¡æ”¹" class="headerlink" title="åœºæ™¯1ï¼šæ–‡ä»¶å†…å®¹è¢«ç¯¡æ”¹"></a>åœºæ™¯1ï¼šæ–‡ä»¶å†…å®¹è¢«ç¯¡æ”¹</h3><p>å‡è®¾æ”»å‡»è€…å°é»‘åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ä¿®æ”¹äº†åˆåŒã€‚</p><p><strong>å‘½ä»¤ï¼š</strong><br>æˆ‘ä»¬å°†åˆåŒå†…å®¹ä¿®æ”¹ï¼Œç„¶åç«‹å³ç”¨<strong>åŸå§‹ç­¾å</strong>å’Œ<strong>å°æ˜çš„å…¬é’¥</strong>è¿›è¡ŒéªŒè¯ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¿®æ”¹æ–‡ä»¶å†…å®¹</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;è¿™æ˜¯ä¸€ä»½è¢«ç¯¡æ”¹è¿‡çš„åˆåŒï¼&quot;</span> &gt; contract.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°è¯•éªŒè¯</span></span><br><span class="line">openssl dgst -sha256 -verify xiaoming_public_key.pem -signature contract.sig contract.txt</span><br></pre></td></tr></table></figure><p><strong>ç»ˆç«¯è¾“å‡ºï¼š</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Verification Failure</span><br><span class="line">400817F601000000:error:02000068:rsa routines:ossl_rsa_verify:bad signature:crypto/rsa/rsa_sign.c:442:</span><br><span class="line">400817F601000000:error:1C880004:Provider routines:rsa_verify_directly:RSA lib:providers/implementations/signature/rsa_sig.c:1041:</span><br></pre></td></tr></table></figure><p><strong>Verification Failure!</strong> éªŒè¯å¤±è´¥ã€‚å› ä¸ºæ–‡ä»¶å†…å®¹çš„å“ˆå¸Œå€¼å˜äº†ï¼Œä¸ç­¾åè§£å¯†åçš„åŸå§‹å“ˆå¸Œå€¼ä¸åŒ¹é…ã€‚</p><h3 id="åœºæ™¯2ï¼šç­¾åè¢«ä¼ªé€ "><a href="#åœºæ™¯2ï¼šç­¾åè¢«ä¼ªé€ " class="headerlink" title="åœºæ™¯2ï¼šç­¾åè¢«ä¼ªé€ "></a>åœºæ™¯2ï¼šç­¾åè¢«ä¼ªé€ </h3><p>ç°åœ¨ï¼Œæˆ‘ä»¬å°†æ–‡ä»¶æ¢å¤åŸçŠ¶ï¼Œä½†æ¨¡æ‹Ÿå°é»‘è¯•å›¾ç”¨è‡ªå·±çš„ç§é’¥ç­¾åï¼Œå†’å……å°æ˜ã€‚</p><p><strong>å‘½ä»¤ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ¢å¤åŸå§‹æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;è¿™æ˜¯ä¸€ä»½éå¸¸é‡è¦çš„åˆåŒæ–‡ä»¶ï¼Œå†…å®¹ä¸å¯ç¯¡æ”¹ã€‚&quot;</span> &gt; contract.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°é»‘ç”Ÿæˆè‡ªå·±çš„å¯†é’¥å¯¹</span></span><br><span class="line">openssl genpkey -algorithm RSA -out xiaohei_private_key.pem</span><br><span class="line">openssl pkey -<span class="keyword">in</span> xiaohei_private_key.pem -pubout -out xiaohei_public_key.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°é»‘ç”¨è‡ªå·±çš„ç§é’¥ç­¾å</span></span><br><span class="line">openssl dgst -sha256 -sign xiaohei_private_key.pem -out xiaohei.sig contract.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°çº¢ä»ç„¶ç”¨å¥¹ä¿¡ä»»çš„å°æ˜çš„å…¬é’¥å»éªŒè¯è¿™ä¸ªå‡ç­¾å</span></span><br><span class="line">openssl dgst -sha256 -verify xiaoming_public_key.pem -signature xiaohei.sig contract.txt</span><br></pre></td></tr></table></figure><p><strong>ç»ˆç«¯è¾“å‡ºï¼š</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Verification failure</span><br><span class="line">400817F601000000:error:0200008A:rsa routines:RSA_padding_check_PKCS1_type_1:invalid padding:crypto/rsa/rsa_pk1.c:79:</span><br><span class="line">400817F601000000:error:02000072:rsa routines:rsa_ossl_public_decrypt:padding check failed:crypto/rsa/rsa_ossl.c:796:</span><br><span class="line">400817F601000000:error:1C880004:Provider routines:rsa_verify_directly:RSA lib:providers/implementations/signature/rsa_sig.c:1041:</span><br></pre></td></tr></table></figure><p>åŒæ ·<code>Verification Failure</code>ï¼å› ä¸ºå°é»‘çš„ç­¾ååªèƒ½ç”¨å°é»‘çš„å…¬é’¥è§£å¯†ã€‚å°çº¢ç”¨å°æ˜çš„å…¬é’¥å°è¯•è§£å¯†ï¼Œç»“æœè‡ªç„¶æ˜¯å¤±è´¥çš„ã€‚</p><blockquote><p><strong>æ‰©å±•æ¢è®¨ï¼šéªŒè¯å¤±è´¥çš„åº•å±‚åŸå› </strong></p><p>è¿™é‡Œå¯èƒ½ä¼šæœ‰ä¸€ä¸ªç–‘é—®ï¼šä½¿ç”¨é”™è¯¯çš„å…¬é’¥è¿›è¡ŒéªŒè¯ï¼Œç©¶ç«Ÿæ˜¯åœ¨RSAè§£å¯†æ—¶å°±ç›´æ¥æŠ¥é”™äº†ï¼Œè¿˜æ˜¯è§£å¯†å‡ºäº†ä¸€æ®µæ— ç”¨çš„å†…å®¹ï¼Ÿ<code>Verification Failure</code>èƒŒåçš„å…·ä½“å«ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿ</p><p><strong>è¯¦ç»†æ‹†è§£å¦‚ä¸‹ï¼š</strong></p><ol><li><p><strong>ç­¾åçš„å†…éƒ¨ç»“æ„</strong>ï¼šä¸ºäº†å®‰å…¨ï¼Œç­¾åè¿‡ç¨‹å¹¶<strong>ä¸æ˜¯</strong>åªå¯¹åŸå§‹å“ˆå¸Œè¿›è¡ŒåŠ å¯†ã€‚è€Œæ˜¯ä¼šå…ˆå°†å“ˆå¸Œå€¼åŒ…è£¹åœ¨ä¸€ä¸ªæœ‰ç‰¹å®šæ ¼å¼çš„â€œä¿¡å°â€é‡Œï¼Œè¿™ä¸ªè¿‡ç¨‹å«åš<strong>å¡«å……ï¼ˆPaddingï¼‰</strong>ã€‚ä¸€ä¸ªå…¸å‹çš„å¡«å……åç»“æ„çœ‹èµ·æ¥åƒï¼š<code>[å›ºå®šå‰ç¼€] + [ä¸€å †å¡«å……å­—èŠ‚] + [å“ˆå¸Œç®—æ³•æ ‡è¯†] + [åŸå§‹å“ˆå¸Œ]</code>ã€‚æœ€åï¼Œç§é’¥åŠ å¯†çš„æ˜¯è¿™ä¸ª<strong>æ•´ä½“</strong>ã€‚</p></li><li><p><strong>éªŒè¯æ—¶çš„ç¬¬ä¸€å…³</strong>ï¼šå½“ç”¨å…¬é’¥å»â€œè§£å¯†â€ç­¾åæ—¶ï¼Œå¯†ç åº“ï¼ˆå¦‚OpenSSLï¼‰çš„<strong>ç¬¬ä¸€ä»¶äº‹</strong>å°±æ˜¯æ£€æŸ¥è§£å¯†å‡ºæ¥çš„ä¸œè¥¿æ˜¯å¦ç¬¦åˆä¸Šè¿°é¢„å®šä¹‰çš„â€œä¿¡å°â€æ ¼å¼ã€‚</p></li><li><p><strong>é”™è¯¯å…¬é’¥çš„åæœ</strong>ï¼šç”±äºä½¿ç”¨çš„æ˜¯ä¸ç­¾åç§é’¥ä¸åŒ¹é…çš„å…¬é’¥ï¼Œè§£å¯†æ“ä½œä¼šå¾—åˆ°ä¸€ä¸²å®Œå…¨éšæœºã€æ¯«æ— è§„å¾‹çš„<strong>äºŒè¿›åˆ¶ä¹±ç </strong>ã€‚</p></li><li><p><strong>å¤±è´¥çš„æ ¹æº</strong>ï¼šå½“å¯†ç åº“è¯•å›¾åœ¨è¿™ä¸²ä¹±ç ä¸­å¯»æ‰¾é‚£ä¸ªä¸¥æ ¼çš„å¡«å……æ ¼å¼æ—¶ï¼Œä¼šç«‹åˆ»å‘ç°æ ¼å¼å¯¹ä¸ä¸Šã€‚å› æ­¤ï¼Œå®ƒæ ¹æœ¬ä¸ä¼šç»§ç»­å¾€åèµ°å»æå–æ‰€è°“çš„â€œåŸå§‹å“ˆå¸Œâ€è¿›è¡Œæ¯”è¾ƒã€‚æµç¨‹ä¼šç›´æ¥ä¸­æ–­ï¼Œå¹¶æŠ›å‡ºä¸€ä¸ªåº•å±‚çš„å¯†ç å­¦é”™è¯¯ï¼Œè¿™æ­£æ˜¯å®éªŒè¾“å‡ºä¸­çœ‹åˆ°çš„ï¼š</p><ul><li><code>bad signature</code> (ç­¾åæ•°æ®æœ¬èº«æ ¼å¼ä¸æ­£ç¡®)</li><li><code>padding check failed</code> (å¡«å……æ ¼å¼æ£€æŸ¥å¤±è´¥)</li></ul></li></ol><p>æ‰€ä»¥ï¼Œæ€»ç»“æ¥è¯´ï¼š<strong>éªŒè¯è¿‡ç¨‹å¹¶ä¸æ˜¯è§£å¯†å‡ºä¸€ä¸ªâ€œé”™è¯¯çš„å“ˆå¸Œå€¼â€å†å»æ¯”è¾ƒï¼Œè€Œæ˜¯åœ¨è§£å¯†åçš„ç¬¬ä¸€æ—¶é—´ï¼Œå°±å› ä¸ºæ— æ³•é€šè¿‡æœ€åŸºæœ¬çš„æ ¼å¼æ ¡éªŒè€Œæå‰å¤±è´¥ã€‚</strong> è¿™ä¸ªâ€œæ ¼å¼æ ¡éªŒâ€æ˜¯é˜²å¾¡å„ç§æ”»å‡»ï¼ˆå¦‚ä¼ªé€ ç­¾åï¼‰çš„ä¸€é“å…³é”®é˜²çº¿ã€‚</p></blockquote><h3 id="åœºæ™¯3ï¼šå…¬é’¥è¢«æ‰åŒ…ï¼ˆä¸­é—´äººæ”»å‡»ï¼‰"><a href="#åœºæ™¯3ï¼šå…¬é’¥è¢«æ‰åŒ…ï¼ˆä¸­é—´äººæ”»å‡»ï¼‰" class="headerlink" title="åœºæ™¯3ï¼šå…¬é’¥è¢«æ‰åŒ…ï¼ˆä¸­é—´äººæ”»å‡»ï¼‰"></a>åœºæ™¯3ï¼šå…¬é’¥è¢«æ‰åŒ…ï¼ˆä¸­é—´äººæ”»å‡»ï¼‰</h3><p>è¿™æ˜¯æœ€éšè”½ä¹Ÿæœ€å±é™©çš„æ”»å‡»ã€‚å‰ä¸¤ä¸ªåœºæ™¯çš„éªŒè¯éƒ½å¤±è´¥äº†ï¼Œä¿æŠ¤äº†æˆ‘ä»¬ã€‚ä½†å¦‚æœå°é»‘ä»ä¸€å¼€å§‹å°±æ¬ºéª—äº†å°çº¢ï¼Œè®©å¥¹è¯¯ä»¥ä¸ºå°é»‘çš„å…¬é’¥å°±æ˜¯å°æ˜çš„å…¬é’¥å‘¢ï¼Ÿ</p><p><strong>å‘½ä»¤ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ¢å¤åŸå§‹æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;è¿™æ˜¯ä¸€ä»½éå¸¸é‡è¦çš„åˆåŒæ–‡ä»¶ï¼Œå†…å®¹ä¸å¯ç¯¡æ”¹ã€‚&quot;</span> &gt; contract.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨åœºæ™¯2ä¸­ï¼Œæˆ‘ä»¬å·²ç»ä¸ºå°é»‘ç”Ÿæˆäº†å¯†é’¥å¯¹ (xiaohei_private_key.pem å’Œ xiaohei_public_key.pem)</span></span><br><span class="line"><span class="comment"># ç°åœ¨ï¼Œå°é»‘è¿›è¡Œæ¬ºéª—ï¼š</span></span><br><span class="line"><span class="comment"># 1. å°é»‘ç”¨è‡ªå·±çš„ç§é’¥å¯¹åŸå§‹åˆåŒè¿›è¡Œç­¾å</span></span><br><span class="line">openssl dgst -sha256 -sign xiaohei_private_key.pem -out fake_for_hong.sig contract.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. å°çº¢æ”¶åˆ°äº†ä¸‰æ ·ä¸œè¥¿ï¼š</span></span><br><span class="line"><span class="comment">#    - åŸå§‹åˆåŒ: contract.txt</span></span><br><span class="line"><span class="comment">#    - å°é»‘ä¼ªé€ çš„ç­¾å: fake_for_hong.sig</span></span><br><span class="line"><span class="comment">#    - å°é»‘çš„å…¬é’¥ï¼Œä½†æ–‡ä»¶åè¢«ä¼ªè£…æˆå°æ˜çš„: xiaohei_public_key.pem (å°çº¢ä»¥ä¸ºè¿™å°±æ˜¯ xiaoming_public_key.pem)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å°çº¢å¼€å§‹éªŒè¯ï¼Œå¥¹ä»¥ä¸ºè‡ªå·±åœ¨ç”¨å°æ˜çš„å…¬é’¥ï¼Œä½†å®é™…ä¸Šç”¨çš„æ˜¯å°é»‘çš„å…¬é’¥</span></span><br><span class="line">openssl dgst -sha256 -verify xiaohei_public_key.pem -signature fake_for_hong.sig contract.txt</span><br></pre></td></tr></table></figure><p><strong>ç»ˆç«¯è¾“å‡ºï¼š</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Verified OK</span><br></pre></td></tr></table></figure><p><strong><code>Verified OK</code><strong>ï¼</strong>éªŒè¯æˆåŠŸäº†ï¼</strong> è¿™å°±æ˜¯ä¸­é—´äººæ”»å‡»çš„å¯æ€•ä¹‹å¤„ã€‚å°çº¢çš„æ‰€æœ‰éªŒè¯æ­¥éª¤éƒ½æ˜¯å¯¹çš„ï¼Œä½†å› ä¸ºå¥¹ä¿¡ä»»çš„â€œæ ¹â€â€”â€”ä¹Ÿå°±æ˜¯å¥¹æ‰‹ä¸­çš„å…¬é’¥â€”â€”ä»ä¸€å¼€å§‹å°±æ˜¯é”™çš„ï¼Œæ•´ä¸ªä¿¡ä»»é“¾æ¡å°±å´©æºƒäº†ã€‚å¥¹ä»¥ä¸ºè‡ªå·±éªŒè¯äº†å°æ˜çš„ç­¾åï¼Œå®é™…ä¸ŠéªŒè¯çš„æ˜¯å°é»‘çš„ç­¾åã€‚</p><p>è¿™ä¸‰ä¸ªå®éªŒï¼Œç‰¹åˆ«æ˜¯æœ€åä¸€ä¸ªï¼Œå½»åº•æš´éœ²äº†å•çº¯æ•°å­—ç­¾åçš„è‡´å‘½å¼±ç‚¹ï¼šæˆ‘ä»¬æ— æ³•é€šè¿‡ç­¾åæŠ€æœ¯æœ¬èº«æ¥ä¿è¯å…¬é’¥çš„çœŸå®æ€§ã€‚<strong>å°çº¢æ— æ³•100%ç¡®å®šå¥¹æ‰‹ä¸­çš„<code>xiaoming_public_key.pem</code>å°±æ˜¯å°æ˜æœ¬äººçš„ã€‚</strong> è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ›´é«˜çº§çš„æœºåˆ¶â€”â€”æ•°å­—è¯ä¹¦â€”â€”æ¥ç™»åœºè§£å†³å…¬é’¥çš„ä¿¡ä»»é—®é¢˜ã€‚</p><hr><h2 id="å››ã€-å®éªŒä¸‰ï¼šç­¾å‘ä¸éªŒè¯æ•°å­—è¯ä¹¦"><a href="#å››ã€-å®éªŒä¸‰ï¼šç­¾å‘ä¸éªŒè¯æ•°å­—è¯ä¹¦" class="headerlink" title="å››ã€ å®éªŒä¸‰ï¼šç­¾å‘ä¸éªŒè¯æ•°å­—è¯ä¹¦"></a>å››ã€ å®éªŒä¸‰ï¼šç­¾å‘ä¸éªŒè¯æ•°å­—è¯ä¹¦</h2><p>ç°åœ¨æˆ‘ä»¬å‡çº§è§’è‰²ï¼Œæ‰®æ¼”ä¸€ä¸ª<strong>æ ¹è¯ä¹¦é¢å‘æœºæ„ï¼ˆRoot CAï¼‰</strong>ï¼Œä¸ºå°æ˜ç­¾å‘ä¸€ä»½å¯ä¿¡çš„è¯ä¹¦ã€‚</p><h3 id="æ­¥éª¤1ï¼šCAç”Ÿæˆè‡ªå·±çš„æ ¹å¯†é’¥å¯¹"><a href="#æ­¥éª¤1ï¼šCAç”Ÿæˆè‡ªå·±çš„æ ¹å¯†é’¥å¯¹" class="headerlink" title="æ­¥éª¤1ï¼šCAç”Ÿæˆè‡ªå·±çš„æ ¹å¯†é’¥å¯¹"></a>æ­¥éª¤1ï¼šCAç”Ÿæˆè‡ªå·±çš„æ ¹å¯†é’¥å¯¹</h3><p>è¿™æ˜¯ä¿¡ä»»çš„æºå¤´ã€‚</p><p><strong>å‘½ä»¤ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl genpkey -algorithm RSA -out root_ca_private_key.pem</span><br><span class="line">openssl pkey -<span class="keyword">in</span> root_ca_private_key.pem -pubout -out root_ca_public_key.pem</span><br></pre></td></tr></table></figure><h3 id="æ­¥éª¤2ï¼šCAç”Ÿæˆè‡ªç­¾åæ ¹è¯ä¹¦"><a href="#æ­¥éª¤2ï¼šCAç”Ÿæˆè‡ªç­¾åæ ¹è¯ä¹¦" class="headerlink" title="æ­¥éª¤2ï¼šCAç”Ÿæˆè‡ªç­¾åæ ¹è¯ä¹¦"></a>æ­¥éª¤2ï¼šCAç”Ÿæˆè‡ªç­¾åæ ¹è¯ä¹¦</h3><p>CAç”¨è‡ªå·±çš„ç§é’¥ç»™è‡ªå·±ç­¾åï¼Œåˆ¶ä½œä¸€å¼ â€œé¡¶çº§èº«ä»½è¯â€ã€‚è¿™å¼ è¯ä¹¦æœªæ¥å°†è¢«å†…ç½®åˆ°æ“ä½œç³»ç»Ÿå’Œæµè§ˆå™¨ä¸­ã€‚</p><p><strong>å‘½ä»¤ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -x509 -new -nodes -key root_ca_private_key.pem -sha256 -days 3650 -out root_ca.crt -subj <span class="string">&quot;/C=CN/ST=Beijing/L=Beijing/O=My Root CA/CN=my-ca.com&quot;</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæœ‰æ•ˆæœŸ10å¹´çš„æ ¹è¯ä¹¦<code>root_ca.crt</code>ã€‚</p><h3 id="æ­¥éª¤3ï¼šå°æ˜åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚-CSR"><a href="#æ­¥éª¤3ï¼šå°æ˜åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚-CSR" class="headerlink" title="æ­¥éª¤3ï¼šå°æ˜åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚(CSR)"></a>æ­¥éª¤3ï¼šå°æ˜åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚(CSR)</h3><p>å°æ˜éœ€è¦å‘CAç”³è¯·è¯ä¹¦ã€‚ä»–è¦å…ˆç”Ÿæˆè‡ªå·±çš„æ–°å¯†é’¥å¯¹ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªåŒ…å«å…¶å…¬é’¥å’Œèº«ä»½ä¿¡æ¯çš„CSRæ–‡ä»¶ã€‚</p><p><strong>å‘½ä»¤ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°æ˜ä¸ºç”³è¯·è¯ä¹¦ç”Ÿæˆæ–°çš„å¯†é’¥å¯¹</span></span><br><span class="line">openssl genpkey -algorithm RSA -out xiaoming_private_key_for_cert.pem</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°æ˜åˆ›å»ºCSR</span></span><br><span class="line">openssl req -new -key xiaoming_private_key_for_cert.pem -out xiaoming.csr -subj <span class="string">&quot;/C=CN/ST=Shanghai/O=å°æ˜çš„å…¬å¸/CN=xiaoming-site.com&quot;</span></span><br></pre></td></tr></table></figure><h3 id="æ­¥éª¤4ï¼šCAç­¾ç½²å°æ˜çš„CSRï¼Œé¢å‘è¯ä¹¦"><a href="#æ­¥éª¤4ï¼šCAç­¾ç½²å°æ˜çš„CSRï¼Œé¢å‘è¯ä¹¦" class="headerlink" title="æ­¥éª¤4ï¼šCAç­¾ç½²å°æ˜çš„CSRï¼Œé¢å‘è¯ä¹¦"></a>æ­¥éª¤4ï¼šCAç­¾ç½²å°æ˜çš„CSRï¼Œé¢å‘è¯ä¹¦</h3><p>CAæ”¶åˆ°å°æ˜çš„<code>xiaoming.csr</code>åï¼Œè¿›è¡Œå®¡æ ¸ã€‚å®¡æ ¸é€šè¿‡åï¼Œç”¨è‡ªå·±çš„æ ¹ç§é’¥å¯¹å…¶è¿›è¡Œç­¾åï¼Œæ­£å¼ç”Ÿæˆå°æ˜çš„æ•°å­—è¯ä¹¦ã€‚</p><p><strong>å‘½ä»¤ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -req -<span class="keyword">in</span> xiaoming.csr -CA root_ca.crt -CAkey root_ca_private_key.pem -CAcreateserial -out xiaoming_site.crt -days 365 -sha256</span><br></pre></td></tr></table></figure><p><strong>ç»ˆç«¯è¾“å‡ºï¼š</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Certificate request self-signature ok</span><br><span class="line">subject=C=CN, ST=Shanghai, O=å°æ˜çš„å…¬å¸, CN=xiaoming-site.com</span><br></pre></td></tr></table></figure><p>ç°åœ¨ï¼Œ<code>xiaoming_site.crt</code>å°±æ˜¯å°æ˜çš„å®˜æ–¹â€œæ•°å­—èº«ä»½è¯â€äº†ã€‚</p><h3 id="æ­¥éª¤5ï¼šéªŒè¯å°æ˜çš„è¯ä¹¦"><a href="#æ­¥éª¤5ï¼šéªŒè¯å°æ˜çš„è¯ä¹¦" class="headerlink" title="æ­¥éª¤5ï¼šéªŒè¯å°æ˜çš„è¯ä¹¦"></a>æ­¥éª¤5ï¼šéªŒè¯å°æ˜çš„è¯ä¹¦</h3><p>å°çº¢æ‹¿åˆ°äº†<code>xiaoming_site.crt</code>ã€‚å¥¹è¦ç”¨å¥¹ç”µè„‘é‡Œé¢„è£…çš„ã€ä¿¡ä»»çš„<code>root_ca.crt</code>æ¥éªŒè¯è¿™å¼ â€œèº«ä»½è¯â€çš„çœŸä¼ªã€‚</p><p><strong>å‘½ä»¤ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl verify -CAfile root_ca.crt xiaoming_site.crt</span><br></pre></td></tr></table></figure><p><strong>ç»ˆç«¯è¾“å‡ºï¼š</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xiaoming_site.crt: OK</span><br></pre></td></tr></table></figure><p>**OK!**éªŒè¯é€šè¿‡ã€‚è¿™è¡¨æ˜å°çº¢å¯ä»¥å®Œå…¨ä¿¡ä»»<code>xiaoming_site.crt</code>ä¸­çš„å…¬é’¥ç¡®å®å±äº<code>CN=xiaoming-site.com</code>ã€‚</p><h3 id="æ­¥éª¤6ï¼šæŸ¥çœ‹è¯ä¹¦å†…å®¹"><a href="#æ­¥éª¤6ï¼šæŸ¥çœ‹è¯ä¹¦å†…å®¹" class="headerlink" title="æ­¥éª¤6ï¼šæŸ¥çœ‹è¯ä¹¦å†…å®¹"></a>æ­¥éª¤6ï¼šæŸ¥çœ‹è¯ä¹¦å†…å®¹</h3><p>æˆ‘ä»¬å¯ä»¥åƒçœ‹èº«ä»½è¯ä¸€æ ·ï¼ŒæŸ¥çœ‹è¯ä¹¦é‡Œçš„è¯¦ç»†ä¿¡æ¯ã€‚</p><p><strong>å‘½ä»¤ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -<span class="keyword">in</span> xiaoming_site.crt -noout -text</span><br></pre></td></tr></table></figure><p><strong>ç»ˆç«¯è¾“å‡ºï¼š</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)</span><br><span class="line">        Serial Number:</span><br><span class="line">            60:bd:c4:46:47:ae:84:34:1e:73:ce:93:ad:fb:6b:6c:61:fb:06:fb</span><br><span class="line">        Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">        Issuer: C=CN, ST=Beijing, L=Beijing, O=My Root CA, CN=my-ca.com</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Aug  3 09:25:02 2025 GMT</span><br><span class="line">            Not After : Aug  3 09:25:02 2026 GMT</span><br><span class="line">        Subject: C=CN, ST=Shanghai, O=å°æ˜çš„å…¬å¸, CN=xiaoming-site.com</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                Public-Key: (2048 bit)</span><br><span class="line">                Modulus:</span><br><span class="line">                    00:b3:ae:be:07:7d:1e:09:34:ff:0d:b3:a2:29:e0:</span><br><span class="line">                    92:26:d7:08:a2:7e:f4:09:3a:54:72:37:75:17:10:</span><br><span class="line">                    95:e0:a6:3a:dd:e9:82:91:b8:fa:80:94:fe:40:d7:</span><br><span class="line">                    d6:bd:45:32:ad:0e:4d:a1:fe:e3:0f:c3:a7:2c:83:</span><br><span class="line">                    e3:e8:d9:60:94:ba:0f:03:1e:d0:b4:31:cc:61:b5:</span><br><span class="line">                    50:cc:e3:df:a1:3c:2d:fb:42:81:98:f4:05:74:5f:</span><br><span class="line">                    bd:5a:62:eb:08:51:69:97:56:ab:4a:68:b8:7a:5d:</span><br><span class="line">                    33:62:ab:01:ad:3b:77:65:c1:4e:15:f5:81:3f:92:</span><br><span class="line">                    ab:ce:4a:91:e0:e3:05:35:58:d7:70:a4:38:65:cc:</span><br><span class="line">                    fd:02:3f:8f:86:9b:3f:5e:07:1d:4f:a5:26:ca:16:</span><br><span class="line">                    8b:15:5a:80:08:07:77:cc:ec:77:99:e8:4a:f4:68:</span><br><span class="line">                    18:08:fb:42:d8:ae:b6:44:ea:54:1f:21:da:ba:4e:</span><br><span class="line">                    9d:bc:fe:f0:27:a7:b3:19:b6:25:a3:7b:fa:5d:53:</span><br><span class="line">                    83:f8:20:f5:19:77:51:4c:01:6b:2f:a2:3f:f3:31:</span><br><span class="line">                    1b:c9:c9:a7:7b:ec:e8:80:d3:53:b9:4b:8a:a1:3b:</span><br><span class="line">                    9d:c0:aa:3a:88:b3:02:13:00:7a:cb:ad:14:78:e4:</span><br><span class="line">                    49:30:f7:df:76:bc:ec:78:d6:40:43:34:f6:58:cd:</span><br><span class="line">                    e9:f5</span><br><span class="line">                Exponent: 65537 (0x10001)</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Subject Key Identifier: </span><br><span class="line">                82:FD:11:5E:82:6F:DF:B4:34:3D:94:C2:F5:5D:25:C4:4D:40:78:27</span><br><span class="line">            X509v3 Authority Key Identifier: </span><br><span class="line">                90:90:4C:31:B6:32:C9:D3:BF:C6:46:22:BB:15:12:EA:9F:AB:08:60</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">    Signature Value:</span><br><span class="line">        83:fe:7a:7c:ae:db:a1:29:ac:54:81:4b:05:9d:40:68:fb:c3:</span><br><span class="line">        34:2d:cc:55:1d:0a:e0:8e:6d:ed:5c:9f:d3:84:9f:b1:f6:0a:</span><br><span class="line">        41:2e:d5:c8:e4:6b:6d:59:d0:d8:c5:76:d6:43:90:00:40:01:</span><br><span class="line">        1e:0b:f6:b3:c3:e3:b4:85:c9:47:59:05:3f:56:23:45:39:ac:</span><br><span class="line">        55:7d:8d:8e:92:c7:c6:4c:e8:59:f6:0e:3f:0e:ab:53:b4:eb:</span><br><span class="line">        3d:11:3e:fb:bd:4b:e1:58:21:6d:78:88:58:36:b0:31:67:38:</span><br><span class="line">        08:66:1a:20:05:9d:7f:48:42:d9:bc:06:10:03:be:09:e5:10:</span><br><span class="line">        f2:5e:a3:2a:32:12:0f:c7:77:3b:c9:0b:a1:64:54:d9:4b:e2:</span><br><span class="line">        ca:4a:0a:39:fc:91:07:83:1c:de:f1:7a:da:36:97:3d:ff:85:</span><br><span class="line">        1b:70:ef:7a:f6:ae:c2:10:27:a1:b2:02:ae:cf:58:3c:9d:d5:</span><br><span class="line">        b7:2f:04:3b:1d:6c:94:a6:22:02:9f:04:13:14:ed:56:55:b4:</span><br><span class="line">        13:68:fb:9e:36:17:df:78:01:e0:0b:fc:1d:44:a8:15:1e:b0:</span><br><span class="line">        03:1b:d7:65:5b:be:3b:1b:6a:5c:fe:85:75:d9:4f:56:06:25:</span><br><span class="line">        5f:50:a9:23:a5:38:0b:91:a5:cc:f8:1a:93:87:c8:b3:e7:da:</span><br><span class="line">        35:5d:c5:26</span><br></pre></td></tr></table></figure><p>ä»è¾“å‡ºä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°**é¢å‘è€…(Issuer)<strong>æ˜¯æˆ‘ä»¬çš„CAï¼Œ</strong>ä¸»é¢˜(Subject)**æ˜¯å°æ˜ï¼Œä»¥åŠè¯ä¹¦ä¸­åŒ…å«çš„å°æ˜çš„å…¬é’¥ã€‚</p><h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><p>é€šè¿‡è¿™ä¸€ç³»åˆ—åŠ¨æ‰‹å®éªŒï¼Œæˆ‘ä»¬ä¸ä»…éªŒè¯äº†ç†è®ºï¼Œæ›´è·å¾—äº†ç›´è§‚çš„ä½“æ„Ÿã€‚ç°åœ¨ï¼Œå½“ä½ çœ‹åˆ°æµè§ˆå™¨åœ°å€æ é‚£æŠŠâ€œå®‰å…¨é”â€æ—¶ï¼Œä½ è„‘æµ·å°†å›æ˜¯ä¸€æ•´å¥—ç”±<code>openssl</code>å‘½ä»¤æ¨¡æ‹Ÿå‡ºçš„ã€ä¸¥è°¨çš„ã€ç¯ç¯ç›¸æ‰£çš„ç­¾åã€ç­¾å‘ä¸éªŒè¯æµç¨‹ã€‚<br>æ•°å­—ç­¾åä¸è¯ä¹¦ï¼Œä¸ä»…åº”ç”¨äºç½‘ç»œä¿¡ä»»ä½“ç³»ã€‚åœ¨è®¡ç®—æœºå…¶ä»–æ–¹æ–¹é¢é¢éƒ½æœ‰å¹¿æ³›åº”ç”¨ã€‚æˆ‘å†™æœ¬ç¯‡çš„å¥‘æœºä¹Ÿæ˜¯åœ¨ç ”ç©¶SGXã€HyperEnclaveæ—¶ï¼Œä¸ºä¹‹å‰ä¸å¤Ÿæ·±å…¥ç†è§£ç­¾åä¸è¯ä¹¦è¿›è¡Œè¡¥è¯¾ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¯†ç å­¦ </tag>
            
            <tag> æ•°å­—ç­¾å </tag>
            
            <tag> æ•°å­—è¯ä¹¦ </tag>
            
            <tag> CA </tag>
            
            <tag> OpenSSL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ•°å­—ç­¾åä¸æ•°å­—è¯ä¹¦æ·±åº¦è§£æ</title>
      <link href="/2025/08/02/%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D%E4%B8%8E%E6%95%B0%E5%AD%97%E8%AF%81%E4%B9%A6%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/"/>
      <url>/2025/08/02/%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D%E4%B8%8E%E6%95%B0%E5%AD%97%E8%AF%81%E4%B9%A6%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h2 id="å¼•è¨€ï¼šç½‘ç»œä¸–ç•Œçš„â€œä¿¡ä»»â€éš¾é¢˜"><a href="#å¼•è¨€ï¼šç½‘ç»œä¸–ç•Œçš„â€œä¿¡ä»»â€éš¾é¢˜" class="headerlink" title="å¼•è¨€ï¼šç½‘ç»œä¸–ç•Œçš„â€œä¿¡ä»»â€éš¾é¢˜"></a>å¼•è¨€ï¼šç½‘ç»œä¸–ç•Œçš„â€œä¿¡ä»»â€éš¾é¢˜</h2><p>åœ¨ç°å®ä¸–ç•Œä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ç­¾åã€å°ç« ã€èº«ä»½è¯å’Œæƒå¨æœºæ„ï¼ˆå¦‚å…¬å®‰å±€ã€é“¶è¡Œï¼‰æ¥ç¡®è®¤ä¸€ä¸ªäººçš„èº«ä»½å’Œä¸€ä»½æ–‡ä»¶çš„çœŸå®æ€§ã€‚ä½†åœ¨åŒ¿åçš„ã€æ•°å­—åŒ–çš„ç½‘ç»œä¸–ç•Œé‡Œï¼Œæˆ‘ä»¬å¦‚ä½•è§£å†³è¿™äº›æ ¹æœ¬æ€§çš„ä¿¡ä»»é—®é¢˜ï¼Ÿ</p><ol><li>**èº«ä»½è®¤è¯ (Authentication)**ï¼šæˆ‘å¦‚ä½•ç¡®å®šæ­£åœ¨ä¸æˆ‘é€šä¿¡çš„ï¼Œç¡®å®æ˜¯æˆ‘è®¤ä¸ºçš„é‚£ä¸ªäººï¼ˆæˆ–æœåŠ¡å™¨ï¼‰ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå†’åé¡¶æ›¿è€…ï¼Ÿ</li><li>**æ•°æ®å®Œæ•´æ€§ (Integrity)**ï¼šæˆ‘å¦‚ä½•ç¡®ä¿æ”¶åˆ°çš„ä¿¡æ¯åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æ²¡æœ‰è¢«ç¯¡æ”¹ï¼Ÿ</li><li>**ä¸å¯å¦è®¤æ€§ (Non-repudiation)**ï¼šå¦‚ä½•é˜²æ­¢å‘é€æ–¹äº‹åå¦è®¤ä»–ä»¬æ›¾ç»å‘é€è¿‡æŸæ¡ä¿¡æ¯ï¼Ÿ</li></ol><p>æ•°å­—ç­¾åå’Œæ•°å­—è¯ä¹¦ï¼Œå°±æ˜¯å¯†ç å­¦ä¸ºè§£å†³è¿™ä¸‰å¤§éš¾é¢˜æä¾›çš„åŸºçŸ³æ€§æŠ€æœ¯ã€‚</p><blockquote><p>çœ‹æœ¬ç¯‡ä¹‹å‰ä¹Ÿå¯ä»¥å…ˆçœ‹ä¸‹æˆ‘ä¹‹å‰çš„è¿™å‡ ç¯‡æ–‡æ¡£ï¼š</p><p>ã€Šæ·±å…¥å“ˆå¸Œå‡½æ•°ï¼šSHA-256çš„æ•°å­¦ä¹‹æ—…ã€‹ï¼š<a href="https://kongxiaoran.github.io/2025/06/18/%E6%B7%B1%E5%85%A5%E5%93%88%E5%B8%8C%E5%87%BD%E6%95%B0%EF%BC%9ASHA-256%E7%9A%84%E6%95%B0%E5%AD%A6%E4%B9%8B%E6%97%85/">https://kongxiaoran.github.io/2025/06/18/%E6%B7%B1%E5%85%A5%E5%93%88%E5%B8%8C%E5%87%BD%E6%95%B0%EF%BC%9ASHA-256%E7%9A%84%E6%95%B0%E5%AD%A6%E4%B9%8B%E6%97%85/</a></p><p>ã€Šæ·±å…¥ç†è§£RSAï¼šåŠ å¯†ä¸ç­¾åçš„è‰ºæœ¯ã€‹ï¼š<a href="https://kongxiaoran.github.io/2025/07/24/RSA_Explained/">https://kongxiaoran.github.io/2025/07/24/RSA_Explained/</a></p></blockquote><hr><h2 id="ä¸€ã€-æ•°å­—ç­¾åï¼šå¦‚ä½•è¯æ˜â€œæ˜¯æˆ‘ï¼Œä¸”ä»…æ˜¯æˆ‘â€"><a href="#ä¸€ã€-æ•°å­—ç­¾åï¼šå¦‚ä½•è¯æ˜â€œæ˜¯æˆ‘ï¼Œä¸”ä»…æ˜¯æˆ‘â€" class="headerlink" title="ä¸€ã€ æ•°å­—ç­¾åï¼šå¦‚ä½•è¯æ˜â€œæ˜¯æˆ‘ï¼Œä¸”ä»…æ˜¯æˆ‘â€"></a>ä¸€ã€ æ•°å­—ç­¾åï¼šå¦‚ä½•è¯æ˜â€œæ˜¯æˆ‘ï¼Œä¸”ä»…æ˜¯æˆ‘â€</h2><p>æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç»å…¸çš„æ•…äº‹æ¥ç†è§£æ•°å­—ç­¾åçš„è¯ç”Ÿã€‚</p><p><strong>åœºæ™¯</strong>ï¼šå°æ˜æƒ³ç»™å°çº¢å‘é€ä¸€ä»½é‡è¦çš„åˆåŒæ–‡ä»¶ã€‚</p><h3 id="1-ç­¾åä¹‹å‰çš„å‡†å¤‡ï¼šéå¯¹ç§°å¯†é’¥"><a href="#1-ç­¾åä¹‹å‰çš„å‡†å¤‡ï¼šéå¯¹ç§°å¯†é’¥" class="headerlink" title="1. ç­¾åä¹‹å‰çš„å‡†å¤‡ï¼šéå¯¹ç§°å¯†é’¥"></a>1. ç­¾åä¹‹å‰çš„å‡†å¤‡ï¼šéå¯¹ç§°å¯†é’¥</h3><p>é¦–å…ˆï¼Œå°æ˜æ‹¥æœ‰ä¸€ä¸ª**å¯†é’¥å¯¹ (Key Pair)**ï¼Œè¿™æ˜¯éå¯¹ç§°åŠ å¯†çš„åŸºç¡€ï¼š</p><ul><li>**ç§é’¥ (Private Key)**ï¼šç”±å°æ˜è‡ªå·±ç»å¯¹ç§å¯†åœ°ä¿ç®¡ï¼Œç»ä¸å¤–æ³„ã€‚å®ƒæ˜¯å°æ˜çš„â€œä¸ªäººå°ç« â€ã€‚</li><li>**å…¬é’¥ (Public Key)**ï¼šå°æ˜å¯ä»¥éšæ„åœ°ã€å…¬å¼€åœ°åˆ†å‘ç»™ä»»ä½•äººï¼ŒåŒ…æ‹¬å°çº¢ã€‚å®ƒæ˜¯ç”¨æ¥éªŒè¯â€œä¸ªäººå°ç« â€çš„â€œéªŒç« å·¥å…·â€ã€‚</li></ul><h3 id="2-ç­¾åçš„è¿‡ç¨‹ï¼šå…ˆæ‘˜è¦ï¼ŒååŠ å¯†"><a href="#2-ç­¾åçš„è¿‡ç¨‹ï¼šå…ˆæ‘˜è¦ï¼ŒååŠ å¯†" class="headerlink" title="2. ç­¾åçš„è¿‡ç¨‹ï¼šå…ˆæ‘˜è¦ï¼ŒååŠ å¯†"></a>2. ç­¾åçš„è¿‡ç¨‹ï¼šå…ˆæ‘˜è¦ï¼ŒååŠ å¯†</h3><p>å°æ˜å‘é€åˆåŒå‰ï¼Œä¼šæ‰§è¡Œä»¥ä¸‹ä¸¤ä¸ªæ­¥éª¤æ¥â€œç­¾åâ€è¿™ä»½æ–‡ä»¶ï¼š</p><ol><li><p><strong>ç”Ÿæˆæ‘˜è¦ (Hashing)<strong>ï¼šå°æ˜ä½¿ç”¨ä¸€ä¸ª</strong>å“ˆå¸Œå‡½æ•°</strong>ï¼ˆå¦‚SHA-256ï¼‰å¯¹æ•´ä¸ªåˆåŒæ–‡ä»¶è¿›è¡Œè®¡ç®—ï¼Œç”Ÿæˆä¸€ä¸ªå›ºå®šé•¿åº¦çš„ã€ç‹¬ä¸€æ— äºŒçš„â€œæ•°å­—æŒ‡çº¹â€ï¼ˆæ‘˜è¦ï¼ŒDigestï¼‰ã€‚</p><blockquote><p><strong>å“ˆå¸Œç‰¹æ€§</strong>ï¼š</p><ul><li><strong>å”¯ä¸€æ€§</strong>ï¼šä»»ä½•å¯¹æ–‡ä»¶çš„å¾®å°æ”¹åŠ¨ï¼Œéƒ½ä¼šå¯¼è‡´æ‘˜è¦å‘ç”Ÿå·¨å¤§å˜åŒ–ã€‚</li><li><strong>å•å‘æ€§</strong>ï¼šæ— æ³•ä»æ‘˜è¦åå‘æ¨å¯¼å‡ºåŸæ–‡ã€‚</li></ul></blockquote></li><li><p><strong>åŠ å¯†æ‘˜è¦ (Encryption)<strong>ï¼šå°æ˜ç”¨ä»–çš„</strong>ç§é’¥</strong>ï¼Œå¯¹è¿™ä¸ªâ€œæ•°å­—æŒ‡çº¹â€è¿›è¡ŒåŠ å¯†ã€‚è¿™ä¸ªåŠ å¯†åçš„ç»“æœï¼Œå°±æ˜¯**æ•°å­—ç­¾å (Digital Signature)**ã€‚</p></li></ol><p>æœ€åï¼Œå°æ˜å°†<strong>åŸå§‹çš„åˆåŒæ–‡ä»¶</strong>å’Œè¿™ä¸ª<strong>æ•°å­—ç­¾å</strong>ä¸€èµ·æ‰“åŒ…å‘é€ç»™å°çº¢ã€‚</p><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD;    subgraph &quot;å°æ˜ (å‘é€æ–¹)&quot;        A[&quot;åˆåŒåŸæ–‡&quot;] -- &quot;1. å“ˆå¸Œè®¡ç®—&quot; --&gt; B[&quot;æ‘˜è¦ (æ•°å­—æŒ‡ç´‹)&quot;;        B -- &quot;2. ä½¿ç”¨å°æ˜çš„ç§é’¥åŠ å¯†&quot; --&gt; C[&quot;æ•°å­—ç­¾å&quot;];    end    subgraph &quot;ç½‘ç»œä¼ è¾“&quot;        P[(&quot;ä¼ è¾“å†…å®¹&lt;br&gt;åˆåŒåŸæ–‡ + æ•°å­—ç­¾å&quot;)]    end        A --&gt; P;    C --&gt; P;        style A fill:#e6f7ff,stroke:#0050b3    style C fill:#d4edda,stroke:#155724  </pre></div><p><em>å›¾1ï¼šæ•°å­—ç­¾åçš„ç”Ÿæˆè¿‡ç¨‹</em></p><h3 id="3-éªŒè¯ç­¾åçš„è¿‡ç¨‹ï¼šå…ˆè§£å¯†ï¼Œåæ¯”å¯¹"><a href="#3-éªŒè¯ç­¾åçš„è¿‡ç¨‹ï¼šå…ˆè§£å¯†ï¼Œåæ¯”å¯¹" class="headerlink" title="3. éªŒè¯ç­¾åçš„è¿‡ç¨‹ï¼šå…ˆè§£å¯†ï¼Œåæ¯”å¯¹"></a>3. éªŒè¯ç­¾åçš„è¿‡ç¨‹ï¼šå…ˆè§£å¯†ï¼Œåæ¯”å¯¹</h3><p>å°çº¢æ”¶åˆ°æ–‡ä»¶åï¼Œéœ€è¦éªŒè¯è¿™ä»½åˆåŒçš„çœŸä¼ªã€‚å¥¹ä¼šæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š</p><ol><li><p><strong>è§£å¯†ç­¾å</strong>ï¼šå°çº¢ç”¨å¥¹æ‰‹ä¸­<strong>å°æ˜çš„å…¬é’¥</strong>ï¼Œå¯¹æ”¶åˆ°çš„<strong>æ•°å­—ç­¾å</strong>è¿›è¡Œè§£å¯†ï¼Œè¿˜åŸå‡ºåŸå§‹çš„â€œæ•°å­—æŒ‡ç´‹Aâ€ã€‚</p><ul><li><strong>è¿™ä¸€æ­¥èƒ½æˆåŠŸï¼Œæœ¬èº«å°±è¯æ˜äº†</strong>ï¼šè¿™ä¸ªç­¾åä¸€å®šæ˜¯ç”±å°æ˜çš„ç§é’¥åŠ å¯†çš„ï¼Œå› ä¸ºåªæœ‰é…å¯¹çš„å…¬é’¥æ‰èƒ½è§£å¼€ã€‚è¿™å°±è§£å†³äº†<strong>èº«ä»½è®¤è¯</strong>å’Œ<strong>ä¸å¯å¦è®¤æ€§</strong>çš„é—®é¢˜â€”â€”é™¤äº†å°æ˜ï¼Œæ²¡äººèƒ½ç”Ÿæˆè¿™ä¸ªç­¾åã€‚</li></ul></li><li><p><strong>ç‹¬ç«‹è®¡ç®—æ‘˜è¦</strong>ï¼šå°çº¢å¯¹å¥¹æ”¶åˆ°çš„<strong>åˆåŒæ–‡ä»¶åŸæ–‡</strong>ï¼Œä½¿ç”¨<strong>ä¸å°æ˜å®Œå…¨ç›¸åŒçš„å“ˆå¸Œå‡½æ•°</strong>è¿›è¡Œè®¡ç®—ï¼Œå¾—åˆ°å¦ä¸€ä¸ªâ€œæ•°å­—æŒ‡ç´‹Bâ€ã€‚</p></li><li><p><strong>æœ€ç»ˆæ¯”å¯¹</strong>ï¼šå°çº¢æ¯”å¯¹â€œæ•°å­—æŒ‡ç´‹Aâ€å’Œâ€œæ•°å­—æŒ‡ç´‹Bâ€ã€‚</p><ul><li><strong>å¦‚æœä¸¤è€…å®Œå…¨ä¸€è‡´</strong>ï¼šè¿™è¯æ˜äº†åˆåŒæ–‡ä»¶åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ªæ¯”ç‰¹éƒ½æ²¡æœ‰è¢«ä¿®æ”¹è¿‡ã€‚è¿™å°±è§£å†³äº†<strong>æ•°æ®å®Œæ•´æ€§</strong>çš„é—®é¢˜ã€‚</li><li><strong>å¦‚æœä¸¤è€…ä¸ä¸€è‡´</strong>ï¼šè¯´æ˜æ–‡ä»¶å·²è¢«ç¯¡æ”¹ï¼Œæˆ–è€…ç­¾åæ˜¯ä¼ªé€ çš„ã€‚</li></ul></li></ol><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD;    subgraph &quot;å°çº¢ (æ¥æ”¶æ–¹)&quot;        P[&quot;åˆåŒåŸæ–‡ + æ•°å­—ç­¾å&quot;] --&gt; R1[&quot;åˆåŒåŸæ–‡&quot;];        P --&gt; S1[&quot;æ•°å­—ç­¾å&quot;];        S1 -- &quot;1. ä½¿ç”¨å°æ˜çš„å…¬é’¥è§£å¯†&quot; --&gt; DA[&quot;æ‘˜è¦A&quot;];        R1 -- &quot;2. ç‹¬ç«‹å“ˆå¸Œè®¡ç®—&quot; --&gt; DB[&quot;æ‘˜è¦B&quot;];            DA -- &quot;3. æ¯”å¯¹æ˜¯å¦ä¸€è‡´&quot; --&gt; V{éªŒè¯ç»“æœ};        DB -- &quot;3. æ¯”å¯¹æ˜¯å¦ä¸€è‡´&quot; --&gt; V;    end        style V fill:#fffbe6,stroke:#d46b08  </pre></div><p><em>å›¾2ï¼šæ•°å­—ç­¾åçš„éªŒè¯è¿‡ç¨‹</em></p><hr><h2 id="äºŒã€-æ•°å­—è¯ä¹¦ï¼šå¦‚ä½•ä¿è¯æˆ‘çš„å…¬é’¥æ˜¯çœŸçš„ï¼Ÿ"><a href="#äºŒã€-æ•°å­—è¯ä¹¦ï¼šå¦‚ä½•ä¿è¯æˆ‘çš„å…¬é’¥æ˜¯çœŸçš„ï¼Ÿ" class="headerlink" title="äºŒã€ æ•°å­—è¯ä¹¦ï¼šå¦‚ä½•ä¿è¯æˆ‘çš„å…¬é’¥æ˜¯çœŸçš„ï¼Ÿ"></a>äºŒã€ æ•°å­—è¯ä¹¦ï¼šå¦‚ä½•ä¿è¯æˆ‘çš„å…¬é’¥æ˜¯çœŸçš„ï¼Ÿ</h2><p>æ•°å­—ç­¾åä¼¼ä¹å®Œç¾åœ°è§£å†³äº†é—®é¢˜ï¼Œä½†å®ƒä¾èµ–äºä¸€ä¸ªå…³é”®å‰æï¼š<strong>å°çº¢å¦‚ä½•ç¡®ä¿¡å¥¹æ‰‹ä¸­çš„â€œå°æ˜çš„å…¬é’¥â€çœŸçš„æ˜¯å°æ˜çš„ï¼Œè€Œä¸æ˜¯æ¥è‡ªä¸€ä¸ªå†’å……è€…ï¼Ÿ</strong></p><p><strong>æ–°çš„å±æœº</strong>ï¼šä¸€ä¸ªå«å°é»‘çš„æ”»å‡»è€…ï¼Œå¯ä»¥æˆªè·å°æ˜å‘ç»™å°çº¢çš„å…¬é’¥ï¼Œç„¶åå°†è‡ªå·±çš„å…¬é’¥ä¼ªè£…æˆå°æ˜çš„äº¤ç»™å°çº¢ã€‚ä¹‹åï¼Œå°é»‘å°±å¯ä»¥ç”¨è‡ªå·±çš„ç§keyå†’å……å°æ˜ç»™å°çº¢ç­¾åå‘ä¿¡ï¼Œå°çº¢ç”¨å‡çš„â€œå°æ˜çš„å…¬é’¥â€éªŒè¯åè¿˜ä¼šä¿¡ä»¥ä¸ºçœŸã€‚è¿™å°±æ˜¯â€œä¸­é—´äººæ”»å‡»â€ã€‚</p><p>ä¸ºäº†è§£å†³å…¬é’¥çš„å¯ä¿¡åº¦é—®é¢˜ï¼Œ<strong>æ•°å­—è¯ä¹¦ (Digital Certificate)</strong> å’Œ <strong>è¯ä¹¦é¢å‘æœºæ„ (Certificate Authority, CA)</strong> åº”è¿è€Œç”Ÿã€‚</p><h3 id="1-è¯ä¹¦çš„è¯ç”Ÿï¼šæƒå¨æœºæ„çš„â€œç›–ç« è®¤è¯â€"><a href="#1-è¯ä¹¦çš„è¯ç”Ÿï¼šæƒå¨æœºæ„çš„â€œç›–ç« è®¤è¯â€" class="headerlink" title="1. è¯ä¹¦çš„è¯ç”Ÿï¼šæƒå¨æœºæ„çš„â€œç›–ç« è®¤è¯â€"></a>1. è¯ä¹¦çš„è¯ç”Ÿï¼šæƒå¨æœºæ„çš„â€œç›–ç« è®¤è¯â€</h3><p>æ•°å­—è¯ä¹¦å°±åƒä¸€ä¸ªâ€œæ•°å­—èº«ä»½è¯â€ï¼Œå®ƒçš„æ ¸å¿ƒä½œç”¨å°±æ˜¯<strong>å°†ä¸€ä¸ªå…¬é’¥ä¸ä¸€ä¸ªå®ä½“ï¼ˆä¸ªäººã€ç½‘ç«™ç­‰ï¼‰çš„èº«ä»½ä¿¡æ¯ç»‘å®šåœ¨ä¸€èµ·ï¼Œå¹¶ç”±ä¸€ä¸ªå—ä¿¡ä»»çš„ç¬¬ä¸‰æ–¹ï¼ˆCAï¼‰å¯¹æ­¤è¿›è¡Œâ€œèƒŒä¹¦â€</strong>ã€‚</p><p><strong>ç”Ÿæˆè¿‡ç¨‹</strong>ï¼š</p><ol><li><strong>ç”³è¯·</strong>: å°æ˜ç”Ÿæˆè‡ªå·±çš„å¯†é’¥å¯¹åï¼Œå°†ä»–çš„<strong>å…¬é’¥</strong>ã€èº«ä»½ä¿¡æ¯ï¼ˆå¦‚å§“åã€é‚®ç®±ã€å…¬å¸ç­‰ï¼‰æäº¤ç»™ä¸€ä¸ªæƒå¨çš„CAæœºæ„ã€‚</li><li><strong>å®¡æ ¸</strong>: CAæœºæ„ä¼šé€šè¿‡å„ç§æ–¹å¼ï¼ˆçº¿ä¸Šæˆ–çº¿ä¸‹ï¼‰ä¸¥æ ¼å®¡æ ¸å°æ˜èº«ä»½çš„çœŸå®æ€§ã€‚</li><li><strong>ç­¾å‘</strong>: å®¡æ ¸é€šè¿‡åï¼ŒCAä¼šåšä¸¤ä»¶äº‹ï¼š<ul><li>å°†å°æ˜çš„å…¬é’¥å’Œèº«ä»½ä¿¡æ¯ç­‰æ‰“åŒ…æˆä¸€ä¸ªâ€œè¯ä¹¦è¯¦æƒ…â€æ–‡ä»¶ã€‚</li><li>ç”¨<strong>CAè‡ªå·±çš„ç§é’¥</strong>ï¼Œå¯¹è¿™ä¸ªâ€œè¯ä¹¦è¯¦æƒ…â€è¿›è¡Œç­¾åã€‚</li></ul></li></ol><p>è¿™ä¸ª<strong>è¢«CAç­¾åè¿‡çš„â€œè¯ä¹¦è¯¦æƒ…â€</strong>ï¼Œå°±æ˜¯æœ€ç»ˆçš„<strong>æ•°å­—è¯ä¹¦</strong>ã€‚</p><h3 id="2-è¯ä¹¦çš„ç»“æ„ï¼šä¸€å¼ æ ‡å‡†çš„â€œæ•°å­—èº«ä»½è¯â€"><a href="#2-è¯ä¹¦çš„ç»“æ„ï¼šä¸€å¼ æ ‡å‡†çš„â€œæ•°å­—èº«ä»½è¯â€" class="headerlink" title="2. è¯ä¹¦çš„ç»“æ„ï¼šä¸€å¼ æ ‡å‡†çš„â€œæ•°å­—èº«ä»½è¯â€"></a>2. è¯ä¹¦çš„ç»“æ„ï¼šä¸€å¼ æ ‡å‡†çš„â€œæ•°å­—èº«ä»½è¯â€</h3><p>ä¸€ä¸ªæ ‡å‡†çš„X.509æ•°å­—è¯ä¹¦ï¼ŒåŒ…å«ä»¥ä¸‹å…³é”®ä¿¡æ¯ï¼š</p><ul><li><strong>ä¸»é¢˜ (Subject)</strong>: è¯ä¹¦æŒæœ‰è€…çš„ä¿¡æ¯ï¼ˆå¦‚åŸŸåã€ä¸ªäººåã€å…¬å¸åï¼‰ã€‚</li><li><strong>é¢å‘è€… (Issuer)</strong>: ç­¾å‘æ­¤è¯ä¹¦çš„CAæœºæ„çš„åç§°ã€‚</li><li><strong>æœ‰æ•ˆæœŸ (Validity)</strong>: è¯ä¹¦çš„ç”Ÿæ•ˆå’Œè¿‡æœŸæ—¥æœŸã€‚</li><li><strong>ä¸»é¢˜çš„å…¬é’¥ (Subjectâ€™s Public Key)</strong>: <strong>è¿™æ˜¯è¯ä¹¦æœ€æ ¸å¿ƒçš„å†…å®¹</strong>ï¼Œå³è¢«è®¤è¯çš„é‚£ä¸ªå…¬é’¥ã€‚</li><li><strong>CAçš„æ•°å­—ç­¾å (CAâ€™s Digital Signature)</strong>: CAç”¨å…¶ç§é’¥å¯¹æ•´ä¸ªè¯ä¹¦å†…å®¹ï¼ˆé™¤ç­¾åæœ¬èº«ï¼‰çš„ç­¾åã€‚</li><li><strong>å…¶ä»–ä¿¡æ¯</strong>: å¦‚ç‰ˆæœ¬å·ã€åºåˆ—å·ã€ç­¾åç®—æ³•ç­‰ã€‚</li></ul><h3 id="3-è¯ä¹¦å¦‚ä½•ä¿è¯å®‰å…¨ï¼Ÿ"><a href="#3-è¯ä¹¦å¦‚ä½•ä¿è¯å®‰å…¨ï¼Ÿ" class="headerlink" title="3. è¯ä¹¦å¦‚ä½•ä¿è¯å®‰å…¨ï¼Ÿ"></a>3. è¯ä¹¦å¦‚ä½•ä¿è¯å®‰å…¨ï¼Ÿ</h3><p>ç°åœ¨ï¼Œå½“å°æ˜æƒ³ç»™å°çº¢å‘é€å…¬é’¥æ—¶ï¼Œä»–ä¸å†ç›´æ¥å‘é€å…¬é’¥æ–‡ä»¶ï¼Œè€Œæ˜¯å‘é€ä»–çš„<strong>æ•°å­—è¯ä¹¦</strong>ã€‚</p><p>å°çº¢æ”¶åˆ°åï¼ŒéªŒè¯æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li><strong>è·å–CAçš„å…¬é’¥</strong>: å°çº¢çš„æ“ä½œç³»ç»Ÿæˆ–æµè§ˆå™¨é€šå¸¸å·²ç»é¢„è£…äº†å…¨çƒå…¬è®¤çš„ã€é¡¶çº§çš„CAæœºæ„çš„å…¬é’¥ï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œæ ¹è¯ä¹¦â€ï¼‰ã€‚å¥¹å¯ä»¥ç›´æ¥ä»æœ¬åœ°ä¿¡ä»»åº“ä¸­æ‰¾åˆ°ç­¾å‘å°æ˜è¯ä¹¦çš„é‚£ä¸ªCAçš„å…¬é’¥ã€‚</li><li><strong>éªŒè¯è¯ä¹¦ç­¾å</strong>: å°çº¢ç”¨CAçš„å…¬é’¥ï¼Œå»è§£å¯†å°æ˜è¯ä¹¦ä¸Šçš„â€œCAæ•°å­—ç­¾åâ€ï¼Œå¹¶æŒ‰ç…§ç­¾åéªŒè¯çš„æµç¨‹ï¼Œç¡®è®¤è¯ä¹¦æœ¬èº«æ²¡æœ‰è¢«ç¯¡æ”¹ï¼Œä¸”ç¡®å®æ˜¯ç”±è¯¥CAç­¾å‘çš„ã€‚</li><li><strong>è·å–å°æ˜çš„çœŸå®å…¬é’¥</strong>: éªŒè¯æˆåŠŸåï¼Œå°çº¢å°±å¯ä»¥100%ä¿¡ä»»è¯ä¹¦ä¸­çš„å†…å®¹ã€‚å¥¹ä»è¯ä¹¦é‡Œå®‰å…¨åœ°æå–å‡º<strong>å°æ˜çš„å…¬é’¥</strong>ã€‚</li><li><strong>éªŒè¯å°æ˜çš„æ¶ˆæ¯</strong>: ä¹‹åï¼Œå°çº¢å°±å¯ä»¥ç”¨è¿™ä¸ªå¯ä¿¡çš„å…¬é’¥ï¼Œå»éªŒè¯å°æ˜åç»­å‘æ¥çš„ã€ç”¨ä»–è‡ªå·±ç§é’¥ç­¾åçš„æ¶ˆæ¯äº†ã€‚</li></ol><p>è‡³æ­¤ï¼Œé€šè¿‡å¼•å…¥ä¸€ä¸ªå¤§å®¶éƒ½ä¿¡ä»»çš„ç¬¬ä¸‰æ–¹ï¼ˆCAï¼‰ï¼Œå…¬é’¥çš„åˆ†å‘å’Œä¿¡ä»»é—®é¢˜å¾—åˆ°äº†è§£å†³ã€‚</p><hr><h2 id="ä¸‰ã€-è¯ä¹¦é“¾ï¼šæ„å»ºå±‚çº§åŒ–çš„ä¿¡ä»»ä½“ç³»"><a href="#ä¸‰ã€-è¯ä¹¦é“¾ï¼šæ„å»ºå±‚çº§åŒ–çš„ä¿¡ä»»ä½“ç³»" class="headerlink" title="ä¸‰ã€ è¯ä¹¦é“¾ï¼šæ„å»ºå±‚çº§åŒ–çš„ä¿¡ä»»ä½“ç³»"></a>ä¸‰ã€ è¯ä¹¦é“¾ï¼šæ„å»ºå±‚çº§åŒ–çš„ä¿¡ä»»ä½“ç³»</h2><p>ä¸€ä¸ªè‡ªç„¶çš„ç–‘é—®æ˜¯ï¼šéš¾é“æ‰€æœ‰è¯ä¹¦éƒ½ç”±é‚£å‡ å®¶é¡¶çº§CAç›´æ¥ç­¾å‘å—ï¼Ÿå¦‚æœé‚£æ ·ï¼ŒCAå°†ä¸å ªé‡è´Ÿã€‚</p><p>ç°å®ä¸–ç•Œé‡‡ç”¨äº†ä¸€ç§æ›´çµæ´»ã€æ›´å®‰å…¨çš„å±‚çº§åŒ–ç®¡ç†æ¨¡å¼ï¼Œè¿™å°±æ˜¯**è¯ä¹¦é“¾ (Certificate Chain) æˆ–ä¿¡ä»»é“¾ (Chain of Trust)**ã€‚</p><h3 id="1-ä¿¡ä»»çš„æºå¤´ï¼šæ ¹è¯ä¹¦-Root-Certificate"><a href="#1-ä¿¡ä»»çš„æºå¤´ï¼šæ ¹è¯ä¹¦-Root-Certificate" class="headerlink" title="1. ä¿¡ä»»çš„æºå¤´ï¼šæ ¹è¯ä¹¦ (Root Certificate)"></a>1. ä¿¡ä»»çš„æºå¤´ï¼šæ ¹è¯ä¹¦ (Root Certificate)</h3><ul><li><strong>èº«ä»½</strong>: ä½äºä¿¡ä»»é“¾çš„æœ€é¡¶ç«¯ï¼Œç”±æ ¹CA (Root CA)è‡ªå·±ç»™è‡ªå·±ç­¾å‘ï¼ˆè‡ªç­¾åè¯ä¹¦ï¼‰ã€‚</li><li><strong>ä¿¡ä»»æ¥æº</strong>: <strong>æ ¹è¯ä¹¦çš„ä¿¡ä»»ä¸æ˜¯é€šè¿‡å¯†ç å­¦è¯æ˜çš„ï¼Œè€Œæ˜¯é€šè¿‡â€œç¤¾ä¼šå¥‘çº¦â€å»ºç«‹çš„</strong>ã€‚å®ƒä»¬è¢«æ“ä½œç³»ç»Ÿï¼ˆå¦‚Windows, macOSï¼‰å’Œæµè§ˆå™¨ï¼ˆå¦‚Chrome, Firefoxï¼‰çš„å¼€å‘å•†é¢„å…ˆå†…ç½®åœ¨å®ƒä»¬çš„â€œå—ä¿¡ä»»çš„æ ¹è¯ä¹¦é¢å‘æœºæ„â€åˆ—è¡¨ä¸­ã€‚ä½ çš„è®¾å¤‡æ— æ¡ä»¶åœ°ä¿¡ä»»è¿™äº›æ ¹è¯ä¹¦ã€‚</li></ul><h3 id="2-ä¿¡ä»»çš„ä¼ é€’ï¼šä¸­é—´è¯ä¹¦-Intermediate-Certificate"><a href="#2-ä¿¡ä»»çš„ä¼ é€’ï¼šä¸­é—´è¯ä¹¦-Intermediate-Certificate" class="headerlink" title="2. ä¿¡ä»»çš„ä¼ é€’ï¼šä¸­é—´è¯ä¹¦ (Intermediate Certificate)"></a>2. ä¿¡ä»»çš„ä¼ é€’ï¼šä¸­é—´è¯ä¹¦ (Intermediate Certificate)</h3><ul><li><strong>èº«ä»½</strong>: ç”±æ ¹CAç­¾å‘çš„è¯ä¹¦ã€‚æŒæœ‰è¿™äº›è¯ä¹¦çš„æœºæ„è¢«ç§°ä¸º**ä¸­é—´CA (Intermediate CA)**ã€‚</li><li><strong>èŒè´£</strong>: æ ¹CAé€šå¸¸ä¸ç›´æ¥ç­¾å‘æœ€ç»ˆç”¨æˆ·çš„è¯ä¹¦ï¼Œè€Œæ˜¯æˆæƒç»™ä¸€ä¸ªæˆ–å¤šä¸ªä¸­é—´CAã€‚ä¸­é—´CAå¯ä»¥å†æˆæƒç»™ä¸‹ä¸€çº§ä¸­é—´CAï¼Œå½¢æˆä¸€ä¸ªæ ‘çŠ¶ç»“æ„ã€‚</li><li><strong>å®‰å…¨è€ƒé‡</strong>: è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œå¯ä»¥å°†é£é™©æé«˜çš„æ ¹CAç§é’¥è¿›è¡Œç¦»çº¿å†·å­˜å‚¨ï¼Œæ—¥å¸¸çš„è¯ä¹¦ç­¾å‘å·¥ä½œç”±ä¸­é—´CAæ¥å®Œæˆï¼Œå³ä½¿ä¸­é—´CAçš„ç§é’¥æ³„éœ²ï¼Œä¹Ÿåªéœ€åŠé”€å…¶è¯ä¹¦ï¼Œä¸ä¼šåŠ¨æ‘‡æ•´ä¸ªä¿¡ä»»ä½“ç³»çš„æ ¹åŸºã€‚</li></ul><h3 id="3-ä¿¡ä»»çš„æœ«ç«¯ï¼šæœ€ç»ˆå®ä½“è¯ä¹¦-End-entity-Certificate"><a href="#3-ä¿¡ä»»çš„æœ«ç«¯ï¼šæœ€ç»ˆå®ä½“è¯ä¹¦-End-entity-Certificate" class="headerlink" title="3. ä¿¡ä»»çš„æœ«ç«¯ï¼šæœ€ç»ˆå®ä½“è¯ä¹¦ (End-entity Certificate)"></a>3. ä¿¡ä»»çš„æœ«ç«¯ï¼šæœ€ç»ˆå®ä½“è¯ä¹¦ (End-entity Certificate)</h3><ul><li><strong>èº«ä»½</strong>: å°±æ˜¯æˆ‘ä»¬å¹³æ—¶è®¿é—®ç½‘ç«™æ—¶ï¼Œæµè§ˆå™¨ä¸‹è½½çš„é‚£ä¸ªæœåŠ¡å™¨è¯ä¹¦ã€‚</li><li><strong>ç­¾å‘è€…</strong>: ç”±æŸä¸ªä¸­é—´CAç­¾å‘ã€‚</li></ul><h3 id="4-è¯ä¹¦é“¾çš„éªŒè¯è¿‡ç¨‹"><a href="#4-è¯ä¹¦é“¾çš„éªŒè¯è¿‡ç¨‹" class="headerlink" title="4. è¯ä¹¦é“¾çš„éªŒè¯è¿‡ç¨‹"></a>4. è¯ä¹¦é“¾çš„éªŒè¯è¿‡ç¨‹</h3><p>å½“ä½ çš„æµè§ˆå™¨è®¿é—®ä¸€ä¸ªç½‘ç«™ï¼ˆå¦‚<code>google.com</code>ï¼‰æ—¶ï¼Œå®ƒä¼šæ”¶åˆ°æœåŠ¡å™¨å‘æ¥çš„<strong>ä¸€æ•´ä¸²è¯ä¹¦</strong>ï¼Œé€šå¸¸åŒ…æ‹¬ï¼š</p><ol><li><code>google.com</code>çš„æœ€ç»ˆå®ä½“è¯ä¹¦ã€‚</li><li>ç­¾å‘<code>google.com</code>çš„ä¸­é—´CAè¯ä¹¦ã€‚</li><li>(å¯èƒ½è¿˜æœ‰)ç­¾å‘ä¸Šä¸€ä¸ªä¸­é—´CAçš„ã€æ›´é«˜çº§åˆ«çš„ä¸­é—´CAè¯ä¹¦â€¦</li></ol><p>æµè§ˆå™¨çš„éªŒè¯è¿‡ç¨‹å°±åƒä¸€åœºâ€œä¿¡ä»»æº¯æºâ€ä¹‹æ—…ï¼š</p><ol><li><strong>éªŒè¯ç¬¬1ç¯</strong>: æµè§ˆå™¨æŸ¥çœ‹<code>google.com</code>çš„è¯ä¹¦ï¼Œæ‰¾åˆ°å…¶â€œé¢å‘è€…â€æ˜¯â€œä¸­é—´CA Aâ€ã€‚ç„¶åç”¨â€œä¸­é—´CA Aâ€çš„å…¬é’¥ï¼ˆä»ç¬¬2ä¸ªè¯ä¹¦ä¸­è·å¾—ï¼‰éªŒè¯<code>google.com</code>è¯ä¹¦çš„ç­¾åã€‚</li><li><strong>éªŒè¯ç¬¬2ç¯</strong>: æµè§ˆå™¨æŸ¥çœ‹â€œä¸­é—´CA Aâ€çš„è¯ä¹¦ï¼Œæ‰¾åˆ°å…¶â€œé¢å‘è€…â€æ˜¯â€œæ ¹CA Xâ€ã€‚ç„¶åç”¨â€œæ ¹CA Xâ€çš„å…¬é’¥ï¼ˆä»æœ¬åœ°ä¿¡ä»»åº“ä¸­è·å¾—ï¼‰éªŒè¯â€œä¸­é—´CA Aâ€è¯ä¹¦çš„ç­¾åã€‚</li><li><strong>è§¦è¾¾ä¿¡ä»»é”šç‚¹</strong>: æµè§ˆå™¨å‘ç°â€œæ ¹CA Xâ€æ˜¯ä¸€ä¸ªè‡ªç­¾åçš„ã€ä¸”å­˜åœ¨äºè‡ªå·±â€œå—ä¿¡ä»»åˆ—è¡¨â€ä¸­çš„æ ¹è¯ä¹¦ã€‚</li></ol><p>è‡³æ­¤ï¼Œæ•´æ¡ä¿¡ä»»é“¾è¢«å®Œæ•´åœ°ã€æˆåŠŸåœ°å»ºç«‹èµ·æ¥ã€‚æµè§ˆå™¨ç¡®ä¿¡ï¼Œ<code>google.com</code>çš„å…¬é’¥æ˜¯çœŸå®å¯ä¿¡çš„ã€‚</p><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD;    subgraph &quot;æœ¬åœ°è®¾å¤‡ä¿¡ä»»åº“&quot;        Root_Cert[&quot;æ ¹CAè¯ä¹¦&lt;br&gt;(è‡ªç­¾å, å†…ç½®ä¿¡ä»»)&quot;];    end    subgraph &quot;æœåŠ¡å™¨å‘æ¥çš„è¯ä¹¦é“¾&quot;        Inter_Cert[&quot;ä¸­é—´CAè¯ä¹¦&lt;br&gt;(ç”±æ ¹CAç­¾å)&quot;];        Entity_Cert[&quot;æœ€ç»ˆå®ä½“è¯ä¹¦&lt;br&gt;(ç”±ä¸­é—´CAç­¾å)&quot;];    end        Root_Cert -- &quot;1. éªŒè¯&quot; --&gt; Inter_Cert;    Inter_Cert -- &quot;2. éªŒè¯&quot; --&gt; Entity_Cert;    Entity_Cert -- &quot;3. æå–å¯ä¿¡å…¬é’¥&quot; --&gt; Key[(&quot;æœ€ç»ˆå®ä½“çš„å…¬é’¥&quot;)];        classDef root fill:#fff0f6,stroke:#c41d7f;    classDef inter fill:#e6f7ff,stroke:#0050b3;    classDef entity fill:#f6ffed,stroke:#237804;        class Root_Cert root;    class Inter_Cert inter;    class Entity_Cert entity;  </pre></div><p><em>å›¾3ï¼šè¯ä¹¦é“¾çš„éªŒè¯æµç¨‹</em></p><h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><p>æ•°å­—ç­¾åä¸æ•°å­—è¯ä¹¦é€šè¿‡ä¸€å¥—ç²¾å¦™çš„å¯†ç å­¦æœºåˆ¶ï¼Œç¯ç¯ç›¸æ‰£ï¼Œå…±åŒæ„å»ºäº†ç°ä»£ç½‘ç»œä¸–ç•Œçš„ä¿¡ä»»åŸºçŸ³ã€‚</p><ul><li><strong>æ•°å­—ç­¾å</strong>åˆ©ç”¨<strong>éå¯¹ç§°åŠ å¯†</strong>å’Œ<strong>å“ˆå¸Œå‡½æ•°</strong>ï¼Œä¿è¯äº†ä¿¡æ¯äº¤æ¢ä¸­çš„<strong>èº«ä»½è®¤è¯ã€å®Œæ•´æ€§</strong>å’Œ<strong>ä¸å¯å¦è®¤æ€§</strong>ã€‚</li><li><strong>æ•°å­—è¯ä¹¦</strong>é€šè¿‡å¼•å…¥<strong>æƒå¨çš„CAæœºæ„</strong>ï¼Œè§£å†³äº†å…¬é’¥åˆ†å‘çš„ä¿¡ä»»é—®é¢˜ã€‚</li><li><strong>è¯ä¹¦é“¾</strong>åˆ™é€šè¿‡<strong>å±‚çº§åŒ–çš„æˆæƒå’ŒéªŒè¯</strong>ï¼Œæ„å»ºäº†ä¸€ä¸ªå¯æ‰©å±•ã€å®‰å…¨ã€é«˜æ•ˆçš„å…¨çƒä¿¡ä»»ä½“ç³»ã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¯†ç å­¦ </tag>
            
            <tag> éå¯¹ç§°åŠ å¯† </tag>
            
            <tag> æ•°å­—ç­¾å </tag>
            
            <tag> æ•°å­—è¯ä¹¦ </tag>
            
            <tag> CA </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxå¯ä¿¡å¯åŠ¨æ·±åº¦è§£æï¼šä»UEFIåˆ°æ“ä½œç³»ç»Ÿçš„å®Œæ•´ä¿¡ä»»é“¾</title>
      <link href="/2025/07/28/Linux%E5%8F%AF%E4%BF%A1%E5%90%AF%E5%8A%A8%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/"/>
      <url>/2025/07/28/Linux%E5%8F%AF%E4%BF%A1%E5%90%AF%E5%8A%A8%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1 id="Linux-å¯ä¿¡å¯åŠ¨æ·±åº¦è§£æï¼šä»UEFIåˆ°æ“ä½œç³»ç»Ÿçš„ä¿¡ä»»é“¾"><a href="#Linux-å¯ä¿¡å¯åŠ¨æ·±åº¦è§£æï¼šä»UEFIåˆ°æ“ä½œç³»ç»Ÿçš„ä¿¡ä»»é“¾" class="headerlink" title="Linux å¯ä¿¡å¯åŠ¨æ·±åº¦è§£æï¼šä»UEFIåˆ°æ“ä½œç³»ç»Ÿçš„ä¿¡ä»»é“¾"></a>Linux å¯ä¿¡å¯åŠ¨æ·±åº¦è§£æï¼šä»UEFIåˆ°æ“ä½œç³»ç»Ÿçš„ä¿¡ä»»é“¾</h1><p>[TOC]</p><h2 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h2><p>åœ¨æ¢è®¨äº†è§£å­¦ä¹ è™šæ‹ŸåŒ–çš„å®‰å…¨æ–¹æ¡ˆï¼ˆå¦‚HyperEnclaveï¼‰æ—¶ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°åŠ¨æ€ä¿¡ä»»æ ¹ï¼ˆDRTMï¼‰çš„æ¦‚å¿µã€‚ä½†DRTMçš„æœ‰æ•ˆæ€§ï¼Œåˆä¾èµ–äºä¸€ä¸ªç¨³å›ºçš„é™æ€ä¿¡ä»»æ ¹ï¼ˆStatic Root of Trust for Measurement, SRTMï¼‰ã€‚è¿™æ¡SRTMä¿¡ä»»é“¾ï¼Œæ„æˆäº†æ•´ä¸ªå¹³å°å¯ä¿¡åº¦çš„åŸºçŸ³ã€‚</p><p>æœ¬æ–‡æ¡£çš„ç›®çš„ï¼Œå°±æ˜¯å®Œæ•´åœ°ã€ç³»ç»Ÿæ€§åœ°æ¢³ç†è¿™æ¡ä¿¡ä»»é“¾ã€‚æˆ‘ä»¬å°†ä»PCä¸Šç”µçš„ç¬é—´å¼€å§‹ï¼Œä¸€è·¯è¿½è¸ªä¿¡ä»»çš„â€œæ¥åŠ›æ£’â€æ˜¯å¦‚ä½•ä»UEFIå›ºä»¶ï¼Œä¼ é€’ç»™GRUB 2å¼•å¯¼åŠ è½½ç¨‹åºï¼Œå¹¶æœ€ç»ˆç”±Linuxå†…æ ¸æ¥ç®¡ï¼Œå°†å…¶å»¶ä¼¸è‡³æ¯ä¸€ä¸ªè¿è¡Œä¸­çš„åº”ç”¨ç¨‹åºã€‚</p><hr><h2 id="ä¸€ã€-å¯ä¿¡æ ¹åŸºï¼šTPMä¸æ ¸å¿ƒæ¦‚å¿µ"><a href="#ä¸€ã€-å¯ä¿¡æ ¹åŸºï¼šTPMä¸æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="ä¸€ã€ å¯ä¿¡æ ¹åŸºï¼šTPMä¸æ ¸å¿ƒæ¦‚å¿µ"></a>ä¸€ã€ å¯ä¿¡æ ¹åŸºï¼šTPMä¸æ ¸å¿ƒæ¦‚å¿µ</h2><p>åœ¨æ·±å…¥æµç¨‹ä¹‹å‰ï¼Œå¿…é¡»å…ˆå¯¹é½å‡ ä¸ªè´¯ç©¿å§‹ç»ˆçš„æ ¸å¿ƒæ¦‚å¿µã€‚</p><h3 id="1-1-ä»€ä¹ˆæ˜¯â€œåº¦é‡â€-Measurement-ï¼Ÿ"><a href="#1-1-ä»€ä¹ˆæ˜¯â€œåº¦é‡â€-Measurement-ï¼Ÿ" class="headerlink" title="1.1 ä»€ä¹ˆæ˜¯â€œåº¦é‡â€ (Measurement)ï¼Ÿ"></a>1.1 ä»€ä¹ˆæ˜¯â€œåº¦é‡â€ (Measurement)ï¼Ÿ</h3><p>åœ¨å¯ä¿¡è®¡ç®—çš„è¯­å¢ƒé‡Œï¼Œâ€œåº¦é‡â€å°±æ˜¯ä¸€ä¸ªåŠ¨ä½œï¼š<strong>å¯¹ä¸€æ®µæ•°æ®ï¼ˆæ¯”å¦‚ä¸€ä¸ªæ–‡ä»¶æˆ–ä¸€æ®µä»£ç ï¼‰è®¡ç®—å…¶å¯†ç å­¦å“ˆå¸Œå€¼ï¼ˆå¦‚SHA-256ï¼‰</strong>ã€‚</p><p>è¿™ä¸ªå“ˆå¸Œå€¼å°±åƒæ˜¯è¿™æ®µæ•°æ®çš„â€œæ•°å­—æŒ‡çº¹â€ï¼Œä»»ä½•å¾®å°çš„æ”¹åŠ¨éƒ½ä¼šå¯¼è‡´æŒ‡çº¹å‘ç”Ÿå¤©ç¿»åœ°è¦†çš„å˜åŒ–ã€‚è¿™ä¸ªåŠ¨ä½œæœ¬èº«ä¸æä¾›å®‰å…¨ï¼Œå®ƒåªæ˜¯æä¾›äº†ä¸€ç§<strong>å¯éªŒè¯çš„ã€å”¯ä¸€çš„èº«ä»½æ ‡è¯†</strong>ã€‚</p><h3 id="1-2-ä¿¡ä»»é“¾ä¸TPM-PCR"><a href="#1-2-ä¿¡ä»»é“¾ä¸TPM-PCR" class="headerlink" title="1.2 ä¿¡ä»»é“¾ä¸TPM PCR"></a>1.2 ä¿¡ä»»é“¾ä¸TPM PCR</h3><p>â€œä¿¡ä»»é“¾â€ï¼ˆChain of Trustï¼‰çš„æ€æƒ³å¾ˆç®€å•ï¼šä¿¡ä»»æ˜¯éœ€è¦ä¼ é€’çš„ã€‚å°±åƒæ¥åŠ›èµ›ï¼Œç¬¬ä¸€æ£’è¿åŠ¨å‘˜ï¼ˆä¿¡ä»»çš„æ ¹æºï¼‰å¿…é¡»æ˜¯å¯ä¿¡çš„ï¼Œç„¶åä»–æŠŠæ¥åŠ›æ£’ï¼ˆæ§åˆ¶æƒï¼‰äº¤ç»™ç¬¬äºŒæ£’æ—¶ï¼Œå¿…é¡»å…ˆä¿è¯ç¬¬äºŒæ£’ä¹Ÿæ˜¯å¯ä¿¡çš„ã€‚</p><p>TPMï¼ˆå¯ä¿¡å¹³å°æ¨¡å—ï¼‰å°±æ˜¯è¿™ä¸ªè¿‡ç¨‹ä¸­çš„â€œå…¬è¯å‘˜â€å’Œâ€œè®°äº‹æœ¬â€ã€‚å®ƒå†…éƒ¨æœ‰ä¸€ç»„ç‰¹æ®Šçš„å¯„å­˜å™¨ï¼Œå«<strong>å¹³å°é…ç½®å¯„å­˜å™¨ï¼ˆPlatform Configuration Registers, PCRsï¼‰</strong>ã€‚</p><p>PCRæœ‰ä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„ç‰¹æ€§ï¼š<strong>ä½ ä¸èƒ½ç›´æ¥å†™å…¥ä¸€ä¸ªå€¼ï¼Œä½ åªèƒ½å¯¹å®ƒæ‰§è¡Œ<code>Extend</code>ï¼ˆæ‰©å±•ï¼‰æ“ä½œã€‚</strong></p><p><code>Extend</code>æ“ä½œçš„æœ¬è´¨æ˜¯ï¼š<code>PCR_new_value = HASH(PCR_old_value || new_data_hash)</code></p><p>è¿™ä¸ªç‰¹æ€§ä½¿å¾—PCRæˆä¸ºäº†ä¸€ä¸ªå®Œç¾çš„ã€é˜²ç¯¡æ”¹çš„å¯åŠ¨æ—¥å¿—ã€‚ä»»ä½•å¯¹å¯åŠ¨æµç¨‹çš„åç¦»ï¼Œéƒ½ä¼šåœ¨è¿™æœ¬â€œåªèƒ½è¿½åŠ ã€ä¸èƒ½ä¿®æ”¹â€çš„æ—¥å¿—ä¸Šç•™ä¸‹æ¸…æ™°çš„ç—•è¿¹ã€‚</p><hr><h2 id="äºŒã€-é˜¶æ®µä¸€ï¼šå›ºä»¶çš„å¯ä¿¡å¯åŠ¨-UEFI"><a href="#äºŒã€-é˜¶æ®µä¸€ï¼šå›ºä»¶çš„å¯ä¿¡å¯åŠ¨-UEFI" class="headerlink" title="äºŒã€ é˜¶æ®µä¸€ï¼šå›ºä»¶çš„å¯ä¿¡å¯åŠ¨ (UEFI)"></a>äºŒã€ é˜¶æ®µä¸€ï¼šå›ºä»¶çš„å¯ä¿¡å¯åŠ¨ (UEFI)</h2><p>ä¿¡ä»»é“¾çš„æºå¤´ï¼Œå§‹äºPCä¸Šç”µåè¿è¡Œçš„ç¬¬ä¸€è¡Œä»£ç â€”â€”UEFIå›ºä»¶ã€‚å®ƒçš„å¯åŠ¨è¿‡ç¨‹å¹¶éä¸€ä¸ªå•ä¸€æ­¥éª¤ï¼Œè€Œæ˜¯éµå¾ªä¸šç•Œæ ‡å‡†ï¼ˆå¦‚PI-Specï¼‰çš„ä¸€ä¸ªåˆ†é˜¶æ®µçš„åˆå§‹åŒ–åºåˆ—ã€‚</p><h3 id="2-1-å¼•å¯¼çš„èµ·ç‚¹ï¼šä»SECåˆ°DXEçš„åˆå§‹åŒ–"><a href="#2-1-å¼•å¯¼çš„èµ·ç‚¹ï¼šä»SECåˆ°DXEçš„åˆå§‹åŒ–" class="headerlink" title="2.1 å¼•å¯¼çš„èµ·ç‚¹ï¼šä»SECåˆ°DXEçš„åˆå§‹åŒ–"></a>2.1 å¼•å¯¼çš„èµ·ç‚¹ï¼šä»SECåˆ°DXEçš„åˆå§‹åŒ–</h3><p>UEFIçš„å¯åŠ¨å¯ä»¥å¤§è‡´åˆ†ä¸ºå‡ ä¸ªå…³é”®é˜¶æ®µï¼Œæ¯ä¸€æ­¥éƒ½ä¸ºä¸‹ä¸€æ­¥æ„å»ºåŸºç¡€ã€‚</p><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD;    A[&quot;ä¸Šç”µ&quot;] --&gt; B[&quot;SEC Phase (Security)&quot;];    B --&gt;|åº¦é‡PEIä»£ç | C[&quot;PEI Phase (Pre-EFI Initialization)&quot;];    C --&gt;|åº¦é‡DXEæ ¸å¿ƒ| D[&quot;DXE Phase (Driver Execution Environment)&quot;];    D --&gt; E[&quot;BDS Phase (Boot Device Selection)&quot;];    E --&gt; F[&quot;OSå¼•å¯¼åŠ è½½ç¨‹åº (GRUB 2)&quot;];        subgraph &quot;CPU Cache as RAM&quot;        B    end    subgraph &quot;DRAMå¯ç”¨&quot;        C;D;E;F    end        classDef metric fill:#f9f,stroke:#333;    class B,C metric;  </pre></div><p><em>å›¾1: UEFI å¯åŠ¨é˜¶æ®µæ€»è§ˆ</em></p><ol><li><p><strong>SEC (Security) Phase - å®‰å…¨é˜¶æ®µ</strong>:</p><ul><li>è¿™æ˜¯CPUåœ¨åŠ ç”µåæ‰§è¡Œçš„<strong>ç¬¬ä¸€æ®µä»£ç </strong>ï¼Œé€šå¸¸ç”±å¤„ç†å™¨çš„å¾®ç å’Œå›ºä»¶ä¸­çš„ä¸€å°æ®µæ±‡ç¼–ä»£ç ç»„æˆï¼Œæ˜¯å¹³å°çš„<strong>é™æ€ä¿¡ä»»æ ¹åº¦é‡ï¼ˆStatic Root of Trust for Measurement, SRTMï¼‰</strong>çš„èµ·ç‚¹ï¼Œä¹Ÿè¢«ç§°ä¸º<strong>æ ¸å¿ƒä¿¡ä»»æ ¹åº¦é‡ï¼ˆCore Root of Trust for Measurement, CRTMï¼‰</strong>ã€‚</li><li>å®ƒçš„æ ¸å¿ƒä»»åŠ¡éå¸¸å•çº¯ï¼šå»ºç«‹ä¸€ä¸ªä¸´æ—¶çš„è¿è¡Œç¯å¢ƒï¼ˆé€šå¸¸æ˜¯ä½¿ç”¨CPUçš„ç¼“å­˜ä½œä¸ºä¸´æ—¶å†…å­˜ï¼‰ï¼Œå¹¶æ‰¾åˆ°ã€éªŒè¯ã€å¯åŠ¨ä¸‹ä¸€é˜¶æ®µï¼ˆPEIï¼‰ã€‚ä½œä¸ºä¿¡ä»»é“¾çš„ç¬¬ä¸€ç¯ï¼Œå®ƒä¼š<strong>åº¦é‡PEIé˜¶æ®µ</strong>çš„ä»£ç ï¼Œå¹¶å°†ç»“æœ<code>Extend</code>åˆ° <strong>PCR[0]</strong> ä¸­ã€‚</li></ul></li><li><p><strong>PEI (Pre-EFI Initialization) Phase - EFIå‰æœŸåˆå§‹åŒ–é˜¶æ®µ</strong>:</p><ul><li>PEIçš„ä¸»è¦èŒè´£æ˜¯<strong>åˆå§‹åŒ–ä¸»å†…å­˜ï¼ˆDRAMï¼‰</strong>ã€‚ä¸€æ—¦DRAMå¯ç”¨ï¼Œåç»­çš„å¤æ‚ä»»åŠ¡æ‰æœ‰äº†è¿è¡Œç©ºé—´ã€‚</li><li>å®ƒä¼šè¿›è¡Œæœ€æ ¸å¿ƒçš„å¹³å°ç¡¬ä»¶å‘ç°ï¼ˆå¦‚CPUã€èŠ¯ç‰‡ç»„ï¼‰ï¼Œå¹¶å°†è¿™äº›ä¿¡æ¯ç»„ç»‡æˆä¸€ä¸ªâ€œäº¤æ¥æ¸…å•â€ï¼ˆHand-Off Block List, HOBsï¼‰ï¼Œä¼ é€’ç»™ä¸‹ä¸€é˜¶æ®µã€‚åœ¨äº¤æ¥å‰ï¼Œå®ƒä¼š<strong>åº¦é‡DXEé˜¶æ®µ</strong>çš„æ ¸å¿ƒä»£ç ï¼Œå¹¶ç»§ç»­<code>Extend</code>åˆ° **PCR[0]**ã€‚</li></ul></li><li><p><strong>DXE (Driver Execution Environment) Phase - é©±åŠ¨æ‰§è¡Œç¯å¢ƒé˜¶æ®µ</strong>:</p><ul><li>è¿™æ˜¯UEFIçš„â€œä¸»èˆå°â€ã€‚DXEé˜¶æ®µçš„æ ¸å¿ƒæ˜¯ä¸€ä¸ª<strong>åˆ†å‘å™¨ï¼ˆDispatcherï¼‰</strong>ï¼Œå®ƒä¼šæ ¹æ®ä¾èµ–å…³ç³»ï¼Œå¾ªç¯åŠ è½½å’Œæ‰§è¡Œä¸€ç³»åˆ—çš„<strong>DXEé©±åŠ¨</strong>ï¼Œå®Œæˆå¯¹å¹³å°ä¸Šå‡ ä¹æ‰€æœ‰ç¡¬ä»¶çš„åˆå§‹åŒ–ã€‚</li><li>åœ¨è¿™ä¸ªé˜¶æ®µï¼Œå„ç§<strong>UEFIæœåŠ¡å’Œåè®®</strong>è¢«åˆ›å»ºå’Œå‘å¸ƒï¼Œæ¯”å¦‚æ–‡ä»¶ç³»ç»ŸæœåŠ¡ã€å—è®¾å¤‡I&#x2F;OæœåŠ¡ï¼Œä»¥åŠæˆ‘ä»¬å¯ä¿¡å¯åŠ¨æ‰€ä¾èµ–çš„ <strong>TPMæœåŠ¡åè®®ï¼ˆEFI_TCG2_PROTOCOLï¼‰</strong>ã€‚æ‰€æœ‰è¢«åŠ è½½çš„DXEé©±åŠ¨ï¼Œä¹Ÿéƒ½ä¼šè¢«åº¦é‡å¹¶ç»§ç»­<code>Extend</code>åˆ° **PCR[0]**ã€‚åˆ°DXEé˜¶æ®µç»“æŸæ—¶ï¼Œç³»ç»Ÿå·²ç»æ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œå¤‡çš„â€œå°å‹æ“ä½œç³»ç»Ÿâ€ã€‚</li></ul></li></ol><h3 id="2-2-å¼•å¯¼è®¾å¤‡é€‰æ‹©-BDS-ï¼šUEFIå¦‚ä½•æ‰¾åˆ°GRUB"><a href="#2-2-å¼•å¯¼è®¾å¤‡é€‰æ‹©-BDS-ï¼šUEFIå¦‚ä½•æ‰¾åˆ°GRUB" class="headerlink" title="2.2 å¼•å¯¼è®¾å¤‡é€‰æ‹© (BDS)ï¼šUEFIå¦‚ä½•æ‰¾åˆ°GRUB"></a>2.2 å¼•å¯¼è®¾å¤‡é€‰æ‹© (BDS)ï¼šUEFIå¦‚ä½•æ‰¾åˆ°GRUB</h3><p>DXEé˜¶æ®µå®Œæˆåï¼Œæ§åˆ¶æƒäº¤ç»™<strong>BDSï¼ˆBoot Device Selectionï¼‰</strong>é˜¶æ®µã€‚è¿™æœ¬è´¨ä¸Šå°±æ˜¯æˆ‘ä»¬ç†ŸçŸ¥çš„<strong>UEFIå¯åŠ¨ç®¡ç†å™¨</strong>ã€‚åœ¨æ‰§è¡Œå¼•å¯¼åŠ è½½ç¨‹åºä¹‹å‰ï¼ŒBDSè‡ªèº«ä¹Ÿä¼šè¢«åº¦é‡åˆ°<code>PCR[0]</code>ä¸­ï¼Œè‡³æ­¤ï¼Œ<code>PCR[0]</code>å®Œæ•´åœ°è®°å½•äº†æ•´ä¸ªå›ºä»¶çš„å¯åŠ¨é“¾æ¡ã€‚</p><ol><li><p><strong>è¯»å–NVRAMå¯åŠ¨å˜é‡</strong>:</p><ul><li>BDSä¼šè¯»å–ä¸»æ¿ä¸Šéæ˜“å¤±æ€§å­˜å‚¨å™¨ï¼ˆNVRAMï¼‰ä¸­å­˜å‚¨çš„å¯åŠ¨å˜é‡ã€‚æœ€é‡è¦çš„å˜é‡æ˜¯ <code>BootOrder</code>ï¼Œå®ƒå®šä¹‰äº†å¯åŠ¨é¡¹çš„å°è¯•é¡ºåºï¼Œå¦‚ <code>[Boot0001, Boot0002, Boot0000]</code>ã€‚</li><li>æ¯ä¸€ä¸ªå¯åŠ¨é¡¹ï¼ˆå¦‚<code>Boot0001</code>ï¼‰éƒ½æ˜¯ä¸€ä¸ªè¯¦ç»†çš„è®°å½•ï¼Œå®ƒåŒ…å«äº†ï¼š<ul><li><strong>è®¾å¤‡è·¯å¾„</strong>: æŒ‡å‘ä¸€ä¸ªå…·ä½“çš„ç‰©ç†è®¾å¤‡ï¼ˆå¦‚æŸä¸€å—ç¡¬ç›˜çš„æŸä¸ªåˆ†åŒºï¼‰ã€‚</li><li><strong>æ–‡ä»¶è·¯å¾„</strong>: æŒ‡å‘è¯¥è®¾å¤‡ä¸Šè¦æ‰§è¡Œçš„EFIåº”ç”¨ç¨‹åºçš„è·¯å¾„ã€‚</li><li><strong>æè¿°</strong>: ä¸€ä¸ªç”¨æˆ·å¯è§çš„å­—ç¬¦ä¸²ï¼Œå¦‚ â€œubuntuâ€ æˆ– â€œWindows Boot Managerâ€ã€‚</li></ul></li></ul></li><li><p><strong>å®šä½GRUB</strong>:</p><ul><li>BDSä¼šæŒ‰ç…§<code>BootOrder</code>çš„é¡ºåºï¼Œå°è¯•åŠ è½½ç¬¬ä¸€ä¸ªå¯åŠ¨é¡¹ã€‚ä¾‹å¦‚ï¼Œå¯¹äº<code>Boot0001</code> (â€œubuntuâ€)ï¼Œå®ƒä¼šæ ¹æ®è®¾å¤‡è·¯å¾„æ‰¾åˆ°ESPåˆ†åŒºï¼ˆEFI System Partitionï¼Œä¸€ä¸ªæ ‡å‡†çš„FAT32åˆ†åŒºï¼‰ï¼Œç„¶ååœ¨è¿™ä¸ªåˆ†åŒºä¸Šæ ¹æ®æ–‡ä»¶è·¯å¾„æ‰¾åˆ°GRUBçš„æ ¸å¿ƒé•œåƒï¼Œä¾‹å¦‚ <code>\EFI\ubuntu\grubx64.efi</code>ã€‚</li><li><strong>å¤‡ç”¨è·¯å¾„(Fallback Path)</strong>: å¦‚æœæ‰€æœ‰<code>BootOrder</code>ä¸­çš„å¯åŠ¨é¡¹éƒ½å¤±è´¥äº†ï¼Œæˆ–è€…<code>BootOrder</code>ä¸ºç©ºï¼ŒBDSä¼šå°è¯•ä¸€ä¸ªæ ‡å‡†çš„å¤‡ç”¨è·¯å¾„ï¼š<code>\EFI\BOOT\BOOTX64.EFI</code>ã€‚</li></ul></li></ol><h3 id="2-3-Secure-Bootä¸åº¦é‡ï¼šä¿¡ä»»çš„ç¬¬ä¸€æ¬¡ä¼ é€’"><a href="#2-3-Secure-Bootä¸åº¦é‡ï¼šä¿¡ä»»çš„ç¬¬ä¸€æ¬¡ä¼ é€’" class="headerlink" title="2.3 Secure Bootä¸åº¦é‡ï¼šä¿¡ä»»çš„ç¬¬ä¸€æ¬¡ä¼ é€’"></a>2.3 Secure Bootä¸åº¦é‡ï¼šä¿¡ä»»çš„ç¬¬ä¸€æ¬¡ä¼ é€’</h3><p>åœ¨BDSæœ€ç»ˆå†³å®šè¦æ‰§è¡ŒæŸä¸ªEFIåº”ç”¨ç¨‹åºï¼ˆå¦‚<code>grubx64.efi</code>ï¼‰çš„é‚£ä¸€åˆ»ï¼ŒSecure Bootå’ŒTPMåº¦é‡æœºåˆ¶ä¼šä»‹å…¥ï¼Œå®Œæˆä¿¡ä»»çš„ç¬¬ä¸€æ¬¡ä¼ é€’ã€‚</p><ol><li><p><strong>Secure BootéªŒè¯</strong>:</p><ul><li>åœ¨æ‰§è¡Œ<code>grubx64.efi</code>ä¹‹å‰ï¼ŒUEFIä¼šç”¨å…¶å†…ç½®çš„<strong>ç­¾åæ•°æ®åº“ï¼ˆdbï¼‰</strong>ä¸­çš„å…¬é’¥ï¼Œå»éªŒè¯è¿™ä¸ªæ–‡ä»¶çš„æ•°å­—ç­¾åã€‚</li><li>åŒæ—¶ï¼Œå®ƒä¼šæ£€æŸ¥è¿™ä¸ªæ–‡ä»¶çš„ç­¾åå“ˆå¸Œæ˜¯å¦ä½äº<strong>ç¦æ­¢ç­¾åæ•°æ®åº“ï¼ˆdbxï¼‰</strong>çš„é»‘åå•ä¸­ã€‚</li><li>åªæœ‰ç­¾åæœ‰æ•ˆä¸”ä¸åœ¨é»‘åå•ä¸­ï¼Œç¨‹åºæ‰è¢«å…è®¸æ‰§è¡Œã€‚</li></ul></li><li><p><strong>ç¬¬ä¸€ç¯åº¦é‡</strong>:</p><ul><li>åœ¨éªŒè¯ç­¾åçš„åŒæ—¶ï¼ŒUEFIå›ºä»¶ä¹Ÿæ‰®æ¼”äº†<strong>ç¬¬ä¸€ä¸ªåº¦é‡è€…</strong>çš„è§’è‰²ã€‚å®ƒä¼šåº¦é‡å¯åŠ¨è¿‡ç¨‹ä¸­åŠ è½½çš„å…³é”®ç»„ä»¶ï¼Œå¹¶å°†å“ˆå¸Œå€¼æ‰©å±•åˆ°PCRä¸­ï¼š<ul><li><strong>PCR[0]</strong>: åº¦é‡UEFIå›ºä»¶è‡ªèº«çš„æ ¸å¿ƒä»£ç ã€å¯åŠ¨è®¾ç½®ç­‰ã€‚</li><li><strong>PCR[2]</strong>: åº¦é‡åŠ è½½çš„ç¬¬ä¸‰æ–¹UEFIé©±åŠ¨æˆ–æ‰©å±•ROMã€‚</li><li><strong>PCR[4]</strong>: åº¦é‡è¢«é€‰ä¸­çš„å¼•å¯¼åŠ è½½ç¨‹åºï¼ˆå¦‚<code>grubx64.efi</code>ï¼‰çš„å®Œæ•´é•œåƒã€‚</li><li><strong>PCR[7]</strong>: åº¦é‡Secure Bootçš„ç­–ç•¥å’Œå¯†é’¥çŠ¶æ€ã€‚</li></ul></li></ul></li><li><p><strong>äº¤æ¥æ§åˆ¶æƒ</strong>:</p><ul><li>è‡³æ­¤ï¼Œåœ¨å°†æ§åˆ¶æƒäº¤ç»™GRUBä¹‹å‰ï¼ŒUEFIå·²ç»å®Œæˆäº†ä¸¤ä»¶å¤§äº‹ï¼š<strong>é€šè¿‡ç­¾åéªŒè¯äº†GRUBçš„èº«ä»½åˆæ³•æ€§</strong>ï¼Œå¹¶<strong>é€šè¿‡åº¦é‡è®°å½•ä¸‹äº†GRUBçš„æ•°å­—æŒ‡çº¹</strong>ã€‚ç„¶åï¼Œå®ƒæ‰ä¼šçœŸæ­£è·³è½¬åˆ°<code>grubx64.efi</code>çš„å…¥å£ç‚¹å¼€å§‹æ‰§è¡Œã€‚</li></ul></li></ol><h4 id="2-4-SECé˜¶æ®µå¦‚ä½•ä¸TPMäº¤äº’ï¼Ÿ"><a href="#2-4-SECé˜¶æ®µå¦‚ä½•ä¸TPMäº¤äº’ï¼Ÿ" class="headerlink" title="2.4 SECé˜¶æ®µå¦‚ä½•ä¸TPMäº¤äº’ï¼Ÿ"></a>2.4 SECé˜¶æ®µå¦‚ä½•ä¸TPMäº¤äº’ï¼Ÿ</h4><p>ä¸€ä¸ªå…³é”®é—®é¢˜æ˜¯ï¼šåœ¨SECé˜¶æ®µï¼Œä¸»å†…å­˜ï¼ˆDRAMï¼‰éƒ½å°šæœªåˆå§‹åŒ–ï¼Œç³»ç»Ÿç¯å¢ƒæå…¶ç®€é™‹ï¼Œå®ƒæ€ä¹ˆå¯èƒ½æœ‰TPMçš„â€œé©±åŠ¨â€æ¥æ“ä½œå¯„å­˜å™¨å‘¢ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯ï¼š<strong>å®ƒæ²¡æœ‰ç°ä»£æ„ä¹‰ä¸Šçš„â€œé©±åŠ¨â€ï¼Œå®ƒæ‹¥æœ‰çš„æ˜¯æ›´åº•å±‚çš„ã€å›ºåŒ–åœ¨è‡ªèº«ä»£ç ä¸­çš„â€œç›´æ¥æ“ä½œèƒ½åŠ›â€ã€‚</strong></p><ul><li><strong>CRTMçš„ç‰¹æ®Šèº«ä»½</strong>: SECé˜¶æ®µæ‰§è¡Œçš„ä»£ç ï¼Œå³<strong>æ ¸å¿ƒä¿¡ä»»æ ¹åº¦é‡ï¼ˆCRTMï¼‰</strong>ï¼Œä¸æ˜¯ä¸€ä¸ªé€šç”¨çš„ç¨‹åºã€‚å®ƒæ˜¯ç”±èŠ¯ç‰‡æˆ–ä¸»æ¿åˆ¶é€ å•†ç¼–å†™çš„ã€é«˜åº¦ç‰¹æƒåŒ–ã€å¹³å°ä¸“å±çš„ä¸€å°æ®µä»£ç ã€‚å®ƒè¢«è®¤ä¸ºæ˜¯<strong>éšå¼å¯ä¿¡çš„</strong>ï¼Œæ˜¯ä¿¡ä»»çš„ç»å¯¹æºå¤´ã€‚</li><li><strong>ç¡¬ç¼–ç çš„é€šä¿¡èƒ½åŠ›</strong>: CRTMçš„ä»£ç <strong>ç›´æ¥åŒ…å«äº†ä¸TPMèŠ¯ç‰‡è¿›è¡Œæœ€ä½çº§åˆ«é€šä¿¡æ‰€éœ€è¦çš„æ‰€æœ‰æŒ‡ä»¤</strong>ã€‚å®ƒçŸ¥é“è¦é€šè¿‡å“ªä¸ªæ€»çº¿ï¼ˆå¦‚LPCæˆ–SPIæ€»çº¿ï¼‰ã€å‘å“ªä¸ªå…·ä½“çš„I&#x2F;Oç«¯å£æˆ–å†…å­˜æ˜ å°„åœ°å€ï¼ˆMMIOï¼‰å‘é€ä»€ä¹ˆæ ·å­—èŠ‚åºåˆ—ï¼Œæ¥å‘½ä»¤TPMæ‰§è¡Œâ€œæ‰©å±•PCR[0]â€è¿™ä¸ªåŠ¨ä½œã€‚è¿™ä¸ªæœ€åŸå§‹çš„â€œTPMé©±åŠ¨â€è¢«<strong>ç¡¬ç¼–ç ï¼ˆHard-codedï¼‰</strong>åœ¨äº†CRTMå†…éƒ¨ã€‚</li><li><strong>è®¾è®¡çš„å®‰å…¨æ€§</strong>: æ­£å› ä¸ºå®ƒä¸ä¾èµ–ä»»ä½•å¤–éƒ¨åŠ è½½çš„é©±åŠ¨ï¼Œæ‰€ä»¥å®ƒçš„è¡Œä¸ºæ˜¯ç¡®å®šçš„ã€ä¸å—å¤–éƒ¨ç¯å¢ƒå½±å“çš„ï¼Œè¿™æ°æ°æ˜¯ä½œä¸ºä¿¡ä»»æ ¹æ‰€å¿…éœ€çš„ã€‚</li></ul><hr><h2 id="ä¸‰ã€-é˜¶æ®µäºŒï¼šå¼•å¯¼åŠ è½½ç¨‹åºçš„æ¥åŠ›-GRUB-2"><a href="#ä¸‰ã€-é˜¶æ®µäºŒï¼šå¼•å¯¼åŠ è½½ç¨‹åºçš„æ¥åŠ›-GRUB-2" class="headerlink" title="ä¸‰ã€ é˜¶æ®µäºŒï¼šå¼•å¯¼åŠ è½½ç¨‹åºçš„æ¥åŠ› (GRUB 2)"></a>ä¸‰ã€ é˜¶æ®µäºŒï¼šå¼•å¯¼åŠ è½½ç¨‹åºçš„æ¥åŠ› (GRUB 2)</h2><p>ç°åœ¨ï¼Œä¿¡ä»»é“¾çš„æ¥åŠ›æ£’ä¼ é€’åˆ°äº†GRUB 2æ‰‹ä¸­ã€‚</p><h3 id="3-1-GRUBè‡ªæˆ‘å”¤é†’å¹¶å»¶ç»­ä¿¡ä»»é“¾"><a href="#3-1-GRUBè‡ªæˆ‘å”¤é†’å¹¶å»¶ç»­ä¿¡ä»»é“¾" class="headerlink" title="3.1 GRUBè‡ªæˆ‘å”¤é†’å¹¶å»¶ç»­ä¿¡ä»»é“¾"></a>3.1 GRUBè‡ªæˆ‘å”¤é†’å¹¶å»¶ç»­ä¿¡ä»»é“¾</h3><p>GRUB 2çš„æ ¸å¿ƒé•œåƒï¼ˆ<code>core.img</code>ï¼‰å·²ç»åœ¨å†…å­˜ä¸­è¿è¡Œï¼Œä½†å®ƒéå¸¸å°ï¼ŒåŠŸèƒ½æœ‰é™ã€‚å®ƒéœ€è¦æ‰¾åˆ°è‡ªå·±çš„â€œå¤§éƒ¨é˜Ÿâ€â€”â€”é…ç½®æ–‡ä»¶å’Œå„ç§æ¨¡å—ã€‚</p><ol><li><p><strong>GRUBçš„è‡ªæˆ‘å®šä½ä¸é…ç½®åŠ è½½</strong>:</p><ul><li>GRUBç°åœ¨æ˜¯â€œé†’ç€â€çš„ã€‚å®ƒä¼šå¯ç”¨è‡ªå·±å†…ç½®çš„ã€å¾®å‹çš„æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨ï¼ˆä¾‹å¦‚<code>fat.mod</code>å¯èƒ½å·²ç»åµŒå…¥<code>core.img</code>ä¸­ï¼‰ï¼Œæ›´é‡è¦çš„æ˜¯ï¼Œå®ƒä¼šåŠ è½½æ›´å¼ºå¤§çš„æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨ï¼ˆå¦‚<code>ext4.mod</code>ï¼‰ã€‚</li><li>å®ƒæ ¹æ®å®‰è£…æ—¶é…ç½®çš„â€œå‰ç¼€â€ï¼ˆprefixï¼‰ä¿¡æ¯ï¼Œå»å¦ä¸€ä¸ªåˆ†åŒºï¼ˆé€šå¸¸æ˜¯Linuxçš„<code>/boot</code>åˆ†åŒºï¼Œæ ¼å¼ä¸ºext4ç­‰ï¼‰ä¸‹çš„<code>/grub/</code>ç›®å½•ä¸­ï¼Œå¯»æ‰¾å¹¶è¯»å–å®ƒçš„â€œæ–½å·¥å›¾çº¸â€â€”â€” <strong><code>grub.cfg</code></strong> æ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶åŒ…å«äº†æ‰€æœ‰å¯åŠ¨èœå•é¡¹å’Œè¦æ‰§è¡Œçš„å‘½ä»¤ã€‚</li></ul></li><li><p><strong>è§£æé…ç½®å¹¶åº¦é‡</strong>:</p><ul><li>GRUBå¼€å§‹é€è¡Œè§£æ<code>grub.cfg</code>ã€‚å½“å®ƒé‡åˆ°ä¸€ä¸ªè¢«é€‰æ‹©çš„<code>menuentry</code>ï¼ˆå¯åŠ¨é¡¹ï¼‰æ—¶ï¼Œå®ƒä¼šä¸¥æ ¼æŒ‰ç…§é‡Œé¢çš„å‘½ä»¤æ‰§è¡Œã€‚ä¸€ä¸ªç”¨äºå¯ä¿¡å¯åŠ¨çš„é…ç½®ç‰‡æ®µå¯èƒ½å¦‚ä¸‹ï¼š<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">menuentry &#x27;Arch Linux (Trusted Boot)&#x27; &#123;</span><br><span class="line">    # 1. åŠ¨æ€åŠ è½½TPMæ¨¡å—ï¼Œè®©GRUBå…·å¤‡ä¸TPMäº¤äº’çš„èƒ½åŠ›</span><br><span class="line">    insmod tpm</span><br><span class="line"></span><br><span class="line">    # 2. åŠ è½½Linuxå†…æ ¸ã€‚åŠ è½½tpm.modåï¼Œ</span><br><span class="line">    #    linuxå‘½ä»¤ä¼šè‡ªåŠ¨è§¦å‘åº¦é‡è¡Œä¸º</span><br><span class="line">    linux   /boot/vmlinuz-linux root=UUID=... ro quiet</span><br><span class="line"></span><br><span class="line">    # 3. åŠ è½½initramfsã€‚åŒæ ·ï¼Œä¼šè¢«åº¦é‡</span><br><span class="line">    initrd  /boot/initramfs-linux.img</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><strong>åº¦é‡<code>grub.cfg</code>æœ¬èº«</strong>: GRUBä¼šåº¦é‡å®ƒè§£æçš„è¿™äº›å‘½ä»¤æ–‡æœ¬ï¼Œå¹¶å°†ç»“æœæ‰©å±•åˆ°PCRä¸­ï¼ˆå¦‚**PCR[8]**ï¼‰ï¼Œä»¥ç¡®ä¿é…ç½®æœ¬èº«æœªè¢«ç¯¡æ”¹ã€‚</li><li><strong>åº¦é‡å†…æ ¸</strong>: å½“æ‰§è¡Œ<code>linux</code>å‘½ä»¤æ—¶ï¼ŒGRUBé¦–å…ˆå°†<code>/boot/vmlinuz-linux</code>æ–‡ä»¶å®Œæ•´è¯»å…¥å†…å­˜ï¼Œå¯¹å…¶å†…å®¹è¿›è¡Œå“ˆå¸Œè®¡ç®—ï¼ˆåº¦é‡ï¼‰ï¼Œç„¶åé€šè¿‡<code>tpm.mod</code>å°†å“ˆå¸Œå€¼<code>Extend</code>åˆ°æŒ‡å®šçš„PCRå¯„å­˜å™¨ä¸­ï¼ˆé€šå¸¸ä¹Ÿæ˜¯**PCR[8]<strong>æˆ–</strong>PCR[10]**ï¼‰ã€‚</li><li><strong>åº¦é‡initramfs</strong>: åŒæ ·ï¼Œ<code>initrd</code>å‘½ä»¤ä¹Ÿä¼šè§¦å‘å¯¹<code>/boot/initramfs-linux.img</code>çš„åº¦é‡ï¼Œå¹¶å°†å“ˆå¸Œå€¼æ‰©å±•åˆ°PCRä¸­ã€‚</li></ul></li></ol><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph LR;    subgraph &quot;ç¡¬ç›˜ (Disk)&quot;        A[&quot;&#x2F;boot&#x2F;vmlinuz (å†…æ ¸æ–‡ä»¶)&quot;];    end    subgraph &quot;GRUB 2 (å†…å­˜ä¸­)&quot;        C[&quot;GRUB æ ¸å¿ƒ&quot;];        D[&quot;å“ˆå¸Œè®¡ç®—å¼•æ“&quot;];        E[&quot;TPM æ¨¡å—&quot;];    end        subgraph &quot;ç¡¬ä»¶ (Hardware)&quot;        F[&quot;TPM èŠ¯ç‰‡&quot;];    end    A -- &quot;1. è¯»å–æ–‡ä»¶è‡³å†…å­˜&quot; --&gt; C;    C -- &quot;2. å¯¹å†…å­˜ä¸­çš„æ•°æ®è¿›è¡Œå“ˆå¸Œ&quot; --&gt; D;    D -- &quot;3. å‡†å¤‡å“ˆå¸Œå€¼&quot; --&gt; E;    E -- &quot;4. è¯·æ±‚æ‰©å±•PCR&quot; --&gt; F;        style A fill:#d3eafb,stroke:#333;  </pre></div><p><em>å›¾2ï¼šGRUB 2 åº¦é‡å†…æ ¸çš„è¯¦ç»†æµç¨‹</em></p><h3 id="3-2-æ§åˆ¶æƒçš„ç¬¬äºŒæ¬¡äº¤æ¥-GRUB-Kernel"><a href="#3-2-æ§åˆ¶æƒçš„ç¬¬äºŒæ¬¡äº¤æ¥-GRUB-Kernel" class="headerlink" title="3.2 æ§åˆ¶æƒçš„ç¬¬äºŒæ¬¡äº¤æ¥ (GRUB -&gt; Kernel)"></a>3.2 æ§åˆ¶æƒçš„ç¬¬äºŒæ¬¡äº¤æ¥ (GRUB -&gt; Kernel)</h3><p>å®Œæˆæ‰€æœ‰åº¦é‡åï¼ŒGRUBå°†CPUçš„æ§åˆ¶æƒæ­£å¼äº¤ç»™å†…æ ¸çš„å…¥å£ç‚¹ã€‚ä¿¡ä»»é“¾çš„æ¥åŠ›æ£’ï¼Œè‡³æ­¤æˆåŠŸä¼ é€’ç»™äº†æ“ä½œç³»ç»Ÿã€‚</p><hr><h2 id="å››ã€-é˜¶æ®µä¸‰ï¼šå†…æ ¸çš„å…¨é¢å®ˆæŠ¤-IMA"><a href="#å››ã€-é˜¶æ®µä¸‰ï¼šå†…æ ¸çš„å…¨é¢å®ˆæŠ¤-IMA" class="headerlink" title="å››ã€ é˜¶æ®µä¸‰ï¼šå†…æ ¸çš„å…¨é¢å®ˆæŠ¤ (IMA)"></a>å››ã€ é˜¶æ®µä¸‰ï¼šå†…æ ¸çš„å…¨é¢å®ˆæŠ¤ (IMA)</h2><p>å½“å†…æ ¸å¼€å§‹è¿è¡Œæ—¶ï¼Œä¿¡ä»»é“¾å¹¶æ²¡æœ‰ç»“æŸï¼Œè€Œæ˜¯è¿›å…¥äº†ä¸€ä¸ªæ›´ç²¾ç»†ã€æ›´æŒç»­çš„é˜¶æ®µã€‚Linuxå†…æ ¸é€šè¿‡<strong>å®Œæ•´æ€§åº¦é‡æ¶æ„ï¼ˆIntegrity Measurement Architecture, IMAï¼‰</strong>æ¥æ¥ç®¡åº¦é‡çš„èŒè´£ã€‚</p><h3 id="4-1-IMAç®€ä»‹ï¼šå°†ä¿¡ä»»æ‰©å±•åˆ°æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿ"><a href="#4-1-IMAç®€ä»‹ï¼šå°†ä¿¡ä»»æ‰©å±•åˆ°æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="4.1 IMAç®€ä»‹ï¼šå°†ä¿¡ä»»æ‰©å±•åˆ°æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿ"></a>4.1 IMAç®€ä»‹ï¼šå°†ä¿¡ä»»æ‰©å±•åˆ°æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿ</h3><p>IMAçš„ç›®æ ‡ï¼Œæ˜¯å°†ä¿¡ä»»é“¾ä»å¯åŠ¨é˜¶æ®µçš„å‡ ä¸ªå…³é”®æ–‡ä»¶ï¼Œå»¶ä¼¸åˆ°ç³»ç»Ÿè¿è¡Œè¿‡ç¨‹ä¸­è®¿é—®çš„<strong>æ¯ä¸€ä¸ªæ–‡ä»¶</strong>ï¼ˆåŒ…æ‹¬åº”ç”¨ç¨‹åºã€é…ç½®æ–‡ä»¶ã€åº“æ–‡ä»¶ç­‰ï¼‰ã€‚</p><h3 id="4-2-IMA-Measureï¼šè¿è¡Œæ—¶åº¦é‡"><a href="#4-2-IMA-Measureï¼šè¿è¡Œæ—¶åº¦é‡" class="headerlink" title="4.2 IMA-Measureï¼šè¿è¡Œæ—¶åº¦é‡"></a>4.2 IMA-Measureï¼šè¿è¡Œæ—¶åº¦é‡</h3><p>è¿™æ˜¯IMAæœ€åŸºç¡€çš„åŠŸèƒ½ã€‚å®ƒçš„å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š</p><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  sequenceDiagram    participant User as ç”¨æˆ·    participant App as åº”ç”¨ç¨‹åº    participant Kernel as å†…æ ¸    participant IMA    participant TPM    User-&gt;&gt;App: æ‰§è¡Œ &#x2F;usr&#x2F;bin&#x2F;cat    App-&gt;&gt;Kernel: ç³»ç»Ÿè°ƒç”¨: execve(&quot;&#x2F;usr&#x2F;bin&#x2F;cat&quot;)    Kernel-&gt;&gt;IMA: (Hook) æ‰§è¡Œå‰è§¦å‘IMA    activate IMA    IMA-&gt;&gt;IMA: è¯»å– &#x2F;usr&#x2F;bin&#x2F;cat æ–‡ä»¶å†…å®¹    IMA-&gt;&gt;IMA: è®¡ç®—æ–‡ä»¶å“ˆå¸Œå€¼    IMA-&gt;&gt;TPM: å°†å“ˆå¸Œå€¼ Extend åˆ° PCR[10]    TPM--&gt;&gt;IMA: æ‰©å±•æˆåŠŸ    deactivate IMA    IMA--&gt;&gt;Kernel: åº¦é‡å®Œæˆ, å…è®¸æ‰§è¡Œ    Kernel-&gt;&gt;App: ç»§ç»­æ‰§è¡Œç¨‹åº  </pre></div><p><em>å›¾2: IMA åº¦é‡æµç¨‹</em></p><ul><li><strong>é’©å­ (Hook)</strong>: IMAåœ¨å†…æ ¸çš„å…³é”®è·¯å¾„ï¼ˆå¦‚æ–‡ä»¶æ‰“å¼€ã€æ‰§è¡Œ<code>execve</code>ã€å†…å­˜æ˜ å°„<code>mmap</code>ï¼‰ä¸Šè®¾ç½®äº†é’©å­ã€‚</li><li><strong>åº¦é‡</strong>: æ¯å½“æœ‰æ–‡ä»¶è¦è¢«è®¿é—®æˆ–æ‰§è¡Œæ—¶ï¼Œé’©å­è¢«è§¦å‘ï¼ŒIMAå­ç³»ç»Ÿä¼šå…ˆè®¡ç®—è¯¥æ–‡ä»¶çš„å“ˆå¸Œå€¼ã€‚</li><li><strong>æ‰©å±•</strong>: è®¡ç®—å‡ºçš„å“ˆå¸Œå€¼è¢«æ‰©å±•åˆ° **PCR[10]**ï¼ˆIMAä¸“ç”¨çš„PCRå¯„å­˜å™¨ï¼‰ã€‚</li><li><strong>è®°å½•æ—¥å¿—</strong>: åŒæ—¶ï¼ŒIMAä¼šå°†è¿™æ¬¡åº¦é‡çš„è¯¦ç»†ä¿¡æ¯ï¼ˆæ–‡ä»¶åã€å“ˆå¸Œå€¼ï¼‰è®°å½•åœ¨å†…å­˜ä¸­çš„ä¸€ä¸ªæ—¥å¿—é‡Œï¼Œè¯¥æ—¥å¿—å¯ä»¥é€šè¿‡<code>/sys/kernel/security/ima/ascii_runtime_measurements</code>æŸ¥çœ‹ã€‚</li></ul><p>é€šè¿‡è¿™ä¸ªæœºåˆ¶ï¼Œä»»ä½•åœ¨ç³»ç»Ÿè¿è¡Œæ—¶è¢«åŠ è½½çš„æ–‡ä»¶ï¼Œéƒ½ä¼šç•™ä¸‹â€œæŒ‡çº¹â€ï¼Œç¡®ä¿äº†ç³»ç»Ÿçš„åŠ¨æ€å¯å®¡è®¡æ€§ã€‚</p><h3 id="4-3-IMA-Appraiseï¼šè¿è¡Œæ—¶å¼ºåˆ¶è®¿é—®æ§åˆ¶"><a href="#4-3-IMA-Appraiseï¼šè¿è¡Œæ—¶å¼ºåˆ¶è®¿é—®æ§åˆ¶" class="headerlink" title="4.3 IMA-Appraiseï¼šè¿è¡Œæ—¶å¼ºåˆ¶è®¿é—®æ§åˆ¶"></a>4.3 IMA-Appraiseï¼šè¿è¡Œæ—¶å¼ºåˆ¶è®¿é—®æ§åˆ¶</h3><p><code>IMA-Appraise</code>æ˜¯IMAçš„è¿›é˜¶åŠŸèƒ½ã€‚å®ƒä¸ä»…åº¦é‡ï¼Œè¿˜ä¼šè¿›è¡Œ<strong>å¼ºåˆ¶æ€§çš„éªŒè¯</strong>ã€‚</p><ul><li>ç³»ç»Ÿä¼šé¢„å…ˆä¸ºæ‰€æœ‰å¯ä¿¡æ–‡ä»¶è®¡ç®—å“ˆå¸Œï¼Œå¹¶å°†è¿™äº›å“ˆå¸Œå€¼ä½œä¸ºæ‰©å±•å±æ€§ï¼ˆ<code>security.ima</code>ï¼‰å­˜å‚¨åœ¨æ–‡ä»¶å…ƒæ•°æ®ä¸­ï¼Œå¹¶è¿›è¡Œç­¾åã€‚</li><li>å½“<code>IMA-Appraise</code>å¯ç”¨æ—¶ï¼Œæ¯æ¬¡æ–‡ä»¶è¢«åº¦é‡åï¼ŒIMAä¼šï¼š<ol><li>æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰<code>security.ima</code>å±æ€§ã€‚</li><li>éªŒè¯å±æ€§ä¸­çš„å“ˆå¸Œç­¾åæ˜¯å¦æœ‰æ•ˆã€‚</li><li>æ¯”è¾ƒå®æ—¶è®¡ç®—çš„å“ˆå¸Œå€¼ä¸å±æ€§ä¸­å­˜å‚¨çš„â€œé»„é‡‘å“ˆå¸Œå€¼â€æ˜¯å¦ä¸€è‡´ã€‚</li></ol></li><li><strong>åªæœ‰ä¸‰è€…å…¨éƒ¨é€šè¿‡ï¼Œæ‰å…è®¸è®¿é—®ã€‚å¦åˆ™ï¼Œç›´æ¥æ‹’ç»ï¼</strong> è¿™å°†å¯ä¿¡å¯åŠ¨ä»ä¸€ä¸ªâ€œåªè®°å½•ã€ä¸é˜»æ­¢â€çš„æ¨¡å‹ï¼Œå˜æˆäº†ä¸€ä¸ªä¸»åŠ¨é˜²å¾¡çš„å¼ºåˆ¶è®¿é—®æ§åˆ¶ç³»ç»Ÿã€‚</li></ul><hr><h2 id="äº”ã€-æ€»ç»“ï¼šä¸€æ¡å®Œæ•´çš„é™æ€ä¿¡ä»»æ ¹-SRTM-é“¾"><a href="#äº”ã€-æ€»ç»“ï¼šä¸€æ¡å®Œæ•´çš„é™æ€ä¿¡ä»»æ ¹-SRTM-é“¾" class="headerlink" title="äº”ã€ æ€»ç»“ï¼šä¸€æ¡å®Œæ•´çš„é™æ€ä¿¡ä»»æ ¹ (SRTM) é“¾"></a>äº”ã€ æ€»ç»“ï¼šä¸€æ¡å®Œæ•´çš„é™æ€ä¿¡ä»»æ ¹ (SRTM) é“¾</h2><p>ç»¼ä¸Šæ‰€è¿°ï¼Œä¸€æ¡å®Œæ•´çš„Linuxé™æ€ä¿¡ä»»æ ¹é“¾æ¡ï¼Œæ˜¯ä¸€ä¸ªåˆ†å·¥æ˜ç¡®ã€å±‚å±‚é€’è¿›çš„æ¥åŠ›è¿‡ç¨‹ï¼š</p><table><thead><tr><th align="left">é˜¶æ®µ</th><th align="left">è´Ÿè´£ç»„ä»¶</th><th align="left">æ ¸å¿ƒåŠ¨ä½œ</th><th align="left">ä¸»è¦åº¦é‡ç›®æ ‡</th><th align="left">ä¸»è¦å½±å“çš„PCR</th></tr></thead><tbody><tr><td align="left"><strong>é˜¶æ®µä¸€</strong></td><td align="left"><strong>UEFI å›ºä»¶</strong></td><td align="left">Secure BootéªŒè¯ã€åº¦é‡</td><td align="left">å›ºä»¶ä»£ç ã€æ‰©å±•ROMã€å¼•å¯¼åŠ è½½ç¨‹åº</td><td align="left">PCR[0-7]</td></tr><tr><td align="left"><strong>é˜¶æ®µäºŒ</strong></td><td align="left"><strong>GRUB 2</strong></td><td align="left">è§£æé…ç½®ã€åº¦é‡</td><td align="left"><code>grub.cfg</code>å‘½ä»¤ã€å†…æ ¸ã€initramfs</td><td align="left">PCR[8-9]</td></tr><tr><td align="left"><strong>é˜¶æ®µä¸‰</strong></td><td align="left"><strong>Linux å†…æ ¸ (IMA)</strong></td><td align="left">Hookå…³é”®è·¯å¾„ã€åº¦é‡</td><td align="left">åº”ç”¨ç¨‹åºã€åº“ã€é…ç½®æ–‡ä»¶ç­‰</td><td align="left">PCR[10]</td></tr></tbody></table><p>ä»ç¡¬ä»¶ä¸Šç”µåˆ°æ¯ä¸€ä¸ªåº”ç”¨è¢«æ‰§è¡Œï¼Œæ¯ä¸€æ­¥çš„æ§åˆ¶æƒäº¤æ¥éƒ½ä¼´éšç€â€œéªŒè¯â€ä¸â€œåº¦é‡â€ï¼Œç¡®ä¿äº†ä¿¡ä»»ä»ä¸€ä¸ªç»å¯¹å¯ä¿¡çš„ç¡¬ä»¶æ ¹ï¼ˆTPMï¼‰ï¼Œä¸€è·¯ä¼ é€’åˆ°è¿è¡Œä¸­çš„æ•´ä¸ªæ“ä½œç³»ç»Ÿï¼Œæœ€ç»ˆå½¢æˆäº†ä¸€ä¸ªåšå®ã€å¯å®¡è®¡ã€å¯éªŒè¯çš„å®‰å…¨åŸºç¡€ã€‚ </p>]]></content>
      
      
      <categories>
          
          <category> éšç§è®¡ç®— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> å¯ä¿¡å¯åŠ¨ </tag>
            
            <tag> TPM </tag>
            
            <tag> UEFI </tag>
            
            <tag> GRUB </tag>
            
            <tag> å®‰å…¨å¯åŠ¨ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¸€èµ·æ¥å­¦Intel SGX</title>
      <link href="/2025/07/26/%E4%B8%80%E8%B5%B7%E6%9D%A5%E5%AD%A6Intel%20SGX/"/>
      <url>/2025/07/26/%E4%B8%80%E8%B5%B7%E6%9D%A5%E5%AD%A6Intel%20SGX/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€èµ·æ¥å­¦-Intel-SGX"><a href="#ä¸€èµ·æ¥å­¦-Intel-SGX" class="headerlink" title="ä¸€èµ·æ¥å­¦ Intel SGX"></a>ä¸€èµ·æ¥å­¦ Intel SGX</h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>Intel SGX è¿˜æ˜¯æ¯”è¾ƒéš¾å­¦é€çš„ï¼Œå› ä¸ºå¯ä¾›å­¦ä¹ çš„èµ„æ–™ç¡®å®æœ‰é™ï¼Œå¹¶ä¸” Intel å¹¶æ²¡æœ‰å¼€æ”¾å…¶æºç å®ç°ã€‚æ‰€ä»¥æˆ‘ä»¬ä»…èƒ½é€šè¿‡å…¶å®˜æ–¹ä¸Šå‘å¸ƒçš„ä¸€äº›æ‰‹å†Œå’Œå­¦æœ¯è®ºæ–‡æ¥å­¦ä¹ ã€‚å¦ç‡çš„è¯´ï¼Œä¸æ˜¯å¾ˆå®¹æ˜“å­¦ï¼Œè¿˜æ¶‰åŠåˆ°ä¸€äº›å¯†ç å­¦çŸ¥è¯†ã€‚</p><blockquote><p>Intel SGX Explainedï¼š<a href="https://eprint.iacr.org/2016/086.pdf">https://eprint.iacr.org/2016/086.pdf</a></p><p>IntelÂ® Software Guard Extensions (IntelÂ® SGX) Developer Guideï¼š</p><p><a href="https://download.01.org/intel-sgx/sgx-linux/2.8/docs/Intel_SGX_Developer_Guide.pdf">https://download.01.org/intel-sgx/sgx-linux/2.8/docs/Intel_SGX_Developer_Guide.pdf</a></p><p>Intel å®˜æ–¹æ–‡æ¡£æœç´¢ï¼š<a href="https://www.intel.com/content/www/us/en/search.html?toplevelcategory=Developers&keyword=sgx#q=intel%20sgx&first=30&sort=relevancy">https://www.intel.com/content/www/us/en/search.html?toplevelcategory=Developers&amp;keyword=sgx#q=intel%20sgx&amp;first=30&amp;sort=relevancy</a></p></blockquote><p>æˆ‘å†™æœ¬æ–‡çš„ç›®çš„å…¶å®å¾ˆç®€å•ï¼Œå°±æ˜¯æƒ³è®©è‡ªå·±å¯ä»¥å°½é‡é€å½»çš„ç†è§£ SGXçš„è®¾è®¡ä¸å®ç°ã€‚çŸ¥é“å®ƒé¢ä¸´å“ªäº›é—®é¢˜ï¼Œç„¶åå¦‚ä½•è§£å†³çš„ã€‚</p><h2 id="ä¸€ã€SGXåŸºç¡€ä¸æ ¸å¿ƒæ¦‚å¿µ"><a href="#ä¸€ã€SGXåŸºç¡€ä¸æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="ä¸€ã€SGXåŸºç¡€ä¸æ ¸å¿ƒæ¦‚å¿µ"></a>ä¸€ã€SGXåŸºç¡€ä¸æ ¸å¿ƒæ¦‚å¿µ</h2><p>Intel SGX (Software Guard Extensions) æ˜¯ä¸€é¡¹å¼ºå¤§çš„ç¡¬ä»¶å®‰å…¨æŠ€æœ¯ï¼Œå®ƒå…è®¸å¼€å‘è€…åœ¨å……æ»¡æ½œåœ¨å¨èƒçš„ç¯å¢ƒä¸­ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªè¢«æ¶æ„è½¯ä»¶æ„ŸæŸ“çš„æ“ä½œç³»ç»Ÿï¼‰åˆ›å»ºä¸€å—è¢«ç§°ä¸ºâ€Enclaveâ€çš„å®‰å…¨åŒºåŸŸï¼Œä»¥ä¿æŠ¤æ•æ„Ÿçš„ä»£ç å’Œæ•°æ®ã€‚</p><h3 id="1-1-SGXçš„ç›®æ ‡ï¼šæœºå¯†è®¡ç®—"><a href="#1-1-SGXçš„ç›®æ ‡ï¼šæœºå¯†è®¡ç®—" class="headerlink" title="1.1 SGXçš„ç›®æ ‡ï¼šæœºå¯†è®¡ç®—"></a>1.1 SGXçš„ç›®æ ‡ï¼šæœºå¯†è®¡ç®—</h3><p>æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æœ‰ä¸€æ®µéå¸¸æ•æ„Ÿçš„ç¨‹åºï¼ˆä¾‹å¦‚ï¼Œå¤„ç†ç”¨æˆ·å¯†ç çš„ç®—æ³•ï¼‰æˆ–ä¸€ä»½æœºå¯†æ•°æ®ï¼ˆä¾‹å¦‚ï¼Œå…¬å¸æ‰€è¿è¥çš„appé‡Œçš„ä¸ªäººä¿¡æ¯æ•°æ®ï¼‰ã€‚åœ¨ä¼ ç»Ÿçš„è®¡ç®—æ¨¡å¼ä¸‹ï¼Œè¿™æ®µç¨‹åºå’Œæ•°æ®åœ¨è¿è¡Œæ—¶ä¼šå®Œå…¨æš´éœ²ç»™æ“ä½œç³»ç»Ÿï¼ˆOSï¼‰å’Œç³»ç»Ÿç®¡ç†å‘˜ã€‚å¦‚æœ OS è¢«é»‘å®¢æ”»ç ´ï¼Œé‚£ä¹ˆæœºå¯†å°†è¡ç„¶æ— å­˜ã€‚</p><p><strong>SGX çš„æ ¸å¿ƒç›®æ ‡å°±æ˜¯è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</strong> å®ƒè‡´åŠ›äºå®ç°â€æœºå¯†è®¡ç®—â€ï¼ˆConfidential Computingï¼‰ï¼Œå³ï¼š<strong>ä¿æŠ¤æ­£åœ¨ä½¿ç”¨ä¸­çš„æ•°æ®</strong>ã€‚å³ä½¿åœ¨æ“ä½œç³»ç»Ÿã€è™šæ‹Ÿæœºç›‘è§†å™¨ï¼ˆVMM&#x2F;Hypervisorï¼‰ç”šè‡³ç‰©ç†å†…å­˜æ¢æµ‹ç­‰æœ€é«˜æƒé™çš„æ”»å‡»ä¸‹ï¼ŒSGX ä¹Ÿèƒ½ç¡®ä¿ Enclave å†…éƒ¨çš„ä»£ç å’Œæ•°æ®ä¸è¢«çªƒå–æˆ–ç¯¡æ”¹ã€‚</p><h3 id="1-2-TCBï¼ˆå¯ä¿¡è®¡ç®—åŸºï¼‰"><a href="#1-2-TCBï¼ˆå¯ä¿¡è®¡ç®—åŸºï¼‰" class="headerlink" title="1.2 TCBï¼ˆå¯ä¿¡è®¡ç®—åŸºï¼‰"></a>1.2 TCBï¼ˆå¯ä¿¡è®¡ç®—åŸºï¼‰</h3><p>åœ¨çœ‹ä¸€äº›æœºå¯†è®¡ç®—æˆ–è€…éšç§è®¡ç®—çš„æ–‡ç« æ—¶å€™ï¼Œå¯èƒ½ä¼šç»å¸¸çœ‹åˆ°è¿™ä¸ªè¯ã€‚å…¶å® <strong>TCBï¼ˆTrusted Computing Baseï¼Œå¯ä¿¡è®¡ç®—åŸºï¼‰</strong>ï¼Œçœ‹å­—æ¯ä»¥ä¸ºæ˜¯ä¸€ä¸ªå…·ä½“çš„ç¡¬ä»¶ï¼Œå…¶å®æ˜¯ä¸€ä¸ªå®‰å…¨æ¦‚å¿µã€‚</p><p><strong>TCB çš„å®šä¹‰æ˜¯</strong>ï¼šä¸€ä¸ªç³»ç»Ÿä¸­ï¼Œæ‰€æœ‰å¿…é¡»ä¾èµ–å…¶æ¥ä¿éšœå®‰å…¨ç­–ç•¥çš„ç¡¬ä»¶ã€å›ºä»¶å’Œè½¯ä»¶ç»„ä»¶çš„é›†åˆã€‚ç®€å•æ¥è¯´ï¼ŒTCB å°±æ˜¯æˆ‘ä»¬é€‰æ‹©â€æ— æ¡ä»¶ä¿¡ä»»â€çš„æ‰€æœ‰éƒ¨åˆ†ï¼ˆä¹Ÿå«ä¿¡ä»»çš„è¾¹ç•Œï¼‰ã€‚ä¸€ä¸ªç³»ç»Ÿçš„ TCB è¶Šå°ï¼Œå…¶è¢«æ”»å‡»çš„é¢å°±è¶Šå°ï¼Œç³»ç»Ÿå°±è¶Šå®‰å…¨ã€‚</p><p>åœ¨ä¼ ç»Ÿçš„è®¡ç®—æœºç³»ç»Ÿä¸­ï¼ŒTCB éå¸¸åºå¤§ï¼Œå®ƒåŒ…æ‹¬ï¼š</p><ul><li>ç¡¬ä»¶</li><li>å›ºä»¶ï¼ˆBIOS&#x2F;UEFIï¼‰</li><li>è™šæ‹Ÿæœºç›‘è§†å™¨ï¼ˆVMM&#x2F;Hypervisorï¼‰</li><li>æ“ä½œç³»ç»Ÿï¼ˆOSï¼‰</li><li>é©±åŠ¨ç¨‹åºç­‰</li></ul><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    %% ä¼ ç»Ÿè®¡ç®—ç¯å¢ƒçš„TCB (æ”»å‡»é¢å¤§)    Traditional[ä¼ ç»Ÿè®¡ç®—ç¯å¢ƒTCB] --&gt; Hardware[ç¡¬ä»¶]    Traditional --&gt; Firmware[å›ºä»¶&#x2F;BIOS]    Traditional --&gt; VMM[è™šæ‹Ÿæœºç›‘æ§ç¨‹åº]    Traditional --&gt; OS[æ“ä½œç³»ç»Ÿ]    Traditional --&gt; Driver[é©±åŠ¨ç¨‹åº]    Traditional --&gt; App[åº”ç”¨ç¨‹åº]        %% SGXç¯å¢ƒ (TCBæå°)    SGX[SGXå¯ä¿¡è®¡ç®—åŸº] --&gt; CPU[CPU+SGXå¾®ç ]        %% ä¸å¯ä¿¡ç»„ä»¶    Untrusted[ä¸å¯ä¿¡åŒºåŸŸ] --&gt; SGX_Firmware[å›ºä»¶&#x2F;BIOS]    Untrusted --&gt; SGX_VMM[VMM]    Untrusted --&gt; SGX_OS[OS]    Untrusted --&gt; SGX_Driver[é©±åŠ¨]        %% å®‰å…¨è¾¹ç•Œ    CPU -.-&gt;|å®‰å…¨è¾¹ç•Œ| Untrusted        %% æ ·å¼ç±»å®šä¹‰ï¼ˆå…¼å®¹æ€§å†™æ³•ï¼‰    classDef trusted fill:#90ee90,stroke:#2e8b57;    classDef untrusted fill:#ffcccb,stroke:#333;    class CPU trusted;    class Hardware,Firmware,VMM,OS,Driver,App untrusted;    class SGX_Firmware,SGX_VMM,SGX_OS,SGX_Driver untrusted;  </pre></div><p>SGX çš„é©å‘½æ€§åœ¨äºï¼Œå®ƒæå¤§åœ°å‡å°äº† TCBã€‚</p><p>åœ¨ä½¿ç”¨ SGX çš„æ¨¡å‹ä¸­ï¼ŒTCB ä¸»è¦åªåŒ…å«ï¼š</p><ol><li><strong>CPU ç¡¬ä»¶</strong>ï¼šç‰¹æŒ‡æ”¯æŒ SGX çš„ CPU èŠ¯ç‰‡æœ¬èº«ã€‚</li><li><strong>SGX å¾®ç ï¼ˆMicrocodeï¼‰</strong>ï¼šCPU å†…éƒ¨å®ç° SGX åŠŸèƒ½çš„å›ºä»¶ã€‚</li></ol><p>æ“ä½œç³»ç»Ÿã€Hypervisorã€BIOS ç­‰æ‰€æœ‰å…¶ä»–è½¯ä»¶éƒ½è¢«æ’é™¤åœ¨ TCB ä¹‹å¤–ï¼Œè¢«è§†ä¸ºâ€ä¸å¯ä¿¡â€çš„ã€‚è¿™æ„å‘³ç€ï¼Œæˆ‘ä»¬ä¸å†éœ€è¦ä¿¡ä»»åºå¤§è€Œå¤æ‚çš„æ“ä½œç³»ç»Ÿï¼Œåªéœ€è¦ä¿¡ä»» Intel è®¾è®¡å’Œåˆ¶é€ çš„ CPU å³å¯ã€‚è¿™å°±æ˜¯ SGX å®‰å…¨æ¨¡å‹çš„åŸºçŸ³ã€‚</p><blockquote><p>ä¸è¿‡ä¸€æ—¦ä¿¡ä»»åŸºå‡ºç°é—®é¢˜ï¼Œå¯èƒ½æ•´ä¸ªä½“ç³»æ¡†æ¶éƒ½ä¼šåœŸå´©ç“¦è§£ã€‚è¿™ä¸ªå…¶å®ä¹Ÿæ˜¯ HyperEnclaveæ‰€æ‹…å¿§çš„ï¼Œä»–ä»¬ä¸å¸Œæœ›ç”±CPUå‚å•†æ¥å†³å®šä¿¡ä»»åŸºã€‚</p></blockquote><h3 id="1-3-Enclaveçš„èº«ä»½ä¸‰è¦ç´ ï¼šMRENCLAVE-SIGSTRUCT-MRSIGNER"><a href="#1-3-Enclaveçš„èº«ä»½ä¸‰è¦ç´ ï¼šMRENCLAVE-SIGSTRUCT-MRSIGNER" class="headerlink" title="1.3 Enclaveçš„èº«ä»½ä¸‰è¦ç´ ï¼šMRENCLAVE, SIGSTRUCT, MRSIGNER"></a>1.3 Enclaveçš„èº«ä»½ä¸‰è¦ç´ ï¼šMRENCLAVE, SIGSTRUCT, MRSIGNER</h3><p>è¦ç†è§£SGXå¦‚ä½•ä¿¡ä»»ä¸€ä¸ªEnclaveï¼Œæˆ‘ä»¬å¿…é¡»è§£å‰–å®ƒçš„ä¸‰å¤§èº«ä»½è¦ç´ ã€‚è¿™ä¸‰è€…ç¯ç¯ç›¸æ‰£ï¼Œå…±åŒæ„æˆäº†Enclaveä¸å¯ä¼ªé€ çš„èº«ä»½è¯æ˜ã€‚</p><h4 id="a-MRENCLAVE-Enclaveçš„â€DNAæŒ‡çº¹â€"><a href="#a-MRENCLAVE-Enclaveçš„â€DNAæŒ‡çº¹â€" class="headerlink" title="a) MRENCLAVE - Enclaveçš„â€DNAæŒ‡çº¹â€"></a>a) MRENCLAVE - Enclaveçš„â€DNAæŒ‡çº¹â€</h4><p><strong>å®šä¹‰</strong>: <code>MRENCLAVE</code> æ˜¯ä¸€ä¸ª 256 ä½çš„å“ˆå¸Œå€¼ï¼Œæ˜¯Enclaveä»£ç å’Œåˆå§‹æ•°æ®å†…å®¹çš„å”¯ä¸€æ ‡è¯†ã€‚</p><p><strong>è®¡ç®—è¿‡ç¨‹</strong>: è¿™æ˜¯åœ¨EnclaveåŠ è½½è¿‡ç¨‹ä¸­ï¼Œç”±CPUç¡¬ä»¶é€šè¿‡<code>EEXTEND</code>æŒ‡ä»¤åŠ¨æ€è®¡ç®—çš„ã€‚æ¯å½“ä¸€é¡µä»£ç æˆ–æ•°æ®è¢«åŠ è½½åˆ°å—ä¿æŠ¤å†…å­˜ï¼ˆEPCï¼‰ä¸­ï¼ŒCPUç¡¬ä»¶éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡å¯†ç å­¦â€æµ‹é‡â€ï¼Œå°†å…¶å†…å®¹åˆå¹¶åˆ°<code>MRENCLAVE</code>çš„ç´¯ç§¯å“ˆå¸Œè®¡ç®—ä¸­ã€‚</p><p><strong>å®‰å…¨æ„ä¹‰</strong>:</p><ul><li><strong>å®Œæ•´æ€§ä¿è¯</strong>: ä»»ä½•å¯¹Enclaveå†…å®¹çš„å¾®å°ä¿®æ”¹ï¼ˆå“ªæ€•ä¸€ä¸ªæ¯”ç‰¹ï¼‰éƒ½ä¼šå¯¼è‡´æœ€ç»ˆçš„<code>MRENCLAVE</code>å€¼å‘ç”Ÿå¤©ç¿»åœ°è¦†çš„å˜åŒ–ã€‚è¿™ä¿è¯äº†è¿è¡Œä¸­çš„Enclaveä¸å…¶å¼€å‘è€…ç¼–è¯‘æ—¶çš„åŸå§‹ç‰ˆæœ¬å®Œå…¨ä¸€è‡´ã€‚</li></ul><hr><h4 id="b-SIGSTRUCT-Enclaveçš„â€æ•°å­—å°æ¡â€ä¸èº«ä»½å‡­è¯"><a href="#b-SIGSTRUCT-Enclaveçš„â€æ•°å­—å°æ¡â€ä¸èº«ä»½å‡­è¯" class="headerlink" title="b) SIGSTRUCT - Enclaveçš„â€æ•°å­—å°æ¡â€ä¸èº«ä»½å‡­è¯"></a>b) SIGSTRUCT - Enclaveçš„â€æ•°å­—å°æ¡â€ä¸èº«ä»½å‡­è¯</h4><p>ä¸€ä¸ªEnclaveæ–‡ä»¶ï¼ˆ<code>.signed.so</code>ï¼‰å°±åƒä¸€ä¸ªå¸¦é˜²ä¼ªæ ‡è¯†çš„æœºå¯†æ–‡ä»¶è¢‹ã€‚å®ƒåŒ…å«ä¸¤éƒ¨åˆ†ï¼š</p><ol><li><strong>ä¸»ä½“å†…å®¹</strong>: å³Enclaveçš„äºŒè¿›åˆ¶ä»£ç å’Œæ•°æ®ã€‚</li><li><strong>æ•°å­—å°æ¡ (<code>SIGSTRUCT</code>)</strong>: è¿™æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ•°æ®ç»“æ„ï¼ŒåŒ…å«äº†éªŒè¯Enclaveèº«ä»½æ‰€éœ€çš„æ‰€æœ‰å…ƒæ•°æ®ã€‚å…¶æ ¸å¿ƒå†…å®¹æ˜¯ï¼š<ul><li><strong>å¼€å‘è€…çš„å…¬é’¥</strong>: ç”¨æ¥ç­¾åEnclaveçš„é‚£ä¸ªç§é’¥æ‰€å¯¹åº”çš„å…¬é’¥ã€‚</li><li><strong>å¯¹MRENCLAVEçš„ç­¾å</strong>: å¼€å‘è€…åœ¨ç¼–è¯‘åï¼Œä¼šç”¨è‡ªå·±çš„<strong>ç§é’¥</strong>å¯¹é¢„æœŸçš„<code>MRENCLAVE</code>å€¼è¿›è¡Œç­¾åã€‚è¿™ä¸ª<strong>ç­¾åæœ¬èº«</strong>è¢«ä¿å­˜åœ¨SIGSTRUCTä¸­ã€‚</li></ul></li></ol><hr><h4 id="c-EINITä¸MRSIGNER-â€œèº«ä»½éªŒè¯â€ä¸â€èº«ä»½æˆäºˆâ€"><a href="#c-EINITä¸MRSIGNER-â€œèº«ä»½éªŒè¯â€ä¸â€èº«ä»½æˆäºˆâ€" class="headerlink" title="c) EINITä¸MRSIGNER - â€œèº«ä»½éªŒè¯â€ä¸â€èº«ä»½æˆäºˆâ€"></a>c) EINITä¸MRSIGNER - â€œèº«ä»½éªŒè¯â€ä¸â€èº«ä»½æˆäºˆâ€</h4><p><code>EINIT</code>æŒ‡ä»¤æ˜¯Enclaveç”Ÿå‘½å‘¨æœŸä¸­å†³å®šæ€§çš„â€åŠ å†•å…¸ç¤¼â€ï¼Œç”±CPUç¡¬ä»¶æ‰®æ¼”ä¸€ä¸ªæ— æ³•è¢«è½¯ä»¶å¹²é¢„çš„â€ç»ˆæè¾¹æ£€å®˜â€ã€‚å½“<code>EINIT</code>æŒ‡ä»¤è¢«è°ƒç”¨æ—¶ï¼Œç¡¬ä»¶ä¼šæ‰§è¡Œä¸¤ä¸ªæ ¸å¿ƒåŠ¨ä½œï¼š</p><p><strong>åŠ¨ä½œä¸€ï¼šéªŒè¯ç­¾å (éªŒè¯â€æ•°å­—å°æ¡â€çš„çœŸå®æ€§)</strong></p><ol><li><strong>æå–å‡­è¯</strong>: CPUç¡¬ä»¶ä»<code>SIGSTRUCT</code>ä¸­æå–å‡º<strong>å¼€å‘è€…çš„å…¬é’¥</strong>å’Œ<strong>ç­¾å</strong>ã€‚</li><li><strong>åŠ¨æ€è®¡ç®—</strong>: CPUç¡¬ä»¶æ ¹æ®å·²åŠ è½½åˆ°å†…å­˜ä¸­çš„ä»£ç ï¼Œç‹¬ç«‹è®¡ç®—å‡ºä¸€ä¸ª<code>actual_mrenclave</code>ã€‚</li><li><strong>å¯†ç å­¦éªŒè¯</strong>: CPUä½¿ç”¨<strong>å¼€å‘è€…çš„å…¬é’¥</strong>æ¥éªŒè¯<strong>ç­¾å</strong>å¯¹äºå®ƒåˆšåˆšç®—å‡ºçš„<code>actual_mrenclave</code>æ˜¯å¦æœ‰æ•ˆã€‚</li></ol><p>å¦‚æœéªŒè¯å¤±è´¥ï¼Œæ„å‘³ç€Enclaveä»£ç è¢«ç¯¡æ”¹æˆ–ç­¾åæ˜¯ä¼ªé€ çš„ï¼Œ<code>EINIT</code>å°†å¤±è´¥ï¼ŒEnclaveè¢«æ‹’ç»å¯åŠ¨ã€‚</p><p><strong>åŠ¨ä½œäºŒï¼šæˆäºˆèº«ä»½ (<code>MRSIGNER</code>)</strong></p><p><strong>åªæœ‰åœ¨ç­¾åéªŒè¯æˆåŠŸå</strong>ï¼ŒCPUç¡¬ä»¶æ‰ä¼šæ‰§è¡Œè¿™ä¸€æ­¥ï¼š</p><ol><li><strong>è®¡ç®—å“ˆå¸Œ</strong>: CPUç¡¬ä»¶æå–å‡ºåˆšåˆšç”¨äºéªŒè¯çš„é‚£ä¸ª<strong>å¼€å‘è€…å…¬é’¥</strong>ï¼Œå¹¶è®¡ç®—å…¶SHA-256å“ˆå¸Œå€¼ã€‚</li><li><strong>æˆäºˆèº«ä»½</strong>: è¿™ä¸ªå“ˆå¸Œç»“æœï¼Œå°±æ˜¯<code>MRSIGNER</code>ã€‚CPUç¡¬ä»¶ä¼šå°†å…¶æƒå¨åœ°è®°å½•åœ¨Enclaveçš„æ§åˆ¶ç»“æ„ï¼ˆSECSï¼‰ä¸­ã€‚</li></ol><p>**<code>MRSIGNER</code>ä»£è¡¨äº†è¿™ä¸ªEnclaveçš„â€ç­¾å‘æœºæ„â€æˆ–â€è¡€ç»Ÿâ€**ã€‚å®ƒè¯æ˜äº†è¿™ä¸ªEnclaveç¡®å®æ˜¯ç”±è¯¥å…¬é’¥çš„æŒæœ‰è€…æ‰€æ‹…ä¿çš„ã€‚</p><hr><h4 id="d-æ·±åº¦è§£æï¼šä¸ºä½•éœ€è¦MRSIGNERï¼Ÿ"><a href="#d-æ·±åº¦è§£æï¼šä¸ºä½•éœ€è¦MRSIGNERï¼Ÿ" class="headerlink" title="d) æ·±åº¦è§£æï¼šä¸ºä½•éœ€è¦MRSIGNERï¼Ÿ"></a>d) æ·±åº¦è§£æï¼šä¸ºä½•éœ€è¦MRSIGNERï¼Ÿ</h4><p>ä¸€ä¸ªç²¾å‡†çš„é—®é¢˜æ˜¯ï¼šæ—¢ç„¶CPUå·²ç»ç”¨å®Œæ•´çš„å…¬é’¥å®Œæˆäº†éªŒè¯å·¥ä½œï¼Œä¸ºä»€ä¹ˆè¿˜è¦å¤šæ­¤ä¸€ä¸¾ï¼Œè®¡ç®—å¹¶ä¿å­˜è¿™ä¸ªå…¬é’¥çš„å“ˆå¸Œå€¼ï¼ˆ<code>MRSIGNER</code>ï¼‰å‘¢ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯ï¼š<strong>å› ä¸ºå¼€å‘è€…å…¬é’¥å’Œ<code>MRSIGNER</code>ï¼Œè™½ç„¶æºè‡ªä¸€ä½“ï¼Œä½†ç”¨é€”å®Œå…¨ä¸åŒã€‚</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left"><strong>å¼€å‘è€…å…¬é’¥ (Public Key)</strong></th><th align="left"><strong>MRSIGNER</strong></th></tr></thead><tbody><tr><td align="left"><strong>è§’è‰²</strong></td><td align="left"><strong>éªŒè¯å·¥å…·</strong> ğŸ› ï¸</td><td align="left"><strong>èº«ä»½æ ‡ç­¾</strong> ğŸ·ï¸</td></tr><tr><td align="left"><strong>æœ¬è´¨</strong></td><td align="left">ä¸€ä¸ªåºå¤§ã€å¤æ‚çš„éå¯¹ç§°å¯†é’¥ç»“æ„ (e.g., 384å­—èŠ‚)</td><td align="left">ä¸€ä¸ªçŸ­å°ã€å›ºå®šçš„å“ˆå¸Œå€¼ (32å­—èŠ‚)</td></tr><tr><td align="left"><strong>ç”Ÿå‘½å‘¨æœŸ</strong></td><td align="left">ä»…åœ¨<code>EINIT</code>æŒ‡ä»¤æ‰§è¡Œçš„ç¬é—´ï¼Œè¢«ç¡¬ä»¶ç”¨æ¥éªŒè¯ç­¾åã€‚</td><td align="left">åœ¨<code>EINIT</code>æ—¶è¢«åˆ›å»ºï¼Œå¹¶ä¼´éšEnclaveçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸã€‚</td></tr><tr><td align="left"><strong>æ ¸å¿ƒç”¨é€”</strong></td><td align="left">1. éªŒè¯Enclaveç­¾åçš„çœŸå®æ€§ã€‚</td><td align="left">1. ä½œä¸ºå¼€å‘è€…èº«ä»½çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚<br>2. ç”¨äºè¿œç¨‹è®¤è¯ç­–ç•¥æ£€æŸ¥ã€‚<br>3. å®ç°æ•°æ®å¯†å°å’Œç‰ˆæœ¬å‡çº§ã€‚</td></tr></tbody></table><p><strong><code>MRSIGNER</code>ä½œä¸ºâ€èº«ä»½æ ‡ç­¾â€çš„æ ¸å¿ƒä»·å€¼ä½“ç°åœ¨ï¼š</strong></p><ol><li><strong>ä¾¿äºç®¡ç†çš„èº«ä»½æ ‡è¯†ç¬¦</strong>: åœ¨è¿œç¨‹è®¤è¯ä¸­ï¼ŒæœåŠ¡å™¨åªéœ€å­˜å‚¨ä¸€ä¸ªç®€çŸ­çš„<code>MRSIGNER</code>å“ˆå¸Œåˆ—è¡¨å³å¯è¿›è¡Œç­–ç•¥æ£€æŸ¥ï¼Œè¿œæ¯”ç®¡ç†åºå¤§çš„å…¬é’¥é«˜æ•ˆã€‚</li><li><strong>å®ç°å®‰å…¨çš„æ•°æ®ç‰ˆæœ¬å‡çº§ï¼ˆæ•°æ®å¯†å° Sealingï¼‰</strong>:<ul><li>SGXå…è®¸Enclaveå‘CPUç”³è¯·ä¸€ä¸ªä¸è‡ªèº«èº«ä»½ç»‘å®šçš„åŠ å¯†å¯†é’¥(<code>EGETKEY</code>)ï¼Œç”¨äºå°†æ•°æ®â€å¯†å°â€åˆ°ç¡¬ç›˜ä¸Šã€‚</li><li><strong>å¯†å°åˆ°<code>MRENCLAVE</code></strong>: åªæœ‰ä»£ç å®Œå…¨ç›¸åŒçš„Enclaveæ‰èƒ½è§£å¯†ã€‚è¿™æ„å‘³ç€Enclaveç‰ˆæœ¬æ›´æ–°åï¼Œæ— æ³•è¯»å–æ—§æ•°æ®ã€‚</li><li><strong>å¯†å°åˆ°<code>MRSIGNER</code></strong>: åªè¦æ˜¯ç”±<strong>åŒä¸€ä¸ªå¼€å‘è€…</strong>ï¼ˆæ‹¥æœ‰åŒä¸€ä¸ªç­¾åç§é’¥ï¼‰ç­¾åçš„Enclaveï¼Œæ— è®ºç‰ˆæœ¬å¦‚ä½•ï¼Œéƒ½èƒ½è·å–åˆ°ç›¸åŒçš„å¯†é’¥ã€‚è¿™å°±å®Œç¾åœ°è§£å†³äº†ç‰ˆæœ¬å‡çº§æ—¶çš„æ•°æ®è¿ç§»é—®é¢˜ã€‚</li></ul></li><li><strong>ç®€åŒ–ç¡¬ä»¶è®¾è®¡</strong>: å¯¹CPUç¡¬ä»¶è€Œè¨€ï¼Œåœ¨Enclaveå¯åŠ¨åï¼Œç”¨ä¸€ä¸ªå›ºå®šé•¿åº¦çš„å“ˆå¸Œå€¼æ¥ä»£è¡¨å¼€å‘è€…èº«ä»½ï¼Œè¿œæ¯”å¤„ç†ä¸€ä¸ªå¤æ‚å…¬é’¥è¦ç®€å•é«˜æ•ˆã€‚</li></ol><hr><h4 id="e-æˆ‘èƒ½ä¼ªé€ MRSIGNERå—ï¼Ÿ"><a href="#e-æˆ‘èƒ½ä¼ªé€ MRSIGNERå—ï¼Ÿ" class="headerlink" title="e) æˆ‘èƒ½ä¼ªé€ MRSIGNERå—ï¼Ÿ"></a>e) æˆ‘èƒ½ä¼ªé€ MRSIGNERå—ï¼Ÿ</h4><p>ç­”æ¡ˆæ˜¯ï¼š<strong>ç»å¯¹ä¸èƒ½ã€‚</strong></p><p>è¿™ä¸ªæœºåˆ¶çš„ç²¾å¦™ä¹‹å¤„åœ¨äºä¸€ä¸ªæ— æ³•ç ´è§£çš„å¯†ç å­¦é—­ç¯ã€‚è®©æˆ‘ä»¬ç”¨ä¸€ä¸ªæ¯”å–»æ¥è§£é‡Šï¼š</p><ul><li><strong>MRENCLAVE</strong>: ä½ çš„<strong>è¯ä»¶ç…§ç‰‡</strong>ã€‚</li><li><strong>MRSIGNER</strong>: è¯ä»¶ä¸Šçš„<strong>ç­¾å‘æœºå…³</strong>ï¼Œæ¯”å¦‚â€ä¸­åäººæ°‘å…±å’Œå›½å¤–äº¤éƒ¨â€ã€‚</li><li><strong>å¼€å‘è€…çš„å…¬é’¥</strong>: ç­¾å‘æœºå…³çš„<strong>å®˜æ–¹å…¬ç« æ¨¡æ¿</strong>ã€‚</li><li><strong>ç­¾å</strong>: ç›–åœ¨ç…§ç‰‡ä¸Šçš„é‚£ä¸ªçº¢è‰²çš„ã€é˜²ä¼ªçš„<strong>å®˜æ–¹é’¢å°</strong>ã€‚</li><li><strong>CPUç¡¬ä»¶ (<code>EINIT</code>)</strong>: ä¸€ä¸ä¸è‹Ÿçš„<strong>æµ·å…³è¾¹æ£€å®˜</strong>ã€‚</li></ul><p>ä¸€ä¸ªæ”»å‡»è€…å¯ä»¥å°è¯•å¦‚ä¸‹ä¼ªé€ ï¼š</p><ol><li><strong>ä½ çš„ç›®æ ‡</strong>: ä½ åˆ›å»ºäº†ä¸€ä¸ªæ¶æ„Enclaveï¼ˆä¸€å¼ æ–°çš„<strong>è¯ä»¶ç…§ç‰‡</strong>ï¼‰ï¼Œæƒ³è®©å®ƒçš„ç­¾å‘æœºå…³å˜æˆâ€ä¸­åäººæ°‘å…±å’Œå›½å¤–äº¤éƒ¨â€ï¼ˆå¾—åˆ°Intelçš„<code>MRSIGNER</code>ï¼‰ã€‚</li><li><strong>ä½ çš„è¡ŒåŠ¨</strong>: ä½ å¿…é¡»å‘è¾¹æ£€å®˜ï¼ˆCPUï¼‰å‡ºç¤ºå¤–äº¤éƒ¨çš„<strong>å…¬ç« æ¨¡æ¿</strong>ï¼ˆIntelçš„å…¬é’¥ï¼‰ï¼Œè¾¹æ£€å®˜æ‰ä¼šè®¤å¯è¿™ä¸ªç­¾å‘æœºå…³ã€‚</li><li><strong>è‡´å‘½æ‚–è®º</strong>: è¾¹æ£€å®˜åœ¨è®¤å¯ç­¾å‘æœºå…³åï¼Œä¼šç«‹å³ä½¿ç”¨è¿™ä¸ªå…¬ç« æ¨¡æ¿å»æ ¸å¯¹ç›–åœ¨ä½ ç…§ç‰‡ä¸Šçš„é‚£ä¸ª<strong>é’¢å°</strong>ï¼ˆç”¨å…¬é’¥éªŒè¯ç­¾åï¼‰ã€‚ä½†ä½ å¹¶æ²¡æœ‰å¤–äº¤éƒ¨çš„å®˜æ–¹é’¢å°ï¼ˆIntelçš„ç§é’¥ï¼‰ï¼Œä½ åªæœ‰ä¸€ä¸ªèåœåˆ»çš„å‡ç« ï¼ˆç”¨ä½ è‡ªå·±çš„ç§é’¥ç”Ÿæˆçš„ç­¾åï¼‰ã€‚</li><li><strong>æœ€ç»ˆç»“æœ</strong>: è¾¹æ£€å®˜å‘ç°é’¢å°ä¸åŒ¹é…ï¼Œä½ çš„è¯ä»¶è¢«æ²¡æ”¶ï¼Œä½ è¢«æ‹’ç»å…¥å¢ƒï¼ˆEnclaveå¯åŠ¨å¤±è´¥ï¼‰ã€‚</li></ol><p><strong>ç»“è®º</strong>: ä½ æ— æ³•åœ¨å†’ç”¨ä»–äººå…¬é’¥çš„åŒæ—¶ï¼Œè¿˜èƒ½æä¾›ä¸€ä¸ªèƒ½è¢«è¯¥å…¬é’¥éªŒè¯çš„ã€å¯¹è‡ªå·±ä»£ç çš„æœ‰æ•ˆç­¾åã€‚è¿™ä¸ªå¯†ç å­¦é—­ç¯ï¼Œä¿è¯äº†<code>MRSIGNER</code>çš„ä¸å¯ä¼ªé€ æ€§ã€‚</p><h2 id="äºŒã€æ ¸å¿ƒç¡¬ä»¶ä¸ç»„ä»¶è§£æ"><a href="#äºŒã€æ ¸å¿ƒç¡¬ä»¶ä¸ç»„ä»¶è§£æ" class="headerlink" title="äºŒã€æ ¸å¿ƒç¡¬ä»¶ä¸ç»„ä»¶è§£æ"></a>äºŒã€æ ¸å¿ƒç¡¬ä»¶ä¸ç»„ä»¶è§£æ</h2><p>ä¸ºäº†å®ç°å°† TCB ç¼©å°åˆ°ä»…å‰© CPU çš„ç›®æ ‡ï¼ŒIntel åœ¨å…¶å¤„ç†å™¨ä¸­é›†æˆäº†ä¸€ç³»åˆ—ä¸“é—¨çš„ç¡¬ä»¶å•å…ƒå’Œæœºåˆ¶ã€‚ç†è§£è¿™äº›ç»„ä»¶æ˜¯è§£å¼€ SGX å·¥ä½œåŸç†çš„é’¥åŒ™ã€‚</p><h3 id="2-1-PRM-EPC"><a href="#2-1-PRM-EPC" class="headerlink" title="2.1 PRM &amp; EPC"></a>2.1 PRM &amp; EPC</h3><p><strong>PRM</strong> (Processor Reserved Memory) ï¼š<strong>å¤„ç†å™¨é¢„ç•™å†…å­˜</strong>ã€‚é¦–å…ˆï¼ŒCPU ä¼šè¦æ±‚ BIOS åœ¨ç‰©ç†å†…å­˜ä¸­åˆ’å‡ºä¸€å—ä¸“é—¨çš„åŒºåŸŸï¼Œè¿™å—åŒºåŸŸè¢«ç§°ä¸º PRMã€‚è¿™å—å†…å­˜å¯¹äº CPU æ¥è¯´æ˜¯â€å¯è§â€çš„ï¼Œä½†æ˜¯å¯¹äºå¤–éƒ¨è®¾å¤‡ï¼ˆå¦‚ç½‘å¡ã€æ˜¾å¡ï¼‰é€šè¿‡ DMAï¼ˆç›´æ¥å†…å­˜è®¿é—®ï¼‰æ˜¯ä¸å¯è§çš„ã€‚PRM æ˜¯ SGX å®‰å…¨å†…å­˜çš„â€åœŸå£¤â€ã€‚</p><blockquote><p>è¿™ä¸ªç‰©ç†å†…å­˜è¿˜æ˜¯DRAMï¼Œå°±æ˜¯å†…å­˜æ¡ã€‚æˆ‘ä¸€å¼€å§‹ä»¥ä¸ºæ˜¯ CPUå†…å•ç‹¬çš„ä¸€å—ç¡¬ä»¶ã€‚</p></blockquote><p><strong>EPC</strong> (Enclave Page Cache)ï¼š<strong>Enclave é¡µé¢ç¼“å­˜</strong>ã€‚PRM è¿™å—â€åœŸå£¤â€é‡ŒçœŸæ­£ç”Ÿé•¿ä½œç‰©çš„åŒºåŸŸå°±æ˜¯ EPCã€‚EPC ç”±ä¸€ç³»åˆ— 4KB å¤§å°çš„ç‰©ç†å†…å­˜é¡µç»„æˆï¼Œå®ƒæ˜¯ <strong>Enclave ä»£ç å’Œæ•°æ®å®é™…å­˜æ”¾çš„åœ°æ–¹</strong>ã€‚å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆä¸€ä¸ªä¿é™©åº“ï¼ŒEnclave çš„æ‰€æœ‰èµ„äº§éƒ½å­˜æ”¾åœ¨è¿™é‡Œã€‚EPC çš„æ‰€æœ‰é¡µé¢éƒ½å—åˆ°ç¡¬ä»¶çº§åˆ«çš„åŠ å¯†å’Œå®Œæ•´æ€§ä¿æŠ¤ã€‚</p><h3 id="2-2-MEE"><a href="#2-2-MEE" class="headerlink" title="2.2 MEE"></a>2.2 MEE</h3><p><strong>MEE</strong> (Memory Encryption Engine)ï¼š<strong>å†…å­˜åŠ å¯†å¼•æ“</strong>ï¼Œè¿™æ˜¯ SGX çš„â€å®ˆæŠ¤ç¥â€ã€‚å½“ CPU éœ€è¦å°†æ•°æ®ä»å…¶å†…éƒ¨ç¼“å­˜å†™å…¥åˆ° EPC æ—¶ï¼ŒMEE ä¼šè‡ªåŠ¨å¯¹å…¶è¿›è¡Œ<strong>åŠ å¯†</strong>ï¼›å½“ CPU éœ€è¦ä» EPC è¯»å–æ•°æ®åˆ°ç¼“å­˜æ—¶ï¼ŒMEE åˆä¼šè‡ªåŠ¨è¿›è¡Œ<strong>è§£å¯†</strong>ã€‚</p><p>è¿™ä¸ªè¿‡ç¨‹å¯¹ç¨‹åºæ˜¯å®Œå…¨é€æ˜çš„ã€‚å®ƒçš„æ ¸å¿ƒä½œç”¨æ˜¯é˜²å¾¡<strong>ç‰©ç†æ”»å‡»</strong>ã€‚å³ä½¿æ”»å‡»è€…æŠŠå†…å­˜æ¡æ‹”ä¸‹æ¥ï¼Œæˆ–è€…ä½¿ç”¨ç‰¹æ®Šè®¾å¤‡æ¢æµ‹å†…å­˜æ€»çº¿ï¼Œä»–ä»¬èƒ½çœ‹åˆ°çš„ä¹Ÿåªæ˜¯ä¸€å †æ¯«æ— æ„ä¹‰çš„åŠ å¯†æ•°æ®ã€‚MEE ç¡®ä¿äº†æ•°æ®ä¸€æ—¦ç¦»å¼€ CPU çš„æ ¸å¿ƒï¼Œå°±æ˜¯ç»è¿‡åŠ å¯†çš„ã€‚</p><h3 id="2-3-SECS"><a href="#2-3-SECS" class="headerlink" title="2.3 SECS"></a>2.3 SECS</h3><p><strong>SECS</strong> (SGX Enclave Control Structure)ï¼š<strong>SGX Enclave æ§åˆ¶ç»“æ„</strong>ã€‚å¦‚æœè¯´ EPC æ˜¯ä¿é™©åº“ï¼Œé‚£ä¹ˆ SECS å°±æ˜¯è¿™ä¸ªä¿é™©åº“çš„<strong>æ€»å°è´¦å’Œæ§åˆ¶å™¨</strong>ã€‚æ¯ä¸ª Enclave åœ¨ EPC ä¸­éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ã€ä¸ä¹‹å¯¹åº”çš„ SECS ç»“æ„ã€‚</p><p><strong>ä½œç”¨</strong>ï¼šå®ƒæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ã€å—ç¡¬ä»¶ä¸¥æ ¼ä¿æŠ¤çš„æ•°æ®ç»“æ„ï¼Œè®°å½•äº†è¯¥ Enclave çš„æ‰€æœ‰å…ƒæ•°æ®å’ŒçŠ¶æ€ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š</p><ul><li>Enclave çš„å¤§å°ã€‚</li><li>Enclave çš„å®‰å…¨å±æ€§ï¼ˆå¦‚æ˜¯å¦å…è®¸è¢«è°ƒè¯•ï¼‰ã€‚</li><li>Enclave çš„â€èº«ä»½æ ‡è¯†â€ï¼ˆæˆ‘ä»¬ç¨åä¼šè®²åˆ°çš„ MRENCLAVE å’Œ MRSIGNERï¼‰ã€‚</li><li>Enclave çš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€ï¼ˆä¾‹å¦‚ï¼Œæ­£åœ¨åˆ›å»ºã€å·²åˆå§‹åŒ–ã€æ­£åœ¨è¿è¡Œç­‰ï¼‰ã€‚</li><li><strong>SECS æ˜¯ Enclave ç®¡ç†çš„æ¢çº½ï¼Œä»»ä½•å¯¹ Enclave çš„æ“ä½œï¼ˆå¦‚æ·»åŠ å†…å­˜ã€åˆå§‹åŒ–ï¼‰éƒ½å¿…é¡»å…ˆé€šè¿‡ SECS çš„æ£€æŸ¥å’Œè®°å½•ã€‚</strong></li></ul><h3 id="2-4-EPCM"><a href="#2-4-EPCM" class="headerlink" title="2.4 EPCM"></a>2.4 EPCM</h3><p>EPCM (Enclave Page Cache Map)ï¼šEnclave é¡µé¢ç¼“å­˜åœ°å›¾ã€‚å¦‚æœ EPC æ˜¯ä¿é™©åº“é‡Œçš„ä¸€æ’æ’ä¿é™©æŸœï¼ˆå†…å­˜é¡µï¼‰ï¼Œé‚£ä¹ˆ EPCM å°±æ˜¯<strong>è®°å½•æ¯ä¸ªä¿é™©æŸœå½’å±å’Œæƒé™çš„åœ°å›¾</strong>ã€‚</p><p><strong>ä½œç”¨</strong>ï¼šEPCM æ˜¯ä¸€ä¸ªå—ç¡¬ä»¶ä¿æŠ¤çš„ã€å­˜åœ¨äº CPU å†…éƒ¨çš„æ•°æ®ç»“æ„ã€‚å®ƒä¸º EPC ä¸­çš„æ¯ä¸€ä¸ª 4KB é¡µé¢éƒ½ç»´æŠ¤ä¸€ä¸ªæ¡ç›®ï¼Œè¯¦ç»†è®°å½•äº†ï¼š</p><ul><li><strong>è¿™ä¸ªé¡µé¢å±äºå“ªä¸ª Enclave</strong>ï¼ˆé€šè¿‡æŒ‡å‘å¯¹åº”çš„ SECSï¼‰ã€‚</li><li><strong>è¿™ä¸ªé¡µé¢çš„ç±»å‹</strong>ï¼ˆæ˜¯ SECS æœ¬èº«ï¼Œè¿˜æ˜¯å­˜æ”¾ä»£ç &#x2F;æ•°æ®çš„æ™®é€šé¡µï¼Œæˆ–æ˜¯ç”¨äºçº¿ç¨‹ç®¡ç†çš„ TCS é¡µç­‰ï¼‰ã€‚</li><li><strong>è¿™ä¸ªé¡µé¢çš„è®¿é—®æƒé™</strong>ï¼ˆè¯»ã€å†™ã€æ‰§è¡Œæƒé™ï¼‰ã€‚</li><li><strong>è¿™ä¸ªé¡µé¢æ˜¯å¦å·²ç»è¢«éªŒè¯å’ŒåŠ è½½</strong>ã€‚</li></ul><p><strong>æ ¸å¿ƒå®‰å…¨æœºåˆ¶</strong>ï¼šä»»ä½•å¯¹ EPC å†…å­˜çš„è®¿é—®ï¼ŒCPU éƒ½ä¼š<strong>å¼ºåˆ¶æŸ¥è¯¢ EPCM</strong>ã€‚å¦‚æœä¸€ä¸ªç¨‹åºè¯•å›¾è®¿é—®ä¸€ä¸ªå®ƒæ— æƒè®¿é—®çš„ EPC é¡µé¢ï¼ˆä¾‹å¦‚ï¼ŒOS è¯•å›¾è¯»å– Enclave çš„æ•°æ®é¡µï¼Œæˆ–è€… Enclave A è¯•å›¾è®¿é—® Enclave B çš„é¡µé¢ï¼‰ï¼ŒCPU ä¼šåœ¨ç¡¬ä»¶å±‚é¢ç›´æ¥æ‹’ç»è¯¥è®¿é—®å¹¶è§¦å‘å¼‚å¸¸ã€‚<strong>EPCM æ˜¯å®ç° Enclave ä¹‹é—´ä»¥åŠ Enclave ä¸å¤–éƒ¨ä¸–ç•Œéš”ç¦»çš„æ ¹æœ¬ä¿è¯ã€‚</strong></p><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    %% CPUå†…éƒ¨ç»„ä»¶    MEE[MEE å†…å­˜åŠ å¯†å¼•æ“]    EPCM[EPCM åœ°å›¾]    CPU_Cache[CPU ç¼“å­˜]        %% ç‰©ç†å†…å­˜ç»“æ„    PRM[PRM å¤„ç†å™¨é¢„ç•™å†…å­˜]    EPC[EPC å®‰å…¨é¡µé¢ç¼“å­˜]        %% Enclaveå†…å­˜ç»„ç»‡    SECS_A[SECS for Enclave A]    Page_A1[Page 1 for A]    Page_A2[Page 2 for A]        SECS_B[SECS for Enclave B]     Page_B1[Page 1 for B]        %% è¿æ¥å…³ç³»    CPU_Cache &lt;--&gt;|æ˜æ–‡æ•°æ®| MEE    MEE &lt;--&gt;|å¯†æ–‡æ•°æ®| EPC        EPCM --&gt;|æƒé™æ ¡éªŒ| EPC    SECS_A --&gt; Page_A1    SECS_A --&gt; Page_A2    SECS_B --&gt; Page_B1        %% åˆ†ç»„è¯´æ˜ï¼ˆå…¼å®¹æ€§å†™æ³•ï¼‰    classDef cpu fill:#87ceeb,stroke:#333;    classDef enclave fill:#90ee90,stroke:#2e8b57;    class MEE,EPCM,CPU_Cache cpu;    class SECS_A,SECS_B,Page_A1,Page_A2,Page_B1 enclave;        %% è™šæ‹Ÿåˆ†ç»„ï¼ˆé€šè¿‡æ³¨é‡Šå®ç°ï¼‰    %% CPUå†…éƒ¨:::     %% MEE&#x2F;EPCM&#x2F;CPU_Cacheå±äºCPU    %%     %% PRMåŒºåŸŸ:::    %% EPCå±äºPRM  </pre></div><h2 id="ä¸‰ã€SGXå·¥ä½œåŸç†ä¸å†…éƒ¨æµç¨‹"><a href="#ä¸‰ã€SGXå·¥ä½œåŸç†ä¸å†…éƒ¨æµç¨‹" class="headerlink" title="ä¸‰ã€SGXå·¥ä½œåŸç†ä¸å†…éƒ¨æµç¨‹"></a>ä¸‰ã€SGXå·¥ä½œåŸç†ä¸å†…éƒ¨æµç¨‹</h2><p>äº†è§£äº†é™æ€çš„ç¡¬ä»¶ç»„ä»¶åï¼Œæˆ‘ä»¬ç°åœ¨æ¥æ¢è®¨ SGX çš„åŠ¨æ€è¡Œä¸ºã€‚è¿™éƒ¨åˆ†å°†èšç„¦äºä¸€ä¸ª Enclave æ˜¯å¦‚ä½•è¢«åˆ›å»ºã€æ‰§è¡Œã€å¹¶æœ€ç»ˆè¢«é”€æ¯çš„ï¼Œä»¥åŠè¿™ä¸ªè¿‡ç¨‹ä¸­æ¶‰åŠåˆ°çš„å…³é”®æŒ‡ä»¤å’Œå®‰å…¨æœºåˆ¶ã€‚</p><h3 id="3-1-Enclave-çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†"><a href="#3-1-Enclave-çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†" class="headerlink" title="3.1 Enclave çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†"></a>3.1 Enclave çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†</h3><p>ä¸€ä¸ª Enclave çš„ç”Ÿå‘½å‘¨æœŸç”±ä¸€ç³»åˆ—å®šä¹‰æ˜ç¡®çš„çŠ¶æ€å’Œè½¬æ¢æ„æˆï¼Œè¿™äº›éƒ½ç”± SGX ç¡¬ä»¶æŒ‡ä»¤ä¸¥æ ¼æ§åˆ¶ã€‚ä¸å¯ä¿¡çš„æ“ä½œç³»ç»Ÿï¼ˆå¦‚ Windows æˆ– Linuxï¼‰æ‰®æ¼”ç€èµ„æºç®¡ç†å‘˜çš„è§’è‰²ï¼Œè´Ÿè´£åˆ†é…å†…å­˜ï¼Œä½†å®ƒæ— æ³•å¹²é¢„ Enclave çš„å†…éƒ¨çŠ¶æ€è½¬æ¢ï¼Œåªèƒ½â€å¬ä»â€ç¡¬ä»¶çš„æŒ‡ä»¤æ¥æ‰§è¡Œæ“ä½œã€‚ä»¥ä¸‹æ˜¯ Enclave ç”Ÿå‘½å‘¨æœŸæœ€æ ¸å¿ƒçš„å‡ ä¸ªé˜¶æ®µï¼š</p><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    subgraph &quot;ä¸å¯ä¿¡åŒºåŸŸ (ç”±OS&#x2F;Appæ“ä½œ)&quot;        A[å¼€å§‹] --&gt; B(1. åˆ›å»º Enclave&lt;br&gt;EGETKEY &#x2F; ECREATE);        B --&gt; C(2. åŠ è½½ä»£ç ä¸æ•°æ®&lt;br&gt;EADD &#x2F; EEXTEND);        C --&gt; D(3. åˆå§‹åŒ– Enclave&lt;br&gt;EINIT);    end    subgraph &quot;å¯ä¿¡åŒºåŸŸ (Enclaveå†…éƒ¨æ‰§è¡Œ)&quot;        D --&gt; E{Enclave æ˜¯å¦åœ¨è¿è¡Œ?};        E -- æ˜¯ --&gt; F(4. è¿›å…¥&#x2F;æ¢å¤æ‰§è¡Œ&lt;br&gt;EENTER &#x2F; ERESUME);        F --&gt; G{å‘ç”Ÿä¸­æ–­&#x2F;è°ƒç”¨å¤–éƒ¨å‡½æ•°?};        G -- æ˜¯ --&gt; H(5. é€€å‡º Enclave&lt;br&gt;EEXIT);        H --&gt; E;    end        E -- å¦ --&gt; I(6. é”€æ¯ Enclave&lt;br&gt;EREMOVE);    I --&gt; J[ç»“æŸ];    style D fill:#90ee90    style F fill:#90ee90  </pre></div><h4 id="é˜¶æ®µ-1-åˆ›å»º-Creation-ECREATE"><a href="#é˜¶æ®µ-1-åˆ›å»º-Creation-ECREATE" class="headerlink" title="é˜¶æ®µ 1: åˆ›å»º (Creation) - ECREATE"></a>é˜¶æ®µ 1: åˆ›å»º (Creation) - <code>ECREATE</code></h4><ol><li><strong>å‘èµ·è€…</strong>ï¼šç”¨æˆ·çš„åº”ç”¨ç¨‹åºï¼ˆAppï¼‰é€šè¿‡ SGX é©±åŠ¨å‘ OS å‘å‡ºè¯·æ±‚ã€‚</li><li><strong>OS æ“ä½œ</strong>ï¼šOS åœ¨ç‰©ç†å†…å­˜ä¸­åˆ†é…ä¸€å— EPC é¡µé¢ã€‚</li><li><strong>CPU æŒ‡ä»¤</strong>ï¼šCPU æ‰§è¡Œ <code>ECREATE</code> æŒ‡ä»¤ã€‚</li><li><strong>ç¡¬ä»¶è¡Œä¸º</strong>ï¼š<ul><li>CPU å°†è¿™å— EPC é¡µé¢åˆå§‹åŒ–ä¸ºè¯¥ Enclave çš„ <strong>SECSï¼ˆSGX Enclave æ§åˆ¶ç»“æ„ï¼‰</strong>ã€‚</li><li>SECS ä¸­ä¼šè®°å½•ä¸€äº›åŸºç¡€ä¿¡æ¯ï¼Œæ¯”å¦‚ Enclave çš„å®‰å…¨å±æ€§ï¼ˆç”±å¼€å‘è€…å®šä¹‰ï¼‰ã€åŸºåœ°å€å’Œå¤§å°èŒƒå›´ç­‰ã€‚</li><li>æ­¤æ—¶ï¼ŒEnclave å¤„äºâ€åˆ›å»ºä¸­â€çŠ¶æ€ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªç©ºçš„æ¡†æ¶ï¼Œé‡Œé¢æ²¡æœ‰ä»»ä½•ä»£ç å’Œæ•°æ®ã€‚</li><li><code>ECREATE</code>è¿˜ä¼šç”Ÿæˆä¸€ä¸ªç”¨äºåç»­éªŒè¯çš„ <code>ECREATE</code> å¯†é’¥ã€‚</li></ul></li></ol><h4 id="é˜¶æ®µ-2-åŠ è½½ä»£ç ä¸æ•°æ®-Content-Loading-EADD-EEXTEND"><a href="#é˜¶æ®µ-2-åŠ è½½ä»£ç ä¸æ•°æ®-Content-Loading-EADD-EEXTEND" class="headerlink" title="é˜¶æ®µ 2: åŠ è½½ä»£ç ä¸æ•°æ® (Content Loading) - EADD &amp; EEXTEND"></a>é˜¶æ®µ 2: åŠ è½½ä»£ç ä¸æ•°æ® (Content Loading) - <code>EADD</code> &amp; <code>EEXTEND</code></h4><ol><li><p><strong>å‘èµ·è€…</strong>ï¼šåº”ç”¨ç¨‹åºã€‚</p></li><li><p><strong>OS æ“ä½œ</strong>ï¼šæ ¹æ®åº”ç”¨ç¨‹åºçš„è¯·æ±‚ï¼Œç»§ç»­åˆ†é… EPC é¡µé¢ç”¨äºå­˜æ”¾ä»£ç å’Œæ•°æ®ã€‚</p></li><li><p><strong>CPU æŒ‡ä»¤</strong>ï¼š</p><ul><li><code>EADD</code>ï¼šç”± CPU æ‰§è¡Œï¼Œå°†ä¸€ä¸ªæ™®é€šçš„å†…å­˜é¡µé¢ï¼ˆåŒ…å«å¼€å‘è€…çš„ä»£ç æˆ–æ•°æ®ï¼‰çš„å†…å®¹<strong>æ‹·è´</strong>åˆ°æ–°åˆ†é…çš„ EPC é¡µé¢ä¸­ï¼Œå¹¶æ ¹æ® SECS ä¸­è®¾å®šçš„ç›®æ ‡åœ°å€ï¼Œæ›´æ–°é¡µè¡¨ï¼Œå»ºç«‹æ˜ å°„å…³ç³»ã€‚åŒæ—¶ï¼ŒEPCM ä¼šè®°å½•ä¸‹è¿™ä¸ªé¡µé¢çš„å½’å±å’Œæƒé™ï¼ˆå¦‚ä»£ç é¡µè®¾ä¸ºè¯»&#x2F;æ‰§è¡Œï¼Œæ•°æ®é¡µè®¾ä¸ºè¯»&#x2F;å†™ï¼‰ã€‚</li><li><code>EEXTEND</code>ï¼šè¿™æ˜¯<strong>ä¿éšœåŠ è½½è¿‡ç¨‹å®‰å…¨æ€§çš„æ ¸å¿ƒæŒ‡ä»¤</strong>ã€‚æ¯å½“ä¸€ä¸ªé¡µé¢è¢« <code>EADD</code> æ·»åŠ è¿›æ¥åï¼ŒCPU å°±ä¼šæ‰§è¡Œ <code>EEXTEND</code> æŒ‡ä»¤ï¼Œå°†è¿™ä¸ªé¡µé¢çš„å†…å®¹ï¼ˆ256å­—èŠ‚ä¸ºä¸€å—ï¼‰é€å…¥ä¸€ä¸ªä¸“é—¨çš„ SHA-256 å¯†ç å­¦ç´¯åŠ å™¨ä¸­è¿›è¡Œâ€<strong>æµ‹é‡</strong>â€œ(Measure)ã€‚</li></ul></li><li><p><strong>ç¡¬ä»¶è¡Œä¸º</strong>ï¼š</p><ul><li><p><code>EEXTEND</code> ä¼šä¸æ–­æ›´æ–° SECS ä¸­ä¸€ä¸ªè¢«ç§°ä¸º <code>MRENCLAVE</code> çš„ç‰¹æ®Šå­—æ®µã€‚è¿™ä¸ªå­—æ®µæ˜¯æ•´ä¸ª Enclave æ‰€æœ‰ä»£ç å’Œæ•°æ®çš„å®Œæ•´æ€§åº¦é‡å€¼</p><ul><li><p>è®¡ç®—åˆšåˆšåŠ è½½è¿›æ¥çš„é‚£ä¸€é¡µå†…å­˜çš„SHA-256å“ˆå¸Œå€¼ã€‚</p></li><li><p>å°†è¿™ä¸ªå“ˆå¸Œå€¼ï¼Œä¸ä¸€ä¸ªç‰¹æ®Šçš„ã€ä¿å­˜åœ¨SECSä¸­çš„åº¦é‡å¯„å­˜å™¨ï¼ˆMRENCLAVEå¯„å­˜å™¨ï¼‰çš„å½“å‰å€¼ï¼Œåˆå¹¶èµ·æ¥å†ç®—ä¸€æ¬¡å“ˆå¸Œã€‚</p></li><li><p>æ–°MRENCLAVE &#x3D; SHA256(æ—§MRENCLAVE + åˆšåˆšåŠ è½½é¡µçš„å“ˆå¸Œ)</p></li><li><p>è¿™ä¸ªè¿‡ç¨‹ä¼šä¸€ç›´æŒç»­ï¼Œç›´åˆ°æ‰€æœ‰ä»£ç å’Œæ•°æ®é¡µéƒ½è¢«åŠ è½½å®Œæ¯•ã€‚æœ€ç»ˆï¼ŒMRENCLAVEå¯„å­˜å™¨é‡Œçš„å€¼ï¼Œå°±æˆäº†æ•´ä¸ªEnclaveä»£ç å’Œæ•°æ®çš„å”¯ä¸€â€DNAæŒ‡çº¹â€ã€‚ä»»ä½•ä¸€é¡µå“ªæ€•ä¸€ä¸ªæ¯”ç‰¹çš„æ”¹åŠ¨ï¼Œéƒ½ä¼šå¯¼è‡´æœ€ç»ˆçš„MRENCLAVEå®Œå…¨ä¸åŒã€‚</p></li></ul></li><li><p><strong>å…³é”®ç‚¹</strong>ï¼šè¿™ä¸ªæµ‹é‡è¿‡ç¨‹æ˜¯åŸå­æ€§çš„ï¼Œç”±ç¡¬ä»¶ä¿è¯ã€‚ä»»ä½•å¯¹ä»£ç æˆ–æ•°æ®çš„ç¯¡æ”¹ï¼ˆå“ªæ€•åªä¿®æ”¹äº†ä¸€ä¸ªæ¯”ç‰¹ï¼‰ï¼Œæœ€ç»ˆç”Ÿæˆçš„ <code>MRENCLAVE</code> å€¼éƒ½ä¼šæˆªç„¶ä¸åŒã€‚è¿™å›ç­”äº†â€<strong>å¦‚ä½•ä¿è¯åŠ è½½è¿‡ç¨‹ä¸è¢«ç¯¡æ”¹</strong>â€œçš„æ ¸å¿ƒé—®é¢˜ã€‚</p></li></ul></li></ol><h4 id="é˜¶æ®µ-3-åˆå§‹åŒ–-Initialization-EINIT"><a href="#é˜¶æ®µ-3-åˆå§‹åŒ–-Initialization-EINIT" class="headerlink" title="é˜¶æ®µ 3: åˆå§‹åŒ– (Initialization) - EINIT"></a>é˜¶æ®µ 3: åˆå§‹åŒ– (Initialization) - <code>EINIT</code></h4><p><code>EINIT</code> æŒ‡ä»¤æ˜¯ Enclave ç”Ÿå‘½å‘¨æœŸçš„â€åŠ å†•å…¸ç¤¼â€ï¼Œæ˜¯å®ƒä»ä¸€ä¸ªâ€åŠæˆå“â€å˜ä¸ºâ€å¯ä¿¡å®ä½“â€çš„å†³å®šæ€§ä¸€æ­¥ã€‚å¯ä»¥æŠŠ <code>EINIT</code> æƒ³è±¡æˆä¸€ä¸ªæ— æ³•è¢«è½¯ä»¶å¹²é¢„çš„ã€ç”±CPUç¡¬ä»¶æ‰®æ¼”çš„â€ç»ˆææµ·å…³è¾¹æ£€å®˜â€ã€‚</p><ol><li><p><strong>å‘èµ·è€…</strong>ï¼šåº”ç”¨ç¨‹åºè¯·æ±‚æ‰§è¡Œ <code>EINIT</code>ï¼Œå¹¶å‘CPUæä¾›ä»Enclaveæ–‡ä»¶ä¸­è¯»å‡ºçš„<code>SIGSTRUCT</code>ï¼ˆâ€æ•°å­—å°æ¡â€ï¼‰ã€‚</p></li><li><p><strong>CPUç¡¬ä»¶è¡Œä¸º</strong>ï¼šCPUç¡¬ä»¶ä¼šæ‰§è¡Œä»¥ä¸‹ä¸¤ä¸ªæ ¸å¿ƒåŠ¨ä½œï¼Œå°†Enclaveçš„å®é™…å†…å®¹ (<code>MRENCLAVE</code>) ä¸å…¶å£°ç§°çš„ä½œè€… (<code>MRSIGNER</code>) ç‰¢ç‰¢åœ°ã€ä¸å¯ä¼ªé€ åœ°ç»‘å®šåœ¨ä¸€èµ·ã€‚</p><ul><li><p><strong>åŠ¨ä½œä¸€ï¼šéªŒè¯ç­¾å (éªŒè¯â€æ•°å­—å°æ¡â€çš„çœŸå®æ€§)</strong></p><ol><li><strong>æå–å‡­è¯</strong>: CPUç¡¬ä»¶ä»<code>SIGSTRUCT</code>ä¸­æå–å‡º<strong>å¼€å‘è€…çš„å…¬é’¥</strong>å’Œ<strong>ç­¾å</strong>ã€‚</li><li><strong>åŠ¨æ€è®¡ç®—</strong>: CPUç¡¬ä»¶æ ¹æ®å·²åŠ è½½åˆ°å†…å­˜ä¸­çš„ä»£ç ï¼Œç‹¬ç«‹è®¡ç®—å‡ºä¸€ä¸ª<code>actual_mrenclave</code>ã€‚</li><li><strong>å¯†ç å­¦éªŒè¯</strong>: è¿™æ˜¯æœ€å…³é”®çš„ä¸€ç¯ï¼CPUä½¿ç”¨<strong>å¼€å‘è€…çš„å…¬é’¥</strong>æ¥éªŒè¯<strong>ç­¾å</strong>å¯¹äºå®ƒåˆšåˆšç®—å‡ºçš„<code>actual_mrenclave</code>æ˜¯å¦æœ‰æ•ˆã€‚</li></ol></li><li><p><strong>åŠ¨ä½œäºŒï¼šæˆäºˆèº«ä»½ (<code>MRSIGNER</code>)</strong></p><ul><li><strong>åªæœ‰åœ¨ç­¾åéªŒè¯æˆåŠŸå</strong>ï¼ŒCPUç¡¬ä»¶æ‰ä¼šæ‰§è¡Œè¿™ä¸€æ­¥ã€‚</li><li>CPUç¡¬ä»¶æå–å‡ºåˆšåˆšç”¨äºéªŒè¯çš„é‚£ä¸ª<strong>å¼€å‘è€…å…¬é’¥</strong>ï¼Œå¹¶è®¡ç®—å…¶SHA-256å“ˆå¸Œå€¼ï¼Œè¿™ä¸ªç»“æœå°±æ˜¯<code>MRSIGNER</code>ã€‚</li><li>CPUç¡¬ä»¶å°†è¿™ä¸ª<code>MRSIGNER</code>æƒå¨åœ°è®°å½•åœ¨Enclaveçš„æ§åˆ¶ç»“æ„ï¼ˆSECSï¼‰ä¸­ã€‚</li></ul></li></ul></li><li><p><strong>æœ€ç»ˆè£å†³</strong>:</p><ul><li><strong>å¦‚æœç­¾åéªŒè¯æˆåŠŸ</strong>:<ul><li><code>EINIT</code>æˆåŠŸï¼ŒEnclaveæ­£å¼â€è¯ç”Ÿâ€ï¼Œå…¶ç”Ÿå‘½å‘¨æœŸçŠ¶æ€å˜ä¸ºâ€å·²åˆå§‹åŒ–â€ã€‚</li><li><strong>ä»æ­¤ä»¥åï¼ŒEnclave çš„å†…å®¹å°†ä¸å¯å†æ›´æ”¹</strong>ï¼Œ<code>EADD</code> å’Œ <code>EEXTEND</code> æŒ‡ä»¤å°†å¯¹æ­¤ Enclaveå¤±æ•ˆã€‚è¿™å›ºåŒ–äº† Enclave çš„èº«ä»½ã€‚</li><li>è¿™ä¸ªåŒ¹é…æˆåŠŸåŒæ—¶è¯æ˜äº†ï¼š<ul><li><strong>å®Œæ•´æ€§ (Integrity)</strong>: Enclaveä»è¢«å¼€å‘è€…ç­¾ååï¼Œåˆ°è¢«åŠ è½½è¿›å†…å­˜ï¼Œå…¶ä»£ç å’Œæ•°æ®ä¸€ä¸ªæ¯”ç‰¹éƒ½æ²¡æœ‰è¢«ç¯¡æ”¹è¿‡ã€‚</li><li><strong>çœŸå®æ€§ (Authenticity)</strong>: è¿™ä¸ªEnclaveç¡®å®æ˜¯ç”±<code>MRSIGNER</code>æ‰€ä»£è¡¨çš„å¼€å‘è€…ç­¾åçš„ã€‚</li></ul></li></ul></li><li><strong>å¦‚æœç­¾åéªŒè¯å¤±è´¥</strong>:<ul><li><code>EINIT</code>å¤±è´¥ï¼ŒEnclaveè¢«é”€æ¯ï¼Œç»å¯¹æ— æ³•è¿è¡Œã€‚</li></ul></li></ul></li></ol><blockquote><p><strong>å…³äº<code>EINITTOKEN</code></strong>: ç»†å¿ƒçš„è¯»è€…å¯èƒ½ä¼šåœ¨å®˜æ–¹æ–‡æ¡£ä¸­çœ‹åˆ°<code>EINITTOKEN</code>ã€‚è¿™æ˜¯ä¸€ä¸ªç”±ç‰¹æ®Šçš„â€è®¸å¯Enclaveâ€ç”Ÿæˆçš„ä»¤ç‰Œï¼Œç”¨äºç¡®ä¿åŠ è½½Enclaveçš„å¹³å°è½¯ä»¶æ ˆï¼ˆå¦‚SGXé©±åŠ¨ï¼‰æ˜¯åˆæ³•çš„ã€‚<code>EINIT</code>æŒ‡ä»¤åŒæ—¶ä¹Ÿä¼šéªŒè¯è¿™ä¸ªä»¤ç‰Œã€‚ä¸è¿‡ï¼Œä»ç†è§£Enclaveèº«ä»½éªŒè¯çš„æ ¸å¿ƒé€»è¾‘æ¥è¯´ï¼Œ<code>SIGSTRUCT</code>çš„éªŒè¯æ˜¯æ ¹æœ¬ï¼Œå®ƒä¿è¯äº†Enclaveå†…å®¹æœ¬èº«çš„å¯ä¿¡ã€‚</p></blockquote><h4 id="é˜¶æ®µ-4-5-è¿›å…¥ä¸é€€å‡º-Enter-Exit-EENTER-ERESUME-EEXIT"><a href="#é˜¶æ®µ-4-5-è¿›å…¥ä¸é€€å‡º-Enter-Exit-EENTER-ERESUME-EEXIT" class="headerlink" title="é˜¶æ®µ 4 &amp; 5: è¿›å…¥ä¸é€€å‡º (Enter &amp; Exit) - EENTER, ERESUME, EEXIT"></a>é˜¶æ®µ 4 &amp; 5: è¿›å…¥ä¸é€€å‡º (Enter &amp; Exit) - <code>EENTER</code>, <code>ERESUME</code>, <code>EEXIT</code></h4><ul><li>**<code>EENTER</code>**ï¼šå½“åº”ç”¨ç¨‹åºéœ€è¦è°ƒç”¨ Enclave å†…éƒ¨çš„å‡½æ•°æ—¶ï¼ŒCPU æ‰§è¡Œæ­¤æŒ‡ä»¤ã€‚CPU ä¼šä¿å­˜å½“å‰çš„ä¸Šä¸‹æ–‡ï¼ˆå¯„å­˜å™¨çŠ¶æ€ç­‰ï¼‰ï¼Œç„¶åè·³è½¬åˆ° Enclave æŒ‡å®šçš„å…¥å£ç‚¹å¼€å§‹æ‰§è¡Œå—ä¿æŠ¤çš„ä»£ç ã€‚</li><li>**<code>EEXIT</code>**ï¼šå½“ Enclave éœ€è¦è°ƒç”¨å¤–éƒ¨å‡½æ•°ï¼ˆOCALLï¼‰æˆ–å¤„ç†ç¡¬ä»¶ä¸­æ–­ï¼ˆå¦‚æ—¶é’Ÿä¸­æ–­ï¼‰æ—¶ï¼ŒCPU æ‰§è¡Œæ­¤æŒ‡ä»¤ã€‚å®ƒä¼šä¿å­˜ Enclave çš„å†…éƒ¨çŠ¶æ€ï¼Œç„¶åè¿”å›åˆ°ä¸å¯ä¿¡çš„åº”ç”¨ç¨‹åºæˆ– OS ä¸­ã€‚</li><li>**<code>ERESUME</code>**ï¼šå½“å¤–éƒ¨è°ƒç”¨æˆ–ä¸­æ–­å¤„ç†å®Œæˆåï¼ŒCPU æ‰§è¡Œæ­¤æŒ‡ä»¤ï¼Œæ¢å¤ Enclave çš„ä¸Šä¸‹æ–‡å¹¶ä»ä¸Šæ¬¡é€€å‡ºçš„åœ°æ–¹ç»§ç»­æ‰§è¡Œã€‚</li></ul><p>è¿™ä¸ªè¿›å…¥&#x2F;é€€å‡ºçš„å¾ªç¯æ˜¯ Enclave å‘æŒ¥ä½œç”¨çš„ä¸»è¦æ–¹å¼ã€‚</p><h4 id="é˜¶æ®µ-6-é”€æ¯-Deletion-EREMOVE"><a href="#é˜¶æ®µ-6-é”€æ¯-Deletion-EREMOVE" class="headerlink" title="é˜¶æ®µ 6: é”€æ¯ (Deletion) - EREMOVE"></a>é˜¶æ®µ 6: é”€æ¯ (Deletion) - <code>EREMOVE</code></h4><ol><li><strong>å‘èµ·è€…</strong>ï¼šåº”ç”¨ç¨‹åºæˆ– OSã€‚</li><li><strong>CPU æŒ‡ä»¤</strong>ï¼šCPU æ‰§è¡Œ <code>EREMOVE</code> æŒ‡ä»¤ã€‚</li><li><strong>ç¡¬ä»¶è¡Œä¸º</strong>ï¼š<ul><li>CPU ä¼šå®‰å…¨åœ°æ“¦é™¤æŒ‡å®šçš„ SECS é¡µé¢ã€‚</li><li>ä¸€æ—¦ SECS è¢«é”€æ¯ï¼Œä¸ä¹‹å…³è”çš„æ‰€æœ‰ EPC é¡µé¢ï¼ˆé€šè¿‡ EPCM çš„è®°å½•ï¼‰éƒ½å°†å˜ä¸ºæ— æ•ˆã€‚</li><li>OS éšåå¯ä»¥å›æ”¶è¿™äº› EPC é¡µé¢ï¼Œç”¨äºå…¶ä»–ç›®çš„ã€‚Enclave çš„ç”Ÿå‘½å‘¨æœŸè‡³æ­¤ç»“æŸã€‚</li></ul></li></ol><hr><p><em>ç†è§£äº† Enclave çš„ç”Ÿå‘½å‘¨æœŸåï¼Œæˆ‘ä»¬åœ¨ä¸‹ä¸€èŠ‚æ·±å…¥æ¢è®¨é©±åŠ¨è¿™äº›çŠ¶æ€è½¬æ¢çš„æ ¸å¿ƒâ€”â€”SGX ç¡¬ä»¶æŒ‡ä»¤é›†ï¼Œå¹¶æ­ç¤ºå…¶å†…éƒ¨çš„æ‰§è¡Œæµç¨‹ã€‚</em></p><h3 id="3-2-SGX-ç¡¬ä»¶æŒ‡ä»¤é›†ä¸å†…éƒ¨æ‰§è¡Œæµç¨‹"><a href="#3-2-SGX-ç¡¬ä»¶æŒ‡ä»¤é›†ä¸å†…éƒ¨æ‰§è¡Œæµç¨‹" class="headerlink" title="3.2 SGX ç¡¬ä»¶æŒ‡ä»¤é›†ä¸å†…éƒ¨æ‰§è¡Œæµç¨‹"></a>3.2 SGX ç¡¬ä»¶æŒ‡ä»¤é›†ä¸å†…éƒ¨æ‰§è¡Œæµç¨‹</h3><p>SGX çš„æ‰€æœ‰æ“ä½œéƒ½ç”±ä¸€ç»„å…¨æ–°çš„ CPU æŒ‡ä»¤é©±åŠ¨ã€‚è¿™äº›æŒ‡ä»¤æ˜¯ CPU ç¡¬ä»¶åŸç”Ÿæ”¯æŒçš„ï¼Œå®ƒä»¬çš„æ‰§è¡Œè¿‡ç¨‹å—åˆ°ä¸¥æ ¼çš„ç¡¬ä»¶æ£€æŸ¥ï¼Œä»è€Œä¿è¯äº†æ“ä½œçš„åŸå­æ€§å’Œå®‰å…¨æ€§ã€‚ä¸å¯ä¿¡çš„è½¯ä»¶ï¼ˆå¦‚ OSï¼‰å¯ä»¥â€è¯·æ±‚â€æ‰§è¡Œè¿™äº›æŒ‡ä»¤ï¼Œä½†æ— æ³•å¹²é¢„å…¶å†…éƒ¨é€»è¾‘ã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸€äº›æœ€é‡è¦çš„ SGX æŒ‡ä»¤åŠå…¶ä½œç”¨ï¼š</p><table><thead><tr><th align="left">æŒ‡ä»¤ç±»åˆ«</th><th align="left">å…³é”®æŒ‡ä»¤</th><th align="left">ä¸»è¦ä½œç”¨</th></tr></thead><tbody><tr><td align="left"><strong>Enclave æ„å»º</strong></td><td align="left"><code>ECREATE</code></td><td align="left">åˆ›å»ºä¸€ä¸ªç©ºçš„ Enclaveï¼Œåˆå§‹åŒ–å…¶ SECSã€‚</td></tr><tr><td align="left"></td><td align="left"><code>EADD</code></td><td align="left">å°†ä»£ç &#x2F;æ•°æ®é¡µé¢åŠ è½½åˆ° EPC ä¸­ã€‚</td></tr><tr><td align="left"></td><td align="left"><code>EEXTEND</code></td><td align="left">â€œæµ‹é‡â€åŠ è½½çš„é¡µé¢ï¼Œæ›´æ–° <code>MRENCLAVE</code> æ‘˜è¦ã€‚</td></tr><tr><td align="left"></td><td align="left"><code>EINIT</code></td><td align="left">å®Œæˆ Enclave åˆå§‹åŒ–ï¼Œä½¿å…¶å‡†å¤‡å¥½è¢«æ‰§è¡Œã€‚</td></tr><tr><td align="left"><strong>Enclave æ‰§è¡Œ</strong></td><td align="left"><code>EENTER</code></td><td align="left">é¦–æ¬¡è¿›å…¥ Enclaveï¼Œå¼€å§‹æ‰§è¡Œä»£ç ã€‚</td></tr><tr><td align="left"></td><td align="left"><code>ERESUME</code></td><td align="left">ä»ä¸­æ–­æˆ–å¤–éƒ¨è°ƒç”¨åï¼Œæ¢å¤ Enclave çš„æ‰§è¡Œã€‚</td></tr><tr><td align="left"></td><td align="left"><code>EEXIT</code></td><td align="left">ä¸»åŠ¨é€€å‡º Enclaveï¼Œè¿”å›åˆ°ä¸å¯ä¿¡çš„åº”ç”¨ä»£ç ã€‚</td></tr><tr><td align="left"><strong>Enclave ç®¡ç†</strong></td><td align="left"><code>EREMOVE</code></td><td align="left">é”€æ¯ä¸€ä¸ª Enclaveï¼Œé‡Šæ”¾å…¶æ‰€æœ‰èµ„æºã€‚</td></tr><tr><td align="left"></td><td align="left"><code>EDBGRD</code>&#x2F;<code>EDBGWR</code></td><td align="left">ï¼ˆåœ¨è°ƒè¯•æ¨¡å¼ä¸‹ï¼‰è¯»&#x2F;å†™ Enclave å†…å­˜ã€‚</td></tr><tr><td align="left"></td><td align="left"><code>EGETKEY</code></td><td align="left">è·å–ç”¨äºç”Ÿæˆè®¤è¯æŠ¥å‘Šæˆ–å¯†å°æ•°æ®çš„ SGX å¯†é’¥ã€‚</td></tr><tr><td align="left"></td><td align="left"><code>EREPORT</code></td><td align="left">ç”Ÿæˆä¸€ä»½å…³äºå½“å‰ Enclave çš„æŠ¥å‘Šï¼ˆç”¨äºæœ¬åœ°è®¤è¯ï¼‰ã€‚</td></tr><tr><td align="left"><strong>å†…å­˜ç®¡ç†</strong></td><td align="left"><code>EAUG</code></td><td align="left">ä¸ºå·²å­˜åœ¨çš„ Enclave å¢åŠ  EPC é¡µé¢ã€‚</td></tr><tr><td align="left"></td><td align="left"><code>EMODPE</code></td><td align="left">ä¿®æ”¹å·²åŠ è½½é¡µé¢çš„æƒé™ã€‚</td></tr><tr><td align="left"></td><td align="left"><code>ETRACK</code></td><td align="left">åœæ­¢å¯¹ Enclave çš„è¿½è¸ªï¼ˆç”¨äºç”µæºç®¡ç†ï¼‰ã€‚</td></tr></tbody></table><h4 id="æŒ‡ä»¤å†…éƒ¨æ‰§è¡Œæµç¨‹ç¤ºä¾‹-EADD"><a href="#æŒ‡ä»¤å†…éƒ¨æ‰§è¡Œæµç¨‹ç¤ºä¾‹-EADD" class="headerlink" title="æŒ‡ä»¤å†…éƒ¨æ‰§è¡Œæµç¨‹ç¤ºä¾‹ (EADD)"></a>æŒ‡ä»¤å†…éƒ¨æ‰§è¡Œæµç¨‹ç¤ºä¾‹ (<code>EADD</code>)</h4><p>è®©æˆ‘ä»¬ä»¥ <code>EADD</code> æŒ‡ä»¤ä¸ºä¾‹ï¼Œçœ‹çœ‹å…¶å†…éƒ¨çš„æ‰§è¡Œæµç¨‹æœ‰å¤šä¹ˆä¸¥è°¨ï¼š</p><ol><li><strong>æƒé™æ£€æŸ¥</strong>ï¼šCPU é¦–å…ˆæ£€æŸ¥å½“å‰æ˜¯å¦å¤„äº Ring 0ï¼ˆå†…æ ¸æ€ï¼‰ï¼Œå› ä¸ºåªæœ‰ OS æ‰æœ‰æƒé™ç®¡ç†ç‰©ç†å†…å­˜ã€‚</li><li><strong>å‚æ•°éªŒè¯</strong>ï¼šCPU æ£€æŸ¥ <code>EADD</code> æŒ‡ä»¤çš„å‚æ•°ï¼ŒåŒ…æ‹¬æºå†…å­˜åœ°å€ï¼ˆæ™®é€šå†…å­˜ï¼‰ã€ç›®æ ‡ EPC é¡µé¢åœ°å€ï¼Œä»¥åŠç›®æ ‡é¡µé¢çš„ SECS åœ°å€ã€‚</li><li><strong>SECS çŠ¶æ€æ£€æŸ¥</strong>ï¼šCPU è¯»å–ç›®æ ‡ Enclave çš„ SECSï¼Œæ£€æŸ¥å…¶ç”Ÿå‘½å‘¨æœŸçŠ¶æ€ã€‚åªæœ‰å¤„äºâ€åˆ›å»ºä¸­â€æˆ–â€åŠ è½½ä¸­â€çš„ Enclave æ‰èƒ½æ¥å— <code>EADD</code>ã€‚å¦‚æœ Enclave å·²åˆå§‹åŒ–ï¼Œ<code>EADD</code> å°†å¤±è´¥ã€‚</li><li><strong>åœ°å€æ£€æŸ¥</strong>ï¼šCPU éªŒè¯ç›®æ ‡ EPC é¡µé¢çš„åœ°å€æ˜¯å¦åœ¨ SECS å£°æ˜çš„åŸºåœ°å€å’Œå¤§å°èŒƒå›´ä¹‹å†…ã€‚</li><li><strong>EPCM æŸ¥æ‰¾</strong>ï¼šCPU åœ¨ EPCMï¼ˆEnclave é¡µé¢ç¼“å­˜åœ°å›¾ï¼‰ä¸­æŸ¥æ‰¾ç›®æ ‡ EPC é¡µé¢ã€‚<ul><li><strong>å¦‚æœé¡µé¢å·²è¢«å ç”¨</strong>ï¼šæ£€æŸ¥å®ƒæ˜¯å¦å±äºå½“å‰ Enclaveã€‚å¦‚æœå±äºå…¶ä»– Enclaveï¼Œæ“ä½œå¤±è´¥ã€‚</li><li><strong>å¦‚æœé¡µé¢æœªè¢«å ç”¨</strong>ï¼šæ ‡è®°è¯¥é¡µé¢ä¸ºæœ‰æ•ˆã€‚</li></ul></li><li><strong>å†…å®¹æ‹·è´</strong>ï¼šCPU å°†æºå†…å­˜é¡µé¢çš„ 4KB å†…å®¹æ‹·è´åˆ°ç›®æ ‡ EPC é¡µé¢ã€‚è¿™ä¸ªè¿‡ç¨‹ç”±ç¡¬ä»¶ç›´æ¥å®Œæˆã€‚</li><li><strong>EPCM æ›´æ–°</strong>ï¼šCPU åœ¨ EPCM ä¸­æ›´æ–°è¯¥é¡µé¢çš„æ¡ç›®ï¼Œè®°å½•å…¶å½’å±çš„ SECSã€é¡µé¢ç±»å‹ï¼ˆä¾‹å¦‚ <code>PT_REG</code> ä»£è¡¨æ™®é€šé¡µé¢ï¼‰ä»¥åŠå¼€å‘è€…åœ¨ SECS ä¸­é¢„è®¾çš„è®¿é—®æƒé™ï¼ˆè¯»&#x2F;å†™&#x2F;æ‰§è¡Œï¼‰ã€‚</li><li><strong>çŠ¶æ€è¿”å›</strong>ï¼šå¦‚æœæ‰€æœ‰æ­¥éª¤éƒ½æˆåŠŸï¼ŒæŒ‡ä»¤æ‰§è¡Œå®Œæ¯•ã€‚å¦åˆ™ï¼Œè¿”å›ç›¸åº”çš„é”™è¯¯ç ã€‚</li></ol><p>è¿™ä¸ªæµç¨‹ä¸­çš„æ¯ä¸€æ­¥éƒ½ç”±ç¡¬ä»¶å¼ºåˆ¶æ‰§è¡Œï¼Œç¡®ä¿äº†å³ä½¿æ˜¯æ¶æ„çš„ OS ä¹Ÿæ— æ³•å°†é¡µé¢åŠ è½½åˆ°é”™è¯¯çš„ Enclave ä¸­ï¼Œæˆ–è€…èµ‹äºˆé¡µé¢é”™è¯¯çš„æƒé™ã€‚</p><blockquote><p>è¿™å°±æ˜¯ç¡¬ä»¶çš„é­…åŠ›ï½ å¯ä»¥å°†ä¸€äº›å®‰å…¨é€»è¾‘å›ºåŒ–åˆ°ç¡¬ä»¶ä¸Šæ˜¯é¦™çš„ï¼ˆä¸è¿‡ä¸è¦æœ‰æ¼æ´å“¦ï¼Œä¸ç„¶å°±åºŸäº†ã€‚ã€‚ï¼‰</p></blockquote><h3 id="3-3-å®‰å…¨åŠ è½½"><a href="#3-3-å®‰å…¨åŠ è½½" class="headerlink" title="3.3 å®‰å…¨åŠ è½½"></a>3.3 å®‰å…¨åŠ è½½</h3><p>ä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰ç–‘æƒ‘ï¼Ÿæˆ‘ä¹‹å‰çœ‹åˆ°è¯´æ˜¯ æ“ä½œç³»ç»Ÿï¼ˆOSï¼‰ åŠ è½½ ç¨‹åºå’Œæ•°æ®åˆ° Enclaveé‡Œçš„æ—¶å€™ï¼Œæˆ‘å°±æœ‰ç–‘æƒ‘äº†ï¼Œå› ä¸ºä¸æ˜¯è¯´OSä¸åœ¨ä¿¡ä»»åŸºå†…å—ã€‚å¦‚æœæ˜¯OSæ¥åŠ è½½çš„è¯ï¼Œå°±æ— æ³•ä¿è¯ éœ€è¦åŠ è½½çš„ç¨‹åºå’Œæ•°æ®åœ¨ä¸­é€”è¢«çª¥æ¢å’Œç¯¡æ”¹å§ã€‚</p><p>ç­”æ¡ˆçš„æ ¸å¿ƒåœ¨äºä¸¤ä¸ªæœºåˆ¶çš„åä½œï¼šå†…å­˜åŠ å¯†å¼•æ“ï¼ˆMEEï¼‰å’Œ æµ‹é‡æœºåˆ¶ï¼ˆMeasurementï¼‰</p><h4 id="æ­¥éª¤-1ï¼šé˜²çª¥æ¢-MEE-çš„å®æ—¶åŠ å¯†"><a href="#æ­¥éª¤-1ï¼šé˜²çª¥æ¢-MEE-çš„å®æ—¶åŠ å¯†" class="headerlink" title="æ­¥éª¤ 1ï¼šé˜²çª¥æ¢ - MEE çš„å®æ—¶åŠ å¯†"></a>æ­¥éª¤ 1ï¼šé˜²çª¥æ¢ - MEE çš„å®æ—¶åŠ å¯†</h4><p>å½“åº”ç”¨ç¨‹åºï¼ˆåœ¨ä¸å¯ä¿¡çš„æ™®é€šå†…å­˜ä¸­ï¼‰å‡†å¤‡å¥½ä¸€æ®µä»£ç æˆ–æ•°æ®ï¼Œå¹¶é€šè¿‡ <code>EADD</code> æŒ‡ä»¤å°†å…¶åŠ è½½åˆ° EPC æ—¶ï¼Œæ•°æ®ä¼šæµç» CPU å†…éƒ¨ã€‚å½“æ•°æ®ç¦»å¼€ CPU æ ¸å¿ƒï¼Œå‡†å¤‡å†™å…¥åˆ°ç‰©ç†å†…å­˜ï¼ˆEPCï¼‰æ—¶ï¼Œ<strong>MEEï¼ˆå†…å­˜åŠ å¯†å¼•æ“ï¼‰ä¼šè‡ªåŠ¨å¯¹å…¶è¿›è¡ŒåŠ å¯†</strong>ã€‚</p><ul><li><strong>è¿™æ„å‘³ç€</strong>ï¼šä»»ä½•åœ¨ CPU å¤–éƒ¨çš„â€äººâ€ï¼ˆæ— è®ºæ˜¯ç‰©ç†æ¢æµ‹å†…å­˜æ€»çº¿çš„é»‘å®¢ï¼Œè¿˜æ˜¯æ‹¥æœ‰æœ€é«˜æƒé™çš„ OSï¼‰ï¼Œçœ‹åˆ°çš„éƒ½åªæ˜¯åŠ å¯†åçš„å¯†æ–‡ã€‚å®ƒä»¬æ— æ³•çª¥æ¢åˆ°æ‚¨åŠ è½½çš„çœŸå®å†…å®¹ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯ç¡¬ä»¶å¼ºåˆ¶çš„ã€è‡ªåŠ¨çš„ã€ä¸”å¯¹å¼€å‘è€…é€æ˜çš„ã€‚</li></ul><blockquote><p>ä¸çŸ¥é“ä½ æ˜¯ä¸æ˜¯è§‰å¾—è¿™æ®µè¯æ˜¯æ­£ç¡®åˆç†ï¼Œèƒ½å®Œç¾ä¿è¯å®‰å…¨é—®é¢˜ã€‚å…¶å®æ˜¯ä¸å®Œå…¨æ­£ç¡®çš„</p></blockquote><p>å¦‚æœåº”ç”¨ç¨‹åºå‡†å¤‡å¥½äº†ä¸€æ®µä»£ç æˆ–æ•°æ®ï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œ  <code>EADD</code> æŒ‡ä»¤å‰ï¼Œè¿™æ®µä»£ç æˆ–æ•°æ®å…¶å®å°±åœ¨ä¼šæ³„éœ²ï¼ˆå› ä¸ºåº”ç”¨ç¨‹åºæ˜¯åœ¨ä¸å¯ä¿¡çš„æ™®é€šå†…å­˜ä¸­çš„ï¼‰ã€‚</p><p>æ‰€ä»¥æ€ä¹ˆé¢„é˜²ï¼Œæ­£ç¡®çš„ç­”æ¡ˆæ˜¯ï¼šå¯¹äºçœŸæ­£éœ€è¦ä¿æŠ¤çš„å•†ä¸šçº§åº”ç”¨ï¼Œæ•æ„Ÿæ•°æ®ä»ä¸€å¼€å§‹å°±ä¸ä¼šä»¥æ˜æ–‡å½¢å¼å‡ºç°åœ¨ä¸å¯ä¿¡çš„å†…å­˜ä¸­ï¼Œè€Œæ˜¯ä¸€ç›´åŠ å¯†çš„ï¼ˆè¿™å°±æ˜¯æ‰€è°“çš„ æ˜æ–‡ä¸è½åœ°ï¼‰ã€‚åªæœ‰åœ¨Enclaveå†…æ‰ä¼šè§£å¯†çš„ã€‚</p><p>æ•°æ®æ˜¯è¿™æ ·çš„ï¼ŒEnclaveä»£ç æ€»ä¸èƒ½è¯´åŠ å¯†å§ã€‚è¿™ç¡®å®ï¼Enclave çš„åº”ç”¨ç¨‹åºä»£ç ï¼ˆ.so æ–‡ä»¶ï¼‰æœ¬èº«ï¼Œåœ¨åŠ è½½å‰ç¡®å®æ˜¯ä»¥æ˜æ–‡å½¢å¼å­˜æ”¾åœ¨ä¸å¯ä¿¡çš„ç¡¬ç›˜ä¸Šï¼Œå¹¶ä¸”ä¼šè¢«åŠ è½½åˆ°ä¸å¯ä¿¡çš„å†…å­˜ä¸­ã€‚</p><p>è¿™æ„å‘³ç€ï¼Œ<strong>OS å’Œæ”»å‡»è€…ç¡®å®å¯ä»¥çœ‹åˆ°æ‚¨çš„ Enclave ä»£ç çš„äºŒè¿›åˆ¶æŒ‡ä»¤</strong>ã€‚æˆ‘ä»¬èƒ½åšçš„æ˜¯åœ¨è½¯ä»¶å±‚é¢å»åšæ··æ·†ä¿æŠ¤ï¼ˆä»£ç æ··æ·†ï¼‰ã€‚</p><p>SGXå®‰å…¨æ¨¡å‹èƒ½ä¿è¯çš„æ˜¯ï¼šæ­£åœ¨è¿è¡Œçš„ç»å¯¹æ˜¯æœªç»ä»»ä½•ç¯¡æ”¹çš„åŸå§‹ä»£ç ï¼ˆè¿™ä¸ªæ€ä¹ˆå®ç°çš„æ˜¯ï¼Ÿæ˜¯é€šè¿‡ä¸‹é¢è¿™ä¸ªï¼‰</p><h4 id="æ­¥éª¤-2ï¼šé˜²ç¯¡æ”¹-æµ‹é‡æœºåˆ¶çš„æ ¸å¿ƒ-EEXTEND"><a href="#æ­¥éª¤-2ï¼šé˜²ç¯¡æ”¹-æµ‹é‡æœºåˆ¶çš„æ ¸å¿ƒ-EEXTEND" class="headerlink" title="æ­¥éª¤ 2ï¼šé˜²ç¯¡æ”¹ - æµ‹é‡æœºåˆ¶çš„æ ¸å¿ƒ EEXTEND"></a>æ­¥éª¤ 2ï¼šé˜²ç¯¡æ”¹ - æµ‹é‡æœºåˆ¶çš„æ ¸å¿ƒ <code>EEXTEND</code></h4><p>ä»…ä»…åŠ å¯†æ˜¯ä¸å¤Ÿçš„ï¼Œæ¶æ„çš„ OS ä»ç„¶å¯ä»¥ç¯¡æ”¹åŠ å¯†åçš„æ•°æ®ï¼ˆä¾‹å¦‚ï¼Œæ›¿æ¢æ‰æ•´ä¸ªåŠ å¯†é¡µé¢ï¼‰ã€‚å¯ä»¥æŠŠä½ æœ¬æ¥éœ€è¦åŠ è½½çš„Enclaveå†…çš„ç¨‹åºå·æ¢æ‰æˆ–è€…ä¿®æ”¹å…¶å†…éƒ¨éƒ¨åˆ†ä»£ç ã€‚</p><p>SGX ä½¿ç”¨â€<strong>æµ‹é‡</strong>â€œæœºåˆ¶æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><ol><li><strong>åˆå§‹çŠ¶æ€</strong>ï¼šåœ¨ <code>ECREATE</code> åˆ›å»º Enclave æ—¶ï¼Œå…¶å†…éƒ¨æœ‰ä¸€ä¸ªåä¸º <code>MRENCLAVE</code> çš„æµ‹é‡å¯„å­˜å™¨ï¼Œåˆå§‹å€¼ä¸ºç©ºã€‚</li><li><strong>ç´¯ç§¯æ›´æ–°</strong>ï¼šæ¯å½“ä¸€æ¡ <code>EADD</code> æŒ‡ä»¤æˆåŠŸåŠ è½½ä¸€ä¸ªé¡µé¢åï¼ŒCPU å¿…é¡»ç´§æ¥ç€æ‰§è¡Œ <code>EEXTEND</code> æŒ‡ä»¤ã€‚<code>EEXTEND</code> æŒ‡ä»¤ä¼šï¼š<ul><li>è¯»å–åˆšåˆšåŠ è½½çš„é‚£ä¸ªé¡µé¢çš„ <strong>4KB æ˜æ–‡å†…å®¹</strong>ï¼ˆæ³¨æ„ï¼Œæ˜¯åœ¨ CPU å†…éƒ¨ï¼ŒåŠ å¯†ä¹‹å‰è¿›è¡Œçš„ï¼‰ã€‚</li><li>å°†é¡µé¢å†…å®¹ä»¥ 256 å­—èŠ‚ä¸ºå•ä½è¿›è¡Œåˆ‡å—ã€‚</li><li>å°†æ¯ä¸€å—çš„å†…å®¹ï¼Œè¿åŒå½“å‰ <code>MRENCLAVE</code> å¯„å­˜å™¨çš„å€¼ï¼Œä¸€èµ·é€å…¥ä¸€ä¸ª SHA-256 å“ˆå¸Œè®¡ç®—å•å…ƒã€‚</li><li><strong>ç”¨è®¡ç®—å‡ºçš„æ–°å“ˆå¸Œå€¼ï¼Œå»æ›´æ–° <code>MRENCLAVE</code> å¯„å­˜å™¨</strong>ã€‚</li></ul></li><li><strong>æœ€ç»ˆç»“æœ</strong>ï¼šå½“æ‰€æœ‰ä»£ç å’Œæ•°æ®é¡µé¢éƒ½é€šè¿‡ <code>EADD</code> å’Œ <code>EEXTEND</code> åŠ è½½å®Œæˆåï¼Œ<code>MRENCLAVE</code> å¯„å­˜å™¨ä¸­å°±ä¿å­˜äº†ä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„ã€ä»£è¡¨äº† Enclave æ‰€æœ‰åˆå§‹å†…å®¹çš„ SHA-256 å“ˆå¸Œå€¼ã€‚</li></ol><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph LR    %% åˆå§‹åŒ–é˜¶æ®µ    A[MRENCLAVEåˆå§‹å€¼&lt;br&gt;å…¨é›¶çŠ¶æ€] --&gt; B[åŠ è½½Page 1]        %% é¡µé¢åº¦é‡è¿‡ç¨‹    B --&gt; C[EEXTENDæŒ‡ä»¤]    C --&gt; D[&quot;SHA256(å½“å‰MRENCLAVE +&lt;br&gt;Page 1å†…å®¹)&quot;]    D --&gt; E[æ›´æ–°MRENCLAVE]        E --&gt; F[åŠ è½½Page 2]    F --&gt; G[EEXTENDæŒ‡ä»¤]    G --&gt; H[&quot;SHA256(æ–°MRENCLAVE +&lt;br&gt;Page 2å†…å®¹)&quot;]    H --&gt; I[æ›´æ–°MRENCLAVE]        %% æœ€ç»ˆç»“æœ    I --&gt; J[...è¿­ä»£è¿‡ç¨‹...]    J --&gt; K[æœ€ç»ˆMRENCLAVEå€¼]        %% æ ·å¼å®šä¹‰    classDef final fill:#90ee90,stroke:#2e8b57;    class K final;        %% è¿æ¥çº¿è¯´æ˜    linkStyle 2,4,6,8 stroke:#666,stroke-width:2px;  </pre></div><h4 id="ä¸ºä»€ä¹ˆè¿™ä¸ªæœºåˆ¶æ˜¯å®‰å…¨çš„ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆè¿™ä¸ªæœºåˆ¶æ˜¯å®‰å…¨çš„ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆè¿™ä¸ªæœºåˆ¶æ˜¯å®‰å…¨çš„ï¼Ÿ"></a>ä¸ºä»€ä¹ˆè¿™ä¸ªæœºåˆ¶æ˜¯å®‰å…¨çš„ï¼Ÿ</h4><ul><li><strong>é¡ºåºä¾èµ–æ€§</strong>ï¼šæµ‹é‡çš„é¡ºåºæ˜¯å›ºå®šçš„ã€‚å¦‚æœ OS è¯•å›¾æ”¹å˜é¡µé¢åŠ è½½çš„é¡ºåºï¼Œæœ€ç»ˆçš„ <code>MRENCLAVE</code> å°†ä¼šä¸åŒã€‚</li><li><strong>å†…å®¹æ•æ„Ÿæ€§</strong>ï¼šSHA-256 ç®—æ³•çš„ç‰¹æ€§ä¿è¯äº†ï¼Œå“ªæ€•åŸå§‹ä»£ç æˆ–æ•°æ®ä¸­åªæœ‰ä¸€ä¸ªæ¯”ç‰¹è¢«ç¯¡æ”¹ï¼Œæœ€ç»ˆçš„ <code>MRENCLAVE</code> å€¼ä¹Ÿä¼šå®Œå…¨ä¸åŒã€‚</li><li><strong>ä¸€æ¬¡æ€§å›ºåŒ–</strong>ï¼šå½“ <code>EINIT</code> æŒ‡ä»¤æ‰§è¡ŒæˆåŠŸåï¼ŒEnclave å°±è¢«â€é”å®šâ€äº†ã€‚<code>MRENCLAVE</code> çš„å€¼è¢«æœ€ç»ˆç¡®å®šä¸‹æ¥ï¼Œæ— æ³•å†è¢«ä¿®æ”¹ã€‚è¿™ä¸ªæœ€ç»ˆçš„ <code>MRENCLAVE</code> å€¼å°±æˆäº†è¿™ä¸ª Enclave çš„**â€æŒ‡çº¹â€æˆ–â€DNAâ€**ã€‚</li></ul><blockquote><p>å…¶å®è¿™ä¸ªå’Œæˆ‘ä¹‹å‰è°ƒç ”è¿‡çš„ä¸€ä¸ªå®¡è®¡æ—¥å¿—æ–¹æ¡ˆé‡Œæ–¹æ³•æ˜¯ä¸€è‡´çš„ï¼ˆå¦‚ä½•ä¿è¯æ—¥å¿—é“¾å®Œæ•´æ€§å’Œæœªè¢«ç¯¡æ”¹ï¼‰</p></blockquote><p>åœ¨åç»­çš„è®¤è¯æµç¨‹ï¼ˆæˆ‘ä»¬å°†åœ¨ç¬¬å››éƒ¨åˆ†è¯¦ç»†è®²è§£ï¼‰ä¸­ï¼Œè¿œç¨‹æœåŠ¡å™¨ä¼šéªŒè¯è¿™ä¸ªâ€DNAâ€ã€‚å¦‚æœ OS åœ¨åŠ è½½è¿‡ç¨‹ä¸­è¿›è¡Œäº†ä»»ä½•æ‰‹è„šï¼Œå¯¼è‡´æœ€ç»ˆçš„ <code>MRENCLAVE</code> ä¸å¼€å‘è€…é¢„æœŸçš„ä¸ç¬¦ï¼Œè®¤è¯å°†ä¼šå¤±è´¥ï¼Œè¿œç¨‹æœåŠ¡å™¨å°±ä¸ä¼šä¿¡ä»»è¿™ä¸ª Enclaveï¼Œä¹Ÿä¸ä¼šç»™å®ƒå‘é€ä»»ä½•æ•æ„Ÿæ•°æ®ã€‚</p><p><strong>æ€»ç»“</strong>ï¼šé€šè¿‡<strong>EEXTEND çš„æµ‹é‡</strong>ï¼Œå¯ä»¥ä¿è¯æˆ‘ä»¬çš„ä»£ç ä¸€å®šæ˜¯å®Œæ•´çš„è¢«åŠ è½½åˆ° Enclaveä¸­çš„ã€‚è€Œæ•æ„Ÿæ•°æ®å› ä¸ºåœ¨Enclaveå‰ä¸€ç›´æ˜¯åŠ å¯†çš„ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯å®‰å…¨çš„ã€‚å½“è¿›å…¥åˆ° Enclaveåè§£å¯†æ—¶ï¼Œåˆç”±<strong>MEE</strong>æ¥ä¿æŠ¤å…¶å®‰å…¨ã€‚</p><hr><p><em>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»äº†è§£äº† Enclave æ˜¯å¦‚ä½•è¢«å®‰å…¨åœ°åˆ›å»ºå’ŒåŠ è½½çš„ã€‚ä¸‹ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨ SGX æœ€æ ¸å¿ƒçš„å„ç§å®‰å…¨æœºåˆ¶ï¼ŒåŒ…æ‹¬å†…å­˜å®‰å…¨ã€è®¤è¯å’Œæ•°æ®æŒä¹…åŒ–ç­‰ã€‚</em></p><h2 id="å››ã€å…³é”®å®‰å…¨æœºåˆ¶æ·±åº¦å‰–æ"><a href="#å››ã€å…³é”®å®‰å…¨æœºåˆ¶æ·±åº¦å‰–æ" class="headerlink" title="å››ã€å…³é”®å®‰å…¨æœºåˆ¶æ·±åº¦å‰–æ"></a>å››ã€å…³é”®å®‰å…¨æœºåˆ¶æ·±åº¦å‰–æ</h2><p>åœ¨è¿™ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨ SGX å¦‚ä½•å®ç°å…¶å®‰å…¨æ‰¿è¯ºã€‚æˆ‘ä»¬å°†é€ä¸€å‰–æå†…å­˜å®‰å…¨ã€èº«ä»½è®¤è¯å’Œæ•°æ®æŒä¹…åŒ–è¿™ä¸‰å¤§æ ¸å¿ƒå®‰å…¨æœºåˆ¶ã€‚</p><h3 id="4-1-å†…å­˜å®‰å…¨ï¼šå¦‚ä½•æŠµå¾¡æ¥è‡ª-OS-çš„æ”»å‡»"><a href="#4-1-å†…å­˜å®‰å…¨ï¼šå¦‚ä½•æŠµå¾¡æ¥è‡ª-OS-çš„æ”»å‡»" class="headerlink" title="4.1 å†…å­˜å®‰å…¨ï¼šå¦‚ä½•æŠµå¾¡æ¥è‡ª OS çš„æ”»å‡»"></a>4.1 å†…å­˜å®‰å…¨ï¼šå¦‚ä½•æŠµå¾¡æ¥è‡ª OS çš„æ”»å‡»</h3><p>è¿™æ˜¯ SGX è®¾è®¡çš„å‡ºå‘ç‚¹å’Œæ ¸å¿ƒä»·å€¼æ‰€åœ¨ï¼šå³ä½¿æ“ä½œç³»ç»Ÿï¼ˆOSï¼‰æ˜¯æ¶æ„çš„ï¼Œä¹Ÿæ— æ³•ä¾µå®³ Enclave çš„å†…å­˜ã€‚è¿™ä¸»è¦é€šè¿‡ç¡¬ä»¶å±‚é¢çš„ä¸‰ä¸ªæœºåˆ¶å®ç°ï¼š<strong>MEE åŠ å¯†</strong>ã€<strong>EPCM æƒé™æ£€æŸ¥</strong>ã€‚</p><p>æˆ‘ä»¬å›é¡¾ä¸€ä¸‹ä¹‹å‰è¯´çš„æ ¸å¿ƒç»„ä»¶ï¼š</p><ul><li>**MEE (å†…å­˜åŠ å¯†å¼•æ“)**ï¼šä¿è¯äº†æ‰€æœ‰ç¦»å¼€ CPU å†™å…¥åˆ° EPC çš„æ•°æ®éƒ½æ˜¯åŠ å¯†çš„ï¼Œé˜²æ­¢äº†ç‰©ç†å—…æ¢ã€‚</li><li>**EPCM (Enclave é¡µé¢ç¼“å­˜åœ°å›¾)**ï¼šè¿™æ˜¯å®ç°è®¿é—®æ§åˆ¶çš„å…³é”®ã€‚å®ƒåƒä¸€ä¸ªä¸¥æ ¼çš„é—¨å«ï¼Œè®°å½•äº†æ¯ä¸ª EPC é¡µé¢çš„â€æˆ·å£â€â€”â€”å®ƒå±äºå“ªä¸ª Enclaveï¼Œä»¥åŠå®ƒçš„è®¿é—®æƒé™ï¼ˆè¯»&#x2F;å†™&#x2F;æ‰§è¡Œï¼‰ã€‚</li></ul><p><strong>å½“ä¸€ä¸ªå†…å­˜è®¿é—®å‘ç”Ÿæ—¶ï¼Œç¡¬ä»¶ä¼šå¼ºåˆ¶æ‰§è¡Œä»¥ä¸‹æ£€æŸ¥ï¼š</strong></p><ol><li><p><strong>è®¿é—®æºæ£€æŸ¥</strong>ï¼š</p><ul><li><strong>å¦‚æœè®¿é—®æ¥è‡ª Enclave å†…éƒ¨</strong>ï¼šCPU æ£€æŸ¥è¯¥ Enclave æ˜¯å¦æœ‰æƒè®¿é—®ç›®æ ‡ EPC é¡µé¢ã€‚ä¾‹å¦‚ï¼ŒEnclave ä¸èƒ½å†™å…¥ä¸€ä¸ªåªè¯»çš„ä»£ç é¡µã€‚</li><li><strong>å¦‚æœè®¿é—®æ¥è‡ª Enclave å¤–éƒ¨ï¼ˆå¦‚ OSï¼‰</strong>ï¼šCPU ä¼šæ£€æŸ¥ EPCMã€‚ç”±äºæ‰€æœ‰ EPC é¡µé¢éƒ½åœ¨ EPCM ä¸­è¢«æ ‡è®°ä¸ºâ€å—ä¿æŠ¤çš„â€ï¼Œç¡¬ä»¶ä¼šç›´æ¥æ‹’ç»ä»»ä½•æ¥è‡ªå¤–éƒ¨çš„è¯»ã€å†™æˆ–æ‰§è¡Œè¯·æ±‚ï¼Œå¹¶ç«‹å³è§¦å‘ä¸€ä¸ªé¡µé¢é”™è¯¯ï¼ˆPage Faultï¼‰å¼‚å¸¸ç»™ OSã€‚</li></ul></li><li><p><strong>åœ°å€èŒƒå›´æ£€æŸ¥</strong>ï¼šCPU è¿˜ä¼šæ£€æŸ¥è®¿é—®çš„åœ°å€æ˜¯å¦åœ¨ Enclave çš„ SECS ç»“æ„ä¸­å£°æ˜çš„åœ°å€èŒƒå›´ä¹‹å†…ã€‚</p></li></ol><p><strong>è¿™ä¸ªç”±ç¡¬ä»¶å¼ºåˆ¶æ‰§è¡Œçš„æµç¨‹ï¼Œç¡®ä¿äº† OS å¯¹ Enclave å†…å­˜çš„â€ä¸‰ä¸â€ï¼š</strong></p><ul><li><strong>çœ‹ä¸è§</strong>ï¼šæ•°æ®æ˜¯åŠ å¯†çš„ã€‚</li><li><strong>è¯»ä¸åˆ°</strong>ï¼šç¡¬ä»¶æ‹’ç»è®¿é—®ã€‚</li><li><strong>æ”¹ä¸äº†</strong>ï¼šç¡¬ä»¶æ‹’ç»è®¿é—®ã€‚</li></ul><p>è¿™å°±æ˜¯ SGX å¦‚ä½•ä»æ ¹æœ¬ä¸Šé˜²å¾¡æ¥è‡ªæ¶æ„ OS çš„ç›´æ¥å†…å­˜æ”»å‡»ï¼Œå®ç°å†…å­˜éš”ç¦»ä¸è®¿é—®æ§åˆ¶ã€‚</p><h3 id="4-2-EDMMï¼šEnclave-åŠ¨æ€å†…å­˜ç®¡ç†"><a href="#4-2-EDMMï¼šEnclave-åŠ¨æ€å†…å­˜ç®¡ç†" class="headerlink" title="4.2 EDMMï¼šEnclave åŠ¨æ€å†…å­˜ç®¡ç†"></a>4.2 EDMMï¼šEnclave åŠ¨æ€å†…å­˜ç®¡ç†</h3><p>åœ¨ SGX v1 ä¸­ï¼ŒEnclave çš„å¤§å°åœ¨åˆ›å»ºæ—¶æ˜¯å›ºå®šçš„ï¼Œè¿™æå¤§åœ°é™åˆ¶äº†å…¶å®ç”¨æ€§ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒSGX v2 å¼•å…¥äº† <strong>EDMM (Enclave Dynamic Memory Management)</strong> æœºåˆ¶ï¼Œå…è®¸ Enclave åœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°ç”³è¯·å’Œé‡Šæ”¾å†…å­˜ã€‚</p><p>EDMM çš„å®ç°ä¾ç„¶éµå¾ª SGX çš„æ ¸å¿ƒåŸåˆ™ï¼š<strong>OS ä½œä¸ºä¸å¯ä¿¡çš„èµ„æºç®¡ç†å‘˜ï¼Œè€Œ CPU ä½œä¸ºå¯ä¿¡çš„æ‰§è¡Œè€…ã€‚</strong></p><p><strong>åŠ¨æ€æ·»åŠ å†…å­˜ (<code>EAUG</code>) çš„æµç¨‹ï¼š</strong></p><ol><li><strong>Enclave è¯·æ±‚</strong>ï¼šEnclave å†…éƒ¨çš„å†…å­˜ç®¡ç†å™¨ï¼ˆä¾‹å¦‚ <code>malloc</code> çš„å®‰å…¨å®ç°ï¼‰å‘ç° EPC ä¸è¶³ï¼Œå®ƒä¼šè§¦å‘ä¸€ä¸ª OCALLï¼ˆå¤–éƒ¨è°ƒç”¨ï¼‰é€šçŸ¥å¤–éƒ¨çš„ Appã€‚</li><li><strong>App ä¸ OS åä½œ</strong>ï¼šApp å‘ OS è¯·æ±‚åˆ†é…ä¸€å—æ™®é€šçš„ã€æ–°çš„å†…å­˜é¡µé¢ã€‚</li><li><strong>App è¯·æ±‚åŠ è½½</strong>ï¼šApp è¯·æ±‚ SGX é©±åŠ¨ï¼Œä½¿ç”¨ <code>EAUG</code> (Enclave AUGment) æŒ‡ä»¤å°†è¿™ä¸ªæ–°é¡µé¢ä½œä¸º EPC é¡µé¢æ·»åŠ åˆ° Enclave ä¸­ã€‚</li><li>**CPU æ‰§è¡Œ <code>EAUG</code>**ï¼š<ul><li><code>EAUG</code> æŒ‡ä»¤ä¸ <code>EADD</code> ç±»ä¼¼ï¼Œä½†å®ƒæ“ä½œçš„æ˜¯ä¸€ä¸ªå·²ç»åˆå§‹åŒ–çš„ Enclaveã€‚</li><li>CPU å°†æ™®é€šé¡µé¢çš„å†…å®¹æ‹·è´åˆ°ä¸€å—æ–°çš„ EPC é¡µé¢ä¸­ï¼ˆé€šå¸¸æ˜¯å…¨ 0ï¼‰ã€‚</li><li>æœ€å…³é”®çš„æ˜¯ï¼ŒCPU åœ¨ EPCM ä¸­å°†è¿™ä¸ªæ–°é¡µé¢ä¸å‘èµ·è¯·æ±‚çš„ Enclave çš„ SECS å…³è”èµ·æ¥ï¼Œå¹¶è®¾ç½®å¥½è®¿é—®æƒé™ã€‚</li></ul></li><li><strong>Enclave ä½¿ç”¨</strong>ï¼šä¸€æ—¦ <code>EAUG</code> å®Œæˆï¼ŒEnclave å†…éƒ¨çš„å†…å­˜ç®¡ç†å™¨å°±å¯ä»¥å®‰å…¨åœ°ä½¿ç”¨è¿™å—æ–°çš„ EPC å†…å­˜äº†ã€‚</li></ol><p><strong>åŠ¨æ€é‡Šæ”¾å†…å­˜ (<code>TRIM</code>) çš„æµç¨‹</strong>ï¼š</p><p>é‡Šæ”¾å†…å­˜ç›¸å¯¹å¤æ‚ï¼Œéœ€è¦ç¡®ä¿é¡µé¢ä¸­æ²¡æœ‰æ•æ„Ÿæ•°æ®æ®‹ç•™ã€‚</p><ol><li><strong>Enclave æ ‡è®°</strong>ï¼šEnclave å†…éƒ¨çš„ <code>free</code> å‡½æ•°ä¼šå°†ä¸€å—ä¸å†ä½¿ç”¨çš„ EPC é¡µé¢æ ‡è®°ä¸ºâ€å¾…é‡Šæ”¾â€ã€‚</li><li><strong>å†…å®¹æ¸…é™¤</strong>ï¼šEnclave è´Ÿè´£æ¸…é™¤è¯¥é¡µé¢çš„å†…å®¹ï¼ˆé€šå¸¸æ˜¯å¡« 0ï¼‰ï¼Œå¹¶è°ƒç”¨ <code>EMODT</code> (Modify Type) æŒ‡ä»¤ï¼Œå°†å…¶é¡µé¢ç±»å‹åœ¨ EPCM ä¸­ä»æ™®é€šé¡µï¼ˆ<code>PT_REG</code>ï¼‰ä¿®æ”¹ä¸ºâ€å¾…å›æ”¶â€ï¼ˆ<code>PT_TRIM</code>ï¼‰ã€‚</li><li><strong>OS å›æ”¶</strong>ï¼šOS å¯ä»¥é€šè¿‡ <code>EREMOVE</code> æŒ‡ä»¤å®‰å…¨åœ°å›æ”¶è¿™äº›è¢«æ ‡è®°ä¸º <code>PT_TRIM</code> çš„é¡µé¢ï¼Œå¹¶å°†å…¶å½’è¿˜ç»™ç³»ç»Ÿã€‚</li></ol><p>é€šè¿‡è¿™ä¸€å¥—ç”±ç¡¬ä»¶æŒ‡ä»¤ä¿éšœçš„æµç¨‹ï¼ŒEDMM å®ç°äº†åœ¨ä¸ç ´åå®‰å…¨æ¨¡å‹çš„å‰æä¸‹ï¼Œå¯¹ Enclave å†…å­˜çš„åŠ¨æ€ã€å®‰å…¨ç®¡ç†ã€‚</p><hr><p><em>å†…å­˜å®‰å…¨æ˜¯åŸºç¡€ï¼Œä½†å¦‚ä½•è¯æ˜ä¸€ä¸ª Enclave çš„èº«ä»½æ˜¯å¯ä¿¡çš„ï¼Ÿæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨ SGX çš„â€æ€æ‰‹çº§åº”ç”¨â€â€”â€”è®¤è¯æœºåˆ¶ã€‚</em></p><h3 id="4-3-è®¤è¯æœºåˆ¶ï¼šæ„å»ºä¿¡ä»»çš„é˜¶æ¢¯"><a href="#4-3-è®¤è¯æœºåˆ¶ï¼šæ„å»ºä¿¡ä»»çš„é˜¶æ¢¯" class="headerlink" title="4.3 è®¤è¯æœºåˆ¶ï¼šæ„å»ºä¿¡ä»»çš„é˜¶æ¢¯"></a>4.3 è®¤è¯æœºåˆ¶ï¼šæ„å»ºä¿¡ä»»çš„é˜¶æ¢¯</h3><blockquote><p>è¿™ä¸€èŠ‚æ˜¯æœ‰ç†è§£éš¾åº¦çš„ï¼Œè¯·å…ˆè‡ªè¡Œç†è§£é€ æ•°å­—ç­¾ååŸç†ã€éå¯¹ç§°åŠ å¯†è¿™äº›ï¼Œä¸ç„¶å¾ˆéš¾ç†è§£é€è¿™ä¸ªä¿¡ä»»ä½“ç³»çš„æ­å»º</p></blockquote><p>ä»…ä»…åœ¨æœ¬åœ°ä¿æŠ¤å¥½ Enclave æ˜¯ä¸å¤Ÿçš„ã€‚åœ¨çœŸå®ä¸–ç•Œçš„åº”ç”¨ä¸­ï¼Œä¸€ä¸ª Enclave é€šå¸¸éœ€è¦ä¸å¤–éƒ¨ä¸–ç•Œäº¤äº’ï¼Œæ¯”å¦‚å‘ä¸€ä¸ªè¿œç¨‹æœåŠ¡å™¨è¯·æ±‚æ•æ„Ÿæ•°æ®ã€‚è¿™æ—¶ï¼Œè¿œç¨‹æœåŠ¡å™¨å¦‚ä½•æ‰èƒ½ç›¸ä¿¡å®ƒæ­£åœ¨ä¸ä¹‹é€šä¿¡çš„ï¼Œç¡®å®æ˜¯ä¸€ä¸ªåœ¨å®‰å…¨ã€æœªè¢«ç¯¡æ”¹çš„SGXç¯å¢ƒä¸­è¿è¡Œçš„ã€å†…å®¹æ­£ç¡®çš„Enclaveï¼Ÿ</p><p><strong>è®¤è¯ï¼ˆAttestationï¼‰æœºåˆ¶å°±æ˜¯ç”¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚</strong> å®ƒæ˜¯ä¸€ä¸ªåˆ†é˜¶æ®µå»ºç«‹ä¿¡ä»»çš„è¿‡ç¨‹ï¼Œå°±åƒçˆ¬ä¸€ä¸ªæ¢¯å­ï¼Œæ¯ä¸€é˜¶éƒ½ä¾èµ–äºå‰ä¸€é˜¶çš„ç¨³å›ºã€‚</p><h4 id="4-3-1-ä¿¡ä»»é˜¶æ¢¯çš„èµ·ç‚¹ï¼šCPUå†…éƒ¨çš„è‡ªæˆ‘ä¿¡ä»»-æœ¬åœ°è®¤è¯"><a href="#4-3-1-ä¿¡ä»»é˜¶æ¢¯çš„èµ·ç‚¹ï¼šCPUå†…éƒ¨çš„è‡ªæˆ‘ä¿¡ä»»-æœ¬åœ°è®¤è¯" class="headerlink" title="4.3.1 ä¿¡ä»»é˜¶æ¢¯çš„èµ·ç‚¹ï¼šCPUå†…éƒ¨çš„è‡ªæˆ‘ä¿¡ä»» (æœ¬åœ°è®¤è¯)"></a>4.3.1 ä¿¡ä»»é˜¶æ¢¯çš„èµ·ç‚¹ï¼šCPUå†…éƒ¨çš„è‡ªæˆ‘ä¿¡ä»» (æœ¬åœ°è®¤è¯)</h4><ul><li><strong>åœºæ™¯</strong>ï¼šåœ¨åŒä¸€å°ç‰©ç†æœºä¸Šï¼Œæœ‰ä¸¤ä¸ªä¸åŒçš„ Enclaveï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸º Enclave A å’Œ Enclave Bï¼‰ï¼Œå®ƒä»¬éœ€è¦ç›¸äº’éªŒè¯å¯¹æ–¹çš„èº«ä»½ï¼Œå¹¶å»ºç«‹ä¸€ä¸ªå®‰å…¨çš„é€šä¿¡ä¿¡é“ã€‚</li><li><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼šåˆ©ç”¨ CPU ä½œä¸ºå¯ä¿¡çš„ä¸­é—´äººï¼Œé€šè¿‡ä¸€ä¸ªåªæœ‰æœ¬æœºç¡¬ä»¶èƒ½ç”Ÿæˆå’ŒéªŒè¯çš„æŠ¥å‘Š (<code>REPORT</code>) æ¥äº¤æ¢èº«ä»½ä¿¡æ¯ã€‚</li></ul><p> <strong>æµç¨‹è¯¦è§£ï¼š</strong></p><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  sequenceDiagram    participant Enclave_A as Enclave A (å‘èµ·è€…)    participant CPU_Hardware as CPU Hardware    participant Enclave_B as Enclave B (ç›®æ ‡)    Enclave_A-&gt;&gt;CPU_Hardware: 1. EREPORT æŒ‡ä»¤&lt;br&gt;è¯·æ±‚ç”Ÿæˆå…³äºè‡ªå·±çš„æŠ¥å‘Š&lt;br&gt;å¹¶æŒ‡å®šç›®æ ‡ä¸º Enclave B    CPU_Hardware-&gt;&gt;CPU_Hardware: 2. (a) ç”¨ Report Key å’Œ B çš„èº«ä»½&lt;br&gt;    æ´¾ç”Ÿå‡º&#39;æ´¾ç”ŸæŠ¥å‘Šå¯†é’¥&#39;&lt;br&gt;(b) ç”ŸæˆREPORT, åŒ…å«Açš„èº«ä»½&lt;br&gt;(c) ç”¨&#39;æ´¾ç”ŸæŠ¥å‘Šå¯†é’¥&#39;ç­¾åMAC    CPU_Hardware--&gt;&gt;Enclave_A: 3. è¿”å›å·²ç­¾åçš„REPORT    Enclave_A-&gt;&gt;Enclave_B: 4. (é€šè¿‡ä¸å¯ä¿¡å†…å­˜) å‘é€REPORT    Enclave_B-&gt;&gt;CPU_Hardware: 5. EGETKEY æŒ‡ä»¤&lt;br&gt;è¯·æ±‚è·å–ç”¨äºéªŒè¯&lt;br&gt;æ¥è‡ª A çš„æŠ¥å‘Šçš„å¯†é’¥    CPU_Hardware-&gt;&gt;CPU_Hardware: 6. å†æ¬¡æ´¾ç”Ÿå‡º&lt;br&gt;åŒä¸€ä¸ª&#39;æ´¾ç”ŸæŠ¥å‘Šå¯†é’¥&#39;    CPU_Hardware--&gt;&gt;Enclave_B: 7. è¿”å›&#39;æ´¾ç”ŸæŠ¥å‘Šå¯†é’¥&#39;    Enclave_B-&gt;&gt;Enclave_B: 8. (a) ç”¨å¯†é’¥éªŒè¯REPORTçš„MAC&lt;br&gt;(b) è‹¥æˆåŠŸ, ä¿¡ä»»Açš„èº«ä»½  </pre></div><ol><li><strong>Enclave A è¯·æ±‚å®šå‘æŠ¥å‘Š</strong>ï¼šEnclave A è°ƒç”¨<code>EREPORT</code>æŒ‡ä»¤ã€‚æœ€å…³é”®çš„æ˜¯ï¼Œå®ƒåœ¨æŒ‡ä»¤ä¸­æ˜ç¡®å°† <strong>Enclave B çš„èº«ä»½æ ‡è¯†</strong>ï¼ˆå¦‚<code>MRENCLAVE</code>ï¼‰ä½œä¸º<strong>ç›®æ ‡</strong>ã€‚å®ƒè¿˜å¯ä»¥åœ¨<code>REPORTDATA</code>å­—æ®µä¸­æ”¾å…¥è‡ªå·±çš„ä¸´æ—¶é€šä¿¡å…¬é’¥å“ˆå¸Œï¼Œç”¨äºåç»­å»ºç«‹å®‰å…¨ä¿¡é“ã€‚</li><li><strong>CPU æ´¾ç”Ÿå¯†é’¥å¹¶ç”ŸæˆæŠ¥å‘Š</strong>ï¼šCPUç¡¬ä»¶æ‰§è¡Œ<code>EREPORT</code>ï¼š<ul><li><strong>æ´¾ç”Ÿå¯†é’¥</strong>ï¼šå®ƒå–å‡ºè‡ªå·±å†…éƒ¨çš„<code>Report Key</code>å’ŒæŒ‡ä»¤ä¸­æŒ‡å®šçš„ç›®æ ‡ï¼ˆEnclave Bï¼‰èº«ä»½ï¼Œé€šè¿‡å¯†é’¥æ´¾ç”Ÿå‡½æ•°ï¼ˆKDFï¼‰è®¡ç®—å‡ºä¸€ä¸ª**ä¸€æ¬¡æ€§çš„ã€ä¸“ç”¨äºæœ¬æ¬¡ A-&gt;B é€šä¿¡çš„<code>æ´¾ç”ŸæŠ¥å‘Šå¯†é’¥</code>**ã€‚</li><li><strong>è®¡ç®—MAC</strong>ï¼šCPUä½¿ç”¨è¿™ä¸ªæ–°é²œå‡ºç‚‰çš„<code>æ´¾ç”ŸæŠ¥å‘Šå¯†é’¥</code>ï¼Œä¸ºåŒ…å«Enclave Aèº«ä»½å’Œæ•°æ®çš„<code>REPORT</code>å†…å®¹è®¡ç®—ä¸€ä¸ªMACã€‚</li></ul></li><li><strong>è¿”å›æŠ¥å‘Š</strong>ï¼šCPUå°†å®Œæ•´çš„<code>REPORT</code>ï¼ˆå†…å®¹ + MACï¼‰è¿”å›ç»™Enclave Aã€‚</li><li><strong>è½¬å‘æŠ¥å‘Š</strong>ï¼šEnclave A é€šè¿‡æ™®é€šå†…å­˜å°†è¿™ä»½æŠ¥å‘Šå‘é€ç»™ Enclave Bã€‚</li><li><strong>Enclave B è¯·æ±‚éªŒè¯å¯†é’¥</strong>ï¼šEnclave B æ”¶åˆ°æŠ¥å‘Šåï¼Œä¸ºäº†éªŒè¯å®ƒï¼Œéœ€è¦è·å–åŒä¸€ä¸ª<code>æ´¾ç”ŸæŠ¥å‘Šå¯†é’¥</code>ã€‚å®ƒä¼šè°ƒç”¨<code>EGETKEY</code>æŒ‡ä»¤ï¼Œå‘CPUç”³è¯·ä¸€ä¸ªç”¨äºéªŒè¯<strong>æ¥è‡ªEnclave A</strong>çš„æŠ¥å‘Šçš„å¯†é’¥ã€‚</li><li><strong>CPU å†æ¬¡æ´¾ç”Ÿ</strong>ï¼šå› ä¸ºEnclave Bæ˜¯å½“åˆæŒ‡å®šçš„åˆæ³•ç›®æ ‡ï¼ŒCPUä¼šå†æ¬¡æ‰§è¡Œå®Œå…¨ç›¸åŒçš„æ´¾ç”Ÿè¿‡ç¨‹ï¼Œå¹¶å°†**åŒä¸€ä¸ª<code>æ´¾ç”ŸæŠ¥å‘Šå¯†é’¥</code>**å®‰å…¨åœ°äº¤ç»™Enclave Bã€‚</li><li><strong>Enclave B éªŒè¯</strong>ï¼šEnclave B ä½¿ç”¨è·å–åˆ°çš„å¯†é’¥ï¼Œé‡æ–°è®¡ç®—æ”¶åˆ°<code>REPORT</code>å†…å®¹çš„MACï¼Œå¹¶ä¸æŠ¥å‘Šé™„å¸¦çš„MACè¿›è¡Œæ¯”å¯¹ã€‚</li><li><strong>å»ºç«‹ä¿¡ä»»</strong>ï¼šå¦‚æœMACåŒ¹é…ï¼ŒEnclave Bå°±è·å¾—äº†ç¡¬ä»¶çº§åˆ«çš„ä¿¡ä»»ï¼Œç¡®ä¿¡è¿™ä»½æŠ¥å‘Šç¡®å®æ¥è‡ªEnclave Aï¼Œå†…å®¹æœªç»ç¯¡æ”¹ï¼Œä¸”å°±æ˜¯å‘ç»™è‡ªå·±çš„ã€‚æœ¬åœ°è®¤è¯æˆåŠŸã€‚</li></ol><p><strong>æ€»ç»“</strong>ï¼šæœ¬åœ°è®¤è¯é€šè¿‡<strong>å¯†é’¥æ´¾ç”Ÿ</strong>æœºåˆ¶ï¼Œå®ç°äº†ç¡¬ä»¶çº§åˆ«çš„è®¿é—®æ§åˆ¶å’Œèº«ä»½éªŒè¯ã€‚å®ƒé«˜æ•ˆä¸”è½»é‡ï¼Œå› ä¸ºå®ƒå®Œå…¨åœ¨ CPU å†…éƒ¨å®Œæˆï¼Œä¸æ¶‰åŠå¤–éƒ¨é€šä¿¡ã€‚å®ƒä½¿å¾—åŒä¸€å¹³å°ä¸Šçš„å¤šä¸ª Enclave å¯ä»¥å®‰å…¨åœ°åä½œï¼Œæ˜¯æ‰€æœ‰åç»­ä¿¡ä»»çš„åŸºç¡€ã€‚</p><hr><h4 id="4-3-2-è¿œç¨‹è®¤è¯ï¼šæ„å»ºè·¨ç½‘ç»œçš„ä¿¡ä»»é“¾"><a href="#4-3-2-è¿œç¨‹è®¤è¯ï¼šæ„å»ºè·¨ç½‘ç»œçš„ä¿¡ä»»é“¾" class="headerlink" title="4.3.2 è¿œç¨‹è®¤è¯ï¼šæ„å»ºè·¨ç½‘ç»œçš„ä¿¡ä»»é“¾"></a>4.3.2 è¿œç¨‹è®¤è¯ï¼šæ„å»ºè·¨ç½‘ç»œçš„ä¿¡ä»»é“¾</h4><p>è¿™æ˜¯SGXæœ€æ ¸å¿ƒã€æœ€å¼ºå¤§çš„åŠŸèƒ½ã€‚å®ƒæ—¨åœ¨è§£å†³ä¸€ä¸ªç»ˆæé—®é¢˜ï¼š<strong>è¿œç¨‹æœåŠ¡å™¨å¦‚ä½•èƒ½ç»å¯¹ç›¸ä¿¡ï¼Œå®ƒæ­£åœ¨é€šä¿¡çš„å¯¹è±¡ï¼Œç¡®å®æ˜¯ä¸€ä¸ªè¿è¡Œåœ¨å®‰å…¨ã€æ­£ç‰ˆIntelç¡¬ä»¶ä¸Šã€æœªè¢«ç¯¡æ”¹çš„ã€ä¸”å†…å®¹æ­£ç¡®çš„Enclaveï¼Ÿ</strong></p><p>ä¸ºäº†å®ç°è¿™ä¸ªç›®æ ‡ï¼ŒSGXè®¾è®¡äº†ä¸€å¥—ç²¾å¯†çš„ã€ç¯ç¯ç›¸æ‰£çš„ä¿¡ä»»é“¾ã€‚æˆ‘ä»¬é¦–å…ˆæ¥çœ‹å®Œæ•´çš„æµç¨‹ï¼Œç„¶åå†æ·±å…¥å‰–ææ¯ä¸€æ­¥èƒŒåçš„è®¾è®¡å“²å­¦ã€‚</p><h5 id="a-è¿œç¨‹è®¤è¯çš„å®Œæ•´æµç¨‹"><a href="#a-è¿œç¨‹è®¤è¯çš„å®Œæ•´æµç¨‹" class="headerlink" title="a) è¿œç¨‹è®¤è¯çš„å®Œæ•´æµç¨‹"></a>a) è¿œç¨‹è®¤è¯çš„å®Œæ•´æµç¨‹</h5><p><strong>æµç¨‹æ€»è§ˆå›¾ï¼š</strong></p><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  sequenceDiagram    participant App_Enclave as åº”ç”¨é£åœ°    participant QE as Quoting Enclave    participant PCE as Provisioning&lt;br&gt;Certification Enclave    participant Challenger as è¿œç¨‹æŒ‘æˆ˜è€…(æœåŠ¡å•†)    participant Intel_IAS as Intelè®¤è¯æœåŠ¡(IAS)    participant Intel_Provisioning as Intelä¾›åº”æœåŠ¡    Note over QE, Intel_Provisioning: é˜¶æ®µã€‡: å¹³å°é¦–æ¬¡å¯åŠ¨æˆ–QEæ›´æ–°æ—¶&lt;br&gt;æ‰§è¡Œä¸€æ¬¡æ€§çš„å¯†é’¥ä¾›åº”æµç¨‹    PCE--&gt;&gt;Intel_Provisioning: (1) PCEç”¨ç‰¹æƒå¯†é’¥å‘Intelè¯·æ±‚    Intel_Provisioning--&gt;&gt;PCE: (2) InteléªŒè¯å, é¢å‘å¹³å°ç§é’¥(Attestation Key)    PCE--&gt;&gt;QE: (3) PCEå°†ç§é’¥å®‰å…¨è½¬äº¤QE    Note over App_Enclave, Challenger: é˜¶æ®µä¸€: åº”ç”¨å‘èµ·è¿œç¨‹è®¤è¯    App_Enclave-&gt;&gt;QE: (4) ç”ŸæˆREPORT(å«MRENCLAVE, PubKeyHash)    QE--&gt;&gt;App_Enclave: (5) QEç”¨å¹³å°ç§é’¥ç­¾åREPORT, ç”ŸæˆQUOTE    Note over App_Enclave, Challenger: é˜¶æ®µäºŒ: è¿œç¨‹éªŒè¯ä¸å»ºç«‹ä¿¡ä»»    App_Enclave-&gt;&gt;Challenger: (6) å‘é€QUOTEåŠä¸´æ—¶å…¬é’¥åˆ°è¿œç¨‹    Challenger-&gt;&gt;Intel_IAS: (7) è½¬å‘QUOTEè¯·æ±‚æœ€ç»ˆè£å†³        Intel_IAS--&gt;&gt;Intel_IAS: (8) éªŒè¯QUOTEç­¾å, æ£€æŸ¥TCBçŠ¶æ€    Intel_IAS--&gt;&gt;Challenger: (9) è¿”å›ç­¾åçš„è®¤è¯æŠ¥å‘Š (Verdict)    Challenger--&gt;&gt;Challenger: (10) (a) éªŒè¯IASç­¾å&lt;br&#x2F;&gt;(b) è‹¥OK, æ£€æŸ¥MRENCLAVE&#x2F;MRSIGNER&lt;br&#x2F;&gt;(c) éªŒè¯ä¸´æ—¶å…¬é’¥, å»ºç«‹å®‰å…¨ä¿¡é“  </pre></div><p><strong>åˆ†æ­¥è¯¦è§£ï¼š</strong></p><ul><li><p><strong>é˜¶æ®µã€‡ï¼šå¯†é’¥ä¾›åº” (ä¸€æ¬¡æ€§)</strong></p><ol><li><strong>PCEè¯·æ±‚</strong>: åœ¨å¹³å°é¦–æ¬¡é…ç½®SGXæˆ–QEæ›´æ–°æ—¶ï¼Œæ‹¥æœ‰ç‰¹æ®Šèº«ä»½çš„PCEä¼šå‘Intelä¾›åº”æœåŠ¡å‘èµ·è¯·æ±‚ã€‚</li><li><strong>Intelé¢å‘</strong>: IntelæœåŠ¡å™¨éªŒè¯PCEçš„èº«ä»½åï¼Œä¼šä¸ºå½“å‰å¹³å°ç”Ÿæˆä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„å¹³å°ç§é’¥ï¼ˆAttestation Keyï¼‰ã€‚</li><li><strong>PCEè½¬äº¤</strong>: PCEå°†è¿™ä¸ªå¯†é’¥å®‰å…¨åœ°è½¬äº¤ç»™QEã€‚QEä¼šå°†å…¶â€å¯†å°â€ä¿å­˜ï¼Œä¾›åç»­ä½¿ç”¨ã€‚</li></ol></li><li><p><strong>é˜¶æ®µä¸€ï¼šç”Ÿæˆè®¤è¯æŠ¥å‘Š (QUOTE)</strong></p><ol start="4"><li><strong>åº”ç”¨ç”ŸæˆREPORT</strong>: å½“åº”ç”¨é£åœ°éœ€è¦è¿œç¨‹è®¤è¯æ—¶ï¼Œå®ƒä¼šè°ƒç”¨<code>EREPORT</code>æŒ‡ä»¤ï¼Œç”Ÿæˆä¸€ä»½åŒ…å«è‡ªèº«èº«ä»½ï¼ˆ<code>MRENCLAVE</code>ï¼‰å’Œé€šä¿¡å…¬é’¥å“ˆå¸Œï¼ˆ<code>REPORTDATA</code>ï¼‰çš„æœ¬åœ°æŠ¥å‘Š<code>REPORT</code>ã€‚</li><li><strong>QEç”ŸæˆQUOTE</strong>: åº”ç”¨é£åœ°å°†<code>REPORT</code>å‘é€ç»™QEã€‚QEé¦–å…ˆåœ¨æœ¬åœ°éªŒè¯<code>REPORT</code>çš„çœŸå®æ€§ï¼Œç„¶åç”¨é˜¶æ®µã€‡è·å–çš„å¹³å°ç§é’¥å¯¹å…¶è¿›è¡Œç­¾åï¼Œç”Ÿæˆæœ€ç»ˆçš„â€å¯è·¨å›½å…¬è¯ä¹¦â€â€”â€”<code>QUOTE</code>ã€‚</li></ol></li><li><p><strong>é˜¶æ®µäºŒï¼šè¿œç¨‹éªŒè¯ä¸å»ºç«‹ä¿¡ä»»</strong></p><ol start="6"><li><strong>å‘é€è‡³æœåŠ¡å•†</strong>: å®¢æˆ·ç«¯å°†<code>QUOTE</code>å’Œç”¨äºé€šä¿¡çš„ä¸´æ—¶å…¬é’¥å‘é€ç»™è¿œç¨‹æœåŠ¡å•†ï¼ˆæŒ‘æˆ˜è€…ï¼‰ã€‚</li><li><strong>è½¬å‘è‡³IAS</strong>: æœåŠ¡å•†ä¸ç›´æ¥éªŒè¯<code>QUOTE</code>ï¼Œè€Œæ˜¯å°†å…¶åŸæ ·è½¬å‘ç»™Intelè®¤è¯æœåŠ¡ï¼ˆIASï¼‰ã€‚</li><li><strong>IASæœ€ç»ˆè£å†³</strong>: IASä½œä¸ºæœ€ç»ˆæƒå¨ï¼Œä¼šéªŒè¯<code>QUOTE</code>çš„ç­¾åï¼Œå¹¶æ£€æŸ¥å¹³å°çš„å¯ä¿¡è®¡ç®—åŸºï¼ˆTCBï¼‰ç‰ˆæœ¬æ˜¯å¦å®‰å…¨ã€‚</li><li><strong>è¿”å›è®¤è¯æŠ¥å‘Š</strong>: IASå‘æœåŠ¡å•†è¿”å›ä¸€ä»½ç­¾åçš„æŠ¥å‘Šï¼ˆVerdictï¼‰ï¼Œå‘ŠçŸ¥<code>QUOTE</code>æ˜¯å¦å¯ä¿¡ã€‚</li><li><strong>å»ºç«‹ä¿¡ä»»</strong>: æœåŠ¡å•†éªŒè¯IASçš„ç­¾ååï¼Œå¦‚æœç»“æœOKï¼Œå°±ä¼šä¿¡ä»»è¯¥Enclaveçš„èº«ä»½ã€‚å®ƒä¼šæ£€æŸ¥<code>MRENCLAVE</code>å’Œ<code>MRSIGNER</code>æ˜¯å¦ç¬¦åˆå…¶ç­–ç•¥ï¼Œå¹¶ç”¨å®¢æˆ·ç«¯å‘æ¥çš„ä¸´æ—¶å…¬é’¥å»ºç«‹ç«¯åˆ°ç«¯çš„å®‰å…¨ä¿¡é“ã€‚</li></ol></li></ul><hr><h5 id="b-æ·±åº¦è§£æï¼šä¿¡ä»»é“¾çš„æ„å»ºç»†èŠ‚"><a href="#b-æ·±åº¦è§£æï¼šä¿¡ä»»é“¾çš„æ„å»ºç»†èŠ‚" class="headerlink" title="b) æ·±åº¦è§£æï¼šä¿¡ä»»é“¾çš„æ„å»ºç»†èŠ‚"></a>b) æ·±åº¦è§£æï¼šä¿¡ä»»é“¾çš„æ„å»ºç»†èŠ‚</h5><p>ç°åœ¨ï¼Œæˆ‘ä»¬æ¥å›ç­”é‚£äº›å…³é”®çš„â€ä¸ºä»€ä¹ˆâ€å’Œâ€å¦‚ä½•åšåˆ°â€ã€‚</p><p><strong>1. ä¸ºä»€ä¹ˆéœ€è¦ä¸­é—´äºº(QE)ï¼Ÿ</strong></p><p>è¿™æ˜¯ä¸€ä¸ªæ ¸å¿ƒçš„æ¶æ„è®¾è®¡é—®é¢˜ï¼Œç­”æ¡ˆæ˜¯<strong>æƒè´£åˆ†ç¦»</strong>ä¸<strong>é£é™©éš”ç¦»</strong>ã€‚</p><table><thead><tr><th align="left">å­˜åœ¨çš„é—®é¢˜</th><th align="left">QEè§£å†³æ–¹æ¡ˆ (<code>Quoting Enclave</code>)</th></tr></thead><tbody><tr><td align="left"><strong>å¯†é’¥ç®¡ç†çš„ç¾éš¾</strong>: è®©æ¯ä¸ªåº”ç”¨éƒ½å»ç®¡ç†é«˜é£é™©çš„å¹³å°ç§é’¥ï¼Œæ˜¯ä¸ç°å®ä¸”å±é™©çš„ã€‚</td><td align="left"><strong>å¯†é’¥æ‰€æœ‰æƒéš”ç¦»</strong>: å¹³å°ç§é’¥å±äºå¹³å°ï¼Œç”±Intelç­¾åçš„æ ‡å‡†åŒ–ä»£ç†QEç»Ÿä¸€ä¿ç®¡ï¼Œåº”ç”¨æ— æƒæ¥è§¦ã€‚</td></tr><tr><td align="left"><strong>å®‰å…¨è´£ä»»çš„ç¾éš¾</strong>: åº”ç”¨çš„æ¼æ´å¯èƒ½å¯¼è‡´å¹³å°å¯†é’¥æ³„éœ²ï¼Œå¨èƒæ•´ä¸ªå¹³å°çš„è®¤è¯èƒ½åŠ›ã€‚</td><td align="left"><strong>å‡å°‘æ”»å‡»é¢</strong>: QEä»£ç ç²¾ç®€ã€å®¡æŸ¥ä¸¥æ ¼ã€‚åº”ç”¨æ¼æ´ä¸ä¼šå½±å“åˆ°å¹³å°è®¤è¯æœºåˆ¶æœ¬èº«ï¼Œå®ç°äº†å®‰å…¨éš”ç¦»ã€‚</td></tr><tr><td align="left"><strong>å¤æ‚æ€§çš„ç¾éš¾</strong>: åº”ç”¨å¼€å‘è€…è¢«è¿«æˆä¸ºå¯†ç å­¦å’Œåº•å±‚è®¤è¯åè®®çš„ä¸“å®¶ã€‚</td><td align="left"><strong>èŒè´£åˆ†ç¦»</strong>: QEå°è£…äº†æ‰€æœ‰å¤æ‚çš„è®¤è¯é€»è¾‘ï¼Œåº”ç”¨åªéœ€è°ƒç”¨ç®€å•æ¥å£ï¼Œä¸“æ³¨äºè‡ªèº«ä¸šåŠ¡å³å¯ã€‚</td></tr></tbody></table><p><strong>ç»“è®º</strong>: QEæ˜¯ä¸€ä¸ª<strong>ç³»ç»Ÿçº§çš„ã€æ ‡å‡†åŒ–çš„è®¤è¯ä»£ç†</strong>ï¼Œå®ƒéš”ç¦»äº†å¤æ‚æ€§å’Œå…³é”®å¯†é’¥ï¼Œè®©åº”ç”¨å¯ä»¥å®‰å…¨ã€ç®€å•åœ°è¯·æ±‚è®¤è¯æœåŠ¡ã€‚</p><p><strong>2. QEå¦‚ä½•è‡ªè¯åˆæ³•ï¼Ÿè°æ¥ä¸ºQEä½œä¿ï¼Ÿ</strong></p><p>QEè‡ªå·±æ— æ³•å‘Intelè¯æ˜â€æˆ‘æ˜¯åˆæ³•çš„QEâ€ã€‚å®ƒéœ€è¦ä¸€ä¸ªæ›´å¯ä¿¡çš„å®ä½“æ¥ä¸ºå®ƒä½œä¿ï¼Œè¿™ä¸ªå®ä½“å°±æ˜¯**PCE (Provisioning Certification Enclave)**ã€‚</p><p>åœ¨å¯†é’¥ä¾›åº”æµç¨‹ï¼ˆé˜¶æ®µã€‡ï¼‰ä¸­ï¼ŒQEä¸PCEä¹‹é—´è¿›è¡Œäº†ä¸€æ¬¡<strong>æœ¬åœ°è®¤è¯</strong>ï¼Œè¿™èƒŒåæ˜¯ä¸€å¥—ç²¾å¯†çš„ç¡¬ä»¶æœºåˆ¶ï¼š</p><ol><li><strong>QEç”Ÿæˆå®šå‘æŠ¥å‘Š</strong>: QEè°ƒç”¨<code>EREPORT</code>æŒ‡ä»¤ï¼Œåœ¨æŒ‡ä»¤ä¸­æ˜ç¡®æŒ‡å®š<strong>PCEä½œä¸ºæŠ¥å‘Šçš„ç›®æ ‡</strong>ã€‚</li><li><strong>CPUç¡¬ä»¶ä½¿ç”¨æ´¾ç”Ÿå¯†é’¥ç”ŸæˆMAC</strong>: CPUç¡¬ä»¶æ ¹æ®QEçš„è¯·æ±‚ï¼Œç”Ÿæˆ<code>REPORT</code>ã€‚å…³é”®åœ¨äºï¼Œå®ƒ<strong>å¹¶ä¸ä¼šç›´æ¥ä½¿ç”¨<code>Report Key</code><strong>ï¼Œè€Œæ˜¯ä¼šæ‰§è¡Œä¸€ä¸ª</strong>å¯†é’¥æ´¾ç”Ÿ (Key Derivation)</strong> çš„è¿‡ç¨‹æ¥ç”Ÿæˆä¸€ä¸ªä¸€æ¬¡æ€§çš„å¯¹ç§°å¯†é’¥ã€‚<ul><li><strong>æ·±åº¦è§£æï¼šä»€ä¹ˆæ˜¯â€æ´¾ç”Ÿå¯†é’¥â€ï¼Ÿ</strong><ul><li><strong>å®ƒä¸æ˜¯Report Keyæœ¬èº«</strong>ï¼šæ´¾ç”Ÿå¯†é’¥æ˜¯ä¸€ä¸ªå…¨æ–°çš„ã€ä¸ºæœ¬æ¬¡é€šä¿¡ä¸´æ—¶ç”Ÿæˆçš„å¯¹ç§°å¯†é’¥ã€‚</li><li><strong>æ¥æº</strong>ï¼šå®ƒç”±CPUç¡¬ä»¶é€šè¿‡ä¸€ä¸ªæ ‡å‡†çš„å¯†ç å­¦å‡½æ•°ï¼ˆå¯†é’¥æ´¾ç”Ÿå‡½æ•°, KDFï¼‰è®¡ç®—å¾—æ¥ã€‚</li><li>**æ´¾ç”Ÿâ€åŸæ–™â€**ï¼šKDFçš„è¾“å…¥æ˜¯ï¼š1) æ°¸ä¸æš´éœ²çš„<code>Report Key</code>ï¼ˆä½œä¸ºä¸»å¯†é’¥ï¼‰å’Œ 2) ç›®æ ‡Enclaveçš„èº«ä»½æ ‡è¯†ï¼ˆæ¯”å¦‚PCEçš„<code>MRENCLAVE</code>ï¼‰ã€‚</li><li><strong>æ¯”å–»</strong>ï¼š<code>Report Key</code>å°±åƒä¸€æŠŠä¸‡èƒ½çš„â€ä¸»æ¨¡å…·â€ã€‚å½“è¦ä¸ºPCEè¿™æ‰‡â€é—¨â€é…ä¸€æŠŠé’¥åŒ™æ—¶ï¼ŒCPUå°±ç”¨â€ä¸»æ¨¡å…·â€+PCEé—¨ç‹¬æœ‰çš„èŠ±çº¹â€ï¼Œåˆ¶é€ å‡ºä¸€æŠŠç‹¬ä¸€æ— äºŒçš„é’¥åŒ™ã€‚è¿™æŠŠé’¥åŒ™å°±æ˜¯æ´¾ç”Ÿå¯†é’¥ã€‚</li><li><strong>ä¸ºä½•è¦æ´¾ç”Ÿï¼Ÿ</strong>ï¼šè¿™æ˜¯ä¸ºäº†å®ç°ç²¾ç¡®çš„è®¿é—®æ§åˆ¶ã€‚åªæœ‰æŒ‡å®šçš„ç›®æ ‡ï¼ˆPCEï¼‰æ‰èƒ½å‘CPUæä¾›æ­£ç¡®çš„â€èŠ±çº¹â€ï¼ˆè‡ªå·±çš„èº«ä»½ï¼‰ï¼Œä»è€Œæ´¾ç”Ÿå‡ºåŒä¸€æŠŠé’¥åŒ™æ¥å®ŒæˆéªŒè¯ã€‚è¿™ä»ç¡¬ä»¶ä¸Šä¿è¯äº†æŠ¥å‘Šä¸ä¼šè¢«é”™é¢†æˆ–è¢«éç›®æ ‡éªŒè¯ã€‚</li></ul></li></ul></li><li><strong>CPUè®¡ç®—MAC</strong>: CPUç¡¬ä»¶ä½¿ç”¨è¿™ä¸ªåˆšåˆšæ´¾ç”Ÿå‡ºçš„å¯†é’¥ï¼Œä¸º<code>REPORT</code>çš„å®Œæ•´å†…å®¹è®¡ç®—MACï¼Œå¹¶é™„åŠ åœ¨æŠ¥å‘Šæœ«å°¾ã€‚</li><li><strong>PCEéªŒè¯MAC</strong>: QEå°†è¿™ä»½å¸¦MACçš„<code>REPORT</code>äº¤ç»™PCEã€‚PCEä¸ºäº†éªŒè¯ï¼Œä¼šå‘CPUè¯·æ±‚<strong>é‡æ–°æ´¾ç”Ÿå‡ºåŒä¸€ä¸ªå¯†é’¥</strong>ï¼ˆç¡¬ä»¶ä¼šå› ä¸ºPCEæ˜¯åˆæ³•ç›®æ ‡æ–¹è€ŒæˆåŠŸæ´¾ç”Ÿï¼‰ã€‚PCEä½¿ç”¨æ­¤å¯†é’¥é‡æ–°è®¡ç®—<code>REPORT</code>çš„MACï¼Œå¹¶ä¸æ”¶åˆ°çš„MACè¿›è¡Œæ¯”å¯¹ã€‚</li><li><strong>å»ºç«‹ä¿¡ä»»</strong>: å¦‚æœMACåŒ¹é…ï¼ŒPCEå°±è·å¾—äº†ç¡¬ä»¶çº§åˆ«çš„ä¿è¯ï¼šè¿™ä»½<code>REPORT</code>ç¡®å®æ¥è‡ªæœ¬æœºCPUï¼Œå†…å®¹æœªç»ç¯¡æ”¹ï¼Œä¸”çœŸçš„æ˜¯å‘ç»™è‡ªå·±çš„ã€‚PCEæ­¤æ—¶ä¾¿å¯ä¿¡ä»»<code>REPORT</code>ä¸­çš„<code>MRSIGNER</code>ï¼Œå¹¶æ£€æŸ¥å…¶æ˜¯å¦ä¸Intelå®˜æ–¹å‘å¸ƒçš„QEèº«ä»½ç›¸ç¬¦ã€‚</li></ol><p>é€šè¿‡è¿™å¥—æœºåˆ¶ï¼Œ<strong>PCEä¸ºQEçš„åˆæ³•æ€§ä½œå‡ºäº†æ‹…ä¿</strong>ï¼Œå¹¶åŒæ„ä¸ºå®ƒç»§ç»­æ‰§è¡Œå¯†é’¥ç”³è¯·æµç¨‹ã€‚</p><p><strong>3. PCEå¦‚ä½•è‡ªè¯åˆæ³•ï¼Ÿä¿¡ä»»çš„çœŸæ­£èµ·æº</strong></p><p>æˆ‘ä»¬æŠŠä¿¡ä»»è¿½æº¯åˆ°äº†PCEï¼Œé‚£PCEçš„åˆæ³•æ€§åˆä»ä½•è€Œæ¥ï¼Ÿè¿™è§¦åŠäº†æ•´ä¸ªSGXä¿¡ä»»æ¨¡å‹çš„<strong>ç¡¬ä»¶ä¿¡ä»»æ ¹</strong>ã€‚</p><ul><li><strong>PCEçš„ç‰¹æ®Šèº«ä»½</strong>: PCEä¹Ÿæ˜¯ä¸€ä¸ªç”±Intelæä¾›çš„Enclaveï¼Œä½†å®ƒçš„ç‰¹æ®Šä¹‹å¤„åœ¨äºï¼Œå®ƒæ˜¯ç”¨<strong>Intelçš„æ ¹ç§é’¥ï¼ˆåˆ›ä¸–ç§é’¥ï¼‰</strong>ç­¾åçš„ã€‚</li><li><strong>ç¡¬ä»¶ä¿¡ä»»æ ¹</strong>: åœ¨CPUåˆ¶é€ è¿‡ç¨‹ä¸­ï¼ŒIntelæ ¹ç§é’¥å¯¹åº”çš„<strong>å…¬é’¥å“ˆå¸Œå€¼</strong>ï¼Œè¢«æ°¸ä¹…æ€§åœ°ã€ä¸å¯æ›´æ”¹åœ°<strong>çƒ§å½•åœ¨èŠ¯ç‰‡çš„ç¡¬ä»¶ç”µè·¯ä¸­</strong>ã€‚<ul><li><strong>å…³äºå“ˆå¸Œå€¼çš„ç»Ÿä¸€æ€§</strong>: æ˜¯çš„ï¼Œä¸ºäº†ä¿è¯ç”Ÿæ€çš„å…¼å®¹æ€§å’Œå¯æ‰©å±•æ€§ï¼Œ<strong>åŒä¸€ä»£çš„æ‰€æœ‰CPUéƒ½ä¼šçƒ§å½•ç›¸åŒçš„Intelæ ¹å…¬é’¥å“ˆå¸Œ</strong>ã€‚è¿™ä½¿å¾—ä¸€ä¸ªç”±Intelç»Ÿä¸€ç­¾åçš„PCEç¨‹åºï¼Œå¯ä»¥åœ¨æ‰€æœ‰è¿™äº›CPUä¸Šè¢«ä¸€è‡´åœ°è¯†åˆ«ä¸ºåˆæ³•ã€‚å¦‚æœæ¯ä¸ªCPUçš„å“ˆå¸Œéƒ½ä¸åŒï¼ŒIntelå°†ä¸å¾—ä¸ä¸ºæ¯ä¸€é¢—èŠ¯ç‰‡å•ç‹¬ç­¾åä¸€ä¸ªPCEï¼Œè¿™åœ¨å®è·µä¸­æ˜¯ä¸å¯è¡Œçš„ã€‚</li></ul></li><li><strong>ç¡¬ä»¶è®¤è¯</strong>: å½“PCEè¢«åŠ è½½æ—¶ï¼ŒCPUç¡¬ä»¶åœ¨<code>EINIT</code>è¿‡ç¨‹ä¸­ä¼šè®¡ç®—å…¶<code>MRSIGNER</code>ï¼ˆå³Intelæ ¹å…¬é’¥çš„å“ˆå¸Œï¼‰ï¼Œå¹¶å‘ç°å®ƒä¸èŠ¯ç‰‡å†…çƒ§å½•çš„å“ˆå¸Œå€¼<strong>å®Œå…¨åŒ¹é…</strong>ã€‚</li><li><strong>æˆäºˆç‰¹æƒ</strong>: è¿™ä¸ªç¡¬ä»¶å±‚é¢çš„åŒ¹é…ï¼Œå‘CPUè¯æ˜äº†PCEçš„è‡³é«˜æ— ä¸Šçš„èº«ä»½ã€‚å› æ­¤ï¼ŒCPUæˆäºˆPCEç‰¹æ®Šçš„ã€å…¶ä»–ä»»ä½•Enclaveéƒ½æ²¡æœ‰çš„æƒé™â€”â€”è®¿é—®**<code>Provisioning Key</code>**ã€‚è¿™æ˜¯ä¸€ä¸ªå¯¹ç§°å¯†é’¥ï¼Œç”±åŒä»£CPUå’ŒIntelä¾›åº”æœåŠ¡æ‰€å…±äº«ï¼Œä½†æ¯ä¸ªCPUçš„<code>Provisioning Key</code>éƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„ï¼Œä¿è¯äº†å³ä¾¿æ ¹å…¬é’¥å“ˆå¸Œç›¸åŒï¼Œæ¯ä¸ªå¹³å°çš„ä¿¡é“ä¹Ÿæ˜¯ç‹¬ç«‹çš„ã€‚</li></ul><p><strong>ç»“è®º</strong>: å¯¹PCEçš„ä¿¡ä»»ï¼Œæ¥è‡ªäº<strong>Intelçš„ç­¾å</strong>ä¸<strong>CPUç¡¬ä»¶çš„å†…ç½®æ ¡éªŒ</strong>ç›¸åŒ¹é…ã€‚è¿™æ˜¯ä¸€ä¸ªç¡¬ç¼–ç åœ¨ç¡…ç‰‡é‡Œçš„ä¿¡ä»»å…³ç³»ï¼Œæ˜¯æ•´ä¸ªSGXä¿¡ä»»æ¨¡å‹çš„â€ç¬¬ä¸€æ¨åŠ¨åŠ›â€ã€‚</p><p><strong>4. è®¤è¯é£æš´ï¼šæ‹†è§£æ‰€æœ‰å¯†é’¥ã€ç­¾åä¸å“ˆå¸Œ</strong></p><p>æ•´ä¸ªè¿œç¨‹è®¤è¯æµç¨‹æ¶‰åŠäº†å¤šç§å¯†ç å­¦å…ƒç´ ï¼Œç†è§£å®ƒä»¬å„è‡ªçš„ç”¨é€”æ˜¯å…³é”®ã€‚ä¸ºäº†æœ€æ¸…æ™°åœ°å±•ç¤ºï¼Œæˆ‘ä»¬å°†è¡¨æ ¼åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š<strong>å“ˆå¸Œ</strong>ã€<strong>å¯†é’¥</strong>ã€ä»¥åŠæœ€ç»ˆçš„<strong>ç­¾å&#x2F;è®¤è¯ç </strong>ã€‚</p><p><strong>Part 1: å“ˆå¸Œ (ä½œä¸ºèº«ä»½æ ‡è¯†)</strong></p><table><thead><tr><th align="left">åç§°</th><th align="left">æ¥æº&#x2F;ç”Ÿæˆè€…</th><th align="left">ä½œç”¨ä¸ç›®çš„</th><th align="left">ä¸å¯æˆ–ç¼ºçš„ç†ç”±</th></tr></thead><tbody><tr><td align="left"><code>MRENCLAVE</code></td><td align="left"><strong>CPUç¡¬ä»¶</strong> (åœ¨<code>EEXTEND</code>æ—¶)</td><td align="left">ä¸ºEnclaveä»£ç å’Œæ•°æ®ç”Ÿæˆå”¯ä¸€çš„â€DNAæŒ‡çº¹â€ã€‚</td><td align="left">ä¿è¯<strong>å®Œæ•´æ€§</strong>ï¼Œç¡®è®¤Enclaveå†…å®¹æœªè¢«ç¯¡æ”¹ã€‚</td></tr><tr><td align="left"><code>MRSIGNER</code></td><td align="left"><strong>CPUç¡¬ä»¶</strong> (åœ¨<code>EINIT</code>æ—¶)</td><td align="left">ä¸ºå¼€å‘è€…å…¬é’¥ç”Ÿæˆå”¯ä¸€çš„â€èº«ä»½æ ‡ç­¾â€ã€‚</td><td align="left">ä¿è¯<strong>å¼€å‘è€…èº«ä»½</strong>çš„ä¸€è‡´æ€§ï¼Œç”¨äºç­–ç•¥æ£€æŸ¥å’Œæ•°æ®ç‰ˆæœ¬å‡çº§ã€‚</td></tr></tbody></table><p><strong>Part 2: å¯†é’¥ (ä½œä¸ºåŠ å¯†å’Œç­¾åçš„å·¥å…·)</strong></p><table><thead><tr><th align="left">ç±»å‹</th><th align="left">åç§°</th><th align="left">æ¥æº&#x2F;ç”Ÿæˆè€…</th><th align="left">ä½œç”¨ä¸ç›®çš„</th></tr></thead><tbody><tr><td align="left"><strong>å¯¹ç§°å¯†é’¥</strong></td><td align="left"><strong><code>Report Key</code></strong></td><td align="left"><strong>CPUç¡¬ä»¶</strong> (åˆ¶é€ æ—¶çƒ§å½•, æ¯é¢—CPUå”¯ä¸€)</td><td align="left">ä½œä¸ºCPUçš„ç§˜å¯†æŒ‡çº¹ï¼Œæ˜¯æ´¾ç”Ÿå…¶ä»–æœ¬åœ°è®¤è¯å¯†é’¥çš„æ ¹æºã€‚</td></tr><tr><td align="left"></td><td align="left"><strong><code>Root Seal Key (RSK)</code></strong></td><td align="left"><strong>CPUç¡¬ä»¶</strong> (åˆ¶é€ æ—¶çƒ§å½•, æ¯é¢—CPUå”¯ä¸€)</td><td align="left">ä½œä¸ºCPUçš„å¦ä¸€ç§˜å¯†æŒ‡çº¹ï¼Œæ˜¯æ´¾ç”Ÿæ‰€æœ‰â€å¯†å°å¯†é’¥â€çš„æ ¹æºï¼Œç”¨äºæ•°æ®æŒä¹…åŒ–åŠ å¯† (å°†åœ¨ä¸‹ä¸€èŠ‚è¯¦è¿°)ã€‚</td></tr><tr><td align="left"></td><td align="left"><strong><code>æ´¾ç”ŸæŠ¥å‘Šå¯†é’¥ (Derived Report Key)</code></strong></td><td align="left"><strong>CPUç¡¬ä»¶</strong> (ç”±<code>Report Key</code>å’Œç›®æ ‡èº«ä»½æ´¾ç”Ÿ)</td><td align="left">ä¸ºå®šå‘çš„<code>EREPORT</code>æŒ‡ä»¤ç”Ÿæˆä¸€æ¬¡æ€§çš„MACè®¡ç®—å¯†é’¥ã€‚</td></tr><tr><td align="left"></td><td align="left"><strong><code>Provisioning Key</code></strong></td><td align="left"><strong>CPUç¡¬ä»¶</strong> (ç”±ç¡¬ä»¶æ ¹å¯†é’¥æ´¾ç”Ÿ, æ¯é¢—CPUå”¯ä¸€)</td><td align="left">ç”¨äºPCEå‘IntelæœåŠ¡å™¨è®¤è¯è‡ªå·±ã€‚Intelå¯é€šè¿‡æ­¤å¯†é’¥éªŒè¯CPUå¹³å°èº«ä»½ï¼Œä»è€Œå®‰å…¨åœ°ä¾›åº”å¹³å°ç§é’¥ã€‚</td></tr><tr><td align="left"><strong>éå¯¹ç§°å¯†é’¥</strong></td><td align="left"><strong>å¼€å‘è€…ç§é’¥&#x2F;å…¬é’¥</strong></td><td align="left"><strong>åº”ç”¨å¼€å‘è€…</strong></td><td align="left">ç”¨äºç­¾åEnclaveï¼Œå¹¶åœ¨<code>EINIT</code>æ—¶éªŒè¯ã€‚</td></tr><tr><td align="left"></td><td align="left"><strong>å¹³å°ç§é’¥(Attestation Key)</strong></td><td align="left"><strong>Intelä¾›åº”æœåŠ¡</strong></td><td align="left">ç”¨äºQEå¯¹<code>REPORT</code>è¿›è¡Œç­¾åï¼Œç”Ÿæˆ<code>QUOTE</code>ã€‚</td></tr><tr><td align="left"></td><td align="left"><strong>Intelæ ¹ç§é’¥&#x2F;å…¬uyo</strong></td><td align="left"><strong>Intel</strong></td><td align="left">ç”¨äºç­¾åPCEï¼Œå…¶å…¬é’¥å“ˆå¸Œæ˜¯ç¡¬ä»¶ä¿¡ä»»æ ¹ã€‚</td></tr><tr><td align="left"></td><td align="left"><strong>IASç§é’¥&#x2F;å…¬é’¥</strong></td><td align="left"><strong>Intelè®¤è¯æœåŠ¡</strong></td><td align="left">ç”¨äºå¯¹å‘å›ç»™æœåŠ¡å•†çš„è®¤è¯æŠ¥å‘Šè¿›è¡Œç­¾åã€‚</td></tr></tbody></table><p><strong>Part 3: ç­¾å&#x2F;è®¤è¯ç  (ä½œä¸ºå¯éªŒè¯çš„å‡­è¯)</strong></p><table><thead><tr><th align="left">åç§°</th><th align="left">æ¥æº&#x2F;ç”Ÿæˆè€…</th><th align="left">ä½¿ç”¨å“ªä¸ªå¯†é’¥ç­¾åï¼Ÿ</th><th align="left">ä½œç”¨ä¸ç›®çš„</th><th align="left">ä¸å¯æˆ–ç¼ºçš„ç†ç”±</th></tr></thead><tbody><tr><td align="left"><strong><code>REPORT</code>ä¸Šçš„MAC</strong></td><td align="left"><strong>CPUç¡¬ä»¶</strong> (é€šè¿‡<code>EREPORT</code>æŒ‡ä»¤)</td><td align="left"><code>æ´¾ç”ŸæŠ¥å‘Šå¯†é’¥</code></td><td align="left"><strong>å®ƒæ˜¯ä¸€ç§å¯¹ç§°ç­¾å</strong>ã€‚é€šè¿‡HMACç­‰ç®—æ³•ï¼Œä¸º<code>REPORT</code>æä¾›æœ¬åœ°å¯éªŒè¯çš„å®Œæ•´æ€§å’Œæ¥æºè¯æ˜ã€‚</td><td align="left"><strong>è§£å†³æœ¬åœ°ä¿¡ä»»</strong>ï¼šåœ¨æœ¬æœºCPUä¸Šå¿«é€Ÿã€å®‰å…¨åœ°è¯æ˜<code>REPORT</code>ã€‚</td></tr><tr><td align="left"><strong><code>SIGSTRUCT</code>ä¸­çš„ç­¾å</strong></td><td align="left"><strong>åº”ç”¨å¼€å‘è€…</strong></td><td align="left">å¼€å‘è€…ç§é’¥</td><td align="left"><strong>éå¯¹ç§°ç­¾å</strong>ã€‚å¯¹<code>MRENCLAVE</code>ç­¾åï¼Œè¯æ˜ä»£ç ç”±è¯¥å¼€å‘è€…æˆæƒã€‚</td><td align="left"><strong>è¿æ¥ä»£ç ä¸å¼€å‘è€…</strong>ï¼šåœ¨<code>EINIT</code>æ—¶ç»‘å®šä»£ç ä¸å¼€å‘è€…èº«ä»½ã€‚</td></tr><tr><td align="left"><strong><code>QUOTE</code>ä¸Šçš„ç­¾å</strong></td><td align="left"><strong>Quoting Enclave (QE)</strong></td><td align="left">å¹³å°ç§é’¥</td><td align="left"><strong>éå¯¹ç§°ç­¾å</strong>ã€‚å¯¹<code>REPORT</code>ç­¾åï¼Œä½¿å…¶å˜ä¸ºå¯è¢«è¿œç¨‹éªŒè¯çš„å‡­è¯ã€‚</td><td align="left"><strong>è§£å†³è¿œç¨‹ä¿¡ä»»</strong>ï¼šå°†æœ¬åœ°æŠ¥å‘Šè½¬å˜ä¸ºâ€å›½é™…æŠ¤ç…§â€ã€‚</td></tr><tr><td align="left"><strong>IASè®¤è¯æŠ¥å‘Šçš„ç­¾å</strong></td><td align="left"><strong>Intelè®¤è¯æœåŠ¡(IAS)</strong></td><td align="left">IASç§é’¥</td><td align="left"><strong>éå¯¹ç§°ç­¾å</strong>ã€‚å¯¹æœ€ç»ˆçš„è®¤è¯ç»“æœç­¾åï¼Œå‘é€ç»™è¿œç¨‹æœåŠ¡å•†ã€‚</td><td align="left"><strong>ä¿è¯æœ€ç»ˆè£å†³çš„çœŸå®æ€§</strong>ï¼šè®©æœåŠ¡å•†ç¡®ä¿¡æ”¶åˆ°çš„è®¤è¯ç»“æœç¡®å®æ¥è‡ªIntelã€‚</td></tr></tbody></table><p>é€šè¿‡ä»¥ä¸Šè¿™äº›è§’è‰²çš„ç²¾å¯†åä½œï¼ŒSGXæ„å»ºäº†ä¸€æ¡ä»CPUç¡¬ä»¶å†…éƒ¨çš„ä¿¡ä»»æ ¹ï¼Œåˆ°Inteläº‘ç«¯æœåŠ¡çš„å®Œæ•´ã€å¯éªŒè¯çš„ä¿¡ä»»é“¾ã€‚</p><p><strong>5. ç»¼è¿°ï¼šè´¯ç©¿å§‹ç»ˆçš„åˆæ³•æ€§éªŒè¯é“¾</strong></p><p>ä¸ºäº†è®©é€»è¾‘æ›´æ¸…æ™°ï¼Œæˆ‘ä»¬æœ€åå¯ä»¥æŠŠæ•´ä¸ªæµç¨‹ä¸­çš„â€åˆæ³•æ€§éªŒè¯â€ä¸²èµ·æ¥çœ‹ï¼š</p><ul><li><p><strong>é˜¶æ®µä¸€ï¼šEnclaveåŠ è½½æ—¶ (<code>EINIT</code>)</strong></p><ul><li><strong>éªŒè¯ä»€ä¹ˆï¼Ÿ</strong> Enclaveä»£ç çš„å®Œæ•´æ€§ä¸å¼€å‘è€…çš„çœŸå®æ€§ã€‚</li><li><strong>å¦‚ä½•éªŒè¯ï¼Ÿ</strong> CPUç¡¬ä»¶ä½¿ç”¨<code>SIGSTRUCT</code>ä¸­çš„å¼€å‘è€…å…¬é’¥ï¼ŒéªŒè¯å¯¹<code>MRENCLAVE</code>çš„ç­¾åã€‚</li><li><strong>ç»“è®ºï¼š</strong> ç¡®è®¤äº†â€è½¯ä»¶ï¼ˆEnclaveï¼‰æ˜¯å¼€å‘è€…åŸç‰ˆâ€ã€‚</li></ul></li><li><p><strong>é˜¶æ®µäºŒï¼šæœ¬åœ°è®¤è¯æ—¶ (<code>EREPORT</code> &#x2F; PCEéªŒè¯QE)</strong></p><ul><li><strong>éªŒè¯ä»€ä¹ˆï¼Ÿ</strong> Enclave Açš„æŠ¥å‘Šå¯¹äºEnclave Bçš„çœŸå®æ€§ã€‚</li><li><strong>å¦‚ä½•éªŒè¯ï¼Ÿ</strong> Bä½¿ç”¨CPUæˆäºˆçš„ã€ä¸Aå®šå‘ç”Ÿæˆçš„å¯†é’¥ï¼ŒéªŒè¯æŠ¥å‘Šçš„MACã€‚</li><li><strong>ç»“è®ºï¼š</strong> ç¡®è®¤äº†â€æŠ¥å‘Šï¼ˆREPORTï¼‰æ˜¯æœ¬æœºåŒä¼´çœŸå®ã€æœªç¯¡æ”¹çš„æ„å›¾è¡¨è¾¾â€ã€‚</li></ul></li><li><p><strong>é˜¶æ®µä¸‰ï¼šä¾›åº”å¯†é’¥æ—¶ (PCEè¯·æ±‚Intel)</strong></p><ul><li><strong>éªŒè¯ä»€ä¹ˆï¼Ÿ</strong> å‘èµ·å¯†é’¥ç”³è¯·çš„å¹³å°çš„åˆæ³•æ€§ã€‚</li><li><strong>å¦‚ä½•éªŒè¯ï¼Ÿ</strong> IntelæœåŠ¡å™¨ä½¿ç”¨å…±äº«çš„<code>Provisioning Key</code>éªŒè¯PCEçš„è¯·æ±‚ã€‚PCEèƒ½æ‹¿åˆ°æ­¤å¯†é’¥ï¼Œæœ¬èº«å°±æ˜¯å› ä¸ºå®ƒé€šè¿‡äº†CPUç¡¬ä»¶çƒ§å½•å“ˆå¸Œçš„éªŒè¯ã€‚</li><li><strong>ç»“è®ºï¼š</strong> ç¡®è®¤äº†â€å¹³å°ï¼ˆCPU+PCEï¼‰æ˜¯Intelæ­£ç‰ˆï¼Œæœ‰æƒç”³è¯·å¹³å°å¯†é’¥â€ã€‚</li></ul></li><li><p><strong>é˜¶æ®µå››ï¼šè¿œç¨‹è®¤è¯æ—¶ (IASéªŒè¯QUOTE)</strong></p><ul><li><strong>éªŒè¯ä»€ä¹ˆï¼Ÿ</strong> <code>QUOTE</code>çš„çœŸå®æ€§ä¸å¹³å°çš„å®‰å…¨æ€§ã€‚</li><li><strong>å¦‚ä½•éªŒè¯ï¼Ÿ</strong> IASä½¿ç”¨å…¬é’¥ä½“ç³»éªŒè¯<code>QUOTE</code>ç”±åˆæ³•çš„å¹³å°ç§é’¥ç­¾åï¼Œå¹¶æ£€æŸ¥å¹³å°çš„TCBç‰ˆæœ¬ã€‚</li><li><strong>ç»“è®ºï¼š</strong> ç¡®è®¤äº†â€è®¤è¯æŠ¥å‘Šï¼ˆQUOTEï¼‰æ˜¯æ¥è‡ªä¸€ä¸ªå®‰å…¨ã€æ­£ç‰ˆå¹³å°çš„ã€å¯ä¿¡çš„å£°æ˜â€ã€‚</li></ul></li><li><p><strong>é˜¶æ®µäº”ï¼šæœ€ç»ˆå†³ç­–æ—¶ (æœåŠ¡å•†éªŒè¯IASæŠ¥å‘Š)</strong></p><ul><li><strong>éªŒè¯ä»€ä¹ˆï¼Ÿ</strong> IASè®¤è¯æŠ¥å‘Šçš„çœŸå®æ€§ï¼Œä»¥åŠEnclaveèº«ä»½æ˜¯å¦ç¬¦åˆä¸šåŠ¡ç­–ç•¥ã€‚</li><li><strong>å¦‚ä½•éªŒè¯ï¼Ÿ</strong> æœåŠ¡å•†éªŒè¯IASæŠ¥å‘Šçš„ç­¾åï¼Œå¹¶æ£€æŸ¥æŠ¥å‘Šä¸­çš„<code>MRENCLAVE</code>&#x2F;<code>MRSIGNER</code>æ˜¯å¦æ˜¯è‡ªå·±æœŸæœ›ä¸ä¹‹é€šä¿¡çš„ã€‚</li><li><strong>ç»“è®ºï¼š</strong> ç¡®è®¤äº†â€è¿™ä¸ªEnclaveæ˜¯æˆ‘è¦æ‰¾çš„é‚£ä¸ªï¼Œå¹¶ä¸”Intelä¸ºå®ƒçš„èº«ä»½å’Œç¯å¢ƒå®‰å…¨èƒŒä¹¦â€ã€‚</li></ul></li></ul><hr><p><em>èº«ä»½é—®é¢˜è§£å†³åï¼ŒEnclave å†…éƒ¨çš„æ•°æ®å¦‚æœéœ€è¦è¢«é•¿æœŸä¿å­˜åˆ°ç¡¬ç›˜ä¸Šï¼Œåˆè¯¥å¦‚ä½•ä¿æŠ¤å‘¢ï¼Ÿä¸‹ä¸€èŠ‚ï¼Œæˆ‘ä»¬å°†æ¢è®¨ SGX çš„æŒä¹…åŒ–æ•°æ®ä¿æŠ¤æœºåˆ¶ã€‚</em></p><h3 id="4-4-æŒä¹…åŒ–æ•°æ®ä¿æŠ¤ï¼šæ•°æ®å¯†å°-Data-Sealing"><a href="#4-4-æŒä¹…åŒ–æ•°æ®ä¿æŠ¤ï¼šæ•°æ®å¯†å°-Data-Sealing" class="headerlink" title="4.4 æŒä¹…åŒ–æ•°æ®ä¿æŠ¤ï¼šæ•°æ®å¯†å° (Data Sealing)"></a>4.4 æŒä¹…åŒ–æ•°æ®ä¿æŠ¤ï¼šæ•°æ®å¯†å° (Data Sealing)</h3><p>æˆ‘ä»¬å·²ç»è§£å†³äº†Enclaveè¿è¡Œæ—¶å’Œè®¤è¯æ—¶çš„å®‰å…¨é—®é¢˜ï¼Œä½†è¿˜å‰©ä¸‹æœ€åä¸€ä¸ªå…³é”®ç¯èŠ‚ï¼š<strong>æŒä¹…åŒ–</strong>ã€‚Enclaveçš„å†…å­˜ï¼ˆEPCï¼‰æ˜¯æ˜“å¤±çš„ï¼Œæ–­ç”µåæ•°æ®å°±ä¼šæ¶ˆå¤±ã€‚å¦‚æœEnclaveéœ€è¦å°†ä¸€ä¸ªé‡è¦çš„ç§˜å¯†ï¼ˆå¦‚ä¸€ä¸ªè§£å¯†å¯†é’¥ã€ä¸€ä¸ªä¼šè¯çŠ¶æ€ã€æˆ–ä¸€ä»½é…ç½®æ–‡ä»¶ï¼‰ä¿å­˜ä¸‹æ¥ä¾›ä¸‹æ¬¡ä½¿ç”¨ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿç›´æ¥å†™å…¥ç”±ä¸å¯ä¿¡OSç®¡ç†çš„ç¡¬ç›˜ï¼Œæ— å¼‚äºå°†ç§˜å¯†å…¬ä¹‹äºä¼—ã€‚</p><p><strong>æ•°æ®å¯†å° (Data Sealing) æœºåˆ¶ï¼Œå°±æ˜¯SGXæä¾›çš„ã€ç”¨äºè§£å†³â€æ•°æ®å®‰å…¨è½ç›˜â€é—®é¢˜çš„ç¡¬ä»¶çº§æ–¹æ¡ˆã€‚</strong></p><h4 id="a-æ ¸å¿ƒæ€æƒ³ä¸å…³é”®è¦ç´ "><a href="#a-æ ¸å¿ƒæ€æƒ³ä¸å…³é”®è¦ç´ " class="headerlink" title="a) æ ¸å¿ƒæ€æƒ³ä¸å…³é”®è¦ç´ "></a>a) æ ¸å¿ƒæ€æƒ³ä¸å…³é”®è¦ç´ </h4><ul><li><strong>æ ¸å¿ƒæ€æƒ³</strong>: å…è®¸Enclaveå°†æ•°æ®åŠ å¯†åï¼Œå®‰å…¨åœ°å­˜å‚¨åˆ°ä¸å¯ä¿¡çš„å¤–éƒ¨ä»‹è´¨ï¼ˆå¦‚ç¡¬ç›˜ï¼‰ï¼Œå¹¶ç¡®ä¿åªæœ‰<strong>ç‰¹å®šçš„Enclave</strong>æ‰èƒ½è§£å°ï¼ˆUnsealï¼‰è¿™äº›æ•°æ®ã€‚</li><li><strong>ç¡¬ä»¶æŒ‡ä»¤</strong>: <code>EGETKEY</code>ï¼Œè¿™æ˜¯Enclaveå‘CPUç”³è¯·å„ç§ç¡¬ä»¶å¯†é’¥çš„ç»Ÿä¸€æ¥å£ã€‚</li><li><strong>ä¿¡ä»»æ ¹æº</strong>: æˆ‘ä»¬åœ¨å¯†é’¥è¡¨æ ¼ä¸­æåˆ°çš„ **<code>Root Seal Key (RSK)</code>**ã€‚è¿™ä¸ªä¸<code>Report Key</code>å¹¶åˆ—çš„ã€CPUåˆ¶é€ æ—¶çƒ§å½•çš„ã€æ¯é¢—èŠ¯ç‰‡å”¯ä¸€çš„ç¡¬ä»¶å¯†é’¥ï¼Œæ˜¯æ‰€æœ‰å¯†å°å¯†é’¥çš„ä¿¡ä»»ä¹‹æ ¹ã€‚</li></ul><h4 id="b-EGETKEY-ä¸ä¸¤ç§å¯†å°ç­–ç•¥"><a href="#b-EGETKEY-ä¸ä¸¤ç§å¯†å°ç­–ç•¥" class="headerlink" title="b) EGETKEY ä¸ä¸¤ç§å¯†å°ç­–ç•¥"></a>b) <code>EGETKEY</code> ä¸ä¸¤ç§å¯†å°ç­–ç•¥</h4><p>å½“Enclaveè°ƒç”¨<code>EGETKEY</code>æŒ‡ä»¤è¯·æ±‚ä¸€ä¸ªç”¨äºå¯†å°çš„å¯†é’¥ï¼ˆSeal Keyï¼‰æ—¶ï¼Œå®ƒå¿…é¡»åšå‡ºä¸€ä¸ªå…³é”®çš„ç­–ç•¥é€‰æ‹©ï¼šè¿™ä¸ªå¯†é’¥åˆ°åº•åº”è¯¥å’Œè°çš„èº«ä»½ç»‘å®šï¼ŸSGXæä¾›äº†ä¸¤ç§ç­–ç•¥ï¼š</p><p><strong>ç­–ç•¥ä¸€ï¼šç»‘å®šEnclaveçš„â€DNAæŒ‡çº¹â€ (<code>MRENCLAVE</code>)</strong></p><ul><li><strong>å«ä¹‰</strong>: å¯†å°å¯†é’¥çš„æ´¾ç”Ÿå°†ä¸å½“å‰Enclaveçš„<code>MRENCLAVE</code>å€¼å¼ºç»‘å®šã€‚</li><li><strong>æ•ˆæœ</strong>: æ•°æ®è¢«å¯†å°åï¼Œ<strong>åªæœ‰æ‹¥æœ‰å®Œå…¨ç›¸åŒä»£ç å’Œåˆå§‹æ•°æ®çš„Enclaveï¼ˆå³æ‹¥æœ‰ç›¸åŒ<code>MRENCLAVE</code>ï¼‰æ‰èƒ½æ´¾ç”Ÿå‡ºåŒä¸€ä¸ªå¯†é’¥æ¥è§£å°ã€‚</strong></li><li><strong>ç±»æ¯”</strong>: è¿™å°±åƒä¸€ä¸ªåªè®¤<strong>ç‰¹å®šäººç‰©DNAæŒ‡çº¹</strong>çš„ä¿é™©ç®±ã€‚</li><li><strong>ä¼˜ç‚¹</strong>: <strong>æè‡´çš„å®‰å…¨</strong>ã€‚å®ƒä¿è¯äº†åªæœ‰â€åŸæ±åŸå‘³â€ã€æœªç»ä»»ä½•ä¿®æ”¹çš„Enclaveæ‰èƒ½è®¿é—®æ•°æ®ã€‚</li><li><strong>ç¼ºç‚¹</strong>: <strong>æ¯«æ— çµæ´»æ€§</strong>ã€‚å¦‚æœå¼€å‘è€…ä¿®å¤äº†ä¸€ä¸ªbugï¼Œé‡æ–°ç¼–è¯‘çš„Enclaveå“ªæ€•åªæ”¹å˜äº†ä¸€ä¸ªæ¯”ç‰¹ï¼Œå…¶<code>MRENCLAVE</code>å°±ä¼šå˜åŒ–ï¼Œå¯¼è‡´æ–°ç‰ˆEnclaveæ— æ³•è¯»å–æ—§ç‰ˆæ•°æ®ã€‚è¿™å¯¹äºéœ€è¦è¿­ä»£å‡çº§çš„åº”ç”¨æ˜¯è‡´å‘½çš„ã€‚</li></ul><p><strong>ç­–ç•¥äºŒï¼šç»‘å®šå¼€å‘è€…çš„â€å®¶æ—å¾½ç« â€ (<code>MRSIGNER</code>)</strong></p><ul><li><strong>å«ä¹‰</strong>: å¯†å°å¯†é’¥çš„æ´¾ç”Ÿå°†ä¸å½“å‰Enclaveçš„<code>MRSIGNER</code>å€¼å¼ºç»‘å®šã€‚</li><li><strong>æ•ˆæœ</strong>: æ•°æ®è¢«å¯†å°åï¼Œ<strong>åªè¦æ˜¯ç”±åŒä¸€ä¸ªå¼€å‘è€…ï¼ˆæ‹¥æœ‰åŒä¸€ä¸ªç­¾åç§é’¥ï¼Œå³æ‹¥æœ‰ç›¸åŒ<code>MRSIGNER</code>ï¼‰ç­¾åçš„ä»»ä½•Enclaveï¼Œéƒ½å¯ä»¥æ´¾ç”Ÿå‡ºåŒä¸€ä¸ªå¯†é’¥æ¥è§£å°ã€‚</strong></li><li><strong>ç±»æ¯”</strong>: è¿™å°±åƒä¸€ä¸ªåªè®¤<strong>ç‰¹å®šå®¶æ—å¾½ç« </strong>çš„ä¿é™©ç®±ï¼Œå®¶æ—é‡Œçš„ä»»ä½•æˆå‘˜ï¼ˆä¸åŒç‰ˆæœ¬çš„Enclaveï¼‰éƒ½èƒ½æ‰“å¼€ã€‚</li><li><strong>ä¼˜ç‚¹</strong>: <strong>æä½³çš„çµæ´»æ€§</strong>ã€‚å¼€å‘è€…å¯ä»¥éšæ„å‘å¸ƒæ–°ç‰ˆæœ¬çš„Enclaveæ¥ä¿®å¤bugæˆ–å¢åŠ åŠŸèƒ½ã€‚åªè¦ç­¾åå¯†é’¥ä¸å˜ï¼Œæ–°ç‰ˆEnclaveå°±èƒ½æ— ç¼è®¿é—®å’Œè¿ç§»æ—§ç‰ˆæ•°æ®ï¼Œè¿™æ˜¯åº”ç”¨å‡çº§çš„åŸºçŸ³ã€‚</li><li><strong>ç¼ºç‚¹</strong>: <strong>å®‰å…¨è¾¹ç•Œæ›´å¹¿</strong>ã€‚å…¶å®‰å…¨æ€§å®Œå…¨ä¾èµ–äºå¼€å‘è€…çš„ç­¾åç§é’¥ã€‚ä¸€æ—¦ç§é’¥æ³„éœ²ï¼Œæ”»å‡»è€…å°±å¯ä»¥ä¼ªé€ ä¸€ä¸ªå±äºè¯¥å¼€å‘è€…çš„æ¶æ„Enclaveï¼Œä»è€Œè§£å°æ‰€æœ‰ç”±è¯¥<code>MRSIGNER</code>ç»‘å®šçš„æ•°æ®ã€‚</li></ul><h4 id="c-å¯†é’¥æ´¾ç”Ÿç»†èŠ‚ä¸é™çº§æ”»å‡»é˜²å¾¡"><a href="#c-å¯†é’¥æ´¾ç”Ÿç»†èŠ‚ä¸é™çº§æ”»å‡»é˜²å¾¡" class="headerlink" title="c) å¯†é’¥æ´¾ç”Ÿç»†èŠ‚ä¸é™çº§æ”»å‡»é˜²å¾¡"></a>c) å¯†é’¥æ´¾ç”Ÿç»†èŠ‚ä¸é™çº§æ”»å‡»é˜²å¾¡</h4><p>å®é™…ä¸Šï¼Œ<code>EGETKEY</code>åœ¨æ´¾ç”ŸSeal Keyæ—¶ï¼Œä¸ä»…ä»…åªè€ƒè™‘<code>MRENCLAVE</code>æˆ–<code>MRSIGNER</code>ã€‚ä¸ºäº†æä¾›æ›´ç²¾ç»†çš„å®‰å…¨æ§åˆ¶ï¼Œå®ƒè¿˜ä¼šæ··å…¥å…¶ä»–å®‰å…¨å±æ€§ï¼Œä¾‹å¦‚ï¼š</p><ul><li><strong><code>ISVSVN</code> (Security Version Number)</strong>: å¼€å‘è€…è‡ªå·±å®šä¹‰çš„å®‰å…¨ç‰ˆæœ¬å·ã€‚</li><li><strong><code>CPUSVN</code> (CPU Security Version Number)</strong>: CPUå¾®ç çš„å®‰å…¨ç‰ˆæœ¬å·ã€‚</li></ul><p><code>Seal Key = KDF(RSK, Key Policy + ISVSVN + CPUSVN + ...)</code></p><p>è¿™æ„å‘³ç€ï¼Œå¼€å‘è€…å¯ä»¥åœ¨å¯†å°æ—¶è®¾å®šä¸€ä¸ªç­–ç•¥ï¼Œæ¯”å¦‚â€åªæœ‰<code>MRSIGNER</code>ç›¸åŒï¼Œä¸”<code>ISVSVN</code>ä¸ä½äºv2çš„Enclaveâ€æ‰èƒ½è§£å°ã€‚è¿™å¯ä»¥æœ‰æ•ˆ<strong>é˜²æ­¢é™çº§æ”»å‡»</strong>ï¼Œå³é˜²æ­¢æ”»å‡»è€…ç”¨ä¸€ä¸ªå­˜åœ¨å·²çŸ¥æ¼æ´çš„æ—§ç‰ˆEnclaveæ¥è§£å°æ–°ç‰ˆEnclaveäº§ç”Ÿçš„æ•°æ®ã€‚</p><h4 id="d-å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼šå¯†å°ä¸è§£å°"><a href="#d-å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼šå¯†å°ä¸è§£å°" class="headerlink" title="d) å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼šå¯†å°ä¸è§£å°"></a>d) å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼šå¯†å°ä¸è§£å°</h4><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  sequenceDiagram    participant App_Enclave as Enclave    participant CPU_Hardware as CPU Hardware    participant Untrusted_Storage as ä¸å¯ä¿¡å­˜å‚¨ (ç¡¬ç›˜&#x2F;DB)    Note over App_Enclave, CPU_Hardware: é˜¶æ®µä¸€ï¼šå¯†å° (Sealing)    App_Enclave-&gt;&gt;CPU_Hardware: 1. EGETKEYæŒ‡ä»¤&lt;br&gt;è¯·æ±‚ä¸€ä¸ªç»‘å®šåˆ°&#39;MRSIGNER&#39;&lt;br&gt;å’Œç‰¹å®š&#39;ISVSVN&#39;çš„å¯†å°å¯†é’¥    CPU_Hardware--&gt;&gt;CPU_Hardware: 2. ç”¨RSKåŠç›¸å…³ç­–ç•¥&lt;br&gt;æ´¾ç”Ÿå‡ºå¯†å°å¯†é’¥(Seal Key)    CPU_Hardware--&gt;&gt;App_Enclave: 3. è¿”å›å¯†å°å¯†é’¥        App_Enclave-&gt;&gt;App_Enclave: 4. ç”¨å¯†å°å¯†é’¥åŠ å¯†&lt;br&gt;æ•æ„Ÿæ•°æ®(Secret)    App_Enclave-&gt;&gt;Untrusted_Storage: 5. (é€šè¿‡OCALL)å°†&lt;br&gt;åŠ å¯†æ•°æ®(Sealed Blob)&lt;br&gt;å†™å…¥å¤–éƒ¨å­˜å‚¨    Note over App_Enclave, Untrusted_Storage: ...æ—¶é—´æµé€ï¼ŒEnclaveé‡å¯...    Note over App_Enclave, CPU_Hardware: é˜¶æ®µäºŒï¼šè§£å° (Unsealing)    App_Enclave-&gt;&gt;Untrusted_Storage: 6. (é€šè¿‡OCALL)è¯»å–&lt;br&gt;ä¹‹å‰å­˜å‚¨çš„Sealed Blob        App_Enclave-&gt;&gt;CPU_Hardware: 7. å†æ¬¡å‘èµ·EGETKEYè¯·æ±‚&lt;br&gt;ä½¿ç”¨å®Œå…¨ç›¸åŒçš„ç­–ç•¥    CPU_Hardware--&gt;&gt;CPU_Hardware: 8. ç¡¬ä»¶é‡æ–°æ´¾ç”Ÿå‡º&lt;br&gt;åŒä¸€ä¸ªå¯†å°å¯†é’¥    CPU_Hardware--&gt;&gt;App_Enclave: 9. è¿”å›å¯†å°å¯†é’¥        App_Enclave-&gt;&gt;App_Enclave: 10. ä½¿ç”¨å¯†é’¥è§£å¯†&lt;br&gt;Sealed Blob, æ¢å¤Secret  </pre></div><p><strong>æ€»ç»“</strong>ï¼šæ•°æ®å¯†å°æœºåˆ¶é€šè¿‡<code>EGETKEY</code>æŒ‡ä»¤ï¼Œåˆ©ç”¨CPUå†…ç‹¬æœ‰çš„<code>Root Seal Key</code>ï¼Œå¹¶ç»“åˆEnclaveçš„èº«ä»½æ ‡è¯†ï¼ˆ<code>MRENCLAVE</code> æˆ– <code>MRSIGNER</code>ï¼‰åŠå…¶ä»–å®‰å…¨å±æ€§ï¼Œä¸ºEnclaveæ•°æ®æä¾›äº†ä¸€ç§å¼ºå¤§çš„æŒä¹…åŒ–ä¿æŠ¤æ–¹æ¡ˆã€‚å®ƒå·§å¦™åœ°å°†æ•°æ®çš„è®¿é—®æƒé™ä¸Enclaveçš„å®Œæ•´æ€§ã€ä½œè€…èº«ä»½å’Œå®‰å…¨ç‰ˆæœ¬ç»‘å®šåœ¨ä¸€èµ·ï¼Œç¡®ä¿äº†å³ä½¿æ•°æ®ç¦»å¼€äº†å®‰å…¨çš„EPCç¯å¢ƒï¼Œå…¶ä¿å¯†æ€§ä¾ç„¶èƒ½å¤Ÿå¾—åˆ°ç¡¬ä»¶çº§åˆ«çš„ä¿éšœã€‚</p><hr><p><em>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å®Œæ•´åœ°å‰–æäº† SGX çš„ä¸‰å¤§æ ¸å¿ƒå®‰å…¨æœºåˆ¶ï¼ˆçœŸä¸å®¹æ˜“ğŸ˜­ï¼‰ã€‚ä¸‹ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†ä»ç†è®ºèµ°å‘å®è·µã€‚</em></p><h2 id="äº”ã€æ¦‚å¿µå®è·µï¼šåœ¨æ€æƒ³ä¸Šæ„å»ºä¸€ä¸ªEnclave"><a href="#äº”ã€æ¦‚å¿µå®è·µï¼šåœ¨æ€æƒ³ä¸Šæ„å»ºä¸€ä¸ªEnclave" class="headerlink" title="äº”ã€æ¦‚å¿µå®è·µï¼šåœ¨æ€æƒ³ä¸Šæ„å»ºä¸€ä¸ªEnclave"></a>äº”ã€æ¦‚å¿µå®è·µï¼šåœ¨æ€æƒ³ä¸Šæ„å»ºä¸€ä¸ªEnclave</h2><p>ç†è®ºçŸ¥è¯†æ˜¯æ ¹åŸºï¼Œä½†çœŸæ­£çš„ç†è§£å‡åï¼Œæ¥è‡ªäºè§‚å¯Ÿè¿™äº›ç†è®ºå¦‚ä½•åœ¨å®è·µä¸­è¢«ç¼–æ’å’Œåº”ç”¨â€”â€”è¿™ä¸ªæ˜¯æˆ‘ç‰¹åˆ«å–œæ¬¢çš„ä¸€å¥è¯ã€‚ä½†æ˜¯å› ä¸ºæˆ‘çš„Macç”µè„‘æ­å»ºä¸äº†ä¸€ä¸ªSGXç¯å¢ƒã€‚æ‰€ä»¥è¿™é‡Œæˆ‘é€šè¿‡æ€æƒ³å®éªŒï¼Œå®ç°ä¸€ä¸ªæ¡ˆä¾‹ï¼šé€šè¿‡ä¸€ä¸ªâ€Hello, Worldâ€ç¨‹åºçš„ä»£ç ï¼Œæ¥åå‘å°è¯å’Œä¸²è”ä¹‹å‰å­¦è¿‡çš„æ‰€æœ‰ç¡¬ä»¶è¡Œä¸ºå’Œå®‰å…¨æœºåˆ¶ï¼Œçœ‹æ‡‚ä¸€ä¸ªSGXç¨‹åºæ˜¯å¦‚ä½•ä»ä»£ç æœ€ç»ˆå˜ä¸ºä¸€ä¸ªå—ç¡¬ä»¶ä¿æŠ¤çš„å¯ä¿¡å®ä½“çš„ã€‚</p><h3 id="a-SGXé¡¹ç›®çš„â€ä¸‰å›½é¼ç«‹â€æ¶æ„"><a href="#a-SGXé¡¹ç›®çš„â€ä¸‰å›½é¼ç«‹â€æ¶æ„" class="headerlink" title="a) SGXé¡¹ç›®çš„â€ä¸‰å›½é¼ç«‹â€æ¶æ„"></a>a) SGXé¡¹ç›®çš„â€ä¸‰å›½é¼ç«‹â€æ¶æ„</h3><p>ä¸€ä¸ªå…¸å‹çš„SGXé¡¹ç›®ï¼Œç”±ä¸‰ä¸ªæ ¸å¿ƒéƒ¨åˆ†ç»„æˆï¼Œç¼ºä¸€ä¸å¯ï¼š</p><ol><li><p><strong>App (ä¸å¯ä¿¡åº”ç”¨)</strong>:</p><ul><li><strong>è§’è‰²</strong>: ç±»ä¼¼ä¸ä¸Šé¢æåˆ°çš„â€é¡¹ç›®ç»ç†â€ä¸â€å¤–äº¤å®˜â€ã€‚</li><li><strong>æœ¬è´¨</strong>: ä¸€ä¸ªæ ‡å‡†çš„ã€è¿è¡Œåœ¨OSæ­£å¸¸ç¯å¢ƒä¸‹çš„ç”¨æˆ·æ€ç¨‹åºã€‚</li><li><strong>èŒè´£</strong>:<ul><li>è´Ÿè´£åŠ è½½ã€åˆå§‹åŒ–ã€é”€æ¯Enclaveï¼Œæ˜¯Enclaveç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†è€…ã€‚</li><li>ä½œä¸ºEnclaveä¸å¤–éƒ¨ä¸–ç•Œï¼ˆå¦‚æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œã€ç”¨æˆ·ç•Œé¢ï¼‰æ²Ÿé€šçš„å”¯ä¸€æ¡¥æ¢ã€‚</li><li>é€šè¿‡ECALLï¼ˆEnclave Callï¼‰è¯·æ±‚Enclaveæ‰§è¡Œå¯ä¿¡è®¡ç®—ã€‚</li><li>ä¸ºEnclaveæä¾›OCALLï¼ˆOutside Callï¼‰æœåŠ¡ï¼Œå“åº”å…¶è®¿é—®å¤–éƒ¨èµ„æºçš„éœ€æ±‚ã€‚</li></ul></li></ul></li><li><p><strong>Enclave (å¯ä¿¡é£åœ°)</strong>:</p><ul><li><strong>è§’è‰²</strong>: â€œä¿é™©åº“â€ä¸â€æ ¸å¿ƒç®—æ³•ä¸“å®¶â€ã€‚</li><li><strong>æœ¬è´¨</strong>: ä¸€ä¸ªç‰¹æ®Šçš„ã€å°†è¢«åŠ å¯†å’Œä¿æŠ¤çš„åŠ¨æ€åº“ï¼ˆ<code>.so</code>æˆ–<code>.dll</code>ï¼‰ã€‚</li><li><strong>èŒè´£</strong>:<ul><li>å­˜æ”¾æ‰€æœ‰éœ€è¦è¢«ä¿æŠ¤çš„æ•æ„Ÿä»£ç å’Œæ•°æ®ã€‚</li><li>æ‰§è¡Œæ ¸å¿ƒçš„æœºå¯†è®¡ç®—ä»»åŠ¡ã€‚</li><li>ä¸å¤–ç•Œå®Œå…¨éš”ç¦»ï¼Œåªèƒ½é€šè¿‡Appå®šä¹‰çš„æ¥å£è¿›è¡Œæœ‰é™çš„äº¤äº’ã€‚</li></ul></li></ul></li><li><p><strong>EDL (æ¥å£å®šä¹‰è¯­è¨€)</strong>:</p><ul><li><strong>è§’è‰²</strong>: â€œæ³•å¾‹å¥‘çº¦â€ä¸â€æµ·å…³ç”³æŠ¥å•â€ã€‚</li><li><strong>æœ¬è´¨</strong>: ä¸€ä¸ªéµå¾ªç‰¹å®šè¯­æ³•çš„<code>.edl</code>æ–‡ä»¶ã€‚</li><li><strong>èŒè´£</strong>:<ul><li><strong>ä¸¥æ ¼å®šä¹‰</strong>äº†Appå’ŒEnclaveä¹‹é—´çš„é€šä¿¡è¾¹ç•Œã€‚</li><li>æ˜ç¡®å£°æ˜äº†å“ªäº›å‡½æ•°æ˜¯ECALLï¼ˆAppå¯è°ƒç”¨Enclaveï¼‰ï¼Œå“ªäº›æ˜¯OCALLï¼ˆEnclaveå¯è°ƒç”¨Appï¼‰ã€‚</li><li>è¿™ä¸ªæ–‡ä»¶æ˜¯åç»­è‡ªåŠ¨ç”Ÿæˆâ€è·¨è¾¹ç•Œé€šä¿¡ä»£ç â€çš„å”¯ä¸€è“å›¾ã€‚</li></ul></li></ul></li></ol><h3 id="b-ç¥å¥‡çš„â€èƒ¶æ°´â€ï¼šEDLæ–‡ä»¶ä¸edger8rå·¥å…·"><a href="#b-ç¥å¥‡çš„â€èƒ¶æ°´â€ï¼šEDLæ–‡ä»¶ä¸edger8rå·¥å…·" class="headerlink" title="b) ç¥å¥‡çš„â€èƒ¶æ°´â€ï¼šEDLæ–‡ä»¶ä¸edger8rå·¥å…·"></a>b) ç¥å¥‡çš„â€èƒ¶æ°´â€ï¼šEDLæ–‡ä»¶ä¸edger8rå·¥å…·</h3><p>EDLæ–‡ä»¶æ˜¯ç†è§£SGXç¼–ç¨‹çš„å…³é”®ã€‚å®ƒä¸ä»…æ˜¯å®šä¹‰ï¼Œæ›´æ˜¯è‡ªåŠ¨ç”Ÿæˆå®‰å…¨ä»£ç çš„ä¾æ®ã€‚</p><p><strong>ç¤ºä¾‹ <code>Enclave.edl</code> æ–‡ä»¶ï¼š</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">enclave &#123;</span><br><span class="line">    <span class="comment">// trustedå—ï¼šå£°æ˜ECALL</span></span><br><span class="line">    <span class="comment">// Appå¯ä»¥è°ƒç”¨è¿™äº›å‡½æ•°è¿›å…¥Enclave</span></span><br><span class="line">    trusted &#123;</span><br><span class="line">        <span class="comment">// publicè¡¨ç¤ºè¯¥å‡½æ•°æ˜¯å¯ä¿¡å…¥å£ç‚¹</span></span><br><span class="line">        public <span class="type">void</span> <span class="title function_">ecall_process_data</span><span class="params">([in, size=len] <span class="type">const</span> <span class="type">char</span>* data, <span class="type">size_t</span> len)</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// untrustedå—ï¼šå£°æ˜OCALL</span></span><br><span class="line">    <span class="comment">// Enclaveå¯ä»¥è°ƒç”¨è¿™äº›å‡½æ•°ç¦»å¼€Enclave</span></span><br><span class="line">    untrusted &#123;</span><br><span class="line">        <span class="type">void</span> <span class="title function_">ocall_print_log</span><span class="params">([in, <span class="built_in">string</span>] <span class="type">const</span> <span class="type">char</span> *str)</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li><code>[in, string]</code>ç­‰å±æ€§ï¼šå®ƒä»¬æ˜¯**æ•°æ®å°é€(Marshalling)**çš„æŒ‡ä»¤ï¼Œå‘Šè¯‰ç¼–è¯‘å™¨å¦‚ä½•å®‰å…¨åœ°æ‹·è´æ•°æ®è·¨è¶Šå¯ä¿¡&#x2F;ä¸å¯ä¿¡è¾¹ç•Œã€‚</li></ul><p><strong><code>edger8r</code>å·¥å…·çš„â€é­”æ³•â€</strong></p><p>å½“æ‚¨ç”¨SGX SDKç¼–è¯‘é¡¹ç›®æ—¶ï¼Œä¸€ä¸ªåä¸º<code>edger8r</code>çš„å·¥å…·ä¼šè¯»å–è¿™ä¸ªEDLæ–‡ä»¶ï¼Œå¹¶è‡ªåŠ¨ç”Ÿæˆä¸€å¯¹â€èƒ¶æ°´â€æ–‡ä»¶ï¼š<code>Enclave_u.h</code>&#x2F;<code>c</code>ï¼ˆfor Appï¼‰å’Œ<code>Enclave_t.h</code>&#x2F;<code>c</code>ï¼ˆfor Enclaveï¼‰ã€‚</p><ul><li><strong>å¯¹Appè€Œè¨€ (<code>Enclave_u.h</code>)</strong>: <code>edger8r</code>ä¼šç”Ÿæˆä¸€ä¸ªä¸EDLä¸­å‡½æ•°åŒåçš„Cå‡½æ•°ï¼Œæ¯”å¦‚<code>ecall_process_data</code>ã€‚ä½†è¿™ä¸ªå‡½æ•°<strong>ä¸æ˜¯çœŸæ­£çš„Enclaveä»£ç </strong>ï¼Œè€Œæ˜¯ä¸€ä¸ªâ€ä»£ç†å‡½æ•°â€ï¼ˆProxyï¼‰ã€‚å½“Appè°ƒç”¨å®ƒæ—¶ï¼Œå®ƒå†…éƒ¨ä¼šæ‰§è¡Œä¸€ç³»åˆ—å¤æ‚æ“ä½œï¼šå°†å‚æ•°å®‰å…¨æ‰“åŒ…ã€è§¦å‘<code>EENTER</code>æŒ‡ä»¤ã€å¹¶å°†æ‰§è¡Œæƒäº¤ç»™Enclaveå†…çš„å¯¹åº”å‡½æ•°ã€‚</li><li><strong>å¯¹Enclaveè€Œè¨€ (<code>Enclave_t.h</code>)</strong>: <code>edger8r</code>ä¼šç”Ÿæˆä¸€ä¸ªçœŸæ­£çš„å‡½æ•°ä½“ï¼Œå®ƒè´Ÿè´£æ¥æ”¶ä»Appä¼ æ¥çš„æ•°æ®ï¼Œè§£åŒ…å‚æ•°ï¼Œç„¶åè°ƒç”¨æ‚¨åœ¨Enclaveä¸­äº²æ‰‹ç¼–å†™çš„é€»è¾‘ã€‚</li></ul><p>è¿™å±‚è‡ªåŠ¨ç”Ÿæˆçš„èƒ¶æ°´ä»£ç ï¼Œå°†å¼€å‘è€…ä»å¤æ‚çš„è¾¹ç•Œæ•°æ®å¤„ç†å’Œåº•å±‚æŒ‡ä»¤è°ƒç”¨ä¸­è§£æ”¾å‡ºæ¥ï¼Œæ˜¯SGXç¼–ç¨‹çš„æ ¸å¿ƒä¾¿åˆ©æ€§æ‰€åœ¨ã€‚</p><blockquote><p>å…¶å®å¦ç‡çš„è¯´å¦‚æœçœŸçš„è‡ªå·±å¼€å‘SGXåº”ç”¨æ˜¯å¾ˆéº»çƒ¦çš„</p></blockquote><h3 id="c-æ ¸å¿ƒä»£ç å¯¼è¯»ï¼šç†è®ºä¸å®è·µçš„äº¤æ±‡"><a href="#c-æ ¸å¿ƒä»£ç å¯¼è¯»ï¼šç†è®ºä¸å®è·µçš„äº¤æ±‡" class="headerlink" title="c) æ ¸å¿ƒä»£ç å¯¼è¯»ï¼šç†è®ºä¸å®è·µçš„äº¤æ±‡"></a>c) æ ¸å¿ƒä»£ç å¯¼è¯»ï¼šç†è®ºä¸å®è·µçš„äº¤æ±‡</h3><p>ç°åœ¨ï¼Œæˆ‘ä»¬æ¥çœ‹ä»£ç ã€‚åœ¨é˜…è¯»æ—¶ï¼Œè¯·æ—¶åˆ»å›æƒ³æˆ‘ä»¬ä¹‹å‰å­¦ä¹ çš„ç¡¬ä»¶æœºåˆ¶ã€‚</p><p><strong>1. Appéƒ¨åˆ† (<code>App.cpp</code>) - Enclaveçš„â€ç”Ÿå‘½å‘¨æœŸç®¡ç†è€…â€</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sgx_urts.h&quot;</span>    <span class="comment">// SGXè¿è¡Œæ—¶åº“</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Enclave_u.h&quot;</span>   <span class="comment">// edger8rä¸ºAppç”Ÿæˆçš„å¤´æ–‡ä»¶</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Appå¿…é¡»å®ç°æ‰€æœ‰åœ¨EDLä¸­å£°æ˜çš„OCALLå‡½æ•°</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ocall_print_log</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *str)</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; str &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">sgx_enclave_id_t</span> eid = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// ... å…¶ä»–å˜é‡ ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// --- ç†è®ºäº¤æ±‡ç‚¹ 1: Enclaveçš„è¯ç”Ÿ ---</span></span><br><span class="line">    <span class="comment">// è¿™ä¸€è¡Œä»£ç ï¼Œè§¦å‘äº†æ•´ä¸ªEnclaveçš„ç¡¬ä»¶åŠ è½½ç”Ÿå‘½å‘¨æœŸï¼</span></span><br><span class="line">    <span class="type">sgx_status_t</span> ret = <span class="built_in">sgx_create_enclave</span>(</span><br><span class="line">        <span class="string">&quot;enclave.signed.so&quot;</span>, <span class="comment">// æŒ‡å‘ç­¾è¿‡åçš„Enclaveæ–‡ä»¶</span></span><br><span class="line">        SGX_DEBUG_FLAG,      <span class="comment">// æ˜¯å¦å…è®¸è°ƒè¯•</span></span><br><span class="line">        &amp;token, &amp;updated, </span><br><span class="line">        &amp;eid, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">// èƒŒåå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</span></span><br><span class="line">    <span class="comment">// 1. ECREATE: åˆ›å»ºSECSã€‚</span></span><br><span class="line">    <span class="comment">// 2. EADD: é€é¡µåŠ è½½enclave.signed.soçš„ä»£ç å’Œæ•°æ®åˆ°EPCã€‚</span></span><br><span class="line">    <span class="comment">// 3. EEXTEND: ç¡¬ä»¶å¹¶è¡Œè®¡ç®—MRENCLAVEã€‚</span></span><br><span class="line">    <span class="comment">// 4. EINIT: ç¡¬ä»¶ç”¨SIGSTRUCTä¸­çš„å…¬é’¥ï¼ŒéªŒè¯MRENCLAVEç­¾åï¼Œ</span></span><br><span class="line">    <span class="comment">//    å¹¶è®¡ç®—ã€å­˜å…¥MRSIGNERã€‚</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (ret != SGX_SUCCESS) &#123; <span class="comment">/* ... é”™è¯¯å¤„ç† ... */</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --- ç†è®ºäº¤æ±‡ç‚¹ 2: è¿›å…¥Enclave ---</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* secret_data = <span class="string">&quot;my secret&quot;</span>;</span><br><span class="line">    <span class="comment">// è¿™ä¸ªå‡½æ•°è°ƒç”¨ï¼Œå®é™…ä¸Šè§¦å‘äº†EENTERæŒ‡ä»¤ï¼</span></span><br><span class="line">    <span class="built_in">ecall_process_data</span>(eid, secret_data, <span class="built_in">strlen</span>(secret_data));</span><br><span class="line">    <span class="comment">// èƒŒåå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</span></span><br><span class="line">    <span class="comment">// 1. CPUä¿å­˜å½“å‰Appçš„ä¸Šä¸‹æ–‡ï¼ˆå¯„å­˜å™¨ç­‰ï¼‰ã€‚</span></span><br><span class="line">    <span class="comment">// 2. å°†æ‰§è¡Œæµè·³è½¬åˆ°Enclaveå†…éƒ¨çš„æŒ‡å®šå…¥å£ç‚¹ã€‚</span></span><br><span class="line">    <span class="comment">// 3. EPCMç¡¬ä»¶ç¡®ä¿Enclaveåªèƒ½è®¿é—®è‡ªå·±çš„EPCå†…å­˜ã€‚</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// --- ç†è®ºäº¤æ±‡ç‚¹ 3: é”€æ¯Enclave ---</span></span><br><span class="line">    <span class="built_in">sgx_destroy_enclave</span>(eid); <span class="comment">// è§¦å‘EREMOVEæŒ‡ä»¤ï¼Œæ“¦é™¤SECS</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2. Enclaveéƒ¨åˆ† (<code>Enclave.cpp</code>) - â€œä¿é™©åº“â€å†…çš„æ ¸å¿ƒé€»è¾‘</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Enclave_t.h&quot;</span>   <span class="comment">// edger8rä¸ºEnclaveç”Ÿæˆçš„å¤´æ–‡ä»¶</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Enclaveå®ç°æ‰€æœ‰åœ¨EDLä¸­å£°æ˜çš„ECALLå‡½æ•°</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ecall_process_data</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* data, <span class="type">size_t</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ­¤æ—¶ï¼Œä»£ç å·²åœ¨å—ä¿æŠ¤çš„EPCä¸­æ‰§è¡Œ</span></span><br><span class="line">    <span class="comment">// å‚æ•°&#x27;data&#x27;å·²ç»è¢«å®‰å…¨åœ°ä»ä¸å¯ä¿¡å†…å­˜æ‹·è´è¿›æ¥</span></span><br><span class="line">    <span class="type">char</span> log_msg[] = <span class="string">&quot;[Enclave] Data received and processed securely.&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --- ç†è®ºäº¤æ±‡ç‚¹ 4: é€€å‡ºEnclave ---</span></span><br><span class="line">    <span class="comment">// è¿™ä¸ªå‡½æ•°è°ƒç”¨ï¼Œå®é™…ä¸Šè§¦å‘äº†EEXITæŒ‡ä»¤ï¼</span></span><br><span class="line">    <span class="built_in">ocall_print_log</span>(log_msg);</span><br><span class="line">    <span class="comment">// èƒŒåå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</span></span><br><span class="line">    <span class="comment">// 1. CPUä¿å­˜å½“å‰Enclaveçš„ä¸Šä¸‹æ–‡ã€‚</span></span><br><span class="line">    <span class="comment">// 2. è¿”å›åˆ°Appä¸­ï¼Œæ‰§è¡ŒAppå®ç°çš„ocall_print_logå‡½æ•°ã€‚</span></span><br><span class="line">    <span class="comment">// 3. ä»OCALLè¿”å›åï¼ŒCPUä¼šé€šè¿‡ERESUMEæŒ‡ä»¤æ¢å¤Enclaveçš„æ‰§è¡Œã€‚</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="d-æœ€åçš„é­”æ³•ï¼šsgx-signä¸SIGSTRUCT"><a href="#d-æœ€åçš„é­”æ³•ï¼šsgx-signä¸SIGSTRUCT" class="headerlink" title="d) æœ€åçš„é­”æ³•ï¼šsgx_signä¸SIGSTRUCT"></a>d) æœ€åçš„é­”æ³•ï¼š<code>sgx_sign</code>ä¸<code>SIGSTRUCT</code></h3><p>æ‚¨ç¼–å†™çš„<code>Enclave.so</code>è¿˜ä¸èƒ½ç›´æ¥è¢«åŠ è½½ï¼Œå®ƒå¿…é¡»è¢«ç­¾åã€‚SDKæä¾›çš„<code>sgx_sign</code>å·¥å…·ä¼šæ‰§è¡Œè¿™æœ€åä¸€æ­¥å…³é”®çš„â€å°è£…â€ï¼š</p><ol><li><strong>è®¡ç®—MRENCLAVE</strong>: å·¥å…·ä¼šæ¨¡æ‹Ÿç¡¬ä»¶çš„<code>EEXTEND</code>è¿‡ç¨‹ï¼Œå¯¹æ‚¨çš„<code>Enclave.so</code>å†…å®¹è¿›è¡Œå®Œæ•´æ€§æµ‹é‡ï¼Œè®¡ç®—å‡ºæœ€ç»ˆçš„<code>MRENCLAVE</code>å€¼ã€‚</li><li><strong>ç”Ÿæˆç­¾å</strong>: æ‚¨éœ€è¦æä¾›ä¸€ä¸ªRSAç§é’¥ã€‚<code>sgx_sign</code>ä¼šç”¨è¿™ä¸ªç§é’¥ï¼Œå¯¹ä¸Šä¸€æ­¥ç®—å‡ºçš„<code>MRENCLAVE</code>è¿›è¡Œæ•°å­—ç­¾åã€‚</li><li><strong>æ‰“åŒ…SIGSTRUCT</strong>: å·¥å…·å°†æ‚¨çš„<strong>å…¬é’¥</strong>ã€ä¸Šä¸€æ­¥ç”Ÿæˆçš„<strong>ç­¾å</strong>ï¼Œä»¥åŠå…¶ä»–å…ƒæ•°æ®ï¼ˆå¦‚<code>ISVSVN</code>ï¼‰æ‰“åŒ…æˆä¸€ä¸ª<code>SIGSTRUCT</code>ç»“æ„ã€‚</li><li><strong>ç”Ÿæˆæœ€ç»ˆæ–‡ä»¶</strong>: æœ€åï¼Œå®ƒå°†åŸå§‹çš„<code>Enclave.so</code>å’Œè¿™ä¸ª<code>SIGSTRUCT</code>æ†ç»‘åœ¨ä¸€èµ·ï¼Œç”Ÿæˆæœ€ç»ˆçš„å¯åŠ è½½æ–‡ä»¶ï¼š<code>enclave.signed.so</code>ã€‚</li></ol><p>è¿™ä¸ª<code>enclave.signed.so</code>æ–‡ä»¶ï¼Œå°±æ˜¯<code>sgx_create_enclave</code>å‡½æ•°çœŸæ­£è¯»å–çš„å¯¹è±¡ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬æ‰€æœ‰å®‰å…¨æœºåˆ¶çš„èµ·ç‚¹ã€‚</p><h3 id="e-è¶…è¶Šâ€Hello-Worldâ€ï¼šä¸€ä¸ªæ›´çœŸå®çš„æ€æƒ³å®éªŒ"><a href="#e-è¶…è¶Šâ€Hello-Worldâ€ï¼šä¸€ä¸ªæ›´çœŸå®çš„æ€æƒ³å®éªŒ" class="headerlink" title="e) è¶…è¶Šâ€Hello Worldâ€ï¼šä¸€ä¸ªæ›´çœŸå®çš„æ€æƒ³å®éªŒ"></a>e) è¶…è¶Šâ€Hello Worldâ€ï¼šä¸€ä¸ªæ›´çœŸå®çš„æ€æƒ³å®éªŒ</h3><p>æƒ³è±¡ä¸€ä¸ªåœºæ™¯ï¼šä¸¤å®¶äº’ä¸ä¿¡ä»»çš„åŒ»é™¢ï¼Œæƒ³è”åˆç ”ç©¶ä¸€ç§ç½•è§ç—…ï¼Œä½†åˆä¸èƒ½å°†å„è‡ªçš„ç—…äººéšç§æ•°æ®ç›´æ¥åˆ†äº«ç»™å¯¹æ–¹ã€‚</p><ul><li><strong>SGXè§£å†³æ–¹æ¡ˆ</strong>:<ol><li>ä¸€ä¸ªä¸­ç«‹çš„è½¯ä»¶å¼€å‘è€…ï¼Œå¼€å‘å¹¶ç­¾åä¸€ä¸ªæ•°æ®åˆ†æEnclaveã€‚<code>MRSIGNER</code>ä»£è¡¨äº†è¿™ä¸ªç®—æ³•æä¾›æ–¹çš„å¯ä¿¡èº«ä»½ã€‚</li><li>ä¸¤å®¶åŒ»é™¢éƒ½é€šè¿‡<strong>è¿œç¨‹è®¤è¯</strong>ï¼ŒéªŒè¯åœ¨äº‘æœåŠ¡å™¨ä¸Šè¿è¡Œçš„ï¼Œç¡®å®æ˜¯é‚£ä¸ªæœªç»ç¯¡æ”¹çš„ã€ç”±å¯ä¿¡æ–¹å¼€å‘çš„Enclave (<code>MRENCLAVE</code>å’Œ<code>MRSIGNER</code>éƒ½æ­£ç¡®)ã€‚</li><li>ä¸¤å®¶åŒ»é™¢å„è‡ªä¸Enclaveå»ºç«‹ç«¯åˆ°ç«¯çš„åŠ å¯†ä¿¡é“ã€‚</li><li>å®ƒä»¬å°†è‡ªå·±çš„åŠ å¯†ç—…äººæ•°æ®å‘é€ç»™Enclaveã€‚æ•°æ®åªæœ‰åœ¨Enclaveå†…éƒ¨æ‰è¢«è§£å¯†å’Œå¤„ç†ã€‚</li><li>Enclaveåœ¨å†…éƒ¨å®Œæˆè”åˆç»Ÿè®¡åˆ†æï¼Œå¹¶å°†æœ€ç»ˆçš„ã€ä¸å«ä»»ä½•ä¸ªä½“éšç§çš„ç»Ÿè®¡ç»“æœè¿”å›ç»™ä¸¤å®¶åŒ»é™¢ã€‚</li></ol></li></ul><p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæ²¡æœ‰ä»»ä½•ä¸€æ–¹ï¼ˆåŒ…æ‹¬äº‘æœåŠ¡å•†ã€ç®—æ³•å¼€å‘è€…ã€ä»»ä½•ä¸€å®¶åŒ»é™¢ï¼‰èƒ½çœ‹åˆ°å¦ä¸€æ–¹çš„åŸå§‹æ•°æ®ï¼Œä½†è”åˆè®¡ç®—çš„ç›®æ ‡å´è¾¾æˆäº†ã€‚è¿™å°±æ˜¯SGXåœ¨ç°å®ä¸–ç•Œä¸­å‘æŒ¥å…¶â€æœºå¯†è®¡ç®—â€æ ¸å¿ƒä»·å€¼çš„å…¸å‹æ¨¡å¼ã€‚</p><hr><p>*è‡³æ­¤ï¼Œæˆ‘ä»¬å®Œæˆäº†ä»ç†è®ºåˆ°æ¦‚å¿µå®è·µçš„å®Œæ•´æ—…ç¨‹ã€‚SGXçš„ä½“ç³»è™½ç„¶å¤æ‚ï¼Œä½†å…¶æ¯ä¸€ä¸ªè®¾è®¡éƒ½æœåŠ¡äºä¸€ä¸ªæ˜ç¡®çš„å®‰å…¨ç›®æ ‡ï¼ˆæ¯æ¬¡æˆ‘éƒ½ä¼šä»¥è´¨ç–‘çš„ç›®å…‰å»çœ‹æ¯ä¸ªç»„ä»¶åŠæµç¨‹çš„æ„ä¹‰ï¼‰</p><h3 id="å…­ã€æœªæ¥æŒ‘æˆ˜ï¼šå¦‚ä½•å°½é‡é¢„é˜²ä¾§ä¿¡é“æ”»å‡»"><a href="#å…­ã€æœªæ¥æŒ‘æˆ˜ï¼šå¦‚ä½•å°½é‡é¢„é˜²ä¾§ä¿¡é“æ”»å‡»" class="headerlink" title="å…­ã€æœªæ¥æŒ‘æˆ˜ï¼šå¦‚ä½•å°½é‡é¢„é˜²ä¾§ä¿¡é“æ”»å‡»"></a>å…­ã€æœªæ¥æŒ‘æˆ˜ï¼šå¦‚ä½•å°½é‡é¢„é˜²ä¾§ä¿¡é“æ”»å‡»</h3><blockquote><p>æ²¡æœ‰ä»»ä½•æŠ€æœ¯æ˜¯ä¸€å®šç»å¯¹å®‰å…¨çš„ã€‚æ”¾å®½æ—¶é—´çš„é•¿åº¦ï¼Œä»»ä½•æŠ€æœ¯åœ¨æœªæ¥éƒ½ä¼šé¢ä¸´æŒ‘æˆ˜ã€‚å³ä½¿æ˜¯å¯†ç å­¦åŠ å¯†åº”ç”¨çš„çš‡å† â€”â€”éå¯¹ç§°åŠ å¯†ï¼Œä¹Ÿåœ¨é¢„é˜²æ¥è‡ªé‡å­è®¡ç®—çš„æ”»å‡»ã€‚</p></blockquote><p>å°½ç®¡ SGX åœ¨é˜²å¾¡ç›´æ¥çš„è½¯ä»¶æ”»å‡»ï¼ˆå¦‚å†…å­˜è¯»å–ã€ä»£ç æ³¨å…¥ï¼‰æ–¹é¢åšå¾—éå¸¸å‡ºè‰²ï¼Œä½†å®ƒä¾ç„¶é¢ä¸´ç€ä¸€ç±»æ›´ä¸ºå¾®å¦™å’Œå›°éš¾çš„å¨èƒâ€”â€”<strong>ä¾§ä¿¡é“æ”»å‡»ï¼ˆSide-Channel Attacksï¼‰</strong>ã€‚</p><h4 id="10-1-ä»€ä¹ˆæ˜¯ä¾§ä¿¡é“æ”»å‡»ï¼Ÿ"><a href="#10-1-ä»€ä¹ˆæ˜¯ä¾§ä¿¡é“æ”»å‡»ï¼Ÿ" class="headerlink" title="10.1 ä»€ä¹ˆæ˜¯ä¾§ä¿¡é“æ”»å‡»ï¼Ÿ"></a>10.1 ä»€ä¹ˆæ˜¯ä¾§ä¿¡é“æ”»å‡»ï¼Ÿ</h4><p>ä¾§ä¿¡é“æ”»å‡»ä¸ç›´æ¥æ”»å‡»åŠ å¯†ç®—æ³•æˆ–å®‰å…¨åè®®æœ¬èº«ï¼Œè€Œæ˜¯é€šè¿‡è§‚å¯Ÿè®¡ç®—è¿‡ç¨‹ä¸­çš„<strong>ç‰©ç†ä¿¡æ¯æˆ–å‰¯ä½œç”¨ï¼ˆå³â€ä¾§ä¿¡é“â€ï¼‰</strong>æ¥æ¨æ–­æ•æ„Ÿä¿¡æ¯ã€‚è¿™äº›â€å‰¯ä½œç”¨â€äº”èŠ±å…«é—¨ï¼Œå¯¹äº SGX æ¥è¯´ï¼Œæœ€ä¸»è¦çš„å¨èƒæ¥è‡ªäºï¼š</p><ol><li><strong>ç¼“å­˜æ”»å‡»ï¼ˆCache-based Attacksï¼‰</strong>ï¼šé€šè¿‡ç²¾ç¡®æµ‹é‡è®¿é—®æŸä¸ªå†…å­˜åœ°å€çš„è€—æ—¶ï¼Œæ”»å‡»è€…å¯ä»¥æ¨æ–­å‡ºè¯¥åœ°å€å¯¹åº”çš„æ•°æ®æ˜¯å¦åœ¨ CPU ç¼“å­˜ä¸­ã€‚æ¶æ„ç¨‹åºå¯ä»¥é€šè¿‡ç›‘æ§ä¸ Enclave å…±äº«çš„ CPU ç¼“å­˜ï¼ˆç‰¹åˆ«æ˜¯ L3 Cacheï¼‰ï¼Œæ¥æ¨æ–­ Enclave çš„å†…å­˜è®¿é—®æ¨¡å¼ï¼Œä»è€Œå¯èƒ½æ³„éœ²åŠ å¯†å¯†é’¥ç­‰ä¿¡æ¯ã€‚<code>Foreshadow</code>, <code>L1TF</code> ç­‰éƒ½æ˜¯è‘—åçš„ç¼“å­˜ä¾§ä¿¡é“æ”»å‡»ã€‚</li><li><strong>é¡µè¡¨æ”»å‡»ï¼ˆPage-Fault-based Attacksï¼‰</strong>ï¼šæ¶æ„çš„ OS æ§åˆ¶ç€é¡µè¡¨ã€‚å®ƒè™½ç„¶ä¸èƒ½è¯»å– Enclave çš„é¡µé¢å†…å®¹ï¼Œä½†å¯ä»¥é€šè¿‡æ•…æ„å°†æŸä¸ª Enclave é¡µé¢æ ‡è®°ä¸ºâ€ä¸å­˜åœ¨â€ï¼ˆNot Presentï¼‰ï¼Œæ¥è§‚å¯Ÿ Enclave ä½•æ—¶ä¼šè®¿é—®å®ƒã€‚å½“ Enclave è®¿é—®è¯¥é¡µé¢æ—¶ï¼Œä¼šè§¦å‘ä¸€æ¬¡é¡µé¢é”™è¯¯ï¼ˆPage Faultï¼‰ï¼ŒOS å°±èƒ½æ•è·åˆ°è¿™ä¸ªäº‹ä»¶ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒOS å¯ä»¥ç²¾ç¡®åœ°ç›‘æ§ Enclave çš„ä»£ç æ‰§è¡Œæµå’Œæ•°æ®è®¿é—®æ¨¡å¼ã€‚</li><li><strong>åˆ†æ”¯é¢„æµ‹æ”»å‡»ï¼ˆBranch Prediction Attacksï¼‰</strong>ï¼šåƒ <code>Spectre</code> è¿™æ ·çš„æ”»å‡»åˆ©ç”¨äº†ç°ä»£ CPU çš„åˆ†æ”¯é¢„æµ‹æ‰§è¡Œå•å…ƒã€‚æ”»å‡»è€…å¯ä»¥â€è®­ç»ƒâ€åˆ†æ”¯é¢„æµ‹å™¨ï¼Œè¯±å¯¼ Enclave åœ¨æ¨æµ‹æ‰§è¡Œï¼ˆSpeculative Executionï¼‰çš„è·¯å¾„ä¸Šè®¿é—®å…¶å†…éƒ¨çš„æ•æ„Ÿæ•°æ®ï¼Œå¹¶é€šè¿‡ç¼“å­˜ç­‰ä¾§ä¿¡é“å°†è¿™äº›ä¿¡æ¯æ³„éœ²å‡ºæ¥ã€‚</li></ol><h4 id="10-2-ä¸ºä½•-SGX-éš¾ä»¥å®Œå…¨å…ç–«ä¾§ä¿¡é“æ”»å‡»ï¼Ÿ"><a href="#10-2-ä¸ºä½•-SGX-éš¾ä»¥å®Œå…¨å…ç–«ä¾§ä¿¡é“æ”»å‡»ï¼Ÿ" class="headerlink" title="10.2 ä¸ºä½• SGX éš¾ä»¥å®Œå…¨å…ç–«ä¾§ä¿¡é“æ”»å‡»ï¼Ÿ"></a>10.2 ä¸ºä½• SGX éš¾ä»¥å®Œå…¨å…ç–«ä¾§ä¿¡é“æ”»å‡»ï¼Ÿ</h4><p>SGX çš„è®¾è®¡ç†å¿µæ˜¯å°† OS æ’é™¤åœ¨ TCB ä¹‹å¤–ï¼Œä½†å®ƒæ— æ³•æ”¹å˜ä¸€ä¸ªåŸºæœ¬äº‹å®ï¼š<strong>Enclave å¿…é¡»ä¸ä¸å¯ä¿¡çš„ OS å…±äº«åº•å±‚çš„ç‰©ç†ç¡¬ä»¶èµ„æº</strong>ï¼Œå¦‚ CPU ç¼“å­˜ã€åˆ†æ”¯é¢„æµ‹å™¨ã€å†…å­˜æ§åˆ¶å™¨ç­‰ã€‚ä¾§ä¿¡é“æ”»å‡»æ­£æ˜¯åˆ©ç”¨äº†å¯¹è¿™äº›å…±äº«èµ„æºçš„è®¿é—®å’Œè§‚å¯Ÿèƒ½åŠ›ã€‚SGX çš„å†…å­˜åŠ å¯†å’Œè®¿é—®æ§åˆ¶æ— æ³•é˜»æ­¢è¿™äº›â€å…ƒä¿¡æ¯â€çš„æ³„éœ²ã€‚</p><h4 id="10-3-é˜²æŠ¤ç­–ç•¥ä¸æœªæ¥æ–¹å‘"><a href="#10-3-é˜²æŠ¤ç­–ç•¥ä¸æœªæ¥æ–¹å‘" class="headerlink" title="10.3 é˜²æŠ¤ç­–ç•¥ä¸æœªæ¥æ–¹å‘"></a>10.3 é˜²æŠ¤ç­–ç•¥ä¸æœªæ¥æ–¹å‘</h4><p>é¢„é˜²ä¾§ä¿¡é“æ”»å‡»æ˜¯ä¸€ä¸ªæŒç»­æ¼”è¿›çš„ã€ç³»ç»Ÿæ€§çš„å·¥ç¨‹ï¼Œéœ€è¦è½¯ä»¶å’Œç¡¬ä»¶çš„ååŒåŠªåŠ›ã€‚</p><ol><li><p><strong>ç¡¬ä»¶å±‚é¢æ”¹è¿› (æ¥è‡ª Intel)</strong></p><ul><li><strong>å¢å¼ºéš”ç¦»</strong>ï¼šåœ¨æ–°ä¸€ä»£çš„ CPU ä¸­ï¼ŒIntel å·²ç»å¼€å§‹å¼•å…¥æ›´å¼ºçš„ç¡¬ä»¶éš”ç¦»æœºåˆ¶ï¼Œä¾‹å¦‚ L1 ç¼“å­˜çš„åˆ·æ–°æœºåˆ¶ã€å¯¹åˆ†æ”¯é¢„æµ‹å™¨çš„é—´æ¥åˆ†æ”¯é™åˆ¶ï¼ˆIBRS&#x2F;IBPBï¼‰ç­‰ï¼Œä»¥å‡å°ä¿¡æ¯æ³„éœ²çš„å¸¦å®½ã€‚</li><li><strong>TCB æ›´æ–°</strong>ï¼šIntel ä¼šå®šæœŸå‘å¸ƒå¾®ç ï¼ˆMicrocodeï¼‰æ›´æ–°ï¼Œä¿®å¤å·²çŸ¥çš„ç¡¬ä»¶æ¼æ´ã€‚ä¿æŒ TCB çš„æ›´æ–°æ˜¯é˜²å¾¡çš„åŸºç¡€ã€‚</li></ul></li><li><p><strong>è½¯ä»¶å±‚é¢ç¼“è§£ (æ¥è‡ªå¼€å‘è€…)</strong></p><ul><li><strong>æ•°æ®æ— å…³çš„ç¼–ç¨‹èŒƒå¼</strong>ï¼šç¼–å†™ä»£ç æ—¶ï¼Œå°½é‡é¿å…è®©ç¨‹åºçš„å†…å­˜è®¿é—®æ¨¡å¼æˆ–æ‰§è¡Œæ—¶é—´ä¸æ•æ„Ÿæ•°æ®ç›´æ¥ç›¸å…³ã€‚ä¾‹å¦‚ï¼Œæ— è®ºè¾“å…¥æ˜¯ä»€ä¹ˆï¼Œéƒ½æ‰§è¡Œç›¸åŒçš„åˆ†æ”¯å’Œå†…å­˜è®¿é—®è·¯å¾„ã€‚è¿™è¢«ç§°ä¸ºâ€æ’å®šæ—¶é—´ç¼–ç¨‹â€ï¼ˆConstant-Time Programmingï¼‰ã€‚</li><li><strong>è®¿é—®æ¨¡å¼æ··æ·†</strong>ï¼šåœ¨ä»£ç ä¸­æ’å…¥ä¸€äº›ä¼ªéšæœºçš„ã€æ— æ„ä¹‰çš„å†…å­˜è®¿é—®æŒ‡ä»¤ï¼Œä»¥â€æ·¹æ²¡â€çœŸå®çš„å†…å­˜è®¿é—®ä¿¡å·ï¼Œè®©æ”»å‡»è€…éš¾ä»¥åˆ†æã€‚è¿™è¢«ç§°ä¸ºâ€ä»£ç æ··æ·†â€æˆ–â€å™ªå£°æ³¨å…¥â€ã€‚</li><li><strong>ä½¿ç”¨ SDK&#x2F;ç¼–è¯‘å™¨æä¾›çš„é˜²æŠ¤</strong>ï¼šä¸€äº›å…ˆè¿›çš„ SGX SDK æˆ–ä¸“é—¨çš„å®‰å…¨ç¼–è¯‘å™¨ï¼ˆå¦‚ <code>T-SGX</code>ï¼‰ä¼šå°è¯•è‡ªåŠ¨åœ¨ä»£ç ä¸­æ’å…¥é˜²æŠ¤æŒ‡ä»¤ã€‚ä¾‹å¦‚ï¼Œåœ¨æ¯æ¬¡è¿›å…¥æˆ–é€€å‡º Enclave æ—¶è‡ªåŠ¨åˆ·æ–°åˆ†æ”¯é¢„æµ‹å™¨çŠ¶æ€ï¼Œæˆ–åœ¨å¾ªç¯çš„æœ«å°¾æ’å…¥ <code>LFENCE</code> æŒ‡ä»¤æ¥é˜»æ­¢æ¨æµ‹æ‰§è¡Œè¶Šè¿‡è¾¹ç•Œã€‚</li><li><strong>å‡å°‘æ”»å‡»é¢</strong>ï¼šç²¾å¿ƒè®¾è®¡ Enclave çš„æ¥å£ï¼ˆECALL&#x2F;OCALLï¼‰ï¼Œæœ€å°åŒ–ä¸ä¸å¯ä¿¡ä¸–ç•Œçš„äº¤äº’æ¬¡æ•°å’Œæ•°æ®é‡ã€‚é¿å…åœ¨ Enclave å†…éƒ¨å¤„ç†è¿‡äºå¤æ‚çš„é€»è¾‘ï¼Œå°¤å…¶æ˜¯é‚£äº›å®¹æ˜“äº§ç”Ÿå¤æ‚åˆ†æ”¯å’Œå†…å­˜è®¿é—®æ¨¡å¼çš„é€»è¾‘ã€‚</li></ul></li><li><p><strong>æ“ä½œç³»ç»Ÿ&#x2F;VMM å±‚é¢</strong></p><ul><li><strong>èµ„æºåˆ’åˆ†</strong>ï¼šåœ¨äº‘ç¯å¢ƒä¸­ï¼Œå¯ä»¥é‡‡ç”¨æ›´ä¸¥æ ¼çš„èµ„æºè°ƒåº¦ç­–ç•¥ï¼Œä¾‹å¦‚ï¼Œå°†è¿è¡Œæ•æ„Ÿ Enclave çš„ç‰©ç†æ ¸å¿ƒä¸è¿è¡Œå…¶ä»–ä¸å¯ä¿¡ä»»åŠ¡çš„æ ¸å¿ƒåˆ†ç¦»å¼€ï¼Œé¿å…å…±äº« L1&#x2F;L2 ç¼“å­˜ã€‚</li></ul></li></ol><p><strong>æ€»ç»“</strong>ï¼šä¾§ä¿¡é“æ”»å‡»æ˜¯ SGX ä¹ƒè‡³æ‰€æœ‰ç°ä»£å¤„ç†å™¨é¢ä¸´çš„å…±åŒæŒ‘æˆ˜ã€‚ç›®å‰æ²¡æœ‰ä¸€åŠ³æ°¸é€¸çš„â€é“¶å¼¹â€ï¼Œé˜²æŠ¤å·¥ä½œæ›´åƒæ˜¯ä¸€åœºæŒç»­çš„â€å†›å¤‡ç«èµ›â€ã€‚æˆ‘ä»¬éœ€è¦ä¿æŒå¯¹æœ€æ–°æ”»å‡»æ–¹æ³•çš„å…³æ³¨ï¼Œå¹¶åœ¨ç¼–ç¨‹å®è·µä¸­å§‹ç»ˆè´¯ç©¿â€å‡å°‘ä¿¡æ¯æ³„éœ²â€çš„å®‰å…¨æ„è¯†ï¼Œç»“åˆä½¿ç”¨ç¡¬ä»¶æ›´æ–°ã€SDK é˜²æŠ¤å’Œæ•°æ®æ— å…³ç¼–ç¨‹ç­‰å¤šç§ç­–ç•¥ï¼Œæ¥å…±åŒæ„å»ºæ›´å¥å£®çš„æœºå¯†è®¡ç®—åº”ç”¨ã€‚</p><blockquote><p>ä¸–é—´å®‰å¾—åŒå…¨æ³•ï¼Œå”¯æœ‰ä¸æ–­å‰è¿›</p></blockquote><hr><h2 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h2><p>æˆ‘ä»¬ä» SGX çš„åŸºæœ¬æ¦‚å¿µå’Œ TCB å‡ºå‘ï¼Œæ·±å…¥å‰–æäº†å…¶æ ¸å¿ƒç¡¬ä»¶ç»„ä»¶ã€å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸã€å…³é”®çš„ç¡¬ä»¶æŒ‡ä»¤é›†ï¼Œå¹¶è¯¦ç»†æ‹†è§£äº†å†…å­˜å®‰å…¨ã€èº«ä»½è®¤è¯ã€æŒä¹…åŒ–å­˜å‚¨è¿™ä¸‰å¤§æ ¸å¿ƒå®‰å…¨æœºåˆ¶ã€‚æœ€åï¼Œæˆ‘ä»¬è¿˜é€šè¿‡ä¸€ä¸ªç¼–ç¨‹å®ä¾‹å±•ç¤ºäº†å¦‚ä½•ä¸Šæ‰‹ SGX å¼€å‘ï¼Œå¹¶æ¢è®¨äº†ä¾§ä¿¡é“æ”»å‡»è¿™ä¸€å‰æ²¿æŒ‘æˆ˜ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> éšç§è®¡ç®— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æœºå¯†è®¡ç®— </tag>
            
            <tag> TEE </tag>
            
            <tag> Intel SGX </tag>
            
            <tag> ç¡¬ä»¶å®‰å…¨ </tag>
            
            <tag> å¯ä¿¡æ‰§è¡Œç¯å¢ƒ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hypervisorä¸»è¦åŸç†è§£æï¼šä¼ ç»Ÿè™šæ‹ŸåŒ–æŠ€æœ¯ä¸HyperEnclave</title>
      <link href="/2025/07/26/Hypervisor%E6%8A%80%E6%9C%AF%E8%AF%A6%E8%A7%A3/"/>
      <url>/2025/07/26/Hypervisor%E6%8A%80%E6%9C%AF%E8%AF%A6%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<h1 id="Hypervisorä¸»è¦åŸç†è§£æï¼šä¼ ç»Ÿè™šæ‹ŸåŒ–æŠ€æœ¯ä¸HyperEnclave"><a href="#Hypervisorä¸»è¦åŸç†è§£æï¼šä¼ ç»Ÿè™šæ‹ŸåŒ–æŠ€æœ¯ä¸HyperEnclave" class="headerlink" title="Hypervisorä¸»è¦åŸç†è§£æï¼šä¼ ç»Ÿè™šæ‹ŸåŒ–æŠ€æœ¯ä¸HyperEnclave"></a>Hypervisorä¸»è¦åŸç†è§£æï¼šä¼ ç»Ÿè™šæ‹ŸåŒ–æŠ€æœ¯ä¸HyperEnclave</h1><h2 id="1-Hypervisor-æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#1-Hypervisor-æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="1. Hypervisor æ˜¯ä»€ä¹ˆï¼Ÿ"></a>1. Hypervisor æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>åœ¨æ·±å…¥æŠ€æœ¯ç»†èŠ‚ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆè¦ç†è§£ Hypervisor åˆ°åº•æ˜¯ä»€ä¹ˆã€‚</p><p>ç®€å•æ¥è¯´ï¼Œ<strong>Hypervisor</strong>ï¼Œåˆç§°ä¸º**è™šæ‹Ÿæœºç›‘è§†å™¨ (Virtual Machine Monitor, VMM)**ï¼Œæ˜¯ä¸€ç§è½¯ä»¶ã€å›ºä»¶ï¼Œå®ƒèƒ½å¤Ÿåˆ›å»ºå¹¶è¿è¡Œè™šæ‹Ÿæœº (Virtual Machines, VMs)ã€‚å®ƒæ˜¯ä¸€ä¸ªâ€œå…ƒæ“ä½œç³»ç»Ÿâ€ï¼Œå…è®¸å¤šä¸ªæ“ä½œç³»ç»Ÿï¼ˆç§°ä¸ºå®¢æˆ·æœºæ“ä½œç³»ç»Ÿï¼ŒGuest OSï¼‰å…±äº«åŒä¸€å¥—ç‰©ç†ç¡¬ä»¶èµ„æºã€‚</p><p>Hypervisor çš„æ ¸å¿ƒä½¿å‘½æ˜¯<strong>è™šæ‹ŸåŒ–</strong>â€”â€”å³ä¸ºæ¯ä¸ªè™šæ‹Ÿæœºåˆ›å»ºä¸€ä¸ªè™šæ‹Ÿçš„ã€ç‹¬ç«‹çš„ç¡¬ä»¶å¹³å°ï¼ŒåŒ…æ‹¬è™šæ‹Ÿçš„ CPUã€å†…å­˜ã€ç¡¬ç›˜å’Œç½‘ç»œæ¥å£ç­‰ã€‚è¿™ä½¿å¾—è™šæ‹Ÿæœºä¸­çš„æ“ä½œç³»ç»Ÿè®¤ä¸ºè‡ªå·±ç‹¬å äº†ä¸€æ•´å°è®¡ç®—æœºï¼Œè€Œå®é™…ä¸Šå®ƒä»¬åªæ˜¯åœ¨ Hypervisor çš„åè°ƒä¸‹ï¼Œå…±äº«ä½¿ç”¨åº•å±‚çœŸå®çš„ç‰©ç†ç¡¬ä»¶ã€‚</p><p>è¿™ç§æŠ€æœ¯æ˜¯äº‘è®¡ç®—ã€æ•°æ®ä¸­å¿ƒç°ä»£åŒ–å’Œè½¯ä»¶å¼€å‘æµ‹è¯•ç­‰é¢†åŸŸçš„åŸºçŸ³ã€‚</p><h2 id="2-Hypervisor-çš„ä½“ç³»æ¶æ„ï¼šä¸¤å¤§åˆ†ç±»"><a href="#2-Hypervisor-çš„ä½“ç³»æ¶æ„ï¼šä¸¤å¤§åˆ†ç±»" class="headerlink" title="2. Hypervisor çš„ä½“ç³»æ¶æ„ï¼šä¸¤å¤§åˆ†ç±»"></a>2. Hypervisor çš„ä½“ç³»æ¶æ„ï¼šä¸¤å¤§åˆ†ç±»</h2><p>æ ¹æ® Hypervisor çš„è¿è¡Œæ–¹å¼å’Œæ‰€å¤„çš„ä½ç½®ï¼Œæˆ‘ä»¬é€šå¸¸å°†å…¶åˆ†ä¸ºä¸¤å¤§ç±»ï¼šType 1 å’Œ Type 2ã€‚</p><h3 id="Type-1-è£¸é‡‘å±-Hypervisor-Bare-metal"><a href="#Type-1-è£¸é‡‘å±-Hypervisor-Bare-metal" class="headerlink" title="Type 1: è£¸é‡‘å± Hypervisor (Bare-metal)"></a>Type 1: è£¸é‡‘å± Hypervisor (Bare-metal)</h3><p>Type 1 Hypervisor ç›´æ¥å®‰è£…åœ¨ç‰©ç†ç¡¬ä»¶ï¼ˆå³â€œè£¸é‡‘å±â€ï¼‰ä¹‹ä¸Šï¼Œå®ƒæœ¬èº«å°±æ˜¯ä¸€ä¸ªç²¾ç®€çš„æ“ä½œç³»ç»Ÿã€‚æ‰€æœ‰çš„å®¢æˆ·æœºæ“ä½œç³»ç»Ÿéƒ½è¿è¡Œåœ¨ Hypervisor ä¹‹ä¸Šã€‚è¿™ç§æ¶æ„æ€§èƒ½é«˜ã€å»¶è¿Ÿä½ï¼Œå› ä¸ºå®¢æˆ·æœºæ“ä½œç³»ç»Ÿå’Œç¡¬ä»¶ä¹‹é—´çš„ä¸­é—´å±‚æœ€å°‘ã€‚</p><p><strong>å¸¸è§ä¾‹å­</strong>: VMware ESXi, Microsoft Hyper-V, KVM (Kernel-based Virtual Machine), Xenã€‚</p><p><strong>æ¶æ„å›¾</strong>:</p><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD;    subgraph &quot;ç‰©ç†ç¡¬ä»¶&quot;      CPU[&quot;CPU&quot;]      Memory[&quot;å†…å­˜&quot;]      Storage[&quot;å­˜å‚¨&quot;]      Network[&quot;ç½‘ç»œ&quot;]    end    subgraph &quot;è™šæ‹Ÿæœº&quot;      VM1[&quot;è™šæ‹Ÿæœº 1 (å®¢æˆ·æœºæ“ä½œç³»ç»Ÿ + åº”ç”¨)&quot;]      VM2[&quot;è™šæ‹Ÿæœº 2 (å®¢æˆ·æœºæ“ä½œç³»ç»Ÿ + åº”ç”¨)&quot;]      VM3[&quot;è™šæ‹Ÿæœº 3 (å®¢æˆ·æœºæ“ä½œç³»ç»Ÿ + åº”ç”¨)&quot;]    end    Hypervisor[&quot;Hypervisor&quot;] -- &quot;ç®¡ç†ç¡¬ä»¶&quot; --&gt; CPU;    Hypervisor -- &quot;ç®¡ç†ç¡¬ä»¶&quot; --&gt; Memory;    Hypervisor -- &quot;ç®¡ç†ç¡¬ä»¶&quot; --&gt; Storage;    Hypervisor -- &quot;ç®¡ç†ç¡¬ä»¶&quot; --&gt; Network;    Hypervisor -- &quot;åˆ›å»ºå’Œè¿è¡Œ&quot; --&gt; VM1;    Hypervisor -- &quot;åˆ›å»ºå’Œè¿è¡Œ&quot; --&gt; VM2;    Hypervisor -- &quot;åˆ›å»ºå’Œè¿è¡Œ&quot; --&gt; VM3;  </pre></div><ul><li><strong>ä¼˜ç‚¹</strong>: æ€§èƒ½é«˜ã€å®‰å…¨æ€§å¥½ã€ç¨³å®šæ€§å¼ºã€‚</li><li><strong>ç¼ºç‚¹</strong>: é€šå¸¸éœ€è¦ä¸“é—¨çš„ç®¡ç†ç¡¬ä»¶ï¼Œé…ç½®ç›¸å¯¹å¤æ‚ã€‚</li></ul><h3 id="Type-2-å®¿ä¸»å‹-Hypervisor-Hosted"><a href="#Type-2-å®¿ä¸»å‹-Hypervisor-Hosted" class="headerlink" title="Type 2: å®¿ä¸»å‹ Hypervisor (Hosted)"></a>Type 2: å®¿ä¸»å‹ Hypervisor (Hosted)</h3><p>Type 2 Hypervisor åƒæ™®é€šåº”ç”¨ç¨‹åºä¸€æ ·ï¼Œè¿è¡Œåœ¨ä¸€ä¸ªå®Œæ•´çš„å®¿ä¸»æ“ä½œç³»ç»Ÿ (Host OS) ä¹‹ä¸Šã€‚å®ƒä¾èµ–å®¿ä¸»æ“ä½œç³»ç»Ÿæ¥ç®¡ç†ç¡¬ä»¶èµ„æºã€‚</p><p><strong>å¸¸è§ä¾‹å­</strong>: VMware Workstation, Oracle VirtualBox, QEMUã€‚</p><p><strong>æ¶æ„å›¾</strong>:</p><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD;    subgraph &quot;ç‰©ç†ç¡¬ä»¶&quot;        CPU[&quot;CPU&quot;]        Memory[&quot;å†…å­˜&quot;]        Storage[&quot;å­˜å‚¨&quot;]        Network[&quot;ç½‘ç»œ&quot;]    end    HostOS[&quot;å®¿ä¸»æ“ä½œç³»ç»Ÿ&quot;] -- &quot;ç®¡ç†&quot; --&gt; CPU    HostOS -- &quot;ç®¡ç†&quot; --&gt; Memory    HostOS -- &quot;ç®¡ç†&quot; --&gt; Storage    HostOS -- &quot;ç®¡ç†&quot; --&gt; Network    subgraph &quot;ç”¨æˆ·ç©ºé—´è¿›ç¨‹&quot;      Hypervisor[&quot;Hypervisor åº”ç”¨&quot;]    end        HostOS -- &quot;è¿è¡Œ&quot; --&gt; Hypervisor    subgraph &quot;è™šæ‹Ÿæœº&quot;        VM1[&quot;è™šæ‹Ÿæœº 1 (å®¢æˆ·æœºæ“ä½œç³»ç»Ÿ + åº”ç”¨)&quot;]        VM2[&quot;è™šæ‹Ÿæœº 2 (å®¢æˆ·æœºæ“ä½œç³»ç»Ÿ + åº”ç”¨)&quot;]    end    Hypervisor -- &quot;åˆ›å»ºå’Œè¿è¡Œ&quot; --&gt; VM1;    Hypervisor -- &quot;åˆ›å»ºå’Œè¿è¡Œ&quot; --&gt; VM2;  </pre></div><ul><li><strong>ä¼˜ç‚¹</strong>: å®‰è£…ç®€å•ï¼Œæ˜“äºä½¿ç”¨ï¼Œéå¸¸é€‚åˆä¸ªäººæ¡Œé¢å’Œå¼€å‘ç¯å¢ƒã€‚</li><li><strong>ç¼ºç‚¹</strong>: æ€§èƒ½å¼€é”€è¾ƒå¤§ï¼Œå› ä¸ºå¤šäº†ä¸€å±‚å®¿ä¸»æ“ä½œç³»ç»Ÿã€‚</li></ul><blockquote><p><strong>KVM çš„ç‰¹æ®Šæ€§</strong>: KVM æ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒå°† Linux å†…æ ¸æœ¬èº«è½¬å˜æˆäº†ä¸€ä¸ª Type 1 Hypervisorã€‚å½“ KVM æ¨¡å—åŠ è½½åï¼ŒLinux å†…æ ¸å°±å¯ä»¥ç›´æ¥ç®¡ç†å’Œè¿è¡Œè™šæ‹Ÿæœºï¼Œå› æ­¤å®ƒå…·å¤‡ Type 1 çš„æ€§èƒ½å’Œæ¶æ„ï¼Œä½†åˆä¿ç•™äº†å®Œæ•´ Linux æ“ä½œç³»ç»Ÿçš„åŠŸèƒ½ã€‚</p></blockquote><h2 id="3-Hypervisor-çš„å¯åŠ¨ä¸åˆå§‹åŒ–"><a href="#3-Hypervisor-çš„å¯åŠ¨ä¸åˆå§‹åŒ–" class="headerlink" title="3. Hypervisor çš„å¯åŠ¨ä¸åˆå§‹åŒ–"></a>3. Hypervisor çš„å¯åŠ¨ä¸åˆå§‹åŒ–</h2><p>äº†è§£ Hypervisor çš„æ¶æ„åï¼Œä¸€ä¸ªè‡ªç„¶è€Œç„¶çš„é—®é¢˜æ˜¯ï¼šå®ƒæ˜¯å¦‚ä½•å¯åŠ¨çš„ï¼Ÿå®ƒåœ¨è®¡ç®—æœºçš„å¯åŠ¨æµç¨‹ä¸­æ‰®æ¼”ä»€ä¹ˆè§’è‰²ï¼Ÿ</p><h3 id="3-1-è®¡ç®—æœºçš„é€šç”¨å¯åŠ¨æµç¨‹"><a href="#3-1-è®¡ç®—æœºçš„é€šç”¨å¯åŠ¨æµç¨‹" class="headerlink" title="3.1 è®¡ç®—æœºçš„é€šç”¨å¯åŠ¨æµç¨‹"></a>3.1 è®¡ç®—æœºçš„é€šç”¨å¯åŠ¨æµç¨‹</h3><p>æˆ‘ä»¬å¯ä»¥å°†è®¡ç®—æœºçš„å¯åŠ¨è¿‡ç¨‹æƒ³è±¡æˆä¸€ä¸ªæ¥åŠ›èµ›ï¼š</p><ol><li><strong>ç¬¬ä¸€æ£’ï¼šBIOS&#x2F;UEFI å›ºä»¶</strong>ï¼šæŒ‰ä¸‹ç”µæºåï¼Œä¸»æ¿ä¸Šçš„å›ºä»¶ç¨‹åºé¦–å…ˆè¢«æ¿€æ´»ã€‚å®ƒä¼šè¿›è¡Œç¡¬ä»¶è‡ªæ£€ï¼ˆPOSTï¼‰ï¼Œç„¶åæ ¹æ®é¢„è®¾çš„å¯åŠ¨é¡ºåºï¼Œå¯»æ‰¾ä¸‹ä¸€ä¸ªâ€œæ¥åŠ›è€…â€â€”â€”å¼•å¯¼åŠ è½½ç¨‹åºã€‚</li><li>**ç¬¬äºŒæ£’ï¼šå¼•å¯¼åŠ è½½ç¨‹åº (Bootloader)**ï¼šå›ºä»¶å°†æ§åˆ¶æƒäº¤ç»™å­˜å‚¨è®¾å¤‡ä¸Šçš„å¼•å¯¼åŠ è½½ç¨‹åºï¼ˆå¦‚ GRUBï¼‰ã€‚å®ƒçš„ä»»åŠ¡æ˜¯æ‰¾åˆ°æ“ä½œç³»ç»Ÿçš„å†…æ ¸æ–‡ä»¶ï¼Œå¹¶å°†å…¶åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</li><li>**ç¬¬ä¸‰æ£’ï¼šæ“ä½œç³»ç»Ÿå†…æ ¸ (Kernel)**ï¼šå†…æ ¸è¢«åŠ è½½åï¼Œå¼€å§‹æ¥ç®¡è®¡ç®—æœºã€‚å®ƒä¼šåˆå§‹åŒ–æ‰€æœ‰æ ¸å¿ƒç»„ä»¶ï¼ˆå¦‚è¿›ç¨‹ç®¡ç†ã€å†…å­˜ç®¡ç†ï¼‰ï¼Œå¹¶åŠ è½½é©±åŠ¨ç¨‹åºæ¥ç®¡ç†ç¡¬ä»¶ã€‚æœ€ç»ˆï¼Œå®ƒä¼šå¯åŠ¨ç”¨æˆ·ç©ºé—´çš„ç¨‹åºï¼Œå®Œæˆæ•´ä¸ªç³»ç»Ÿçš„å¯åŠ¨ã€‚</li></ol><h3 id="3-2-ä¸åŒ-Hypervisor-çš„â€œç™»åœºâ€æ–¹å¼"><a href="#3-2-ä¸åŒ-Hypervisor-çš„â€œç™»åœºâ€æ–¹å¼" class="headerlink" title="3.2 ä¸åŒ Hypervisor çš„â€œç™»åœºâ€æ–¹å¼"></a>3.2 ä¸åŒ Hypervisor çš„â€œç™»åœºâ€æ–¹å¼</h3><p>ä¸åŒç±»å‹çš„ Hypervisor åœ¨è¿™ä¸ªâ€œæ¥åŠ›èµ›â€ä¸­ç™»åœºçš„æ—¶æœºå„ä¸ç›¸åŒã€‚</p><ul><li><p><strong>Type 1 (KVM - é›†æˆå‹)</strong>:<br>KVM å¹¶ä¸æ˜¯ä¸€ä¸ªç‹¬ç«‹äºå†…æ ¸çš„è½¯ä»¶ã€‚å®ƒæœ¬èº«å°±æ˜¯ Linux å†…æ ¸çš„ä¸€éƒ¨åˆ†ã€‚å½“ Linux å†…æ ¸åœ¨ç¬¬ä¸‰æ£’å¯åŠ¨æ—¶ï¼Œå®ƒä¼šåŠ è½½ <code>kvm.ko</code> ç­‰å†…æ ¸æ¨¡å—ã€‚ä¸€æ—¦æ¨¡å—åŠ è½½ï¼Œå†…æ ¸è‡ªèº«å°±è¢«èµ‹äºˆäº† Hypervisor çš„èƒ½åŠ›ã€‚å› æ­¤ï¼Œ<strong>å¯åŠ¨ Linux å†…æ ¸çš„è¿‡ç¨‹ï¼Œæœ¬èº«å°±åœ¨å¯åŠ¨ KVM è¿™ä¸ª Hypervisor</strong>ã€‚</p></li><li><p><strong>Type 1 (ESXi - ç‹¬ç«‹å‹)</strong>:<br>è¿™ç±» Hypervisor æœ¬èº«å°±æ˜¯ä¸€ä¸ªç²¾ç®€çš„ã€ä¸“ç”¨çš„æ“ä½œç³»ç»Ÿã€‚åœ¨æ¥åŠ›èµ›çš„ç¬¬äºŒæ£’ï¼Œå¼•å¯¼åŠ è½½ç¨‹åºåŠ è½½çš„<strong>ä¸æ˜¯é€šç”¨å†…æ ¸ï¼Œè€Œæ˜¯ ESXi è‡ªå·±çš„å†…æ ¸</strong>ã€‚å¯åŠ¨åï¼Œç‰©ç†æœºå°±ç›´æ¥æˆä¸ºä¸€å°ä¸“ç”¨çš„è™šæ‹ŸåŒ–ä¸»æœºã€‚</p></li><li><p><strong>Type 2 (VirtualBox - å®¿ä¸»å‹)</strong>:<br>è¿™ç§ Hypervisor çš„å¯åŠ¨æœ€ç®€å•ã€‚å®ƒå®Œå…¨é”™å¼€äº†ç³»ç»Ÿå¯åŠ¨æµç¨‹ã€‚ç”¨æˆ·å…ˆæ­£å¸¸å¯åŠ¨ä¸€ä¸ªå®Œæ•´çš„å®¿ä¸»æ“ä½œç³»ç»Ÿï¼ˆå¦‚ Windows æˆ– macOSï¼‰ï¼Œç„¶ååƒæ‰“å¼€æ™®é€šè½¯ä»¶ä¸€æ ·ï¼Œ<strong>é€šè¿‡åŒå‡»å›¾æ ‡æ¥è¿è¡Œ VirtualBox ç¨‹åº</strong>ã€‚</p></li></ul><p><strong>KVM Hypervisor å¯åŠ¨æµç¨‹å›¾</strong>:</p><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD;    A[&quot;1. æŒ‰ä¸‹ç”µæºæŒ‰é’®&quot;] --&gt; B[&quot;2. ä¸»æ¿å›ºä»¶å¯åŠ¨ (BIOS&#x2F;UEFI)&quot;];    B -- &quot;ç¡¬ä»¶è‡ªæ£€, å¯»æ‰¾å¯åŠ¨è®¾å¤‡&quot; --&gt; C[&quot;3. å¼•å¯¼åŠ è½½ç¨‹åº (GRUB)&quot;];    C -- &quot;åŠ è½½å†…æ ¸åˆ°å†…å­˜&quot; --&gt; D[&quot;4. Linux å†…æ ¸å¯åŠ¨åˆå§‹åŒ–&quot;];    D -- &quot;åŠ è½½æ¨¡å—&quot; --&gt; E[&quot;5. åŠ è½½KVMæ¨¡å— (kvm.ko)&quot;];    E --&gt; F[&quot;&lt;b&gt;Linuxå†…æ ¸æ­¤æ—¶å·²æˆä¸ºType 1 Hypervisor&lt;&#x2F;b&gt;&quot;];    F -- &quot;å¯åŠ¨ç”¨æˆ·æœåŠ¡&quot; --&gt; G[&quot;6. ç³»ç»Ÿå®Œå…¨å¯åŠ¨, ç­‰å¾…æŒ‡ä»¤&quot;];    G --&gt; H[&quot;7. ç”¨æˆ·é€šè¿‡QEMUç­‰å·¥å…·&lt;br&gt;è¯·æ±‚åˆ›å»ºè™šæ‹Ÿæœº&quot;];    F -- &quot;æ‰§è¡Œè™šæ‹ŸåŒ–æ“ä½œ&quot; --&gt; H;  </pre></div><h3 id="3-3-ä»ä¼ ç»Ÿè™šæ‹ŸåŒ–åˆ°æœºå¯†è®¡ç®—ï¼šHyperEnclave-çš„åˆ›æ–°"><a href="#3-3-ä»ä¼ ç»Ÿè™šæ‹ŸåŒ–åˆ°æœºå¯†è®¡ç®—ï¼šHyperEnclave-çš„åˆ›æ–°" class="headerlink" title="3.3 ä»ä¼ ç»Ÿè™šæ‹ŸåŒ–åˆ°æœºå¯†è®¡ç®—ï¼šHyperEnclave çš„åˆ›æ–°"></a>3.3 ä»ä¼ ç»Ÿè™šæ‹ŸåŒ–åˆ°æœºå¯†è®¡ç®—ï¼šHyperEnclave çš„åˆ›æ–°</h3><p>åœ¨äº†è§£äº†ä¼ ç»Ÿ Hypervisor çš„å¯åŠ¨æœºåˆ¶åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªæ›´åŠ å‰æ²¿çš„åº”ç”¨åœºæ™¯ã€‚éšç€äº‘è®¡ç®—å’Œè¾¹ç¼˜è®¡ç®—çš„æ™®åŠï¼Œ<strong>æ•°æ®å®‰å…¨</strong>å’Œ<strong>éšç§ä¿æŠ¤</strong>æˆä¸ºäº†è¶Šæ¥è¶Šé‡è¦çš„éœ€æ±‚ã€‚ä¼ ç»Ÿçš„è™šæ‹ŸåŒ–æŠ€æœ¯è™½ç„¶æä¾›äº†èµ„æºéš”ç¦»ï¼Œä½†åœ¨é¢å¯¹æ¶æ„ Hypervisor æˆ–æ“ä½œç³»ç»Ÿæ”»å‡»æ—¶ï¼Œä»ç„¶å­˜åœ¨å®‰å…¨é£é™©ã€‚</p><p>æ­£æ˜¯åœ¨è¿™æ ·çš„èƒŒæ™¯ä¸‹ï¼Œ<strong>æœºå¯†è®¡ç®— (Confidential Computing)</strong> æŠ€æœ¯åº”è¿è€Œç”Ÿã€‚å®ƒé€šè¿‡ç¡¬ä»¶çº§çš„å®‰å…¨éš”ç¦»ï¼Œç¡®ä¿å³ä½¿åº•å±‚ç³»ç»Ÿè¢«æ”»ç ´ï¼Œæ•æ„Ÿæ•°æ®ä¹Ÿèƒ½å¾—åˆ°ä¿æŠ¤ã€‚è€Œ HyperEnclave ä½œä¸ºè¿™ä¸€é¢†åŸŸçš„åˆ›æ–°è€…ï¼Œå±•ç¤ºäº†å¦‚ä½•å°†ä¼ ç»Ÿçš„ Hypervisor æŠ€æœ¯ä¸ç°ä»£å®‰å…¨éœ€æ±‚ç›¸ç»“åˆã€‚</p><h4 id="æœºå¯†è®¡ç®—çš„æŠ€æœ¯æ¼”è¿›"><a href="#æœºå¯†è®¡ç®—çš„æŠ€æœ¯æ¼”è¿›" class="headerlink" title="æœºå¯†è®¡ç®—çš„æŠ€æœ¯æ¼”è¿›"></a>æœºå¯†è®¡ç®—çš„æŠ€æœ¯æ¼”è¿›</h4><p>æœºå¯†è®¡ç®—æŠ€æœ¯ç»å†äº†ä»<strong>åº”ç”¨çº§éš”ç¦»</strong>åˆ°<strong>è™šæ‹Ÿæœºçº§éš”ç¦»</strong>çš„æ¼”è¿›è¿‡ç¨‹ï¼š</p><p><strong>ç¬¬ä¸€ä»£ï¼šåº”ç”¨çº§ Enclave</strong><br>ä»¥ <strong>Intel SGX</strong> ä¸ºä»£è¡¨ï¼Œåœ¨è¿è¡Œçš„åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­ï¼Œé€šè¿‡ç¡¬ä»¶æŠ€æœ¯éš”ç¦»å‡ºä¸€å—åŠ å¯†çš„å†…å­˜â€å®‰å…¨åŒºâ€ï¼ˆEnclaveï¼‰ï¼Œç”¨äºä¿æŠ¤æ ¸å¿ƒä»£ç å’Œæ•°æ®ã€‚å®ƒéš”ç¦»çš„æ˜¯<strong>è¿›ç¨‹çš„ä¸€éƒ¨åˆ†</strong>ã€‚</p><p><strong>ç¬¬äºŒä»£ï¼šè™šæ‹Ÿæœºçº§ Enclave</strong><br>ä»¥ <strong>Intel TDX</strong> &#x2F; <strong>AMD SEV</strong> å’Œ <strong>HyperEnclave</strong> ä¸ºä»£è¡¨ï¼Œå°†éš”ç¦»çš„å•ä½æå‡åˆ°äº†æ•´ä¸ªè™šæ‹Ÿæœºã€‚å®ƒä¿æŠ¤çš„æ˜¯<strong>ä¸€ä¸ªå®Œæ•´çš„è™šæ‹Ÿæœº</strong>ï¼Œä½¿å…¶èƒ½å¤ŸæŠµæŠ—æ¥è‡ªå®¿ä¸» Hypervisor æˆ–æ“ä½œç³»ç»Ÿçš„æ”»å‡»ã€‚</p><p><strong>æŠ€æœ¯å¯¹æ¯”</strong>:</p><ul><li><strong>Intel SGX</strong>: ç¡¬ä»¶çº§å¯ä¿¡æ‰§è¡Œç¯å¢ƒï¼Œç›´æ¥åœ¨ CPU ä¸­å®ç°å†…å­˜åŠ å¯†å’Œéš”ç¦»</li><li><strong>Intel TDX</strong>: åŸºäº VMX ç¡¬ä»¶è™šæ‹ŸåŒ–çš„æœºå¯†è®¡ç®—ï¼Œå°†æ•´ä¸ªè™šæ‹Ÿæœºä½œä¸ºå¯ä¿¡æ‰§è¡Œç¯å¢ƒ</li><li><strong>AMD SEV</strong>: åŸºäº SVM ç¡¬ä»¶è™šæ‹ŸåŒ–çš„æœºå¯†è®¡ç®—ï¼Œé€šè¿‡å†…å­˜åŠ å¯†ä¿æŠ¤è™šæ‹Ÿæœº</li><li><strong>HyperEnclave</strong>: è½¯ä»¶å®ç°çš„ SGX å…¼å®¹å±‚ï¼Œé€šè¿‡è™šæ‹ŸåŒ–æŠ€æœ¯æ¨¡æ‹Ÿ SGX åŠŸèƒ½ï¼Œæ”¯æŒå¤šç§ CPU å¹³å°</li></ul><h4 id="HyperEnclave-çš„çœŸå®æœºåˆ¶ï¼šä¸€ä¸ªåŠ¨æ€åŠ è½½çš„ç‹¬ç«‹-Hypervisor"><a href="#HyperEnclave-çš„çœŸå®æœºåˆ¶ï¼šä¸€ä¸ªåŠ¨æ€åŠ è½½çš„ç‹¬ç«‹-Hypervisor" class="headerlink" title="HyperEnclave çš„çœŸå®æœºåˆ¶ï¼šä¸€ä¸ªåŠ¨æ€åŠ è½½çš„ç‹¬ç«‹ Hypervisor"></a>HyperEnclave çš„çœŸå®æœºåˆ¶ï¼šä¸€ä¸ªåŠ¨æ€åŠ è½½çš„ç‹¬ç«‹ Hypervisor</h4><p><strong>HyperEnclave çš„å®ç°ä¸ä¾èµ– KVMï¼Œå®ƒæœ¬èº«å°±æ˜¯ä¸€ä¸ªç”¨ Rust ç¼–å†™çš„ã€å®Œæ•´çš„ã€ç‹¬ç«‹çš„ Type 1 Hypervisorã€‚</strong></p><p>å®ƒåˆ›é€ æ€§åœ°ä½¿ç”¨äº†ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ Linux ç³»ç»Ÿä½œä¸ºâ€è·³æ¿â€æ¥å¯åŠ¨è‡ªå·±ï¼Œä¸€æ—¦è¿è¡Œï¼Œå®ƒå°±å®Œå…¨æ¥ç®¡ç¡¬ä»¶è™šæ‹ŸåŒ–çš„æ§åˆ¶æƒã€‚</p><p>å…¶ç²¾ç¡®çš„å¯åŠ¨å’Œå·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š</p><h3 id="1-åŠ è½½ä¸è·³è½¬"><a href="#1-åŠ è½½ä¸è·³è½¬" class="headerlink" title="1. åŠ è½½ä¸è·³è½¬"></a>1. <strong>åŠ è½½ä¸è·³è½¬</strong></h3><p>ç”¨æˆ·é€šè¿‡ä¸€ä¸ªç‰¹åˆ¶çš„ Linux å†…æ ¸é©±åŠ¨ï¼ˆ<code>hyper_enclave.ko</code>ï¼‰æ¥åŠ è½½ HyperEnclave çš„äºŒè¿›åˆ¶ç¨‹åºã€‚è¯¥é©±åŠ¨éšåä¼šåœ¨æ‰€æœ‰åœ¨çº¿çš„ CPU æ ¸å¿ƒä¸Šï¼Œæ‰§è¡ŒæŒ‡ä»¤è·³è½¬åˆ° HyperEnclave çš„å…¥å£ç‚¹ <code>entry()</code>ï¼Œä»è€Œå°† CPU çš„<strong>å®Œå…¨æ§åˆ¶æƒ</strong>äº¤ç»™ HyperEnclaveã€‚</p><h3 id="2-ä¿å­˜ä¸æ¥ç®¡"><a href="#2-ä¿å­˜ä¸æ¥ç®¡" class="headerlink" title="2. ä¿å­˜ä¸æ¥ç®¡"></a>2. <strong>ä¿å­˜ä¸æ¥ç®¡</strong></h3><p>HyperEnclave æ¥ç®¡ CPU åï¼Œç¬¬ä¸€ä»¶äº‹æ˜¯ä¿å­˜å¥½ Linux å†…æ ¸çš„å®Œæ•´æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆå¯„å­˜å™¨çŠ¶æ€ã€æ ˆæŒ‡é’ˆ <code>linux_sp</code> ç­‰ï¼‰ï¼Œè¿™æ˜¯ä¸ºäº†ç¡®ä¿å°†æ¥å¯ä»¥å®‰å…¨åœ°é€€å‡ºå¹¶è¿”å›åˆ° Linuxã€‚</p><h3 id="3-ç‹¬ç«‹åˆå§‹åŒ–"><a href="#3-ç‹¬ç«‹åˆå§‹åŒ–" class="headerlink" title="3. ç‹¬ç«‹åˆå§‹åŒ–"></a>3. <strong>ç‹¬ç«‹åˆå§‹åŒ–</strong></h3><p>æ¥ä¸‹æ¥ï¼ŒHyperEnclave ä½œä¸º<strong>ä¸€ä¸ªå…¨æ–°çš„ Hypervisor</strong> å¼€å§‹è¿›è¡Œå½»åº•çš„åˆå§‹åŒ–ã€‚å®ƒä¸ä¾èµ– Linux çš„ä»»ä½•æœåŠ¡ï¼Œè€Œæ˜¯å»ºç«‹è‡ªå·±çš„å†…å­˜ç®¡ç†ã€é¡µè¡¨ã€ä¸­æ–­æè¿°ç¬¦è¡¨ï¼ˆIDTï¼‰ï¼Œå¹¶ä¸ºå³å°†è¿è¡Œçš„æœºå¯†è™šæ‹Ÿæœºé…ç½®è™šæ‹Ÿæœºæ§åˆ¶ç»“æ„ï¼ˆVMCS&#x2F;VMCBï¼‰ã€‚</p><h3 id="4-å¯åŠ¨æœºå¯†VM"><a href="#4-å¯åŠ¨æœºå¯†VM" class="headerlink" title="4. å¯åŠ¨æœºå¯†VM"></a>4. <strong>å¯åŠ¨æœºå¯†VM</strong></h3><p>æ‰€æœ‰åˆå§‹åŒ–å®Œæˆåï¼ŒHyperEnclave æ ¹æ® CPU æ¶æ„æ‰§è¡Œç›¸åº”çš„è™šæ‹ŸåŒ–æŒ‡ä»¤ï¼š</p><ul><li><strong>Intel å¹³å°</strong>: æ‰§è¡Œ <code>vmlaunch</code> æŒ‡ä»¤å¯åŠ¨è™šæ‹Ÿæœº</li><li><strong>AMD å¹³å°</strong>: æ‰§è¡Œ <code>vmrun</code> æŒ‡ä»¤å¯åŠ¨è™šæ‹Ÿæœº</li></ul><p>ä»æ­¤åˆ»èµ·ï¼Œæ‰€æœ‰è™šæ‹ŸåŒ–ç›¸å…³çš„ <code>VM-Exit</code> äº‹ä»¶éƒ½ç”± HyperEnclave è‡ªè¡Œå¤„ç†ï¼Œä¸ Linux å†…æ ¸æˆ– KVM æ¯«æ— å…³ç³»ã€‚</p><p><strong>æ€»ç»“</strong>ï¼šHyperEnclave å’Œ KVM æ˜¯<strong>å¹³çº§çš„ã€äºŒé€‰ä¸€</strong>çš„ Hypervisorã€‚HyperEnclave åªæ˜¯åˆ©ç”¨ Linux å†…æ ¸é©±åŠ¨å®Œæˆäº†ä¸€æ¬¡â€çƒ­éƒ¨ç½²â€ï¼Œå®ç°äº†ä»ä¸€ä¸ªé€šç”¨æ“ä½œç³»ç»Ÿåˆ°ä¸“ç”¨ Hypervisor çš„â€å˜èº«â€ã€‚</p><p><strong>HyperEnclave å¯åŠ¨æµç¨‹å›¾</strong>:</p><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    subgraph &quot;Linux ç³»ç»Ÿ&quot;        App[&quot;ç”¨æˆ·åº”ç”¨ç¨‹åº&quot;] -- &quot;ioctl() ç³»ç»Ÿè°ƒç”¨&quot; --&gt; Driver[&quot;HyperEnclave å†…æ ¸é©±åŠ¨&quot;]        Driver -- &quot;1. åŠ è½½ HyperEnclave äºŒè¿›åˆ¶æ–‡ä»¶åˆ°å†…å­˜&quot; --&gt; H_Bin[&quot;HyperEnclave ä»£ç &quot;]        Driver -- &quot;2. åœ¨æ¯ä¸ªCPUä¸Šè·³è½¬åˆ° entry() å‡½æ•°&quot; --&gt; H_Bin    end    subgraph &quot;ç¡¬ä»¶æ§åˆ¶å±‚ (HyperEnclave æ¥ç®¡)&quot;        H_Bin -- &quot;3. ä¿å­˜ Linux çŠ¶æ€å¹¶å®Œå…¨æ¥ç®¡ CPU&quot; --&gt; CPU[&quot;CPU ç¡¬ä»¶ (VMX&#x2F;SVM)&quot;]        H_Bin -- &quot;4. ä½œä¸º Hypervisor è‡ªæˆ‘åˆå§‹åŒ– (å†…å­˜, VMCS&#x2F;VMCB ç­‰)&quot; --&gt; CPU        H_Bin -- &quot;5. æ‰§è¡Œ &#39;vmlaunch&#39;(Intel) æˆ– &#39;vmrun&#39;(AMD) å¯åŠ¨æœºå¯†è™šæ‹Ÿæœº&quot; --&gt; GuestVM[&quot;æœºå¯†å®¢æˆ·è™šæ‹Ÿæœº&quot;]    end    GuestVM -- &quot;è™šæ‹Ÿæœºé€€å‡º (ä¾‹å¦‚ I&#x2F;O)&quot; --&gt; H_Bin    H_Bin -- &quot;å¤„ç†é€€å‡ºå¹¶æ¢å¤è™šæ‹Ÿæœº&quot; --&gt; GuestVM    style H_Bin fill:#d4edda,stroke:#155724,stroke-width:2px  </pre></div><h2 id="4-å†…éƒ¨æ ¸å¿ƒåŸç†ä¸æœºåˆ¶"><a href="#4-å†…éƒ¨æ ¸å¿ƒåŸç†ä¸æœºåˆ¶" class="headerlink" title="4. å†…éƒ¨æ ¸å¿ƒåŸç†ä¸æœºåˆ¶"></a>4. å†…éƒ¨æ ¸å¿ƒåŸç†ä¸æœºåˆ¶</h2><p>Hypervisor çš„é­”åŠ›åœ¨äºå®ƒå¦‚ä½•å·§å¦™åœ°â€œæ¬ºéª—â€å®¢æˆ·æœºæ“ä½œç³»ç»Ÿï¼Œè®©å…¶ç›¸ä¿¡è‡ªå·±æ‹¥æœ‰ç¡¬ä»¶ã€‚è¿™ä¸»è¦é€šè¿‡è™šæ‹ŸåŒ– CPUã€å†…å­˜å’Œ I&#x2F;O è®¾å¤‡æ¥å®ç°ã€‚</p><h3 id="CPU-è™šæ‹ŸåŒ–"><a href="#CPU-è™šæ‹ŸåŒ–" class="headerlink" title="CPU è™šæ‹ŸåŒ–"></a>CPU è™šæ‹ŸåŒ–</h3><p>CPU è™šæ‹ŸåŒ–æ˜¯æ ¸å¿ƒã€‚ç°ä»£ CPU æœ‰ä¸åŒçš„ç‰¹æƒçº§ï¼ˆå¦‚ x86 æ¶æ„çš„ Ring 0-3ï¼‰ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸è¿è¡Œåœ¨æœ€é«˜ç‰¹æƒçº§ Ring 0ï¼Œè€Œåº”ç”¨ç¨‹åºåœ¨ Ring 3ã€‚é—®é¢˜æ˜¯ï¼Œå®¢æˆ·æœºæ“ä½œç³»ç»Ÿä¹Ÿè®¤ä¸ºè‡ªå·±åº”è¯¥åœ¨ Ring 0 è¿è¡Œï¼Œä½†ç‰©ç† CPU çš„ Ring 0 å·²ç»è¢« Hypervisor å ç”¨äº†ã€‚</p><p>æ—©æœŸçš„è§£å†³æ–¹æ¡ˆæ˜¯**äºŒè¿›åˆ¶ç¿»è¯‘ (Binary Translation)**ï¼ŒHypervisor åŠ¨æ€åœ°ç¿»è¯‘å®¢æˆ·æœºæ“ä½œç³»ç»Ÿçš„æ•æ„ŸæŒ‡ä»¤ã€‚ä½†è¿™ç§æ–¹å¼æ•ˆç‡ä½ä¸‹ã€‚</p><p>ç°ä»£çš„è§£å†³æ–¹æ¡ˆæ˜¯**ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ– (Hardware-assisted Virtualization)**ï¼Œå³ Intel çš„ <strong>VT-x</strong> å’Œ AMD çš„ <strong>AMD-V</strong> æŠ€æœ¯ã€‚</p><ul><li><strong>æ ¸å¿ƒæ€æƒ³</strong>: å¼•å…¥äº†ä¸€ç§æ–°çš„æ“ä½œæ¨¡å¼ï¼Œç§°ä¸ºâ€œæ ¹æ¨¡å¼ (Root Operation)â€å’Œâ€œéæ ¹æ¨¡å¼ (Non-root Operation)â€ã€‚</li><li><strong>Hypervisor</strong> è¿è¡Œåœ¨æ ¹æ¨¡å¼ä¸‹ï¼Œæ‹¥æœ‰æœ€é«˜æƒé™ã€‚</li><li><strong>è™šæ‹Ÿæœº</strong> è¿è¡Œåœ¨éæ ¹æ¨¡å¼ä¸‹ï¼Œå³ä½¿åœ¨ Ring 0ï¼Œå…¶æƒé™ä¹Ÿå— Hypervisor é™åˆ¶ã€‚</li><li>å½“å®¢æˆ·æœºæ“ä½œç³»ç»Ÿæ‰§è¡Œæ•æ„ŸæŒ‡ä»¤æ—¶ï¼ŒCPU ä¼šè‡ªåŠ¨è§¦å‘ä¸€æ¬¡<strong>VM Exit</strong>ï¼Œå°†æ§åˆ¶æƒäº¤è¿˜ç»™æ ¹æ¨¡å¼ä¸‹çš„ Hypervisorã€‚</li><li>Hypervisor å¤„ç†å®Œæ•æ„Ÿæ“ä½œåï¼Œå†æ‰§è¡Œ <strong>VM Entry</strong>ï¼Œå°†æ§åˆ¶æƒè¿”è¿˜ç»™è™šæ‹Ÿæœºã€‚</li></ul><p>è¿™ä¸ªè¿‡ç¨‹è™½ç„¶æœ‰åˆ‡æ¢å¼€é”€ï¼Œä½†è¿œæ¯”è½¯ä»¶æ¨¡æ‹Ÿé«˜æ•ˆå’Œç®€å•ã€‚</p><h3 id="å†…å­˜è™šæ‹ŸåŒ–"><a href="#å†…å­˜è™šæ‹ŸåŒ–" class="headerlink" title="å†…å­˜è™šæ‹ŸåŒ–"></a>å†…å­˜è™šæ‹ŸåŒ–</h3><p>å®¢æˆ·æœºæ“ä½œç³»ç»Ÿç®¡ç†çš„æ˜¯<strong>å®¢æˆ·æœºç‰©ç†åœ°å€ (Guest Physical Address, GPA)<strong>ï¼Œä½† Hypervisor éœ€è¦å°†å…¶æ˜ å°„åˆ°çœŸæ­£çš„</strong>ä¸»æœºç‰©ç†åœ°å€ (Host Physical Address, HPA)</strong> ä¸Šã€‚</p><ul><li><p><strong>ä¼ ç»Ÿæ–¹æ³•ï¼šå½±å­é¡µè¡¨ (Shadow Page Tables)</strong>: Hypervisor ä¸ºæ¯ä¸ªè™šæ‹Ÿæœºç»´æŠ¤ä¸€å¥—â€œå½±å­é¡µè¡¨â€ï¼Œè¿™å¥—é¡µè¡¨ç›´æ¥å°†å®¢æˆ·æœºçš„è™šæ‹Ÿåœ°å€ (GVA) æ˜ å°„åˆ°ä¸»æœºç‰©ç†åœ°å€ (HPA)ã€‚å½“å®¢æˆ·æœºä¿®æ”¹è‡ªå·±çš„é¡µè¡¨æ—¶ï¼ŒHypervisor ä¼šæ•è·è¯¥æ“ä½œå¹¶åŒæ­¥æ›´æ–°å½±å­é¡µè¡¨ï¼Œå¼€é”€å¾ˆå¤§ã€‚</p></li><li><p><strong>ç¡¬ä»¶è¾…åŠ©æ–¹æ³•ï¼šäºŒçº§åœ°å€ç¿»è¯‘ (Second Level Address Translation, SLAT)</strong>: Intel çš„ <strong>EPT (Extended Page Tables)</strong> å’Œ AMD çš„ <strong>NPT (Nested Page Tables)</strong> æŠ€æœ¯ã€‚</p><ul><li>CPU çš„å†…å­˜ç®¡ç†å•å…ƒ (MMU) ç¡¬ä»¶æœ¬èº«æ”¯æŒä¸¤çº§é¡µè¡¨ã€‚</li><li>ç¬¬ä¸€çº§ç”±å®¢æˆ·æœºæ“ä½œç³»ç»Ÿç®¡ç†ï¼ˆGVA -&gt; GPAï¼‰ã€‚</li><li>ç¬¬äºŒçº§ç”± Hypervisor ç®¡ç†ï¼ˆGPA -&gt; HPAï¼‰ã€‚</li><li>åœ°å€ç¿»è¯‘å®Œå…¨ç”±ç¡¬ä»¶å®Œæˆï¼ŒHypervisor åªéœ€ç»´æŠ¤å¥½ç¬¬äºŒçº§é¡µè¡¨å³å¯ï¼Œæå¤§æå‡äº†å†…å­˜è™šæ‹ŸåŒ–æ€§èƒ½ã€‚</li></ul></li></ul><p><strong>å†…å­˜ç¿»è¯‘æµç¨‹å›¾</strong>:</p><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph LR;    subgraph &quot;å®¢æˆ·æœºæ“ä½œç³»ç»Ÿ&quot;        GVA[&quot;å®¢æˆ·æœºè™šæ‹Ÿåœ°å€ (GVA)&quot;]        GPA[&quot;å®¢æˆ·æœºç‰©ç†åœ°å€ (GPA)&quot;]        GVA -- &quot;å®¢æˆ·æœºé¡µè¡¨&quot; --&gt; GPA;    end    subgraph &quot;Hypervisor&quot;        HPA[&quot;ä¸»æœºç‰©ç†åœ°å€ (HPA)&quot;]        GPA -- &quot;äºŒçº§åœ°å€ç¿»è¯‘ (EPT&#x2F;NPT)&quot; --&gt; HPA;    end        subgraph &quot;ç¡¬ä»¶&quot;        MMU[&quot;CPU å†…å­˜ç®¡ç†å•å…ƒ&quot;]    end    HPA -- &quot;è®¿é—®&quot; --&gt; MMU;  </pre></div><h3 id="I-O-è™šæ‹ŸåŒ–"><a href="#I-O-è™šæ‹ŸåŒ–" class="headerlink" title="I&#x2F;O è™šæ‹ŸåŒ–"></a>I&#x2F;O è™šæ‹ŸåŒ–</h3><p>I&#x2F;O è™šæ‹ŸåŒ–æ˜¯æœ€å¤æ‚çš„ï¼Œå› ä¸ºå®ƒæ¶‰åŠç§ç±»ç¹å¤šçš„å¤–éƒ¨è®¾å¤‡ã€‚ä¸»è¦æœ‰ä¸‰ç§æ–¹å¼ï¼š</p><ol><li><p><strong>å…¨æ¨¡æ‹Ÿ (Full Emulation)</strong>:</p><ul><li>Hypervisor æ¨¡æ‹Ÿä¸€ä¸ªçœŸå®çš„ã€å…·ä½“çš„ç¡¬ä»¶è®¾å¤‡ï¼Œä¾‹å¦‚ä¸€ä¸ª Intel E1000 ç½‘å¡æˆ–ä¸€ä¸ª IDE æ§åˆ¶å™¨ã€‚</li><li><strong>ä¼˜ç‚¹</strong>: å®¢æˆ·æœºæ“ä½œç³»ç»Ÿæ— éœ€ä»»ä½•ç‰¹æ®Šé©±åŠ¨ï¼Œå…¼å®¹æ€§å¥½ã€‚</li><li><strong>ç¼ºç‚¹</strong>: æ•ˆç‡æä½ã€‚æ¯ä¸€æ¬¡ I&#x2F;O æ“ä½œéƒ½éœ€è¦ Hypervisor ä»‹å…¥ã€ç¿»è¯‘å’Œæ¨¡æ‹Ÿï¼ŒCPU å¼€é”€å·¨å¤§ã€‚QEMU ç»å¸¸ç”¨äºæ­¤ç›®çš„ã€‚</li></ul></li><li><p><strong>åŠè™šæ‹ŸåŒ– (Paravirtualization, PV)</strong>:</p><ul><li>è¿™æ˜¯ä¸€ç§åä½œæ¨¡å¼ã€‚å®¢æˆ·æœºæ“ä½œç³»ç»Ÿâ€œçŸ¥é“â€è‡ªå·±è¿è¡Œåœ¨è™šæ‹Ÿç¯å¢ƒä¸­ï¼Œå¹¶å®‰è£…ä¸“é—¨çš„â€œåŠè™šæ‹ŸåŒ–é©±åŠ¨â€ã€‚</li><li>Hypervisor ä¹Ÿæä¾›ä¸€ä¸ªé«˜æ•ˆçš„åç«¯é©±åŠ¨ã€‚ä¸¤è€…é€šè¿‡ä¸€ä¸ªä¼˜åŒ–çš„é€šä¿¡æ¥å£ï¼ˆå¦‚å…±äº«å†…å­˜ç¯å½¢ç¼“å†²åŒºï¼‰ç›´æ¥äº¤æ¢æ•°æ®ã€‚</li><li><strong>VirtIO</strong> å°±æ˜¯ä¸€ä¸ªæ ‡å‡†çš„åŠè™šæ‹ŸåŒ–æ¥å£è§„èŒƒã€‚</li><li><strong>ä¼˜ç‚¹</strong>: æ€§èƒ½è¿œé«˜äºå…¨æ¨¡æ‹Ÿï¼Œæ¥è¿‘åŸç”Ÿæ€§èƒ½ã€‚</li><li><strong>ç¼ºç‚¹</strong>: éœ€è¦åœ¨å®¢æˆ·æœºä¸­å®‰è£…ç‰¹å®šé©±åŠ¨ã€‚</li></ul></li><li><p><strong>è®¾å¤‡ç›´é€š (Passthrough)</strong>:</p><ul><li>åˆ©ç”¨ <strong>Intel VT-d</strong> æˆ– <strong>AMD-Vi (IOMMU)</strong> æŠ€æœ¯ï¼Œå°†ä¸€ä¸ªç‰©ç† PCI è®¾å¤‡ï¼ˆå¦‚ç½‘å¡ã€GPUï¼‰ç›´æ¥åˆ†é…ç»™ä¸€ä¸ªè™šæ‹Ÿæœºã€‚</li><li>è¯¥è™šæ‹Ÿæœºå¯ä»¥åƒåœ¨ç‰©ç†æœºä¸Šä¸€æ ·ç›´æ¥æ“ä½œè¿™ä¸ªç¡¬ä»¶ï¼Œæ— éœ€ Hypervisor ä»‹å…¥ I&#x2F;O è¿‡ç¨‹ã€‚</li><li><strong>ä¼˜ç‚¹</strong>: èƒ½å¤Ÿè¾¾åˆ°å‡ ä¹ 100% çš„åŸç”Ÿæ€§èƒ½ï¼Œé€‚ç”¨äºé«˜æ€§èƒ½è®¡ç®—ã€NFV ç­‰åœºæ™¯ã€‚</li><li><strong>ç¼ºç‚¹</strong>: è¯¥è®¾å¤‡æ— æ³•è¢«å…¶ä»–è™šæ‹Ÿæœºå…±äº«ã€‚</li></ul></li></ol><p><strong>I&#x2F;O è™šæ‹ŸåŒ–æ–¹æ¡ˆå¯¹æ¯”å›¾</strong>:</p><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD;    subgraph &quot;å®¢æˆ·æœºæ“ä½œç³»ç»Ÿ&quot;      Request[&quot;I&#x2F;O è¯·æ±‚&quot;]    end        subgraph &quot;Hypervisor&quot;      Hypervisor_Layer[&quot;Hypervisor å±‚&quot;]    end        subgraph &quot;ç¡¬ä»¶&quot;      PhysicalDevice[&quot;ç‰©ç†è®¾å¤‡&quot;]    end        Request --&gt; Hypervisor_Layer;        subgraph &quot;è™šæ‹ŸåŒ–æ–¹æ³•&quot;      Emulation[&quot;å…¨æ¨¡æ‹Ÿ&quot;]      Paravirt[&quot;åŠè™šæ‹ŸåŒ– (VirtIO)&quot;]      Passthrough[&quot;è®¾å¤‡ç›´é€š (VT-d&#x2F;IOMMU)&quot;]    end    Hypervisor_Layer --&gt; Emulation;    Hypervisor_Layer --&gt; Paravirt;    Hypervisor_Layer --&gt; Passthrough;        Emulation -- &quot;æ…¢é€Ÿè·¯å¾„&quot; --&gt; PhysicalDevice;    Paravirt -- &quot;ä¼˜åŒ–è·¯å¾„&quot; --&gt; PhysicalDevice;    Passthrough -- &quot;ç›´æ¥è®¿é—®&quot; --&gt; PhysicalDevice;  </pre></div><h2 id="5-ä¸Šä¸‹æ¸¸äº¤äº’ä¸åä½œ"><a href="#5-ä¸Šä¸‹æ¸¸äº¤äº’ä¸åä½œ" class="headerlink" title="5. ä¸Šä¸‹æ¸¸äº¤äº’ä¸åä½œ"></a>5. ä¸Šä¸‹æ¸¸äº¤äº’ä¸åä½œ</h2><p>Hypervisor ä½äºä¸€ä¸ªå¤æ‚ç”Ÿæ€çš„ä¸­å¿ƒï¼Œä¸ä¸Šä¸‹æ¸¸ç³»ç»Ÿç´§å¯†åä½œã€‚</p><ul><li><p><strong>ä¸ç¡¬ä»¶ (ä¸‹æ¸¸) çš„äº¤äº’</strong>:</p><ul><li>Hypervisor åœ¨å¯åŠ¨æ—¶ä¼šæ£€æµ‹æ‰€æœ‰ç‰©ç†ç¡¬ä»¶ï¼ˆCPUã€å†…å­˜ã€å­˜å‚¨ã€ç½‘ç»œï¼‰ï¼Œå¹¶å–å¾—å®ƒä»¬çš„æ§åˆ¶æƒã€‚</li><li>å®ƒé€šè¿‡ç¡¬ä»¶è™šæ‹ŸåŒ–æ‰©å±•ï¼ˆVT-x, EPT ç­‰ï¼‰æ¥è°ƒåº¦ CPU å’Œå†…å­˜èµ„æºã€‚</li><li>å®ƒç®¡ç†ç‰©ç†è®¾å¤‡çš„è®¿é—®ï¼Œè¦ä¹ˆé€šè¿‡æ¨¡æ‹Ÿï¼Œè¦ä¹ˆé€šè¿‡åŠè™šæ‹ŸåŒ–åç«¯ï¼Œè¦ä¹ˆé€šè¿‡ IOMMU è¿›è¡Œè®¾å¤‡åˆ†é…ã€‚</li></ul></li><li><p><strong>ä¸å®¢æˆ·æœºæ“ä½œç³»ç»Ÿ (ä¸Šæ¸¸) çš„äº¤äº’</strong>:</p><ul><li>Hypervisor å‘å®¢æˆ·æœºå‘ˆç°ä¸€ä¸ªæ ‡å‡†åŒ–çš„è™šæ‹Ÿç¡¬ä»¶å¹³å°ã€‚</li><li>å®¢æˆ·æœºæ“ä½œç³»ç»Ÿä½¿ç”¨è‡ªå·±çš„æ ‡å‡†é©±åŠ¨ç¨‹åºä¸è¿™äº›è™šæ‹Ÿè®¾å¤‡äº¤äº’ã€‚</li><li>ä¸ºäº†è·å¾—æ›´å¥½çš„æ€§èƒ½ï¼Œå¯ä»¥åœ¨å®¢æˆ·æœºä¸­å®‰è£… <strong>Guest Tools</strong> æˆ– <strong>VirtIO é©±åŠ¨</strong>ï¼Œå®ç°ä¸ Hypervisor çš„é«˜æ•ˆåŠè™šæ‹ŸåŒ–é€šä¿¡ã€‚</li></ul></li><li><p><strong>ä¸ç®¡ç†å¹³å° (ä¸Šæ¸¸) çš„äº¤äº’</strong>:</p><ul><li>å•ä¸ª Hypervisor çš„èƒ½åŠ›æœ‰é™ï¼Œé€šå¸¸ç”±ä¸€ä¸ªæ›´é«˜çº§çš„ç®¡ç†å¹³å°æ¥ç¼–æ’ã€‚</li><li><strong>libvirt</strong> æ˜¯ä¸€ä¸ªå¼€æºçš„ API å’Œå·¥å…·é›†ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„ã€ä¸­ç«‹çš„æ¥å£æ¥ç®¡ç†ä¸åŒç§ç±»çš„ Hypervisorï¼ˆå¦‚ KVM, Xen, QEMUï¼‰ã€‚<code>virsh</code> å°±æ˜¯å®ƒé™„å¸¦çš„å‘½ä»¤è¡Œå·¥å…·ã€‚</li><li>åœ¨äº‘ç¯å¢ƒä¸­ï¼Œåƒ <strong>OpenStack</strong>, <strong>CloudStack</strong> æˆ– <strong>VMware vCenter</strong> è¿™æ ·çš„äº‘ç®¡å¹³å°ï¼Œä¼šé€šè¿‡ libvirt æˆ–ä¸“ç”¨ API æ¥è‡ªåŠ¨åŒ–åœ°åˆ›å»ºã€è¿ç§»ã€ç›‘æ§å’Œé”€æ¯æˆåƒä¸Šä¸‡çš„è™šæ‹Ÿæœºã€‚</li></ul></li></ul><h2 id="6-Hypervisor-èƒ½åšä»€ä¹ˆï¼Ÿ-åº”ç”¨åœºæ™¯"><a href="#6-Hypervisor-èƒ½åšä»€ä¹ˆï¼Ÿ-åº”ç”¨åœºæ™¯" class="headerlink" title="6. Hypervisor èƒ½åšä»€ä¹ˆï¼Ÿ(åº”ç”¨åœºæ™¯)"></a>6. Hypervisor èƒ½åšä»€ä¹ˆï¼Ÿ(åº”ç”¨åœºæ™¯)</h2><ul><li><strong>æœåŠ¡å™¨æ•´åˆ</strong>: å°†å¤šå°è´Ÿè½½è¾ƒä½çš„ç‰©ç†æœåŠ¡å™¨æ•´åˆåˆ°ä¸€å°æˆ–å°‘æ•°å‡ å°æœåŠ¡å™¨ä¸Šï¼Œé™ä½ç¡¬ä»¶æˆæœ¬ã€ç”µåŠ›å’Œç©ºé—´æ¶ˆè€—ã€‚</li><li><strong>å¼€å‘ä¸æµ‹è¯•</strong>: ä¸ºå¼€å‘äººå‘˜å’Œæµ‹è¯•äººå‘˜å¿«é€Ÿæä¾›å¹²å‡€ã€éš”ç¦»çš„ã€å¯éšæ—¶é”€æ¯å’Œé‡å»ºçš„å®éªŒç¯å¢ƒã€‚</li><li><strong>äº‘è®¡ç®— (IaaS)</strong>: Hypervisor æ˜¯ Infrastructure as a Service (IaaS) çš„æ ¸å¿ƒã€‚äº‘æœåŠ¡å•†åˆ©ç”¨å®ƒå°†åºå¤§çš„ç‰©ç†èµ„æºæ± åˆ‡åˆ†æˆå¯ä¾›ç§Ÿç”¨çš„è™šæ‹Ÿæœºã€‚</li><li><strong>æ¡Œé¢è™šæ‹ŸåŒ– (VDI)</strong>: åœ¨æ•°æ®ä¸­å¿ƒè¿è¡Œæ¡Œé¢æ“ä½œç³»ç»Ÿï¼ˆå¦‚ Windows 10&#x2F;11ï¼‰ï¼Œç”¨æˆ·é€šè¿‡ç½‘ç»œè¿œç¨‹è®¿é—®ï¼Œå®ç°é›†ä¸­ç®¡ç†å’Œæ•°æ®å®‰å…¨ã€‚</li><li><strong>å®‰å…¨éš”ç¦»ä¸æ²™ç®±</strong>: åˆ©ç”¨è™šæ‹Ÿæœºçš„å¼ºéš”ç¦»æ€§æ¥è¿è¡Œä¸å¯ä¿¡çš„è½¯ä»¶ï¼Œæˆ–è€…åˆ†ææ¶æ„è½¯ä»¶ï¼Œå³ä½¿è½¯ä»¶å´©æºƒæˆ–è¢«æ”»å‡»ï¼Œä¹Ÿä¸ä¼šå½±å“åˆ°å®¿ä¸»æœºå’Œå…¶ä»–è™šæ‹Ÿæœºã€‚</li></ul><h2 id="7-ä¸»æµ-Hypervisor-å¯¹æ¯”"><a href="#7-ä¸»æµ-Hypervisor-å¯¹æ¯”" class="headerlink" title="7. ä¸»æµ Hypervisor å¯¹æ¯”"></a>7. ä¸»æµ Hypervisor å¯¹æ¯”</h2><table><thead><tr><th align="left">ç‰¹æ€§ (Feature)</th><th align="left">KVM</th><th align="left">Xen</th><th align="left">VMware ESXi</th><th align="left">Microsoft Hyper-V</th></tr></thead><tbody><tr><td align="left"><strong>ç±»å‹ (Type)</strong></td><td align="left">Type 1 (é›†æˆäºLinuxå†…æ ¸)</td><td align="left">Type 1 (å¾®å†…æ ¸æ¶æ„)</td><td align="left">Type 1 (ç‹¬ç«‹å†…æ ¸)</td><td align="left">Type 1 (é›†æˆäºWindows)</td></tr><tr><td align="left"><strong>æ¶æ„ (Architecture)</strong></td><td align="left">å®å†…æ ¸ (Monolithic with Kernel)</td><td align="left">å¾®å†…æ ¸ (Microkernel)</td><td align="left">ç‹¬ç«‹å†…æ ¸ (Proprietary Kernel)</td><td align="left">å¾®å†…æ ¸åŒ– (Microkernelized)</td></tr><tr><td align="left"><strong>CPUè™šæ‹ŸåŒ–</strong></td><td align="left">ç¡¬ä»¶è¾…åŠ© (VT-x&#x2F;AMD-V)</td><td align="left">åŠè™šæ‹ŸåŒ– &#x2F; ç¡¬ä»¶è¾…åŠ©</td><td align="left">ç¡¬ä»¶è¾…åŠ©</td><td align="left">ç¡¬ä»¶è¾…åŠ©</td></tr><tr><td align="left"><strong>å¼€æºæ€§ (Open Source)</strong></td><td align="left">å¼€æº (Open Source)</td><td align="left">å¼€æº (Open Source)</td><td align="left">é—­æº (Proprietary, æœ‰å…è´¹ç‰ˆ)</td><td align="left">é—­æº (Proprietary, éšWindows Server)</td></tr><tr><td align="left"><strong>ç”Ÿæ€ç³»ç»Ÿ (Ecosystem)</strong></td><td align="left">æå¼º (OpenStack, oVirt, Proxmox)</td><td align="left">å¼ºå¤§ (AWS, Citrix, Oracle VM)</td><td align="left">éå¸¸æˆç†Ÿ (ä¼ä¸šçº§å¸‚åœºé¢†å¯¼è€…)</td><td align="left">å¼ºå¤§ (Azure, Windows ç”Ÿæ€)</td></tr><tr><td align="left"><strong>ç®¡ç†å·¥å…· (Management)</strong></td><td align="left">libvirt, virsh, Web UIs</td><td align="left">xl, xe, XenCenter</td><td align="left">vSphere, vCenter</td><td align="left">Hyper-V Manager, PowerShell, SCVMM</td></tr></tbody></table><h2 id="8-æ€»ç»“ä¸æœªæ¥å±•æœ›"><a href="#8-æ€»ç»“ä¸æœªæ¥å±•æœ›" class="headerlink" title="8. æ€»ç»“ä¸æœªæ¥å±•æœ›"></a>8. æ€»ç»“ä¸æœªæ¥å±•æœ›</h2><p>Hypervisor æ˜¯ç°ä»£è®¡ç®—æŠ€æœ¯çš„ä¸­æµç ¥æŸ±ã€‚å®ƒé€šè¿‡åœ¨è½¯ä»¶å±‚é¢æŠ½è±¡ç¡¬ä»¶ï¼Œå®ç°äº†èµ„æºçš„çµæ´»è°ƒåº¦ã€é«˜æ•ˆåˆ©ç”¨å’Œå¼ºåŠ›éš”ç¦»ã€‚ä»æœ€åˆçš„æœåŠ¡å™¨æ•´åˆï¼Œåˆ°ä»Šå¤©æ”¯æ’‘æ•´ä¸ªäº‘è®¡ç®—ï¼ŒHypervisor çš„é‡è¦æ€§ä¸è¨€è€Œå–»ã€‚</p><p>æœªæ¥ï¼ŒHypervisor æŠ€æœ¯ä»åœ¨ä¸æ–­æ¼”è¿›ï¼š</p><ul><li><strong>è½»é‡åŒ–</strong>: éšç€å®¹å™¨æŠ€æœ¯çš„å‘å±•ï¼Œå‡ºç°äº†åƒ <strong>Firecracker</strong> è¿™æ ·çš„å¾®å‹ Hypervisorï¼Œå®ƒä»¬ä¸“ä¸ºæ— æœåŠ¡å™¨è®¡ç®—å’Œå®¹å™¨è®¾è®¡ï¼Œå¯åŠ¨é€Ÿåº¦æå¿«ï¼Œå¼€é”€æå°ã€‚</li><li><strong>ä¸å®¹å™¨èåˆ</strong>: é¡¹ç›®å¦‚ <strong>Kata Containers</strong> å°è¯•å°†è™šæ‹Ÿæœºçš„å®‰å…¨éš”ç¦»ä¼˜åŠ¿ä¸å®¹å™¨çš„è½»ä¾¿å¿«æ·ç›¸ç»“åˆã€‚</li><li><strong>åµŒå¥—è™šæ‹ŸåŒ– (Nested Virtualization)</strong>: åœ¨è™šæ‹Ÿæœºå†…éƒ¨å†è¿è¡Œä¸€ä¸ª Hypervisorï¼Œè¿™ä¸ºäº‘ä¸­äº‘ã€è™šæ‹ŸåŒ–åŸ¹è®­ç­‰åœºæ™¯æä¾›äº†å¯èƒ½ã€‚</li></ul><p>ç†è§£ Hypervisor ä¸ä»…æ˜¯ç†è§£è™šæ‹ŸåŒ–ï¼Œæ›´æ˜¯ç†è§£ç°ä»£ IT åŸºç¡€è®¾æ–½å¦‚ä½•å·¥ä½œçš„å…³é”®ä¸€æ­¥ã€‚ </p>]]></content>
      
      
      <categories>
          
          <category> è™šæ‹ŸåŒ–æŠ€æœ¯ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è™šæ‹ŸåŒ– </tag>
            
            <tag> Hypervisor </tag>
            
            <tag> KVM </tag>
            
            <tag> VMware </tag>
            
            <tag> Xen </tag>
            
            <tag> äº‘è®¡ç®— </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥ç†è§£RSAï¼šåŠ å¯†ä¸ç­¾åçš„è‰ºæœ¯</title>
      <link href="/2025/07/24/RSA_Explained/"/>
      <url>/2025/07/24/RSA_Explained/</url>
      
        <content type="html"><![CDATA[<h1 id="æ·±å…¥ç†è§£RSAï¼šåŠ å¯†ä¸ç­¾åçš„è‰ºæœ¯"><a href="#æ·±å…¥ç†è§£RSAï¼šåŠ å¯†ä¸ç­¾åçš„è‰ºæœ¯" class="headerlink" title="æ·±å…¥ç†è§£RSAï¼šåŠ å¯†ä¸ç­¾åçš„è‰ºæœ¯"></a>æ·±å…¥ç†è§£RSAï¼šåŠ å¯†ä¸ç­¾åçš„è‰ºæœ¯</h1><p>RSA æ˜¯å½“ä»Šä¸–ç•Œåº”ç”¨æœ€å¹¿æ³›çš„å…¬é’¥åŠ å¯†ç®—æ³•ï¼Œç”± Ron <strong>R</strong>ivest, Adi <strong>S</strong>hamir å’Œ Leonard <strong>A</strong>dleman åœ¨1977å¹´æå‡ºã€‚å®ƒå·§å¦™åœ°åˆ©ç”¨äº†æ•°è®ºä¸­ä¸€ä¸ªæ ¸å¿ƒçš„éš¾é¢˜ï¼š<strong>å°†ä¸€ä¸ªå·¨å¤§çš„åˆæ•°åˆ†è§£è´¨å› æ•°æ˜¯æå…¶å›°éš¾çš„ï¼Œä½†å°†ä¸¤ä¸ªå¤§ç´ æ•°ç›¸ä¹˜å´éå¸¸å®¹æ˜“ã€‚</strong></p><p>è¿™ä»½æ–‡æ¡£å°†å¸¦ä½ èµ°å®Œ RSA ä»å¯†é’¥ç”Ÿæˆã€åŠ å¯†&#x2F;è§£å¯†ï¼Œåˆ°æ•°å­—ç­¾å&#x2F;éªŒè¯çš„å…¨è¿‡ç¨‹ï¼Œå¹¶é™„å¸¦ä¸€ä¸ªå¯æ‰‹åŠ¨è®¡ç®—çš„çœŸå®æ•°æ®ç¤ºä¾‹ã€‚</p><hr><h2 id="1-æ ¸å¿ƒæ•°å­¦æ¦‚å¿µ"><a href="#1-æ ¸å¿ƒæ•°å­¦æ¦‚å¿µ" class="headerlink" title="1. æ ¸å¿ƒæ•°å­¦æ¦‚å¿µ"></a>1. æ ¸å¿ƒæ•°å­¦æ¦‚å¿µ</h2><p>ç†è§£RSAéœ€è¦äº†è§£ä¸€äº›åŸºç¡€çš„æ•°è®ºæ¦‚å¿µï¼Œåˆ«æ‹…å¿ƒï¼Œæˆ‘ä»¬ä¼šç”¨æœ€ç›´è§‚çš„æ–¹å¼è§£é‡Šã€‚</p><ul><li><p><strong>ç´ æ•° (Prime Number):</strong> åªèƒ½è¢«1å’Œè‡ªèº«æ•´é™¤çš„æ•°ï¼Œå¦‚ 7, 11, 13ã€‚å®ƒä»¬æ˜¯RSAç®—æ³•çš„åŸºçŸ³ã€‚</p></li><li><p><strong>æ¨¡è¿ç®— (Modular Arithmetic):</strong> ä¹Ÿå«â€œæ—¶é’Ÿè¿ç®—â€ï¼Œå³å–ä½™æ•°ã€‚ä¾‹å¦‚ <code>14 mod 12</code> ç­‰äº <code>2</code>ï¼ˆæ—¶é’Ÿä¸Šçš„14ç‚¹å°±æ˜¯2ç‚¹ï¼‰ã€‚å…¬å¼å†™ä½œ <code>a â‰¡ b (mod n)</code>ï¼Œè¡¨ç¤º <code>a</code> å’Œ <code>b</code> é™¤ä»¥ <code>n</code> çš„ä½™æ•°ç›¸åŒã€‚</p></li><li><p><strong>æ¬§æ‹‰å‡½æ•° (Eulerâ€™s Totient Function):</strong> <code>Ï†(n)</code> è¡¨ç¤ºå°äº <code>n</code> ä¸”ä¸ <code>n</code> äº’è´¨ï¼ˆæ²¡æœ‰é™¤1ä»¥å¤–çš„å…¬çº¦æ•°ï¼‰çš„æ•°çš„ä¸ªæ•°ã€‚è¿™æ˜¯ä¸€ä¸ªå…³é”®çš„å‡½æ•°ï¼Œå®ƒæœ‰ä¸€ä¸ªç¥å¥‡çš„æ€§è´¨ï¼š</p><blockquote><p>å¦‚æœ <code>n</code> æ˜¯ä¸¤ä¸ªç´ æ•° <code>p</code> å’Œ <code>q</code> çš„ä¹˜ç§¯ï¼Œå³ <code>n = p * q</code>ï¼Œ<br>é‚£ä¹ˆ **<code>Ï†(n) = (p-1) * (q-1)</code>**ã€‚</p></blockquote></li><li><p><strong>æ¬§æ‹‰å®šç† (Eulerâ€™s Theorem):</strong> è¿™æ˜¯RSAèƒ½å¤Ÿå·¥ä½œçš„æ•°å­¦åŸºçŸ³ã€‚å®ƒæŒ‡å‡ºï¼Œå¦‚æœä¸€ä¸ªæ•´æ•° <code>a</code> ä¸ <code>n</code> äº’è´¨ï¼Œé‚£ä¹ˆï¼š</p><blockquote><p><strong><code>a^Ï†(n) â‰¡ 1 (mod n)</code></strong></p></blockquote></li><li><p><strong>æ¨¡åå…ƒç´  (Modular Multiplicative Inverse):</strong> å¦‚æœ <code>e</code> å’Œ <code>d</code> æ»¡è¶³ <code>(e * d) mod Ï†(n) = 1</code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç§° <code>d</code> æ˜¯ <code>e</code> ç›¸å¯¹äº <code>Ï†(n)</code> çš„æ¨¡åå…ƒç´ ã€‚å¯ä»¥ç†è§£ä¸º <code>d</code> æ˜¯ <code>e</code> åœ¨æ¨¡ <code>Ï†(n)</code> è¿ç®—ä¸‹çš„â€œå€’æ•°â€ã€‚</p></li></ul><hr><h2 id="2-ç¬¬ä¸€æ­¥ï¼šç”Ÿæˆå¯†é’¥å¯¹ï¼ˆå…¬é’¥ä¸ç§é’¥ï¼‰"><a href="#2-ç¬¬ä¸€æ­¥ï¼šç”Ÿæˆå¯†é’¥å¯¹ï¼ˆå…¬é’¥ä¸ç§é’¥ï¼‰" class="headerlink" title="2. ç¬¬ä¸€æ­¥ï¼šç”Ÿæˆå¯†é’¥å¯¹ï¼ˆå…¬é’¥ä¸ç§é’¥ï¼‰"></a>2. ç¬¬ä¸€æ­¥ï¼šç”Ÿæˆå¯†é’¥å¯¹ï¼ˆå…¬é’¥ä¸ç§é’¥ï¼‰</h2><p>è®©æˆ‘ä»¬ç”¨ä¸€ä¸ªçœŸå®çš„ã€å¯æ‰‹åŠ¨è®¡ç®—çš„ä¾‹å­æ¥ç”Ÿæˆä¸€å¥—å¯†é’¥ã€‚åœ¨çœŸå®ä¸–ç•Œä¸­ï¼Œæ‰€é€‰çš„ç´ æ•°ä¼šéå¸¸å·¨å¤§ï¼ˆå‡ ç™¾ä½é•¿ï¼‰ã€‚</p><p><strong>ç›®æ ‡ï¼š</strong> ç”Ÿæˆå…¬é’¥ <code>(n, e)</code> å’Œç§é’¥ <code>(n, d)</code>ã€‚</p><ol><li><p><strong>é€‰æ‹©ä¸¤ä¸ªä¸åŒçš„ç´ æ•° <code>p</code> å’Œ <code>q</code>ã€‚</strong></p><ul><li>ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬é€‰æ‹© <code>p = 61</code> å’Œ <code>q = 53</code>ã€‚</li><li><strong>ä¿å¯†ï¼š</strong> è¿™ä¸¤ä¸ªæ•°åœ¨ç”Ÿæˆå¯†é’¥åå¿…é¡»é”€æ¯ï¼Œç»å¯¹ä¸èƒ½æ³„éœ²ã€‚</li></ul></li><li><p><strong>è®¡ç®— <code>n = p * q</code>ã€‚</strong></p><ul><li><code>n = 61 * 53 = 3233</code>ã€‚</li><li>è¿™ä¸ª <code>n</code> æ˜¯å…¬é’¥å’Œç§é’¥çš„ä¸€éƒ¨åˆ†ï¼Œæ˜¯å…¬å¼€çš„ã€‚</li></ul></li><li><p><strong>è®¡ç®—æ¬§æ‹‰å‡½æ•° <code>Ï†(n) = (p-1) * (q-1)</code>ã€‚</strong></p><ul><li><code>Ï†(3233) = (61-1) * (53-1) = 60 * 52 = 3120</code>ã€‚</li><li><strong>ä¿å¯†ï¼š</strong> <code>Ï†(n)</code> å¿…é¡»ä¿å¯†ï¼Œå› ä¸ºå¦‚æœå®ƒè¢«æ³„éœ²ï¼Œæ”»å‡»è€…å°±èƒ½è½»æ˜“è®¡ç®—å‡ºç§é’¥ã€‚</li></ul></li><li><p><strong>é€‰æ‹©ä¸€ä¸ªå…¬é’¥æŒ‡æ•° <code>e</code>ã€‚</strong></p><ul><li><code>e</code> å¿…é¡»æ»¡è¶³ <code>1 &lt; e &lt; Ï†(n)</code> ä¸” <code>e</code> ä¸ <code>Ï†(n)</code> äº’è´¨ã€‚</li><li>æˆ‘ä»¬é€‰æ‹© <code>e = 17</code>ã€‚ï¼ˆ17æ˜¯ç´ æ•°ï¼Œä¸”3120ä¸èƒ½è¢«17æ•´é™¤ï¼Œæ‰€ä»¥å®ƒä»¬äº’è´¨ï¼‰ã€‚</li><li><strong>å…¬é’¥è¯ç”Ÿï¼š</strong> æˆ‘ä»¬çš„å…¬é’¥æ˜¯ <code>(n, e) = (3233, 17)</code>ã€‚è¿™ä¸ªå¯ä»¥å‘Šè¯‰ä»»ä½•äººã€‚</li></ul></li><li><p><strong>è®¡ç®—ç§é’¥æŒ‡æ•° <code>d</code>ã€‚</strong></p><ul><li><code>d</code> æ˜¯ <code>e</code> ç›¸å¯¹äº <code>Ï†(n)</code> çš„æ¨¡åå…ƒç´ ã€‚å³ <code>(d * e) mod Ï†(n) = 1</code>ã€‚</li><li>æˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ª <code>d</code> ä½¿å¾— <code>(d * 17) mod 3120 = 1</code>ã€‚</li><li>è¿™å¯ä»¥é€šè¿‡â€œæ‰©å±•æ¬§å‡ é‡Œå¾—ç®—æ³•â€æ¥è§£å†³ã€‚è¿™é‡Œæˆ‘ä»¬ç›´æ¥ç»™å‡ºç»“æœï¼š<code>d = 2753</code>ã€‚</li><li>ï¼ˆéªŒè¯ä¸€ä¸‹ï¼š<code>2753 * 17 = 46801</code>ï¼Œç„¶å <code>46801 mod 3120 = (15 * 3120 + 1) mod 3120 = 1</code>ï¼‰ã€‚</li><li><strong>ç§é’¥è¯ç”Ÿï¼š</strong> æˆ‘ä»¬çš„ç§é’¥æ˜¯ <code>(n, d) = (3233, 2753)</code>ã€‚è¿™ä¸ªå¿…é¡»æ­»å®ˆï¼Œå¤©çŸ¥åœ°çŸ¥ä½ çŸ¥ã€‚</li></ul></li></ol><p><strong>å°ç»“:</strong></p><ul><li><strong>å…¬é’¥ (Public Key): (3233, 17)</strong>  -&gt; ç”¨äºåŠ å¯†ï¼Œæˆ–éªŒè¯ç­¾å</li><li><strong>ç§é’¥ (Private Key): (3233, 2753)</strong> -&gt; ç”¨äºè§£å¯†ï¼Œæˆ–ç”Ÿæˆç­¾å</li></ul><hr><h2 id="3-ç¬¬äºŒæ­¥ï¼šä½¿ç”¨RSAè¿›è¡ŒåŠ å¯†å’Œè§£å¯†"><a href="#3-ç¬¬äºŒæ­¥ï¼šä½¿ç”¨RSAè¿›è¡ŒåŠ å¯†å’Œè§£å¯†" class="headerlink" title="3. ç¬¬äºŒæ­¥ï¼šä½¿ç”¨RSAè¿›è¡ŒåŠ å¯†å’Œè§£å¯†"></a>3. ç¬¬äºŒæ­¥ï¼šä½¿ç”¨RSAè¿›è¡ŒåŠ å¯†å’Œè§£å¯†</h2><p><strong>åœºæ™¯ï¼š</strong> Alice æƒ³ç»™ Bob å‘é€ä¸€ä¸ªç§˜å¯†æ¶ˆæ¯ã€‚å¥¹éœ€è¦ç”¨ Bob çš„ <strong>å…¬é’¥</strong> æ¥åŠ å¯†ã€‚</p><ul><li><strong>åŸå§‹æ¶ˆæ¯ (Message):</strong> <code>M</code>ã€‚å¿…é¡»æ˜¯ä¸€ä¸ªå°äº <code>n</code> çš„æ•´æ•°ã€‚å¦‚æœæ¶ˆæ¯æ˜¯æ–‡æœ¬ï¼Œéœ€è¦å…ˆè½¬æ¢æˆæ•°å­—ã€‚æˆ‘ä»¬å‡è®¾è¦å‘é€çš„ç§˜å¯†æ•°å­—æ˜¯ <code>M = 123</code>ã€‚</li></ul><h3 id="åŠ å¯†è¿‡ç¨‹-Aliceæ“ä½œ"><a href="#åŠ å¯†è¿‡ç¨‹-Aliceæ“ä½œ" class="headerlink" title="åŠ å¯†è¿‡ç¨‹ (Aliceæ“ä½œ)"></a>åŠ å¯†è¿‡ç¨‹ (Aliceæ“ä½œ)</h3><p>Alice ä½¿ç”¨ Bob çš„ **å…¬é’¥ <code>(n, e) = (3233, 17)</code>**ã€‚</p><ul><li><strong>å…¬å¼:</strong> <code>Ciphertext (C) = M^e mod n</code></li><li><strong>è®¡ç®—:</strong> <code>C = 123^17 mod 3233</code></li><li>è¿™ä¸ªè®¡ç®—éœ€è¦è®¡ç®—å™¨ï¼Œç»“æœæ˜¯ï¼š<code>C = 855</code>ã€‚</li></ul><p>ç°åœ¨ï¼ŒAlice å°†è¿™ä¸ªåŠ å¯†åçš„å¯†æ–‡ <code>855</code> é€šè¿‡ä¸å®‰å…¨çš„ç½‘ç»œå‘é€ç»™ Bobã€‚å³ä½¿è¢«çªƒå¬ï¼Œæ”»å‡»è€…æ‹¿åˆ° <code>855</code> ä¹Ÿæ— æ³•æ¨æ–­å‡ºåŸå§‹æ¶ˆæ¯æ˜¯ <code>123</code>ã€‚</p><h3 id="è§£å¯†è¿‡ç¨‹-Bobæ“ä½œ"><a href="#è§£å¯†è¿‡ç¨‹-Bobæ“ä½œ" class="headerlink" title="è§£å¯†è¿‡ç¨‹ (Bobæ“ä½œ)"></a>è§£å¯†è¿‡ç¨‹ (Bobæ“ä½œ)</h3><p>Bob æ”¶åˆ°å¯†æ–‡ <code>C = 855</code>ï¼Œä»–ä½¿ç”¨è‡ªå·±çš„ <strong>ç§é’¥ <code>(n, d) = (3233, 2753)</code></strong> æ¥è§£å¯†ã€‚</p><ul><li><strong>å…¬å¼:</strong> <code>Message (M) = C^d mod n</code></li><li><strong>è®¡ç®—:</strong> <code>M = 855^2753 mod 3233</code></li><li>è¿™åŒæ ·æ˜¯ä¸ªå·¨å¤§çš„è®¡ç®—ï¼Œä½†ç»“æœä¼šç²¾ç¡®åœ°å›åˆ°ï¼š<code>M = 123</code>ã€‚</li></ul><p><strong>ä¸ºä»€ä¹ˆèƒ½è§£å¯†ï¼Ÿ</strong><br>è¿™èƒŒåçš„æ•°å­¦åŸç†æ˜¯æ¬§æ‹‰å®šç†ã€‚<code>C^d = (M^e)^d = M^(e*d)</code>ã€‚ç”±äº <code>e*d mod Ï†(n) = 1</code>ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ <code>e*d</code> å†™æˆ <code>k*Ï†(n) + 1</code> çš„å½¢å¼ã€‚æ‰€ä»¥ï¼š<br><code>M^(e*d) mod n = M^(k*Ï†(n) + 1) mod n = (M^Ï†(n))^k * M^1 mod n</code><br>æ ¹æ®æ¬§æ‹‰å®šç†, <code>M^Ï†(n) mod n</code> ç­‰äº <code>1</code>ã€‚æ‰€ä»¥ä¸Šå¼å˜ä¸º <code>1^k * M mod n</code>ï¼Œæœ€ç»ˆç»“æœå°±æ˜¯ <code>M</code>ã€‚</p><blockquote><p>æ¬§æ‹‰å®šç†è¦æ±‚ <code>M</code> ä¸ <code>n</code> äº’è´¨ï¼ˆå³<code>gcd(M,n)=1</code>ï¼‰ã€‚åœ¨ç¤ºä¾‹ä¸­<code>M=123</code>ï¼Œ<code>n=3233</code>ï¼Œå› <code>123=3Ã—41</code>ï¼Œ<code>n=61Ã—53</code>ï¼Œä¸¤è€…äº’è´¨ï¼Œæ•…æˆç«‹ã€‚ä½†è‹¥<code>M</code>æ˜¯<code>p</code>æˆ–<code>q</code>çš„å€æ•°ï¼ˆå¦‚<code>M=61</code>ï¼‰ï¼Œæ¬§æ‹‰å®šç†ä¸ç›´æ¥é€‚ç”¨ï¼Œæ­¤æ—¶éœ€ç”¨<strong>ä¸­å›½å‰©ä½™å®šç†ï¼ˆCRTï¼‰</strong>ä¿è¯è§£å¯†æ­£ç¡®æ€§ã€‚å®é™…RSAå®ç°å‡ä¾èµ–CRTä¼˜åŒ–ã€‚</p></blockquote><hr><h2 id="4-ç¬¬ä¸‰æ­¥ï¼šä½¿ç”¨RSAè¿›è¡Œæ•°å­—ç­¾åå’ŒéªŒè¯"><a href="#4-ç¬¬ä¸‰æ­¥ï¼šä½¿ç”¨RSAè¿›è¡Œæ•°å­—ç­¾åå’ŒéªŒè¯" class="headerlink" title="4. ç¬¬ä¸‰æ­¥ï¼šä½¿ç”¨RSAè¿›è¡Œæ•°å­—ç­¾åå’ŒéªŒè¯"></a>4. ç¬¬ä¸‰æ­¥ï¼šä½¿ç”¨RSAè¿›è¡Œæ•°å­—ç­¾åå’ŒéªŒè¯</h2><p><strong>åœºæ™¯ï¼š</strong> Alice æƒ³å‘å¸ƒä¸€ä¸ªè½¯ä»¶ï¼Œå¥¹éœ€è¦å¯¹è½¯ä»¶ç­¾åï¼Œä»¥è¯æ˜è¿™ä¸ªè½¯ä»¶ç¡®å®æ˜¯å¥¹å‘å¸ƒçš„ï¼ˆ<strong>çœŸå®æ€§</strong>ï¼‰ï¼Œå¹¶ä¸”æ²¡æœ‰è¢«ç¯¡æ”¹ï¼ˆ<strong>å®Œæ•´æ€§</strong>ï¼‰ã€‚</p><p>ç­¾åçš„è¿‡ç¨‹ä¸åŠ å¯†<strong>æ­£å¥½ç›¸å</strong>ï¼Œæ˜¯<strong>ç”¨ç§é’¥â€œåŠ å¯†â€</strong>ï¼Œç”¨å…¬é’¥â€œè§£å¯†â€ã€‚</p><p><strong>é‡è¦ï¼š</strong> ç›´æ¥å¯¹å¤§æ•°æ®ï¼ˆå¦‚æ•´ä¸ªè½¯ä»¶ï¼‰è¿›è¡Œç­¾åï¼Œé€Ÿåº¦ææ…¢ä¸”ä¸å®‰å…¨ã€‚æ­£ç¡®çš„åšæ³•æ˜¯ <strong>â€œå…ˆå“ˆå¸Œï¼Œå†ç­¾åâ€</strong>ã€‚</p><ol><li><strong>å“ˆå¸Œ (Hashing):</strong> Alice å…ˆç”¨ä¸€ä¸ªå¯†ç å­¦å“ˆå¸Œå‡½æ•°ï¼ˆå¦‚ SHA-256ï¼‰è®¡ç®—è½¯ä»¶çš„å“ˆå¸Œå€¼ï¼ˆä¸€ä¸ªç®€çŸ­çš„ã€ç‹¬ä¸€æ— äºŒçš„â€œæŒ‡çº¹â€ï¼‰ã€‚<ul><li>ä¸ºç®€åŒ–è®¡ç®—ï¼Œæˆ‘ä»¬å‡è®¾è½¯ä»¶çš„å“ˆå¸Œæ‘˜è¦è½¬æ¢æˆæ•°å­—åæ˜¯ <code>H = 99</code>ã€‚</li></ul></li></ol><h3 id="ç­¾åè¿‡ç¨‹-Aliceæ“ä½œ"><a href="#ç­¾åè¿‡ç¨‹-Aliceæ“ä½œ" class="headerlink" title="ç­¾åè¿‡ç¨‹ (Aliceæ“ä½œ)"></a>ç­¾åè¿‡ç¨‹ (Aliceæ“ä½œ)</h3><p>Alice ä½¿ç”¨å¥¹è‡ªå·±çš„ <strong>ç§é’¥ <code>(n, d) = (3233, 2753)</code></strong> æ¥ç­¾åã€‚</p><ul><li><strong>å…¬å¼:</strong> <code>Signature (S) = H^d mod n</code></li><li><strong>è®¡ç®—:</strong> <code>S = 99^2753 mod 3233</code></li><li>è®¡ç®—ç»“æœä¸º <code>S = 2426</code>ã€‚</li></ul><p>Alice å°† <strong><code>(åŸå§‹è½¯ä»¶, ç­¾åS=2426)</code></strong> ä¸€èµ·å‘å¸ƒã€‚</p><h3 id="éªŒè¯è¿‡ç¨‹-Bobæ“ä½œ"><a href="#éªŒè¯è¿‡ç¨‹-Bobæ“ä½œ" class="headerlink" title="éªŒè¯è¿‡ç¨‹ (Bobæ“ä½œ)"></a>éªŒè¯è¿‡ç¨‹ (Bobæ“ä½œ)</h3><p>Bob ä¸‹è½½äº†è½¯ä»¶å’Œç­¾å <code>2426</code>ã€‚ä»–éœ€è¦ç”¨ Alice çš„ <strong>å…¬é’¥ <code>(n, e) = (3233, 17)</code></strong> æ¥éªŒè¯ã€‚</p><ol><li><strong>ç¬¬ä¸€æ­¥ï¼š</strong> Bob å¯¹ä»–ä¸‹è½½çš„è½¯ä»¶ <strong>ä½¿ç”¨å®Œå…¨ç›¸åŒçš„å“ˆå¸Œç®—æ³•</strong>ï¼ˆSHA-256ï¼‰è®¡ç®—å“ˆå¸Œå€¼ã€‚ç»“æœå¿…ç„¶ä¹Ÿæ˜¯ <code>H1 = 99</code>ã€‚</li><li><strong>ç¬¬äºŒæ­¥ï¼š</strong> Bob ä½¿ç”¨ Alice çš„å…¬é’¥å¯¹ç­¾åè¿›è¡Œâ€œè§£å¯†â€æ“ä½œã€‚<ul><li><strong>å…¬å¼:</strong> <code>Verified_Hash (H2) = S^e mod n</code></li><li><strong>è®¡ç®—:</strong> <code>H2 = 2426^17 mod 3233</code></li><li>è®¡ç®—ç»“æœä¸º <code>H2 = 99</code>ã€‚</li></ul></li><li><strong>ç¬¬ä¸‰æ­¥ï¼šæ¯”è¾ƒ</strong><ul><li>Bob æ¯”è¾ƒä»–è‡ªå·±è®¡ç®—çš„å“ˆå¸Œ <code>H1</code> å’Œä»ç­¾åä¸­è¿˜åŸå‡ºçš„å“ˆå¸Œ <code>H2</code>ã€‚</li><li><code>H1 (99)</code> æ˜¯å¦ç­‰äº <code>H2 (99)</code>ï¼Ÿ <strong>æ˜¯çš„</strong>ã€‚</li><li><strong>ç»“è®ºï¼š</strong> ç­¾åæœ‰æ•ˆã€‚Bob å¯ä»¥ç¡®ä¿¡ï¼Œè¿™ä¸ªè½¯ä»¶ç¡®å®æ˜¯ Alice å‘å¸ƒçš„ï¼Œå¹¶ä¸”ä»å‘å¸ƒåˆ°ç°åœ¨ï¼Œä¸€ä¸ªæ¯”ç‰¹éƒ½æ²¡æœ‰è¢«æ”¹åŠ¨è¿‡ã€‚å¦‚æœæœ‰äººç¯¡æ”¹äº†è½¯ä»¶ï¼Œ<code>H1</code> å°†ä¼šæ”¹å˜ï¼ŒéªŒè¯å°±ä¼šå¤±è´¥ã€‚</li></ul></li></ol><hr><h2 id="5-ä¸ºä»€ä¹ˆRSAæ˜¯å®‰å…¨çš„ï¼Ÿâ€”â€”-ç†è®ºä¸ç°å®çš„å·®è·"><a href="#5-ä¸ºä»€ä¹ˆRSAæ˜¯å®‰å…¨çš„ï¼Ÿâ€”â€”-ç†è®ºä¸ç°å®çš„å·®è·" class="headerlink" title="5. ä¸ºä»€ä¹ˆRSAæ˜¯å®‰å…¨çš„ï¼Ÿâ€”â€” ç†è®ºä¸ç°å®çš„å·®è·"></a>5. ä¸ºä»€ä¹ˆRSAæ˜¯å®‰å…¨çš„ï¼Ÿâ€”â€” ç†è®ºä¸ç°å®çš„å·®è·</h2><h4 id="ç†è®ºä¸Šçš„å®‰å…¨æ€§"><a href="#ç†è®ºä¸Šçš„å®‰å…¨æ€§" class="headerlink" title="ç†è®ºä¸Šçš„å®‰å…¨æ€§"></a>ç†è®ºä¸Šçš„å®‰å…¨æ€§</h4><p>RSAçš„å®‰å…¨æ€§æ ¹æ¤äºä¸€ä¸ªæ•°å­¦éš¾é¢˜â€”â€”<strong>å¤§æ•°è´¨å› æ•°åˆ†è§£</strong>ã€‚æ”»å‡»è€…çŸ¥é“å…¬é’¥ <code>(n, e)</code>ï¼Œä½†è¦æ¨å¯¼å‡ºç§é’¥ <code>d</code>ï¼Œå°±å¿…é¡»å…ˆè®¡ç®—å‡º <code>Ï†(n) = (p-1)(q-1)</code>ã€‚è€Œè¦è®¡ç®— <code>Ï†(n)</code>ï¼Œå°±å¿…é¡»çŸ¥é“ <code>n</code> çš„ä¸¤ä¸ªè´¨å› æ•° <code>p</code> å’Œ <code>q</code>ã€‚å½“ <code>n</code> è¶³å¤Ÿå¤§æ—¶ï¼ˆå¦‚2048ä½ï¼‰ï¼Œåˆ†è§£ <code>n</code> åœ¨è®¡ç®—ä¸Šæ˜¯ä¸å¯è¡Œçš„ã€‚</p><h4 id="ç°å®ä¸­çš„è‡´å‘½æ¼æ´"><a href="#ç°å®ä¸­çš„è‡´å‘½æ¼æ´" class="headerlink" title="ç°å®ä¸­çš„è‡´å‘½æ¼æ´"></a>ç°å®ä¸­çš„è‡´å‘½æ¼æ´</h4><p>ç„¶è€Œï¼Œç†è®ºä¸Šçš„å®‰å…¨ä¸ç­‰äºå®è·µä¸­çš„å®‰å…¨ã€‚å¦‚æœæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ä¸Šé¢ä»‹ç»çš„â€œæ•™ç§‘ä¹¦å¼â€RSAè¿›è¡Œç­¾åï¼Œä¼šå­˜åœ¨ä¸€ä¸ªè‡´å‘½çš„æ¼æ´ï¼Œå³<strong>å­˜åœ¨æ€§ä¼ªé€ æ”»å‡» (Existential Forgery)<strong>ã€‚è¿™ä¸ªæ”»å‡»ç”ŸåŠ¨åœ°å±•ç¤ºäº†ä¸ºä»€ä¹ˆ</strong>å¡«å…… (Padding)</strong> æ˜¯ç»å¯¹å¿…è¦çš„ã€‚</p><h3 id="æ·±åº¦å‰–æï¼šå­˜åœ¨æ€§ä¼ªé€ æ”»å‡»-Existential-Forgery"><a href="#æ·±åº¦å‰–æï¼šå­˜åœ¨æ€§ä¼ªé€ æ”»å‡»-Existential-Forgery" class="headerlink" title="æ·±åº¦å‰–æï¼šå­˜åœ¨æ€§ä¼ªé€ æ”»å‡» (Existential Forgery)"></a>æ·±åº¦å‰–æï¼šå­˜åœ¨æ€§ä¼ªé€ æ”»å‡» (Existential Forgery)</h3><p><strong>æ”»å‡»è€…å¦‚ä½•â€œå‡­ç©ºâ€åˆ›é€ æœ‰æ•ˆç­¾å</strong></p><p>æ”»å‡»è€… Eve å®Œå…¨ä¸çŸ¥é“æ‚¨çš„ç§é’¥ <code>d</code>ï¼Œä½†å¥¹çŸ¥é“æ‚¨çš„å…¬é’¥ <code>(n, e)</code>ã€‚å¥¹çš„ç›®æ ‡æ˜¯æ„é€ å‡ºä¸€å¯¹ <code>(ä¼ªé€ çš„æ¶ˆæ¯ m&#39;, ä¼ªé€ çš„ç­¾å s&#39;)</code>ï¼Œå¹¶è®©å®ƒé€šè¿‡éªŒè¯ã€‚æ€è·¯å®Œå…¨æ˜¯<strong>é€†å‘çš„</strong>ï¼š</p><ol><li><p><strong>ç¬¬ä¸€æ­¥ (é€‰æ‹©ä¸€ä¸ªâ€œç­¾åâ€):</strong> Eve éšæœºæŒ‘é€‰ä¸€ä¸ªæ•°å­— <code>s&#39;</code>ï¼Œå¹¶å†³å®š<strong>æŠŠå®ƒå½“ä½œä¸€ä¸ªâ€œç­¾åâ€</strong>ã€‚æ¯”å¦‚ï¼ŒEve éšä¾¿é€‰ä¸€ä¸ªæ•°å­— <code>s&#39; = 12345</code> (åªè¦å°äº <code>n</code> å³å¯)ã€‚</p></li><li><p><strong>ç¬¬äºŒæ­¥ (ä½¿ç”¨å…¬é’¥è®¡ç®—â€œæ¶ˆæ¯â€):</strong> Eve åˆ©ç”¨<strong>éªŒè¯å…¬å¼</strong>å’Œ<strong>å…¬é’¥</strong>æ¥åå‘è®¡ç®—è¿™ä¸ªâ€œç­¾åâ€å¯¹åº”çš„â€œæ¶ˆæ¯â€ï¼š<br><code>m&#39; = (s&#39;)^e mod n</code></p></li><li><p><strong>ç¬¬ä¸‰æ­¥ (ä¼ªé€ å®Œæˆ):</strong> Eve å¾—åˆ°äº†ä¸€å¯¹æ•°æ®ï¼š<code>(m&#39;, s&#39;)</code>ã€‚å¥¹å°†è¿™å¯¹æ•°æ®å‘ç»™æ¥æ”¶è€…ã€‚</p></li></ol><p><strong>ä¸ºä»€ä¹ˆè¿™ä¸ªä¼ªé€ ä¼šé€šè¿‡éªŒè¯ï¼Ÿ</strong></p><p>æ¥æ”¶è€…æ‰§è¡Œæ ‡å‡†éªŒè¯æµç¨‹ï¼šç”¨å…¬é’¥ <code>e</code> è®¡ç®— <code>(s&#39;)^e mod n</code>ï¼Œç„¶åå°†ç»“æœä¸æ”¶åˆ°çš„ <code>m&#39;</code> æ¯”è¾ƒã€‚æ ¹æ® Eve çš„æ„é€ æ–¹æ³•ï¼Œè¿™ä¸ªè®¡ç®—ç»“æœ**æ­£å¥½å°±æ˜¯ <code>m&#39;</code>**ï¼Œå› æ­¤éªŒè¯é€šè¿‡ï¼æ¥æ”¶è€…ä¼šè¯¯ä»¥ä¸ºè¿™æ˜¯ä¸€ä¸ªåˆæ³•çš„ç­¾åã€‚</p><p><strong>è¿™ç ´è§£äº†RSAå—ï¼Ÿ</strong></p><p>æ²¡æœ‰ã€‚Eve <strong>å¹¶æ²¡æœ‰</strong> æ‰¾å‡ºç§é’¥ <code>d</code>ï¼Œå¥¹ä¹Ÿ<strong>æ— æ³•</strong>ä¸ºä»»ä½•<strong>å¥¹æŒ‡å®šçš„ã€æœ‰æ„ä¹‰çš„</strong>æ¶ˆæ¯ï¼ˆæ¯”å¦‚â€œè½¬è´¦100ä¸‡â€ï¼‰ä¼ªé€ ç­¾åã€‚å¥¹ä¼ªé€ å‡ºçš„æ¶ˆæ¯ <code>m&#39;</code> å‡ ä¹è‚¯å®šæ˜¯æ— æ„ä¹‰çš„ä¹±ç ã€‚è¿™ç§æ”»å‡»å› æ­¤è¢«ç§°ä¸ºâ€œå­˜åœ¨æ€§ä¼ªé€ â€â€”â€”åªèƒ½è¯æ˜ä¸€ä¸ªæœ‰æ•ˆçš„ <code>(æ¶ˆæ¯, ç­¾å)</code> å¯¹çš„å­˜åœ¨ï¼Œä½†æ— æ³•æ§åˆ¶å…¶å†…å®¹ã€‚</p><p><strong>è§£å†³æ–¹æ¡ˆï¼šå¯†ç å­¦å¡«å…… (Padding) çš„å¨åŠ›</strong></p><p>ä¸ºäº†é˜»æ­¢è¿™ç§é€†å‘æ”»å‡»ï¼Œç°å®ä¸–ç•Œçš„æ ‡å‡†ï¼ˆå¦‚ <code>PKCS#1</code>ï¼‰å¼•å…¥äº†<strong>å¼ºåˆ¶çš„æ ¼å¼è¦æ±‚</strong>ï¼Œè¿™å°±æ˜¯å¡«å……ã€‚</p><ul><li><p><strong>æµç¨‹ï¼š</strong> åœ¨ç­¾åä¹‹å‰ï¼Œå¿…é¡»å…ˆè®¡ç®—æ¶ˆæ¯çš„å“ˆå¸Œå€¼ <code>H(m)</code>ï¼Œç„¶åå°†å“ˆå¸Œå€¼ä¸å…¶ä»–çº¦å®šå¥½çš„æ•°æ®ï¼ˆå¦‚å›ºå®šå‰ç¼€ï¼‰æ‰“åŒ…æˆä¸€ä¸ª<strong>é«˜åº¦ç»“æ„åŒ–</strong>çš„æ•°æ®å— <code>Formatted_Block</code>ã€‚æœ€åæ‰å¯¹è¿™ä¸ª <code>Formatted_Block</code> è¿›è¡Œç­¾åã€‚</p></li><li><p><strong>å¦‚ä½•æŒ«è´¥æ”»å‡»ï¼š</strong> ç°åœ¨ï¼Œå½“ Eve å†æ¬¡å°è¯•æ”»å‡»æ—¶ï¼Œå¥¹è®¡ç®—å‡ºçš„ <code>m&#39; = (s&#39;)^e mod n</code> <strong>å¿…é¡»</strong>ç¬¦åˆè¿™ä¸ªé¢„å…ˆå®šä¹‰å¥½çš„ã€ä¸¥æ ¼çš„ç»“æ„ã€‚ä¸€ä¸ªéšæœºè®¡ç®—çš„ç»“æœæ°å¥½æ»¡è¶³è¿™ç§å¤æ‚æ ¼å¼çš„æ¦‚ç‡æ˜¯å¾®ä¹å…¶å¾®çš„ï¼Œåœ¨è®¡ç®—ä¸Šå¯ä»¥è®¤ä¸ºæ˜¯ä¸å¯èƒ½çš„ã€‚</p></li></ul><p><strong>ä¸€å¥è¯æ€»ç»“ï¼šå¡«å……æ–¹æ¡ˆæ˜¯ç¡®ä¿RSAåœ¨ç°å®ä¸–ç•Œä¸­å®‰å…¨ä½¿ç”¨çš„ç”Ÿå‘½çº¿ï¼Œç»ä¸å¯çœç•¥ã€‚</strong></p><h2 id="6-ç­¾åæ—¶ä¸è¿›è¡Œå“ˆå¸Œå¯è¡Œå—ï¼Ÿ"><a href="#6-ç­¾åæ—¶ä¸è¿›è¡Œå“ˆå¸Œå¯è¡Œå—ï¼Ÿ" class="headerlink" title="6. ç­¾åæ—¶ä¸è¿›è¡Œå“ˆå¸Œå¯è¡Œå—ï¼Ÿ"></a>6. ç­¾åæ—¶ä¸è¿›è¡Œå“ˆå¸Œå¯è¡Œå—ï¼Ÿ</h2><p>è¿™ä¸ªæ˜¯æˆ‘åœ¨çœ‹SGXä¸­ä½¿ç”¨ç­¾åé˜²æ­¢ç¯¡æ”¹æ—¶æƒ³åˆ°çš„ä¸€ä¸ªé—®é¢˜ã€‚æˆ‘çš„å¥½å¥‡ï¼šå“ˆå¸Œä¿è¯äº†ç­¾åçš„å®‰å…¨ï¼Œè¿˜æ˜¯éå¯¹ç§°åŠ å¯†ï¼Œè¿˜æ˜¯ä¸¤ç§å…±åŒä¿è¯äº†ç­¾åçš„å®‰å…¨ã€‚ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥ä½¿ç”¨ç§é’¥è¿›è¡Œç­¾åï¼Œç„¶åä½¿ç”¨å…¬é’¥éªŒè¯ï¼Ÿï¼ˆå½“æ—¶åœ¨æƒ³è¿™ä¸ªé—®é¢˜çš„æ—¶å€™ï¼Œæˆ‘è¿˜ä¸æ˜¯å¾ˆæ¸…æ¥šå¡«å……ï¼‰ã€‚ä¸è¿‡å³ä½¿åæ¥äº†è§£åˆ°å­˜åœ¨æ€§ä¼ªé€ æ”»å‡»ä¸å¡«å……ï¼Œæˆ‘è¿˜æ˜¯æœ‰ç‚¹ç‚¹ç–‘æƒ‘ã€‚é‚£æˆ‘æŠŠæ•°æ®è¿›è¡Œå¡«å……äº†å‘¢ï¼Ÿ</p><blockquote><p><strong>æˆ‘çš„æ–°é—®é¢˜ï¼š</strong> å¦‚æœæˆ‘çš„åŸå§‹æ•°æ®å·²ç»å¾ˆçŸ­äº†ï¼ˆæ¯”å¦‚ä¸€ä¸ª64å­—èŠ‚çš„IDï¼‰ï¼Œæˆ‘ä¸èƒ½è·³è¿‡å“ˆå¸Œï¼Œç›´æ¥å¯¹å®ƒè¿›è¡Œ**å¡«å……(Padding)**ç„¶åç­¾åå—ï¼Ÿè¿™æ ·æ—¢è§£å†³äº†æ•°æ®é•¿åº¦é—®é¢˜ï¼Œä¹Ÿé€šè¿‡å¡«å……é˜²æ­¢äº†æˆ‘ä»¬ä¹‹å‰è®¨è®ºçš„å­˜åœ¨æ€§ä¼ªé€ æ”»å‡»ã€‚ä»å®‰å…¨è§’åº¦çœ‹ï¼Œè¿™å¯è¡Œå—ï¼Ÿ</p></blockquote><p>å“ˆå“ˆï¼Œæˆ‘é—®äº†AIï¼ˆè±†åŒ…å’Œgemini-2.5ï¼‰è¿™ä¸ªé—®é¢˜ï¼Œå®ƒçš„å›ç­”æ˜¯ï¼šè¿™ä¸ªæƒ³æ³•éå¸¸æ•é”ï¼Œä½†ç­”æ¡ˆæ˜¯ï¼š**å¼ºçƒˆä¸æ¨èï¼Œè¿™æ ·åšä¼šå¼•å…¥ä¸¥é‡çš„å®‰å…¨é£é™©ã€‚è¿‡ç¨‹ä¸­ï¼Œæˆ‘å’Œå¤šä¸ªaiæ¨¡å‹è®¨è®ºäº†è¿™ä¸ªç‚¹ï¼Œå¾ˆå¤šaiåå¤å’Œæˆ‘å¼ºè°ƒå¿…é¡»è¦ä½¿ç”¨å“ˆå¸Œæ¥è¿›è¡Œç­¾åã€‚ä½†æ˜¯ä¸€ç›´æ²¡å›ç­”çš„è¦ç‚¹ä¸Šï¼Œåé¢æˆ‘å‘ç°äº†ç­”æ¡ˆã€‚</p><p>è™½ç„¶â€œå¡«å……åç›´æ¥ç­¾åâ€ç¡®å®å¯ä»¥æŠµå¾¡æœ€åŸºç¡€çš„ä¼ªé€ æ”»å‡»ï¼Œä½†å®ƒå¿½ç•¥äº†å“ˆå¸Œå‡½æ•°åœ¨æ­¤æµç¨‹ä¸­æ‰®æ¼”çš„å¦ä¸€ä¸ªè‡³å…³é‡è¦çš„ã€ä½†æ›´å¾®å¦™çš„è§’è‰²ï¼š<strong>ç ´åæ¶ˆæ¯çš„æ•°å­¦ç»“æ„</strong>ã€‚</p><p>è®©æˆ‘ä»¬çœ‹çœ‹ä¸ºä»€ä¹ˆçœç•¥å“ˆå¸Œæ˜¯å±é™©çš„ï¼š</p><h3 id="6-1-æœªçŸ¥çš„ç»“æ„æ€§æ”»å‡»-Structural-Attacks"><a href="#6-1-æœªçŸ¥çš„ç»“æ„æ€§æ”»å‡»-Structural-Attacks" class="headerlink" title="6.1 æœªçŸ¥çš„ç»“æ„æ€§æ”»å‡» (Structural Attacks)"></a>6.1 æœªçŸ¥çš„ç»“æ„æ€§æ”»å‡» (Structural Attacks)</h3><p>RSAç®—æ³•ä¾èµ–äºæ¨¡å¹‚è¿ç®—ï¼Œè¿™ä¸ªè¿ç®—æœ¬èº«å…·æœ‰ä¸€äº›æ•°å­¦ç‰¹æ€§ï¼ˆä¾‹å¦‚ï¼Œä¹˜æ³•åŒæ€æ€§ï¼š<code>sig(m1) * sig(m2) = sig(m1 * m2)</code>ï¼‰ã€‚è™½ç„¶æˆ‘ä»¬ä½¿ç”¨çš„å¡«å……æ–¹æ¡ˆï¼ˆå¦‚PKCS#1 v1.5ï¼‰æ—¨åœ¨ç ´åè¿™äº›ç‰¹æ€§ï¼Œä½†å®ƒæ˜¯<strong>å›´ç»•ç€ç­¾åä¸€ä¸ªå“ˆå¸Œå€¼</strong>æ¥è®¾è®¡çš„ã€‚</p><p>å¦‚æœè¢«ç­¾åçš„å†…å®¹ä¸æ˜¯ä¸€ä¸ªè¿‘ä¹éšæœºçš„å“ˆå¸Œå€¼ï¼Œè€Œæ˜¯åŒ…å«ç‰¹å®šç»“æ„ï¼ˆæ¯”å¦‚å…¨é›¶çš„å­—èŠ‚ã€é‡å¤çš„åºåˆ—ã€æˆ–è€…ä¸å…¶ä»–æ¶ˆæ¯æœ‰æ•°å­¦å…³è”ï¼‰çš„åŸå§‹æ•°æ®ï¼Œé‚£ä¹ˆå³ä½¿ç»è¿‡äº†å¡«å……ï¼Œä¹Ÿ<strong>å¯èƒ½</strong>å­˜åœ¨ä¸€äº›æœªçŸ¥çš„ã€éå¸¸å·§å¦™çš„æ”»å‡»æ–¹æ³•ï¼Œå¯ä»¥åˆ©ç”¨è¿™äº›åŸå§‹æ•°æ®çš„å†…åœ¨ç»“æ„æ¥ä¼ªé€ ç­¾åã€‚</p><p>å“ˆå¸Œå‡½æ•°åœ¨è¿™é‡Œèµ·åˆ°äº†<strong>â€œéšæœºé¢„å¤„ç†â€</strong>çš„ä½œç”¨ã€‚æ— è®ºä½ çš„åŸå§‹æ•°æ®æ˜¯ä»€ä¹ˆç»“æ„ï¼Œç»è¿‡å“ˆå¸Œåï¼Œéƒ½ä¼šå˜æˆä¸€ä¸²æ¯«æ— è§„å¾‹ã€è¿‘ä¹éšæœºçš„æ¯”ç‰¹ã€‚è¿™ä¸²â€œéšæœºâ€çš„æ•°æ®å†è¢«å¡«å……å’Œç­¾åï¼Œå…¶å®‰å…¨æ€§å°±å¤§å¤§å¢å¼ºäº†ï¼Œå› ä¸ºå®ƒå½»åº•æ¶ˆé™¤äº†åŸå§‹æ•°æ®ç»“æ„å¯èƒ½å¸¦æ¥çš„ä»»ä½•é£é™©ã€‚</p><h3 id="6-2-æ¥è‡ªå†å²çš„æ•™è®­ï¼šå¯†ç å­¦æ ‡å‡†æ›¾å› æ­¤çŠ¯é”™"><a href="#6-2-æ¥è‡ªå†å²çš„æ•™è®­ï¼šå¯†ç å­¦æ ‡å‡†æ›¾å› æ­¤çŠ¯é”™" class="headerlink" title="6.2 æ¥è‡ªå†å²çš„æ•™è®­ï¼šå¯†ç å­¦æ ‡å‡†æ›¾å› æ­¤çŠ¯é”™"></a>6.2 æ¥è‡ªå†å²çš„æ•™è®­ï¼šå¯†ç å­¦æ ‡å‡†æ›¾å› æ­¤çŠ¯é”™</h3><p>è¿™ä¸ä»…ä»…æ˜¯ç†è®ºä¸Šçš„æ‹…å¿§ï¼Œè€Œæ˜¯æœ‰çœŸå®æ¡ˆä¾‹çš„ï¼ˆæ‰çŸ¥é“åŸæ¥ä¸æ˜¯åªæœ‰æˆ‘æƒ³è¿‡è¿™ä¸ªï¼‰ã€‚</p><p>å†å²ä¸Šï¼Œç¡®å®å­˜åœ¨è¿‡ä¸€äº›ä¸ºäº†æ•ˆç‡è€Œè®¾è®¡çš„ç­¾åæ ‡å‡†ï¼ˆå¦‚æ—©æœŸç‰ˆæœ¬çš„ <code>ISO/IEC 9796</code>ï¼Œæˆ‘æœçš„ä¸€äº›èµ„æ–™è¯´çš„å¥½åƒæ˜¯1994ç‰ˆï¼‰ï¼Œå®ƒä»¬å°±é‡‡ç”¨äº†â€œå¡«å……åç›´æ¥ç­¾åçŸ­æ¶ˆæ¯â€çš„æ–¹æ¡ˆã€‚ç„¶è€Œï¼Œåæ¥å¯†ç å­¦å®¶ä»¬å‘ç°äº†é’ˆå¯¹è¿™äº›æ ‡å‡†çš„ä¸¥é‡æ¼æ´ï¼Œè¯æ˜äº†å¯ä»¥åœ¨ä¸çŸ¥é“ç§é’¥çš„æƒ…å†µä¸‹ä¼ªé€ ç­¾åã€‚</p><p>è¿™äº›æ”»å‡»éå¸¸å¤æ‚ï¼Œå®ƒä»¬æ­£æ˜¯åˆ©ç”¨äº†è¢«ç­¾åæ¶ˆæ¯çš„ééšæœºæ€§ï¼ˆå³æ²¡æœ‰ç»è¿‡å“ˆå¸Œå¤„ç†ï¼‰è¿™ä¸ªå¼±ç‚¹ã€‚æœ€ç»ˆï¼Œè¿™äº›æ ‡å‡†ä¸å¾—ä¸è¢«åºŸå¼ƒæˆ–è¿›è¡Œé‡å¤§ä¿®è®¢ã€‚</p><h3 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h3><p>â€œå…ˆå“ˆå¸Œï¼Œå†ç­¾åâ€ (Hash-then-Sign) å¹¶ä¸ä»…ä»…æ˜¯ä¸ºäº†å‹ç¼©æ•°æ®ï¼Œå®ƒæ˜¯ä¸€ä¸ªç»è¿‡äº†æ•°åå¹´ç ”ç©¶å’Œå®æˆ˜æ£€éªŒçš„å®‰å…¨èŒƒå¼ã€‚</p><ul><li><strong>å“ˆå¸Œ</strong>ï¼šè´Ÿè´£å°†ä»»æ„é•¿åº¦ã€ä»»æ„ç»“æ„çš„è¾“å…¥ï¼Œè½¬æ¢ä¸ºä¸€ä¸ªå›ºå®šé•¿åº¦ã€æ— ç»“æ„çš„ã€è¿‘ä¹éšæœºçš„æ‘˜è¦ã€‚</li><li><strong>å¡«å……</strong>ï¼šè´Ÿè´£ä¸ºè¿™ä¸ªæ‘˜è¦æä¾›ä¸€ä¸ªå®‰å…¨çš„ã€æ ‡å‡†åŒ–çš„å°è£…ï¼Œä»¥æŠµå¾¡é’ˆå¯¹RSAç®—æ³•æœ¬èº«çš„æ”»å‡»ã€‚</li><li><strong>ç­¾å</strong>ï¼šå¯¹å¡«å……åçš„æ•°æ®å—æ‰§è¡Œæ ¸å¿ƒçš„éå¯¹ç§°åŠ å¯†æ“ä½œã€‚</li></ul><p>è¿™ä¸‰ä¸ªæ­¥éª¤ç¯ç¯ç›¸æ‰£ï¼Œç¼ºä¸€ä¸å¯ã€‚çœç•¥æ‰å“ˆå¸Œï¼Œå°±ç›¸å½“äºç»•è¿‡äº†å®‰å…¨ä½“ç³»ä¸­çš„ç¬¬ä¸€é“ä¹Ÿæ˜¯è‡³å…³é‡è¦çš„ä¸€é“é˜²çº¿ï¼Œå³ä½¿åé¢çš„é˜²çº¿çœ‹èµ·æ¥å¾ˆåšå›ºï¼Œæ•´ä¸ªä½“ç³»çš„å®‰å…¨æ€§ä¹Ÿä¼šå› æ­¤å—åˆ°æå¤§æŸå®³ã€‚</p><p>æ‰€ä»¥ï¼Œç»“è®ºæ˜¯ï¼š<strong>æ— è®ºåŸå§‹æ•°æ®å¤šçŸ­ï¼Œéƒ½å¿…é¡»å…ˆè¿›è¡Œå“ˆå¸Œï¼Œç„¶åå†è¿›è¡Œå¡«å……å’Œç­¾åã€‚è¿™æ˜¯ç¡®ä¿æ•°å­—ç­¾åå®‰å…¨çš„é»„é‡‘å‡†åˆ™ã€‚</strong></p><hr><p><em>å¯†ç å­¦ç¡®å®æ˜¯ä¸€é—¨å¾ˆç²¾å¦™çš„è‰ºæœ¯ï¼Œå……æ»¡äº†ç¾æ„Ÿ</em></p>]]></content>
      
      
      <categories>
          
          <category> éšç§è®¡ç®— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¯†ç å­¦ </tag>
            
            <tag> RSA </tag>
            
            <tag> éå¯¹ç§°åŠ å¯† </tag>
            
            <tag> æ•°å­—ç­¾å </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HyperEnclaveå†…å­˜ç®¡ç†æ¨¡å—æºç ä¸åŸç†åˆ†æ</title>
      <link href="/2025/07/23/HyperEnclave%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
      <url>/2025/07/23/HyperEnclave%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1 id="HyperEnclaveå†…å­˜ç®¡ç†æ¨¡å—æºç ä¸åŸç†åˆ†æ"><a href="#HyperEnclaveå†…å­˜ç®¡ç†æ¨¡å—æºç ä¸åŸç†åˆ†æ" class="headerlink" title="HyperEnclaveå†…å­˜ç®¡ç†æ¨¡å—æºç ä¸åŸç†åˆ†æ"></a>HyperEnclaveå†…å­˜ç®¡ç†æ¨¡å—æºç ä¸åŸç†åˆ†æ</h1><h2 id="ç›®å½•"><a href="#ç›®å½•" class="headerlink" title="ç›®å½•"></a>ç›®å½•</h2><ol><li><a href="#1-%E6%A6%82%E8%BF%B0"><strong>æ¦‚è¿°</strong></a><ul><li><a href="#%E8%AE%BE%E8%AE%A1%E5%93%B2%E5%AD%A6">è®¾è®¡å“²å­¦</a></li><li><a href="#%E6%A8%A1%E5%9D%97%E7%BB%93%E6%9E%84">æ¨¡å—ç»“æ„</a></li></ul></li><li><a href="#2-%E7%AC%AC%E4%B8%80%E5%B1%82%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-framers"><strong>ç¬¬ä¸€å±‚ï¼šç‰©ç†å†…å­˜ç®¡ç† (<code>frame.rs</code>)</strong></a><ul><li><a href="#%E6%A0%B8%E5%BF%83%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">æ ¸å¿ƒæ•°æ®ç»“æ„</a></li><li><a href="#%E5%88%86%E9%85%8D%E4%B8%8E%E9%87%8A%E6%94%BE">åˆ†é…ä¸é‡Šæ”¾</a></li><li><a href="#%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86">åº•å±‚åŸç†</a></li></ul></li><li><a href="#3-%E7%AC%AC%E4%BA%8C%E5%B1%82%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E4%B8%8E%E6%9D%83%E9%99%90-addrs-modrs"><strong>ç¬¬äºŒå±‚ï¼šè™šæ‹Ÿåœ°å€ä¸æƒé™ (<code>addr.rs</code>, <code>mod.rs</code>)</strong></a><ul><li><a href="#%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E5%AE%9A%E4%B9%89">åœ°å€ç©ºé—´å®šä¹‰</a></li><li><a href="#%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2%E4%B8%8E%E5%8A%A0%E5%AF%86">åœ°å€è½¬æ¢ä¸åŠ å¯†</a></li><li><a href="#%E5%86%85%E5%AD%98%E6%9D%83%E9%99%90%E6%A0%87%E5%BF%97">å†…å­˜æƒé™æ ‡å¿—</a></li></ul></li><li><a href="#4-%E7%AC%AC%E4%B8%89%E5%B1%82%E9%A1%B5%E8%A1%A8%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6-pagingrs"><strong>ç¬¬ä¸‰å±‚ï¼šé¡µè¡¨æ ¸å¿ƒæœºåˆ¶ (<code>paging.rs</code>)</strong></a><ul><li><a href="#%E6%A0%B8%E5%BF%83%E6%8A%BD%E8%B1%A1genericpte">æ ¸å¿ƒæŠ½è±¡ï¼š<code>GenericPTE</code></a></li><li><a href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84level4pagetable">æ•°æ®ç»“æ„ï¼š<code>Level4PageTable</code></a></li><li><a href="#%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3">åœ°å€è½¬æ¢æœºåˆ¶è¯¦è§£</a></li><li><a href="#%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86mmu%E4%B8%8Ecr3">åº•å±‚åŸç†ï¼šMMUä¸CR3</a></li></ul></li><li><a href="#5-%E7%AC%AC%E5%9B%9B%E5%B1%82%E9%AB%98%E7%BA%A7%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84-mmrs-mapperrs"><strong>ç¬¬å››å±‚ï¼šé«˜çº§å†…å­˜æ˜ å°„ (<code>mm.rs</code>, <code>mapper.rs</code>)</strong></a><ul><li><a href="#%E6%A0%B8%E5%BF%83%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-1">æ ¸å¿ƒæ•°æ®ç»“æ„</a></li><li><a href="#%E6%A0%B8%E5%BF%83%E9%80%BB%E8%BE%91memorysetinsert">æ ¸å¿ƒé€»è¾‘ï¼š<code>MemorySet::insert</code></a></li><li><a href="#%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%E4%BB%8Eapi%E5%88%B0%E7%A1%AC%E4%BB%B6">åº•å±‚åŸç†ï¼šä»APIåˆ°ç¡¬ä»¶</a></li></ul></li><li><a href="#6-%E7%AC%AC%E4%BA%94%E5%B1%82enclave%E5%8F%AF%E8%BD%AC%E6%8D%A2%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-cmrrs"><strong>ç¬¬äº”å±‚ï¼šEnclaveå¯è½¬æ¢å†…å­˜ç®¡ç† (<code>cmr.rs</code>)</strong></a><ul><li><a href="#%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3%E5%8F%AF%E8%BD%AC%E6%8D%A2%E5%86%85%E5%AD%98">è®¾è®¡æ€æƒ³ï¼šå¯è½¬æ¢å†…å­˜</a></li><li><a href="#%E6%A0%B8%E5%BF%83%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-2">æ ¸å¿ƒæ•°æ®ç»“æ„</a></li><li><a href="#%E6%A0%B8%E5%BF%83%E9%80%BB%E8%BE%91initialize_cmrm">æ ¸å¿ƒé€»è¾‘ï¼š<code>initialize_cmrm</code></a></li><li><a href="#%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%E5%AE%89%E5%85%A8%E5%86%85%E5%AD%98%E7%9A%84%E5%AE%9E%E7%8E%B0">åº•å±‚åŸç†ï¼šå®‰å…¨å†…å­˜çš„å®ç°</a></li></ul></li><li><a href="#7-%E5%86%85%E5%AD%98%E8%AE%BF%E9%97%AE%E6%B5%81%E7%A8%8B%E5%92%8C%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2%E6%9E%B6%E6%9E%84"><strong>å†…å­˜è®¿é—®æµç¨‹å’Œåœ°å€è½¬æ¢æ¶æ„</strong></a><ul><li><a href="#71-guest%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%86%85%E5%AD%98%E8%AE%BF%E9%97%AE%E6%9C%BA%E5%88%B6">Guestç¨‹åºçš„å†…å­˜è®¿é—®æœºåˆ¶</a></li><li><a href="#72-enclave%E7%A8%8B%E5%BA%8F%E7%9A%84%E5%86%85%E5%AD%98%E8%AE%BF%E9%97%AE%E6%9C%BA%E5%88%B6">Enclaveç¨‹åºçš„å†…å­˜è®¿é—®æœºåˆ¶</a></li><li><a href="#73-%E6%8E%A7%E5%88%B6%E5%B1%82%E6%AC%A1%E5%88%86%E6%9E%90">æ§åˆ¶å±‚æ¬¡åˆ†æ</a></li><li><a href="#74-%E5%86%85%E5%AD%98%E8%AE%BF%E9%97%AE%E7%9A%84%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B%E5%9B%BE">å†…å­˜è®¿é—®çš„å®Œæ•´æµç¨‹å›¾</a></li></ul></li><li><a href="#8-%E6%80%BB%E7%BB%93"><strong>æ€»ç»“</strong></a></li></ol><h2 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h2><blockquote><p>é¡¹ç›®æºç ï¼š<a href="https://github.com/asterinas/hyperenclave">https://github.com/asterinas/hyperenclave</a><br>ç´§æ¥ä¸Šä¸€ç¯‡<a href="https://kongxiaoran.github.io/2025/07/21/HyperEnclave%E5%90%AF%E5%8A%A8%E5%92%8C%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B/">ã€ŠHyperEnclaveå¯åŠ¨å’Œåˆå§‹åŒ–æµç¨‹ã€‹</a>ï¼Œæˆ‘ä»¬ç»§ç»­ä¸€èµ·å­¦ä¹ HyperEnclaveã€‚è¿™æ¬¡æˆ‘ä»¬ä¸»è¦çœ‹çš„æ˜¯HyperEnclaveçš„å†…å­˜ç®¡ç†çš„è®¾è®¡ä¸å®ç°ã€‚è¿™ä¸ªå¯èƒ½æ˜¯HyperEnclaveä¸­æœ€å…³é”®çš„éƒ¨åˆ†äº†ã€‚</p></blockquote><h3 id="è®¾è®¡å“²å­¦"><a href="#è®¾è®¡å“²å­¦" class="headerlink" title="è®¾è®¡å“²å­¦"></a>è®¾è®¡å“²å­¦</h3><p>HyperEnclaveçš„å†…å­˜ç®¡ç†æ¨¡å—æ˜¯å…¶å®‰å…¨æ€§çš„åŸºçŸ³ã€‚å®ƒçš„è®¾è®¡å“²å­¦æ˜¯<strong>åˆ†å±‚æŠ½è±¡</strong>å’Œ<strong>å®‰å…¨éš”ç¦»</strong>ã€‚é€šè¿‡å°†ç‰©ç†å†…å­˜ç®¡ç†ã€é¡µè¡¨æœºåˆ¶å’Œé«˜çº§å†…å­˜æ˜ å°„åˆ†ç¦»å¼€æ¥ï¼Œå®ç°äº†æ¸…æ™°ã€å¯ç»´æŠ¤ä¸”å®‰å…¨çš„ä»£ç ç»“æ„ã€‚</p><p>é‚£æœ€ç»ˆç›®æ ‡å°±æ˜¯ä¸ºæ¯ä¸ªEnclaveæä¾›ä¸€ä¸ªå®Œå…¨ç‹¬ç«‹ã€å—ç¡¬ä»¶ä¿æŠ¤çš„åŠ å¯†åœ°å€ç©ºé—´ã€‚</p><h3 id="æ¨¡å—ç»“æ„"><a href="#æ¨¡å—ç»“æ„" class="headerlink" title="æ¨¡å—ç»“æ„"></a>æ¨¡å—ç»“æ„</h3><p>æˆ‘ä»¬çœ‹src&#x2F;memoryåŒ…ï¼Œå°±å¯ä»¥å‘ç°æ¨¡å—æ–‡ä»¶åŠå…¶èŒè´£çš„ç»„ç»‡ä½“ç°äº†åˆ†å±‚æ€æƒ³ï¼š</p><ul><li><strong>åº•å±‚ç‰©ç†</strong><ul><li><code>frame.rs</code>: ç‰©ç†å†…å­˜é¡µå¸§çš„åˆ†é…ä¸å›æ”¶ã€‚</li></ul></li><li><strong>æ ¸å¿ƒè™šæ‹ŸåŒ–</strong><ul><li><code>addr.rs</code>: åŸºç¡€åœ°å€ç±»å‹çš„å®šä¹‰ä¸è½¬æ¢ã€‚</li><li><code>paging.rs</code>: è™šæ‹Ÿå†…å­˜çš„æ ¸å¿ƒï¼Œå®ç°å¤šçº§é¡µè¡¨ã€‚</li></ul></li><li><strong>é«˜å±‚æŠ½è±¡</strong><ul><li><code>mm.rs</code> &amp; <code>mapper.rs</code>: å°†é¡µè¡¨å’Œç‰©ç†å¸§ç»„åˆæˆæ˜“äºä½¿ç”¨çš„å†…å­˜æ˜ å°„APIã€‚</li></ul></li><li><strong>ä¸“ç”¨åŠŸèƒ½</strong><ul><li><code>cmr.rs</code>: Enclaveå®‰å…¨é¡µç¼“å­˜ï¼ˆEPCï¼‰çš„ç‰¹æ®Šç®¡ç†ã€‚</li><li><code>heap.rs</code>: Hypervisorè‡ªèº«çš„å †å†…å­˜ã€‚</li><li><code>gaccess.rs</code>: å®‰å…¨çš„Guestå†…å­˜è®¿é—®æ¥å£ã€‚</li></ul></li></ul><h2 id="2-ç¬¬ä¸€å±‚ï¼šç‰©ç†å†…å­˜ç®¡ç†-frame-rs"><a href="#2-ç¬¬ä¸€å±‚ï¼šç‰©ç†å†…å­˜ç®¡ç†-frame-rs" class="headerlink" title="2. ç¬¬ä¸€å±‚ï¼šç‰©ç†å†…å­˜ç®¡ç† (frame.rs)"></a>2. ç¬¬ä¸€å±‚ï¼šç‰©ç†å†…å­˜ç®¡ç† (<code>frame.rs</code>)</h2><p>è¿™æ˜¯æœ€åº•å±‚ï¼Œè´Ÿè´£ç®¡ç†Hypervisoræ‹¥æœ‰çš„æ‰€æœ‰ç‰©ç†å†…å­˜ã€‚</p><h3 id="æ ¸å¿ƒæ•°æ®ç»“æ„"><a href="#æ ¸å¿ƒæ•°æ®ç»“æ„" class="headerlink" title="æ ¸å¿ƒæ•°æ®ç»“æ„"></a>æ ¸å¿ƒæ•°æ®ç»“æ„</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/memory/frame.rs:35-45</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">FrameAllocator</span> &#123;</span><br><span class="line">    base: PhysAddr,</span><br><span class="line">    inner: FrameAlloc, <span class="comment">// BitAlloc1M</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Frame</span> &#123;</span><br><span class="line">    start_paddr: PhysAddr,</span><br><span class="line">    frame_count: <span class="type">usize</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>FrameAllocator</code>: å…¨å±€å”¯ä¸€çš„ç‰©ç†å¸§åˆ†é…å™¨ï¼Œä½¿ç”¨<code>bitmap_allocator</code>åº“ï¼ˆä¸€ä¸ªä½å›¾åˆ†é…å™¨ï¼‰æ¥è·Ÿè¸ªå“ªäº›4Kç‰©ç†é¡µå¸§æ˜¯ç©ºé—²çš„ã€‚</li><li><code>Frame</code>: ä»£è¡¨ä¸€ä¸ªæˆ–å¤šä¸ªè¿ç»­çš„ã€å·²åˆ†é…çš„ç‰©ç†é¡µå¸§ã€‚å®ƒæ˜¯ä¸€ä¸ªæ‰€æœ‰æƒå¥æŸ„ï¼Œå½“<code>Frame</code>å¯¹è±¡è¢«<code>drop</code>æ—¶ï¼Œå…¶å ç”¨çš„ç‰©ç†å†…å­˜ä¼šè‡ªåŠ¨é‡Šæ”¾ã€‚</li></ul><h3 id="åˆ†é…ä¸é‡Šæ”¾"><a href="#åˆ†é…ä¸é‡Šæ”¾" class="headerlink" title="åˆ†é…ä¸é‡Šæ”¾"></a>åˆ†é…ä¸é‡Šæ”¾</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/memory/frame.rs:60-85</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">FrameAllocator</span> &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">alloc</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;PhysAddr&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">ret</span> = <span class="keyword">self</span>.inner.<span class="title function_ invoke__">alloc</span>().<span class="title function_ invoke__">map</span>(|idx| idx * PAGE_SIZE + <span class="keyword">self</span>.base);</span><br><span class="line">        trace!(<span class="string">&quot;Allocate frame: &#123;:x?&#125;&quot;</span>, ret);</span><br><span class="line">        ret</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">dealloc</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, target: PhysAddr) &#123;</span><br><span class="line">        trace!(<span class="string">&quot;Deallocate frame: &#123;:x&#125;&quot;</span>, target);</span><br><span class="line">        <span class="keyword">self</span>.inner.<span class="title function_ invoke__">dealloc</span>((target - <span class="keyword">self</span>.base) / PAGE_SIZE)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>alloc</code>åœ¨ä½å›¾ä¸­æ‰¾åˆ°ä¸€ä¸ªç©ºé—²ä½ï¼Œå°†å…¶æ ‡è®°ä¸ºå·²ä½¿ç”¨ï¼Œå¹¶è®¡ç®—å‡ºå¯¹åº”çš„ç‰©ç†åœ°å€è¿”å›ã€‚<code>dealloc</code>åˆ™æ‰§è¡Œç›¸åæ“ä½œã€‚</p><h3 id="åº•å±‚åŸç†"><a href="#åº•å±‚åŸç†" class="headerlink" title="åº•å±‚åŸç†"></a>åº•å±‚åŸç†</h3><p>è¿™ä¸€å±‚ä¸æ¶‰åŠè™šæ‹Ÿåœ°å€æˆ–CPUç‰¹æ€§ï¼Œå®ƒä»…ä»…æ˜¯å¯¹ä¸€å—ç‰©ç†å†…å­˜è¿›è¡Œè½¯ä»¶å±‚é¢çš„ç°¿è®°(bookkeeping)ã€‚ä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆä¸€ä¸ªç®€åŒ–çš„<code>malloc</code>&#x2F;<code>free</code>ï¼Œä½†æ“ä½œå¯¹è±¡æ˜¯å›ºå®šå¤§å°ï¼ˆ4KBï¼‰çš„ç‰©ç†å†…å­˜é¡µå¸§ã€‚</p><h2 id="3-ç¬¬äºŒå±‚ï¼šè™šæ‹Ÿåœ°å€ä¸æƒé™-addr-rs-mod-rs"><a href="#3-ç¬¬äºŒå±‚ï¼šè™šæ‹Ÿåœ°å€ä¸æƒé™-addr-rs-mod-rs" class="headerlink" title="3. ç¬¬äºŒå±‚ï¼šè™šæ‹Ÿåœ°å€ä¸æƒé™ (addr.rs, mod.rs)"></a>3. ç¬¬äºŒå±‚ï¼šè™šæ‹Ÿåœ°å€ä¸æƒé™ (<code>addr.rs</code>, <code>mod.rs</code>)</h2><p>è¿™ä¸€å±‚å®šä¹‰äº†å†…å­˜æ“ä½œçš„åŸºç¡€å•ä½å’Œè§„åˆ™ã€‚</p><h3 id="åœ°å€ç©ºé—´å®šä¹‰"><a href="#åœ°å€ç©ºé—´å®šä¹‰" class="headerlink" title="åœ°å€ç©ºé—´å®šä¹‰"></a>åœ°å€ç©ºé—´å®šä¹‰</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/memory/addr.rs:18-25</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">type</span> <span class="title class_">VirtAddr</span> = <span class="type">usize</span>;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">type</span> <span class="title class_">PhysAddr</span> = <span class="type">usize</span>;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">type</span> <span class="title class_">GuestVirtAddr</span> = <span class="type">usize</span>;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">type</span> <span class="title class_">GuestPhysAddr</span> = <span class="type">usize</span>;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ç±»å‹åˆ«ååŒºåˆ†äº†ä¸åŒä¸Šä¸‹æ–‡ä¸­çš„åœ°å€ï¼Œå¢å¼ºäº†ä»£ç çš„å¯è¯»æ€§å’Œå®‰å…¨æ€§ï¼ˆæŒºæœ‰æ„æ€çš„ï¼‰</p><h3 id="åœ°å€è½¬æ¢ä¸åŠ å¯†"><a href="#åœ°å€è½¬æ¢ä¸åŠ å¯†" class="headerlink" title="åœ°å€è½¬æ¢ä¸åŠ å¯†"></a>åœ°å€è½¬æ¢ä¸åŠ å¯†</h3><p>HyperEnclaveä¸­å­˜åœ¨ä¸¤ç§ä¸åŒçš„åœ°å€è½¬æ¢æœºåˆ¶ï¼Œä»¥åŠä¸€ç§åœ°å€åŠ å¯†æ ‡è®°æœºåˆ¶ï¼š</p><h4 id="åœºæ™¯ä¸€ï¼šHypervisorè‡ªèº«å†…å­˜çš„çº¿æ€§åœ°å€è½¬æ¢"><a href="#åœºæ™¯ä¸€ï¼šHypervisorè‡ªèº«å†…å­˜çš„çº¿æ€§åœ°å€è½¬æ¢" class="headerlink" title="åœºæ™¯ä¸€ï¼šHypervisorè‡ªèº«å†…å­˜çš„çº¿æ€§åœ°å€è½¬æ¢"></a><strong>åœºæ™¯ä¸€ï¼šHypervisorè‡ªèº«å†…å­˜çš„çº¿æ€§åœ°å€è½¬æ¢</strong></h4><p>å¯¹äºHypervisorè‡ªèº«ä»£ç å’Œæ•°æ®çš„å†…å­˜ï¼Œå®ƒé‡‡ç”¨çš„æ˜¯ä¸€ç§ç®€å•çš„<strong>çº¿æ€§æ˜ å°„</strong>ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/memory/addr.rs:27-32</span></span><br><span class="line">lazy_static! &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">ref</span> PHYS_VIRT_OFFSET: <span class="type">usize</span> = HV_BASE</span><br><span class="line">        - crate::config::HvSystemConfig::<span class="title function_ invoke__">get</span>()</span><br><span class="line">            .hypervisor_memory</span><br><span class="line">            .phys_start <span class="keyword">as</span> <span class="type">usize</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// src/memory/addr.rs:41-43</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">virt_to_phys</span>(vaddr: VirtAddr) <span class="punctuation">-&gt;</span> PhysAddr &#123;</span><br><span class="line">    vaddr - *PHYS_VIRT_OFFSET</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// src/memory/addr.rs:45-47</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">phys_to_virt</span>(paddr: PhysAddr) <span class="punctuation">-&gt;</span> VirtAddr &#123;</span><br><span class="line">    (paddr &amp; (SME_C_BIT_OFFSET.<span class="title function_ invoke__">wrapping_sub</span>(<span class="number">1</span>))) + *PHYS_VIRT_OFFSET</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å®ç°åŸç†ï¼š</strong></p><ol><li><code>PHYS_VIRT_OFFSET</code>: è¿™æ˜¯ä¸€ä¸ªåœ¨Hypervisorå¯åŠ¨æ—¶è®¡ç®—å¥½çš„<strong>å›ºå®šåç§»é‡</strong>ï¼Œä»£è¡¨äº†Hypervisorçš„è™šæ‹Ÿåœ°å€åŸºå€ (<code>HV_BASE</code>) å’Œå®ƒåœ¨ç‰©ç†å†…å­˜ä¸­çš„åŠ è½½åœ°å€ä¹‹é—´çš„å·®å€¼ã€‚</li><li><strong>è½¬æ¢è¿‡ç¨‹</strong>: <code>virt_to_phys</code>å‡½æ•°ç”¨è™šæ‹Ÿåœ°å€å‡å»è¿™ä¸ªå›ºå®šçš„åç§»é‡ï¼Œä»è€Œå¾—åˆ°ç‰©ç†åœ°å€ï¼›<code>phys_to_virt</code>åˆ™æ‰§è¡Œç›¸åæ“ä½œï¼Œå¹¶ä¸”è¿‡æ»¤æ‰SMEçš„C-bitã€‚</li></ol><p><strong>ä½¿ç”¨åœºæ™¯</strong>: è¿™ç§æ–¹æ³•<strong>ä»…ç”¨äºHypervisorè‡ªèº«çš„åœ°å€ç©ºé—´</strong>ï¼Œå› ä¸ºå®ƒç®€å•ã€é«˜æ•ˆï¼Œå¹¶ä¸”Hypervisorçš„å†…å­˜å¸ƒå±€åœ¨å¯åŠ¨åæ˜¯å›ºå®šçš„ã€‚</p><h4 id="åœºæ™¯äºŒï¼šGuestè™šæ‹Ÿæœºçš„é€šç”¨åœ°å€è½¬æ¢"><a href="#åœºæ™¯äºŒï¼šGuestè™šæ‹Ÿæœºçš„é€šç”¨åœ°å€è½¬æ¢" class="headerlink" title="åœºæ™¯äºŒï¼šGuestè™šæ‹Ÿæœºçš„é€šç”¨åœ°å€è½¬æ¢"></a><strong>åœºæ™¯äºŒï¼šGuestè™šæ‹Ÿæœºçš„é€šç”¨åœ°å€è½¬æ¢</strong></h4><p>å¯¹äºGuestçš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼ˆåŒ…æ‹¬Enclaveï¼‰ï¼Œæƒ…å†µè¦å¤æ‚å¾—å¤šï¼Œå› ä¸ºå®ƒéœ€è¦æ”¯æŒä»»æ„çš„ã€éçº¿æ€§çš„æ˜ å°„ã€‚è¿™ä¾èµ–äº<strong>å¤šçº§é¡µè¡¨</strong>æœºåˆ¶ã€‚</p><p><strong>å…³é”®æ¥å£ï¼š</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/memory/paging.rs:217-230</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">GenericPageTableImmut</span>: <span class="built_in">Sized</span> &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">VA</span>: <span class="built_in">From</span>&lt;<span class="type">usize</span>&gt; + <span class="built_in">Into</span>&lt;<span class="type">usize</span>&gt; + <span class="built_in">Copy</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// éå†é¡µè¡¨è·å–æœ‰æ•ˆçš„æ˜ å°„ä¿¡æ¯</span></span><br><span class="line">    <span class="comment">/// è¿”å›ï¼š(ç‰©ç†åœ°å€, å†…å­˜æ ‡å¿—, é¡µé¢å¤§å°)</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">query</span>(&amp;<span class="keyword">self</span>, vaddr: <span class="keyword">Self</span>::VA) <span class="punctuation">-&gt;</span> PagingResult&lt;(PhysAddr, MemFlags, PageSize)&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ç§åœ°å€è½¬æ¢é€šè¿‡<strong>å¤šçº§é¡µè¡¨éå†</strong>å®ç°ï¼Œè¯¦ç»†æœºåˆ¶å°†åœ¨ç¬¬ä¸‰å±‚ï¼ˆé¡µè¡¨æ ¸å¿ƒæœºåˆ¶ï¼‰ä¸­è¯¦ç»†ä»‹ç»ã€‚</p><h4 id="ç‰©ç†åœ°å€çš„ç¡¬ä»¶åŠ å¯†æ ‡è®°"><a href="#ç‰©ç†åœ°å€çš„ç¡¬ä»¶åŠ å¯†æ ‡è®°" class="headerlink" title="ç‰©ç†åœ°å€çš„ç¡¬ä»¶åŠ å¯†æ ‡è®°"></a><strong>ç‰©ç†åœ°å€çš„ç¡¬ä»¶åŠ å¯†æ ‡è®°</strong></h4><p>é™¤äº†åœ°å€è½¬æ¢ï¼ŒHyperEnclaveè¿˜æä¾›äº†åœ°å€åŠ å¯†æ ‡è®°åŠŸèƒ½ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/memory/addr.rs:35-37</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">phys_encrypted</span>(paddr: PhysAddr) <span class="punctuation">-&gt;</span> PhysAddr &#123;</span><br><span class="line">    paddr | SME_C_BIT_OFFSET</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ³¨æ„</strong>: è¿™<strong>ä¸æ˜¯åœ°å€è½¬æ¢</strong>ï¼Œè€Œæ˜¯<strong>åœ°å€åŠ å¯†æ ‡è®°</strong>ã€‚<code>phys_encrypted</code> å‡½æ•°çš„ä½œç”¨æ˜¯ä¸ºä¸€ä¸ªç‰©ç†åœ°å€å¯ç”¨ç¡¬ä»¶å†…å­˜åŠ å¯†ã€‚å®ƒé€šè¿‡åœ¨ç‰©ç†åœ°å€ä¸Šè®¾ç½®ä¸€ä¸ªç‰¹æ®Šçš„æ ‡å¿—ä½ï¼ˆC-bitï¼‰ï¼Œå‘Šè¯‰CPUçš„å†…å­˜æ§åˆ¶å™¨å¯¹è¯¥åœ°å€çš„è®¿é—®è¿›è¡ŒåŠ è§£å¯†æ“ä½œã€‚</p><ul><li><p><strong>AMD SME (Secure Memory Encryption)</strong>: è¿™æ˜¯AMDå¤„ç†å™¨æä¾›çš„ä¸€é¡¹ç¡¬ä»¶å®‰å…¨åŠŸèƒ½ã€‚å½“å¯ç”¨SMEåï¼ŒCPUçš„å†…å­˜æ§åˆ¶å™¨ä¼šåœ¨æ•°æ®ç¦»å¼€CPUèŠ¯ç‰‡å†™å…¥å†…å­˜æ—¶è‡ªåŠ¨åŠ å¯†ï¼Œåœ¨æ•°æ®ä»å†…å­˜è¯»å…¥CPUæ—¶è‡ªåŠ¨è§£å¯†ã€‚</p></li><li><p><strong>C-bit (Encryption Bit)</strong>: AMDåœ¨ç‰©ç†åœ°å€æ€»çº¿ä¸Šå¢åŠ äº†ä¸€ä¸ªé¢å¤–çš„ä½ï¼Œç§°ä¸ºC-bitï¼ˆCrypto-bitï¼‰ã€‚å¦‚æœä¸€ä¸ªç‰©ç†åœ°å€çš„C-bitè¢«è®¾ç½®ä¸º1ï¼Œå†…å­˜æ§åˆ¶å™¨å°±ä¼šå¯¹è¯¥åœ°å€çš„è®¿é—®æ‰§è¡ŒåŠ è§£å¯†æ“ä½œã€‚</p></li></ul><h3 id="å†…å­˜æƒé™æ ‡å¿—"><a href="#å†…å­˜æƒé™æ ‡å¿—" class="headerlink" title="å†…å­˜æƒé™æ ‡å¿—"></a>å†…å­˜æƒé™æ ‡å¿—</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/memory/mod.rs:45-60</span></span><br><span class="line"><span class="built_in">bitflags!</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">MemFlags</span>: <span class="type">u64</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> READ          = <span class="number">1</span> &lt;&lt; <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">const</span> WRITE         = <span class="number">1</span> &lt;&lt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">const</span> EXECUTE       = <span class="number">1</span> &lt;&lt; <span class="number">2</span>;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">const</span> ENCRYPTED     = <span class="number">1</span> &lt;&lt; <span class="number">10</span>;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>åº•å±‚åŸç†</strong>: <code>MemFlags</code>ä¸­çš„æ¯ä¸€ä½éƒ½ç›´æ¥å¯¹åº”x86-64é¡µè¡¨é¡¹ï¼ˆPTEï¼‰ä¸­çš„ä¸€ä¸ªæ§åˆ¶ä½ã€‚ä¾‹å¦‚ï¼š<ul><li><code>READ</code> | <code>WRITE</code> å¯¹åº” <code>R/W</code> (Read&#x2F;Write) ä½ã€‚</li><li><code>EXECUTE</code> å¯¹åº” <code>XD</code> (Execute Disable) ä½ï¼ˆé€»è¾‘ç›¸åï¼‰ã€‚</li><li><code>USER</code> å¯¹åº” <code>U/S</code> (User&#x2F;Supervisor) ä½ã€‚<br>å½“åˆ›å»ºé¡µè¡¨é¡¹æ—¶ï¼Œè¿™äº›æ ‡å¿—ä½ä¼šè¢«ç»„åˆå¹¶å†™å…¥PTEçš„ç¡¬ä»¶ç»“æ„ä¸­ï¼Œç”±CPUçš„MMUå¼ºåˆ¶æ‰§è¡Œã€‚</li></ul></li></ul><h2 id="4-ç¬¬ä¸‰å±‚ï¼šé¡µè¡¨æ ¸å¿ƒæœºåˆ¶-paging-rs"><a href="#4-ç¬¬ä¸‰å±‚ï¼šé¡µè¡¨æ ¸å¿ƒæœºåˆ¶-paging-rs" class="headerlink" title="4. ç¬¬ä¸‰å±‚ï¼šé¡µè¡¨æ ¸å¿ƒæœºåˆ¶ (paging.rs)"></a>4. ç¬¬ä¸‰å±‚ï¼šé¡µè¡¨æ ¸å¿ƒæœºåˆ¶ (<code>paging.rs</code>)</h2><p>è¿™æ˜¯å†…å­˜è™šæ‹ŸåŒ–çš„æ ¸å¿ƒï¼Œå®ç°äº†å°†è™šæ‹Ÿåœ°å€ç¿»è¯‘æˆç‰©ç†åœ°å€çš„æœºåˆ¶ã€‚</p><h3 id="æ ¸å¿ƒæŠ½è±¡ï¼šGenericPTE"><a href="#æ ¸å¿ƒæŠ½è±¡ï¼šGenericPTE" class="headerlink" title="æ ¸å¿ƒæŠ½è±¡ï¼šGenericPTE"></a>æ ¸å¿ƒæŠ½è±¡ï¼š<code>GenericPTE</code></h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/memory/paging.rs:166-203</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">GenericPTE</span>: <span class="built_in">Debug</span> + <span class="built_in">Clone</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">addr</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> PhysAddr;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">flags</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> MemFlags;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">is_present</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">bool</span>;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">set_addr</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, paddr: PhysAddr);</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">set_flags</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, flags: MemFlags, is_huge: <span class="type">bool</span>) <span class="punctuation">-&gt;</span> PagingResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªtraitæ˜¯HyperEnclaveé¡µè¡¨å®ç°çš„ç²¾é«“ã€‚å®ƒå®šä¹‰äº†ä¸€ä¸ªé¡µè¡¨é¡¹ï¼ˆPTEï¼‰å¿…é¡»å…·å¤‡çš„é€šç”¨è¡Œä¸ºï¼Œå°†ä¸Šå±‚é€»è¾‘ä¸å…·ä½“ç¡¬ä»¶ï¼ˆå¦‚Intel EPTæˆ–AMD NPTï¼‰çš„PTEæ ¼å¼è§£è€¦ã€‚</p><h3 id="æ•°æ®ç»“æ„ï¼šLevel4PageTable"><a href="#æ•°æ®ç»“æ„ï¼šLevel4PageTable" class="headerlink" title="æ•°æ®ç»“æ„ï¼šLevel4PageTable"></a>æ•°æ®ç»“æ„ï¼š<code>Level4PageTable</code></h3><p>HyperEnclaveä½¿ç”¨ä¸€ä¸ª4çº§é¡µè¡¨ç»“æ„æ¥ç®¡ç†åœ°å€ç©ºé—´ï¼Œè¿™ä¸x86-64æ¶æ„ç›¸åŒ¹é…ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/memory/paging.rs:691-696</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Level4PageTable</span>&lt;VA, PTE: GenericPTE, I: PagingInstr&gt; &#123;</span><br><span class="line">    inner: Level4PageTableUnlocked&lt;VA, PTE, I&gt;,</span><br><span class="line">    clonee_lock: Arc&lt;Mutex&lt;()&gt;&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åœ°å€è½¬æ¢æœºåˆ¶è¯¦è§£"><a href="#åœ°å€è½¬æ¢æœºåˆ¶è¯¦è§£" class="headerlink" title="åœ°å€è½¬æ¢æœºåˆ¶è¯¦è§£"></a>åœ°å€è½¬æ¢æœºåˆ¶è¯¦è§£</h3><p>HyperEnclaveçš„åœ°å€è½¬æ¢æ˜¯é€šè¿‡å¤šçº§é¡µè¡¨éå†å®ç°çš„ï¼Œè¿™æ˜¯<strong>ç°ä»£æ“ä½œç³»ç»Ÿå†…å­˜ç®¡ç†çš„æ ¸å¿ƒ</strong>ã€‚</p><h4 id="è™šæ‹Ÿåœ°å€ç´¢å¼•æå–"><a href="#è™šæ‹Ÿåœ°å€ç´¢å¼•æå–" class="headerlink" title="è™šæ‹Ÿåœ°å€ç´¢å¼•æå–"></a><strong>è™šæ‹Ÿåœ°å€ç´¢å¼•æå–</strong></h4><p>é¦–å…ˆï¼Œç³»ç»Ÿéœ€è¦ä»64ä½è™šæ‹Ÿåœ°å€ä¸­æå–å„çº§é¡µè¡¨çš„ç´¢å¼•ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/memory/paging.rs:865-880</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">fn</span> <span class="title function_">p4_index</span>(vaddr: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">    (vaddr &gt;&gt; (<span class="number">12</span> + <span class="number">27</span>)) &amp; (ENTRY_COUNT - <span class="number">1</span>)  <span class="comment">// æå– [47:39] ä½</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">fn</span> <span class="title function_">p3_index</span>(vaddr: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">    (vaddr &gt;&gt; (<span class="number">12</span> + <span class="number">18</span>)) &amp; (ENTRY_COUNT - <span class="number">1</span>)  <span class="comment">// æå– [38:30] ä½</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">fn</span> <span class="title function_">p2_index</span>(vaddr: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">    (vaddr &gt;&gt; (<span class="number">12</span> + <span class="number">9</span>)) &amp; (ENTRY_COUNT - <span class="number">1</span>)   <span class="comment">// æå– [29:21] ä½</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">fn</span> <span class="title function_">p1_index</span>(vaddr: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">    (vaddr &gt;&gt; <span class="number">12</span>) &amp; (ENTRY_COUNT - <span class="number">1</span>)         <span class="comment">// æå– [20:12] ä½</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>åœ°å€åˆ†è§£åŸç†ï¼š</strong></p><ul><li>x86-64çš„64ä½è™šæ‹Ÿåœ°å€è¢«åˆ†ä¸º5ä¸ªéƒ¨åˆ†ï¼š<ul><li><strong>[63:48]</strong>: ç¬¦å·æ‰©å±•ä½ï¼ˆå¿…é¡»ä¸ç¬¬47ä½ç›¸åŒï¼‰</li><li><strong>[47:39]</strong>: L4é¡µè¡¨ç´¢å¼•ï¼ˆ9ä½ï¼Œ512ä¸ªæ¡ç›®ï¼‰</li><li><strong>[38:30]</strong>: L3é¡µè¡¨ç´¢å¼•ï¼ˆ9ä½ï¼Œ512ä¸ªæ¡ç›®ï¼‰</li><li><strong>[29:21]</strong>: L2é¡µè¡¨ç´¢å¼•ï¼ˆ9ä½ï¼Œ512ä¸ªæ¡ç›®ï¼‰</li><li><strong>[20:12]</strong>: L1é¡µè¡¨ç´¢å¼•ï¼ˆ9ä½ï¼Œ512ä¸ªæ¡ç›®ï¼‰</li><li><strong>[11:0]</strong>: é¡µå†…åç§»ï¼ˆ12ä½ï¼Œ4KBé¡µé¢ï¼‰</li></ul></li></ul><h4 id="é¡µè¡¨éå†æ ¸å¿ƒé€»è¾‘"><a href="#é¡µè¡¨éå†æ ¸å¿ƒé€»è¾‘" class="headerlink" title="é¡µè¡¨éå†æ ¸å¿ƒé€»è¾‘"></a><strong>é¡µè¡¨éå†æ ¸å¿ƒé€»è¾‘</strong></h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/memory/paging.rs:280-318</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">get_entry_mut_internal</span>(&amp;<span class="keyword">self</span>, vaddr: VA) <span class="punctuation">-&gt;</span> PagingResult&lt;(&amp;<span class="keyword">mut</span> PTE, PageTableLevel)&gt; &#123;</span><br><span class="line">    <span class="keyword">use</span> PageTableLevel::*;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">vaddr</span> = vaddr.<span class="title function_ invoke__">into</span>();</span><br><span class="line">    <span class="comment">// 1. ä»L4é¡µè¡¨æ ¹å¼€å§‹ï¼ˆç›¸å½“äºä»CR3å¯„å­˜å™¨è·å–åœ°å€ï¼‰</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p4</span> = table_of_mut::&lt;PTE&gt;(<span class="keyword">self</span>.<span class="title function_ invoke__">root_paddr</span>());</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p4e</span> = &amp;<span class="keyword">mut</span> p4[<span class="title function_ invoke__">p4_index</span>(vaddr)];</span><br><span class="line">    <span class="keyword">if</span> p4e.<span class="title function_ invoke__">is_unused</span>() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Ok</span>((p4e, L4));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> !p4e.<span class="title function_ invoke__">is_present</span>() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(PagingError::UnexpectedError);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. è¿›å…¥L3é¡µè¡¨</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p3</span> = table_of_mut::&lt;PTE&gt;(p4e.<span class="title function_ invoke__">addr</span>());</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p3e</span> = &amp;<span class="keyword">mut</span> p3[<span class="title function_ invoke__">p3_index</span>(vaddr)];</span><br><span class="line">    <span class="keyword">if</span> p3e.<span class="title function_ invoke__">is_unused</span>() || p3e.<span class="title function_ invoke__">is_leaf</span>() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Ok</span>((p3e, L3));  <span class="comment">// å¯èƒ½æ˜¯1GBå¤§é¡µ</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> !p3e.<span class="title function_ invoke__">is_present</span>() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(PagingError::UnexpectedError);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. è¿›å…¥L2é¡µè¡¨</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p2</span> = table_of_mut::&lt;PTE&gt;(p2e.<span class="title function_ invoke__">addr</span>());</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p2e</span> = &amp;<span class="keyword">mut</span> p2[<span class="title function_ invoke__">p2_index</span>(vaddr)];</span><br><span class="line">    <span class="keyword">if</span> p2e.<span class="title function_ invoke__">is_unused</span>() || p2e.<span class="title function_ invoke__">is_leaf</span>() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Ok</span>((p2e, L2));  <span class="comment">// å¯èƒ½æ˜¯2MBå¤§é¡µ</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> !p2e.<span class="title function_ invoke__">is_present</span>() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(PagingError::UnexpectedError);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. è¿›å…¥L1é¡µè¡¨ï¼ˆæœ€ç»ˆçº§åˆ«ï¼‰</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p1</span> = table_of_mut::&lt;PTE&gt;(p2e.<span class="title function_ invoke__">addr</span>());</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">p1e</span> = &amp;<span class="keyword">mut</span> p1[<span class="title function_ invoke__">p1_index</span>(vaddr)];</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>((p1e, L1))  <span class="comment">// 4KBé¡µé¢</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="åœ°å€æŸ¥è¯¢æ¥å£"><a href="#åœ°å€æŸ¥è¯¢æ¥å£" class="headerlink" title="åœ°å€æŸ¥è¯¢æ¥å£"></a><strong>åœ°å€æŸ¥è¯¢æ¥å£</strong></h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/memory/paging.rs:217-230</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">GenericPageTableImmut</span>: <span class="built_in">Sized</span> &#123;</span><br><span class="line">    <span class="keyword">type</span> <span class="title class_">VA</span>: <span class="built_in">From</span>&lt;<span class="type">usize</span>&gt; + <span class="built_in">Into</span>&lt;<span class="type">usize</span>&gt; + <span class="built_in">Copy</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">from_root</span>(root_paddr: PhysAddr) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span>;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">root_paddr</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> PhysAddr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// éå†é¡µè¡¨è·å–æœ‰æ•ˆçš„æ˜ å°„ä¿¡æ¯</span></span><br><span class="line">    <span class="comment">/// è¿”å›ï¼š(ç‰©ç†åœ°å€, å†…å­˜æ ‡å¿—, é¡µé¢å¤§å°)</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">query</span>(&amp;<span class="keyword">self</span>, vaddr: <span class="keyword">Self</span>::VA) <span class="punctuation">-&gt;</span> PagingResult&lt;(PhysAddr, MemFlags, PageSize)&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>queryå‡½æ•°çš„å®ç°ï¼š</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/memory/paging.rs:406-420</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">query</span>(&amp;<span class="keyword">self</span>, vaddr: VA) <span class="punctuation">-&gt;</span> PagingResult&lt;(PhysAddr, MemFlags, PageSize)&gt; &#123;</span><br><span class="line">    <span class="comment">// 1. è·å–é¡µè¡¨é¡¹å’Œçº§åˆ«</span></span><br><span class="line">    <span class="keyword">let</span> (entry, level) = <span class="keyword">self</span>.<span class="title function_ invoke__">get_entry_mut_internal</span>(vaddr)?;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. æ£€æŸ¥é¡µè¡¨é¡¹æ˜¯å¦è¢«ä½¿ç”¨</span></span><br><span class="line">    <span class="keyword">if</span> entry.<span class="title function_ invoke__">is_unused</span>() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(PagingError::<span class="title function_ invoke__">NotMapped</span>(vaddr.<span class="title function_ invoke__">into</span>()));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. è·å–é¡µé¢å¤§å°</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">size</span> = level.<span class="title function_ invoke__">page_size</span>()?;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. æ£€æŸ¥é¡µè¡¨é¡¹æ˜¯å¦æœ‰æ•ˆï¼ˆPresentä½ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> !entry.<span class="title function_ invoke__">is_present</span>() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(PagingError::<span class="title function_ invoke__">NotPresent</span>((</span><br><span class="line">            vaddr.<span class="title function_ invoke__">into</span>(),</span><br><span class="line">            entry.<span class="title function_ invoke__">addr</span>(),</span><br><span class="line">            entry.<span class="title function_ invoke__">flags</span>(),</span><br><span class="line">            size,</span><br><span class="line">        )));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. è®¡ç®—æœ€ç»ˆç‰©ç†åœ°å€ = é¡µé¢åŸºå€ + é¡µå†…åç§»</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">off</span> = size.<span class="title function_ invoke__">page_offset</span>(vaddr.<span class="title function_ invoke__">into</span>());</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>((entry.<span class="title function_ invoke__">addr</span>() + off, entry.<span class="title function_ invoke__">flags</span>(), size))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="åœ°å€è½¬æ¢å®Œæ•´æµç¨‹"><a href="#åœ°å€è½¬æ¢å®Œæ•´æµç¨‹" class="headerlink" title="åœ°å€è½¬æ¢å®Œæ•´æµç¨‹"></a><strong>åœ°å€è½¬æ¢å®Œæ•´æµç¨‹</strong></h4><ol><li><strong>èµ·å§‹ç‚¹</strong>: ä»æ ¹é¡µè¡¨ï¼ˆL4 Tableï¼‰å¼€å§‹ï¼Œæ ¹åœ°å€å­˜å‚¨åœ¨<code>self.root_paddr()</code>ä¸­</li><li><strong>L4éå†</strong>: ä½¿ç”¨è™šæ‹Ÿåœ°å€çš„<code>[47:39]</code>ä½ä½œä¸ºç´¢å¼•ï¼Œåœ¨L4é¡µè¡¨ä¸­æ‰¾åˆ°L4 PTE</li><li><strong>L3éå†</strong>: å¦‚æœL4 PTEä¸æ˜¯å¶å­èŠ‚ç‚¹ï¼Œä½¿ç”¨<code>[38:30]</code>ä½åœ¨L3é¡µè¡¨ä¸­æŸ¥æ‰¾</li><li><strong>L2éå†</strong>: å¦‚æœL3 PTEä¸æ˜¯å¶å­èŠ‚ç‚¹ï¼Œä½¿ç”¨<code>[29:21]</code>ä½åœ¨L2é¡µè¡¨ä¸­æŸ¥æ‰¾  </li><li><strong>L1éå†</strong>: å¦‚æœL2 PTEä¸æ˜¯å¶å­èŠ‚ç‚¹ï¼Œä½¿ç”¨<code>[20:12]</code>ä½åœ¨L1é¡µè¡¨ä¸­æŸ¥æ‰¾</li><li><strong>æœ€ç»ˆåœ°å€</strong>: PTEçš„åŸºå€ + è™šæ‹Ÿåœ°å€çš„ä½12ä½ï¼ˆé¡µå†…åç§»ï¼‰&#x3D; æœ€ç»ˆç‰©ç†åœ°å€</li></ol><h3 id="åº•å±‚åŸç†ï¼šMMUä¸CR3"><a href="#åº•å±‚åŸç†ï¼šMMUä¸CR3" class="headerlink" title="åº•å±‚åŸç†ï¼šMMUä¸CR3"></a>åº•å±‚åŸç†ï¼šMMUä¸CR3</h3><ul><li><p><code>query</code>å‡½æ•°æ˜¯åœ¨<strong>è½¯ä»¶ä¸­æ¨¡æ‹Ÿ</strong>äº†CPUç¡¬ä»¶<strong>MMUï¼ˆå†…å­˜ç®¡ç†å•å…ƒï¼‰</strong>çš„å·¥ä½œæµç¨‹ã€‚</p></li><li><p>åœ¨çœŸå®è¿è¡Œæ—¶ï¼ŒHypervisoré€šè¿‡<code>activate()</code>æ–¹æ³•å°†æ ¹é¡µè¡¨çš„ç‰©ç†åœ°å€åŠ è½½åˆ°<code>CR3</code>å¯„å­˜å™¨ä¸­ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼ªä»£ç ï¼Œå®é™…ç”±x86_64åº“æä¾›</span></span><br><span class="line">asm!(<span class="string">&quot;mov cr3, &#123;&#125;&quot;</span>, <span class="title function_ invoke__">in</span>(reg) root_paddr);</span><br></pre></td></tr></table></figure></li><li><p>ä¹‹åï¼Œæ¯ä¸€æ¬¡å†…å­˜è®¿é—®ï¼ŒCPUçš„MMUéƒ½ä¼šè‡ªåŠ¨ã€ç¡¬ä»¶çº§åœ°æ‰§è¡Œä¸Šè¿°<code>query</code>å‡½æ•°ä¸­çš„é¡µè¡¨éå†è¿‡ç¨‹ï¼Œä»¥æé«˜çš„é€Ÿåº¦å®Œæˆåœ°å€ç¿»è¯‘ã€‚å¦‚æœç¿»è¯‘å¤±è´¥ï¼ˆä¾‹å¦‚PTEçš„<code>Present</code>ä½ä¸º0ï¼‰ï¼ŒMMUä¼šè§¦å‘ä¸€ä¸ª<strong>Page Fault</strong>å¼‚å¸¸ï¼Œå°†æ§åˆ¶æƒäº¤è¿˜ç»™Hypervisorçš„å¤„ç†ç¨‹åºã€‚</p></li></ul><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>PTEçš„æ ¸å¿ƒä½œç”¨ï¼š</p><ol><li>åœ°å€æ˜ å°„: è®°å½•è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„æ˜ å°„å…³ç³»</li><li>æƒé™æ§åˆ¶: è®°å½•å†…å­˜é¡µé¢çš„è®¿é—®æƒé™ï¼ˆè¯»&#x2F;å†™&#x2F;æ‰§è¡Œ&#x2F;ç”¨æˆ·&#x2F;åŠ å¯†ç­‰ï¼‰</li><li>çŠ¶æ€ç®¡ç†: è®°å½•é¡µé¢çŠ¶æ€ï¼ˆæ˜¯å¦å­˜åœ¨ã€æ˜¯å¦è¢«è®¿é—®ã€æ˜¯å¦ä¸ºå¤§é¡µç­‰ï¼‰</li><li>ç¡¬ä»¶æ¥å£: ä½œä¸ºè½¯ä»¶ä¸CPUç¡¬ä»¶MMUä¹‹é—´çš„æ•°æ®ç»“æ„</li></ol><blockquote><p>è¿™å—å¦‚æœä½ ä¹‹å‰ä¸æ˜¯å¾ˆäº†è§£ linux çš„ MMU æˆ–è€…ä¸å¤ªæ¸…æ¥š HyperEnclaveçš„å®è§‚åœ°å€è½¬æ¢æ¶æ„ï¼ˆè¿™ä¸ªæ–‡ç« åé¢ä¼šè¯´ï¼‰ï¼Œç›´æ¥è¯´ç»†èŠ‚å¯èƒ½å¾ˆéš¾ç†è§£é€ã€‚</p></blockquote><h2 id="5-ç¬¬å››å±‚ï¼šé«˜çº§å†…å­˜æ˜ å°„-mm-rs-mapper-rs"><a href="#5-ç¬¬å››å±‚ï¼šé«˜çº§å†…å­˜æ˜ å°„-mm-rs-mapper-rs" class="headerlink" title="5. ç¬¬å››å±‚ï¼šé«˜çº§å†…å­˜æ˜ å°„ (mm.rs, mapper.rs)"></a>5. ç¬¬å››å±‚ï¼šé«˜çº§å†…å­˜æ˜ å°„ (<code>mm.rs</code>, <code>mapper.rs</code>)</h2><p>è¿™ä¸€å±‚æä¾›äº†é¢å‘å¼€å‘è€…çš„ã€æ›´æ˜“äºä½¿ç”¨çš„APIï¼Œå°†ç‰©ç†å¸§åˆ†é…å’Œé¡µè¡¨æ“ä½œå°è£…åœ¨ä¸€èµ·ã€‚</p><h3 id="æ ¸å¿ƒæ•°æ®ç»“æ„-1"><a href="#æ ¸å¿ƒæ•°æ®ç»“æ„-1" class="headerlink" title="æ ¸å¿ƒæ•°æ®ç»“æ„"></a>æ ¸å¿ƒæ•°æ®ç»“æ„</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/memory/mm.rs:35-42</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">MemorySet</span>&lt;PT: GenericPageTable&gt;</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    PT::VA: <span class="built_in">Ord</span>,</span><br><span class="line">&#123;</span><br><span class="line">    regions: BTreeMap&lt;PT::VA, MemoryRegion&lt;PT::VA&gt;&gt;,</span><br><span class="line">    pt: PT, <span class="comment">// å†…å«ä¸€ä¸ªé¡µè¡¨</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>MemorySet</code>ä»£è¡¨ä¸€ä¸ªå®Œæ•´çš„åœ°å€ç©ºé—´ï¼ˆå¦‚ä¸€ä¸ªEnclaveçš„åœ°å€ç©ºé—´ï¼‰ã€‚å®ƒåŒ…å«ä¸€ä¸ªé¡µè¡¨ï¼ˆ<code>pt</code>ï¼‰å’Œå¤šä¸ª<code>MemoryRegion</code>ã€‚<code>MemoryRegion</code>å®šä¹‰äº†ä¸€ä¸ªè¿ç»­çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸåŠå…¶å±æ€§ã€‚</p><h3 id="æ ¸å¿ƒé€»è¾‘ï¼šMemorySet-insert"><a href="#æ ¸å¿ƒé€»è¾‘ï¼šMemorySet-insert" class="headerlink" title="æ ¸å¿ƒé€»è¾‘ï¼šMemorySet::insert"></a>æ ¸å¿ƒé€»è¾‘ï¼š<code>MemorySet::insert</code></h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/memory/mm.rs:85-94 (simplified)</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">insert</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, region: MemoryRegion&lt;PT::VA&gt;) <span class="punctuation">-&gt;</span> HvResult &#123;</span><br><span class="line">    <span class="comment">// 1. æ£€æŸ¥è™šæ‹Ÿåœ°å€åŒºåŸŸæ˜¯å¦ä¸å…¶ä»–åŒºåŸŸé‡å </span></span><br><span class="line">    <span class="keyword">if</span> !<span class="keyword">self</span>.<span class="title function_ invoke__">test_free_area</span>(&amp;region) &#123;</span><br><span class="line">        <span class="keyword">return</span> hv_result_err!(EINVAL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2. è°ƒç”¨é¡µè¡¨å±‚çš„mapå‡½æ•°</span></span><br><span class="line">    <span class="keyword">self</span>.pt.<span class="title function_ invoke__">map</span>(&amp;region)?; </span><br><span class="line">    <span class="comment">// 3. å°†åŒºåŸŸä¿¡æ¯å­˜å…¥BTreeMap</span></span><br><span class="line">    <span class="keyword">self</span>.regions.<span class="title function_ invoke__">insert</span>(region.start, region);</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>self.pt.map(&amp;region)</code>æ˜¯å…³é”®ï¼Œå®ƒå†…éƒ¨ä¼šï¼š</p><ol><li>éå†<code>region</code>ä¸­çš„æ¯ä¸€ä¸ªè™šæ‹Ÿé¡µé¢ã€‚</li><li>ä¸ºæ¯ä¸ªè™šæ‹Ÿé¡µé¢è°ƒç”¨<code>frame::alloc()</code>åˆ†é…ä¸€ä¸ªç‰©ç†å¸§ã€‚</li><li>è®¡ç®—å‡ºPTEåº”è¯¥åœ¨é¡µè¡¨ä¸­çš„ä½ç½®ã€‚</li><li>åˆ›å»ºä¸€ä¸ªPTEï¼Œå°†è™šæ‹Ÿé¡µé¢é“¾æ¥åˆ°åˆ†é…çš„ç‰©ç†å¸§ï¼Œå¹¶è®¾ç½®å¥½<code>region.flags</code>ä¸­æŒ‡å®šçš„æƒé™ã€‚</li></ol><h3 id="åº•å±‚åŸç†ï¼šä»APIåˆ°ç¡¬ä»¶"><a href="#åº•å±‚åŸç†ï¼šä»APIåˆ°ç¡¬ä»¶" class="headerlink" title="åº•å±‚åŸç†ï¼šä»APIåˆ°ç¡¬ä»¶"></a>åº•å±‚åŸç†ï¼šä»APIåˆ°ç¡¬ä»¶</h3><p>ä¸€ä¸ª<code>MemorySet::insert</code>è°ƒç”¨æœ€ç»ˆä¼šè½¬åŒ–ä¸ºä¸€ç³»åˆ—åº•å±‚çš„CPUæ“ä½œï¼š</p><ol><li><strong>è½¯ä»¶ç°¿è®°</strong>ï¼šæ›´æ–°<code>FrameAllocator</code>çš„ä½å›¾ã€‚</li><li><strong>å†…å­˜å†™æ“ä½œ</strong>ï¼šä¿®æ”¹å¤šçº§é¡µè¡¨ä¸­çš„PTEå†…å®¹ã€‚</li><li><strong>TLBåˆ·æ–°</strong>ï¼šæ‰§è¡Œ<code>invlpg</code>æŒ‡ä»¤ä½¿TLBï¼ˆå¿«è¡¨ï¼‰ä¸­çš„æ—§ç¼“å­˜å¤±æ•ˆï¼Œç¡®ä¿CPUä½¿ç”¨æœ€æ–°çš„é¡µè¡¨æ˜ å°„ã€‚</li></ol><h2 id="6-ç¬¬äº”å±‚ï¼šEnclaveå¯è½¬æ¢å†…å­˜ç®¡ç†-cmr-rs"><a href="#6-ç¬¬äº”å±‚ï¼šEnclaveå¯è½¬æ¢å†…å­˜ç®¡ç†-cmr-rs" class="headerlink" title="6. ç¬¬äº”å±‚ï¼šEnclaveå¯è½¬æ¢å†…å­˜ç®¡ç† (cmr.rs)"></a>6. ç¬¬äº”å±‚ï¼šEnclaveå¯è½¬æ¢å†…å­˜ç®¡ç† (<code>cmr.rs</code>)</h2><p>è¿™æ˜¯HyperEnclaveæœ€å…·ç‰¹è‰²çš„éƒ¨åˆ†ï¼Œä¸“é—¨ç”¨äºç®¡ç†Enclaveçš„å®‰å…¨å†…å­˜ï¼ˆEPCï¼‰ã€‚</p><h3 id="è®¾è®¡æ€æƒ³ï¼šå¯è½¬æ¢å†…å­˜"><a href="#è®¾è®¡æ€æƒ³ï¼šå¯è½¬æ¢å†…å­˜" class="headerlink" title="è®¾è®¡æ€æƒ³ï¼šå¯è½¬æ¢å†…å­˜"></a>è®¾è®¡æ€æƒ³ï¼šå¯è½¬æ¢å†…å­˜</h3><p>HyperEnclaveä¸é™æ€åˆ’åˆ†æ™®é€šå†…å­˜å’Œå®‰å…¨å†…å­˜ï¼Œè€Œæ˜¯æå‡º<strong>å¯è½¬æ¢å†…å­˜ï¼ˆConvertible Memoryï¼‰</strong>çš„æ¦‚å¿µã€‚è¿™æ„å‘³ç€ä¸€å—ç‰©ç†å†…å­˜é¡µå¯ä»¥åœ¨è¿è¡Œæ—¶è¢«åŠ¨æ€åœ°è½¬æ¢ä¸ºæ™®é€šå†…å­˜ã€EPCå®‰å…¨å†…å­˜æˆ–Hypervisorå†…éƒ¨å†…å­˜ã€‚</p><h3 id="æ ¸å¿ƒæ•°æ®ç»“æ„-2"><a href="#æ ¸å¿ƒæ•°æ®ç»“æ„-2" class="headerlink" title="æ ¸å¿ƒæ•°æ®ç»“æ„"></a>æ ¸å¿ƒæ•°æ®ç»“æ„</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/memory/cmr.rs:59-71</span></span><br><span class="line"><span class="meta">#[repr(u8)]</span></span><br><span class="line"><span class="meta">#[derive(Clone, Copy, Debug, Eq, PartialEq)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">enum</span> <span class="title class_">PageStatus</span> &#123;</span><br><span class="line">    Reserved = <span class="number">0</span>,</span><br><span class="line">    _Pending = <span class="number">1</span>,</span><br><span class="line">    Normal = <span class="number">2</span>,</span><br><span class="line">    Secure = <span class="number">3</span>, <span class="comment">// EPC é¡µé¢</span></span><br><span class="line">    Internal = <span class="number">4</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// src/memory/cmr.rs:74-77</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">CmrmEntry</span> &#123;</span><br><span class="line">    page_status: PageStatus,</span><br><span class="line">    _inner: [<span class="type">u8</span>; <span class="number">23</span>],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>ConvMemManager</code>ä¸ºç³»ç»Ÿä¸­<strong>æ¯ä¸€é¡µ</strong>å¯è½¬æ¢çš„ç‰©ç†å†…å­˜ç»´æŠ¤ä¸€ä¸ª<code>CmrmEntry</code>å…ƒæ•°æ®ã€‚è¿™ä¸ªå·¨å¤§çš„å…ƒæ•°æ®æ•°ç»„å°±æ˜¯<strong>CMRMï¼ˆConvertible Memory Region Metadataï¼‰</strong>ã€‚</li><li><code>CmrmEntry</code>çš„æ ¸å¿ƒæ˜¯<code>page_status</code>ï¼Œå®ƒè®°å½•äº†å¯¹åº”ç‰©ç†é¡µçš„å½“å‰ç±»å‹ã€‚</li></ul><h3 id="æ ¸å¿ƒé€»è¾‘ï¼šinitialize-cmrm"><a href="#æ ¸å¿ƒé€»è¾‘ï¼šinitialize-cmrm" class="headerlink" title="æ ¸å¿ƒé€»è¾‘ï¼šinitialize_cmrm"></a>æ ¸å¿ƒé€»è¾‘ï¼š<code>initialize_cmrm</code></h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/memory/cmr.rs:172-210</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">initialize_cmrm</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, num: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> HyperCallResult&lt;<span class="type">usize</span>&gt; &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">for</span> <span class="variable">idx</span> <span class="keyword">in</span> start_idx..start_idx + num &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">paddr</span> = *CONV_MEM_START + idx * PAGE_SIZE;</span><br><span class="line">        <span class="comment">// æ ¹æ®ç‰©ç†åœ°å€æ‰€åœ¨çš„é¢„å®šä¹‰èŒƒå›´ï¼Œåˆ¤æ–­å…¶åˆå§‹çŠ¶æ€</span></span><br><span class="line">        <span class="keyword">self</span>.cmrm[idx].page_status = &#123;</span><br><span class="line">            <span class="keyword">if</span> ConvMemManager::<span class="title function_ invoke__">in_init_hypervior_mem</span>(paddr) &#123;</span><br><span class="line">                PageStatus::Internal</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ConvMemManager::<span class="title function_ invoke__">in_init_epc</span>(paddr, PAGE_SIZE) &#123;</span><br><span class="line">                PageStatus::Secure</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ConvMemManager::<span class="title function_ invoke__">in_conv_mem</span>(paddr, PAGE_SIZE) &#123;</span><br><span class="line">                PageStatus::Normal</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                PageStatus::Reserved</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤å‡½æ•°åœ¨Hypervisorå¯åŠ¨æ—¶è¢«è°ƒç”¨ï¼Œå®ƒéå†æ‰€æœ‰å¯è½¬æ¢å†…å­˜ï¼Œæ ¹æ®å›ºä»¶æä¾›çš„ä¿¡æ¯ï¼ˆå¦‚å“ªäº›å†…å­˜é¢„ç•™ä¸ºåˆå§‹EPCï¼‰ï¼Œä¸ºæ¯ä¸ªç‰©ç†é¡µè®¾ç½®å…¶åˆå§‹<code>PageStatus</code>ã€‚</p><h3 id="åº•å±‚åŸç†ï¼šå®‰å…¨å†…å­˜çš„å®ç°"><a href="#åº•å±‚åŸç†ï¼šå®‰å…¨å†…å­˜çš„å®ç°" class="headerlink" title="åº•å±‚åŸç†ï¼šå®‰å…¨å†…å­˜çš„å®ç°"></a>åº•å±‚åŸç†ï¼šå®‰å…¨å†…å­˜çš„å®ç°</h3><p>å°†ä¸€é¡µæ™®é€šå†…å­˜è½¬æ¢ä¸ºEPCå®‰å…¨å†…å­˜çš„å®Œæ•´æµç¨‹æ˜¯ï¼š</p><ol><li><strong>è½¯ä»¶å±‚</strong>ï¼šè°ƒç”¨<code>ConvMemManager</code>çš„æ¥å£ï¼Œå°†å¯¹åº”<code>CmrmEntry</code>çš„<code>page_status</code>ä»<code>Normal</code>æ›´æ–°ä¸º<code>Secure</code>ã€‚</li><li><strong>é¡µè¡¨å±‚</strong>ï¼šæ‰¾åˆ°æ˜ å°„åˆ°è¯¥ç‰©ç†é¡µçš„PTEï¼Œå¹¶å°†å…¶<code>MemFlags</code>æ·»åŠ <code>ENCRYPTED</code>æ ‡å¿—ã€‚</li><li><strong>åœ°å€è½¬æ¢å±‚</strong>ï¼šåœ¨æ„å»ºæœ€ç»ˆPTEæ—¶ï¼Œ<code>phys_encrypted</code>å‡½æ•°ä¼šä¸ºè¯¥ç‰©ç†åœ°å€è®¾ç½®<code>C-bit</code>ã€‚</li><li><strong>ç¡¬ä»¶å±‚</strong>ï¼šå½“MMUä½¿ç”¨è¿™ä¸ªPTEè¿›è¡Œåœ°å€ç¿»è¯‘æ—¶ï¼Œå®ƒå°†å¸¦æœ‰<code>C-bit</code>çš„ç‰©ç†åœ°å€å‘é€åˆ°å†…å­˜æ§åˆ¶å™¨ã€‚å†…å­˜æ§åˆ¶å™¨è¯†åˆ«åˆ°<code>C-bit</code>åï¼Œè‡ªåŠ¨ä½¿ç”¨SEVå¼•æ“å¯¹è¯¥æ¬¡å†…å­˜è®¿é—®è¿›è¡ŒåŠ è§£å¯†ã€‚</li></ol><h2 id="7-å†…å­˜è®¿é—®æµç¨‹å’Œåœ°å€è½¬æ¢æ¶æ„"><a href="#7-å†…å­˜è®¿é—®æµç¨‹å’Œåœ°å€è½¬æ¢æ¶æ„" class="headerlink" title="7.å†…å­˜è®¿é—®æµç¨‹å’Œåœ°å€è½¬æ¢æ¶æ„"></a>7.å†…å­˜è®¿é—®æµç¨‹å’Œåœ°å€è½¬æ¢æ¶æ„</h2><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    subgraph &quot;Guestç¨‹åºå†…å­˜è®¿é—®&quot;        A1[Gueståº”ç”¨ç¨‹åº] --&gt; A2[Guestè™šæ‹Ÿåœ°å€]        A2 --&gt; A3[Guesté¡µè¡¨éå†]        A3 --&gt; A4[Guestç‰©ç†åœ°å€]        A4 --&gt; A5[Nestedé¡µè¡¨&#x2F;EPT]        A5 --&gt; A6[å®é™…ç‰©ç†å†…å­˜]    end        subgraph &quot;Enclaveç¨‹åºå†…å­˜è®¿é—®&quot;        B1[Enclaveåº”ç”¨ç¨‹åº] --&gt; B2[Enclaveè™šæ‹Ÿåœ°å€]        B2 --&gt; B3[Enclave Guesté¡µè¡¨éå†]        B3 --&gt; B4[Guestç‰©ç†åœ°å€]        B4 --&gt; B5[Nestedé¡µè¡¨&#x2F;EPT]        B5 --&gt; B6[å®é™…ç‰©ç†å†…å­˜]    end        subgraph &quot;æ§åˆ¶å±‚æ¬¡&quot;        C1[Guestæ“ä½œç³»ç»Ÿ] --&gt; C2[ç®¡ç†Guesté¡µè¡¨]        C3[HyperEnclave] --&gt; C4[ç®¡ç†Enclave Guesté¡µè¡¨]        C3 --&gt; C5[ç®¡ç†Nestedé¡µè¡¨]        C3 --&gt; C6[å®‰å…¨ç­–ç•¥æ§åˆ¶]    end  </pre></div><h3 id="7-1-Guestç¨‹åºçš„å†…å­˜è®¿é—®æœºåˆ¶"><a href="#7-1-Guestç¨‹åºçš„å†…å­˜è®¿é—®æœºåˆ¶" class="headerlink" title="7.1 Guestç¨‹åºçš„å†…å­˜è®¿é—®æœºåˆ¶"></a>7.1 Guestç¨‹åºçš„å†…å­˜è®¿é—®æœºåˆ¶</h3><h4 id="åœ°å€è½¬æ¢æµç¨‹"><a href="#åœ°å€è½¬æ¢æµç¨‹" class="headerlink" title="åœ°å€è½¬æ¢æµç¨‹"></a>åœ°å€è½¬æ¢æµç¨‹</h4><p>ä»ä»£ç åˆ†æå¯ä»¥çœ‹å‡ºï¼ŒGuestç¨‹åºçš„å†…å­˜è®¿é—®åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š</p><h4 id="æ™®é€šGuestå†…å­˜è®¿é—®ï¼ˆNonSecureï¼‰"><a href="#æ™®é€šGuestå†…å­˜è®¿é—®ï¼ˆNonSecureï¼‰" class="headerlink" title="æ™®é€šGuestå†…å­˜è®¿é—®ï¼ˆNonSecureï¼‰"></a>æ™®é€šGuestå†…å­˜è®¿é—®ï¼ˆNonSecureï¼‰</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/memory/gaccess.rs:215-227</span></span><br><span class="line">PtrType::<span class="title function_ invoke__">NonSecure</span>(untrusted_gpt) =&gt; <span class="keyword">match</span> untrusted_gpt.<span class="title function_ invoke__">query</span>(gvaddr) &#123;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>((gpaddr, mem_flags, pg_size)) =&gt; (gpaddr, mem_flags, pg_size),</span><br><span class="line">    <span class="title function_ invoke__">Err</span>(PagingError::<span class="title function_ invoke__">NotMapped</span>(_)) | <span class="title function_ invoke__">Err</span>(PagingError::<span class="title function_ invoke__">NotPresent</span>(_)) =&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(hypercall_excep_err!(</span><br><span class="line">            <span class="title function_ invoke__">generate_pf</span>(<span class="literal">false</span>),</span><br><span class="line">            <span class="built_in">format!</span>(<span class="string">&quot;Cannot get gpaddr for gvaddr: &#123;:#x?&#125;, inject #PF&quot;</span>, gvaddr)</span><br><span class="line">        ));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">Err</span>(e) =&gt; <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(HvError::<span class="title function_ invoke__">from</span>(e).<span class="title function_ invoke__">into</span>()),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è½¬æ¢æ­¥éª¤</strong>ï¼š</p><ol><li><strong>Guestè™šæ‹Ÿåœ°å€</strong> â†’ Guesté¡µè¡¨æŸ¥è¯¢ â†’ <strong>Guestç‰©ç†åœ°å€</strong></li><li><strong>Guestç‰©ç†åœ°å€</strong> â†’ Nestedé¡µè¡¨ï¼ˆEPT&#x2F;NPTï¼‰â†’ <strong>å®é™…ç‰©ç†å†…å­˜</strong></li></ol><h4 id="é¡µè¡¨éå†æœºåˆ¶"><a href="#é¡µè¡¨éå†æœºåˆ¶" class="headerlink" title="é¡µè¡¨éå†æœºåˆ¶"></a>é¡µè¡¨éå†æœºåˆ¶</h4><p>Guesté¡µè¡¨éå†é€šè¿‡å››çº§é¡µè¡¨ç»“æ„å®ç°ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/memory/paging.rs:865-880</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">fn</span> <span class="title function_">p4_index</span>(vaddr: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">    (vaddr &gt;&gt; (<span class="number">12</span> + <span class="number">27</span>)) &amp; (ENTRY_COUNT - <span class="number">1</span>)  <span class="comment">// [47:39] ä½</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">fn</span> <span class="title function_">p3_index</span>(vaddr: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">    (vaddr &gt;&gt; (<span class="number">12</span> + <span class="number">18</span>)) &amp; (ENTRY_COUNT - <span class="number">1</span>)  <span class="comment">// [38:30] ä½</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">fn</span> <span class="title function_">p2_index</span>(vaddr: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">    (vaddr &gt;&gt; (<span class="number">12</span> + <span class="number">9</span>)) &amp; (ENTRY_COUNT - <span class="number">1</span>)   <span class="comment">// [29:21] ä½</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">fn</span> <span class="title function_">p1_index</span>(vaddr: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">    (vaddr &gt;&gt; <span class="number">12</span>) &amp; (ENTRY_COUNT - <span class="number">1</span>)         <span class="comment">// [20:12] ä½</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="7-2-Enclaveç¨‹åºçš„å†…å­˜è®¿é—®æœºåˆ¶"><a href="#7-2-Enclaveç¨‹åºçš„å†…å­˜è®¿é—®æœºåˆ¶" class="headerlink" title="7.2. Enclaveç¨‹åºçš„å†…å­˜è®¿é—®æœºåˆ¶"></a>7.2. Enclaveç¨‹åºçš„å†…å­˜è®¿é—®æœºåˆ¶</h3><h4 id="ç‰¹æ®Šçš„åœ°å€è½¬æ¢"><a href="#ç‰¹æ®Šçš„åœ°å€è½¬æ¢" class="headerlink" title="ç‰¹æ®Šçš„åœ°å€è½¬æ¢"></a>ç‰¹æ®Šçš„åœ°å€è½¬æ¢</h4><p>Enclaveç¨‹åºçš„å†…å­˜è®¿é—®æ›´å¤æ‚ï¼Œéœ€è¦é¢å¤–çš„å®‰å…¨æ£€æŸ¥ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/memory/gaccess.rs:231-235</span></span><br><span class="line">PtrType::<span class="title function_ invoke__">Secure</span>(enclave) =&gt; &#123;</span><br><span class="line">    enclave.<span class="title function_ invoke__">load_page</span>(gvaddr, *cpu_state == CpuState::EnclaveRunning)?</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Enclaveé¡µé¢åŠ è½½æœºåˆ¶"><a href="#Enclaveé¡µé¢åŠ è½½æœºåˆ¶" class="headerlink" title="Enclaveé¡µé¢åŠ è½½æœºåˆ¶"></a>Enclaveé¡µé¢åŠ è½½æœºåˆ¶</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/enclave/mod.rs:967-1009</span></span><br><span class="line"><span class="keyword">match</span> secure_gpt.<span class="title function_ invoke__">get_pte_mut</span>(gvaddr) &#123;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(pte) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> pte.<span class="title function_ invoke__">is_unused</span>() &#123;</span><br><span class="line">            <span class="comment">// é¡µé¢æœªæ˜ å°„ï¼Œè§¦å‘é¡µé¢é”™è¯¯</span></span><br><span class="line">            <span class="keyword">let</span> <span class="variable">error_code</span> = PageFaultErrorCode::USER_MODE.<span class="title function_ invoke__">bits</span>();</span><br><span class="line">            <span class="title function_ invoke__">generate_pf</span>(error_code, gvaddr, is_encl_mode)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> !pte.<span class="title function_ invoke__">is_present</span>() &#123;</span><br><span class="line">            <span class="comment">// é¡µé¢è¢«å›æ”¶ï¼Œéœ€è¦é‡æ–°åŠ è½½</span></span><br><span class="line">            <span class="keyword">let</span> <span class="variable">gpaddr_aligned</span> = pte.<span class="title function_ invoke__">addr</span>();</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">new_sec_info</span> = EpcmManager::<span class="title function_ invoke__">access_page_check</span>(</span><br><span class="line">                gvaddr, gpaddr_aligned, <span class="keyword">self</span>, <span class="literal">false</span>, is_encl_mode,</span><br><span class="line">            )?;</span><br><span class="line">            pte.<span class="title function_ invoke__">set_flags</span>(new_sec_info.<span class="title function_ invoke__">into</span>(), <span class="literal">false</span>)?;</span><br><span class="line">            <span class="title function_ invoke__">Ok</span>((</span><br><span class="line">                gpaddr_aligned + PageSize::Size4K.<span class="title function_ invoke__">page_offset</span>(gvaddr),</span><br><span class="line">                pte.<span class="title function_ invoke__">flags</span>(),</span><br><span class="line">                PageSize::Size4K,</span><br><span class="line">            ))</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// é¡µé¢æ­£å¸¸ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">            <span class="keyword">let</span> <span class="variable">gpfn</span> = pte.<span class="title function_ invoke__">addr</span>();</span><br><span class="line">            <span class="title function_ invoke__">Ok</span>((gpfn + PageSize::Size4K.<span class="title function_ invoke__">page_offset</span>(gvaddr), pte.<span class="title function_ invoke__">flags</span>(), PageSize::Size4K))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è½¬æ¢æ­¥éª¤</strong>ï¼š</p><ol><li><strong>Enclaveè™šæ‹Ÿåœ°å€</strong> â†’ Enclave Guesté¡µè¡¨æŸ¥è¯¢ â†’ <strong>Guestç‰©ç†åœ°å€</strong></li><li><strong>Guestç‰©ç†åœ°å€</strong> â†’ Nestedé¡µè¡¨ï¼ˆEPT&#x2F;NPTï¼‰â†’ <strong>å®é™…ç‰©ç†å†…å­˜</strong></li><li><strong>é¢å¤–å®‰å…¨æ£€æŸ¥</strong>ï¼šEPCMéªŒè¯ã€æƒé™æ£€æŸ¥ã€çŠ¶æ€éªŒè¯</li></ol><h3 id="7-3-æ§åˆ¶å±‚æ¬¡åˆ†æ"><a href="#7-3-æ§åˆ¶å±‚æ¬¡åˆ†æ" class="headerlink" title="7.3. æ§åˆ¶å±‚æ¬¡åˆ†æ"></a>7.3. æ§åˆ¶å±‚æ¬¡åˆ†æ</h3><h4 id="7-3-1-Guestæ“ä½œç³»ç»Ÿæ§åˆ¶èŒƒå›´"><a href="#7-3-1-Guestæ“ä½œç³»ç»Ÿæ§åˆ¶èŒƒå›´" class="headerlink" title="7.3.1 Guestæ“ä½œç³»ç»Ÿæ§åˆ¶èŒƒå›´"></a>7.3.1 Guestæ“ä½œç³»ç»Ÿæ§åˆ¶èŒƒå›´</h4><p>Guestæ“ä½œç³»ç»Ÿï¼ˆLinuxï¼‰æ§åˆ¶çš„å†…å®¹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä»ä»£ç æ¨æ–­Guest OSçš„æ§åˆ¶èŒƒå›´</span></span><br><span class="line"><span class="comment">// Guest OSç®¡ç†è‡ªå·±çš„é¡µè¡¨ï¼Œä½†å—åˆ°HyperEnclaveçš„ç›‘æ§</span></span><br></pre></td></tr></table></figure><p><strong>Guest OSæ§åˆ¶</strong>ï¼š</p><ul><li><strong>Guesté¡µè¡¨ç®¡ç†</strong>ï¼šåˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤Guestè™šæ‹Ÿåœ°å€åˆ°Guestç‰©ç†åœ°å€çš„æ˜ å°„</li><li><strong>å†…å­˜åˆ†é…</strong>ï¼šåœ¨Guestç‰©ç†åœ°å€ç©ºé—´å†…åˆ†é…å†…å­˜ç»™åº”ç”¨ç¨‹åº</li><li><strong>æƒé™ç®¡ç†</strong>ï¼šè®¾ç½®é¡µé¢çš„è¯»å†™æ‰§è¡Œæƒé™ï¼ˆå—é™ï¼‰</li><li><strong>è¿›ç¨‹éš”ç¦»</strong>ï¼šåœ¨Guestå†…éƒ¨å®ç°è¿›ç¨‹é—´çš„å†…å­˜éš”ç¦»</li></ul><p><strong>Guest OSæ— æ³•æ§åˆ¶</strong>ï¼š</p><ul><li>Nestedé¡µè¡¨ï¼ˆEPT&#x2F;NPTï¼‰</li><li>Enclaveçš„å†…å­˜ç®¡ç†</li><li>å®é™…ç‰©ç†å†…å­˜çš„åˆ†é…</li><li>è·¨Guestçš„å®‰å…¨ç­–ç•¥</li></ul><h4 id="7-3-2-HyperEnclaveæ§åˆ¶èŒƒå›´"><a href="#7-3-2-HyperEnclaveæ§åˆ¶èŒƒå›´" class="headerlink" title="7.3.2 HyperEnclaveæ§åˆ¶èŒƒå›´"></a>7.3.2 HyperEnclaveæ§åˆ¶èŒƒå›´</h4><p>ä»ä»£ç å¯ä»¥çœ‹å‡ºHyperEnclaveçš„å…¨é¢æ§åˆ¶ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/cell.rs:27-36</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Cell</span> &#123;</span><br><span class="line">    <span class="comment">/// Guest physical memory set.</span></span><br><span class="line">    <span class="keyword">pub</span> gpm: MemorySet&lt;NestedPageTable&gt;,</span><br><span class="line">    <span class="comment">/// Host virtual memory set.</span></span><br><span class="line">    <span class="keyword">pub</span> hvm: MemorySet&lt;HostPageTable&gt;,</span><br><span class="line">    <span class="comment">/// DMA memory set.</span></span><br><span class="line">    <span class="keyword">pub</span> dma_regions: MemorySet&lt;IoPageTable&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>HyperEnclaveæ§åˆ¶</strong>ï¼š</p><h5 id="1ï¼‰Nestedé¡µè¡¨ç®¡ç†"><a href="#1ï¼‰Nestedé¡µè¡¨ç®¡ç†" class="headerlink" title="1ï¼‰Nestedé¡µè¡¨ç®¡ç†"></a>1ï¼‰Nestedé¡µè¡¨ç®¡ç†</h5><ul><li><strong>äºŒçº§åœ°å€è½¬æ¢</strong>ï¼šGuestç‰©ç†åœ°å€ â†’ å®é™…ç‰©ç†åœ°å€</li><li><strong>å†…å­˜éš”ç¦»</strong>ï¼šç¡®ä¿ä¸åŒGuestæ— æ³•è®¿é—®å¯¹æ–¹å†…å­˜</li><li><strong>è®¿é—®æƒé™</strong>ï¼šæ§åˆ¶Guestå¯¹ç‰©ç†å†…å­˜çš„è®¿é—®æƒé™</li></ul><h5 id="2ï¼‰Enclaveä¸“ç”¨ç®¡ç†"><a href="#2ï¼‰Enclaveä¸“ç”¨ç®¡ç†" class="headerlink" title="2ï¼‰Enclaveä¸“ç”¨ç®¡ç†"></a>2ï¼‰Enclaveä¸“ç”¨ç®¡ç†</h5><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/enclave/mod.rs:170-175</span></span><br><span class="line"><span class="comment">/// Nested page table in S-world.</span></span><br><span class="line">npt: RwLock&lt;EnclaveNestedPageTableUnlocked&gt;,</span><br><span class="line"><span class="comment">/// Guest page table in S-world.</span></span><br><span class="line">gpt: RwLock&lt;EnclaveGuestPageTableUnlocked&gt;,</span><br></pre></td></tr></table></figure><ul><li><strong>Enclave Guesté¡µè¡¨</strong>ï¼šä¸“é—¨ä¸ºEnclaveåˆ›å»ºçš„é¡µè¡¨</li><li><strong>EPCMç®¡ç†</strong>ï¼šEnclaveé¡µé¢ç¼“å­˜æ˜ å°„ç®¡ç†</li><li><strong>å®‰å…¨ç­–ç•¥</strong>ï¼šå®æ–½Enclaveçš„å®‰å…¨éš”ç¦»ç­–ç•¥</li></ul><h5 id="3ï¼‰å†…å­˜å®‰å…¨éªŒè¯"><a href="#3ï¼‰å†…å­˜å®‰å…¨éªŒè¯" class="headerlink" title="3ï¼‰å†…å­˜å®‰å…¨éªŒè¯"></a>3ï¼‰å†…å­˜å®‰å…¨éªŒè¯</h5><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/memory/gaccess.rs:140-158</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">check_gpaddr</span>(gpaddr: GuestPhysAddr, is_secure: <span class="type">bool</span>) <span class="punctuation">-&gt;</span> HvResult &#123;</span><br><span class="line">    <span class="keyword">if</span> is_secure &#123;</span><br><span class="line">        <span class="keyword">if</span> !EpcmManager::<span class="title function_ invoke__">is_valid_epc</span>(gpaddr) &#123;</span><br><span class="line">            <span class="keyword">return</span> hv_result_err!(EINVAL, <span class="string">&quot;Cannot access guest paddr as secure memory&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> EpcmManager::<span class="title function_ invoke__">is_valid_epc</span>(gpaddr) </span><br><span class="line">        || !ROOT_CELL.<span class="title function_ invoke__">is_valid_normal_world_gpaddr</span>(gpaddr) &#123;</span><br><span class="line">        <span class="keyword">return</span> hv_result_err!(EINVAL, <span class="string">&quot;Cannot access guest paddr as non-secure memory&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>åœ°å€éªŒè¯</strong>ï¼šéªŒè¯è®¿é—®çš„ç‰©ç†åœ°å€æ˜¯å¦åˆæ³•</li><li><strong>å®‰å…¨è¾¹ç•Œ</strong>ï¼šå¼ºåˆ¶æ‰§è¡Œå®‰å…¨å†…å­˜å’Œéå®‰å…¨å†…å­˜çš„è¾¹ç•Œ</li><li><strong>è®¿é—®æ§åˆ¶</strong>ï¼šæ ¹æ®ä¸Šä¸‹æ–‡æ§åˆ¶å†…å­˜è®¿é—®æƒé™</li></ul><h3 id="7-4-å†…å­˜è®¿é—®çš„å®Œæ•´æµç¨‹å›¾"><a href="#7-4-å†…å­˜è®¿é—®çš„å®Œæ•´æµç¨‹å›¾" class="headerlink" title="7.4 å†…å­˜è®¿é—®çš„å®Œæ•´æµç¨‹å›¾"></a>7.4 å†…å­˜è®¿é—®çš„å®Œæ•´æµç¨‹å›¾</h3><h4 id="Guestç¨‹åºå†…å­˜è®¿é—®"><a href="#Guestç¨‹åºå†…å­˜è®¿é—®" class="headerlink" title="Guestç¨‹åºå†…å­˜è®¿é—®"></a>Guestç¨‹åºå†…å­˜è®¿é—®</h4><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  sequenceDiagram    participant App as Gueståº”ç”¨    participant OS as Guest OS    participant HV as HyperEnclave    participant HW as ç¡¬ä»¶MMU    App-&gt;&gt;HW: è®¿é—®è™šæ‹Ÿåœ°å€    HW-&gt;&gt;OS: æŸ¥è¯¢Guesté¡µè¡¨    OS-&gt;&gt;HW: è¿”å›Guestç‰©ç†åœ°å€    HW-&gt;&gt;HV: æŸ¥è¯¢Nestedé¡µè¡¨    HV-&gt;&gt;HW: è¿”å›å®é™…ç‰©ç†åœ°å€    HW-&gt;&gt;App: å®Œæˆå†…å­˜è®¿é—®  </pre></div><h4 id="Enclaveç¨‹åºå†…å­˜è®¿é—®"><a href="#Enclaveç¨‹åºå†…å­˜è®¿é—®" class="headerlink" title="Enclaveç¨‹åºå†…å­˜è®¿é—®"></a>Enclaveç¨‹åºå†…å­˜è®¿é—®</h4><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  sequenceDiagram    participant EApp as Enclaveåº”ç”¨    participant HV as HyperEnclave    participant EPCM as EPCMç®¡ç†å™¨    participant HW as ç¡¬ä»¶MMU    EApp-&gt;&gt;HW: è®¿é—®Enclaveè™šæ‹Ÿåœ°å€    HW-&gt;&gt;HV: æŸ¥è¯¢Enclave Guesté¡µè¡¨    HV-&gt;&gt;EPCM: éªŒè¯é¡µé¢çŠ¶æ€å’Œæƒé™    EPCM-&gt;&gt;HV: è¿”å›éªŒè¯ç»“æœ    HV-&gt;&gt;HW: è¿”å›Guestç‰©ç†åœ°å€    HW-&gt;&gt;HV: æŸ¥è¯¢Nestedé¡µè¡¨    HV-&gt;&gt;HW: è¿”å›å®é™…ç‰©ç†åœ°å€    HW-&gt;&gt;EApp: å®Œæˆå†…å­˜è®¿é—®  </pre></div><h4 id="å…³é”®å·®å¼‚æ€»ç»“"><a href="#å…³é”®å·®å¼‚æ€»ç»“" class="headerlink" title="å…³é”®å·®å¼‚æ€»ç»“"></a>å…³é”®å·®å¼‚æ€»ç»“</h4><table><thead><tr><th>ç‰¹æ€§</th><th>Guestç¨‹åº</th><th>Enclaveç¨‹åº</th></tr></thead><tbody><tr><td><strong>é¡µè¡¨ç®¡ç†</strong></td><td>Guest OSç®¡ç†</td><td>HyperEnclaveç®¡ç†</td></tr><tr><td><strong>å®‰å…¨æ£€æŸ¥</strong></td><td>åŸºæœ¬æƒé™æ£€æŸ¥</td><td>EPCM + æƒé™ + çŠ¶æ€éªŒè¯</td></tr><tr><td><strong>å†…å­˜åŒºåŸŸ</strong></td><td>æ™®é€šç‰©ç†å†…å­˜</td><td>EPCï¼ˆåŠ å¯†é¡µé¢ç¼“å­˜ï¼‰</td></tr><tr><td><strong>éš”ç¦»çº§åˆ«</strong></td><td>è¿›ç¨‹çº§éš”ç¦»</td><td>ç¡¬ä»¶çº§åŠ å¯†éš”ç¦»</td></tr><tr><td><strong>æ•…éšœå¤„ç†</strong></td><td>æ ‡å‡†é¡µé¢é”™è¯¯</td><td>ç‰¹æ®Šå®‰å…¨å¼‚å¸¸</td></tr><tr><td><strong>åŠ¨æ€ç®¡ç†</strong></td><td>OSå†…å­˜ç®¡ç†</td><td>HyperEnclave + EPCM</td></tr></tbody></table><p>è¿™ç§è®¾è®¡ç¡®ä¿äº†Enclaveç¨‹åºå…·æœ‰æ¯”æ™®é€šGuestç¨‹åºæ›´å¼ºçš„å®‰å…¨ä¿éšœï¼ŒåŒæ—¶HyperEnclaveé€šè¿‡æ§åˆ¶å…³é”®çš„é¡µè¡¨ç»“æ„å’Œå®‰å…¨ç­–ç•¥ï¼Œå®ç°äº†å¯¹æ•´ä¸ªç³»ç»Ÿå†…å­˜è®¿é—®çš„å…¨é¢ç®¡æ§ã€‚</p><h2 id="8-æ€»ç»“"><a href="#8-æ€»ç»“" class="headerlink" title="8. æ€»ç»“"></a>8. æ€»ç»“</h2><p>HyperEnclaveçš„å†…å­˜ç®¡ç†æ˜¯ä¸€ä¸ªè®¾è®¡ç²¾è‰¯ã€å±‚æ¬¡åˆ†æ˜çš„ç³»ç»Ÿã€‚</p><ul><li>å®ƒä»æœ€åº•å±‚çš„<strong>ç‰©ç†å¸§ä½å›¾</strong>å¼€å§‹ã€‚</li><li>é€šè¿‡<strong>å¤šçº§é¡µè¡¨</strong>å’Œ<strong>PTEæŠ½è±¡</strong>ï¼Œæ„å»ºäº†å¼ºå¤§çš„è™šæ‹Ÿå†…å­˜æœºåˆ¶ã€‚</li><li>åˆ©ç”¨**<code>MemorySet</code>**å°†å…¶å°è£…æˆæ˜“ç”¨çš„é«˜çº§APIã€‚</li><li>æœ€åé€šè¿‡åˆ›æ–°çš„<strong>å¯è½¬æ¢å†…å­˜æ¨¡å‹ï¼ˆCMRMï¼‰</strong>ï¼Œå®ç°äº†å¯¹EPCå®‰å…¨å†…å­˜çš„çµæ´»ã€åŠ¨æ€ç®¡ç†ã€‚</li></ul><p>æ•´ä¸ªç³»ç»Ÿçš„å®ç°æ·±åº¦ä¾èµ–äºå¯¹x86-64ç¡¬ä»¶ç‰¹æ€§ï¼ˆå¦‚MMUã€CR3ã€MSRã€SEVåŠ å¯†ä½ï¼‰çš„ç›´æ¥åˆ©ç”¨ï¼Œå¹¶é€šè¿‡Rustçš„ç±»å‹ç³»ç»Ÿå’ŒæŠ½è±¡èƒ½åŠ›ï¼Œå°†è¿™äº›å¤æ‚çš„åº•å±‚æ“ä½œå®‰å…¨ã€æ¸…æ™°åœ°ç»„ç»‡èµ·æ¥ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> éšç§è®¡ç®— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HyperEnclave </tag>
            
            <tag> TEE </tag>
            
            <tag> å†…å­˜ç®¡ç† </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HypervisoræŠ€æœ¯è§£æï¼šä¼ ç»Ÿè™šæ‹ŸåŒ–æŠ€æœ¯ä¸HyperEnclave</title>
      <link href="/2025/07/23/Hypervisor%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90%EF%BC%9A%E4%BC%A0%E7%BB%9F%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF%E4%B8%8EHyperEnclave/"/>
      <url>/2025/07/23/Hypervisor%E6%8A%80%E6%9C%AF%E8%A7%A3%E6%9E%90%EF%BC%9A%E4%BC%A0%E7%BB%9F%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF%E4%B8%8EHyperEnclave/</url>
      
        <content type="html"><![CDATA[<h2 id="1-Hypervisor-æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#1-Hypervisor-æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="1. Hypervisor æ˜¯ä»€ä¹ˆï¼Ÿ"></a>1. Hypervisor æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>åœ¨æ·±å…¥æŠ€æœ¯ç»†èŠ‚ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆè¦ç†è§£ Hypervisor åˆ°åº•æ˜¯ä»€ä¹ˆ</p><p>ç®€å•æ¥è¯´ï¼Œ<strong>Hypervisor</strong>ï¼Œåˆç§°ä¸º**è™šæ‹Ÿæœºç›‘è§†å™¨ (Virtual Machine Monitor, VMM)**ï¼Œæ˜¯ä¸€ç§è½¯ä»¶ã€å›ºä»¶æˆ–ç¡¬ä»¶ï¼Œå®ƒèƒ½å¤Ÿåˆ›å»ºå¹¶è¿è¡Œè™šæ‹Ÿæœº (Virtual Machines, VMs)ã€‚å®ƒæ˜¯ä¸€ä¸ªâ€œå…ƒæ“ä½œç³»ç»Ÿâ€ï¼Œå…è®¸å¤šä¸ªæ“ä½œç³»ç»Ÿï¼ˆç§°ä¸ºå®¢æˆ·æœºæ“ä½œç³»ç»Ÿï¼ŒGuest OSï¼‰å…±äº«åŒä¸€å¥—ç‰©ç†ç¡¬ä»¶èµ„æºã€‚</p><p>Hypervisor çš„æ ¸å¿ƒä½¿å‘½æ˜¯<strong>è™šæ‹ŸåŒ–</strong>â€”â€”å³ä¸ºæ¯ä¸ªè™šæ‹Ÿæœºåˆ›å»ºä¸€ä¸ªè™šæ‹Ÿçš„ã€ç‹¬ç«‹çš„ç¡¬ä»¶å¹³å°ï¼ŒåŒ…æ‹¬è™šæ‹Ÿçš„ CPUã€å†…å­˜ã€ç¡¬ç›˜å’Œç½‘ç»œæ¥å£ç­‰ã€‚è¿™ä½¿å¾—è™šæ‹Ÿæœºä¸­çš„æ“ä½œç³»ç»Ÿè®¤ä¸ºè‡ªå·±ç‹¬å äº†ä¸€æ•´å°è®¡ç®—æœºï¼Œè€Œå®é™…ä¸Šå®ƒä»¬åªæ˜¯åœ¨ Hypervisor çš„åè°ƒä¸‹ï¼Œå…±äº«ä½¿ç”¨åº•å±‚çœŸå®çš„ç‰©ç†ç¡¬ä»¶ã€‚</p><p>è¿™ç§æŠ€æœ¯æ˜¯äº‘è®¡ç®—ã€æ•°æ®ä¸­å¿ƒç°ä»£åŒ–å’Œè½¯ä»¶å¼€å‘æµ‹è¯•ç­‰é¢†åŸŸçš„åŸºçŸ³ã€‚</p><h2 id="2-Hypervisor-çš„ä½“ç³»æ¶æ„ï¼šä¸¤å¤§åˆ†ç±»"><a href="#2-Hypervisor-çš„ä½“ç³»æ¶æ„ï¼šä¸¤å¤§åˆ†ç±»" class="headerlink" title="2. Hypervisor çš„ä½“ç³»æ¶æ„ï¼šä¸¤å¤§åˆ†ç±»"></a>2. Hypervisor çš„ä½“ç³»æ¶æ„ï¼šä¸¤å¤§åˆ†ç±»</h2><p>æ ¹æ® Hypervisor çš„è¿è¡Œæ–¹å¼å’Œæ‰€å¤„çš„ä½ç½®ï¼Œæˆ‘ä»¬é€šå¸¸å°†å…¶åˆ†ä¸ºä¸¤å¤§ç±»ï¼šType 1 å’Œ Type 2ã€‚</p><h3 id="Type-1-è£¸é‡‘å±-Hypervisor-Bare-metal"><a href="#Type-1-è£¸é‡‘å±-Hypervisor-Bare-metal" class="headerlink" title="Type 1: è£¸é‡‘å± Hypervisor (Bare-metal)"></a>Type 1: è£¸é‡‘å± Hypervisor (Bare-metal)</h3><p>Type 1 Hypervisor ç›´æ¥å®‰è£…åœ¨ç‰©ç†ç¡¬ä»¶ï¼ˆå³â€œè£¸é‡‘å±â€ï¼‰ä¹‹ä¸Šï¼Œå®ƒæœ¬èº«å°±æ˜¯ä¸€ä¸ªç²¾ç®€çš„æ“ä½œç³»ç»Ÿã€‚æ‰€æœ‰çš„å®¢æˆ·æœºæ“ä½œç³»ç»Ÿéƒ½è¿è¡Œåœ¨ Hypervisor ä¹‹ä¸Šã€‚è¿™ç§æ¶æ„æ€§èƒ½é«˜ã€å»¶è¿Ÿä½ï¼Œå› ä¸ºå®¢æˆ·æœºæ“ä½œç³»ç»Ÿå’Œç¡¬ä»¶ä¹‹é—´çš„ä¸­é—´å±‚æœ€å°‘ã€‚</p><p><strong>å¸¸è§ä¾‹å­</strong>: VMware ESXi, Microsoft Hyper-V, KVM (Kernel-based Virtual Machine), Xenã€‚</p><p><strong>æ¶æ„å›¾</strong>:</p><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD;    subgraph &quot;ç‰©ç†ç¡¬ä»¶&quot;      CPU[&quot;CPU&quot;]      Memory[&quot;å†…å­˜&quot;]      Storage[&quot;å­˜å‚¨&quot;]      Network[&quot;ç½‘ç»œ&quot;]    end    subgraph &quot;è™šæ‹Ÿæœº&quot;      VM1[&quot;è™šæ‹Ÿæœº 1 (å®¢æˆ·æœºæ“ä½œç³»ç»Ÿ + åº”ç”¨)&quot;]      VM2[&quot;è™šæ‹Ÿæœº 2 (å®¢æˆ·æœºæ“ä½œç³»ç»Ÿ + åº”ç”¨)&quot;]      VM3[&quot;è™šæ‹Ÿæœº 3 (å®¢æˆ·æœºæ“ä½œç³»ç»Ÿ + åº”ç”¨)&quot;]    end    Hypervisor[&quot;Hypervisor&quot;] -- &quot;ç®¡ç†ç¡¬ä»¶&quot; --&gt; CPU;    Hypervisor -- &quot;ç®¡ç†ç¡¬ä»¶&quot; --&gt; Memory;    Hypervisor -- &quot;ç®¡ç†ç¡¬ä»¶&quot; --&gt; Storage;    Hypervisor -- &quot;ç®¡ç†ç¡¬ä»¶&quot; --&gt; Network;    Hypervisor -- &quot;åˆ›å»ºå’Œè¿è¡Œ&quot; --&gt; VM1;    Hypervisor -- &quot;åˆ›å»ºå’Œè¿è¡Œ&quot; --&gt; VM2;    Hypervisor -- &quot;åˆ›å»ºå’Œè¿è¡Œ&quot; --&gt; VM3;  </pre></div><ul><li><strong>ä¼˜ç‚¹</strong>: æ€§èƒ½é«˜ã€å®‰å…¨æ€§å¥½ã€ç¨³å®šæ€§å¼ºã€‚</li><li><strong>ç¼ºç‚¹</strong>: é€šå¸¸éœ€è¦ä¸“é—¨çš„ç®¡ç†ç¡¬ä»¶ï¼Œé…ç½®ç›¸å¯¹å¤æ‚ã€‚</li></ul><h3 id="Type-2-å®¿ä¸»å‹-Hypervisor-Hosted"><a href="#Type-2-å®¿ä¸»å‹-Hypervisor-Hosted" class="headerlink" title="Type 2: å®¿ä¸»å‹ Hypervisor (Hosted)"></a>Type 2: å®¿ä¸»å‹ Hypervisor (Hosted)</h3><p>Type 2 Hypervisor åƒæ™®é€šåº”ç”¨ç¨‹åºä¸€æ ·ï¼Œè¿è¡Œåœ¨ä¸€ä¸ªå®Œæ•´çš„å®¿ä¸»æ“ä½œç³»ç»Ÿ (Host OS) ä¹‹ä¸Šã€‚å®ƒä¾èµ–å®¿ä¸»æ“ä½œç³»ç»Ÿæ¥ç®¡ç†ç¡¬ä»¶èµ„æºã€‚</p><p><strong>å¸¸è§ä¾‹å­</strong>: VMware Workstation, Oracle VirtualBox, QEMUã€‚</p><p><strong>æ¶æ„å›¾</strong>:</p><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD;    subgraph &quot;ç‰©ç†ç¡¬ä»¶&quot;        CPU[&quot;CPU&quot;]        Memory[&quot;å†…å­˜&quot;]        Storage[&quot;å­˜å‚¨&quot;]        Network[&quot;ç½‘ç»œ&quot;]    end    HostOS[&quot;å®¿ä¸»æ“ä½œç³»ç»Ÿ&quot;] -- &quot;ç®¡ç†&quot; --&gt; CPU    HostOS -- &quot;ç®¡ç†&quot; --&gt; Memory    HostOS -- &quot;ç®¡ç†&quot; --&gt; Storage    HostOS -- &quot;ç®¡ç†&quot; --&gt; Network    subgraph &quot;ç”¨æˆ·ç©ºé—´è¿›ç¨‹&quot;      Hypervisor[&quot;Hypervisor åº”ç”¨&quot;]    end        HostOS -- &quot;è¿è¡Œ&quot; --&gt; Hypervisor    subgraph &quot;è™šæ‹Ÿæœº&quot;        VM1[&quot;è™šæ‹Ÿæœº 1 (å®¢æˆ·æœºæ“ä½œç³»ç»Ÿ + åº”ç”¨)&quot;]        VM2[&quot;è™šæ‹Ÿæœº 2 (å®¢æˆ·æœºæ“ä½œç³»ç»Ÿ + åº”ç”¨)&quot;]    end    Hypervisor -- &quot;åˆ›å»ºå’Œè¿è¡Œ&quot; --&gt; VM1;    Hypervisor -- &quot;åˆ›å»ºå’Œè¿è¡Œ&quot; --&gt; VM2;  </pre></div><ul><li><strong>ä¼˜ç‚¹</strong>: å®‰è£…ç®€å•ï¼Œæ˜“äºä½¿ç”¨ï¼Œéå¸¸é€‚åˆä¸ªäººæ¡Œé¢å’Œå¼€å‘ç¯å¢ƒã€‚</li><li><strong>ç¼ºç‚¹</strong>: æ€§èƒ½å¼€é”€è¾ƒå¤§ï¼Œå› ä¸ºå¤šäº†ä¸€å±‚å®¿ä¸»æ“ä½œç³»ç»Ÿã€‚</li></ul><blockquote><p><strong>KVM çš„ç‰¹æ®Šæ€§</strong>: KVM æ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒå°† Linux å†…æ ¸æœ¬èº«è½¬å˜æˆäº†ä¸€ä¸ª Type 1 Hypervisorã€‚å½“ KVM æ¨¡å—åŠ è½½åï¼ŒLinux å†…æ ¸å°±å¯ä»¥ç›´æ¥ç®¡ç†å’Œè¿è¡Œè™šæ‹Ÿæœºï¼Œå› æ­¤å®ƒå…·å¤‡ Type 1 çš„æ€§èƒ½å’Œæ¶æ„ï¼Œä½†åˆä¿ç•™äº†å®Œæ•´ Linux æ“ä½œç³»ç»Ÿçš„åŠŸèƒ½ã€‚</p></blockquote><h2 id="3-Hypervisor-çš„å¯åŠ¨ä¸åˆå§‹åŒ–"><a href="#3-Hypervisor-çš„å¯åŠ¨ä¸åˆå§‹åŒ–" class="headerlink" title="3. Hypervisor çš„å¯åŠ¨ä¸åˆå§‹åŒ–"></a>3. Hypervisor çš„å¯åŠ¨ä¸åˆå§‹åŒ–</h2><p>äº†è§£ Hypervisor çš„æ¶æ„åï¼Œä¸€ä¸ªè‡ªç„¶è€Œç„¶çš„é—®é¢˜æ˜¯ï¼šå®ƒæ˜¯å¦‚ä½•å¯åŠ¨çš„ï¼Ÿå®ƒåœ¨è®¡ç®—æœºçš„å¯åŠ¨æµç¨‹ä¸­æ‰®æ¼”ä»€ä¹ˆè§’è‰²ï¼Ÿ</p><h3 id="3-1-è®¡ç®—æœºçš„é€šç”¨å¯åŠ¨æµç¨‹"><a href="#3-1-è®¡ç®—æœºçš„é€šç”¨å¯åŠ¨æµç¨‹" class="headerlink" title="3.1 è®¡ç®—æœºçš„é€šç”¨å¯åŠ¨æµç¨‹"></a>3.1 è®¡ç®—æœºçš„é€šç”¨å¯åŠ¨æµç¨‹</h3><p>æˆ‘ä»¬å¯ä»¥å°†è®¡ç®—æœºçš„å¯åŠ¨è¿‡ç¨‹æƒ³è±¡æˆä¸€ä¸ªæ¥åŠ›èµ›ï¼š</p><ol><li><strong>ç¬¬ä¸€æ£’ï¼šBIOS&#x2F;UEFI å›ºä»¶</strong>ï¼šæŒ‰ä¸‹ç”µæºåï¼Œä¸»æ¿ä¸Šçš„å›ºä»¶ç¨‹åºé¦–å…ˆè¢«æ¿€æ´»ã€‚å®ƒä¼šè¿›è¡Œç¡¬ä»¶è‡ªæ£€ï¼ˆPOSTï¼‰ï¼Œç„¶åæ ¹æ®é¢„è®¾çš„å¯åŠ¨é¡ºåºï¼Œå¯»æ‰¾ä¸‹ä¸€ä¸ªâ€œæ¥åŠ›è€…â€â€”â€”å¼•å¯¼åŠ è½½ç¨‹åºã€‚</li><li>**ç¬¬äºŒæ£’ï¼šå¼•å¯¼åŠ è½½ç¨‹åº (Bootloader)**ï¼šå›ºä»¶å°†æ§åˆ¶æƒäº¤ç»™å­˜å‚¨è®¾å¤‡ä¸Šçš„å¼•å¯¼åŠ è½½ç¨‹åºï¼ˆå¦‚ GRUBï¼‰ã€‚å®ƒçš„ä»»åŠ¡æ˜¯æ‰¾åˆ°æ“ä½œç³»ç»Ÿçš„å†…æ ¸æ–‡ä»¶ï¼Œå¹¶å°†å…¶åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</li><li>**ç¬¬ä¸‰æ£’ï¼šæ“ä½œç³»ç»Ÿå†…æ ¸ (Kernel)**ï¼šå†…æ ¸è¢«åŠ è½½åï¼Œå¼€å§‹æ¥ç®¡è®¡ç®—æœºã€‚å®ƒä¼šåˆå§‹åŒ–æ‰€æœ‰æ ¸å¿ƒç»„ä»¶ï¼ˆå¦‚è¿›ç¨‹ç®¡ç†ã€å†…å­˜ç®¡ç†ï¼‰ï¼Œå¹¶åŠ è½½é©±åŠ¨ç¨‹åºæ¥ç®¡ç†ç¡¬ä»¶ã€‚æœ€ç»ˆï¼Œå®ƒä¼šå¯åŠ¨ç”¨æˆ·ç©ºé—´çš„ç¨‹åºï¼Œå®Œæˆæ•´ä¸ªç³»ç»Ÿçš„å¯åŠ¨ã€‚</li></ol><h3 id="3-2-ä¸åŒ-Hypervisor-çš„â€œç™»åœºâ€æ–¹å¼"><a href="#3-2-ä¸åŒ-Hypervisor-çš„â€œç™»åœºâ€æ–¹å¼" class="headerlink" title="3.2 ä¸åŒ Hypervisor çš„â€œç™»åœºâ€æ–¹å¼"></a>3.2 ä¸åŒ Hypervisor çš„â€œç™»åœºâ€æ–¹å¼</h3><p>ä¸åŒç±»å‹çš„ Hypervisor åœ¨è¿™ä¸ªâ€œæ¥åŠ›èµ›â€ä¸­ç™»åœºçš„æ—¶æœºå„ä¸ç›¸åŒã€‚</p><ul><li><p><strong>Type 1 (KVM - é›†æˆå‹)</strong>:<br>KVM å¹¶ä¸æ˜¯ä¸€ä¸ªç‹¬ç«‹äºå†…æ ¸çš„è½¯ä»¶ã€‚å®ƒæœ¬èº«å°±æ˜¯ Linux å†…æ ¸çš„ä¸€éƒ¨åˆ†ã€‚å½“ Linux å†…æ ¸åœ¨ç¬¬ä¸‰æ£’å¯åŠ¨æ—¶ï¼Œå®ƒä¼šåŠ è½½ <code>kvm.ko</code> ç­‰å†…æ ¸æ¨¡å—ã€‚ä¸€æ—¦æ¨¡å—åŠ è½½ï¼Œå†…æ ¸è‡ªèº«å°±è¢«èµ‹äºˆäº† Hypervisor çš„èƒ½åŠ›ã€‚å› æ­¤ï¼Œ<strong>å¯åŠ¨ Linux å†…æ ¸çš„è¿‡ç¨‹ï¼Œæœ¬èº«å°±åœ¨å¯åŠ¨ KVM è¿™ä¸ª Hypervisor</strong>ã€‚</p></li><li><p><strong>Type 1 (ESXi - ç‹¬ç«‹å‹)</strong>:<br>è¿™ç±» Hypervisor æœ¬èº«å°±æ˜¯ä¸€ä¸ªç²¾ç®€çš„ã€ä¸“ç”¨çš„æ“ä½œç³»ç»Ÿã€‚åœ¨æ¥åŠ›èµ›çš„ç¬¬äºŒæ£’ï¼Œå¼•å¯¼åŠ è½½ç¨‹åºåŠ è½½çš„<strong>ä¸æ˜¯é€šç”¨å†…æ ¸ï¼Œè€Œæ˜¯ ESXi è‡ªå·±çš„å†…æ ¸</strong>ã€‚å¯åŠ¨åï¼Œç‰©ç†æœºå°±ç›´æ¥æˆä¸ºä¸€å°ä¸“ç”¨çš„è™šæ‹ŸåŒ–ä¸»æœºã€‚</p></li><li><p><strong>Type 2 (VirtualBox - å®¿ä¸»å‹)</strong>:<br>è¿™ç§ Hypervisor çš„å¯åŠ¨æœ€ç®€å•ã€‚å®ƒå®Œå…¨é”™å¼€äº†ç³»ç»Ÿå¯åŠ¨æµç¨‹ã€‚ç”¨æˆ·å…ˆæ­£å¸¸å¯åŠ¨ä¸€ä¸ªå®Œæ•´çš„å®¿ä¸»æ“ä½œç³»ç»Ÿï¼ˆå¦‚ Windows æˆ– macOSï¼‰ï¼Œç„¶ååƒæ‰“å¼€æ™®é€šè½¯ä»¶ä¸€æ ·ï¼Œ<strong>é€šè¿‡åŒå‡»å›¾æ ‡æ¥è¿è¡Œ VirtualBox ç¨‹åº</strong>ã€‚</p></li></ul><p><strong>KVM Hypervisor å¯åŠ¨æµç¨‹å›¾</strong>:</p><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD;    A[&quot;1. æŒ‰ä¸‹ç”µæºæŒ‰é’®&quot;] --&gt; B[&quot;2. ä¸»æ¿å›ºä»¶å¯åŠ¨ (BIOS&#x2F;UEFI)&quot;];    B -- &quot;ç¡¬ä»¶è‡ªæ£€, å¯»æ‰¾å¯åŠ¨è®¾å¤‡&quot; --&gt; C[&quot;3. å¼•å¯¼åŠ è½½ç¨‹åº (GRUB)&quot;];    C -- &quot;åŠ è½½å†…æ ¸åˆ°å†…å­˜&quot; --&gt; D[&quot;4. Linux å†…æ ¸å¯åŠ¨åˆå§‹åŒ–&quot;];    D -- &quot;åŠ è½½æ¨¡å—&quot; --&gt; E[&quot;5. åŠ è½½KVMæ¨¡å— (kvm.ko)&quot;];    E --&gt; F[&quot;&lt;b&gt;Linuxå†…æ ¸æ­¤æ—¶å·²æˆä¸ºType 1 Hypervisor&lt;&#x2F;b&gt;&quot;];    F -- &quot;å¯åŠ¨ç”¨æˆ·æœåŠ¡&quot; --&gt; G[&quot;6. ç³»ç»Ÿå®Œå…¨å¯åŠ¨, ç­‰å¾…æŒ‡ä»¤&quot;];    G --&gt; H[&quot;7. ç”¨æˆ·é€šè¿‡QEMUç­‰å·¥å…·&lt;br&gt;è¯·æ±‚åˆ›å»ºè™šæ‹Ÿæœº&quot;];    F -- &quot;æ‰§è¡Œè™šæ‹ŸåŒ–æ“ä½œ&quot; --&gt; H;  </pre></div><h3 id="3-3-ä»ä¼ ç»Ÿè™šæ‹ŸåŒ–åˆ°æœºå¯†è®¡ç®—ï¼šHyperEnclave-çš„åˆ›æ–°"><a href="#3-3-ä»ä¼ ç»Ÿè™šæ‹ŸåŒ–åˆ°æœºå¯†è®¡ç®—ï¼šHyperEnclave-çš„åˆ›æ–°" class="headerlink" title="3.3 ä»ä¼ ç»Ÿè™šæ‹ŸåŒ–åˆ°æœºå¯†è®¡ç®—ï¼šHyperEnclave çš„åˆ›æ–°"></a>3.3 ä»ä¼ ç»Ÿè™šæ‹ŸåŒ–åˆ°æœºå¯†è®¡ç®—ï¼šHyperEnclave çš„åˆ›æ–°</h3><p>åœ¨äº†è§£äº†ä¼ ç»Ÿ Hypervisor çš„å¯åŠ¨æœºåˆ¶åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªæ›´åŠ å‰æ²¿çš„åº”ç”¨åœºæ™¯ã€‚éšç€äº‘è®¡ç®—å’Œè¾¹ç¼˜è®¡ç®—çš„æ™®åŠï¼Œ<strong>æ•°æ®å®‰å…¨</strong>å’Œ<strong>éšç§ä¿æŠ¤</strong>æˆä¸ºäº†è¶Šæ¥è¶Šé‡è¦çš„éœ€æ±‚ã€‚ä¼ ç»Ÿçš„è™šæ‹ŸåŒ–æŠ€æœ¯è™½ç„¶æä¾›äº†èµ„æºéš”ç¦»ï¼Œä½†åœ¨é¢å¯¹æ¶æ„ Hypervisor æˆ–æ“ä½œç³»ç»Ÿæ”»å‡»æ—¶ï¼Œä»ç„¶å­˜åœ¨å®‰å…¨é£é™©ã€‚</p><p>æ­£æ˜¯åœ¨è¿™æ ·çš„èƒŒæ™¯ä¸‹ï¼Œ<strong>æœºå¯†è®¡ç®— (Confidential Computing)</strong> æŠ€æœ¯åº”è¿è€Œç”Ÿã€‚å®ƒé€šè¿‡ç¡¬ä»¶çº§çš„å®‰å…¨éš”ç¦»ï¼Œç¡®ä¿å³ä½¿åº•å±‚ç³»ç»Ÿè¢«æ”»ç ´ï¼Œæ•æ„Ÿæ•°æ®ä¹Ÿèƒ½å¾—åˆ°ä¿æŠ¤ã€‚è€Œ HyperEnclave ä½œä¸ºè¿™ä¸€é¢†åŸŸçš„åˆ›æ–°è€…ï¼Œå±•ç¤ºäº†å¦‚ä½•å°†ä¼ ç»Ÿçš„ Hypervisor æŠ€æœ¯ä¸ç°ä»£å®‰å…¨éœ€æ±‚ç›¸ç»“åˆã€‚</p><h4 id="æœºå¯†è®¡ç®—çš„æŠ€æœ¯æ¼”è¿›"><a href="#æœºå¯†è®¡ç®—çš„æŠ€æœ¯æ¼”è¿›" class="headerlink" title="æœºå¯†è®¡ç®—çš„æŠ€æœ¯æ¼”è¿›"></a>æœºå¯†è®¡ç®—çš„æŠ€æœ¯æ¼”è¿›</h4><p>æœºå¯†è®¡ç®—æŠ€æœ¯ç»å†äº†ä»<strong>åº”ç”¨çº§éš”ç¦»</strong>åˆ°<strong>è™šæ‹Ÿæœºçº§éš”ç¦»</strong>çš„æ¼”è¿›è¿‡ç¨‹ï¼š</p><p><strong>ç¬¬ä¸€ä»£ï¼šåº”ç”¨çº§ Enclave</strong><br>ä»¥ <strong>Intel SGX</strong> ä¸ºä»£è¡¨ï¼Œåœ¨è¿è¡Œçš„åº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­ï¼Œé€šè¿‡ç¡¬ä»¶æŠ€æœ¯éš”ç¦»å‡ºä¸€å—åŠ å¯†çš„å†…å­˜â€å®‰å…¨åŒºâ€ï¼ˆEnclaveï¼‰ï¼Œç”¨äºä¿æŠ¤æ ¸å¿ƒä»£ç å’Œæ•°æ®ã€‚å®ƒéš”ç¦»çš„æ˜¯<strong>è¿›ç¨‹çš„ä¸€éƒ¨åˆ†</strong>ã€‚</p><p><strong>ç¬¬äºŒä»£ï¼šè™šæ‹Ÿæœºçº§ Enclave</strong><br>ä»¥ <strong>Intel TDX</strong> &#x2F; <strong>AMD SEV</strong> å’Œ <strong>HyperEnclave</strong> ä¸ºä»£è¡¨ï¼Œå°†éš”ç¦»çš„å•ä½æå‡åˆ°äº†æ•´ä¸ªè™šæ‹Ÿæœºã€‚å®ƒä¿æŠ¤çš„æ˜¯<strong>ä¸€ä¸ªå®Œæ•´çš„è™šæ‹Ÿæœº</strong>ï¼Œä½¿å…¶èƒ½å¤ŸæŠµæŠ—æ¥è‡ªå®¿ä¸» Hypervisor æˆ–æ“ä½œç³»ç»Ÿçš„æ”»å‡»ã€‚</p><p><strong>æŠ€æœ¯å¯¹æ¯”</strong>:</p><ul><li><strong>Intel SGX</strong>: ç¡¬ä»¶çº§å¯ä¿¡æ‰§è¡Œç¯å¢ƒï¼Œç›´æ¥åœ¨ CPU ä¸­å®ç°å†…å­˜åŠ å¯†å’Œéš”ç¦»</li><li><strong>Intel TDX</strong>: åŸºäº VMX ç¡¬ä»¶è™šæ‹ŸåŒ–çš„æœºå¯†è®¡ç®—ï¼Œå°†æ•´ä¸ªè™šæ‹Ÿæœºä½œä¸ºå¯ä¿¡æ‰§è¡Œç¯å¢ƒ</li><li><strong>AMD SEV</strong>: åŸºäº SVM ç¡¬ä»¶è™šæ‹ŸåŒ–çš„æœºå¯†è®¡ç®—ï¼Œé€šè¿‡å†…å­˜åŠ å¯†ä¿æŠ¤è™šæ‹Ÿæœº</li><li><strong>HyperEnclave</strong>: è½¯ä»¶å®ç°çš„ SGX å…¼å®¹å±‚ï¼Œé€šè¿‡è™šæ‹ŸåŒ–æŠ€æœ¯æ¨¡æ‹Ÿ SGX åŠŸèƒ½ï¼Œæ”¯æŒå¤šç§ CPU å¹³å°</li></ul><h4 id="HyperEnclave-çš„çœŸå®æœºåˆ¶ï¼šä¸€ä¸ªåŠ¨æ€åŠ è½½çš„ç‹¬ç«‹-Hypervisor"><a href="#HyperEnclave-çš„çœŸå®æœºåˆ¶ï¼šä¸€ä¸ªåŠ¨æ€åŠ è½½çš„ç‹¬ç«‹-Hypervisor" class="headerlink" title="HyperEnclave çš„çœŸå®æœºåˆ¶ï¼šä¸€ä¸ªåŠ¨æ€åŠ è½½çš„ç‹¬ç«‹ Hypervisor"></a>HyperEnclave çš„çœŸå®æœºåˆ¶ï¼šä¸€ä¸ªåŠ¨æ€åŠ è½½çš„ç‹¬ç«‹ Hypervisor</h4><p><strong>HyperEnclave çš„å®ç°ä¸ä¾èµ– KVMï¼Œå®ƒæœ¬èº«å°±æ˜¯ä¸€ä¸ªç”¨ Rust ç¼–å†™çš„ã€å®Œæ•´çš„ã€ç‹¬ç«‹çš„ Type 1 Hypervisorã€‚</strong></p><p>å®ƒåˆ›é€ æ€§åœ°ä½¿ç”¨äº†ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ Linux ç³»ç»Ÿä½œä¸ºâ€è·³æ¿â€æ¥å¯åŠ¨è‡ªå·±ï¼Œä¸€æ—¦è¿è¡Œï¼Œå®ƒå°±å®Œå…¨æ¥ç®¡ç¡¬ä»¶è™šæ‹ŸåŒ–çš„æ§åˆ¶æƒã€‚</p><p>å…¶ç²¾ç¡®çš„å¯åŠ¨å’Œå·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š</p><h3 id="1-åŠ è½½ä¸è·³è½¬"><a href="#1-åŠ è½½ä¸è·³è½¬" class="headerlink" title="1. åŠ è½½ä¸è·³è½¬"></a>1. <strong>åŠ è½½ä¸è·³è½¬</strong></h3><p>ç”¨æˆ·é€šè¿‡ä¸€ä¸ªç‰¹åˆ¶çš„ Linux å†…æ ¸é©±åŠ¨ï¼ˆ<code>hyper_enclave.ko</code>ï¼‰æ¥åŠ è½½ HyperEnclave çš„äºŒè¿›åˆ¶ç¨‹åºã€‚è¯¥é©±åŠ¨éšåä¼šåœ¨æ‰€æœ‰åœ¨çº¿çš„ CPU æ ¸å¿ƒä¸Šï¼Œæ‰§è¡ŒæŒ‡ä»¤è·³è½¬åˆ° HyperEnclave çš„å…¥å£ç‚¹ <code>entry()</code>ï¼Œä»è€Œå°† CPU çš„<strong>å®Œå…¨æ§åˆ¶æƒ</strong>äº¤ç»™ HyperEnclaveã€‚</p><h3 id="2-ä¿å­˜ä¸æ¥ç®¡"><a href="#2-ä¿å­˜ä¸æ¥ç®¡" class="headerlink" title="2. ä¿å­˜ä¸æ¥ç®¡"></a>2. <strong>ä¿å­˜ä¸æ¥ç®¡</strong></h3><p>HyperEnclave æ¥ç®¡ CPU åï¼Œç¬¬ä¸€ä»¶äº‹æ˜¯ä¿å­˜å¥½ Linux å†…æ ¸çš„å®Œæ•´æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆå¯„å­˜å™¨çŠ¶æ€ã€æ ˆæŒ‡é’ˆ <code>linux_sp</code> ç­‰ï¼‰ï¼Œè¿™æ˜¯ä¸ºäº†ç¡®ä¿å°†æ¥å¯ä»¥å®‰å…¨åœ°é€€å‡ºå¹¶è¿”å›åˆ° Linuxã€‚</p><h3 id="3-ç‹¬ç«‹åˆå§‹åŒ–"><a href="#3-ç‹¬ç«‹åˆå§‹åŒ–" class="headerlink" title="3. ç‹¬ç«‹åˆå§‹åŒ–"></a>3. <strong>ç‹¬ç«‹åˆå§‹åŒ–</strong></h3><p>æ¥ä¸‹æ¥ï¼ŒHyperEnclave ä½œä¸º<strong>ä¸€ä¸ªå…¨æ–°çš„ Hypervisor</strong> å¼€å§‹è¿›è¡Œå½»åº•çš„åˆå§‹åŒ–ã€‚å®ƒä¸ä¾èµ– Linux çš„ä»»ä½•æœåŠ¡ï¼Œè€Œæ˜¯å»ºç«‹è‡ªå·±çš„å†…å­˜ç®¡ç†ã€é¡µè¡¨ã€ä¸­æ–­æè¿°ç¬¦è¡¨ï¼ˆIDTï¼‰ï¼Œå¹¶ä¸ºå³å°†è¿è¡Œçš„æœºå¯†è™šæ‹Ÿæœºé…ç½®è™šæ‹Ÿæœºæ§åˆ¶ç»“æ„ï¼ˆVMCS&#x2F;VMCBï¼‰ã€‚</p><h3 id="4-å¯åŠ¨æœºå¯†VM"><a href="#4-å¯åŠ¨æœºå¯†VM" class="headerlink" title="4. å¯åŠ¨æœºå¯†VM"></a>4. <strong>å¯åŠ¨æœºå¯†VM</strong></h3><p>æ‰€æœ‰åˆå§‹åŒ–å®Œæˆåï¼ŒHyperEnclave æ ¹æ® CPU æ¶æ„æ‰§è¡Œç›¸åº”çš„è™šæ‹ŸåŒ–æŒ‡ä»¤ï¼š</p><ul><li><strong>Intel å¹³å°</strong>: æ‰§è¡Œ <code>vmlaunch</code> æŒ‡ä»¤å¯åŠ¨è™šæ‹Ÿæœº</li><li><strong>AMD å¹³å°</strong>: æ‰§è¡Œ <code>vmrun</code> æŒ‡ä»¤å¯åŠ¨è™šæ‹Ÿæœº</li></ul><p>ä»æ­¤åˆ»èµ·ï¼Œæ‰€æœ‰è™šæ‹ŸåŒ–ç›¸å…³çš„ <code>VM-Exit</code> äº‹ä»¶éƒ½ç”± HyperEnclave è‡ªè¡Œå¤„ç†ï¼Œä¸ Linux å†…æ ¸æˆ– KVM æ¯«æ— å…³ç³»ã€‚</p><p><strong>æ€»ç»“</strong>ï¼šHyperEnclave å’Œ KVM æ˜¯<strong>å¹³çº§çš„ã€äºŒé€‰ä¸€</strong>çš„ Hypervisorã€‚HyperEnclave åªæ˜¯åˆ©ç”¨ Linux å†…æ ¸é©±åŠ¨å®Œæˆäº†ä¸€æ¬¡â€çƒ­éƒ¨ç½²â€ï¼Œå®ç°äº†ä»ä¸€ä¸ªé€šç”¨æ“ä½œç³»ç»Ÿåˆ°ä¸“ç”¨ Hypervisor çš„â€å˜èº«â€ã€‚</p><p><strong>HyperEnclave å¯åŠ¨æµç¨‹å›¾</strong>:</p><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    subgraph &quot;Linux ç³»ç»Ÿ&quot;        App[&quot;ç”¨æˆ·åº”ç”¨ç¨‹åº&quot;] -- &quot;ioctl() ç³»ç»Ÿè°ƒç”¨&quot; --&gt; Driver[&quot;HyperEnclave å†…æ ¸é©±åŠ¨&quot;]        Driver -- &quot;1. åŠ è½½ HyperEnclave äºŒè¿›åˆ¶æ–‡ä»¶åˆ°å†…å­˜&quot; --&gt; H_Bin[&quot;HyperEnclave ä»£ç &quot;]        Driver -- &quot;2. åœ¨æ¯ä¸ªCPUä¸Šè·³è½¬åˆ° entry() å‡½æ•°&quot; --&gt; H_Bin    end    subgraph &quot;ç¡¬ä»¶æ§åˆ¶å±‚ (HyperEnclave æ¥ç®¡)&quot;        H_Bin -- &quot;3. ä¿å­˜ Linux çŠ¶æ€å¹¶å®Œå…¨æ¥ç®¡ CPU&quot; --&gt; CPU[&quot;CPU ç¡¬ä»¶ (VMX&#x2F;SVM)&quot;]        H_Bin -- &quot;4. ä½œä¸º Hypervisor è‡ªæˆ‘åˆå§‹åŒ– (å†…å­˜, VMCS&#x2F;VMCB ç­‰)&quot; --&gt; CPU        H_Bin -- &quot;5. æ‰§è¡Œ &#39;vmlaunch&#39;(Intel) æˆ– &#39;vmrun&#39;(AMD) å¯åŠ¨æœºå¯†è™šæ‹Ÿæœº&quot; --&gt; GuestVM[&quot;æœºå¯†å®¢æˆ·è™šæ‹Ÿæœº&quot;]    end    GuestVM -- &quot;è™šæ‹Ÿæœºé€€å‡º (ä¾‹å¦‚ I&#x2F;O)&quot; --&gt; H_Bin    H_Bin -- &quot;å¤„ç†é€€å‡ºå¹¶æ¢å¤è™šæ‹Ÿæœº&quot; --&gt; GuestVM    style H_Bin fill:#d4edda,stroke:#155724,stroke-width:2px  </pre></div><h2 id="4-å†…éƒ¨æ ¸å¿ƒåŸç†ä¸æœºåˆ¶"><a href="#4-å†…éƒ¨æ ¸å¿ƒåŸç†ä¸æœºåˆ¶" class="headerlink" title="4. å†…éƒ¨æ ¸å¿ƒåŸç†ä¸æœºåˆ¶"></a>4. å†…éƒ¨æ ¸å¿ƒåŸç†ä¸æœºåˆ¶</h2><p>Hypervisor çš„é­”åŠ›åœ¨äºå®ƒå¦‚ä½•å·§å¦™åœ°â€œæ¬ºéª—â€å®¢æˆ·æœºæ“ä½œç³»ç»Ÿï¼Œè®©å…¶ç›¸ä¿¡è‡ªå·±æ‹¥æœ‰ç¡¬ä»¶ã€‚è¿™ä¸»è¦é€šè¿‡è™šæ‹ŸåŒ– CPUã€å†…å­˜å’Œ I&#x2F;O è®¾å¤‡æ¥å®ç°ã€‚</p><h3 id="CPU-è™šæ‹ŸåŒ–"><a href="#CPU-è™šæ‹ŸåŒ–" class="headerlink" title="CPU è™šæ‹ŸåŒ–"></a>CPU è™šæ‹ŸåŒ–</h3><p>CPU è™šæ‹ŸåŒ–æ˜¯æ ¸å¿ƒã€‚ç°ä»£ CPU æœ‰ä¸åŒçš„ç‰¹æƒçº§ï¼ˆå¦‚ x86 æ¶æ„çš„ Ring 0-3ï¼‰ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸è¿è¡Œåœ¨æœ€é«˜ç‰¹æƒçº§ Ring 0ï¼Œè€Œåº”ç”¨ç¨‹åºåœ¨ Ring 3ã€‚é—®é¢˜æ˜¯ï¼Œå®¢æˆ·æœºæ“ä½œç³»ç»Ÿä¹Ÿè®¤ä¸ºè‡ªå·±åº”è¯¥åœ¨ Ring 0 è¿è¡Œï¼Œä½†ç‰©ç† CPU çš„ Ring 0 å·²ç»è¢« Hypervisor å ç”¨äº†ã€‚</p><p>æ—©æœŸçš„è§£å†³æ–¹æ¡ˆæ˜¯**äºŒè¿›åˆ¶ç¿»è¯‘ (Binary Translation)**ï¼ŒHypervisor åŠ¨æ€åœ°ç¿»è¯‘å®¢æˆ·æœºæ“ä½œç³»ç»Ÿçš„æ•æ„ŸæŒ‡ä»¤ã€‚ä½†è¿™ç§æ–¹å¼æ•ˆç‡ä½ä¸‹ã€‚</p><p>ç°ä»£çš„è§£å†³æ–¹æ¡ˆæ˜¯**ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ– (Hardware-assisted Virtualization)**ï¼Œå³ Intel çš„ <strong>VT-x</strong> å’Œ AMD çš„ <strong>AMD-V</strong> æŠ€æœ¯ã€‚</p><ul><li><strong>æ ¸å¿ƒæ€æƒ³</strong>: å¼•å…¥äº†ä¸€ç§æ–°çš„æ“ä½œæ¨¡å¼ï¼Œç§°ä¸ºâ€œæ ¹æ¨¡å¼ (Root Operation)â€å’Œâ€œéæ ¹æ¨¡å¼ (Non-root Operation)â€ã€‚</li><li><strong>Hypervisor</strong> è¿è¡Œåœ¨æ ¹æ¨¡å¼ä¸‹ï¼Œæ‹¥æœ‰æœ€é«˜æƒé™ã€‚</li><li><strong>è™šæ‹Ÿæœº</strong> è¿è¡Œåœ¨éæ ¹æ¨¡å¼ä¸‹ï¼Œå³ä½¿åœ¨ Ring 0ï¼Œå…¶æƒé™ä¹Ÿå— Hypervisor é™åˆ¶ã€‚</li><li>å½“å®¢æˆ·æœºæ“ä½œç³»ç»Ÿæ‰§è¡Œæ•æ„ŸæŒ‡ä»¤æ—¶ï¼ŒCPU ä¼šè‡ªåŠ¨è§¦å‘ä¸€æ¬¡<strong>VM Exit</strong>ï¼Œå°†æ§åˆ¶æƒäº¤è¿˜ç»™æ ¹æ¨¡å¼ä¸‹çš„ Hypervisorã€‚</li><li>Hypervisor å¤„ç†å®Œæ•æ„Ÿæ“ä½œåï¼Œå†æ‰§è¡Œ <strong>VM Entry</strong>ï¼Œå°†æ§åˆ¶æƒè¿”è¿˜ç»™è™šæ‹Ÿæœºã€‚</li></ul><p>è¿™ä¸ªè¿‡ç¨‹è™½ç„¶æœ‰åˆ‡æ¢å¼€é”€ï¼Œä½†è¿œæ¯”è½¯ä»¶æ¨¡æ‹Ÿé«˜æ•ˆå’Œç®€å•ã€‚</p><h3 id="å†…å­˜è™šæ‹ŸåŒ–"><a href="#å†…å­˜è™šæ‹ŸåŒ–" class="headerlink" title="å†…å­˜è™šæ‹ŸåŒ–"></a>å†…å­˜è™šæ‹ŸåŒ–</h3><p>å®¢æˆ·æœºæ“ä½œç³»ç»Ÿç®¡ç†çš„æ˜¯<strong>å®¢æˆ·æœºç‰©ç†åœ°å€ (Guest Physical Address, GPA)<strong>ï¼Œä½† Hypervisor éœ€è¦å°†å…¶æ˜ å°„åˆ°çœŸæ­£çš„</strong>ä¸»æœºç‰©ç†åœ°å€ (Host Physical Address, HPA)</strong> ä¸Šã€‚</p><ul><li><p><strong>ä¼ ç»Ÿæ–¹æ³•ï¼šå½±å­é¡µè¡¨ (Shadow Page Tables)</strong>: Hypervisor ä¸ºæ¯ä¸ªè™šæ‹Ÿæœºç»´æŠ¤ä¸€å¥—â€œå½±å­é¡µè¡¨â€ï¼Œè¿™å¥—é¡µè¡¨ç›´æ¥å°†å®¢æˆ·æœºçš„è™šæ‹Ÿåœ°å€ (GVA) æ˜ å°„åˆ°ä¸»æœºç‰©ç†åœ°å€ (HPA)ã€‚å½“å®¢æˆ·æœºä¿®æ”¹è‡ªå·±çš„é¡µè¡¨æ—¶ï¼ŒHypervisor ä¼šæ•è·è¯¥æ“ä½œå¹¶åŒæ­¥æ›´æ–°å½±å­é¡µè¡¨ï¼Œå¼€é”€å¾ˆå¤§ã€‚</p></li><li><p><strong>ç¡¬ä»¶è¾…åŠ©æ–¹æ³•ï¼šäºŒçº§åœ°å€ç¿»è¯‘ (Second Level Address Translation, SLAT)</strong>: Intel çš„ <strong>EPT (Extended Page Tables)</strong> å’Œ AMD çš„ <strong>NPT (Nested Page Tables)</strong> æŠ€æœ¯ã€‚</p><ul><li>CPU çš„å†…å­˜ç®¡ç†å•å…ƒ (MMU) ç¡¬ä»¶æœ¬èº«æ”¯æŒä¸¤çº§é¡µè¡¨ã€‚</li><li>ç¬¬ä¸€çº§ç”±å®¢æˆ·æœºæ“ä½œç³»ç»Ÿç®¡ç†ï¼ˆGVA -&gt; GPAï¼‰ã€‚</li><li>ç¬¬äºŒçº§ç”± Hypervisor ç®¡ç†ï¼ˆGPA -&gt; HPAï¼‰ã€‚</li><li>åœ°å€ç¿»è¯‘å®Œå…¨ç”±ç¡¬ä»¶å®Œæˆï¼ŒHypervisor åªéœ€ç»´æŠ¤å¥½ç¬¬äºŒçº§é¡µè¡¨å³å¯ï¼Œæå¤§æå‡äº†å†…å­˜è™šæ‹ŸåŒ–æ€§èƒ½ã€‚</li></ul></li></ul><p><strong>å†…å­˜ç¿»è¯‘æµç¨‹å›¾</strong>:</p><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph LR;    subgraph &quot;å®¢æˆ·æœºæ“ä½œç³»ç»Ÿ&quot;        GVA[&quot;å®¢æˆ·æœºè™šæ‹Ÿåœ°å€ (GVA)&quot;]        GPA[&quot;å®¢æˆ·æœºç‰©ç†åœ°å€ (GPA)&quot;]        GVA -- &quot;å®¢æˆ·æœºé¡µè¡¨&quot; --&gt; GPA;    end    subgraph &quot;Hypervisor&quot;        HPA[&quot;ä¸»æœºç‰©ç†åœ°å€ (HPA)&quot;]        GPA -- &quot;äºŒçº§åœ°å€ç¿»è¯‘ (EPT&#x2F;NPT)&quot; --&gt; HPA;    end        subgraph &quot;ç¡¬ä»¶&quot;        MMU[&quot;CPU å†…å­˜ç®¡ç†å•å…ƒ&quot;]    end    HPA -- &quot;è®¿é—®&quot; --&gt; MMU;  </pre></div><h3 id="I-O-è™šæ‹ŸåŒ–"><a href="#I-O-è™šæ‹ŸåŒ–" class="headerlink" title="I&#x2F;O è™šæ‹ŸåŒ–"></a>I&#x2F;O è™šæ‹ŸåŒ–</h3><p>I&#x2F;O è™šæ‹ŸåŒ–æ˜¯æœ€å¤æ‚çš„ï¼Œå› ä¸ºå®ƒæ¶‰åŠç§ç±»ç¹å¤šçš„å¤–éƒ¨è®¾å¤‡ã€‚ä¸»è¦æœ‰ä¸‰ç§æ–¹å¼ï¼š</p><ol><li><p><strong>å…¨æ¨¡æ‹Ÿ (Full Emulation)</strong>:</p><ul><li>Hypervisor æ¨¡æ‹Ÿä¸€ä¸ªçœŸå®çš„ã€å…·ä½“çš„ç¡¬ä»¶è®¾å¤‡ï¼Œä¾‹å¦‚ä¸€ä¸ª Intel E1000 ç½‘å¡æˆ–ä¸€ä¸ª IDE æ§åˆ¶å™¨ã€‚</li><li><strong>ä¼˜ç‚¹</strong>: å®¢æˆ·æœºæ“ä½œç³»ç»Ÿæ— éœ€ä»»ä½•ç‰¹æ®Šé©±åŠ¨ï¼Œå…¼å®¹æ€§å¥½ã€‚</li><li><strong>ç¼ºç‚¹</strong>: æ•ˆç‡æä½ã€‚æ¯ä¸€æ¬¡ I&#x2F;O æ“ä½œéƒ½éœ€è¦ Hypervisor ä»‹å…¥ã€ç¿»è¯‘å’Œæ¨¡æ‹Ÿï¼ŒCPU å¼€é”€å·¨å¤§ã€‚QEMU ç»å¸¸ç”¨äºæ­¤ç›®çš„ã€‚</li></ul></li><li><p><strong>åŠè™šæ‹ŸåŒ– (Paravirtualization, PV)</strong>:</p><ul><li>è¿™æ˜¯ä¸€ç§åä½œæ¨¡å¼ã€‚å®¢æˆ·æœºæ“ä½œç³»ç»Ÿâ€œçŸ¥é“â€è‡ªå·±è¿è¡Œåœ¨è™šæ‹Ÿç¯å¢ƒä¸­ï¼Œå¹¶å®‰è£…ä¸“é—¨çš„â€œåŠè™šæ‹ŸåŒ–é©±åŠ¨â€ã€‚</li><li>Hypervisor ä¹Ÿæä¾›ä¸€ä¸ªé«˜æ•ˆçš„åç«¯é©±åŠ¨ã€‚ä¸¤è€…é€šè¿‡ä¸€ä¸ªä¼˜åŒ–çš„é€šä¿¡æ¥å£ï¼ˆå¦‚å…±äº«å†…å­˜ç¯å½¢ç¼“å†²åŒºï¼‰ç›´æ¥äº¤æ¢æ•°æ®ã€‚</li><li><strong>VirtIO</strong> å°±æ˜¯ä¸€ä¸ªæ ‡å‡†çš„åŠè™šæ‹ŸåŒ–æ¥å£è§„èŒƒã€‚</li><li><strong>ä¼˜ç‚¹</strong>: æ€§èƒ½è¿œé«˜äºå…¨æ¨¡æ‹Ÿï¼Œæ¥è¿‘åŸç”Ÿæ€§èƒ½ã€‚</li><li><strong>ç¼ºç‚¹</strong>: éœ€è¦åœ¨å®¢æˆ·æœºä¸­å®‰è£…ç‰¹å®šé©±åŠ¨ã€‚</li></ul></li><li><p><strong>è®¾å¤‡ç›´é€š (Passthrough)</strong>:</p><ul><li>åˆ©ç”¨ <strong>Intel VT-d</strong> æˆ– <strong>AMD-Vi (IOMMU)</strong> æŠ€æœ¯ï¼Œå°†ä¸€ä¸ªç‰©ç† PCI è®¾å¤‡ï¼ˆå¦‚ç½‘å¡ã€GPUï¼‰ç›´æ¥åˆ†é…ç»™ä¸€ä¸ªè™šæ‹Ÿæœºã€‚</li><li>è¯¥è™šæ‹Ÿæœºå¯ä»¥åƒåœ¨ç‰©ç†æœºä¸Šä¸€æ ·ç›´æ¥æ“ä½œè¿™ä¸ªç¡¬ä»¶ï¼Œæ— éœ€ Hypervisor ä»‹å…¥ I&#x2F;O è¿‡ç¨‹ã€‚</li><li><strong>ä¼˜ç‚¹</strong>: èƒ½å¤Ÿè¾¾åˆ°å‡ ä¹ 100% çš„åŸç”Ÿæ€§èƒ½ï¼Œé€‚ç”¨äºé«˜æ€§èƒ½è®¡ç®—ã€NFV ç­‰åœºæ™¯ã€‚</li><li><strong>ç¼ºç‚¹</strong>: è¯¥è®¾å¤‡æ— æ³•è¢«å…¶ä»–è™šæ‹Ÿæœºå…±äº«ã€‚</li></ul></li></ol><p><strong>I&#x2F;O è™šæ‹ŸåŒ–æ–¹æ¡ˆå¯¹æ¯”å›¾</strong>:</p><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD;    subgraph &quot;å®¢æˆ·æœºæ“ä½œç³»ç»Ÿ&quot;      Request[&quot;I&#x2F;O è¯·æ±‚&quot;]    end        subgraph &quot;Hypervisor&quot;      Hypervisor_Layer[&quot;Hypervisor å±‚&quot;]    end        subgraph &quot;ç¡¬ä»¶&quot;      PhysicalDevice[&quot;ç‰©ç†è®¾å¤‡&quot;]    end        Request --&gt; Hypervisor_Layer;        subgraph &quot;è™šæ‹ŸåŒ–æ–¹æ³•&quot;      Emulation[&quot;å…¨æ¨¡æ‹Ÿ&quot;]      Paravirt[&quot;åŠè™šæ‹ŸåŒ– (VirtIO)&quot;]      Passthrough[&quot;è®¾å¤‡ç›´é€š (VT-d&#x2F;IOMMU)&quot;]    end    Hypervisor_Layer --&gt; Emulation;    Hypervisor_Layer --&gt; Paravirt;    Hypervisor_Layer --&gt; Passthrough;        Emulation -- &quot;æ…¢é€Ÿè·¯å¾„&quot; --&gt; PhysicalDevice;    Paravirt -- &quot;ä¼˜åŒ–è·¯å¾„&quot; --&gt; PhysicalDevice;    Passthrough -- &quot;ç›´æ¥è®¿é—®&quot; --&gt; PhysicalDevice;  </pre></div><h2 id="5-ä¸Šä¸‹æ¸¸äº¤äº’ä¸åä½œ"><a href="#5-ä¸Šä¸‹æ¸¸äº¤äº’ä¸åä½œ" class="headerlink" title="5. ä¸Šä¸‹æ¸¸äº¤äº’ä¸åä½œ"></a>5. ä¸Šä¸‹æ¸¸äº¤äº’ä¸åä½œ</h2><p>Hypervisor ä½äºä¸€ä¸ªå¤æ‚ç”Ÿæ€çš„ä¸­å¿ƒï¼Œä¸ä¸Šä¸‹æ¸¸ç³»ç»Ÿç´§å¯†åä½œã€‚</p><ul><li><p><strong>ä¸ç¡¬ä»¶ (ä¸‹æ¸¸) çš„äº¤äº’</strong>:</p><ul><li>Hypervisor åœ¨å¯åŠ¨æ—¶ä¼šæ£€æµ‹æ‰€æœ‰ç‰©ç†ç¡¬ä»¶ï¼ˆCPUã€å†…å­˜ã€å­˜å‚¨ã€ç½‘ç»œï¼‰ï¼Œå¹¶å–å¾—å®ƒä»¬çš„æ§åˆ¶æƒã€‚</li><li>å®ƒé€šè¿‡ç¡¬ä»¶è™šæ‹ŸåŒ–æ‰©å±•ï¼ˆVT-x, EPT ç­‰ï¼‰æ¥è°ƒåº¦ CPU å’Œå†…å­˜èµ„æºã€‚</li><li>å®ƒç®¡ç†ç‰©ç†è®¾å¤‡çš„è®¿é—®ï¼Œè¦ä¹ˆé€šè¿‡æ¨¡æ‹Ÿï¼Œè¦ä¹ˆé€šè¿‡åŠè™šæ‹ŸåŒ–åç«¯ï¼Œè¦ä¹ˆé€šè¿‡ IOMMU è¿›è¡Œè®¾å¤‡åˆ†é…ã€‚</li></ul></li><li><p><strong>ä¸å®¢æˆ·æœºæ“ä½œç³»ç»Ÿ (ä¸Šæ¸¸) çš„äº¤äº’</strong>:</p><ul><li>Hypervisor å‘å®¢æˆ·æœºå‘ˆç°ä¸€ä¸ªæ ‡å‡†åŒ–çš„è™šæ‹Ÿç¡¬ä»¶å¹³å°ã€‚</li><li>å®¢æˆ·æœºæ“ä½œç³»ç»Ÿä½¿ç”¨è‡ªå·±çš„æ ‡å‡†é©±åŠ¨ç¨‹åºä¸è¿™äº›è™šæ‹Ÿè®¾å¤‡äº¤äº’ã€‚</li><li>ä¸ºäº†è·å¾—æ›´å¥½çš„æ€§èƒ½ï¼Œå¯ä»¥åœ¨å®¢æˆ·æœºä¸­å®‰è£… <strong>Guest Tools</strong> æˆ– <strong>VirtIO é©±åŠ¨</strong>ï¼Œå®ç°ä¸ Hypervisor çš„é«˜æ•ˆåŠè™šæ‹ŸåŒ–é€šä¿¡ã€‚</li></ul></li><li><p><strong>ä¸ç®¡ç†å¹³å° (ä¸Šæ¸¸) çš„äº¤äº’</strong>:</p><ul><li>å•ä¸ª Hypervisor çš„èƒ½åŠ›æœ‰é™ï¼Œé€šå¸¸ç”±ä¸€ä¸ªæ›´é«˜çº§çš„ç®¡ç†å¹³å°æ¥ç¼–æ’ã€‚</li><li><strong>libvirt</strong> æ˜¯ä¸€ä¸ªå¼€æºçš„ API å’Œå·¥å…·é›†ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„ã€ä¸­ç«‹çš„æ¥å£æ¥ç®¡ç†ä¸åŒç§ç±»çš„ Hypervisorï¼ˆå¦‚ KVM, Xen, QEMUï¼‰ã€‚<code>virsh</code> å°±æ˜¯å®ƒé™„å¸¦çš„å‘½ä»¤è¡Œå·¥å…·ã€‚</li><li>åœ¨äº‘ç¯å¢ƒä¸­ï¼Œåƒ <strong>OpenStack</strong>, <strong>CloudStack</strong> æˆ– <strong>VMware vCenter</strong> è¿™æ ·çš„äº‘ç®¡å¹³å°ï¼Œä¼šé€šè¿‡ libvirt æˆ–ä¸“ç”¨ API æ¥è‡ªåŠ¨åŒ–åœ°åˆ›å»ºã€è¿ç§»ã€ç›‘æ§å’Œé”€æ¯æˆåƒä¸Šä¸‡çš„è™šæ‹Ÿæœºã€‚</li></ul></li></ul><h2 id="6-Hypervisor-èƒ½åšä»€ä¹ˆï¼Ÿ-åº”ç”¨åœºæ™¯"><a href="#6-Hypervisor-èƒ½åšä»€ä¹ˆï¼Ÿ-åº”ç”¨åœºæ™¯" class="headerlink" title="6. Hypervisor èƒ½åšä»€ä¹ˆï¼Ÿ(åº”ç”¨åœºæ™¯)"></a>6. Hypervisor èƒ½åšä»€ä¹ˆï¼Ÿ(åº”ç”¨åœºæ™¯)</h2><ul><li><strong>æœåŠ¡å™¨æ•´åˆ</strong>: å°†å¤šå°è´Ÿè½½è¾ƒä½çš„ç‰©ç†æœåŠ¡å™¨æ•´åˆåˆ°ä¸€å°æˆ–å°‘æ•°å‡ å°æœåŠ¡å™¨ä¸Šï¼Œé™ä½ç¡¬ä»¶æˆæœ¬ã€ç”µåŠ›å’Œç©ºé—´æ¶ˆè€—ã€‚</li><li><strong>å¼€å‘ä¸æµ‹è¯•</strong>: ä¸ºå¼€å‘äººå‘˜å’Œæµ‹è¯•äººå‘˜å¿«é€Ÿæä¾›å¹²å‡€ã€éš”ç¦»çš„ã€å¯éšæ—¶é”€æ¯å’Œé‡å»ºçš„å®éªŒç¯å¢ƒã€‚</li><li><strong>äº‘è®¡ç®— (IaaS)</strong>: Hypervisor æ˜¯ Infrastructure as a Service (IaaS) çš„æ ¸å¿ƒã€‚äº‘æœåŠ¡å•†åˆ©ç”¨å®ƒå°†åºå¤§çš„ç‰©ç†èµ„æºæ± åˆ‡åˆ†æˆå¯ä¾›ç§Ÿç”¨çš„è™šæ‹Ÿæœºã€‚</li><li><strong>æ¡Œé¢è™šæ‹ŸåŒ– (VDI)</strong>: åœ¨æ•°æ®ä¸­å¿ƒè¿è¡Œæ¡Œé¢æ“ä½œç³»ç»Ÿï¼ˆå¦‚ Windows 10&#x2F;11ï¼‰ï¼Œç”¨æˆ·é€šè¿‡ç½‘ç»œè¿œç¨‹è®¿é—®ï¼Œå®ç°é›†ä¸­ç®¡ç†å’Œæ•°æ®å®‰å…¨ã€‚</li><li><strong>å®‰å…¨éš”ç¦»ä¸æ²™ç®±</strong>: åˆ©ç”¨è™šæ‹Ÿæœºçš„å¼ºéš”ç¦»æ€§æ¥è¿è¡Œä¸å¯ä¿¡çš„è½¯ä»¶ï¼Œæˆ–è€…åˆ†ææ¶æ„è½¯ä»¶ï¼Œå³ä½¿è½¯ä»¶å´©æºƒæˆ–è¢«æ”»å‡»ï¼Œä¹Ÿä¸ä¼šå½±å“åˆ°å®¿ä¸»æœºå’Œå…¶ä»–è™šæ‹Ÿæœºã€‚</li></ul><h2 id="7-ä¸»æµ-Hypervisor-å¯¹æ¯”"><a href="#7-ä¸»æµ-Hypervisor-å¯¹æ¯”" class="headerlink" title="7. ä¸»æµ Hypervisor å¯¹æ¯”"></a>7. ä¸»æµ Hypervisor å¯¹æ¯”</h2><table><thead><tr><th align="left">ç‰¹æ€§ (Feature)</th><th align="left">KVM</th><th align="left">Xen</th><th align="left">VMware ESXi</th><th align="left">Microsoft Hyper-V</th></tr></thead><tbody><tr><td align="left"><strong>ç±»å‹ (Type)</strong></td><td align="left">Type 1 (é›†æˆäºLinuxå†…æ ¸)</td><td align="left">Type 1 (å¾®å†…æ ¸æ¶æ„)</td><td align="left">Type 1 (ç‹¬ç«‹å†…æ ¸)</td><td align="left">Type 1 (é›†æˆäºWindows)</td></tr><tr><td align="left"><strong>æ¶æ„ (Architecture)</strong></td><td align="left">å®å†…æ ¸ (Monolithic with Kernel)</td><td align="left">å¾®å†…æ ¸ (Microkernel)</td><td align="left">ç‹¬ç«‹å†…æ ¸ (Proprietary Kernel)</td><td align="left">å¾®å†…æ ¸åŒ– (Microkernelized)</td></tr><tr><td align="left"><strong>CPUè™šæ‹ŸåŒ–</strong></td><td align="left">ç¡¬ä»¶è¾…åŠ© (VT-x&#x2F;AMD-V)</td><td align="left">åŠè™šæ‹ŸåŒ– &#x2F; ç¡¬ä»¶è¾…åŠ©</td><td align="left">ç¡¬ä»¶è¾…åŠ©</td><td align="left">ç¡¬ä»¶è¾…åŠ©</td></tr><tr><td align="left"><strong>å¼€æºæ€§ (Open Source)</strong></td><td align="left">å¼€æº (Open Source)</td><td align="left">å¼€æº (Open Source)</td><td align="left">é—­æº (Proprietary, æœ‰å…è´¹ç‰ˆ)</td><td align="left">é—­æº (Proprietary, éšWindows Server)</td></tr><tr><td align="left"><strong>ç”Ÿæ€ç³»ç»Ÿ (Ecosystem)</strong></td><td align="left">æå¼º (OpenStack, oVirt, Proxmox)</td><td align="left">å¼ºå¤§ (AWS, Citrix, Oracle VM)</td><td align="left">éå¸¸æˆç†Ÿ (ä¼ä¸šçº§å¸‚åœºé¢†å¯¼è€…)</td><td align="left">å¼ºå¤§ (Azure, Windows ç”Ÿæ€)</td></tr><tr><td align="left"><strong>ç®¡ç†å·¥å…· (Management)</strong></td><td align="left">libvirt, virsh, Web UIs</td><td align="left">xl, xe, XenCenter</td><td align="left">vSphere, vCenter</td><td align="left">Hyper-V Manager, PowerShell, SCVMM</td></tr></tbody></table><h2 id="8-æ€»ç»“ä¸æœªæ¥å±•æœ›"><a href="#8-æ€»ç»“ä¸æœªæ¥å±•æœ›" class="headerlink" title="8. æ€»ç»“ä¸æœªæ¥å±•æœ›"></a>8. æ€»ç»“ä¸æœªæ¥å±•æœ›</h2><p>Hypervisor æ˜¯ç°ä»£è®¡ç®—æŠ€æœ¯çš„ä¸­æµç ¥æŸ±ã€‚å®ƒé€šè¿‡åœ¨è½¯ä»¶å±‚é¢æŠ½è±¡ç¡¬ä»¶ï¼Œå®ç°äº†èµ„æºçš„çµæ´»è°ƒåº¦ã€é«˜æ•ˆåˆ©ç”¨å’Œå¼ºåŠ›éš”ç¦»ã€‚ä»æœ€åˆçš„æœåŠ¡å™¨æ•´åˆï¼Œåˆ°ä»Šå¤©æ”¯æ’‘æ•´ä¸ªäº‘è®¡ç®—ï¼ŒHypervisor çš„é‡è¦æ€§ä¸è¨€è€Œå–»ã€‚</p><p>æœªæ¥ï¼ŒHypervisor æŠ€æœ¯ä»åœ¨ä¸æ–­æ¼”è¿›ï¼š</p><ul><li><strong>è½»é‡åŒ–</strong>: éšç€å®¹å™¨æŠ€æœ¯çš„å‘å±•ï¼Œå‡ºç°äº†åƒ <strong>Firecracker</strong> è¿™æ ·çš„å¾®å‹ Hypervisorï¼Œå®ƒä»¬ä¸“ä¸ºæ— æœåŠ¡å™¨è®¡ç®—å’Œå®¹å™¨è®¾è®¡ï¼Œå¯åŠ¨é€Ÿåº¦æå¿«ï¼Œå¼€é”€æå°ã€‚</li><li><strong>ä¸å®¹å™¨èåˆ</strong>: é¡¹ç›®å¦‚ <strong>Kata Containers</strong> å°è¯•å°†è™šæ‹Ÿæœºçš„å®‰å…¨éš”ç¦»ä¼˜åŠ¿ä¸å®¹å™¨çš„è½»ä¾¿å¿«æ·ç›¸ç»“åˆã€‚</li><li><strong>åµŒå¥—è™šæ‹ŸåŒ– (Nested Virtualization)</strong>: åœ¨è™šæ‹Ÿæœºå†…éƒ¨å†è¿è¡Œä¸€ä¸ª Hypervisorï¼Œè¿™ä¸ºäº‘ä¸­äº‘ã€è™šæ‹ŸåŒ–åŸ¹è®­ç­‰åœºæ™¯æä¾›äº†å¯èƒ½ã€‚</li></ul><p>ç†è§£ Hypervisor ä¸ä»…æ˜¯ç†è§£è™šæ‹ŸåŒ–ï¼Œæ›´æ˜¯ç†è§£ç°ä»£ IT åŸºç¡€è®¾æ–½å¦‚ä½•å·¥ä½œçš„å…³é”®ä¸€æ­¥ã€‚ </p>]]></content>
      
      
      <categories>
          
          <category> éšç§è®¡ç®— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TEE </tag>
            
            <tag> éšç§è®¡ç®— </tag>
            
            <tag> è™šæ‹ŸåŒ– </tag>
            
            <tag> Hypervisor </tag>
            
            <tag> KVM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HyperEnclaveå¯åŠ¨å’Œåˆå§‹åŒ–æµç¨‹</title>
      <link href="/2025/07/21/HyperEnclave%E5%90%AF%E5%8A%A8%E5%92%8C%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B/"/>
      <url>/2025/07/21/HyperEnclave%E5%90%AF%E5%8A%A8%E5%92%8C%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><blockquote><p>é¡¹ç›®æºç ï¼š<a href="https://github.com/asterinas/hyperenclave">https://github.com/asterinas/hyperenclave</a></p></blockquote><p>æœ€è¿‘åœ¨çœ‹èš‚èšçš„HyperEnclaveï¼Œå¾ˆå¥½å¥‡å®ƒæ˜¯æ€ä¹ˆå®ç°çš„ã€‚å…¶å®HyperEnclaveæºç é‡å¹¶ä¸å¤šï¼Œéå¸¸æ–¹ä¾¿æˆ‘ä»¬å»åˆ†æã€å­¦ä¹ ã€‚</p><p>æœ¬æ–‡å°†ç»“åˆæºç ï¼Œåˆ†æHyperEnclaveçš„å¯åŠ¨å’Œåˆå§‹åŒ–æµç¨‹ã€‚</p><h2 id="å¯åŠ¨æ•´ä½“æµç¨‹å›¾"><a href="#å¯åŠ¨æ•´ä½“æµç¨‹å›¾" class="headerlink" title="å¯åŠ¨æ•´ä½“æµç¨‹å›¾"></a>å¯åŠ¨æ•´ä½“æµç¨‹å›¾</h2><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  sequenceDiagram    participant Driver as å†…æ ¸é©±åŠ¨    participant Entry as entryå‡½æ•°    participant Main as mainå‡½æ•°    participant Primary as Primary CPU    participant Secondary as Secondary CPU    participant VMM as VMMæ¿€æ´»    Driver-&gt;&gt;Entry: è°ƒç”¨entry(cpu_id, linux_sp)    Entry-&gt;&gt;Main: è°ƒç”¨main(cpu_id, linux_sp)        Note over Main: ç¬¬ä¸€æ­¥ï¼šCPUåŒæ­¥å’Œè§’è‰²ç¡®å®š    Main-&gt;&gt;Main: è·å–CPUæ•°æ® PerCpu::from_id_mut(cpu_id)    Main-&gt;&gt;Main: è·å–åœ¨çº¿CPUæ•°é‡ HvHeader::get().online_cpus    Main-&gt;&gt;Main: ç¡®å®šPrimary CPU ENTERED_CPUS.fetch_add(1)    Main-&gt;&gt;Main: ç­‰å¾…æ‰€æœ‰CPUè¿›å…¥ wait_for_other_completed        Note over Main: ç¬¬äºŒæ­¥ï¼šæ—©æœŸåˆå§‹åŒ–é˜¶æ®µ    alt Primary CPU        Main-&gt;&gt;Primary: primary_init_early()        Primary-&gt;&gt;Primary: åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ logging::init()        Primary-&gt;&gt;Primary: æ£€æŸ¥CPUæ•°é‡é™åˆ¶ cpumask::check_max_cpus()        Primary-&gt;&gt;Primary: æ‰“å°ç³»ç»Ÿé…ç½®ä¿¡æ¯        Primary-&gt;&gt;Primary: åˆå§‹åŒ–å†…å­˜å›æ”¶æ¨¡å— reclaim::init()        Primary-&gt;&gt;Primary: åˆå§‹åŒ–å†…å­˜ç®¡ç† memory::init()        Primary-&gt;&gt;Primary: åˆå§‹åŒ–å†…å­˜å•å…ƒç®¡ç† cell::init()        Primary-&gt;&gt;Primary: æ ‡è®°earlyåˆå§‹åŒ–å®Œæˆ INIT_EARLY_OK.store(1)    else Secondary CPU        Main-&gt;&gt;Secondary: ç­‰å¾…earlyåˆå§‹åŒ–å®Œæˆ wait_for_other_completed(&amp;INIT_EARLY_OK, 1)    end        Note over Main: ç¬¬ä¸‰æ­¥ï¼šCPUåˆå§‹åŒ–    Main-&gt;&gt;Main: CPUåˆå§‹åŒ– cpu_data.init(cpu_id, linux_sp, &amp;cell::ROOT_CELL)    Main-&gt;&gt;Main: æ‰“å°CPUåˆå§‹åŒ–å®Œæˆä¿¡æ¯    Main-&gt;&gt;Main: é€’å¢å·²åˆå§‹åŒ–CPUè®¡æ•° INITED_CPUS.fetch_add(1)    Main-&gt;&gt;Main: ç­‰å¾…æ‰€æœ‰CPUåˆå§‹åŒ–å®Œæˆ wait_for_other_completed(&amp;INITED_CPUS, online_cpus)        Note over Main: ç¬¬å››æ­¥ï¼šæ™šæœŸåˆå§‹åŒ–é˜¶æ®µ    alt Primary CPU        Main-&gt;&gt;Primary: primary_init_late()        Primary-&gt;&gt;Primary: åˆå§‹åŒ–hypervisoræ—¥å¿— logging::hhbox_init()        Primary-&gt;&gt;Primary: ç‰ˆæœ¬æ£€æŸ¥ LIBTPM_VERSION vs RUST_HYPERVISOR_VERSION        alt ç‰ˆæœ¬ä¸åŒ¹é…            Primary--&gt;&gt;Main: è¿”å›EINVALé”™è¯¯        else ç‰ˆæœ¬åŒ¹é…            Primary-&gt;&gt;Primary: æ‰“å°ç‰ˆæœ¬ä¿¡æ¯            Primary-&gt;&gt;Primary: åˆå§‹åŒ–IOMMU iommu::init()            Primary-&gt;&gt;Primary: åˆå§‹åŒ–TPMå’ŒåŠ å¯†æ¨¡å— tc::tc_init()            alt TPMåˆå§‹åŒ–å¤±è´¥                Primary--&gt;&gt;Main: è¿”å›EIOé”™è¯¯            else TPMåˆå§‹åŒ–æˆåŠŸ                Primary-&gt;&gt;Primary: æ ‡è®°lateåˆå§‹åŒ–å®Œæˆ INIT_LATE_OK.store(1)            end        end    else Secondary CPU        Main-&gt;&gt;Secondary: ç­‰å¾…lateåˆå§‹åŒ–å®Œæˆ wait_for_other_completed(&amp;INIT_LATE_OK, 1)    end        Note over Main: ç¬¬äº”æ­¥ï¼šæ¿€æ´»VMM    alt åˆå§‹åŒ–æˆåŠŸ        Main-&gt;&gt;VMM: activate_vmm()        VMM-&gt;&gt;VMM: åˆ‡æ¢åˆ°hypervisoræ¨¡å¼        VMM--&gt;&gt;Entry: è¿”å›æˆåŠŸä»£ç (0)    else åˆå§‹åŒ–å¤±è´¥        Note over Main: ä»»ä½•æ­¥éª¤å¤±è´¥        Main--&gt;&gt;Entry: è¿”å›é”™è¯¯ä»£ç     end        Entry-&gt;&gt;Entry: restore_states(cpu_id)    Entry--&gt;&gt;Driver: è¿”å›çŠ¶æ€ä»£ç     Note over Driver: æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›é”™è¯¯ä»£ç   </pre></div><p>HyperEnclaveçš„å…¥å£æ˜¯ main.rsæ–‡ä»¶ä¸­çš„entryå‡½æ•°ã€‚</p><h2 id="æ ¸å¿ƒå‡½æ•°åˆ†æ"><a href="#æ ¸å¿ƒå‡½æ•°åˆ†æ" class="headerlink" title="æ ¸å¿ƒå‡½æ•°åˆ†æ"></a>æ ¸å¿ƒå‡½æ•°åˆ†æ</h2><h3 id="Entryå‡½æ•°-ç³»ç»Ÿå…¥å£ç‚¹"><a href="#Entryå‡½æ•°-ç³»ç»Ÿå…¥å£ç‚¹" class="headerlink" title="Entryå‡½æ•° - ç³»ç»Ÿå…¥å£ç‚¹"></a>Entryå‡½æ•° - ç³»ç»Ÿå…¥å£ç‚¹</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;sysv64&quot;</span> <span class="keyword">fn</span> <span class="title function_">entry</span>(cpu_id: <span class="type">usize</span>, linux_sp: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">i32</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">code</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Err</span>(e) = <span class="title function_ invoke__">main</span>(cpu_id, linux_sp) &#123;</span><br><span class="line">        error!(<span class="string">&quot;&#123;:?&#125;&quot;</span>, e);</span><br><span class="line">        ERROR_NUM.<span class="title function_ invoke__">store</span>(e.<span class="title function_ invoke__">code</span>(), Ordering::Release);</span><br><span class="line">        code = e.<span class="title function_ invoke__">code</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">restore_states</span>(cpu_id);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;CPU &#123;&#125; return back to driver with code &#123;&#125;.&quot;</span>, cpu_id, code);</span><br><span class="line">    code</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å…³é”®ç‚¹ï¼š"><a href="#å…³é”®ç‚¹ï¼š" class="headerlink" title="å…³é”®ç‚¹ï¼š"></a>å…³é”®ç‚¹ï¼š</h4><ul><li><p>è¿™æ˜¯hypervisorçš„å…¥å£ç‚¹ï¼Œç”±å†…æ ¸é©±åŠ¨è°ƒç”¨</p></li><li><p>å‚æ•°ï¼šcpu_idï¼ˆCPU IDï¼‰å’Œlinux_spï¼ˆLinuxæ ˆæŒ‡é’ˆï¼‰</p></li><li><p>é”™è¯¯å¤„ç†ï¼šå¦‚æœmainå¤±è´¥ï¼Œè®°å½•é”™è¯¯ä»£ç </p></li><li><p>çŠ¶æ€æ¢å¤ï¼šå¦‚æœmainå¤±è´¥ï¼Œè¿˜ä¼šè°ƒç”¨restore_statesï¼Œæ¢å¤LinuxçŠ¶æ€ï¼ˆå…³é—­IOMMUç­‰ç¡¬ä»¶èµ„æºï¼‰</p></li></ul><h4 id="å‚æ•°è¯´æ˜"><a href="#å‚æ•°è¯´æ˜" class="headerlink" title="å‚æ•°è¯´æ˜"></a>å‚æ•°è¯´æ˜</h4><p><strong>cpu_id - CPUæ ‡è¯†ç¬¦</strong></p><p>å«ä¹‰ï¼šç‰©ç†CPUæ ¸å¿ƒçš„æ ‡è¯†ç¬¦ï¼Œè¡¨ç¤ºå½“å‰æ­£åœ¨å¯åŠ¨hypervisorçš„CPUæ ¸å¿ƒç¼–å·ã€‚é€šå¸¸ä»0å¼€å§‹ï¼Œåˆ°ç³»ç»ŸCPUæ ¸å¿ƒæ•°-1</p><p>åœ¨hypervisorä¸­ç”¨é€”ï¼š</p><ul><li><p>ç”¨äºæ ‡è¯†æ¯ä¸ªCPUçš„PerCpuç»“æ„</p></li><li><p>åœ¨å¤šCPUç³»ç»Ÿä¸­è¿›è¡Œåè°ƒå’ŒåŒæ­¥</p></li><li><p>ç¡®å®šå“ªä¸ªCPUæ˜¯Primary CPU</p></li></ul><p><strong>linux_sp - Linuxæ ˆæŒ‡é’ˆ</strong></p><p>å«ä¹‰ï¼š</p><ul><li><p>Linuxå†…æ ¸æ ˆæŒ‡é’ˆï¼šä¿å­˜Linuxå†…æ ¸åœ¨è°ƒç”¨hypervisoræ—¶çš„æ ˆæŒ‡é’ˆä½ç½®</p></li><li><p>ä¸Šä¸‹æ–‡ä¿å­˜ï¼šç”¨äºä¿å­˜Linuxçš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œä»¥ä¾¿åç»­æ¢å¤</p></li><li><p>æ ˆåˆ‡æ¢ï¼šhypervisoréœ€è¦åˆ‡æ¢åˆ°è‡ªå·±çš„æ ˆï¼Œä½†éœ€è¦è®°ä½Linuxçš„æ ˆä½ç½®</p></li></ul><p>ç”¨é€”ï¼šä¿å­˜Linuxçš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œç¡®ä¿hypervisoré€€å‡ºæ—¶èƒ½æ­£ç¡®æ¢å¤LinuxçŠ¶æ€ã€‚</p><p>entryå‡½æ•°ï¼Œç¡®ä¿äº†hypervisorèƒ½å¤Ÿå®‰å…¨åœ°æ¥ç®¡CPUæ§åˆ¶æƒï¼ŒåŒæ—¶ä¹Ÿæ˜¯hypervisorå®‰å…¨é€€å‡ºæœºåˆ¶çš„å…³é”®ç»„æˆéƒ¨åˆ†ï¼Œç¡®ä¿äº†å³ä½¿åœ¨å¯åŠ¨å¤±è´¥çš„æƒ…å†µä¸‹ï¼Œç³»ç»Ÿä¹Ÿèƒ½å®‰å…¨åœ°æ¢å¤åˆ°LinuxçŠ¶æ€ã€‚</p><h3 id="Mainå‡½æ•°-æ ¸å¿ƒåˆå§‹åŒ–é€»è¾‘"><a href="#Mainå‡½æ•°-æ ¸å¿ƒåˆå§‹åŒ–é€»è¾‘" class="headerlink" title="Mainå‡½æ•° - æ ¸å¿ƒåˆå§‹åŒ–é€»è¾‘"></a>Mainå‡½æ•° - æ ¸å¿ƒåˆå§‹åŒ–é€»è¾‘</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>(cpu_id: <span class="type">usize</span>, linux_sp: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> HvResult</span><br></pre></td></tr></table></figure><h4 id="å‚æ•°è¯´æ˜ï¼š"><a href="#å‚æ•°è¯´æ˜ï¼š" class="headerlink" title="å‚æ•°è¯´æ˜ï¼š"></a>å‚æ•°è¯´æ˜ï¼š</h4><ul><li><p>cpu_id: CPUæ ¸å¿ƒæ ‡è¯†ç¬¦</p></li><li><p>linux_sp: Linuxæ ˆæŒ‡é’ˆï¼Œç”¨äºä¿å­˜Linuxæ‰§è¡Œä¸Šä¸‹æ–‡</p></li><li><p>è¿”å›å€¼ï¼šHvResultï¼ˆæˆåŠŸä¸ºOk(())ï¼Œå¤±è´¥ä¸ºErr(HvError)ï¼‰</p></li></ul><h4 id="ç¬¬ä¸€æ­¥ï¼šCPUæ•°æ®è·å–å’ŒåŒæ­¥"><a href="#ç¬¬ä¸€æ­¥ï¼šCPUæ•°æ®è·å–å’ŒåŒæ­¥" class="headerlink" title="ç¬¬ä¸€æ­¥ï¼šCPUæ•°æ®è·å–å’ŒåŒæ­¥"></a>ç¬¬ä¸€æ­¥ï¼šCPUæ•°æ®è·å–å’ŒåŒæ­¥</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¬¬1æ­¥ï¼šè·å–CPUæ•°æ®å’Œç³»ç»Ÿä¿¡æ¯</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">cpu_data</span> = PerCpu::<span class="title function_ invoke__">from_id_mut</span>(cpu_id);</span><br><span class="line"><span class="keyword">let</span> <span class="variable">online_cpus</span> = HvHeader::<span class="title function_ invoke__">get</span>().online_cpus <span class="keyword">as</span> <span class="type">usize</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">is_primary</span> = ENTERED_CPUS.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Ordering::SeqCst) == <span class="number">0</span>;</span><br><span class="line"><span class="title function_ invoke__">wait_for_other_completed</span>(&amp;ENTERED_CPUS, online_cpus)?;</span><br></pre></td></tr></table></figure><p><strong>è¯¦ç»†åˆ†æï¼š</strong></p><ol><li>PerCpu::from_id_mut(cpu_id)</li></ol><ul><li><p>è·å–å½“å‰CPUçš„PerCpuæ•°æ®ç»“æ„</p></li><li><p>æ¯ä¸ªCPUéƒ½æœ‰ç‹¬ç«‹çš„PerCpuå®ä¾‹</p></li></ul><ol start="2"><li>HvHeader::get().online_cpus</li></ol><ul><li><p>è·å–ç³»ç»Ÿä¸­åœ¨çº¿CPUçš„æ€»æ•°</p></li><li><p>ç”¨äºåç»­çš„åŒæ­¥ç­‰å¾…</p></li></ul><ol start="3"><li>ENTERED_CPUS.fetch_add(1, Ordering::SeqCst) &#x3D;&#x3D; 0</li></ol><ul><li><p>åŸå­æ“ä½œï¼Œé€’å¢å·²è¿›å…¥çš„CPUè®¡æ•°</p></li><li><p>ç¬¬ä¸€ä¸ªè¿›å…¥çš„CPUï¼ˆè¿”å›0ï¼‰è¢«æ ‡è®°ä¸ºPrimary CPU</p></li><li><p>å…¶ä»–CPUè¢«æ ‡è®°ä¸ºSecondary CPU</p></li></ul><ol start="4"><li>wait_for_other_completed(&amp;ENTERED_CPUS, online_cpus)</li></ol><ul><li><p>ç­‰å¾…æ‰€æœ‰CPUéƒ½è¿›å…¥hypervisor</p></li><li><p>ç¡®ä¿å¤šCPUåŒæ­¥å¯åŠ¨</p></li></ul><h4 id="ç¬¬äºŒæ­¥ï¼šæ—©æœŸåˆå§‹åŒ–é˜¶æ®µ"><a href="#ç¬¬äºŒæ­¥ï¼šæ—©æœŸåˆå§‹åŒ–é˜¶æ®µ" class="headerlink" title="ç¬¬äºŒæ­¥ï¼šæ—©æœŸåˆå§‹åŒ–é˜¶æ®µ"></a>ç¬¬äºŒæ­¥ï¼šæ—©æœŸåˆå§‹åŒ–é˜¶æ®µ</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¬¬2æ­¥ï¼šæ—©æœŸåˆå§‹åŒ–é˜¶æ®µ</span></span><br><span class="line"><span class="keyword">if</span> is_primary &#123;</span><br><span class="line">    <span class="title function_ invoke__">primary_init_early</span>()?;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">wait_for_other_completed</span>(&amp;INIT_EARLY_OK, <span class="number">1</span>)?;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Primary CPUæ‰§è¡Œprimary_init_early()</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">fn primary_init_early() -&gt; HvResult &#123;</span><br><span class="line">    logging::init();                    // 1. åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ</span><br><span class="line">    info!(&quot;Primary CPU init early...&quot;);</span><br><span class="line">    cpumask::check_max_cpus()?;        // 2. æ£€æŸ¥CPUæ•°é‡é™åˆ¶</span><br><span class="line"></span><br><span class="line">    // 3. æ‰“å°ç³»ç»Ÿé…ç½®ä¿¡æ¯</span><br><span class="line">    let system_config = HvSystemConfig::get();</span><br><span class="line">    println!(&quot;Initializing hypervisor...\n\</span><br><span class="line">        build_mode = &#123;&#125;\n\</span><br><span class="line">        log_level = &#123;&#125;\n\</span><br><span class="line">        arch = &#123;&#125;\n\</span><br><span class="line">        vendor = &#123;&#125;\n\</span><br><span class="line">        stats = &#123;&#125;\n\</span><br><span class="line">        sme = &#123;&#125;\n\</span><br><span class="line">        epc = &#123;&#125;\n&quot;,</span><br><span class="line">        // ... é…ç½®ä¿¡æ¯</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    info!(&quot;Hypervisor header: &#123;:#x?&#125;&quot;, HvHeader::get());</span><br><span class="line">    debug!(&quot;System config: &#123;:#x?&#125;&quot;, system_config);</span><br><span class="line"></span><br><span class="line">    reclaim::init();    // 4. åˆå§‹åŒ–å†…å­˜å›æ”¶æ¨¡å—</span><br><span class="line">    memory::init()?;    // 5. åˆå§‹åŒ–å†…å­˜ç®¡ç†</span><br><span class="line">    cell::init()?;      // 6. åˆå§‹åŒ–å†…å­˜å•å…ƒç®¡ç†</span><br><span class="line"></span><br><span class="line">    INIT_EARLY_OK.store(1, Ordering::Release);  // 7. æ ‡è®°æ—©æœŸåˆå§‹åŒ–å®Œæˆ</span><br><span class="line">    Ok(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Secondary CPUç­‰å¾…æ—©æœŸåˆå§‹åŒ–å®Œæˆ</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">wait_for_other_completed</span>(&amp;INIT_EARLY_OK, <span class="number">1</span>)?</span><br></pre></td></tr></table></figure><h4 id="ç¬¬ä¸‰æ­¥ï¼šCPUåˆå§‹åŒ–"><a href="#ç¬¬ä¸‰æ­¥ï¼šCPUåˆå§‹åŒ–" class="headerlink" title="ç¬¬ä¸‰æ­¥ï¼šCPUåˆå§‹åŒ–"></a>ç¬¬ä¸‰æ­¥ï¼šCPUåˆå§‹åŒ–</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¬¬3æ­¥ï¼šCPUåˆå§‹åŒ–</span></span><br><span class="line">cpu_data.<span class="title function_ invoke__">init</span>(cpu_id, linux_sp, &amp;cell::ROOT_CELL)?;</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">&quot;CPU &#123;&#125; init OK.&quot;</span>, cpu_id);</span><br><span class="line">INITED_CPUS.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Ordering::SeqCst);</span><br><span class="line"><span class="title function_ invoke__">wait_for_other_completed</span>(&amp;INITED_CPUS, online_cpus)?;</span><br></pre></td></tr></table></figure><p><strong>è¯¦ç»†åˆ†æï¼š</strong></p><ol><li>cpu_data.init(cpu_id, linux_sp, &amp;cell::ROOT_CELL)</li></ol><ul><li><p>åˆå§‹åŒ–å½“å‰CPUçš„PerCpuç»“æ„</p></li><li><p>è®¾ç½®CPUçŠ¶æ€ã€ä¿å­˜Linuxä¸Šä¸‹æ–‡</p></li><li><p>åˆå§‹åŒ–å†…å­˜æ˜ å°„å’ŒVCPU</p></li></ul><ol start="2"><li>INITED_CPUS.fetch_add(1, Ordering::SeqCst)</li></ol><ul><li>åŸå­é€’å¢å·²åˆå§‹åŒ–çš„CPUè®¡æ•°</li></ul><ol start="3"><li>wait_for_other_completed(&amp;INITED_CPUS, online_cpus)</li></ol><ul><li>ç­‰å¾…æ‰€æœ‰CPUéƒ½å®Œæˆåˆå§‹åŒ–</li></ul><h4 id="ç¬¬å››æ­¥ï¼šæ™šæœŸåˆå§‹åŒ–é˜¶æ®µ"><a href="#ç¬¬å››æ­¥ï¼šæ™šæœŸåˆå§‹åŒ–é˜¶æ®µ" class="headerlink" title="ç¬¬å››æ­¥ï¼šæ™šæœŸåˆå§‹åŒ–é˜¶æ®µ"></a>ç¬¬å››æ­¥ï¼šæ™šæœŸåˆå§‹åŒ–é˜¶æ®µ</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¬¬4æ­¥ï¼šæ™šæœŸåˆå§‹åŒ–é˜¶æ®µ</span></span><br><span class="line"><span class="keyword">if</span> is_primary &#123;</span><br><span class="line">    <span class="title function_ invoke__">primary_init_late</span>()?;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    wa</span><br></pre></td></tr></table></figure><p><strong>primary_init_late()å‡½æ•°åˆ†æï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">fn primary_init_late() -&gt; HvResult &#123;</span><br><span class="line">    info!(&quot;Primary CPU init late...&quot;);</span><br><span class="line"></span><br><span class="line">    logging::hhbox_init()?;  // 1. åˆå§‹åŒ–hypervisoræ—¥å¿—ç³»ç»Ÿ</span><br><span class="line"></span><br><span class="line">    let (ra, rb, rc) = to_subversion(RUST_HYPERVISOR_VERSION);</span><br><span class="line"></span><br><span class="line">    // 2. ç‰ˆæœ¬æ£€æŸ¥</span><br><span class="line">    unsafe &#123;</span><br><span class="line">        if LIBTPM_VERSION != RUST_HYPERVISOR_VERSION &#123;</span><br><span class="line">            let (ta, tb, tc) = to_subversion(LIBTPM_VERSION);</span><br><span class="line">            error!(&quot;Version mismatch. libtpm v&#123;&#125;.&#123;&#125;.&#123;&#125; v rust-hypervisor v&#123;&#125;.&#123;&#125;.&#123;&#125; &quot;,</span><br><span class="line">                ta, tb, tc, ra, rb, rc);</span><br><span class="line">            return hv_result_err!(EINVAL);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    println!(&quot;Rust-hypervisor (libtpm) version v&#123;&#125;.&#123;&#125;.&#123;&#125;&quot;, ra, rb, rc);</span><br><span class="line"></span><br><span class="line">    iommu::init()?;  // 3. åˆå§‹åŒ–IOMMU</span><br><span class="line">    if !tc::tc_init() &#123;  // 4. åˆå§‹åŒ–TPMå’ŒåŠ å¯†æ¨¡å—</span><br><span class="line">        println!(&quot;HyperEnclave: tpm or cyrpto module initialization failed&quot;);</span><br><span class="line">        return hv_result_err!(EIO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    INIT_LATE_OK.store(1, Ordering::Release);  // 5. æ ‡è®°æ™šæœŸåˆå§‹åŒ–å®Œæˆ</span><br><span class="line">    Ok(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ç¬¬äº”æ­¥ï¼šæ¿€æ´»VMM"><a href="#ç¬¬äº”æ­¥ï¼šæ¿€æ´»VMM" class="headerlink" title="ç¬¬äº”æ­¥ï¼šæ¿€æ´»VMM"></a>ç¬¬äº”æ­¥ï¼šæ¿€æ´»VMM</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¬¬5æ­¥ï¼šæ¿€æ´»VMM</span></span><br><span class="line">cpu_data.<span class="title function_ invoke__">activate_vmm</span>()</span><br></pre></td></tr></table></figure><p><strong>activate_vmm()çš„ä½œç”¨ï¼š</strong></p><ul><li><p>æ¿€æ´»è™šæ‹ŸåŒ–ç¡¬ä»¶ï¼ˆIntel VMXæˆ–AMD SVMï¼‰</p></li><li><p>åˆ‡æ¢åˆ°hypervisoræ¨¡å¼</p></li><li><p>å¼€å§‹å¤„ç†è™šæ‹ŸåŒ–äº‹ä»¶</p></li></ul><h2 id="åº•å±‚å®ç°æœºåˆ¶"><a href="#åº•å±‚å®ç°æœºåˆ¶" class="headerlink" title="åº•å±‚å®ç°æœºåˆ¶"></a>åº•å±‚å®ç°æœºåˆ¶</h2><h3 id="ä¸ºä»€ä¹ˆçœ‹èµ·æ¥é‚£ä¹ˆç®€å•"><a href="#ä¸ºä»€ä¹ˆçœ‹èµ·æ¥é‚£ä¹ˆç®€å•" class="headerlink" title="ä¸ºä»€ä¹ˆçœ‹èµ·æ¥é‚£ä¹ˆç®€å•"></a>ä¸ºä»€ä¹ˆçœ‹èµ·æ¥é‚£ä¹ˆç®€å•</h3><p>æˆ‘åˆšçœ‹çš„æ—¶å€™ï¼Œæ„Ÿè§‰è¿˜æ˜¯æŒºç–‘æƒ‘çš„ï¼Œrustä»£ç å°±è¿™æ ·å°±å¯ä»¥æ“ä½œCPUäº†ï¼Ÿå…¶å®åˆšåˆšæˆ‘ä»¬çœ‹çš„Rustä»£ç åªæ˜¯â€èƒ¶æ°´å±‚â€ã€‚å®é™…ä¸Šæ˜¯æœ‰Rustä»£ç ï¼Œå¸®æˆ‘ä»¬å°è£…äº† æ±‡ç¼–æŒ‡ä»¤ä¸ä¸€äº›ç¡¬ä»¶è™šæ‹ŸåŒ–æŒ‡ä»¤ã€‚</p><p>ä¸‹é¢è¯¦ç»†è¯´ä¸‹æˆ‘ä»¬mainå‡½æ•°å…¥å£ï¼Œæ¶‰åŠçš„åˆ°çš„å„ç§CPUæ“ä½œåº•å±‚æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p><h3 id="CPUçŠ¶æ€è·å–å’ŒåŒæ­¥æ“ä½œ"><a href="#CPUçŠ¶æ€è·å–å’ŒåŒæ­¥æ“ä½œ" class="headerlink" title="CPUçŠ¶æ€è·å–å’ŒåŒæ­¥æ“ä½œ"></a>CPUçŠ¶æ€è·å–å’ŒåŒæ­¥æ“ä½œ</h3><h4 id="åŸå­æ“ä½œ-CPUè®¡æ•°"><a href="#åŸå­æ“ä½œ-CPUè®¡æ•°" class="headerlink" title="åŸå­æ“ä½œ - CPUè®¡æ•°"></a>åŸå­æ“ä½œ - CPUè®¡æ•°</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/main.rs:171-172</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">is_primary</span> = ENTERED_CPUS.<span class="title function_ invoke__">fetch_add</span>(<span class="number">1</span>, Ordering::SeqCst) == <span class="number">0</span>;</span><br><span class="line"><span class="title function_ invoke__">wait_for_other_completed</span>(&amp;ENTERED_CPUS, online_cpus)?;</span><br></pre></td></tr></table></figure><p><strong>åº•å±‚å®ç°ï¼š</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŸå­æ“ä½œåº•å±‚æ˜¯CPUçš„LOCKå‰ç¼€æŒ‡ä»¤</span></span><br><span class="line"><span class="comment">// fetch_add å±•å¼€ä¸ºç±»ä¼¼ï¼š</span></span><br><span class="line">asm!(<span class="string">&quot;lock add &#123;&#125;, &#123;&#125;&quot;</span>, <span class="title function_ invoke__">in</span>(reg) value, <span class="title function_ invoke__">in</span>(reg) addr);</span><br></pre></td></tr></table></figure><h4 id="CPU-IDè·å–"><a href="#CPU-IDè·å–" class="headerlink" title="CPU IDè·å–"></a>CPU IDè·å–</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/main.rs:169</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">cpu_data</span> = PerCpu::<span class="title function_ invoke__">from_id_mut</span>(cpu_id);</span><br></pre></td></tr></table></figure><p><strong>åº•å±‚å®ç°ï¼š</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/percpu.rs:65-72</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">from_id_mut</span>&lt;<span class="string">&#x27;a&gt;(cpu_id: usize) -&gt; &amp;&#x27;</span>a <span class="keyword">mut</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        &amp;<span class="keyword">mut</span> core::slice::<span class="title function_ invoke__">from_raw_parts_mut</span>(</span><br><span class="line">            PER_CPU_ARRAY_PTR,  <span class="comment">// å…¨å±€PerCpuæ•°ç»„æŒ‡é’ˆ</span></span><br><span class="line">            HvHeader::<span class="title function_ invoke__">get</span>().max_cpus <span class="keyword">as</span> <span class="type">usize</span>,</span><br><span class="line">        )[cpu_id]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å†…å­˜æ˜ å°„å’Œé¡µè¡¨æ“ä½œ"><a href="#å†…å­˜æ˜ å°„å’Œé¡µè¡¨æ“ä½œ" class="headerlink" title="å†…å­˜æ˜ å°„å’Œé¡µè¡¨æ“ä½œ"></a>å†…å­˜æ˜ å°„å’Œé¡µè¡¨æ“ä½œ</h3><h4 id="å†…å­˜æ˜ å°„è®¾ç½®"><a href="#å†…å­˜æ˜ å°„è®¾ç½®" class="headerlink" title="å†…å­˜æ˜ å°„è®¾ç½®"></a>å†…å­˜æ˜ å°„è®¾ç½®</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/percpu.rs:100-115</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">vaddr</span> = <span class="keyword">self</span> <span class="keyword">as</span> *<span class="keyword">const</span> _ <span class="keyword">as</span> <span class="type">usize</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">paddr</span> = <span class="title function_ invoke__">virt_to_phys</span>(vaddr);</span><br><span class="line">hvm.<span class="title function_ invoke__">insert</span>(MemoryRegion::<span class="title function_ invoke__">new_with_offset_mapper</span>(</span><br><span class="line">    vaddr,</span><br><span class="line">    paddr,</span><br><span class="line">    PER_CPU_SIZE,</span><br><span class="line">    MemFlags::READ | MemFlags::WRITE | MemFlags::ENCRYPTED,</span><br><span class="line">))?;</span><br></pre></td></tr></table></figure><p><strong>åº•å±‚å®ç°ï¼š</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ¶‰åŠé¡µè¡¨æ“ä½œï¼Œæœ€ç»ˆä¼šæ‰§è¡Œï¼š</span></span><br><span class="line"><span class="comment">// 1. è¯»å–CR3å¯„å­˜å™¨è·å–é¡µè¡¨åŸºå€</span></span><br><span class="line"><span class="comment">// 2. ä¿®æ”¹é¡µè¡¨é¡¹</span></span><br><span class="line"><span class="comment">// 3. åˆ·æ–°TLB</span></span><br><span class="line">asm!(<span class="string">&quot;mov rax, cr3&quot;</span>);  <span class="comment">// è¯»å–é¡µè¡¨åŸºå€</span></span><br><span class="line">asm!(<span class="string">&quot;invlpg [&#123;&#125;]&quot;</span>, <span class="title function_ invoke__">in</span>(reg) addr);  <span class="comment">// åˆ·æ–°TLB</span></span><br></pre></td></tr></table></figure><h4 id="æ ˆåˆ‡æ¢æ“ä½œ"><a href="#æ ˆåˆ‡æ¢æ“ä½œ" class="headerlink" title="æ ˆåˆ‡æ¢æ“ä½œ"></a>æ ˆåˆ‡æ¢æ“ä½œ</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/percpu.rs:152</span></span><br><span class="line"><span class="keyword">unsafe</span> &#123; asm!(<span class="string">&quot;add rsp, &#123;&#125;&quot;</span>, <span class="title function_ invoke__">in</span>(reg) LOCAL_PER_CPU_BASE - old_percpu_vaddr) &#125;;</span><br></pre></td></tr></table></figure><p><strong>åº•å±‚å®ç°ï¼š</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç›´æ¥æ“ä½œæ ˆæŒ‡é’ˆå¯„å­˜å™¨</span></span><br><span class="line">asm!(<span class="string">&quot;add rsp, &#123;&#125;&quot;</span>, <span class="title function_ invoke__">in</span>(reg) offset);</span><br></pre></td></tr></table></figure><h3 id="å¯„å­˜å™¨ä¿å­˜å’Œæ¢å¤æ“ä½œ"><a href="#å¯„å­˜å™¨ä¿å­˜å’Œæ¢å¤æ“ä½œ" class="headerlink" title="å¯„å­˜å™¨ä¿å­˜å’Œæ¢å¤æ“ä½œ"></a>å¯„å­˜å™¨ä¿å­˜å’Œæ¢å¤æ“ä½œ</h3><h4 id="Linuxä¸Šä¸‹æ–‡ä¿å­˜"><a href="#Linuxä¸Šä¸‹æ–‡ä¿å­˜" class="headerlink" title="Linuxä¸Šä¸‹æ–‡ä¿å­˜"></a>Linuxä¸Šä¸‹æ–‡ä¿å­˜</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/arch/x86_64/context.rs:128-135</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">load_from</span>(linux_sp: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">regs</span> = <span class="keyword">unsafe</span> &#123; core::slice::<span class="title function_ invoke__">from_raw_parts</span>(linux_sp <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">u64</span>, SAVED_LINUX_REGS) &#125;;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">gdt</span> = GDTStruct::<span class="title function_ invoke__">sgdt</span>();  <span class="comment">// è·å–GDT</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">fs</span> = Segment::<span class="title function_ invoke__">from_selector</span>(segmentation::<span class="title function_ invoke__">fs</span>(), &amp;gdt);</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">gs</span> = Segment::<span class="title function_ invoke__">from_selector</span>(segmentation::<span class="title function_ invoke__">gs</span>(), &amp;gdt);</span><br><span class="line">    fs.base = Msr::IA32_FS_BASE.<span class="title function_ invoke__">read</span>();  <span class="comment">// è¯»å–MSR</span></span><br><span class="line">    gs.base = Msr::IA32_GS_BASE.<span class="title function_ invoke__">read</span>();</span><br></pre></td></tr></table></figure><p><strong>åº•å±‚å®ç°ï¼š</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¯»å–MSRå¯„å­˜å™¨</span></span><br><span class="line">asm!(<span class="string">&quot;rdmsr&quot;</span>, <span class="title function_ invoke__">in</span>(<span class="string">&quot;ecx&quot;</span>) <span class="number">0xc0000100</span>, <span class="title function_ invoke__">out</span>(<span class="string">&quot;eax&quot;</span>) low, <span class="title function_ invoke__">out</span>(<span class="string">&quot;edx&quot;</span>) high);  <span class="comment">// IA32_FS_BASE</span></span><br><span class="line">asm!(<span class="string">&quot;rdmsr&quot;</span>, <span class="title function_ invoke__">in</span>(<span class="string">&quot;ecx&quot;</span>) <span class="number">0xc0000101</span>, <span class="title function_ invoke__">out</span>(<span class="string">&quot;eax&quot;</span>) low, <span class="title function_ invoke__">out</span>(<span class="string">&quot;edx&quot;</span>) high);  <span class="comment">// IA32_GS_BASE</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯»å–æ®µå¯„å­˜å™¨</span></span><br><span class="line">asm!(<span class="string">&quot;mov rax, fs&quot;</span>);  <span class="comment">// è¯»å–FSæ®µå¯„å­˜å™¨</span></span><br><span class="line">asm!(<span class="string">&quot;mov rax, gs&quot;</span>);  <span class="comment">// è¯»å–GSæ®µå¯„å­˜å™¨</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯»å–GDT</span></span><br><span class="line">asm!(<span class="string">&quot;sgdt [&#123;&#125;]&quot;</span>, <span class="title function_ invoke__">in</span>(reg) &amp;gdt_ptr);</span><br></pre></td></tr></table></figure><h4 id="æ§åˆ¶å¯„å­˜å™¨æ“ä½œ"><a href="#æ§åˆ¶å¯„å­˜å™¨æ“ä½œ" class="headerlink" title="æ§åˆ¶å¯„å­˜å™¨æ“ä½œ"></a>æ§åˆ¶å¯„å­˜å™¨æ“ä½œ</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/arch/x86_64/context.rs:152-154</span></span><br><span class="line">cr0: Cr0::<span class="title function_ invoke__">read</span>(),</span><br><span class="line">cr3: Cr3::<span class="title function_ invoke__">read</span>().<span class="number">0</span>.<span class="title function_ invoke__">start_address</span>().<span class="title function_ invoke__">as_u64</span>(),</span><br><span class="line">cr4: Cr4::<span class="title function_ invoke__">read</span>(),</span><br></pre></td></tr></table></figure><p><strong>åº•å±‚å®ç°ï¼š</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¯»å–æ§åˆ¶å¯„å­˜å™¨</span></span><br><span class="line">asm!(<span class="string">&quot;mov rax, cr0&quot;</span>);  <span class="comment">// è¯»å–CR0</span></span><br><span class="line">asm!(<span class="string">&quot;mov rax, cr3&quot;</span>);  <span class="comment">// è¯»å–CR3</span></span><br><span class="line">asm!(<span class="string">&quot;mov rax, cr4&quot;</span>);  <span class="comment">// è¯»å–CR4</span></span><br></pre></td></tr></table></figure><h3 id="VMCSï¼ˆVirtual-Machine-Control-Structureï¼‰è®¾ç½®"><a href="#VMCSï¼ˆVirtual-Machine-Control-Structureï¼‰è®¾ç½®" class="headerlink" title="VMCSï¼ˆVirtual Machine Control Structureï¼‰è®¾ç½®"></a>VMCSï¼ˆVirtual Machine Control Structureï¼‰è®¾ç½®</h3><h4 id="VMCSåˆå§‹åŒ–"><a href="#VMCSåˆå§‹åŒ–" class="headerlink" title="VMCSåˆå§‹åŒ–"></a>VMCSåˆå§‹åŒ–</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/arch/x86_64/intel/vcpu.rs:198-205</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">vmcs_setup</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, linux: &amp;LinuxContext, cell: &amp;Cell) <span class="punctuation">-&gt;</span> HvResult &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">paddr</span> = <span class="keyword">self</span>.vmcs_region.<span class="title function_ invoke__">paddr</span>();</span><br><span class="line">    Vmcs::<span class="title function_ invoke__">clear</span>(paddr)?;    <span class="comment">// æ¸…é™¤VMCS</span></span><br><span class="line">    Vmcs::<span class="title function_ invoke__">load</span>(paddr)?;     <span class="comment">// åŠ è½½VMCS</span></span><br><span class="line">    <span class="keyword">self</span>.<span class="title function_ invoke__">setup_vmcs_host</span>()?;   <span class="comment">// è®¾ç½®HostçŠ¶æ€</span></span><br><span class="line">    <span class="keyword">self</span>.<span class="title function_ invoke__">setup_vmcs_guest</span>(linux)?;  <span class="comment">// è®¾ç½®GuestçŠ¶æ€</span></span><br><span class="line">    <span class="keyword">self</span>.<span class="title function_ invoke__">setup_vmcs_control</span>(cell)?; <span class="comment">// è®¾ç½®æ§åˆ¶å­—æ®µ</span></span><br><span class="line">    <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>åº•å±‚å®ç°ï¼š</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Intel VMXæŒ‡ä»¤</span></span><br><span class="line">asm!(<span class="string">&quot;vmclear [&#123;&#125;]&quot;</span>, <span class="title function_ invoke__">in</span>(reg) paddr);  <span class="comment">// æ¸…é™¤VMCS</span></span><br><span class="line">asm!(<span class="string">&quot;vmptrld [&#123;&#125;]&quot;</span>, <span class="title function_ invoke__">in</span>(reg) paddr);  <span class="comment">// åŠ è½½VMCS</span></span><br></pre></td></tr></table></figure><h4 id="HostçŠ¶æ€è®¾ç½®"><a href="#HostçŠ¶æ€è®¾ç½®" class="headerlink" title="HostçŠ¶æ€è®¾ç½®"></a>HostçŠ¶æ€è®¾ç½®</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/arch/x86_64/intel/vcpu.rs:207-235</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">setup_vmcs_host</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> HvResult &#123;</span><br><span class="line">    VmcsField64Host::IA32_PAT.<span class="title function_ invoke__">write</span>(Msr::IA32_PAT.<span class="title function_ invoke__">read</span>())?;</span><br><span class="line">    VmcsField64Host::IA32_EFER.<span class="title function_ invoke__">write</span>(Msr::IA32_EFER.<span class="title function_ invoke__">read</span>())?;</span><br><span class="line">    VmcsField64Host::CR0.<span class="title function_ invoke__">write</span>(Cr0::<span class="title function_ invoke__">read_raw</span>())?;</span><br><span class="line">    VmcsField64Host::CR3.<span class="title function_ invoke__">write</span>(Cr3::<span class="title function_ invoke__">read</span>().<span class="number">0</span>.<span class="title function_ invoke__">start_address</span>().<span class="title function_ invoke__">as_u64</span>())?;</span><br><span class="line">    VmcsField64Host::CR4.<span class="title function_ invoke__">write</span>(Cr4::<span class="title function_ invoke__">read_raw</span>())?;</span><br><span class="line">    <span class="comment">// ... å…¶ä»–å¯„å­˜å™¨è®¾ç½®</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>åº•å±‚å®ç°ï¼š</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¯»å–MSRå¯„å­˜å™¨</span></span><br><span class="line">asm!(<span class="string">&quot;rdmsr&quot;</span>, <span class="title function_ invoke__">in</span>(<span class="string">&quot;ecx&quot;</span>) <span class="number">0x277</span>, <span class="title function_ invoke__">out</span>(<span class="string">&quot;eax&quot;</span>) low, <span class="title function_ invoke__">out</span>(<span class="string">&quot;edx&quot;</span>) high);  <span class="comment">// IA32_PAT</span></span><br><span class="line">asm!(<span class="string">&quot;rdmsr&quot;</span>, <span class="title function_ invoke__">in</span>(<span class="string">&quot;ecx&quot;</span>) <span class="number">0xc0000080</span>, <span class="title function_ invoke__">out</span>(<span class="string">&quot;eax&quot;</span>) low, <span class="title function_ invoke__">out</span>(<span class="string">&quot;edx&quot;</span>) high);  <span class="comment">// IA32_EFER</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯»å–æ§åˆ¶å¯„å­˜å™¨</span></span><br><span class="line">asm!(<span class="string">&quot;mov rax, cr0&quot;</span>);</span><br><span class="line">asm!(<span class="string">&quot;mov rax, cr3&quot;</span>);</span><br><span class="line">asm!(<span class="string">&quot;mov rax, cr4&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å†™å…¥VMCSå­—æ®µ</span></span><br><span class="line">asm!(<span class="string">&quot;vmwrite &#123;&#125;, &#123;&#125;&quot;</span>, <span class="title function_ invoke__">in</span>(reg) field_id, <span class="title function_ invoke__">in</span>(reg) value);</span><br></pre></td></tr></table></figure><h4 id="GuestçŠ¶æ€è®¾ç½®"><a href="#GuestçŠ¶æ€è®¾ç½®" class="headerlink" title="GuestçŠ¶æ€è®¾ç½®"></a>GuestçŠ¶æ€è®¾ç½®</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/arch/x86_64/intel/vcpu.rs:247-289</span></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">setup_vmcs_guest</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, linux: &amp;LinuxContext) <span class="punctuation">-&gt;</span> HvResult &#123;</span><br><span class="line">    VmcsField64Guest::IA32_PAT.<span class="title function_ invoke__">write</span>(linux.pat)?;</span><br><span class="line">    VmcsField64Guest::IA32_EFER.<span class="title function_ invoke__">write</span>(linux.efer)?;</span><br><span class="line">    <span class="keyword">self</span>.<span class="title function_ invoke__">set_cr</span>(<span class="number">0</span>, linux.cr0.<span class="title function_ invoke__">bits</span>());</span><br><span class="line">    <span class="keyword">self</span>.<span class="title function_ invoke__">set_cr</span>(<span class="number">4</span>, linux.cr4.<span class="title function_ invoke__">bits</span>());</span><br><span class="line">    <span class="keyword">self</span>.<span class="title function_ invoke__">set_cr</span>(<span class="number">3</span>, linux.cr3);</span><br><span class="line">    <span class="comment">// ... æ®µå¯„å­˜å™¨è®¾ç½®</span></span><br><span class="line">    VmcsField64Guest::RSP.<span class="title function_ invoke__">write</span>(linux.rsp)?;</span><br><span class="line">    VmcsField64Guest::RIP.<span class="title function_ invoke__">write</span>(linux.rip)?;</span><br><span class="line">    VmcsField64Guest::RFLAGS.<span class="title function_ invoke__">write</span>(<span class="number">0x2</span>)?;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>åº•å±‚å®ç°ï¼š</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å†™å…¥VMCS Guestå­—æ®µ</span></span><br><span class="line">asm!(<span class="string">&quot;vmwrite &#123;&#125;, &#123;&#125;&quot;</span>, <span class="title function_ invoke__">in</span>(reg) field_id, <span class="title function_ invoke__">in</span>(reg) value);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®æ®µå¯„å­˜å™¨</span></span><br><span class="line">set_guest_segment!(linux.cs, CS);  <span class="comment">// å±•å¼€ä¸ºVMCSå­—æ®µå†™å…¥</span></span><br></pre></td></tr></table></figure><h3 id="è™šæ‹ŸåŒ–å¯åŠ¨æ“ä½œ"><a href="#è™šæ‹ŸåŒ–å¯åŠ¨æ“ä½œ" class="headerlink" title="è™šæ‹ŸåŒ–å¯åŠ¨æ“ä½œ"></a>è™šæ‹ŸåŒ–å¯åŠ¨æ“ä½œ</h3><h4 id="VCPUæ¿€æ´»"><a href="#VCPUæ¿€æ´»" class="headerlink" title="VCPUæ¿€æ´»"></a>VCPUæ¿€æ´»</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/arch/x86_64/intel/vcpu.rs:136-155</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">activate_vmm</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, linux: &amp;LinuxContext) <span class="punctuation">-&gt;</span> HvResult &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">regs</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">regs_mut</span>();</span><br><span class="line">    regs.rax = <span class="number">0</span>;</span><br><span class="line">    regs.rbx = linux.rbx;</span><br><span class="line">    regs.rbp = linux.rbp;</span><br><span class="line">    regs.r12 = linux.r12;</span><br><span class="line">    regs.r13 = linux.r13;</span><br><span class="line">    regs.r14 = linux.r14;</span><br><span class="line">    regs.r15 = linux.r15;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        asm!(</span><br><span class="line">            <span class="string">&quot;mov rsp, &#123;0&#125;&quot;</span>,</span><br><span class="line">            restore_regs_from_stack!(),</span><br><span class="line">            <span class="string">&quot;vmlaunch&quot;</span>,  <span class="comment">// å…³é”®ï¼šIntel VMXæŒ‡ä»¤</span></span><br><span class="line">            <span class="title function_ invoke__">in</span>(reg) &amp;<span class="keyword">self</span>.guest_regs <span class="keyword">as</span> *<span class="keyword">const</span> _ <span class="keyword">as</span> <span class="type">usize</span>,</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>åº•å±‚å®ç°ï¼š</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¾ç½®å¯„å­˜å™¨</span></span><br><span class="line">asm!(<span class="string">&quot;mov rax, &#123;&#125;&quot;</span>, <span class="title function_ invoke__">in</span>(reg) <span class="number">0</span>);</span><br><span class="line">asm!(<span class="string">&quot;mov rbx, &#123;&#125;&quot;</span>, <span class="title function_ invoke__">in</span>(reg) linux.rbx);</span><br><span class="line">asm!(<span class="string">&quot;mov rbp, &#123;&#125;&quot;</span>, <span class="title function_ invoke__">in</span>(reg) linux.rbp);</span><br><span class="line"><span class="comment">// ... å…¶ä»–å¯„å­˜å™¨</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®æ ˆæŒ‡é’ˆ</span></span><br><span class="line">asm!(<span class="string">&quot;mov rsp, &#123;&#125;&quot;</span>, <span class="title function_ invoke__">in</span>(reg) stack_ptr);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¢å¤å¯„å­˜å™¨ï¼ˆä»æ ˆä¸Šï¼‰</span></span><br><span class="line">asm!(<span class="string">&quot;pop rax&quot;</span>);</span><br><span class="line">asm!(<span class="string">&quot;pop rcx&quot;</span>);</span><br><span class="line">asm!(<span class="string">&quot;pop rdx&quot;</span>);</span><br><span class="line"><span class="comment">// ... å…¶ä»–å¯„å­˜å™¨</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯åŠ¨è™šæ‹ŸåŒ–</span></span><br><span class="line">asm!(<span class="string">&quot;vmlaunch&quot;</span>);  <span class="comment">// Intel VMXæŒ‡ä»¤ï¼Œå¯åŠ¨è™šæ‹ŸåŒ–</span></span><br></pre></td></tr></table></figure><h3 id="ä¸­æ–­å’Œå¼‚å¸¸å¤„ç†è®¾ç½®"><a href="#ä¸­æ–­å’Œå¼‚å¸¸å¤„ç†è®¾ç½®" class="headerlink" title="ä¸­æ–­å’Œå¼‚å¸¸å¤„ç†è®¾ç½®"></a>ä¸­æ–­å’Œå¼‚å¸¸å¤„ç†è®¾ç½®</h3><h4 id="ä¸­æ–­æè¿°ç¬¦è¡¨è®¾ç½®"><a href="#ä¸­æ–­æè¿°ç¬¦è¡¨è®¾ç½®" class="headerlink" title="ä¸­æ–­æè¿°ç¬¦è¡¨è®¾ç½®"></a>ä¸­æ–­æè¿°ç¬¦è¡¨è®¾ç½®</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/arch/x86_64/context.rs:168-171</span></span><br><span class="line">GDT.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">load</span>();</span><br><span class="line"><span class="keyword">unsafe</span> &#123;</span><br><span class="line">    segmentation::<span class="title function_ invoke__">load_cs</span>(GDTStruct::KCODE_SELECTOR);</span><br><span class="line">    segmentation::<span class="title function_ invoke__">load_ds</span>(SegmentSelector::<span class="title function_ invoke__">from_raw</span>(<span class="number">0</span>));</span><br><span class="line">    segmentation::<span class="title function_ invoke__">load_es</span>(SegmentSelector::<span class="title function_ invoke__">from_raw</span>(<span class="number">0</span>));</span><br><span class="line">    segmentation::<span class="title function_ invoke__">load_ss</span>(SegmentSelector::<span class="title function_ invoke__">from_raw</span>(<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line">IDT.<span class="title function_ invoke__">lock</span>().<span class="title function_ invoke__">load</span>();</span><br></pre></td></tr></table></figure><p><strong>åº•å±‚å®ç°ï¼š</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŠ è½½GDT</span></span><br><span class="line">asm!(<span class="string">&quot;lgdt [&#123;&#125;]&quot;</span>, <span class="title function_ invoke__">in</span>(reg) &amp;gdt_ptr);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŠ è½½æ®µå¯„å­˜å™¨</span></span><br><span class="line">asm!(<span class="string">&quot;mov cs, &#123;&#125;&quot;</span>, <span class="title function_ invoke__">in</span>(reg) selector);</span><br><span class="line">asm!(<span class="string">&quot;mov ds, &#123;&#125;&quot;</span>, <span class="title function_ invoke__">in</span>(reg) selector);</span><br><span class="line">asm!(<span class="string">&quot;mov es, &#123;&#125;&quot;</span>, <span class="title function_ invoke__">in</span>(reg) selector);</span><br><span class="line">asm!(<span class="string">&quot;mov ss, &#123;&#125;&quot;</span>, <span class="title function_ invoke__">in</span>(reg) selector);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŠ è½½IDT</span></span><br><span class="line">asm!(<span class="string">&quot;lidt [&#123;&#125;]&quot;</span>, <span class="title function_ invoke__">in</span>(reg) &amp;idt_ptr);</span><br></pre></td></tr></table></figure><h3 id="çŠ¶æ€æ¢å¤æ“ä½œ"><a href="#çŠ¶æ€æ¢å¤æ“ä½œ" class="headerlink" title="çŠ¶æ€æ¢å¤æ“ä½œ"></a>çŠ¶æ€æ¢å¤æ“ä½œ</h3><h4 id="å¯„å­˜å™¨æ¢å¤"><a href="#å¯„å­˜å™¨æ¢å¤" class="headerlink" title="å¯„å­˜å™¨æ¢å¤"></a>å¯„å­˜å™¨æ¢å¤</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/arch/x86_64/context.rs:175-225</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">restore</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        <span class="comment">// æ¢å¤MSRå¯„å­˜å™¨</span></span><br><span class="line">        Msr::IA32_PAT.<span class="title function_ invoke__">write</span>(<span class="keyword">self</span>.pat);</span><br><span class="line">        Msr::IA32_EFER.<span class="title function_ invoke__">write</span>(<span class="keyword">self</span>.efer);</span><br><span class="line">        Msr::IA32_KERNEL_GSBASE.<span class="title function_ invoke__">write</span>(<span class="keyword">self</span>.kernel_gsbase);</span><br><span class="line">        <span class="comment">// ... å…¶ä»–MSR</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¢å¤æ§åˆ¶å¯„å­˜å™¨</span></span><br><span class="line">        Cr0::<span class="title function_ invoke__">write</span>(<span class="keyword">self</span>.cr0);</span><br><span class="line">        Cr4::<span class="title function_ invoke__">write</span>(<span class="keyword">self</span>.cr4);</span><br><span class="line">        Cr3::<span class="title function_ invoke__">write</span>(PhysFrame::<span class="title function_ invoke__">containing_address</span>(PhysAddr::<span class="title function_ invoke__">new</span>(<span class="keyword">self</span>.cr3)), Cr3Flags::<span class="title function_ invoke__">empty</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¢å¤æ®µå¯„å­˜å™¨</span></span><br><span class="line">        segmentation::<span class="title function_ invoke__">load_cs</span>(<span class="keyword">self</span>.cs.selector);</span><br><span class="line">        segmentation::<span class="title function_ invoke__">load_ds</span>(<span class="keyword">self</span>.ds.selector);</span><br><span class="line">        segmentation::<span class="title function_ invoke__">load_es</span>(<span class="keyword">self</span>.es.selector);</span><br><span class="line">        segmentation::<span class="title function_ invoke__">load_fs</span>(<span class="keyword">self</span>.fs.selector);</span><br><span class="line">        segmentation::<span class="title function_ invoke__">load_gs</span>(<span class="keyword">self</span>.gs.selector);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¢å¤æ®µåŸºå€</span></span><br><span class="line">        Msr::IA32_FS_BASE.<span class="title function_ invoke__">write</span>(<span class="keyword">self</span>.fs.base);</span><br><span class="line">        Msr::IA32_GS_BASE.<span class="title function_ invoke__">write</span>(<span class="keyword">self</span>.gs.base);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>åº•å±‚å®ç°ï¼š</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å†™å…¥MSRå¯„å­˜å™¨</span></span><br><span class="line">asm!(<span class="string">&quot;wrmsr&quot;</span>, <span class="title function_ invoke__">in</span>(<span class="string">&quot;ecx&quot;</span>) <span class="number">0x277</span>, <span class="title function_ invoke__">in</span>(<span class="string">&quot;eax&quot;</span>) low, <span class="title function_ invoke__">in</span>(<span class="string">&quot;edx&quot;</span>) high);  <span class="comment">// IA32_PAT</span></span><br><span class="line">asm!(<span class="string">&quot;wrmsr&quot;</span>, <span class="title function_ invoke__">in</span>(<span class="string">&quot;ecx&quot;</span>) <span class="number">0xc0000080</span>, <span class="title function_ invoke__">in</span>(<span class="string">&quot;eax&quot;</span>) low, <span class="title function_ invoke__">in</span>(<span class="string">&quot;edx&quot;</span>) high);  <span class="comment">// IA32_EFER</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å†™å…¥æ§åˆ¶å¯„å­˜å™¨</span></span><br><span class="line">asm!(<span class="string">&quot;mov cr0, rax&quot;</span>);</span><br><span class="line">asm!(<span class="string">&quot;mov cr4, rax&quot;</span>);</span><br><span class="line">asm!(<span class="string">&quot;mov cr3, rax&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŠ è½½æ®µå¯„å­˜å™¨</span></span><br><span class="line">asm!(<span class="string">&quot;mov cs, &#123;&#125;&quot;</span>, <span class="title function_ invoke__">in</span>(reg) selector);</span><br><span class="line">asm!(<span class="string">&quot;mov ds, &#123;&#125;&quot;</span>, <span class="title function_ invoke__">in</span>(reg) selector);</span><br><span class="line">asm!(<span class="string">&quot;mov es, &#123;&#125;&quot;</span>, <span class="title function_ invoke__">in</span>(reg) selector);</span><br><span class="line">asm!(<span class="string">&quot;mov fs, &#123;&#125;&quot;</span>, <span class="title function_ invoke__">in</span>(reg) selector);</span><br><span class="line">asm!(<span class="string">&quot;mov gs, &#123;&#125;&quot;</span>, <span class="title function_ invoke__">in</span>(reg) selector);</span><br></pre></td></tr></table></figure><h2 id="åº•å±‚å®ç°ä¾èµ–æ€»ç»“"><a href="#åº•å±‚å®ç°ä¾èµ–æ€»ç»“" class="headerlink" title="åº•å±‚å®ç°ä¾èµ–æ€»ç»“"></a>åº•å±‚å®ç°ä¾èµ–æ€»ç»“</h2><h3 id="x86æ¶æ„æŒ‡ä»¤é›†"><a href="#x86æ¶æ„æŒ‡ä»¤é›†" class="headerlink" title="x86æ¶æ„æŒ‡ä»¤é›†"></a>x86æ¶æ„æŒ‡ä»¤é›†</h3><ul><li><strong>MSRæ“ä½œ</strong>ï¼š<code>rdmsr</code>&#x2F;<code>wrmsr</code> æŒ‡ä»¤</li><li><strong>æ§åˆ¶å¯„å­˜å™¨</strong>ï¼š<code>mov rax, cr0</code>&#x2F;<code>mov cr0, rax</code> ç­‰</li><li><strong>æ®µå¯„å­˜å™¨</strong>ï¼š<code>mov cs, selector</code> ç­‰</li><li><strong>é¡µè¡¨æ“ä½œ</strong>ï¼š<code>mov rax, cr3</code>ã€<code>invlpg</code> ç­‰</li></ul><h3 id="Intel-VMXè™šæ‹ŸåŒ–æŒ‡ä»¤"><a href="#Intel-VMXè™šæ‹ŸåŒ–æŒ‡ä»¤" class="headerlink" title="Intel VMXè™šæ‹ŸåŒ–æŒ‡ä»¤"></a>Intel VMXè™šæ‹ŸåŒ–æŒ‡ä»¤</h3><ul><li><strong>VMCSæ“ä½œ</strong>ï¼š<code>vmclear</code>ã€<code>vmptrld</code>ã€<code>vmwrite</code>ã€<code>vmread</code></li><li><strong>è™šæ‹ŸåŒ–å¯åŠ¨</strong>ï¼š<code>vmlaunch</code>ã€<code>vmresume</code></li><li><strong>è™šæ‹ŸåŒ–é€€å‡º</strong>ï¼š<code>vmxoff</code></li></ul><h3 id="åŸå­æ“ä½œæŒ‡ä»¤"><a href="#åŸå­æ“ä½œæŒ‡ä»¤" class="headerlink" title="åŸå­æ“ä½œæŒ‡ä»¤"></a>åŸå­æ“ä½œæŒ‡ä»¤</h3><ul><li><strong>LOCKå‰ç¼€</strong>ï¼š<code>lock add</code>ã€<code>lock xchg</code> ç­‰</li><li><strong>å†…å­˜å±éšœ</strong>ï¼š<code>mfence</code>ã€<code>sfence</code>ã€<code>lfence</code></li></ul><h3 id="å†…å­˜ç®¡ç†æŒ‡ä»¤"><a href="#å†…å­˜ç®¡ç†æŒ‡ä»¤" class="headerlink" title="å†…å­˜ç®¡ç†æŒ‡ä»¤"></a>å†…å­˜ç®¡ç†æŒ‡ä»¤</h3><ul><li><strong>é¡µè¡¨æ“ä½œ</strong>ï¼š<code>invlpg</code>ï¼ˆåˆ·æ–°TLBï¼‰</li><li><strong>å†…å­˜è®¿é—®</strong>ï¼šç›´æ¥å†…å­˜è¯»å†™æ“ä½œ</li></ul><h3 id="ä¸­æ–­å’Œå¼‚å¸¸å¤„ç†"><a href="#ä¸­æ–­å’Œå¼‚å¸¸å¤„ç†" class="headerlink" title="ä¸­æ–­å’Œå¼‚å¸¸å¤„ç†"></a>ä¸­æ–­å’Œå¼‚å¸¸å¤„ç†</h3><ul><li><strong>æè¿°ç¬¦è¡¨</strong>ï¼š<code>lgdt</code>ã€<code>lidt</code> æŒ‡ä»¤</li><li><strong>ä¸­æ–­æ§åˆ¶</strong>ï¼š<code>cli</code>ã€<code>sti</code> æŒ‡ä»¤</li></ul><p>è¿™äº›æ“ä½œéƒ½ä¾èµ–äºIntel x86æ¶æ„çš„ç¡¬ä»¶æ”¯æŒï¼Œé€šè¿‡Rustçš„<code>asm!</code>å®ç›´æ¥æ‰§è¡Œæ±‡ç¼–æŒ‡ä»¤æ¥å®ç°å¯¹CPUçš„åº•å±‚æ§åˆ¶ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> éšç§è®¡ç®— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HyperEnclave </tag>
            
            <tag> TEE </tag>
            
            <tag> è™šæ‹ŸåŒ– </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HyperEnclaveæœºå¯†è®¡ç®—è§£æï¼šæ¶æ„åŸç†ã€å®‰å…¨æœºåˆ¶ä¸æŠ€æœ¯å¯¹æ¯”</title>
      <link href="/2025/07/20/HyperEnclave%E6%9C%BA%E5%AF%86%E8%AE%A1%E7%AE%97%E8%A7%A3%E6%9E%90%EF%BC%9A%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E3%80%81%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6%E4%B8%8E%E6%8A%80%E6%9C%AF%E5%AF%B9%E6%AF%94/"/>
      <url>/2025/07/20/HyperEnclave%E6%9C%BA%E5%AF%86%E8%AE%A1%E7%AE%97%E8%A7%A3%E6%9E%90%EF%BC%9A%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E3%80%81%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6%E4%B8%8E%E6%8A%80%E6%9C%AF%E5%AF%B9%E6%AF%94/</url>
      
        <content type="html"><![CDATA[<h2 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h2><p>æœºå¯†è®¡ç®—ï¼ˆConfidential Computingï¼‰ä½œä¸ºäº‘åŸç”Ÿå®‰å…¨çš„æ ¸å¿ƒæŠ€æœ¯ï¼Œæ—¨åœ¨ä¸ºæ•°æ®åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­æä¾›ç¡¬ä»¶çº§çš„ä¿æŠ¤ã€‚HyperEnclaveä½œä¸ºä¸€ä¸ªå¼€æ”¾ä¸”è·¨å¹³å°çš„å¯ä¿¡æ‰§è¡Œç¯å¢ƒï¼ˆTEEï¼‰ï¼Œæ˜¯ä¸€ä¸ªæœ‰ä»£è¡¨æ€§çš„æœºå¯†è®¡ç®—é¢†åŸŸåˆ›æ–°æ–¹å‘ã€‚ä¸ä¼ ç»ŸåŸºäºç‰¹å®šç¡¬ä»¶çš„è§£å†³æ–¹æ¡ˆä¸åŒï¼ŒHyperEnclaveé€šè¿‡è½¯ä»¶å®šä¹‰çš„æ–¹å¼ï¼Œåœ¨é€šç”¨ç¡¬ä»¶ä¸Šæ„å»ºäº†ä¸€å¥—å®Œæ•´çš„æœºå¯†è®¡ç®—ä½“ç³»ã€‚</p><p>æœ¬æ–‡å°†ä»æŠ€æœ¯æ¶æ„ã€å®‰å…¨æœºåˆ¶ã€åº•å±‚å®ç°ç­‰å¤šä¸ªç»´åº¦ï¼Œå¤§è‡´å‰–æä¸€ä¸‹HyperEnclaveçš„è®¾è®¡ç†å¿µå’Œå®ç°åŸç†ï¼Œå¹¶ä¸Intel SGXç­‰ä¸»æµæ–¹æ¡ˆè¿›è¡Œå…¨é¢å¯¹æ¯”ã€‚</p><h2 id="HyperEnclaveæ ¸å¿ƒå®‰å…¨æœºåˆ¶"><a href="#HyperEnclaveæ ¸å¿ƒå®‰å…¨æœºåˆ¶" class="headerlink" title="HyperEnclaveæ ¸å¿ƒå®‰å…¨æœºåˆ¶"></a>HyperEnclaveæ ¸å¿ƒå®‰å…¨æœºåˆ¶</h2><p>HyperEnclaveçš„å®‰å…¨ä¿è¯æ˜¯ä¸€ä¸ª<strong>åˆ†å±‚ã€å¤šç»´åº¦çš„ä½“ç³»</strong>ï¼Œå®ƒå¹¶ä¸ä»…ä»…ä¾èµ–å•ä¸€æŠ€æœ¯ï¼Œè€Œæ˜¯é€šè¿‡å¤šç§æœºåˆ¶çš„ååŒå·¥ä½œæ¥æ„å»ºä¸€ä¸ªåšå®çš„å¯ä¿¡æ‰§è¡Œç¯å¢ƒã€‚å…¶å®‰å…¨æ¨¡å‹å¯ä»¥ä»å…­ä¸ªæ ¸å¿ƒç»´åº¦æ¥ç†è§£ï¼š</p><h3 id="1-éš”ç¦»æ€§ï¼ˆIsolationï¼‰ï¼šæ„å»ºå®‰å…¨è¾¹ç•Œ"><a href="#1-éš”ç¦»æ€§ï¼ˆIsolationï¼‰ï¼šæ„å»ºå®‰å…¨è¾¹ç•Œ" class="headerlink" title="1. éš”ç¦»æ€§ï¼ˆIsolationï¼‰ï¼šæ„å»ºå®‰å…¨è¾¹ç•Œ"></a>1. éš”ç¦»æ€§ï¼ˆIsolationï¼‰ï¼šæ„å»ºå®‰å…¨è¾¹ç•Œ</h3><p>éš”ç¦»æ€§æ˜¯HyperEnclaveå®‰å…¨çš„åŸºçŸ³ï¼Œç¡®ä¿äº†Enclaveçš„è®¡ç®—è¿‡ç¨‹ä¸è¢«å¤–éƒ¨ï¼ˆå°¤å…¶æ˜¯ç‰¹æƒè½¯ä»¶ï¼Œå¦‚æ“ä½œç³»ç»Ÿå’ŒHypervisorï¼‰å¹²æ‰°æˆ–çª¥æ¢ã€‚</p><h4 id="å®ç°æŠ€æœ¯ï¼šCPUç¡¬ä»¶è™šæ‹ŸåŒ–æ‰©å±•ï¼ˆIntel-VT-x-AMD-Vï¼‰"><a href="#å®ç°æŠ€æœ¯ï¼šCPUç¡¬ä»¶è™šæ‹ŸåŒ–æ‰©å±•ï¼ˆIntel-VT-x-AMD-Vï¼‰" class="headerlink" title="å®ç°æŠ€æœ¯ï¼šCPUç¡¬ä»¶è™šæ‹ŸåŒ–æ‰©å±•ï¼ˆIntel VT-x &#x2F; AMD-Vï¼‰"></a>å®ç°æŠ€æœ¯ï¼šCPUç¡¬ä»¶è™šæ‹ŸåŒ–æ‰©å±•ï¼ˆIntel VT-x &#x2F; AMD-Vï¼‰</h4><p><strong>ç‰¹æƒçº§åˆ†ç¦»</strong>ï¼š</p><ul><li>HyperEnclaveçš„æ ¸å¿ƒç»„ä»¶<code>RustMonitor</code>è¿è¡Œåœ¨ç¡¬ä»¶çš„æœ€é«˜æƒé™çº§åˆ«ï¼ˆVMX Root Modeï¼‰</li><li>å¸¸è§„çš„æ“ä½œç³»ç»Ÿï¼ˆå¦‚Linuxï¼‰å’Œéå¯ä¿¡åº”ç”¨è¢«â€é™çº§â€åˆ°ä¸€ä¸ªå—é™çš„è™šæ‹Ÿæœºç¯å¢ƒï¼ˆVMX Non-Root Modeï¼‰ä¸­è¿è¡Œ</li><li><code>RustMonitor</code>ä½œä¸ºâ€ä¸Šå¸â€ï¼Œå®Œå…¨æŒæ§ç€ä¸‹æ–¹è™šæ‹Ÿæœºçš„è¡Œä¸º</li></ul><p><strong>å†…å­˜éš”ç¦»ï¼ˆæ ¸å¿ƒä¸­çš„æ ¸å¿ƒï¼‰</strong>ï¼š</p><ul><li>é€šè¿‡<strong>äºŒçº§åœ°å€è½¬æ¢ï¼ˆEPT&#x2F;NPTï¼‰</strong>ï¼Œ<code>RustMonitor</code>ä¸ºEnclaveåˆ›å»ºäº†ä¸€å¥—å®Œå…¨ç‹¬ç«‹çš„å†…å­˜åœ°å€ç©ºé—´</li><li>å®ƒä»ç‰©ç†å†…å­˜ä¸­åˆ’å‡ºä¸€å—ä¸“ç”¨åŒºåŸŸç»™Enclaveä½¿ç”¨ï¼Œå¹¶åœ¨EPT&#x2F;NPTä¸­è®¾ç½®è§„åˆ™ï¼š<strong>åªå…è®¸Enclaveå¯¹åº”çš„è™šæ‹ŸCPUï¼ˆvCPUï¼‰è®¿é—®è¿™ç‰‡å†…å­˜</strong></li><li>å¯¹äºå¤–éƒ¨çš„ã€éå¯ä¿¡çš„æ“ä½œç³»ç»Ÿï¼Œ<code>RustMonitor</code>åœ¨å…¶EPT&#x2F;NPTä¸­æ ¹æœ¬<strong>ä¸å»ºç«‹ä»»ä½•åˆ°Enclaveç‰©ç†å†…å­˜çš„æ˜ å°„</strong></li><li>ä»æ“ä½œç³»ç»Ÿçš„è§†è§’çœ‹ï¼ŒEnclaveçš„å†…å­˜åŒºåŸŸæ˜¯å®Œå…¨â€ä¸å­˜åœ¨â€çš„ï¼Œä»»ä½•ç›´æ¥è®¿é—®å°è¯•éƒ½ä¼šè¢«ç¡¬ä»¶ç›´æ¥æ‹¦æˆªå¹¶å¯¼è‡´page faultï¼ˆé¡µå¤±è´¥ï¼‰</li><li><strong>IOMMUï¼ˆInput-Output Memory Management Unitï¼‰</strong>ï¼š<code>RustMonitor</code>è¿˜ä¼šé…ç½®IOMMUï¼Œé˜²æ­¢æ¶æ„çš„å¤–å›´è®¾å¤‡é€šè¿‡DMAï¼ˆç›´æ¥å†…å­˜è®¿é—®ï¼‰æ”»å‡»æ¥ç»•è¿‡CPUç›´æ¥è¯»å†™Enclaveçš„å†…å­˜</li></ul><p><strong>ç¼–ç»„ç¼“å†²åŒºï¼ˆMarshalling Bufferï¼‰æœºåˆ¶</strong>ï¼š</p><ul><li>ä¸ºè§£å†³Enclaveä¸åº”ç”¨ç¨‹åºé—´çš„æ•°æ®äº¤æ¢é—®é¢˜ï¼ŒHyperEnclaveå¼•å…¥äº†ç¼–ç»„ç¼“å†²åŒºæœºåˆ¶</li><li>ç¼“å†²åŒºåœ¨åº”ç”¨ç¨‹åºåœ°å€ç©ºé—´ä¸­é¢„åˆ†é…ï¼Œé€šè¿‡<code>mmap()</code>å’Œ<code>MAP_POPULATE</code>æ ‡å¿—åˆ†é…ï¼Œç¡®ä¿GPAè¢«é¢„å¡«å……</li><li>ç¼“å†²åŒºåœ¨æ•´ä¸ªEnclaveç”Ÿå‘½å‘¨æœŸå†…ä¿æŒå›ºå®šæ˜ å°„ï¼Œç‰©ç†å†…å­˜è¢«é”å®šä¸å…è®¸æ¢å‡º</li><li>Enclaveå’Œåº”ç”¨ç¨‹åºé—´çš„æ‰€æœ‰æ•°æ®äº¤æ¢éƒ½å¿…é¡»é€šè¿‡æ­¤ç¼“å†²åŒºè¿›è¡Œ</li><li>åº”ç”¨ç¨‹åºçš„å…¶ä»–å†…å­˜æ˜ å°„å¯¹Enclaveä¸å¯è§ï¼Œå¤§å¹…å‡å°‘äº†æ”»å‡»é¢</li><li>ç¼“å†²åŒºçš„åœ°å€èŒƒå›´åœ¨Enclaveåˆå§‹åŒ–æ—¶ç»è¿‡RustMonitorçš„ä¸¥æ ¼éªŒè¯ï¼Œé˜²æ­¢è¦†ç›–Enclaveå†…å­˜</li></ul><p><strong>æ‰§è¡Œæµéš”ç¦»</strong>ï¼š</p><ul><li>Enclaveçš„åˆ›å»ºã€è¿›å…¥ã€é€€å‡ºã€é”€æ¯ç­‰æ‰€æœ‰ç”Ÿå‘½å‘¨æœŸæ“ä½œï¼Œéƒ½å¿…é¡»é€šè¿‡<code>hypercall</code>é™·å…¥åˆ°<code>RustMonitor</code>ä¸­æ‰§è¡Œ</li><li>æ“ä½œç³»ç»Ÿæ— æ³•ç›´æ¥å¯åŠ¨æˆ–ç»ˆæ­¢Enclaveï¼Œä¹Ÿæ— æ³•éšæ„åˆ‡æ¢å…¶æ‰§è¡Œä¸Šä¸‹æ–‡</li></ul><p><strong>å®‰å…¨ä¿è¯</strong>ï¼šé€šè¿‡ç¡¬ä»¶è™šæ‹ŸåŒ–ï¼ŒHyperEnclaveå®ç°äº†<strong>è®¡ç®—è¿‡ç¨‹çš„å¼ºéš”ç¦»</strong>ã€‚å³ä½¿æ“ä½œç³»ç»Ÿè¢«é»‘å®¢å®Œå…¨æ§åˆ¶ï¼Œä¹Ÿæ— æ³•ä»è½¯ä»¶å±‚é¢çªç ´ç¡¬ä»¶è®¾å®šçš„è¾¹ç•Œæ¥çªƒå–æˆ–ç¯¡æ”¹Enclaveä¸­çš„æ•°æ®å’Œä»£ç ã€‚</p><h3 id="2-å¯éªŒè¯æ€§ï¼ˆAttestationï¼‰ï¼šå»ºç«‹è¿œç¨‹ä¿¡ä»»"><a href="#2-å¯éªŒè¯æ€§ï¼ˆAttestationï¼‰ï¼šå»ºç«‹è¿œç¨‹ä¿¡ä»»" class="headerlink" title="2. å¯éªŒè¯æ€§ï¼ˆAttestationï¼‰ï¼šå»ºç«‹è¿œç¨‹ä¿¡ä»»"></a>2. å¯éªŒè¯æ€§ï¼ˆAttestationï¼‰ï¼šå»ºç«‹è¿œç¨‹ä¿¡ä»»</h3><p>ä»…ä»…éš”ç¦»æ˜¯ä¸å¤Ÿçš„ï¼Œè¿œç¨‹ç”¨æˆ·éœ€è¦ä¸€ç§æ–¹æ³•æ¥<strong>éªŒè¯</strong>åœ¨è¿œç«¯æœåŠ¡å™¨ä¸Šè¿è¡Œçš„ç¡®å®æ˜¯ä»–ä»¬æœŸæœ›çš„ã€æœªç»ç¯¡æ”¹çš„Enclaveã€‚</p><h4 id="å®ç°æŠ€æœ¯ï¼šå¯ä¿¡å¹³å°æ¨¡å—ï¼ˆTPMï¼‰-åº¦é‡å»¶è¿Ÿå¯åŠ¨ï¼ˆMeasured-Late-Launchï¼‰"><a href="#å®ç°æŠ€æœ¯ï¼šå¯ä¿¡å¹³å°æ¨¡å—ï¼ˆTPMï¼‰-åº¦é‡å»¶è¿Ÿå¯åŠ¨ï¼ˆMeasured-Late-Launchï¼‰" class="headerlink" title="å®ç°æŠ€æœ¯ï¼šå¯ä¿¡å¹³å°æ¨¡å—ï¼ˆTPMï¼‰+ åº¦é‡å»¶è¿Ÿå¯åŠ¨ï¼ˆMeasured Late Launchï¼‰"></a>å®ç°æŠ€æœ¯ï¼šå¯ä¿¡å¹³å°æ¨¡å—ï¼ˆTPMï¼‰+ åº¦é‡å»¶è¿Ÿå¯åŠ¨ï¼ˆMeasured Late Launchï¼‰</h4><p><strong>å¯ä¿¡å¯åŠ¨é“¾ï¼ˆChain of Trustï¼‰</strong>ï¼š</p><ol><li>ä»ç³»ç»ŸåŠ ç”µå¼€å§‹ï¼Œä¸€ä¸ªä¸å¯å˜çš„ç¡¬ä»¶ä¿¡ä»»æ ¹<code>CRTM</code>ï¼ˆCore Root of Trust for Measurementï¼‰å¼€å§‹æ‰§è¡Œ</li><li><code>CRTM</code>ä¼šæµ‹é‡ï¼ˆè®¡ç®—å“ˆå¸Œå€¼ï¼‰ä¸‹ä¸€é˜¶æ®µçš„å¯åŠ¨ä»£ç ï¼ˆå¦‚BIOS&#x2F;UEFIï¼‰ï¼Œå¹¶å°†æµ‹é‡ç»“æœå­˜å…¥TPMçš„å¹³å°é…ç½®å¯„å­˜å™¨ï¼ˆPCRï¼‰</li><li>è¿™ä¸ªè¿‡ç¨‹åƒæ¥åŠ›ä¸€æ ·å»¶ç»­ä¸‹å»ï¼šBIOSæµ‹é‡Bootloaderï¼ŒBootloaderæµ‹é‡æ“ä½œç³»ç»Ÿå†…æ ¸â€¦æ¯ä¸€ç¯çš„æµ‹é‡å€¼éƒ½ä¼šè¢«<strong>æ‰©å±•ï¼ˆextendï¼‰</strong>åˆ°PCRä¸­</li><li>PCRçš„ç‰¹æ€§æ˜¯åªèƒ½æ‰©å±•ä¸èƒ½æ¸…é›¶æˆ–è¦†ç›–ï¼Œç¡®ä¿äº†å¯åŠ¨é“¾çš„å®Œæ•´æ€§</li></ol><p><strong>åº¦é‡å»¶è¿Ÿå¯åŠ¨</strong>ï¼š</p><ul><li>è¿™æ˜¯HyperEnclaveçš„ä¸€ä¸ªåˆ›æ–°ç‚¹ã€‚å®ƒä¸æ˜¯ä¸€å¼€å§‹å°±ä½œä¸ºHypervisorå¯åŠ¨ï¼Œè€Œæ˜¯å…ˆè®©ä¸€ä¸ª<strong>å¯ä¿¡çš„ã€ç»è¿‡æµ‹é‡çš„</strong>æ“ä½œç³»ç»Ÿå†…æ ¸å¯åŠ¨</li><li>ç„¶åï¼Œåœ¨æ“ä½œç³»ç»Ÿåˆå§‹åŒ–æ—©æœŸçš„å®‰å…¨é˜¶æ®µï¼ˆæ­¤æ—¶ç½‘ç»œç­‰å¤–éƒ¨æ¥å£å°šæœªæ¿€æ´»ï¼‰ï¼Œç”±ä¸€ä¸ªå†…æ ¸æ¨¡å—æ¥åŠ è½½å¹¶å¯åŠ¨<code>RustMonitor</code></li><li><code>RustMonitor</code>æœ¬èº«ä¹Ÿä¼šè¢«æµ‹é‡å¹¶è®°å½•åˆ°TPM PCRä¸­</li><li>å¯åŠ¨åï¼Œ<code>RustMonitor</code>åè¿‡æ¥å°†æ“ä½œç³»ç»Ÿé™çº§åˆ°å—æ§çš„è™šæ‹Ÿæœºä¸­</li><li>è¿™æ ·åšçš„å¥½å¤„æ˜¯<strong>å¤§å¤§å‡å°äº†å¯ä¿¡è®¡ç®—åŸºï¼ˆTCBï¼‰</strong>ï¼Œ<code>RustMonitor</code>æ— éœ€åŒ…å«å¤æ‚çš„é©±åŠ¨ç¨‹åºï¼Œå¯åŠ¨è¿‡ç¨‹æ›´å®‰å…¨ã€æ›´å¯ä¿¡</li></ul><p><strong>TCBæœ€å°åŒ–çš„å…·ä½“å®ç°</strong>ï¼š</p><ul><li>RustMonitoré•œåƒè¢«æ”¾å…¥initramfsä¸­ï¼Œåœ¨æ—©æœŸç”¨æˆ·ç©ºé—´åŠ è½½</li><li>æ­¤é˜¶æ®µä¸»æ“ä½œç³»ç»Ÿå†…æ ¸ä¸æ¥å—å¤–éƒ¨è¾“å…¥ï¼Œç½‘ç»œè¿æ¥ç­‰å¤–å›´è®¾å¤‡è¢«ç¦ç”¨</li><li>é€šè¿‡è¿™ç§â€ç±»å‹-2è™šæ‹Ÿæœºç®¡ç†ç¨‹åºåŠ è½½ï¼Œç±»å‹-1è™šæ‹Ÿæœºç®¡ç†ç¨‹åºè¿è¡Œâ€çš„æ–¹å¼</li><li>åœ¨ä¸»æ“ä½œç³»ç»Ÿè¢«é™çº§åï¼ŒRustMonitorä¸å†éœ€è¦ä¿¡ä»»ä¸»æ“ä½œç³»ç»Ÿ</li><li>æ€»ä»£ç é‡ä»…çº¦7,500è¡ŒRustä»£ç ï¼Œç›¸æ¯”ä¼ ç»ŸHypervisorå¤§å¹…å‡å°‘</li></ul><p><strong>è¿œç¨‹è¯æ˜æµç¨‹</strong>ï¼š</p><ol><li>è¿œç¨‹ç”¨æˆ·è¯·æ±‚è¯æ˜</li><li><code>RustMonitor</code>æŒ‡ç¤ºTPMç”Ÿæˆä¸€ä¸ª<code>Quote</code>ã€‚è¿™ä¸ª<code>Quote</code>åŒ…å«äº†å½“å‰æ‰€æœ‰PCRå¯„å­˜å™¨çš„å€¼ï¼Œå¹¶ç”¨ä¸€ä¸ªåªæœ‰è¯¥TPMæ‹¥æœ‰çš„ã€ä¸å¯ä¼ªé€ çš„<strong>è¯æ˜å¯†é’¥ï¼ˆAIKï¼‰</strong>è¿›è¡Œç­¾å</li><li>åŒæ—¶ï¼Œ<code>RustMonitor</code>ä¼šæµ‹é‡è¦åŠ è½½çš„Enclaveä»£ç ï¼Œå¹¶ç”¨è‡ªå·±çš„ä¸€ä¸ªå—TPMä¿æŠ¤çš„å¯†é’¥å¯¹Enclaveçš„æµ‹é‡å€¼è¿›è¡Œç­¾å</li><li>æœ€ç»ˆï¼Œå°†TPM Quoteå’ŒEnclaveç­¾åä¸€èµ·å‘é€ç»™è¿œç¨‹ç”¨æˆ·</li><li>è¿œç¨‹ç”¨æˆ·é€šè¿‡éªŒè¯TPMç­¾åå’ŒEnclaveç­¾åï¼Œå°±å¯ä»¥ç¡®ä¿¡ï¼š<ul><li>ç¡¬ä»¶å¹³å°æ˜¯å¯ä¿¡çš„ï¼ˆæ¥è‡ªåˆæ³•çš„TPMï¼‰</li><li>ä»BIOSåˆ°<code>RustMonitor</code>çš„æ•´ä¸ªå¯åŠ¨é“¾æ˜¯æ­£ç¡®çš„</li><li>å³å°†è¿è¡Œçš„Enclaveä»£ç æ˜¯æœªç»ç¯¡æ”¹çš„</li></ul></li></ol><p><strong>å¯†é’¥ç”Ÿæˆä¸å°è£…æœºåˆ¶</strong>ï¼š</p><ul><li><strong>æ ¹å¯†é’¥ç”Ÿæˆ</strong>ï¼šRustMonitoré¦–æ¬¡åˆå§‹åŒ–æ—¶ï¼Œä»TPMçš„éšæœºæ•°ç”Ÿæˆå™¨ï¼ˆRNGï¼‰æ¨¡å—ç”Ÿæˆæ ¹å¯†é’¥<code>Kroot</code></li><li><strong>å®‰å…¨å­˜å‚¨</strong>ï¼š<code>Kroot</code>ä½¿ç”¨TPMçš„å°è£…ï¼ˆSealï¼‰æ“ä½œå­˜å‚¨åœ¨TPMå¤–éƒ¨ï¼Œåªèƒ½åœ¨ç›¸åŒTPMèŠ¯ç‰‡å’ŒåŒ¹é…PCRé…ç½®ä¸‹è§£å°</li><li><strong>é˜²æŠ¤æªæ–½</strong>ï¼šåœ¨å°†æ§åˆ¶æƒè½¬ç§»ç»™ä¸»æ“ä½œç³»ç»Ÿå‰ï¼ŒRustMonitorç”¨å¸¸é‡å¡«å……PCRsï¼Œé˜²æ­¢å…¶æ£€ç´¢<code>Kroot</code></li><li><strong>å¯†é’¥æ´¾ç”Ÿ</strong>ï¼šæ‰€æœ‰å…¶ä»–å¯†é’¥ææ–™ï¼ˆåŒ…æ‹¬Enclaveçš„å°è£…å¯†é’¥å’ŒæŠ¥å‘Šå¯†é’¥ï¼‰éƒ½ç”±<code>Kroot</code>å’ŒEnclaveçš„æµ‹é‡å€¼æ´¾ç”Ÿè€Œæ¥</li><li><strong>è¯æ˜å¯†é’¥å¯¹</strong>ï¼šRustMonitoræ´¾ç”Ÿä¸“ç”¨çš„è¯æ˜å¯†é’¥å¯¹ï¼Œç”¨äºç­¾ç½²Enclaveæµ‹é‡å€¼ï¼Œç§é’¥æ°¸ä¸ç¦»å¼€å—ä¿æŠ¤çš„RustMonitor</li></ul><p><strong>å®‰å…¨ä¿è¯</strong>ï¼šé€šè¿‡è¿œç¨‹è¯æ˜ï¼ŒHyperEnclaveä¿è¯äº†<strong>è®¡ç®—ç¯å¢ƒçš„å¯ä¿¡æ€§</strong>ã€‚ç”¨æˆ·å¯ä»¥è¿œç¨‹éªŒè¯ä»–ä»¬çš„æ•°æ®åªä¼šè¢«æ­£ç¡®çš„ä»£ç åœ¨æ­£ç¡®çš„ç¯å¢ƒä¸­å¤„ç†ã€‚ç»“åˆTPMçš„å¯†é’¥ç®¡ç†æœºåˆ¶ï¼Œç¡®ä¿äº†å¯†é’¥çš„å®‰å…¨æ€§å’Œå¹³å°ç»‘å®šæ€§ã€‚</p><h3 id="3-æœºå¯†æ€§ï¼ˆConfidentialityï¼‰ï¼šä¿æŠ¤é™æ€æ•°æ®"><a href="#3-æœºå¯†æ€§ï¼ˆConfidentialityï¼‰ï¼šä¿æŠ¤é™æ€æ•°æ®" class="headerlink" title="3. æœºå¯†æ€§ï¼ˆConfidentialityï¼‰ï¼šä¿æŠ¤é™æ€æ•°æ®"></a>3. æœºå¯†æ€§ï¼ˆConfidentialityï¼‰ï¼šä¿æŠ¤é™æ€æ•°æ®</h3><p>é™¤äº†è¿è¡Œæ—¶éš”ç¦»ï¼Œè¿˜éœ€è¦ä¿æŠ¤æ•°æ®åœ¨ç‰©ç†å†…å­˜ä¸­çš„å®‰å…¨ï¼Œé˜²æ­¢ç‰©ç†æ”»å‡»ã€‚</p><h4 id="å®ç°æŠ€æœ¯ï¼šç¡¬ä»¶å†…å­˜åŠ å¯†ï¼ˆå¯é€‰ä½†æ¨èï¼‰"><a href="#å®ç°æŠ€æœ¯ï¼šç¡¬ä»¶å†…å­˜åŠ å¯†ï¼ˆå¯é€‰ä½†æ¨èï¼‰" class="headerlink" title="å®ç°æŠ€æœ¯ï¼šç¡¬ä»¶å†…å­˜åŠ å¯†ï¼ˆå¯é€‰ä½†æ¨èï¼‰"></a>å®ç°æŠ€æœ¯ï¼šç¡¬ä»¶å†…å­˜åŠ å¯†ï¼ˆå¯é€‰ä½†æ¨èï¼‰</h4><p>HyperEnclaveå¯ä»¥åˆ©ç”¨<strong>AMD SME</strong>æˆ–<strong>Intel TME</strong>ç­‰æŠ€æœ¯ï¼š</p><ul><li>è¿™äº›æŠ€æœ¯åœ¨CPUå†…éƒ¨çš„å†…å­˜æ§åˆ¶å™¨ä¸Šå®ç°<strong>å…¨å†…å­˜å®æ—¶åŠ è§£å¯†</strong></li><li>æ•°æ®ç¦»å¼€CPUæ ¸å¿ƒæ—¶è‡ªåŠ¨åŠ å¯†ï¼Œè¿›å…¥CPUæ ¸å¿ƒæ—¶è‡ªåŠ¨è§£å¯†</li><li>åŠ å¯†å¯†é’¥ç”±CPUå†…éƒ¨çš„ç¡¬ä»¶éšæœºæ•°ç”Ÿæˆå™¨äº§ç”Ÿï¼Œå®‰å…¨åœ°ä¿å­˜åœ¨CPUå†…éƒ¨ï¼Œè½¯ä»¶æ— æ³•è®¿é—®</li></ul><p><strong>åŠ¨æ€å†…å­˜ç®¡ç†æ”¯æŒ</strong>ï¼š</p><ul><li><strong>æŒ‰éœ€åˆ†é…</strong>ï¼šæ”¯æŒç±»ä¼¼SGX2çš„EDMMï¼ˆEnclaveåŠ¨æ€å†…å­˜ç®¡ç†ï¼‰åŠŸèƒ½</li><li><strong>è¿è¡Œæ—¶æ‰©å±•</strong>ï¼šEnclaveå¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€æ·»åŠ æˆ–åˆ é™¤é¡µé¢ï¼Œæ›´æ”¹é¡µé¢å±æ€§æˆ–ç±»å‹</li><li><strong>JITç¼–è¯‘æ”¯æŒ</strong>ï¼šæ”¯æŒæŒ‰éœ€åˆ›å»ºä»£ç é¡µé¢ï¼Œå®ç°å³æ—¶ï¼ˆJITï¼‰ç¼–è¯‘åŠŸèƒ½</li><li><strong>å †æ ˆç®¡ç†</strong>ï¼šå®ç°æŒ‰éœ€å †æ ˆå’Œå †å¢é•¿ï¼Œä¼˜åŒ–å†…å­˜ä½¿ç”¨æ•ˆç‡</li><li><strong>é¡µé”™è¯¯å¤„ç†</strong>ï¼šå½“Enclaveè®¿é—®æœªæäº¤ç‰©ç†é¡µçš„è™šæ‹Ÿåœ°å€æ—¶ï¼ŒRustMonitorä»å†…å­˜æ± ä¸­åˆ†é…ç©ºé—²é¡µå¹¶æ›´æ–°é¡µè¡¨</li></ul><p><strong>å®‰å…¨ä¿è¯</strong>ï¼šé€šè¿‡ç¡¬ä»¶å†…å­˜åŠ å¯†ï¼ŒHyperEnclaveä¿è¯äº†<strong>æ•°æ®åœ¨ç‰©ç†å†…å­˜ä¸­çš„æœºå¯†æ€§</strong>ï¼Œæœ‰æ•ˆæŠµå¾¡å†·å¯åŠ¨æ”»å‡»ã€æ€»çº¿å—…æ¢ç­‰ç‰©ç†å±‚é¢çš„å¨èƒã€‚åŠ¨æ€å†…å­˜ç®¡ç†æœºåˆ¶è¿›ä¸€æ­¥æå‡äº†å†…å­˜ä½¿ç”¨çš„çµæ´»æ€§å’Œæ•ˆç‡ã€‚</p><h3 id="4-å®Œæ•´æ€§ï¼ˆIntegrityï¼‰ï¼šé˜²æ­¢æ•°æ®ç¯¡æ”¹"><a href="#4-å®Œæ•´æ€§ï¼ˆIntegrityï¼‰ï¼šé˜²æ­¢æ•°æ®ç¯¡æ”¹" class="headerlink" title="4. å®Œæ•´æ€§ï¼ˆIntegrityï¼‰ï¼šé˜²æ­¢æ•°æ®ç¯¡æ”¹"></a>4. å®Œæ•´æ€§ï¼ˆIntegrityï¼‰ï¼šé˜²æ­¢æ•°æ®ç¯¡æ”¹</h3><p>ç¡®ä¿Enclaveçš„ä»£ç å’Œæ•°æ®åœ¨å†…å­˜ä¸­ä¸è¢«æ¶æ„ç¯¡æ”¹ã€‚</p><h4 id="å®ç°æŠ€æœ¯ï¼šå†…å­˜éš”ç¦»ä¸é¡µè¡¨ä¿æŠ¤"><a href="#å®ç°æŠ€æœ¯ï¼šå†…å­˜éš”ç¦»ä¸é¡µè¡¨ä¿æŠ¤" class="headerlink" title="å®ç°æŠ€æœ¯ï¼šå†…å­˜éš”ç¦»ä¸é¡µè¡¨ä¿æŠ¤"></a>å®ç°æŠ€æœ¯ï¼šå†…å­˜éš”ç¦»ä¸é¡µè¡¨ä¿æŠ¤</h4><p><strong>é¡µè¡¨ç‹¬å </strong>ï¼š</p><ul><li>HyperEnclaveçš„ä¸€ä¸ªå…³é”®è®¾è®¡æ˜¯ï¼ŒEnclaveçš„é¡µè¡¨<strong>å®Œå…¨ç”±<code>RustMonitor</code>ç®¡ç†</strong>ï¼Œè€Œéæ“ä½œç³»ç»Ÿ</li><li>è¿™ä»æ ¹æœ¬ä¸Šæœç»äº†æ“ä½œç³»ç»Ÿé€šè¿‡æ“çºµé¡µè¡¨æ¥æ”»å‡»Enclaveçš„å¯èƒ½æ€§ï¼ˆä¾‹å¦‚ï¼Œå°†Enclaveçš„é¡µé¢æ˜ å°„åˆ°æ”»å‡»è€…å¯æ§çš„åœ°å€ï¼‰</li></ul><p><strong>ç¡¬ä»¶å†…å­˜åŠ å¯†çš„å®Œæ•´æ€§ä¿æŠ¤</strong>ï¼š</p><ul><li>ä¸€äº›é«˜çº§çš„ç¡¬ä»¶å†…å­˜åŠ å¯†æŠ€æœ¯ï¼ˆå¦‚SGXçš„å†…å­˜åŠ å¯†ï¼‰æœ¬èº«å°±åŒ…å«äº†å¯¹å†…å­˜å—çš„å®Œæ•´æ€§æ ¡éªŒï¼ˆé€šè¿‡Merkle Treeç­‰æœºåˆ¶ï¼‰</li><li>è™½ç„¶HyperEnclaveä¾èµ–çš„TME&#x2F;SMEåŸºç¡€ç‰ˆä¸»è¦æä¾›æœºå¯†æ€§ï¼Œä½†è¿™æ˜¯æœªæ¥å¯æ‰©å±•çš„æ–¹å‘</li></ul><p><strong>å¯åŠ¨é“¾å®Œæ•´æ€§</strong>ï¼š</p><ul><li>TPMçš„PCRæœºåˆ¶æœ¬èº«å°±æ˜¯ä¸€ç§å¯¹å¯åŠ¨ä»£ç å®Œæ•´æ€§çš„å¼ºæœ‰åŠ›ä¿è¯</li></ul><p><strong>å®‰å…¨ä¿è¯</strong>ï¼šHyperEnclaveé€šè¿‡<strong>å‰¥å¤ºæ“ä½œç³»ç»Ÿçš„é¡µè¡¨ç®¡ç†æƒé™</strong>ï¼Œå¹¶ç»“åˆTPMçš„åº¦é‡ï¼Œç¡®ä¿äº†Enclaveä»£ç å’Œå…³é”®è¿è¡Œæ—¶ç»“æ„çš„å®Œæ•´æ€§ã€‚</p><h3 id="5-çµæ´»æ“ä½œæ¨¡å¼å®‰å…¨æ€§ï¼šå¤šæ¨¡å¼å®‰å…¨ä¿éšœ"><a href="#5-çµæ´»æ“ä½œæ¨¡å¼å®‰å…¨æ€§ï¼šå¤šæ¨¡å¼å®‰å…¨ä¿éšœ" class="headerlink" title="5. çµæ´»æ“ä½œæ¨¡å¼å®‰å…¨æ€§ï¼šå¤šæ¨¡å¼å®‰å…¨ä¿éšœ"></a>5. çµæ´»æ“ä½œæ¨¡å¼å®‰å…¨æ€§ï¼šå¤šæ¨¡å¼å®‰å…¨ä¿éšœ</h3><p>HyperEnclaveçš„åˆ›æ–°ä¹‹å¤„åœ¨äºæ”¯æŒä¸‰ç§ä¸åŒçš„Enclaveæ“ä½œæ¨¡å¼ï¼Œæ¯ç§æ¨¡å¼éƒ½é’ˆå¯¹ç‰¹å®šçš„å®‰å…¨å’Œæ€§èƒ½éœ€æ±‚è¿›è¡Œäº†ä¼˜åŒ–ã€‚</p><h4 id="ä¸‰ç§æ“ä½œæ¨¡å¼"><a href="#ä¸‰ç§æ“ä½œæ¨¡å¼" class="headerlink" title="ä¸‰ç§æ“ä½œæ¨¡å¼"></a>ä¸‰ç§æ“ä½œæ¨¡å¼</h4><p><strong>å®¢æˆ·æœºç”¨æˆ·Enclaveï¼ˆGU-Enclaveï¼‰</strong>ï¼š</p><ul><li>è¿è¡Œåœ¨VMX non-rootæ¨¡å¼çš„å®¢æˆ·æœºRing-3</li><li>åŸºæœ¬çš„Enclaveæ“ä½œæ¨¡å¼ï¼Œé€‚ç”¨äºè®¡ç®—å¯†é›†å‹ä»»åŠ¡</li><li>æä¾›ä¸SGXç±»ä¼¼çš„å®‰å…¨çº§åˆ«</li><li>æ‰€æœ‰ä¸­æ–­å’Œå¼‚å¸¸éƒ½ä¼šé™·å…¥RustMonitorè¿›è¡Œå¤„ç†</li></ul><p><strong>ä¸»æœºç”¨æˆ·Enclaveï¼ˆHU-Enclaveï¼‰</strong>ï¼š</p><ul><li>è¿è¡Œåœ¨VMX rootæ¨¡å¼çš„ä¸»æœºç”¨æˆ·æ€</li><li>é€šè¿‡ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ï¼ˆ<del>120å‘¨æœŸï¼‰æ›¿ä»£hypercallï¼ˆ</del>880å‘¨æœŸï¼‰ä¼˜åŒ–æ€§èƒ½</li><li>æ¶ˆé™¤äº†äºŒçº§åœ°å€è½¬æ¢çš„è™šæ‹ŸåŒ–å¼€é”€</li><li>ç‰¹åˆ«é€‚åˆI&#x2F;Oå¯†é›†å‹å·¥ä½œè´Ÿè½½</li></ul><p><strong>ç‰¹æƒEnclaveï¼ˆP-Enclaveï¼‰</strong>ï¼š</p><ul><li>è¿è¡Œåœ¨VMX non-rootæ¨¡å¼çš„å®¢æˆ·æœºRing-0</li><li>å¯ä»¥è®¿é—®GDTã€IDTå’Œä¸€çº§é¡µè¡¨ç­‰ç‰¹æƒèµ„æº</li><li>æ”¯æŒEnclaveå†…å¼‚å¸¸å¤„ç†å’Œé¡µè¡¨ç®¡ç†</li><li>ç‰¹åˆ«é€‚åˆéœ€è¦é¢‘ç¹å†…å­˜æƒé™å˜æ›´çš„åº”ç”¨ï¼ˆå¦‚Javaåƒåœ¾å›æ”¶å™¨ï¼‰</li></ul><h4 id="å®‰å…¨ä¼˜åŠ¿"><a href="#å®‰å…¨ä¼˜åŠ¿" class="headerlink" title="å®‰å…¨ä¼˜åŠ¿"></a>å®‰å…¨ä¼˜åŠ¿</h4><p><strong>æ€§èƒ½ä¼˜åŒ–ä¸ç‰ºç‰²å®‰å…¨æ€§</strong>ï¼š</p><ul><li>æ¯ç§æ¨¡å¼éƒ½ä¿æŒäº†æ ¸å¿ƒçš„å†…å­˜éš”ç¦»æœºåˆ¶</li><li>RustMonitorå§‹ç»ˆæ§åˆ¶ç€å…³é”®çš„å®‰å…¨ç­–ç•¥</li><li>ä¸åŒæ¨¡å¼é—´çš„åˆ‡æ¢ç”±RustMonitorä¸¥æ ¼ç®¡ç†</li></ul><p><strong>é’ˆå¯¹æ€§å¨èƒé˜²æŠ¤</strong>ï¼š</p><ul><li>P-Enclaveé€šè¿‡Enclaveå†…å¼‚å¸¸å¤„ç†é˜²æ­¢åŸºäºä¸­æ–­çš„ä¾§ä¿¡é“æ”»å‡»</li><li>HU-Enclaveå‡å°‘äº†æ”»å‡»é¢ï¼ŒåŒæ—¶æä¾›äº†æ›´å¥½çš„I&#x2F;Oæ€§èƒ½</li><li>ç™½åå•æœºåˆ¶ç¡®ä¿åªæœ‰å®‰å…¨çš„å¼‚å¸¸è¢«ä¼ é€’ç»™P-Enclave</li></ul><h3 id="6-æ¶æ„Enclaveé˜²æŠ¤ï¼šå¤šå±‚é˜²å¾¡æœºåˆ¶"><a href="#6-æ¶æ„Enclaveé˜²æŠ¤ï¼šå¤šå±‚é˜²å¾¡æœºåˆ¶" class="headerlink" title="6. æ¶æ„Enclaveé˜²æŠ¤ï¼šå¤šå±‚é˜²å¾¡æœºåˆ¶"></a>6. æ¶æ„Enclaveé˜²æŠ¤ï¼šå¤šå±‚é˜²å¾¡æœºåˆ¶</h3><p>ä¸ä¼ ç»ŸTEEè®¾è®¡ä¸åŒï¼ŒHyperEnclaveä¸“é—¨è®¾è®¡äº†æœºåˆ¶æ¥é˜²å¾¡å¯èƒ½è¢«æ”»é™·æˆ–æ¶æ„çš„Enclaveã€‚</p><h4 id="å®ç°æŠ€æœ¯ï¼šå—é™å†…å­˜è®¿é—®ä¸æ§åˆ¶æµä¿æŠ¤"><a href="#å®ç°æŠ€æœ¯ï¼šå—é™å†…å­˜è®¿é—®ä¸æ§åˆ¶æµä¿æŠ¤" class="headerlink" title="å®ç°æŠ€æœ¯ï¼šå—é™å†…å­˜è®¿é—®ä¸æ§åˆ¶æµä¿æŠ¤"></a>å®ç°æŠ€æœ¯ï¼šå—é™å†…å­˜è®¿é—®ä¸æ§åˆ¶æµä¿æŠ¤</h4><p><strong>ç¼–ç»„ç¼“å†²åŒºéš”ç¦»</strong>ï¼š</p><ul><li>Enclaveåªèƒ½è®¿é—®è‡ªå·±çš„å†…å­˜å’Œé¢„åˆ†é…çš„ç¼–ç»„ç¼“å†²åŒº</li><li>æ¶ˆé™¤äº†SGXä¸­Enclaveå¯ä»¥è®¿é—®æ•´ä¸ªåº”ç”¨ç¨‹åºåœ°å€ç©ºé—´çš„é£é™©</li><li>ç¼–ç»„ç¼“å†²åŒºçš„åœ°å€èŒƒå›´åœ¨Enclaveåˆå§‹åŒ–æ—¶ç»è¿‡ä¸¥æ ¼éªŒè¯</li></ul><p><strong>æ§åˆ¶æµå®Œæ•´æ€§</strong>ï¼š</p><ul><li>é€šè¿‡RustMonitoræ¨¡æ‹ŸEEXITæŒ‡ä»¤ï¼Œæ·»åŠ æœ‰æ•ˆæ€§æ£€æŸ¥</li><li>é˜²æ­¢æ¶æ„Enclaveé€šè¿‡è®¾ç½®rbxå¯„å­˜å™¨è·³è½¬åˆ°ä»»æ„åœ°å€</li><li>æ‰€æœ‰EnclaveçŠ¶æ€è½¬æ¢éƒ½å¿…é¡»é€šè¿‡RustMonitorçš„hypercallæ¥å£</li></ul><p><strong>å†…å­˜æ˜ å°„æ”»å‡»é˜²æŠ¤</strong>ï¼š</p><ul><li>ä¸»æ“ä½œç³»ç»Ÿæ— æ³•æ“çºµEnclaveçš„é¡µè¡¨æ˜ å°„</li><li>æ¶ˆé™¤äº†é€šè¿‡åœ°å€æ˜ å°„è¿›è¡Œçš„æ”»å‡»ï¼ˆå¦‚å°†Enclaveé¡µé¢æ˜ å°„åˆ°æ”»å‡»è€…æ§åˆ¶çš„åœ°å€ï¼‰</li><li>é¡µé”™è¯¯å®Œå…¨ç”±RustMonitorå¤„ç†ï¼Œæ— éœ€ä¸»æ“ä½œç³»ç»Ÿå‚ä¸</li></ul><h4 id="å…·ä½“é˜²æŠ¤æªæ–½"><a href="#å…·ä½“é˜²æŠ¤æªæ–½" class="headerlink" title="å…·ä½“é˜²æŠ¤æªæ–½"></a>å…·ä½“é˜²æŠ¤æªæ–½</h4><p><strong>é˜²æ­¢å¯¹åº”ç”¨ç¨‹åºçš„ä»»æ„å†…å­˜è®¿é—®</strong>ï¼š</p><ul><li>ä¼ ç»ŸSGX Enclaveå¯ä»¥è®¿é—®åº”ç”¨ç¨‹åºçš„æ•´ä¸ªåœ°å€ç©ºé—´ï¼Œå¯èƒ½å¯¼è‡´å¯†é’¥æ³„éœ²æˆ–ä»£ç æŒ‡é’ˆç¯¡æ”¹</li><li>HyperEnclaveçš„Enclaveåªèƒ½è®¿é—®è‡ªå·±çš„å†…å­˜å’Œç¼–ç»„ç¼“å†²åŒº</li><li>æœ‰æ•ˆé˜²æ­¢äº†Enclaveæ¶æ„è½¯ä»¶çªƒå–åº”ç”¨ç¨‹åºæ•æ„Ÿæ•°æ®</li></ul><p><strong>é˜²æ­¢EEXITåçš„ä»»æ„æ§åˆ¶æµ</strong>ï¼š</p><ul><li>SGXè®¾è®¡å…è®¸Enclaveåœ¨é€€å‡ºæ—¶è·³è½¬åˆ°ä»»æ„åœ°å€</li><li>HyperEnclaveé€šè¿‡RustMonitorçš„æ¨¡æ‹Ÿå’ŒéªŒè¯æœºåˆ¶é˜»æ­¢æ­¤ç±»æ”»å‡»</li><li>ç¡®ä¿Enclaveé€€å‡ºåçš„æ‰§è¡Œæµç¨‹åœ¨é¢„æœŸèŒƒå›´å†…</li></ul><p><strong>ä¾§ä¿¡é“æ”»å‡»ç¼“è§£</strong>ï¼š</p><ul><li>ç”±äºEnclaveçš„é¡µè¡¨å’Œé¡µé”™è¯¯ç”±RustMonitorå¤„ç†ï¼Œä¸»æ“ä½œç³»ç»Ÿæ— æ³•å‘èµ·åŸºäºé¡µè¡¨çš„ä¾§ä¿¡é“æ”»å‡»</li><li>P-Enclaveæ¨¡å¼å¯ä»¥æ£€æµ‹å¼‚å¸¸ä¸­æ–­äº‹ä»¶ï¼Œæœ‰åŠ©äºå‘ç°å’Œç¼“è§£åŸºäºä¸­æ–­çš„ä¾§ä¿¡é“æ”»å‡»</li><li>TLBåœ¨ä¸–ç•Œåˆ‡æ¢æ—¶è¢«æ¸…é™¤ï¼Œé˜²æ­¢ä½¿ç”¨è¿‡æ—¶TLBæ¡ç›®è¿›è¡Œéæ³•è®¿é—®</li></ul><p><strong>ç‰©ç†æ”»å‡»é˜²æŠ¤</strong>ï¼š</p><ul><li>æ”¯æŒAMD SMEå’ŒIntel MKTMEç­‰ç¡¬ä»¶å†…å­˜åŠ å¯†æŠ€æœ¯</li><li>å†…å­˜åŠ å¯†å¯†é’¥åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶éšæœºç”Ÿæˆå¹¶å­˜å‚¨åœ¨CPUå†…éƒ¨ï¼Œè½¯ä»¶æ— æ³•è®¿é—®</li><li>æœ‰æ•ˆé˜²å¾¡å†·å¯åŠ¨æ”»å‡»ã€æ€»çº¿å—…æ¢ç­‰ç‰©ç†å±‚é¢çš„å¨èƒ</li><li>IOMMUé…ç½®é˜²æ­¢æ¶æ„å¤–å›´è®¾å¤‡é€šè¿‡DMAè®¿é—®å—ä¿æŠ¤å†…å­˜</li></ul><p><strong>å®‰å…¨ä¿è¯</strong>ï¼šé€šè¿‡å¤šå±‚é˜²å¾¡æœºåˆ¶ï¼ŒHyperEnclaveä¸ä»…ä¿æŠ¤Enclaveå…å—å¤–éƒ¨æ”»å‡»ï¼Œè¿˜èƒ½æœ‰æ•ˆé™åˆ¶æ¶æ„Enclaveçš„ç ´åèƒ½åŠ›ï¼Œç¡®ä¿ç³»ç»Ÿæ•´ä½“çš„å®‰å…¨æ€§ã€‚</p><h2 id="åº•å±‚æŠ€æœ¯å®ç°å‰–æ"><a href="#åº•å±‚æŠ€æœ¯å®ç°å‰–æ" class="headerlink" title="åº•å±‚æŠ€æœ¯å®ç°å‰–æ"></a>åº•å±‚æŠ€æœ¯å®ç°å‰–æ</h2><p>ä¸ºäº†æ›´æ·±å…¥ç†è§£HyperEnclaveçš„å®‰å…¨ä¿è¯ï¼Œæˆ‘ä»¬éœ€è¦æ·±å…¥åˆ°ç¡¬ä»¶å’Œè½¯ä»¶äº¤äº’çš„ç»†èŠ‚å±‚é¢ï¼Œæ¢è®¨å…¶ä¸‰ä¸ªæ ¸å¿ƒéš”ç¦»æœºåˆ¶çš„åº•å±‚å®ç°åŸç†ã€‚</p><h3 id="1-ç‰¹æƒçº§åˆ†ç¦»çš„åº•å±‚å®ç°"><a href="#1-ç‰¹æƒçº§åˆ†ç¦»çš„åº•å±‚å®ç°" class="headerlink" title="1. ç‰¹æƒçº§åˆ†ç¦»çš„åº•å±‚å®ç°"></a>1. ç‰¹æƒçº§åˆ†ç¦»çš„åº•å±‚å®ç°</h3><h4 id="æ ¸å¿ƒæŠ€æœ¯ï¼šVMCS-VMCBï¼ˆè™šæ‹Ÿæœºæ§åˆ¶ç»“æ„ï¼‰"><a href="#æ ¸å¿ƒæŠ€æœ¯ï¼šVMCS-VMCBï¼ˆè™šæ‹Ÿæœºæ§åˆ¶ç»“æ„ï¼‰" class="headerlink" title="æ ¸å¿ƒæŠ€æœ¯ï¼šVMCS&#x2F;VMCBï¼ˆè™šæ‹Ÿæœºæ§åˆ¶ç»“æ„ï¼‰"></a>æ ¸å¿ƒæŠ€æœ¯ï¼šVMCS&#x2F;VMCBï¼ˆè™šæ‹Ÿæœºæ§åˆ¶ç»“æ„ï¼‰</h4><p>ç‰¹æƒçº§åˆ†ç¦»ä¸ä»…ä»…æ˜¯æ¦‚å¿µä¸Šçš„ï¼Œå®ƒè¢«å›ºåŒ–åœ¨CPUçš„ä¸€ä¸ªå…³é”®æ•°æ®ç»“æ„ä¸­ï¼Œå³Intelçš„<strong>VMCSï¼ˆVirtual Machine Control Structureï¼‰</strong>æˆ–AMDçš„<strong>VMCBï¼ˆVirtual Machine Control Blockï¼‰</strong>ã€‚</p><p>å½“<code>RustMonitor</code>é€šè¿‡â€åº¦é‡å»¶è¿Ÿå¯åŠ¨â€æŒæ§ç³»ç»Ÿåï¼Œå®ƒä¼šä¸ºâ€æ™®é€šä¸–ç•Œâ€ï¼ˆå³ä¸»æ“ä½œç³»ç»Ÿï¼‰ç²¾å¿ƒæ„å»ºè¿™æœ¬â€æ‰‹å†Œâ€ï¼š</p><p><strong>å®šä¹‰â€ä¸»æœºçŠ¶æ€â€ï¼ˆHost Stateï¼‰</strong>ï¼š</p><ul><li><code>RustMonitor</code>åœ¨VMCSä¸­å¡«å…¥è‡ªå·±è¿è¡Œæ‰€éœ€çš„æ‰€æœ‰CPUçŠ¶æ€ï¼ŒåŒ…æ‹¬æŒ‡ä»¤æŒ‡é’ˆï¼ˆ<code>RIP</code>ï¼‰ã€æ ˆæŒ‡é’ˆï¼ˆ<code>RSP</code>ï¼‰ã€æ§åˆ¶å¯„å­˜å™¨ï¼ˆ<code>CR3</code>ï¼ŒæŒ‡å‘<code>RustMonitor</code>è‡ªå·±çš„é¡µè¡¨ï¼‰ç­‰</li><li><strong>ä½œç”¨</strong>ï¼šå½“å‘ç”Ÿéœ€è¦<code>RustMonitor</code>ä»‹å…¥çš„äº‹ä»¶æ—¶ï¼ˆå³<strong>VM-Exit</strong>ï¼‰ï¼ŒCPUç¡¬ä»¶ä¼šè‡ªåŠ¨ã€åŸå­æ€§åœ°åŠ è½½è¿™å¥—çŠ¶æ€ï¼Œç¡®ä¿æ§åˆ¶æƒèƒ½ç¬é—´ã€å®‰å…¨åœ°è½¬ç§»ç»™<code>RustMonitor</code></li></ul><p><strong>å®šä¹‰â€å®¢æˆ·æœºçŠ¶æ€â€ï¼ˆGuest Stateï¼‰</strong>ï¼š</p><ul><li><code>RustMonitor</code>åŒæ ·åœ¨VMCSä¸­å¡«å…¥ä¸»æ“ä½œç³»ç»Ÿè¿è¡Œæ—¶åº”æœ‰çš„çŠ¶æ€</li><li><strong>ä½œç”¨</strong>ï¼šå½“<code>RustMonitor</code>å¤„ç†å®Œäº‹ä»¶ï¼Œå†³å®šå°†æ§åˆ¶æƒäº¤è¿˜ç»™ä¸»æ“ä½œç³»ç»Ÿæ—¶ï¼ˆå³<strong>VM-Entry</strong>ï¼‰ï¼ŒCPUä¼šè‡ªåŠ¨åŠ è½½è¿™å¥—çŠ¶æ€ï¼Œè®©ä¸»æ“ä½œç³»ç»Ÿä»åˆšæ‰è¢«ä¸­æ–­çš„åœ°æ–¹æ— ç¼æ¢å¤æ‰§è¡Œ</li></ul><p><strong>å®šä¹‰â€æ‰§è¡Œæ§åˆ¶â€ï¼ˆExecution Controlsï¼‰</strong>ï¼š</p><ul><li><strong>è¿™æ˜¯æœ€å…³é”®çš„ä¸€æ­¥</strong>ã€‚<code>RustMonitor</code>åœ¨VMCSä¸­è®¾ç½®äº†ä¸€ç³»åˆ—<strong>æ§åˆ¶ä½</strong>ï¼Œåƒä¸€ä¸ªè§„åˆ™å¼•æ“ï¼Œå‘Šè¯‰CPUç¡¬ä»¶ï¼šâ€å½“æ™®é€šä¸–ç•Œè¯•å›¾åšä»¥ä¸‹è¿™äº›äº‹æƒ…æ—¶ï¼Œç«‹å³åœæ­¢å®ƒçš„æ‰§è¡Œï¼Œå¹¶å‘æˆ‘ï¼ˆ<code>RustMonitor</code>ï¼‰æŠ¥å‘Šï¼â€</li><li>è¿™äº›äº‹æƒ…åŒ…æ‹¬ï¼š<ul><li><strong>è®¿é—®ç‰¹æƒå¯„å­˜å™¨</strong>ï¼šå¦‚å°è¯•ä¿®æ”¹<code>CR0</code>, <code>CR3</code>ç­‰</li><li><strong>æ‰§è¡Œç‰¹æƒæŒ‡ä»¤</strong>ï¼šå¦‚<code>HLT</code>ï¼ˆåœæœºï¼‰, <code>IN</code>&#x2F;<code>OUT</code>ï¼ˆI&#x2F;Oç«¯å£è®¿é—®ï¼‰, <code>LGDT</code>ï¼ˆåŠ è½½å…¨å±€æè¿°ç¬¦è¡¨ï¼‰ç­‰</li><li><strong>å¤„ç†ä¸­æ–­å’Œå¼‚å¸¸</strong>ï¼šæ‰€æœ‰å¤–éƒ¨ä¸­æ–­å’Œå†…éƒ¨å¼‚å¸¸ï¼ˆå¦‚ç¼ºé¡µé”™è¯¯ï¼‰éƒ½ä¼šè¢«é…ç½®ä¸ºç›´æ¥è§¦å‘VM-Exit</li></ul></li></ul><p><strong>å®‰å…¨æ•ˆæœçš„å®ç°</strong>ï¼šå½“<code>RustMonitor</code>æ‰§è¡Œ<code>VMLAUNCH</code>æˆ–<code>VMRESUME</code>æŒ‡ä»¤åï¼ŒCPUå°±è¿›å…¥äº†Non-Rootæ¨¡å¼ï¼Œå¼€å§‹ä¸¥æ ¼æŒ‰ç…§VMCSè¿™æœ¬â€æ‰‹å†Œâ€æ¥ç›‘ç£ä¸»æ“ä½œç³»ç»Ÿçš„è¡Œä¸ºã€‚ä¸»æ“ä½œç³»ç»Ÿè‡ªä»¥ä¸ºæ‹¥æœ‰Ring 0çš„æœ€é«˜æƒé™ï¼Œä½†å®é™…ä¸Šï¼Œå®ƒçš„æ¯ä¸€æ¬¡â€ç‰¹æƒâ€æ“ä½œéƒ½è¢«ç¡¬ä»¶çº§çš„è§„åˆ™å¼•æ“çœ‹åœ¨çœ¼é‡Œï¼Œä»»ä½•è¶Šç•Œè¡Œä¸ºéƒ½ä¼šå¯¼è‡´VM-Exitï¼Œä»è€Œå°†æ§åˆ¶æƒäº¤è¿˜ç»™çœŸæ­£çš„ä¸»å®°â€”â€”<code>RustMonitor</code>ã€‚</p><h3 id="2-å†…å­˜éš”ç¦»çš„åº•å±‚å®ç°"><a href="#2-å†…å­˜éš”ç¦»çš„åº•å±‚å®ç°" class="headerlink" title="2. å†…å­˜éš”ç¦»çš„åº•å±‚å®ç°"></a>2. å†…å­˜éš”ç¦»çš„åº•å±‚å®ç°</h3><h4 id="æ ¸å¿ƒæŠ€æœ¯ï¼šEPT-NPTï¼ˆäºŒçº§åœ°å€è½¬æ¢ï¼‰"><a href="#æ ¸å¿ƒæŠ€æœ¯ï¼šEPT-NPTï¼ˆäºŒçº§åœ°å€è½¬æ¢ï¼‰" class="headerlink" title="æ ¸å¿ƒæŠ€æœ¯ï¼šEPT&#x2F;NPTï¼ˆäºŒçº§åœ°å€è½¬æ¢ï¼‰"></a>æ ¸å¿ƒæŠ€æœ¯ï¼šEPT&#x2F;NPTï¼ˆäºŒçº§åœ°å€è½¬æ¢ï¼‰</h4><p>å½“CPUåœ¨Non-Rootæ¨¡å¼ä¸‹è®¿é—®å†…å­˜æ—¶ï¼Œå…¶MMUï¼ˆå†…å­˜ç®¡ç†å•å…ƒï¼‰ä¼šæ‰§è¡Œä¸€ä¸ª<strong>ä¸¤é˜¶æ®µçš„åœ°å€ç¿»è¯‘</strong>ï¼š</p><table><thead><tr><th>é˜¶æ®µ</th><th>å‘ç”Ÿåœ°ç‚¹</th><th>æ§åˆ¶è€…</th><th>è¾“å…¥</th><th>è¾“å‡º</th><th>ä½¿ç”¨çš„é¡µè¡¨</th></tr></thead><tbody><tr><td><strong>ç¬¬ä¸€é˜¶æ®µ</strong></td><td>Guest VMå†…éƒ¨</td><td>ä¸»æ“ä½œç³»ç»Ÿ</td><td>è™šæ‹Ÿåœ°å€(VA)</td><td>å®¢æˆ·æœºç‰©ç†åœ°å€(GPA)</td><td><strong>L1é¡µè¡¨</strong>(<code>CR3</code>æŒ‡å‘)</td></tr><tr><td><strong>ç¬¬äºŒé˜¶æ®µ</strong></td><td>CPUç¡¬ä»¶</td><td><code>RustMonitor</code></td><td>å®¢æˆ·æœºç‰©ç†åœ°å€(GPA)</td><td><strong>ä¸»æœºç‰©ç†åœ°å€(HPA)</strong></td><td><strong>L2é¡µè¡¨</strong>(EPT&#x2F;NPT)</td></tr></tbody></table><p>HyperEnclaveæ­£æ˜¯åˆ©ç”¨äº†å®ƒå¯¹<strong>L2é¡µè¡¨</strong>çš„ç»å¯¹æ§åˆ¶æƒæ¥å®ç°å†…å­˜éš”ç¦»çš„ï¼š</p><p><strong>L2é¡µè¡¨çš„æ„å»ºä¸åˆ‡æ¢</strong>ï¼š</p><ul><li><strong>ä¸»OSçš„L2é¡µè¡¨</strong>ï¼š<code>RustMonitor</code>ä¸ºä¸»æ“ä½œç³»ç»Ÿæ„å»ºçš„L2é¡µè¡¨ä¸­ï¼ŒåªåŒ…å«äº†ä»å…¶GPAåˆ°<strong>éå®‰å…¨ç‰©ç†å†…å­˜åŒº</strong>çš„æ˜ å°„ã€‚å¯¹äºâ€å®‰å…¨ç‰©ç†å†…å­˜åŒºâ€çš„åœ°å€èŒƒå›´ï¼Œè¿™å¼ è¡¨é‡Œæ˜¯<strong>ä¸€ç‰‡ç©ºç™½</strong>ï¼Œæ²¡æœ‰ä»»ä½•æœ‰æ•ˆæ¡ç›®</li><li><strong>Enclaveçš„L2é¡µè¡¨</strong>ï¼šå½“åˆ›å»ºä¸€ä¸ªEnclaveæ—¶ï¼Œ<code>RustMonitor</code>ä¼šåˆ†é…ä¸€å—æ–°çš„å®‰å…¨ç‰©ç†å†…å­˜ï¼Œå¹¶ä¸ºè¿™ä¸ªEnclaveçš„vCPUæ„å»ºä¸€å¥—<strong>å…¨æ–°çš„ã€ç‹¬ç«‹çš„L2é¡µè¡¨</strong>ã€‚è¿™å¥—é¡µè¡¨åªåŒ…å«ä»Enclaveçš„GPAåˆ°è¿™å—æ–°åˆ†é…çš„å®‰å…¨ç‰©ç†å†…å­˜çš„æ˜ å°„ï¼ˆä»¥åŠåˆ°å…±äº«ç¼–ç»„ç¼“å†²åŒºçš„æ˜ å°„ï¼‰</li><li><strong>åˆ‡æ¢æœºåˆ¶</strong>ï¼š<code>RustMonitor</code>åœ¨VMCSä¸­ä¸ºä¸åŒçš„vCPUä¸Šä¸‹æ–‡ï¼ˆä¸»OSçš„vCPUå’ŒEnclaveçš„vCPUï¼‰é…ç½®äº†ä¸åŒçš„L2é¡µè¡¨åŸºå€æŒ‡é’ˆï¼ˆ<code>EPTP</code>ï¼‰ã€‚å½“é€šè¿‡<code>hypercall</code>è¿›è¡Œä¸–ç•Œåˆ‡æ¢æ—¶ï¼Œ<code>RustMonitor</code>ä¼šåŠ è½½ç›®æ ‡ä¸–ç•Œçš„VMCSï¼ŒCPUåœ¨æ‰§è¡Œ<code>VMRESUME</code>æ—¶ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°æ–°çš„L2é¡µè¡¨ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯<strong>åŸå­æ€§</strong>çš„</li></ul><p><strong>ç¡¬ä»¶å¼ºåˆ¶çš„è®¿é—®æ§åˆ¶</strong>ï¼š</p><ul><li><strong>åœºæ™¯æ¨¡æ‹Ÿ</strong>ï¼šå‡è®¾ä¸»æ“ä½œç³»ç»Ÿä¸­çš„æ¶æ„ä»£ç è¯•å›¾è®¿é—®ä¸€ä¸ªå±äºEnclaveçš„GPA</li><li><strong>MMUå·¥ä½œæµ</strong>ï¼š<ol><li>MMUå¼€å§‹ç¬¬äºŒé˜¶æ®µç¿»è¯‘ï¼Œæ‹¿ç€è¿™ä¸ªGPAå»æŸ¥è¯¢<strong>å½“å‰ä¸»OSæ­£åœ¨ä½¿ç”¨çš„L2é¡µè¡¨</strong></li><li>MMUéå†L2é¡µè¡¨ï¼Œå‘ç°è¯¥GPAå¯¹åº”çš„æ¡ç›®æ˜¯<strong>ä¸å­˜åœ¨æˆ–æ— æ•ˆçš„</strong></li><li>ç¡¬ä»¶ç«‹å³è§¦å‘ä¸€ä¸ªåä¸º<strong>EPT Violation</strong>çš„å¼‚å¸¸</li><li>è¿™ä¸ªå¼‚å¸¸è¢«â€æ‰§è¡Œæ§åˆ¶â€è§„åˆ™å®šä¹‰ä¸ºå¿…é¡»è§¦å‘<strong>VM-Exit</strong></li><li><code>RustMonitor</code>è·å¾—æ§åˆ¶æƒï¼Œæ£€æŸ¥VM-Exitçš„åŸå› æ˜¯EPT Violationï¼Œå®ƒç«‹åˆ»å°±çŸ¥é“ä¸»æ“ä½œç³»ç»Ÿè¯•å›¾è¿›è¡Œéæ³•å†…å­˜è®¿é—®ï¼Œå¯ä»¥ç«‹å³ç»ˆæ­¢è¿™ä¸ªæ¶æ„è¿›ç¨‹</li></ol></li></ul><p><strong>å®‰å…¨æ•ˆæœçš„å®ç°</strong>ï¼šå†…å­˜éš”ç¦»å¹¶éç”±<code>RustMonitor</code>åœ¨è½¯ä»¶å±‚é¢ä¸æ–­æ£€æŸ¥ï¼Œè€Œæ˜¯é€šè¿‡<strong>é¢„è®¾L2é¡µè¡¨â€è§„åˆ™â€<strong>ï¼Œç„¶åå®Œå…¨äº¤ç”±</strong>CPU MMUç¡¬ä»¶</strong>æ¥å¼ºåˆ¶æ‰§è¡Œã€‚ç¡¬ä»¶æˆä¸ºäº†æœ€å¿ å®ã€æœ€é«˜æ•ˆçš„å®ˆå«ï¼Œä»»ä½•è¿åé¢„è®¾å†…å­˜è§†å›¾çš„è¡Œä¸ºéƒ½ä¼šè¢«å®ƒç«‹å³æ•è·å¹¶ä¸ŠæŠ¥ã€‚</p><h3 id="3-æ‰§è¡Œæµéš”ç¦»çš„åº•å±‚å®ç°"><a href="#3-æ‰§è¡Œæµéš”ç¦»çš„åº•å±‚å®ç°" class="headerlink" title="3. æ‰§è¡Œæµéš”ç¦»çš„åº•å±‚å®ç°"></a>3. æ‰§è¡Œæµéš”ç¦»çš„åº•å±‚å®ç°</h3><h4 id="æ ¸å¿ƒæŠ€æœ¯ï¼šVMCALLæŒ‡ä»¤ä¸å—æ§çš„VM-Exit"><a href="#æ ¸å¿ƒæŠ€æœ¯ï¼šVMCALLæŒ‡ä»¤ä¸å—æ§çš„VM-Exit" class="headerlink" title="æ ¸å¿ƒæŠ€æœ¯ï¼šVMCALLæŒ‡ä»¤ä¸å—æ§çš„VM-Exit"></a>æ ¸å¿ƒæŠ€æœ¯ï¼šVMCALLæŒ‡ä»¤ä¸å—æ§çš„VM-Exit</h4><p>ç¡®ä¿Enclaveçš„æ¯ä¸€æ¬¡å¯åŠ¨ã€é€€å‡ºå’Œé€šä¿¡éƒ½åœ¨<code>RustMonitor</code>çš„ä¸¥å¯†æ§åˆ¶ä¸‹ï¼Œé˜²æ­¢éé¢„æœŸçš„æµç¨‹è·³è½¬ã€‚</p><p><strong>ECALLçš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ</strong>ï¼š</p><ol><li><strong>åº”ç”¨å±‚ï¼ˆéå¯ä¿¡ï¼‰</strong>ï¼šè°ƒç”¨<code>HyperEnclave SDK</code>æä¾›çš„åº“å‡½æ•°ï¼Œå¦‚<code>ecall_my_function()</code></li><li><strong>SDKï¼ˆuRTSï¼‰</strong>ï¼šå°†å‚æ•°å®‰å…¨åœ°å¤åˆ¶åˆ°â€ç¼–ç»„ç¼“å†²åŒºâ€ã€‚ç„¶åï¼Œå®ƒä¸ä¼šç›´æ¥è·³è½¬ï¼Œè€Œæ˜¯å‘èµ·ä¸€ä¸ª<code>ioctl</code>ç³»ç»Ÿè°ƒç”¨ï¼Œè¯·æ±‚<code>/dev/hyper_enclave</code>å†…æ ¸æ¨¡å—</li><li><strong>å†…æ ¸æ¨¡å—ï¼ˆéå¯ä¿¡ï¼‰</strong>ï¼šæ”¶åˆ°<code>ioctl</code>è¯·æ±‚åï¼Œå®ƒæ‰€åšçš„å”¯ä¸€ä¸€ä»¶æ ¸å¿ƒäº‹æƒ…å°±æ˜¯æ‰§è¡Œ<code>VMCALL</code>æŒ‡ä»¤ã€‚è¿™æ˜¯ä¸€ä¸ªæ˜ç¡®çš„ã€è¯·æ±‚HypervisoræœåŠ¡çš„ä¿¡å·</li><li><strong>VM-Exit</strong>ï¼š<code>VMCALL</code>æŒ‡ä»¤ç«‹å³è§¦å‘VM-Exitã€‚CPUç¡¬ä»¶ä¿å­˜å®¢æˆ·æœºçŠ¶æ€ï¼ŒåŠ è½½ä¸»æœºçŠ¶æ€ï¼Œå°†æ§åˆ¶æƒäº¤ç»™<code>RustMonitor</code>ã€‚VMCSä¸­çš„é€€å‡ºåŸå› å­—æ®µä¼šæ˜ç¡®è®°å½•â€VMCALLâ€</li><li><strong><code>RustMonitor</code>ï¼ˆå¯ä¿¡ï¼‰</strong>ï¼š<ul><li>æ£€æŸ¥é€€å‡ºåŸå› ï¼Œç¡®è®¤ä¸º<code>VMCALL</code></li><li>ä»å®¢æˆ·æœºçš„å¯„å­˜å™¨ï¼ˆå¦‚<code>RAX</code>ï¼‰ä¸­è¯»å–å…·ä½“çš„æœåŠ¡è¯·æ±‚å·ï¼ˆä¾‹å¦‚ï¼Œè¿™æ˜¯ä¸€ä¸ªECALLè¯·æ±‚ï¼Œç›®æ ‡æ˜¯å“ªä¸ªEnclaveçš„å“ªä¸ªå‡½æ•°ï¼‰</li><li><strong>æ‰§è¡Œå®‰å…¨æ£€æŸ¥</strong>ï¼šéªŒè¯è¯·æ±‚çš„åˆæ³•æ€§</li><li><strong>ä¸Šä¸‹æ–‡åˆ‡æ¢</strong>ï¼š<ul><li>ä¿å­˜ä¸»OSçš„vCPUçŠ¶æ€</li><li>åŠ è½½ç›®æ ‡Enclaveçš„vCPUçŠ¶æ€</li><li><strong>åˆ‡æ¢L2é¡µè¡¨</strong>ï¼Œå°†å†…å­˜è§†å›¾å˜ä¸ºEnclaveçš„è§†å›¾</li></ul></li><li><strong>è®¾ç½®å…¥å£ç‚¹</strong>ï¼šåœ¨Enclaveçš„vCPUçŠ¶æ€ä¸­ï¼Œå°†<code>RIP</code>ï¼ˆæŒ‡ä»¤æŒ‡é’ˆï¼‰è®¾ç½®ä¸ºç›®æ ‡å‡½æ•°çš„å…¥å£åœ°å€ï¼Œå¹¶å°†å‚æ•°æŒ‡é’ˆè®¾ç½®ä¸ºæŒ‡å‘â€ç¼–ç»„ç¼“å†²åŒºâ€</li></ul></li><li><strong>VM-Entry</strong>ï¼š<code>RustMonitor</code>æ‰§è¡Œ<code>VMRESUME</code>ï¼ŒCPUåŠ è½½Enclaveçš„ä¸Šä¸‹æ–‡ï¼Œå¼€å§‹åœ¨å®‰å…¨ä¸–ç•Œä¸­æ‰§è¡Œ</li></ol><p><strong>OCALLï¼ˆä»Enclaveè¿”å›ï¼‰</strong>çš„æµç¨‹ä¸æ­¤ç±»ä¼¼ï¼Œåªæ˜¯æ–¹å‘ç›¸åã€‚Enclaveä¹Ÿå¿…é¡»é€šè¿‡<code>VMCALL</code>è¯·æ±‚<code>RustMonitor</code>æ¥ä½œä¸ºä¸­ä»‹ï¼Œå®‰å…¨åœ°è¿”å›åˆ°ä¸»æ“ä½œç³»ç»Ÿã€‚</p><p><strong>å®‰å…¨æ•ˆæœçš„å®ç°</strong>ï¼šè¿™æ¡æ‰§è¡Œé“¾æ˜¯<strong>å•å‘ä¸”ä¸å¯ç»•è¿‡çš„</strong>ã€‚ä¸»OSå’ŒEnclaveä¹‹é—´æ— æ³•ç›´æ¥é€šä¿¡æˆ–è·³è½¬ï¼Œå®ƒä»¬ä¹‹é—´æ°¸è¿œéš”ç€ä¸€ä¸ª**å¼ºåˆ¶æ€§çš„ã€å¯ä¿¡çš„ä¸­é—´äººâ€”â€”<code>RustMonitor</code>**ã€‚<code>RustMonitor</code>å°±åƒä¸€ä¸ªè¾¹å¢ƒæ£€æŸ¥ç«™ï¼Œå¯¹æ¯ä¸€æ¬¡è¿›å‡ºï¼ˆECALL&#x2F;OCALLï¼‰éƒ½è¿›è¡Œä¸¥æ ¼çš„å®¡æŸ¥å’Œæµç¨‹ç®¡ç†ï¼Œç¡®ä¿äº†æ‰§è¡Œæµçš„ç»å¯¹éš”ç¦»ã€‚</p><h2 id="ä¸Intel-SGX2-Occlumçš„æŠ€æœ¯å¯¹æ¯”"><a href="#ä¸Intel-SGX2-Occlumçš„æŠ€æœ¯å¯¹æ¯”" class="headerlink" title="ä¸Intel SGX2 + Occlumçš„æŠ€æœ¯å¯¹æ¯”"></a>ä¸Intel SGX2 + Occlumçš„æŠ€æœ¯å¯¹æ¯”</h2><p>å½“æˆ‘ä»¬æ·±å…¥åˆ°å¹³å°å®ç°å±‚é¢æ—¶ï¼Œå°±ä¸å†æ˜¯ç®€å•åœ°å¯¹æ¯”ä¸¤ç§TEEç¡¬ä»¶æŠ€æœ¯ï¼Œè€Œæ˜¯åœ¨å¯¹æ¯”ä¸¤ä¸ª<strong>é«˜åº¦å¯ç”¨çš„æœºå¯†è®¡ç®—å¹³å°è§£å†³æ–¹æ¡ˆ</strong>ã€‚<code>Intel SGX2 + Occlum</code>å’Œ<code>HyperEnclave</code>éƒ½è‡´åŠ›äºè§£å†³åŒä¸€ä¸ªæ ¸å¿ƒç—›ç‚¹ï¼š<strong>å¦‚ä½•è®©æ™®é€šåº”ç”¨ç¨‹åºæ›´å®¹æ˜“åœ°è¿è¡Œåœ¨å¯ä¿¡æ‰§è¡Œç¯å¢ƒï¼ˆTEEï¼‰ä¸­</strong>ã€‚</p><h3 id="æ ¸å¿ƒå“²å­¦å¯¹æ¯”"><a href="#æ ¸å¿ƒå“²å­¦å¯¹æ¯”" class="headerlink" title="æ ¸å¿ƒå“²å­¦å¯¹æ¯”"></a>æ ¸å¿ƒå“²å­¦å¯¹æ¯”</h3><ul><li><strong>Intel SGX2 + Occlum</strong>ï¼š**â€ä¸ºå›ºè‹¥é‡‘æ±¤çš„å ¡å’ï¼ˆSGXï¼‰å¼€ä¸€æ‰‡æ–¹ä¾¿çš„é—¨â€**ã€‚å®ƒæ¥å—SGXç¡¬ä»¶çš„å¼ºä¾èµ–å’Œå°é—­æ€§ï¼Œé€šè¿‡åœ¨å ¡å’å†…éƒ¨æ„å»ºä¸€ä¸ªç²¾å·§çš„åº“æ“ä½œç³»ç»Ÿï¼ˆLibOSï¼‰ï¼Œæ¥æ¨¡æ‹Ÿä¸€ä¸ªå®Œæ•´çš„Linuxç¯å¢ƒï¼Œä»è€Œâ€æ¬ºéª—â€åº”ç”¨ç¨‹åºï¼Œè®©å®ƒæ„Ÿè§‰è‡ªå·±è¿è¡Œåœ¨ä¸€ä¸ªæ™®é€šç³»ç»Ÿé‡Œ</li><li><strong>HyperEnclave</strong>ï¼š**â€ç”¨éšå¤„å¯è§çš„ç§¯æœ¨ï¼ˆè™šæ‹ŸåŒ–ï¼‰æ­å»ºä¸€ä¸ªçµæ´»çš„å ¡å’â€**ã€‚å®ƒæ”¾å¼ƒå¯¹ç‰¹å®šç¡¬ä»¶çš„ä¾èµ–ï¼Œåˆ©ç”¨æ‰€æœ‰ç°ä»£CPUéƒ½å…·å¤‡çš„è™šæ‹ŸåŒ–åŠŸèƒ½æ¥æ„å»ºéš”ç¦»åŒºï¼Œå¹¶é€šè¿‡çµæ´»çš„æ¶æ„è®¾è®¡æ¥æ¨¡æ‹ŸSGXçš„æ¥å£ï¼Œä»è€Œå…¼å®¹å…¶ç”Ÿæ€</li></ul><h3 id="è¯¦ç»†ä¼˜ç¼ºç‚¹åˆ†æ"><a href="#è¯¦ç»†ä¼˜ç¼ºç‚¹åˆ†æ" class="headerlink" title="è¯¦ç»†ä¼˜ç¼ºç‚¹åˆ†æ"></a>è¯¦ç»†ä¼˜ç¼ºç‚¹åˆ†æ</h3><table><thead><tr><th>æŠ€æœ¯ç»´åº¦</th><th>Intel SGX2 + Occlum</th><th>HyperEnclave</th></tr></thead><tbody><tr><td><strong>å®‰å…¨çº¯ç²¹æ€§</strong></td><td><strong>æè‡´</strong>ï¼šTCBæœ€å°ï¼Œå®‰å…¨æ ¹åŸºæ˜¯çº¯ç¡¬ä»¶ï¼Œå†…å­˜å®Œæ•´æ€§ç”±ç¡¬ä»¶ä¿è¯</td><td><strong>é«˜</strong>ï¼šTCBåŒ…å«ä¸€ä¸ªè½»é‡çº§Hypervisorï¼ˆ<code>RustMonitor</code>ï¼‰ï¼Œæ˜¯è½¯ä»¶</td></tr><tr><td><strong>åº”ç”¨å…¼å®¹æ€§</strong></td><td><strong>é«˜</strong>ï¼šOcclumæ—¨åœ¨æ— éœ€ä¿®æ”¹å³å¯è¿è¡Œå¤§å¤šæ•°Linuxåº”ç”¨</td><td><strong>æé«˜</strong>ï¼šæ—¨åœ¨å…¼å®¹SGX APIï¼Œç†è®ºä¸ŠOcclumä¹Ÿèƒ½è¿è¡Œåœ¨å®ƒä¹‹ä¸Š</td></tr><tr><td><strong>æ€§èƒ½æ¨¡å‹</strong></td><td><strong>ç›¸å¯¹å›ºå®š</strong>ï¼šå¼€é”€ä¸»è¦æ¥è‡ªç³»ç»Ÿè°ƒç”¨è¢«Occlumæ‹¦æˆªå¹¶å¤„ç†ï¼Œä»¥åŠè¿›å‡ºEnclaveçš„å›ºå®šæˆæœ¬</td><td><strong>çµæ´»å¯è°ƒ</strong>ï¼šæä¾›ä¸‰ç§æ“ä½œæ¨¡å¼ï¼Œå¯ä¸ºä¸åŒè´Ÿè½½ï¼ˆè®¡ç®—&#x2F;IOå¯†é›†å‹ï¼‰ä¼˜åŒ–æ€§èƒ½</td></tr><tr><td><strong>ç¡¬ä»¶çµæ´»æ€§</strong></td><td><strong>æ— </strong>ï¼šä¸¥æ ¼ç»‘å®šäºæ”¯æŒSGX2çš„Intel CPU</td><td><strong>æé«˜</strong>ï¼šè·¨Intel&#x2F;AMDå¹³å°ï¼Œä¸ºæ··åˆäº‘å’Œåˆ©æ—§æä¾›äº†å¯èƒ½</td></tr><tr><td><strong>ç”Ÿæ€æˆç†Ÿåº¦</strong></td><td><strong>éå¸¸æˆç†Ÿ</strong>ï¼šOcclumã€Gramineç­‰å·¥å…·ç»è¿‡å¤šå¹´å‘å±•ï¼Œæœ‰å¤§é‡ç”Ÿäº§æ¡ˆä¾‹å’Œç¤¾åŒºæ”¯æŒ</td><td><strong>å‘å±•ä¸­</strong>ï¼šé¡¹ç›®ç›¸å¯¹è¾ƒæ–°ï¼Œç¤¾åŒºå’Œå·¥å…·é“¾æ­£åœ¨å¿«é€Ÿæˆé•¿</td></tr><tr><td><strong>å¼€æºä¸å¯å®¡è®¡æ€§</strong></td><td><strong>éƒ¨åˆ†å¼€æº</strong>ï¼šOcclumæ˜¯å¼€æºçš„ï¼Œä½†åº•å±‚çš„SGXå¾®ç å’ŒCPUé€»è¾‘æ˜¯é»‘ç›’</td><td><strong>é«˜åº¦å¼€æº</strong>ï¼šæ ¸å¿ƒç»„ä»¶<code>RustMonitor</code>æ˜¯å¼€æºçš„ï¼Œä¸ºå®‰å…¨å®¡è®¡æä¾›äº†å¯èƒ½</td></tr><tr><td><strong>æˆæœ¬</strong></td><td><strong>é«˜</strong>ï¼šéœ€è¦é‡‡è´­ç‰¹å®šçš„ã€é€šå¸¸æ›´æ˜‚è´µçš„SGXæœåŠ¡å™¨ç¡¬ä»¶</td><td><strong>ä½</strong>ï¼šå‡ ä¹å¯ä»¥åœ¨ä»»ä½•ç°æœ‰æ•°æ®ä¸­å¿ƒæœåŠ¡å™¨ä¸Šéƒ¨ç½²ï¼Œç¡¬ä»¶æˆæœ¬æä½</td></tr></tbody></table><h3 id="å„è‡ªçš„ç‹¬ç‰¹ä¼˜åŠ¿"><a href="#å„è‡ªçš„ç‹¬ç‰¹ä¼˜åŠ¿" class="headerlink" title="å„è‡ªçš„ç‹¬ç‰¹ä¼˜åŠ¿"></a>å„è‡ªçš„ç‹¬ç‰¹ä¼˜åŠ¿</h3><h4 id="Intel-SGX2-Occlumæ–¹æ¡ˆçš„ä¼˜ç‚¹"><a href="#Intel-SGX2-Occlumæ–¹æ¡ˆçš„ä¼˜ç‚¹" class="headerlink" title="Intel SGX2 + Occlumæ–¹æ¡ˆçš„ä¼˜ç‚¹"></a>Intel SGX2 + Occlumæ–¹æ¡ˆçš„ä¼˜ç‚¹</h4><p><strong>ğŸ¥‡ æè‡´çš„å®‰å…¨ä¿è¯å’Œæœ€å°çš„ä¿¡ä»»é¢</strong></p><ul><li>è¿™æ˜¯å®ƒæœ€æ ¸å¿ƒçš„ç‹ç‰Œã€‚ç”±äºåº•å±‚æ˜¯SGX2ç¡¬ä»¶ï¼Œå®ƒçš„å¯ä¿¡è®¡ç®—åŸºï¼ˆTCBï¼‰ä¸åŒ…å«ä»»ä½•Hypervisorã€‚ä¿¡ä»»é“¾ç›´è¾¾CPUç¡¬ä»¶ï¼Œæä¾›äº†ç†è®ºä¸Šæœ€é«˜çš„å®‰å…¨ä¿è¯ã€‚å†…å­˜çš„åŠ å¯†å’Œå®Œæ•´æ€§ä¿æŠ¤ç”±ç¡¬ä»¶å¼ºåˆ¶æ‰§è¡Œï¼Œæ— éœ€ä¾èµ–å¤–éƒ¨</li></ul><p><strong>ğŸ¥ˆ æˆç†Ÿä¸”ç»è¿‡éªŒè¯çš„LibOSç”Ÿæ€</strong></p><ul><li>Occlumå’ŒGramineç­‰é¡¹ç›®å·²ç»éå¸¸æˆç†Ÿï¼Œèƒ½å¤Ÿæ”¯æŒåŒ…æ‹¬Pythonï¼ˆGlibcï¼‰ã€Javaï¼ˆJVMï¼‰ã€Goç­‰åœ¨å†…çš„å¤æ‚åº”ç”¨ç”Ÿæ€ã€‚è¿™æ„å‘³ç€å¤§é‡çš„å‘å·²ç»è¢«è¸©è¿‡ï¼Œå…¼å®¹æ€§å’Œç¨³å®šæ€§æœ‰æ›´å¥½çš„ä¿éšœ</li></ul><p><strong>ğŸ¥‰ å…¬æœ‰äº‘ä¸Šçš„ç”Ÿäº§å°±ç»ª</strong></p><ul><li>Azureã€Google Cloudã€IBM Cloudç­‰ä¸»æµäº‘å‚å•†æä¾›çš„æœºå¯†è®¡ç®—å®ä¾‹ï¼Œå…¶åº•å±‚æŠ€æœ¯æ ˆå°±æ˜¯<code>SGX + LibOS</code>ã€‚è¿™æ„å‘³ç€è¯¥æ–¹æ¡ˆå·²ç»è¿‡å¤§è§„æ¨¡çš„ç”Ÿäº§ç¯å¢ƒéªŒè¯ï¼Œæœ‰æˆç†Ÿçš„å•†ä¸šæ”¯æŒå’ŒæœåŠ¡ç­‰çº§åè®®ï¼ˆSLAï¼‰</li></ul><h4 id="HyperEnclaveæ–¹æ¡ˆçš„ä¼˜ç‚¹"><a href="#HyperEnclaveæ–¹æ¡ˆçš„ä¼˜ç‚¹" class="headerlink" title="HyperEnclaveæ–¹æ¡ˆçš„ä¼˜ç‚¹"></a>HyperEnclaveæ–¹æ¡ˆçš„ä¼˜ç‚¹</h4><p><strong>ğŸ¥‡ æ— ä¸ä¼¦æ¯”çš„ç¡¬ä»¶æ— å…³æ€§å’Œæˆæœ¬æ•ˆç›Š</strong></p><ul><li>HyperEnclaveæ‰“ç ´äº†å‚å•†é”å®šï¼Œè®©æœºå¯†è®¡ç®—æˆä¸ºäº†ä¸€ä¸ªæ™®é€‚æ€§çš„èƒ½åŠ›ã€‚ä¼ä¸šå¯ä»¥åœ¨ç°æœ‰çš„ã€æ··åˆäº†Intelå’ŒAMDæœåŠ¡å™¨çš„æ•°æ®ä¸­å¿ƒé‡Œï¼Œæ— éœ€é¢å¤–ç¡¬ä»¶æŠ•èµ„ï¼Œå°±èƒ½éƒ¨ç½²ä¸€å¥—ç»Ÿä¸€çš„æœºå¯†è®¡ç®—æ–¹æ¡ˆ</li></ul><p><strong>ğŸ¥ˆ é’ˆå¯¹å·¥ä½œè´Ÿè½½çš„æ€§èƒ½ä¼˜åŒ–èƒ½åŠ›</strong></p><ul><li>è¿™æ˜¯HyperEnclaveçš„â€é»‘ç§‘æŠ€â€ã€‚ä¼ ç»ŸTEEæ–¹æ¡ˆæ€§èƒ½æ¨¡å¼å•ä¸€ï¼Œè€ŒHyperEnclaveçš„ä¸‰ç§æ¨¡å¼ï¼ˆGU&#x2F;HU&#x2F;P-Enclaveï¼‰åƒä¸€ä¸ªâ€æ€§èƒ½æ—‹é’®â€ï¼š<ul><li>é‡åˆ°<strong>WebæœåŠ¡</strong>ç­‰I&#x2F;Oå¯†é›†å‹åº”ç”¨ï¼Ÿåˆ‡æ¢åˆ°<strong>HU-Enclave</strong>æ¨¡å¼ï¼Œç”¨æ›´å¿«çš„<code>syscall</code>ä»£æ›¿<code>hypercall</code>ï¼Œæ€§èƒ½æ˜¾è‘—æå‡</li><li>é‡åˆ°<strong>Javaåº”ç”¨</strong>è¿™ç§éœ€è¦é¢‘ç¹æ“ä½œå†…å­˜æƒé™çš„GCåœºæ™¯ï¼Ÿåˆ‡æ¢åˆ°<strong>P-Enclave</strong>æ¨¡å¼ï¼Œåœ¨Enclaveå†…éƒ¨å¤„ç†é¡µé”™è¯¯ï¼Œé¿å…æ˜‚è´µçš„æ¨¡å¼åˆ‡æ¢ï¼Œæ€§èƒ½è¿œè¶…SGXæ–¹æ¡ˆ</li></ul></li></ul><p><strong>ğŸ¥‰ å¼€æ”¾é€æ˜çš„å¯å®¡è®¡æ€§</strong></p><ul><li>å¯¹äºä¸€äº›å¯¹ä¾›åº”é“¾å®‰å…¨å’Œåé—¨æœ‰æé«˜è¦æ±‚çš„ç»„ç»‡ï¼ˆå¦‚æ”¿åºœã€å†›å·¥ï¼‰ï¼ŒSGXçš„â€é»‘ç›’â€ç‰¹æ€§å¯èƒ½æ˜¯ä¸€ä¸ªç–‘è™‘ç‚¹ã€‚HyperEnclaveçš„æ ¸å¿ƒ<code>RustMonitor</code>æ˜¯å¼€æºçš„ï¼Œå…è®¸è¿›è¡Œä»£ç çº§çš„å®‰å…¨å®¡è®¡ï¼Œæä¾›äº†æ›´é«˜çš„é€æ˜åº¦</li></ul><h3 id="åº”ç”¨åœºæ™¯é€‰æ‹©æŒ‡å—"><a href="#åº”ç”¨åœºæ™¯é€‰æ‹©æŒ‡å—" class="headerlink" title="åº”ç”¨åœºæ™¯é€‰æ‹©æŒ‡å—"></a>åº”ç”¨åœºæ™¯é€‰æ‹©æŒ‡å—</h3><h4 id="é€‰æ‹©Intel-SGX2-Occlumçš„åœºæ™¯"><a href="#é€‰æ‹©Intel-SGX2-Occlumçš„åœºæ™¯" class="headerlink" title="é€‰æ‹©Intel SGX2 + Occlumçš„åœºæ™¯"></a>é€‰æ‹©Intel SGX2 + Occlumçš„åœºæ™¯</h4><p><strong>æ ¸å¿ƒå…³é”®è¯ï¼šå…¬æœ‰äº‘ã€æœ€é«˜å®‰å…¨æ ‡å‡†ã€é‡‘èçº§åº”ç”¨ã€ä¿æŠ¤æ ¸å¿ƒæ•°å­—èµ„äº§</strong></p><ul><li><strong>å…¬æœ‰äº‘åŸç”Ÿæœºå¯†è®¡ç®—</strong>ï¼šå¦‚æœä½ å¸Œæœ›åˆ©ç”¨Azure DCsv3ã€Google Cloud Confidential Computingç­‰ç°æˆçš„ã€æœ‰å•†ä¸šæ”¯æŒçš„æœåŠ¡ï¼Œä½ çš„é€‰æ‹©å°±æ˜¯<code>SGX2 + LibOS</code></li><li><strong>é‡‘èã€åŒ»ç–—ç­‰å¼ºç›‘ç®¡è¡Œä¸š</strong>ï¼šå½“åˆè§„æ€§è¦æ±‚å¿…é¡»ä½¿ç”¨ç»è¿‡è¡Œä¸šå¹¿æ³›éªŒè¯ã€è¾¾åˆ°æœ€é«˜å®‰å…¨ç­‰çº§çš„æŠ€æœ¯æ—¶ï¼ŒSGXçš„æˆç†Ÿåº¦å’Œæœ€å°TCBæ˜¯é¦–é€‰</li><li>**ä¿æŠ¤â€çš‡å† ä¸Šçš„æ˜ç â€**ï¼šå½“ä½ è¦ä¿æŠ¤çš„æ˜¯æ•°å­—è´§å¸äº¤æ˜“æ‰€çš„çƒ­é’±åŒ…ç§é’¥ã€AIå…¬å¸çš„æ ¸å¿ƒè®­ç»ƒæ¨¡å‹ã€å›½å®¶çº§çš„æ•æ„Ÿæ•°æ®æ—¶ï¼Œä¸è®¡æˆæœ¬åœ°è¿½æ±‚æœ€æè‡´çš„ç¡¬ä»¶å®‰å…¨ï¼ŒSGXæ˜¯ä¸äºŒä¹‹é€‰</li></ul><p><strong>å…¸å‹ä¾‹å­</strong>ï¼šä¸€å®¶è·¨å›½é“¶è¡Œå¸Œæœ›åœ¨Azureäº‘ä¸Šéƒ¨ç½²å…¶æ ¸å¿ƒçš„äº¤æ˜“æ¸…ç®—ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œä»¥æ»¡è¶³ç›‘ç®¡è¦æ±‚ï¼Œå¹¶ç¡®ä¿äº‘æœåŠ¡å•†æ— æ³•è®¿é—®äº¤æ˜“æ•°æ®ã€‚</p><h4 id="é€‰æ‹©HyperEnclaveçš„åœºæ™¯"><a href="#é€‰æ‹©HyperEnclaveçš„åœºæ™¯" class="headerlink" title="é€‰æ‹©HyperEnclaveçš„åœºæ™¯"></a>é€‰æ‹©HyperEnclaveçš„åœºæ™¯</h4><p><strong>æ ¸å¿ƒå…³é”®è¯ï¼šç§æœ‰äº‘ã€æ··åˆäº‘ã€æˆæœ¬æ§åˆ¶ã€æ€§èƒ½æ•æ„Ÿã€æŠ€æœ¯è‡ªä¸»</strong></p><ul><li><strong>ä¼ä¸šç§æœ‰äº‘&#x2F;æ··åˆäº‘</strong>ï¼šä¸€ä¸ªå¤§å‹ä¼ä¸šå¸Œæœ›åœ¨è‡ªå·±ç°æœ‰çš„ã€åºå¤§ä¸”å¼‚æ„çš„æœåŠ¡å™¨é›†ç¾¤ä¸Šï¼Œä¸ºå†…éƒ¨ä¸šåŠ¡çº¿æä¾›ç»Ÿä¸€çš„TEEæœåŠ¡ï¼Œè€Œä¸æƒ³è¢«å•ä¸€ç¡¬ä»¶å‚å•†ç»‘å®š</li><li><strong>ç‰¹å®šæ€§èƒ½ä¼˜åŒ–åœºæ™¯</strong>ï¼šä¸€ä¸ªå›¢é˜Ÿæ­£åœ¨æ„å»ºä¸€ä¸ªåŸºäºJavaçš„å¤§æ•°æ®å¤„ç†åº”ç”¨ï¼Œå…¶åƒåœ¾å›æ”¶ï¼ˆGCï¼‰æœºåˆ¶åœ¨SGXä¸­æ€§èƒ½è¡¨ç°ä¸ä½³ã€‚ä»–ä»¬å¯ä»¥åˆ©ç”¨HyperEnclaveçš„<code>P-Enclave</code>æ¨¡å¼è·å¾—æ•°é‡çº§çš„æ€§èƒ½æå‡</li><li><strong>æŠ€æœ¯æ¢ç´¢ä¸ç ”ç©¶</strong>ï¼šé«˜æ ¡æˆ–ç ”ç©¶æœºæ„å¸Œæœ›åœ¨ä¸€ä¸ªå¼€æ”¾çš„ã€å¯å®šåˆ¶çš„ç¯å¢ƒä¸­ç ”ç©¶TEEæŠ€æœ¯ï¼Œç”šè‡³å°†å…¶ç§»æ¤åˆ°ARMæˆ–RISC-Vå¹³å°</li><li><strong>å¯¹ä¾›åº”é“¾å®‰å…¨è¦æ±‚é«˜çš„åœºæ™¯</strong>ï¼šå¸Œæœ›èƒ½å¤Ÿå¯¹TEEçš„æ ¸å¿ƒé€»è¾‘è¿›è¡Œä»£ç å®¡è®¡ï¼Œç¡®ä¿æ²¡æœ‰åé—¨</li></ul><p><strong>å…¸å‹ä¾‹å­</strong>ï¼šä¸€å®¶ç”µå•†å…¬å¸å¸Œæœ›ä¿æŠ¤å…¶éƒ¨ç½²åœ¨æœ¬åœ°æ•°æ®ä¸­å¿ƒçš„ã€ç”±Javaç¼–å†™çš„å®æ—¶æ¨èå¼•æ“ï¼ŒåŒæ—¶ä¸å¸Œæœ›ä¸ºæ­¤æ›´æ¢å¤§é‡ç°æœ‰æœåŠ¡å™¨ã€‚</p><h2 id="å®‰å…¨é£é™©ä¸æŒ‘æˆ˜åˆ†æ"><a href="#å®‰å…¨é£é™©ä¸æŒ‘æˆ˜åˆ†æ" class="headerlink" title="å®‰å…¨é£é™©ä¸æŒ‘æˆ˜åˆ†æ"></a>å®‰å…¨é£é™©ä¸æŒ‘æˆ˜åˆ†æ</h2><p>ä¸€ä¸ªæˆç†Ÿçš„å®‰å…¨ä¸“å®¶ç»ä¸ä¼šè¯´æŸä¸ªç³»ç»Ÿæ˜¯â€ç»å¯¹å®‰å…¨â€çš„ã€‚HyperEnclaveè™½ç„¶è®¾è®¡ç²¾å·§ï¼Œä½†å®ƒä¹Ÿç»éå®Œç¾æ— ç‘•ã€‚é™¤äº†å‡ ä¹æ‰€æœ‰TEEéƒ½é¢ä¸´çš„<strong>ç¡¬ä»¶ä¾§ä¿¡é“æ”»å‡»</strong>ï¼ˆå¦‚Spectre, Meltdown, L1TFç­‰ï¼‰ä¹‹å¤–ï¼ŒHyperEnclaveç¡®å®è¿˜å­˜åœ¨ä¸€äº›ç†è®ºä¸Šæˆ–å®è·µä¸­éœ€è¦å…³æ³¨çš„æ½œåœ¨å¼±ç‚¹å’ŒæŒ‘æˆ˜ã€‚</p><h3 id="1-ä¿¡ä»»æ ¹ä¸TCBå±‚é¢çš„é£é™©"><a href="#1-ä¿¡ä»»æ ¹ä¸TCBå±‚é¢çš„é£é™©" class="headerlink" title="1. ä¿¡ä»»æ ¹ä¸TCBå±‚é¢çš„é£é™©"></a>1. ä¿¡ä»»æ ¹ä¸TCBå±‚é¢çš„é£é™©</h3><p>è¿™æ˜¯å®ƒä¸SGXç›¸æ¯”æœ€æœ¬è´¨çš„å·®å¼‚ï¼Œä¹Ÿæ˜¯å…¶ç†è®ºä¸Šçš„ä¸»è¦å¼±ç‚¹ã€‚</p><p><strong>è½¯ä»¶ä½œä¸ºä¿¡ä»»æ ¹çš„å›ºæœ‰é£é™©</strong>ï¼š</p><ul><li><strong>æ ¸å¿ƒå¼±ç‚¹</strong>ï¼šHyperEnclaveçš„ä¿¡ä»»æ ¹æ˜¯<code>RustMonitor</code>è¿™ä¸ª<strong>è½¯ä»¶</strong>ã€‚å°½ç®¡å®ƒä»£ç é‡å°ä¸”ç”¨Rustç¼–å†™ï¼Œä½†â€æ˜¯è½¯ä»¶å°±å¯èƒ½æœ‰bugâ€æ˜¯æ— æ³•æ”¹å˜çš„çœŸç†ã€‚ä¸€ä¸ªæœªçŸ¥çš„ã€é«˜æ˜çš„é€»è¾‘æ¼æ´ï¼ˆéå†…å­˜å®‰å…¨ç±»å‹ï¼‰å¯èƒ½ä¾ç„¶å­˜åœ¨ï¼Œä¸€æ—¦è¢«åˆ©ç”¨ï¼Œæ•´ä¸ªç³»ç»Ÿå°±ä¼šå´©æºƒ</li><li><strong>å¯¹æ¯”SGX</strong>ï¼šSGXçš„ä¿¡ä»»æ ¹æ˜¯<strong>ç¡¬ä»¶</strong>å’Œ<strong>å¾®ç </strong>ã€‚è™½ç„¶ç¡¬ä»¶ä¹Ÿå¯èƒ½æœ‰bugï¼ˆå¦‚Plundervoltï¼‰ï¼Œä½†åˆ©ç”¨éš¾åº¦å’Œå‘ç°éš¾åº¦é€šå¸¸è¿œé«˜äºè½¯ä»¶</li></ul><p><strong>TPMçš„è„†å¼±æ€§</strong>ï¼š</p><ul><li>HyperEnclaveå¼ºä¾èµ–TPMè¿›è¡Œåº¦é‡å’Œè¯æ˜ã€‚å¦‚æœTPMæœ¬èº«å­˜åœ¨æ¼æ´ï¼ˆæ— è®ºæ˜¯å›ºä»¶fTPMè¿˜æ˜¯ç‹¬ç«‹çš„dTPMï¼‰ï¼Œæˆ–è€…ç‰©ç†æ”»å‡»è€…èƒ½å¤Ÿç¯¡æ”¹CPUä¸TPMä¹‹é—´çš„é€šä¿¡æ€»çº¿ï¼ˆå¦‚SPIæ€»çº¿ï¼‰ï¼Œé‚£ä¹ˆè¿œç¨‹è¯æ˜çš„æ ¹åŸºå°±ä¼šåŠ¨æ‘‡</li></ul><p><strong>å¯åŠ¨é“¾çš„å®Œæ•´æ€§ä¾èµ–</strong>ï¼š</p><ul><li>â€œåº¦é‡å»¶è¿Ÿå¯åŠ¨â€ä¾èµ–äºä¸€ä¸ªå¯ä¿¡çš„æ—©æœŸå¯åŠ¨ç¯å¢ƒï¼ˆBIOS&#x2F;UEFI, Bootloader, OS Kernel early stageï¼‰ã€‚å¦‚æœè¿™æ¡é“¾çš„å‰åŠéƒ¨åˆ†åœ¨<strong>åº¦é‡å®Œæˆä¹‹åã€RustMonitorå¯åŠ¨ä¹‹å‰</strong>çš„ç¬é—´è¢«ä¸€ç§é«˜è¶…çš„ã€ç¬æ—¶æ”»å‡»ï¼ˆTime-of-Check to Time-of-Use, TOCTOUï¼‰æ‰€ç¯¡æ”¹ï¼Œç†è®ºä¸Šå­˜åœ¨é£é™©</li></ul><h3 id="2-æ¶æ„è®¾è®¡ä¸å®ç°å±‚é¢çš„é£é™©"><a href="#2-æ¶æ„è®¾è®¡ä¸å®ç°å±‚é¢çš„é£é™©" class="headerlink" title="2. æ¶æ„è®¾è®¡ä¸å®ç°å±‚é¢çš„é£é™©"></a>2. æ¶æ„è®¾è®¡ä¸å®ç°å±‚é¢çš„é£é™©</h3><p><strong>I&#x2F;Oæ¨¡å‹å¸¦æ¥çš„å¤æ‚æ€§</strong>ï¼š</p><ul><li>HyperEnclaveå°†æ‰€æœ‰è®¾å¤‡é©±åŠ¨éƒ½æ”¾åœ¨äº†éå¯ä¿¡çš„ä¸»æ“ä½œç³»ç»Ÿä¸­ï¼Œè¿™è™½ç„¶å‡å°äº†<code>RustMonitor</code>çš„TCBï¼Œä½†ä¹Ÿæ„å‘³ç€<strong>æ‰€æœ‰I&#x2F;Oæ“ä½œéƒ½å¿…é¡»ç»è¿‡ä¸€æ¬¡æ˜‚è´µçš„world switch</strong>ï¼ˆEnclave -&gt; <code>RustMonitor</code> -&gt; ä¸»OS -&gt; <code>RustMonitor</code> -&gt; Enclaveï¼‰</li><li>ä¸ºäº†ä¼˜åŒ–æ€§èƒ½ï¼Œæ•°æ®äº¤æ¢ä¾èµ–ä¸€ä¸ªå…±äº«çš„<strong>ç¼–ç»„ç¼“å†²åŒºï¼ˆMarshalling Bufferï¼‰</strong>ã€‚è¿™ä¸ªå…±äº«å†…å­˜åŒºåŸŸæ˜¯Enclaveå’Œéå¯ä¿¡OSä¹‹é—´çš„ä¸€ä¸ª<strong>æ˜ç¡®çš„ã€å¿…é¡»è¢«å°å¿ƒå¤„ç†çš„æ”»å‡»é¢</strong></li><li>å¦‚æœEnclaveåº”ç”¨å¼€å‘è€…æ²¡æœ‰å¯¹æ¥è‡ªè¿™ä¸ªç¼“å†²åŒºçš„æ•°æ®åšä¸¥æ ¼çš„æ ¡éªŒï¼ˆä¾‹å¦‚ï¼Œæ£€æŸ¥æ•°æ®é•¿åº¦ã€æ ¼å¼ã€å†…å®¹ï¼‰ï¼Œå°±å¯èƒ½è¢«æ¶æ„çš„ä¸»OSæ¬ºéª—ï¼Œå¯¼è‡´Enclaveå†…éƒ¨é€»è¾‘é”™è¯¯ã€ä¿¡æ¯æ³„éœ²ç”šè‡³å´©æºƒ</li></ul><p><strong>æ¨¡æ‹ŸSGXæŒ‡ä»¤é›†çš„å¤æ‚æ€§</strong>ï¼š</p><ul><li>HyperEnclaveä¸ºäº†å…¼å®¹SGXç”Ÿæ€ï¼Œéœ€è¦ç”¨è½¯ä»¶å»æ¨¡æ‹Ÿä¸€ç³»åˆ—å¤æ‚çš„SGXæŒ‡ä»¤ï¼ˆå¦‚ECREATE, EADD, EINITç­‰ï¼‰ã€‚å¦‚æœæ¨¡æ‹Ÿçš„é€»è¾‘ä¸çœŸå®SGXç¡¬ä»¶çš„è¡Œä¸ºæœ‰ä»»ä½•ç»†å¾®çš„åå·®ï¼Œå°±å¯èƒ½äº§ç”Ÿæ–°çš„ã€éé¢„æœŸçš„æ¼æ´</li></ul><p><strong>çµæ´»æ“ä½œæ¨¡å¼å¸¦æ¥çš„é£é™©</strong>ï¼š</p><ul><li>P-Enclaveå’ŒHU-Enclaveæ¨¡å¼è™½ç„¶æå‡äº†æ€§èƒ½ï¼Œä½†ä¹Ÿ<strong>å¢å¤§äº†æ”»å‡»é¢</strong></li><li><strong>P-Enclave</strong>å¯ä»¥åœ¨Enclaveå†…éƒ¨å¤„ç†éƒ¨åˆ†ä¸­æ–­å’Œé¡µè¡¨ï¼Œè¿™æ„å‘³ç€å¦‚æœEnclaveè‡ªèº«ä»£ç æœ‰æ¼æ´ï¼Œå®ƒå¯èƒ½é€ æˆçš„ç ´åæ¯”æ™®é€šçš„ç”¨æˆ·æ€Enclaveæ›´å¤§</li><li><strong>HU-Enclave</strong>è¿è¡Œåœ¨Host User Modeï¼Œç¦»<code>RustMonitor</code>çš„Host Kernel Modeï¼ˆRing 0ï¼‰åªæœ‰ä¸€æ­¥ä¹‹é¥ã€‚è™½ç„¶æœ‰ç¡¬ä»¶éš”ç¦»ï¼Œä½†ç›¸æ¯”äºåœ¨éš”ç¦»çš„Guest VMä¸­è¿è¡Œï¼Œå…¶æ½œåœ¨çš„æ”»å‡»è·¯å¾„æ›´å¤š</li></ul><h3 id="3-ç”Ÿæ€ä¸è¿ç»´å±‚é¢çš„é£é™©"><a href="#3-ç”Ÿæ€ä¸è¿ç»´å±‚é¢çš„é£é™©" class="headerlink" title="3. ç”Ÿæ€ä¸è¿ç»´å±‚é¢çš„é£é™©"></a>3. ç”Ÿæ€ä¸è¿ç»´å±‚é¢çš„é£é™©</h3><p><strong>ç”Ÿæ€ç³»ç»Ÿä¸æˆç†Ÿ</strong>ï¼š</p><ul><li>ä½œä¸ºä¸€ä¸ªè¾ƒæ–°çš„é¡¹ç›®ï¼Œå¯èƒ½ç¼ºä¹ç»è¿‡å¤§è§„æ¨¡ã€é•¿æ—¶é—´ã€å¤šæ ·åŒ–ç”Ÿäº§ç¯å¢ƒæ£€éªŒçš„â€æœ€ä½³å®è·µâ€ã€‚ç”¨æˆ·åœ¨é…ç½®ã€éƒ¨ç½²æ—¶å¯èƒ½ä¼šå› ä¸ºä¸ç†Ÿæ‚‰è€Œå¼•å…¥å®‰å…¨é£é™©</li><li>ç›¸å…³çš„å®‰å…¨åˆ†æå·¥å…·ã€æ¼æ´æ‰«æå™¨ã€è°ƒè¯•å™¨ç­‰ç”Ÿæ€æ”¯æŒå¯èƒ½ä¸å¦‚SGXå®Œå–„ï¼Œå¯¼è‡´å¼€å‘è€…éš¾ä»¥å‘ç°å’Œä¿®å¤è‡ªå·±åº”ç”¨ä¸­çš„å®‰å…¨é—®é¢˜</li></ul><p><strong>é…ç½®é”™è¯¯é£é™©</strong>ï¼š</p><ul><li>HyperEnclaveçš„çµæ´»æ€§æ˜¯ä¸€æŠŠåŒåˆƒå‰‘ã€‚é”™è¯¯çš„é…ç½®ï¼ˆä¾‹å¦‚ï¼Œä¸æ°å½“åœ°è®¾ç½®å†…å­˜ã€æƒé™ï¼Œæˆ–è€…åœ¨é”™è¯¯åœºæ™¯ä¸‹ä½¿ç”¨äº†é”™è¯¯çš„Enclaveæ¨¡å¼ï¼‰å¯èƒ½ä¼šå¯¼è‡´å®‰å…¨ç­‰çº§ä¸‹é™</li></ul><h3 id="4-ä¸åŒæ“ä½œæ¨¡å¼çš„æ”»å‡»é¢å·®å¼‚"><a href="#4-ä¸åŒæ“ä½œæ¨¡å¼çš„æ”»å‡»é¢å·®å¼‚" class="headerlink" title="4. ä¸åŒæ“ä½œæ¨¡å¼çš„æ”»å‡»é¢å·®å¼‚"></a>4. ä¸åŒæ“ä½œæ¨¡å¼çš„æ”»å‡»é¢å·®å¼‚</h3><p>HyperEnclaveæ”¯æŒçš„ä¸‰ç§æ“ä½œæ¨¡å¼åœ¨æä¾›æ€§èƒ½ä¼˜åŒ–çš„åŒæ—¶ï¼Œä¹Ÿå¸¦æ¥äº†ä¸åŒçš„å®‰å…¨è€ƒé‡ï¼š</p><p><strong>GU-Enclaveï¼ˆå®¢æˆ·æœºç”¨æˆ·æ¨¡å¼ï¼‰</strong>ï¼š</p><ul><li>æ”»å‡»é¢æœ€å°ï¼Œæä¾›ä¸SGXç±»ä¼¼çš„å®‰å…¨çº§åˆ«</li><li>æ‰€æœ‰ç‰¹æƒæ“ä½œéƒ½éœ€è¦é€šè¿‡RustMonitorï¼Œå¢åŠ äº†å®‰å…¨æ£€æŸ¥å±‚æ¬¡</li><li>é€‚ç”¨äºå¯¹å®‰å…¨æ€§è¦æ±‚æœ€é«˜çš„åœºæ™¯</li></ul><p><strong>HU-Enclaveï¼ˆä¸»æœºç”¨æˆ·æ¨¡å¼ï¼‰</strong>ï¼š</p><ul><li>è¿è¡Œåœ¨ä¸»æœºç”¨æˆ·æ€ï¼Œç¦»ä¸»æœºå†…æ ¸æ¨¡å¼æ›´è¿‘</li><li>è™½ç„¶ä»æœ‰ç¡¬ä»¶éš”ç¦»ä¿æŠ¤ï¼Œä½†æ½œåœ¨æ”»å‡»è·¯å¾„ç›¸å¯¹æ›´å¤š</li><li>å¯¹RustMonitorçš„ç³»ç»Ÿè°ƒç”¨æ¥å£å¥å£®æ€§è¦æ±‚æ›´é«˜</li><li>åœ¨æ€§èƒ½å’Œå®‰å…¨æ€§é—´æä¾›äº†å¹³è¡¡</li></ul><p><strong>P-Enclaveï¼ˆç‰¹æƒæ¨¡å¼ï¼‰</strong>ï¼š</p><ul><li>æ”»å‡»é¢ç›¸å¯¹æœ€å¤§ï¼Œå› ä¸ºå¯ä»¥è®¿é—®ç‰¹æƒèµ„æº</li><li>å¦‚æœEnclaveä»£ç å­˜åœ¨æ¼æ´ï¼Œå¯èƒ½é€ æˆçš„ç ´åæ¯”ç”¨æˆ·æ€Enclaveæ›´å¤§</li><li>å¯èƒ½ä½¿æ¶æ„Enclaveæ›´å®¹æ˜“å‡çº§åˆ°ä¸»æœºRing-0æƒé™</li><li>éœ€è¦æ›´ä¸¥æ ¼çš„ä»£ç å®¡æŸ¥å’Œå®‰å…¨æµ‹è¯•</li></ul><p><strong>é£é™©ç¼“è§£æªæ–½</strong>ï¼š</p><ul><li>é€šè¿‡ç™½åå•æœºåˆ¶ä¸¥æ ¼æ§åˆ¶P-Enclaveå¯å¤„ç†çš„å¼‚å¸¸ç±»å‹</li><li>RustMonitorå¯¹æ‰€æœ‰æ¨¡å¼éƒ½ä¿æŒç»Ÿä¸€çš„å†…å­˜éš”ç¦»ç­–ç•¥</li><li>ä¸åŒæ¨¡å¼é—´çš„åˆ‡æ¢ç”±RustMonitorä¸¥æ ¼æ§åˆ¶å’ŒéªŒè¯</li><li>å»ºè®®æ ¹æ®åº”ç”¨çš„å®‰å…¨éœ€æ±‚é€‰æ‹©åˆé€‚çš„æ“ä½œæ¨¡å¼</li></ul><h2 id="HyperEnclaveæ¶æ„è®¾è®¡ä¸å®ç°"><a href="#HyperEnclaveæ¶æ„è®¾è®¡ä¸å®ç°" class="headerlink" title="HyperEnclaveæ¶æ„è®¾è®¡ä¸å®ç°"></a>HyperEnclaveæ¶æ„è®¾è®¡ä¸å®ç°</h2><h3 id="æ•´ä½“æ¶æ„æ¦‚è§ˆ"><a href="#æ•´ä½“æ¶æ„æ¦‚è§ˆ" class="headerlink" title="æ•´ä½“æ¶æ„æ¦‚è§ˆ"></a>æ•´ä½“æ¶æ„æ¦‚è§ˆ</h3><p>HyperEnclaveçš„æ¶æ„ä½“ç°äº†ä¸€ä¸ªåˆ†å±‚ã€æ¨¡å—åŒ–çš„è®¾è®¡æ€è·¯ï¼Œä»ç¡¬ä»¶å±‚åˆ°åº”ç”¨å±‚å½¢æˆäº†ä¸€ä¸ªå®Œæ•´çš„æœºå¯†è®¡ç®—æ ˆã€‚</p><p><strong>ç¡¬ä»¶å±‚</strong>ï¼š</p><ul><li>CPUï¼ˆè™šæ‹ŸåŒ–æ‰©å±•VT-x &#x2F; AMD-Vï¼‰</li><li>TPM 2.0ï¼ˆå¯ä¿¡å¹³å°æ¨¡å—ï¼‰</li><li>ç‰©ç†å†…å­˜ï¼ˆRAMï¼‰</li><li>IOMMUï¼ˆè¾“å…¥è¾“å‡ºå†…å­˜ç®¡ç†å•å…ƒï¼‰</li><li>I&#x2F;Oè®¾å¤‡</li></ul><p><strong>ç‰¹æƒè½¯ä»¶å±‚ï¼ˆç›‘æ§ä¸–ç•Œ &#x2F; VMX Rootæ¨¡å¼ï¼‰</strong>ï¼š</p><ul><li>RustMonitorï¼ˆåŸºäºRustçš„è½»é‡çº§Hypervisorï¼‰</li><li>å†…å­˜ç®¡ç†å™¨ï¼ˆç®¡ç†å®‰å…¨å†…å­˜æ± ï¼‰</li><li>Enclaveç”Ÿå‘½å‘¨æœŸç®¡ç†å™¨ï¼ˆåˆ›å»ºã€è¿›å…¥ã€é€€å‡ºã€é”€æ¯ï¼‰</li><li>äºŒçº§é¡µè¡¨ç®¡ç†å™¨ï¼ˆEPT&#x2F;NPTï¼Œæ§åˆ¶å†…å­˜è§†å›¾ï¼‰</li><li>è¿œç¨‹è¯æ˜ç®¡ç†å™¨ï¼ˆä¸TPMäº¤äº’ï¼‰</li><li>Hypercallæ¥å£ï¼ˆå®‰å…¨ç½‘å…³ï¼‰</li></ul><p><strong>éç‰¹æƒè½¯ä»¶å±‚ï¼ˆæ™®é€šä¸–ç•Œ &#x2F; VMX Non-Rootæ¨¡å¼ï¼‰</strong>ï¼š</p><ul><li>å®¢æˆ·æœºè™šæ‹Ÿæœºï¼ˆGuest VMï¼‰<ul><li>ç”¨æˆ·ç©ºé—´ï¼ˆRing 3ï¼‰ï¼šéå¯ä¿¡åº”ç”¨é€»è¾‘ã€HyperEnclave SDKï¼ˆuRTSï¼‰ã€ç¼–ç»„ç¼“å†²åŒº</li><li>å†…æ ¸ç©ºé—´ï¼ˆRing 0ï¼‰ï¼šä¸»æ“ä½œç³»ç»Ÿã€è®¾å¤‡é©±åŠ¨ç¨‹åºã€HyperEnclaveå†…æ ¸æ¨¡å—</li></ul></li><li>å®‰å…¨ä¸–ç•Œï¼šEnclaveï¼ˆåœ¨ä¸“ç”¨çš„vCPUä¸Šä¸‹æ–‡ä¸­è¿è¡Œï¼‰<ul><li>å¯ä¿¡åº”ç”¨é€»è¾‘</li><li>HyperEnclave SDKï¼ˆtRTSï¼‰</li><li>ç¼–ç»„ç¼“å†²åŒºçš„è§†å›¾</li></ul></li></ul><h3 id="å…³é”®æ•°æ®æµä¸æ§åˆ¶æµ"><a href="#å…³é”®æ•°æ®æµä¸æ§åˆ¶æµ" class="headerlink" title="å…³é”®æ•°æ®æµä¸æ§åˆ¶æµ"></a>å…³é”®æ•°æ®æµä¸æ§åˆ¶æµ</h3><p><strong>æ§åˆ¶æµ</strong>ï¼š</p><ol><li>åº”ç”¨ç¨‹åºè°ƒç”¨HyperEnclave SDK</li><li>SDKé€šè¿‡ioctlç³»ç»Ÿè°ƒç”¨è¯·æ±‚å†…æ ¸æ¨¡å—</li><li>å†…æ ¸æ¨¡å—æ‰§è¡ŒVMCALLæŒ‡ä»¤</li><li>CPUè§¦å‘VM-Exitï¼Œæ§åˆ¶æƒè½¬ç§»ç»™RustMonitor</li><li>RustMonitorè¿›è¡Œå®‰å…¨æ£€æŸ¥å’Œä¸Šä¸‹æ–‡åˆ‡æ¢</li><li>æ‰§è¡ŒVM-Entryï¼Œè¿›å…¥Enclaveæ‰§è¡Œ</li></ol><p><strong>å†…å­˜éš”ç¦»</strong>ï¼š</p><ul><li>RustMonitorçš„EPT&#x2F;NPTç®¡ç†å™¨ä¸ºGuest VMå’ŒEnclaveåˆ†åˆ«è®¾ç½®ä¸åŒçš„â€é€šè¡Œè§„åˆ™â€</li><li>ç¡®ä¿å®ƒä»¬åœ¨å†…å­˜ä¸Šæ°¸ä¸ç›¸äº¤ï¼ˆé™¤äº†æŒ‡å®šçš„å…±äº«åŒºï¼‰</li><li>ç¡¬ä»¶å¼ºåˆ¶æ‰§è¡Œå†…å­˜è®¿é—®æ§åˆ¶</li></ul><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>HyperEnclaveä»£è¡¨äº†æœºå¯†è®¡ç®—æŠ€æœ¯å‘å±•çš„ä¸€ä¸ªé‡è¦æ–¹å‘ï¼Œå®ƒé€šè¿‡è½¯ä»¶å®šä¹‰çš„æ–¹å¼ï¼Œåœ¨é€šç”¨ç¡¬ä»¶ä¸Šæ„å»ºäº†ä¸€å¥—å®Œæ•´çš„å¯ä¿¡æ‰§è¡Œç¯å¢ƒã€‚å…¶æ ¸å¿ƒè´¡çŒ®åœ¨äºï¼š</p><ol><li><strong>æŠ€æœ¯åˆ›æ–°</strong>ï¼šé€šè¿‡â€åº¦é‡å»¶è¿Ÿå¯åŠ¨â€å’Œç¡¬ä»¶è™šæ‹ŸåŒ–æŠ€æœ¯çš„å·§å¦™ç»“åˆï¼Œå®ç°äº†è·¨å¹³å°çš„æœºå¯†è®¡ç®—èƒ½åŠ›</li><li><strong>æˆæœ¬æ•ˆç›Š</strong>ï¼šå¤§å¹…é™ä½äº†æœºå¯†è®¡ç®—çš„ç¡¬ä»¶é—¨æ§›å’Œéƒ¨ç½²æˆæœ¬</li><li><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼šæä¾›äº†å¤šç§æ“ä½œæ¨¡å¼ï¼Œèƒ½å¤Ÿé’ˆå¯¹ä¸åŒå·¥ä½œè´Ÿè½½è¿›è¡Œæ€§èƒ½ä¼˜åŒ–</li><li><strong>å¼€æ”¾é€æ˜</strong>ï¼šæ ¸å¿ƒç»„ä»¶å¼€æºï¼Œæ”¯æŒå®‰å…¨å®¡è®¡å’ŒæŠ€æœ¯éªŒè¯</li></ol><p>ç„¶è€Œï¼ŒHyperEnclaveä¹Ÿé¢ä¸´ç€ä¸€äº›æŒ‘æˆ˜ï¼š</p><ol><li><strong>ä¿¡ä»»æ¨¡å‹</strong>ï¼šåŸºäºè½¯ä»¶çš„ä¿¡ä»»æ ¹ç›¸æ¯”çº¯ç¡¬ä»¶æ–¹æ¡ˆåœ¨ç†è®ºå®‰å…¨æ€§ä¸Šå­˜åœ¨å·®è·</li><li><strong>ç”Ÿæ€æˆç†Ÿåº¦</strong>ï¼šä½œä¸ºç›¸å¯¹è¾ƒæ–°çš„æŠ€æœ¯ï¼Œå…¶ç”Ÿæ€ç³»ç»Ÿå’Œæœ€ä½³å®è·µä»åœ¨å‘å±•ä¸­</li><li><strong>å¤æ‚æ€§ç®¡ç†</strong>ï¼šçµæ´»çš„æ¶æ„è®¾è®¡å¸¦æ¥äº†æ›´é«˜çš„é…ç½®å’Œä½¿ç”¨å¤æ‚æ€§</li></ol><p>æ€»çš„æ¥è¯´ï¼ŒHyperEnclaveä¸Intel SGXç­‰æ–¹æ¡ˆå½¢æˆäº†äº’è¡¥å…³ç³»ï¼Œä¸ºä¸åŒåœºæ™¯ä¸‹çš„æœºå¯†è®¡ç®—éœ€æ±‚æä¾›äº†æ›´å¤šé€‰æ‹©ã€‚é€‰æ‹©å“ªç§æ–¹æ¡ˆéœ€è¦æ ¹æ®å…·ä½“çš„å®‰å…¨è¦æ±‚ã€æ€§èƒ½éœ€æ±‚ã€æˆæœ¬é¢„ç®—å’Œç¡¬ä»¶ç¯å¢ƒæ¥ç»¼åˆè€ƒè™‘ã€‚</p><p>éšç€æœºå¯†è®¡ç®—æŠ€æœ¯çš„ä¸æ–­å‘å±•ï¼Œæˆ‘ä»¬å¯ä»¥é¢„æœŸè¿™äº›æŠ€æœ¯å°†åœ¨äº‘è®¡ç®—ã€è¾¹ç¼˜è®¡ç®—ã€äººå·¥æ™ºèƒ½ç­‰å¤šä¸ªé¢†åŸŸå‘æŒ¥è¶Šæ¥è¶Šé‡è¦çš„ä½œç”¨ï¼Œä¸ºæ•°æ®å®‰å…¨å’Œéšç§ä¿æŠ¤æä¾›æ›´å¼ºæœ‰åŠ›çš„æŠ€æœ¯ä¿éšœã€‚ </p>]]></content>
      
      
      <categories>
          
          <category> éšç§è®¡ç®— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HyperEnclave </tag>
            
            <tag> TEE </tag>
            
            <tag> è™šæ‹ŸåŒ– </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HyperEnclaveï¼šä¸€ä¸ªå¼€æ”¾ä¸”è·¨å¹³å°çš„å¯ä¿¡æ‰§è¡Œç¯å¢ƒ</title>
      <link href="/2025/07/19/HyperEnclave%EF%BC%9A%E4%B8%80%E4%B8%AA%E5%BC%80%E6%94%BE%E4%B8%94%E8%B7%A8%E5%B9%B3%E5%8F%B0%E7%9A%84%E5%8F%AF%E4%BF%A1%E6%89%A7%E8%A1%8C%E7%8E%AF%E5%A2%83/"/>
      <url>/2025/07/19/HyperEnclave%EF%BC%9A%E4%B8%80%E4%B8%AA%E5%BC%80%E6%94%BE%E4%B8%94%E8%B7%A8%E5%B9%B3%E5%8F%B0%E7%9A%84%E5%8F%AF%E4%BF%A1%E6%89%A7%E8%A1%8C%E7%8E%AF%E5%A2%83/</url>
      
        <content type="html"><![CDATA[<h1 id="HyperEnclaveï¼šä¸€ä¸ªå¼€æ”¾ä¸”è·¨å¹³å°çš„å¯ä¿¡æ‰§è¡Œç¯å¢ƒ"><a href="#HyperEnclaveï¼šä¸€ä¸ªå¼€æ”¾ä¸”è·¨å¹³å°çš„å¯ä¿¡æ‰§è¡Œç¯å¢ƒ" class="headerlink" title="HyperEnclaveï¼šä¸€ä¸ªå¼€æ”¾ä¸”è·¨å¹³å°çš„å¯ä¿¡æ‰§è¡Œç¯å¢ƒ"></a>HyperEnclaveï¼šä¸€ä¸ªå¼€æ”¾ä¸”è·¨å¹³å°çš„å¯ä¿¡æ‰§è¡Œç¯å¢ƒ</h1><blockquote><p>æœ¬æ–‡æ˜¯è®ºæ–‡ã€ŠHyperEnclave: An Open and Cross-platform Trusted Execution Environmentã€‹çš„åŸæ–‡ç¿»è¯‘</p></blockquote><h2 id="æ‘˜è¦"><a href="#æ‘˜è¦" class="headerlink" title="æ‘˜è¦"></a>æ‘˜è¦</h2><p>å­¦æœ¯ç•Œå’Œå·¥ä¸šç•Œå·²ç»æå‡ºäº†è®¸å¤šå¯ä¿¡æ‰§è¡Œç¯å¢ƒï¼ˆTEEï¼‰ã€‚ç„¶è€Œï¼Œå®ƒä»¬ä¸­çš„å¤§å¤šæ•°éƒ½éœ€è¦ç‰¹å®šçš„ç¡¬ä»¶æˆ–å›ºä»¶æ›´æ”¹ï¼Œå¹¶ä¸”ä¸ç‰¹å®šçš„ç¡¬ä»¶ä¾›åº”å•†ï¼ˆå¦‚è‹±ç‰¹å°”ã€AMDã€ARM å’Œ IBMï¼‰ç»‘å®šã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬æå‡ºäº† HyperEnclaveï¼Œè¿™æ˜¯ä¸€ä¸ªå¼€æ”¾ä¸”è·¨å¹³å°çš„ã€åŸºäºè¿›ç¨‹çš„ TEEï¼Œå®ƒä¾èµ–äºå¹¿æ³›å¯ç”¨çš„è™šæ‹ŸåŒ–æ‰©å±•æ¥åˆ›å»ºéš”ç¦»çš„æ‰§è¡Œç¯å¢ƒã€‚ç‰¹åˆ«æ˜¯ï¼ŒHyperEnclave æ—¨åœ¨æ”¯æŒçµæ´»çš„ enclave æ“ä½œæ¨¡å¼ï¼Œä»¥æ»¡è¶³å„ç§ enclave å·¥ä½œè´Ÿè½½ä¸‹çš„å®‰å…¨å’Œæ€§èƒ½éœ€æ±‚ã€‚æˆ‘ä»¬æä¾›äº† enclave SDKï¼Œä»¥ä¾¿åœ¨ HyperEnclave ä¸Šè¿è¡Œç°æœ‰çš„ SGX ç¨‹åºï¼Œåªéœ€å¾ˆå°‘æˆ–æ— éœ€æ›´æ”¹æºä»£ç ã€‚æˆ‘ä»¬å·²åœ¨å•†ç”¨ AMD æœåŠ¡å™¨ä¸Šå®ç°äº† HyperEnclaveï¼Œå¹¶å°†è¯¥ç³»ç»Ÿéƒ¨ç½²åœ¨ä¸€å®¶ä¸–ç•Œé¢†å…ˆçš„é‡‘èç§‘æŠ€å…¬å¸ï¼Œä»¥æ”¯æŒçœŸå®çš„éšç§ä¿æŠ¤è®¡ç®—ã€‚åœ¨å¾®åŸºå‡†æµ‹è¯•å’Œåº”ç”¨åŸºå‡†æµ‹è¯•ä¸Šçš„è¯„ä¼°è¡¨æ˜ï¼ŒHyperEnclave çš„è®¾è®¡åªå¼•å…¥äº†å¾ˆå°çš„å¼€é”€ã€‚</p><h2 id="1-å¼•è¨€"><a href="#1-å¼•è¨€" class="headerlink" title="1 å¼•è¨€"></a>1 å¼•è¨€</h2><p>è¿‘å¹´æ¥ï¼Œç”±äºå¯¹èƒ½å¤Ÿå¤„ç†æµ·é‡æ•°æ®æ ·æœ¬çš„éšç§ä¿æŠ¤æ•°æ®å¤„ç†æŠ€æœ¯çš„é«˜éœ€æ±‚ï¼Œå¯ä¿¡æ‰§è¡Œç¯å¢ƒï¼ˆTEEï¼‰æ­£ä½œä¸ºä¸€ç§æ–°çš„è®¡ç®—èŒƒå¼â€”â€”æœºå¯†è®¡ç®—â€”â€”è€Œå…´èµ·ã€‚TEE æä¾›äº†ç¡¬ä»¶å¼ºåˆ¶çš„å†…å­˜åˆ†åŒºï¼Œæ•æ„Ÿæ•°æ®å¯ä»¥åœ¨å…¶ä¸­è¢«å®‰å…¨åœ°å¤„ç†ã€‚ç°æœ‰çš„ TEE è®¾è®¡æ”¯æŒä¸åŒçº§åˆ«çš„ TEE æŠ½è±¡ï¼Œä¾‹å¦‚åŸºäºè¿›ç¨‹çš„ï¼ˆè‹±ç‰¹å°”çš„è½¯ä»¶é˜²æŠ¤æ‰©å±•ï¼ˆSGXï¼‰[55]ï¼‰ã€åŸºäºè™šæ‹Ÿæœºçš„ï¼ˆAMD SEV [45]ï¼‰ã€åˆ†ç¦»çš„ä¸–ç•Œï¼ˆARM TrustZone [16]ï¼‰ä»¥åŠæ··åˆæ¨¡å¼ï¼ˆKeystone [49]ï¼‰ã€‚ç›®å‰ï¼ŒTEE æœ€çªå‡ºçš„ä¾‹å­æ˜¯è‹±ç‰¹å°” SGXï¼Œå®ƒåœ¨å•†ç”¨ç°æˆå“ï¼ˆCOTSï¼‰å°å¼æœºå’ŒæœåŠ¡å™¨å¤„ç†å™¨ä¸­å¹¿æ³›å¯ç”¨ã€‚</p><p><strong>åŠ¨æœºã€‚</strong> å½“ä»Šå¤§å¤šæ•° TEE æŠ€æœ¯éƒ½æ˜¯é—­æºçš„ï¼Œå¹¶ä¸”éœ€è¦ç‰¹å®šçš„ç¡¬ä»¶æˆ–å›ºä»¶æ›´æ”¹ï¼Œè¿™äº›æ›´æ”¹éš¾ä»¥å®¡è®¡ã€æ¼”è¿›ç¼“æ…¢ï¼Œå› æ­¤ä¸å¦‚åŸºäºå…¬å¼€ç®—æ³•å’Œå¹¿æ³›å¯ç”¨ç¡¬ä»¶çš„å¯†ç å­¦æ›¿ä»£æ–¹æ¡ˆï¼ˆå¦‚åŒæ€åŠ å¯†ï¼‰ã€‚æ­¤å¤–ï¼Œå¤§å¤šæ•°ç°æœ‰çš„ TEE è®¾è®¡é™åˆ¶äº† enclaveï¼ˆå³å—ä¿æŠ¤çš„ TEE åŒºåŸŸï¼‰åªèƒ½åœ¨å›ºå®šæ¨¡å¼ä¸‹è¿è¡Œã€‚è¿™å¾ˆéš¾æ»¡è¶³éœ€è¦ç”± TEE ä¿æŠ¤çš„å„ç§ç±»å‹åº”ç”¨çš„å®‰å…¨å’Œæ€§èƒ½è¦æ±‚ã€‚ä¾‹å¦‚ï¼Œè‹±ç‰¹å°” SGX enclave åœ¨ç”¨æˆ·æ¨¡å¼ä¸‹è¿è¡Œï¼Œæ— æ³•è®¿é—®ç‰¹æƒèµ„æºï¼ˆå¦‚æ–‡ä»¶ç³»ç»Ÿã€IDT å’Œé¡µè¡¨ï¼‰å’Œå¤„ç†ç‰¹æƒäº‹ä»¶ï¼ˆä¸­æ–­å’Œå¼‚å¸¸ï¼‰ã€‚å› æ­¤ï¼Œè¿è¡Œ I&#x2F;O å¯†é›†å‹å’Œå†…å­˜è¦æ±‚é«˜çš„ä»»åŠ¡ä¼šå¯¼è‡´æ˜¾è‘—çš„æ€§èƒ½ä¸‹é™ã€‚</p><p>ä¸ºäº†å¡«è¡¥è¿™ä¸€ç©ºç™½ï¼Œæˆ‘ä»¬åœ¨æœ¬æ–‡ä¸­æå‡ºäº† HyperEnclave çš„è®¾è®¡ï¼Œä»¥æ”¯æŒæœºå¯†äº‘è®¡ç®—ï¼Œå®ƒå¯ä»¥åœ¨äº‘ä¸­ç°æˆçš„ä¼ ç»ŸæœåŠ¡å™¨ä¸Šå®‰å…¨è¿è¡Œï¼Œä¹Ÿå¯ä»¥åœ¨æ–°å…´çš„ ARMï¼ˆæˆ–æœªæ¥çš„ RISC-Vï¼‰æœåŠ¡å™¨ä¸Šè¿è¡Œï¼Œè€Œæ— éœ€ç‰¹å®šçš„ç¡¬ä»¶åŠŸèƒ½ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬çš„è®¾è®¡ä½¿ç”¨å¹¿æ³›å¯ç”¨çš„è™šæ‹ŸåŒ–æ‰©å±•ï¼ˆç”¨äºéš”ç¦»ï¼‰å’Œ TPMï¼ˆç”¨äºä¿¡ä»»æ ¹å’Œéšæœºæ€§ç­‰ï¼‰æä¾›äº†ä¸€ä¸ªåŸºäºè¿›ç¨‹çš„ TEE æŠ½è±¡ã€‚ä¸ºäº†æ›´å¥½åœ°æ»¡è¶³ç‰¹å®š enclave å·¥ä½œè´Ÿè½½çš„éœ€æ±‚ï¼ŒHyperEnclave æ”¯æŒçµæ´»çš„ enclave æ“ä½œæ¨¡å¼ï¼Œå³ enclave å¯ä»¥åœ¨ä¸åŒçš„ç‰¹æƒçº§åˆ«è¿è¡Œï¼Œå¹¶ä¸”å¯ä»¥è®¿é—®æŸäº›ç‰¹æƒèµ„æºï¼ˆè¯¦è§ç¬¬ 4 èŠ‚ï¼‰ã€‚</p><p><strong>è®¾è®¡ç»†èŠ‚ã€‚</strong> åœ¨æˆ‘ä»¬çš„è®¾è®¡ä¸­ï¼Œç³»ç»Ÿä»¥ä¸‰ç§æ¨¡å¼è¿è¡Œã€‚ä¸€ä¸ªåä¸º RustMonitor çš„å¯ä¿¡è½¯ä»¶å±‚ï¼ˆç”¨ Rust ç¼–å†™çš„å®‰å…¨ç›‘è§†å™¨ï¼‰åœ¨ç›‘è§†å™¨æ¨¡å¼ä¸‹è¿è¡Œï¼Œè¯¥æ¨¡å¼æ˜ å°„åˆ° VMX root æ¨¡å¼ã€‚RustMonitor è´Ÿè´£å¼ºåˆ¶éš”ç¦»ï¼Œæ˜¯å¯ä¿¡è®¡ç®—åŸºï¼ˆTCBï¼‰çš„ä¸€éƒ¨åˆ†ã€‚éå¯ä¿¡æ“ä½œç³»ç»Ÿï¼ˆç§°ä¸ºä¸»æ“ä½œç³»ç»Ÿï¼‰ä¸ºåº”ç”¨ç¨‹åºçš„éå¯ä¿¡éƒ¨åˆ†æä¾›æ‰§è¡Œç¯å¢ƒï¼›éå¯ä¿¡æ“ä½œç³»ç»Ÿå’Œåº”ç”¨ç¨‹åºéƒ¨åˆ†åœ¨æ­£å¸¸æ¨¡å¼ä¸‹è¿è¡Œï¼Œè¯¥æ¨¡å¼æ˜ å°„åˆ° VMX non-root æ¨¡å¼ã€‚åº”ç”¨ç¨‹åºçš„å¯ä¿¡éƒ¨åˆ†ï¼ˆå³ enclaveï¼‰åœ¨å®‰å…¨æ¨¡å¼ä¸‹è¿è¡Œï¼Œå¯ä»¥çµæ´»åœ°æ˜ å°„åˆ° VMX non-root æ¨¡å¼çš„ ring-3 æˆ– ring-0ï¼Œæˆ– VMX root æ¨¡å¼çš„ ring-3ã€‚</p><p>å†…å­˜éš”ç¦»ç”±å†…å­˜ç®¡ç†å•å…ƒï¼ˆMMUï¼‰çš„åŸºäºç¡¬ä»¶çš„å†…å­˜ä¿æŠ¤å¼ºåˆ¶æ‰§è¡Œã€‚æ­£å¦‚æˆ‘ä»¬è§‚å¯Ÿåˆ°ç°æœ‰çš„åŸºäºè¿›ç¨‹çš„ TEEï¼ˆä¾‹å¦‚ï¼ŒInktag [38] å’Œè‹±ç‰¹å°” SGX [55]ï¼‰å®¹æ˜“å—åˆ°åŸºäºé¡µè¡¨çš„æ”»å‡» [74]ï¼Œæˆ‘ä»¬çš„å†…å­˜éš”ç¦»æ–¹æ¡ˆé€‰æ‹©å®Œå…¨ç”±å¯ä¿¡ä»£ç ç®¡ç† enclave çš„é¡µè¡¨å’Œé¡µé”™è¯¯äº‹ä»¶ï¼Œä»è€Œæ¶ˆé™¤äº†ä¸»æ“ä½œç³»ç»Ÿçš„å‚ä¸ã€‚è¯¥è®¾è®¡è¿˜é˜²æ­¢äº†æŸäº›ç±»å‹çš„ enclave æ¶æ„è½¯ä»¶æ”»å‡»ï¼ˆç¬¬ 3.2 èŠ‚ï¼‰ã€‚</p><p>ä¸ºäº†æœ€å°åŒ–æ”»å‡»é¢ï¼Œæˆ‘ä»¬é‡‡ç”¨äº†ä¸€ç§ç§°ä¸ºâ€åº¦é‡å»¶è¿Ÿå¯åŠ¨â€çš„æ–¹æ³•ï¼šé¦–å…ˆå¯åŠ¨ä¸»æ“ä½œç³»ç»Ÿå†…æ ¸ï¼›ç„¶åï¼Œä¸€æ®µä½œä¸ºä¸»æ“ä½œç³»ç»Ÿå†…æ ¸æ¨¡å—å®ç°çš„ç‰¹æ®Šå†…æ ¸ä»£ç è¿è¡Œï¼Œä»¥åœ¨æœ€é«˜ç‰¹æƒçº§åˆ«ï¼ˆå³ç›‘è§†å™¨æ¨¡å¼ï¼‰åˆå§‹åŒ– RustMonitorï¼Œå¹¶å°†ä¸»æ“ä½œç³»ç»Ÿé™çº§åˆ°æ­£å¸¸æ¨¡å¼ã€‚å¯åŠ¨è¿‡ç¨‹ä¸­çš„æ‰€æœ‰å·²å¯åŠ¨ç»„ä»¶éƒ½è¢«åº¦é‡å¹¶æ‰©å±•åˆ° TPM å¹³å°é…ç½®å¯„å­˜å™¨ï¼ˆPCRsï¼‰ã€‚ç”±äº TPM è¯æ˜ä¿è¯äº† PCRs ä¸èƒ½å›æ»šï¼Œè¯¥è®¾è®¡ç¡®ä¿äº† RustMonitor çš„å®‰å…¨å¯åŠ¨ï¼›å¦åˆ™ï¼Œåœ¨è¿œç¨‹è¯æ˜æœŸé—´å°†æ£€æµ‹åˆ° TPM quote çš„è¿è§„ã€‚</p><p>æˆ‘ä»¬å·²åœ¨å•†ç”¨ AMD æœåŠ¡å™¨ä¸Šå®ç°äº† HyperEnclaveã€‚RustMonitor æ€»å…±åŒ…å«çº¦ 7,500 è¡Œ Rust ä»£ç ã€‚æˆ‘ä»¬çš„ enclave SDK çš„ API ä¸å®˜æ–¹ SGX SDK å…¼å®¹ã€‚å› æ­¤ï¼Œä¸º SGX ç¼–å†™çš„ä»£ç å¯ä»¥é€šè¿‡é‡æ–°ç¼–è¯‘ï¼Œåªéœ€å¾ˆå°‘ï¼ˆæˆ–æ²¡æœ‰ï¼‰æºä»£ç æ›´æ”¹ï¼Œå°±å¯ä»¥è½»æ¾åœ°ç§»æ¤åˆ° HyperEnclave ä¸Šè¿è¡Œã€‚æˆ‘ä»¬å·²ç»å°†ä¸€äº› SGX åº”ç”¨ç¨‹åºä»¥åŠ Rust SGX SDK [71] å’Œ Occlum åº“æ“ä½œç³»ç»Ÿ [64] ç§»æ¤åˆ°äº† HyperEnclaveã€‚å¾®åŸºå‡†æµ‹è¯•æ˜¾ç¤ºï¼ŒECALL å’Œ OCALL çš„å¼€é”€åˆ†åˆ«å°äº 9,700 å’Œ 5,260 ä¸ªå‘¨æœŸï¼ˆåœ¨è‹±ç‰¹å°” SGX ä¸Šåˆ†åˆ«ä¸º 14,432 å’Œ 12,432 ä¸ªå‘¨æœŸï¼‰ã€‚åœ¨ä¸€ç³»åˆ—çœŸå®ä¸–ç•Œåº”ç”¨ä¸Šçš„è¯„ä¼°è¡¨æ˜ï¼Œå¼€é”€å¾ˆå°ï¼ˆä¾‹å¦‚ï¼Œåœ¨ SQLite ä¸Šçš„å¼€é”€ä»…ä¸º 5%ï¼‰ã€‚</p><p><strong>è´¡çŒ®ã€‚</strong> æ€»è€Œè¨€ä¹‹ï¼Œæœ¬æ–‡æå‡ºäº† HyperEnclave çš„è®¾è®¡ï¼Œå…·æœ‰ä»¥ä¸‹è´¡çŒ®ï¼š</p><ul><li>ä¸€ä¸ªå¼€æ”¾çš„ã€è·¨å¹³å°çš„ã€åŸºäºè¿›ç¨‹çš„ TEEï¼Œå…·æœ‰æœ€ä½çš„ç¡¬ä»¶è¦æ±‚ï¼ˆè™šæ‹ŸåŒ–æ‰©å±•å’Œ TPMï¼‰ï¼Œå¯ä»¥è¿è¡Œç°æœ‰çš„ SGX ç¨‹åºï¼Œåªéœ€å¾ˆå°‘æˆ–æ²¡æœ‰æºä»£ç æ›´æ”¹ï¼Œä»è€Œèƒ½å¤Ÿé‡ç”¨è‹±ç‰¹å°” SGX ä¸°å¯Œçš„å·¥å…·é“¾å’Œç”Ÿæ€ç³»ç»Ÿã€‚</li><li>æ”¯æŒçµæ´»çš„ enclave æ“ä½œæ¨¡å¼ï¼Œä»¥æ»¡è¶³ enclave åº”ç”¨ç¨‹åºå¤šæ ·åŒ–çš„å®‰å…¨å’Œæ€§èƒ½éœ€æ±‚ï¼Œè€Œæ— éœ€ç¡¬ä»¶æˆ–å›ºä»¶æ›´æ”¹ã€‚</li><li>ä¸€ç§å†…å­˜éš”ç¦»æ–¹æ¡ˆï¼Œå…¶ä¸­ enclave çš„é¡µè¡¨å’Œé¡µé”™è¯¯å®Œå…¨ç”±å¯ä¿¡ä»£ç ç®¡ç†ï¼Œè¿™å‡è½»äº†åŸºäºé¡µè¡¨çš„æ”»å‡»å’Œ enclave æ¶æ„è½¯ä»¶æ”»å‡»ã€‚</li><li>ä¸€ç§åº¦é‡å»¶è¿Ÿå¯åŠ¨æ–¹æ³•ï¼Œç»“åˆåŸºäº TPM çš„è¯æ˜æ¥å‡å°‘æ”»å‡»é¢ã€‚</li><li>åœ¨å•†ç”¨æœåŠ¡å™¨ä¸Šï¼ˆä¸»è¦ï¼‰ä½¿ç”¨å†…å­˜å®‰å…¨è¯­è¨€ Rust å®ç°ï¼Œå¹¶åœ¨çœŸå®ç¡¬ä»¶å’Œåº”ç”¨ä¸Šè¿›è¡Œè¯„ä¼°ï¼Œè¯æ˜äº†æ‰€æå‡ºçš„è®¾è®¡æ˜¯å®ç”¨çš„ï¼Œå¹¶ä¸”åªæœ‰å¾ˆå°çš„å¼€é”€ã€‚</li></ul><h2 id="2-èƒŒæ™¯"><a href="#2-èƒŒæ™¯" class="headerlink" title="2 èƒŒæ™¯"></a>2 èƒŒæ™¯</h2><h3 id="2-1-å¯ä¿¡æ‰§è¡Œç¯å¢ƒ"><a href="#2-1-å¯ä¿¡æ‰§è¡Œç¯å¢ƒ" class="headerlink" title="2.1 å¯ä¿¡æ‰§è¡Œç¯å¢ƒ"></a>2.1 å¯ä¿¡æ‰§è¡Œç¯å¢ƒ</h3><p>å¯ä¿¡æ‰§è¡Œç¯å¢ƒï¼ˆTEEï¼‰æ—¨åœ¨ç¡®ä¿æ•æ„Ÿæ•°æ®åœ¨ä¸€ä¸ªéš”ç¦»å’Œå¯ä¿¡çš„ç¯å¢ƒä¸­è¢«å­˜å‚¨ã€å¤„ç†å’Œä¿æŠ¤ã€‚éš”ç¦»åŒºåŸŸå¯ä»¥æ˜¯ä¸€ä¸ªç‹¬ç«‹äºæ­£å¸¸æ“ä½œç³»ç»Ÿçš„ç³»ç»Ÿï¼ˆå¦‚ TrustZone [16] çš„å®‰å…¨ä¸–ç•Œï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯è¿›ç¨‹åœ°å€ç©ºé—´çš„ä¸€éƒ¨åˆ†ï¼ˆå¦‚è‹±ç‰¹å°” SGX [55] enclaveï¼‰ï¼Œæˆ–ä¸€ä¸ªç‹¬ç«‹çš„è™šæ‹Ÿæœºï¼ˆå¦‚å— AMD SEV [45] æˆ–è‹±ç‰¹å°” TDX [41] ä¿æŠ¤çš„è™šæ‹Ÿæœºï¼‰ã€‚ä¸ºäº†æŠµæŠ—ç‰¹æƒæ”»å‡»è€…ï¼ŒTEE ä¸ä»…éœ€è¦æŒ«è´¥æ“ä½œç³»ç»Ÿçº§åˆ«çš„å¯¹æ‰‹ï¼Œè¿˜éœ€è¦é˜²å¾¡å¯¹å¹³å°æœ‰ç‰©ç†è®¿é—®æƒé™çš„æ¶æ„æ–¹ã€‚ä¸ºæ­¤ï¼Œå®ƒæä¾›äº†ç¡¬ä»¶å¼ºåˆ¶çš„å®‰å…¨åŠŸèƒ½ï¼ŒåŒ…æ‹¬éš”ç¦»æ‰§è¡Œã€enclave çš„å®Œæ•´æ€§å’Œæœºå¯†æ€§ä¿æŠ¤ï¼Œä»¥åŠé€šè¿‡è¿œç¨‹è¯æ˜æ¥éªŒè¯åœ¨å¯ä¿¡å¹³å°å†…è¿è¡Œçš„ä»£ç çš„èƒ½åŠ›ã€‚</p><p><strong>éš”ç¦»ã€‚</strong> TEE çš„æ ¸å¿ƒæ˜¯å†…å­˜éš”ç¦»æ–¹æ¡ˆï¼Œå®ƒä¿è¯äº† enclave çš„ä»£ç ã€æ•°æ®å’Œè¿è¡Œæ—¶çŠ¶æ€ä¸èƒ½è¢«éå¯ä¿¡æ–¹è®¿é—®æˆ–ç¯¡æ”¹ã€‚å¯¹äºè‹±ç‰¹å°” SGXï¼Œå—ä¿æŠ¤çš„å†…å­˜ï¼ˆå³ enclaveï¼‰è¢«æ˜ å°„åˆ°ä¸€ä¸ªç§°ä¸º Enclave é¡µç¼“å­˜ï¼ˆEPCï¼‰çš„ç‰¹æ®Šç‰©ç†å†…å­˜åŒºåŸŸï¼Œè¯¥åŒºåŸŸè¢«åŠ å¯†ï¼Œä¸èƒ½è¢«å…¶ä»–è½¯ä»¶ã€å›ºä»¶ã€BIOS å’Œç›´æ¥å†…å­˜è®¿é—®ï¼ˆDMAï¼‰ç›´æ¥è®¿é—®ã€‚</p><p><strong>è¯æ˜ã€‚</strong> è¿œç¨‹è¯æ˜çš„ç›®æ ‡æ˜¯ç”Ÿæˆä¸€ä¸ªè¯æ˜ quoteï¼Œå…¶ä¸­åŒ…æ‹¬å¯¹è½¯ä»¶çŠ¶æ€çš„åº¦é‡ï¼Œå¹¶ç”¨åµŒå…¥åœ¨ç¡¬ä»¶ä¸­çš„è¯æ˜å¯†é’¥ç­¾åã€‚è¿œç¨‹ç”¨æˆ·é€šè¿‡æ£€æŸ¥ç­¾åï¼ˆåæ˜ ç¡¬ä»¶èº«ä»½ï¼‰å’Œåº¦é‡ï¼ˆè¯æ˜è½¯ä»¶çŠ¶æ€ï¼‰æ¥éªŒè¯ quote çš„æœ‰æ•ˆæ€§ã€‚</p><h3 id="2-2-å¯ä¿¡å¹³å°æ¨¡å—"><a href="#2-2-å¯ä¿¡å¹³å°æ¨¡å—" class="headerlink" title="2.2 å¯ä¿¡å¹³å°æ¨¡å—"></a>2.2 å¯ä¿¡å¹³å°æ¨¡å—</h3><p>å¯ä¿¡å¹³å°æ¨¡å—ï¼ˆTPMï¼‰æ—¢æ˜¯è¡Œä¸šæ ‡å‡† [36]ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªç”¨äºå®‰å…¨åŠ å¯†å¤„ç†å™¨çš„ ISO&#x2F;IEC æ ‡å‡† [4]ã€‚å‡ ä¹æ‰€æœ‰çš„ä¸ªäººç”µè„‘å’ŒæœåŠ¡å™¨åˆ¶é€ å•†éƒ½åœ¨ä½¿ç”¨å®ƒã€‚å›ºä»¶ TPMï¼ˆfTPMsï¼‰æ˜¯åŸºäºå›ºä»¶ï¼ˆä¾‹å¦‚ UEFIï¼‰çš„ TPM å®ç°ã€‚åœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼Œè‹±ç‰¹å°”ã€AMD å’Œé«˜é€šéƒ½å·²å®ç° fTPMã€‚</p><p>TPM æœ‰ä¸€ç»„å¹³å°é…ç½®å¯„å­˜å™¨ï¼ˆPCRsï¼‰ï¼Œå¯ç”¨äºåœ¨å¯åŠ¨è¿‡ç¨‹ä¸­åº¦é‡å·²å¯åŠ¨çš„ä»£ç ã€‚PCRs åœ¨ç³»ç»Ÿé‡å¯æˆ–å¼€å…³æœºæ—¶è¢«é‡ç½®ä¸ºé›¶ã€‚åœ¨æ¯ä¸ªå¯åŠ¨è¿‡ç¨‹ä¸­ï¼ŒPCRs åªèƒ½ç”¨æ–°çš„åº¦é‡å€¼è¿›è¡Œæ‰©å±•ï¼ˆç§°ä¸º PCR extendï¼‰ï¼Œå› æ­¤ä¸èƒ½è¢«è®¾ç½®ä¸ºä»»æ„å€¼ã€‚</p><p>æ¯ä¸ª TPM éƒ½å¸¦æœ‰ä¸€ä¸ªç‹¬ç‰¹çš„éå¯¹ç§°å¯†é’¥ï¼Œç§°ä¸ºç­¾æ³¨å¯†é’¥ï¼ˆEKï¼‰ï¼Œç”±åˆ¶é€ å•†åµŒå…¥ä½œä¸ºä¿¡ä»»æ ¹ã€‚TPM å¯ä»¥ç”Ÿæˆ PCR å€¼çš„ quoteï¼Œç”¨ TPM è¯æ˜èº«ä»½å¯†é’¥ï¼ˆAIKï¼‰ç­¾åï¼Œè€Œ AIK åœ¨ TPM å†…éƒ¨ç”Ÿæˆå¹¶ä½¿ç”¨ EK è®¤è¯ã€‚å¯¹å·²å¯åŠ¨ä»£ç çš„ä»»ä½•ä¿®æ”¹éƒ½å°†åæ˜ åœ¨ quote ä¸­ã€‚æ”¶åˆ° quote åï¼Œè¿œç¨‹æ–¹å¯ä»¥éªŒè¯ç­¾åå¯†é’¥æ¥è‡ªä¸€ä¸ªçœŸå®çš„ TPMï¼Œå¹¶å¯ä»¥ç¡®ä¿¡ PCR æ‘˜è¦æŠ¥å‘Šæ²¡æœ‰è¢«æ›´æ”¹ã€‚</p><h3 id="2-3-å¨èƒæ¨¡å‹"><a href="#2-3-å¨èƒæ¨¡å‹" class="headerlink" title="2.3 å¨èƒæ¨¡å‹"></a>2.3 å¨èƒæ¨¡å‹</h3><p>ä¸å…¶ä»– TEE æè®® [23, 49] ä¸€æ ·ï¼Œæˆ‘ä»¬ä¿¡ä»»åº•å±‚ç¡¬ä»¶ï¼ŒåŒ…æ‹¬å»ºç«‹åŸºäºè™šæ‹ŸåŒ–çš„éš”ç¦»çš„å¤„ç†å™¨ã€ç³»ç»Ÿç®¡ç†æ¨¡å¼ï¼ˆSMMï¼‰ä»£ç ä»¥åŠ TPMã€‚æˆ‘ä»¬å‡è®¾æµ‹é‡æ ¸å¿ƒä¿¡ä»»æ ¹ï¼ˆCRTMï¼‰æ˜¯å¯ä¿¡ä¸”ä¸å¯å˜çš„ã€‚HyperEnclave é€šè¿‡ç¡¬ä»¶å¯¹å†…å­˜åŠ å¯†çš„æ”¯æŒï¼Œå‡è½»äº†æŸäº›ç‰©ç†å†…å­˜æ”»å‡»ï¼Œä¾‹å¦‚å†·å¯åŠ¨æ”»å‡»å’Œæ€»çº¿å—…æ¢æ”»å‡»ã€‚æˆ‘ä»¬ä¸å®Œå…¨ä¿¡ä»»æ“ä½œå‘˜ï¼Œå¹¶å‡è®¾æ”»å‡»è€…åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­æ— æ³•è¿›è¡Œç‰©ç†æ”»å‡»ï¼Œå³æˆ‘ä»¬å‡è®¾ç³»ç»Ÿæœ€åˆæ˜¯è‰¯æ€§çš„ï¼ˆåœ¨ç³»ç»Ÿå¯åŠ¨æœŸé—´ï¼‰ï¼Œå¹¶ä¸”å¯åŠ¨é˜¶æ®µçš„æ—©æœŸæ“ä½œç³»ç»Ÿæ˜¯ TCB çš„ä¸€éƒ¨åˆ†ã€‚è¿™å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼å®ç°ã€‚</p><ul><li>é¦–å…ˆï¼Œå¼€æœºäº‹ä»¶å¯ä»¥ç”¨ç¡¬ä»¶è®¾å¤‡ï¼ˆå¦‚ HSMï¼Œå³ç¡¬ä»¶å®‰å…¨æ¨¡å—ï¼‰æ¥ä¿æŠ¤ã€‚å¹³å°åªæœ‰åœ¨æ‹¥æœ‰ HSM çš„å¯ä¿¡æ–¹çš„å‚ä¸å’Œç›‘ç£ä¸‹æ‰èƒ½è¿›å…¥å¯åŠ¨è¿‡ç¨‹ã€‚ä¹‹åï¼Œè´Ÿè´£ç»´æŠ¤çš„æ“ä½œå‘˜æ˜¯ä¸è¢«ä¿¡ä»»çš„ã€‚</li><li>å…¶æ¬¡ï¼Œå¯ä»¥å¢å¼ºå¯åŠ¨è¿‡ç¨‹ä»¥é˜²å¾¡å…·æœ‰ç‰©ç†è®¿é—®æƒé™çš„å¯¹æ‰‹ã€‚ä¸ºäº†é˜²æ­¢ I&#x2F;O æ”»å‡»ï¼Œæˆ‘ä»¬å¯ä»¥å¼ºåŒ–æ“ä½œç³»ç»Ÿä»¥ç§»é™¤ä¸å¿…è¦çš„è®¾å¤‡ï¼Œå¹¶åœ¨å¯ç”¨ IOMMU ä¹‹å‰ç¦ç”¨å¤–å›´è®¾å¤‡çš„ DMA åŠŸèƒ½ã€‚æˆ‘ä»¬å¯ä»¥åœ¨æ—©æœŸé˜¶æ®µï¼ˆä¾‹å¦‚ï¼Œåœ¨ BIOS ä¸­ï¼Œåœ¨ä»»ä½•ç‰‡å¤–å†…å­˜è¢«ä½¿ç”¨ä¹‹å‰ï¼‰å¯ç”¨å†…å­˜åŠ å¯†ä»¥é˜²æ­¢ç‰©ç†å†…å­˜æ”»å‡»ã€‚</li></ul><p>ç„¶è€Œï¼Œåœ¨ RustMonitor å¯åŠ¨åï¼Œä¸»æ“ä½œç³»ç»Ÿè¢«é™çº§åˆ°æ­£å¸¸æ¨¡å¼ï¼Œå¹¶å¯èƒ½å—åˆ°æ”»å‡»è€…çš„æ§åˆ¶ï¼Œæ”»å‡»è€…å¯èƒ½ä¼šè¯•å›¾ç ´å RustMonitor æˆ– enclaveï¼Œä¾‹å¦‚ï¼Œè¯•å›¾ç›´æ¥æˆ–é€šè¿‡ DMA è®¿é—®å—ä¿æŠ¤çš„å†…å­˜ã€‚æˆ‘ä»¬è®¤ä¸º enclave ä»£ç å¯èƒ½æ˜¯æ¶æ„çš„æˆ–ç”±äºå†…å­˜é”™è¯¯è€Œè¢«æ”»å‡»è€…æ§åˆ¶ã€‚æˆ‘ä»¬çš„è®¾è®¡éœ€è¦é˜²æ­¢ä¸€ä¸ªå—æŸçš„ enclave æ±¡æŸ“å…¶ä»– enclave æˆ– RustMonitorã€‚æˆ‘ä»¬è¿˜é˜²æ­¢äº†é’ˆå¯¹ä¸»æ“ä½œç³»ç»Ÿæˆ–åº”ç”¨ç¨‹åºä»£ç çš„æ”»å‡»ï¼Œå¦‚ [63] ä¸­æ‰€è¿°ã€‚ä¸å…¶ä»– TEE ç±»ä¼¼ï¼Œåœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬ä¸å…³æ³¨æ‹’ç»æœåŠ¡ï¼ˆDoSï¼‰æ”»å‡»æˆ–ä¾§ä¿¡é“æ”»å‡»çš„é¢„é˜²ï¼Œä¾‹å¦‚ç¼“å­˜æ—¶åºå’Œæ¨æµ‹æ‰§è¡Œæ”»å‡» [48]ã€‚</p><h2 id="3-è®¾è®¡"><a href="#3-è®¾è®¡" class="headerlink" title="3 è®¾è®¡"></a>3 è®¾è®¡</h2><p>HyperEnclave æ—¨åœ¨æ”¯æŒæœºå¯†äº‘è®¡ç®—ï¼Œè€Œæ— éœ€ç‰¹å®šçš„ç¡¬ä»¶åŠŸèƒ½ã€‚å› æ­¤ï¼ŒHyperEnclave æ˜¯å»ºç«‹åœ¨å¹¿æ³›å¯ç”¨çš„è™šæ‹ŸåŒ–æ‰©å±•ä¹‹ä¸Šçš„ã€‚ç‰¹åˆ«æ˜¯ï¼ŒHyperEnclave æ—¨åœ¨æ”¯æŒåŸºäºè¿›ç¨‹çš„ TEE æ¨¡å‹ï¼ˆç±»ä¼¼äºè‹±ç‰¹å°” SGXï¼‰ï¼ŒåŸå› å¦‚ä¸‹ã€‚</p><ul><li><strong>æœ€å°åŒ– TCBã€‚</strong> ä½¿ç”¨åŸºäºè¿›ç¨‹çš„ TEE ä¿æŠ¤åº”ç”¨ç¨‹åºæ—¶ï¼ŒTCB ä»…åŒ…æ‹¬å—ä¿æŠ¤çš„ä»£ç æœ¬èº«ï¼Œè€Œåœ¨å…¶ä»–å½¢å¼çš„ TEE ä¸­ï¼Œå¿…é¡»åŒ…æ‹¬æ›´å¤šçš„ä»£ç ï¼Œä¾‹å¦‚åŸºäº VM çš„ TEE çš„å®¢æˆ·æœºæ“ä½œç³»ç»Ÿã€‚</li><li><strong>å·²å»ºç«‹çš„ç”Ÿæ€ç³»ç»Ÿã€‚</strong> ç”±äºè‹±ç‰¹å°” SGX ç›®å‰æ˜¯äº‘ä¸­æ”¯æŒæœ€æ™®éçš„ TEEï¼ˆåŒ…æ‹¬ GCPã€Azure å’Œé˜¿é‡Œäº‘åœ¨å†…çš„ä¸»è¦ CSP éƒ½æä¾›åŸºäº SGX çš„å®ä¾‹ [9, 62]ï¼‰ï¼Œå·²ç»å¼€å‘äº†ä¸°å¯Œçš„å·¥å…·é“¾å’Œåº”ç”¨ç¨‹åºã€‚æ”¯æŒ SGX æ¨¡å‹å‡å°‘äº†ç§»æ¤å·¥ä½œï¼Œå¹¶ä½¿å…¶æ˜“äºåœ¨äº‘ä¸­éƒ¨ç½²æœºå¯†è®¡ç®—ä»»åŠ¡ã€‚</li><li><strong>äº‘è®¡ç®—è¶‹åŠ¿ã€‚</strong> æˆ‘ä»¬å·²ç»çœ‹åˆ°äº†åœ¨äº‘ä¸­è¿è¡ŒåŸºäºå®¹å™¨çš„æ— æœåŠ¡å™¨åº”ç”¨ç¨‹åºçš„æ˜æ˜¾è¶‹åŠ¿ã€‚ä½¿ç”¨ TEE ä¿æŠ¤è¿™äº›åº”ç”¨ç¨‹åºå…å—éå¯ä¿¡äº‘çš„æ”»å‡»éå¸¸é‡è¦ã€‚è€ƒè™‘åˆ°è¿™ç±»è®¡ç®—ä»»åŠ¡é€šå¸¸æ˜¯çŸ­æš‚çš„ï¼Œå¹¶ä¸”åå¥½è¾ƒçŸ­çš„å¯åŠ¨æ—¶é—´ï¼Œç»´æŠ¤ä¸€ä¸ªè™šæ‹Ÿæœºä¼¼ä¹è¿‡äºé‡é‡çº§ã€‚</li></ul><p>åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ x86 ç¬¦å·ä»‹ç» HyperEnclaveï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ AMD æœåŠ¡å™¨ä¸Šå¯¹ HyperEnclave è¿›è¡Œäº†åŸå‹è®¾è®¡ã€‚</p><h3 id="3-1-ç³»ç»Ÿæ¦‚è¿°"><a href="#3-1-ç³»ç»Ÿæ¦‚è¿°" class="headerlink" title="3.1 ç³»ç»Ÿæ¦‚è¿°"></a>3.1 ç³»ç»Ÿæ¦‚è¿°</h3><p>HyperEnclave æ”¯æŒä»¥ä¸‹æ¨¡å¼ï¼šç›‘è§†å™¨æ¨¡å¼ï¼Œå³ VMX root æ“ä½œæ¨¡å¼ï¼›ç”¨äºä¸»æ“ä½œç³»ç»Ÿå’Œåº”ç”¨ç¨‹åºéå¯ä¿¡éƒ¨åˆ†çš„æ­£å¸¸æ¨¡å¼ï¼Œå³åˆ†åˆ«ä¸º VMX non-root æ“ä½œæ¨¡å¼çš„ ring-0 å’Œ ring-3ï¼›ä»¥åŠç”¨äº enclave çš„å®‰å…¨æ¨¡å¼ï¼Œæ ¹æ® enclave æ“ä½œæ¨¡å¼ï¼Œå®ƒå¯ä»¥æ˜¯ VMX non-root æ“ä½œæ¨¡å¼çš„ ring-3 å’Œ ring-0ï¼Œæˆ– VMX root æ“ä½œæ¨¡å¼çš„ ring-3ã€‚æˆ‘ä»¬å°†åœ¨ç¬¬ 4 èŠ‚ä¸­ä»‹ç» HyperEnclave æ”¯æŒçš„çµæ´»æ“ä½œæ¨¡å¼ã€‚å¦‚å›¾ 1 æ‰€ç¤ºï¼ŒHyperEnclave ç”±ä»¥ä¸‹ç»„ä»¶ç»„æˆï¼š</p><ul><li><strong>RustMonitor</strong> æ˜¯ä¸€ä¸ªåœ¨ç›‘è§†å™¨æ¨¡å¼ä¸‹è¿è¡Œçš„è½»é‡çº§è™šæ‹Ÿæœºç®¡ç†ç¨‹åºï¼Œå®ƒç®¡ç† enclave å†…å­˜ï¼Œå¼ºåˆ¶æ‰§è¡Œå†…å­˜éš”ç¦»ï¼Œå¹¶æ§åˆ¶ enclave çŠ¶æ€è½¬æ¢ã€‚å®ƒä½œä¸ºä¸€ä¸ªèµ„æºç›‘è§†å™¨å·¥ä½œï¼Œè€Œå¤æ‚çš„ä»»åŠ¡åˆ™è¢«å¸è½½åˆ°ä¸»æ“ä½œç³»ç»Ÿã€‚</li><li>RustMonitor åˆ›å»ºä¸€ä¸ªç‹¬ç‰¹çš„å®¢æˆ·æœºè™šæ‹Ÿæœºï¼ˆç§°ä¸º<strong>æ­£å¸¸è™šæ‹Ÿæœº</strong>ï¼‰ï¼Œè¯¥è™šæ‹Ÿæœºè¿è¡Œä¸»æ“ä½œç³»ç»Ÿï¼ˆå¦‚ Linuxï¼‰å¹¶åœ¨æ­£å¸¸æ¨¡å¼ä¸‹æ‰˜ç®¡åº”ç”¨ç¨‹åºçš„éå¯ä¿¡éƒ¨åˆ†ã€‚ä¸»æ“ä½œç³»ç»Ÿä»ç„¶è´Ÿè´£è¿›ç¨‹è°ƒåº¦å’Œ I&#x2F;O è®¾å¤‡ç®¡ç†ï¼Œä½†å®ƒä¸è¢« RustMonitor å’Œ enclave ä¿¡ä»»ã€‚</li><li><strong>åº”ç”¨ç¨‹åº</strong>æ˜¯åœ¨ä¸»æ“ä½œç³»ç»Ÿä¸­è¿è¡Œçš„åº”ç”¨ç¨‹åºçš„éå¯ä¿¡éƒ¨åˆ†ã€‚</li><li><strong>å†…æ ¸æ¨¡å—</strong>ã€‚æˆ‘ä»¬åœ¨ä¸»æ“ä½œç³»ç»Ÿä¸­æä¾›ä¸€ä¸ªå†…æ ¸æ¨¡å—ï¼Œç”¨äºåŠ è½½ã€åº¦é‡å’Œå¯åŠ¨ RustMonitorï¼Œä»¥åŠè°ƒç”¨æ¨¡æ‹Ÿçš„ç‰¹æƒæ“ä½œã€‚</li><li>ä¸ºäº†æ–¹ä¾¿å¼€å‘ï¼ŒHyperEnclave æä¾›äº†ä¸€ä¸ª <strong>enclave SDK</strong>ï¼Œå…¶ API ä¸å®˜æ–¹è‹±ç‰¹å°” SGX SDK [12] å…¼å®¹ï¼ŒåŒ…æ‹¬éå¯ä¿¡è¿è¡Œæ—¶å’Œå¯ä¿¡è¿è¡Œæ—¶ï¼ˆå³ SDK uRTS å’Œ SDK tRTSï¼‰ã€‚å› æ­¤ï¼Œå¤§å¤šæ•° SGX ç¨‹åºåªéœ€å¾ˆå°‘æˆ–æ²¡æœ‰æºä»£ç æ›´æ”¹å³å¯åœ¨ HyperEnclave ä¸Šè¿è¡Œã€‚</li><li><strong>Enclave</strong> æ˜¯åœ¨å®‰å…¨æ¨¡å¼ä¸‹è¿è¡Œçš„åº”ç”¨ç¨‹åºçš„å¯ä¿¡éƒ¨åˆ†ã€‚</li></ul><h3 id="3-2-å†…å­˜ç®¡ç†å’Œä¿æŠ¤"><a href="#3-2-å†…å­˜ç®¡ç†å’Œä¿æŠ¤" class="headerlink" title="3.2 å†…å­˜ç®¡ç†å’Œä¿æŠ¤"></a>3.2 å†…å­˜ç®¡ç†å’Œä¿æŠ¤</h3><p><strong>æŒ‘æˆ˜ã€‚</strong> å¯¹äºåŸºäºè¿›ç¨‹çš„ TEEï¼Œenclave åœ¨ç”¨æˆ·æ¨¡å¼ä¸‹è¿è¡Œï¼Œæ— æ³•ç®¡ç†è‡ªå·±çš„é¡µè¡¨ã€‚ç°æœ‰è®¾è®¡ï¼ˆä¾‹å¦‚ï¼Œè‹±ç‰¹å°” SGXã€TrustVisor [54]ï¼‰å…è®¸éå¯ä¿¡æ“ä½œç³»ç»Ÿç®¡ç† enclave çš„é¡µè¡¨ã€‚ä¸ºäº†é˜²æ­¢å†…å­˜æ˜ å°„æ”»å‡»ï¼ˆå³é€šè¿‡æ“çºµ enclave çš„åœ°å€æ˜ å°„è¿›è¡Œçš„æ”»å‡»ï¼Œå¦‚å›¾ 9ï¼Œé™„å½• A.1 æ‰€ç¤ºï¼‰ï¼ŒSGX çš„è®¾è®¡æ‰©å±•äº†ç¼ºé¡µå¤„ç†ç¨‹åºï¼ˆPMHï¼‰å¹¶å¼•å…¥äº†ä¸€ä¸ªåä¸º EPCM çš„æ–°å…ƒæ•°æ®ï¼Œç”¨äºå¯¹ TLB æœªå‘½ä¸­è¿›è¡Œé¢å¤–çš„å®‰å…¨æ£€æŸ¥ [32]ã€‚åœ¨æ²¡æœ‰å®‰å…¨ç¡¬ä»¶æ”¯æŒçš„æƒ…å†µä¸‹ï¼Œä¸€ç§æ™®éçš„è½¯ä»¶è§£å†³æ–¹æ¡ˆ [19, 54, 75] æ˜¯é€šè¿‡è®¾ç½®æŒæœ‰é¡µè¡¨çš„é¡µçš„é¡µè¡¨é¡¹ï¼ˆPTEsï¼‰æ¥ä½¿é¡µè¡¨å†™ä¿æŠ¤ï¼Œå³å¯¹é¡µè¡¨çš„ä»»ä½•æ›´æ–°éƒ½ä¼šé™·å…¥è™šæ‹Ÿæœºç®¡ç†ç¨‹åºç„¶åè¿›è¡ŒéªŒè¯ã€‚ç„¶è€Œï¼Œåœ¨ x86 å¹³å°ä¸Šï¼ŒPTE çš„è®¿é—®ä½å’Œè„ä½çš„æ›´æ–°ä¹Ÿä¼šé™·å…¥è™šæ‹Ÿæœºç®¡ç†ç¨‹åºï¼Œå¯¼è‡´ä¸å¯å¿½ç•¥çš„å¼€é”€ã€‚æ›´ç³Ÿç³•çš„æ˜¯ï¼Œç”±äº enclave é¡µé”™è¯¯ä¹Ÿç”±æ“ä½œç³»ç»Ÿå¤„ç†ï¼Œä¸Šè¿°è®¾è®¡ä»ç„¶å®¹æ˜“å—åˆ°åŸºäºé¡µè¡¨çš„æ”»å‡»ï¼Œä¾‹å¦‚å—æ§ä¿¡é“æ”»å‡» [74]ã€‚</p><p>æ”¯æŒ enclave åŠ¨æ€å†…å­˜ç®¡ç†ï¼ˆå³ SGX2 å¹³å°ä¸Šçš„ EDMM [34]ï¼‰æ—¶ï¼Œè®¾è®¡å˜å¾—æ›´å…·æŒ‘æˆ˜æ€§ï¼Œå³åœ¨ enclave åˆå§‹åŒ–ååŠ¨æ€æ·»åŠ æˆ–åˆ é™¤ enclave é¡µé¢ï¼Œæˆ–æ›´æ”¹ enclave é¡µé¢å±æ€§æˆ–ç±»å‹ã€‚æ²¡æœ‰ EDMMï¼Œenclave å¯èƒ½æ›¾ç»ä½¿ç”¨çš„æ‰€æœ‰ç‰©ç†å†…å­˜éƒ½å¿…é¡»åœ¨ enclave åˆå§‹åŒ–ä¹‹å‰æäº¤ã€‚å› æ­¤ï¼ŒEDMM å‡å°‘äº† enclave æ„å»ºæ—¶é—´å¹¶å¯ç”¨äº†æ–°çš„ enclave åŠŸèƒ½ï¼Œä¾‹å¦‚æŒ‰éœ€å †æ ˆå’Œå †å¢é•¿ï¼Œä»¥åŠæŒ‰éœ€åˆ›å»ºä»£ç é¡µä»¥æ”¯æŒå³æ—¶ï¼ˆJITï¼‰ç¼–è¯‘ã€‚åœ¨ SGX2 å¹³å°ä¸Šï¼Œenclave éœ€è¦é€šè¿‡ OCALL å°† EDMM è¯·æ±‚å‘é€åˆ° SGX é©±åŠ¨ç¨‹åºï¼Œç„¶åç”±é©±åŠ¨ç¨‹åºè¿›è¡Œè¯·æ±‚çš„æ›´æ”¹ã€‚ç”±äºé©±åŠ¨ç¨‹åºä¸å— enclave ä¿¡ä»»ï¼Œå› æ­¤æ›´æ”¹éœ€è¦ç”± enclave æ˜ç¡®æ£€æŸ¥å’Œæ¥å—æ‰èƒ½ç”Ÿæ•ˆï¼Œè¿™æ¶‰åŠåˆ°ç¹é‡çš„ enclave æ¨¡å¼åˆ‡æ¢ã€‚</p><p><strong>HyperEnclave å†…å­˜ç®¡ç†ã€‚</strong> æˆ‘ä»¬è§‚å¯Ÿåˆ°ï¼Œä¸Šè¿°æŒ‘æˆ˜æ ¹æºäº enclave çš„é¡µè¡¨å’Œé¡µé”™è¯¯éƒ½ç”±ä¸»æ“ä½œç³»ç»Ÿç®¡ç†ã€‚åœ¨ HyperEnclave ä¸­ï¼Œå°½ç®¡ enclave ä»ç„¶æ˜¯åº”ç”¨ç¨‹åºåœ°å€ç©ºé—´çš„ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬ä¸º enclave åˆ›å»ºäº†ä¸€ä¸ªå•ç‹¬çš„é¡µè¡¨ï¼Œå¹¶è®© RustMonitor ç®¡ç† enclave çš„é¡µè¡¨å’Œé¡µé”™è¯¯ï¼Œè€Œæ— éœ€ä¸»æ“ä½œç³»ç»Ÿçš„å‚ä¸Â³ï¼Œè€Œæ­£å¸¸è™šæ‹Ÿæœºä¸­çš„é¡µè¡¨ä»ç”±ä¸»æ“ä½œç³»ç»Ÿç®¡ç†ã€‚ç„¶è€Œï¼Œè¯¥è®¾è®¡é¢ä¸´æ–°çš„æŒ‘æˆ˜ï¼šç”±äº enclave å¯ä»¥è®¿é—®åº”ç”¨ç¨‹åºçš„æ•´ä¸ªåœ°å€ç©ºé—´ï¼Œä¸€æ—¦åº”ç”¨ç¨‹åºä¸­é¡µè¡¨çš„æ˜ å°„å‘ç”Ÿå˜åŒ–ï¼Œä¾‹å¦‚ç”±äºé¡µé¢äº¤æ¢ï¼Œæ›´æ–°çš„æ˜ å°„éœ€è¦åŒæ­¥åˆ°ç”± RustMonitor ç®¡ç†çš„ enclave é¡µè¡¨ä¸­ã€‚</p><p>ä¸ºäº†æ¶ˆé™¤åŒæ­¥å¼€é”€ï¼Œæˆ‘ä»¬åœ¨åº”ç”¨ç¨‹åºçš„åœ°å€ç©ºé—´ä¸­é¢„åˆ†é…ä¸€ä¸ªç¼–ç»„ç¼“å†²åŒºï¼Œè¯¥ç¼“å†²åŒºä¸ enclave å…±äº«ã€‚ç¼–ç»„ç¼“å†²åŒºçš„æ˜ å°„åœ¨æ•´ä¸ª enclave ç”Ÿå‘½å‘¨æœŸå†…é€šè¿‡é¢„å¡«å……ç‰©ç†å†…å­˜å¹¶å°†å…¶å›ºå®šåœ¨å†…å­˜ä¸­æ¥ä¿æŒå›ºå®šã€‚enclave å’Œåº”ç”¨ç¨‹åºä¹‹é—´äº¤æ¢çš„æ‰€æœ‰æ•°æ®éƒ½å¿…é¡»é€šè¿‡ç¼–ç»„ç¼“å†²åŒºä¼ é€’ã€‚åº”ç”¨ç¨‹åºçš„å†…å­˜æ˜ å°„ï¼ˆé™¤äº†ç¼–ç»„ç¼“å†²åŒºçš„æ˜ å°„ï¼‰å¯¹ enclave æ˜¯ä¸éœ€è¦çš„ï¼Œå¹¶ä¸”ä¸åŒ…æ‹¬åœ¨ enclave çš„é¡µè¡¨ä¸­ã€‚è¿™æ ·çš„è®¾è®¡ä¹Ÿå‡è½»äº†å·²çŸ¥çš„ enclave æ¶æ„è½¯ä»¶æ”»å‡» [63]ï¼Œå› ä¸º enclave ä¸èƒ½è®¿é—®åº”ç”¨ç¨‹åºçš„åœ°å€ç©ºé—´ï¼Œåªèƒ½è®¿é—®ç¼–ç»„ç¼“å†²åŒºï¼ˆè¯¦è§ç¬¬ 6 èŠ‚ï¼‰ã€‚æˆ‘ä»¬æé†’æ”»å‡»è€…å¯èƒ½ä¼šæ“çºµç¼–ç»„ç¼“å†²åŒºï¼Œä½†è¿™ä¸ä¼šå¯¼è‡´é¢å¤–çš„å®‰å…¨é—®é¢˜ï¼Œå› ä¸ºè¯¥ç¼“å†²åŒºåœ¨è®¾è®¡ä¸Šæ˜¯ä¸å—ä¿¡ä»»çš„ï¼Œå¼€å‘è€…æœ‰è´£ä»»ç¡®ä¿é€šè¿‡è¯¥ç¼“å†²åŒºä¼ è¾“çš„æ•°æ®æ˜¯çœŸå®çš„å¹¶å—åˆ°ä¿æŠ¤ï¼ˆä¸ SGX æ¨¡å‹ç›¸åŒï¼‰ã€‚</p><p>å½“ enclave è®¿é—®ä¸€ä¸ªæœªæäº¤ç‰©ç†é¡µçš„è™šæ‹Ÿåœ°å€æ—¶ï¼ˆä¾‹å¦‚ï¼Œç”±äºé¡µé¢äº¤æ¢æˆ– EDMMï¼‰ï¼Œä¼šå¼•å‘ä¸€ä¸ªé¡µé”™è¯¯ï¼Œenclave ä¼šé™·å…¥ RustMonitorã€‚RustMonitor ä» enclave å†…å­˜æ± ä¸­æŒ‘é€‰ä¸€ä¸ªç©ºé—²é¡µï¼Œåœ¨ enclave çš„é¡µè¡¨ä¸­æ’å…¥ä¸€ä¸ªæ–°çš„æ˜ å°„ï¼Œå¹¶æ¢å¤ enclave çš„æ‰§è¡Œã€‚å½“ enclave è¯·æ±‚æ›´æ”¹é¡µé¢æƒé™æ—¶ï¼Œenclave ä¼šå‘ RustMonitor å‘å‡ºä¸€ä¸ª hypercallï¼Œä»¥æ›´æ–° enclave é¡µè¡¨ä¸­çš„æƒé™å¹¶æ¸…é™¤ç›¸åº”çš„ TLB æ¡ç›®ã€‚â´</p><p><strong>HyperEnclave å†…å­˜éš”ç¦»ã€‚</strong> å›¾ 2 æ˜¾ç¤ºäº†æ­£å¸¸è™šæ‹Ÿæœºå†…åº”ç”¨ç¨‹åºå’Œ enclave çš„å†…å­˜æ˜ å°„ã€‚æ­£å¸¸è™šæ‹Ÿæœºå†…çš„åº”ç”¨ç¨‹åºå†…å­˜é€šè¿‡åµŒå¥—åˆ†é¡µè¿›è¡Œç®¡ç†ï¼Œè€Œ enclave çš„å†…å­˜å¯ä»¥é€šè¿‡åµŒå¥—åˆ†é¡µæˆ–é€šè¿‡æ­£å¸¸çš„ 1 çº§åœ°å€è½¬æ¢è¿›è¡Œç®¡ç†ï¼Œå…·ä½“å–å†³äºç›¸åº”çš„æ“ä½œæ¨¡å¼ï¼ˆç¬¬ 4 èŠ‚ï¼‰ã€‚å› æ­¤ï¼ŒHyperEnclave å¼ºåˆ¶æ‰§è¡Œä»¥ä¸‹å®‰å…¨è¦æ±‚ã€‚</p><ul><li><strong>R-1:</strong> ä¸»æ“ä½œç³»ç»Ÿå’Œåº”ç”¨ç¨‹åºä¸å…è®¸è®¿é—®å±äº RustMonitor å’Œ enclave çš„ç‰©ç†å†…å­˜ã€‚</li><li><strong>R-2:</strong> enclave ä¸å…è®¸è®¿é—®å±äº RustMonitor å’Œå…¶ä»– enclave çš„ç‰©ç†å†…å­˜ã€‚å®ƒè¢«è®¾è®¡ä¸ºåªèƒ½è®¿é—®ä¸éå¯ä¿¡åº”ç”¨ç¨‹åºå…±äº«çš„ç‰¹å®šå†…å­˜åŒºåŸŸä»¥è¿›è¡Œå‚æ•°ä¼ é€’ï¼ˆå³ç¼–ç»„ç¼“å†²åŒºï¼‰ã€‚</li><li><strong>R-3:</strong> ä¸å…è®¸æ¶æ„å¤–å›´è®¾å¤‡é€šè¿‡ DMA è®¿é—®å±äº RustMonitor å’Œ enclave çš„ç‰©ç†å†…å­˜ã€‚ä¸ºäº†é˜²æ­¢æ­¤ç±»æ”»å‡»ï¼ŒHyperEnclave åœ¨ç°ä»£å¤„ç†å™¨ä¸­åˆ©ç”¨è¾“å…¥è¾“å‡ºå†…å­˜ç®¡ç†å•å…ƒï¼ˆIOMMUï¼‰çš„æ”¯æŒæ¥é™åˆ¶å¤–å›´è®¾å¤‡ä½¿ç”¨çš„ç‰©ç†å†…å­˜ã€‚</li></ul><p><strong>å†…å­˜åŠ å¯†ã€‚</strong> ä¸ºäº†æŒ«è´¥ç‰©ç†å†…å­˜æ”»å‡»ï¼Œä¾‹å¦‚å†·å¯åŠ¨å’Œæ€»çº¿å—…æ¢æ”»å‡»ï¼ŒHyperEnclave å¯ä»¥åˆ©ç”¨ç¡¬ä»¶å†…å­˜åŠ å¯†ï¼ˆä¾‹å¦‚ AMD SME [44] å’Œ Intel MKTME [42]ï¼‰æ¥ä»¥é¡µé¢ç²’åº¦åŠ å¯†éƒ¨åˆ†ç‰©ç†å†…å­˜ã€‚å¦‚æœå¹³å°ä¸æ”¯æŒç¡¬ä»¶å†…å­˜åŠ å¯†ï¼ŒHyperEnclave å¯ä»¥è€ƒè™‘åº”ç”¨è½¯ä»¶æ–¹æ³• [76] æ¥åŠ å¯†éš”ç¦»çš„å†…å­˜ã€‚ç„¶è€Œï¼Œä¸åŸºäºç¡¬ä»¶çš„è§£å†³æ–¹æ¡ˆç›¸æ¯”ï¼Œè¿™ç§æ–¹æ³•å¯èƒ½ä¼šå¸¦æ¥å·¨å¤§çš„å¼€é”€ã€‚</p><h3 id="3-3-å¯ä¿¡å¯åŠ¨ã€è¯æ˜å’Œå°è£…"><a href="#3-3-å¯ä¿¡å¯åŠ¨ã€è¯æ˜å’Œå°è£…" class="headerlink" title="3.3 å¯ä¿¡å¯åŠ¨ã€è¯æ˜å’Œå°è£…"></a>3.3 å¯ä¿¡å¯åŠ¨ã€è¯æ˜å’Œå°è£…</h3><p><strong>åº¦é‡å»¶è¿Ÿå¯åŠ¨ã€‚</strong> HyperEnclave çš„å¯åŠ¨è¿‡ç¨‹å¦‚å›¾ 3 æ‰€ç¤ºã€‚ç³»ç»Ÿå¯åŠ¨æ—¶ï¼Œä¸€æ®µç§°ä¸ºæµ‹é‡æ ¸å¿ƒä¿¡ä»»æ ¹ï¼ˆCRTMï¼‰çš„é™æ€ä¸”ä¸å¯å˜çš„ä»£ç é¦–å…ˆæ‰§è¡Œï¼Œä»¥å¼•å¯¼æ„å»ºåç»­å›ºä»¶å’Œè½¯ä»¶çš„æµ‹é‡é“¾ï¼ŒåŒ…æ‹¬ BIOSã€grubã€ä¸»æ“ä½œç³»ç»Ÿå†…æ ¸å’Œ initramfsã€‚æµ‹é‡å€¼å­˜å‚¨åœ¨ TPM PCR ä¸­ï¼Œç”¨äºæ¯ä¸ªå¯åŠ¨ç»„ä»¶ï¼Œå› æ­¤ä»»ä½•ä¿®æ”¹éƒ½å°†åæ˜ åœ¨è¯æ˜ quote ä¸­ã€‚</p><p>ä¸ºäº†å‡å°‘æ¥è‡ªä¸»æ“ä½œç³»ç»Ÿçš„æ”»å‡»é¢ï¼Œæˆ‘ä»¬å°† RustMonitor é•œåƒæ”¾å…¥ initramfsã€‚å†…æ ¸æµ‹é‡ RustMonitor é•œåƒå¹¶å°†å€¼æ‰©å±•åˆ° TPM PCRï¼Œç„¶åå®ƒåœ¨æ—©æœŸç”¨æˆ·ç©ºé—´ä¸­å¯åŠ¨ RustMonitorï¼Œå³åœ¨ä»»ä½•ä¾èµ–äºç£ç›˜æ–‡ä»¶ç³»ç»Ÿçš„ç”¨æˆ·ç©ºé—´ç¨‹åºå¼€å§‹è¿è¡Œä¹‹å‰ã€‚ç»“åˆåº¦é‡å¯åŠ¨ï¼Œå®ƒç¡®ä¿äº† RustMonitor åŠ è½½æ—¶çš„è½¯ä»¶çŠ¶æ€æ˜¯å¯ä¿¡çš„ã€‚RustMonitor åŠ è½½åï¼Œæ‰§è¡Œåœ¨é¢„å®šä¹‰çš„å…¥å£ç‚¹ç»§ç»­ã€‚RustMonitor è®¾ç½®è‡ªå·±çš„è¿è¡Œä¸Šä¸‹æ–‡ï¼ˆå¦‚å †æ ˆã€é¡µè¡¨ã€IDT ç­‰ï¼‰å¹¶ä¸ºæ¯ä¸ª CPU å‡†å¤‡è™šæ‹Ÿ CPUï¼ˆvCPUï¼‰é…ç½®ã€‚ç„¶å RustMonitor å¯åŠ¨æ­£å¸¸è™šæ‹Ÿæœºå¹¶å°†ä¸»æ“ä½œç³»ç»Ÿé™çº§åˆ°æ­£å¸¸æ¨¡å¼ã€‚è¿”å›å†…æ ¸æ¨¡å—åï¼Œå†…æ ¸åœ¨æ­£å¸¸æ¨¡å¼ä¸‹ç»§ç»­å¯åŠ¨ï¼Œå¹¶ä¸”ä¸çŸ¥é“ RustMonitor çš„å­˜åœ¨ã€‚</p><p>HyperEnclave åº”ç”¨ä¸Šè¿°æ–¹æ³•ï¼ˆç§°ä¸º<strong>åº¦é‡å»¶è¿Ÿå¯åŠ¨</strong>ï¼‰ï¼Œä»¥ä¾¿ RustMonitor ä½œä¸ºç±»å‹-2 è™šæ‹Ÿæœºç®¡ç†ç¨‹åºï¼ˆå¦‚ KVMï¼‰åŠ è½½ï¼ŒåŒæ—¶ä½œä¸ºç±»å‹-1 è™šæ‹Ÿæœºç®¡ç†ç¨‹åºï¼ˆå¦‚ Xenï¼‰è¿è¡Œã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œåœ¨ä¸»æ“ä½œç³»ç»Ÿè¢«é™çº§åˆ°æ­£å¸¸æ¨¡å¼åï¼ŒRustMonitor ä¸å†éœ€è¦ä¿¡ä»»ä¸»æ“ä½œç³»ç»Ÿã€‚</p><p><strong>è¿œç¨‹è¯æ˜ã€‚</strong> é€šè¿‡åº¦é‡å»¶è¿Ÿå¯åŠ¨ï¼Œæ‰€æœ‰å¯åŠ¨çš„ç»„ä»¶éƒ½è¢«æµ‹é‡å¹¶æ‰©å±•åˆ° TPMã€‚åœ¨ RustMonitor å¯åŠ¨åï¼Œå®ƒéœ€è¦å°†ä¿¡ä»»æ‰©å±•åˆ° enclaveã€‚ä¸ºæ­¤ï¼ŒRustMonitor æ´¾ç”Ÿä¸€ä¸ªè¯æ˜å¯†é’¥å¯¹ï¼Œç”¨äºç­¾ç½² enclave æµ‹é‡å€¼ã€‚ç„¶å RustMonitor å°†æ´¾ç”Ÿçš„å…¬é’¥æ‰©å±•åˆ° TPM PCRï¼Œç§é’¥æ°¸è¿œä¸ä¼šç¦»å¼€å—å†…å­˜éš”ç¦»å’ŒåŠ å¯†ä¿æŠ¤çš„ RustMonitorã€‚</p><p>åœ¨ enclave åˆ›å»ºæœŸé—´ï¼Œæ·»åŠ åˆ° enclave çš„æ‰€æœ‰é¡µé¢ï¼ˆåŒ…æ‹¬ç›¸åº”çš„é¡µé¢å†…å®¹ã€é¡µé¢ç±»å‹å’Œ RWX æƒé™ï¼‰éƒ½ç”± RustMonitor æµ‹é‡ï¼Œä»¥ç”Ÿæˆ enclave æµ‹é‡å€¼ã€‚ï¼ˆä¸­é—´ï¼‰æµ‹é‡å€¼å­˜å‚¨åœ¨ RustMonitor çš„å†…å­˜ä¸­ï¼Œå¯¹ enclave å’Œä¸»æ“ä½œç³»ç»Ÿæ˜¯ä¸å¯è§çš„ã€‚</p><p>ä¸ TPM å’Œè‹±ç‰¹å°” SGX ç±»ä¼¼ï¼ŒHyperEnclave é‡‡ç”¨ SIGn-and-MAc (SIGMA) è¯æ˜åè®®è¿›è¡Œè¿œç¨‹è¯æ˜æµç¨‹ã€‚å¦‚å›¾ 4 æ‰€ç¤ºï¼Œæˆ‘ä»¬å°† RustMonitor çš„è¯æ˜å¯†é’¥çš„å…¬é’¥è¡¨ç¤ºä¸ºè™šæ‹Ÿæœºç®¡ç†ç¨‹åºè¯æ˜å…¬é’¥ï¼ˆhapkï¼‰ã€‚enclave æµ‹é‡å€¼ä½¿ç”¨ RustMonitor çš„è¯æ˜å¯†é’¥ç­¾åï¼Œå½¢æˆ enclave æµ‹é‡ç­¾åï¼ˆemsï¼‰ã€‚TPM quote <code>TMP_Quote</code>ï¼Œä½¿ç”¨ TPM è¯æ˜å¯†é’¥ç­¾åï¼ŒåŒ…æ‹¬æ‰€æœ‰å¯åŠ¨ä»£ç æµ‹é‡çš„ PCRsï¼Œä»¥åŠ hapk çš„æµ‹é‡å€¼ã€‚æ”¶åˆ°è¯æ˜æŠ¥å‘Šåï¼Œè¿œç¨‹ç”¨æˆ·å¯ä»¥é€šè¿‡æ¯”è¾ƒå¯åŠ¨ä»£ç ï¼ˆåŒ…æ‹¬ CRTMã€BIOSã€grubã€å†…æ ¸ã€initramfs å’Œè™šæ‹Ÿæœºç®¡ç†ç¨‹åºï¼‰å’Œ enclave çš„æµ‹é‡å€¼ï¼Œä»¥åŠéªŒè¯ç”Ÿæˆç­¾åçš„è¯ä¹¦é“¾æ¥éªŒè¯æŠ¥å‘Šã€‚</p><p><strong>å¯†é’¥ç”Ÿæˆã€‚</strong> å½“ RustMonitor é¦–æ¬¡åˆå§‹åŒ–æ—¶ï¼Œå®ƒä» TPM çš„éšæœºæ•°ç”Ÿæˆå™¨ï¼ˆRNGï¼‰æ¨¡å—ç”Ÿæˆä¸€ä¸ªæ ¹å¯†é’¥ <code>Kroot</code>ã€‚<code>Kroot</code> ä½¿ç”¨ TPM çš„å°è£…æ“ä½œå­˜å‚¨åœ¨ TPM ä¹‹å¤–ã€‚åœ¨ç³»ç»Ÿé‡ç½®çš„å¯åŠ¨è¿‡ç¨‹ä¸­ï¼ŒRustMonitor ä½¿ç”¨ TPM çš„è§£å°æ“ä½œè§£å¯† <code>Kroot</code>ï¼Œè¿™ä¿è¯äº† <code>Kroot</code> åªèƒ½åœ¨å®Œå…¨ç›¸åŒçš„ TPM èŠ¯ç‰‡å’ŒåŒ¹é…çš„ PCR é…ç½®ä¸‹è¢«è§£å°ã€‚æ­¤å¤–ï¼Œåœ¨å°†æ§åˆ¶æƒè½¬ç§»ç»™ä¸»æ“ä½œç³»ç»Ÿä¹‹å‰ï¼ŒRustMonitor ç”¨ä¸€ä¸ªå¸¸é‡å¡«å…… PCRsï¼Œä»¥é˜²æ­¢å…¶æ£€ç´¢ <code>Kroot</code>ã€‚æ‰€æœ‰å…¶ä»–å¯†é’¥ææ–™ï¼ŒåŒ…æ‹¬ enclave çš„å°è£…å¯†é’¥å’ŒæŠ¥å‘Šå¯†é’¥ï¼Œéƒ½ç”± <code>Kroot</code> å’Œ enclave çš„æµ‹é‡å€¼æ´¾ç”Ÿè€Œæ¥ã€‚</p><h3 id="3-4-Enclave-SDK"><a href="#3-4-Enclave-SDK" class="headerlink" title="3.4 Enclave SDK"></a>3.4 Enclave SDK</h3><p>å°†ç°æœ‰åº”ç”¨ç¨‹åºç§»æ¤åˆ° enclave ä¸­å¯èƒ½å¾ˆéº»çƒ¦ï¼Œå› ä¸º TEE é€šå¸¸æš´éœ²æœ‰é™çš„ç¡¬ä»¶å’Œè½¯ä»¶æ¥å£ï¼Œå¹¶æä¾›é¢å¤–çš„å®‰å…¨æœåŠ¡ï¼ˆä¾‹å¦‚ï¼Œè¯æ˜å’Œå°è£…ï¼‰ã€‚å¯¹äºåŸºäºè¿›ç¨‹çš„ TEEï¼Œåº”ç”¨ç¨‹åºéœ€è¦è¢«åˆ’åˆ†ä¸ºå¯ä¿¡å’Œéå¯ä¿¡éƒ¨åˆ†ï¼Œå¹¶ä¸”éœ€è¦ä»”ç»†è®¾è®¡æ¥å£ä»¥é¿å…å„ç§å®‰å…¨é™·é˜± [27, 46, 69]ã€‚ç”±äºè‹±ç‰¹å°” SGX åœ¨å¸‚åœºä¸Šçš„ä¸»å¯¼åœ°ä½ï¼Œå·²ç»æŠ•å…¥äº†å¤§é‡ç²¾åŠ›å¹¶å¼€å‘äº†è®¸å¤šå·¥å…·ï¼ŒåŒ…æ‹¬åº“æ“ä½œç³»ç»Ÿ [64, 67]ã€å®¹å™¨ [18]ã€è‡ªåŠ¨åˆ†åŒºå’Œä¿æŠ¤å·¥å…· [50, 68]ã€WebAssembly å¾®è¿è¡Œæ—¶ [57] å’Œæ¥å£ä¿æŠ¤ [65]ã€‚å› æ­¤ï¼Œè‹±ç‰¹å°” SGX å·²ç»æ”¯æŒå®‰å…¨åœ°è¿è¡Œç”¨ C&#x2F;C++ã€Rustã€Javaã€Python ç­‰ç¼–å†™çš„åº”ç”¨ç¨‹åºï¼Œè€Œæ— éœ€æ˜‚è´µçš„ä»£ç é‡æ„ã€‚</p><p>æˆ‘ä»¬æä¾›çš„ enclave SDK çš„ API ä¸å®˜æ–¹è‹±ç‰¹å°” SGX SDK å…¼å®¹ï¼Œä»¥ç®€åŒ–åœ¨ HyperEnclave ä¸Šçš„åº”ç”¨ç¨‹åºå¼€å‘ã€‚enclave SDK æ˜¯å¯¹å®˜æ–¹ SGX SDK çš„æ”¹é€ ã€‚é€šè¿‡ç”¨ hypercall æ›¿æ¢ SGX ç”¨æˆ·å¶å‡½æ•°ï¼ˆä¾‹å¦‚ï¼ŒEENTERã€EEXIT å’Œ ERESUMEï¼‰ï¼ŒSGX ç¨‹åºå¯ä»¥åœ¨ HyperEnclave ä¸Šè¿è¡Œï¼Œåªéœ€å¾ˆå°‘æˆ–æ²¡æœ‰æºä»£ç æ›´æ”¹ã€‚ä¸€æ—¦ enclave æ‰§è¡Œè¿™äº›ç”¨æˆ·å¶å‡½æ•°ï¼Œå®ƒå°±ä¼šé™·å…¥ RustMonitorï¼ŒRustMonitor ä¼šæ¨¡æ‹Ÿç›¸åº” SGX æŒ‡ä»¤çš„åŠŸèƒ½ã€‚</p><p>enclave è¢«ç¼–è¯‘ä¸ºåº”ç”¨ç¨‹åºçš„å¯ä¿¡åº“ï¼Œè€Œåº”ç”¨ç¨‹åºæœ¬èº«åœ¨ä¸»æ“ä½œç³»ç»Ÿä¸­è¿è¡Œã€‚enclave çš„ç”Ÿå‘½å‘¨æœŸé€šè¿‡æ¨¡æ‹Ÿä¸€ç»„ç‰¹æƒ SGX æŒ‡ä»¤ï¼ˆå³ ECREATEã€EADDã€EINIT ç­‰ï¼‰æ¥ç®¡ç†ã€‚ä¸ºæ­¤ï¼Œåœ¨ä¸»æ“ä½œç³»ç»Ÿä¸­è¿è¡Œçš„å†…æ ¸æ¨¡å—é€šè¿‡è°ƒç”¨ RustMonitor çš„ hypercall æ¥æä¾›ç±»ä¼¼çš„åŠŸèƒ½ï¼Œå¹¶é€šè¿‡ <code>ioctl()</code> æ¥å£å‘åº”ç”¨ç¨‹åºå…¬å¼€è¿™äº›åŠŸèƒ½ã€‚é€šè¿‡æ¨¡æ‹Ÿç‰¹æƒ SGX æŒ‡ä»¤ï¼ŒRustMonitor è´Ÿè´£ enclave ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆç¬¬ 4 èŠ‚ï¼‰ã€‚</p><p>ä¸ºäº†ä¸å®˜æ–¹è‹±ç‰¹å°” SGX SDK å…¼å®¹ï¼ŒHyperEnclave ä¸­æ¶‰åŠçš„å¤§å¤šæ•°æ•°æ®ç»“æ„ï¼ˆä¾‹å¦‚ SIGSTRUCT ç»“æ„ã€SECS é¡µé¢å’Œ TCS é¡µé¢ï¼‰éƒ½ä¸ SGX ç›¸ä¼¼ã€‚é€šè¿‡ HyperEnclave çš„è®¾è®¡ï¼Œåœ¨ enclave ä¸­æ”¯æŒåŠ¨æ€ enclave ç®¡ç†éå¸¸ç›´æ¥ï¼Œå› ä¸º enclave å†…å­˜å’Œé¡µé”™è¯¯éƒ½ç”± RustMonitor ç®¡ç†ã€‚é€šè¿‡ä¸º enclave ä¸­çš„æ¯ä¸ªçº¿ç¨‹å…³è”ä¸€ä¸ª TCS é¡µé¢æ¥æ”¯æŒ enclave å†…çš„å¤šçº¿ç¨‹ã€‚é€šè¿‡ä¸ºæ¯ä¸ª TCS è®¾ç½®è¶…è¿‡ 1 ä¸ª SSA é¡µé¢æ¥æ”¯æŒ enclave å†…çš„å¼‚å¸¸å¤„ç†ã€‚ç”±äºç©ºé—´é™åˆ¶ï¼Œç»†èŠ‚è¢«çœç•¥ï¼Œæˆ‘ä»¬å»ºè®®è¯»è€…å‚è€ƒ SGX æ‰‹å†Œ [11] ä»¥è·å–æ›´å¤šç»†èŠ‚ã€‚</p><h2 id="4-çµæ´»çš„-Enclave-æ“ä½œæ¨¡å¼"><a href="#4-çµæ´»çš„-Enclave-æ“ä½œæ¨¡å¼" class="headerlink" title="4 çµæ´»çš„ Enclave æ“ä½œæ¨¡å¼"></a>4 çµæ´»çš„ Enclave æ“ä½œæ¨¡å¼</h2><p>ç°æœ‰çš„å¤§é‡åº”ç”¨ç¨‹åºå¯ä»¥è¢«å¸è½½åˆ° TEE ä¸­ï¼Œä¾‹å¦‚è®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼ˆæœºå™¨å­¦ä¹  [60]ï¼‰ã€è¾“å…¥è¾“å‡ºï¼ˆIOï¼‰å¯†é›†å‹ä»»åŠ¡ï¼ˆå¦‚ Apache å’Œ Nginx Web æœåŠ¡å™¨ [18]ï¼‰ã€å†…å­˜å¯†é›†å‹ä»»åŠ¡ï¼ˆRedis å’Œ Memcached [18]ï¼‰ï¼Œä»¥åŠåå¥½åœ¨ enclave å†…è¿›è¡Œå¼‚å¸¸å¤„ç†å’Œç‰¹æƒåˆ†ç¦»çš„ä»»åŠ¡ [21]ã€‚å¤§å¤šæ•° TEE åªæ”¯æŒåœ¨å›ºå®šæ¨¡å¼ä¸‹è¿è¡Œ enclaveï¼Œç‰¹åˆ«æ˜¯è‹±ç‰¹å°” SGXï¼ˆä»¥åŠ TrustVisor [54] å’Œ Secage [51]ï¼‰enclaveï¼Œä½œä¸ºåº”ç”¨ç¨‹åºåœ°å€ç©ºé—´çš„ä¸€éƒ¨åˆ†ï¼Œåœ¨ç”¨æˆ·æ¨¡å¼ä¸‹è¿è¡Œã€‚å› æ­¤ï¼Œç”¨æˆ·æ¨¡å¼ enclave ä¸å…è®¸è®¿é—®ç‰¹æƒèµ„æºï¼ˆå¦‚ IDT å’Œé¡µè¡¨ï¼‰å’Œå¤„ç†ç‰¹æƒäº‹ä»¶ï¼ˆä¸­æ–­å’Œå¼‚å¸¸ï¼‰ã€‚å®ƒå¿…é¡»åˆ‡æ¢åˆ°éå¯ä¿¡ä»£ç æ‰èƒ½è®¿é—®ç‰¹æƒèµ„æºå’Œå¤„ç†äº‹ä»¶ã€‚IO å¯†é›†å‹å’Œå†…å­˜å¯†é›†å‹ä»»åŠ¡åŸºæœ¬ä¸Šæ¶‰åŠé¢‘ç¹çš„ world switchï¼Œè¿™äº›åˆ‡æ¢æ˜¯æ˜‚è´µçš„ï¼Œå¹¶å¼•å…¥äº†ä¸å¯å¿½ç•¥çš„æ€§èƒ½æŸå¤±ï¼Œå°½ç®¡å·²ç»æå‡ºäº†è½¯ä»¶å’Œç¡¬ä»¶ä¼˜åŒ–æ¥å°è¯•å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢å»¶è¿Ÿ [61, 66, 73]ã€‚åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä»‹ç» HyperEnclave æ”¯æŒçš„ä¸‰ç§ enclave æ“ä½œæ¨¡å¼ï¼Œå¦‚å›¾ 5 æ‰€ç¤ºã€‚ä¸åŒ enclave æ“ä½œæ¨¡å¼ä¸‹çš„ world switch å¦‚å›¾ 6 æ‰€ç¤ºã€‚</p><p><strong>å›¾ 5ï¼šåŸºäºè¿›ç¨‹çš„ TEE æ”¯æŒçš„ enclave æ“ä½œæ¨¡å¼æ¯”è¾ƒã€‚</strong> (a) è‹±ç‰¹å°” SGX åœ¨ä¸»æœºç”¨æˆ·æ¨¡å¼ï¼ˆæˆ–è™šæ‹ŸåŒ–ç¯å¢ƒä¸­çš„å®¢æˆ·æœºç”¨æˆ·æ¨¡å¼ï¼‰ä¸‹è¿è¡Œ enclaveã€‚(b) TrustVisor åœ¨å®¢æˆ·æœºç”¨æˆ·æ¨¡å¼ä¸‹è¿è¡Œå—ä¿æŠ¤çš„ä»£ç ï¼ˆåº”ç”¨ç¨‹åºé€»è¾‘ç‰‡æ®µï¼ŒPALsï¼‰ã€‚(c) HyperEnclave æ”¯æŒ 3 ç§å…±å­˜çš„ enclave æ“ä½œæ¨¡å¼ï¼šâ‘  åœ¨å®¢æˆ·æœºç”¨æˆ·æ¨¡å¼ä¸‹è¿è¡Œçš„ GU-Enclavesï¼›â‘¡ åœ¨å®¢æˆ·æœºç‰¹æƒæ¨¡å¼å’Œå¯é€‰çš„å®¢æˆ·æœºç”¨æˆ·æ¨¡å¼ä¸‹è¿è¡Œçš„ P-Enclavesï¼›â‘¢ åœ¨ä¸»æœºç”¨æˆ·æ¨¡å¼ä¸‹è¿è¡Œçš„ HU-Enclavesã€‚</p><h3 id="4-1-å®¢æˆ·æœºç”¨æˆ·-Enclaves"><a href="#4-1-å®¢æˆ·æœºç”¨æˆ·-Enclaves" class="headerlink" title="4.1 å®¢æˆ·æœºç”¨æˆ· Enclaves"></a>4.1 å®¢æˆ·æœºç”¨æˆ· Enclaves</h3><p>å®¢æˆ·æœºç”¨æˆ· enclave (GU-Enclave) æ˜¯åŸºæœ¬çš„ enclave æ“ä½œæ¨¡å¼ï¼Œé€šå¸¸è¿è¡Œè®¡ç®—å¯†é›†å‹ä»»åŠ¡ã€‚enclave åœ¨å®¢æˆ·æœºç”¨æˆ·æ¨¡å¼ä¸‹è¿è¡Œï¼ˆå³ VMX non-root æ“ä½œæ¨¡å¼çš„å®¢æˆ·æœº ring-3ï¼‰ã€‚</p><p>åœ¨ enclave åˆ›å»ºæœŸé—´ï¼ŒRustMonitor å‡†å¤‡ä¸€ä¸ª vCPU ç»“æ„ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªå®¢æˆ·æœºé¡µè¡¨ï¼ˆGPTï¼‰å’Œä¸€ä¸ªç”¨äº GU-Enclave çš„åµŒå¥—é¡µè¡¨ï¼ˆNPTï¼‰ã€‚åœ¨æ­£å¸¸è™šæ‹Ÿæœºå’Œ enclave è™šæ‹Ÿæœºä¹‹é—´è¿›å…¥å’Œé€€å‡ºæ—¶ï¼ŒRustMonitor ä¼šç›¸åº”åœ°åˆ‡æ¢ vCPU çŠ¶æ€ï¼ˆä¾‹å¦‚æŒ‡ä»¤æŒ‡é’ˆã€çº¿ç¨‹æŒ‡é’ˆã€NPT å’Œ GPTï¼‰ã€‚</p><p>ä¸ºäº†å¤„ç† enclave è¿è¡ŒæœŸé—´çš„ä¸­æ–­å’Œå¼‚å¸¸ï¼ŒRustMonitor é…ç½® vCPU ä»¥å°†æ‰€æœ‰ä¸­æ–­å’Œå¼‚å¸¸é™·å…¥ç›‘è§†å™¨æ¨¡å¼ã€‚ç„¶å RustMonitor ä¿å­˜ enclave çš„ä¸Šä¸‹æ–‡ï¼Œå°†ä¸­æ–­æˆ–å¼‚å¸¸è½¬å‘åˆ°æ­£å¸¸è™šæ‹Ÿæœºã€‚åœ¨ä¸»æ“ä½œç³»ç»Ÿå®Œæˆå¤„ç†ä¸­æ–­æˆ–å¼‚å¸¸åï¼Œåº”ç”¨ç¨‹åºè°ƒç”¨ ERESUME hypercallï¼Œè¯¥ hypercall é™·å…¥ RustMonitor ä»¥æ¢å¤ enclave çš„ä¸Šä¸‹æ–‡å¹¶ç»§ç»­æ‰§è¡Œ enclaveã€‚</p><h3 id="4-2-ä¸»æœºç”¨æˆ·-Enclaves"><a href="#4-2-ä¸»æœºç”¨æˆ·-Enclaves" class="headerlink" title="4.2 ä¸»æœºç”¨æˆ· Enclaves"></a>4.2 ä¸»æœºç”¨æˆ· Enclaves</h3><p>ä¸»æœºç”¨æˆ· enclave (HU-Enclave) åœ¨ä¸»æœºç”¨æˆ·æ¨¡å¼ä¸‹è¿è¡Œã€‚å®ƒé€šè¿‡ç”¨ç¯åˆ‡æ¢ï¼ˆsyscallsï¼šåœ¨æˆ‘ä»¬çš„å¹³å°ä¸Šçº¦ 120 ä¸ª CPU å‘¨æœŸï¼‰æ›¿ä»£æ¨¡å¼åˆ‡æ¢ï¼ˆhypercallsï¼šåœ¨æˆ‘ä»¬çš„å¹³å°ä¸Šçº¦ 880 ä¸ª CPU å‘¨æœŸï¼‰æ¥æä¾›æœ€ä½³çš„ world switch æ•ˆç‡ï¼ˆå›¾ 6ï¼‰ã€‚å®ƒè¿›ä¸€æ­¥æ¶ˆé™¤äº† GU-Enclave ä¸­çš„é¢å¤–è™šæ‹ŸåŒ–å¼€é”€ï¼ˆä¾‹å¦‚ vCPU ä¸Šä¸‹æ–‡åˆ‡æ¢å’ŒäºŒç»´é¡µè¡¨éå†ï¼‰ã€‚æ ¹æ®æˆ‘ä»¬åœ¨ç¬¬ 7 èŠ‚çš„è¯„ä¼°ï¼ŒHU-Enclave å¯èƒ½æœ‰åˆ©äº I&#x2F;O å¯†é›†å‹å·¥ä½œè´Ÿè½½ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œåœ¨å®¢æˆ·æœºç”¨æˆ·æ¨¡å¼ä¸‹è¿è¡Œ enclave æä¾›äº†æ›´æ·±çš„é˜²å¾¡å±‚æ¬¡ã€‚</p><p>åŠ è½½ HU-Enclave æ—¶ï¼ŒRustMonitor å‡†å¤‡ä¸€ä¸ªè¿›ç¨‹ä¸Šä¸‹æ–‡ï¼Œä¾‹å¦‚åˆ›å»ºä¸€ä¸ª 1 çº§é¡µè¡¨ã€‚åœ¨ enclave è¿›å…¥æ—¶ï¼ŒRustMonitor æ›´æ–° CPU çŠ¶æ€å¹¶è°ƒç”¨ç³»ç»Ÿè°ƒç”¨è¿”å›æŒ‡ä»¤ï¼ˆå³ x86 å¹³å°ä¸Šçš„ SYSRETï¼‰ä»¥è¿›å…¥ HU-Enclaveã€‚ç›¸åº”åœ°ï¼Œåœ¨ enclave é€€å‡ºæ—¶ï¼ŒHU-Enclave è°ƒç”¨ç³»ç»Ÿè°ƒç”¨æŒ‡ä»¤ï¼ˆå³ x86 å¹³å°ä¸Šçš„ SYSCALLï¼‰å¹¶é™·å…¥ RustMonitorã€‚ENCLU å¶æŒ‡ä»¤ï¼ˆä¾‹å¦‚ï¼ŒEGETKEYã€EREPORTï¼‰è¢«æ¨¡æ‹Ÿä¸ºç³»ç»Ÿè°ƒç”¨ã€‚HU-Enclaves å†…çš„ä¸­æ–­å’Œå¼‚å¸¸ä¹Ÿä¼šé™·å…¥ RustMonitorã€‚å…¶è¿‡ç¨‹ä¸ç¬¬ 4.1 èŠ‚ä¸­æè¿°çš„ GU-Enclaves ç›¸ä¼¼ã€‚</p><p><strong>å›¾ 6ï¼šæ”¯æŒçš„ enclave æ“ä½œæ¨¡å¼çš„ world switchã€‚</strong> (a) ä½¿ç”¨ hypercall è¿›å…¥å’Œé€€å‡º GU-Enclave å’Œ P-Enclaveã€‚(b) ä½¿ç”¨ syscall å’Œ syscall è¿”å›è¿›å…¥å’Œé€€å‡º HU-Enclaveã€‚</p><h3 id="4-3-ç‰¹æƒ-Enclaves"><a href="#4-3-ç‰¹æƒ-Enclaves" class="headerlink" title="4.3 ç‰¹æƒ Enclaves"></a>4.3 ç‰¹æƒ Enclaves</h3><p>å—åŸºäº VM çš„ TEEï¼ˆå¦‚ AMD SEV [45]ï¼‰çš„å¯å‘ï¼ŒHyperEnclave æ”¯æŒåœ¨å®¢æˆ·æœºç‰¹æƒæ¨¡å¼ä¸‹è¿è¡Œçš„ç‰¹æƒ enclave (P-Enclaves)ã€‚P-Enclave è¢«å…è®¸è®¿é—® GDTã€IDT å’Œ 1 çº§é¡µè¡¨ï¼Œè¿™æœ‰åˆ©äºå„ç§åº”ç”¨ï¼Œå¦‚ Dune [21] æ‰€ç¤ºã€‚ä¸€ä¸ªè¿™æ ·çš„ä¾‹å­æ˜¯åƒåœ¾æ”¶é›†å™¨ï¼Œå®ƒæ˜¯ Java åº”ç”¨ç¨‹åºçš„ä¸€ä¸ªåŸºæœ¬ç‰¹æ€§ï¼ˆç°æœ‰å·¥ä½œå°† JVM ç§»æ¤åˆ° enclave [26, 43]ï¼‰ã€‚åƒåœ¾æ”¶é›†å™¨é¢‘ç¹æ›´æ”¹é¡µé¢æƒé™ä»¥è§¦å‘é¡µé”™è¯¯ï¼Œä»¥ä¾¿è·Ÿè¸ªé¡µé¢çŠ¶æ€ã€‚å¯¹äºç”¨æˆ·æ¨¡å¼ enclaveï¼ˆä¾‹å¦‚ï¼ŒGU-Enclaves å’Œ HU-Enclavesï¼‰ï¼Œå®ƒå¿…é¡»æ¶‰åŠä¸»æ“ä½œç³»ç»Ÿæ¥æ›´æ–°é¡µè¡¨å’Œå¤„ç†é¡µé”™è¯¯ï¼Œè¿™ç”±äº world switch è€Œé­å—å·¨å¤§çš„æ€§èƒ½æŸå¤±ã€‚P-Enclaves é€šè¿‡æ”¯æŒ enclave å†…å¼‚å¸¸å¤„ç†å’Œ 1 çº§é¡µè¡¨ç®¡ç†æ¥æ¶ˆé™¤ world switchã€‚æ›´å…·ä½“åœ°è¯´ï¼ŒP-Enclaves é…ç½®è‡ªå·±çš„å¼‚å¸¸å¤„ç†ç¨‹åºæ¥å¤„ç†æŸäº›å¼‚å¸¸ï¼ˆå¦‚é¡µé”™è¯¯ï¼‰ã€‚RustMonitor å°†ç™½åå•ä¸­çš„å¼‚å¸¸ä¼ é€’ç»™ P-Enclaveï¼Œå¹¶å°†å…¶ä»–å¼‚å¸¸è½¬å‘ç»™ä¸»æ“ä½œç³»ç»Ÿã€‚æ­¤å¤–ï¼ŒP-Enclaves è¿˜å¯ä»¥æ”¯æŒåŸºäºé¡µè¡¨çš„ enclave å†…éš”ç¦»æ–¹æ¡ˆï¼Œä¾‹å¦‚ï¼Œæ²™ç®±åŒ–éå¯ä¿¡çš„ç¬¬ä¸‰æ–¹åº“ã€‚</p><p>ç”±äºèƒ½å¤Ÿåœ¨ enclave å†…æ¥æ”¶ä¸­æ–­ï¼ŒP-Enclaves è¿˜å¯ä»¥é€šè¿‡è®¡ç®—é¢‘ç‡æ¥æ£€æµ‹å¼‚å¸¸ä¸­æ–­äº‹ä»¶ï¼Œç„¶åè¯·æ±‚ RustMonitor å°†å®ƒä»¬è·¯ç”±åˆ°ä¸»æ“ä½œç³»ç»Ÿã€‚å› æ­¤ï¼Œå¯ä»¥æ£€æµ‹å’Œå‡è½»ç°æœ‰çš„åŸºäºä¸­æ–­çš„ä¾§ä¿¡é“æ”»å‡» [24, 37, 40, 58, 59, 70]ã€‚ç”±äºç©ºé—´é™åˆ¶ï¼Œæˆ‘ä»¬æŠŠå¯¹è¿™æ–¹é¢çš„è¿›ä¸€æ­¥æ¢ç´¢ç•™ç»™æœªæ¥çš„å·¥ä½œã€‚</p><h2 id="5-å®ç°"><a href="#5-å®ç°" class="headerlink" title="5 å®ç°"></a>5 å®ç°</h2><p>æˆ‘ä»¬æŠ¥å‘Šäº†æˆ‘ä»¬åœ¨æ”¯æŒç¡¬ä»¶è™šæ‹ŸåŒ–æŠ€æœ¯å’Œå†…å­˜åŠ å¯†çš„ AMD å¹³å°ä¸Šå®ç° HyperEnclave çš„æƒ…å†µã€‚åœ¨å½“å‰å®ç°ä¸­ï¼ŒRustMonitor åŒ…å«çº¦ 7,500 è¡Œä¸»è¦ç”¨ Rust ç¼–å†™çš„ä»£ç ï¼Œä¸»æ“ä½œç³»ç»Ÿçš„å†…æ ¸æ¨¡å—æœ‰çº¦ 3,500 è¡Œ C ä»£ç ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬å¯¹å®˜æ–¹è‹±ç‰¹å°” SGX SDKï¼ˆç‰ˆæœ¬ 2.13ï¼‰è¿›è¡Œäº†çº¦ 2,000 è¡Œä»£ç çš„æ›´æ”¹ã€‚</p><h3 id="5-1-RustMonitor"><a href="#5-1-RustMonitor" class="headerlink" title="5.1 RustMonitor"></a>5.1 RustMonitor</h3><p>RustMonitor è¿è¡Œåœ¨æœ€é«˜ç‰¹æƒçº§åˆ«ï¼Œå¹¶ä¸º enclave å¼ºåˆ¶æ‰§è¡Œéš”ç¦»ã€‚ä¸ºäº†å‡å°‘ç”±å†…å­˜æŸåæˆ–å¹¶å‘é”™è¯¯å¼•èµ·çš„é£é™©ï¼Œæˆ‘ä»¬ä¸»è¦ç”¨å†…å­˜å®‰å…¨çš„è¯­è¨€ Rust å®ç°äº† RustMonitorï¼Œåªæœ‰å‡ è¡Œæ±‡ç¼–ä»£ç ç”¨äºä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚ä¸ç°æœ‰çš„è™šæ‹Ÿæœºç®¡ç†ç¨‹åºå¦‚ KVM [47] å’Œ Xen [29] ç›¸æ¯”ï¼ŒRustMonitor å°å¾—å¤šï¼Œå› æ­¤æ›´å®¹æ˜“è¿›è¡Œå½¢å¼åŒ–éªŒè¯ã€‚æˆ‘ä»¬æ­£åœ¨è¿›è¡Œ RustMonitor çš„å½¢å¼åŒ–éªŒè¯ï¼Œå¹¶è®¡åˆ’å°†ç»“æœä½œä¸ºå•ç‹¬çš„æŠ¥å‘Šå‘å¸ƒã€‚</p><p>å¹³å°å¯åŠ¨æ—¶ï¼Œæˆ‘ä»¬åœ¨ grub ä¸­é…ç½®å†…æ ¸å‘½ä»¤è¡Œå‚æ•°ä»¥ä¿ç•™ç‰©ç†å†…å­˜åŒºåŸŸï¼Œè¿™äº›åŒºåŸŸä¸“ä¾› RustMonitor å’Œ enclave ä½¿ç”¨ã€‚RustMonitor é€šè¿‡ç»´æŠ¤ä¸€ä¸ªç©ºé—²é¡µé¢åˆ—è¡¨æ¥ç®¡ç†ä¿ç•™çš„ç‰©ç†å†…å­˜ã€‚å½“éœ€è¦ä¸€ä¸ª enclave é¡µé¢æ—¶ï¼Œä¾‹å¦‚ï¼Œåœ¨ enclave åˆ›å»ºæœŸé—´æ·»åŠ ä¸€ä¸ª enclave é¡µé¢æ—¶ï¼Œä»æ± ä¸­æ£€ç´¢ä¸€ä¸ªç©ºé—²é¡µé¢ï¼›å½“ enclave é¡µé¢è¢«é‡Šæ”¾æ—¶ï¼Œè¯¥é¡µé¢å†æ¬¡é™„åŠ åˆ°åˆ—è¡¨ä¸­ã€‚æ­¤å¤–ï¼ŒRustMonitor è¿˜ç®¡ç† enclave çš„é¡µè¡¨å¹¶å¤„ç†é¡µé”™è¯¯ã€‚</p><h3 id="5-2-å†…æ ¸æ¨¡å—"><a href="#5-2-å†…æ ¸æ¨¡å—" class="headerlink" title="5.2 å†…æ ¸æ¨¡å—"></a>5.2 å†…æ ¸æ¨¡å—</h3><p>å†…æ ¸æ¨¡å—åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ç”±ä¸»æ“ä½œç³»ç»ŸåŠ è½½ã€‚ç„¶åå®ƒåŠ è½½ã€åº¦é‡å’Œå¯åŠ¨ RustMonitorï¼Œå¹¶å°†æµ‹é‡å€¼ä½œä¸º TPM quote çš„ä¸€éƒ¨åˆ†æ‰©å±•åˆ° TPM PCRã€‚å†…æ ¸æ¨¡å—åŠ è½½åï¼Œä¼šåˆ›å»ºä¸€ä¸ªè®¾å¤‡æ–‡ä»¶å¹¶æŒ‚è½½åœ¨ <code>/dev/hyper_enclave</code>ã€‚åº”ç”¨ç¨‹åºå¯ä»¥æ‰“å¼€å®ƒå¹¶é€šè¿‡ <code>ioctl()</code> è°ƒç”¨æ¥è°ƒç”¨æ¨¡æ‹Ÿçš„ç‰¹æƒæ“ä½œã€‚</p><h3 id="5-3-Enclave-SDK"><a href="#5-3-Enclave-SDK" class="headerlink" title="5.3 Enclave SDK"></a>5.3 Enclave SDK</h3><p>HyperEnclave å¯¹å®˜æ–¹ SGX SDK è¿›è¡Œäº†å¦‚ä¸‹æ”¹é€ ã€‚</p><p><strong>æ”¯æŒ SGX SDK APIã€‚</strong> æˆ‘ä»¬ç”¨ hypercall æˆ–ç³»ç»Ÿè°ƒç”¨æ›¿æ¢äº† SGX SDK ä¸­çš„ SGX ç”¨æˆ·å¶å‡½æ•°ï¼ˆä¾‹å¦‚ EENTERã€EEXITã€ERESUME ç­‰ï¼‰ã€‚ä¸ºäº†å…¼å®¹æ€§ï¼Œæˆ‘ä»¬çš„å®ç°ä¿ç•™äº†ä¸ SGX ç›¸åŒçš„å‚æ•°è¯­ä¹‰å’Œé¡ºåºã€‚</p><p><strong>é€šè¿‡ç¼–ç»„ç¼“å†²åŒºè¿›è¡Œå‚æ•°ä¼ é€’ã€‚</strong> åœ¨ HyperEnclave ä¸­ï¼Œenclave åªèƒ½è®¿é—®è‡ªå·±çš„åœ°å€ç©ºé—´å’Œä¸åº”ç”¨ç¨‹åºå…±äº«çš„ç¼–ç»„ç¼“å†²åŒºã€‚ç¼–ç»„ç¼“å†²åŒºçš„å¤§å°å¯ä»¥åœ¨ enclave çš„é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼Œæœ‰é»˜è®¤å¤§å°ã€‚åœ¨è°ƒç”¨è¾¹ç¼˜è°ƒç”¨ä¹‹å‰ï¼Œæ•°æ®éœ€è¦è¢«ä¼ è¾“åˆ°ç¼–ç»„ç¼“å†²åŒºã€‚æˆ‘ä»¬ä¿®æ”¹äº† SGX SDK æ¥å¤„ç†è¿™äº›è½¬æ¢ï¼Œå› æ­¤å¯¹å¼€å‘è€…æ˜¯é€æ˜çš„ã€‚</p><p>æˆ‘ä»¬ä¿®æ”¹äº† SDK ä¸­çš„éå¯ä¿¡è¿è¡Œæ—¶åº“ï¼ˆå³ <code>libsgx_urts.so</code>ï¼‰ï¼Œä»¥ä¾¿åœ¨ enclave åˆå§‹åŒ–æœŸé—´ä½¿ç”¨ <code>mmap()</code> å’Œ <code>MAP_POPULATE</code> æ ‡å¿—åˆ†é…ä¸€ä¸ªç¼–ç»„ç¼“å†²åŒºã€‚å› æ­¤ï¼Œç¼–ç»„ç¼“å†²åŒºçš„ GPA è¢«é¢„å¡«å……ã€‚ç„¶åå‘å‡ºä¸€ä¸ª <code>ioctl()</code> è¯·æ±‚ä¸»æ“ä½œç³»ç»Ÿåœ¨ enclave çš„ç”Ÿå‘½å‘¨æœŸå†…ä¸è¦å‹ç¼©æˆ–æ¢å‡ºç¼–ç»„ç¼“å†²åŒºçš„ç‰©ç†é¡µé¢ã€‚å½“åº”ç”¨ç¨‹åºè°ƒç”¨æ¨¡æ‹Ÿçš„ EINIT æŒ‡ä»¤æ¥æ ‡è®° enclave çš„åˆå§‹åŒ–æ—¶ï¼Œç¼–ç»„ç¼“å†²åŒºçš„åŸºåœ°å€å’Œå¤§å°è¢«ä¼ é€’ç»™ RustMonitorï¼ŒRustMonitor ä¼šåœ¨ enclave çš„é¡µè¡¨ä¸­æ·»åŠ ç¼–ç»„ç¼“å†²åŒºçš„æ˜ å°„ã€‚è¿™æ ·ï¼Œç¼–ç»„ç¼“å†²åŒºç°åœ¨åœ¨ enclave å’Œéå¯ä¿¡åº”ç”¨ç¨‹åºä¹‹é—´å…±äº«ã€‚ç¼–ç»„ç¼“å†²åŒºçš„åŸºåœ°å€å’Œå¤§å°ä¹Ÿè¢«ä¼ é€’ç»™å¯ä¿¡è¿è¡Œæ—¶åº“ï¼Œä»¥ä¾¿å°†æ•°æ®ä»ç¼–ç»„ç¼“å†²åŒºä¼ è¾“åˆ° enclaveã€‚</p><p>å½“å‰ SGX SDK ä¸­çš„ OCALL å®ç°æ˜¯åœ¨ enclave å†…éƒ¨è°ƒç”¨ <code>sgx_ocalloc()</code>ï¼Œåœ¨éå¯ä¿¡åº”ç”¨ç¨‹åºçš„å †æ ˆåŒºåŸŸåˆ†é…ä¸€ä¸ªç¼“å†²åŒºï¼Œç„¶åç”¨äºè·¨ enclave æ•°æ®ä¼ è¾“ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åªéœ€è¦ä¿®æ”¹ <code>sgx_ocalloc()</code> å‡½æ•°ï¼Œåœ¨ç¼–ç»„ç¼“å†²åŒºä¸­åˆ†é…ä¸€ä¸ªå†…å­˜åŒºåŸŸã€‚ä¸ºäº†æ”¯æŒé€šè¿‡ç¼–ç»„ç¼“å†²åŒºä¸º ECALL ä¼ é€’å‚æ•°ï¼Œæˆ‘ä»¬ä¿®æ”¹äº† SGX çš„ Edger8r å·¥å…·ï¼Œä»¥è‡ªåŠ¨ç”Ÿæˆå°†ä¼ è¾“æ•°æ®å¤åˆ¶åˆ°ç¼–ç»„ç¼“å†²åŒºçš„ä»£ç ã€‚</p><p>SGX ç¼–ç¨‹æ¨¡å‹æ”¯æŒä½¿ç”¨ <code>user_check</code> å±æ€§ä¼ é€’å‚æ•°ã€‚å¯¹äºæ­¤ç±»å‚æ•°ï¼ŒSDK å·¥å…·ä¸ä¼šç”Ÿæˆä»£ç æ¥æ£€æŸ¥åœ°å€èŒƒå›´æˆ–æ‰§è¡Œæ•°æ®ç§»åŠ¨ã€‚ç”±äº enclave ä»£ç å¯ä»¥è®¿é—®æ•´ä¸ªè¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œä¸€äº› enclave ç¨‹åºå¯èƒ½ä¼šä½¿ç”¨å¸¦æœ‰ <code>user_check</code> å±æ€§çš„æŒ‡é’ˆç›´æ¥æ“çºµ enclave å¤–éƒ¨çš„æ•°æ®ç¼“å†²åŒºï¼Œè€Œä¸è€ƒè™‘è·¨ enclave è¾¹ç•Œå¤åˆ¶æ•°æ®çš„å¼€é”€ã€‚ä¸ºäº†å¤„ç†è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä¸ºå¼€å‘è€…å¢åŠ äº†ä¸€ä¸ªæ¥å£ï¼Œä»¥ä¾¿åœ¨å¼€å‘è€…å¯èƒ½ä½¿ç”¨å¸¦æœ‰ <code>user_check</code> å±æ€§çš„å‚æ•°æ—¶ï¼Œåœ¨ç¼–ç»„ç¼“å†²åŒºå†…åˆ†é…ç¼“å†²åŒºã€‚</p><p>è¿œç¨‹è¯æ˜æµç¨‹ä¸ SGX ç±»ä¼¼ï¼Œéµå¾ªç›¸åŒçš„ SIGn-and-MAc (SIGMA) åè®®ã€‚æˆ‘ä»¬æ‰©å±•äº† SDK ä¸­çš„ <code>sgx_quote_t</code> ç»“æ„ä»¥åŒ…æ‹¬ HyperEnclave quoteï¼Œå¹¶ä¸”è¯¥ä¿®æ”¹å¯¹ enclave ä»£ç æ˜¯é€æ˜çš„ã€‚</p><p>é€šè¿‡ä»¥ä¸Šè®¾è®¡ï¼Œå¤§å¤šæ•° SGX ç¨‹åºå¯ä»¥åœ¨ HyperEnclave ä¸Šè¿è¡Œè€Œæ— éœ€æ›´æ”¹æºä»£ç ã€‚æ­¤å¤–ï¼Œä¸ºäº†ç®€åŒ– HyperEnclave åº”ç”¨ç¨‹åºçš„å¼€å‘ï¼Œæˆ‘ä»¬è¿˜å·²å°† Rust SGX SDK [71] å’Œ Occlum åº“æ“ä½œç³»ç»Ÿ [64] ç§»æ¤åˆ° HyperEnclaveã€‚</p><h2 id="6-å®‰å…¨æ€§åˆ†æ"><a href="#6-å®‰å…¨æ€§åˆ†æ" class="headerlink" title="6 å®‰å…¨æ€§åˆ†æ"></a>6 å®‰å…¨æ€§åˆ†æ</h2><p><strong>ä¿¡ä»»å»ºç«‹ã€‚</strong> HyperEnclave ä¾èµ–åº¦é‡å¯åŠ¨æ¥å¼•å¯¼ RustMonitor çš„ä¿¡ä»»ï¼Œè¿™æ˜¯ TEE è®¾è®¡çš„å¸¸ç”¨æ–¹æ³•ï¼ˆä¾‹å¦‚ï¼ŒTrustZone [16] å’Œ Keystone [49]ï¼‰ã€‚å¯åŠ¨è¿‡ç¨‹ä¸­çš„æ‰€æœ‰ç»„ä»¶ï¼ˆåŒ…æ‹¬ CRTMã€BIOSã€grubã€å†…æ ¸å’Œ initramfsï¼‰éƒ½è¢«æµ‹é‡å¹¶æ‰©å±•åˆ° TPM PCRã€‚å› æ­¤ï¼Œå¯¹å¯åŠ¨ä»£ç çš„ä»»ä½•ç¯¡æ”¹éƒ½å°†é€šè¿‡è¿œç¨‹è¯æ˜åæ˜ å’Œå®¡è®¡ã€‚æˆ‘ä»¬è®¤ä¸º HyperEnclave éƒ¨ç½²åœ¨å—æ§ç¯å¢ƒä¸­ï¼ˆå³äº‘è®¡ç®—åœºæ™¯ä¸­çš„æ•°æ®ä¸­å¿ƒï¼‰ï¼Œå› æ­¤æ”»å‡»è€…å¯¹å¹³å°çš„ç‰©ç†è®¿é—®æƒé™æœ‰é™ã€‚ä¸ºäº†å‡å°‘æ”»å‡»é¢å¹¶æœ€å°åŒ– TCBï¼Œæˆ‘ä»¬å°† RustMonitor é•œåƒæ”¾å…¥ initramfsï¼Œå¹¶åœ¨æ—©æœŸç”¨æˆ·ç©ºé—´ä¸­åŠ è½½å’Œæµ‹é‡ RustMonitorã€‚åœ¨æ­¤é˜¶æ®µï¼Œä¸»æ“ä½œç³»ç»Ÿå†…æ ¸ä¸æ¥å—æ¥è‡ªç”¨æˆ·çš„å¤–éƒ¨è¾“å…¥ï¼Œå¹¶ä¸”ç½‘ç»œè¿æ¥ç­‰å¤–å›´è®¾å¤‡è¢«ç¦ç”¨ã€‚é€šè¿‡åº¦é‡å»¶è¿Ÿå¯åŠ¨æ–¹æ³•ï¼Œåœ¨æ“ä½œç³»ç»Ÿè¢«é™çº§åˆ°æ­£å¸¸æ¨¡å¼åï¼ŒRustMonitor ä¸å†éœ€è¦ä¿¡ä»»ä¸»æ“ä½œç³»ç»Ÿã€‚</p><p><strong>Enclave å†…å­˜éš”ç¦»ã€‚</strong> å¦‚ç¬¬ 3.2 èŠ‚æ‰€è¿°ï¼Œenclave çš„å†…å­˜å’Œé¡µè¡¨ç”± RustMonitor ç»´æŠ¤ï¼Œä¸»æ“ä½œç³»ç»Ÿæ— æ³•è®¿é—®ã€‚TLB åœ¨ world switch æ—¶è¢«æ¸…é™¤ï¼Œä»¥é˜²æ­¢ä½¿ç”¨è¿‡æ—¶çš„ TLB æ¡ç›®è¿›è¡Œéæ³•å†…å­˜è®¿é—®ã€‚RustMonitor é€šè¿‡ä»å…¶ NPT ä¸­ç§»é™¤ç›¸åº”æ˜ å°„æ¥é˜²æ­¢ä¸»æ“ä½œç³»ç»Ÿè®¿é—®ä¿ç•™çš„ç‰©ç†å†…å­˜ã€‚RustMonitor è¿˜é…ç½® IOMMU ä»¥é˜²æ­¢æœªç»æˆæƒçš„è®¾å¤‡è®¿é—®ä¿ç•™çš„ç‰©ç†å†…å­˜ã€‚</p><p>æˆ‘ä»¬çš„è®¾è®¡é˜²æ­¢äº†å†…å­˜æ˜ å°„æ”»å‡»ï¼Œå› ä¸ºä¸»æ“ä½œç³»ç»Ÿä¸èƒ½å¹²æ‰° enclave çš„åœ°å€æ˜ å°„ã€‚æˆ‘ä»¬å¼•å…¥ç¼–ç»„ç¼“å†²åŒºä»¥æ”¯æŒ enclave å’Œåº”ç”¨ç¨‹åºä¹‹é—´çš„å†…å­˜å…±äº«ã€‚åº”ç”¨ç¨‹åºåœ¨æ­£å¸¸å†…å­˜ä¸­é¢„åˆ†é…ä¸€ä¸ªç¼–ç»„ç¼“å†²åŒºï¼Œå¹¶åœ¨ enclave åˆå§‹åŒ–æœŸé—´å°†ç¼“å†²åŒºçš„åŸºåœ°å€å’Œå¤§å°ä¼ é€’ç»™ RustMonitorã€‚å¦‚æœåº”ç”¨ç¨‹åºå¯èƒ½ä¼ é€’ä¼ªé€ çš„åœ°å€ï¼ˆä¾‹å¦‚ï¼Œè¦†ç›– enclave å†…å­˜ï¼‰ï¼Œåœ¨å°†ç¼–ç»„ç¼“å†²åŒºçš„æ˜ å°„æ·»åŠ åˆ° enclave çš„é¡µè¡¨ä¹‹å‰ï¼ŒRustMonitor ä¼šç¡®ä¿ç¼–ç»„ç¼“å†²åŒºçš„åœ°å€èŒƒå›´åœ¨ enclave åœ°å€èŒƒå›´ä¹‹å¤–ã€‚</p><p><strong>é˜²å¾¡å—æŸçš„ Enclaveã€‚</strong> å…ˆå‰çš„å·¥ä½œè¡¨æ˜ï¼Œenclave æ¶æ„è½¯ä»¶å¯èƒ½ä¼šçªƒå–ç§˜å¯†æ•°æ®æˆ–åŠ«æŒ enclave å¤–éƒ¨åº”ç”¨ç¨‹åºçš„æ§åˆ¶æµ [63]ã€‚HyperEnclave æ—¨åœ¨é™åˆ¶æ½œåœ¨çš„æ¶æ„ enclaveï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><ul><li><strong>é˜²æ­¢å¯¹åº”ç”¨ç¨‹åºçš„ä»»æ„å†…å­˜è®¿é—®ã€‚</strong> SGX enclave å¯ä»¥è®¿é—®åº”ç”¨ç¨‹åºçš„æ•´ä¸ªåœ°å€ç©ºé—´ï¼Œè¿™å¯èƒ½å¯¼è‡´è¯¸å¦‚æ³„éœ²å¯†é’¥æˆ–å †æ ˆé‡‘ä¸é›€ï¼Œæˆ–ç¯¡æ”¹ä»£ç æŒ‡é’ˆä»¥è¿›è¡Œæ§åˆ¶æµæ”»å‡»ç­‰æ”»å‡»ã€‚åœ¨ HyperEnclave ä¸­ï¼Œenclave åªèƒ½è®¿é—®è‡ªå·±çš„å†…å­˜å’Œç”¨äºå‚æ•°ä¼ é€’çš„ç¼–ç»„ç¼“å†²åŒºã€‚</li><li><strong>é˜²æ­¢ EEXIT åçš„ä»»æ„æ§åˆ¶æµã€‚</strong> SGX è®¾è®¡å…è®¸ enclave é€šè¿‡åœ¨æ‰§è¡Œ EEXIT æŒ‡ä»¤ï¼ˆå³é€€å‡º enclaveï¼‰ä¹‹å‰è®¾ç½® rbx æ¥è·³è½¬åˆ°ä»»æ„åœ°å€ï¼Œè¿™ä¸º enclave æ¶æ„è½¯ä»¶æ”»å‡»æ‰“å¼€äº†å¤§é—¨ [63]ã€‚åœ¨æˆ‘ä»¬çš„è®¾è®¡ä¸­ï¼Œç”±äº EEXIT æŒ‡ä»¤ç”± RustMonitor æ¨¡æ‹Ÿï¼Œå› æ­¤é€šè¿‡åœ¨è°ƒç”¨ EEXIT æ—¶æ·»åŠ æœ‰æ•ˆæ€§æ£€æŸ¥ï¼Œå¾ˆå®¹æ˜“é˜²æ­¢æ­¤ç±»æ”»å‡»ã€‚</li></ul><p><strong>ç‰©ç†æ”»å‡»ã€‚</strong> è¯¸å¦‚ AMD SME ä¹‹ç±»çš„ç¡¬ä»¶å†…å­˜åŠ å¯†æŠ€æœ¯å¯ç”¨äºä¿æŠ¤ enclave å…å—å†·å¯åŠ¨æ”»å‡»æˆ–æ€»çº¿å—…æ¢æ”»å‡»ç­‰ç‰©ç†æ”»å‡»ã€‚é€šè¿‡å†…å­˜åŠ å¯†ï¼Œæ•°æ®åœ¨å†…å­˜æˆ–å†…å­˜æ€»çº¿ä¸Šå§‹ç»ˆæ˜¯åŠ å¯†çš„ï¼Œå¹¶ä¸”ä»…åœ¨ CPU å†…éƒ¨è§£å¯†ã€‚å†…å­˜åŠ å¯†å¯†é’¥åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶éšæœºç”Ÿæˆå¹¶å­˜å‚¨åœ¨ CPU ä¸­ï¼Œè½¯ä»¶æ— æ³•æ˜¾å¼è®¿é—®ã€‚</p><p><strong>ä¾§ä¿¡é“æ”»å‡»ã€‚</strong> ä¸ SGX ç›¸æ¯”ï¼ŒHyperEnclave å¯ä»¥å‡è½»æŸäº›ç±»å‹çš„ä¾§ä¿¡é“æ”»å‡»ã€‚ç”±äº enclave çš„å®¢æˆ·æœºé¡µè¡¨å’Œé¡µé”™è¯¯äº‹ä»¶ç”± RustMonitor å¤„ç†ï¼Œè€Œæ²¡æœ‰ä¸»æ“ä½œç³»ç»Ÿçš„å‚ä¸ï¼Œå› æ­¤åè€…æ— æ³•å‘èµ·åŸºäºé¡µè¡¨çš„æ”»å‡» [25, 72, 74]ã€‚æˆ‘ä»¬å°†é’ˆå¯¹å¾®æ¶æ„æ”»å‡»ï¼ˆå¦‚æ¨æµ‹æ‰§è¡Œæ”»å‡»ï¼‰çš„é˜²æŠ¤ç•™ä½œæœªæ¥å·¥ä½œã€‚</p><h2 id="7-è¯„ä¼°"><a href="#7-è¯„ä¼°" class="headerlink" title="7 è¯„ä¼°"></a>7 è¯„ä¼°</h2><p>æˆ‘ä»¬åœ¨ä¸€ä¸ªé…å¤‡ä¸¤é¢— AMD EPYC 7601 CPUï¼ˆæ¯æ ¸ 2 çº¿ç¨‹ï¼Œå…± 128 ä¸ªé€»è¾‘æ ¸å¿ƒï¼‰å’Œ 512 GB DDR4 RAM çš„æœåŠ¡å™¨ä¸Šéƒ¨ç½²äº† HyperEnclaveã€‚æˆ‘ä»¬ä¸º RustMonitor é…ç½®äº† 2 GB çš„ä¿ç•™å†…å­˜ï¼Œä¸º EPC å†…å­˜é…ç½®äº† 24 GBã€‚ä¸»æ“ä½œç³»ç»Ÿæ˜¯ Ubuntu 18.04 LTSï¼ŒLinux å†…æ ¸ç‰ˆæœ¬ä¸º 4.19.91ã€‚ä¸ºäº†æ¯”è¾ƒï¼Œæˆ‘ä»¬åœ¨ä¸€ä¸ªå¯ç”¨ SGX çš„ Intel Xeon E3-1270 v6 CPU ä¸Šè¿è¡Œäº†ç›¸åŒçš„å®éªŒï¼Œè¯¥ CPU é…å¤‡ 64 GB DDR4 RAMï¼Œè¿è¡Œç›¸åŒçš„æ“ä½œç³»ç»Ÿã€‚HyperEnclave å’ŒåŸç”Ÿ SGX ç¡¬ä»¶çš„ SGX SDK ç‰ˆæœ¬å‡ä¸º 2.13ã€‚æ‰€æœ‰ç¨‹åºéƒ½ä½¿ç”¨ GCC 7.5.0 å’Œç›¸åŒçš„ä¼˜åŒ–çº§åˆ«è¿›è¡Œç¼–è¯‘ã€‚</p><p>æˆ‘ä»¬è¯•å›¾æ’é™¤ç¡¬ä»¶ä¹‹é—´çš„å·®å¼‚ã€‚é™¤éæ˜ç¡®è¯´æ˜ï¼Œè¯„ä¼°æ²¡æœ‰è¶…è¿‡ EPC å¤§å°ï¼Œä»¥å…å¼•å‘è¿‡å¤šçš„é¡µé¢äº¤æ¢ã€‚æ‰€æœ‰è¯„ä¼°éƒ½åœ¨å•çº¿ç¨‹æ¨¡å¼ä¸‹è¿›è¡Œã€‚å¯¹äºå¾®åŸºå‡†æµ‹è¯•ï¼ˆè¡¨ 1 å’Œè¡¨ 2ï¼‰ï¼Œæˆ‘ä»¬ä½¿ç”¨ç›¸åŒçš„ SGX SDK åœ¨ AMD ç¡¬ä»¶ä¸Šå°† HyperEnclave ä¸åœ¨ Intel ç¡¬ä»¶ä¸Šçš„ SGX è¿›è¡Œæ¯”è¾ƒã€‚æˆ‘ä»¬æµ‹é‡äº†æ ¸å¿ƒå‘¨æœŸä»¥é¿å… CPU é¢‘ç‡çš„å½±å“ã€‚å¯¹äºçœŸå®ä¸–ç•Œçš„å·¥ä½œè´Ÿè½½ï¼Œæˆ‘ä»¬åˆ†åˆ«åœ¨ Intel å’Œ AMD å¹³å°ä¸Šå°†æ²¡æœ‰å®‰å…¨ä¿æŠ¤çš„å¯¹åº”ç‰©è®¾ç½®ä¸ºåŸºçº¿ï¼Œå¹¶æ¯”è¾ƒ SGX å’Œ HyperEnclave å¼•å…¥çš„ç›¸å¯¹å‡é€Ÿã€‚ç”±äºæˆ‘ä»¬åªæ¯”è¾ƒç›¸å¯¹å‡é€Ÿï¼Œæˆ‘ä»¬å¼ºè°ƒç»å¯¹æ€§èƒ½ç»“æœæ˜¯åœ¨ä¸åŒçš„å¹³å°ä¸Šå¾—å‡ºçš„ï¼Œä¸èƒ½ç›´æ¥æ¯”è¾ƒã€‚æ‰€æœ‰ HyperEnclave è¯„ä¼°éƒ½æ˜¯åœ¨å¯ç”¨å†…å­˜åŠ å¯†çš„æƒ…å†µä¸‹è¿›è¡Œçš„ã€‚</p><p>æˆ‘ä»¬å·²è°¨æ…ç¡®ä¿ HyperEnclave æ­£ç¡®å®ç°äº† TEE åŠŸèƒ½ã€‚å°½ç®¡å¦‚æ­¤ï¼ŒSGX1 å’Œ HyperEnclave ä¹‹é—´çš„å†…å­˜åŠ å¯†æ˜¯ä¸åŒçš„ï¼Œå³ Merkel æ ‘å’Œ AES-CTR å¯¹æ¯” AES-XTSï¼ˆæœ‰å…³å†…å­˜åŠ å¯†å¼€é”€çš„è¯„ä¼°ï¼Œè¯·å‚è§ç¬¬ A.3 èŠ‚ä¸­çš„å›¾ 11ï¼‰ï¼Œè¿™å¯èƒ½è§£é‡Šäº†å†…å­˜å¯†é›†å‹å·¥ä½œè´Ÿè½½çš„æ”¹è¿›ã€‚æ­¤å¤–ï¼ŒHyperEnclaveï¼ˆç‰¹åˆ«æ˜¯ HU-enclaveï¼‰çš„ world switch æ›´å¿«ï¼Œè¿™è§£é‡Šäº† I&#x2F;O å¯†é›†å‹å·¥ä½œè´Ÿè½½çš„æ”¹è¿›ã€‚</p><h3 id="7-1-World-Switch-æ€§èƒ½"><a href="#7-1-World-Switch-æ€§èƒ½" class="headerlink" title="7.1 World Switch æ€§èƒ½"></a>7.1 World Switch æ€§èƒ½</h3><p>æˆ‘ä»¬åœ¨ HyperEnclaveï¼ˆåœ¨ä¸åŒçš„ enclave æ“ä½œæ¨¡å¼ä¸‹ï¼‰å’Œ Intel SGX ä¸Šéƒ½æµ‹é‡äº†è¾¹ç¼˜è°ƒç”¨ï¼ˆå³ ECALL å’Œ OCALLï¼‰çš„å»¶è¿Ÿã€‚æµ‹è¯•ä»£ç è¿è¡Œäº† 1,000,000 æ¬¡æ²¡æœ‰æ˜¾å¼å‚æ•°çš„ç©ºè¾¹ç¼˜è°ƒç”¨ï¼Œå¹¶å–ä¸­å€¼ã€‚æˆ‘ä»¬è¿˜æµ‹é‡äº† HyperEnclave ä¸Šæ¨¡æ‹Ÿçš„ EENTER å’Œ EEXIT æŒ‡ä»¤çš„æŒ‡ä»¤çº§å»¶è¿Ÿã€‚æˆ‘ä»¬æ— æ³•åœ¨ SGX ä¸Šæµ‹é‡æŒ‡ä»¤çº§å»¶è¿Ÿï¼Œå› ä¸ºæˆ‘ä»¬çš„ SGX å¹³å°ä¸Šçš„ enclave å†…ä¸æ”¯æŒ RDTSCP æŒ‡ä»¤ã€‚</p><p>ç»“æœå¦‚è¡¨ 1 æ‰€ç¤ºã€‚ç»“æœè¡¨æ˜ï¼ŒHU-Enclave å…·æœ‰æœ€ä½³çš„è¾¹ç¼˜è°ƒç”¨æ€§èƒ½ï¼Œå› ä¸ºå®ƒå°†æ¨¡å¼åˆ‡æ¢ï¼ˆçº¦ 880 å‘¨æœŸï¼‰å‡å°‘ä¸ºç¯åˆ‡æ¢ï¼ˆçº¦ 120 å‘¨æœŸï¼‰ï¼Œè€Œ P-Enclave æ¯” GU-Enclave æ…¢ï¼Œå› ä¸ºå®ƒåœ¨ world switch æœŸé—´éœ€è¦åˆ‡æ¢æ›´å¤šçš„ç‰¹æƒçŠ¶æ€ã€‚æ‰€æœ‰ç»“æœéƒ½ä¸ Intel SGX ç›¸å½“ã€‚</p><h3 id="7-2-Enclave-å¼‚å¸¸å¤„ç†"><a href="#7-2-Enclave-å¼‚å¸¸å¤„ç†" class="headerlink" title="7.2 Enclave å¼‚å¸¸å¤„ç†"></a>7.2 Enclave å¼‚å¸¸å¤„ç†</h3><p>æˆ‘ä»¬ä½¿ç”¨æœªå®šä¹‰æŒ‡ä»¤å¼‚å¸¸ï¼ˆ#UDï¼‰å’Œé¡µé”™è¯¯å¼‚å¸¸ï¼ˆ#PFï¼‰æ¥è¯„ä¼° enclave å¼‚å¸¸å¤„ç†æ€§èƒ½ã€‚åœ¨ #UD åŸºå‡†æµ‹è¯•ä¸­ï¼Œæµ‹è¯•ä»£ç åœ¨ enclave ä¸­æ‰§è¡Œä¸€æ¡æœªå®šä¹‰æŒ‡ä»¤ä»¥è§¦å‘å¼‚å¸¸ 1,000,000 æ¬¡ã€‚å¼‚å¸¸å¤„ç†ç¨‹åºæ¨è¿›æŒ‡ä»¤æŒ‡é’ˆå¹¶è¿”å›ã€‚å¯¹äº P-Enclaveï¼Œå¼‚å¸¸å®Œå…¨åœ¨ enclave å†…éƒ¨æ•è·å’Œå¤„ç†ï¼Œæ— éœ€ enclave æ¨¡å¼åˆ‡æ¢ã€‚å¯¹äº GU-Enclave å’Œ SGXï¼Œå¼‚å¸¸ä¼šå¯¼è‡´å¼‚æ­¥ enclave é€€å‡ºï¼ˆAEXï¼‰å¹¶å°† CPU åˆ‡æ¢åˆ°éå¯ä¿¡æ“ä½œç³»ç»Ÿï¼Œç„¶åæ‰§è¡Œä¸€ä¸ªä¸¤é˜¶æ®µå¼‚å¸¸å¤„ç† [7]ã€‚ç»“æœè¡¨æ˜ï¼ŒP-Enclave å†…çš„å¼‚å¸¸å¤„ç†åˆ†åˆ«æ¯” GU-Enclave å’Œ Intel SGX å¿«çº¦ 68 å€å’Œ 110 å€ï¼ˆè¡¨ 2ï¼‰ã€‚</p><p>æˆ‘ä»¬è¿›ä¸€æ­¥æ¨¡æ‹Ÿäº†ä¸€ä¸ªå…¸å‹çš„åƒåœ¾æ”¶é›†å™¨ï¼ˆGCï¼‰åœºæ™¯ï¼Œæµ‹è¯•ä»£ç é¦–å…ˆåˆ†é…ä¸€ä¸ªå¤§çš„å†…å­˜ç¼“å†²åŒºï¼Œç„¶åé€šè¿‡æ›´æ”¹ enclave çš„é¡µè¡¨æ¥æ’¤é”€å¯¹è¯¥ç¼“å†²åŒºçš„å†™æƒé™ã€‚ä¹‹åï¼Œenclave è®¿é—®è¯¥ç¼“å†²åŒºä»¥è§¦å‘é¡µé”™è¯¯ã€‚åœ¨å¼‚å¸¸å¤„ç†ç¨‹åºä¸­ï¼Œå†™æƒé™è¢«æ¢å¤ã€‚ç»“æœï¼ˆè¡¨ 2ï¼‰æ˜¾ç¤ºï¼ŒP-Enclave æ¯” GU-Enclave å¿«çº¦ 2.3 å€ï¼Œå› ä¸º P-Enclave è‡ªå·±æ›´æ–°é¡µè¡¨å¹¶å¤„ç†é¡µé”™è¯¯ï¼Œè€Œ GU-Enclave éœ€è¦é™·å…¥ RustMonitor æ¥æ›´æ–°é¡µè¡¨ã€‚è¯·æ³¨æ„ï¼Œæˆ‘ä»¬æ²¡æœ‰åœ¨ Intel SGX ä¸Šè¯„ä¼° GCï¼Œå› ä¸ºæˆ‘ä»¬çš„ SGX1 å¹³å°åœ¨ enclave åˆå§‹åŒ–åä¸æ”¯æŒé¡µé¢æƒé™ä¿®æ”¹ã€‚</p><h3 id="7-3-ç¼–ç»„ç¼“å†²åŒºå¼€é”€"><a href="#7-3-ç¼–ç»„ç¼“å†²åŒºå¼€é”€" class="headerlink" title="7.3 ç¼–ç»„ç¼“å†²åŒºå¼€é”€"></a>7.3 ç¼–ç»„ç¼“å†²åŒºå¼€é”€</h3><p>ä¸ºäº†æµ‹é‡å¼•å…¥ç¼–ç»„ç¼“å†²åŒºçš„å¼€é”€ï¼Œæˆ‘ä»¬æ„å»ºäº†ä¸€ä¸ªä¸ä½¿ç”¨ç¼–ç»„ç¼“å†²åŒºçš„ GU-Enclave å˜ä½“ä½œä¸ºåŸºçº¿ã€‚æˆ‘ä»¬æµ‹é‡äº† ECALL å’Œ OCALL åœ¨ä¸åŒå¤§å°çš„ä¼ è¾“æ•°æ®å’Œä¸åŒæ•°æ®ç§»åŠ¨æ–¹å‘ï¼ˆå³â€inâ€ã€â€outâ€å’Œâ€in&amp;outâ€ï¼‰ä¸‹çš„å¼€é”€ã€‚æˆ‘ä»¬ä½¿ç”¨ CLFLUSH æŒ‡ä»¤ç¡®ä¿è¦ä¼ è¾“çš„æ•°æ®æ²¡æœ‰è¢«ç¼“å­˜ã€‚æˆ‘ä»¬è¯„ä¼°äº†åœ¨ SGX ä¸Šä¼ è¾“ç›¸åŒæ•°æ®çš„æ€§èƒ½ä»¥è¿›è¡Œæ¯”è¾ƒã€‚</p><p>ï¼ˆåŸæ–‡æ­¤å¤„æœ‰ç¼ºå¤±ï¼Œä½†æ ¹æ®ä¸Šä¸‹æ–‡æ¨æ–­ï¼‰å¼€é”€éšç€æ•°æ®å¤§å°çš„å¢åŠ è€Œå¢åŠ ã€‚å¯¹äº ECALLï¼Œç”±äºé¢å¤–çš„å†…å­˜å¤åˆ¶ï¼Œä¼ è¾“ 16 KB æ•°æ®æ—¶ï¼Œâ€inâ€ã€â€outâ€ å’Œ â€œin&amp;outâ€ æ–¹å‘çš„å¼€é”€åˆ†åˆ«ä¸º 8%ã€11% å’Œ 21%ã€‚å¯¹äº OCALLï¼Œå¼€é”€å¯ä»¥å¿½ç•¥ä¸è®¡ï¼Œå› ä¸ºå®ƒåœ¨ç¼–ç»„ç¼“å†²åŒºä¸Šåˆ†é…ä¸€ä¸ªç¼“å†²åŒºè€Œæ²¡æœ‰é¢å¤–çš„å†…å­˜å¤åˆ¶ï¼ˆç¬¬ 5.3 èŠ‚ï¼‰ã€‚æˆ‘ä»¬æé†’ï¼Œåœ¨è®¸å¤šçœŸå®ä¸–ç•Œçš„è®¡ç®—å·¥ä½œè´Ÿè½½ä¸­ï¼Œå°¤å…¶æ˜¯åœ¨è®¡ç®—æˆ–å†…å­˜å¯†é›†å‹ä»»åŠ¡ä¸­ï¼ŒECALL ä¸­çš„æ•°æ®ä¼ è¾“åªå å¤„ç†æ—¶é—´çš„ä¸€å°éƒ¨åˆ†ã€‚</p><h3 id="7-4-çœŸå®ä¸–ç•Œå·¥ä½œè´Ÿè½½"><a href="#7-4-çœŸå®ä¸–ç•Œå·¥ä½œè´Ÿè½½" class="headerlink" title="7.4 çœŸå®ä¸–ç•Œå·¥ä½œè´Ÿè½½"></a>7.4 çœŸå®ä¸–ç•Œå·¥ä½œè´Ÿè½½</h3><p>è¯„ä¼°åœ¨å››ä¸ªçœŸå®ä¸–ç•Œçš„åº”ç”¨ç¨‹åºä¸Šè¿›è¡Œï¼šä¸€ä¸ªç®—æ³•åŸºå‡†å¥—ä»¶ NBench [53]ï¼Œä¸€ä¸ªè½»é‡çº§ Web æœåŠ¡å™¨ Lighttpd [13]ï¼Œä¸¤ä¸ªæµè¡Œçš„æ•°æ®åº“ SQLite [14] å’Œ Redis [15]ï¼Œä½œä¸º CPU å¯†é›†å‹ã€I&#x2F;O å¯†é›†å‹å’Œå†…å­˜å¯†é›†å‹ä»»åŠ¡çš„ä»£è¡¨ã€‚æˆ‘ä»¬å°†åº“æ“ä½œç³»ç»Ÿ Occlum [64] (v0.21) ç§»æ¤åˆ° enclave SDKï¼Œä»¥å‡å°‘ Lighttpd å’Œ Redis çš„ç§»æ¤å·¥ä½œã€‚æˆ‘ä»¬ä½¿ç”¨åœ¨ SDK æ¨¡æ‹Ÿæ¨¡å¼ä¸‹ç¼–è¯‘çš„ç›¸åŒä»£ç ä½œä¸ºåŸºçº¿ï¼ˆä¸æä¾›å®‰å…¨ä¿è¯ï¼‰ï¼Œåœ¨ HyperEnclave å’Œ Intel SGX ä¸Šæµ‹é‡äº†æ€§èƒ½ã€‚</p><h4 id="NBench"><a href="#NBench" class="headerlink" title="NBench"></a>NBench</h4><p>NBench æµ‹é‡ç³»ç»Ÿçš„ CPUã€FPU å’Œå†…å­˜ç³»ç»Ÿçš„æ€§èƒ½ï¼Œä¸æ¶‰åŠ I&#x2F;O å’Œç³»ç»Ÿè°ƒç”¨ã€‚æˆ‘ä»¬ä½¿ç”¨äº† NBench çš„ä¸€ä¸ª SGX æ”¹ç¼–ç‰ˆï¼Œå³ SGX-NBench [8]ï¼Œåœ¨æˆ‘ä»¬çš„è¯„ä¼°ä¸­æ²¡æœ‰ä¿®æ”¹æºä»£ç ã€‚å¦‚å›¾ 8a æ‰€ç¤ºï¼ŒHyperEnclave å’Œ SGX å¼•å…¥çš„å¼€é”€åˆ†åˆ«çº¦ä¸º 1% å’Œ 3%ã€‚</p><h4 id="SQLite"><a href="#SQLite" class="headerlink" title="SQLite"></a>SQLite</h4><p>æˆ‘ä»¬å°† SQLite (v3.19.3) ä¸ enclave SDK è¿›è¡Œäº†ç§»æ¤ï¼Œå¹¶ä½¿ç”¨ YCSB [30] å·¥ä½œè´Ÿè½½ Aï¼ˆ50% è¯»å–ï¼Œ50% æ›´æ–°ï¼‰åœ¨ Intel SGX å’Œ HyperEnclaveï¼ˆGU-Enclave å’Œ HU-Enclaveï¼‰ä¸Šå¯¹å…¶è¿›è¡Œäº†è¯„ä¼°ã€‚åœ¨æ­¤è¯„ä¼°ä¸­ï¼Œæˆ‘ä»¬ä¸“æ³¨äºå†…å­˜æ€§èƒ½ï¼Œå› æ­¤æˆ‘ä»¬å°†æ•°æ®åº“é…ç½®ä¸ºå†…å­˜æ•°æ®åº“ï¼Œå¹¶å°†å®¢æˆ·ç«¯åµŒå…¥åˆ° enclave ä¸­ä»¥é¿å… I&#x2F;O æ“ä½œã€‚æˆ‘ä»¬å¢åŠ äº†è®°å½•æ•°é‡ï¼Œå¹¶æµ‹é‡äº† 100,000 æ¬¡æ•°æ®åº“æ“ä½œçš„æ—¶é—´ã€‚å¦‚å›¾ 8b æ‰€ç¤ºï¼Œåœ¨ SGX ä¸Šï¼Œå¯¹äºå°å†…å­˜ä½¿ç”¨é‡ï¼Œååé‡çº¦ä¸ºåŸºçº¿çš„ 75%ã€‚å½“å†…å­˜ä½¿ç”¨é‡è¶…è¿‡ EPC å¤§å°ï¼ˆçº¦ 90 MBï¼‰æ—¶ï¼Œç”±äºé¡µé¢äº¤æ¢ï¼Œæ€§èƒ½ä¸‹é™åˆ° 50%ã€‚åœ¨ HyperEnclave ä¸Šï¼ŒGU-Enclave å’Œ HU-Enclave çš„æ€§èƒ½å‡ ä¹ä¸åŸºçº¿ç›¸åŒï¼ˆå¼€é”€ &lt; 5%ï¼‰ã€‚æˆ‘ä»¬æ¨æµ‹è¿™æ˜¯å› ä¸º AMD SME çš„å†…å­˜åŠ å¯†æ€§èƒ½ï¼ˆæ²¡æœ‰å®Œæ•´æ€§ä¿æŠ¤ï¼‰æ¯” SGX å¿«ã€‚</p><h4 id="Lighttpd"><a href="#Lighttpd" class="headerlink" title="Lighttpd"></a>Lighttpd</h4><p>æˆ‘ä»¬åœ¨ SGX å’Œ HyperEnclaveï¼ˆGU-Enclave å’Œ HU-Enclave æ¨¡å¼ï¼‰ä¸Šä½¿ç”¨ Occlum è¿è¡Œäº†ä¸€ä¸ª Lighttpd (v1.4.40) æœåŠ¡å™¨ã€‚æˆ‘ä»¬ä½¿ç”¨äº† Apache HTTP åŸºå‡†æµ‹è¯•å·¥å…· [10]ï¼Œå¹¶é€šè¿‡æœ¬åœ°ç¯å›è¿è¡Œäº† 100 ä¸ªå¹¶å‘å®¢æˆ·ç«¯æ¥è·å–å„ç§å¤§å°çš„ç½‘é¡µä»¥è¯„ä¼°ååé‡ã€‚åœ¨æ­¤è¯„ä¼°ä¸­ï¼Œå¼€é”€ä¸»è¦æ¥è‡ªé¢‘ç¹çš„ enclave æ¨¡å¼åˆ‡æ¢ï¼ˆè¡¨ 1ï¼‰ã€‚å¦‚å›¾ 8c æ‰€ç¤ºï¼ŒHU-Enclave æä¾›äº†é¢„æœŸçš„æœ€ä½³æ€§èƒ½ï¼ˆåŸºçº¿çš„ 81% ~ 88%ï¼‰ã€‚GU-Enclave è¾¾åˆ°äº†åŸºçº¿çš„ 69% ~ 78%ï¼Œè€Œ SGX è¾¾åˆ°äº†åŸºçº¿çš„ 51% ~ 63%ã€‚</p><h4 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h4><p>æˆ‘ä»¬ä½¿ç”¨ Redis æ¥è¯„ä¼°åœ¨å†…å­˜å’Œ I&#x2F;O éƒ½å¾ˆå¯†é›†çš„ç»¼åˆåœºæ™¯ä¸‹çš„æ€§èƒ½ã€‚æˆ‘ä»¬åœ¨ SGX å’Œ HyperEnclaveï¼ˆGU-Enclave å’Œ HU-Enclave æ¨¡å¼ï¼‰ä¸Šä½¿ç”¨ Occlum è¿è¡Œäº†ä¸€ä¸ª Redis (v6.0.9) æ•°æ®åº“æœåŠ¡å™¨ã€‚ä¸ SQLite ç±»ä¼¼ï¼Œæˆ‘ä»¬å°†æ•°æ®åº“é…ç½®ä¸ºå†…å­˜æ•°æ®åº“ï¼Œå¹¶ä½¿ç”¨äº† YCSB å·¥ä½œè´Ÿè½½ Aã€‚å¯¹äºè¯„ä¼°ï¼Œæˆ‘ä»¬é¦–å…ˆåŠ è½½äº† 50,000 æ¡è®°å½•ï¼ˆæ€»å…± 50 MB æ•°æ®ï¼‰ï¼Œç„¶åé€šè¿‡æœ¬åœ°ç¯å›ä» 20 ä¸ªå®¢æˆ·ç«¯æ‰§è¡Œäº† 100,000 æ¬¡æ“ä½œã€‚æˆ‘ä»¬å¢åŠ äº†è¯·æ±‚é¢‘ç‡ï¼Œå¹¶æµ‹é‡äº†ä¸åŒååé‡ä¸‹çš„å»¶è¿Ÿã€‚å¦‚å›¾ 8d æ‰€ç¤ºï¼ŒHU-Enclave è¾¾åˆ°äº†åŸºçº¿æœ€å¤§ååé‡çš„ 89%ï¼Œè€Œ GU-Enclave å’Œ SGX åˆ†åˆ«çº¦ä¸ºåŸºçº¿çš„ 72% å’Œ 48%ã€‚</p><h2 id="8-è®¨è®º"><a href="#8-è®¨è®º" class="headerlink" title="8 è®¨è®º"></a>8 è®¨è®º</h2><p><strong>HyperEnclave åœ¨å…¶ä»–å¹³å°ä¸Šçš„åº”ç”¨ã€‚</strong> HyperEnclave éœ€è¦è™šæ‹ŸåŒ–æ‰©å±•ï¼ˆç‰¹åˆ«æ˜¯ä¸¤çº§åœ°å€è½¬æ¢ï¼‰è¿›è¡Œéš”ç¦»ï¼Œä»¥åŠ TPM ç”¨äºä¿¡ä»»æ ¹å’Œéšæœºæ€§ç­‰ã€‚è®¸å¤š ARM æœåŠ¡å™¨ï¼ˆå¦‚ ARMv8 å¹³å° [2]ï¼‰éƒ½æ”¯æŒè™šæ‹ŸåŒ–ã€‚RISC-V H-æ‰©å±•è§„èŒƒå·²äº 2021 å¹´æ¼”è¿›åˆ° v0.6.1ã€‚ARM å’Œ RISC-V è™šæ‹ŸåŒ–éƒ½æ”¯æŒä¸¤çº§åœ°å€è½¬æ¢ã€‚æŸäº› TPM äº§å“å·²ç»æ”¯æŒ ARM æœåŠ¡å™¨ã€‚å·²ç»æœ‰ç ”ç©¶åœ¨ RISC-V ä¸Šæ”¯æŒå›ºä»¶ TPM [22]ã€‚å› æ­¤ï¼Œæœ‰è¿¹è±¡è¡¨æ˜ HyperEnclave å¯ä»¥è¢«é€‚é…åˆ° ARM å’Œ RISC-V å¹³å°ä¸Šè¿è¡Œã€‚</p><p>ç„¶è€Œï¼Œå°† HyperEnclave ç§»æ¤åˆ° ARM å’Œ RISC-V å¹³å°éœ€è¦å¤§é‡çš„å·¥ç¨‹å·¥ä½œï¼Œè€ƒè™‘åˆ°æŒ‡ä»¤é›†æ¶æ„ï¼ˆISAï¼‰å®Œå…¨ä¸åŒã€‚ä»¥ ARMv8 æ¶æ„ä¸ºä¾‹ã€‚è½¯ä»¶æ¨¡å—å¯ä»¥æ˜ å°„åˆ°ä¸åŒçš„å¼‚å¸¸çº§åˆ«ï¼ˆELï¼‰ï¼šRustMonitor çš„ç›‘è§†å™¨æ¨¡å¼å¯ä»¥æ˜ å°„åˆ° EL2ï¼›ä¸»æ“ä½œç³»ç»Ÿå’Œåº”ç”¨ç¨‹åºçš„éå¯ä¿¡éƒ¨åˆ†å¯ä»¥åˆ†åˆ«æ˜ å°„åˆ° EL1 å’Œ EL0ï¼›enclave çš„å®‰å…¨æ¨¡å¼å¯ä»¥çµæ´»åœ°æ˜ å°„åˆ° EL1 æˆ– EL0ã€‚å†…å­˜éš”ç¦»å¯ä»¥é€šè¿‡ stage 2 åœ°å€è½¬æ¢çš„æ”¯æŒç±»ä¼¼åœ°å®ç°ã€‚æ­¤å¤–ï¼Œå®˜æ–¹çš„ Intel SGX SDK åªæ”¯æŒ x86 å¹³å°ã€‚ç‰¹åˆ«æ˜¯ï¼Œè·¨ enclave è¾¹ç•Œçš„è½¬æ¢æ˜¯ç”¨å¹³å°ç›¸å…³çš„æ±‡ç¼–ä»£ç å¤„ç†çš„ï¼Œéœ€è¦æ ¹æ®ç›®æ ‡å¹³å°çš„åº”ç”¨ç¨‹åºäºŒè¿›åˆ¶æ¥å£ï¼ˆABIï¼‰é‡å†™ã€‚æˆ‘ä»¬å°†æŠŠ HyperEnclave é€‚é…åˆ°å…¶ä»–å¹³å°çš„è¿›ä¸€æ­¥æ¢ç´¢ç•™ä½œæœªæ¥å·¥ä½œã€‚</p><p><strong>ä¸åŒ enclave æ“ä½œæ¨¡å¼ä¸‹çš„æ”»å‡»é¢ã€‚</strong> éå¯ä¿¡çš„ä¸»æ“ä½œç³»ç»Ÿä»ç„¶åœ¨è™šæ‹Ÿæœºå†…è¿è¡Œï¼Œä»ä¸»æ“ä½œç³»ç»Ÿåˆ° enclave çš„æ”»å‡»é¢æ²¡æœ‰æ”¹å˜ã€‚ç„¶è€Œï¼Œåœ¨ç‰¹æƒæ¨¡å¼æˆ–ä¸»æœºä¸­è¿è¡Œ enclaveï¼Œå¯èƒ½ä¼šå‘æ¶æ„ enclave æš´éœ²æ›´å¤šçš„æ”»å‡»é¢ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ enclave å·²ç»åœ¨ä¸»æœºä¸­è¿è¡Œï¼Œå®ƒå¯èƒ½ä¼šä½¿ enclave æ¶æ„è½¯ä»¶æ›´å®¹æ˜“å‡çº§åˆ°ä¸»æœº ring-0ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> éšç§è®¡ç®— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HyperEnclave </tag>
            
            <tag> æœºå¯†è®¡ç®— </tag>
            
            <tag> TEE </tag>
            
            <tag> è™šæ‹ŸåŒ– </tag>
            
            <tag> è®ºæ–‡ç¿»è¯‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HyperEnclaveæºç å­¦ä¹ è·¯çº¿å›¾</title>
      <link href="/2025/07/18/HyperEnclave%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF%E5%9B%BE/"/>
      <url>/2025/07/18/HyperEnclave%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF%E5%9B%BE/</url>
      
        <content type="html"><![CDATA[<h2 id="HyperEnclaveæºç å­¦ä¹ è·¯çº¿å›¾"><a href="#HyperEnclaveæºç å­¦ä¹ è·¯çº¿å›¾" class="headerlink" title="HyperEnclaveæºç å­¦ä¹ è·¯çº¿å›¾"></a>HyperEnclaveæºç å­¦ä¹ è·¯çº¿å›¾</h2><p>å˜»å˜»ï¼Œè®©AIå¸®æˆ‘è§„åˆ’è§„åˆ’å­¦ä¹ è·¯çº¿å›¾ï¼Œåé¢å°±å¤§è‡´æŒ‰ç…§è¿™ä¸ªè·¯çº¿è¿›è¡Œã€‚</p><h3 id="ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ¦‚å¿µå’Œæ¶æ„ç†è§£"><a href="#ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ¦‚å¿µå’Œæ¶æ„ç†è§£" class="headerlink" title="ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ¦‚å¿µå’Œæ¶æ„ç†è§£"></a>ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ¦‚å¿µå’Œæ¶æ„ç†è§£</h3><h4 id="1-é¡¹ç›®æ¦‚è¿°å’Œæ ¸å¿ƒæ¦‚å¿µ"><a href="#1-é¡¹ç›®æ¦‚è¿°å’Œæ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="1. é¡¹ç›®æ¦‚è¿°å’Œæ ¸å¿ƒæ¦‚å¿µ"></a>1. <strong>é¡¹ç›®æ¦‚è¿°å’Œæ ¸å¿ƒæ¦‚å¿µ</strong></h4><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    A[HyperEnclaveé¡¹ç›®] --&gt; B[å¯ä¿¡æ‰§è¡Œç¯å¢ƒTEE]    A --&gt; C[è™šæ‹ŸåŒ–æŠ€æœ¯]    A --&gt; D[Rustè¯­è¨€ç‰¹æ€§]    B --&gt; E[SGXæŠ½è±¡]    C --&gt; F[VMX&#x2F;SVMç¡¬ä»¶è™šæ‹ŸåŒ–]    D --&gt; G[å†…å­˜å®‰å…¨]  </pre></div><p><strong>å­¦ä¹ é‡ç‚¹ï¼š</strong></p><ul><li>ç†è§£TEEçš„åŸºæœ¬æ¦‚å¿µå’ŒHyperEnclaveçš„è®¾è®¡ç›®æ ‡</li><li>æŒæ¡è™šæ‹ŸåŒ–æŠ€æœ¯åŸºç¡€ï¼ˆIntel VMX&#x2F;AMD SVMï¼‰</li><li>ç†Ÿæ‚‰Rustè¯­è¨€çš„å†…å­˜å®‰å…¨ç‰¹æ€§</li></ul><h4 id="2-é¡¹ç›®ç»“æ„åˆ†æ"><a href="#2-é¡¹ç›®ç»“æ„åˆ†æ" class="headerlink" title="2. é¡¹ç›®ç»“æ„åˆ†æ"></a>2. <strong>é¡¹ç›®ç»“æ„åˆ†æ</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">hyperenclave/</span><br><span class="line">â”œâ”€â”€ src/                    # æ ¸å¿ƒæºç </span><br><span class="line">â”‚   â”œâ”€â”€ main.rs            # å…¥å£ç‚¹</span><br><span class="line">â”‚   â”œâ”€â”€ arch/x86_64/       # æ¶æ„ç›¸å…³</span><br><span class="line">â”‚   â”œâ”€â”€ enclave/           # Enclaveç®¡ç†</span><br><span class="line">â”‚   â”œâ”€â”€ memory/            # å†…å­˜ç®¡ç†</span><br><span class="line">â”‚   â””â”€â”€ hypercall/         # Hypercallæ¥å£</span><br><span class="line">â”œâ”€â”€ crates/                # ä¾èµ–åº“</span><br><span class="line">â”‚   â”œâ”€â”€ libvmm/           # è™šæ‹ŸåŒ–åº“</span><br><span class="line">â”‚   â”œâ”€â”€ yogcrypt/         # å›½å¯†ç®—æ³•</span><br><span class="line">â”‚   â””â”€â”€ uart_16550/       # ä¸²å£é€šä¿¡</span><br><span class="line">â””â”€â”€ scripts/              # æ„å»ºè„šæœ¬</span><br></pre></td></tr></table></figure><h3 id="ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒæ¨¡å—æ·±å…¥å­¦ä¹ "><a href="#ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒæ¨¡å—æ·±å…¥å­¦ä¹ " class="headerlink" title="ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒæ¨¡å—æ·±å…¥å­¦ä¹ "></a>ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒæ¨¡å—æ·±å…¥å­¦ä¹ </h3><h4 id="1-å¯åŠ¨å’Œåˆå§‹åŒ–æµç¨‹"><a href="#1-å¯åŠ¨å’Œåˆå§‹åŒ–æµç¨‹" class="headerlink" title="1. å¯åŠ¨å’Œåˆå§‹åŒ–æµç¨‹"></a>1. <strong>å¯åŠ¨å’Œåˆå§‹åŒ–æµç¨‹</strong></h4><p>Read file: src&#x2F;main.rs<br><strong>å­¦ä¹ è·¯å¾„ï¼š</strong></p><ol><li><p><strong>å¯åŠ¨æµç¨‹</strong> (<code>src/main.rs</code>)</p><ul><li>ç†è§£CPUåˆå§‹åŒ–å’ŒåŒæ­¥æœºåˆ¶</li><li>æŒæ¡å¤šCPUåè°ƒå¯åŠ¨è¿‡ç¨‹</li><li>å­¦ä¹ é”™è¯¯å¤„ç†å’ŒçŠ¶æ€æ¢å¤</li></ul></li><li><p><strong>CPUç®¡ç†</strong> (<code>src/percpu.rs</code>)</p><ul><li>ç†è§£PerCpuç»“æ„å’ŒCPUçŠ¶æ€ç®¡ç†</li><li>æŒæ¡enclaveè¿›å…¥&#x2F;é€€å‡ºæœºåˆ¶</li><li>å­¦ä¹ CPUçŠ¶æ€è½¬æ¢é€»è¾‘</li></ul></li></ol><h4 id="2-å†…å­˜ç®¡ç†æ¨¡å—"><a href="#2-å†…å­˜ç®¡ç†æ¨¡å—" class="headerlink" title="2. å†…å­˜ç®¡ç†æ¨¡å—"></a>2. <strong>å†…å­˜ç®¡ç†æ¨¡å—</strong></h4><p>Read file: src&#x2F;memory&#x2F;mod.rs<br><strong>å­¦ä¹ è·¯å¾„ï¼š</strong></p><ol><li><p><strong>å†…å­˜ç®¡ç†åŸºç¡€</strong> (<code>src/memory/</code>)</p><ul><li>ç†è§£åœ°å€ç©ºé—´ç®¡ç†</li><li>æŒæ¡é¡µè¡¨ç®¡ç†æœºåˆ¶</li><li>å­¦ä¹ å†…å­˜æ˜ å°„å’Œæƒé™æ§åˆ¶</li></ul></li><li><p><strong>EPCç®¡ç†</strong> (<code>src/memory/cmr.rs</code>)</p><ul><li>ç†è§£Enclave Page Cache</li><li>æŒæ¡EPCå†…å­˜åˆ†é…å’Œå›æ”¶</li><li>å­¦ä¹ å†…å­˜åŠ å¯†æœºåˆ¶</li></ul></li></ol><h4 id="3-Enclaveç®¡ç†æ¨¡å—"><a href="#3-Enclaveç®¡ç†æ¨¡å—" class="headerlink" title="3. Enclaveç®¡ç†æ¨¡å—"></a>3. <strong>Enclaveç®¡ç†æ¨¡å—</strong></h4><p>Read file: src&#x2F;enclave&#x2F;manager.rs<br><strong>å­¦ä¹ è·¯å¾„ï¼š</strong></p><ol><li><p><strong>Enclaveç”Ÿå‘½å‘¨æœŸç®¡ç†</strong> (<code>src/enclave/</code>)</p><ul><li>ç†è§£enclaveåˆ›å»ºã€åˆå§‹åŒ–ã€é”€æ¯æµç¨‹</li><li>æŒæ¡enclaveçŠ¶æ€ç®¡ç†</li><li>å­¦ä¹ enclaveå†…å­˜ç®¡ç†</li></ul></li><li><p><strong>EPCMç®¡ç†</strong> (<code>src/enclave/epcm.rs</code>)</p><ul><li>ç†è§£Enclave Page Cache Map</li><li>æŒæ¡é¡µé¢æƒé™æ§åˆ¶</li><li>å­¦ä¹ å†…å­˜è®¿é—®éªŒè¯</li></ul></li><li><p><strong>çº¿ç¨‹ç®¡ç†</strong> (<code>src/enclave/thread.rs</code>)</p><ul><li>ç†è§£enclaveçº¿ç¨‹çŠ¶æ€</li><li>æŒæ¡enclaveè¿›å…¥&#x2F;é€€å‡ºæœºåˆ¶</li><li>å­¦ä¹ å¼‚å¸¸å¤„ç†</li></ul></li></ol><h3 id="ç¬¬ä¸‰é˜¶æ®µï¼šæ¶æ„ç‰¹å®šæ¨¡å—"><a href="#ç¬¬ä¸‰é˜¶æ®µï¼šæ¶æ„ç‰¹å®šæ¨¡å—" class="headerlink" title="ç¬¬ä¸‰é˜¶æ®µï¼šæ¶æ„ç‰¹å®šæ¨¡å—"></a>ç¬¬ä¸‰é˜¶æ®µï¼šæ¶æ„ç‰¹å®šæ¨¡å—</h3><h4 id="1-x86-64æ¶æ„æ”¯æŒ"><a href="#1-x86-64æ¶æ„æ”¯æŒ" class="headerlink" title="1. x86_64æ¶æ„æ”¯æŒ"></a>1. <strong>x86_64æ¶æ„æ”¯æŒ</strong></h4><p>Read file: src&#x2F;arch&#x2F;x86_64&#x2F;vmm.rs<br><strong>å­¦ä¹ è·¯å¾„ï¼š</strong></p><ol><li><p><strong>Intel VMXæ”¯æŒ</strong> (<code>src/arch/x86_64/intel/</code>)</p><ul><li>ç†è§£VMCSç»“æ„å’Œç®¡ç†</li><li>æŒæ¡VM Exitå¤„ç†æœºåˆ¶</li><li>å­¦ä¹ EPTé¡µè¡¨ç®¡ç†</li></ul></li><li><p><strong>AMD SVMæ”¯æŒ</strong> (<code>src/arch/x86_64/amd/</code>)</p><ul><li>ç†è§£VMCBç»“æ„å’Œç®¡ç†</li><li>æŒæ¡SVM Exitå¤„ç†æœºåˆ¶</li><li>å­¦ä¹ NPTé¡µè¡¨ç®¡ç†</li></ul></li></ol><h3 id="ç¬¬å››é˜¶æ®µï¼šé«˜çº§ç‰¹æ€§å’Œä¼˜åŒ–"><a href="#ç¬¬å››é˜¶æ®µï¼šé«˜çº§ç‰¹æ€§å’Œä¼˜åŒ–" class="headerlink" title="ç¬¬å››é˜¶æ®µï¼šé«˜çº§ç‰¹æ€§å’Œä¼˜åŒ–"></a>ç¬¬å››é˜¶æ®µï¼šé«˜çº§ç‰¹æ€§å’Œä¼˜åŒ–</h3><h4 id="1-å®‰å…¨æœºåˆ¶"><a href="#1-å®‰å…¨æœºåˆ¶" class="headerlink" title="1. å®‰å…¨æœºåˆ¶"></a>1. <strong>å®‰å…¨æœºåˆ¶</strong></h4><p>Read file: src&#x2F;enclave&#x2F;measure.rs<br><strong>å­¦ä¹ è·¯å¾„ï¼š</strong></p><ol><li><p><strong>æµ‹é‡æœºåˆ¶</strong> (<code>src/enclave/measure.rs</code>)</p><ul><li>ç†è§£enclaveå®Œæ•´æ€§æµ‹é‡</li><li>æŒæ¡SHA256å“ˆå¸Œè®¡ç®—</li><li>å­¦ä¹ æµ‹é‡çŠ¶æ€ç®¡ç†</li></ul></li><li><p><strong>æŠ¥å‘Šå’Œè®¤è¯</strong> (<code>src/enclave/report.rs</code>)</p><ul><li>ç†è§£è¿œç¨‹è®¤è¯æœºåˆ¶</li><li>æŒæ¡æŠ¥å‘Šç”Ÿæˆå’ŒéªŒè¯</li><li>å­¦ä¹ å¯†é’¥ç®¡ç†</li></ul></li></ol><h4 id="2-æ€§èƒ½ä¼˜åŒ–"><a href="#2-æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="2. æ€§èƒ½ä¼˜åŒ–"></a>2. <strong>æ€§èƒ½ä¼˜åŒ–</strong></h4><p>Read file: src&#x2F;enclave&#x2F;tlb_track.rs<br><strong>å­¦ä¹ è·¯å¾„ï¼š</strong></p><ol><li><p><strong>TLBç®¡ç†</strong> (<code>src/enclave/tlb_track.rs</code>)</p><ul><li>ç†è§£TLBåˆ·æ–°è·Ÿè¸ªæœºåˆ¶</li><li>æŒæ¡å¤šCPUåè°ƒæœºåˆ¶</li><li>å­¦ä¹ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</li></ul></li><li><p><strong>å†…å­˜å›æ”¶</strong> (<code>src/enclave/reclaim.rs</code>)</p><ul><li>ç†è§£EPCé¡µé¢å›æ”¶æœºåˆ¶</li><li>æŒæ¡å†…å­˜å‹ç¼©å’ŒåŠ å¯†</li><li>å­¦ä¹ å†…å­˜ç®¡ç†ä¼˜åŒ–</li></ul></li></ol><h3 id="ç¬¬äº”é˜¶æ®µï¼šå®è·µå’Œè°ƒè¯•"><a href="#ç¬¬äº”é˜¶æ®µï¼šå®è·µå’Œè°ƒè¯•" class="headerlink" title="ç¬¬äº”é˜¶æ®µï¼šå®è·µå’Œè°ƒè¯•"></a>ç¬¬äº”é˜¶æ®µï¼šå®è·µå’Œè°ƒè¯•</h3><h4 id="1-æ„å»ºå’Œéƒ¨ç½²"><a href="#1-æ„å»ºå’Œéƒ¨ç½²" class="headerlink" title="1. æ„å»ºå’Œéƒ¨ç½²"></a>1. <strong>æ„å»ºå’Œéƒ¨ç½²</strong></h4><p>Read file: scripts&#x2F;build_and_install_hyperenclave.sh<br><strong>å­¦ä¹ è·¯å¾„ï¼š</strong></p><ol><li><p><strong>æ„å»ºç³»ç»Ÿ</strong> (<code>Makefile</code>, <code>scripts/</code>)</p><ul><li>ç†è§£æ„å»ºé…ç½®å’Œä¾èµ–ç®¡ç†</li><li>æŒæ¡ä¸åŒCPUå‚å•†çš„æ„å»ºé€‰é¡¹</li><li>å­¦ä¹ éƒ¨ç½²å’Œå®‰è£…æµç¨‹</li></ul></li><li><p><strong>è°ƒè¯•å’Œæµ‹è¯•</strong></p><ul><li>å­¦ä¹ æ—¥å¿—ç³»ç»Ÿå’Œè°ƒè¯•æŠ€å·§</li><li>æŒæ¡æ€§èƒ½åˆ†æå’Œä¼˜åŒ–</li><li>ç†è§£é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶</li></ul></li></ol><h3 id="å­¦ä¹ å»ºè®®å’Œèµ„æº"><a href="#å­¦ä¹ å»ºè®®å’Œèµ„æº" class="headerlink" title="å­¦ä¹ å»ºè®®å’Œèµ„æº"></a>å­¦ä¹ å»ºè®®å’Œèµ„æº</h3><h4 id="1-å­¦ä¹ é¡ºåºå»ºè®®"><a href="#1-å­¦ä¹ é¡ºåºå»ºè®®" class="headerlink" title="1. å­¦ä¹ é¡ºåºå»ºè®®"></a>1. <strong>å­¦ä¹ é¡ºåºå»ºè®®</strong></h4><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    A[åŸºç¡€æ¦‚å¿µ] --&gt; B[å¯åŠ¨æµç¨‹]    B --&gt; C[å†…å­˜ç®¡ç†]    C --&gt; D[Enclaveç®¡ç†]    D --&gt; E[æ¶æ„æ”¯æŒ]    E --&gt; F[å®‰å…¨æœºåˆ¶]    F --&gt; G[æ€§èƒ½ä¼˜åŒ–]    G --&gt; H[å®è·µè°ƒè¯•]  </pre></div><h4 id="2-é‡ç‚¹å­¦ä¹ æ–‡ä»¶"><a href="#2-é‡ç‚¹å­¦ä¹ æ–‡ä»¶" class="headerlink" title="2. é‡ç‚¹å­¦ä¹ æ–‡ä»¶"></a>2. <strong>é‡ç‚¹å­¦ä¹ æ–‡ä»¶</strong></h4><p><strong>æ ¸å¿ƒæ–‡ä»¶ï¼š</strong></p><ul><li><code>src/main.rs</code> - ç³»ç»Ÿå…¥å£</li><li><code>src/percpu.rs</code> - CPUç®¡ç†</li><li><code>src/enclave/mod.rs</code> - Enclaveæ ¸å¿ƒ</li><li><code>src/memory/mod.rs</code> - å†…å­˜ç®¡ç†</li><li><code>src/hypercall/mod.rs</code> - æ¥å£å®šä¹‰</li></ul><p><strong>æ¶æ„æ–‡ä»¶ï¼š</strong></p><ul><li><code>src/arch/x86_64/intel/</code> - Intelæ”¯æŒ</li><li><code>src/arch/x86_64/amd/</code> - AMDæ”¯æŒ</li><li><code>crates/libvmm/</code> - è™šæ‹ŸåŒ–åº“</li></ul><h4 id="3-å®è·µå»ºè®®"><a href="#3-å®è·µå»ºè®®" class="headerlink" title="3. å®è·µå»ºè®®"></a>3. <strong>å®è·µå»ºè®®</strong></h4><ol><li><p><strong>ç¯å¢ƒæ­å»º</strong></p><ul><li>æ­å»ºå¼€å‘ç¯å¢ƒ</li><li>ç¼–è¯‘å’Œè¿è¡Œé¡¹ç›®</li><li>ç†è§£æ„å»ºæµç¨‹</li></ul></li><li><p><strong>ä»£ç é˜…è¯»</strong></p><ul><li>ä»main.rså¼€å§‹ï¼Œç†è§£å¯åŠ¨æµç¨‹</li><li>é‡ç‚¹ç†è§£enclaveç”Ÿå‘½å‘¨æœŸ</li><li>æŒæ¡å†…å­˜ç®¡ç†æœºåˆ¶</li></ul></li><li><p><strong>è°ƒè¯•å®è·µ</strong></p><ul><li>ä½¿ç”¨æ—¥å¿—ç³»ç»Ÿè°ƒè¯•</li><li>ç†è§£é”™è¯¯å¤„ç†æœºåˆ¶</li><li>å­¦ä¹ æ€§èƒ½åˆ†ææ–¹æ³•</li></ul></li><li><p><strong>æ‰©å±•å­¦ä¹ </strong></p><ul><li>é˜…è¯»ç›¸å…³è®ºæ–‡</li><li>ç†è§£SGXæ ‡å‡†</li><li>å­¦ä¹ è™šæ‹ŸåŒ–æŠ€æœ¯</li></ul></li></ol><h4 id="4-å­¦ä¹ èµ„æº"><a href="#4-å­¦ä¹ èµ„æº" class="headerlink" title="4. å­¦ä¹ èµ„æº"></a>4. <strong>å­¦ä¹ èµ„æº</strong></h4><ul><li><strong>å®˜æ–¹æ–‡æ¡£</strong>ï¼šREADME.mdå’Œè®ºæ–‡</li><li><strong>ä»£ç æ³¨é‡Š</strong>ï¼šè¯¦ç»†çš„ä»£ç æ³¨é‡Š</li><li><strong>æµ‹è¯•ç”¨ä¾‹</strong>ï¼šdemos&#x2F;ç›®å½•ä¸‹çš„ç¤ºä¾‹</li><li><strong>ç›¸å…³æŠ€æœ¯</strong>ï¼šSGXã€è™šæ‹ŸåŒ–ã€Rust</li></ul><p>é€šè¿‡è¿™ä¸ªç³»ç»Ÿæ€§çš„å­¦ä¹ è®¡åˆ’ï¼Œæ‚¨å¯ä»¥é€æ­¥æ·±å…¥ç†è§£HyperEnclaveçš„æ¶æ„è®¾è®¡å’Œå®ç°ç»†èŠ‚ï¼ŒæŒæ¡å¯ä¿¡æ‰§è¡Œç¯å¢ƒçš„æ ¸å¿ƒæŠ€æœ¯ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> éšç§è®¡ç®— </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HyperEnclave </tag>
            
            <tag> å­¦ä¹ è·¯çº¿ </tag>
            
            <tag> TEE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä» CSVæ–‡ä»¶çš„åŠ è½½ã€åˆ†åŒºå’Œå¤„ç† æ¥ç†è§£ RDD</title>
      <link href="/2025/07/15/%E4%BB%8E%20CSV%E6%96%87%E4%BB%B6%E7%9A%84%E5%8A%A0%E8%BD%BD%E3%80%81%E5%88%86%E5%8C%BA%E5%92%8C%E5%A4%84%E7%90%86%20%E6%9D%A5%E7%90%86%E8%A7%A3%20RDD/"/>
      <url>/2025/07/15/%E4%BB%8E%20CSV%E6%96%87%E4%BB%B6%E7%9A%84%E5%8A%A0%E8%BD%BD%E3%80%81%E5%88%86%E5%8C%BA%E5%92%8C%E5%A4%84%E7%90%86%20%E6%9D%A5%E7%90%86%E8%A7%A3%20RDD/</url>
      
        <content type="html"><![CDATA[<h1 id="ä»-CSVæ–‡ä»¶çš„åŠ è½½ã€åˆ†åŒºå’Œå¤„ç†-æ¥ç†è§£-RDD"><a href="#ä»-CSVæ–‡ä»¶çš„åŠ è½½ã€åˆ†åŒºå’Œå¤„ç†-æ¥ç†è§£-RDD" class="headerlink" title="ä» CSVæ–‡ä»¶çš„åŠ è½½ã€åˆ†åŒºå’Œå¤„ç† æ¥ç†è§£ RDD"></a>ä» CSVæ–‡ä»¶çš„åŠ è½½ã€åˆ†åŒºå’Œå¤„ç† æ¥ç†è§£ RDD</h1><p>ä¹‹å‰çœ‹äº†ä¸å°‘å…³äºSpark RDDçš„ä»‹ç»ï¼Œå…¶å®çœ‹éƒ½å¯ä»¥çœ‹å¾—æ‡‚ï¼Œä½†æ˜¯è¿˜æ˜¯ä¼šæœ‰ä¸å°‘ç–‘é—®ã€‚æ¯”å¦‚</p><ul><li>RDD æ˜¯æŠ½è±¡çš„ï¼Œé‚£ä¹ˆRDDä¸­çš„è°ˆåˆ°çš„åˆ†åŒºåˆ—è¡¨ã€ä¾èµ–å…³ç³»ã€è®¡ç®—å‡½æ•°åˆæ˜¯å­˜å‚¨åœ¨å“ªçš„ï¼Ÿ</li><li>æ‰§è¡Œå™¨æ˜¯æ€ä¹ˆå°±æ‹¿åˆ°äº†è‡ªå·±çš„ åˆ†åŒºæ•°æ®çš„ï¼Ÿä¼šä¸ä¼šå¤šæ‹¿åˆ°å…¶ä»–åˆ†åŒºçš„æ•°æ®</li><li>RDDåˆ†åŒºåˆ—è¡¨ä¸­å¦‚æœä¸å­˜å‚¨çœŸå®æ•°æ®ï¼Œé‚£ä¹ˆè¿™äº›æ•°æ®åˆæ˜¯æ€ä¹ˆåˆ†é…åˆ°æ‰§è¡Œå™¨çš„ï¼Ÿ</li></ul><p>è¿™é‡Œæˆ‘æ‹†è§£ä¸€ä¸ª csvæ–‡ä»¶åœ¨ HDFSä¸Š å¦‚ä½•è¢« Spark RDD åŠ è½½ã€åˆ†åŒºå’Œå­˜å‚¨çš„ï¼Œå°±åº”è¯¥å¾ˆæ–¹ä¾¿ç†è§£ RDDäº†ã€‚</p><hr><h2 id="1-HDFS-å­˜å‚¨å±‚é¢ï¼šç‰©ç†åˆ†å—"><a href="#1-HDFS-å­˜å‚¨å±‚é¢ï¼šç‰©ç†åˆ†å—" class="headerlink" title="1. HDFS å­˜å‚¨å±‚é¢ï¼šç‰©ç†åˆ†å—"></a><strong>1. HDFS å­˜å‚¨å±‚é¢ï¼šç‰©ç†åˆ†å—</strong></h2><ul><li><strong>å‡è®¾ï¼š</strong> æ¯”å¦‚ CSV æ–‡ä»¶ <code>data.csv</code> å¤§å°ä¸º <strong>256MB</strong>ï¼ŒHDFS é»˜è®¤å—å¤§å°ï¼ˆblock sizeï¼‰ä¸º <strong>128MB</strong>ã€‚</li><li><strong>HDFS è¡Œä¸ºï¼š</strong><ul><li>HDFS ä¼šè‡ªåŠ¨å°†æ–‡ä»¶åˆ‡å‰²æˆ 2 ä¸ªç‰©ç†å—ï¼š<ul><li><code>Block 0</code>: 0 - 128MB (å­˜å‚¨åœ¨èŠ‚ç‚¹ <code>Node1</code> å’Œ <code>Node2</code> ä¸Šï¼Œå‰¯æœ¬)</li><li><code>Block 1</code>: 128MB - 256MB (å­˜å‚¨åœ¨èŠ‚ç‚¹ <code>Node3</code> å’Œ <code>Node4</code> ä¸Šï¼Œå‰¯æœ¬)</li></ul></li><li><strong>å…³é”®ç‚¹ï¼š</strong> è¿™æ˜¯ <strong>ç‰©ç†å­˜å‚¨çº§åˆ«</strong> çš„åˆ†å—ï¼Œç”± HDFS æ§åˆ¶ï¼Œç›®çš„æ˜¯å®¹é”™å’Œåˆ†å¸ƒå¼å­˜å‚¨ã€‚</li></ul></li></ul><hr><h2 id="2-Spark-è¯»å–ï¼šåˆ›å»ºåˆå§‹-RDD-textFile"><a href="#2-Spark-è¯»å–ï¼šåˆ›å»ºåˆå§‹-RDD-textFile" class="headerlink" title="2. Spark è¯»å–ï¼šåˆ›å»ºåˆå§‹ RDD (textFile)"></a><strong>2. Spark è¯»å–ï¼šåˆ›å»ºåˆå§‹ RDD (<code>textFile</code>)</strong></h2><p>å½“æˆ‘åœ¨ Spark ä¸­æ‰§è¡Œï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">JavaRDD</span>&lt;<span class="type">String</span>&gt; rdd = sc.textFile(<span class="string">&quot;hdfs://data/users.csv&quot;</span>);  </span><br></pre></td></tr></table></figure><p>Spark ä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p><h4 id="a-ç¡®å®š-RDD-çš„åˆ†åŒºæ•°"><a href="#a-ç¡®å®š-RDD-çš„åˆ†åŒºæ•°" class="headerlink" title="a) ç¡®å®š RDD çš„åˆ†åŒºæ•°"></a><strong>a) ç¡®å®š RDD çš„åˆ†åŒºæ•°</strong></h4><ul><li><p><strong>é»˜è®¤è§„åˆ™ï¼š</strong> æ¯ä¸ª HDFS Block å¯¹åº” <strong>1ä¸ª RDD åˆ†åŒº</strong>ã€‚</p><ul><li>æœ¬ä¾‹ä¸­ï¼šæ–‡ä»¶è¢«åˆ‡åˆ†æˆ 2 ä¸ª HDFS Block â†’ RDD ä¼šæœ‰ <strong>2 ä¸ªåˆ†åŒº</strong> (<code>Partition 0</code>, <code>Partition 1</code>)ã€‚</li></ul></li><li><p><strong>æ‰‹åŠ¨æŒ‡å®šåˆ†åŒºæ•°ï¼š</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> rdd = sc.textFile(<span class="string">&quot;hdfs://path/to/data.csv&quot;</span>, <span class="number">4</span>) <span class="comment">// å¼ºåˆ¶åˆ†æˆ4ä¸ªåˆ†åŒº</span></span><br></pre></td></tr></table></figure><ul><li>å¦‚æœæ–‡ä»¶ä¸å¯åˆ‡åˆ†ï¼ˆå¦‚ GZIP å‹ç¼©æ–‡ä»¶ï¼‰ï¼Œåˆ†åŒºæ•° &#x3D; æ–‡ä»¶æ•°ã€‚</li><li>å¦‚æœæ–‡ä»¶å¯åˆ‡åˆ†ï¼ˆå¦‚ CSVï¼‰ï¼ŒSpark ä¼šå°è¯•æŒ‰å­—èŠ‚åˆ’åˆ†æˆ 4 ä»½ï¼ˆå¯èƒ½<strong>ä¸ç­‰åˆ†</strong>ï¼‰ã€‚</li></ul></li></ul><h4 id="b-åˆ†åŒºä¸-HDFS-Block-çš„æ˜ å°„"><a href="#b-åˆ†åŒºä¸-HDFS-Block-çš„æ˜ å°„" class="headerlink" title="b) åˆ†åŒºä¸ HDFS Block çš„æ˜ å°„"></a><strong>b) åˆ†åŒºä¸ HDFS Block çš„æ˜ å°„</strong></h4><table><thead><tr><th>RDD åˆ†åŒº</th><th>è´Ÿè´£çš„ HDFS Block èŒƒå›´</th><th>æ•°æ®ä½ç½®åå¥½ (Preferred Locations)</th></tr></thead><tbody><tr><td>åˆ†åŒº 0</td><td>0 - 128MB (Block 0)</td><td><code>[Node1, Node2]</code> (Block 0 çš„å­˜å‚¨èŠ‚ç‚¹)</td></tr><tr><td>åˆ†åŒº 1</td><td>128MB - 256MB (Block 1)</td><td><code>[Node3, Node4]</code> (Block 1 çš„å­˜å‚¨èŠ‚ç‚¹)</td></tr></tbody></table><blockquote><p>âœ… <strong>æå…¶é‡è¦ï¼š</strong> æ¯ä¸ª RDD åˆ†åŒºçŸ¥é“å®ƒåº”è¯¥è¯»å–å“ªä¸ª HDFS Blockï¼Œå¹¶ä¸”çŸ¥é“è¯¥ Block å­˜å‚¨åœ¨å“ªäº›èŠ‚ç‚¹ä¸Šã€‚</p></blockquote><hr><h2 id="3-æ•°æ®å­˜å‚¨ä½ç½®ï¼šè¿è¡Œæ—¶è¿‡ç¨‹"><a href="#3-æ•°æ®å­˜å‚¨ä½ç½®ï¼šè¿è¡Œæ—¶è¿‡ç¨‹" class="headerlink" title="3. æ•°æ®å­˜å‚¨ä½ç½®ï¼šè¿è¡Œæ—¶è¿‡ç¨‹"></a><strong>3. æ•°æ®å­˜å‚¨ä½ç½®ï¼šè¿è¡Œæ—¶è¿‡ç¨‹</strong></h2><h4 id="æ‰§è¡Œé˜¶æ®µï¼š"><a href="#æ‰§è¡Œé˜¶æ®µï¼š" class="headerlink" title="æ‰§è¡Œé˜¶æ®µï¼š"></a><strong>æ‰§è¡Œé˜¶æ®µï¼š</strong></h4><ol><li><strong>Driver åˆ†é…ä»»åŠ¡ï¼š</strong><ul><li>æ ¹æ® RDD åˆ†åŒºçš„ä½ç½®åå¥½ï¼ŒDriver å°†ä»»åŠ¡åˆ†é…ç»™ç¦»æ•°æ®æœ€è¿‘çš„ Executorã€‚</li><li>ä¾‹å¦‚ï¼š<ul><li><code>Task 0</code> (å¤„ç†åˆ†åŒº0) â†’ ä¼˜å…ˆè°ƒåº¦åˆ° <code>Node1</code> æˆ– <code>Node2</code> ä¸Šçš„ Executorã€‚</li><li><code>Task 1</code> (å¤„ç†åˆ†åŒº1) â†’ ä¼˜å…ˆè°ƒåº¦åˆ° <code>Node3</code> æˆ– <code>Node4</code> ä¸Šçš„ Executorã€‚</li></ul></li></ul></li><li><strong>Executor è¯»å–æ•°æ®ï¼š</strong><ul><li>æ¯ä¸ª Task å¯åŠ¨åï¼Œé€šè¿‡ <strong>HDFS Client</strong> è¯»å–å¯¹åº”çš„ Blockã€‚</li><li><strong>æœ¬åœ°æ€§ä¼˜åŒ–ï¼š</strong><ul><li>å¦‚æœ Task åœ¨ <code>Node1</code> æ‰§è¡Œï¼Œå®ƒç›´æ¥ä»æœ¬æœºçš„ HDFS DataNode è¯»å– <code>Block 0</code> (<strong>æœ¬åœ°è¯»å–</strong>ï¼Œé€Ÿåº¦æœ€å¿«)ã€‚</li><li>å¦‚æœ <code>Node1</code> ç¹å¿™ï¼ŒTask å¯èƒ½è°ƒåº¦åˆ° <code>Node2</code> â†’ ä»åŒä¸€æœºæ¶å†…çš„ <code>Node1</code> è¯»å– (<strong>æœºæ¶æœ¬åœ°æ€§</strong>ï¼Œé€Ÿåº¦ä¸­ç­‰)ã€‚</li><li>æœ€å·®æƒ…å†µï¼šè·¨æœºæ¶è¯»å–ï¼ˆå¦‚è°ƒåº¦åˆ° <code>Node5</code> è¯»å– <code>Block 0</code>ï¼‰ã€‚</li></ul></li></ul></li><li><strong>æ•°æ®åœ¨ Executor ä¸­çš„å­˜å‚¨ï¼š</strong><ul><li>è¯»å–çš„æ•°æ®ä»¥ <strong>è¡Œï¼ˆStringï¼‰</strong> çš„å½¢å¼åŠ è½½åˆ°å†…å­˜ï¼ˆæ¯è¡Œæ˜¯ CSV ä¸­çš„ä¸€æ¡è®°å½•ï¼‰ã€‚</li><li>å­˜å‚¨ä½ç½®ï¼š<strong>Executor çš„ JVM å †å†…å­˜</strong> ä¸­ï¼ˆé™¤éæŒ‡å®šäº†æŒä¹…åŒ–çº§åˆ«ï¼‰ã€‚</li><li>å­˜å‚¨å½¢å¼ï¼šæŒ‰åˆ†åŒºå­˜å‚¨ï¼Œæ¯ä¸ª Task å¤„ç†çš„åˆ†åŒºæ•°æ®ç‹¬ç«‹å­˜åœ¨äºæ‰§è¡Œå®ƒçš„ Executor å†…å­˜ä¸­ã€‚</li></ul></li></ol><hr><h2 id="4-åˆ†åŒºæ•°æ®å†…å®¹"><a href="#4-åˆ†åŒºæ•°æ®å†…å®¹" class="headerlink" title="4. åˆ†åŒºæ•°æ®å†…å®¹"></a><strong>4. åˆ†åŒºæ•°æ®å†…å®¹</strong></h2><p>å‡è®¾ CSV å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1,Alice,Beijing</span><br><span class="line">2,Bob,Shanghai</span><br><span class="line">1001,David,Shanghai</span><br><span class="line">1002,Eve,Shenzhen</span><br></pre></td></tr></table></figure><ul><li><p><strong>åˆ†åŒº 0 å¯èƒ½åŒ…å«ï¼š</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">&quot;1,Alice,Beijing&quot;</span>, <span class="string">&quot;2,Bob,Shanghai&quot;</span>, <span class="string">&quot;3,Charlie,Beijing&quot;</span>, ...]  # å‰<span class="number">128</span>MB</span><br></pre></td></tr></table></figure></li><li><p><strong>åˆ†åŒº 1 å¯èƒ½åŒ…å«ï¼š</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">&quot;1001,David,Shanghai&quot;</span>, <span class="string">&quot;1002,Eve,Shenzhen&quot;</span>, ...]  # å<span class="number">128</span>MB</span><br></pre></td></tr></table></figure></li></ul><blockquote><p>âš ï¸ <strong>æ³¨æ„ï¼š</strong> åˆ†åŒºè¾¹ç•Œæ˜¯<strong>æŒ‰å­—èŠ‚åˆ‡å‰²çš„</strong>ï¼Œå¯èƒ½<strong>æˆªæ–­æŸä¸€è¡Œ</strong>ï¼ˆæœ€åä¸€è¡Œä¸å®Œæ•´ï¼‰ã€‚Spark ä¼šç¡®ä¿ï¼š</p><ul><li>åˆ†åŒº0è¯»å–åˆ°ç¬¬ä¸€ä¸ªå®Œæ•´è¡Œ â†’ æœ€åä¸€ä¸ªå®Œæ•´è¡Œ</li><li>åˆ†åŒº1ä»ä¸Šä¸ªåˆ†åŒºæœªè¯»å®Œçš„ä½ç½®å¼€å§‹ â†’ ç›´åˆ°æ–‡ä»¶ç»“æŸ</li></ul></blockquote><hr><h2 id="5-è¯¦ç»†æ‰§è¡Œè¿‡ç¨‹"><a href="#5-è¯¦ç»†æ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="5.è¯¦ç»†æ‰§è¡Œè¿‡ç¨‹"></a>5.è¯¦ç»†æ‰§è¡Œè¿‡ç¨‹</h2><p>æˆ‘ä»¬æ‰€ç¼–å†™çš„sparkä»£ç æ•´ä½“å¦‚ä¸‹ï¼Œåˆšåˆšè¯´çš„æ˜¯ åŠ è½½csvéƒ¨åˆ†ï¼Œä¸‹é¢è¯´çš„å°±æ˜¯ æ•°æ®æ¸…æ´—ä¸èšåˆäº†ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">JavaSparkContext sc = new JavaSparkContext();</span><br><span class="line"></span><br><span class="line">// 1. åŠ è½½ CSVï¼ˆå‡è®¾æ–‡ä»¶ 256MBï¼Œ2ä¸ªHDFS Blockï¼‰</span><br><span class="line">JavaRDD&lt;String&gt; rdd = sc.textFile(&quot;hdfs://data/users.csv&quot;);  // 2ä¸ªåˆ†åŒº</span><br><span class="line"></span><br><span class="line">// 2. æ•°æ®æ¸…æ´—ï¼ˆè¿‡æ»¤ + æå–å­—æ®µï¼‰</span><br><span class="line">JavaPairRDD&lt;String, Integer&gt; cleanedRdd = rdd.filter(new Function&lt;String, Boolean&gt;() &#123;</span><br><span class="line">  @Override</span><br><span class="line">  public Boolean call(String line) throws Exception &#123;</span><br><span class="line">    return !line.contains(&quot;id&quot;);  // è¿‡æ»¤æ ‡é¢˜è¡Œ</span><br><span class="line">  &#125;</span><br><span class="line">&#125;).mapToPair(new PairFunction&lt;String, String, Integer&gt;() &#123;</span><br><span class="line">  @Override</span><br><span class="line">  public Tuple2&lt;String, Integer&gt; call(String line) throws Exception &#123;</span><br><span class="line">    String[] arr = line.split(&quot;,&quot;);</span><br><span class="line">    return new Tuple2&lt;&gt;(arr[2], 1);  // (åŸå¸‚, 1)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// 3. Shuffleæ“ä½œï¼ˆæŒ‰åŸå¸‚èšåˆï¼‰</span><br><span class="line">JavaPairRDD&lt;String, Integer&gt; cityCountRdd = cleanedRdd.reduceByKey(new Function2&lt;Integer, Integer, Integer&gt;() &#123;</span><br><span class="line">  @Override</span><br><span class="line">  public Integer call(Integer a, Integer b) throws Exception &#123;</span><br><span class="line">    return a + b;  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// 4. è§¦å‘è®¡ç®—ï¼ˆè¡ŒåŠ¨æ“ä½œï¼‰</span><br><span class="line">List&lt;Tuple2&lt;String, Integer&gt;&gt; results = cityCountRdd.collect();</span><br><span class="line"></span><br><span class="line">// è¾“å‡ºç»“æœ</span><br><span class="line">for (Tuple2&lt;String, Integer&gt; result : results) &#123;</span><br><span class="line">  System.out.println(result._1() + &quot;: &quot; + result._2());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é˜¶æ®µ1ï¼šåŠ è½½ä¸åˆå§‹åˆ†åŒºï¼ˆçª„ä¾èµ–ï¼‰"><a href="#é˜¶æ®µ1ï¼šåŠ è½½ä¸åˆå§‹åˆ†åŒºï¼ˆçª„ä¾èµ–ï¼‰" class="headerlink" title="é˜¶æ®µ1ï¼šåŠ è½½ä¸åˆå§‹åˆ†åŒºï¼ˆçª„ä¾èµ–ï¼‰"></a>é˜¶æ®µ1ï¼šåŠ è½½ä¸åˆå§‹åˆ†åŒºï¼ˆçª„ä¾èµ–ï¼‰</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TB    A[HDFS Block 0] --&gt;|è¯»å–| B[Executor1-Part0]    C[HDFS Block 1] --&gt;|è¯»å–| D[Executor2-Part1]  </pre></div><h3 id="é˜¶æ®µ2ï¼šè½¬æ¢æ“ä½œï¼ˆçª„ä¾èµ–-æµæ°´çº¿æ‰§è¡Œï¼‰"><a href="#é˜¶æ®µ2ï¼šè½¬æ¢æ“ä½œï¼ˆçª„ä¾èµ–-æµæ°´çº¿æ‰§è¡Œï¼‰" class="headerlink" title="é˜¶æ®µ2ï¼šè½¬æ¢æ“ä½œï¼ˆçª„ä¾èµ– - æµæ°´çº¿æ‰§è¡Œï¼‰"></a>é˜¶æ®µ2ï¼šè½¬æ¢æ“ä½œï¼ˆçª„ä¾èµ– - æµæ°´çº¿æ‰§è¡Œï¼‰</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph LR    B[Part0åŸå§‹æ•°æ®] --&gt; E[filter+mapæ“ä½œ] --&gt; F[Part0æ¸…æ´—å]    D[Part1åŸå§‹æ•°æ®] --&gt; G[filter+mapæ“ä½œ] --&gt; H[Part1æ¸…æ´—å]  </pre></div><ul><li><p><strong>Executor1 å¤„ç† Partition 0</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># è¾“å…¥</span><br><span class="line">[&quot;1,Alice,Beijing&quot;, &quot;2,Bob,Shanghai&quot;, ...]</span><br><span class="line"></span><br><span class="line"># è½¬æ¢å</span><br><span class="line">[(&quot;Beijing&quot;,1), (&quot;Shanghai&quot;,1), (&quot;Beijing&quot;,1), ...]</span><br></pre></td></tr></table></figure></li><li><p><strong>Executor2 å¤„ç† Partition 1</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># è¾“å…¥</span><br><span class="line">[&quot;1001,David,Shanghai&quot;, &quot;1002,Eve,Shenzhen&quot;, ...]</span><br><span class="line"></span><br><span class="line"># è½¬æ¢å</span><br><span class="line">[(&quot;Shanghai&quot;,1), (&quot;Shenzhen&quot;,1), ...]</span><br></pre></td></tr></table></figure></li></ul><p>è¿™é‡Œæˆ‘ä»¬å…¶å®å¯ä»¥å‘ç°ä¸€ä¸ªç‰¹ç‚¹ï¼Œå°±æ˜¯æ¯ä¸ª Executor éƒ½æ•´å¥½å¤„ç†çš„æ˜¯ è‡ªå·±æœºå™¨ä¸Šçš„ Partitionæ•°æ®ã€‚</p><blockquote><p>âœ… <strong>å…³é”®ç‰¹ç‚¹</strong>ï¼šæ— éœ€è·¨èŠ‚ç‚¹é€šä¿¡ï¼Œå„åˆ†åŒºç‹¬ç«‹å¤„ç†</p></blockquote><h3 id="é˜¶æ®µ3ï¼šShuffleæ“ä½œï¼ˆå®½ä¾èµ–-æ•°æ®é‡ç»„ï¼‰"><a href="#é˜¶æ®µ3ï¼šShuffleæ“ä½œï¼ˆå®½ä¾èµ–-æ•°æ®é‡ç»„ï¼‰" class="headerlink" title="é˜¶æ®µ3ï¼šShuffleæ“ä½œï¼ˆå®½ä¾èµ– - æ•°æ®é‡ç»„ï¼‰"></a>é˜¶æ®µ3ï¼šShuffleæ“ä½œï¼ˆå®½ä¾èµ– - æ•°æ®é‡ç»„ï¼‰</h3><h4 id="æ­¥éª¤-1-åˆ’åˆ†-Stageï¼ˆDriverå†³ç­–ï¼‰"><a href="#æ­¥éª¤-1-åˆ’åˆ†-Stageï¼ˆDriverå†³ç­–ï¼‰" class="headerlink" title="æ­¥éª¤ 1: åˆ’åˆ† Stageï¼ˆDriverå†³ç­–ï¼‰"></a>æ­¥éª¤ 1: åˆ’åˆ† Stageï¼ˆDriverå†³ç­–ï¼‰</h4><ul><li>è¯†åˆ« <code>reduceByKey</code> æ˜¯å®½ä¾èµ– â†’ åˆ›å»ºæ–° Stage</li><li><strong>Stage 0</strong>: æ‰€æœ‰çª„ä¾èµ–æ“ä½œï¼ˆtextFile â†’ filter â†’ mapï¼‰</li><li><strong>Stage 1</strong>: reduceByKey</li></ul><h4 id="æ­¥éª¤-2ï¼šStage-0-æ‰§è¡Œï¼ˆShuffle-Writeï¼‰"><a href="#æ­¥éª¤-2ï¼šStage-0-æ‰§è¡Œï¼ˆShuffle-Writeï¼‰" class="headerlink" title="æ­¥éª¤ 2ï¼šStage 0 æ‰§è¡Œï¼ˆShuffle Writeï¼‰"></a>æ­¥éª¤ 2ï¼šStage 0 æ‰§è¡Œï¼ˆShuffle Writeï¼‰</h4><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TB    F[Part0æ¸…æ´—å] --&gt; I[æŒ‰åŸå¸‚åˆ†åŒº]    H[Part1æ¸…æ´—å] --&gt; J[æŒ‰åŸå¸‚åˆ†åŒº]    I --&gt; K[Executor1æœ¬åœ°ç£ç›˜]    J --&gt; L[Executor2æœ¬åœ°ç£ç›˜]  </pre></div><ul><li><p><strong>Shuffle å†™æ“ä½œ</strong>ï¼š</p><ul><li><p>æ¯ä¸ª Task å°†è‡ªå·±çš„æ•°æ® <strong>æŒ‰ Keyï¼ˆåŸå¸‚ï¼‰åˆ†ç»„</strong></p></li><li><p>æ ¹æ®é»˜è®¤åˆ†åŒºå™¨ï¼ˆ<code>HashPartitioner</code>ï¼‰è®¡ç®—ç›®æ ‡åˆ†åŒº</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Partition 0: Beijing, Shenzhen â†’ Hashå€¼%2=0</span><br><span class="line">Partition 1: Shanghai â†’ Hashå€¼%2=1</span><br></pre></td></tr></table></figure></li><li><p>å°†æ•°æ®å†™å…¥ <strong>æœ¬åœ°ç£ç›˜çš„ Shuffle ä¸´æ—¶æ–‡ä»¶</strong>ï¼Œå¹¶ç”Ÿæˆç´¢å¼•æ–‡ä»¶</p></li></ul></li><li><p><strong>Executor1 å†™å…¥</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># æ–‡ä»¶ï¼šshuffle_0_temp_0.data (Partition <span class="number">0</span>)</span><br><span class="line">(<span class="string">&quot;Beijing&quot;</span>,<span class="number">1</span>), (<span class="string">&quot;Beijing&quot;</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"># æ–‡ä»¶ï¼šshuffle_0_temp_1.data (Partition <span class="number">1</span>)</span><br><span class="line">(<span class="string">&quot;Shanghai&quot;</span>,<span class="number">1</span>)</span><br></pre></td></tr></table></figure></li><li><p><strong>Executor2 å†™å…¥</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># æ–‡ä»¶ï¼šshuffle_1_temp_0.data (Partition <span class="number">0</span>)</span><br><span class="line">(<span class="string">&quot;Shenzhen&quot;</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"># æ–‡ä»¶ï¼šshuffle_1_temp_1.data (Partition <span class="number">1</span>)</span><br><span class="line">(<span class="string">&quot;Shanghai&quot;</span>,<span class="number">1</span>)</span><br></pre></td></tr></table></figure></li></ul><h4 id="æ­¥éª¤-3-Stage-1-æ‰§è¡Œï¼ˆShuffle-Readï¼‰"><a href="#æ­¥éª¤-3-Stage-1-æ‰§è¡Œï¼ˆShuffle-Readï¼‰" class="headerlink" title="æ­¥éª¤ 3: Stage 1 æ‰§è¡Œï¼ˆShuffle Readï¼‰"></a>æ­¥éª¤ 3: Stage 1 æ‰§è¡Œï¼ˆShuffle Readï¼‰</h4><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph LR    K[Shuffleæ–‡ä»¶] --&gt; M[TaskA]    L[Shuffleæ–‡ä»¶] --&gt; M    K --&gt; N[TaskB]    L --&gt; N  </pre></div><ul><li><p><strong>Driver åˆ›å»ºæ–° Task</strong>ï¼š</p><ul><li>Task Aï¼šå¤„ç†æœ€ç»ˆ RDD çš„ Partition 0ï¼ˆKey: Beijing, Shenzhenï¼‰</li><li>Task Bï¼šå¤„ç†æœ€ç»ˆ RDD çš„ Partition 1ï¼ˆKey: Shanghaiï¼‰</li></ul></li><li><p><strong>Shuffle è¯»æ“ä½œ</strong>ï¼š</p><ul><li><p>Task A ä» <strong>æ‰€æœ‰ Executor</strong> æ‹‰å–å±äº Partition 0 çš„æ•°æ®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># ä» Executor1 æ‹‰å–ï¼š(&quot;Beijing&quot;,1), (&quot;Beijing&quot;,1)</span><br><span class="line"># ä» Executor2 æ‹‰å–ï¼š(&quot;Shenzhen&quot;,1)</span><br></pre></td></tr></table></figure></li><li><p>Task B æ‹‰å– Partition 1 çš„æ•°æ®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># ä» Executor1 æ‹‰å–ï¼š(&quot;Shanghai&quot;,1)</span><br><span class="line"># ä» Executor2 æ‹‰å–ï¼š(&quot;Shanghai&quot;,1)</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>èšåˆè®¡ç®—</strong>ï¼š</p><ul><li><p>Task A æ‰§è¡Œ <code>reduceByKey</code>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Beijing: 1 + 1 = 2</span><br><span class="line">Shenzhen: 1</span><br></pre></td></tr></table></figure></li><li><p>Task B æ‰§è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Shanghai: 1 + 1 = 2</span><br></pre></td></tr></table></figure></li></ul></li></ul><h3 id="é˜¶æ®µ-4-ç»“æœæ”¶é›†"><a href="#é˜¶æ®µ-4-ç»“æœæ”¶é›†" class="headerlink" title="é˜¶æ®µ 4: ç»“æœæ”¶é›†"></a>é˜¶æ®µ 4: ç»“æœæ”¶é›†</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph LR    M[TaskAç»“æœ] --&gt; O[Driver]    N[TaskBç»“æœ] --&gt; O  </pre></div><p>æœ€ç»ˆæ•°æ®åˆ°è¾¾ Driverï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[(&quot;Beijing&quot;,2), (&quot;Shenzhen&quot;,1), (&quot;Shanghai&quot;,2)]</span><br></pre></td></tr></table></figure><h3 id="Shuffle-æ•°æ®æµå…¨æ™¯"><a href="#Shuffle-æ•°æ®æµå…¨æ™¯" class="headerlink" title="Shuffle æ•°æ®æµå…¨æ™¯"></a>Shuffle æ•°æ®æµå…¨æ™¯</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  flowchart LR    subgraph Stage 0        A[Executor1] --&gt;|Shuffle Write| D[ç£ç›˜æ–‡ä»¶]        B[Executor2] --&gt;|Shuffle Write| E[ç£ç›˜æ–‡ä»¶]    end        subgraph Stage 1        D --&gt;|Part0æ•°æ®| F[TaskA]        E --&gt;|Part0æ•°æ®| F        D --&gt;|Part1æ•°æ®| G[TaskB]        E --&gt;|Part1æ•°æ®| G    end        F --&gt; H[æœ€ç»ˆç»“æœ]    G --&gt; H  </pre></div><p>ä¸ºä»€ä¹ˆéœ€è¦ Shuffleï¼Ÿå› ä¸ºæœ‰äº›æ“ä½œå¿…é¡»è¦å°†æ•°æ®è¿›è¡Œé‡æ–°åˆ†åŒºæ‰å¥½è¿›è¡Œè®¡ç®—ã€ç»Ÿè®¡ã€‚</p><table><thead><tr><th align="left">æ“ä½œç±»å‹</th><th align="left">æ•°æ®ç§»åŠ¨</th><th align="left">ç½‘ç»œå¼€é”€</th><th align="left">å…¸å‹æ“ä½œ</th></tr></thead><tbody><tr><td align="left"><strong>çª„ä¾èµ–</strong></td><td align="left">æ•°æ®ä¸åŠ¨ Taskç§»åŠ¨</td><td align="left">ä½</td><td align="left"><code>map</code>, <code>filter</code></td></tr><tr><td align="left"><strong>å®½ä¾èµ–</strong></td><td align="left">æ•°æ®æŒ‰Keyé‡ç»„ è·¨èŠ‚ç‚¹ä¼ è¾“</td><td align="left">é«˜</td><td align="left"><code>groupByKey</code>, <code>reduceByKey</code></td></tr></tbody></table><p>é€šè¿‡è¿™ä¸ªå®Œæ•´ç¤ºä¾‹ï¼Œå°±å¯ä»¥çœ‹åˆ°ï¼š</p><ol><li><strong>åˆ†åŒº</strong>å¦‚ä½•ä»ç‰©ç†å­˜å‚¨æ˜ å°„åˆ°è®¡ç®—å•å…ƒ</li><li><strong>çª„ä¾èµ–</strong>å¦‚ä½•å®ç°é›¶æ•°æ®ä¼ è¾“çš„æµæ°´çº¿</li><li><strong>å®½ä¾èµ–</strong>å¦‚ä½•é€šè¿‡Shuffleé‡ç»„æ•°æ®</li><li><strong>Stageåˆ’åˆ†</strong>å¦‚ä½•é©±åŠ¨åˆ†å¸ƒå¼è®¡ç®—</li></ol><p>è¿™æ­£æ˜¯ RDD æŠ½è±¡çš„æ ¸å¿ƒä»·å€¼â€”â€”é€šè¿‡æ¸…æ™°çš„é˜¶æ®µåˆ’åˆ†å’Œä¾èµ–å…³ç³»ï¼Œåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­é«˜æ•ˆæ‰§è¡Œå¤æ‚è®¡ç®—ã€‚ä¸éœ€è¦æ‹˜æŸäºé€šè¿‡æ¦‚å¿µç†è§£ RDDã€‚</p><h3 id="5-æ ¸å¿ƒé—®é¢˜è§£ç­”"><a href="#5-æ ¸å¿ƒé—®é¢˜è§£ç­”" class="headerlink" title="5. æ ¸å¿ƒé—®é¢˜è§£ç­”"></a><strong>5. æ ¸å¿ƒé—®é¢˜è§£ç­”</strong></h3><h4 id="Q1ï¼šåˆ†åŒºæ•°æ®å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿ"><a href="#Q1ï¼šåˆ†åŒºæ•°æ®å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿ" class="headerlink" title="Q1ï¼šåˆ†åŒºæ•°æ®å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿ"></a><strong>Q1ï¼šåˆ†åŒºæ•°æ®å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿ</strong></h4><ul><li><strong>åŸå§‹æ•°æ®ï¼š</strong> ç‰©ç†å­˜å‚¨åœ¨ HDFS DataNodeï¼ˆå¦‚ <code>Node1</code>, <code>Node2</code>, <code>Node3</code>, <code>Node4</code>ï¼‰ã€‚</li><li><strong>RDD å¤„ç†æ—¶ï¼š</strong> <ul><li>è®¡ç®—ä¸­ï¼šæ•°æ®åŠ è½½åˆ° <strong>Executor çš„ JVM å †å†…å­˜</strong>ã€‚</li><li>æŒä¹…åŒ–åï¼šå¯ç¼“å­˜åˆ° Executor å†…å­˜&#x2F;ç£ç›˜ï¼ˆé€šè¿‡ <code>rdd.persist()</code>ï¼‰ã€‚</li></ul></li></ul><h4 id="Q2ï¼šä¼šå¤šè·å–æ•°æ®å—ï¼Ÿ"><a href="#Q2ï¼šä¼šå¤šè·å–æ•°æ®å—ï¼Ÿ" class="headerlink" title="Q2ï¼šä¼šå¤šè·å–æ•°æ®å—ï¼Ÿ"></a><strong>Q2ï¼šä¼šå¤šè·å–æ•°æ®å—ï¼Ÿ</strong></h4><ul><li><p><strong>ç»å¯¹ä¸ä¼šï¼</strong> æ¯ä¸ª Task åªè¯»å–<strong>è‡ªå·±åˆ†åŒºæ˜ å°„çš„ HDFS Block èŒƒå›´</strong>ã€‚</p></li><li><p><strong>ä¼˜åŒ–æœºåˆ¶ï¼š</strong></p><table><thead><tr><th>æœºåˆ¶</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>ä½ç½®æ„ŸçŸ¥è°ƒåº¦</td><td>Task ä¼˜å…ˆåœ¨å­˜æœ‰æ•°æ®çš„èŠ‚ç‚¹æ‰§è¡Œ</td></tr><tr><td>HDFS å—å®šä½</td><td>Executor ç›´æ¥è¯»å–æœ¬åœ°æˆ–é‚»è¿‘èŠ‚ç‚¹çš„æ•°æ®å—</td></tr><tr><td>ç²¾ç¡®çš„å­—èŠ‚èŒƒå›´è¯»å–</td><td>æ¯ä¸ª Task åªè¯»å–åˆ†é…ç»™å®ƒçš„è¿ç»­å­—èŠ‚åŒºé—´</td></tr></tbody></table></li></ul><hr><h3 id="6-æ€»ç»“ï¼š"><a href="#6-æ€»ç»“ï¼š" class="headerlink" title="6. æ€»ç»“ï¼š"></a><strong>6. æ€»ç»“ï¼š</strong></h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  sequenceDiagram    participant Driver    participant Executor    participant HDFS    participant LocalDisk    participant OtherExecutor    Note over Driver: åˆå§‹åŒ–é˜¶æ®µ    Driver-&gt;&gt;Driver: 1. åˆ›å»ºSparkContext    Driver-&gt;&gt;Driver: 2. æ„å»ºRDDä¾èµ–å›¾ (DAG)    Driver-&gt;&gt;Driver: 3. åˆ’åˆ†Stage (æ ¹æ®Shuffleè¾¹ç•Œ)    Driver-&gt;&gt;Driver: 4. è®¡ç®—åˆ†åŒº&#x2F;ä»»åŠ¡åˆ—è¡¨ï¼ˆæ„å»ºDAGï¼‰    Note over Driver,Executor: Stage 0 æ‰§è¡Œ (ShuffleMapStage)    Driver-&gt;&gt;Executor: 5. å‘é€Stage0ä»»åŠ¡ï¼ˆå«åˆ†åŒºè®¡ç®—é€»è¾‘ï¼‰    Executor-&gt;&gt;HDFS: 6. è¯»å–æŒ‡å®šæ•°æ®å—    Executor-&gt;&gt;Executor: 7. æ‰§è¡Œæµæ°´çº¿æ“ä½œï¼š&lt;br&#x2F;&gt;- Map&lt;br&#x2F;&gt;- Filter&lt;br&#x2F;&gt;- Partitioning    Executor-&gt;&gt;Executor: 8. å°†ç»“æœå†™å…¥å†…å­˜ç¼“å†²åŒº    Executor-&gt;&gt;LocalDisk: 9. Shuffle Writeï¼š&lt;br&#x2F;&gt;- æ’åº&lt;br&#x2F;&gt;- æŒ‰åˆ†åŒºå†™å…¥æœ¬åœ°ç£ç›˜æ–‡ä»¶    Executor-&gt;&gt;Driver: 10. æ±‡æŠ¥çŠ¶æ€å’ŒShuffleå…ƒæ•°æ®    Note over Driver,Executor: Stage 1 æ‰§è¡Œ (ResultStage)    Driver-&gt;&gt;Executor: 11. å‘é€Stage1ä»»åŠ¡ï¼ˆå«èšåˆé€»è¾‘ï¼‰    Executor-&gt;&gt;OtherExecutor: 12. Shuffle Readï¼š&lt;br&#x2F;&gt;- æ ¹æ®å…ƒæ•°æ®æ‹‰å–å¯¹åº”åˆ†åŒºçš„æ•°æ®    Executor-&gt;&gt;Executor: 13. åˆå¹¶æ•°æ®ï¼ˆå¯èƒ½æº¢å†™åˆ°ç£ç›˜ï¼‰    Executor-&gt;&gt;Executor: 14. æ‰§è¡Œèšåˆæ“ä½œï¼š&lt;br&#x2F;&gt;- reduceByKey&lt;br&#x2F;&gt;- combine    Executor-&gt;&gt;Driver: 15. è¿”å›æœ€ç»ˆç»“æœåˆ†åŒºæ•°æ®    Driver-&gt;&gt;Driver: 16. æ±‡æ€»æ‰€æœ‰åˆ†åŒºçš„ç»“æœ  </pre></div><p><strong>å…³é”®åŸåˆ™ï¼š</strong></p><ol><li><p><strong>ç§»åŠ¨è®¡ç®—ï¼Œè€Œéæ•°æ®</strong>ï¼šå°† Task å‘é€åˆ°æ•°æ®æ‰€åœ¨çš„èŠ‚ç‚¹ã€‚ç®€è€Œè¨€ä¹‹å°±æ˜¯è®©è®¡ç®—å°½é‡è´´è¿‘æ•°æ®ã€‚æˆ‘ä»¬å¯èƒ½ä¹ æƒ¯äºå°†æ•°æ®ä¼ è¾“åˆ°è®¡ç®—ç«¯è¿›è¡Œå¤„ç†ï¼Œæ¯”å¦‚æŸ¥è¯¢mysqlã€esã€mongoã€‚ä½†æ˜¯å¯¹äºå¤§æ•°æ®å¤„ç†æ¥è¯´ï¼Œè®¡ç®—é€»è¾‘å¥½ç§»åŠ¨ï¼Œè€Œæ•°æ®éš¾ç§»åŠ¨ã€‚</p></li><li><p><strong>åˆ†è€Œæ²»ä¹‹</strong>ï¼šå¤§æ–‡ä»¶è¢«åˆ’åˆ†æˆå°åˆ†åŒºï¼Œå¹¶è¡Œå¤„ç†ã€‚è¿™å…¶å®å°±æ˜¯ç±»ä¼¼äºåç«¯å¸¸ç”¨çš„å¤šçº¿ç¨‹ï¼Œå¤§æ–‡ä»¶åˆ’åŒºä¹‹åï¼Œå¹¶è¡Œå¤„ç†ï¼Œé‚£ä¹ˆæ•´ä½“é€Ÿåº¦å°±å¾—åˆ°æå¤§æå‡ã€‚</p></li><li><p><strong>ç²¾å‡†æ˜ å°„</strong>ï¼šRDD åˆ†åŒºä¸ HDFS Block ä¸€ä¸€å¯¹åº”ï¼Œæ— é‡å¤è¯»å–ã€‚ä¸å…‰HDFSå¤©ç„¶åˆ†å—ï¼Œå…¶å®å¾ˆå¤šåˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿéƒ½æ˜¯æœ‰åˆ†å—æœºåˆ¶çš„ï¼Œæ¯”å¦‚S3ã€‚å¯¹äºä¸å¤©ç„¶æ”¯æŒåˆ†å—çš„æ•°æ®æºï¼Œæ¯”å¦‚mysql æ˜¯å¯ä»¥äººå·¥åˆ†åŒºçš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¹¶è¡Œè¯»å– MySQL (æŒ‰ç…§åˆ†åŒºé”®è¿›è¡Œåˆ’åˆ†åŒºï¼Œæ­¤å¤„å°±æ˜¯1-1000000æ˜¯åˆ†åŒº0ï¼Œ1000001-2000000æ˜¯åˆ†åŒº1 ä»¥æ­¤ç±»æ¨...)</span></span><br><span class="line"><span class="type">val</span> <span class="variable">jdbcDF</span> <span class="operator">=</span> spark.read</span><br><span class="line">  .format(<span class="string">&quot;jdbc&quot;</span>)</span><br><span class="line">  .option(<span class="string">&quot;url&quot;</span>, <span class="string">&quot;jdbc:mysql://host:3306/db&quot;</span>)</span><br><span class="line">  .option(<span class="string">&quot;dbtable&quot;</span>, <span class="string">&quot;orders&quot;</span>)</span><br><span class="line">  .option(<span class="string">&quot;partitionColumn&quot;</span>, <span class="string">&quot;order_id&quot;</span>)   <span class="comment">// åˆ†åŒºé”®</span></span><br><span class="line">  .option(<span class="string">&quot;lowerBound&quot;</span>, <span class="number">1</span>)                <span class="comment">// æœ€å°å€¼</span></span><br><span class="line">  .option(<span class="string">&quot;upperBound&quot;</span>, <span class="number">1000000</span>)          <span class="comment">// æœ€å¤§å€¼</span></span><br><span class="line">  .option(<span class="string">&quot;numPartitions&quot;</span>, <span class="number">10</span>)            <span class="comment">// åˆ†åŒºæ•°</span></span><br><span class="line">  .load()</span><br></pre></td></tr></table></figure></li></ol><p>é€šè¿‡è¿™ç§è®¾è®¡ï¼ŒSpark èƒ½é«˜æ•ˆå¤„ç†è¿œå¤§äºå†…å­˜çš„åˆ†å¸ƒå¼æ–‡ä»¶ï¼Œè€Œå¼€å‘è€…åªéœ€å†™å‡ è¡Œä»£ç ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HDFS </tag>
            
            <tag> Spark </tag>
            
            <tag> å¤§æ•°æ® </tag>
            
            <tag> RDD </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æµ…å° Spring AI</title>
      <link href="/2025/07/11/%E6%B5%85%E5%B0%9D%20Spring%20AI/"/>
      <url>/2025/07/11/%E6%B5%85%E5%B0%9D%20Spring%20AI/</url>
      
        <content type="html"><![CDATA[<h1 id="æµ…å°-Spring-AI"><a href="#æµ…å°-Spring-AI" class="headerlink" title="æµ…å° Spring AI"></a>æµ…å° Spring AI</h1><p>ä¸€ç›´æƒ³è¦ä½“éªŒä¸‹ Spring AIï¼Œæœ€è¿‘è‡ªå·±çš„ä¸€ä¸ªå·¥å…·æœ‰è¿™ä¸ªéœ€æ±‚ï¼Œæ‰€ä»¥è¿™é‡Œå‡†å¤‡ä½¿ç”¨ä¸‹ã€‚</p><h2 id="1-IDEA-æ–°å»º-Springé¡¹ç›®"><a href="#1-IDEA-æ–°å»º-Springé¡¹ç›®" class="headerlink" title="1.IDEA æ–°å»º Springé¡¹ç›®"></a>1.IDEA æ–°å»º Springé¡¹ç›®</h2><p>1ï¼‰è¿™é‡Œå¯ä»¥æ ¹æ®è‡ªå·±çš„å–œå¥½é€‰æ‹© é¡¹ç›®åã€jdkç‰ˆæœ¬ç­‰</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/image-20250711115133493.png" alt="image-20250711115133493"></p><p>2ï¼‰è¿™é‡Œé€‰æ‹© åœ¨aiä¸­é€‰æ‹© openAI å³å¯ã€‚ç„¶åæˆ‘å¦å¤–é€‰æ‹©äº†ä¸€ä¸ª Spring Webï¼Œå› ä¸ºæˆ‘æ˜¯éœ€è¦å¯¹å¤–æä¾›APIçš„ã€‚</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/image-20250711115054272.png" alt="image-20250711115054272"></p><h2 id="2-é¡¹ç›®ä»£ç ä¸é…ç½®"><a href="#2-é¡¹ç›®ä»£ç ä¸é…ç½®" class="headerlink" title="2.é¡¹ç›®ä»£ç ä¸é…ç½®"></a>2.é¡¹ç›®ä»£ç ä¸é…ç½®</h2><p>é¡¹ç›®ç›®å½•æ–‡ä»¶ç»“æ„ï¼š<br><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/image-20250711143606389.png" alt="image-20250711143606389"></p><p>1ï¼‰é…ç½® application.yml</p><p>è¿™é‡Œæˆ‘å¯¹æ¥çš„æ˜¯ ç¡…åŸºæµåŠ¨çš„apiï¼Œç„¶åé€‰æ‹©çš„æ¨¡å‹æ˜¯ deepseek-ai&#x2F;DeepSeek-V3ã€‚è¿™äº›éƒ½å¯ä»¥è‡ªç”±é€‰æ‹©ï¼Œå¦‚æœä½ ä¹‹å‰æ²¡æœ‰æ³¨å†Œä½¿ç”¨è¿‡è¿™ç§æ¨¡å‹apiæä¾›å•†ï¼Œå¯ä»¥å…ˆçœ‹ä¸‹ç¬¬ä¸‰èŠ‚ã€‚</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">x-ai</span></span><br><span class="line">  <span class="attr">ai:</span></span><br><span class="line">    <span class="attr">openai:</span></span><br><span class="line">      <span class="attr">api-key:</span> <span class="string">sk-qoiiuryvclnaqbmhqqquyg*****vyrincprsfvirxafrr</span></span><br><span class="line">      <span class="attr">base-url:</span> <span class="string">https://api.siliconflow.cn/</span></span><br><span class="line">      <span class="attr">chat:</span></span><br><span class="line">        <span class="attr">options:</span></span><br><span class="line">          <span class="attr">model:</span> <span class="string">deepseek-ai/DeepSeek-V3</span></span><br></pre></td></tr></table></figure><p>2ï¼‰é…ç½®å®¢æˆ·ç«¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xr.xai.config;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.openai.OpenAiChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatClient <span class="title function_">chatClient</span><span class="params">(OpenAiChatModel model)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ChatClient</span><br><span class="line">                .builder(model)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>3ï¼‰ç¼–å†™ ChatController</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xr.xai.controller;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/ai&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ChatClient chatClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/chat&quot;, produces = &quot;text/html;charset=utf8&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">chat</span><span class="params">(String prompt)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> chatClient.prompt()</span><br><span class="line">                .user(prompt)</span><br><span class="line">                .stream()</span><br><span class="line">                .content();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å®Œæˆä»¥ä¸Šï¼Œå°±å¯ä»¥ç¼–è¯‘è¿è¡Œäº†ã€‚æ€ä¹ˆæµ‹è¯•å‘¢ï¼Ÿ</p><p>åœ¨æµè§ˆå™¨ä¸Šè¾“å…¥è¿™ä¸ªURL æˆ–è€… postmanè¯·æ±‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8080/ai/chat?prompt=Spring AI æ€ä¹ˆä½¿ç”¨</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/image-20250711144033075.png" alt="image-20250711144033075"></p><h2 id="3-ç¡…åŸºæµåŠ¨æ³¨å†Œä¸ä½¿ç”¨"><a href="#3-ç¡…åŸºæµåŠ¨æ³¨å†Œä¸ä½¿ç”¨" class="headerlink" title="3.ç¡…åŸºæµåŠ¨æ³¨å†Œä¸ä½¿ç”¨"></a>3.ç¡…åŸºæµåŠ¨æ³¨å†Œä¸ä½¿ç”¨</h2><p>æˆ‘çš„é‚€è¯·æ³¨å†Œé“¾æ¥ï¼š<a href="https://cloud.siliconflow.cn/i/19016f2p%EF%BC%8C%E6%B3%A8%E5%86%8C%E5%AE%8C%E6%88%90%E5%90%8E%E5%8F%AF%E4%BB%A5%E6%96%B0%E5%BB%BAAPI%E5%AF%86%E9%92%A5%E3%80%82">https://cloud.siliconflow.cn/i/19016f2pï¼Œæ³¨å†Œå®Œæˆåå¯ä»¥æ–°å»ºAPIå¯†é’¥ã€‚</a></p><p>1ï¼‰æ–°å»ºAPIå¯†é’¥å¹¶å¤åˆ¶ç²˜è´´åˆ°é¡¹ç›®ä¸­</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/image-20250711144837854.png" alt="image-20250711144837854"></p><p>2ï¼‰é€‰æ‹©æƒ³è¦ä½¿ç”¨çš„æ¨¡å‹</p><p>å¯ä»¥ä½¿ç”¨çš„æ¨¡å‹æœ‰å¾ˆå¤šï¼Œæœ‰äº›æ˜¯ä½å‚æ•°çš„æ˜¯å…è´¹çš„ï¼Œè¿™é‡Œä½ æƒ³è¦ä½¿ç”¨ä»€ä¹ˆï¼Œå°±æŠŠä»–çš„åå­— å¤åˆ¶ç²˜è´´åˆ°é¡¹ç›®é…ç½®ä¸­ã€‚</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/image-20250711145432916.png" alt="image-20250711145432916"></p>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Spring </tag>
            
            <tag> AI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Sparkæ ¸å¿ƒæ¦‚å¿µä¸æ‡’æƒ°è®¡ç®—[æœªä¿®è®¢å®Œ]</title>
      <link href="/2025/07/10/Spark%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E4%B8%8E%E6%87%92%E6%83%B0%E8%AE%A1%E7%AE%97/"/>
      <url>/2025/07/10/Spark%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E4%B8%8E%E6%87%92%E6%83%B0%E8%AE%A1%E7%AE%97/</url>
      
        <content type="html"><![CDATA[<h1 id="Sparkæ ¸å¿ƒæ¦‚å¿µä¸æ‡’æƒ°è®¡ç®—-æœªä¿®è®¢å®Œ"><a href="#Sparkæ ¸å¿ƒæ¦‚å¿µä¸æ‡’æƒ°è®¡ç®—-æœªä¿®è®¢å®Œ" class="headerlink" title="Sparkæ ¸å¿ƒæ¦‚å¿µä¸æ‡’æƒ°è®¡ç®—[æœªä¿®è®¢å®Œ]"></a>Sparkæ ¸å¿ƒæ¦‚å¿µä¸æ‡’æƒ°è®¡ç®—[æœªä¿®è®¢å®Œ]</h1><h2 id="1-Sparkæ ¸å¿ƒæ•°æ®ç»“æ„ï¼šRDDä¸å…±äº«å˜é‡"><a href="#1-Sparkæ ¸å¿ƒæ•°æ®ç»“æ„ï¼šRDDä¸å…±äº«å˜é‡" class="headerlink" title="1. Sparkæ ¸å¿ƒæ•°æ®ç»“æ„ï¼šRDDä¸å…±äº«å˜é‡"></a>1. Sparkæ ¸å¿ƒæ•°æ®ç»“æ„ï¼šRDDä¸å…±äº«å˜é‡</h2><p>åœ¨æ·±å…¥æ¢è®¨ç®—å­ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»é¦–å…ˆç†è§£Sparkå·¥ä½œçš„åŸºæœ¬å•å…ƒï¼š<strong>å¼¹æ€§åˆ†å¸ƒå¼æ•°æ®é›†ï¼ˆRDDï¼‰</strong> å’Œ <strong>å…±äº«å˜é‡</strong>ã€‚å®ƒä»¬æ˜¯æ„å»ºæ‰€æœ‰Sparkåº”ç”¨çš„åŸºç¡€ã€‚</p><h3 id="1-1-æ ¸å¿ƒæŠ½è±¡ï¼šå¼¹æ€§åˆ†å¸ƒå¼æ•°æ®é›†ï¼ˆRDDï¼‰"><a href="#1-1-æ ¸å¿ƒæŠ½è±¡ï¼šå¼¹æ€§åˆ†å¸ƒå¼æ•°æ®é›†ï¼ˆRDDï¼‰" class="headerlink" title="1.1 æ ¸å¿ƒæŠ½è±¡ï¼šå¼¹æ€§åˆ†å¸ƒå¼æ•°æ®é›†ï¼ˆRDDï¼‰"></a>1.1 æ ¸å¿ƒæŠ½è±¡ï¼šå¼¹æ€§åˆ†å¸ƒå¼æ•°æ®é›†ï¼ˆRDDï¼‰</h3><p><strong>RDD (Resilient Distributed Dataset)</strong> æ˜¯Sparkæœ€æ ¸å¿ƒçš„æŠ½è±¡ã€‚å¯ä»¥å°†å…¶ç†è§£ä¸ºä¸€ä¸ª<strong>ä¸å¯å˜çš„ã€å¯åˆ†åŒºçš„ã€åŒ…å«å¯å¹¶è¡Œè®¡ç®—å…ƒç´ çš„å¤§å‹é›†åˆ</strong>ã€‚</p><p>æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æœ‰ä¸€æœ¬è¶…å¤§çš„ä¹¦ï¼ˆä½ çš„æµ·é‡æ•°æ®ï¼‰ï¼Œè¿™æœ¬ä¹¦å¤ªåšäº†ï¼Œä¸€ä¸ªäººæ ¹æœ¬è¯»ä¸å®Œã€‚äºæ˜¯ä½ æƒ³äº†ä¸ªåŠæ³•ï¼š</p><ol><li><strong>åˆ†å¸ƒå¼ï¼ˆDistributedï¼‰</strong>ï¼š<ul><li>ä½ æŠŠä¹¦æ’•æˆå¾ˆå¤šå°å†Œå­ï¼ˆåˆ†ç‰‡ï¼‰</li><li>åˆ†ç»™ä¸€ç¾¤æœ‹å‹ï¼ˆé›†ç¾¤ä¸­çš„è®¡ç®—æœºï¼‰æ¯äººè¯»ä¸€éƒ¨åˆ†</li></ul></li><li><strong>æ•°æ®é›†ï¼ˆDatasetï¼‰</strong>ï¼š<ul><li>è¿™æœ¬â€ä¹¦â€å°±æ˜¯ä½ çš„æ•°æ®é›†åˆ</li><li>å¯ä»¥æ˜¯æ•°å­—ã€æ–‡å­—ã€ç”¨æˆ·ä¿¡æ¯ç­‰ç­‰</li></ul></li><li><strong>å¼¹æ€§ï¼ˆResilientï¼‰</strong>ï¼š<ul><li>çªç„¶æœ‰ä¸ªæœ‹å‹æŠŠå’–å•¡æ´’åœ¨å°å†Œå­ä¸Šï¼ˆæœºå™¨æ•…éšœï¼‰</li><li>æ²¡å…³ç³»ï¼å› ä¸ºä½ è®°å¾—è¿™æœ¬ä¹¦æ˜¯æ€ä¹ˆæ’•å¼€çš„ï¼ˆè¡€ç»Ÿï¼‰</li><li>ä½ å¯ä»¥é‡æ–°å¤å°é‚£å‡ é¡µï¼ˆé‡æ–°è®¡ç®—ï¼‰</li><li>æ•´ä¸ªé˜…è¯»å·¥ä½œä¸ä¼šå› æ­¤åœæ­¢</li></ul></li></ol><p>è¿™ä¸ªå°±æ˜¯RDDçš„è®¾è®¡ç‰¹ç‚¹ï¼š</p><ul><li>**å¼¹æ€§ (Resilient)**ï¼šRDDé€šè¿‡å…¶â€œè¡€ç¼˜å…³ç³»ï¼ˆLineageï¼‰â€å¤©ç”Ÿæ”¯æŒå®¹é”™ã€‚å¦‚æœæŸä¸ªåˆ†åŒºçš„æ•°æ®ä¸¢å¤±ï¼ŒSparkå¯ä»¥æ ¹æ®è¡€ç¼˜å…³ç³»é‡æ–°è®¡ç®—å‡ºè¯¥åˆ†åŒºï¼Œè€Œæ— éœ€ä»å¤´å†æ¥ã€‚</li><li>**åˆ†å¸ƒå¼ (Distributed)**ï¼šRDDçš„æ•°æ®è¢«åˆ†æˆå¤šä¸ªåˆ†åŒºï¼ˆPartitionï¼‰ï¼Œå­˜å‚¨åœ¨é›†ç¾¤çš„ä¸åŒèŠ‚ç‚¹ä¸Šã€‚è¿™ä½¿å¾—æ•°æ®å¯ä»¥è¢«å¹¶è¡Œå¤„ç†ã€‚</li><li>**æ•°æ®é›† (Dataset)**ï¼šå®ƒæ˜¯ä¸€ä¸ªåªè¯»çš„æ•°æ®é›†åˆï¼Œå¯ä»¥å­˜å‚¨ä»»ä½•ç±»å‹çš„Javaæˆ–Pythonå¯¹è±¡ã€‚</li><li>**ä¸å¯å˜ (Immutable)*<em>ï¼šä¸€æ—¦åˆ›å»ºï¼ŒRDDå°±ä¸èƒ½è¢«ä¿®æ”¹ã€‚å¯¹RDDçš„ä»»ä½•æ“ä½œï¼ˆè½¬æ¢ï¼‰éƒ½ä¼šç”Ÿæˆä¸€ä¸ª</em>æ–°çš„*RDDã€‚è¿™ç§è®¾è®¡ç®€åŒ–äº†å¹¶å‘å’Œå®¹é”™ã€‚</li><li>**æƒ°æ€§è®¡ç®— (Lazy Evaluation)**ï¼šåœ¨Sparkä¸­ï¼Œå¯¹RDDçš„è½¬æ¢æ“ä½œï¼ˆå¦‚mapã€filterã€joinç­‰ï¼‰ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯è®°å½•ä¸‹æ“ä½œï¼ˆå½¢æˆè¡€ç¼˜å…³ç³»å›¾ï¼‰ã€‚åªæœ‰å½“é‡åˆ°ä¸€ä¸ªè¡ŒåŠ¨æ“ä½œï¼ˆå¦‚countã€collectã€saveç­‰ï¼‰æ—¶ï¼Œæ‰ä¼šè§¦å‘å®é™…çš„è®¡ç®—ã€‚</li></ul><p><strong>ä¸ºä»€ä¹ˆRDDé‡è¦ï¼Ÿ</strong></p><ul><li><strong>ä¸æ€•æ•…éšœ</strong>ï¼šæœºå™¨åäº†æ•°æ®èƒ½æ¢å¤</li><li><strong>é«˜æ•ˆå¹¶è¡Œ</strong>ï¼šä»»åŠ¡å¯ä»¥åˆ†ç»™å¾ˆå¤šæœºå™¨åŒæ—¶åš</li><li><strong>çµæ´»å¤„ç†</strong>ï¼šé€‚åˆå„ç§å¤æ‚çš„æ•°æ®å¤„ç†ä»»åŠ¡</li><li><strong>å†…å­˜è®¡ç®—</strong>ï¼šæ•°æ®å¯ä»¥æ”¾åœ¨å†…å­˜ä¸­å¤„ç†ï¼Œæ¯”è¯»ç¡¬ç›˜å¿«å¾—å¤š</li></ul><h4 id="åˆ›å»ºRDD"><a href="#åˆ›å»ºRDD" class="headerlink" title="åˆ›å»ºRDD"></a>åˆ›å»ºRDD</h4><p>åœ¨Sparkä¸­ï¼Œåˆ›å»ºRDDä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><ol><li><p><strong>å¹¶è¡ŒåŒ–ä¸€ä¸ªå·²æœ‰çš„é›†åˆ</strong>ï¼šä½¿ç”¨<code>SparkContext</code>çš„<code>parallelize</code>æ–¹æ³•ï¼Œå°†Driverç¨‹åºä¸­çš„ä¸€ä¸ªæ™®é€šé›†åˆï¼ˆå¦‚Listï¼‰è½¬æ¢ä¸ºä¸€ä¸ªåˆ†å¸ƒå¼RDDã€‚è¿™ä¸»è¦ç”¨äºå­¦ä¹ å’Œæµ‹è¯•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; data = Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>);</span><br><span class="line">JavaRDD&lt;Integer&gt; distData = sc.parallelize(data);</span><br></pre></td></tr></table></figure></li><li><p><strong>è¯»å–å¤–éƒ¨æ•°æ®æº</strong>ï¼šä»HDFSã€S3ã€æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿç­‰å¤–éƒ¨å­˜å‚¨ç³»ç»ŸåŠ è½½æ•°æ®ã€‚è¿™æ˜¯ç”Ÿäº§ç¯å¢ƒä¸­æœ€å¸¸è§çš„æ–¹å¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JavaRDD&lt;String&gt; distFile = sc.textFile(<span class="string">&quot;data.txt&quot;</span>);</span><br></pre></td></tr></table></figure></li></ol><h3 id="1-2-ä¼˜åŒ–å·¥å…·ï¼šå…±äº«å˜é‡"><a href="#1-2-ä¼˜åŒ–å·¥å…·ï¼šå…±äº«å˜é‡" class="headerlink" title="1.2 ä¼˜åŒ–å·¥å…·ï¼šå…±äº«å˜é‡"></a>1.2 ä¼˜åŒ–å·¥å…·ï¼šå…±äº«å˜é‡</h3><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œå½“æˆ‘ä»¬åœ¨Driverç«¯å®šä¹‰çš„å‡½æ•°ï¼ˆé—­åŒ…ï¼‰è¢«å‘é€åˆ°Executorä¸Šæ‰§è¡Œæ—¶ï¼Œå‡½æ•°ä¸­å¼•ç”¨çš„æ‰€æœ‰å˜é‡éƒ½ä¼šè¢«å¤åˆ¶ä¸€ä»½ï¼Œæ¯ä¸ªä»»åŠ¡éƒ½æ‹¥æœ‰ä¸€ä»½ç‹¬ç«‹çš„å‰¯æœ¬ã€‚ä½†æœ‰æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ‰€æœ‰ä»»åŠ¡é—´å…±äº«æ•°æ®ï¼Œæˆ–è€…å°†ç»“æœèšåˆå›Driverç«¯ã€‚ä¸ºæ­¤ï¼ŒSparkæä¾›äº†ä¸¤ç§ç‰¹æ®Šçš„å…±äº«å˜é‡ã€‚</p><h4 id="1-2-1-å¹¿æ’­å˜é‡-Broadcast-Variables"><a href="#1-2-1-å¹¿æ’­å˜é‡-Broadcast-Variables" class="headerlink" title="1.2.1 å¹¿æ’­å˜é‡ (Broadcast Variables)"></a>1.2.1 å¹¿æ’­å˜é‡ (Broadcast Variables)</h4><p><strong>é—®é¢˜</strong>ï¼šå½“ä¸€ä¸ªè¾ƒå¤§çš„åªè¯»å˜é‡ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªæŸ¥æ‰¾è¡¨æˆ–é…ç½®å¯¹è±¡ï¼‰è¢«å¤šä¸ªä»»åŠ¡ä½¿ç”¨æ—¶ï¼Œå¦‚æœç›´æ¥åœ¨é—­åŒ…ä¸­å¼•ç”¨å®ƒï¼Œè¿™ä¸ªå˜é‡ä¼šè¢«åºåˆ—åŒ–å¹¶éšæ¯ä¸ªä»»åŠ¡ä¸€èµ·å‘é€åˆ°Executorï¼Œé€ æˆå·¨å¤§çš„ç½‘ç»œå¼€é”€ã€‚</p><p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šä½¿ç”¨å¹¿æ’­å˜é‡ã€‚å¹¿æ’­å˜é‡åªä¼šè¢«å‘é€åˆ°æ¯ä¸ªExecutorä¸€æ¬¡ï¼Œç„¶åè¯¥Executorä¸Šçš„æ‰€æœ‰ä»»åŠ¡éƒ½å¯ä»¥å…±äº«è¿™ä»½æ•°æ®ã€‚è¿™æå¤§åœ°å‡å°‘äº†ç½‘ç»œä¼ è¾“å’ŒDriverçš„è´Ÿè½½ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æœ‰ä¸€ä¸ªè¾ƒå¤§çš„åªè¯»æŸ¥æ‰¾è¡¨</span></span><br><span class="line">Map&lt;String, String&gt; lookupTable = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">lookupTable.put(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;Apple&quot;</span>);</span><br><span class="line">lookupTable.put(<span class="string">&quot;B&quot;</span>, <span class="string">&quot;Ball&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†å…¶å¹¿æ’­å‡ºå»</span></span><br><span class="line">Broadcast&lt;Map&lt;String, String&gt;&gt; broadcastTable = sc.broadcast(lookupTable);</span><br><span class="line"></span><br><span class="line">JavaRDD&lt;String&gt; rdd = sc.parallelize(Arrays.asList(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨ç®—å­ä¸­é€šè¿‡.value()æ–¹æ³•è®¿é—®å¹¿æ’­å˜é‡</span></span><br><span class="line">rdd.map(key -&gt; &#123;</span><br><span class="line">    Map&lt;String, String&gt; localTable = broadcastTable.value();</span><br><span class="line">    <span class="keyword">return</span> localTable.get(key);</span><br><span class="line">&#125;).collect();</span><br></pre></td></tr></table></figure><h4 id="1-2-2-ç´¯åŠ å™¨-Accumulators"><a href="#1-2-2-ç´¯åŠ å™¨-Accumulators" class="headerlink" title="1.2.2 ç´¯åŠ å™¨ (Accumulators)"></a>1.2.2 ç´¯åŠ å™¨ (Accumulators)</h4><p><strong>é—®é¢˜</strong>ï¼šä»»åŠ¡åœ¨Executorä¸Šæ‰§è¡Œæ—¶æ˜¯ç›¸äº’éš”ç¦»çš„ï¼Œæˆ‘ä»¬æ— æ³•åœ¨ç®—å­å†…éƒ¨å®‰å…¨åœ°ä¿®æ”¹ä¸€ä¸ªå¤–éƒ¨å˜é‡ï¼ˆä¾‹å¦‚ï¼Œç”¨ä¸€ä¸ªè®¡æ•°å™¨æ¥ç»Ÿè®¡ç¬¦åˆæŸä¸ªæ¡ä»¶çš„è®°å½•æ•°ï¼‰ã€‚</p><p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šä½¿ç”¨ç´¯åŠ å™¨ã€‚ç´¯åŠ å™¨æ˜¯ä¸€ç§åªæ”¯æŒâ€œç´¯åŠ â€æ“ä½œçš„å˜é‡ï¼Œå®ƒå¯ä»¥åœ¨æ‰€æœ‰ä»»åŠ¡ä¸­è¢«å®‰å…¨åœ°å¹¶è¡Œæ›´æ–°ï¼Œæœ€ç»ˆç”±Driverç«¯ç»Ÿä¸€è¯»å–ç»“æœã€‚SparkåŸç”Ÿæ”¯æŒæ•°å€¼å‹å’Œé›†åˆç±»å‹çš„ç´¯åŠ å™¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªé•¿æ•´å‹ç´¯åŠ å™¨ï¼Œåˆå§‹å€¼ä¸º0</span></span><br><span class="line"><span class="type">LongAccumulator</span> <span class="variable">counter</span> <span class="operator">=</span> sc.sc().longAccumulator(<span class="string">&quot;MyCounter&quot;</span>);</span><br><span class="line"></span><br><span class="line">JavaRDD&lt;Integer&gt; numbers = sc.parallelize(Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨ç®—å­ä¸­é€šè¿‡.add()æ–¹æ³•ç´¯åŠ </span></span><br><span class="line">numbers.foreach(x -&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (x % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">        counter.add(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨Driverç«¯é€šè¿‡.value()è·å–æœ€ç»ˆç»“æœ</span></span><br><span class="line">System.out.println(<span class="string">&quot;å¶æ•°çš„æ•°é‡æ˜¯: &quot;</span> + counter.value()); <span class="comment">// è¾“å‡º: 2</span></span><br></pre></td></tr></table></figure><p>ç†è§£äº†RDDã€å¹¿æ’­å˜é‡å’Œç´¯åŠ å™¨ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹å­¦ä¹ å¦‚ä½•ä½¿ç”¨<strong>ç®—å­</strong>æ¥æ“ä½œè¿™äº›æ•°æ®ç»“æ„äº†ã€‚</p><h2 id="2-Sparkç®—å­çš„åˆ†ç±»ä¸ç‰¹æ€§"><a href="#2-Sparkç®—å­çš„åˆ†ç±»ä¸ç‰¹æ€§" class="headerlink" title="2. Sparkç®—å­çš„åˆ†ç±»ä¸ç‰¹æ€§"></a>2. Sparkç®—å­çš„åˆ†ç±»ä¸ç‰¹æ€§</h2><p>Sparkç®—å­æ˜¯æ„å»ºåˆ†å¸ƒå¼æ•°æ®å¤„ç†åº”ç”¨çš„åŸºç¡€æŒ‡ä»¤ï¼Œç†è§£å…¶åˆ†ç±»æ˜¯æŒæ¡Sparkç¼–ç¨‹æ¨¡å‹çš„ç¬¬ä¸€æ­¥ã€‚ç®—å­å¯ä»¥ä»ä¸¤ä¸ªæ ¸å¿ƒç»´åº¦è¿›è¡Œåˆ†ç±»ï¼š<strong>æŒ‰åŠŸèƒ½åˆ’åˆ†</strong>å’Œ<strong>æŒ‰ä¾èµ–å…³ç³»åˆ’åˆ†</strong>ã€‚è¿™ä¸¤ä¸ªç»´åº¦å…±åŒå†³å®šäº†ç®—å­çš„è¡Œä¸ºã€æ‰§è¡Œæ—¶æœºå’Œæ€§èƒ½ç‰¹å¾ã€‚</p><h3 id="2-1-æŒ‰åŠŸèƒ½åˆ’åˆ†ï¼šè½¬æ¢ï¼ˆTransformationï¼‰ä¸è¡ŒåŠ¨ï¼ˆActionï¼‰"><a href="#2-1-æŒ‰åŠŸèƒ½åˆ’åˆ†ï¼šè½¬æ¢ï¼ˆTransformationï¼‰ä¸è¡ŒåŠ¨ï¼ˆActionï¼‰" class="headerlink" title="2.1 æŒ‰åŠŸèƒ½åˆ’åˆ†ï¼šè½¬æ¢ï¼ˆTransformationï¼‰ä¸è¡ŒåŠ¨ï¼ˆActionï¼‰"></a>2.1 æŒ‰åŠŸèƒ½åˆ’åˆ†ï¼šè½¬æ¢ï¼ˆTransformationï¼‰ä¸è¡ŒåŠ¨ï¼ˆActionï¼‰</h3><p>è¿™ä¸ªç»´åº¦å†³å®šäº†ç®—å­çš„æ‰§è¡Œæ—¶æœºï¼Œæ˜¯ç†è§£Sparkæ ¸å¿ƒç‰¹æ€§â€”â€”<strong>æ‡’æƒ°è®¡ç®—</strong>â€”â€”çš„å…³é”®ã€‚</p><p><strong>è½¬æ¢ï¼ˆTransformationï¼‰</strong></p><ul><li><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼šåªå®šä¹‰è®¡ç®—é€»è¾‘ï¼Œä¸ç«‹å³æ‰§è¡Œã€‚</li><li><strong>ç‰¹ç‚¹</strong>ï¼š<strong>æ‡’æƒ°è®¡ç®—ï¼ˆLazy Evaluationï¼‰</strong>ã€‚è°ƒç”¨æ—¶ï¼ŒSparkå¹¶ä¸ä¼šç«‹å³æ‰§è¡Œè®¡ç®—ï¼Œè€Œæ˜¯å°†è¯¥æ“ä½œè®°å½•ä¸‹æ¥ï¼Œå½¢æˆä¸€ä¸ªè®¡ç®—çš„æœ‰å‘æ— ç¯å›¾ï¼ˆDAGï¼‰çš„ä¸€éƒ¨åˆ†ã€‚è¿™å°±åƒæ˜¯åˆ¶å®šä¸€ä»½è¯¦ç»†çš„ä½œæˆ˜è®¡åˆ’ï¼Œä½†å¹¶ä¸å¼€ç«ã€‚</li><li><strong>è¿”å›å€¼</strong>ï¼šä¸€ä¸ªæ–°çš„RDDï¼Œä»£è¡¨äº†åº”ç”¨è¯¥è½¬æ¢åçš„ç»“æœæ•°æ®é›†ã€‚</li><li><strong>ä»£è¡¨ç®—å­</strong>ï¼š<code>map</code>, <code>filter</code>, <code>flatMap</code>, <code>groupByKey</code>, <code>reduceByKey</code>, <code>join</code>, <code>repartition</code>ç­‰ã€‚</li></ul><p><strong>è¡ŒåŠ¨ï¼ˆActionï¼‰</strong></p><ul><li><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼šè§¦å‘è®¡ç®—ï¼Œè·å–ç»“æœã€‚</li><li><strong>ç‰¹ç‚¹</strong>ï¼š<strong>ç«‹å³è®¡ç®—ï¼ˆEager Evaluationï¼‰</strong>ã€‚è°ƒç”¨æ—¶ï¼Œä¼šè§¦å‘ä¸€ä¸ªSparkä½œä¸šï¼ˆJobï¼‰çš„æäº¤å’Œæ‰§è¡Œã€‚Sparkä¼šæ ¹æ®ä¹‹å‰æ„å»ºçš„DAGï¼Œå°†è®¡ç®—ä»»åŠ¡åˆ†å‘åˆ°é›†ç¾¤æ‰§è¡Œï¼Œè¿™æ˜¯â€œå¼€ç«â€çš„ä¿¡å·ã€‚</li><li><strong>è¿”å›å€¼</strong>ï¼šä¸€ä¸ªéRDDç±»å‹çš„å€¼ï¼ˆå¦‚<code>Int</code>, <code>List</code>ï¼‰æˆ–æ— è¿”å›å€¼ï¼ˆä¾‹å¦‚ï¼Œå°†ç»“æœå†™å…¥å¤–éƒ¨å­˜å‚¨ï¼‰ã€‚</li><li><strong>ä»£è¡¨ç®—å­</strong>ï¼š<code>count</code>, <code>collect</code>, <code>first</code>, <code>take</code>, <code>reduce</code>, <code>foreach</code>, <code>saveAsTextFile</code>ç­‰ã€‚</li></ul><h3 id="2-2-æŒ‰ä¾èµ–å…³ç³»åˆ’åˆ†ï¼šçª„ä¾èµ–ï¼ˆNarrowï¼‰ä¸å®½ä¾èµ–ï¼ˆWideï¼‰"><a href="#2-2-æŒ‰ä¾èµ–å…³ç³»åˆ’åˆ†ï¼šçª„ä¾èµ–ï¼ˆNarrowï¼‰ä¸å®½ä¾èµ–ï¼ˆWideï¼‰" class="headerlink" title="2.2 æŒ‰ä¾èµ–å…³ç³»åˆ’åˆ†ï¼šçª„ä¾èµ–ï¼ˆNarrowï¼‰ä¸å®½ä¾èµ–ï¼ˆWideï¼‰"></a>2.2 æŒ‰ä¾èµ–å…³ç³»åˆ’åˆ†ï¼šçª„ä¾èµ–ï¼ˆNarrowï¼‰ä¸å®½ä¾èµ–ï¼ˆWideï¼‰</h3><p>è¿™ä¸ªç»´åº¦å†³å®šäº†æ•°æ®çš„ç‰©ç†æµè½¬æ–¹å¼ï¼Œæ˜¯ç†è§£Sparkæ€§èƒ½ç“¶é¢ˆâ€”â€”<strong>Shuffle</strong>â€”â€”çš„å…³é”®ã€‚</p><p><strong>çª„ä¾èµ–ç®—å­ï¼ˆNarrow Dependencyï¼‰ï¼š</strong></p><ul><li><strong>å®šä¹‰</strong>ï¼šå­RDDçš„æ¯ä¸ªåˆ†åŒºåªä¾èµ–çˆ¶RDDçš„ä¸€ä¸ªæˆ–å°‘æ•°å‡ ä¸ªå›ºå®šçš„åˆ†åŒºã€‚è¿™æ„å‘³ç€è®¡ç®—å¯ä»¥åœ¨å•ä¸ªèŠ‚ç‚¹ä¸Šç‹¬ç«‹å®Œæˆï¼Œæ— éœ€ç­‰å¾…å…¶ä»–èŠ‚ç‚¹çš„æ•°æ®ã€‚</li><li><strong>ç‰¹ç‚¹</strong>ï¼šæ•°æ®ä¸éœ€è¦è·¨èŠ‚ç‚¹ä¼ è¾“ï¼ˆNo Shuffleï¼‰ï¼Œè®¡ç®—å¯ä»¥åœ¨å•ä¸ªèŠ‚ç‚¹ä¸Šä»¥æµæ°´çº¿ï¼ˆPipelineï¼‰æ–¹å¼é«˜æ•ˆæ‰§è¡Œï¼Œæ€§èƒ½æé«˜ã€‚</li><li><strong>ä»£è¡¨ç®—å­</strong>ï¼š<code>map</code>, <code>filter</code>, <code>flatMap</code>, <code>union</code>ç­‰ã€‚</li></ul><p><strong>å®½ä¾èµ–ç®—å­ï¼ˆWide Dependencyï¼‰ï¼š</strong></p><ul><li><strong>å®šä¹‰</strong>ï¼šå­RDDçš„æ¯ä¸ªåˆ†åŒºä¾èµ–çˆ¶RDDçš„æ‰€æœ‰æˆ–å¤šä¸ªåˆ†åŒºã€‚è¿™æ„å‘³ç€ä¸€ä¸ªå­åˆ†åŒºçš„è®¡ç®—éœ€è¦ä»çˆ¶RDDçš„å¤šä¸ªåˆ†åŒºæ‹‰å–æ•°æ®ã€‚</li><li><strong>ç‰¹ç‚¹</strong>ï¼šéœ€è¦è¿›è¡ŒShuffleæ“ä½œï¼Œæ•°æ®å¿…é¡»åœ¨ç½‘ç»œé—´è¿›è¡Œå¤§è§„æ¨¡ä¼ è¾“å’Œé‡åˆ†åŒºã€‚Shuffleæ˜¯Sparkä¸­æœ€æ˜‚è´µçš„æ“ä½œä¹‹ä¸€ï¼Œæ˜¯æ€§èƒ½ä¼˜åŒ–çš„é‡ç‚¹å’Œéš¾ç‚¹ã€‚</li><li><strong>ä»£è¡¨ç®—å­</strong>ï¼š<code>groupByKey</code>, <code>reduceByKey</code>, <code>join</code>, <code>distinct</code>, <code>repartition</code>ç­‰ã€‚</li></ul><h2 id="3-ç®—å­æ‰§è¡Œçš„å†…å­˜ä¸ç£ç›˜ç®¡ç†"><a href="#3-ç®—å­æ‰§è¡Œçš„å†…å­˜ä¸ç£ç›˜ç®¡ç†" class="headerlink" title="3. ç®—å­æ‰§è¡Œçš„å†…å­˜ä¸ç£ç›˜ç®¡ç†"></a>3. ç®—å­æ‰§è¡Œçš„å†…å­˜ä¸ç£ç›˜ç®¡ç†</h2><p>åœ¨åˆ†å¸ƒå¼è®¡ç®—ä¸­ï¼Œå†…å­˜ä¸ç£ç›˜çš„ç®¡ç†æ˜¯å†³å®šæ€§èƒ½å’Œç¨³å®šæ€§çš„æ ¸å¿ƒè¦ç´ ã€‚Sparké€šè¿‡ä¸€ä¸ªç²¾å·§çš„<strong>ç»Ÿä¸€å†…å­˜ç®¡ç†ï¼ˆUnified Memory Managementï¼‰</strong>æ¨¡å‹ä»¥åŠé«˜æ•ˆçš„<strong>æº¢å†™ï¼ˆSpillï¼‰</strong>æœºåˆ¶ï¼Œåœ¨æ‰§è¡Œæ•ˆç‡ã€æ•°æ®ç¼“å­˜å’Œå¤§è§„æ¨¡æ•°æ®å¤„ç†èƒ½åŠ›ä¹‹é—´å–å¾—äº†åŠ¨æ€å¹³è¡¡ã€‚</p><h3 id="3-1-ç»Ÿä¸€å†…å­˜ç®¡ç†æ¨¡å‹"><a href="#3-1-ç»Ÿä¸€å†…å­˜ç®¡ç†æ¨¡å‹" class="headerlink" title="3.1 ç»Ÿä¸€å†…å­˜ç®¡ç†æ¨¡å‹"></a>3.1 ç»Ÿä¸€å†…å­˜ç®¡ç†æ¨¡å‹</h3><p>Sparké€šè¿‡ä¸€ä¸ªç²¾å·§çš„<strong>ç»Ÿä¸€å†…å­˜ç®¡ç†ï¼ˆUnified Memory Managementï¼‰</strong>æ¨¡å‹ï¼Œåœ¨æ‰§è¡Œæ•ˆç‡å’Œæ•°æ®ç¼“å­˜ä¹‹é—´å–å¾—äº†åŠ¨æ€å¹³è¡¡ã€‚</p><p>åœ¨Spark 1.6ç‰ˆæœ¬ä¹‹å‰ï¼Œæ‰§è¡Œå†…å­˜å’Œå­˜å‚¨å†…å­˜æ˜¯é™æ€åˆ’åˆ†çš„ï¼Œåˆ©ç”¨ç‡ä¸é«˜ã€‚è€Œç»Ÿä¸€å†…å­˜ç®¡ç†æ¨¡å‹å…è®¸è¿™ä¸¤éƒ¨åˆ†å†…å­˜åœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°ç›¸äº’å€Ÿç”¨ï¼Œä»è€Œæå¤§åœ°æå‡äº†å†…å­˜ä½¿ç”¨æ•ˆç‡ã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š<strong>è®¡ç®—ä¼˜å…ˆï¼Œåœ¨ä¸å½±å“è®¡ç®—çš„å‰æä¸‹ï¼Œå°½å¯èƒ½å¤šåœ°åˆ©ç”¨å†…å­˜è¿›è¡Œæ•°æ®ç¼“å­˜ã€‚</strong></p><p><strong>å†…å­˜åŒºåŸŸåˆ’åˆ†ï¼š</strong></p><pre class="mermaid">graph TD    A["Executor æ€»å†…å­˜"]    A --> B["ä¿ç•™å†…å­˜ (Reserved Memory)<br/>å›ºå®š300MB, å­˜å‚¨Sparkå†…éƒ¨å¯¹è±¡"]    A --> C["ç”¨æˆ·å†…å­˜ (User Memory)<br/>å­˜å‚¨ç”¨æˆ·ä»£ç åˆ›å»ºçš„å¯¹è±¡"]    A --> D["Spark å†…å­˜ (Spark Memory)<br/>ç»Ÿä¸€å†…å­˜ç®¡ç†åŒºåŸŸ"]    D --> E["æ‰§è¡Œå†…å­˜ (Execution Memory)<br/>ç®—å­æ‰§è¡Œ<br/>(Shuffle/Join/Sort)"]    D --> F["å­˜å‚¨å†…å­˜ (Storage Memory)<br/>ç¼“å­˜æ•°æ®<br/>(RDD/å¹¿æ’­å˜é‡)"]    E <--> F</pre><p>Spark Executorçš„å†…å­˜è¢«åˆ’åˆ†ä¸ºå‡ ä¸ªå…³é”®åŒºåŸŸï¼š</p><ol><li>**ä¿ç•™å†…å­˜ (Reserved Memory)**ï¼šç³»ç»Ÿä¿ç•™å†…å­˜ï¼Œå›ºå®šä¸º300MBï¼Œç”¨äºå­˜å‚¨Sparkå†…éƒ¨å¯¹è±¡å’Œå…ƒæ•°æ®ï¼Œé˜²æ­¢OOMã€‚</li><li>**ç”¨æˆ·å†…å­˜ (User Memory)**ï¼šç”¨æˆ·ä»£ç ä½¿ç”¨çš„å†…å­˜åŒºåŸŸï¼Œä¾‹å¦‚ï¼Œåœ¨ç®—å­å‡½æ•°ä¸­åˆ›å»ºçš„è‡ªå®šä¹‰å¯¹è±¡ã€æ•°æ®ç»“æ„ç­‰ã€‚è¿™éƒ¨åˆ†å†…å­˜ä¸å—Sparkç®¡ç†ï¼Œå¦‚æœä½¿ç”¨ä¸å½“ï¼Œæ˜¯OOMçš„ä¸»è¦æ¥æºä¹‹ä¸€ã€‚</li><li>**Sparkå†…å­˜ (Spark Memory)**ï¼šSparkæ¡†æ¶è‡ªèº«ç®¡ç†çš„å†…å­˜ï¼Œæ˜¯ä¼˜åŒ–çš„æ ¸å¿ƒåŒºåŸŸã€‚å®ƒè¿›ä¸€æ­¥åŠ¨æ€åœ°åˆ†ä¸ºï¼š<ul><li>**æ‰§è¡Œå†…å­˜ (Execution Memory)**ï¼šæ‰§è¡Œç®—å­ï¼ˆå¦‚Shuffleã€Joinã€Sortã€Aggregateï¼‰æ—¶æ‰€éœ€çš„å†…å­˜ã€‚è¿™éƒ¨åˆ†å†…å­˜ç”¨äºå­˜å‚¨ä¸­é—´æ•°æ®ï¼Œä¾‹å¦‚Shuffleæ—¶çš„ç¼“å†²åŒºã€‚å®ƒæ˜¯ä¿éšœè®¡ç®—ä»»åŠ¡é¡ºåˆ©æ‰§è¡Œçš„å…³é”®ã€‚</li><li>**å­˜å‚¨å†…å­˜ (Storage Memory)**ï¼šç”¨äºç¼“å­˜RDDã€å¹¿æ’­å˜é‡ç­‰æ•°æ®çš„å†…å­˜ã€‚é€šè¿‡å°†å¸¸ç”¨æ•°æ®ç¼“å­˜åœ¨æ­¤ï¼Œå¯ä»¥é¿å…é‡å¤è®¡ç®—ï¼Œæå‡æ€§èƒ½ã€‚å½“æ‰§è¡Œå†…å­˜ä¸è¶³æ—¶ï¼ŒSparkä¼šå¼ºåˆ¶é©±é€ï¼ˆEvictï¼‰å­˜å‚¨å†…å­˜ä¸­ç¼“å­˜çš„æ•°æ®å—ï¼Œä¸ºè®¡ç®—ä»»åŠ¡è…¾å‡ºç©ºé—´ã€‚</li></ul></li></ol><p>ğŸ”¥ <strong>æ ¸å¿ƒæœºåˆ¶</strong>ï¼šæ‰§è¡Œå†…å­˜å’Œå­˜å‚¨å†…å­˜å…±äº« <strong>Unified Memory</strong> åŒºåŸŸï¼ˆåŠ¨æ€æŠ¢å ï¼‰ï¼š</p><ul><li>æ‰§è¡Œä»»åŠ¡å¯æŠ¢å å­˜å‚¨å†…å­˜ï¼ˆè‹¥å­˜å‚¨å†…å­˜æœªç”¨å®Œï¼‰</li><li>å­˜å‚¨å†…å­˜åªèƒ½è¢«åŠ¨å›æ”¶ï¼ˆLRU ç­–ç•¥ï¼‰ï¼Œ<strong>ä¸èƒ½æŠ¢å </strong>æ‰§è¡Œå†…å­˜</li></ul><h3 id="3-2-å†…å­˜ä¸ç£ç›˜çš„äº¤äº’ï¼šæº¢å†™-Spill-ä¸åˆå¹¶-Merge"><a href="#3-2-å†…å­˜ä¸ç£ç›˜çš„äº¤äº’ï¼šæº¢å†™-Spill-ä¸åˆå¹¶-Merge" class="headerlink" title="3.2 å†…å­˜ä¸ç£ç›˜çš„äº¤äº’ï¼šæº¢å†™ (Spill) ä¸åˆå¹¶ (Merge)"></a>3.2 å†…å­˜ä¸ç£ç›˜çš„äº¤äº’ï¼šæº¢å†™ (Spill) ä¸åˆå¹¶ (Merge)</h3><p>ç»Ÿä¸€å†…å­˜ç®¡ç†æ¨¡å‹è§£é‡Šäº†å†…å­˜çš„å†…éƒ¨åˆ’åˆ†ä¸åŠ¨æ€è°ƒæ•´ï¼Œä½†å½“æ‰§è¡Œå†…å­˜æœ¬èº«ä¹Ÿä¸è¶³ä»¥å®¹çº³æ‰€æœ‰è®¡ç®—æ‰€éœ€çš„æ•°æ®æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿè¿™æ—¶ï¼ŒSparkä¼šå¯åŠ¨<strong>æº¢å†™ï¼ˆSpillï¼‰</strong>æœºåˆ¶ï¼Œå°†éƒ¨åˆ†æ•°æ®ä¸´æ—¶å†™å…¥ç£ç›˜ï¼Œä»¥é‡Šæ”¾å†…å­˜ä¾›å½“å‰è®¡ç®—ä»»åŠ¡ç»§ç»­ä½¿ç”¨ã€‚</p><p><strong>æº¢å†™ï¼ˆSpillï¼‰</strong></p><ul><li><strong>è§¦å‘æ—¶æœº</strong>ï¼šåœ¨æ‰§è¡Œéœ€è¦å¤§é‡å†…å­˜çš„ç®—å­æ—¶ï¼ˆå¦‚ <code>reduceByKey</code>, <code>groupByKey</code>, <code>sortByKey</code>, <code>join</code>ï¼‰ï¼Œè¿™äº›ç®—å­é€šå¸¸ä½¿ç”¨åŸºäºå“ˆå¸Œçš„èšåˆå™¨æˆ–å¤–éƒ¨æ’åºå™¨ã€‚å½“è¿™äº›å†…å­˜ä¸­çš„æ•°æ®ç»“æ„ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªå·¨å¤§çš„å“ˆå¸Œè¡¨ï¼‰çš„å¤§å°è¶…è¿‡äº†å¯ç”¨çš„æ‰§è¡Œå†…å­˜æ—¶ï¼Œæº¢å†™å°±ä¼šè¢«è§¦å‘ã€‚</li><li><strong>è¿‡ç¨‹</strong>ï¼šSparkå°†å†…å­˜ä¸­çš„æ•°æ®ï¼ˆä¾‹å¦‚å“ˆå¸Œè¡¨çš„éƒ¨åˆ†å†…å®¹ï¼‰è¿›è¡Œæ’åºï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼Œç„¶ååºåˆ—åŒ–æˆå­—èŠ‚æµï¼Œå†™å…¥æœ¬åœ°ç£ç›˜ä¸Šçš„ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ã€‚ä¹‹åï¼Œæ¸…ç©ºå†…å­˜ä¸­çš„è¿™éƒ¨åˆ†æ•°æ®ç»“æ„ï¼Œä»¥ç»§ç»­å¤„ç†åç»­æ•°æ®ã€‚ä¸€ä¸ªä»»åŠ¡å¯èƒ½ä¼šå› ä¸ºæ•°æ®é‡å·¨å¤§è€Œäº§ç”Ÿå¤šä¸ªæº¢å†™æ–‡ä»¶ã€‚</li></ul><p><strong>åˆå¹¶ï¼ˆMergeï¼‰</strong></p><ul><li><strong>è§¦å‘æ—¶æœº</strong>ï¼šå½“ä¸€ä¸ªä»»åŠ¡å¤„ç†å®Œå…¶æ‰€æœ‰çš„è¾“å…¥æ•°æ®åï¼Œå®ƒå¯èƒ½å·²ç»åœ¨ç£ç›˜ä¸Šç•™ä¸‹äº†å¤šä¸ªæº¢å†™æ–‡ä»¶ï¼ŒåŒæ—¶å†…å­˜é‡Œå¯èƒ½è¿˜å‰©ä½™ä¸€éƒ¨åˆ†æ•°æ®ã€‚</li><li><strong>è¿‡ç¨‹</strong>ï¼šä¸ºäº†å½¢æˆè¯¥ä»»åŠ¡çš„æœ€ç»ˆè¾“å‡ºï¼ˆä¾‹å¦‚ï¼Œä¸ºShuffleçš„ä¸‹ä¸€é˜¶æ®µå‡†å¤‡æ•°æ®ï¼‰ï¼ŒSparkä¼šå¯åŠ¨ä¸€ä¸ªåˆå¹¶æµç¨‹ã€‚å®ƒä½¿ç”¨å½’å¹¶æ’åºçš„ç­–ç•¥ï¼ŒåŒæ—¶ä»æ‰€æœ‰æº¢å†™æ–‡ä»¶å’Œå†…å­˜ä¸­è¯»å–æ•°æ®ï¼Œå°†å®ƒä»¬åˆå¹¶æˆä¸€ä¸ªå•ä¸€çš„ã€é€šå¸¸æ˜¯æ’åºå¥½çš„è¾“å‡ºæ–‡ä»¶ã€‚è¿™ä¸ªæœ€ç»ˆæ–‡ä»¶æ‰æ˜¯Shuffleé˜¶æ®µç½‘ç»œä¼ è¾“çš„æºæ–‡ä»¶ã€‚</li></ul><p>è¿™ä¸ª <strong>å†…å­˜-æº¢å†™-åˆå¹¶</strong> çš„æµç¨‹æ˜¯Sparkèƒ½å¤Ÿå¤„ç†è¿œè¶…å†…å­˜å®¹é‡çš„å¤§è§„æ¨¡æ•°æ®çš„å…³é”®ã€‚å®ƒä»¥ç£ç›˜I&#x2F;Oçš„å¼€é”€ä¸ºä»£ä»·ï¼Œæ¢å–äº†è®¡ç®—çš„ç¨³å®šæ€§å’Œå¯¹æµ·é‡æ•°æ®çš„å¤„ç†èƒ½åŠ›ã€‚</p><h2 id="4-æ•°æ®åºåˆ—åŒ–ä¸ç½‘ç»œä¼ è¾“"><a href="#4-æ•°æ®åºåˆ—åŒ–ä¸ç½‘ç»œä¼ è¾“" class="headerlink" title="4. æ•°æ®åºåˆ—åŒ–ä¸ç½‘ç»œä¼ è¾“"></a>4. æ•°æ®åºåˆ—åŒ–ä¸ç½‘ç»œä¼ è¾“</h2><p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæ•°æ®éœ€è¦åœ¨ä¸åŒèŠ‚ç‚¹é—´é€šè¿‡ç½‘ç»œä¼ è¾“ï¼Œè€Œç½‘ç»œä¼ è¾“çš„æ•°æ®å¿…é¡»æ˜¯äºŒè¿›åˆ¶æ ¼å¼ã€‚<strong>åºåˆ—åŒ–</strong>å°±æ˜¯å°†å†…å­˜ä¸­çš„Javaå¯¹è±¡ï¼ˆåŒ…å«æ•°æ®å’Œç»“æ„ï¼‰è½¬æ¢ä¸ºäºŒè¿›åˆ¶å­—èŠ‚æµçš„è¿‡ç¨‹ï¼Œè€Œ<strong>ååºåˆ—åŒ–</strong>åˆ™æ˜¯ç›¸åçš„è¿‡ç¨‹ã€‚åºåˆ—åŒ–æ˜¯Sparkä¸­ä¸€ä¸ªåŸºç¡€ä½†æå…¶é‡è¦çš„æ€§èƒ½å½±å“ç‚¹ï¼Œå®ƒçš„æ•ˆç‡ç›´æ¥å†³å®šäº†ç½‘ç»œä¼ è¾“å’Œç£ç›˜IOçš„å¼€é”€ã€‚</p><p>Sparkåœ¨å¤šä¸ªåœºæ™¯ä¸‹éƒ½ä¼šè§¦å‘åºåˆ—åŒ–æ“ä½œï¼š</p><p><strong>åºåˆ—åŒ–è§¦å‘åœºæ™¯ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. Taskåºåˆ—åŒ–ï¼šå°†Taskä»Driverå‘é€åˆ°Executor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TaskSerialization</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] serializeTask(Task&lt;?&gt; task) &#123;</span><br><span class="line">        <span class="comment">// ä»»åŠ¡åŒ…å«ï¼šä»£ç ã€ä¾èµ–ã€åˆ†åŒºä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> serializer.serialize(task);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>åœºæ™¯è§£è¯»</strong>ï¼šå½“ä½ åœ¨Driverç«¯ç¼–å†™çš„ç®—å­å‡½æ•°ï¼ˆé—­åŒ…ï¼‰éœ€è¦è¢«å‘é€åˆ°Executorä¸Šæ‰§è¡Œæ—¶ï¼Œæ•´ä¸ªä»»åŠ¡ï¼ˆåŒ…æ‹¬ä»£ç å’Œå…¶å¼•ç”¨çš„å¤–éƒ¨å˜é‡ï¼‰éƒ½ä¼šè¢«åºåˆ—åŒ–ã€‚å¦‚æœé—­åŒ…å¼•ç”¨äº†åºå¤§ä¸”ä¸å¯åºåˆ—åŒ–çš„å¯¹è±¡ï¼Œä¼šå¯¼è‡´ä»»åŠ¡æäº¤å¤±è´¥æˆ–æ€§èƒ½ä½ä¸‹ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2. Shuffleåºåˆ—åŒ–ï¼šæ•°æ®åœ¨èŠ‚ç‚¹é—´ä¼ è¾“</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShuffleDataSerialization</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writeShuffleData</span><span class="params">(Iterator&lt;Product2&lt;K, V&gt;&gt; records)</span> &#123;</span><br><span class="line">        <span class="type">SerializationStream</span> <span class="variable">stream</span> <span class="operator">=</span> serializer.serializeStream(outputStream);</span><br><span class="line">        <span class="keyword">while</span> (records.hasNext()) &#123;</span><br><span class="line">            Product2&lt;K, V&gt; record = records.next();</span><br><span class="line">            stream.writeKey(record._1);    <span class="comment">// åºåˆ—åŒ–key</span></span><br><span class="line">            stream.writeValue(record._2);  <span class="comment">// åºåˆ—åŒ–value</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>åœºæ™¯è§£è¯»</strong>ï¼šè¿™æ˜¯åºåˆ—åŒ–æœ€å½±å“æ€§èƒ½çš„ç¯èŠ‚ã€‚åœ¨Shuffleè¿‡ç¨‹ä¸­ï¼Œå¤§é‡æ•°æ®éœ€è¦åœ¨èŠ‚ç‚¹é—´æµåŠ¨ï¼Œé«˜æ•ˆçš„åºåˆ—åŒ–æ ¼å¼ï¼ˆå¦‚Kryoï¼‰å¯ä»¥æ˜¾è‘—å‡å°‘ç½‘ç»œä¼ è¾“çš„æ•°æ®é‡å’ŒCPUæ¶ˆè€—ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 3. ç¼“å­˜åºåˆ—åŒ–ï¼šRDDæŒä¹…åŒ–åˆ°å†…å­˜/ç£ç›˜</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheSerialization</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cacheRDD</span><span class="params">(RDD&lt;?&gt; rdd, StorageLevel level)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (level.useSerialization()) &#123;</span><br><span class="line">            <span class="comment">// å°†RDDæ•°æ®åºåˆ—åŒ–åå­˜å‚¨</span></span><br><span class="line">            <span class="type">byte</span>[] serializedData = serializer.serialize(rdd.collect());</span><br><span class="line">            blockManager.putBytes(blockId, serializedData, level);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>åœºæ™¯è§£è¯»</strong>ï¼šå½“ä½ è°ƒç”¨<code>rdd.persist(StorageLevel.MEMORY_AND_DISK_SER)</code>ç­‰åŒ…å«<code>_SER</code>çš„ç¼“å­˜çº§åˆ«æ—¶ï¼Œæ•°æ®ä¼šä»¥åºåˆ—åŒ–çš„å½¢å¼å­˜å‚¨ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯èŠ‚çœå†…å­˜ç©ºé—´ï¼Œä½†ä»£ä»·æ˜¯æ¯æ¬¡è®¿é—®ç¼“å­˜æ•°æ®æ—¶éƒ½éœ€è¦è¿›è¡Œååºåˆ—åŒ–ï¼Œå¢åŠ äº†CPUå¼€é”€ã€‚</li></ul><h2 id="5-ä¸ºä»€ä¹ˆç†è§£ç®—å­åŸç†å¦‚æ­¤é‡è¦ï¼Ÿ"><a href="#5-ä¸ºä»€ä¹ˆç†è§£ç®—å­åŸç†å¦‚æ­¤é‡è¦ï¼Ÿ" class="headerlink" title="5. ä¸ºä»€ä¹ˆç†è§£ç®—å­åŸç†å¦‚æ­¤é‡è¦ï¼Ÿ"></a>5. ä¸ºä»€ä¹ˆç†è§£ç®—å­åŸç†å¦‚æ­¤é‡è¦ï¼Ÿ</h2><p>åœ¨Sparkå¼€å‘ä¸­ï¼Œå®ç°åŒä¸€ä¸ªä¸šåŠ¡éœ€æ±‚å¾€å¾€æœ‰å¤šç§ç®—å­ç»„åˆã€‚ç„¶è€Œï¼Œä¸åŒçš„å®ç°æ–¹å¼å¯èƒ½å¯¼è‡´ç™¾å€ç”šè‡³åƒå€çš„æ€§èƒ½å·®å¼‚ã€‚è¿™ç§å·®å¼‚çš„æ ¹æºï¼Œå°±åœ¨äºæ¯ä¸ªç®—å­èƒŒåçš„æ•°æ®å¤„ç†å’Œæµè½¬æœºåˆ¶å®Œå…¨ä¸åŒã€‚</p><p><strong>æ€§èƒ½å·®å¼‚çš„æ ¹æœ¬åŸå› ï¼š</strong></p><p>ä¸åŒç®—å­çš„æ€§èƒ½å·®å¼‚ä¸»è¦æºäºå®ƒä»¬åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢çš„ä¸åŒé€‰æ‹©ï¼š</p><ol><li><strong>ä¾èµ–å…³ç³»</strong>ï¼šæ˜¯éœ€è¦Shuffleçš„å®½ä¾èµ–ï¼Œè¿˜æ˜¯æ— éœ€Shuffleçš„çª„ä¾èµ–ï¼Ÿè¿™æ˜¯æœ€æ ¸å¿ƒçš„åŒºåˆ«ã€‚</li><li><strong>æ•°æ®å±€éƒ¨æ€§</strong>ï¼šè®¡ç®—æ˜¯åœ¨æ•°æ®æ‰€åœ¨çš„èŠ‚ç‚¹æœ¬åœ°æ‰§è¡Œï¼Œè¿˜æ˜¯å¿…é¡»é€šè¿‡ç½‘ç»œæ‹‰å–è¿œç¨‹æ•°æ®ï¼Ÿ</li><li><strong>å†…å­˜ä½¿ç”¨æ¨¡å¼</strong>ï¼šç®—å­æ˜¯ä¸€æ¬¡æ€§å°†æ•´ä¸ªåˆ†åŒºåŠ è½½åˆ°å†…å­˜ï¼Œè¿˜æ˜¯ä»¥æµå¼ï¼ˆStreamingï¼‰æ–¹å¼é€æ¡å¤„ç†ï¼Ÿè¿™å†³å®šäº†å†…å­˜æ¶ˆè€—çš„å³°å€¼ã€‚</li><li><strong>CPUåˆ©ç”¨ç‡</strong>ï¼šç®—å­çš„è®¡ç®—é€»è¾‘æ˜¯å¦å¤æ‚ï¼Œæ˜¯å¦èƒ½è¢«Sparkçš„ä¼˜åŒ–å™¨ï¼ˆå¦‚Tungstenï¼‰è¿›è¡Œä¼˜åŒ–ï¼Ÿ</li></ol><p>ä¸‹é¢çš„ä¾‹å­ç›´è§‚åœ°å±•ç¤ºäº†<code>groupByKey</code>å’Œ<code>reduceByKey</code>çš„å·¨å¤§æ€§èƒ½å·®å¼‚ï¼Œå°½ç®¡å®ƒä»¬éƒ½èƒ½å®ç°åˆ†ç»„èšåˆçš„åŠŸèƒ½ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœºæ™¯ï¼šå¤„ç†1GBæ•°æ®ï¼Œç»Ÿè®¡æ¯ä¸ªç”¨æˆ·çš„è®¢å•æ•°é‡</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–¹æ¡ˆ1ï¼šä½¿ç”¨groupByKey - æ€§èƒ½å·®</span></span><br><span class="line">JavaPairRDD&lt;String, Integer&gt; result1 = orders</span><br><span class="line">    .mapToPair(order -&gt; <span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(order.getUserId(), <span class="number">1</span>))</span><br><span class="line">    .groupByKey()  <span class="comment">// å®½ä¾èµ–ï¼ŒShuffleæ‰€æœ‰æ•°æ®</span></span><br><span class="line">    .mapValues(values -&gt; &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (Integer v : values) count += v;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;);</span><br><span class="line"><span class="comment">// æ‰§è¡Œæ—¶é—´ï¼šçº¦45ç§’ï¼ŒShuffleæ•°æ®é‡ï¼š1GB</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–¹æ¡ˆ2ï¼šä½¿ç”¨reduceByKey - æ€§èƒ½å¥½</span></span><br><span class="line">JavaPairRDD&lt;String, Integer&gt; result2 = orders</span><br><span class="line">    .mapToPair(order -&gt; <span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(order.getUserId(), <span class="number">1</span>))</span><br><span class="line">    .reduceByKey((a, b) -&gt; a + b);  <span class="comment">// æœ¬åœ°é¢„èšåˆï¼Œå‡å°‘Shuffleæ•°æ®</span></span><br><span class="line"><span class="comment">// æ‰§è¡Œæ—¶é—´ï¼šçº¦15ç§’ï¼ŒShuffleæ•°æ®é‡ï¼šçº¦100MBï¼ˆå‡è®¾æœ‰10ä¸‡ç”¨æˆ·ï¼‰</span></span><br></pre></td></tr></table></figure><p><strong>ä¼˜åŒ–æ€è·¯çš„æœ¬è´¨ï¼š</strong><br>å› æ­¤ï¼Œç†è§£ç®—å­åŸç†å¹¶éç‚«æŠ€ï¼Œè€Œæ˜¯è¿›è¡Œæ€§èƒ½ä¼˜åŒ–çš„åŸºçŸ³ã€‚å®ƒèƒ½è®©ä½ åœ¨å¼€å‘æ—¶å°±å…·å¤‡â€œæ€§èƒ½æ€ç»´â€ï¼Œä»è€Œèƒ½å¤Ÿï¼š</p><ul><li><strong>é€‰æ‹©åˆé€‚çš„ç®—å­</strong>ï¼šä¸»åŠ¨é¿å…ä¸å¿…è¦çš„Shuffleï¼Œä¾‹å¦‚ç”¨<code>reduceByKey</code>æ›¿ä»£<code>groupByKey</code>ã€‚</li><li><strong>è®¾è®¡åˆç†çš„æ•°æ®æµ</strong>ï¼šé€šè¿‡<code>broadcast</code>ç­‰æŠ€å·§ï¼Œå°†Shuffleå¯†é›†å‹çš„<code>join</code>æ“ä½œä¼˜åŒ–ä¸ºæœ¬åœ°è®¡ç®—ã€‚</li><li><strong>åˆ©ç”¨æ•°æ®å±€éƒ¨æ€§</strong>ï¼šåˆç†è®¾è®¡åˆ†åŒºç­–ç•¥ï¼Œè®©è®¡ç®—å°½å¯èƒ½åœ¨æ•°æ®æ‰€åœ¨çš„èŠ‚ç‚¹å‘ç”Ÿã€‚</li><li><strong>åˆç†é…ç½®èµ„æº</strong>ï¼šé¢„ä¼°ç®—å­çš„å†…å­˜æ¶ˆè€—ï¼Œä¸ºä½œä¸šåˆ†é…åˆç†çš„å†…å­˜å’ŒCPUèµ„æºï¼Œé¿å…OOMå’Œæ€§èƒ½ç“¶é¢ˆã€‚</li></ul><p>ä¸ºä»€ä¹ˆæœ‰äº›ç®—å­æ‰§è¡Œå¾ˆå¿«ï¼Œæœ‰äº›å´å¾ˆæ…¢ï¼Ÿç­”æ¡ˆå°±è—åœ¨ç®—å­çš„å®ç°åŸç†å’Œæ•°æ®æµè½¬æœºåˆ¶ä¸­ã€‚åªæœ‰æ·±å…¥ç†è§£è¿™äº›ï¼Œæ‰èƒ½çœŸæ­£é©¾é©­Sparkã€‚</p><h2 id="6-RDDæ‡’æƒ°è®¡ç®—æœºåˆ¶æ·±åº¦å‰–æ"><a href="#6-RDDæ‡’æƒ°è®¡ç®—æœºåˆ¶æ·±åº¦å‰–æ" class="headerlink" title="6. RDDæ‡’æƒ°è®¡ç®—æœºåˆ¶æ·±åº¦å‰–æ"></a>6. RDDæ‡’æƒ°è®¡ç®—æœºåˆ¶æ·±åº¦å‰–æ</h2><p>æ‡’æƒ°è®¡ç®—ï¼ˆLazy Evaluationï¼‰æ˜¯Sparkæœ€æ ¸å¿ƒã€æœ€å·§å¦™çš„è®¾è®¡ä¹‹ä¸€ï¼Œæ˜¯å…¶å®ç°é«˜æ•ˆã€å®¹é”™çš„åˆ†å¸ƒå¼è®¡ç®—çš„åŸºçŸ³ã€‚ç®€å•æ¥è¯´ï¼Œæ‡’æƒ°è®¡ç®—å°±æ˜¯<strong>â€œéåˆ°ä¸‡ä¸å¾—å·²ï¼Œç»ä¸æ‰§è¡Œè®¡ç®—â€</strong>ã€‚</p><h3 id="6-1-æ ¸å¿ƒæ¦‚å¿µï¼šæ‡’æƒ°è®¡ç®—-vs-æ€¥åˆ‡è®¡ç®—"><a href="#6-1-æ ¸å¿ƒæ¦‚å¿µï¼šæ‡’æƒ°è®¡ç®—-vs-æ€¥åˆ‡è®¡ç®—" class="headerlink" title="6.1 æ ¸å¿ƒæ¦‚å¿µï¼šæ‡’æƒ°è®¡ç®— vs æ€¥åˆ‡è®¡ç®—"></a>6.1 æ ¸å¿ƒæ¦‚å¿µï¼šæ‡’æƒ°è®¡ç®— vs æ€¥åˆ‡è®¡ç®—</h3><p><strong>æ‡’æƒ°è®¡ç®—ï¼ˆLazy Evaluationï¼‰</strong>ï¼š</p><ul><li>æŒ‡çš„æ˜¯Sparkåœ¨é‡åˆ°<strong>è½¬æ¢æ“ä½œï¼ˆTransformationsï¼‰</strong>æ—¶ï¼Œå¹¶ä¸ä¼šç«‹å³æ‰§è¡Œè®¡ç®—å¹¶ç”Ÿæˆæ–°çš„RDD</li><li>å®ƒåªæ˜¯è®°å½•ä¸‹è¿™ä¸ªæ“ä½œä»¥åŠå®ƒä¾èµ–çš„çˆ¶RDDï¼ˆå³ï¼šæ„å»ºäº†ä¸€ä¸ªé€»è¾‘æ‰§è¡Œè®¡åˆ’æˆ–ç§°ä¸ºLineageï¼‰</li><li>çœŸæ­£çš„è®¡ç®—ï¼ˆæ•°æ®è¯»å–ã€è½¬æ¢å¤„ç†ï¼‰ä¼šè¢«æ¨è¿Ÿåˆ°é‡åˆ°<strong>è¡ŒåŠ¨æ“ä½œï¼ˆActionsï¼‰</strong>æ—¶æ‰è§¦å‘æ‰§è¡Œ</li></ul><p><strong>æ€¥åˆ‡è®¡ç®—ï¼ˆEager Evaluationï¼‰</strong>ï¼š</p><ul><li>ä¼ ç»Ÿç¼–ç¨‹æˆ–æŸäº›æ•°æ®å¤„ç†æ¡†æ¶ï¼ˆå¦‚Scalaé›†åˆçš„æŸäº›æ“ä½œï¼‰æ˜¯æ€¥åˆ‡è®¡ç®—çš„</li><li>å½“ä½ è°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒä¼šç«‹å³æ‰§è¡Œå¹¶è¿”å›ç»“æœ</li><li>ä¾‹å¦‚ï¼Œåœ¨Scalaä¸­<code>List(1,2,3).map(_ * 2)</code>ä¼šç«‹å³è®¡ç®—å¹¶è¿”å›<code>List(2,4,6)</code></li></ul><p><strong>å¯¹æ¯”ç¤ºä¾‹ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ€¥åˆ‡è®¡ç®— - ä¼ ç»ŸJavaé›†åˆ</span></span><br><span class="line">List&lt;Integer&gt; numbers = Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>);</span><br><span class="line">List&lt;Integer&gt; doubled = numbers.stream()</span><br><span class="line">    .map(x -&gt; x * <span class="number">2</span>)     <span class="comment">// ç«‹å³æ‰§è¡Œ</span></span><br><span class="line">    .filter(x -&gt; x &gt; <span class="number">5</span>)  <span class="comment">// ç«‹å³æ‰§è¡Œ</span></span><br><span class="line">    .collect(Collectors.toList()); <span class="comment">// ç«‹å³è¿”å›ç»“æœ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‡’æƒ°è®¡ç®— - Spark RDD</span></span><br><span class="line">JavaRDD&lt;Integer&gt; numbersRDD = sc.parallelize(Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>));</span><br><span class="line">JavaRDD&lt;Integer&gt; transformedRDD = numbersRDD</span><br><span class="line">    .map(x -&gt; x * <span class="number">2</span>)     <span class="comment">// ä»…è®°å½•æ“ä½œï¼Œä¸æ‰§è¡Œ</span></span><br><span class="line">    .filter(x -&gt; x &gt; <span class="number">5</span>); <span class="comment">// ä»…è®°å½•æ“ä½œï¼Œä¸æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">// æ­¤æ—¶è¿˜æ²¡æœ‰ä»»ä½•å®é™…è®¡ç®—å‘ç”Ÿï¼</span></span><br><span class="line"></span><br><span class="line">List&lt;Integer&gt; result = transformedRDD.collect(); <span class="comment">// è¿™é‡Œæ‰å¼€å§‹çœŸæ­£è®¡ç®—</span></span><br></pre></td></tr></table></figure><h3 id="6-2-ä¸ºä»€ä¹ˆSparkè¦é‡‡ç”¨æ‡’æƒ°è®¡ç®—ï¼Ÿ"><a href="#6-2-ä¸ºä»€ä¹ˆSparkè¦é‡‡ç”¨æ‡’æƒ°è®¡ç®—ï¼Ÿ" class="headerlink" title="6.2 ä¸ºä»€ä¹ˆSparkè¦é‡‡ç”¨æ‡’æƒ°è®¡ç®—ï¼Ÿ"></a>6.2 ä¸ºä»€ä¹ˆSparkè¦é‡‡ç”¨æ‡’æƒ°è®¡ç®—ï¼Ÿ</h3><p>è¿™ç§â€œè°‹å®šè€ŒååŠ¨â€çš„è®¾è®¡å“²å­¦ï¼Œä¸ºSparkå¸¦æ¥äº†å‡ ä¸ªåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹è‡³å…³é‡è¦çš„ä¼˜åŠ¿ï¼š</p><p><strong>1. ä¼˜åŒ–æ‰§è¡Œè®¡åˆ’ï¼ˆOptimizationï¼‰</strong></p><p>è¿™æ˜¯æ‡’æƒ°è®¡ç®—æœ€å¤§çš„ä¼˜åŠ¿ã€‚å› ä¸ºæ‰€æœ‰è½¬æ¢æ“ä½œéƒ½åªæ˜¯è®°å½•åœ¨DAGä¸­ï¼Œç›´åˆ°è¡ŒåŠ¨æ“ä½œè¢«è°ƒç”¨å‰ï¼ŒSparkéƒ½æ‹¥æœ‰äº†è®¡ç®—çš„å…¨æ™¯å›¾ã€‚è¿™ä½¿å¾—Sparkçš„ä¼˜åŒ–å™¨ï¼ˆå¦‚DAGSchedulerå’ŒCatalystï¼‰å¯ä»¥ä»å…¨å±€è§†è§’å¯¹æ•´ä¸ªè®¡ç®—æµç¨‹è¿›è¡Œä¼˜åŒ–ã€‚</p><ul><li><strong>æµæ°´çº¿åŒ–ï¼ˆPipeliningï¼‰</strong>ï¼šåœ¨æ€¥åˆ‡è®¡ç®—ä¸­ï¼Œ<code>rdd.map(...).filter(...)</code>ä¼šæ‰§è¡Œä¸¤æ¬¡å…¨é‡æ•°æ®æ‰«æã€‚ä½†åœ¨æ‡’æƒ°è®¡ç®—ä¸­ï¼ŒSparkä¼šå°†<code>map</code>å’Œ<code>filter</code>è¿™ä¸¤ä¸ªæ“ä½œåˆå¹¶ï¼ˆfuseï¼‰æˆä¸€ä¸ªä»»åŠ¡ã€‚æ•°æ®åœ¨åˆ†åŒºå†…ä»¥æµå¼çš„æ–¹å¼è¢«å¤„ç†ï¼Œä¸€æ¡æ•°æ®å¤„ç†å®Œ<code>map</code>åç«‹åˆ»è¿›è¡Œ<code>filter</code>ï¼Œæ— éœ€å°†ä¸­é—´ç»“æœå†™å…¥å†…å­˜æˆ–ç£ç›˜ï¼Œæå¤§åœ°æå‡äº†æ•ˆç‡ã€‚</li><li><strong>è°“è¯ä¸‹æ¨ï¼ˆPredicate Pushdownï¼‰</strong>ï¼šå¦‚æœæ•°æ®æºï¼ˆå¦‚Parquetã€ORCï¼‰æ”¯æŒï¼ŒSparkä¼šå°†<code>filter</code>æ“ä½œä¸‹æ¨åˆ°æ•°æ®è¯»å–å±‚ã€‚è¿™æ ·ï¼Œåœ¨æ•°æ®åŠ è½½åˆ°å†…å­˜ä¹‹å‰ï¼Œå°±èƒ½è¿‡æ»¤æ‰å¤§é‡æ— å…³æ•°æ®ï¼Œä»æºå¤´ä¸Šå‡å°‘äº†IOå’Œå†…å­˜çš„æ¶ˆè€—ã€‚</li><li><strong>å‡å°‘Shuffle</strong>ï¼šä¼˜åŒ–å™¨å¯ä»¥åˆ†ææ•´ä¸ªDAGï¼Œè¯†åˆ«å‡ºå¯ä»¥é¿å…æˆ–ä¼˜åŒ–çš„Shuffleæ“ä½œï¼Œä¾‹å¦‚åœ¨å¤šä¸ª<code>join</code>æ“ä½œä¸­é€‰æ‹©æœ€ä¼˜çš„æ‰§è¡Œé¡ºåºã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‡’æƒ°è®¡ç®—çš„ä¼˜åŒ–ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LazyEvaluationOptimizer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demonstrateOptimizations</span><span class="params">()</span> &#123;</span><br><span class="line">        JavaRDD&lt;String&gt; textRDD = sc.textFile(<span class="string">&quot;large_file.txt&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å®šä¹‰ä¸€ç³»åˆ—è½¬æ¢æ“ä½œï¼ˆå…¨éƒ¨æ˜¯æ‡’æƒ°çš„ï¼‰</span></span><br><span class="line">        JavaRDD&lt;String&gt; result = textRDD</span><br><span class="line">            .filter(line -&gt; line.contains(<span class="string">&quot;ERROR&quot;</span>))      <span class="comment">// è¿‡æ»¤æ“ä½œ</span></span><br><span class="line">            .map(line -&gt; line.toUpperCase())             <span class="comment">// è½¬æ¢æ“ä½œ</span></span><br><span class="line">            .filter(line -&gt; line.length() &gt; <span class="number">50</span>)          <span class="comment">// å†æ¬¡è¿‡æ»¤</span></span><br><span class="line">            .map(line -&gt; line.substring(<span class="number">0</span>, <span class="number">100</span>));        <span class="comment">// æˆªå–æ“ä½œ</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åªæœ‰åœ¨è°ƒç”¨Actionæ—¶ï¼ŒSparkæ‰å¼€å§‹ä¼˜åŒ–å’Œæ‰§è¡Œ</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> result.count();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Sparkçš„ä¼˜åŒ–ç­–ç•¥ï¼š</span></span><br><span class="line">        <span class="comment">// 1. æµæ°´çº¿åŒ–ï¼šå°†æ‰€æœ‰mapå’Œfilteræ“ä½œåˆå¹¶ä¸ºå•ä¸ªTaskæ‰§è¡Œ</span></span><br><span class="line">        <span class="comment">// 2. è°“è¯ä¸‹æ¨ï¼šå¦‚æœæ•°æ®æºæ”¯æŒï¼Œå°†filterä¸‹æ¨åˆ°è¯»å–å±‚</span></span><br><span class="line">        <span class="comment">// 3. å‡å°‘ä¸­é—´ç»“æœï¼šä¸éœ€è¦ç‰©åŒ–æ¯ä¸ªä¸­é—´RDD</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2. å‡å°‘ä¸å¿…è¦çš„è®¡ç®—ï¼ˆReduced Computationï¼‰</strong></p><p>æ‡’æƒ°è®¡ç®—ä½¿å¾—Sparkå¯ä»¥åªè®¡ç®—ä»»åŠ¡çœŸæ­£éœ€è¦çš„æ•°æ®ã€‚å¯¹äºä¸€äº›åªéœ€è¦éƒ¨åˆ†ç»“æœçš„è¡ŒåŠ¨æ“ä½œï¼Œè¿™ä¸ªç‰¹æ€§å¯ä»¥èŠ‚çœå¤§é‡çš„è®¡ç®—èµ„æºã€‚</p><ul><li>å½“ä½ è°ƒç”¨<code>rdd.take(5)</code>æ—¶ï¼ŒSparkçŸ¥é“åªéœ€è¦è·å–5æ¡è®°å½•ã€‚å®ƒä¼šå¯åŠ¨ä»»åŠ¡ï¼Œä¸€æ—¦æŸä¸ªåˆ†åŒºè®¡ç®—å¾—åˆ°äº†è¶³å¤Ÿçš„5æ¡è®°å½•ï¼Œå…¶ä»–æ­£åœ¨è¿è¡Œçš„æˆ–å°šæœªå¼€å§‹çš„ä»»åŠ¡å°±å¯ä»¥è¢«ç»ˆæ­¢ï¼Œé¿å…äº†å¯¹æ•´ä¸ªæ•°æ®é›†çš„æ— æ•ˆæ‰«æã€‚</li><li>ç±»ä¼¼åœ°ï¼Œ<code>rdd.first()</code>åªä¼šè®¡ç®—ç¬¬ä¸€ä¸ªåˆ†åŒºï¼Œç›´åˆ°æ‰¾åˆ°ç¬¬ä¸€æ¡è®°å½•ä¸ºæ­¢ã€‚</li></ul><p><strong>3. èŠ‚çœå†…å­˜å’Œå­˜å‚¨ï¼ˆMemory&#x2F;Storage Efficiencyï¼‰</strong></p><p>ç”±äºè½¬æ¢æ“ä½œä¸ä¼šç«‹å³ç‰©åŒ–ï¼ˆmaterializeï¼‰ä¸­é—´ç»“æœRDDï¼Œå› æ­¤æå¤§åœ°èŠ‚çœäº†å†…å­˜å’Œç£ç›˜ç©ºé—´ã€‚åœ¨ä¸€ä¸ªé•¿é•¿çš„è½¬æ¢é“¾ä¸­ï¼Œæ•°æ®ä»¥æµçš„æ–¹å¼åœ¨ç®—å­é—´ä¼ é€’ï¼Œå¤„ç†å®Œå³è¢«å›æ”¶ï¼Œå†…å­˜ä¸­åªéœ€ä¿ç•™å½“å‰æ­£åœ¨å¤„ç†çš„æ•°æ®å³å¯ã€‚è¿™ä¸é‚£äº›æ¯ä¸€æ­¥éƒ½ç”Ÿæˆå®Œæ•´ä¸­é—´ç»“æœçš„ç³»ç»Ÿå½¢æˆäº†é²œæ˜å¯¹æ¯”ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å†…å­˜æ•ˆç‡ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemoryEfficiency</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demonstrateMemoryEfficiency</span><span class="params">()</span> &#123;</span><br><span class="line">        JavaRDD&lt;String&gt; data = sc.textFile(<span class="string">&quot;input.txt&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å®šä¹‰é•¿è½¬æ¢é“¾ï¼ˆå…¨éƒ¨æ‡’æƒ°ï¼‰</span></span><br><span class="line">        JavaRDD&lt;String&gt; step1 = data.map(line -&gt; processStep1(line));</span><br><span class="line">        JavaRDD&lt;String&gt; step2 = step1.filter(line -&gt; line.length() &gt; <span class="number">10</span>);</span><br><span class="line">        JavaRDD&lt;String&gt; step3 = step2.map(line -&gt; processStep2(line));</span><br><span class="line">        JavaRDD&lt;String&gt; step4 = step3.filter(line -&gt; line.contains(<span class="string">&quot;important&quot;</span>));</span><br><span class="line">        JavaRDD&lt;String&gt; finalResult = step4.map(line -&gt; processStep3(line));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å…³é”®ç‚¹ï¼šè¿™äº›ä¸­é—´RDDï¼ˆstep1-step4ï¼‰ä¸ä¼šçœŸçš„å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼</span></span><br><span class="line">        <span class="comment">// å®ƒä»¬åªæ˜¯åŒ…å«Lineageä¿¡æ¯çš„å¯¹è±¡ï¼Œå®é™…æ•°æ®åœ¨Actionæ—¶æ‰è®¡ç®—</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åªæœ‰åœ¨Actionè§¦å‘æ—¶ï¼Œæ•°æ®æ‰æµå¼å¤„ç†ï¼Œæ— éœ€å­˜å‚¨ä¸­é—´ç»“æœ</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> finalResult.count();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¯¹æ¯”ï¼šå¦‚æœæ˜¯æ€¥åˆ‡è®¡ç®—ï¼Œæ¯ä¸ªstepéƒ½ä¼šäº§ç”Ÿå®Œæ•´çš„ä¸­é—´æ•°æ®é›†</span></span><br><span class="line">        <span class="comment">// è¿™ä¼šæ¶ˆè€—5å€çš„å†…å­˜ï¼</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>4. å®¹é”™æ€§ï¼ˆFault Toleranceï¼‰çš„å¤©ç„¶æ”¯æŒ</strong></p><p>æ‡’æƒ°è®¡ç®—ä¸Sparkçš„å®¹é”™æœºåˆ¶ç´§å¯†ç›¸å…³ã€‚å› ä¸ºSparkè®°å½•äº†å®Œæ•´çš„RDDè¡€ç¼˜å…³ç³»ï¼ˆLineageï¼‰ï¼Œå³æ¯ä¸ªRDDæ˜¯å¦‚ä½•é€šè¿‡è½¬æ¢æ“ä½œä»å…¶çˆ¶RDDæ´¾ç”Ÿè€Œæ¥çš„ã€‚è¿™ä¸ªLineageå°±åƒä¸€ä»½è¯¦ç»†çš„â€œæ•°æ®é‡å»ºæŒ‡å—â€ã€‚å½“é›†ç¾¤ä¸­æŸä¸ªèŠ‚ç‚¹æ•…éšœï¼Œå¯¼è‡´å…¶ä¸Šçš„æ•°æ®åˆ†åŒºä¸¢å¤±æ—¶ï¼ŒSparkå¯ä»¥æ ¹æ®è¿™ä»½æŒ‡å—ï¼Œç²¾ç¡®åœ°åªé‡æ–°è®¡ç®—ä¸¢å¤±çš„é‚£ä¸ªåˆ†åŒºï¼Œè€Œæ— éœ€é‡è·‘æ•´ä¸ªä½œä¸šã€‚æ‡’æƒ°è®¡ç®—ä½¿å¾—è®°å½•è¿™ä»½â€œæŒ‡å—â€æˆä¸ºå…¶æ‰§è¡Œæ¨¡å‹çš„è‡ªç„¶ç»„æˆéƒ¨åˆ†ã€‚</p><h3 id="6-3-æ‡’æƒ°è®¡ç®—å·¥ä½œåŸç†ï¼šè¯¦ç»†ç¤ºä¾‹åˆ†æ"><a href="#6-3-æ‡’æƒ°è®¡ç®—å·¥ä½œåŸç†ï¼šè¯¦ç»†ç¤ºä¾‹åˆ†æ" class="headerlink" title="6.3 æ‡’æƒ°è®¡ç®—å·¥ä½œåŸç†ï¼šè¯¦ç»†ç¤ºä¾‹åˆ†æ"></a>6.3 æ‡’æƒ°è®¡ç®—å·¥ä½œåŸç†ï¼šè¯¦ç»†ç¤ºä¾‹åˆ†æ</h3><p>è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„ä¾‹å­æ¥ç†è§£æ‡’æƒ°è®¡ç®—çš„å·¥ä½œæµç¨‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LazyEvaluationWorkflow</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">completeExample</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 1. å®šä¹‰RDDï¼ˆæƒ°æ€§ï¼šåªè®°å½•æ¥æºï¼‰</span></span><br><span class="line">        JavaRDD&lt;String&gt; textRDD = sc.textFile(<span class="string">&quot;hdfs://path/to/largefile.txt&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Step 1: åˆ›å»ºtextRDD - æ— è®¡ç®—å‘ç”Ÿï¼Œåªè®°å½•æ•°æ®æº&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. è½¬æ¢æ“ä½œï¼ˆæƒ°æ€§ï¼šåªè®°å½•è½¬æ¢é€»è¾‘ï¼‰</span></span><br><span class="line">        JavaRDD&lt;String&gt; wordsRDD = textRDD.flatMap(line -&gt; </span><br><span class="line">            Arrays.asList(line.split(<span class="string">&quot; &quot;</span>)).iterator());</span><br><span class="line">        System.out.println(<span class="string">&quot;Step 2: åˆ›å»ºwordsRDD - æ— è®¡ç®—å‘ç”Ÿï¼Œåªè®°å½•flatMapæ“ä½œ&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        JavaRDD&lt;String&gt; filteredRDD = wordsRDD.filter(word -&gt; </span><br><span class="line">            word.startsWith(<span class="string">&quot;error&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;Step 3: åˆ›å»ºfilteredRDD - æ— è®¡ç®—å‘ç”Ÿï¼Œåªè®°å½•filteræ“ä½œ&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        JavaPairRDD&lt;String, Integer&gt; mappedRDD = filteredRDD.mapToPair(word -&gt; </span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(word, <span class="number">1</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;Step 4: åˆ›å»ºmappedRDD - æ— è®¡ç®—å‘ç”Ÿï¼Œåªè®°å½•mapToPairæ“ä½œ&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        JavaPairRDD&lt;String, Integer&gt; errorCountRDD = mappedRDD.reduceByKey((a, b) -&gt; a + b);</span><br><span class="line">        System.out.println(<span class="string">&quot;Step 5: åˆ›å»ºerrorCountRDD - æ— è®¡ç®—å‘ç”Ÿï¼Œåªè®°å½•reduceByKeyæ“ä½œ&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ­¤æ—¶çš„çŠ¶æ€ï¼š</span></span><br><span class="line">        printRDDLineage(errorCountRDD);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. è¡ŒåŠ¨æ“ä½œï¼ˆè§¦å‘è®¡ç®—ï¼ï¼‰</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Step 6: è°ƒç”¨collect() - å¼€å§‹çœŸæ­£çš„è®¡ç®—ï¼&quot;</span>);</span><br><span class="line">        List&lt;Tuple2&lt;String, Integer&gt;&gt; result = errorCountRDD.collect();</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;è®¡ç®—å®Œæˆï¼Œç»“æœ: &quot;</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">printRDDLineage</span><span class="params">(JavaPairRDD&lt;String, Integer&gt; rdd)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;=== RDD Lineage ä¿¡æ¯ ===&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;errorCountRDD ä¾èµ–é“¾ï¼š&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;  textRDD (HadoopRDD) &lt;- æ•°æ®æº&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;  -&gt; wordsRDD (FlatMappedRDD) &lt;- flatMapè½¬æ¢&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;  -&gt; filteredRDD (FilteredRDD) &lt;- filterè½¬æ¢&quot;</span>); </span><br><span class="line">        System.out.println(<span class="string">&quot;  -&gt; mappedRDD (MapPartitionsRDD) &lt;- mapToPairè½¬æ¢&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;  -&gt; errorCountRDD (ShuffledRDD) &lt;- reduceByKeyè½¬æ¢&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;æ­¤æ—¶åªæœ‰é€»è¾‘æ‰§è¡Œè®¡åˆ’ï¼Œæ²¡æœ‰å®é™…æ•°æ®ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-4-æ‰§è¡Œæµç¨‹è¯¦è§£"><a href="#6-4-æ‰§è¡Œæµç¨‹è¯¦è§£" class="headerlink" title="6.4 æ‰§è¡Œæµç¨‹è¯¦è§£"></a>6.4 æ‰§è¡Œæµç¨‹è¯¦è§£</h3><p><strong>é˜¶æ®µ1ï¼šå®šä¹‰å’Œè½¬æ¢é˜¶æ®µï¼ˆtextFile åˆ° reduceByKeyï¼‰</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DAGæ„å»ºè¿‡ç¨‹çš„å†…éƒ¨æœºåˆ¶</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DAGBuildingProcess</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demonstrateDAGBuilding</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// å½“æ‰§è¡Œæ¯ä¸ªè½¬æ¢æ“ä½œæ—¶ï¼ŒSparkå†…éƒ¨çš„å·¥ä½œï¼š</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. textFileæ“ä½œ</span></span><br><span class="line">        JavaRDD&lt;String&gt; textRDD = sc.textFile(<span class="string">&quot;input.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// å†…éƒ¨ï¼šåˆ›å»ºHadoopRDDå¯¹è±¡ï¼Œè®°å½•ï¼š</span></span><br><span class="line">        <span class="comment">// - æ•°æ®æºè·¯å¾„</span></span><br><span class="line">        <span class="comment">// - åˆ†åŒºç­–ç•¥ï¼ˆåŸºäºHDFSå—ï¼‰</span></span><br><span class="line">        <span class="comment">// - ä¾èµ–å…³ç³»ï¼šæ— ï¼ˆå¶å­èŠ‚ç‚¹ï¼‰</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. flatMapæ“ä½œ</span></span><br><span class="line">        JavaRDD&lt;String&gt; wordsRDD = textRDD.flatMap(line -&gt; </span><br><span class="line">            Arrays.asList(line.split(<span class="string">&quot; &quot;</span>)).iterator());</span><br><span class="line">        <span class="comment">// å†…éƒ¨ï¼šåˆ›å»ºFlatMappedRDDå¯¹è±¡ï¼Œè®°å½•ï¼š</span></span><br><span class="line">        <span class="comment">// - çˆ¶RDDï¼štextRDD</span></span><br><span class="line">        <span class="comment">// - è½¬æ¢å‡½æ•°ï¼šsplitå’Œiterator</span></span><br><span class="line">        <span class="comment">// - ä¾èµ–ç±»å‹ï¼šçª„ä¾èµ–ï¼ˆOneToOneDependencyï¼‰</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. filteræ“ä½œ</span></span><br><span class="line">        JavaRDD&lt;String&gt; filteredRDD = wordsRDD.filter(word -&gt; word.startsWith(<span class="string">&quot;error&quot;</span>));</span><br><span class="line">        <span class="comment">// å†…éƒ¨ï¼šåˆ›å»ºFilteredRDDå¯¹è±¡ï¼Œè®°å½•ï¼š</span></span><br><span class="line">        <span class="comment">// - çˆ¶RDDï¼šwordsRDD</span></span><br><span class="line">        <span class="comment">// - è¿‡æ»¤å‡½æ•°ï¼šstartsWithåˆ¤æ–­</span></span><br><span class="line">        <span class="comment">// - ä¾èµ–ç±»å‹ï¼šçª„ä¾èµ–</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. reduceByKeyæ“ä½œ</span></span><br><span class="line">        JavaPairRDD&lt;String, Integer&gt; countRDD = </span><br><span class="line">            filteredRDD.mapToPair(w -&gt; <span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(w, <span class="number">1</span>)).reduceByKey((a, b) -&gt; a + b);</span><br><span class="line">        <span class="comment">// å†…éƒ¨ï¼šåˆ›å»ºShuffledRDDå¯¹è±¡ï¼Œè®°å½•ï¼š</span></span><br><span class="line">        <span class="comment">// - çˆ¶RDDï¼šmappedRDD</span></span><br><span class="line">        <span class="comment">// - èšåˆå‡½æ•°ï¼šaddition</span></span><br><span class="line">        <span class="comment">// - ä¾èµ–ç±»å‹ï¼šå®½ä¾èµ–ï¼ˆShuffleDependencyï¼‰</span></span><br><span class="line">        <span class="comment">// - åˆ†åŒºå™¨ï¼šHashPartitioner</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ„å»ºçš„DAGå›¾ï¼š</span></span><br><span class="line">        System.out.println(<span class="string">&quot;DAGç»“æ„ï¼š&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;HadoopRDD -&gt; FlatMappedRDD -&gt; FilteredRDD -&gt; MappedRDD -&gt; ShuffledRDD&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;    |            |              |            |           |&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;  textFile    flatMap        filter    mapToPair   reduceByKey&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;                                                        |&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;                                             Stageåˆ†ç•Œç‚¹ï¼ˆShuffleï¼‰&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>é˜¶æ®µ2ï¼šActionè§¦å‘æ‰§è¡Œ</strong></p><p><strong>1. DAGScheduleråˆ†æ</strong>ï¼š</p><ul><li>ä»collect()çš„ç›®æ ‡RDD(ShuffledRDD)å¼€å§‹å›æº¯Lineageé“¾</li><li>è¯†åˆ«ä¾èµ–å…³ç³»ï¼šå‘ç°flatMap+filter+mapToPairå¯æµæ°´çº¿æ‰§è¡Œ</li><li>ç¡®å®šreduceByKeyéœ€è¦å•ç‹¬Stageï¼ˆå®½ä¾èµ–è¾¹ç•Œï¼‰</li></ul><p><strong>2. Stageåˆ’åˆ†</strong>ï¼š</p><ul><li>Stage 0ï¼štextFile â†’ flatMap â†’ filter â†’ mapToPair<ul><li>è¾“å‡ºï¼šæŒ‰keyåˆ†åŒºçš„(word, 1)å¯¹</li></ul></li><li>Stage 1ï¼šreduceByKey<ul><li>è¾“å…¥ï¼šStage 0çš„Shuffleè¾“å‡º</li><li>è¾“å‡ºï¼š(word, count)ç»“æœ</li></ul></li></ul><p><strong>3. ä»»åŠ¡ç”Ÿæˆ</strong>ï¼š</p><ul><li>Stage 0ï¼šæ ¹æ®è¾“å…¥åˆ†åŒºæ•°ï¼ˆ4ä¸ªHDFSå—ï¼‰ç”Ÿæˆ4ä¸ªShuffleMapTask</li><li>Stage 1ï¼šæ ¹æ®Shuffleåˆ†åŒºæ•°ï¼ˆé»˜è®¤200ï¼‰ç”Ÿæˆ200ä¸ªResultTask</li></ul><p><strong>4. ä»»åŠ¡è°ƒåº¦</strong>ï¼š</p><ul><li>TaskSchedulerå°†ä»»åŠ¡åˆ†å‘åˆ°Executor</li><li>ä¼˜å…ˆè€ƒè™‘æ•°æ®æœ¬åœ°æ€§ï¼ˆæ•°æ®æ‰€åœ¨èŠ‚ç‚¹ï¼‰</li><li>ä¸¥æ ¼æ‰§è¡ŒStageé¡ºåºï¼šStage 0å®Œæˆæ‰èƒ½å¼€å§‹Stage 1</li></ul><p><strong>5. ä»»åŠ¡æ‰§è¡Œ</strong>ï¼š</p><ul><li>Stage 0ä»»åŠ¡ï¼š<ol><li>è¯»å–HDFSæ–‡ä»¶å—</li><li>æµæ°´çº¿æ‰§è¡Œï¼šsplit â†’ filter â†’ mapToPair</li><li>æŒ‰keyå“ˆå¸Œåˆ†åŒºï¼Œæ‰§è¡ŒShuffle Write</li></ol></li><li>Stage 1ä»»åŠ¡ï¼š<ol><li>ä»å¤šä¸ªèŠ‚ç‚¹æ‹‰å–æ•°æ®ï¼ˆShuffle Readï¼‰</li><li>æŒ‰keyèšåˆæ‰§è¡ŒreduceByKey</li><li>ç”Ÿæˆæœ€ç»ˆ(word, count)ç»“æœ</li></ol></li></ul><p><strong>6. ç»“æœæ”¶é›†</strong>ï¼š</p><ul><li>æ‰€æœ‰Stage 1çš„ResultTaskå°†ç»“æœå‘é€å›Driver</li><li>Driveræ±‡æ€»æ‰€æœ‰ç»“æœè¿”å›ç»™ç”¨æˆ·</li></ul><p>RDDçš„æ‡’æƒ°è®¡ç®—æœºåˆ¶æ˜¯Sparkå®ç°é«˜æ•ˆã€å®¹é”™çš„å¤§è§„æ¨¡åˆ†å¸ƒå¼æ•°æ®å¤„ç†çš„æ ¸å¿ƒæ™ºæ…§ã€‚å®ƒå°†æ˜‚è´µçš„è®¡ç®—æ¨è¿Ÿåˆ°æœ€åï¼Œå¹¶åˆ©ç”¨è¿™æ®µæ—¶é—´çª—å£è¿›è¡Œå…¨å±€ä¼˜åŒ–ï¼Œæå¤§åœ°æå‡äº†å¤„ç†èƒ½åŠ›å’Œèµ„æºåˆ©ç”¨ç‡ã€‚ç†è§£è¿™ä¸€æœºåˆ¶å¯¹äºç¼–å†™é«˜æ•ˆçš„Sparkåº”ç”¨ç¨‹åºè‡³å…³é‡è¦ã€‚</p><h2 id="7-æ•°æ®æœ¬åœ°æ€§åŸç†æ·±åº¦è§£æ"><a href="#7-æ•°æ®æœ¬åœ°æ€§åŸç†æ·±åº¦è§£æ" class="headerlink" title="7. æ•°æ®æœ¬åœ°æ€§åŸç†æ·±åº¦è§£æ"></a>7. æ•°æ®æœ¬åœ°æ€§åŸç†æ·±åº¦è§£æ</h2><p><strong>â€œç§»åŠ¨è®¡ç®—ï¼Œè€Œéç§»åŠ¨æ•°æ®â€</strong>æ˜¯å¤§æ•°æ®å¤„ç†çš„åŸºæœ¬åŸåˆ™ã€‚æ•°æ®æœ¬åœ°æ€§ï¼ˆData Localityï¼‰æ­£æ˜¯è¿™ä¸€åŸåˆ™åœ¨Sparkä¸­çš„å…·ä½“ä½“ç°ã€‚ç”±äºç½‘ç»œä¼ è¾“çš„å¼€é”€è¿œå¤§äºå†…å­˜è¯»å–ï¼ŒSparkçš„è°ƒåº¦å™¨ä¼šå°½å¯èƒ½åœ°å°†è®¡ç®—ä»»åŠ¡åˆ†é…åˆ°å­˜å‚¨ç€å…¶æ‰€éœ€æ•°æ®çš„èŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼Œä»¥æœ€å¤§é™åº¦åœ°å‡å°‘ç½‘ç»œIOï¼Œæå‡æ€§èƒ½ã€‚</p><h3 id="7-1-æ•°æ®æœ¬åœ°æ€§çš„å±‚æ¬¡ç»“æ„"><a href="#7-1-æ•°æ®æœ¬åœ°æ€§çš„å±‚æ¬¡ç»“æ„" class="headerlink" title="7.1 æ•°æ®æœ¬åœ°æ€§çš„å±‚æ¬¡ç»“æ„"></a>7.1 æ•°æ®æœ¬åœ°æ€§çš„å±‚æ¬¡ç»“æ„</h3><p>Sparkå®šä¹‰äº†ä»ä¼˜åˆ°åŠ£çš„å¤šä¸ªæœ¬åœ°æ€§çº§åˆ«ï¼Œä»»åŠ¡è°ƒåº¦å™¨ä¼šæŒ‰ç…§è¿™ä¸ªé¡ºåºï¼Œåœ¨ä¸€å®šçš„æ—¶é—´ç­‰å¾…é˜ˆå€¼å†…ï¼Œä¸ºä»»åŠ¡å¯»æ‰¾æœ€â€œè¿‘â€çš„å¯ç”¨èµ„æºã€‚</p><p><strong>æœ¬åœ°æ€§çº§åˆ«çš„è¯¦ç»†å®šä¹‰ï¼š</strong></p><ul><li><code>PROCESS_LOCAL</code>: ä»»åŠ¡å’Œæ•°æ®åœ¨åŒä¸€ä¸ªExecutorçš„JVMè¿›ç¨‹ä¸­ã€‚è¿™æ˜¯æœ€ç†æƒ³çš„çº§åˆ«ï¼Œæ•°æ®æ— éœ€ä»»ä½•ç½‘ç»œä¼ è¾“ï¼Œå¯ä»¥ç›´æ¥åœ¨å†…å­˜ä¸­è®¿é—®ã€‚</li><li><code>NODE_LOCAL</code>: ä»»åŠ¡å’Œæ•°æ®åœ¨åŒä¸€ä¸ªç‰©ç†èŠ‚ç‚¹ä¸Šï¼Œä½†å¯èƒ½åœ¨ä¸åŒçš„Executorè¿›ç¨‹ä¸­ã€‚æ•°æ®éœ€è¦é€šè¿‡èŠ‚ç‚¹å†…éƒ¨çš„è¿›ç¨‹é—´é€šä¿¡æˆ–å…±äº«å†…å­˜æ¥ä¼ è¾“ã€‚</li><li><code>RACK_LOCAL</code>: ä»»åŠ¡å’Œæ•°æ®åœ¨åŒä¸€ä¸ªæœºæ¶ï¼ˆRackï¼‰çš„ä¸åŒèŠ‚ç‚¹ä¸Šã€‚æ•°æ®éœ€è¦é€šè¿‡æœºæ¶å†…çš„äº¤æ¢æœºè¿›è¡Œç½‘ç»œä¼ è¾“ã€‚</li><li><code>ANY</code>: ä»»åŠ¡å’Œæ•°æ®åœ¨é›†ç¾¤çš„ä»»ä½•åœ°æ–¹ï¼Œé€šå¸¸æ„å‘³ç€éœ€è¦è·¨æœºæ¶è¿›è¡Œç½‘ç»œä¼ è¾“ï¼Œè¿™æ˜¯å¼€é”€æœ€å¤§çš„æƒ…å†µã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ•°æ®æœ¬åœ°æ€§çº§åˆ«æšä¸¾</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">TaskLocality</span> &#123;</span><br><span class="line">    PROCESS_LOCAL(<span class="string">&quot;PROCESS_LOCAL&quot;</span>, <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAllowed</span><span class="params">(TaskSetManager taskSet, <span class="type">long</span> currentTime)</span> &#123;</span><br><span class="line">            <span class="comment">// è¿›ç¨‹æœ¬åœ°ï¼šæ•°æ®åœ¨åŒä¸€JVMè¿›ç¨‹ä¸­</span></span><br><span class="line">            <span class="keyword">return</span> taskSet.getAllowedLocalityLevel(currentTime).ordinal() &gt;= ordinal();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    NODE_LOCAL(<span class="string">&quot;NODE_LOCAL&quot;</span>, <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAllowed</span><span class="params">(TaskSetManager taskSet, <span class="type">long</span> currentTime)</span> &#123;</span><br><span class="line">            <span class="comment">// èŠ‚ç‚¹æœ¬åœ°ï¼šæ•°æ®åœ¨åŒä¸€ç‰©ç†èŠ‚ç‚¹ä¸Š</span></span><br><span class="line">            <span class="keyword">return</span> taskSet.getAllowedLocalityLevel(currentTime).ordinal() &gt;= ordinal();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    RACK_LOCAL(<span class="string">&quot;RACK_LOCAL&quot;</span>, <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAllowed</span><span class="params">(TaskSetManager taskSet, <span class="type">long</span> currentTime)</span> &#123;</span><br><span class="line">            <span class="comment">// æœºæ¶æœ¬åœ°ï¼šæ•°æ®åœ¨åŒä¸€æœºæ¶å†…</span></span><br><span class="line">            <span class="keyword">return</span> taskSet.getAllowedLocalityLevel(currentTime).ordinal() &gt;= ordinal();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    ANY(<span class="string">&quot;ANY&quot;</span>, <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAllowed</span><span class="params">(TaskSetManager taskSet, <span class="type">long</span> currentTime)</span> &#123;</span><br><span class="line">            <span class="comment">// ä»»æ„ä½ç½®ï¼šå¯ä»¥åœ¨ä»»ä½•åœ°æ–¹æ‰§è¡Œ</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String toString;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> id;</span><br><span class="line">    </span><br><span class="line">    TaskLocality(String toString, <span class="type">int</span> id) &#123;</span><br><span class="line">        <span class="built_in">this</span>.toString = toString;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="type">boolean</span> <span class="title function_">isAllowed</span><span class="params">(TaskSetManager taskSet, <span class="type">long</span> currentTime)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æœ¬åœ°æ€§æ„ŸçŸ¥çš„ä»»åŠ¡è°ƒåº¦ç®—æ³•ï¼š</strong><br>Sparkçš„ä»»åŠ¡è°ƒåº¦å¹¶éâ€œæ­»ç­‰â€æœ€ä½³çš„æœ¬åœ°æ€§çº§åˆ«ã€‚å®ƒé‡‡ç”¨äº†ä¸€ç§<strong>å»¶è¿Ÿè°ƒåº¦ï¼ˆDelay Schedulingï¼‰</strong>ç­–ç•¥ï¼Œåœ¨æ•ˆç‡å’Œæ—¶é—´ä¹‹é—´è¿›è¡Œæƒè¡¡ï¼š</p><ol><li>è°ƒåº¦å™¨é¦–å…ˆå°è¯•ä»¥<code>PROCESS_LOCAL</code>çº§åˆ«åœ¨æ•°æ®æ‰€åœ¨çš„Executorä¸Šå¯åŠ¨ä»»åŠ¡ã€‚</li><li>å¦‚æœåœ¨è®¾å®šçš„ç­‰å¾…æ—¶é—´ï¼ˆé»˜è®¤ä¸º3ç§’ï¼Œç”±<code>spark.locality.wait</code>é…ç½®ï¼‰å†…ï¼Œè¯¥Executoræ²¡æœ‰ç©ºé—²èµ„æºï¼Œè°ƒåº¦å™¨ä¼šå°†æœ¬åœ°æ€§çº§åˆ«é™çº§åˆ°<code>NODE_LOCAL</code>ï¼Œå°è¯•åœ¨è¯¥èŠ‚ç‚¹çš„å…¶ä»–Executorä¸Šå¯åŠ¨ä»»åŠ¡ã€‚</li><li>å¦‚æœåˆç­‰å¾…äº†ä¸€ä¸ªå‘¨æœŸåä»ç„¶æ²¡æœ‰èµ„æºï¼Œçº§åˆ«ä¼šç»§ç»­é™çº§åˆ°<code>RACK_LOCAL</code>ï¼Œæœ€ååˆ°<code>ANY</code>ã€‚<br>è¿™ç§ç­–ç•¥æ—¢è¿½æ±‚äº†æœ€ä½³çš„æ•°æ®æœ¬åœ°æ€§ï¼Œåˆé¿å…äº†å› ç­‰å¾…æŸä¸ªç¹å¿™èŠ‚ç‚¹è€Œå¯¼è‡´æ•´ä¸ªä½œä¸šè¢«é˜»å¡ã€‚</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æœ¬åœ°æ€§æ„ŸçŸ¥è°ƒåº¦å™¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LocalityAwareTaskScheduler</span> &#123;</span><br><span class="line">    <span class="comment">// æœ¬åœ°æ€§ç­‰å¾…æ—¶é—´é…ç½®</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;TaskLocality, Long&gt; localityWaitMap = Map.of(</span><br><span class="line">        TaskLocality.PROCESS_LOCAL, <span class="number">3000L</span>,  <span class="comment">// 3ç§’</span></span><br><span class="line">        TaskLocality.NODE_LOCAL, <span class="number">3000L</span>,     <span class="comment">// 3ç§’</span></span><br><span class="line">        TaskLocality.RACK_LOCAL, <span class="number">3000L</span>,     <span class="comment">// 3ç§’</span></span><br><span class="line">        TaskLocality.ANY, <span class="number">0L</span>                <span class="comment">// ç«‹å³æ‰§è¡Œ</span></span><br><span class="line">    );</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> å¤§æ•°æ® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spark </tag>
            
            <tag> åˆ†å¸ƒå¼è®¡ç®— </tag>
            
            <tag> RDD </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spark3.xæ ¸å¿ƒç®—å­åŸç†è§£æï¼šæ•°æ®æµè½¬ä¸Shuffleæœºåˆ¶[åé¢ä¼šæ‹†åˆ†]</title>
      <link href="/2025/07/09/Spark3.x%E6%A0%B8%E5%BF%83%E7%AE%97%E5%AD%90%E5%8E%9F%E7%90%86%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%EF%BC%9A%E6%95%B0%E6%8D%AE%E6%B5%81%E8%BD%AC%E4%B8%8EShuffle%E6%9C%BA%E5%88%B6/"/>
      <url>/2025/07/09/Spark3.x%E6%A0%B8%E5%BF%83%E7%AE%97%E5%AD%90%E5%8E%9F%E7%90%86%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%EF%BC%9A%E6%95%B0%E6%8D%AE%E6%B5%81%E8%BD%AC%E4%B8%8EShuffle%E6%9C%BA%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<h1 id="Spark3-xæ ¸å¿ƒç®—å­åŸç†æ·±åº¦å‰–æï¼šæ•°æ®æµè½¬ä¸Shuffleæœºåˆ¶"><a href="#Spark3-xæ ¸å¿ƒç®—å­åŸç†æ·±åº¦å‰–æï¼šæ•°æ®æµè½¬ä¸Shuffleæœºåˆ¶" class="headerlink" title="Spark3.xæ ¸å¿ƒç®—å­åŸç†æ·±åº¦å‰–æï¼šæ•°æ®æµè½¬ä¸Shuffleæœºåˆ¶"></a>Spark3.xæ ¸å¿ƒç®—å­åŸç†æ·±åº¦å‰–æï¼šæ•°æ®æµè½¬ä¸Shuffleæœºåˆ¶</h1><h2 id="ä¸€ã€å¼•è¨€ï¼šç†è§£Sparkç®—å­çš„æœ¬è´¨"><a href="#ä¸€ã€å¼•è¨€ï¼šç†è§£Sparkç®—å­çš„æœ¬è´¨" class="headerlink" title="ä¸€ã€å¼•è¨€ï¼šç†è§£Sparkç®—å­çš„æœ¬è´¨"></a>ä¸€ã€å¼•è¨€ï¼šç†è§£Sparkç®—å­çš„æœ¬è´¨</h2><p>åœ¨Sparkå¼€å‘ä¸­ï¼Œæˆ‘ä»¬æ¯å¤©éƒ½åœ¨ä½¿ç”¨å„ç§ç®—å­ï¼Œä½†å¾ˆå°‘æœ‰äººçœŸæ­£ç†è§£å®ƒä»¬èƒŒåçš„æ‰§è¡ŒåŸç†ã€‚è¿™ç¯‡æ–‡ç« ä»å®é™…æ‰§è¡Œçš„è§’åº¦ï¼Œæ·±å…¥åˆ†æSpark3.xä¸­å‡ ä¸ªæ ¸å¿ƒç®—å­çš„å†…éƒ¨æœºåˆ¶ã€‚</p><p><strong>æ–‡æ¡£ç»“æ„æ¦‚è§ˆï¼š</strong></p><pre class="mermaid">graph TD    A[ä¸€ã€å¼•è¨€ï¼šç†è§£Sparkç®—å­çš„æœ¬è´¨] --> A1[1.1 ç®—å­åˆ†ç±»ä¸ç‰¹æ€§]    A --> A2[1.2 ç®—å­æ‰§è¡Œçš„å†…å­˜æ¨¡å‹]    A --> A3[1.3 æ•°æ®åºåˆ—åŒ–ä¸ç½‘ç»œä¼ è¾“]    A --> A4[1.4 ä¸ºä»€ä¹ˆç†è§£ç®—å­åŸç†å¦‚æ­¤é‡è¦]    A --> A5[1.5 RDDæ‡’æƒ°è®¡ç®—æœºåˆ¶æ·±åº¦è§£æ]    A --> A6[1.6 æ•°æ®æœ¬åœ°æ€§åŸç†æ·±åº¦è§£æ]        A --> B[äºŒã€åŸºç¡€ç®—å­ï¼šmapã€filterã€flatMap]    B --> B1[2.1 mapç®—å­ï¼šä¸€å¯¹ä¸€è½¬æ¢]    B --> B2[2.2 filterç®—å­ï¼šæ¡ä»¶è¿‡æ»¤]    B --> B3[2.3 flatMapç®—å­ï¼šä¸€å¯¹å¤šè½¬æ¢]    B --> B4[2.4 ç®—å­é“¾ä¼˜åŒ–æœºåˆ¶æ·±åº¦å‰–æ]        B --> C[ä¸‰ã€Shuffleæœºåˆ¶æ·±åº¦è§£æ]    C --> C1[3.1 ä»€ä¹ˆæ˜¯Shuffleï¼Ÿ]    C --> C2[3.2 Shuffleçš„ä¸¤ä¸ªé˜¶æ®µ]        C --> D[å››ã€å¤æ‚ç®—å­ï¼šdistinctã€sortBy]    D --> D1[4.1 distinctç®—å­ï¼šå»é‡æ“ä½œ]    D --> D2[4.2 sortByç®—å­ï¼šæ’åºæ“ä½œ]        D --> E[äº”ã€å®¹é”™æœºåˆ¶ï¼šè¡€ç¼˜å…³ç³»ä¸æ•…éšœæ¢å¤]    E --> E1[5.1 RDDè¡€ç¼˜å…³ç³»æ·±åº¦è§£æ]    E --> E2[5.2 æ£€æŸ¥ç‚¹æœºåˆ¶è¯¦è§£]    E --> E3[5.3 å®¹é”™æœºåˆ¶çš„æ€§èƒ½å½±å“]        E --> F[å…­ã€Spark3.x æ€§èƒ½ä¼˜åŒ–ç­–ç•¥å¤§å…¨]    F --> F1[6.1 åºåˆ—åŒ–ä¼˜åŒ–ï¼šKryo vs JavaåŸç”Ÿåºåˆ—åŒ–]    F --> F2[6.2 åˆ†åŒºä¼˜åŒ–ç­–ç•¥]    F --> F3[6.3 è‡ªé€‚åº”æŸ¥è¯¢æ‰§è¡ŒAQE]    F --> F4[6.4 Shuffleä¼˜åŒ–ç­–ç•¥]    F --> F5[6.5 åŠ¨æ€åˆ†åŒºè£å‰ªDPP]    F --> F6[6.6 è‡ªå®šä¹‰åˆ†åŒºå™¨]    F --> F7[6.7 æ•°æ®å€¾æ–œå¤„ç†ç­–ç•¥]        F --> G[ä¸ƒã€ç®—å­ç»„åˆçš„æ€§èƒ½å½±å“ä¸æœ€ä½³å®è·µ]    G --> G1[7.1 ç®—å­é€‰æ‹©åŸåˆ™]    G --> G2[7.2 å†…å­˜ä¼˜åŒ–]    G --> G3[7.3 ç›‘æ§ä¸è°ƒè¯•]        G --> H[å…«ã€æ€»ç»“]        style A fill:#e1f5fe    style E fill:#f3e5f5    style F fill:#fff3e0    style H fill:#e8f5e8</pre><h3 id="1-1-Sparkç®—å­çš„åˆ†ç±»ä¸ç‰¹æ€§"><a href="#1-1-Sparkç®—å­çš„åˆ†ç±»ä¸ç‰¹æ€§" class="headerlink" title="1.1 Sparkç®—å­çš„åˆ†ç±»ä¸ç‰¹æ€§"></a>1.1 Sparkç®—å­çš„åˆ†ç±»ä¸ç‰¹æ€§</h3><p>Sparkç®—å­æŒ‰ç…§ä¾èµ–å…³ç³»å¯ä»¥åˆ†ä¸ºä¸¤å¤§ç±»ï¼š</p><p><strong>çª„ä¾èµ–ç®—å­ï¼ˆNarrow Dependencyï¼‰ï¼š</strong></p><ul><li>å­RDDçš„æ¯ä¸ªåˆ†åŒºåªä¾èµ–çˆ¶RDDçš„ä¸€ä¸ªåˆ†åŒº</li><li>æ•°æ®ä¸éœ€è¦è·¨èŠ‚ç‚¹ä¼ è¾“ï¼Œå…·æœ‰è‰¯å¥½çš„æ•°æ®å±€éƒ¨æ€§</li><li>ä»£è¡¨ç®—å­ï¼šmapã€filterã€flatMapã€unionç­‰</li><li>ç‰¹ç‚¹ï¼šæ‰§è¡Œé€Ÿåº¦å¿«ï¼Œå†…å­˜å‹å¥½ï¼Œæ˜“äºæµæ°´çº¿ä¼˜åŒ–</li></ul><p><strong>å®½ä¾èµ–ç®—å­ï¼ˆWide Dependencyï¼‰ï¼š</strong></p><ul><li>å­RDDçš„æ¯ä¸ªåˆ†åŒºä¾èµ–çˆ¶RDDçš„å¤šä¸ªåˆ†åŒº</li><li>éœ€è¦è¿›è¡ŒShuffleæ“ä½œï¼Œæ•°æ®è·¨èŠ‚ç‚¹ä¼ è¾“</li><li>ä»£è¡¨ç®—å­ï¼šgroupByKeyã€reduceByKeyã€joinã€distinctç­‰</li><li>ç‰¹ç‚¹ï¼šæ‰§è¡Œå¼€é”€å¤§ï¼Œæ¶‰åŠç½‘ç»œIOå’Œç£ç›˜IO</li></ul><h3 id="1-2-ç®—å­æ‰§è¡Œçš„å†…å­˜æ¨¡å‹"><a href="#1-2-ç®—å­æ‰§è¡Œçš„å†…å­˜æ¨¡å‹" class="headerlink" title="1.2 ç®—å­æ‰§è¡Œçš„å†…å­˜æ¨¡å‹"></a>1.2 ç®—å­æ‰§è¡Œçš„å†…å­˜æ¨¡å‹</h3><p>Sparkä½¿ç”¨ç»Ÿä¸€å†…å­˜ç®¡ç†ï¼ˆUnified Memory Managementï¼‰æœºåˆ¶ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Sparkå†…å­˜ç®¡ç†å™¨çš„æ ¸å¿ƒé€»è¾‘</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UnifiedMemoryManager</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> maxExecutionMemory;    <span class="comment">// æ‰§è¡Œå†…å­˜ä¸Šé™</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> maxStorageMemory;      <span class="comment">// å­˜å‚¨å†…å­˜ä¸Šé™</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">double</span> storageFraction;     <span class="comment">// å­˜å‚¨å†…å­˜æ¯”ä¾‹</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">acquireExecutionMemory</span><span class="params">(<span class="type">long</span> numBytes)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. æ£€æŸ¥æ‰§è¡Œå†…å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">        <span class="keyword">if</span> (executionMemoryUsed + numBytes &lt;= maxExecutionMemory) &#123;</span><br><span class="line">            executionMemoryUsed += numBytes;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. å°è¯•ä»å­˜å‚¨å†…å­˜å€Ÿç”¨</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">memoryToBorrow</span> <span class="operator">=</span> Math.min(</span><br><span class="line">            numBytes - (maxExecutionMemory - executionMemoryUsed),</span><br><span class="line">            storageMemoryUsed</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (memoryToBorrow &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// é©±é€ç¼“å­˜æ•°æ®ï¼Œé‡Šæ”¾å­˜å‚¨å†…å­˜</span></span><br><span class="line">            evictCachedBlocks(memoryToBorrow);</span><br><span class="line">            executionMemoryUsed += numBytes;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// å†…å­˜ä¸è¶³</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å†…å­˜åŒºåŸŸåˆ’åˆ†ï¼š</strong></p><ol><li><strong>Reserved Memoryï¼ˆ300MBï¼‰</strong>ï¼šç³»ç»Ÿä¿ç•™å†…å­˜ï¼Œç”¨äºSparkå†…éƒ¨å¯¹è±¡</li><li><strong>User Memory</strong>ï¼šç”¨æˆ·ä»£ç ä½¿ç”¨çš„å†…å­˜ï¼Œå­˜å‚¨ç”¨æˆ·æ•°æ®ç»“æ„</li><li><strong>Spark Memory</strong>ï¼šSparkæ¡†æ¶ä½¿ç”¨çš„å†…å­˜ï¼Œè¿›ä¸€æ­¥åˆ†ä¸ºï¼š<ul><li><strong>Execution Memory</strong>ï¼šæ‰§è¡Œç®—å­æ—¶ä½¿ç”¨ï¼Œå¦‚Shuffleã€Joinã€Sort</li><li><strong>Storage Memory</strong>ï¼šç¼“å­˜RDDå’Œå¹¿æ’­å˜é‡</li></ul></li></ol><h3 id="1-3-æ•°æ®åºåˆ—åŒ–ä¸ç½‘ç»œä¼ è¾“"><a href="#1-3-æ•°æ®åºåˆ—åŒ–ä¸ç½‘ç»œä¼ è¾“" class="headerlink" title="1.3 æ•°æ®åºåˆ—åŒ–ä¸ç½‘ç»œä¼ è¾“"></a>1.3 æ•°æ®åºåˆ—åŒ–ä¸ç½‘ç»œä¼ è¾“</h3><p>Sparkä¸­çš„æ•°æ®åºåˆ—åŒ–å‘ç”Ÿåœ¨å¤šä¸ªç¯èŠ‚ï¼š</p><p><strong>åºåˆ—åŒ–è§¦å‘åœºæ™¯ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. Taskåºåˆ—åŒ–ï¼šå°†Taskä»Driverå‘é€åˆ°Executor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TaskSerialization</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] serializeTask(Task&lt;?&gt; task) &#123;</span><br><span class="line">        <span class="comment">// ä»»åŠ¡åŒ…å«ï¼šä»£ç ã€ä¾èµ–ã€åˆ†åŒºä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> serializer.serialize(task);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. Shuffleåºåˆ—åŒ–ï¼šæ•°æ®åœ¨èŠ‚ç‚¹é—´ä¼ è¾“</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShuffleDataSerialization</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writeShuffleData</span><span class="params">(Iterator&lt;Product2&lt;K, V&gt;&gt; records)</span> &#123;</span><br><span class="line">        <span class="type">SerializationStream</span> <span class="variable">stream</span> <span class="operator">=</span> serializer.serializeStream(outputStream);</span><br><span class="line">        <span class="keyword">while</span> (records.hasNext()) &#123;</span><br><span class="line">            Product2&lt;K, V&gt; record = records.next();</span><br><span class="line">            stream.writeKey(record._1);    <span class="comment">// åºåˆ—åŒ–key</span></span><br><span class="line">            stream.writeValue(record._2);  <span class="comment">// åºåˆ—åŒ–value</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. ç¼“å­˜åºåˆ—åŒ–ï¼šRDDæŒä¹…åŒ–åˆ°å†…å­˜/ç£ç›˜</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheSerialization</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cacheRDD</span><span class="params">(RDD&lt;?&gt; rdd, StorageLevel level)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (level.useSerialization()) &#123;</span><br><span class="line">            <span class="comment">// å°†RDDæ•°æ®åºåˆ—åŒ–åå­˜å‚¨</span></span><br><span class="line">            <span class="type">byte</span>[] serializedData = serializer.serialize(rdd.collect());</span><br><span class="line">            blockManager.putBytes(blockId, serializedData, level);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-4-ä¸ºä»€ä¹ˆç†è§£ç®—å­åŸç†å¦‚æ­¤é‡è¦ï¼Ÿ"><a href="#1-4-ä¸ºä»€ä¹ˆç†è§£ç®—å­åŸç†å¦‚æ­¤é‡è¦ï¼Ÿ" class="headerlink" title="1.4 ä¸ºä»€ä¹ˆç†è§£ç®—å­åŸç†å¦‚æ­¤é‡è¦ï¼Ÿ"></a>1.4 ä¸ºä»€ä¹ˆç†è§£ç®—å­åŸç†å¦‚æ­¤é‡è¦ï¼Ÿ</h3><p><strong>æ€§èƒ½å·®å¼‚çš„æ ¹æœ¬åŸå› ï¼š</strong></p><p>ä¸åŒç®—å­çš„æ€§èƒ½å·®å¼‚ä¸»è¦æºäºï¼š</p><ol><li><strong>ä¾èµ–å…³ç³»</strong>ï¼šçª„ä¾èµ– vs å®½ä¾èµ–å†³å®šäº†æ˜¯å¦éœ€è¦Shuffle</li><li><strong>æ•°æ®å±€éƒ¨æ€§</strong>ï¼šæœ¬åœ°è®¡ç®— vs ç½‘ç»œä¼ è¾“çš„å·¨å¤§æ€§èƒ½å·®å¼‚</li><li><strong>å†…å­˜ä½¿ç”¨æ¨¡å¼</strong>ï¼šæµå¼å¤„ç† vs æ‰¹é‡åŠ è½½çš„å†…å­˜æ•ˆç‡</li><li><strong>CPUåˆ©ç”¨ç‡</strong>ï¼šå•çº¿ç¨‹å¤„ç† vs å¹¶è¡Œè®¡ç®—çš„æ•ˆç‡å·®å¼‚</li></ol><p>ä¸¾ä¸ªå®é™…ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœºæ™¯ï¼šå¤„ç†1GBæ•°æ®ï¼Œç»Ÿè®¡æ¯ä¸ªç”¨æˆ·çš„è®¢å•æ•°é‡</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–¹æ¡ˆ1ï¼šä½¿ç”¨groupByKey - æ€§èƒ½å·®</span></span><br><span class="line">JavaPairRDD&lt;String, Integer&gt; result1 = orders</span><br><span class="line">    .mapToPair(order -&gt; <span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(order.getUserId(), <span class="number">1</span>))</span><br><span class="line">    .groupByKey()  <span class="comment">// å®½ä¾èµ–ï¼ŒShuffleæ‰€æœ‰æ•°æ®</span></span><br><span class="line">    .mapValues(values -&gt; &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (Integer v : values) count += v;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;);</span><br><span class="line"><span class="comment">// æ‰§è¡Œæ—¶é—´ï¼šçº¦45ç§’ï¼ŒShuffleæ•°æ®é‡ï¼š1GB</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–¹æ¡ˆ2ï¼šä½¿ç”¨reduceByKey - æ€§èƒ½å¥½</span></span><br><span class="line">JavaPairRDD&lt;String, Integer&gt; result2 = orders</span><br><span class="line">    .mapToPair(order -&gt; <span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(order.getUserId(), <span class="number">1</span>))</span><br><span class="line">    .reduceByKey((a, b) -&gt; a + b);  <span class="comment">// æœ¬åœ°é¢„èšåˆï¼Œå‡å°‘Shuffleæ•°æ®</span></span><br><span class="line"><span class="comment">// æ‰§è¡Œæ—¶é—´ï¼šçº¦15ç§’ï¼ŒShuffleæ•°æ®é‡ï¼šçº¦100MBï¼ˆå‡è®¾æœ‰10ä¸‡ç”¨æˆ·ï¼‰</span></span><br></pre></td></tr></table></figure><p><strong>ä¼˜åŒ–æ€è·¯çš„æœ¬è´¨ï¼š</strong><br>ç†è§£ç®—å­åŸç†è®©æˆ‘ä»¬èƒ½å¤Ÿï¼š</p><ul><li>é€‰æ‹©åˆé€‚çš„ç®—å­å‡å°‘Shuffle</li><li>è®¾è®¡åˆç†çš„æ•°æ®æµå‡å°‘åºåˆ—åŒ–å¼€é”€</li><li>åˆ©ç”¨æ•°æ®å±€éƒ¨æ€§æå‡è®¡ç®—æ•ˆç‡</li><li>åˆç†é…ç½®å†…å­˜é¿å…OOMå’Œæ€§èƒ½ç“¶é¢ˆ</li></ul><p>ä¸ºä»€ä¹ˆæœ‰äº›ç®—å­æ‰§è¡Œå¾ˆå¿«ï¼Œæœ‰äº›å´å¾ˆæ…¢ï¼Ÿç­”æ¡ˆå°±è—åœ¨ç®—å­çš„å®ç°åŸç†å’Œæ•°æ®æµè½¬æœºåˆ¶ä¸­ã€‚</p><h3 id="1-5-RDDæ‡’æƒ°è®¡ç®—æœºåˆ¶æ·±åº¦å‰–æ"><a href="#1-5-RDDæ‡’æƒ°è®¡ç®—æœºåˆ¶æ·±åº¦å‰–æ" class="headerlink" title="1.5 RDDæ‡’æƒ°è®¡ç®—æœºåˆ¶æ·±åº¦å‰–æ"></a>1.5 RDDæ‡’æƒ°è®¡ç®—æœºåˆ¶æ·±åº¦å‰–æ</h3><p>æ‡’æƒ°è®¡ç®—æ˜¯Sparkå®ç°é«˜æ•ˆåˆ†å¸ƒå¼è®¡ç®—çš„æ ¸å¿ƒæ™ºæ…§ï¼Œè®©æˆ‘ä»¬æ·±å…¥å‰–æè¿™ä¸€æœºåˆ¶çš„åŸç†å’Œå½±å“ã€‚</p><h4 id="1-5-1-æ ¸å¿ƒæ¦‚å¿µï¼šæ‡’æƒ°è®¡ç®—-vs-æ€¥åˆ‡è®¡ç®—"><a href="#1-5-1-æ ¸å¿ƒæ¦‚å¿µï¼šæ‡’æƒ°è®¡ç®—-vs-æ€¥åˆ‡è®¡ç®—" class="headerlink" title="1.5.1 æ ¸å¿ƒæ¦‚å¿µï¼šæ‡’æƒ°è®¡ç®— vs æ€¥åˆ‡è®¡ç®—"></a>1.5.1 æ ¸å¿ƒæ¦‚å¿µï¼šæ‡’æƒ°è®¡ç®— vs æ€¥åˆ‡è®¡ç®—</h4><p><strong>æ‡’æƒ°è®¡ç®—ï¼ˆLazy Evaluationï¼‰</strong>ï¼š</p><ul><li>æŒ‡çš„æ˜¯Sparkåœ¨é‡åˆ°<strong>è½¬æ¢æ“ä½œï¼ˆTransformationsï¼‰</strong>æ—¶ï¼Œå¹¶ä¸ä¼šç«‹å³æ‰§è¡Œè®¡ç®—å¹¶ç”Ÿæˆæ–°çš„RDD</li><li>å®ƒåªæ˜¯è®°å½•ä¸‹è¿™ä¸ªæ“ä½œä»¥åŠå®ƒä¾èµ–çš„çˆ¶RDDï¼ˆå³ï¼šæ„å»ºäº†ä¸€ä¸ªé€»è¾‘æ‰§è¡Œè®¡åˆ’æˆ–ç§°ä¸ºLineageï¼‰</li><li>çœŸæ­£çš„è®¡ç®—ï¼ˆæ•°æ®è¯»å–ã€è½¬æ¢å¤„ç†ï¼‰ä¼šè¢«æ¨è¿Ÿåˆ°é‡åˆ°<strong>è¡ŒåŠ¨æ“ä½œï¼ˆActionsï¼‰</strong>æ—¶æ‰è§¦å‘æ‰§è¡Œ</li></ul><p><strong>æ€¥åˆ‡è®¡ç®—ï¼ˆEager Evaluationï¼‰</strong>ï¼š</p><ul><li>ä¼ ç»Ÿç¼–ç¨‹æˆ–æŸäº›æ•°æ®å¤„ç†æ¡†æ¶ï¼ˆå¦‚Scalaé›†åˆçš„æŸäº›æ“ä½œï¼‰æ˜¯æ€¥åˆ‡è®¡ç®—çš„</li><li>å½“ä½ è°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒä¼šç«‹å³æ‰§è¡Œå¹¶è¿”å›ç»“æœ</li><li>ä¾‹å¦‚ï¼Œåœ¨Scalaä¸­<code>List(1,2,3).map(_ * 2)</code>ä¼šç«‹å³è®¡ç®—å¹¶è¿”å›<code>List(2,4,6)</code></li></ul><p><strong>å¯¹æ¯”ç¤ºä¾‹ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ€¥åˆ‡è®¡ç®— - ä¼ ç»ŸJavaé›†åˆ</span></span><br><span class="line">List&lt;Integer&gt; numbers = Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>);</span><br><span class="line">List&lt;Integer&gt; doubled = numbers.stream()</span><br><span class="line">    .map(x -&gt; x * <span class="number">2</span>)     <span class="comment">// ç«‹å³æ‰§è¡Œ</span></span><br><span class="line">    .filter(x -&gt; x &gt; <span class="number">5</span>)  <span class="comment">// ç«‹å³æ‰§è¡Œ</span></span><br><span class="line">    .collect(Collectors.toList()); <span class="comment">// ç«‹å³è¿”å›ç»“æœ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‡’æƒ°è®¡ç®— - Spark RDD</span></span><br><span class="line">JavaRDD&lt;Integer&gt; numbersRDD = sc.parallelize(Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>));</span><br><span class="line">JavaRDD&lt;Integer&gt; transformedRDD = numbersRDD</span><br><span class="line">    .map(x -&gt; x * <span class="number">2</span>)     <span class="comment">// ä»…è®°å½•æ“ä½œï¼Œä¸æ‰§è¡Œ</span></span><br><span class="line">    .filter(x -&gt; x &gt; <span class="number">5</span>); <span class="comment">// ä»…è®°å½•æ“ä½œï¼Œä¸æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">// æ­¤æ—¶è¿˜æ²¡æœ‰ä»»ä½•å®é™…è®¡ç®—å‘ç”Ÿï¼</span></span><br><span class="line"></span><br><span class="line">List&lt;Integer&gt; result = transformedRDD.collect(); <span class="comment">// è¿™é‡Œæ‰å¼€å§‹çœŸæ­£è®¡ç®—</span></span><br></pre></td></tr></table></figure><h4 id="1-5-2-ä¸ºä»€ä¹ˆSparkè¦é‡‡ç”¨æ‡’æƒ°è®¡ç®—ï¼Ÿ"><a href="#1-5-2-ä¸ºä»€ä¹ˆSparkè¦é‡‡ç”¨æ‡’æƒ°è®¡ç®—ï¼Ÿ" class="headerlink" title="1.5.2 ä¸ºä»€ä¹ˆSparkè¦é‡‡ç”¨æ‡’æƒ°è®¡ç®—ï¼Ÿ"></a>1.5.2 ä¸ºä»€ä¹ˆSparkè¦é‡‡ç”¨æ‡’æƒ°è®¡ç®—ï¼Ÿ</h4><p>è¿™ç§è®¾è®¡å¸¦æ¥äº†å‡ ä¸ªå…³é”®ä¼˜åŠ¿ï¼Œå°¤å…¶é€‚åˆå¤§è§„æ¨¡åˆ†å¸ƒå¼æ•°æ®å¤„ç†ï¼š</p><p><strong>1. ä¼˜åŒ–æ‰§è¡Œè®¡åˆ’ï¼ˆOptimizationï¼‰</strong></p><p>æ ¸å¿ƒä¼˜åŠ¿ï¼å› ä¸ºSparkåœ¨é‡åˆ°Actionä¹‹å‰â€çœ‹â€åˆ°äº†æ‰€æœ‰éœ€è¦æ‰§è¡Œçš„Transformationæ“ä½œï¼Œå®ƒå°±æ‹¥æœ‰äº†å…¨å±€è§†å›¾ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‡’æƒ°è®¡ç®—çš„ä¼˜åŒ–ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LazyEvaluationOptimizer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demonstrateOptimizations</span><span class="params">()</span> &#123;</span><br><span class="line">        JavaRDD&lt;String&gt; textRDD = sc.textFile(<span class="string">&quot;large_file.txt&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å®šä¹‰ä¸€ç³»åˆ—è½¬æ¢æ“ä½œï¼ˆå…¨éƒ¨æ˜¯æ‡’æƒ°çš„ï¼‰</span></span><br><span class="line">        JavaRDD&lt;String&gt; result = textRDD</span><br><span class="line">            .filter(line -&gt; line.contains(<span class="string">&quot;ERROR&quot;</span>))      <span class="comment">// è¿‡æ»¤æ“ä½œ</span></span><br><span class="line">            .map(line -&gt; line.toUpperCase())             <span class="comment">// è½¬æ¢æ“ä½œ</span></span><br><span class="line">            .filter(line -&gt; line.length() &gt; <span class="number">50</span>)          <span class="comment">// å†æ¬¡è¿‡æ»¤</span></span><br><span class="line">            .map(line -&gt; line.substring(<span class="number">0</span>, <span class="number">100</span>));        <span class="comment">// æˆªå–æ“ä½œ</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åªæœ‰åœ¨è°ƒç”¨Actionæ—¶ï¼ŒSparkæ‰å¼€å§‹ä¼˜åŒ–å’Œæ‰§è¡Œ</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> result.count();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Sparkçš„ä¼˜åŒ–ç­–ç•¥ï¼š</span></span><br><span class="line">        <span class="comment">// 1. æµæ°´çº¿åŒ–ï¼šå°†æ‰€æœ‰mapå’Œfilteræ“ä½œåˆå¹¶ä¸ºå•ä¸ªTaskæ‰§è¡Œ</span></span><br><span class="line">        <span class="comment">// 2. è°“è¯ä¸‹æ¨ï¼šå¦‚æœæ•°æ®æºæ”¯æŒï¼Œå°†filterä¸‹æ¨åˆ°è¯»å–å±‚</span></span><br><span class="line">        <span class="comment">// 3. å‡å°‘ä¸­é—´ç»“æœï¼šä¸éœ€è¦ç‰©åŒ–æ¯ä¸ªä¸­é—´RDD</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Sparkçš„DAGSchedulerå¯ä»¥åˆ©ç”¨å…¨å±€è§†å›¾è¿›è¡Œå¤æ‚ä¼˜åŒ–ï¼š</strong></p><ul><li><strong>æµæ°´çº¿åŒ–ï¼ˆPipeliningï¼‰</strong>ï¼šå°†å¤šä¸ªå¯ä»¥åœ¨åŒä¸€ä¸ªæ•°æ®åˆ†åŒºä¸Šè¿ç»­æ‰§è¡Œçš„è½¬æ¢æ“ä½œåˆå¹¶æˆä¸€ä¸ªä»»åŠ¡</li><li><strong>è°“è¯ä¸‹æ¨ï¼ˆPredicate Pushdownï¼‰</strong>ï¼šå°†filteræ“ä½œä¸‹æ¨åˆ°æ•°æ®æºå±‚ï¼Œç›´æ¥è¿‡æ»¤æ‰ä¸éœ€è¦çš„æ•°æ®</li><li><strong>å‡å°‘Shuffle</strong>ï¼šåˆ†ææ•´ä¸ªDAGåï¼Œè¯†åˆ«å¹¶åˆå¹¶å¯ä»¥å‡å°‘Shuffleçš„æ“ä½œ</li></ul><p><strong>2. å‡å°‘ä¸å¿…è¦çš„è®¡ç®—ï¼ˆReduced Computationï¼‰</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æŒ‰éœ€è®¡ç®—ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OnDemandComputation</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demonstrateOnDemandComputation</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// å‡è®¾æœ‰ä¸€ä¸ªéå¸¸å¤§çš„æ•°æ®é›†</span></span><br><span class="line">        JavaRDD&lt;String&gt; massiveDataset = sc.textFile(<span class="string">&quot;10TB_dataset.txt&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å®šä¹‰å¤æ‚çš„è½¬æ¢é“¾</span></span><br><span class="line">        JavaRDD&lt;String&gt; processedData = massiveDataset</span><br><span class="line">            .filter(line -&gt; line.contains(<span class="string">&quot;CRITICAL&quot;</span>))</span><br><span class="line">            .map(<span class="built_in">this</span>::expensiveProcessing)           <span class="comment">// æ˜‚è´µçš„å¤„ç†æ“ä½œ</span></span><br><span class="line">            .filter(line -&gt; line.startsWith(<span class="string">&quot;ALERT&quot;</span>))</span><br><span class="line">            .map(<span class="built_in">this</span>::anotherExpensiveOperation);    <span class="comment">// å¦ä¸€ä¸ªæ˜‚è´µæ“ä½œ</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åœºæ™¯1ï¼šåªéœ€è¦ç¬¬ä¸€ä¸ªç»“æœ</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">firstResult</span> <span class="operator">=</span> processedData.first();</span><br><span class="line">        <span class="comment">// Sparkæ™ºèƒ½ï¼šåªè®¡ç®—ç¬¬ä¸€ä¸ªåˆ†åŒºï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„ç»“æœå°±åœæ­¢</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åœºæ™¯2ï¼šåªéœ€è¦å‰10ä¸ªç»“æœ</span></span><br><span class="line">        List&lt;String&gt; top10 = processedData.take(<span class="number">10</span>);</span><br><span class="line">        <span class="comment">// Sparkæ™ºèƒ½ï¼šåªè®¡ç®—å¿…è¦çš„åˆ†åŒºï¼Œæ‰¾åˆ°10ä¸ªç»“æœå°±åœæ­¢</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åœºæ™¯3ï¼šéœ€è¦å…¨éƒ¨ç»“æœ</span></span><br><span class="line">        List&lt;String&gt; allResults = processedData.collect();</span><br><span class="line">        <span class="comment">// è¿™æ—¶æ‰ä¼šè®¡ç®—æ‰€æœ‰åˆ†åŒº</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">expensiveProcessing</span><span class="params">(String input)</span> &#123;</span><br><span class="line">        <span class="comment">// æ¨¡æ‹Ÿæ˜‚è´µçš„å¤„ç†æ“ä½œ</span></span><br><span class="line">        <span class="keyword">return</span> input.toUpperCase() + <span class="string">&quot;_PROCESSED&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">anotherExpensiveOperation</span><span class="params">(String input)</span> &#123;</span><br><span class="line">        <span class="comment">// æ¨¡æ‹Ÿå¦ä¸€ä¸ªæ˜‚è´µæ“ä½œ</span></span><br><span class="line">        <span class="keyword">return</span> input + <span class="string">&quot;_FINAL&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>3. èŠ‚çœå†…å­˜å’Œå­˜å‚¨ï¼ˆMemory&#x2F;Storage Efficiencyï¼‰</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å†…å­˜æ•ˆç‡ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemoryEfficiency</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demonstrateMemoryEfficiency</span><span class="params">()</span> &#123;</span><br><span class="line">        JavaRDD&lt;String&gt; data = sc.textFile(<span class="string">&quot;input.txt&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å®šä¹‰é•¿è½¬æ¢é“¾ï¼ˆå…¨éƒ¨æ‡’æƒ°ï¼‰</span></span><br><span class="line">        JavaRDD&lt;String&gt; step1 = data.map(line -&gt; processStep1(line));</span><br><span class="line">        JavaRDD&lt;String&gt; step2 = step1.filter(line -&gt; line.length() &gt; <span class="number">10</span>);</span><br><span class="line">        JavaRDD&lt;String&gt; step3 = step2.map(line -&gt; processStep2(line));</span><br><span class="line">        JavaRDD&lt;String&gt; step4 = step3.filter(line -&gt; line.contains(<span class="string">&quot;important&quot;</span>));</span><br><span class="line">        JavaRDD&lt;String&gt; finalResult = step4.map(line -&gt; processStep3(line));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å…³é”®ç‚¹ï¼šè¿™äº›ä¸­é—´RDDï¼ˆstep1-step4ï¼‰ä¸ä¼šçœŸçš„å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼</span></span><br><span class="line">        <span class="comment">// å®ƒä»¬åªæ˜¯åŒ…å«Lineageä¿¡æ¯çš„å¯¹è±¡ï¼Œå®é™…æ•°æ®åœ¨Actionæ—¶æ‰è®¡ç®—</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åªæœ‰åœ¨Actionè§¦å‘æ—¶ï¼Œæ•°æ®æ‰æµå¼å¤„ç†ï¼Œæ— éœ€å­˜å‚¨ä¸­é—´ç»“æœ</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> finalResult.count();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¯¹æ¯”ï¼šå¦‚æœæ˜¯æ€¥åˆ‡è®¡ç®—ï¼Œæ¯ä¸ªstepéƒ½ä¼šäº§ç”Ÿå®Œæ•´çš„ä¸­é—´æ•°æ®é›†</span></span><br><span class="line">        <span class="comment">// è¿™ä¼šæ¶ˆè€—5å€çš„å†…å­˜ï¼</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>4. å®¹é”™æ€§ï¼ˆFault Toleranceï¼‰çš„å¤©ç„¶æ”¯æŒ</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®¹é”™æœºåˆ¶ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FaultToleranceSupport</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demonstrateFaultTolerance</span><span class="params">()</span> &#123;</span><br><span class="line">        JavaRDD&lt;String&gt; rawData = sc.textFile(<span class="string">&quot;hdfs://input/data.txt&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ„å»ºå¤æ‚çš„Lineageé“¾</span></span><br><span class="line">        JavaRDD&lt;String&gt; processed = rawData</span><br><span class="line">            .filter(line -&gt; line.length() &gt; <span class="number">0</span>)          <span class="comment">// Transformation 1</span></span><br><span class="line">            .map(line -&gt; line.trim())                   <span class="comment">// Transformation 2</span></span><br><span class="line">            .filter(line -&gt; !line.startsWith(<span class="string">&quot;#&quot;</span>))     <span class="comment">// Transformation 3</span></span><br><span class="line">            .map(line -&gt; processLine(line))             <span class="comment">// Transformation 4</span></span><br><span class="line">            .filter(line -&gt; isValid(line));            <span class="comment">// Transformation 5</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Lineageè®°å½•ï¼šprocessedä¾èµ–äºä¸€ç³»åˆ—è½¬æ¢æ“ä½œå’Œæœ€ç»ˆçš„æ•°æ®æº</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å½“æŸä¸ªèŠ‚ç‚¹æ•…éšœï¼ŒæŸä¸ªåˆ†åŒºæ•°æ®ä¸¢å¤±æ—¶ï¼š</span></span><br><span class="line">        <span class="comment">// Sparkå¯ä»¥åˆ©ç”¨Lineageä¿¡æ¯ï¼Œä»…é‡æ–°è®¡ç®—ä¸¢å¤±çš„åˆ†åŒº</span></span><br><span class="line">        <span class="comment">// é‡è®¡ç®—è·¯å¾„ï¼šä»HDFSè¯»å–å¯¹åº”åˆ†åŒº -&gt; åº”ç”¨Transformation 1-5</span></span><br><span class="line">        </span><br><span class="line">        processed.saveAsTextFile(<span class="string">&quot;hdfs://output/result&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1-5-3-æ‡’æƒ°è®¡ç®—å·¥ä½œåŸç†ï¼šè¯¦ç»†ç¤ºä¾‹åˆ†æ"><a href="#1-5-3-æ‡’æƒ°è®¡ç®—å·¥ä½œåŸç†ï¼šè¯¦ç»†ç¤ºä¾‹åˆ†æ" class="headerlink" title="1.5.3 æ‡’æƒ°è®¡ç®—å·¥ä½œåŸç†ï¼šè¯¦ç»†ç¤ºä¾‹åˆ†æ"></a>1.5.3 æ‡’æƒ°è®¡ç®—å·¥ä½œåŸç†ï¼šè¯¦ç»†ç¤ºä¾‹åˆ†æ</h4><p>è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„ä¾‹å­æ¥ç†è§£æ‡’æƒ°è®¡ç®—çš„å·¥ä½œæµç¨‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LazyEvaluationWorkflow</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">completeExample</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 1. å®šä¹‰RDDï¼ˆæƒ°æ€§ï¼šåªè®°å½•æ¥æºï¼‰</span></span><br><span class="line">        JavaRDD&lt;String&gt; textRDD = sc.textFile(<span class="string">&quot;hdfs://path/to/largefile.txt&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Step 1: åˆ›å»ºtextRDD - æ— è®¡ç®—å‘ç”Ÿï¼Œåªè®°å½•æ•°æ®æº&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. è½¬æ¢æ“ä½œï¼ˆæƒ°æ€§ï¼šåªè®°å½•è½¬æ¢é€»è¾‘ï¼‰</span></span><br><span class="line">        JavaRDD&lt;String&gt; wordsRDD = textRDD.flatMap(line -&gt; </span><br><span class="line">            Arrays.asList(line.split(<span class="string">&quot; &quot;</span>)).iterator());</span><br><span class="line">        System.out.println(<span class="string">&quot;Step 2: åˆ›å»ºwordsRDD - æ— è®¡ç®—å‘ç”Ÿï¼Œåªè®°å½•flatMapæ“ä½œ&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        JavaRDD&lt;String&gt; filteredRDD = wordsRDD.filter(word -&gt; </span><br><span class="line">            word.startsWith(<span class="string">&quot;error&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;Step 3: åˆ›å»ºfilteredRDD - æ— è®¡ç®—å‘ç”Ÿï¼Œåªè®°å½•filteræ“ä½œ&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        JavaPairRDD&lt;String, Integer&gt; mappedRDD = filteredRDD.mapToPair(word -&gt; </span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(word, <span class="number">1</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;Step 4: åˆ›å»ºmappedRDD - æ— è®¡ç®—å‘ç”Ÿï¼Œåªè®°å½•mapToPairæ“ä½œ&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        JavaPairRDD&lt;String, Integer&gt; errorCountRDD = mappedRDD.reduceByKey((a, b) -&gt; a + b);</span><br><span class="line">        System.out.println(<span class="string">&quot;Step 5: åˆ›å»ºerrorCountRDD - æ— è®¡ç®—å‘ç”Ÿï¼Œåªè®°å½•reduceByKeyæ“ä½œ&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ­¤æ—¶çš„çŠ¶æ€ï¼š</span></span><br><span class="line">        printRDDLineage(errorCountRDD);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. è¡ŒåŠ¨æ“ä½œï¼ˆè§¦å‘è®¡ç®—ï¼ï¼‰</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Step 6: è°ƒç”¨collect() - å¼€å§‹çœŸæ­£çš„è®¡ç®—ï¼&quot;</span>);</span><br><span class="line">        List&lt;Tuple2&lt;String, Integer&gt;&gt; result = errorCountRDD.collect();</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;è®¡ç®—å®Œæˆï¼Œç»“æœ: &quot;</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">printRDDLineage</span><span class="params">(JavaPairRDD&lt;String, Integer&gt; rdd)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;=== RDD Lineage ä¿¡æ¯ ===&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;errorCountRDD ä¾èµ–é“¾ï¼š&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;  textRDD (HadoopRDD) &lt;- æ•°æ®æº&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;  -&gt; wordsRDD (FlatMappedRDD) &lt;- flatMapè½¬æ¢&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;  -&gt; filteredRDD (FilteredRDD) &lt;- filterè½¬æ¢&quot;</span>); </span><br><span class="line">        System.out.println(<span class="string">&quot;  -&gt; mappedRDD (MapPartitionsRDD) &lt;- mapToPairè½¬æ¢&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;  -&gt; errorCountRDD (ShuffledRDD) &lt;- reduceByKeyè½¬æ¢&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;æ­¤æ—¶åªæœ‰é€»è¾‘æ‰§è¡Œè®¡åˆ’ï¼Œæ²¡æœ‰å®é™…æ•°æ®ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1-5-4-æ‰§è¡Œæµç¨‹è¯¦è§£"><a href="#1-5-4-æ‰§è¡Œæµç¨‹è¯¦è§£" class="headerlink" title="1.5.4 æ‰§è¡Œæµç¨‹è¯¦è§£"></a>1.5.4 æ‰§è¡Œæµç¨‹è¯¦è§£</h4><p><strong>é˜¶æ®µ1ï¼šå®šä¹‰å’Œè½¬æ¢é˜¶æ®µï¼ˆtextFile åˆ° reduceByKeyï¼‰</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DAGæ„å»ºè¿‡ç¨‹çš„å†…éƒ¨æœºåˆ¶</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DAGBuildingProcess</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demonstrateDAGBuilding</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// å½“æ‰§è¡Œæ¯ä¸ªè½¬æ¢æ“ä½œæ—¶ï¼ŒSparkå†…éƒ¨çš„å·¥ä½œï¼š</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. textFileæ“ä½œ</span></span><br><span class="line">        JavaRDD&lt;String&gt; textRDD = sc.textFile(<span class="string">&quot;input.txt&quot;</span>);</span><br><span class="line">        <span class="comment">// å†…éƒ¨ï¼šåˆ›å»ºHadoopRDDå¯¹è±¡ï¼Œè®°å½•ï¼š</span></span><br><span class="line">        <span class="comment">// - æ•°æ®æºè·¯å¾„</span></span><br><span class="line">        <span class="comment">// - åˆ†åŒºç­–ç•¥ï¼ˆåŸºäºHDFSå—ï¼‰</span></span><br><span class="line">        <span class="comment">// - ä¾èµ–å…³ç³»ï¼šæ— ï¼ˆå¶å­èŠ‚ç‚¹ï¼‰</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. flatMapæ“ä½œ</span></span><br><span class="line">        JavaRDD&lt;String&gt; wordsRDD = textRDD.flatMap(line -&gt; </span><br><span class="line">            Arrays.asList(line.split(<span class="string">&quot; &quot;</span>)).iterator());</span><br><span class="line">        <span class="comment">// å†…éƒ¨ï¼šåˆ›å»ºFlatMappedRDDå¯¹è±¡ï¼Œè®°å½•ï¼š</span></span><br><span class="line">        <span class="comment">// - çˆ¶RDDï¼štextRDD</span></span><br><span class="line">        <span class="comment">// - è½¬æ¢å‡½æ•°ï¼šsplitå’Œiterator</span></span><br><span class="line">        <span class="comment">// - ä¾èµ–ç±»å‹ï¼šçª„ä¾èµ–ï¼ˆOneToOneDependencyï¼‰</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. filteræ“ä½œ</span></span><br><span class="line">        JavaRDD&lt;String&gt; filteredRDD = wordsRDD.filter(word -&gt; word.startsWith(<span class="string">&quot;error&quot;</span>));</span><br><span class="line">        <span class="comment">// å†…éƒ¨ï¼šåˆ›å»ºFilteredRDDå¯¹è±¡ï¼Œè®°å½•ï¼š</span></span><br><span class="line">        <span class="comment">// - çˆ¶RDDï¼šwordsRDD</span></span><br><span class="line">        <span class="comment">// - è¿‡æ»¤å‡½æ•°ï¼šstartsWithåˆ¤æ–­</span></span><br><span class="line">        <span class="comment">// - ä¾èµ–ç±»å‹ï¼šçª„ä¾èµ–</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. reduceByKeyæ“ä½œ</span></span><br><span class="line">        JavaPairRDD&lt;String, Integer&gt; countRDD = </span><br><span class="line">            filteredRDD.mapToPair(w -&gt; <span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(w, <span class="number">1</span>)).reduceByKey((a, b) -&gt; a + b);</span><br><span class="line">        <span class="comment">// å†…éƒ¨ï¼šåˆ›å»ºShuffledRDDå¯¹è±¡ï¼Œè®°å½•ï¼š</span></span><br><span class="line">        <span class="comment">// - çˆ¶RDDï¼šmappedRDD</span></span><br><span class="line">        <span class="comment">// - èšåˆå‡½æ•°ï¼šaddition</span></span><br><span class="line">        <span class="comment">// - ä¾èµ–ç±»å‹ï¼šå®½ä¾èµ–ï¼ˆShuffleDependencyï¼‰</span></span><br><span class="line">        <span class="comment">// - åˆ†åŒºå™¨ï¼šHashPartitioner</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ„å»ºçš„DAGå›¾ï¼š</span></span><br><span class="line">        System.out.println(<span class="string">&quot;DAGç»“æ„ï¼š&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;HadoopRDD -&gt; FlatMappedRDD -&gt; FilteredRDD -&gt; MappedRDD -&gt; ShuffledRDD&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;    |            |              |            |           |&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;  textFile    flatMap        filter    mapToPair   reduceByKey&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;                                                        |&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;                                             Stageåˆ†ç•Œç‚¹ï¼ˆShuffleï¼‰&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>é˜¶æ®µ2ï¼šActionè§¦å‘æ‰§è¡Œ</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Actionè§¦å‘çš„è¯¦ç»†æ‰§è¡Œè¿‡ç¨‹</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ActionTriggeredExecution</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demonstrateActionExecution</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// å½“è°ƒç”¨collect()æ—¶ï¼ŒSparkçš„æ‰§è¡Œæµç¨‹ï¼š</span></span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;=== Actionè§¦å‘ï¼šcollect() ===&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. DAGScheduleråˆ†æ</span></span><br><span class="line">        analyzeDAG();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. Stageåˆ’åˆ†</span></span><br><span class="line">        divideStages();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. ä»»åŠ¡ç”Ÿæˆ</span></span><br><span class="line">        generateTasks();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. ä»»åŠ¡è°ƒåº¦</span></span><br><span class="line">        scheduleTasks();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5. ä»»åŠ¡æ‰§è¡Œ</span></span><br><span class="line">        executeTasks();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 6. ç»“æœæ”¶é›†</span></span><br><span class="line">        collectResults();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">analyzeDAG</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;1. DAGScheduleråˆ†æï¼š&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - ä»collect()çš„ç›®æ ‡RDDå¼€å§‹&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - å›æº¯æ•´ä¸ªLineageé“¾&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - è¯†åˆ«ä¾èµ–å…³ç³»å’Œä¼˜åŒ–æœºä¼š&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// DAGSchedulerçš„ä¼˜åŒ–ï¼š</span></span><br><span class="line">        System.out.println(<span class="string">&quot;   ä¼˜åŒ–å‘ç°ï¼š&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - flatMap + filter + mapToPair å¯ä»¥æµæ°´çº¿æ‰§è¡Œ&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - reduceByKeyéœ€è¦å•ç‹¬Stageï¼ˆå®½ä¾èµ–ï¼‰&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">divideStages</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;2. Stageåˆ’åˆ†ï¼š&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   Stage 0: textFile -&gt; flatMap -&gt; filter -&gt; mapToPair&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;           è¾“å‡ºï¼šæŒ‰keyåˆ†åŒºçš„(word, 1)å¯¹&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   Stage 1: reduceByKey&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;           è¾“å…¥ï¼šä»Stage 0 Shuffleè¯»å–æ•°æ®&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;           è¾“å‡ºï¼š(word, count)ç»“æœ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">generateTasks</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;3. ä»»åŠ¡ç”Ÿæˆï¼š&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   Stage 0: æ ¹æ®è¾“å…¥åˆ†åŒºæ•°ç”ŸæˆShuffleMapTask&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;           å‡è®¾è¾“å…¥æœ‰4ä¸ªHDFSå—ï¼Œç”Ÿæˆ4ä¸ªTask&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   Stage 1: æ ¹æ®Shuffleåˆ†åŒºæ•°ç”ŸæˆResultTask&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;           å‡è®¾é»˜è®¤200ä¸ªåˆ†åŒºï¼Œç”Ÿæˆ200ä¸ªTask&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">scheduleTasks</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;4. ä»»åŠ¡è°ƒåº¦ï¼š&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   TaskSchedulerå°†Taskåˆ†å‘åˆ°Executor&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   è€ƒè™‘æ•°æ®æœ¬åœ°æ€§ï¼šä¼˜å…ˆåˆ†é…åˆ°æ•°æ®æ‰€åœ¨èŠ‚ç‚¹&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   Stage 0å¿…é¡»å…ˆæ‰§è¡Œå®Œï¼ŒStage 1æ‰èƒ½å¼€å§‹&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">executeTasks</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;5. ä»»åŠ¡æ‰§è¡Œï¼š&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   Stage 0æ‰§è¡Œï¼š&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - è¯»å–HDFSæ–‡ä»¶å—&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - æµæ°´çº¿æ‰§è¡Œï¼šsplit -&gt; filter -&gt; mapToPair&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - æŒ‰key hashåˆ†åŒºï¼Œå†™å…¥æœ¬åœ°ç£ç›˜ï¼ˆShuffle Writeï¼‰&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   Stage 1æ‰§è¡Œï¼š&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - ä»å¤šä¸ªèŠ‚ç‚¹æ‹‰å–æ•°æ®ï¼ˆShuffle Readï¼‰&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - æŒ‰keyèšåˆï¼šreduceByKey&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - ç”Ÿæˆæœ€ç»ˆç»“æœ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">collectResults</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;6. ç»“æœæ”¶é›†ï¼š&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   æ‰€æœ‰Stage 1çš„Taskç»“æœå‘é€å›Driver&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   Driveræ”¶é›†æ‰€æœ‰ç»“æœå¹¶è¿”å›ç»™ç”¨æˆ·&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1-5-5-å…³é”®è¦ç‚¹æ€»ç»“"><a href="#1-5-5-å…³é”®è¦ç‚¹æ€»ç»“" class="headerlink" title="1.5.5 å…³é”®è¦ç‚¹æ€»ç»“"></a>1.5.5 å…³é”®è¦ç‚¹æ€»ç»“</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KeyTakeaways</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">summarizeKeyPoints</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;=== RDDæ‡’æƒ°è®¡ç®—å…³é”®è¦ç‚¹ ===&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. Transformation = è®¡åˆ’ï¼ŒAction = æ‰§è¡Œå‘½ä»¤</span></span><br><span class="line">        System.out.println(<span class="string">&quot;1. Transformation = è®¡åˆ’ï¼ŒAction = æ‰§è¡Œå‘½ä»¤&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - è½¬æ¢æ“ä½œåªæ˜¯å®šä¹‰è®¡ç®—é€»è¾‘ï¼ˆæ„å»ºLineage/DAGï¼‰&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - è¡ŒåŠ¨æ“ä½œæ‰æ˜¯çœŸæ­£è§¦å‘è®¡ç®—å¼€å§‹çš„ä¿¡å·&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. å…¨å±€ä¼˜åŒ–</span></span><br><span class="line">        System.out.println(<span class="string">&quot;2. å…¨å±€ä¼˜åŒ–&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - æ‡’æƒ°ä½¿å¾—Sparkå¯ä»¥åœ¨æ‰§è¡Œå‰çœ‹åˆ°æ‰€æœ‰æ“ä½œ&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - è¿›è¡ŒDAGçº§åˆ«çš„ä¼˜åŒ–ï¼ˆæµæ°´çº¿ã€ä¸‹æ¨ã€å‡å°‘Shuffleï¼‰&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. æŒ‰éœ€è®¡ç®—</span></span><br><span class="line">        System.out.println(<span class="string">&quot;3. æŒ‰éœ€è®¡ç®—&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - Sparkåªè®¡ç®—ActionçœŸæ­£éœ€è¦çš„æ•°æ®&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - å¯¹äºfirst, take, lookupç­‰æ“ä½œç‰¹åˆ«é«˜æ•ˆ&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. èµ„æºæ•ˆç‡</span></span><br><span class="line">        System.out.println(<span class="string">&quot;4. èµ„æºæ•ˆç‡&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - é¿å…å­˜å‚¨ä¸å¿…è¦çš„ä¸­é—´ç»“æœ&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - èŠ‚çœå†…å­˜å’ŒI/O&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5. å®¹é”™åŸºçŸ³</span></span><br><span class="line">        System.out.println(<span class="string">&quot;5. å®¹é”™åŸºçŸ³&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - Lineageæ˜¯RDDå®¹é”™çš„åŸºç¡€&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - æ‡’æƒ°è®¡ç®—ä½¿å¾—è®°å½•Lineageå˜å¾—å¿…è¦å’Œè‡ªç„¶&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 6. ç‰©ç†æ‰§è¡Œåˆ’åˆ†</span></span><br><span class="line">        System.out.println(<span class="string">&quot;6. ç‰©ç†æ‰§è¡Œåˆ’åˆ†&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - æœ€ç»ˆçš„ç‰©ç†æ‰§è¡Œè¢«åˆ’åˆ†ä¸ºStage&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - Stageçš„è¾¹ç•Œæ˜¯å®½ä¾èµ–ï¼ˆShuffleï¼‰&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - åŒä¸€ä¸ªStageå†…çš„çª„ä¾èµ–æ“ä½œä¼šè¢«åˆå¹¶ï¼ˆæµæ°´çº¿ï¼‰æ‰§è¡Œ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1-5-6-å¯¹å¼€å‘è€…çš„å®é™…å½±å“ä¸æœ€ä½³å®è·µ"><a href="#1-5-6-å¯¹å¼€å‘è€…çš„å®é™…å½±å“ä¸æœ€ä½³å®è·µ" class="headerlink" title="1.5.6 å¯¹å¼€å‘è€…çš„å®é™…å½±å“ä¸æœ€ä½³å®è·µ"></a>1.5.6 å¯¹å¼€å‘è€…çš„å®é™…å½±å“ä¸æœ€ä½³å®è·µ</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeveloperGuidelines</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">practicalGuidelines</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;=== å¼€å‘è€…å®è·µæŒ‡å— ===&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. ç†è§£æ‰§è¡Œæ—¶æœº</span></span><br><span class="line">        understandExecutionTiming();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. åˆ©ç”¨æŒä¹…åŒ–</span></span><br><span class="line">        utilizePersistence();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. å…³æ³¨Actions</span></span><br><span class="line">        focusOnActions();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. åˆ©ç”¨æƒ°æ€§ä¼˜åŒ–</span></span><br><span class="line">        leverageLazyOptimization();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">understandExecutionTiming</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;1. ç†è§£æ‰§è¡Œæ—¶æœºï¼š&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¸¸è§è¯¯åŒº</span></span><br><span class="line">        JavaRDD&lt;String&gt; rdd = sc.textFile(<span class="string">&quot;large_file.txt&quot;</span>);</span><br><span class="line">        JavaRDD&lt;String&gt; processed = rdd.filter(line -&gt; line.contains(<span class="string">&quot;ERROR&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;è¯¯åŒºï¼šè®¤ä¸ºè¿™é‡Œå·²ç»å¤„ç†å®Œæ•°æ®&quot;</span>);</span><br><span class="line">        <span class="comment">// å®é™…ï¼šè¿™é‡Œåªæ˜¯å®šä¹‰äº†å¤„ç†é€»è¾‘ï¼Œæ²¡æœ‰ä»»ä½•è®¡ç®—å‘ç”Ÿ</span></span><br><span class="line">        </span><br><span class="line">        <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> processed.count(); <span class="comment">// è¿™é‡Œæ‰å¼€å§‹è®¡ç®—</span></span><br><span class="line">        System.out.println(<span class="string">&quot;æ­£ç¡®ï¼šActionè§¦å‘æ—¶æ‰å¼€å§‹çœŸæ­£è®¡ç®—&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">utilizePersistence</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;2. åˆ©ç”¨æŒä¹…åŒ–ï¼ˆPersist/Cacheï¼‰ï¼š&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        JavaRDD&lt;String&gt; baseRDD = sc.textFile(<span class="string">&quot;input.txt&quot;</span>)</span><br><span class="line">            .filter(line -&gt; line.length() &gt; <span class="number">100</span>)</span><br><span class="line">            .map(line -&gt; expensiveProcessing(line));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é”™è¯¯åšæ³•ï¼š</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">count1</span> <span class="operator">=</span> baseRDD.count();        <span class="comment">// è®¡ç®—ä¸€æ¬¡</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">count2</span> <span class="operator">=</span> baseRDD.filter(line -&gt; line.contains(<span class="string">&quot;ERROR&quot;</span>)).count(); <span class="comment">// é‡æ–°è®¡ç®—</span></span><br><span class="line">        <span class="comment">// é—®é¢˜ï¼šbaseRDDè¢«è®¡ç®—äº†ä¸¤æ¬¡ï¼</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ­£ç¡®åšæ³•ï¼š</span></span><br><span class="line">        baseRDD.cache(); <span class="comment">// ç¼“å­˜ä¸­é—´ç»“æœ</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">correctCount1</span> <span class="operator">=</span> baseRDD.count();        <span class="comment">// ç¬¬ä¸€æ¬¡è®¡ç®—å¹¶ç¼“å­˜</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">correctCount2</span> <span class="operator">=</span> baseRDD.filter(line -&gt; line.contains(<span class="string">&quot;ERROR&quot;</span>)).count(); <span class="comment">// ä½¿ç”¨ç¼“å­˜</span></span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;å…³é”®ï¼šå¦‚æœæŸä¸ªRDDä¼šè¢«å¤šä¸ªActionä½¿ç”¨ï¼Œå¿…é¡»cache()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">focusOnActions</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;3. å…³æ³¨Actionsï¼š&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - æ€§èƒ½é—®é¢˜å’Œèµ„æºæ¶ˆè€—å¾€å¾€åœ¨Actionè§¦å‘åæ‰æ˜¾ç°&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - éœ€è¦ç›‘æ§Actionæ‰§è¡Œè¿‡ç¨‹&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - ä½¿ç”¨Spark UIæŸ¥çœ‹Jobæ‰§è¡Œæƒ…å†µ&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ€§èƒ½ç›‘æ§ç¤ºä¾‹</span></span><br><span class="line">        JavaRDD&lt;String&gt; rdd = sc.textFile(<span class="string">&quot;input.txt&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        List&lt;String&gt; results = rdd.filter(line -&gt; line.contains(<span class="string">&quot;CRITICAL&quot;</span>))</span><br><span class="line">                                 .collect(); <span class="comment">// Actionï¼šè¿™é‡Œå¼€å§‹ç›‘æ§</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;Actionæ‰§è¡Œæ—¶é—´: &quot;</span> + (endTime - startTime) + <span class="string">&quot;ms&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">leverageLazyOptimization</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;4. åˆ©ç”¨æƒ°æ€§ä¼˜åŒ–ï¼š&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - æ”¾å¿ƒåœ°ç¼–å†™å¤æ‚çš„è½¬æ¢é“¾&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - Sparkçš„ä¼˜åŒ–å™¨ä¼šå°½åŠ›ä¼˜åŒ–å®ƒ&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ç¤ºä¾‹ï¼šå¤æ‚è½¬æ¢é“¾</span></span><br><span class="line">        JavaRDD&lt;String&gt; optimizedChain = sc.textFile(<span class="string">&quot;input.txt&quot;</span>)</span><br><span class="line">            .filter(line -&gt; !line.isEmpty())           <span class="comment">// è¿‡æ»¤1</span></span><br><span class="line">            .map(line -&gt; line.trim())                   <span class="comment">// è½¬æ¢1</span></span><br><span class="line">            .filter(line -&gt; !line.startsWith(<span class="string">&quot;#&quot;</span>))     <span class="comment">// è¿‡æ»¤2</span></span><br><span class="line">            .map(line -&gt; line.toLowerCase())            <span class="comment">// è½¬æ¢2</span></span><br><span class="line">            .filter(line -&gt; line.contains(<span class="string">&quot;important&quot;</span>)) <span class="comment">// è¿‡æ»¤3</span></span><br><span class="line">            .map(line -&gt; processLine(line));            <span class="comment">// è½¬æ¢3</span></span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;Sparkä¼šè‡ªåŠ¨ä¼˜åŒ–è¿™ä¸ªé“¾æ¡ï¼Œåˆå¹¶ç›¸é‚»æ“ä½œ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">expensiveProcessing</span><span class="params">(String input)</span> &#123;</span><br><span class="line">        <span class="comment">// æ¨¡æ‹Ÿæ˜‚è´µæ“ä½œ</span></span><br><span class="line">        <span class="keyword">try</span> &#123; Thread.sleep(<span class="number">10</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125;</span><br><span class="line">        <span class="keyword">return</span> input.toUpperCase();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">processLine</span><span class="params">(String line)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> line + <span class="string">&quot;_PROCESSED&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ€»ç»“ï¼š</strong></p><p>RDDçš„æ‡’æƒ°è®¡ç®—æœºåˆ¶æ˜¯Sparkå®ç°é«˜æ•ˆã€å®¹é”™çš„å¤§è§„æ¨¡åˆ†å¸ƒå¼æ•°æ®å¤„ç†çš„æ ¸å¿ƒæ™ºæ…§ã€‚å®ƒå°†æ˜‚è´µçš„è®¡ç®—æ¨è¿Ÿåˆ°æœ€åï¼Œå¹¶åˆ©ç”¨è¿™æ®µæ—¶é—´çª—å£è¿›è¡Œå…¨å±€ä¼˜åŒ–ï¼Œæå¤§åœ°æå‡äº†å¤„ç†èƒ½åŠ›å’Œèµ„æºåˆ©ç”¨ç‡ã€‚ç†è§£è¿™ä¸€æœºåˆ¶å¯¹äºç¼–å†™é«˜æ•ˆçš„Sparkåº”ç”¨ç¨‹åºè‡³å…³é‡è¦ã€‚</p><pre><code>    // 2. è®¡ç®—åˆ†åŒºæ•°æ®    Iterator&lt;?&gt; data = rdd.iterator(partition, context);        // 3. æ‰§è¡ŒShuffle Write    ShuffleWriter writer = task.shuffleDep.shuffleWriterFor(        task.partitionId, context);        while (data.hasNext()) &#123;        writer.write(data.next());    &#125;        // 4. è¿”å›Shuffle Writeçš„ç»“æœçŠ¶æ€    return writer.stop(true);&#125;</code></pre><p>}</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### 1.6 æ•°æ®æœ¬åœ°æ€§åŸç†æ·±åº¦è§£æ</span><br><span class="line"></span><br><span class="line">æ•°æ®æœ¬åœ°æ€§æ˜¯Sparkæ€§èƒ½ä¼˜åŒ–çš„å…³é”®å› ç´ ï¼Œç†è§£å…¶å·¥ä½œåŸç†æœ‰åŠ©äºç¼–å†™é«˜æ•ˆçš„Sparkåº”ç”¨ã€‚</span><br><span class="line"></span><br><span class="line">#### 1.6.1 æ•°æ®æœ¬åœ°æ€§çš„å±‚æ¬¡ç»“æ„</span><br><span class="line"></span><br><span class="line">**æœ¬åœ°æ€§çº§åˆ«çš„è¯¦ç»†å®šä¹‰ï¼š**</span><br><span class="line">```java</span><br><span class="line">// æ•°æ®æœ¬åœ°æ€§çº§åˆ«æšä¸¾</span><br><span class="line">public enum TaskLocality &#123;</span><br><span class="line">    PROCESS_LOCAL(&quot;PROCESS_LOCAL&quot;, 0) &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public boolean isAllowed(TaskSetManager taskSet, long currentTime) &#123;</span><br><span class="line">            // è¿›ç¨‹æœ¬åœ°ï¼šæ•°æ®åœ¨åŒä¸€JVMè¿›ç¨‹ä¸­</span><br><span class="line">            return taskSet.getAllowedLocalityLevel(currentTime).ordinal() &gt;= ordinal();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    NODE_LOCAL(&quot;NODE_LOCAL&quot;, 1) &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public boolean isAllowed(TaskSetManager taskSet, long currentTime) &#123;</span><br><span class="line">            // èŠ‚ç‚¹æœ¬åœ°ï¼šæ•°æ®åœ¨åŒä¸€ç‰©ç†èŠ‚ç‚¹ä¸Š</span><br><span class="line">            return taskSet.getAllowedLocalityLevel(currentTime).ordinal() &gt;= ordinal();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    RACK_LOCAL(&quot;RACK_LOCAL&quot;, 2) &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public boolean isAllowed(TaskSetManager taskSet, long currentTime) &#123;</span><br><span class="line">            // æœºæ¶æœ¬åœ°ï¼šæ•°æ®åœ¨åŒä¸€æœºæ¶å†…</span><br><span class="line">            return taskSet.getAllowedLocalityLevel(currentTime).ordinal() &gt;= ordinal();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    ANY(&quot;ANY&quot;, 3) &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public boolean isAllowed(TaskSetManager taskSet, long currentTime) &#123;</span><br><span class="line">            // ä»»æ„ä½ç½®ï¼šå¯ä»¥åœ¨ä»»ä½•åœ°æ–¹æ‰§è¡Œ</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    public final String toString;</span><br><span class="line">    public final int id;</span><br><span class="line">    </span><br><span class="line">    TaskLocality(String toString, int id) &#123;</span><br><span class="line">        this.toString = toString;</span><br><span class="line">        this.id = id;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public abstract boolean isAllowed(TaskSetManager taskSet, long currentTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æœ¬åœ°æ€§æ„ŸçŸ¥çš„ä»»åŠ¡è°ƒåº¦ç®—æ³•ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æœ¬åœ°æ€§æ„ŸçŸ¥è°ƒåº¦å™¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LocalityAwareTaskScheduler</span> &#123;</span><br><span class="line">    <span class="comment">// æœ¬åœ°æ€§ç­‰å¾…æ—¶é—´é…ç½®</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;TaskLocality, Long&gt; localityWaitMap = Map.of(</span><br><span class="line">        TaskLocality.PROCESS_LOCAL, <span class="number">3000L</span>,  <span class="comment">// 3ç§’</span></span><br><span class="line">        TaskLocality.NODE_LOCAL, <span class="number">3000L</span>,     <span class="comment">// 3ç§’</span></span><br><span class="line">        TaskLocality.RACK_LOCAL, <span class="number">3000L</span>,     <span class="comment">// 3ç§’</span></span><br><span class="line">        TaskLocality.ANY, <span class="number">0L</span>                <span class="comment">// ç«‹å³æ‰§è¡Œ</span></span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Option&lt;TaskDescription&gt; <span class="title function_">resourceOffer</span><span class="params">(</span></span><br><span class="line"><span class="params">            String executorId, String host, <span class="type">int</span> maxCores)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. å°è¯•PROCESS_LOCALçº§åˆ«</span></span><br><span class="line">        Option&lt;TaskDescription&gt; processLocalTask = </span><br><span class="line">            findTask(TaskLocality.PROCESS_LOCAL, executorId, host, maxCores);</span><br><span class="line">        <span class="keyword">if</span> (processLocalTask.isDefined()) &#123;</span><br><span class="line">            <span class="keyword">return</span> processLocalTask;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. å°è¯•NODE_LOCALçº§åˆ«</span></span><br><span class="line">        Option&lt;TaskDescription&gt; nodeLocalTask = </span><br><span class="line">            findTask(TaskLocality.NODE_LOCAL, executorId, host, maxCores);</span><br><span class="line">        <span class="keyword">if</span> (nodeLocalTask.isDefined()) &#123;</span><br><span class="line">            <span class="keyword">return</span> nodeLocalTask;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. æ£€æŸ¥æ˜¯å¦å¯ä»¥é™çº§åˆ°RACK_LOCAL</span></span><br><span class="line">        <span class="keyword">if</span> (canExecuteAtLocality(TaskLocality.RACK_LOCAL)) &#123;</span><br><span class="line">            Option&lt;TaskDescription&gt; rackLocalTask = </span><br><span class="line">                findTask(TaskLocality.RACK_LOCAL, executorId, host, maxCores);</span><br><span class="line">            <span class="keyword">if</span> (rackLocalTask.isDefined()) &#123;</span><br><span class="line">                <span class="keyword">return</span> rackLocalTask;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. æœ€åè€ƒè™‘ANYçº§åˆ«</span></span><br><span class="line">        <span class="keyword">if</span> (canExecuteAtLocality(TaskLocality.ANY)) &#123;</span><br><span class="line">            <span class="keyword">return</span> findTask(TaskLocality.ANY, executorId, host, maxCores);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> Option.empty();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">canExecuteAtLocality</span><span class="params">(TaskLocality locality)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">currentTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">long</span> <span class="variable">waitTime</span> <span class="operator">=</span> localityWaitMap.get(locality);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ£€æŸ¥æ˜¯å¦å·²ç­‰å¾…è¶³å¤Ÿé•¿æ—¶é—´å¯ä»¥é™çº§æ‰§è¡Œ</span></span><br><span class="line">        <span class="keyword">return</span> (currentTime - lastLaunchTime) &gt;= waitTime;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1-6-2-æ•°æ®æœ¬åœ°æ€§çš„ä¼˜åŒ–ç­–ç•¥"><a href="#1-6-2-æ•°æ®æœ¬åœ°æ€§çš„ä¼˜åŒ–ç­–ç•¥" class="headerlink" title="1.6.2 æ•°æ®æœ¬åœ°æ€§çš„ä¼˜åŒ–ç­–ç•¥"></a>1.6.2 æ•°æ®æœ¬åœ°æ€§çš„ä¼˜åŒ–ç­–ç•¥</h4><p><strong>æ™ºèƒ½æ•°æ®æ”¾ç½®ç­–ç•¥ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ•°æ®æ”¾ç½®ä¼˜åŒ–å™¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataPlacementOptimizer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">optimizeDataPlacement</span><span class="params">(JavaRDD&lt;?&gt; rdd)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. åˆ†ææ•°æ®è®¿é—®æ¨¡å¼</span></span><br><span class="line">        <span class="type">DataAccessPattern</span> <span class="variable">pattern</span> <span class="operator">=</span> analyzeAccessPattern(rdd);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. æ ¹æ®è®¿é—®æ¨¡å¼é€‰æ‹©ç¼“å­˜ç­–ç•¥</span></span><br><span class="line">        <span class="keyword">if</span> (pattern.isFrequentlyAccessed()) &#123;</span><br><span class="line">            <span class="comment">// é¢‘ç¹è®¿é—®ï¼šä½¿ç”¨å†…å­˜ç¼“å­˜</span></span><br><span class="line">            rdd.cache();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// é¢„å–æ•°æ®åˆ°æœ€ä¼˜ä½ç½®</span></span><br><span class="line">            prefetchToOptimalLocations(rdd);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pattern.hasHotPartitions()) &#123;</span><br><span class="line">            <span class="comment">// çƒ­ç‚¹åˆ†åŒºï¼šå¤åˆ¶åˆ°å¤šä¸ªèŠ‚ç‚¹</span></span><br><span class="line">            replicateHotPartitions(rdd, pattern.getHotPartitions());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. ä¼˜åŒ–åç»­RDDçš„åˆ†åŒºæ”¾ç½®</span></span><br><span class="line">        optimizeDownstreamPartitioning(rdd);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">prefetchToOptimalLocations</span><span class="params">(JavaRDD&lt;?&gt; rdd)</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–é›†ç¾¤æ‹“æ‰‘ä¿¡æ¯</span></span><br><span class="line">        <span class="type">ClusterTopology</span> <span class="variable">topology</span> <span class="operator">=</span> getClusterTopology();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è®¡ç®—æ¯ä¸ªåˆ†åŒºçš„æœ€ä¼˜æ”¾ç½®ä½ç½®</span></span><br><span class="line">        Map&lt;Integer, List&lt;String&gt;&gt; optimalPlacements = </span><br><span class="line">            calculateOptimalPlacements(rdd, topology);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ‰§è¡Œæ•°æ®é¢„å–</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;Integer, List&lt;String&gt;&gt; entry : optimalPlacements.entrySet()) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">partitionId</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">            List&lt;String&gt; preferredHosts = entry.getValue();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å¼‚æ­¥é¢„å–åˆ†åŒºæ•°æ®</span></span><br><span class="line">            prefetchPartitionAsync(rdd, partitionId, preferredHosts);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Map&lt;Integer, List&lt;String&gt;&gt; <span class="title function_">calculateOptimalPlacements</span><span class="params">(</span></span><br><span class="line"><span class="params">            JavaRDD&lt;?&gt; rdd, ClusterTopology topology)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        Map&lt;Integer, List&lt;String&gt;&gt; placements = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆ†æRDDçš„è¡€ç¼˜å…³ç³»ï¼Œé¢„æµ‹æ•°æ®è®¿é—®æ¨¡å¼</span></span><br><span class="line">        List&lt;RDD&lt;?&gt;&gt; downstreamRDDs = findDownstreamRDDs(rdd);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; rdd.getNumPartitions(); i++) &#123;</span><br><span class="line">            <span class="comment">// è®¡ç®—è¯¥åˆ†åŒºçš„è®¿é—®é¢‘ç‡å’Œæ¨¡å¼</span></span><br><span class="line">            <span class="type">AccessFrequency</span> <span class="variable">frequency</span> <span class="operator">=</span> calculateAccessFrequency(i, downstreamRDDs);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// åŸºäºç½‘ç»œæ‹“æ‰‘é€‰æ‹©æœ€ä¼˜ä½ç½®</span></span><br><span class="line">            List&lt;String&gt; optimalHosts = topology.selectOptimalHosts(</span><br><span class="line">                frequency, rdd.preferredLocations(rdd.partitions()[i]));</span><br><span class="line">            </span><br><span class="line">            placements.put(i, optimalHosts);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> placements;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="äºŒã€åŸºç¡€ç®—å­ï¼šmapã€filterã€flatMap"><a href="#äºŒã€åŸºç¡€ç®—å­ï¼šmapã€filterã€flatMap" class="headerlink" title="äºŒã€åŸºç¡€ç®—å­ï¼šmapã€filterã€flatMap"></a>äºŒã€åŸºç¡€ç®—å­ï¼šmapã€filterã€flatMap</h2><p>åŸºç¡€ç®—å­æ˜¯Sparkè®¡ç®—çš„æ ¹åŸºï¼Œè™½ç„¶çœ‹ä¼¼ç®€å•ï¼Œä½†å…¶å†…éƒ¨åŒ…å«äº†è®¸å¤šç²¾å·§çš„è®¾è®¡å’Œä¼˜åŒ–æœºåˆ¶ã€‚æ·±å…¥ç†è§£è¿™äº›ç®—å­çš„å·¥ä½œåŸç†ï¼Œæ˜¯æŒæ¡Sparkæ€§èƒ½ä¼˜åŒ–çš„å…³é”®ã€‚</p><h3 id="2-1-mapç®—å­ï¼šä¸€å¯¹ä¸€è½¬æ¢"><a href="#2-1-mapç®—å­ï¼šä¸€å¯¹ä¸€è½¬æ¢" class="headerlink" title="2.1 mapç®—å­ï¼šä¸€å¯¹ä¸€è½¬æ¢"></a>2.1 mapç®—å­ï¼šä¸€å¯¹ä¸€è½¬æ¢</h3><p>mapç®—å­æ˜¯Sparkä¸­æœ€åŸºç¡€ä¹Ÿæœ€å¸¸ç”¨çš„ç®—å­ä¹‹ä¸€ï¼Œå®ƒä½“ç°äº†å‡½æ•°å¼ç¼–ç¨‹çš„æ ¸å¿ƒæ€æƒ³ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JavaRDD&lt;Integer&gt; rdd = sc.parallelize(Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>));</span><br><span class="line">JavaRDD&lt;Integer&gt; mapped = rdd.map(x -&gt; x * <span class="number">2</span>);</span><br></pre></td></tr></table></figure><h4 id="2-1-1-å†…éƒ¨æ‰§è¡Œæœºåˆ¶æ·±åº¦è§£æ"><a href="#2-1-1-å†…éƒ¨æ‰§è¡Œæœºåˆ¶æ·±åº¦è§£æ" class="headerlink" title="2.1.1 å†…éƒ¨æ‰§è¡Œæœºåˆ¶æ·±åº¦è§£æ"></a>2.1.1 å†…éƒ¨æ‰§è¡Œæœºåˆ¶æ·±åº¦è§£æ</h4><p><strong>RDDè¡€ç¼˜å…³ç³»çš„å»ºç«‹ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mapç®—å­å†…éƒ¨å®ç°çš„ç®€åŒ–ç‰ˆæœ¬</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MappedRDD</span>&lt;U, T&gt; <span class="keyword">extends</span> <span class="title class_">RDD</span>&lt;U&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RDD&lt;T&gt; prev;           <span class="comment">// çˆ¶RDDå¼•ç”¨</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Function&lt;T, U&gt; f;      <span class="comment">// è½¬æ¢å‡½æ•°</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MappedRDD</span><span class="params">(RDD&lt;T&gt; prev, Function&lt;T, U&gt; f)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(prev.context(), List.of(<span class="keyword">new</span> <span class="title class_">OneToOneDependency</span>&lt;&gt;(prev)));</span><br><span class="line">        <span class="built_in">this</span>.prev = prev;</span><br><span class="line">        <span class="built_in">this</span>.f = f;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Iterator&lt;U&gt; <span class="title function_">compute</span><span class="params">(Partition split, TaskContext context)</span> &#123;</span><br><span class="line">        <span class="comment">// å…³é”®ï¼šæ‡’æƒ°è®¡ç®—ï¼Œç›´åˆ°Actionè§¦å‘æ‰çœŸæ­£æ‰§è¡Œ</span></span><br><span class="line">        <span class="keyword">return</span> prev.iterator(split, context).map(f);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Partition[] getPartitions() &#123;</span><br><span class="line">        <span class="comment">// ç»§æ‰¿çˆ¶RDDçš„åˆ†åŒºç»“æ„ï¼Œä¿æŒä¸€å¯¹ä¸€å…³ç³»</span></span><br><span class="line">        <span class="keyword">return</span> prev.getPartitions();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ•°æ®æµè½¬çš„å¾®è§‚è¿‡ç¨‹ï¼š</strong></p><ol><li><p><strong>åˆ†åŒºçº§åˆ«çš„å¤„ç†</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ¯ä¸ªåˆ†åŒºç‹¬ç«‹å¤„ç†ï¼Œäº’ä¸å¹²æ‰°</span></span><br><span class="line"><span class="keyword">public</span> Iterator&lt;U&gt; <span class="title function_">processPartition</span><span class="params">(Iterator&lt;T&gt; input)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Iterator</span>&lt;U&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasNext</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> input.hasNext();  <span class="comment">// æµå¼å¤„ç†ï¼Œä¸ç¼“å­˜æ•°æ®</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> U <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">T</span> <span class="variable">element</span> <span class="operator">=</span> input.next();</span><br><span class="line">            <span class="keyword">return</span> f.apply(element);  <span class="comment">// é€å…ƒç´ è½¬æ¢</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>å†…å­˜ä½¿ç”¨ç‰¹ç‚¹</strong>ï¼š</p><ul><li><strong>æµå¼å¤„ç†</strong>ï¼šä¸éœ€è¦å°†æ•´ä¸ªåˆ†åŒºåŠ è½½åˆ°å†…å­˜</li><li><strong>å³æ—¶è®¡ç®—</strong>ï¼šæ¯æ¬¡è°ƒç”¨next()æ—¶æ‰è®¡ç®—ä¸‹ä¸€ä¸ªå…ƒç´ </li><li><strong>å†…å­˜å¤ç”¨</strong>ï¼šå¤„ç†å®Œçš„å…ƒç´ ç«‹å³è¢«åƒåœ¾å›æ”¶</li></ul></li></ol><h4 id="2-1-2-ä»»åŠ¡è°ƒåº¦ä¸æ‰§è¡Œè¯¦è§£"><a href="#2-1-2-ä»»åŠ¡è°ƒåº¦ä¸æ‰§è¡Œè¯¦è§£" class="headerlink" title="2.1.2 ä»»åŠ¡è°ƒåº¦ä¸æ‰§è¡Œè¯¦è§£"></a>2.1.2 ä»»åŠ¡è°ƒåº¦ä¸æ‰§è¡Œè¯¦è§£</h4><p><strong>Taskç”Ÿæˆæœºåˆ¶ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DAGSchedulerå¦‚ä½•ä¸ºmapç”ŸæˆTask</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DAGScheduler</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;Task&lt;?&gt;&gt; createTasksForStage(Stage stage) &#123;</span><br><span class="line">        <span class="keyword">if</span> (stage.isShuffleMap()) &#123;</span><br><span class="line">            <span class="comment">// mapç®—å­é€šå¸¸ç”ŸæˆResultTask</span></span><br><span class="line">            <span class="keyword">return</span> stage.rdd.partitions().stream()</span><br><span class="line">                .map(partition -&gt; <span class="keyword">new</span> <span class="title class_">ResultTask</span>&lt;&gt;(</span><br><span class="line">                    stage.id,</span><br><span class="line">                    partition.index,</span><br><span class="line">                    stage.rdd,</span><br><span class="line">                    partition,</span><br><span class="line">                    stage.outputLocs</span><br><span class="line">                ))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¼˜åŒ–æœºåˆ¶ï¼š</strong></p><ol><li><strong>Pipelineä¼˜åŒ–</strong>ï¼šå¤šä¸ªè¿ç»­çš„çª„ä¾èµ–ç®—å­ä¼šè¢«åˆå¹¶æ‰§è¡Œ</li><li><strong>ä»£ç ç”Ÿæˆ</strong>ï¼šCatalystä¼˜åŒ–å™¨ä¸ºç®€å•è½¬æ¢ç”Ÿæˆé«˜æ•ˆçš„Javaä»£ç </li><li><strong>å‘é‡åŒ–æ‰§è¡Œ</strong>ï¼šå¯¹äºæ•°å€¼ç±»å‹ï¼Œä½¿ç”¨SIMDæŒ‡ä»¤åŠ é€Ÿ</li></ol><p><strong>æ‰§è¡ŒåŸç†æ·±åº¦å‰–æï¼š</strong></p><ol><li><strong>çª„ä¾èµ–çš„æœ¬è´¨</strong>ï¼šå­RDDçš„æ¯ä¸ªåˆ†åŒºåªä¾èµ–çˆ¶RDDçš„å¯¹åº”åˆ†åŒº</li><li><strong>æ•°æ®å±€éƒ¨æ€§çš„ä¼˜åŠ¿</strong>ï¼šæ•°æ®ä¸éœ€è¦è·¨èŠ‚ç‚¹ä¼ è¾“ï¼Œå……åˆ†åˆ©ç”¨CPUç¼“å­˜</li><li><strong>å†…å­˜å‹å¥½çš„ç‰¹æ€§</strong>ï¼šè½¬æ¢è¿‡ç¨‹ä¸æ”¹å˜æ•°æ®é‡ï¼Œå†…å­˜å‹åŠ›å¯æ§</li></ol><h4 id="2-1-3-æ€§èƒ½ç‰¹å¾ä¸å†…å­˜ç®¡ç†"><a href="#2-1-3-æ€§èƒ½ç‰¹å¾ä¸å†…å­˜ç®¡ç†" class="headerlink" title="2.1.3 æ€§èƒ½ç‰¹å¾ä¸å†…å­˜ç®¡ç†"></a>2.1.3 æ€§èƒ½ç‰¹å¾ä¸å†…å­˜ç®¡ç†</h4><p><strong>CPUç¼“å­˜å‹å¥½æ€§ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mapæ“ä½œçš„ç¼“å­˜å±€éƒ¨æ€§åˆ†æ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheLocalityAnalysis</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demonstrateCacheEfficiency</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// æ•°æ®åœ¨åŒä¸€ä¸ªåˆ†åŒºå†…é¡ºåºå¤„ç†</span></span><br><span class="line">        <span class="comment">// CPUå¯ä»¥æœ‰æ•ˆåˆ©ç”¨L1/L2/L3ç¼“å­˜</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ç¤ºä¾‹ï¼šå¤„ç†100ä¸‡ä¸ªæ•´æ•°</span></span><br><span class="line">        List&lt;Integer&gt; data = IntStream.range(<span class="number">1</span>, <span class="number">1000001</span>)</span><br><span class="line">            .boxed().collect(Collectors.toList());</span><br><span class="line">        </span><br><span class="line">        JavaRDD&lt;Integer&gt; rdd = sc.parallelize(data, <span class="number">4</span>); <span class="comment">// 4ä¸ªåˆ†åŒº</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ¯ä¸ªåˆ†åŒºçº¦25ä¸‡ä¸ªå…ƒç´ ï¼Œé¡ºåºå¤„ç†</span></span><br><span class="line">        <span class="comment">// CPUç¼“å­˜å‘½ä¸­ç‡é«˜ï¼Œæ€§èƒ½ä¼˜å¼‚</span></span><br><span class="line">        JavaRDD&lt;Integer&gt; result = rdd.map(x -&gt; x * x + <span class="number">2</span> * x + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å†…å­˜åˆ†é…æ¨¡å¼ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mapæ“ä½œçš„å†…å­˜ä½¿ç”¨æ¨¡å¼</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemoryUsagePattern</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">analyzeMemoryUsage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 1. ä¸ä¼šé¢å¤–åˆ†é…å¤§å‹æ•°æ®ç»“æ„</span></span><br><span class="line">        <span class="comment">// 2. åªéœ€è¦å­˜å‚¨å½“å‰å¤„ç†çš„å•ä¸ªå…ƒç´ </span></span><br><span class="line">        <span class="comment">// 3. æ”¯æŒæµå¼å¤„ç†ï¼Œå†…å­˜ä½¿ç”¨ç¨³å®š</span></span><br><span class="line">        </span><br><span class="line">        <span class="type">long</span> <span class="variable">memoryBefore</span> <span class="operator">=</span> getUsedMemory();</span><br><span class="line">        </span><br><span class="line">        JavaRDD&lt;String&gt; largeRDD = sc.textFile(<span class="string">&quot;100GB_file.txt&quot;</span>);</span><br><span class="line">        JavaRDD&lt;String&gt; processed = largeRDD.map(line -&gt; line.toUpperCase());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ­¤æ—¶å†…å­˜ä½¿ç”¨é‡å‡ ä¹æ²¡æœ‰å˜åŒ–ï¼Œå› ä¸ºæ˜¯æ‡’æƒ°è®¡ç®—</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">memoryAfter</span> <span class="operator">=</span> getUsedMemory();</span><br><span class="line">        System.out.println(<span class="string">&quot;Memory increase: &quot;</span> + (memoryAfter - memoryBefore) + <span class="string">&quot; bytes&quot;</span>);</span><br><span class="line">        <span class="comment">// è¾“å‡ºé€šå¸¸ä¸ºï¼šMemory increase: &lt; 1MB</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><pre class="mermaid">graph LR    A[Partition 1<br/>1,2,3,4,5] --> B[Partition 1<br/>2,4,6,8,10]    C[Partition 2<br/>6,7,8,9,10] --> D[Partition 2<br/>12,14,16,18,20]</pre><p><strong>æ•°æ®æµè½¬è¿‡ç¨‹ï¼š</strong></p><ul><li>æ¯ä¸ªExecutorè¯»å–æœ¬åœ°åˆ†åŒºçš„æ•°æ®</li><li>å¯¹æ¯ä¸ªå…ƒç´ åº”ç”¨mapå‡½æ•°</li><li>ç»“æœç›´æ¥å†™å…¥æ–°çš„åˆ†åŒºï¼Œæ— éœ€ç½‘ç»œä¼ è¾“</li><li>æ•´ä¸ªè¿‡ç¨‹åœ¨å•ä¸ªèŠ‚ç‚¹å†…å®Œæˆ</li></ul><p><strong>å†…å­˜ç®¡ç†æœºåˆ¶ï¼š</strong></p><p>Sparkåœ¨mapæ“ä½œä¸­é‡‡ç”¨ä»¥ä¸‹å†…å­˜ç®¡ç†ç­–ç•¥ï¼š</p><ol><li><strong>å¯¹è±¡å¤ç”¨</strong>ï¼šå°½å¯èƒ½å¤ç”¨å¯¹è±¡ï¼Œå‡å°‘GCå‹åŠ›</li><li><strong>åºåˆ—åŒ–ä¼˜åŒ–</strong>ï¼šä½¿ç”¨TungstenäºŒè¿›åˆ¶æ ¼å¼ï¼Œå‡å°‘åºåˆ—åŒ–å¼€é”€</li><li><strong>å†…å­˜æ± </strong>ï¼šä½¿ç”¨å†…å­˜æ± ç®¡ç†ä¸´æ—¶å¯¹è±¡</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å†…å­˜ä¼˜åŒ–çš„mapç¤ºä¾‹</span></span><br><span class="line">JavaRDD&lt;String&gt; optimizedMap = rdd.mapPartitions(iter -&gt; &#123;</span><br><span class="line">    <span class="comment">// åœ¨åˆ†åŒºçº§åˆ«è¿›è¡Œå¯¹è±¡å¤ç”¨</span></span><br><span class="line">    List&lt;String&gt; results = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">item</span> <span class="operator">=</span> iter.next();</span><br><span class="line">        results.add(item.toUpperCase());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> results.iterator();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><strong>æ€§èƒ½ç‰¹ç‚¹ï¼š</strong></p><ul><li>æ‰§è¡Œé€Ÿåº¦å¿«ï¼Œå› ä¸ºæ— ç½‘ç»œIO</li><li>å†…å­˜ä½¿ç”¨çº¿æ€§å¢é•¿</li><li>é€‚åˆCPUå¯†é›†å‹è½¬æ¢æ“ä½œ</li></ul><h3 id="2-2-filterç®—å­ï¼šæ¡ä»¶è¿‡æ»¤"><a href="#2-2-filterç®—å­ï¼šæ¡ä»¶è¿‡æ»¤" class="headerlink" title="2.2 filterç®—å­ï¼šæ¡ä»¶è¿‡æ»¤"></a>2.2 filterç®—å­ï¼šæ¡ä»¶è¿‡æ»¤</h3><p>filterç®—å­æ˜¯æ•°æ®ç­›é€‰çš„æ ¸å¿ƒå·¥å…·ï¼Œå…¶çœ‹ä¼¼ç®€å•çš„å¤–è¡¨ä¸‹éšè—ç€å¤æ‚çš„å†…å­˜ç®¡ç†å’Œæ€§èƒ½ä¼˜åŒ–é€»è¾‘ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JavaRDD&lt;Integer&gt; rdd = sc.parallelize(Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>));</span><br><span class="line">JavaRDD&lt;Integer&gt; filtered = rdd.filter(x -&gt; x % <span class="number">2</span> == <span class="number">0</span>);</span><br></pre></td></tr></table></figure><h4 id="2-2-1-filterç®—å­çš„å†…éƒ¨å®ç°æœºåˆ¶"><a href="#2-2-1-filterç®—å­çš„å†…éƒ¨å®ç°æœºåˆ¶" class="headerlink" title="2.2.1 filterç®—å­çš„å†…éƒ¨å®ç°æœºåˆ¶"></a>2.2.1 filterç®—å­çš„å†…éƒ¨å®ç°æœºåˆ¶</h4><p><strong>FilteredRDDçš„å®ç°åŸç†ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// filterç®—å­çš„æ ¸å¿ƒå®ç°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FilteredRDD</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">RDD</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RDD&lt;T&gt; prev;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Function&lt;T, Boolean&gt; f;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FilteredRDD</span><span class="params">(RDD&lt;T&gt; prev, Function&lt;T, Boolean&gt; f)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(prev.context(), List.of(<span class="keyword">new</span> <span class="title class_">OneToOneDependency</span>&lt;&gt;(prev)));</span><br><span class="line">        <span class="built_in">this</span>.prev = prev;</span><br><span class="line">        <span class="built_in">this</span>.f = f;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Iterator&lt;T&gt; <span class="title function_">compute</span><span class="params">(Partition split, TaskContext context)</span> &#123;</span><br><span class="line">        <span class="comment">// å…³é”®ï¼šä½¿ç”¨æµå¼è¿‡æ»¤ï¼Œå†…å­˜æ•ˆç‡é«˜</span></span><br><span class="line">        <span class="keyword">return</span> prev.iterator(split, context)</span><br><span class="line">            .filter(f::apply);  <span class="comment">// åªä¿ç•™æ»¡è¶³æ¡ä»¶çš„å…ƒç´ </span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Partition[] getPartitions() &#123;</span><br><span class="line">        <span class="comment">// ä¿æŒä¸çˆ¶RDDç›¸åŒçš„åˆ†åŒºç»“æ„</span></span><br><span class="line">        <span class="keyword">return</span> prev.getPartitions();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ•°æ®æµè½¬çš„è¯¦ç»†è¿‡ç¨‹ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// filteræ“ä½œçš„å¾®è§‚æ‰§è¡Œè¿‡ç¨‹</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FilterIterator</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Iterator</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Iterator&lt;T&gt; input;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Function&lt;T, Boolean&gt; predicate;</span><br><span class="line">    <span class="keyword">private</span> T nextElement;          <span class="comment">// é¢„è¯»å–çš„ä¸‹ä¸€ä¸ªå…ƒç´ </span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> hasNextElement; <span class="comment">// æ˜¯å¦æœ‰ä¸‹ä¸€ä¸ªå…ƒç´ </span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FilterIterator</span><span class="params">(Iterator&lt;T&gt; input, Function&lt;T, Boolean&gt; predicate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.input = input;</span><br><span class="line">        <span class="built_in">this</span>.predicate = predicate;</span><br><span class="line">        findNext(); <span class="comment">// é¢„å…ˆæŸ¥æ‰¾ç¬¬ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„å…ƒç´ </span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">findNext</span><span class="params">()</span> &#123;</span><br><span class="line">        hasNextElement = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">while</span> (input.hasNext()) &#123;</span><br><span class="line">            <span class="type">T</span> <span class="variable">element</span> <span class="operator">=</span> input.next();</span><br><span class="line">            <span class="keyword">if</span> (predicate.apply(element)) &#123;</span><br><span class="line">                nextElement = element;</span><br><span class="line">                hasNextElement = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ä¸æ»¡è¶³æ¡ä»¶çš„å…ƒç´ ç›´æ¥ä¸¢å¼ƒï¼Œä¸å ç”¨å†…å­˜</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasNext</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> hasNextElement;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!hasNextElement) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchElementException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">T</span> <span class="variable">result</span> <span class="operator">=</span> nextElement;</span><br><span class="line">        findNext(); <span class="comment">// æŸ¥æ‰¾ä¸‹ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„å…ƒç´ </span></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-2-2-æ•°æ®åˆ†å¸ƒä¸åˆ†åŒºå½±å“åˆ†æ"><a href="#2-2-2-æ•°æ®åˆ†å¸ƒä¸åˆ†åŒºå½±å“åˆ†æ" class="headerlink" title="2.2.2 æ•°æ®åˆ†å¸ƒä¸åˆ†åŒºå½±å“åˆ†æ"></a>2.2.2 æ•°æ®åˆ†å¸ƒä¸åˆ†åŒºå½±å“åˆ†æ</h4><p><strong>åˆ†åŒºå¤§å°çš„åŠ¨æ€å˜åŒ–ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ†æfilterå¯¹åˆ†åŒºå¤§å°çš„å½±å“</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PartitionSizeAnalysis</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">analyzeFilterImpact</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// åŸå§‹æ•°æ®ï¼šå‡åŒ€åˆ†å¸ƒ</span></span><br><span class="line">        JavaRDD&lt;Integer&gt; original = sc.parallelize(range(<span class="number">1</span>, <span class="number">1000001</span>), <span class="number">100</span>);</span><br><span class="line">        <span class="comment">// æ¯ä¸ªåˆ†åŒºï¼š10,000ä¸ªå…ƒç´ </span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åœºæ™¯1ï¼šä½é€‰æ‹©æ€§è¿‡æ»¤ï¼ˆä¿ç•™90%æ•°æ®ï¼‰</span></span><br><span class="line">        JavaRDD&lt;Integer&gt; lowSelectivity = original.filter(x -&gt; x % <span class="number">10</span> != <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// ç»“æœï¼šæ¯ä¸ªåˆ†åŒºçº¦9,000ä¸ªå…ƒç´ ï¼Œç›¸å¯¹å‡åŒ€</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åœºæ™¯2ï¼šé«˜é€‰æ‹©æ€§è¿‡æ»¤ï¼ˆä¿ç•™1%æ•°æ®ï¼‰</span></span><br><span class="line">        JavaRDD&lt;Integer&gt; highSelectivity = original.filter(x -&gt; x % <span class="number">100</span> == <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// ç»“æœï¼šæ¯ä¸ªåˆ†åŒºçº¦100ä¸ªå…ƒç´ ï¼Œå¯èƒ½å¯¼è‡´åˆ†åŒºè¿‡å°</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åœºæ™¯3ï¼šå€¾æ–œè¿‡æ»¤ï¼ˆæ•°æ®åˆ†å¸ƒä¸å‡ï¼‰</span></span><br><span class="line">        JavaRDD&lt;String&gt; skewedData = sc.parallelize(generateSkewedData(), <span class="number">100</span>);</span><br><span class="line">        JavaRDD&lt;String&gt; filtered = skewedData.filter(s -&gt; s.startsWith(<span class="string">&quot;error&quot;</span>));</span><br><span class="line">        <span class="comment">// ç»“æœï¼šæŸäº›åˆ†åŒºå¯èƒ½ä¸ºç©ºï¼ŒæŸäº›åˆ†åŒºæ•°æ®å¯†é›†</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>åˆ†åŒºä¼˜åŒ–çš„è§¦å‘æœºåˆ¶ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Sparkå†…éƒ¨çš„åˆ†åŒºå¤§å°ç›‘æ§æœºåˆ¶</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PartitionSizeMonitor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">MIN_PARTITION_SIZE</span> <span class="operator">=</span> <span class="number">1024</span> * <span class="number">1024</span>; <span class="comment">// 1MB</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">double</span> <span class="variable">EMPTY_PARTITION_RATIO</span> <span class="operator">=</span> <span class="number">0.5</span>;    <span class="comment">// 50%ç©ºåˆ†åŒºç‡</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldCoalescePartitions</span><span class="params">(RDD&lt;?&gt; rdd)</span> &#123;</span><br><span class="line">        <span class="type">PartitionStatistics</span> <span class="variable">stats</span> <span class="operator">=</span> collectPartitionStatistics(rdd);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ¡ä»¶1ï¼šå¤§é‡å°åˆ†åŒº</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">hasTooManySmallPartitions</span> <span class="operator">=</span> </span><br><span class="line">            stats.averagePartitionSize &lt; MIN_PARTITION_SIZE;</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// æ¡ä»¶2ï¼šå¤§é‡ç©ºåˆ†åŒº</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">hasTooManyEmptyPartitions</span> <span class="operator">=</span> </span><br><span class="line">            stats.emptyPartitionRatio &gt; EMPTY_PARTITION_RATIO;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> hasTooManySmallPartitions || hasTooManyEmptyPartitions;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-2-3-æ€§èƒ½ç‰¹å¾ä¸ä¼˜åŒ–ç­–ç•¥"><a href="#2-2-3-æ€§èƒ½ç‰¹å¾ä¸ä¼˜åŒ–ç­–ç•¥" class="headerlink" title="2.2.3 æ€§èƒ½ç‰¹å¾ä¸ä¼˜åŒ–ç­–ç•¥"></a>2.2.3 æ€§èƒ½ç‰¹å¾ä¸ä¼˜åŒ–ç­–ç•¥</h4><p><strong>é€‰æ‹©æ€§å¯¹æ€§èƒ½çš„å½±å“ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é€‰æ‹©æ€§åˆ†æå’Œæ€§èƒ½é¢„æµ‹</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SelectivityAnalysis</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">analyzeSelectivity</span><span class="params">()</span> &#123;</span><br><span class="line">        JavaRDD&lt;LogEntry&gt; logs = sc.textFile(<span class="string">&quot;access.log&quot;</span>)</span><br><span class="line">            .map(LogEntry::parse);</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// é«˜é€‰æ‹©æ€§åœºæ™¯ï¼šé”™è¯¯æ—¥å¿—ï¼ˆé€‰æ‹©æ€§ &lt; 5%ï¼‰</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime1</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        JavaRDD&lt;LogEntry&gt; errorLogs = logs.filter(log -&gt; log.getLevel().equals(<span class="string">&quot;ERROR&quot;</span>));</span><br><span class="line">        <span class="type">long</span> <span class="variable">errorCount</span> <span class="operator">=</span> errorLogs.count();</span><br><span class="line">        <span class="type">long</span> <span class="variable">time1</span> <span class="operator">=</span> System.currentTimeMillis() - startTime1;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä½é€‰æ‹©æ€§åœºæ™¯ï¼šéè°ƒè¯•æ—¥å¿—ï¼ˆé€‰æ‹©æ€§ &gt; 80%ï¼‰</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime2</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        JavaRDD&lt;LogEntry&gt; nonDebugLogs = logs.filter(log -&gt; !log.getLevel().equals(<span class="string">&quot;DEBUG&quot;</span>));</span><br><span class="line">        <span class="type">long</span> <span class="variable">nonDebugCount</span> <span class="operator">=</span> nonDebugLogs.count();</span><br><span class="line">        <span class="type">long</span> <span class="variable">time2</span> <span class="operator">=</span> System.currentTimeMillis() - startTime2;</span><br><span class="line">        </span><br><span class="line">        <span class="type">double</span> <span class="variable">selectivity1</span> <span class="operator">=</span> (<span class="type">double</span>) errorCount / logs.count();</span><br><span class="line">        <span class="type">double</span> <span class="variable">selectivity2</span> <span class="operator">=</span> (<span class="type">double</span>) nonDebugCount / logs.count();</span><br><span class="line">        </span><br><span class="line">        System.out.printf(<span class="string">&quot;é«˜é€‰æ‹©æ€§è¿‡æ»¤ - é€‰æ‹©æ€§: %.2f%%, æ‰§è¡Œæ—¶é—´: %dms%n&quot;</span>, </span><br><span class="line">            selectivity1 * <span class="number">100</span>, time1);</span><br><span class="line">        System.out.printf(<span class="string">&quot;ä½é€‰æ‹©æ€§è¿‡æ»¤ - é€‰æ‹©æ€§: %.2f%%, æ‰§è¡Œæ—¶é—´: %dms%n&quot;</span>, </span><br><span class="line">            selectivity2 * <span class="number">100</span>, time2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å†…å­˜ä½¿ç”¨æ¨¡å¼åˆ†æï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// filteræ“ä½œçš„å†…å­˜ç‰¹å¾</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FilterMemoryAnalysis</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">analyzeMemoryUsage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// filterç®—å­çš„å†…å­˜ä¼˜åŠ¿ï¼š</span></span><br><span class="line">        <span class="comment">// 1. æµå¼å¤„ç†ï¼Œä¸éœ€è¦ç¼“å­˜æ‰€æœ‰æ•°æ®</span></span><br><span class="line">        <span class="comment">// 2. ä¸æ»¡è¶³æ¡ä»¶çš„æ•°æ®ç«‹å³é‡Šæ”¾</span></span><br><span class="line">        <span class="comment">// 3. æ”¯æŒåƒåœ¾å›æ”¶ä¼˜åŒ–</span></span><br><span class="line">        </span><br><span class="line">        <span class="type">MemoryMXBean</span> <span class="variable">memoryBean</span> <span class="operator">=</span> ManagementFactory.getMemoryMXBean();</span><br><span class="line">        </span><br><span class="line">        JavaRDD&lt;String&gt; largeDataset = sc.textFile(<span class="string">&quot;large_dataset.txt&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">long</span> <span class="variable">memoryBefore</span> <span class="operator">=</span> memoryBean.getHeapMemoryUsage().getUsed();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é«˜é€‰æ‹©æ€§è¿‡æ»¤ï¼Œå¤§é‡æ•°æ®è¢«ä¸¢å¼ƒ</span></span><br><span class="line">        JavaRDD&lt;String&gt; filtered = largeDataset.filter(line -&gt; </span><br><span class="line">            line.contains(<span class="string">&quot;important_keyword&quot;</span>));</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// è§¦å‘ä¸€æ¬¡actionï¼Œè§‚å¯Ÿå†…å­˜ä½¿ç”¨</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">resultCount</span> <span class="operator">=</span> filtered.count();</span><br><span class="line">        </span><br><span class="line">        <span class="type">long</span> <span class="variable">memoryAfter</span> <span class="operator">=</span> memoryBean.getHeapMemoryUsage().getUsed();</span><br><span class="line">        </span><br><span class="line">        System.out.printf(<span class="string">&quot;è¿‡æ»¤å‰å†…å­˜: %d MB%n&quot;</span>, memoryBefore / (<span class="number">1024</span> * <span class="number">1024</span>));</span><br><span class="line">        System.out.printf(<span class="string">&quot;è¿‡æ»¤åå†…å­˜: %d MB%n&quot;</span>, memoryAfter / (<span class="number">1024</span> * <span class="number">1024</span>));</span><br><span class="line">        System.out.printf(<span class="string">&quot;å†…å­˜å¢é•¿: %d MB%n&quot;</span>, (memoryAfter - memoryBefore) / (<span class="number">1024</span> * <span class="number">1024</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é€šå¸¸æƒ…å†µä¸‹ï¼Œå†…å­˜å¢é•¿å¾ˆå°ï¼Œå› ä¸ºfilteræ˜¯æµå¼å¤„ç†</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ‰§è¡ŒåŸç†æ·±åº¦å‰–æï¼š</strong></p><ol><li><strong>çª„ä¾èµ–ç‰¹æ€§</strong>ï¼šä¿æŒä¸€å¯¹ä¸€çš„åˆ†åŒºå…³ç³»ï¼Œæ— éœ€Shuffleæ“ä½œ</li><li><strong>æ•°æ®é‡åŠ¨æ€å˜åŒ–</strong>ï¼šè¾“å‡ºæ•°æ®é‡å–å†³äºè¿‡æ»¤æ¡ä»¶çš„é€‰æ‹©æ€§</li><li><strong>åˆ†åŒºå¤§å°ä¸å‡</strong>ï¼šå¯èƒ½å¯¼è‡´æŸäº›åˆ†åŒºå˜å¾—å¾ˆå°ç”šè‡³ä¸ºç©º</li><li><strong>æµå¼å¤„ç†ä¼˜åŠ¿</strong>ï¼šä¸éœ€è¦å°†æ•´ä¸ªåˆ†åŒºåŠ è½½åˆ°å†…å­˜ä¸­</li></ol><p><strong>å…³é”®ä¼˜åŒ–æœºåˆ¶ï¼š</strong></p><ul><li><strong>é¢„æµ‹æ‰§è¡Œ</strong>ï¼šæ ¹æ®é‡‡æ ·æ•°æ®é¢„æµ‹è¿‡æ»¤åçš„æ•°æ®é‡</li><li><strong>åŠ¨æ€åˆ†åŒºåˆå¹¶</strong>ï¼šè‡ªåŠ¨åˆå¹¶è¿‡å°çš„åˆ†åŒºä»¥æé«˜æ•ˆç‡</li><li><strong>åƒåœ¾å›æ”¶ä¼˜åŒ–</strong>ï¼šåŠæ—¶é‡Šæ”¾ä¸æ»¡è¶³æ¡ä»¶çš„å¯¹è±¡</li></ul><p><strong>æ€§èƒ½è€ƒè™‘è¦ç‚¹ï¼š</strong></p><ul><li>è¿‡æ»¤æ¡ä»¶çš„é€‰æ‹©æ€§ç›´æ¥å½±å“åç»­æ“ä½œçš„æ€§èƒ½</li><li>é«˜é€‰æ‹©æ€§ï¼ˆè¿‡æ»¤æ‰å¤§éƒ¨åˆ†æ•°æ®ï¼‰æ—¶ï¼Œåç»­æ“ä½œä¼šæ˜¾è‘—åŠ é€Ÿ</li><li>ä½é€‰æ‹©æ€§æ—¶ï¼Œç½‘ç»œä¼ è¾“é‡å’Œè®¡ç®—é‡åŸºæœ¬ä¸å˜</li><li>å¤æ‚çš„è¿‡æ»¤æ¡ä»¶å¯èƒ½æˆä¸ºCPUç“¶é¢ˆ</li></ul><h3 id="2-3-flatMapç®—å­ï¼šä¸€å¯¹å¤šè½¬æ¢"><a href="#2-3-flatMapç®—å­ï¼šä¸€å¯¹å¤šè½¬æ¢" class="headerlink" title="2.3 flatMapç®—å­ï¼šä¸€å¯¹å¤šè½¬æ¢"></a>2.3 flatMapç®—å­ï¼šä¸€å¯¹å¤šè½¬æ¢</h3><p>flatMapæ˜¯Sparkä¸­æœ€çµæ´»çš„è½¬æ¢ç®—å­ä¹‹ä¸€ï¼Œå®ƒèƒ½å¤Ÿå®ç°å¤æ‚çš„æ•°æ®å˜å½¢å’Œå±•å¼€æ“ä½œï¼Œå…¶å†…éƒ¨æ¶‰åŠå¤æ‚çš„è¿­ä»£å™¨ç®¡ç†å’Œå†…å­˜ä¼˜åŒ–æœºåˆ¶ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JavaRDD&lt;String&gt; rdd = sc.parallelize(Arrays.asList(<span class="string">&quot;hello world&quot;</span>, <span class="string">&quot;spark is great&quot;</span>));</span><br><span class="line">JavaRDD&lt;String&gt; flatMapped = rdd.flatMap(line -&gt; Arrays.asList(line.split(<span class="string">&quot; &quot;</span>)).iterator());</span><br></pre></td></tr></table></figure><h4 id="2-3-1-flatMapçš„å†…éƒ¨å®ç°æœºåˆ¶"><a href="#2-3-1-flatMapçš„å†…éƒ¨å®ç°æœºåˆ¶" class="headerlink" title="2.3.1 flatMapçš„å†…éƒ¨å®ç°æœºåˆ¶"></a>2.3.1 flatMapçš„å†…éƒ¨å®ç°æœºåˆ¶</h4><p><strong>FlatMappedRDDçš„æ ¸å¿ƒé€»è¾‘ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// flatMapç®—å­çš„å†…éƒ¨å®ç°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlatMappedRDD</span>&lt;U, T&gt; <span class="keyword">extends</span> <span class="title class_">RDD</span>&lt;U&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RDD&lt;T&gt; prev;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Function&lt;T, Iterator&lt;U&gt;&gt; f;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FlatMappedRDD</span><span class="params">(RDD&lt;T&gt; prev, Function&lt;T, Iterator&lt;U&gt;&gt; f)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(prev.context(), List.of(<span class="keyword">new</span> <span class="title class_">OneToOneDependency</span>&lt;&gt;(prev)));</span><br><span class="line">        <span class="built_in">this</span>.prev = prev;</span><br><span class="line">        <span class="built_in">this</span>.f = f;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Iterator&lt;U&gt; <span class="title function_">compute</span><span class="params">(Partition split, TaskContext context)</span> &#123;</span><br><span class="line">        <span class="comment">// å…³é”®ï¼šä½¿ç”¨åµŒå¥—è¿­ä»£å™¨å¤„ç†ä¸€å¯¹å¤šæ˜ å°„</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FlatMappedIterator</span>&lt;&gt;(prev.iterator(split, context), f);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åµŒå¥—è¿­ä»£å™¨çš„å®ç°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlatMappedIterator</span>&lt;U, T&gt; <span class="keyword">implements</span> <span class="title class_">Iterator</span>&lt;U&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Iterator&lt;T&gt; input;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Function&lt;T, Iterator&lt;U&gt;&gt; f;</span><br><span class="line">    <span class="keyword">private</span> Iterator&lt;U&gt; currentInnerIterator;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FlatMappedIterator</span><span class="params">(Iterator&lt;T&gt; input, Function&lt;T, Iterator&lt;U&gt;&gt; f)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.input = input;</span><br><span class="line">        <span class="built_in">this</span>.f = f;</span><br><span class="line">        <span class="built_in">this</span>.currentInnerIterator = Collections.emptyIterator();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasNext</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// æ ¸å¿ƒé€»è¾‘ï¼šç®¡ç†å¤šå±‚è¿­ä»£å™¨</span></span><br><span class="line">        <span class="keyword">while</span> (!currentInnerIterator.hasNext() &amp;&amp; input.hasNext()) &#123;</span><br><span class="line">            <span class="type">T</span> <span class="variable">nextElement</span> <span class="operator">=</span> input.next();</span><br><span class="line">            currentInnerIterator = f.apply(nextElement);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> currentInnerIterator.hasNext();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> U <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!hasNext()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchElementException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> currentInnerIterator.next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-3-2-æ•°æ®è†¨èƒ€ä¸å†…å­˜ç®¡ç†"><a href="#2-3-2-æ•°æ®è†¨èƒ€ä¸å†…å­˜ç®¡ç†" class="headerlink" title="2.3.2 æ•°æ®è†¨èƒ€ä¸å†…å­˜ç®¡ç†"></a>2.3.2 æ•°æ®è†¨èƒ€ä¸å†…å­˜ç®¡ç†</h4><p><strong>æ•°æ®è†¨èƒ€çš„å½±å“åˆ†æï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ†æflatMapå¯¼è‡´çš„æ•°æ®è†¨èƒ€</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataExpansionAnalysis</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">analyzeFlatMapExpansion</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// åœºæ™¯1ï¼šæ–‡æœ¬åˆ†è¯ - é€‚åº¦è†¨èƒ€</span></span><br><span class="line">        JavaRDD&lt;String&gt; sentences = sc.parallelize(Arrays.asList(</span><br><span class="line">            <span class="string">&quot;Apache Spark is a unified analytics engine&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Spark provides high-level APIs in Java, Scala, Python and R&quot;</span></span><br><span class="line">        ));</span><br><span class="line">        </span><br><span class="line">        JavaRDD&lt;String&gt; words = sentences.flatMap(line -&gt; </span><br><span class="line">            Arrays.asList(line.split(<span class="string">&quot;\\s+&quot;</span>)).iterator());</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;åŸå§‹è¡Œæ•°: &quot;</span> + sentences.count());      <span class="comment">// 2</span></span><br><span class="line">        System.out.println(<span class="string">&quot;åˆ†è¯åå•è¯æ•°: &quot;</span> + words.count());       <span class="comment">// çº¦15ä¸ªå•è¯</span></span><br><span class="line">        System.out.println(<span class="string">&quot;è†¨èƒ€æ¯”ä¾‹: &quot;</span> + (words.count() / (<span class="type">double</span>)sentences.count())); <span class="comment">// 7.5å€</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åœºæ™¯2ï¼šæ•°æ®ç”Ÿæˆ - é«˜å€è†¨èƒ€</span></span><br><span class="line">        JavaRDD&lt;Integer&gt; numbers = sc.parallelize(Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>));</span><br><span class="line">        JavaRDD&lt;Integer&gt; expanded = numbers.flatMap(n -&gt; </span><br><span class="line">            IntStream.range(<span class="number">1</span>, n * <span class="number">1000</span>).boxed().iterator());</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;åŸå§‹æ•°å­—æ•°: &quot;</span> + numbers.count());       <span class="comment">// 3</span></span><br><span class="line">        System.out.println(<span class="string">&quot;è†¨èƒ€åæ•°é‡: &quot;</span> + expanded.count());      <span class="comment">// çº¦3000ä¸ª</span></span><br><span class="line">        System.out.println(<span class="string">&quot;è†¨èƒ€æ¯”ä¾‹: &quot;</span> + (expanded.count() / (<span class="type">double</span>)numbers.count())); <span class="comment">// 1000å€</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å†…å­˜å‹åŠ›ç®¡ç†æœºåˆ¶ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// flatMapçš„å†…å­˜ç®¡ç†ç­–ç•¥</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlatMapMemoryManagement</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demonstrateMemoryManagement</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// é—®é¢˜ï¼šå¦‚æœå•ä¸ªè¾“å…¥å…ƒç´ äº§ç”Ÿå¤§é‡è¾“å‡ºï¼Œå¯èƒ½å¯¼è‡´å†…å­˜å‹åŠ›</span></span><br><span class="line">        JavaRDD&lt;String&gt; input = sc.parallelize(Arrays.asList(<span class="string">&quot;large_data_source&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å±é™©åšæ³•ï¼šä¸€æ¬¡æ€§ç”Ÿæˆå¤§é‡æ•°æ®</span></span><br><span class="line">        JavaRDD&lt;String&gt; dangerous = input.flatMap(source -&gt; &#123;</span><br><span class="line">            List&lt;String&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++) &#123;  <span class="comment">// 100ä¸‡ä¸ªå…ƒç´ </span></span><br><span class="line">                result.add(<span class="string">&quot;generated_&quot;</span> + i);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> result.iterator();  <span class="comment">// åœ¨å†…å­˜ä¸­åˆ›å»º100ä¸‡ä¸ªå¯¹è±¡</span></span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä¼˜åŒ–åšæ³•ï¼šä½¿ç”¨æƒ°æ€§è¿­ä»£å™¨</span></span><br><span class="line">        JavaRDD&lt;String&gt; optimized = input.flatMap(source -&gt; </span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Iterator</span>&lt;String&gt;() &#123;</span><br><span class="line">                <span class="keyword">private</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">maxCount</span> <span class="operator">=</span> <span class="number">1000000</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasNext</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> count &lt; maxCount;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> String <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&quot;generated_&quot;</span> + (count++);  <span class="comment">// æŒ‰éœ€ç”Ÿæˆï¼Œå†…å­˜å‹å¥½</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-3-3-æ€§èƒ½ç‰¹å¾ä¸ä¼˜åŒ–ç­–ç•¥"><a href="#2-3-3-æ€§èƒ½ç‰¹å¾ä¸ä¼˜åŒ–ç­–ç•¥" class="headerlink" title="2.3.3 æ€§èƒ½ç‰¹å¾ä¸ä¼˜åŒ–ç­–ç•¥"></a>2.3.3 æ€§èƒ½ç‰¹å¾ä¸ä¼˜åŒ–ç­–ç•¥</h4><p><strong>è¿­ä»£å™¨é“¾çš„æ€§èƒ½åˆ†æï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// flatMapæ€§èƒ½ç‰¹å¾åˆ†æ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FlatMapPerformanceAnalysis</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">analyzePerformance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// æµ‹è¯•ä¸åŒè†¨èƒ€æ¯”ä¾‹çš„æ€§èƒ½å½±å“</span></span><br><span class="line">        JavaRDD&lt;Integer&gt; baseRDD = sc.parallelize(range(<span class="number">1</span>, <span class="number">10001</span>), <span class="number">10</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä½è†¨èƒ€ï¼ˆ1:2ï¼‰</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime1</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        JavaRDD&lt;Integer&gt; lowExpansion = baseRDD.flatMap(n -&gt; </span><br><span class="line">            Arrays.asList(n, n + <span class="number">1</span>).iterator());</span><br><span class="line">        <span class="type">long</span> <span class="variable">count1</span> <span class="operator">=</span> lowExpansion.count();</span><br><span class="line">        <span class="type">long</span> <span class="variable">time1</span> <span class="operator">=</span> System.currentTimeMillis() - startTime1;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä¸­è†¨èƒ€ï¼ˆ1:10ï¼‰</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime2</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        JavaRDD&lt;Integer&gt; mediumExpansion = baseRDD.flatMap(n -&gt; </span><br><span class="line">            IntStream.range(n, n + <span class="number">10</span>).boxed().iterator());</span><br><span class="line">        <span class="type">long</span> <span class="variable">count2</span> <span class="operator">=</span> mediumExpansion.count();</span><br><span class="line">        <span class="type">long</span> <span class="variable">time2</span> <span class="operator">=</span> System.currentTimeMillis() - startTime2;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é«˜è†¨èƒ€ï¼ˆ1:100ï¼‰</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime3</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        JavaRDD&lt;Integer&gt; highExpansion = baseRDD.flatMap(n -&gt; </span><br><span class="line">            IntStream.range(n, n + <span class="number">100</span>).boxed().iterator());</span><br><span class="line">        <span class="type">long</span> <span class="variable">count3</span> <span class="operator">=</span> highExpansion.count();</span><br><span class="line">        <span class="type">long</span> <span class="variable">time3</span> <span class="operator">=</span> System.currentTimeMillis() - startTime3;</span><br><span class="line">        </span><br><span class="line">        System.out.printf(<span class="string">&quot;ä½è†¨èƒ€ - æ•°é‡: %d, æ—¶é—´: %dms, ååé‡: %.2fä¸‡/ç§’%n&quot;</span>, </span><br><span class="line">            count1, time1, count1 / (time1 / <span class="number">1000.0</span>) / <span class="number">10000</span>);</span><br><span class="line">        System.out.printf(<span class="string">&quot;ä¸­è†¨èƒ€ - æ•°é‡: %d, æ—¶é—´: %dms, ååé‡: %.2fä¸‡/ç§’%n&quot;</span>, </span><br><span class="line">            count2, time2, count2 / (time2 / <span class="number">1000.0</span>) / <span class="number">10000</span>);</span><br><span class="line">        System.out.printf(<span class="string">&quot;é«˜è†¨èƒ€ - æ•°é‡: %d, æ—¶é—´: %dms, ååé‡: %.2fä¸‡/ç§’%n&quot;</span>, </span><br><span class="line">            count3, time3, count3 / (time3 / <span class="number">1000.0</span>) / <span class="number">10000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>åºåˆ—åŒ–å¼€é”€åˆ†æï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åºåˆ—åŒ–å¯¹flatMapæ€§èƒ½çš„å½±å“</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SerializationImpact</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">analyzeSerializationCost</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// å¤æ‚å¯¹è±¡çš„åºåˆ—åŒ–æˆæœ¬</span></span><br><span class="line">        JavaRDD&lt;ComplexObject&gt; complexRDD = sc.parallelize(generateComplexObjects());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// äº§ç”Ÿå¤§é‡å°å¯¹è±¡çš„flatMapæ“ä½œ</span></span><br><span class="line">        JavaRDD&lt;SimpleObject&gt; flattened = complexRDD.flatMap(complex -&gt; </span><br><span class="line">            complex.getSubObjects().iterator());</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// æ¯ä¸ªComplexObjectå¯èƒ½äº§ç”Ÿæ•°ç™¾ä¸ªSimpleObject</span></span><br><span class="line">        <span class="comment">// åºåˆ—åŒ–æˆæœ¬ï¼šComplexObjectåºåˆ—åŒ– + å¤§é‡SimpleObjectåºåˆ—åŒ–</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä¼˜åŒ–ç­–ç•¥ï¼š</span></span><br><span class="line">        <span class="comment">// 1. ä½¿ç”¨Kryoåºåˆ—åŒ–å™¨</span></span><br><span class="line">        <span class="comment">// 2. é¿å…äº§ç”Ÿè¿‡å¤šå°å¯¹è±¡</span></span><br><span class="line">        <span class="comment">// 3. è€ƒè™‘ä½¿ç”¨åŸå§‹ç±»å‹</span></span><br><span class="line">        </span><br><span class="line">        JavaRDD&lt;String&gt; optimizedFlattened = complexRDD.flatMap(complex -&gt; </span><br><span class="line">            complex.getSubObjects().stream()</span><br><span class="line">                .map(SimpleObject::toString)  <span class="comment">// è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œå‡å°‘åºåˆ—åŒ–å¼€é”€</span></span><br><span class="line">                .iterator());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-3-4-å¸¸è§åº”ç”¨æ¨¡å¼ä¸æœ€ä½³å®è·µ"><a href="#2-3-4-å¸¸è§åº”ç”¨æ¨¡å¼ä¸æœ€ä½³å®è·µ" class="headerlink" title="2.3.4 å¸¸è§åº”ç”¨æ¨¡å¼ä¸æœ€ä½³å®è·µ"></a>2.3.4 å¸¸è§åº”ç”¨æ¨¡å¼ä¸æœ€ä½³å®è·µ</h4><p><strong>æ–‡æœ¬å¤„ç†æ¨¡å¼ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç»å…¸çš„æ–‡æœ¬å¤„ç†åº”ç”¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TextProcessingPatterns</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demonstrateTextProcessing</span><span class="params">()</span> &#123;</span><br><span class="line">        JavaRDD&lt;String&gt; documents = sc.textFile(<span class="string">&quot;documents.txt&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ¨¡å¼1ï¼šåˆ†è¯</span></span><br><span class="line">        JavaRDD&lt;String&gt; words = documents.flatMap(doc -&gt; </span><br><span class="line">            Arrays.stream(doc.split(<span class="string">&quot;\\W+&quot;</span>))</span><br><span class="line">                .filter(word -&gt; !word.isEmpty())</span><br><span class="line">                .map(String::toLowerCase)</span><br><span class="line">                .iterator());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ¨¡å¼2ï¼šN-gramç”Ÿæˆ</span></span><br><span class="line">        JavaRDD&lt;String&gt; bigrams = documents.flatMap(doc -&gt; &#123;</span><br><span class="line">            String[] words = doc.split(<span class="string">&quot;\\W+&quot;</span>);</span><br><span class="line">            List&lt;String&gt; bigrams = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; words.length - <span class="number">1</span>; i++) &#123;</span><br><span class="line">                bigrams.add(words[i] + <span class="string">&quot; &quot;</span> + words[i + <span class="number">1</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> bigrams.iterator();</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ¨¡å¼3ï¼šå¥å­åˆ†å‰²</span></span><br><span class="line">        JavaRDD&lt;String&gt; sentences = documents.flatMap(doc -&gt; </span><br><span class="line">            Arrays.stream(doc.split(<span class="string">&quot;[.!?]+&quot;</span>))</span><br><span class="line">                .map(String::trim)</span><br><span class="line">                .filter(sentence -&gt; !sentence.isEmpty())</span><br><span class="line">                .iterator());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ•°æ®æ‰å¹³åŒ–æ¨¡å¼ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åµŒå¥—æ•°æ®ç»“æ„çš„æ‰å¹³åŒ–</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataFlatteningPatterns</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demonstrateDataFlattening</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// JSONæ•°ç»„æ‰å¹³åŒ–</span></span><br><span class="line">        JavaRDD&lt;String&gt; jsonArrays = sc.parallelize(Arrays.asList(</span><br><span class="line">            <span class="string">&quot;[\&quot;a\&quot;, \&quot;b\&quot;, \&quot;c\&quot;]&quot;</span>,</span><br><span class="line">            <span class="string">&quot;[\&quot;d\&quot;, \&quot;e\&quot;]&quot;</span>,</span><br><span class="line">            <span class="string">&quot;[\&quot;f\&quot;, \&quot;g\&quot;, \&quot;h\&quot;, \&quot;i\&quot;]&quot;</span></span><br><span class="line">        ));</span><br><span class="line">        </span><br><span class="line">        JavaRDD&lt;String&gt; flattenedElements = jsonArrays.flatMap(jsonArray -&gt; &#123;</span><br><span class="line">            <span class="comment">// è§£æJSONæ•°ç»„å¹¶è¿”å›æ‰€æœ‰å…ƒç´ </span></span><br><span class="line">            List&lt;String&gt; elements = parseJsonArray(jsonArray);</span><br><span class="line">            <span class="keyword">return</span> elements.iterator();</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å…³ç³»æ•°æ®æ‰å¹³åŒ–</span></span><br><span class="line">        JavaRDD&lt;Customer&gt; customers = sc.parallelize(getCustomers());</span><br><span class="line">        JavaRDD&lt;Order&gt; allOrders = customers.flatMap(customer -&gt; </span><br><span class="line">            customer.getOrders().iterator());  <span class="comment">// æå–æ‰€æœ‰å®¢æˆ·çš„æ‰€æœ‰è®¢å•</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ‰§è¡ŒåŸç†æ·±åº¦å‰–æï¼š</strong></p><ol><li><strong>çª„ä¾èµ–ç‰¹æ€§</strong>ï¼šç»´æŒåˆ†åŒºé—´çš„ç‹¬ç«‹æ€§ï¼Œæ— éœ€Shuffleæ“ä½œ</li><li><strong>æ•°æ®é‡åŠ¨æ€å˜åŒ–</strong>ï¼šè¾“å‡ºæ•°æ®é‡å¯èƒ½æ¯”è¾“å…¥å¤§å¾ˆå¤šå€</li><li><strong>æµå¼å¤„ç†ä¼˜åŠ¿</strong>ï¼šè¾¹å¤„ç†è¾¹è¾“å‡ºï¼Œå‡å°‘å†…å­˜å‹åŠ›å³°å€¼</li><li><strong>è¿­ä»£å™¨åµŒå¥—ç®¡ç†</strong>ï¼šé«˜æ•ˆå¤„ç†ä¸€å¯¹å¤šçš„æ˜ å°„å…³ç³»</li></ol><p><strong>å…³é”®æ€§èƒ½è€ƒè™‘ï¼š</strong></p><ul><li>è†¨èƒ€æ¯”ä¾‹ç›´æ¥å½±å“ä¸‹æ¸¸æ“ä½œçš„æ€§èƒ½</li><li>åºåˆ—åŒ–å¼€é”€éšè¾“å‡ºå¯¹è±¡æ•°é‡çº¿æ€§å¢é•¿</li><li>å†…å­˜ä½¿ç”¨å–å†³äºä¸­é—´è¿­ä»£å™¨çš„å®ç°æ–¹å¼</li><li>CPUå¼€é”€ä¸»è¦é›†ä¸­åœ¨ç”¨æˆ·å‡½æ•°çš„æ‰§è¡Œä¸Š</li></ul><p><strong>æœ€ä½³å®è·µå»ºè®®ï¼š</strong></p><ul><li>ä½¿ç”¨æƒ°æ€§è¿­ä»£å™¨é¿å…å†…å­˜å‹åŠ›</li><li>ä¼˜å…ˆä½¿ç”¨åŸå§‹ç±»å‹å‡å°‘åºåˆ—åŒ–å¼€é”€</li><li>åˆç†æ§åˆ¶æ•°æ®è†¨èƒ€æ¯”ä¾‹</li><li>åœ¨é«˜è†¨èƒ€åœºæ™¯ä¸‹è€ƒè™‘ä½¿ç”¨mapPartitionsä¼˜åŒ–</li></ul><p><strong>å®é™…åº”ç”¨åœºæ™¯ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¯é¢‘ç»Ÿè®¡çš„ç»å…¸ç”¨æ³•</span></span><br><span class="line">JavaRDD&lt;String&gt; textRDD = sc.textFile(<span class="string">&quot;input.txt&quot;</span>);</span><br><span class="line">JavaRDD&lt;String&gt; words = textRDD.flatMap(line -&gt; Arrays.asList(line.split(<span class="string">&quot;\\s+&quot;</span>)).iterator());</span><br><span class="line">JavaPairRDD&lt;String, Integer&gt; wordCounts = words.mapToPair(word -&gt; <span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(word, <span class="number">1</span>))</span><br><span class="line">    .reduceByKey((a, b) -&gt; a + b);</span><br></pre></td></tr></table></figure><p><strong>å†…å­˜ä¼˜åŒ–æŠ€å·§ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨è¿­ä»£å™¨é¿å…å†…å­˜æº¢å‡º</span></span><br><span class="line">JavaRDD&lt;String&gt; memoryOptimized = rdd.flatMap(line -&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Iterator</span>&lt;String&gt;() &#123;</span><br><span class="line">        <span class="keyword">private</span> String[] words = line.split(<span class="string">&quot;\\s+&quot;</span>);</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasNext</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> index &lt; words.length;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> words[index++];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="2-4-ç®—å­é“¾ä¼˜åŒ–æœºåˆ¶æ·±åº¦å‰–æ"><a href="#2-4-ç®—å­é“¾ä¼˜åŒ–æœºåˆ¶æ·±åº¦å‰–æ" class="headerlink" title="2.4 ç®—å­é“¾ä¼˜åŒ–æœºåˆ¶æ·±åº¦å‰–æ"></a>2.4 ç®—å­é“¾ä¼˜åŒ–æœºåˆ¶æ·±åº¦å‰–æ</h3><p>ç®—å­é“¾ï¼ˆOperator Chainï¼‰ä¼˜åŒ–æ˜¯Sparkæå‡æ€§èƒ½çš„é‡è¦æœºåˆ¶ï¼Œé€šè¿‡å°†å¤šä¸ªçª„ä¾èµ–ç®—å­åˆå¹¶ä¸ºå•ä¸ªTaskæ‰§è¡Œï¼Œæ˜¾è‘—å‡å°‘äº†ä»»åŠ¡è°ƒåº¦å¼€é”€å’Œæ•°æ®åºåˆ—åŒ–æˆæœ¬ã€‚</p><h4 id="2-4-1-ç®—å­é“¾çš„å½¢æˆæ¡ä»¶"><a href="#2-4-1-ç®—å­é“¾çš„å½¢æˆæ¡ä»¶" class="headerlink" title="2.4.1 ç®—å­é“¾çš„å½¢æˆæ¡ä»¶"></a>2.4.1 ç®—å­é“¾çš„å½¢æˆæ¡ä»¶</h4><p><strong>Pipelineä¼˜åŒ–çš„åˆ¤æ–­é€»è¾‘ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç®—å­é“¾ä¼˜åŒ–çš„æ ¸å¿ƒåˆ¤æ–­æœºåˆ¶</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OperatorChainOptimizer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">canChain</span><span class="params">(RDD&lt;?&gt; parent, RDD&lt;?&gt; child)</span> &#123;</span><br><span class="line">        <span class="comment">// æ¡ä»¶1ï¼šå¿…é¡»æ˜¯çª„ä¾èµ–</span></span><br><span class="line">        <span class="keyword">if</span> (!isNarrowDependency(child, parent)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ¡ä»¶2ï¼šåˆ†åŒºç»“æ„å¿…é¡»å…¼å®¹</span></span><br><span class="line">        <span class="keyword">if</span> (!hasCompatiblePartitioning(parent, child)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ¡ä»¶3ï¼šæ²¡æœ‰ç¼“å­˜æˆ–æ£€æŸ¥ç‚¹æ“ä½œ</span></span><br><span class="line">        <span class="keyword">if</span> (parent.getStorageLevel() != StorageLevel.NONE || </span><br><span class="line">            parent.isCheckpointed()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ¡ä»¶4ï¼šæ²¡æœ‰æ˜¾å¼çš„åˆ†åŒºæ“ä½œ</span></span><br><span class="line">        <span class="keyword">if</span> (hasExplicitPartitioning(child)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ¡ä»¶5ï¼šå†…å­˜å’ŒCPUèµ„æºå……è¶³</span></span><br><span class="line">        <span class="keyword">return</span> hasAdequateResources(parent, child);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isNarrowDependency</span><span class="params">(RDD&lt;?&gt; child, RDD&lt;?&gt; parent)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Dependency&lt;?&gt; dep : child.dependencies()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (dep.rdd() == parent &amp;&amp; dep <span class="keyword">instanceof</span> ShuffleDependency) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// å‘ç°å®½ä¾èµ–</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">hasCompatiblePartitioning</span><span class="params">(RDD&lt;?&gt; parent, RDD&lt;?&gt; child)</span> &#123;</span><br><span class="line">        <span class="comment">// æ£€æŸ¥åˆ†åŒºæ•°é‡å’Œåˆ†åŒºå™¨æ˜¯å¦å…¼å®¹</span></span><br><span class="line">        <span class="keyword">if</span> (parent.getNumPartitions() != child.getNumPartitions()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ£€æŸ¥åˆ†åŒºå™¨å…¼å®¹æ€§</span></span><br><span class="line">        <span class="type">Partitioner</span> <span class="variable">parentPartitioner</span> <span class="operator">=</span> parent.partitioner().orElse(<span class="literal">null</span>);</span><br><span class="line">        <span class="type">Partitioner</span> <span class="variable">childPartitioner</span> <span class="operator">=</span> child.partitioner().orElse(<span class="literal">null</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> Objects.equals(parentPartitioner, childPartitioner);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-4-2-ç®—å­é“¾çš„æ‰§è¡Œæœºåˆ¶"><a href="#2-4-2-ç®—å­é“¾çš„æ‰§è¡Œæœºåˆ¶" class="headerlink" title="2.4.2 ç®—å­é“¾çš„æ‰§è¡Œæœºåˆ¶"></a>2.4.2 ç®—å­é“¾çš„æ‰§è¡Œæœºåˆ¶</h4><p><strong>é“¾å¼æ‰§è¡Œçš„å†…éƒ¨å®ç°ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç®—å­é“¾æ‰§è¡Œå™¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChainedOperatorExecutor</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Function&lt;Iterator&lt;?&gt;, Iterator&lt;?&gt;&gt;&gt; operators;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TaskContext context;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ChainedOperatorExecutor</span><span class="params">(List&lt;RDD&lt;?&gt;&gt; chainedRDDs, TaskContext context)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.context = context;</span><br><span class="line">        <span class="built_in">this</span>.operators = buildOperatorChain(chainedRDDs);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> List&lt;Function&lt;Iterator&lt;?&gt;, Iterator&lt;?&gt;&gt;&gt; buildOperatorChain(List&lt;RDD&lt;?&gt;&gt; rdds) &#123;</span><br><span class="line">        List&lt;Function&lt;Iterator&lt;?&gt;, Iterator&lt;?&gt;&gt;&gt; chain = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (RDD&lt;?&gt; rdd : rdds) &#123;</span><br><span class="line">            Function&lt;Iterator&lt;?&gt;, Iterator&lt;?&gt;&gt; op = createOperatorFunction(rdd);</span><br><span class="line">            chain.add(op);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> chain;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Iterator&lt;T&gt; <span class="title function_">execute</span><span class="params">(Partition partition)</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–ç¬¬ä¸€ä¸ªRDDçš„æ•°æ®è¿­ä»£å™¨</span></span><br><span class="line">        RDD&lt;?&gt; firstRDD = getFirstRDD();</span><br><span class="line">        Iterator&lt;?&gt; currentIterator = firstRDD.iterator(partition, context);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä¾æ¬¡åº”ç”¨é“¾ä¸­çš„æ¯ä¸ªç®—å­</span></span><br><span class="line">        <span class="keyword">for</span> (Function&lt;Iterator&lt;?&gt;, Iterator&lt;?&gt;&gt; operator : operators) &#123;</span><br><span class="line">            currentIterator = operator.apply(currentIterator);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// æ€§èƒ½ç›‘æ§ï¼šè®°å½•æ¯ä¸ªç®—å­çš„å¤„ç†æ—¶é—´</span></span><br><span class="line">            <span class="keyword">if</span> (context.taskMetrics() != <span class="literal">null</span>) &#123;</span><br><span class="line">                recordOperatorMetrics(operator, currentIterator);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> (Iterator&lt;T&gt;) currentIterator;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Function&lt;Iterator&lt;?&gt;, Iterator&lt;?&gt;&gt; createOperatorFunction(RDD&lt;?&gt; rdd) &#123;</span><br><span class="line">        <span class="keyword">if</span> (rdd <span class="keyword">instanceof</span> MappedRDD) &#123;</span><br><span class="line">            <span class="keyword">return</span> iter -&gt; <span class="keyword">new</span> <span class="title class_">MapIterator</span>&lt;&gt;(iter, ((MappedRDD&lt;?, ?&gt;) rdd).getFunction());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rdd <span class="keyword">instanceof</span> FilteredRDD) &#123;</span><br><span class="line">            <span class="keyword">return</span> iter -&gt; <span class="keyword">new</span> <span class="title class_">FilterIterator</span>&lt;&gt;(iter, ((FilteredRDD&lt;?&gt;) rdd).getPredicate());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rdd <span class="keyword">instanceof</span> FlatMappedRDD) &#123;</span><br><span class="line">            <span class="keyword">return</span> iter -&gt; <span class="keyword">new</span> <span class="title class_">FlatMapIterator</span>&lt;&gt;(iter, ((FlatMappedRDD&lt;?, ?&gt;) rdd).getFunction());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>(<span class="string">&quot;Unsupported RDD type: &quot;</span> + rdd.getClass());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-4-3-ä»£ç ç”Ÿæˆä¼˜åŒ–"><a href="#2-4-3-ä»£ç ç”Ÿæˆä¼˜åŒ–" class="headerlink" title="2.4.3 ä»£ç ç”Ÿæˆä¼˜åŒ–"></a>2.4.3 ä»£ç ç”Ÿæˆä¼˜åŒ–</h4><p><strong>Codegenï¼ˆä»£ç ç”Ÿæˆï¼‰æœºåˆ¶ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Sparkçš„ä»£ç ç”Ÿæˆä¼˜åŒ–</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CodegenOptimizer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">generateOptimizedCode</span><span class="params">(List&lt;RDD&lt;?&gt;&gt; operatorChain)</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">codeBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ç”Ÿæˆæ–¹æ³•å¤´</span></span><br><span class="line">        codeBuilder.append(<span class="string">&quot;public Iterator&lt;Object&gt; processPartition(Iterator&lt;Object&gt; input) &#123;\n&quot;</span>);</span><br><span class="line">        codeBuilder.append(<span class="string">&quot;    return new Iterator&lt;Object&gt;() &#123;\n&quot;</span>);</span><br><span class="line">        codeBuilder.append(<span class="string">&quot;        private Object nextValue = null;\n&quot;</span>);</span><br><span class="line">        codeBuilder.append(<span class="string">&quot;        private boolean hasNextValue = false;\n&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ç”ŸæˆhasNextæ–¹æ³•</span></span><br><span class="line">        generateHasNextMethod(codeBuilder, operatorChain);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ç”Ÿæˆnextæ–¹æ³•</span></span><br><span class="line">        generateNextMethod(codeBuilder, operatorChain);</span><br><span class="line">        </span><br><span class="line">        codeBuilder.append(<span class="string">&quot;    &#125;;\n&quot;</span>);</span><br><span class="line">        codeBuilder.append(<span class="string">&quot;&#125;\n&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> codeBuilder.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">generateHasNextMethod</span><span class="params">(StringBuilder codeBuilder, List&lt;RDD&lt;?&gt;&gt; chain)</span> &#123;</span><br><span class="line">        codeBuilder.append(<span class="string">&quot;        @Override\n&quot;</span>);</span><br><span class="line">        codeBuilder.append(<span class="string">&quot;        public boolean hasNext() &#123;\n&quot;</span>);</span><br><span class="line">        codeBuilder.append(<span class="string">&quot;            if (hasNextValue) return true;\n&quot;</span>);</span><br><span class="line">        codeBuilder.append(<span class="string">&quot;            \n&quot;</span>);</span><br><span class="line">        codeBuilder.append(<span class="string">&quot;            while (input.hasNext()) &#123;\n&quot;</span>);</span><br><span class="line">        codeBuilder.append(<span class="string">&quot;                Object current = input.next();\n&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä¸ºæ¯ä¸ªç®—å­ç”Ÿæˆå†…è”ä»£ç </span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; chain.size(); i++) &#123;</span><br><span class="line">            RDD&lt;?&gt; rdd = chain.get(i);</span><br><span class="line">            generateInlineOperator(codeBuilder, rdd, <span class="string">&quot;current&quot;</span>, <span class="string">&quot;result&quot;</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        codeBuilder.append(<span class="string">&quot;                nextValue = result&quot;</span> + (chain.size() - <span class="number">1</span>) + <span class="string">&quot;;\n&quot;</span>);</span><br><span class="line">        codeBuilder.append(<span class="string">&quot;                hasNextValue = true;\n&quot;</span>);</span><br><span class="line">        codeBuilder.append(<span class="string">&quot;                return true;\n&quot;</span>);</span><br><span class="line">        codeBuilder.append(<span class="string">&quot;            &#125;\n&quot;</span>);</span><br><span class="line">        codeBuilder.append(<span class="string">&quot;            return false;\n&quot;</span>);</span><br><span class="line">        codeBuilder.append(<span class="string">&quot;        &#125;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">generateInlineOperator</span><span class="params">(StringBuilder codeBuilder, RDD&lt;?&gt; rdd, </span></span><br><span class="line"><span class="params">                                       String inputVar, String outputVar)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (rdd <span class="keyword">instanceof</span> MappedRDD) &#123;</span><br><span class="line">            <span class="comment">// å†…è”mapæ“ä½œ</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">functionCode</span> <span class="operator">=</span> extractFunctionCode(((MappedRDD&lt;?, ?&gt;) rdd).getFunction());</span><br><span class="line">            codeBuilder.append(<span class="string">&quot;                Object &quot;</span>).append(outputVar)</span><br><span class="line">                      .append(<span class="string">&quot; = &quot;</span>).append(functionCode).append(<span class="string">&quot;(&quot;</span>).append(inputVar).append(<span class="string">&quot;);\n&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rdd <span class="keyword">instanceof</span> FilteredRDD) &#123;</span><br><span class="line">            <span class="comment">// å†…è”filteræ“ä½œ</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">predicateCode</span> <span class="operator">=</span> extractPredicateCode(((FilteredRDD&lt;?&gt;) rdd).getPredicate());</span><br><span class="line">            codeBuilder.append(<span class="string">&quot;                if (!&quot;</span>).append(predicateCode)</span><br><span class="line">                      .append(<span class="string">&quot;(&quot;</span>).append(inputVar).append(<span class="string">&quot;)) continue;\n&quot;</span>);</span><br><span class="line">            codeBuilder.append(<span class="string">&quot;                Object &quot;</span>).append(outputVar)</span><br><span class="line">                      .append(<span class="string">&quot; = &quot;</span>).append(inputVar).append(<span class="string">&quot;;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-4-4-æ€§èƒ½ä¼˜åŒ–æ•ˆæœåˆ†æ"><a href="#2-4-4-æ€§èƒ½ä¼˜åŒ–æ•ˆæœåˆ†æ" class="headerlink" title="2.4.4 æ€§èƒ½ä¼˜åŒ–æ•ˆæœåˆ†æ"></a>2.4.4 æ€§èƒ½ä¼˜åŒ–æ•ˆæœåˆ†æ</h4><p><strong>ç®—å­é“¾ä¼˜åŒ–çš„æ€§èƒ½æå‡ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç®—å­é“¾æ€§èƒ½æµ‹è¯•</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChainPerformanceTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testChainOptimization</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">JavaSparkContext</span> <span class="variable">sc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JavaSparkContext</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æµ‹è¯•æ•°æ®ï¼š1000ä¸‡æ¡è®°å½•</span></span><br><span class="line">        JavaRDD&lt;Integer&gt; data = sc.parallelize(IntStream.range(<span class="number">1</span>, <span class="number">10000001</span>)</span><br><span class="line">            .boxed().collect(Collectors.toList()), <span class="number">100</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åœºæ™¯1ï¼šæœªä¼˜åŒ–çš„å¤šä¸ªç‹¬ç«‹æ“ä½œ</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime1</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        JavaRDD&lt;Integer&gt; step1 = data.map(x -&gt; x * <span class="number">2</span>);</span><br><span class="line">        step1.cache(); <span class="comment">// å¼ºåˆ¶materializeï¼Œé˜»æ­¢é“¾ä¼˜åŒ–</span></span><br><span class="line">        JavaRDD&lt;Integer&gt; step2 = step1.filter(x -&gt; x &gt; <span class="number">1000</span>);</span><br><span class="line">        step2.cache();</span><br><span class="line">        JavaRDD&lt;Integer&gt; step3 = step2.map(x -&gt; x + <span class="number">100</span>);</span><br><span class="line">        <span class="type">long</span> <span class="variable">result1</span> <span class="operator">=</span> step3.count();</span><br><span class="line">        <span class="type">long</span> <span class="variable">time1</span> <span class="operator">=</span> System.currentTimeMillis() - startTime1;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åœºæ™¯2ï¼šç®—å­é“¾ä¼˜åŒ–ç‰ˆæœ¬</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime2</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        JavaRDD&lt;Integer&gt; chained = data</span><br><span class="line">            .map(x -&gt; x * <span class="number">2</span>)</span><br><span class="line">            .filter(x -&gt; x &gt; <span class="number">1000</span>)</span><br><span class="line">            .map(x -&gt; x + <span class="number">100</span>);</span><br><span class="line">        <span class="type">long</span> <span class="variable">result2</span> <span class="operator">=</span> chained.count();</span><br><span class="line">        <span class="type">long</span> <span class="variable">time2</span> <span class="operator">=</span> System.currentTimeMillis() - startTime2;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ€§èƒ½å¯¹æ¯”</span></span><br><span class="line">        System.out.println(<span class="string">&quot;=== ç®—å­é“¾ä¼˜åŒ–æ€§èƒ½å¯¹æ¯” ===&quot;</span>);</span><br><span class="line">        System.out.printf(<span class="string">&quot;æœªä¼˜åŒ–ç‰ˆæœ¬: %d ms, ç»“æœ: %d%n&quot;</span>, time1, result1);</span><br><span class="line">        System.out.printf(<span class="string">&quot;ç®—å­é“¾ä¼˜åŒ–: %d ms, ç»“æœ: %d%n&quot;</span>, time2, result2);</span><br><span class="line">        System.out.printf(<span class="string">&quot;æ€§èƒ½æå‡: %.1fx%n&quot;</span>, (<span class="type">double</span>) time1 / time2);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆ†æä»»åŠ¡æ•°é‡</span></span><br><span class="line">        analyzeTaskCount(sc);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">analyzeTaskCount</span><span class="params">(JavaSparkContext sc)</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–æœ€åä¸€ä¸ªJobçš„ä»»åŠ¡ç»Ÿè®¡</span></span><br><span class="line">        <span class="type">SparkContext</span> <span class="variable">sparkContext</span> <span class="operator">=</span> sc.sc();</span><br><span class="line">        <span class="type">StatusStore</span> <span class="variable">statusStore</span> <span class="operator">=</span> sparkContext.statusStore();</span><br><span class="line">        </span><br><span class="line">        List&lt;JobData&gt; jobs = statusStore.jobsList(<span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (!jobs.isEmpty()) &#123;</span><br><span class="line">            <span class="type">JobData</span> <span class="variable">lastJob</span> <span class="operator">=</span> jobs.get(jobs.size() - <span class="number">1</span>);</span><br><span class="line">            System.out.printf(<span class="string">&quot;æœ€åä¸€ä¸ªJobçš„Stageæ•°é‡: %d%n&quot;</span>, lastJob.stageIds().size());</span><br><span class="line">            System.out.printf(<span class="string">&quot;æ€»Taskæ•°é‡: %d%n&quot;</span>, lastJob.numTasks());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç®—å­é“¾ä¼˜åŒ–çš„å…³é”®æ”¶ç›Šï¼š</strong></p><ol><li><strong>å‡å°‘Taskæ•°é‡</strong>ï¼šå¤šä¸ªç®—å­åˆå¹¶ä¸ºå•ä¸ªTaskï¼Œå‡å°‘è°ƒåº¦å¼€é”€</li><li><strong>æ¶ˆé™¤ä¸­é—´åºåˆ—åŒ–</strong>ï¼šæ•°æ®åœ¨å†…å­˜ä¸­ç›´æ¥ä¼ é€’ï¼Œæ— éœ€åºåˆ—åŒ–</li><li><strong>æé«˜CPUç¼“å­˜æ•ˆç‡</strong>ï¼šè¿ç»­å¤„ç†æé«˜ç¼“å­˜å‘½ä¸­ç‡</li><li><strong>å‡å°‘å†…å­˜åˆ†é…</strong>ï¼šé¿å…åˆ›å»ºä¸­é—´RDDå¯¹è±¡</li></ol><p><strong>ä¼˜åŒ–æ•ˆæœé‡åŒ–åˆ†æï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç®—å­é“¾ä¼˜åŒ–æ•ˆæœé‡åŒ–</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChainOptimizationMetrics</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">measureOptimizationEffects</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// æµ‹è¯•åœºæ™¯ï¼š5ä¸ªè¿ç»­çš„mapæ“ä½œ</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å…³é”®æŒ‡æ ‡å¯¹æ¯”ï¼š</span></span><br><span class="line">        <span class="comment">// 1. Taskæ•°é‡ï¼š5ä¸ª -&gt; 1ä¸ª (å‡å°‘80%)</span></span><br><span class="line">        <span class="comment">// 2. åºåˆ—åŒ–æ¬¡æ•°ï¼š4æ¬¡ä¸­é—´åºåˆ—åŒ– -&gt; 0æ¬¡ (å‡å°‘100%)</span></span><br><span class="line">        <span class="comment">// 3. å†…å­˜åˆ†é…ï¼š5ä¸ªRDDå¯¹è±¡ -&gt; 1ä¸ªRDDå¯¹è±¡ (å‡å°‘80%)</span></span><br><span class="line">        <span class="comment">// 4. GCå‹åŠ›ï¼šæ˜¾è‘—å‡å°‘ä¸´æ—¶å¯¹è±¡åˆ›å»º</span></span><br><span class="line">        <span class="comment">// 5. æ‰§è¡Œæ—¶é—´ï¼šé€šå¸¸æå‡2-5å€</span></span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;ç®—å­é“¾ä¼˜åŒ–æ•ˆæœç»Ÿè®¡ï¼š&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;- Taskè°ƒåº¦å¼€é”€å‡å°‘ï¼š80-90%&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;- ä¸­é—´æ•°æ®åºåˆ—åŒ–æ¶ˆé™¤ï¼š100%&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;- å†…å­˜åˆ†é…å‡å°‘ï¼š60-80%&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;- æ•´ä½“æ€§èƒ½æå‡ï¼š2-5å€&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ç§ç®—å­é“¾ä¼˜åŒ–æ˜¯Sparkæ€§èƒ½ä¼˜å¼‚çš„é‡è¦åŸå› ä¹‹ä¸€ï¼Œå®ƒåœ¨ä¿æŒç¼–ç¨‹ç®€æ´æ€§çš„åŒæ—¶ï¼Œé€šè¿‡åº•å±‚çš„è‡ªåŠ¨ä¼˜åŒ–è·å¾—äº†æ¥è¿‘æ‰‹å·¥ä¼˜åŒ–çš„æ€§èƒ½ã€‚ç†è§£è¿™ä¸€æœºåˆ¶æœ‰åŠ©äºæˆ‘ä»¬ç¼–å†™æ›´é«˜æ•ˆçš„Sparkä»£ç ã€‚</p><h2 id="ä¸‰ã€Shuffleæœºåˆ¶æ·±åº¦è§£æ"><a href="#ä¸‰ã€Shuffleæœºåˆ¶æ·±åº¦è§£æ" class="headerlink" title="ä¸‰ã€Shuffleæœºåˆ¶æ·±åº¦è§£æ"></a>ä¸‰ã€Shuffleæœºåˆ¶æ·±åº¦è§£æ</h2><p>Shuffleæ˜¯Sparkåˆ†å¸ƒå¼è®¡ç®—çš„æ ¸å¿ƒæœºåˆ¶ï¼Œä¹Ÿæ˜¯æ€§èƒ½ä¼˜åŒ–çš„å…³é”®æ‰€åœ¨ã€‚ç†è§£Shuffleçš„å·¥ä½œåŸç†ï¼Œå¯¹äºç¼–å†™é«˜æ•ˆçš„Sparkåº”ç”¨è‡³å…³é‡è¦ã€‚</p><h3 id="3-1-ä»€ä¹ˆæ˜¯Shuffleï¼Ÿ"><a href="#3-1-ä»€ä¹ˆæ˜¯Shuffleï¼Ÿ" class="headerlink" title="3.1 ä»€ä¹ˆæ˜¯Shuffleï¼Ÿ"></a>3.1 ä»€ä¹ˆæ˜¯Shuffleï¼Ÿ</h3><p>Shuffleæ˜¯Sparkä¸­æœ€æ˜‚è´µçš„æ“ä½œï¼Œå®ƒé‡æ–°ç»„ç»‡æ•°æ®åˆ†å¸ƒï¼Œä½¿å¾—ç›¸å…³æ•°æ®èƒ½å¤Ÿèšé›†åˆ°åŒä¸€åˆ†åŒºè¿›è¡Œåç»­è®¡ç®—ã€‚</p><h4 id="3-1-1-Shuffleçš„è§¦å‘æ¡ä»¶"><a href="#3-1-1-Shuffleçš„è§¦å‘æ¡ä»¶" class="headerlink" title="3.1.1 Shuffleçš„è§¦å‘æ¡ä»¶"></a>3.1.1 Shuffleçš„è§¦å‘æ¡ä»¶</h4><p><strong>å®½ä¾èµ–ç®—å­è§¦å‘Shuffleï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¸¸è§çš„è§¦å‘Shuffleçš„ç®—å­</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShuffleTriggeringOperators</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demonstrateShuffleTriggers</span><span class="params">()</span> &#123;</span><br><span class="line">        JavaPairRDD&lt;String, Integer&gt; data = sc.parallelizePairs(generateKeyValuePairs());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. èšåˆæ“ä½œ</span></span><br><span class="line">        JavaPairRDD&lt;String, Integer&gt; reduced = data.reduceByKey((a, b) -&gt; a + b);  <span class="comment">// Shuffle</span></span><br><span class="line">        JavaPairRDD&lt;String, Iterable&lt;Integer&gt;&gt; grouped = data.groupByKey();        <span class="comment">// Shuffle</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. é‡åˆ†åŒºæ“ä½œ</span></span><br><span class="line">        JavaRDD&lt;String&gt; repartitioned = data.keys().repartition(<span class="number">10</span>);               <span class="comment">// Shuffle</span></span><br><span class="line">        JavaRDD&lt;String&gt; coalesced = data.keys().coalesce(<span class="number">5</span>);                       <span class="comment">// å¯èƒ½Shuffle</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. Joinæ“ä½œ</span></span><br><span class="line">        JavaPairRDD&lt;String, Tuple2&lt;Integer, String&gt;&gt; joined = </span><br><span class="line">            data.join(otherData);                                                   <span class="comment">// Shuffle</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. æ’åºæ“ä½œ</span></span><br><span class="line">        JavaPairRDD&lt;String, Integer&gt; sorted = data.sortByKey();                    <span class="comment">// Shuffle</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5. å»é‡æ“ä½œ</span></span><br><span class="line">        JavaRDD&lt;String&gt; distinct = data.keys().distinct();                         <span class="comment">// Shuffle</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Shuffleçš„æœ¬è´¨æœºåˆ¶ï¼š</strong></p><ul><li><strong>æ•°æ®é‡åˆ†å¸ƒ</strong>ï¼šå°†æ•°æ®æŒ‰ç…§æŸç§è§„åˆ™é‡æ–°åˆ†å¸ƒåˆ°ä¸åŒçš„åˆ†åŒº</li><li><strong>è·¨èŠ‚ç‚¹ä¼ è¾“</strong>ï¼šæ•°æ®éœ€è¦åœ¨ç½‘ç»œä¸­è¿›è¡Œä¼ è¾“</li><li><strong>å¤šé˜¶æ®µå¤„ç†</strong>ï¼šåˆ†ä¸ºShuffle Writeå’ŒShuffle Readä¸¤ä¸ªé˜¶æ®µ</li></ul><h4 id="3-1-2-Shuffleçš„ç³»ç»Ÿæ¶æ„"><a href="#3-1-2-Shuffleçš„ç³»ç»Ÿæ¶æ„" class="headerlink" title="3.1.2 Shuffleçš„ç³»ç»Ÿæ¶æ„"></a>3.1.2 Shuffleçš„ç³»ç»Ÿæ¶æ„</h4><pre class="mermaid">graph TD    A[Map Stage<br/>Shuffle Write] -->|ç½‘ç»œä¼ è¾“| B[Reduce Stage<br/>Shuffle Read]        subgraph "Shuffle Write"    A1[åˆ†åŒºå™¨<br/>Partitioner]    A2[æœ¬åœ°èšåˆ<br/>Combiner]    A3[æ’åº<br/>Sorter]    A4[ç£ç›˜å†™å…¥<br/>Disk Writer]    end        subgraph "Shuffle Read"    B1[æ•°æ®æ‹‰å–<br/>Data Fetch]    B2[æ•°æ®åˆå¹¶<br/>Data Merge]    B3[ååºåˆ—åŒ–<br/>Deserialize]    end</pre><h4 id="3-1-3-Shuffleçš„æˆæœ¬åˆ†æ"><a href="#3-1-3-Shuffleçš„æˆæœ¬åˆ†æ" class="headerlink" title="3.1.3 Shuffleçš„æˆæœ¬åˆ†æ"></a>3.1.3 Shuffleçš„æˆæœ¬åˆ†æ</h4><p><strong>è¯¦ç»†æˆæœ¬æ„æˆï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Shuffleæˆæœ¬åˆ†æå·¥å…·</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShuffleCostAnalyzer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">analyzeCosts</span><span class="params">(JavaPairRDD&lt;String, Integer&gt; rdd)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. ç½‘ç»œä¼ è¾“æˆæœ¬</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">dataSize</span> <span class="operator">=</span> estimateDataSize(rdd);</span><br><span class="line">        <span class="type">double</span> <span class="variable">networkBandwidth</span> <span class="operator">=</span> <span class="number">1000.0</span>; <span class="comment">// MB/s</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">networkCost</span> <span class="operator">=</span> dataSize / networkBandwidth;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. ç£ç›˜IOæˆæœ¬</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">diskWriteSpeed</span> <span class="operator">=</span> <span class="number">500.0</span>; <span class="comment">// MB/s</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">diskReadSpeed</span> <span class="operator">=</span> <span class="number">600.0</span>;  <span class="comment">// MB/s</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">diskWriteCost</span> <span class="operator">=</span> dataSize / diskWriteSpeed;</span><br><span class="line">        <span class="type">double</span> <span class="variable">diskReadCost</span> <span class="operator">=</span> dataSize / diskReadSpeed;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. åºåˆ—åŒ–æˆæœ¬</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">serializationRate</span> <span class="operator">=</span> <span class="number">2000.0</span>; <span class="comment">// MB/s</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">serializationCost</span> <span class="operator">=</span> dataSize * <span class="number">2</span> / serializationRate; <span class="comment">// åºåˆ—åŒ–+ååºåˆ—åŒ–</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. CPUè®¡ç®—æˆæœ¬</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">cpuProcessingRate</span> <span class="operator">=</span> <span class="number">1000.0</span>; <span class="comment">// MB/s</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">cpuCost</span> <span class="operator">=</span> dataSize / cpuProcessingRate;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5. å†…å­˜ç¼“å†²æˆæœ¬</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">memoryRequired</span> <span class="operator">=</span> (<span class="type">long</span>)(dataSize * <span class="number">0.2</span>); <span class="comment">// 20%æ•°æ®é‡çš„å†…å­˜ç¼“å†²</span></span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;=== Shuffleæˆæœ¬åˆ†æ ===&quot;</span>);</span><br><span class="line">        System.out.printf(<span class="string">&quot;æ•°æ®é‡: %.2f MB%n&quot;</span>, dataSize / (<span class="number">1024.0</span> * <span class="number">1024.0</span>));</span><br><span class="line">        System.out.printf(<span class="string">&quot;ç½‘ç»œä¼ è¾“æ—¶é—´: %.2f ç§’%n&quot;</span>, networkCost);</span><br><span class="line">        System.out.printf(<span class="string">&quot;ç£ç›˜å†™å…¥æ—¶é—´: %.2f ç§’%n&quot;</span>, diskWriteCost);</span><br><span class="line">        System.out.printf(<span class="string">&quot;ç£ç›˜è¯»å–æ—¶é—´: %.2f ç§’%n&quot;</span>, diskReadCost);</span><br><span class="line">        System.out.printf(<span class="string">&quot;åºåˆ—åŒ–æ—¶é—´: %.2f ç§’%n&quot;</span>, serializationCost);</span><br><span class="line">        System.out.printf(<span class="string">&quot;CPUå¤„ç†æ—¶é—´: %.2f ç§’%n&quot;</span>, cpuCost);</span><br><span class="line">        System.out.printf(<span class="string">&quot;å†…å­˜éœ€æ±‚: %.2f MB%n&quot;</span>, memoryRequired / (<span class="number">1024.0</span> * <span class="number">1024.0</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="type">double</span> <span class="variable">totalTime</span> <span class="operator">=</span> Math.max(networkCost, Math.max(diskWriteCost + diskReadCost, </span><br><span class="line">                          Math.max(serializationCost, cpuCost)));</span><br><span class="line">        System.out.printf(<span class="string">&quot;æ€»ä½“æ‰§è¡Œæ—¶é—´: %.2f ç§’%n&quot;</span>, totalTime);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ€§èƒ½ç“¶é¢ˆè¯†åˆ«ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Shuffleæ€§èƒ½ç“¶é¢ˆåˆ†æ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShuffleBottleneckAnalysis</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">identifyBottlenecks</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// å…¸å‹ç“¶é¢ˆåœºæ™¯ï¼š</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. ç½‘ç»œç“¶é¢ˆï¼šå¤§é‡æ•°æ®ä¼ è¾“</span></span><br><span class="line">        <span class="comment">// ç‰¹å¾ï¼šç½‘ç»œå¸¦å®½å æ»¡ï¼Œç£ç›˜å’ŒCPUåˆ©ç”¨ç‡ä½</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. ç£ç›˜IOç“¶é¢ˆï¼šæ•°æ®åºåˆ—åŒ–åˆ°ç£ç›˜</span></span><br><span class="line">        <span class="comment">// ç‰¹å¾ï¼šç£ç›˜IOå æ»¡ï¼Œç½‘ç»œä¼ è¾“æ–­æ–­ç»­ç»­</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. å†…å­˜ç“¶é¢ˆï¼šç¼“å†²åŒºä¸è¶³</span></span><br><span class="line">        <span class="comment">// ç‰¹å¾ï¼šé¢‘ç¹çš„ç£ç›˜æº¢å†™ï¼ŒGCå‹åŠ›å¤§</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. CPUç“¶é¢ˆï¼šåºåˆ—åŒ–/ååºåˆ—åŒ–å¼€é”€</span></span><br><span class="line">        <span class="comment">// ç‰¹å¾ï¼šCPUä½¿ç”¨ç‡é«˜ï¼Œå…¶ä»–èµ„æºç›¸å¯¹ç©ºé—²</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5. æ•°æ®å€¾æ–œï¼šæŸäº›åˆ†åŒºæ•°æ®é‡è¿‡å¤§</span></span><br><span class="line">        <span class="comment">// ç‰¹å¾ï¼šå¤§éƒ¨åˆ†Taskå¿«é€Ÿå®Œæˆï¼Œå°‘æ•°Taskæ‰§è¡Œå¾ˆæ…¢</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å…³é”®æˆæœ¬å› å­ï¼š</strong></p><ol><li><p><strong>ç½‘ç»œä¼ è¾“æˆæœ¬</strong>ï¼šå–å†³äºæ•°æ®é‡å’Œç½‘ç»œå¸¦å®½</p><ul><li>æ•°æ®å‹ç¼©å¯ä»¥æ˜¾è‘—å‡å°‘ç½‘ç»œä¼ è¾“æ—¶é—´</li><li>ç½‘ç»œæ‹“æ‰‘å¯¹ä¼ è¾“æ•ˆç‡å½±å“å¾ˆå¤§</li></ul></li><li><p><strong>ç£ç›˜IOæˆæœ¬</strong>ï¼šåŒ…æ‹¬å†™å…¥å’Œè¯»å–ä¸¤ä¸ªé˜¶æ®µ</p><ul><li>SSD vs æœºæ¢°ç¡¬ç›˜çš„æ€§èƒ½å·®å¼‚å·¨å¤§</li><li>å¹¶å‘IOè¯·æ±‚å¯èƒ½é€ æˆç£ç›˜äº‰ç”¨</li></ul></li><li><p><strong>åºåˆ—åŒ–æˆæœ¬</strong>ï¼šJavaåŸç”Ÿvs Kryoçš„æ€§èƒ½å·®å¼‚</p><ul><li>å¤æ‚å¯¹è±¡åºåˆ—åŒ–å¼€é”€æ›´å¤§</li><li>åºåˆ—åŒ–æ ¼å¼çš„é€‰æ‹©å½±å“CPUå’Œç½‘ç»œå¼€é”€</li></ul></li><li><p><strong>å†…å­˜æˆæœ¬</strong>ï¼šç¼“å†²åŒºç®¡ç†å’ŒGCå‹åŠ›</p><ul><li>å†…å­˜ä¸è¶³ä¼šå¯¼è‡´é¢‘ç¹çš„ç£ç›˜æº¢å†™</li><li>GCæš‚åœå½±å“æ•´ä½“æ€§èƒ½</li></ul></li></ol><p><strong>æˆæœ¬ä¼˜åŒ–ç­–ç•¥ï¼š</strong></p><ul><li>å‡å°‘Shuffleæ•°æ®é‡ï¼šä½¿ç”¨Combinerè¿›è¡Œæœ¬åœ°é¢„èšåˆ</li><li>ä¼˜åŒ–åºåˆ—åŒ–ï¼šä½¿ç”¨Kryoç­‰é«˜æ•ˆåºåˆ—åŒ–æ¡†æ¶</li><li>åˆç†é…ç½®å†…å­˜ï¼šå¹³è¡¡æ‰§è¡Œå†…å­˜å’Œå­˜å‚¨å†…å­˜</li><li>ç½‘ç»œä¼˜åŒ–ï¼šå¯ç”¨æ•°æ®å‹ç¼©ï¼Œä¼˜åŒ–ç½‘ç»œæ‹“æ‰‘</li></ul><h3 id="3-2-Shuffleçš„ä¸¤ä¸ªé˜¶æ®µ"><a href="#3-2-Shuffleçš„ä¸¤ä¸ªé˜¶æ®µ" class="headerlink" title="3.2 Shuffleçš„ä¸¤ä¸ªé˜¶æ®µ"></a>3.2 Shuffleçš„ä¸¤ä¸ªé˜¶æ®µ</h3><p>Shuffleæ“ä½œåˆ†ä¸ºä¸¤ä¸ªå…³é”®é˜¶æ®µï¼šShuffle Writeï¼ˆå†™é˜¶æ®µï¼‰å’ŒShuffle Readï¼ˆè¯»é˜¶æ®µï¼‰ã€‚ç†è§£è¿™ä¸¤ä¸ªé˜¶æ®µçš„è¯¦ç»†æœºåˆ¶æ˜¯ä¼˜åŒ–Shuffleæ€§èƒ½çš„åŸºç¡€ã€‚</p><h4 id="3-2-1-Shuffle-Writeé˜¶æ®µæ·±åº¦è§£æ"><a href="#3-2-1-Shuffle-Writeé˜¶æ®µæ·±åº¦è§£æ" class="headerlink" title="3.2.1 Shuffle Writeé˜¶æ®µæ·±åº¦è§£æ"></a>3.2.1 Shuffle Writeé˜¶æ®µæ·±åº¦è§£æ</h4><p>Shuffle Writeé˜¶æ®µæ˜¯æ•´ä¸ªShuffleè¿‡ç¨‹çš„èµ·ç‚¹ï¼Œè´Ÿè´£å°†æ•°æ®æŒ‰ç…§åˆ†åŒºé€»è¾‘é‡æ–°ç»„ç»‡å¹¶å†™å…¥å­˜å‚¨ã€‚</p><p><strong>è¯¦ç»†çš„å†…éƒ¨æµç¨‹ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Shuffle Writeçš„å®Œæ•´å®ç°æœºåˆ¶</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShuffleWriteManager</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> numPartitions;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Partitioner partitioner;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> mapSideCombine;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Serializer serializer;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writeShuffleData</span><span class="params">(Iterator&lt;Product2&lt;K, V&gt;&gt; records)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. æ•°æ®åˆ†åŒºé˜¶æ®µ</span></span><br><span class="line">        Map&lt;Integer, List&lt;Product2&lt;K, V&gt;&gt;&gt; partitionedData = partitionData(records);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. å¯é€‰çš„æœ¬åœ°èšåˆ</span></span><br><span class="line">        <span class="keyword">if</span> (mapSideCombine) &#123;</span><br><span class="line">            partitionedData = applyLocalCombiner(partitionedData);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. å¯é€‰çš„æ’åº</span></span><br><span class="line">        <span class="keyword">if</span> (needSorting()) &#123;</span><br><span class="line">            partitionedData = sortWithinPartitions(partitionedData);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. åºåˆ—åŒ–å’Œå†™å…¥</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;Integer, List&lt;Product2&lt;K, V&gt;&gt;&gt; entry : partitionedData.entrySet()) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">partitionId</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">            writePartitionToDisk(partitionId, entry.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5. ç”Ÿæˆç´¢å¼•æ–‡ä»¶</span></span><br><span class="line">        generateIndexFile();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Map&lt;Integer, List&lt;Product2&lt;K, V&gt;&gt;&gt; <span class="title function_">partitionData</span><span class="params">(Iterator&lt;Product2&lt;K, V&gt;&gt; records)</span> &#123;</span><br><span class="line">        Map&lt;Integer, List&lt;Product2&lt;K, V&gt;&gt;&gt; partitions = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> (records.hasNext()) &#123;</span><br><span class="line">            Product2&lt;K, V&gt; record = records.next();</span><br><span class="line">            <span class="type">int</span> <span class="variable">partitionId</span> <span class="operator">=</span> partitioner.getPartition(record._1);</span><br><span class="line">            </span><br><span class="line">            partitions.computeIfAbsent(partitionId, k -&gt; <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;()).add(record);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å†…å­˜ç®¡ç†ï¼šå½“åˆ†åŒºç¼“å­˜è¿‡å¤§æ—¶ï¼Œæº¢å†™åˆ°ç£ç›˜</span></span><br><span class="line">            <span class="keyword">if</span> (shouldSpillToDisk(partitions)) &#123;</span><br><span class="line">                spillToDisk(partitions);</span><br><span class="line">                partitions.clear();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> partitions;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å†…å­˜ç®¡ç†ä¸æº¢å†™æœºåˆ¶ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Shuffle Writeçš„å†…å­˜ç®¡ç†</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShuffleMemoryManager</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> maxMemoryPerTask;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">double</span> spillThreshold;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> currentMemoryUsage;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldSpillToDisk</span><span class="params">(Map&lt;Integer, List&lt;Product2&lt;K, V&gt;&gt;&gt; partitions)</span> &#123;</span><br><span class="line">        currentMemoryUsage = estimateMemoryUsage(partitions);</span><br><span class="line">        <span class="keyword">return</span> currentMemoryUsage &gt; maxMemoryPerTask * spillThreshold;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">spillToDisk</span><span class="params">(Map&lt;Integer, List&lt;Product2&lt;K, V&gt;&gt;&gt; partitions)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. é€‰æ‹©è¦æº¢å†™çš„åˆ†åŒºï¼ˆé€šå¸¸æ˜¯æœ€å¤§çš„åˆ†åŒºï¼‰</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">largestPartition</span> <span class="operator">=</span> findLargestPartition(partitions);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. åºåˆ—åŒ–æ•°æ®</span></span><br><span class="line">        <span class="type">byte</span>[] serializedData = serializePartition(partitions.get(largestPartition));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. å†™å…¥ä¸´æ—¶æ–‡ä»¶</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">spillFile</span> <span class="operator">=</span> createSpillFile();</span><br><span class="line">        writeToFile(spillFile, serializedData);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. è®°å½•æº¢å†™ä¿¡æ¯ï¼Œç”¨äºåç»­åˆå¹¶</span></span><br><span class="line">        recordSpillInfo(largestPartition, spillFile);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5. ä»å†…å­˜ä¸­ç§»é™¤å·²æº¢å†™çš„æ•°æ®</span></span><br><span class="line">        partitions.remove(largestPartition);</span><br><span class="line">        </span><br><span class="line">        System.gc(); <span class="comment">// å»ºè®®åƒåœ¾å›æ”¶ï¼Œé‡Šæ”¾å†…å­˜</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ–‡ä»¶ç»„ç»‡ç»“æ„ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Shuffleæ–‡ä»¶çš„ç»„ç»‡æ–¹å¼</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShuffleFileManager</span> &#123;</span><br><span class="line">    <span class="comment">// æ¯ä¸ªShuffle Write Taskç”Ÿæˆä¸¤ç±»æ–‡ä»¶ï¼š</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. æ•°æ®æ–‡ä»¶ï¼šshuffle_0_0_0.data</span></span><br><span class="line">    <span class="comment">// æ ¼å¼ï¼šshuffleId_mapId_attemptId.data</span></span><br><span class="line">    <span class="keyword">private</span> File dataFile;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ç´¢å¼•æ–‡ä»¶ï¼šshuffle_0_0_0.index</span></span><br><span class="line">    <span class="comment">// è®°å½•æ¯ä¸ªåˆ†åŒºåœ¨æ•°æ®æ–‡ä»¶ä¸­çš„ä½ç½®å’Œå¤§å°</span></span><br><span class="line">    <span class="keyword">private</span> File indexFile;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writeShuffleOutput</span><span class="params">(Map&lt;Integer, <span class="type">byte</span>[]&gt; partitionData)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">FileOutputStream</span> <span class="variable">dataOut</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(dataFile);</span><br><span class="line">             <span class="type">DataOutputStream</span> <span class="variable">indexOut</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(indexFile))) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="type">long</span> <span class="variable">currentOffset</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// æŒ‰åˆ†åŒºIDé¡ºåºå†™å…¥æ•°æ®</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">partitionId</span> <span class="operator">=</span> <span class="number">0</span>; partitionId &lt; numPartitions; partitionId++) &#123;</span><br><span class="line">                <span class="type">byte</span>[] data = partitionData.get(partitionId);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (data != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// å†™å…¥æ•°æ®</span></span><br><span class="line">                    dataOut.write(data);</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// å†™å…¥ç´¢å¼•ï¼šèµ·å§‹ä½ç½®å’Œé•¿åº¦</span></span><br><span class="line">                    indexOut.writeLong(currentOffset);</span><br><span class="line">                    indexOut.writeLong(data.length);</span><br><span class="line">                    </span><br><span class="line">                    currentOffset += data.length;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// ç©ºåˆ†åŒº</span></span><br><span class="line">                    indexOut.writeLong(currentOffset);</span><br><span class="line">                    indexOut.writeLong(<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-2-2-Shuffle-Readé˜¶æ®µæ·±åº¦è§£æ"><a href="#3-2-2-Shuffle-Readé˜¶æ®µæ·±åº¦è§£æ" class="headerlink" title="3.2.2 Shuffle Readé˜¶æ®µæ·±åº¦è§£æ"></a>3.2.2 Shuffle Readé˜¶æ®µæ·±åº¦è§£æ</h4><p>Shuffle Readé˜¶æ®µè´Ÿè´£ä»å„ä¸ªèŠ‚ç‚¹æ‹‰å–æ•°æ®å¹¶è¿›è¡Œåˆå¹¶å¤„ç†ã€‚</p><p><strong>æ•°æ®æ‹‰å–çš„è¯¦ç»†æœºåˆ¶ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Shuffle Readçš„å®Œæ•´å®ç°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShuffleReader</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ShuffleBlockResolver blockResolver;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> startPartition;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> endPartition;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Iterator&lt;Product2&lt;K, C&gt;&gt; <span class="title function_">read</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 1. è·å–æ•°æ®å—ä½ç½®ä¿¡æ¯</span></span><br><span class="line">        List&lt;BlockManagerId&gt; blockManagers = getShuffleBlockLocations();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. åˆ›å»ºæ•°æ®æ‹‰å–è¿­ä»£å™¨</span></span><br><span class="line">        <span class="type">ShuffleBlockFetcherIterator</span> <span class="variable">fetchIter</span> <span class="operator">=</span> createFetchIterator(blockManagers);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. ååºåˆ—åŒ–æ•°æ®</span></span><br><span class="line">        Iterator&lt;Product2&lt;K, C&gt;&gt; deserializedIter = deserializeStream(fetchIter);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. å¯é€‰çš„èšåˆæ“ä½œ</span></span><br><span class="line">        <span class="keyword">if</span> (needAggregation()) &#123;</span><br><span class="line">            <span class="keyword">return</span> createAggregationIterator(deserializedIter);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5. å¯é€‰çš„æ’åºæ“ä½œ</span></span><br><span class="line">        <span class="keyword">if</span> (needOrdering()) &#123;</span><br><span class="line">            <span class="keyword">return</span> createSortingIterator(deserializedIter);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> deserializedIter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç½‘ç»œæ•°æ®æ‹‰å–æœºåˆ¶ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç½‘ç»œæ•°æ®æ‹‰å–çš„å®ç°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShuffleBlockFetcherIterator</span> <span class="keyword">implements</span> <span class="title class_">Iterator</span>&lt;Tuple2&lt;BlockId, InputStream&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Queue&lt;FetchRequest&gt; fetchRequests;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;FetchResult&gt; results;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExecutorService fetchExecutor;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ShuffleBlockFetcherIterator</span><span class="params">(List&lt;BlockManagerId&gt; blockManagers)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.fetchRequests = createFetchRequests(blockManagers);</span><br><span class="line">        <span class="built_in">this</span>.results = <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;();</span><br><span class="line">        <span class="built_in">this</span>.fetchExecutor = Executors.newFixedThreadPool(<span class="number">5</span>); <span class="comment">// å¹¶å‘æ‹‰å–</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¯åŠ¨å¼‚æ­¥æ‹‰å–ä»»åŠ¡</span></span><br><span class="line">        startFetching();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startFetching</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (FetchRequest request : fetchRequests) &#123;</span><br><span class="line">            fetchExecutor.submit(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// é€šè¿‡ç½‘ç»œæ‹‰å–æ•°æ®å—</span></span><br><span class="line">                    <span class="type">InputStream</span> <span class="variable">data</span> <span class="operator">=</span> fetchBlockFromRemote(request);</span><br><span class="line">                    results.put(<span class="keyword">new</span> <span class="title class_">FetchResult</span>(request.blockId, data, <span class="literal">null</span>));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    results.put(<span class="keyword">new</span> <span class="title class_">FetchResult</span>(request.blockId, <span class="literal">null</span>, e));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> InputStream <span class="title function_">fetchBlockFromRemote</span><span class="params">(FetchRequest request)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. å»ºç«‹ç½‘ç»œè¿æ¥</span></span><br><span class="line">        <span class="type">NettyTransportConf</span> <span class="variable">conf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NettyTransportConf</span>();</span><br><span class="line">        <span class="type">TransportClient</span> <span class="variable">client</span> <span class="operator">=</span> createTransportClient(request.address, conf);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. å‘é€æ•°æ®å—è¯·æ±‚</span></span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">response</span> <span class="operator">=</span> client.sendRpcSync(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">OpenBlocks</span>(request.blockId).toByteBuffer(), </span><br><span class="line">            <span class="number">30000</span> <span class="comment">// 30ç§’è¶…æ—¶</span></span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. å¤„ç†å“åº”</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ByteBufferInputStream</span>(response);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasNext</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> !fetchRequests.isEmpty() || !results.isEmpty();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Tuple2&lt;BlockId, InputStream&gt; <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">FetchResult</span> <span class="variable">result</span> <span class="operator">=</span> results.take(); <span class="comment">// é˜»å¡ç­‰å¾…ç»“æœ</span></span><br><span class="line">            <span class="keyword">if</span> (result.exception != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed to fetch block&quot;</span>, result.exception);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(result.blockId, result.data);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ•°æ®åˆå¹¶ä¸èšåˆæœºåˆ¶ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Shuffle Readé˜¶æ®µçš„æ•°æ®åˆå¹¶</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShuffleDataMerger</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Iterator&lt;Product2&lt;K, C&gt;&gt; <span class="title function_">mergeAndAggregate</span><span class="params">(</span></span><br><span class="line"><span class="params">            Iterator&lt;Product2&lt;K, V&gt;&gt; input,</span></span><br><span class="line"><span class="params">            Function&lt;V, C&gt; createCombiner,</span></span><br><span class="line"><span class="params">            Function2&lt;C, V, C&gt; mergeValue,</span></span><br><span class="line"><span class="params">            Function2&lt;C, C, C&gt; mergeCombiners)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. å¤–éƒ¨æ’åºåˆå¹¶ï¼ˆå½“æ•°æ®é‡å¤§äºå†…å­˜æ—¶ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> (exceedsMemoryThreshold(input)) &#123;</span><br><span class="line">            <span class="keyword">return</span> externalSortAndMerge(input, createCombiner, mergeValue, mergeCombiners);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. å†…å­˜ä¸­åˆå¹¶ï¼ˆæ•°æ®é‡è¾ƒå°æ—¶ï¼‰</span></span><br><span class="line">        <span class="keyword">return</span> inMemoryMerge(input, createCombiner, mergeValue, mergeCombiners);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Iterator&lt;Product2&lt;K, C&gt;&gt; <span class="title function_">externalSortAndMerge</span><span class="params">(</span></span><br><span class="line"><span class="params">            Iterator&lt;Product2&lt;K, V&gt;&gt; input,</span></span><br><span class="line"><span class="params">            Function&lt;V, C&gt; createCombiner,</span></span><br><span class="line"><span class="params">            Function2&lt;C, V, C&gt; mergeValue,</span></span><br><span class="line"><span class="params">            Function2&lt;C, C, C&gt; mergeCombiners)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        ExternalSorter&lt;K, V, C&gt; sorter = <span class="keyword">new</span> <span class="title class_">ExternalSorter</span>&lt;&gt;(</span><br><span class="line">            createCombiner, mergeValue, mergeCombiners</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å°†æ•°æ®æ’å…¥å¤–éƒ¨æ’åºå™¨</span></span><br><span class="line">        <span class="keyword">while</span> (input.hasNext()) &#123;</span><br><span class="line">            Product2&lt;K, V&gt; record = input.next();</span><br><span class="line">            sorter.insertAll(Collections.singletonList(record).iterator());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è¿”å›æ’åºå’Œèšåˆåçš„ç»“æœ</span></span><br><span class="line">        <span class="keyword">return</span> sorter.iterator();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ€§èƒ½ä¼˜åŒ–æœºåˆ¶ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Shuffle Readçš„æ€§èƒ½ä¼˜åŒ–</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShuffleReadOptimizer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">optimizeShuffleRead</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 1. é¢„å–ä¼˜åŒ–ï¼šæå‰æ‹‰å–æ•°æ®</span></span><br><span class="line">        <span class="comment">// 2. å‹ç¼©ä¼ è¾“ï¼šå‡å°‘ç½‘ç»œä¼ è¾“é‡</span></span><br><span class="line">        <span class="comment">// 3. æœ¬åœ°æ•°æ®ä¼˜å…ˆï¼šä¼˜å…ˆè¯»å–æœ¬åœ°æ•°æ®</span></span><br><span class="line">        <span class="comment">// 4. å¹¶å‘æ‹‰å–ï¼šå¤šçº¿ç¨‹å¹¶å‘æ‹‰å–æ•°æ®å—</span></span><br><span class="line">        <span class="comment">// 5. å†…å­˜ç®¡ç†ï¼šåˆç†ç®¡ç†è¯»å–ç¼“å†²åŒº</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æœ¬åœ°æ•°æ®ä¼˜å…ˆè¯»å–ç­–ç•¥</span></span><br><span class="line">        List&lt;BlockLocation&gt; localBlocks = filterLocalBlocks(allBlocks);</span><br><span class="line">        List&lt;BlockLocation&gt; remoteBlocks = filterRemoteBlocks(allBlocks);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å…ˆè¯»å–æœ¬åœ°æ•°æ®ï¼Œå†è¯»å–è¿œç¨‹æ•°æ®</span></span><br><span class="line">        Iterator&lt;Product2&lt;K, V&gt;&gt; localIter = readBlocks(localBlocks);</span><br><span class="line">        Iterator&lt;Product2&lt;K, V&gt;&gt; remoteIter = readBlocks(remoteBlocks);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> Iterators.concat(localIter, remoteIter);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isLocalBlock</span><span class="params">(BlockLocation block)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> block.getHosts().contains(getCurrentNodeId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å…³é”®ç‰¹ç‚¹æ€»ç»“ï¼š</strong></p><p><strong>Shuffle Writeé˜¶æ®µï¼š</strong></p><ul><li>æ•°æ®æŒ‰åˆ†åŒºå™¨è§„åˆ™é‡æ–°ç»„ç»‡</li><li>æ”¯æŒæœ¬åœ°é¢„èšåˆå‡å°‘æ•°æ®é‡</li><li>å†…å­˜ä¸è¶³æ—¶è‡ªåŠ¨æº¢å†™åˆ°ç£ç›˜</li><li>ç”Ÿæˆç´¢å¼•æ–‡ä»¶ä¾¿äºå¿«é€Ÿå®šä½</li></ul><p><strong>Shuffle Readé˜¶æ®µï¼š</strong></p><ul><li>å¹¶å‘ä»å¤šä¸ªèŠ‚ç‚¹æ‹‰å–æ•°æ®</li><li>æ”¯æŒæœ¬åœ°æ•°æ®ä¼˜å…ˆè¯»å–</li><li>è‡ªåŠ¨å¤„ç†ç½‘ç»œå¼‚å¸¸å’Œé‡è¯•</li><li>æ”¯æŒå¤–éƒ¨æ’åºå¤„ç†å¤§æ•°æ®é›†</li></ul><p>è¿™ä¸¤ä¸ªé˜¶æ®µçš„åè°ƒå·¥ä½œç¡®ä¿äº†æ•°æ®åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­çš„æ­£ç¡®é‡æ–°åˆ†å¸ƒï¼Œä½†ä¹Ÿå¸¦æ¥äº†æ˜¾è‘—çš„æ€§èƒ½å¼€é”€ã€‚ç†è§£è¿™äº›æœºåˆ¶æœ‰åŠ©äºæˆ‘ä»¬é’ˆå¯¹æ€§åœ°è¿›è¡Œä¼˜åŒ–ã€‚</p><h2 id="å…­ã€Spark3-x-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥å¤§å…¨"><a href="#å…­ã€Spark3-x-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥å¤§å…¨" class="headerlink" title="å…­ã€Spark3.x æ€§èƒ½ä¼˜åŒ–ç­–ç•¥å¤§å…¨"></a>å…­ã€Spark3.x æ€§èƒ½ä¼˜åŒ–ç­–ç•¥å¤§å…¨</h2><p>ç†è§£äº†ç®—å­åŸç†å’ŒShuffleæœºåˆ¶åï¼Œè®©æˆ‘ä»¬æ·±å…¥æ¢è®¨å¦‚ä½•ä¼˜åŒ–Sparkåº”ç”¨çš„æ€§èƒ½ã€‚æœ¬ç« å°†å„ç§ä¼˜åŒ–ç­–ç•¥æŒ‰ç±»åˆ«æ•´ç†ï¼Œä¾¿äºå®é™…åº”ç”¨ã€‚</p><h3 id="6-1-åºåˆ—åŒ–ä¼˜åŒ–ï¼šKryo-vs-JavaåŸç”Ÿåºåˆ—åŒ–"><a href="#6-1-åºåˆ—åŒ–ä¼˜åŒ–ï¼šKryo-vs-JavaåŸç”Ÿåºåˆ—åŒ–" class="headerlink" title="6.1 åºåˆ—åŒ–ä¼˜åŒ–ï¼šKryo vs JavaåŸç”Ÿåºåˆ—åŒ–"></a>6.1 åºåˆ—åŒ–ä¼˜åŒ–ï¼šKryo vs JavaåŸç”Ÿåºåˆ—åŒ–</h3><p><strong>Kryoåºåˆ—åŒ–è¯¦è§£ï¼š</strong></p><p>Kryoæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„Javaåºåˆ—åŒ–æ¡†æ¶ï¼Œç›¸æ¯”JavaåŸç”Ÿåºåˆ—åŒ–æœ‰æ˜¾è‘—çš„æ€§èƒ½æå‡ã€‚</p><p><strong>è§£å†³çš„é—®é¢˜ï¼š</strong></p><ol><li><strong>åºåˆ—åŒ–å¼€é”€å¤§</strong>ï¼šJavaåŸç”Ÿåºåˆ—åŒ–é€Ÿåº¦æ…¢ã€ä½“ç§¯å¤§</li><li><strong>ç½‘ç»œä¼ è¾“æ•ˆç‡ä½</strong>ï¼šShuffleè¿‡ç¨‹ä¸­å¤§é‡æ•°æ®éœ€è¦åºåˆ—åŒ–ä¼ è¾“</li><li><strong>å†…å­˜å ç”¨å¤š</strong>ï¼šåºåˆ—åŒ–åçš„å¯¹è±¡å ç”¨æ›´å¤šå†…å­˜ç©ºé—´</li></ol><p><strong>æ€§èƒ½å¯¹æ¯”ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ€§èƒ½æµ‹è¯•ä»£ç </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SerializationBenchmark</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        List&lt;Person&gt; persons = generateTestData(<span class="number">100000</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// JavaåŸç”Ÿåºåˆ—åŒ–</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">javaStartTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">byte</span>[] javaBytes = javaSerialize(persons);</span><br><span class="line">        <span class="type">long</span> <span class="variable">javaEndTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Kryoåºåˆ—åŒ–</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">kryoStartTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">byte</span>[] kryoBytes = kryoSerialize(persons);</span><br><span class="line">        <span class="type">long</span> <span class="variable">kryoEndTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;Javaåºåˆ—åŒ–æ—¶é—´: &quot;</span> + (javaEndTime - javaStartTime) + <span class="string">&quot;ms&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Javaåºåˆ—åŒ–å¤§å°: &quot;</span> + javaBytes.length + <span class="string">&quot; bytes&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Kryoåºåˆ—åŒ–æ—¶é—´: &quot;</span> + (kryoEndTime - kryoStartTime) + <span class="string">&quot;ms&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Kryoåºåˆ—åŒ–å¤§å°: &quot;</span> + kryoBytes.length + <span class="string">&quot; bytes&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å…¸å‹ç»“æœï¼š</span></span><br><span class="line">        <span class="comment">// Javaåºåˆ—åŒ–æ—¶é—´: 2500ms, å¤§å°: 15MB</span></span><br><span class="line">        <span class="comment">// Kryoåºåˆ—åŒ–æ—¶é—´: 800ms, å¤§å°: 8MB</span></span><br><span class="line">        <span class="comment">// Kryoæ€§èƒ½æå‡ï¼š3å€é€Ÿåº¦ï¼Œ50%ä½“ç§¯</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å·¥ä½œåŸç†ï¼š</strong><br>Kryoé€šè¿‡ä»¥ä¸‹æœºåˆ¶æå‡æ€§èƒ½ï¼š</p><ol><li><strong>æ— åå°„</strong>ï¼šé¢„å…ˆæ³¨å†Œç±»å‹ï¼Œé¿å…è¿è¡Œæ—¶åå°„</li><li><strong>å‹ç¼©ç®—æ³•</strong>ï¼šæ›´é«˜æ•ˆçš„äºŒè¿›åˆ¶æ ¼å¼</li><li><strong>å¯¹è±¡æ± </strong>ï¼šå¤ç”¨åºåˆ—åŒ–å™¨å¯¹è±¡</li></ol><p><strong>è‡ªå®šä¹‰Kryoæ³¨å†Œå™¨ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyKryoRegistrator</span> <span class="keyword">implements</span> <span class="title class_">KryoRegistrator</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerClasses</span><span class="params">(Kryo kryo)</span> &#123;</span><br><span class="line">        <span class="comment">// æ³¨å†Œè‡ªå®šä¹‰ç±»</span></span><br><span class="line">        kryo.register(Person.class);</span><br><span class="line">        kryo.register(Address.class);</span><br><span class="line">        kryo.register(scala.collection.mutable.WrappedArray.ofRef.class);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ³¨å†Œé›†åˆç±»</span></span><br><span class="line">        kryo.register(ArrayList.class);</span><br><span class="line">        kryo.register(HashMap.class);</span><br><span class="line">        kryo.register(HashSet.class);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä½¿ç”¨è‡ªå®šä¹‰åºåˆ—åŒ–å™¨</span></span><br><span class="line">        kryo.register(BigDecimal.class, <span class="keyword">new</span> <span class="title class_">BigDecimalSerializer</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰åºåˆ—åŒ–å™¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BigDecimalSerializer</span> <span class="keyword">extends</span> <span class="title class_">Serializer</span>&lt;BigDecimal&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(Kryo kryo, Output output, BigDecimal object)</span> &#123;</span><br><span class="line">        output.writeString(object.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BigDecimal <span class="title function_">read</span><span class="params">(Kryo kryo, Input input, Class&lt;BigDecimal&gt; type)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(input.readString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æœ€ä½³å®è·µï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®Œæ•´çš„Kryoé…ç½®</span></span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.serializer&quot;</span>, <span class="string">&quot;org.apache.spark.serializer.KryoSerializer&quot;</span>);</span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.kryo.registrator&quot;</span>, <span class="string">&quot;com.example.MyKryoRegistrator&quot;</span>);</span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.kryo.registrationRequired&quot;</span>, <span class="string">&quot;true&quot;</span>); <span class="comment">// å¼ºåˆ¶æ³¨å†Œ</span></span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.kryoserializer.buffer&quot;</span>, <span class="string">&quot;256k&quot;</span>);     <span class="comment">// å¢å¤§ç¼“å†²åŒº</span></span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.kryoserializer.buffer.max&quot;</span>, <span class="string">&quot;1g&quot;</span>);   <span class="comment">// æœ€å¤§ç¼“å†²åŒº</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨ä»£ç ä¸­éªŒè¯åºåˆ—åŒ–æ•ˆæœ</span></span><br><span class="line">JavaRDD&lt;Person&gt; persons = sc.parallelize(personList);</span><br><span class="line">persons.cache(); <span class="comment">// è§¦å‘åºåˆ—åŒ–</span></span><br><span class="line"><span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> persons.count(); <span class="comment">// è§‚å¯ŸSpark UIä¸­çš„åºåˆ—åŒ–æ—¶é—´</span></span><br></pre></td></tr></table></figure><h3 id="6-2-åˆ†åŒºä¼˜åŒ–ç­–ç•¥"><a href="#6-2-åˆ†åŒºä¼˜åŒ–ç­–ç•¥" class="headerlink" title="6.2 åˆ†åŒºä¼˜åŒ–ç­–ç•¥"></a>6.2 åˆ†åŒºä¼˜åŒ–ç­–ç•¥</h3><h4 id="6-2-1-è‡ªé€‚åº”åˆ†åŒºï¼ˆAdaptive-Partitionï¼‰"><a href="#6-2-1-è‡ªé€‚åº”åˆ†åŒºï¼ˆAdaptive-Partitionï¼‰" class="headerlink" title="6.2.1 è‡ªé€‚åº”åˆ†åŒºï¼ˆAdaptive Partitionï¼‰"></a>6.2.1 è‡ªé€‚åº”åˆ†åŒºï¼ˆAdaptive Partitionï¼‰</h4><p>è‡ªé€‚åº”åˆ†åŒºæ˜¯Spark3.xå¼•å…¥çš„æ™ºèƒ½åˆ†åŒºç®¡ç†æœºåˆ¶ï¼Œç”¨äºè§£å†³åˆ†åŒºå¤§å°ä¸å‡åŒ€çš„é—®é¢˜ã€‚</p><p><strong>è§£å†³çš„é—®é¢˜ï¼š</strong></p><ol><li><strong>å°æ–‡ä»¶é—®é¢˜</strong>ï¼šè¿‡æ»¤åæŸäº›åˆ†åŒºå˜å¾—å¾ˆå°ï¼Œå¯¼è‡´ä»»åŠ¡æ•°é‡è¿‡å¤š</li><li><strong>èµ„æºæµªè´¹</strong>ï¼šç©ºåˆ†åŒºæˆ–æå°åˆ†åŒºæµªè´¹Executorèµ„æº</li><li><strong>æ€§èƒ½ä¸‹é™</strong>ï¼šè¿‡å¤šçš„å°ä»»åŠ¡å¢åŠ è°ƒåº¦å¼€é”€</li></ol><p><strong>å·¥ä½œåŸç†ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è‡ªé€‚åº”åˆ†åŒºçš„å†…éƒ¨é€»è¾‘ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AdaptivePartitionManager</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">targetPartitionSize</span> <span class="operator">=</span> <span class="number">128</span> * <span class="number">1024</span> * <span class="number">1024</span>; <span class="comment">// 128MB</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">minPartitions</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">maxPartitions</span> <span class="operator">=</span> <span class="number">200</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">calculateOptimalPartitions</span><span class="params">(<span class="type">long</span> totalDataSize, <span class="type">int</span> currentPartitions)</span> &#123;</span><br><span class="line">        <span class="comment">// è®¡ç®—ç†æƒ³åˆ†åŒºæ•°</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">idealPartitions</span> <span class="operator">=</span> (<span class="type">int</span>) (totalDataSize / targetPartitionSize);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åº”ç”¨çº¦æŸæ¡ä»¶</span></span><br><span class="line">        <span class="keyword">return</span> Math.max(minPartitions, Math.min(maxPartitions, idealPartitions));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> List&lt;Partition&gt; <span class="title function_">coalescePartitions</span><span class="params">(List&lt;Partition&gt; partitions)</span> &#123;</span><br><span class="line">        List&lt;Partition&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="type">long</span> <span class="variable">currentSize</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        List&lt;Partition&gt; currentGroup = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (Partition partition : partitions) &#123;</span><br><span class="line">            <span class="keyword">if</span> (currentSize + partition.getSize() &lt;= targetPartitionSize) &#123;</span><br><span class="line">                currentGroup.add(partition);</span><br><span class="line">                currentSize += partition.getSize();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!currentGroup.isEmpty()) &#123;</span><br><span class="line">                    result.add(mergePartitions(currentGroup));</span><br><span class="line">                &#125;</span><br><span class="line">                currentGroup.clear();</span><br><span class="line">                currentGroup.add(partition);</span><br><span class="line">                currentSize = partition.getSize();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!currentGroup.isEmpty()) &#123;</span><br><span class="line">            result.add(mergePartitions(currentGroup));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å®é™…æ•ˆæœå¯¹æ¯”ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼ ç»Ÿæ–¹å¼ï¼šå›ºå®š100ä¸ªåˆ†åŒº</span></span><br><span class="line">JavaRDD&lt;String&gt; largeDataset = sc.textFile(<span class="string">&quot;large_file.txt&quot;</span>, <span class="number">100</span>);</span><br><span class="line">JavaRDD&lt;String&gt; filtered = largeDataset.filter(line -&gt; line.contains(<span class="string">&quot;ERROR&quot;</span>));</span><br><span class="line"><span class="comment">// ç»“æœï¼šå¯èƒ½åªæœ‰10ä¸ªåˆ†åŒºæœ‰æ•°æ®ï¼Œå…¶ä½™90ä¸ªåˆ†åŒºä¸ºç©º</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªé€‚åº”åˆ†åŒºæ–¹å¼</span></span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.sql.adaptive.enabled&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.sql.adaptive.coalescePartitions.enabled&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.sql.adaptive.advisoryPartitionSizeInBytes&quot;</span>, <span class="string">&quot;128MB&quot;</span>);</span><br><span class="line"></span><br><span class="line">Dataset&lt;String&gt; adaptiveFiltered = spark.read().textFile(<span class="string">&quot;large_file.txt&quot;</span>)</span><br><span class="line">    .filter(line -&gt; line.contains(<span class="string">&quot;ERROR&quot;</span>));</span><br><span class="line"><span class="comment">// ç»“æœï¼šè‡ªåŠ¨åˆå¹¶ä¸ºåˆé€‚æ•°é‡çš„åˆ†åŒºï¼Œæ¯ä¸ªåˆ†åŒºå¤§å°çº¦128MB</span></span><br></pre></td></tr></table></figure><h3 id="6-3-è‡ªé€‚åº”æŸ¥è¯¢æ‰§è¡Œï¼ˆAQEï¼‰"><a href="#6-3-è‡ªé€‚åº”æŸ¥è¯¢æ‰§è¡Œï¼ˆAQEï¼‰" class="headerlink" title="6.3 è‡ªé€‚åº”æŸ¥è¯¢æ‰§è¡Œï¼ˆAQEï¼‰"></a>6.3 è‡ªé€‚åº”æŸ¥è¯¢æ‰§è¡Œï¼ˆAQEï¼‰</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¼€å¯AQE</span></span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.sql.adaptive.enabled&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.sql.adaptive.coalescePartitions.enabled&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.sql.adaptive.skewJoin.enabled&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br></pre></td></tr></table></figure><p><strong>è‡ªé€‚åº”æŸ¥è¯¢æ‰§è¡Œï¼ˆAQEï¼‰è¯¦è§£ï¼š</strong></p><p>AQEæ˜¯Spark3.xå¼•å…¥çš„é©å‘½æ€§åŠŸèƒ½ï¼Œèƒ½å¤Ÿåœ¨è¿è¡Œæ—¶æ ¹æ®å®é™…æ•°æ®ç»Ÿè®¡åŠ¨æ€ä¼˜åŒ–æŸ¥è¯¢è®¡åˆ’ã€‚</p><p><strong>è§£å†³çš„é—®é¢˜ï¼š</strong></p><ol><li><strong>é™æ€ä¼˜åŒ–çš„å±€é™æ€§</strong>ï¼šä¼ ç»Ÿä¼˜åŒ–å™¨åªèƒ½åŸºäºç»Ÿè®¡ä¿¡æ¯è¿›è¡Œé™æ€ä¼˜åŒ–</li><li><strong>æ•°æ®å€¾æ–œéš¾ä»¥é¢„æµ‹</strong>ï¼šè¿è¡Œå‰æ— æ³•å‡†ç¡®é¢„çŸ¥æ•°æ®åˆ†å¸ƒæƒ…å†µ</li><li><strong>èµ„æºåˆ©ç”¨ç‡ä½</strong>ï¼šå›ºå®šçš„æ‰§è¡Œè®¡åˆ’æ— æ³•é€‚åº”æ•°æ®å˜åŒ–</li></ol><p><strong>AQEçš„ä¸‰å¤§æ ¸å¿ƒåŠŸèƒ½ï¼š</strong></p><p><strong>1. åŠ¨æ€åˆå¹¶Shuffleåˆ†åŒº</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼ ç»Ÿæ–¹å¼ï¼šå›ºå®š200ä¸ªåˆ†åŒº</span></span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.sql.shuffle.partitions&quot;</span>, <span class="string">&quot;200&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// AQEæ–¹å¼ï¼šæ ¹æ®æ•°æ®é‡åŠ¨æ€è°ƒæ•´</span></span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.sql.adaptive.enabled&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.sql.adaptive.coalescePartitions.enabled&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.sql.adaptive.advisoryPartitionSizeInBytes&quot;</span>, <span class="string">&quot;128MB&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ•ˆæœå¯¹æ¯”ç¤ºä¾‹</span></span><br><span class="line">Dataset&lt;Row&gt; df = spark.read().parquet(<span class="string">&quot;large_table.parquet&quot;</span>);</span><br><span class="line">Dataset&lt;Row&gt; result = df.groupBy(<span class="string">&quot;category&quot;</span>).sum(<span class="string">&quot;amount&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¼ ç»Ÿæ–¹å¼ï¼šå¯èƒ½äº§ç”Ÿ200ä¸ªåˆ†åŒºï¼Œå…¶ä¸­150ä¸ªå‡ ä¹ä¸ºç©º</span></span><br><span class="line"><span class="comment">// AQEæ–¹å¼ï¼šè‡ªåŠ¨åˆå¹¶ä¸º50ä¸ªæœ‰æ•ˆåˆ†åŒºï¼Œæ¯ä¸ªçº¦128MB</span></span><br></pre></td></tr></table></figure><p><strong>2. åŠ¨æ€åˆ‡æ¢Joinç­–ç•¥</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AQEä¼šåœ¨è¿è¡Œæ—¶é‡æ–°è¯„ä¼°Joinç­–ç•¥</span></span><br><span class="line">Dataset&lt;Row&gt; largeTable = spark.read().parquet(<span class="string">&quot;large_table.parquet&quot;</span>);</span><br><span class="line">Dataset&lt;Row&gt; smallTable = spark.read().parquet(<span class="string">&quot;small_table.parquet&quot;</span>)</span><br><span class="line">    .filter(col(<span class="string">&quot;active&quot;</span>).equalTo(<span class="literal">true</span>)); <span class="comment">// è¿‡æ»¤åå˜æˆå°è¡¨</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¼€å¯åŠ¨æ€Joinä¼˜åŒ–</span></span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.sql.adaptive.enabled&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.sql.adaptive.localShuffleReader.enabled&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line"></span><br><span class="line">Dataset&lt;Row&gt; joined = largeTable.join(smallTable, <span class="string">&quot;id&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// AQEä¼˜åŒ–è¿‡ç¨‹ï¼š</span></span><br><span class="line"><span class="comment">// 1. åˆå§‹è®¡åˆ’ï¼šSortMergeJoinï¼ˆåŸºäºåŸå§‹è¡¨å¤§å°ï¼‰</span></span><br><span class="line"><span class="comment">// 2. è¿è¡Œæ—¶å‘ç°ï¼šsmallTableè¿‡æ»¤ååªæœ‰10MB</span></span><br><span class="line"><span class="comment">// 3. åŠ¨æ€åˆ‡æ¢ï¼šBroadcastHashJoinï¼ˆé¿å…Shuffleï¼‰</span></span><br></pre></td></tr></table></figure><p><strong>3. æ•°æ®å€¾æ–œè‡ªåŠ¨å¤„ç†</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¼€å¯å€¾æ–œJoinå¤„ç†</span></span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.sql.adaptive.skewJoin.enabled&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.sql.adaptive.skewJoin.skewedPartitionThresholdInBytes&quot;</span>, <span class="string">&quot;256MB&quot;</span>);</span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.sql.adaptive.skewJoin.skewedPartitionFactor&quot;</span>, <span class="string">&quot;5&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å€¾æ–œå¤„ç†ç¤ºä¾‹</span></span><br><span class="line">Dataset&lt;Row&gt; orders = spark.read().parquet(<span class="string">&quot;orders.parquet&quot;</span>);</span><br><span class="line">Dataset&lt;Row&gt; products = spark.read().parquet(<span class="string">&quot;products.parquet&quot;</span>);</span><br><span class="line"></span><br><span class="line">Dataset&lt;Row&gt; skewedJoin = orders.join(products, <span class="string">&quot;product_id&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// AQEå€¾æ–œå¤„ç†æœºåˆ¶ï¼š</span></span><br><span class="line"><span class="comment">// 1. æ£€æµ‹å€¾æ–œï¼šæŸä¸ªåˆ†åŒºå¤§å° &gt; 256MB ä¸” &gt; 5å€å¹³å‡å€¼</span></span><br><span class="line"><span class="comment">// 2. åˆ†è§£å€¾æ–œåˆ†åŒºï¼šå°†å¤§åˆ†åŒºæ‹†åˆ†æˆå¤šä¸ªå­åˆ†åŒº</span></span><br><span class="line"><span class="comment">// 3. å¤åˆ¶å°è¡¨æ•°æ®ï¼šä¸ºæ¯ä¸ªå­åˆ†åŒºå¤åˆ¶å¯¹åº”çš„å°è¡¨æ•°æ®</span></span><br><span class="line"><span class="comment">// 4. å¹¶è¡Œå¤„ç†ï¼šå¤šä¸ªtaskå¹¶è¡Œå¤„ç†åŸæœ¬çš„å•ä¸ªå€¾æ–œåˆ†åŒº</span></span><br></pre></td></tr></table></figure><p><strong>AQEå·¥ä½œåŸç†ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AQEçš„å†³ç­–æœºåˆ¶ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AdaptiveQueryOptimizer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> QueryPlan <span class="title function_">optimize</span><span class="params">(QueryPlan originalPlan)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. æ‰§è¡Œç¬¬ä¸€ä¸ªStage</span></span><br><span class="line">        <span class="type">StageResult</span> <span class="variable">result</span> <span class="operator">=</span> executeStage(originalPlan.getFirstStage());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. æ”¶é›†è¿è¡Œæ—¶ç»Ÿè®¡ä¿¡æ¯</span></span><br><span class="line">        <span class="type">RuntimeStatistics</span> <span class="variable">stats</span> <span class="operator">=</span> collectStatistics(result);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. åŸºäºç»Ÿè®¡ä¿¡æ¯é‡æ–°ä¼˜åŒ–åç»­Stage</span></span><br><span class="line">        <span class="type">QueryPlan</span> <span class="variable">optimizedPlan</span> <span class="operator">=</span> reoptimize(originalPlan, stats);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> optimizedPlan;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> QueryPlan <span class="title function_">reoptimize</span><span class="params">(QueryPlan plan, RuntimeStatistics stats)</span> &#123;</span><br><span class="line">        <span class="type">QueryPlan</span> <span class="variable">newPlan</span> <span class="operator">=</span> plan;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆ†åŒºåˆå¹¶ä¼˜åŒ–</span></span><br><span class="line">        <span class="keyword">if</span> (shouldCoalescePartitions(stats)) &#123;</span><br><span class="line">            newPlan = coalescePartitions(newPlan, stats);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Joinç­–ç•¥ä¼˜åŒ–</span></span><br><span class="line">        <span class="keyword">if</span> (shouldSwitchJoinStrategy(stats)) &#123;</span><br><span class="line">            newPlan = switchJoinStrategy(newPlan, stats);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å€¾æ–œå¤„ç†</span></span><br><span class="line">        <span class="keyword">if</span> (hasDataSkew(stats)) &#123;</span><br><span class="line">            newPlan = handleDataSkew(newPlan, stats);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> newPlan;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ€§èƒ½æå‡æ•ˆæœï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®é™…æµ‹è¯•å¯¹æ¯”ï¼ˆåŸºäºTPC-DSåŸºå‡†æµ‹è¯•ï¼‰</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AQEPerformanceTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testAQEImpact</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// ç¦ç”¨AQE</span></span><br><span class="line">        spark.conf().set(<span class="string">&quot;spark.sql.adaptive.enabled&quot;</span>, <span class="string">&quot;false&quot;</span>);</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime1</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        runComplexQuery();</span><br><span class="line">        <span class="type">long</span> <span class="variable">withoutAQE</span> <span class="operator">=</span> System.currentTimeMillis() - startTime1;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¯ç”¨AQE</span></span><br><span class="line">        spark.conf().set(<span class="string">&quot;spark.sql.adaptive.enabled&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime2</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        runComplexQuery();</span><br><span class="line">        <span class="type">long</span> <span class="variable">withAQE</span> <span class="operator">=</span> System.currentTimeMillis() - startTime2;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å…¸å‹ç»“æœï¼š</span></span><br><span class="line">        <span class="comment">// æ— AQEï¼š180ç§’</span></span><br><span class="line">        <span class="comment">// æœ‰AQEï¼š120ç§’</span></span><br><span class="line">        <span class="comment">// æ€§èƒ½æå‡ï¼š33%</span></span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;AQEæ€§èƒ½æå‡: &quot;</span> + </span><br><span class="line">            (<span class="type">double</span>)(withoutAQE - withAQE) / withoutAQE * <span class="number">100</span> + <span class="string">&quot;%&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>AQEé…ç½®æœ€ä½³å®è·µï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®Œæ•´çš„AQEé…ç½®</span></span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.sql.adaptive.enabled&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ†åŒºåˆå¹¶é…ç½®</span></span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.sql.adaptive.coalescePartitions.enabled&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.sql.adaptive.advisoryPartitionSizeInBytes&quot;</span>, <span class="string">&quot;128MB&quot;</span>);</span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.sql.adaptive.coalescePartitions.minPartitionNum&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å€¾æ–œJoiné…ç½®</span></span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.sql.adaptive.skewJoin.enabled&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.sql.adaptive.skewJoin.skewedPartitionThresholdInBytes&quot;</span>, <span class="string">&quot;256MB&quot;</span>);</span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.sql.adaptive.skewJoin.skewedPartitionFactor&quot;</span>, <span class="string">&quot;5&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æœ¬åœ°Shuffleè¯»å–å™¨é…ç½®</span></span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.sql.adaptive.localShuffleReader.enabled&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›‘æ§å’Œè°ƒè¯•</span></span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.sql.adaptive.logLevel&quot;</span>, <span class="string">&quot;INFO&quot;</span>);</span><br></pre></td></tr></table></figure><h3 id="6-4-Shuffleä¼˜åŒ–ç­–ç•¥"><a href="#6-4-Shuffleä¼˜åŒ–ç­–ç•¥" class="headerlink" title="6.4 Shuffleä¼˜åŒ–ç­–ç•¥"></a>6.4 Shuffleä¼˜åŒ–ç­–ç•¥</h3><h4 id="6-4-1-Map-sideèšåˆ"><a href="#6-4-1-Map-sideèšåˆ" class="headerlink" title="6.4.1 Map-sideèšåˆ"></a>6.4.1 Map-sideèšåˆ</h4><p>Map-sideèšåˆæ˜¯Sparkä¸­ä¸€ç§é‡è¦çš„ä¼˜åŒ–æŠ€æœ¯ï¼Œåœ¨Shuffle Writeé˜¶æ®µå¯¹ç›¸åŒkeyçš„æ•°æ®è¿›è¡Œé¢„èšåˆã€‚</p><p><strong>è§£å†³çš„é—®é¢˜ï¼š</strong></p><ol><li><strong>ç½‘ç»œä¼ è¾“é‡å¤§</strong>ï¼šå¤§é‡é‡å¤keyå¯¼è‡´Shuffleæ•°æ®é‡å·¨å¤§</li><li><strong>å†…å­˜å‹åŠ›å¤§</strong>ï¼šReduceç«¯éœ€è¦å¤„ç†å¤§é‡é‡å¤æ•°æ®</li><li><strong>æ€§èƒ½ç“¶é¢ˆ</strong>ï¼šç½‘ç»œIOæˆä¸ºç³»ç»Ÿç“¶é¢ˆ</li></ol><p><strong>å·¥ä½œåŸç†ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Map-sideèšåˆçš„å†…éƒ¨å®ç°æœºåˆ¶</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MapSideCombiner</span>&lt;K, V, C&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;K, C&gt; combinerMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Function&lt;V, C&gt; createCombiner;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Function2&lt;C, V, C&gt; mergeValue;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MapSideCombiner</span><span class="params">(Function&lt;V, C&gt; createCombiner, </span></span><br><span class="line"><span class="params">                          Function2&lt;C, V, C&gt; mergeValue)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.createCombiner = createCombiner;</span><br><span class="line">        <span class="built_in">this</span>.mergeValue = mergeValue;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">        <span class="type">C</span> <span class="variable">combiner</span> <span class="operator">=</span> combinerMap.get(key);</span><br><span class="line">        <span class="keyword">if</span> (combiner == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// ç¬¬ä¸€æ¬¡é‡åˆ°è¿™ä¸ªkeyï¼Œåˆ›å»ºæ–°çš„combiner</span></span><br><span class="line">            combinerMap.put(key, createCombiner.call(value));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å·²å­˜åœ¨è¯¥keyï¼Œåˆå¹¶value</span></span><br><span class="line">            combinerMap.put(key, mergeValue.call(combiner, value));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å†…å­˜ç®¡ç†ï¼šå½“ç¼“å­˜è¿‡å¤§æ—¶ï¼Œæº¢å†™åˆ°ç£ç›˜</span></span><br><span class="line">        <span class="keyword">if</span> (combinerMap.size() &gt; <span class="number">1000</span>) &#123;</span><br><span class="line">            spillToDisk();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">spillToDisk</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// å°†æ•°æ®å†™å…¥ç£ç›˜ä¸´æ—¶æ–‡ä»¶</span></span><br><span class="line">        writeToSpillFile(combinerMap);</span><br><span class="line">        combinerMap.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ•ˆæœå¯¹æ¯”ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœºæ™¯ï¼šè¯é¢‘ç»Ÿè®¡ï¼Œ100ä¸‡ä¸ªå•è¯ï¼Œå…¶ä¸­åªæœ‰1000ä¸ªä¸åŒçš„å•è¯</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æœªä½¿ç”¨map-sideèšåˆ</span></span><br><span class="line">JavaPairRDD&lt;String, Integer&gt; withoutCombiner = words</span><br><span class="line">    .mapToPair(word -&gt; <span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(word, <span class="number">1</span>))</span><br><span class="line">    .reduceByKey((a, b) -&gt; a + b);</span><br><span class="line"><span class="comment">// Shuffleæ•°æ®é‡ï¼š100ä¸‡æ¡è®°å½•</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨map-sideèšåˆ</span></span><br><span class="line">JavaPairRDD&lt;String, Integer&gt; withCombiner = words</span><br><span class="line">    .mapToPair(word -&gt; <span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(word, <span class="number">1</span>))</span><br><span class="line">    .combineByKey(</span><br><span class="line">    value -&gt; value,                    <span class="comment">// createCombiner</span></span><br><span class="line">    (acc, value) -&gt; acc + value,      <span class="comment">// mergeValue</span></span><br><span class="line">    (acc1, acc2) -&gt; acc1 + acc2       <span class="comment">// mergeCombiners</span></span><br><span class="line">);</span><br><span class="line"><span class="comment">// Shuffleæ•°æ®é‡ï¼šçº¦1000æ¡è®°å½•ï¼ˆ99.9%å‡å°‘ï¼‰</span></span><br></pre></td></tr></table></figure><p><strong>æ‰‹åŠ¨å®ç°map-sideèšåˆï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨mapPartitionså®ç°è‡ªå®šä¹‰map-sideèšåˆ</span></span><br><span class="line">JavaPairRDD&lt;String, Integer&gt; manualCombiner = words.mapPartitionsToPair(iter -&gt; &#123;</span><br><span class="line">    Map&lt;String, Integer&gt; localMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åœ¨åˆ†åŒºå†…è¿›è¡Œé¢„èšåˆ</span></span><br><span class="line">    <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">word</span> <span class="operator">=</span> iter.next();</span><br><span class="line">        localMap.merge(word, <span class="number">1</span>, Integer::sum);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¿”å›èšåˆåçš„ç»“æœ</span></span><br><span class="line">    <span class="keyword">return</span> localMap.entrySet().stream()</span><br><span class="line">        .map(entry -&gt; <span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(entry.getKey(), entry.getValue()))</span><br><span class="line">        .iterator();</span><br><span class="line">&#125;).reduceByKey((a, b) -&gt; a + b);</span><br></pre></td></tr></table></figure><p><strong>é€‚ç”¨åœºæ™¯åˆ¤æ–­ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ¤æ–­æ˜¯å¦é€‚åˆmap-sideèšåˆ</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldUseCombiner</span><span class="params">(JavaPairRDD&lt;K, V&gt; rdd)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. ä¼°ç®—å»é‡æ¯”ä¾‹</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">totalCount</span> <span class="operator">=</span> rdd.count();</span><br><span class="line">    <span class="type">long</span> <span class="variable">distinctCount</span> <span class="operator">=</span> rdd.keys().distinct().count();</span><br><span class="line">    <span class="type">double</span> <span class="variable">selectivity</span> <span class="operator">=</span> (<span class="type">double</span>) distinctCount / totalCount;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. å¦‚æœå»é‡æ¯”ä¾‹å°äº0.5ï¼Œå»ºè®®ä½¿ç”¨combiner</span></span><br><span class="line">    <span class="keyword">return</span> selectivity &lt; <span class="number">0.5</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®é™…åº”ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">if</span> (shouldUseCombiner(originalRDD)) &#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨combineByKey</span></span><br><span class="line">    result = originalRDD.combineByKey(...);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// ç›´æ¥ä½¿ç”¨reduceByKey</span></span><br><span class="line">    result = originalRDD.reduceByKey((a, b) -&gt; a + b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6-4-2-ç½‘ç»œå’Œå†…å­˜ä¼˜åŒ–"><a href="#6-4-2-ç½‘ç»œå’Œå†…å­˜ä¼˜åŒ–" class="headerlink" title="6.4.2 ç½‘ç»œå’Œå†…å­˜ä¼˜åŒ–"></a>6.4.2 ç½‘ç»œå’Œå†…å­˜ä¼˜åŒ–</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è°ƒæ•´ç½‘ç»œè¶…æ—¶æ—¶é—´</span></span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.network.timeout&quot;</span>, <span class="string">&quot;800s&quot;</span>);</span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.executor.heartbeatInterval&quot;</span>, <span class="string">&quot;60s&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯ç”¨ç½‘ç»œå‹ç¼©</span></span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.io.compression.codec&quot;</span>, <span class="string">&quot;snappy&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è°ƒæ•´Shuffleç¼“å†²åŒºå¤§å°</span></span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.shuffle.file.buffer&quot;</span>, <span class="string">&quot;32k&quot;</span>);</span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.shuffle.spill.compress&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨å †å¤–å†…å­˜</span></span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.memory.offHeap.enabled&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.memory.offHeap.size&quot;</span>, <span class="string">&quot;1g&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// é…ç½®map-sideèšåˆçš„å†…å­˜å‚æ•°</span></span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.shuffle.spill&quot;</span>, <span class="string">&quot;true&quot;</span>);  <span class="comment">// å¯ç”¨æº¢å†™</span></span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.shuffle.spill.compress&quot;</span>, <span class="string">&quot;true&quot;</span>);  <span class="comment">// å‹ç¼©æº¢å†™æ–‡ä»¶</span></span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.shuffle.memoryFraction&quot;</span>, <span class="string">&quot;0.2&quot;</span>);   <span class="comment">// èšåˆå†…å­˜å æ¯”</span></span><br></pre></td></tr></table></figure><h3 id="6-5-åŠ¨æ€åˆ†åŒºè£å‰ªï¼ˆDPPï¼‰"><a href="#6-5-åŠ¨æ€åˆ†åŒºè£å‰ªï¼ˆDPPï¼‰" class="headerlink" title="6.5 åŠ¨æ€åˆ†åŒºè£å‰ªï¼ˆDPPï¼‰"></a>6.5 åŠ¨æ€åˆ†åŒºè£å‰ªï¼ˆDPPï¼‰</h3><p><strong>åŠ¨æ€åˆ†åŒºè£å‰ªï¼ˆDPPï¼‰è¯¦è§£ï¼š</strong></p><p>DPPæ˜¯Spark3.xä¸­çš„æ™ºèƒ½ä¼˜åŒ–æŠ€æœ¯ï¼Œèƒ½å¤Ÿåœ¨Joinæ“ä½œä¸­åŠ¨æ€åœ°è·³è¿‡ä¸éœ€è¦è¯»å–çš„åˆ†åŒºï¼Œæ˜¾è‘—å‡å°‘IOæ“ä½œã€‚</p><p><strong>è§£å†³çš„é—®é¢˜ï¼š</strong></p><ol><li><strong>ä¸å¿…è¦çš„æ•°æ®è¯»å–</strong>ï¼šä¼ ç»Ÿæ–¹å¼ä¼šè¯»å–æ‰€æœ‰åˆ†åŒºï¼Œå³ä½¿æŸäº›åˆ†åŒºåœ¨Joinåä¼šè¢«è¿‡æ»¤æ‰</li><li><strong>IOç“¶é¢ˆ</strong>ï¼šå¤§è¡¨çš„å…¨è¡¨æ‰«ææˆä¸ºæ€§èƒ½ç“¶é¢ˆ</li><li><strong>èµ„æºæµªè´¹</strong>ï¼šCPUå’Œå†…å­˜è¢«ç”¨äºå¤„ç†æœ€ç»ˆä¼šè¢«ä¸¢å¼ƒçš„æ•°æ®</li></ol><p><strong>å·¥ä½œåŸç†ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DPPçš„å·¥ä½œæœºåˆ¶ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicPartitionPruning</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demonstrateDPP</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// åœºæ™¯ï¼šé”€å”®äº‹å®è¡¨ JOIN æ—¥æœŸç»´åº¦è¡¨</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¤§è¡¨ï¼šé”€å”®äº‹å®è¡¨ï¼ˆæŒ‰æ—¥æœŸåˆ†åŒºï¼Œ1000ä¸ªåˆ†åŒºï¼‰</span></span><br><span class="line">        Dataset&lt;Row&gt; salesFact = spark.read()</span><br><span class="line">            .option(<span class="string">&quot;basePath&quot;</span>, <span class="string">&quot;s3://data/sales_fact/&quot;</span>)</span><br><span class="line">            .parquet(<span class="string">&quot;s3://data/sales_fact/year=*/month=*/day=*&quot;</span>);</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// å°è¡¨ï¼šæ—¥æœŸç»´åº¦è¡¨</span></span><br><span class="line">        Dataset&lt;Row&gt; dateDim = spark.read()</span><br><span class="line">            .parquet(<span class="string">&quot;s3://data/date_dim/&quot;</span>)</span><br><span class="line">            .filter(col(<span class="string">&quot;is_holiday&quot;</span>).equalTo(<span class="literal">true</span>))  <span class="comment">// åªæœ‰10å¤©æ˜¯èŠ‚å‡æ—¥</span></span><br><span class="line">            .select(<span class="string">&quot;date_key&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¼€å¯DPP</span></span><br><span class="line">        spark.conf().set(<span class="string">&quot;spark.sql.optimizer.dynamicPartitionPruning.enabled&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ‰§è¡ŒJoin</span></span><br><span class="line">        Dataset&lt;Row&gt; result = salesFact</span><br><span class="line">            .join(dateDim, salesFact.col(<span class="string">&quot;date_key&quot;</span>).equalTo(dateDim.col(<span class="string">&quot;date_key&quot;</span>)))</span><br><span class="line">            .select(<span class="string">&quot;sales_amount&quot;</span>, <span class="string">&quot;product_id&quot;</span>);</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// DPPä¼˜åŒ–è¿‡ç¨‹ï¼š</span></span><br><span class="line">        <span class="comment">// 1. å…ˆæ‰§è¡Œå°è¡¨æŸ¥è¯¢ï¼Œè·å¾—date_keyåˆ—è¡¨ï¼ˆ10ä¸ªå€¼ï¼‰</span></span><br><span class="line">        <span class="comment">// 2. å°†è¿™ä¸ªåˆ—è¡¨å¹¿æ’­åˆ°å„ä¸ªExecutor</span></span><br><span class="line">        <span class="comment">// 3. åœ¨è¯»å–å¤§è¡¨æ—¶ï¼Œåªè¯»å–åŒ¹é…è¿™10ä¸ªæ—¥æœŸçš„åˆ†åŒº</span></span><br><span class="line">        <span class="comment">// 4. è·³è¿‡å…¶ä½™990ä¸ªåˆ†åŒºçš„è¯»å–</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ•ˆæœå¯¹æ¯”ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ€§èƒ½æµ‹è¯•å¯¹æ¯”</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DPPPerformanceTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDPPImpact</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// ç¦ç”¨DPP</span></span><br><span class="line">        spark.conf().set(<span class="string">&quot;spark.sql.optimizer.dynamicPartitionPruning.enabled&quot;</span>, <span class="string">&quot;false&quot;</span>);</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime1</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        executeJoinQuery();</span><br><span class="line">        <span class="type">long</span> <span class="variable">withoutDPP</span> <span class="operator">=</span> System.currentTimeMillis() - startTime1;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¯ç”¨DPP</span></span><br><span class="line">        spark.conf().set(<span class="string">&quot;spark.sql.optimizer.dynamicPartitionPruning.enabled&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime2</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        executeJoinQuery();</span><br><span class="line">        <span class="type">long</span> <span class="variable">withDPP</span> <span class="operator">=</span> System.currentTimeMillis() - startTime2;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å…¸å‹ç»“æœï¼š</span></span><br><span class="line">        <span class="comment">// æ— DPPï¼šè¯»å–1000ä¸ªåˆ†åŒºï¼Œè€—æ—¶300ç§’</span></span><br><span class="line">        <span class="comment">// æœ‰DPPï¼šè¯»å–10ä¸ªåˆ†åŒºï¼Œè€—æ—¶30ç§’</span></span><br><span class="line">        <span class="comment">// æ€§èƒ½æå‡ï¼š10å€</span></span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;æ•°æ®è¯»å–é‡å‡å°‘: &quot;</span> + </span><br><span class="line">            (<span class="number">1000</span> - <span class="number">10</span>) / <span class="number">1000.0</span> * <span class="number">100</span> + <span class="string">&quot;%&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;æŸ¥è¯¢æ—¶é—´å‡å°‘: &quot;</span> + </span><br><span class="line">            (<span class="type">double</span>)(withoutDPP - withDPP) / withoutDPP * <span class="number">100</span> + <span class="string">&quot;%&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>DPPè§¦å‘æ¡ä»¶ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DPPç”Ÿæ•ˆçš„å¿…è¦æ¡ä»¶</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DPPConditions</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">canUseDPP</span><span class="params">(Dataset&lt;Row&gt; largeTable, Dataset&lt;Row&gt; smallTable)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. å¤§è¡¨å¿…é¡»æ˜¯åˆ†åŒºè¡¨</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isPartitioned</span> <span class="operator">=</span> largeTable.isPartitioned();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. Joinæ¡ä»¶å¿…é¡»åŒ…å«åˆ†åŒºåˆ—</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">joinOnPartitionColumn</span> <span class="operator">=</span> checkJoinCondition();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. å°è¡¨ç»“æœé›†è¦ç›¸å¯¹è¾ƒå°</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">smallTableIsSmall</span> <span class="operator">=</span> estimateTableSize(smallTable) &lt; <span class="number">10_000_000</span>; <span class="comment">// 10MB</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. é¢„ä¼°èƒ½å¤Ÿè£å‰ªå¤§é‡åˆ†åŒº</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">pruningRatio</span> <span class="operator">=</span> estimatePruningRatio();</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">significantPruning</span> <span class="operator">=</span> pruningRatio &gt; <span class="number">0.5</span>; <span class="comment">// èƒ½è£å‰ª50%ä»¥ä¸Šåˆ†åŒº</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> isPartitioned &amp;&amp; joinOnPartitionColumn &amp;&amp; </span><br><span class="line">               smallTableIsSmall &amp;&amp; significantPruning;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>DPPçš„å†…éƒ¨å®ç°ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DPPçš„æ‰§è¡Œæµç¨‹</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DPPExecutor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Dataset&lt;Row&gt; <span class="title function_">executeWithDPP</span><span class="params">(Dataset&lt;Row&gt; factTable, </span></span><br><span class="line"><span class="params">                                       Dataset&lt;Row&gt; dimTable, </span></span><br><span class="line"><span class="params">                                       String joinColumn)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é˜¶æ®µ1ï¼šæ‰§è¡Œç»´åº¦è¡¨æŸ¥è¯¢ï¼Œæ”¶é›†è¿‡æ»¤å€¼</span></span><br><span class="line">        List&lt;Object&gt; filterValues = collectFilterValues(dimTable, joinColumn);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é˜¶æ®µ2ï¼šåˆ›å»ºåˆ†åŒºè¿‡æ»¤å™¨</span></span><br><span class="line">        <span class="type">PartitionFilter</span> <span class="variable">partitionFilter</span> <span class="operator">=</span> createPartitionFilter(joinColumn, filterValues);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é˜¶æ®µ3ï¼šåº”ç”¨åˆ†åŒºè£å‰ªè¯»å–äº‹å®è¡¨</span></span><br><span class="line">        Dataset&lt;Row&gt; prunedFactTable = factTable</span><br><span class="line">            .filter(partitionFilter)  <span class="comment">// åœ¨æ–‡ä»¶ç³»ç»Ÿå±‚é¢è·³è¿‡åˆ†åŒº</span></span><br><span class="line">            .filter(col(joinColumn).isin(filterValues.toArray())); <span class="comment">// è¡Œçº§è¿‡æ»¤</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é˜¶æ®µ4ï¼šæ‰§è¡Œä¼˜åŒ–åçš„Join</span></span><br><span class="line">        <span class="keyword">return</span> prunedFactTable.join(dimTable, joinColumn);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> List&lt;Object&gt; <span class="title function_">collectFilterValues</span><span class="params">(Dataset&lt;Row&gt; dimTable, String column)</span> &#123;</span><br><span class="line">        <span class="comment">// æ”¶é›†å°è¡¨çš„æ‰€æœ‰å”¯ä¸€å€¼</span></span><br><span class="line">        <span class="keyword">return</span> dimTable.select(column)</span><br><span class="line">            .distinct()</span><br><span class="line">            .collectAsList()</span><br><span class="line">            .stream()</span><br><span class="line">            .map(row -&gt; row.get(<span class="number">0</span>))</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å®é™…åº”ç”¨åœºæ™¯ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç»å…¸DPPåº”ç”¨åœºæ™¯</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åœºæ™¯1ï¼šäº‹å®è¡¨JOINç»´åº¦è¡¨</span></span><br><span class="line">Dataset&lt;Row&gt; orders = spark.read().parquet(<span class="string">&quot;orders/year=*/month=*/&quot;</span>)  <span class="comment">// æŒ‰æœˆåˆ†åŒº</span></span><br><span class="line">    .alias(<span class="string">&quot;orders&quot;</span>);</span><br><span class="line">Dataset&lt;Row&gt; customers = spark.read().parquet(<span class="string">&quot;customers/&quot;</span>)</span><br><span class="line">    .filter(col(<span class="string">&quot;region&quot;</span>).equalTo(<span class="string">&quot;åŒ—äº¬&quot;</span>))  <span class="comment">// åªæœ‰åŒ—äº¬åœ°åŒºå®¢æˆ·</span></span><br><span class="line">    .alias(<span class="string">&quot;customers&quot;</span>);</span><br><span class="line"></span><br><span class="line">Dataset&lt;Row&gt; beijingOrders = orders.join(customers, </span><br><span class="line">    orders.col(<span class="string">&quot;customer_id&quot;</span>).equalTo(customers.col(<span class="string">&quot;customer_id&quot;</span>)));</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœºæ™¯2ï¼šæ—¶é—´èŒƒå›´æŸ¥è¯¢</span></span><br><span class="line">Dataset&lt;Row&gt; transactions = spark.read().parquet(<span class="string">&quot;transactions/date=*/&quot;</span>)</span><br><span class="line">    .alias(<span class="string">&quot;trans&quot;</span>);</span><br><span class="line">Dataset&lt;Row&gt; holidayDates = spark.read().parquet(<span class="string">&quot;holidays/&quot;</span>)</span><br><span class="line">    .filter(col(<span class="string">&quot;year&quot;</span>).equalTo(<span class="number">2024</span>))</span><br><span class="line">    .alias(<span class="string">&quot;holidays&quot;</span>);</span><br><span class="line"></span><br><span class="line">Dataset&lt;Row&gt; holidayTransactions = transactions.join(holidayDates,</span><br><span class="line">    transactions.col(<span class="string">&quot;date&quot;</span>).equalTo(holidayDates.col(<span class="string">&quot;date&quot;</span>)));</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœºæ™¯3ï¼šå¤šçº§åˆ†åŒºè£å‰ª</span></span><br><span class="line">Dataset&lt;Row&gt; salesData = spark.read()</span><br><span class="line">    .parquet(<span class="string">&quot;sales/country=*/state=*/city=*/&quot;</span>)</span><br><span class="line">    .alias(<span class="string">&quot;sales&quot;</span>);</span><br><span class="line">Dataset&lt;Row&gt; targetCities = spark.read().parquet(<span class="string">&quot;target_cities/&quot;</span>)</span><br><span class="line">    .filter(col(<span class="string">&quot;campaign_active&quot;</span>).equalTo(<span class="literal">true</span>))</span><br><span class="line">    .alias(<span class="string">&quot;cities&quot;</span>);</span><br><span class="line"></span><br><span class="line">Dataset&lt;Row&gt; campaignSales = salesData.join(targetCities,</span><br><span class="line">    expr(<span class="string">&quot;sales.country = cities.country AND &quot;</span> +</span><br><span class="line">         <span class="string">&quot;sales.state = cities.state AND &quot;</span> +</span><br><span class="line">         <span class="string">&quot;sales.city = cities.city&quot;</span>));</span><br></pre></td></tr></table></figure><p><strong>DPPé…ç½®ä¼˜åŒ–ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DPPç›¸å…³é…ç½®</span></span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.sql.optimizer.dynamicPartitionPruning.enabled&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.sql.optimizer.dynamicPartitionPruning.useStats&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.sql.optimizer.dynamicPartitionPruning.fallbackFilterRatio&quot;</span>, <span class="string">&quot;0.5&quot;</span>);</span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.sql.optimizer.dynamicPartitionPruning.reuseBroadcastOnly&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›‘æ§DPPæ•ˆæœ</span></span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.sql.adaptive.logLevel&quot;</span>, <span class="string">&quot;INFO&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨Spark UIä¸­æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ï¼Œåº”è¯¥èƒ½çœ‹åˆ°ï¼š</span></span><br><span class="line"><span class="comment">// &quot;PartitionFilters: [isnotnull(date_key#123), dynamicpruning#456]&quot;</span></span><br></pre></td></tr></table></figure><p><strong>DPPæœ€ä½³å®è·µï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. ç¡®ä¿åˆ†åŒºåˆ—å‚ä¸Joinæ¡ä»¶</span></span><br><span class="line"><span class="comment">// âœ… æ­£ç¡®</span></span><br><span class="line">factTable.join(dimTable, factTable.col(<span class="string">&quot;partition_col&quot;</span>).equalTo(dimTable.col(<span class="string">&quot;join_col&quot;</span>)))</span><br><span class="line"></span><br><span class="line"><span class="comment">// âŒ é”™è¯¯ï¼šåˆ†åŒºåˆ—æœªå‚ä¸Join</span></span><br><span class="line">factTable.join(dimTable, factTable.col(<span class="string">&quot;other_col&quot;</span>).equalTo(dimTable.col(<span class="string">&quot;join_col&quot;</span>)))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. å°è¡¨è¿‡æ»¤è¦åœ¨Joinä¹‹å‰</span></span><br><span class="line"><span class="comment">// âœ… æ­£ç¡®</span></span><br><span class="line">Dataset&lt;Row&gt; filteredDim = dimTable.filter(col(<span class="string">&quot;active&quot;</span>).equalTo(<span class="literal">true</span>));</span><br><span class="line">factTable.join(filteredDim, <span class="string">&quot;key&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// âŒ é”™è¯¯ï¼šè¿‡æ»¤åœ¨Joinä¹‹å</span></span><br><span class="line">factTable.join(dimTable, <span class="string">&quot;key&quot;</span>).filter(col(<span class="string">&quot;active&quot;</span>).equalTo(<span class="literal">true</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. åˆç†è®¾è®¡åˆ†åŒºç­–ç•¥</span></span><br><span class="line"><span class="comment">// é€‰æ‹©åˆé€‚çš„åˆ†åŒºåˆ—ï¼Œç¡®ä¿æŸ¥è¯¢æ¨¡å¼èƒ½å¤Ÿåˆ©ç”¨DPP</span></span><br></pre></td></tr></table></figure><h3 id="6-6-è‡ªå®šä¹‰åˆ†åŒºå™¨ï¼šè§£å†³æ•°æ®å€¾æ–œçš„åˆ©å™¨"><a href="#6-6-è‡ªå®šä¹‰åˆ†åŒºå™¨ï¼šè§£å†³æ•°æ®å€¾æ–œçš„åˆ©å™¨" class="headerlink" title="6.6 è‡ªå®šä¹‰åˆ†åŒºå™¨ï¼šè§£å†³æ•°æ®å€¾æ–œçš„åˆ©å™¨"></a>6.6 è‡ªå®šä¹‰åˆ†åŒºå™¨ï¼šè§£å†³æ•°æ®å€¾æ–œçš„åˆ©å™¨</h3><h4 id="6-6-1-åˆ†åŒºå™¨ç±»å‹å¯¹æ¯”"><a href="#6-6-1-åˆ†åŒºå™¨ç±»å‹å¯¹æ¯”" class="headerlink" title="6.6.1 åˆ†åŒºå™¨ç±»å‹å¯¹æ¯”"></a>6.6.1 åˆ†åŒºå™¨ç±»å‹å¯¹æ¯”</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. é»˜è®¤Hashåˆ†åŒºå™¨ - ç®€å•ä½†å¯èƒ½ä¸å‡åŒ€</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HashPartitioner</span> <span class="keyword">extends</span> <span class="title class_">Partitioner</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> numPartitions;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getPartition</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Math.abs(key.hashCode()) % numPartitions;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. èŒƒå›´åˆ†åŒºå™¨ - é€‚åˆæ’åºæ“ä½œ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RangePartitioner</span>&lt;K, V&gt; <span class="keyword">extends</span> <span class="title class_">Partitioner</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Object[] rangeBounds;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getPartition</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="comment">// æ ¹æ®keyçš„å€¼èŒƒå›´ç¡®å®šåˆ†åŒº</span></span><br><span class="line">        <span class="keyword">return</span> binarySearch(rangeBounds, key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. è‡ªå®šä¹‰åˆ†åŒºå™¨ - è§£å†³ç‰¹å®šä¸šåŠ¡é—®é¢˜</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BusinessPartitioner</span> <span class="keyword">extends</span> <span class="title class_">Partitioner</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getPartition</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="comment">// æ ¹æ®ä¸šåŠ¡é€»è¾‘ç¡®å®šåˆ†åŒº</span></span><br><span class="line">        <span class="keyword">if</span> (key <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">strKey</span> <span class="operator">=</span> (String) key;</span><br><span class="line">            <span class="keyword">if</span> (strKey.startsWith(<span class="string">&quot;VIP_&quot;</span>)) &#123;</span><br><span class="line">                <span class="comment">// VIPç”¨æˆ·æ•°æ®åˆ†æ•£åˆ°å‰å‡ ä¸ªåˆ†åŒº</span></span><br><span class="line">                <span class="keyword">return</span> Math.abs(strKey.hashCode()) % <span class="number">5</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// æ™®é€šç”¨æˆ·æ•°æ®åˆ†æ•£åˆ°åé¢çš„åˆ†åŒº</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">5</span> + (Math.abs(strKey.hashCode()) % (numPartitions - <span class="number">5</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Math.abs(key.hashCode()) % numPartitions;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6-6-2-å®é™…åº”ç”¨åœºæ™¯"><a href="#6-6-2-å®é™…åº”ç”¨åœºæ™¯" class="headerlink" title="6.6.2 å®é™…åº”ç”¨åœºæ™¯"></a>6.6.2 å®é™…åº”ç”¨åœºæ™¯</h4><p><strong>åœºæ™¯1ï¼šå¤„ç†çƒ­ç‚¹æ•°æ®</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç”µå•†åœºæ™¯ï¼šå¤„ç†çˆ†æ¬¾å•†å“çš„è®¢å•æ•°æ®</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductPartitioner</span> <span class="keyword">extends</span> <span class="title class_">Partitioner</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Set&lt;String&gt; hotProducts;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> numPartitions;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ProductPartitioner</span><span class="params">(Set&lt;String&gt; hotProducts, <span class="type">int</span> numPartitions)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.hotProducts = hotProducts;</span><br><span class="line">        <span class="built_in">this</span>.numPartitions = numPartitions;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getPartition</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">productId</span> <span class="operator">=</span> (String) key;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (hotProducts.contains(productId)) &#123;</span><br><span class="line">            <span class="comment">// çƒ­ç‚¹å•†å“ï¼šä½¿ç”¨åŠ ç›æŠ€æœ¯åˆ†æ•£åˆ°å¤šä¸ªåˆ†åŒº</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">saltedKey</span> <span class="operator">=</span> productId + <span class="string">&quot;_&quot;</span> + (Math.abs(productId.hashCode()) % <span class="number">10</span>);</span><br><span class="line">            <span class="keyword">return</span> Math.abs(saltedKey.hashCode()) % numPartitions;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æ™®é€šå•†å“ï¼šæ­£å¸¸åˆ†åŒº</span></span><br><span class="line">            <span class="keyword">return</span> Math.abs(productId.hashCode()) % numPartitions;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line">Set&lt;String&gt; hotProducts = Set.of(<span class="string">&quot;product_001&quot;</span>, <span class="string">&quot;product_002&quot;</span>, <span class="string">&quot;product_003&quot;</span>);</span><br><span class="line"><span class="type">ProductPartitioner</span> <span class="variable">partitioner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProductPartitioner</span>(hotProducts, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">JavaPairRDD&lt;String, Order&gt; orders = ordersRDD.mapToPair(order -&gt; </span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(order.getProductId(), order));</span><br><span class="line"></span><br><span class="line">JavaPairRDD&lt;String, Order&gt; partitionedOrders = orders.partitionBy(partitioner);</span><br></pre></td></tr></table></figure><p><strong>åœºæ™¯2ï¼šåœ°ç†ä½ç½®åˆ†åŒº</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŸºäºåœ°ç†ä½ç½®çš„è‡ªå®šä¹‰åˆ†åŒºå™¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GeographicPartitioner</span> <span class="keyword">extends</span> <span class="title class_">Partitioner</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Integer&gt; regionToPartition;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> numPartitions;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GeographicPartitioner</span><span class="params">(<span class="type">int</span> numPartitions)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.numPartitions = numPartitions;</span><br><span class="line">        <span class="built_in">this</span>.regionToPartition = initializeRegionMapping();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Integer&gt; <span class="title function_">initializeRegionMapping</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, Integer&gt; mapping = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// åŒ—äº¬ã€ä¸Šæµ·ã€æ·±åœ³ç­‰ä¸€çº¿åŸå¸‚åˆ†é…æ›´å¤šåˆ†åŒº</span></span><br><span class="line">        mapping.put(<span class="string">&quot;åŒ—äº¬&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        mapping.put(<span class="string">&quot;ä¸Šæµ·&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        mapping.put(<span class="string">&quot;æ·±åœ³&quot;</span>, <span class="number">2</span>);</span><br><span class="line">        mapping.put(<span class="string">&quot;å¹¿å·&quot;</span>, <span class="number">3</span>);</span><br><span class="line">        <span class="comment">// å…¶ä»–åŸå¸‚å…±äº«å‰©ä½™åˆ†åŒº</span></span><br><span class="line">        <span class="keyword">return</span> mapping;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getPartition</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">location</span> <span class="operator">=</span> extractLocation((String) key);</span><br><span class="line">        </span><br><span class="line">        <span class="type">Integer</span> <span class="variable">partition</span> <span class="operator">=</span> regionToPartition.get(location);</span><br><span class="line">        <span class="keyword">if</span> (partition != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> partition;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å…¶ä»–åœ°åŒºä½¿ç”¨hashåˆ†åŒºï¼Œåˆ†é…åˆ°åé¢çš„åˆ†åŒº</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">4</span> + (Math.abs(key.hashCode()) % (numPartitions - <span class="number">4</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>åœºæ™¯3ï¼šæ—¶é—´åºåˆ—åˆ†åŒº</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŸºäºæ—¶é—´çš„åˆ†åŒºå™¨ï¼Œç¡®ä¿ç›¸åŒæ—¶é—´æ®µçš„æ•°æ®åœ¨åŒä¸€åˆ†åŒº</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TimeBasedPartitioner</span> <span class="keyword">extends</span> <span class="title class_">Partitioner</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> timeWindowMillis;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> numPartitions;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TimeBasedPartitioner</span><span class="params">(<span class="type">long</span> timeWindowMillis, <span class="type">int</span> numPartitions)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.timeWindowMillis = timeWindowMillis;</span><br><span class="line">        <span class="built_in">this</span>.numPartitions = numPartitions;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getPartition</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (key <span class="keyword">instanceof</span> Long) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">timestamp</span> <span class="operator">=</span> (Long) key;</span><br><span class="line">            <span class="comment">// æŒ‰æ—¶é—´çª—å£åˆ†åŒº</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">timeWindow</span> <span class="operator">=</span> timestamp / timeWindowMillis;</span><br><span class="line">            <span class="keyword">return</span> (<span class="type">int</span>) (timeWindow % numPartitions);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Math.abs(key.hashCode()) % numPartitions;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹ï¼šæŒ‰å°æ—¶åˆ†åŒºæ—¥å¿—æ•°æ®</span></span><br><span class="line"><span class="type">TimeBasedPartitioner</span> <span class="variable">hourlyPartitioner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TimeBasedPartitioner</span>(</span><br><span class="line">    <span class="number">3600000L</span>, <span class="comment">// 1å°æ—¶</span></span><br><span class="line">    <span class="number">24</span>        <span class="comment">// 24ä¸ªåˆ†åŒº</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">JavaPairRDD&lt;Long, LogEntry&gt; hourlyLogs = logsRDD</span><br><span class="line">    .mapToPair(log -&gt; <span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(log.getTimestamp(), log))</span><br><span class="line">    .partitionBy(hourlyPartitioner);</span><br></pre></td></tr></table></figure><h4 id="6-6-3-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥"><a href="#6-6-3-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥" class="headerlink" title="6.6.3 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥"></a>6.6.3 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</h4><p><strong>1. åˆ†åŒºæ•°é‡é€‰æ‹©</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¡ç®—æœ€ä¼˜åˆ†åŒºæ•°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PartitionCalculator</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">calculateOptimalPartitions</span><span class="params">(JavaSparkContext sc, <span class="type">long</span> dataSize)</span> &#123;</span><br><span class="line">        <span class="comment">// è§„åˆ™1ï¼šæ¯ä¸ªåˆ†åŒº128MB-256MBæœ€ä¼˜</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">targetPartitionSize</span> <span class="operator">=</span> <span class="number">128</span> * <span class="number">1024</span> * <span class="number">1024</span>; <span class="comment">// 128MB</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">dataSizeBasedPartitions</span> <span class="operator">=</span> (<span class="type">int</span>) (dataSize / targetPartitionSize);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è§„åˆ™2ï¼šåˆ†åŒºæ•°ä¸è¶…è¿‡CPUæ ¸å¿ƒæ•°çš„2-3å€</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">totalCores</span> <span class="operator">=</span> sc.defaultParallelism();</span><br><span class="line">        <span class="type">int</span> <span class="variable">coreBasedPartitions</span> <span class="operator">=</span> totalCores * <span class="number">3</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è§„åˆ™3ï¼šæœ€å°‘åˆ†åŒºæ•°ä¿è¯å¹¶è¡Œåº¦</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">minPartitions</span> <span class="operator">=</span> totalCores;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> Math.max(minPartitions, </span><br><span class="line">               Math.min(dataSizeBasedPartitions, coreBasedPartitions));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2. åˆ†åŒºå™¨æ€§èƒ½æµ‹è¯•</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ†åŒºå™¨æ•ˆæœè¯„ä¼°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PartitionerEvaluator</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">evaluatePartitioner</span><span class="params">(JavaPairRDD&lt;String, ?&gt; rdd, Partitioner partitioner)</span> &#123;</span><br><span class="line">        JavaPairRDD&lt;String, ?&gt; partitionedRDD = rdd.partitionBy(partitioner);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ç»Ÿè®¡æ¯ä¸ªåˆ†åŒºçš„æ•°æ®é‡</span></span><br><span class="line">        Map&lt;Integer, Long&gt; partitionSizes = partitionedRDD</span><br><span class="line">            .mapPartitionsWithIndex((index, iter) -&gt; &#123;</span><br><span class="line">                <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">                    iter.next();</span><br><span class="line">                    count++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> Collections.singletonList(<span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(index, count)).iterator();</span><br><span class="line">            &#125;, <span class="literal">false</span>)</span><br><span class="line">            .collectAsMap();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è®¡ç®—åˆ†åŒºä¸å‡åŒ€åº¦</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">avgSize</span> <span class="operator">=</span> partitionSizes.values().stream()</span><br><span class="line">            .mapToLong(Long::longValue)</span><br><span class="line">            .average()</span><br><span class="line">            .orElse(<span class="number">0.0</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">double</span> <span class="variable">maxSize</span> <span class="operator">=</span> partitionSizes.values().stream()</span><br><span class="line">            .mapToLong(Long::longValue)</span><br><span class="line">            .max()</span><br><span class="line">            .orElse(<span class="number">0L</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">double</span> <span class="variable">skewness</span> <span class="operator">=</span> maxSize / avgSize;</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;å¹³å‡åˆ†åŒºå¤§å°: &quot;</span> + avgSize);</span><br><span class="line">        System.out.println(<span class="string">&quot;æœ€å¤§åˆ†åŒºå¤§å°: &quot;</span> + maxSize);</span><br><span class="line">        System.out.println(<span class="string">&quot;æ•°æ®å€¾æ–œåº¦: &quot;</span> + skewness);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (skewness &gt; <span class="number">2.0</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;è­¦å‘Šï¼šå­˜åœ¨ä¸¥é‡æ•°æ®å€¾æ–œï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>3. åŠ¨æ€åˆ†åŒºç­–ç•¥</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ ¹æ®æ•°æ®ç‰¹å¾åŠ¨æ€é€‰æ‹©åˆ†åŒºå™¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AdaptivePartitioner</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Partitioner <span class="title function_">choosePartitioner</span><span class="params">(JavaPairRDD&lt;String, ?&gt; rdd, </span></span><br><span class="line"><span class="params">                                               <span class="type">int</span> numPartitions)</span> &#123;</span><br><span class="line">        <span class="comment">// é‡‡æ ·åˆ†ææ•°æ®ç‰¹å¾</span></span><br><span class="line">        List&lt;String&gt; sample = rdd.keys().sample(<span class="literal">false</span>, <span class="number">0.01</span>).collect();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆ†ææ•°æ®åˆ†å¸ƒ</span></span><br><span class="line">        Map&lt;String, Long&gt; keyFrequency = sample.stream()</span><br><span class="line">            .collect(Collectors.groupingBy(</span><br><span class="line">                key -&gt; key,</span><br><span class="line">                Collectors.counting()</span><br><span class="line">            ));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ£€æµ‹çƒ­ç‚¹key</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">avgFrequency</span> <span class="operator">=</span> sample.size() / keyFrequency.size();</span><br><span class="line">        Set&lt;String&gt; hotKeys = keyFrequency.entrySet().stream()</span><br><span class="line">            .filter(entry -&gt; entry.getValue() &gt; avgFrequency * <span class="number">10</span>)</span><br><span class="line">            .map(Map.Entry::getKey)</span><br><span class="line">            .collect(Collectors.toSet());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!hotKeys.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">// å­˜åœ¨çƒ­ç‚¹keyï¼Œä½¿ç”¨ç‰¹æ®Šåˆ†åŒºå™¨</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HotKeyPartitioner</span>(hotKeys, numPartitions);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æ•°æ®åˆ†å¸ƒå‡åŒ€ï¼Œä½¿ç”¨é»˜è®¤åˆ†åŒºå™¨</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashPartitioner</span>(numPartitions);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-7-æ•°æ®å€¾æ–œå¤„ç†ç­–ç•¥"><a href="#6-7-æ•°æ®å€¾æ–œå¤„ç†ç­–ç•¥" class="headerlink" title="6.7 æ•°æ®å€¾æ–œå¤„ç†ç­–ç•¥"></a>6.7 æ•°æ®å€¾æ–œå¤„ç†ç­–ç•¥</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¤„ç†æ•°æ®å€¾æ–œçš„å¤šç§ç­–ç•¥</span></span><br><span class="line">JavaPairRDD&lt;String, Integer&gt; skewedRDD = rdd.mapPartitionsToPair(iter -&gt; &#123;</span><br><span class="line">    <span class="comment">// ç­–ç•¥1ï¼šmap-sideé¢„èšåˆ</span></span><br><span class="line">    Map&lt;String, Integer&gt; localMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">        Tuple2&lt;String, Integer&gt; tuple = iter.next();</span><br><span class="line">        localMap.merge(tuple._1, tuple._2, Integer::sum);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> localMap.entrySet().stream()</span><br><span class="line">        .map(entry -&gt; <span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(entry.getKey(), entry.getValue()))</span><br><span class="line">        .iterator();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç­–ç•¥2ï¼šä¸¤é˜¶æ®µèšåˆ</span></span><br><span class="line">JavaPairRDD&lt;String, Integer&gt; twoPhaseAgg = rdd</span><br><span class="line">    .mapToPair(tuple -&gt; <span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(tuple._1 + <span class="string">&quot;_&quot;</span> + (Math.abs(tuple._1.hashCode()) % <span class="number">10</span>), tuple._2))</span><br><span class="line">    .reduceByKey((a, b) -&gt; a + b)</span><br><span class="line">    .mapToPair(tuple -&gt; <span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(tuple._1.split(<span class="string">&quot;_&quot;</span>)[<span class="number">0</span>], tuple._2))</span><br><span class="line">    .reduceByKey((a, b) -&gt; a + b);</span><br></pre></td></tr></table></figure><p><strong>è‡ªå®šä¹‰åˆ†åŒºå™¨å¤„ç†å€¾æ–œï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è‡ªå®šä¹‰åˆ†åŒºå™¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SkewPartitioner</span> <span class="keyword">extends</span> <span class="title class_">Partitioner</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> numPartitions;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String skewedKey;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SkewPartitioner</span><span class="params">(<span class="type">int</span> numPartitions, String skewedKey)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.numPartitions = numPartitions;</span><br><span class="line">        <span class="built_in">this</span>.skewedKey = skewedKey;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">numPartitions</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> numPartitions;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getPartition</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (skewedKey.equals(key)) &#123;</span><br><span class="line">            <span class="comment">// å°†å€¾æ–œçš„keyåˆ†æ•£åˆ°å¤šä¸ªåˆ†åŒº</span></span><br><span class="line">            <span class="keyword">return</span> Math.abs(key.hashCode()) % numPartitions;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Math.abs(key.hashCode()) % numPartitions;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è‡ªå®šä¹‰åˆ†åŒºå™¨è¯¦è§£ï¼š</strong></p><p>è‡ªå®šä¹‰åˆ†åŒºå™¨æ˜¯Sparkä¸­è§£å†³æ•°æ®åˆ†å¸ƒä¸å‡é—®é¢˜çš„é‡è¦å·¥å…·ï¼Œé€šè¿‡æ§åˆ¶æ•°æ®çš„åˆ†åŒºé€»è¾‘æ¥ä¼˜åŒ–æ€§èƒ½ã€‚</p><p><strong>è§£å†³çš„é—®é¢˜ï¼š</strong></p><ol><li><strong>æ•°æ®å€¾æ–œ</strong>ï¼šæŸäº›keyçš„æ•°æ®é‡è¿œå¤§äºå…¶ä»–keyï¼Œå¯¼è‡´ä¸ªåˆ«åˆ†åŒºè¿‡å¤§</li><li><strong>çƒ­ç‚¹é—®é¢˜</strong>ï¼šé«˜é¢‘è®¿é—®çš„æ•°æ®é›†ä¸­åœ¨å°‘æ•°åˆ†åŒºï¼Œé€ æˆè´Ÿè½½ä¸å‡</li><li><strong>é»˜è®¤åˆ†åŒºå™¨å±€é™æ€§</strong>ï¼šHashPartitioneræ— æ³•å¤„ç†ç‰¹æ®Šçš„æ•°æ®åˆ†å¸ƒæ¨¡å¼</li></ol><p><strong>åˆ†åŒºå™¨ç±»å‹å¯¹æ¯”ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. é»˜è®¤Hashåˆ†åŒºå™¨ - ç®€å•ä½†å¯èƒ½ä¸å‡åŒ€</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HashPartitioner</span> <span class="keyword">extends</span> <span class="title class_">Partitioner</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> numPartitions;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getPartition</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Math.abs(key.hashCode()) % numPartitions;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. èŒƒå›´åˆ†åŒºå™¨ - é€‚åˆæ’åºæ“ä½œ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RangePartitioner</span>&lt;K, V&gt; <span class="keyword">extends</span> <span class="title class_">Partitioner</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Object[] rangeBounds;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getPartition</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="comment">// æ ¹æ®keyçš„å€¼èŒƒå›´ç¡®å®šåˆ†åŒº</span></span><br><span class="line">        <span class="keyword">return</span> binarySearch(rangeBounds, key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. è‡ªå®šä¹‰åˆ†åŒºå™¨ - è§£å†³ç‰¹å®šä¸šåŠ¡é—®é¢˜</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BusinessPartitioner</span> <span class="keyword">extends</span> <span class="title class_">Partitioner</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getPartition</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="comment">// æ ¹æ®ä¸šåŠ¡é€»è¾‘ç¡®å®šåˆ†åŒº</span></span><br><span class="line">        <span class="keyword">if</span> (key <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">strKey</span> <span class="operator">=</span> (String) key;</span><br><span class="line">            <span class="keyword">if</span> (strKey.startsWith(<span class="string">&quot;VIP_&quot;</span>)) &#123;</span><br><span class="line">                <span class="comment">// VIPç”¨æˆ·æ•°æ®åˆ†æ•£åˆ°å‰å‡ ä¸ªåˆ†åŒº</span></span><br><span class="line">                <span class="keyword">return</span> Math.abs(strKey.hashCode()) % <span class="number">5</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// æ™®é€šç”¨æˆ·æ•°æ®åˆ†æ•£åˆ°åé¢çš„åˆ†åŒº</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">5</span> + (Math.abs(strKey.hashCode()) % (numPartitions - <span class="number">5</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Math.abs(key.hashCode()) % numPartitions;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å®é™…åº”ç”¨åœºæ™¯ï¼š</strong></p><p><strong>åœºæ™¯1ï¼šå¤„ç†çƒ­ç‚¹æ•°æ®</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç”µå•†åœºæ™¯ï¼šå¤„ç†çˆ†æ¬¾å•†å“çš„è®¢å•æ•°æ®</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductPartitioner</span> <span class="keyword">extends</span> <span class="title class_">Partitioner</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Set&lt;String&gt; hotProducts;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> numPartitions;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ProductPartitioner</span><span class="params">(Set&lt;String&gt; hotProducts, <span class="type">int</span> numPartitions)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.hotProducts = hotProducts;</span><br><span class="line">        <span class="built_in">this</span>.numPartitions = numPartitions;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getPartition</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">productId</span> <span class="operator">=</span> (String) key;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (hotProducts.contains(productId)) &#123;</span><br><span class="line">            <span class="comment">// çƒ­ç‚¹å•†å“ï¼šä½¿ç”¨åŠ ç›æŠ€æœ¯åˆ†æ•£åˆ°å¤šä¸ªåˆ†åŒº</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">saltedKey</span> <span class="operator">=</span> productId + <span class="string">&quot;_&quot;</span> + (Math.abs(productId.hashCode()) % <span class="number">10</span>);</span><br><span class="line">            <span class="keyword">return</span> Math.abs(saltedKey.hashCode()) % numPartitions;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æ™®é€šå•†å“ï¼šæ­£å¸¸åˆ†åŒº</span></span><br><span class="line">            <span class="keyword">return</span> Math.abs(productId.hashCode()) % numPartitions;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line">Set&lt;String&gt; hotProducts = Set.of(<span class="string">&quot;product_001&quot;</span>, <span class="string">&quot;product_002&quot;</span>, <span class="string">&quot;product_003&quot;</span>);</span><br><span class="line"><span class="type">ProductPartitioner</span> <span class="variable">partitioner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProductPartitioner</span>(hotProducts, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">JavaPairRDD&lt;String, Order&gt; orders = ordersRDD.mapToPair(order -&gt; </span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(order.getProductId(), order));</span><br><span class="line"></span><br><span class="line">JavaPairRDD&lt;String, Order&gt; partitionedOrders = orders.partitionBy(partitioner);</span><br></pre></td></tr></table></figure><p><strong>åœºæ™¯2ï¼šåœ°ç†ä½ç½®åˆ†åŒº</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŸºäºåœ°ç†ä½ç½®çš„è‡ªå®šä¹‰åˆ†åŒºå™¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GeographicPartitioner</span> <span class="keyword">extends</span> <span class="title class_">Partitioner</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Integer&gt; regionToPartition;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> numPartitions;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GeographicPartitioner</span><span class="params">(<span class="type">int</span> numPartitions)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.numPartitions = numPartitions;</span><br><span class="line">        <span class="built_in">this</span>.regionToPartition = initializeRegionMapping();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Integer&gt; <span class="title function_">initializeRegionMapping</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, Integer&gt; mapping = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// åŒ—äº¬ã€ä¸Šæµ·ã€æ·±åœ³ç­‰ä¸€çº¿åŸå¸‚åˆ†é…æ›´å¤šåˆ†åŒº</span></span><br><span class="line">        mapping.put(<span class="string">&quot;åŒ—äº¬&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        mapping.put(<span class="string">&quot;ä¸Šæµ·&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        mapping.put(<span class="string">&quot;æ·±åœ³&quot;</span>, <span class="number">2</span>);</span><br><span class="line">        mapping.put(<span class="string">&quot;å¹¿å·&quot;</span>, <span class="number">3</span>);</span><br><span class="line">        <span class="comment">// å…¶ä»–åŸå¸‚å…±äº«å‰©ä½™åˆ†åŒº</span></span><br><span class="line">        <span class="keyword">return</span> mapping;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getPartition</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">location</span> <span class="operator">=</span> extractLocation((String) key);</span><br><span class="line">        </span><br><span class="line">        <span class="type">Integer</span> <span class="variable">partition</span> <span class="operator">=</span> regionToPartition.get(location);</span><br><span class="line">        <span class="keyword">if</span> (partition != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> partition;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å…¶ä»–åœ°åŒºä½¿ç”¨hashåˆ†åŒºï¼Œåˆ†é…åˆ°åé¢çš„åˆ†åŒº</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">4</span> + (Math.abs(key.hashCode()) % (numPartitions - <span class="number">4</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>åœºæ™¯3ï¼šæ—¶é—´åºåˆ—åˆ†åŒº</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŸºäºæ—¶é—´çš„åˆ†åŒºå™¨ï¼Œç¡®ä¿ç›¸åŒæ—¶é—´æ®µçš„æ•°æ®åœ¨åŒä¸€åˆ†åŒº</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TimeBasedPartitioner</span> <span class="keyword">extends</span> <span class="title class_">Partitioner</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> timeWindowMillis;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> numPartitions;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TimeBasedPartitioner</span><span class="params">(<span class="type">long</span> timeWindowMillis, <span class="type">int</span> numPartitions)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.timeWindowMillis = timeWindowMillis;</span><br><span class="line">        <span class="built_in">this</span>.numPartitions = numPartitions;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getPartition</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (key <span class="keyword">instanceof</span> Long) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">timestamp</span> <span class="operator">=</span> (Long) key;</span><br><span class="line">            <span class="comment">// æŒ‰æ—¶é—´çª—å£åˆ†åŒº</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">timeWindow</span> <span class="operator">=</span> timestamp / timeWindowMillis;</span><br><span class="line">            <span class="keyword">return</span> (<span class="type">int</span>) (timeWindow % numPartitions);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Math.abs(key.hashCode()) % numPartitions;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ç¤ºä¾‹ï¼šæŒ‰å°æ—¶åˆ†åŒºæ—¥å¿—æ•°æ®</span></span><br><span class="line"><span class="type">TimeBasedPartitioner</span> <span class="variable">hourlyPartitioner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TimeBasedPartitioner</span>(</span><br><span class="line">    <span class="number">3600000L</span>, <span class="comment">// 1å°æ—¶</span></span><br><span class="line">    <span class="number">24</span>        <span class="comment">// 24ä¸ªåˆ†åŒº</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">JavaPairRDD&lt;Long, LogEntry&gt; hourlyLogs = logsRDD</span><br><span class="line">    .mapToPair(log -&gt; <span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(log.getTimestamp(), log))</span><br><span class="line">    .partitionBy(hourlyPartitioner);</span><br></pre></td></tr></table></figure><p><strong>æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ï¼š</strong></p><p><strong>1. åˆ†åŒºæ•°é‡é€‰æ‹©</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¡ç®—æœ€ä¼˜åˆ†åŒºæ•°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PartitionCalculator</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">calculateOptimalPartitions</span><span class="params">(JavaSparkContext sc, <span class="type">long</span> dataSize)</span> &#123;</span><br><span class="line">        <span class="comment">// è§„åˆ™1ï¼šæ¯ä¸ªåˆ†åŒº128MB-256MBæœ€ä¼˜</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">targetPartitionSize</span> <span class="operator">=</span> <span class="number">128</span> * <span class="number">1024</span> * <span class="number">1024</span>; <span class="comment">// 128MB</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">dataSizeBasedPartitions</span> <span class="operator">=</span> (<span class="type">int</span>) (dataSize / targetPartitionSize);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è§„åˆ™2ï¼šåˆ†åŒºæ•°ä¸è¶…è¿‡CPUæ ¸å¿ƒæ•°çš„2-3å€</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">totalCores</span> <span class="operator">=</span> sc.defaultParallelism();</span><br><span class="line">        <span class="type">int</span> <span class="variable">coreBasedPartitions</span> <span class="operator">=</span> totalCores * <span class="number">3</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è§„åˆ™3ï¼šæœ€å°‘åˆ†åŒºæ•°ä¿è¯å¹¶è¡Œåº¦</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">minPartitions</span> <span class="operator">=</span> totalCores;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> Math.max(minPartitions, </span><br><span class="line">               Math.min(dataSizeBasedPartitions, coreBasedPartitions));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2. åˆ†åŒºå™¨æ€§èƒ½æµ‹è¯•</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ†åŒºå™¨æ•ˆæœè¯„ä¼°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PartitionerEvaluator</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">evaluatePartitioner</span><span class="params">(JavaPairRDD&lt;String, ?&gt; rdd, Partitioner partitioner)</span> &#123;</span><br><span class="line">        JavaPairRDD&lt;String, ?&gt; partitionedRDD = rdd.partitionBy(partitioner);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ç»Ÿè®¡æ¯ä¸ªåˆ†åŒºçš„æ•°æ®é‡</span></span><br><span class="line">        Map&lt;Integer, Long&gt; partitionSizes = partitionedRDD</span><br><span class="line">            .mapPartitionsWithIndex((index, iter) -&gt; &#123;</span><br><span class="line">                <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">                    iter.next();</span><br><span class="line">                    count++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> Collections.singletonList(<span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(index, count)).iterator();</span><br><span class="line">            &#125;, <span class="literal">false</span>)</span><br><span class="line">            .collectAsMap();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è®¡ç®—åˆ†åŒºä¸å‡åŒ€åº¦</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">avgSize</span> <span class="operator">=</span> partitionSizes.values().stream()</span><br><span class="line">            .mapToLong(Long::longValue)</span><br><span class="line">            .average()</span><br><span class="line">            .orElse(<span class="number">0.0</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">double</span> <span class="variable">maxSize</span> <span class="operator">=</span> partitionSizes.values().stream()</span><br><span class="line">            .mapToLong(Long::longValue)</span><br><span class="line">            .max()</span><br><span class="line">            .orElse(<span class="number">0L</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">double</span> <span class="variable">skewness</span> <span class="operator">=</span> maxSize / avgSize;</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;å¹³å‡åˆ†åŒºå¤§å°: &quot;</span> + avgSize);</span><br><span class="line">        System.out.println(<span class="string">&quot;æœ€å¤§åˆ†åŒºå¤§å°: &quot;</span> + maxSize);</span><br><span class="line">        System.out.println(<span class="string">&quot;æ•°æ®å€¾æ–œåº¦: &quot;</span> + skewness);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (skewness &gt; <span class="number">2.0</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;è­¦å‘Šï¼šå­˜åœ¨ä¸¥é‡æ•°æ®å€¾æ–œï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>3. åŠ¨æ€åˆ†åŒºç­–ç•¥</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ ¹æ®æ•°æ®ç‰¹å¾åŠ¨æ€é€‰æ‹©åˆ†åŒºå™¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AdaptivePartitioner</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Partitioner <span class="title function_">choosePartitioner</span><span class="params">(JavaPairRDD&lt;String, ?&gt; rdd, </span></span><br><span class="line"><span class="params">                                               <span class="type">int</span> numPartitions)</span> &#123;</span><br><span class="line">        <span class="comment">// é‡‡æ ·åˆ†ææ•°æ®ç‰¹å¾</span></span><br><span class="line">        List&lt;String&gt; sample = rdd.keys().sample(<span class="literal">false</span>, <span class="number">0.01</span>).collect();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆ†ææ•°æ®åˆ†å¸ƒ</span></span><br><span class="line">        Map&lt;String, Long&gt; keyFrequency = sample.stream()</span><br><span class="line">            .collect(Collectors.groupingBy(</span><br><span class="line">                key -&gt; key,</span><br><span class="line">                Collectors.counting()</span><br><span class="line">            ));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ£€æµ‹çƒ­ç‚¹key</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">avgFrequency</span> <span class="operator">=</span> sample.size() / keyFrequency.size();</span><br><span class="line">        Set&lt;String&gt; hotKeys = keyFrequency.entrySet().stream()</span><br><span class="line">            .filter(entry -&gt; entry.getValue() &gt; avgFrequency * <span class="number">10</span>)</span><br><span class="line">            .map(Map.Entry::getKey)</span><br><span class="line">            .collect(Collectors.toSet());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!hotKeys.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">// å­˜åœ¨çƒ­ç‚¹keyï¼Œä½¿ç”¨ç‰¹æ®Šåˆ†åŒºå™¨</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HotKeyPartitioner</span>(hotKeys, numPartitions);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æ•°æ®åˆ†å¸ƒå‡åŒ€ï¼Œä½¿ç”¨é»˜è®¤åˆ†åŒºå™¨</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashPartitioner</span>(numPartitions);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æœ€ä½³å®è·µï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. æ ¹æ®ä¸šåŠ¡ç‰¹å¾é€‰æ‹©åˆ†åŒºç­–ç•¥</span></span><br><span class="line"><span class="comment">// 2. å®šæœŸè¯„ä¼°åˆ†åŒºæ•ˆæœ</span></span><br><span class="line"><span class="comment">// 3. ç»“åˆSpark UIç›‘æ§åˆ†åŒºæ‰§è¡Œæ—¶é—´</span></span><br><span class="line"><span class="comment">// 4. åœ¨æ•°æ®é¢„å¤„ç†é˜¶æ®µåº”ç”¨åˆ†åŒºå™¨</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å®Œæ•´ç¤ºä¾‹ï¼šå¤„ç†ç”¨æˆ·è¡Œä¸ºæ•°æ®</span></span><br><span class="line">JavaPairRDD&lt;String, UserAction&gt; userActions = rawData</span><br><span class="line">    .mapToPair(data -&gt; <span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(data.getUserId(), data));</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€‰æ‹©åˆé€‚çš„åˆ†åŒºå™¨</span></span><br><span class="line"><span class="type">Partitioner</span> <span class="variable">partitioner</span> <span class="operator">=</span> AdaptivePartitioner.choosePartitioner(userActions, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åº”ç”¨åˆ†åŒºå™¨</span></span><br><span class="line">JavaPairRDD&lt;String, UserAction&gt; partitionedActions = userActions</span><br><span class="line">    .partitionBy(partitioner)</span><br><span class="line">    .cache(); <span class="comment">// ç¼“å­˜åˆ†åŒºç»“æœ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åç»­æ“ä½œéƒ½ä¼šå¤ç”¨è¿™ä¸ªåˆ†åŒº</span></span><br><span class="line">JavaPairRDD&lt;String, Long&gt; userCounts = partitionedActions</span><br><span class="line">    .mapValues(action -&gt; <span class="number">1L</span>)</span><br><span class="line">    .reduceByKey((a, b) -&gt; a + b);</span><br></pre></td></tr></table></figure><h2 id="å››ã€å¤æ‚ç®—å­ï¼šdistinctã€sortBy"><a href="#å››ã€å¤æ‚ç®—å­ï¼šdistinctã€sortBy" class="headerlink" title="å››ã€å¤æ‚ç®—å­ï¼šdistinctã€sortBy"></a>å››ã€å¤æ‚ç®—å­ï¼šdistinctã€sortBy</h2><p>å¤æ‚ç®—å­é€šå¸¸æ¶‰åŠå…¨å±€æ•°æ®æ“ä½œï¼Œéœ€è¦è¿›è¡ŒShuffleï¼Œå…¶å†…éƒ¨å®ç°æœºåˆ¶æ›´åŠ å¤æ‚ï¼Œç†è§£è¿™äº›ç®—å­çš„å·¥ä½œåŸç†å¯¹äºæ€§èƒ½ä¼˜åŒ–è‡³å…³é‡è¦ã€‚</p><h3 id="4-1-distinctç®—å­ï¼šå»é‡æ“ä½œ"><a href="#4-1-distinctç®—å­ï¼šå»é‡æ“ä½œ" class="headerlink" title="4.1 distinctç®—å­ï¼šå»é‡æ“ä½œ"></a>4.1 distinctç®—å­ï¼šå»é‡æ“ä½œ</h3><p>distinctç®—å­çœ‹ä¼¼ç®€å•ï¼Œä½†å…¶å†…éƒ¨å®ç°æ¶‰åŠå¤æ‚çš„Shuffleæœºåˆ¶å’Œå†…å­˜ç®¡ç†ç­–ç•¥ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JavaRDD&lt;Integer&gt; rdd = sc.parallelize(Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">4</span>));</span><br><span class="line">JavaRDD&lt;Integer&gt; distinct = rdd.distinct();</span><br></pre></td></tr></table></figure><h4 id="4-1-1-distinctç®—å­çš„å†…éƒ¨å®ç°æœºåˆ¶"><a href="#4-1-1-distinctç®—å­çš„å†…éƒ¨å®ç°æœºåˆ¶" class="headerlink" title="4.1.1 distinctç®—å­çš„å†…éƒ¨å®ç°æœºåˆ¶"></a>4.1.1 distinctç®—å­çš„å†…éƒ¨å®ç°æœºåˆ¶</h4><p><strong>å®Œæ•´çš„å®ç°é€»è¾‘ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// distinctç®—å­çš„è¯¦ç»†å®ç°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DistinctOperator</span>&lt;T&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> JavaRDD&lt;T&gt; <span class="title function_">distinct</span><span class="params">(JavaRDD&lt;T&gt; input, <span class="type">int</span> numPartitions)</span> &#123;</span><br><span class="line">        <span class="comment">// å®ç°ç­–ç•¥ï¼šåˆ©ç”¨reduceByKeyçš„å»é‡ç‰¹æ€§</span></span><br><span class="line">        <span class="keyword">return</span> input</span><br><span class="line">            .mapToPair(element -&gt; <span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(element, <span class="literal">null</span>))  <span class="comment">// è½¬æ¢ä¸ºkey-valueå¯¹</span></span><br><span class="line">            .reduceByKey((v1, v2) -&gt; v1, numPartitions)        <span class="comment">// æŒ‰keyèšåˆï¼ˆå»é‡ï¼‰</span></span><br><span class="line">            .map(pair -&gt; pair._1);                             <span class="comment">// æå–key</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ›´é«˜æ•ˆçš„å®ç°ï¼šåˆ†ä¸¤é˜¶æ®µå»é‡</span></span><br><span class="line">    <span class="keyword">public</span> JavaRDD&lt;T&gt; <span class="title function_">distinctOptimized</span><span class="params">(JavaRDD&lt;T&gt; input, <span class="type">int</span> numPartitions)</span> &#123;</span><br><span class="line">        <span class="comment">// é˜¶æ®µ1ï¼šåˆ†åŒºå†…å»é‡ï¼Œå‡å°‘Shuffleæ•°æ®é‡</span></span><br><span class="line">        JavaRDD&lt;T&gt; localDistinct = input.mapPartitions(iter -&gt; &#123;</span><br><span class="line">            Set&lt;T&gt; seen = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">            List&lt;T&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">                <span class="type">T</span> <span class="variable">element</span> <span class="operator">=</span> iter.next();</span><br><span class="line">                <span class="keyword">if</span> (seen.add(element)) &#123;  <span class="comment">// HashSet.add()è¿”å›falseè¡¨ç¤ºå·²å­˜åœ¨</span></span><br><span class="line">                    result.add(element);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> result.iterator();</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é˜¶æ®µ2ï¼šå…¨å±€å»é‡</span></span><br><span class="line">        <span class="keyword">return</span> localDistinct</span><br><span class="line">            .mapToPair(element -&gt; <span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(element, <span class="literal">null</span>))</span><br><span class="line">            .reduceByKey((v1, v2) -&gt; v1, numPartitions)</span><br><span class="line">            .map(pair -&gt; pair._1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-1-2-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥è¯¦è§£"><a href="#4-1-2-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥è¯¦è§£" class="headerlink" title="4.1.2 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥è¯¦è§£"></a>4.1.2 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥è¯¦è§£</h4><p><strong>å†…å­˜ä¼˜åŒ–çš„ä¸¤é˜¶æ®µå»é‡ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼˜åŒ–ç‰ˆæœ¬çš„distinctå®ç°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OptimizedDistinct</span>&lt;T&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> JavaRDD&lt;T&gt; <span class="title function_">distinctWithMemoryOptimization</span><span class="params">(JavaRDD&lt;T&gt; input)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. ä¼°ç®—é‡å¤ç‡</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">estimatedDuplicateRatio</span> <span class="operator">=</span> estimateDuplicateRatio(input);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (estimatedDuplicateRatio &gt; <span class="number">0.5</span>) &#123;  <span class="comment">// é‡å¤ç‡é«˜äº50%</span></span><br><span class="line">            <span class="comment">// ä½¿ç”¨ä¸¤é˜¶æ®µå»é‡</span></span><br><span class="line">            <span class="keyword">return</span> twoPhaseDistinct(input);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ç›´æ¥å»é‡</span></span><br><span class="line">            <span class="keyword">return</span> simpleDistinct(input);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> JavaRDD&lt;T&gt; <span class="title function_">twoPhaseDistinct</span><span class="params">(JavaRDD&lt;T&gt; input)</span> &#123;</span><br><span class="line">        <span class="comment">// é˜¶æ®µ1ï¼šåˆ†åŒºå†…å»é‡ï¼ˆæ— Shuffleï¼‰</span></span><br><span class="line">        JavaRDD&lt;T&gt; localDistinct = input.mapPartitions(iterator -&gt; &#123;</span><br><span class="line">            <span class="comment">// ä½¿ç”¨Bloom Filteré¢„è¿‡æ»¤ï¼Œå‡å°‘HashSetå†…å­˜å‹åŠ›</span></span><br><span class="line">            BloomFilter&lt;T&gt; bloomFilter = BloomFilter.create(</span><br><span class="line">                Funnels.javaObjectFunnel(), </span><br><span class="line">                <span class="number">100000</span>,    <span class="comment">// é¢„æœŸå…ƒç´ æ•°é‡</span></span><br><span class="line">                <span class="number">0.01</span>       <span class="comment">// è¯¯åˆ¤ç‡1%</span></span><br><span class="line">            );</span><br><span class="line">            </span><br><span class="line">            Set&lt;T&gt; localSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">            List&lt;T&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                <span class="type">T</span> <span class="variable">element</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// å…ˆç”¨Bloom Filterå¿«é€Ÿåˆ¤æ–­</span></span><br><span class="line">                <span class="keyword">if</span> (!bloomFilter.mightContain(element)) &#123;</span><br><span class="line">                    bloomFilter.put(element);</span><br><span class="line">                    localSet.add(element);</span><br><span class="line">                    result.add(element);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (localSet.add(element)) &#123;</span><br><span class="line">                    <span class="comment">// Bloom Filterå¯èƒ½è¯¯åˆ¤ï¼Œç”¨HashSetç¡®è®¤</span></span><br><span class="line">                    result.add(element);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> result.iterator();</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é˜¶æ®µ2ï¼šå…¨å±€å»é‡ï¼ˆShuffleï¼‰</span></span><br><span class="line">        <span class="keyword">return</span> localDistinct.distinct();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> <span class="title function_">estimateDuplicateRatio</span><span class="params">(JavaRDD&lt;T&gt; input)</span> &#123;</span><br><span class="line">        <span class="comment">// é€šè¿‡é‡‡æ ·ä¼°ç®—é‡å¤ç‡</span></span><br><span class="line">        List&lt;T&gt; sample = input.sample(<span class="literal">false</span>, <span class="number">0.01</span>).collect();</span><br><span class="line">        Set&lt;T&gt; uniqueInSample = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(sample);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="number">1.0</span> - (<span class="type">double</span>) uniqueInSample.size() / sample.size();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-1-3-å†…å­˜ç®¡ç†ä¸æ•°æ®å€¾æ–œå¤„ç†"><a href="#4-1-3-å†…å­˜ç®¡ç†ä¸æ•°æ®å€¾æ–œå¤„ç†" class="headerlink" title="4.1.3 å†…å­˜ç®¡ç†ä¸æ•°æ®å€¾æ–œå¤„ç†"></a>4.1.3 å†…å­˜ç®¡ç†ä¸æ•°æ®å€¾æ–œå¤„ç†</h4><p><strong>å¤§æ•°æ®é‡çš„distinctå¤„ç†ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¤„ç†å¤§æ•°æ®é‡çš„distinctæ“ä½œ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LargeDataDistinct</span>&lt;T&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> JavaRDD&lt;T&gt; <span class="title function_">distinctForLargeData</span><span class="params">(JavaRDD&lt;T&gt; input)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. æ•°æ®é¢„å¤„ç†ï¼šä¼°ç®—æ•°æ®ç‰¹å¾</span></span><br><span class="line">        DataCharacteristics&lt;T&gt; characteristics = analyzeData(input);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (characteristics.hasHighCardinality()) &#123;</span><br><span class="line">            <span class="comment">// é«˜åŸºæ•°æ•°æ®ï¼šä½¿ç”¨æ¦‚ç‡æ€§å»é‡</span></span><br><span class="line">            <span class="keyword">return</span> probabilisticDistinct(input);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (characteristics.hasDataSkew()) &#123;</span><br><span class="line">            <span class="comment">// æ•°æ®å€¾æ–œï¼šä½¿ç”¨åŠ ç›æŠ€æœ¯</span></span><br><span class="line">            <span class="keyword">return</span> skewAwareDistinct(input);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å¸¸è§„å¤„ç†</span></span><br><span class="line">            <span class="keyword">return</span> optimizedDistinct(input);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> JavaRDD&lt;T&gt; <span class="title function_">probabilisticDistinct</span><span class="params">(JavaRDD&lt;T&gt; input)</span> &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨HyperLogLogè¿›è¡Œè¿‘ä¼¼å»é‡</span></span><br><span class="line">        <span class="keyword">return</span> input.mapPartitions(iter -&gt; &#123;</span><br><span class="line">            <span class="type">HyperLogLog</span> <span class="variable">hll</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HyperLogLog</span>(<span class="number">14</span>); <span class="comment">// 2^14ä¸ªæ¡¶</span></span><br><span class="line">            Set&lt;T&gt; exactSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">                <span class="type">T</span> <span class="variable">element</span> <span class="operator">=</span> iter.next();</span><br><span class="line">                hll.offer(element);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// å¯¹äºå°åˆ†åŒºï¼Œä»ä½¿ç”¨ç²¾ç¡®å»é‡</span></span><br><span class="line">                <span class="keyword">if</span> (exactSet.size() &lt; <span class="number">10000</span>) &#123;</span><br><span class="line">                    exactSet.add(element);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// æ ¹æ®åŸºæ•°ä¼°ç®—é€‰æ‹©ç­–ç•¥</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">estimatedCardinality</span> <span class="operator">=</span> hll.cardinality();</span><br><span class="line">            <span class="keyword">if</span> (estimatedCardinality &lt; <span class="number">10000</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> exactSet.iterator();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// ä½¿ç”¨é‡‡æ ·ç»“æœ</span></span><br><span class="line">                <span class="keyword">return</span> sampleFromPartition(iter, <span class="number">0.1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).distinct();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> JavaRDD&lt;T&gt; <span class="title function_">skewAwareDistinct</span><span class="params">(JavaRDD&lt;T&gt; input)</span> &#123;</span><br><span class="line">        <span class="comment">// è¯†åˆ«çƒ­ç‚¹æ•°æ®</span></span><br><span class="line">        Map&lt;T, Long&gt; frequency = input</span><br><span class="line">            .map(x -&gt; <span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(x, <span class="number">1L</span>))</span><br><span class="line">            .reduceByKey(Long::sum)</span><br><span class="line">            .collectAsMap();</span><br><span class="line">            </span><br><span class="line">        <span class="comment">// æ‰¾å‡ºé«˜é¢‘å…ƒç´ ï¼ˆçƒ­ç‚¹æ•°æ®ï¼‰</span></span><br><span class="line">        Set&lt;T&gt; hotKeys = frequency.entrySet().stream()</span><br><span class="line">            .filter(entry -&gt; entry.getValue() &gt; <span class="number">1000</span>)  <span class="comment">// é¢‘æ¬¡è¶…è¿‡1000çš„ä¸ºçƒ­ç‚¹</span></span><br><span class="line">            .map(Map.Entry::getKey)</span><br><span class="line">            .collect(Collectors.toSet());</span><br><span class="line">        </span><br><span class="line">        Broadcast&lt;Set&lt;T&gt;&gt; broadcastHotKeys = input.context().broadcast(hotKeys);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¯¹çƒ­ç‚¹æ•°æ®åŠ ç›å¤„ç†</span></span><br><span class="line">        <span class="keyword">return</span> input.mapToPair(element -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (broadcastHotKeys.value().contains(element)) &#123;</span><br><span class="line">                <span class="comment">// çƒ­ç‚¹æ•°æ®åŠ ç›</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">saltedKey</span> <span class="operator">=</span> element.toString() + <span class="string">&quot;_&quot;</span> + (element.hashCode() % <span class="number">10</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(saltedKey, element);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(element.toString(), element);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).reduceByKey((v1, v2) -&gt; v1)  <span class="comment">// å»é‡</span></span><br><span class="line">        .map(pair -&gt; pair._2);           <span class="comment">// æå–åŸå§‹å€¼</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-1-4-æ€§èƒ½ç‰¹å¾åˆ†æ"><a href="#4-1-4-æ€§èƒ½ç‰¹å¾åˆ†æ" class="headerlink" title="4.1.4 æ€§èƒ½ç‰¹å¾åˆ†æ"></a>4.1.4 æ€§èƒ½ç‰¹å¾åˆ†æ</h4><p><strong>æ‰§è¡Œæµç¨‹æ·±åº¦è§£æï¼š</strong></p><ol><li><p><strong>è½¬æ¢é˜¶æ®µ</strong>ï¼šå°†æ¯ä¸ªå…ƒç´ è½¬æ¢ä¸º(key, null)å¯¹</p><ul><li>ç›®çš„ï¼šåˆ©ç”¨reduceByKeyçš„æŒ‰keyèšåˆç‰¹æ€§</li><li>å¼€é”€ï¼šæ¯ä¸ªå…ƒç´ çš„åŒ…è£…æˆæœ¬</li></ul></li><li><p><strong>Shuffleé˜¶æ®µ</strong>ï¼šæŒ‰keyé‡æ–°åˆ†å¸ƒæ•°æ®</p><ul><li>ç½‘ç»œä¼ è¾“ï¼šæ‰€æœ‰æ•°æ®éƒ½éœ€è¦ä¼ è¾“</li><li>ç£ç›˜IOï¼šåºåˆ—åŒ–å’Œååºåˆ—åŒ–å¼€é”€</li><li>å†…å­˜å‹åŠ›ï¼šéœ€è¦è¶³å¤Ÿçš„å†…å­˜ç¼“å†²åŒº</li></ul></li><li><p><strong>èšåˆé˜¶æ®µ</strong>ï¼šç›¸åŒkeyçš„valuesè¢«åˆå¹¶</p><ul><li>å®é™…ä¸Šåªä¿ç•™ç¬¬ä¸€ä¸ªvalueï¼ˆnullï¼‰</li><li>è‡ªåŠ¨å®ç°å»é‡æ•ˆæœ</li></ul></li></ol><p><strong>æ€§èƒ½ç“¶é¢ˆåˆ†æï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// distinctæ€§èƒ½ç“¶é¢ˆåˆ†æ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DistinctPerformanceAnalyzer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">analyzePerformance</span><span class="params">(JavaRDD&lt;String&gt; input)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ç»Ÿè®¡åŸå§‹æ•°æ®ç‰¹å¾</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">totalCount</span> <span class="operator">=</span> input.count();</span><br><span class="line">        <span class="type">long</span> <span class="variable">distinctCount</span> <span class="operator">=</span> input.distinct().count();</span><br><span class="line">        <span class="type">double</span> <span class="variable">duplicateRatio</span> <span class="operator">=</span> <span class="number">1.0</span> - (<span class="type">double</span>) distinctCount / totalCount;</span><br><span class="line">        </span><br><span class="line">        <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;=== Distinctæ€§èƒ½åˆ†æ ===&quot;</span>);</span><br><span class="line">        System.out.printf(<span class="string">&quot;æ€»æ•°æ®é‡: %d%n&quot;</span>, totalCount);</span><br><span class="line">        System.out.printf(<span class="string">&quot;å»é‡åæ•°é‡: %d%n&quot;</span>, distinctCount);</span><br><span class="line">        System.out.printf(<span class="string">&quot;é‡å¤ç‡: %.2f%%%n&quot;</span>, duplicateRatio * <span class="number">100</span>);</span><br><span class="line">        System.out.printf(<span class="string">&quot;æ‰§è¡Œæ—¶é—´: %d ms%n&quot;</span>, endTime - startTime);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆ†æç“¶é¢ˆ</span></span><br><span class="line">        <span class="keyword">if</span> (duplicateRatio &lt; <span class="number">0.1</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;ç“¶é¢ˆï¼šä½é‡å¤ç‡ï¼ŒShuffleå¼€é”€å¤§&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;å»ºè®®ï¼šè€ƒè™‘æ˜¯å¦çœŸçš„éœ€è¦å»é‡&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (duplicateRatio &gt; <span class="number">0.8</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;ç“¶é¢ˆï¼šé«˜é‡å¤ç‡ï¼Œå†…å­˜å‹åŠ›å¤§&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;å»ºè®®ï¼šä½¿ç”¨ä¸¤é˜¶æ®µå»é‡ä¼˜åŒ–&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ•°æ®å€¾æ–œæ£€æµ‹</span></span><br><span class="line">        Map&lt;Integer, Long&gt; partitionSizes = input</span><br><span class="line">            .mapPartitionsWithIndex((index, iter) -&gt; &#123;</span><br><span class="line">                <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">                    iter.next();</span><br><span class="line">                    count++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> Collections.singletonList(<span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(index, count)).iterator();</span><br><span class="line">            &#125;, <span class="literal">false</span>)</span><br><span class="line">            .collectAsMap();</span><br><span class="line">            </span><br><span class="line">        <span class="type">long</span> <span class="variable">maxPartitionSize</span> <span class="operator">=</span> Collections.max(partitionSizes.values());</span><br><span class="line">        <span class="type">long</span> <span class="variable">minPartitionSize</span> <span class="operator">=</span> Collections.min(partitionSizes.values());</span><br><span class="line">        <span class="type">double</span> <span class="variable">skewRatio</span> <span class="operator">=</span> (<span class="type">double</span>) maxPartitionSize / minPartitionSize;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (skewRatio &gt; <span class="number">3.0</span>) &#123;</span><br><span class="line">            System.out.printf(<span class="string">&quot;æ£€æµ‹åˆ°æ•°æ®å€¾æ–œï¼Œå€¾æ–œæ¯”ä¾‹: %.2f%n&quot;</span>, skewRatio);</span><br><span class="line">            System.out.println(<span class="string">&quot;å»ºè®®ï¼šä½¿ç”¨åŠ ç›æŠ€æœ¯å¤„ç†å€¾æ–œ&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æœ€ä½³å®è·µå»ºè®®ï¼š</strong></p><ol><li><strong>è¯„ä¼°å¿…è¦æ€§</strong>ï¼šç¡®è®¤æ˜¯å¦çœŸçš„éœ€è¦å…¨å±€å»é‡</li><li><strong>åˆ†é˜¶æ®µå¤„ç†</strong>ï¼šå…ˆæœ¬åœ°å»é‡ï¼Œå†å…¨å±€å»é‡</li><li><strong>å†…å­˜ä¼˜åŒ–</strong>ï¼šä½¿ç”¨Bloom Filteré¢„è¿‡æ»¤</li><li><strong>å¤„ç†å€¾æ–œ</strong>ï¼šå¯¹é«˜é¢‘æ•°æ®ä½¿ç”¨åŠ ç›æŠ€æœ¯</li><li><strong>ç›‘æ§æ€§èƒ½</strong>ï¼šå…³æ³¨Shuffleæ•°æ®é‡å’Œæ‰§è¡Œæ—¶é—´</li></ol><p><strong>æ€§èƒ½ç‰¹ç‚¹æ€»ç»“ï¼š</strong></p><ul><li><strong>å¿…ç„¶äº§ç”ŸShuffle</strong>ï¼šæ‰€æœ‰æ•°æ®éƒ½éœ€è¦é‡æ–°åˆ†å¸ƒ</li><li><strong>å†…å­˜ä½¿ç”¨ç¨³å®š</strong>ï¼šä¸»è¦å—åˆ†åŒºæ•°å’Œæ•°æ®åˆ†å¸ƒå½±å“</li><li><strong>é€‚ç”¨äºä¸­ç­‰æ•°æ®é‡</strong>ï¼šè¶…å¤§æ•°æ®é›†å¯èƒ½éœ€è¦ç‰¹æ®Šä¼˜åŒ–</li><li><strong>é‡å¤ç‡å½±å“æ˜¾è‘—</strong>ï¼šé‡å¤ç‡è¶Šé«˜ï¼Œä¼˜åŒ–ç©ºé—´è¶Šå¤§</li></ul><h3 id="4-2-sortByç®—å­ï¼šæ’åºæ“ä½œ"><a href="#4-2-sortByç®—å­ï¼šæ’åºæ“ä½œ" class="headerlink" title="4.2 sortByç®—å­ï¼šæ’åºæ“ä½œ"></a>4.2 sortByç®—å­ï¼šæ’åºæ“ä½œ</h3><p>sortByæ˜¯Sparkä¸­æœ€å¤æ‚å’Œæœ€æ˜‚è´µçš„æ“ä½œä¹‹ä¸€ï¼Œå®ƒéœ€è¦å…¨å±€é‡æ–°æ’åˆ—æ•°æ®ï¼Œæ¶‰åŠå¤æ‚çš„é‡‡æ ·ã€åˆ†åŒºå’Œæ’åºç®—æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JavaRDD&lt;Integer&gt; rdd = sc.parallelize(Arrays.asList(<span class="number">5</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">1</span>, <span class="number">9</span>, <span class="number">3</span>));</span><br><span class="line">JavaRDD&lt;Integer&gt; sorted = rdd.sortBy(x -&gt; x, <span class="literal">true</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure><h4 id="4-2-1-sortByç®—å­çš„å†…éƒ¨å®ç°æœºåˆ¶"><a href="#4-2-1-sortByç®—å­çš„å†…éƒ¨å®ç°æœºåˆ¶" class="headerlink" title="4.2.1 sortByç®—å­çš„å†…éƒ¨å®ç°æœºåˆ¶"></a>4.2.1 sortByç®—å­çš„å†…éƒ¨å®ç°æœºåˆ¶</h4><p><strong>å®Œæ•´çš„æ’åºæµç¨‹ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sortByç®—å­çš„è¯¦ç»†å®ç°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SortByOperator</span>&lt;T, K&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> JavaRDD&lt;T&gt; <span class="title function_">sortBy</span><span class="params">(JavaRDD&lt;T&gt; input, </span></span><br><span class="line"><span class="params">                            Function&lt;T, K&gt; keyFunction,</span></span><br><span class="line"><span class="params">                            <span class="type">boolean</span> ascending,</span></span><br><span class="line"><span class="params">                            <span class="type">int</span> numPartitions)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é˜¶æ®µ1ï¼šæ•°æ®é‡‡æ ·å’Œåˆ†åŒºè¾¹ç•Œè®¡ç®—</span></span><br><span class="line">        RangePartitioner&lt;K, T&gt; partitioner = createRangePartitioner(</span><br><span class="line">            input, keyFunction, numPartitions);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é˜¶æ®µ2ï¼šé‡æ–°åˆ†åŒºï¼ˆShuffleï¼‰</span></span><br><span class="line">        JavaPairRDD&lt;K, T&gt; keyedRDD = input.mapToPair(element -&gt; </span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(keyFunction.call(element), element));</span><br><span class="line">        </span><br><span class="line">        JavaPairRDD&lt;K, T&gt; partitionedRDD = keyedRDD.partitionBy(partitioner);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é˜¶æ®µ3ï¼šåˆ†åŒºå†…æ’åº</span></span><br><span class="line">        <span class="keyword">return</span> partitionedRDD.mapPartitions(iter -&gt; &#123;</span><br><span class="line">            List&lt;Tuple2&lt;K, T&gt;&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">                list.add(iter.next());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// åˆ†åŒºå†…æ’åº</span></span><br><span class="line">            list.sort((t1, t2) -&gt; &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">cmp</span> <span class="operator">=</span> compareKeys(t1._1, t2._1);</span><br><span class="line">                <span class="keyword">return</span> ascending ? cmp : -cmp;</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> list.stream().map(tuple -&gt; tuple._2).iterator();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> RangePartitioner&lt;K, T&gt; <span class="title function_">createRangePartitioner</span><span class="params">(</span></span><br><span class="line"><span class="params">            JavaRDD&lt;T&gt; input, Function&lt;T, K&gt; keyFunction, <span class="type">int</span> numPartitions)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. æ•°æ®é‡‡æ ·</span></span><br><span class="line">        List&lt;K&gt; sample = sampleKeys(input, keyFunction);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. è®¡ç®—åˆ†åŒºè¾¹ç•Œ</span></span><br><span class="line">        K[] rangeBounds = calculateRangeBounds(sample, numPartitions);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RangePartitioner</span>&lt;&gt;(numPartitions, rangeBounds);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-2-é‡‡æ ·ç®—æ³•æ·±åº¦è§£æ"><a href="#4-2-2-é‡‡æ ·ç®—æ³•æ·±åº¦è§£æ" class="headerlink" title="4.2.2 é‡‡æ ·ç®—æ³•æ·±åº¦è§£æ"></a>4.2.2 é‡‡æ ·ç®—æ³•æ·±åº¦è§£æ</h4><p><strong>æ°´å¡˜é‡‡æ ·ï¼ˆReservoir Samplingï¼‰å®ç°ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é«˜çº§æ°´å¡˜é‡‡æ ·ç®—æ³•</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AdvancedReservoirSampler</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> reservoirSize;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Random random;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">double</span> sampleRatio;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AdvancedReservoirSampler</span><span class="params">(<span class="type">int</span> reservoirSize, <span class="type">double</span> sampleRatio)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.reservoirSize = reservoirSize;</span><br><span class="line">        <span class="built_in">this</span>.sampleRatio = sampleRatio;</span><br><span class="line">        <span class="built_in">this</span>.random = <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> List&lt;T&gt; <span class="title function_">sample</span><span class="params">(Iterator&lt;T&gt; data)</span> &#123;</span><br><span class="line">        List&lt;T&gt; reservoir = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é˜¶æ®µ1ï¼šå¡«å……åˆå§‹æ°´å¡˜</span></span><br><span class="line">        <span class="keyword">while</span> (data.hasNext() &amp;&amp; count &lt; reservoirSize) &#123;</span><br><span class="line">            reservoir.add(data.next());</span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é˜¶æ®µ2ï¼šæ°´å¡˜é‡‡æ ·</span></span><br><span class="line">        <span class="keyword">while</span> (data.hasNext()) &#123;</span><br><span class="line">            count++;</span><br><span class="line">            <span class="type">T</span> <span class="variable">item</span> <span class="operator">=</span> data.next();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// ä¼˜åŒ–ï¼šä½¿ç”¨æ›´é«˜æ•ˆçš„éšæœºæ•°ç”Ÿæˆ</span></span><br><span class="line">            <span class="keyword">if</span> (shouldInclude(count)) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">replaceIndex</span> <span class="operator">=</span> random.nextInt(reservoirSize);</span><br><span class="line">                reservoir.set(replaceIndex, item);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> reservoir;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">shouldInclude</span><span class="params">(<span class="type">int</span> count)</span> &#123;</span><br><span class="line">        <span class="comment">// æ¦‚ç‡é€’å‡ä¼˜åŒ–ï¼šå‡å°‘éšæœºæ•°ç”Ÿæˆæ¬¡æ•°</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">probability</span> <span class="operator">=</span> (<span class="type">double</span>) reservoirSize / count;</span><br><span class="line">        <span class="keyword">return</span> random.nextDouble() &lt; probability;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> List&lt;T&gt; <span class="title function_">stratifiedSample</span><span class="params">(Iterator&lt;T&gt; data, Function&lt;T, String&gt; stratifyFunc)</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ†å±‚é‡‡æ ·ï¼šç¡®ä¿æ¯ä¸ªå±‚æ¬¡éƒ½æœ‰ä»£è¡¨æ€§æ ·æœ¬</span></span><br><span class="line">        Map&lt;String, List&lt;T&gt;&gt; stratums = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> (data.hasNext()) &#123;</span><br><span class="line">            <span class="type">T</span> <span class="variable">item</span> <span class="operator">=</span> data.next();</span><br><span class="line">            <span class="type">String</span> <span class="variable">stratum</span> <span class="operator">=</span> stratifyFunc.apply(item);</span><br><span class="line">            stratums.computeIfAbsent(stratum, k -&gt; <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;()).add(item);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        List&lt;T&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="type">int</span> <span class="variable">samplesPerStratum</span> <span class="operator">=</span> reservoirSize / stratums.size();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (List&lt;T&gt; stratumData : stratums.values()) &#123;</span><br><span class="line">            List&lt;T&gt; stratumSample = sample(stratumData.iterator());</span><br><span class="line">            result.addAll(stratumSample.subList(<span class="number">0</span>, </span><br><span class="line">                Math.min(samplesPerStratum, stratumSample.size())));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-3-èŒƒå›´åˆ†åŒºå™¨ï¼ˆRangePartitionerï¼‰è¯¦è§£"><a href="#4-2-3-èŒƒå›´åˆ†åŒºå™¨ï¼ˆRangePartitionerï¼‰è¯¦è§£" class="headerlink" title="4.2.3 èŒƒå›´åˆ†åŒºå™¨ï¼ˆRangePartitionerï¼‰è¯¦è§£"></a>4.2.3 èŒƒå›´åˆ†åŒºå™¨ï¼ˆRangePartitionerï¼‰è¯¦è§£</h4><p><strong>æ™ºèƒ½åˆ†åŒºè¾¹ç•Œè®¡ç®—ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// èŒƒå›´åˆ†åŒºå™¨çš„é«˜çº§å®ç°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AdvancedRangePartitioner</span>&lt;K <span class="keyword">extends</span> <span class="title class_">Comparable</span>&lt;K&gt;, V&gt; <span class="keyword">extends</span> <span class="title class_">Partitioner</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> K[] rangeBounds;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> numPartitions;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AdvancedRangePartitioner</span><span class="params">(List&lt;K&gt; sample, <span class="type">int</span> numPartitions)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.numPartitions = numPartitions;</span><br><span class="line">        <span class="built_in">this</span>.rangeBounds = calculateOptimalBounds(sample, numPartitions);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> K[] calculateOptimalBounds(List&lt;K&gt; sample, <span class="type">int</span> numPartitions) &#123;</span><br><span class="line">        <span class="comment">// 1. æ’åºæ ·æœ¬æ•°æ®</span></span><br><span class="line">        Collections.sort(sample);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. åˆ†ææ•°æ®åˆ†å¸ƒ</span></span><br><span class="line">        DataDistribution&lt;K&gt; distribution = analyzeDistribution(sample);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (distribution.isUniform()) &#123;</span><br><span class="line">            <span class="comment">// å‡åŒ€åˆ†å¸ƒï¼šç­‰é—´è·åˆ†åŒº</span></span><br><span class="line">            <span class="keyword">return</span> calculateUniformBounds(sample, numPartitions);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (distribution.hasHotspots()) &#123;</span><br><span class="line">            <span class="comment">// çƒ­ç‚¹åˆ†å¸ƒï¼šè‡ªé€‚åº”åˆ†åŒº</span></span><br><span class="line">            <span class="keyword">return</span> calculateAdaptiveBounds(sample, numPartitions, distribution);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ä¸€èˆ¬æƒ…å†µï¼šåŸºäºåˆ†ä½æ•°åˆ†åŒº</span></span><br><span class="line">            <span class="keyword">return</span> calculateQuantileBounds(sample, numPartitions);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> K[] calculateQuantileBounds(List&lt;K&gt; sample, <span class="type">int</span> numPartitions) &#123;</span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        K[] bounds = (K[]) <span class="keyword">new</span> <span class="title class_">Comparable</span>[numPartitions - <span class="number">1</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; numPartitions; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> (<span class="type">int</span>) Math.round((<span class="type">double</span>) i * sample.size() / numPartitions);</span><br><span class="line">            bounds[i - <span class="number">1</span>] = sample.get(Math.min(index, sample.size() - <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> bounds;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> K[] calculateAdaptiveBounds(List&lt;K&gt; sample, <span class="type">int</span> numPartitions, </span><br><span class="line">                                       DataDistribution&lt;K&gt; distribution) &#123;</span><br><span class="line">        <span class="comment">// å¯¹äºçƒ­ç‚¹æ•°æ®ï¼Œåˆ†é…æ›´å¤šåˆ†åŒº</span></span><br><span class="line">        List&lt;K&gt; bounds = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        Set&lt;K&gt; hotspots = distribution.getHotspots();</span><br><span class="line">        <span class="type">int</span> <span class="variable">hotspotsPartitions</span> <span class="operator">=</span> Math.max(<span class="number">1</span>, numPartitions / <span class="number">3</span>); <span class="comment">// 1/3åˆ†åŒºç»™çƒ­ç‚¹</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">regularPartitions</span> <span class="operator">=</span> numPartitions - hotspotsPartitions;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä¸ºçƒ­ç‚¹æ•°æ®åˆ›å»ºç»†ç²’åº¦åˆ†åŒº</span></span><br><span class="line">        <span class="keyword">for</span> (K hotspot : hotspots) &#123;</span><br><span class="line">            bounds.add(hotspot);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä¸ºå¸¸è§„æ•°æ®åˆ›å»ºå‡åŒ€åˆ†åŒº</span></span><br><span class="line">        List&lt;K&gt; regularSample = sample.stream()</span><br><span class="line">            .filter(key -&gt; !hotspots.contains(key))</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">            </span><br><span class="line">        K[] regularBounds = calculateQuantileBounds(regularSample, regularPartitions);</span><br><span class="line">        bounds.addAll(Arrays.asList(regularBounds));</span><br><span class="line">        </span><br><span class="line">        Collections.sort(bounds);</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        K[] result = (K[]) bounds.toArray(<span class="keyword">new</span> <span class="title class_">Comparable</span>[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getPartition</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        <span class="type">K</span> <span class="variable">k</span> <span class="operator">=</span> (K) key;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// äºŒåˆ†æŸ¥æ‰¾å®šä½åˆ†åŒº</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">partition</span> <span class="operator">=</span> Arrays.binarySearch(rangeBounds, k);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (partition &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            partition = -partition - <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> Math.min(partition, numPartitions - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-4-å¤–éƒ¨æ’åºæœºåˆ¶"><a href="#4-2-4-å¤–éƒ¨æ’åºæœºåˆ¶" class="headerlink" title="4.2.4 å¤–éƒ¨æ’åºæœºåˆ¶"></a>4.2.4 å¤–éƒ¨æ’åºæœºåˆ¶</h4><p><strong>å¤§æ•°æ®é‡çš„æ’åºå¤„ç†ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¤–éƒ¨æ’åºå®ç°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExternalSorter</span>&lt;T, K <span class="keyword">extends</span> <span class="title class_">Comparable</span>&lt;K&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Function&lt;T, K&gt; keyFunction;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> memoryThreshold;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;File&gt; spillFiles;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ExternalSorter</span><span class="params">(Function&lt;T, K&gt; keyFunction, <span class="type">long</span> memoryThreshold)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.keyFunction = keyFunction;</span><br><span class="line">        <span class="built_in">this</span>.memoryThreshold = memoryThreshold;</span><br><span class="line">        <span class="built_in">this</span>.spillFiles = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Iterator&lt;T&gt; <span class="title function_">sort</span><span class="params">(Iterator&lt;T&gt; input)</span> &#123;</span><br><span class="line">        List&lt;T&gt; memoryBuffer = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="type">long</span> <span class="variable">currentMemoryUsage</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é˜¶æ®µ1ï¼šåˆ†æ‰¹æ’åºå¹¶æº¢å†™</span></span><br><span class="line">        <span class="keyword">while</span> (input.hasNext()) &#123;</span><br><span class="line">            <span class="type">T</span> <span class="variable">element</span> <span class="operator">=</span> input.next();</span><br><span class="line">            memoryBuffer.add(element);</span><br><span class="line">            currentMemoryUsage += estimateSize(element);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å†…å­˜è¶…é™æ—¶æº¢å†™åˆ°ç£ç›˜</span></span><br><span class="line">            <span class="keyword">if</span> (currentMemoryUsage &gt; memoryThreshold) &#123;</span><br><span class="line">                spillToFile(memoryBuffer);</span><br><span class="line">                memoryBuffer.clear();</span><br><span class="line">                currentMemoryUsage = <span class="number">0</span>;</span><br><span class="line">                System.gc(); <span class="comment">// å»ºè®®åƒåœ¾å›æ”¶</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¤„ç†æœ€åä¸€æ‰¹æ•°æ®</span></span><br><span class="line">        <span class="keyword">if</span> (!memoryBuffer.isEmpty()) &#123;</span><br><span class="line">            spillToFile(memoryBuffer);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é˜¶æ®µ2ï¼šå¤šè·¯å½’å¹¶æ’åº</span></span><br><span class="line">        <span class="keyword">return</span> mergeSpillFiles();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">spillToFile</span><span class="params">(List&lt;T&gt; data)</span> &#123;</span><br><span class="line">        <span class="comment">// å†…å­˜ä¸­æ’åº</span></span><br><span class="line">        data.sort((a, b) -&gt; keyFunction.apply(a).compareTo(keyFunction.apply(b)));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å†™å…¥ç£ç›˜</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">spillFile</span> <span class="operator">=</span> createTempFile();</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(spillFile)))) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (T element : data) &#123;</span><br><span class="line">                oos.writeObject(element);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            spillFiles.add(spillFile);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed to spill data&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Iterator&lt;T&gt; <span class="title function_">mergeSpillFiles</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (spillFiles.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyIterator();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (spillFiles.size() == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> readSpillFile(spillFiles.get(<span class="number">0</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¤šè·¯å½’å¹¶</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MergeIterator</span>&lt;&gt;(spillFiles, keyFunction);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤šè·¯å½’å¹¶è¿­ä»£å™¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MergeIterator</span>&lt;T, K <span class="keyword">extends</span> <span class="title class_">Comparable</span>&lt;K&gt;&gt; <span class="keyword">implements</span> <span class="title class_">Iterator</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PriorityQueue&lt;IteratorWrapper&lt;T, K&gt;&gt; heap;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MergeIterator</span><span class="params">(List&lt;File&gt; spillFiles, Function&lt;T, K&gt; keyFunction)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.heap = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(spillFiles.size(), </span><br><span class="line">            Comparator.comparing(IteratorWrapper::getCurrentKey));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–å„ä¸ªæ–‡ä»¶çš„è¿­ä»£å™¨</span></span><br><span class="line">        <span class="keyword">for</span> (File file : spillFiles) &#123;</span><br><span class="line">            Iterator&lt;T&gt; iter = readSpillFile(file);</span><br><span class="line">            <span class="keyword">if</span> (iter.hasNext()) &#123;</span><br><span class="line">                heap.offer(<span class="keyword">new</span> <span class="title class_">IteratorWrapper</span>&lt;&gt;(iter, keyFunction));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasNext</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> !heap.isEmpty();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">        IteratorWrapper&lt;T, K&gt; wrapper = heap.poll();</span><br><span class="line">        <span class="type">T</span> <span class="variable">result</span> <span class="operator">=</span> wrapper.next();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¦‚æœè¯¥è¿­ä»£å™¨è¿˜æœ‰æ•°æ®ï¼Œé‡æ–°æ”¾å…¥å †ä¸­</span></span><br><span class="line">        <span class="keyword">if</span> (wrapper.hasNext()) &#123;</span><br><span class="line">            heap.offer(wrapper);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-5-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥"><a href="#4-2-5-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥" class="headerlink" title="4.2.5 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥"></a>4.2.5 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</h4><p><strong>æ’åºæ€§èƒ½ä¼˜åŒ–ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ’åºæ€§èƒ½ä¼˜åŒ–å™¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SortPerformanceOptimizer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> &lt;T, K <span class="keyword">extends</span> <span class="title class_">Comparable</span>&lt;K&gt;&gt; JavaRDD&lt;T&gt; <span class="title function_">optimizedSort</span><span class="params">(</span></span><br><span class="line"><span class="params">            JavaRDD&lt;T&gt; input, Function&lt;T, K&gt; keyFunction, <span class="type">boolean</span> ascending)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. è¯„ä¼°æ•°æ®ç‰¹å¾</span></span><br><span class="line">        SortDataCharacteristics&lt;K&gt; characteristics = analyzeData(input, keyFunction);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (characteristics.isAlreadySorted()) &#123;</span><br><span class="line">            <span class="comment">// æ•°æ®å·²æ’åºï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">            <span class="keyword">return</span> input;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (characteristics.isNearlySorted()) &#123;</span><br><span class="line">            <span class="comment">// è¿‘ä¼¼æ’åºï¼Œä½¿ç”¨æ’å…¥æ’åºä¼˜åŒ–</span></span><br><span class="line">            <span class="keyword">return</span> nearSortedOptimization(input, keyFunction, ascending);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (characteristics.hasLimitedRange()) &#123;</span><br><span class="line">            <span class="comment">// æœ‰é™èŒƒå›´ï¼Œä½¿ç”¨è®¡æ•°æ’åº</span></span><br><span class="line">            <span class="keyword">return</span> countingSort(input, keyFunction, ascending);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. è‡ªé€‚åº”åˆ†åŒºæ•°é€‰æ‹©</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">optimalPartitions</span> <span class="operator">=</span> calculateOptimalPartitions(input, characteristics);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. é¢„è¿‡æ»¤ä¼˜åŒ–</span></span><br><span class="line">        JavaRDD&lt;T&gt; filtered = preFilterForSort(input, characteristics);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5. æ‰§è¡Œä¼˜åŒ–çš„æ’åº</span></span><br><span class="line">        <span class="keyword">return</span> filtered.sortBy(keyFunction, ascending, optimalPartitions);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> &lt;T, K <span class="keyword">extends</span> <span class="title class_">Comparable</span>&lt;K&gt;&gt; JavaRDD&lt;T&gt; <span class="title function_">nearSortedOptimization</span><span class="params">(</span></span><br><span class="line"><span class="params">            JavaRDD&lt;T&gt; input, Function&lt;T, K&gt; keyFunction, <span class="type">boolean</span> ascending)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> input.mapPartitions(iter -&gt; &#123;</span><br><span class="line">            List&lt;T&gt; partition = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">                partition.add(iter.next());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// ä½¿ç”¨æ’å…¥æ’åºï¼Œå¯¹è¿‘ä¼¼æ’åºæ•°æ®æ•ˆç‡é«˜</span></span><br><span class="line">            insertionSort(partition, keyFunction, ascending);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> partition.iterator();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> &lt;T, K <span class="keyword">extends</span> <span class="title class_">Comparable</span>&lt;K&gt;&gt; JavaRDD&lt;T&gt; <span class="title function_">countingSort</span><span class="params">(</span></span><br><span class="line"><span class="params">            JavaRDD&lt;T&gt; input, Function&lt;T, K&gt; keyFunction, <span class="type">boolean</span> ascending)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é€‚ç”¨äºæ•´æ•°ç­‰æœ‰é™èŒƒå›´çš„æ•°æ®</span></span><br><span class="line">        <span class="keyword">return</span> input.mapPartitions(iter -&gt; &#123;</span><br><span class="line">            Map&lt;K, List&lt;T&gt;&gt; buckets = <span class="keyword">new</span> <span class="title class_">TreeMap</span>&lt;&gt;();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">                <span class="type">T</span> <span class="variable">element</span> <span class="operator">=</span> iter.next();</span><br><span class="line">                <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> keyFunction.apply(element);</span><br><span class="line">                buckets.computeIfAbsent(key, k -&gt; <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;()).add(element);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            List&lt;T&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">if</span> (ascending) &#123;</span><br><span class="line">                <span class="keyword">for</span> (List&lt;T&gt; bucket : buckets.values()) &#123;</span><br><span class="line">                    result.addAll(bucket);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                List&lt;List&lt;T&gt;&gt; reversedBuckets = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(buckets.values());</span><br><span class="line">                Collections.reverse(reversedBuckets);</span><br><span class="line">                <span class="keyword">for</span> (List&lt;T&gt; bucket : reversedBuckets) &#123;</span><br><span class="line">                    result.addAll(bucket);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> result.iterator();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ€§èƒ½ç›‘æ§ä¸è°ƒä¼˜ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ’åºæ€§èƒ½ç›‘æ§</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SortPerformanceMonitor</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">monitorSortPerformance</span><span class="params">(JavaRDD&lt;?&gt; input)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ç›‘æ§æŒ‡æ ‡</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">dataSize</span> <span class="operator">=</span> estimateDataSize(input);</span><br><span class="line">        <span class="type">int</span> <span class="variable">partitionCount</span> <span class="operator">=</span> input.getNumPartitions();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ‰§è¡Œæ’åº</span></span><br><span class="line">        input.sortBy(x -&gt; x.toString(), <span class="literal">true</span>, partitionCount).count();</span><br><span class="line">        </span><br><span class="line">        <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">long</span> <span class="variable">executionTime</span> <span class="operator">=</span> endTime - startTime;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ€§èƒ½åˆ†æ</span></span><br><span class="line">        System.out.println(<span class="string">&quot;=== æ’åºæ€§èƒ½åˆ†æ ===&quot;</span>);</span><br><span class="line">        System.out.printf(<span class="string">&quot;æ•°æ®é‡: %.2f MB%n&quot;</span>, dataSize / (<span class="number">1024.0</span> * <span class="number">1024.0</span>));</span><br><span class="line">        System.out.printf(<span class="string">&quot;åˆ†åŒºæ•°: %d%n&quot;</span>, partitionCount);</span><br><span class="line">        System.out.printf(<span class="string">&quot;æ‰§è¡Œæ—¶é—´: %d ms%n&quot;</span>, executionTime);</span><br><span class="line">        System.out.printf(<span class="string">&quot;ååé‡: %.2f MB/s%n&quot;</span>, </span><br><span class="line">            (dataSize / (<span class="number">1024.0</span> * <span class="number">1024.0</span>)) / (executionTime / <span class="number">1000.0</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å»ºè®®ä¼˜åŒ–ç­–ç•¥</span></span><br><span class="line">        <span class="keyword">if</span> (executionTime &gt; <span class="number">60000</span>) &#123; <span class="comment">// è¶…è¿‡1åˆ†é’Ÿ</span></span><br><span class="line">            System.out.println(<span class="string">&quot;å»ºè®®ï¼š&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;1. å¢åŠ åˆ†åŒºæ•°ä»¥æé«˜å¹¶è¡Œåº¦&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;2. è€ƒè™‘æ˜¯å¦éœ€è¦æ’åºæ•´ä¸ªæ•°æ®é›†&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;3. ä½¿ç”¨takeOrdered()å¦‚æœåªéœ€è¦å‰å‡ å&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ‰§è¡ŒåŸç†æ·±åº¦å‰–æï¼š</strong></p><ol><li><strong>é‡‡æ ·é˜¶æ®µ</strong>ï¼šé€šè¿‡æ°´å¡˜é‡‡æ ·è·å–æ•°æ®åˆ†å¸ƒç‰¹å¾</li><li><strong>åˆ†åŒºè¾¹ç•Œè®¡ç®—</strong>ï¼šåŸºäºæ ·æœ¬è®¡ç®—æœ€ä¼˜çš„åˆ†åŒºè¾¹ç•Œ</li><li><strong>Shuffleé‡åˆ†åŒº</strong>ï¼šæ ¹æ®åˆ†åŒºè¾¹ç•Œé‡æ–°åˆ†å¸ƒæ•°æ®</li><li><strong>åˆ†åŒºå†…æ’åº</strong>ï¼šåœ¨æ¯ä¸ªåˆ†åŒºå†…ç‹¬ç«‹æ’åº</li><li><strong>ç»“æœåˆå¹¶</strong>ï¼šæŒ‰åˆ†åŒºé¡ºåºè¿æ¥å¾—åˆ°å…¨å±€æœ‰åºç»“æœ</li></ol><p><strong>å…³é”®æ€§èƒ½è€ƒè™‘ï¼š</strong></p><ul><li><strong>é‡‡æ ·è´¨é‡</strong>ï¼šå½±å“åˆ†åŒºè¾¹ç•Œçš„å‡†ç¡®æ€§å’Œè´Ÿè½½å‡è¡¡</li><li><strong>åˆ†åŒºæ•°é‡</strong>ï¼šå½±å“å¹¶è¡Œåº¦å’Œå•åˆ†åŒºå¤§å°</li><li><strong>å†…å­˜ç®¡ç†</strong>ï¼šå¤§åˆ†åŒºå¯èƒ½éœ€è¦å¤–éƒ¨æ’åº</li><li><strong>æ•°æ®å€¾æ–œ</strong>ï¼šä¸å‡åŒ€çš„åˆ†åŒºè¾¹ç•Œå¯¼è‡´æ€§èƒ½ç“¶é¢ˆ</li></ul><p><strong>æœ€ä½³å®è·µå»ºè®®ï¼š</strong></p><ul><li>æ’åºå‰å…ˆè¯„ä¼°æ•°æ®ç‰¹å¾å’Œå¿…è¦æ€§</li><li>åˆç†é€‰æ‹©åˆ†åŒºæ•°é‡å¹³è¡¡å¹¶è¡Œåº¦å’Œå¼€é”€</li><li>å¯¹äºéƒ¨åˆ†æ’åºéœ€æ±‚ä½¿ç”¨takeOrderedç­‰ä¼˜åŒ–ç®—å­</li><li>ç›‘æ§Shuffleæ•°æ®é‡å’Œåˆ†åŒºå¤§å°åˆ†å¸ƒ</li><li>è€ƒè™‘ä½¿ç”¨è¿‘ä¼¼æ’åºç®—æ³•å¤„ç†è¶…å¤§æ•°æ®é›†</li></ul><p>sortByç®—å­çš„å¤æ‚æ€§ä½“ç°åœ¨å…¶éœ€è¦åè°ƒé‡‡æ ·ã€åˆ†åŒºã€Shuffleå’Œæ’åºç­‰å¤šä¸ªæ­¥éª¤ï¼Œç†è§£è¿™äº›ç»†èŠ‚æœ‰åŠ©äºæˆ‘ä»¬åœ¨å®é™…åº”ç”¨ä¸­åšå‡ºæ›´å¥½çš„æ€§èƒ½ä¼˜åŒ–å†³ç­–ã€‚</p><h2 id="å››ã€å®¹é”™æœºåˆ¶ï¼šè¡€ç¼˜å…³ç³»ä¸æ•…éšœæ¢å¤"><a href="#å››ã€å®¹é”™æœºåˆ¶ï¼šè¡€ç¼˜å…³ç³»ä¸æ•…éšœæ¢å¤" class="headerlink" title="å››ã€å®¹é”™æœºåˆ¶ï¼šè¡€ç¼˜å…³ç³»ä¸æ•…éšœæ¢å¤"></a>å››ã€å®¹é”™æœºåˆ¶ï¼šè¡€ç¼˜å…³ç³»ä¸æ•…éšœæ¢å¤</h2><p>Sparkçš„å®¹é”™èƒ½åŠ›æ˜¯å…¶åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¯é è¿è¡Œçš„åŸºçŸ³ã€‚é€šè¿‡RDDè¡€ç¼˜å…³ç³»ï¼ˆLineageï¼‰å’Œæ£€æŸ¥ç‚¹ï¼ˆCheckpointï¼‰æœºåˆ¶ï¼ŒSparkèƒ½å¤Ÿåœ¨èŠ‚ç‚¹æ•…éšœæ—¶è‡ªåŠ¨æ¢å¤è®¡ç®—ï¼Œä¿è¯ä½œä¸šçš„æˆåŠŸæ‰§è¡Œã€‚</p><h3 id="4-1-RDDè¡€ç¼˜å…³ç³»æ·±åº¦è§£æ"><a href="#4-1-RDDè¡€ç¼˜å…³ç³»æ·±åº¦è§£æ" class="headerlink" title="4.1 RDDè¡€ç¼˜å…³ç³»æ·±åº¦è§£æ"></a>4.1 RDDè¡€ç¼˜å…³ç³»æ·±åº¦è§£æ</h3><h4 id="4-1-1-è¡€ç¼˜å…³ç³»çš„æ•°æ®ç»“æ„"><a href="#4-1-1-è¡€ç¼˜å…³ç³»çš„æ•°æ®ç»“æ„" class="headerlink" title="4.1.1 è¡€ç¼˜å…³ç³»çš„æ•°æ®ç»“æ„"></a>4.1.1 è¡€ç¼˜å…³ç³»çš„æ•°æ®ç»“æ„</h4><p><strong>ä¾èµ–å…³ç³»çš„ç±»å‹ä¸å®ç°ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RDDä¾èµ–å…³ç³»çš„æ ¸å¿ƒæŠ½è±¡</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Dependency</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="comment">// çˆ¶RDDå¼•ç”¨</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> RDD&lt;T&gt; rdd;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Dependency</span><span class="params">(RDD&lt;T&gt; rdd)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.rdd = rdd;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> RDD&lt;T&gt; <span class="title function_">rdd</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> rdd;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æŠ½è±¡æ–¹æ³•ï¼šè·å–çˆ¶åˆ†åŒº</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> List&lt;Integer&gt; <span class="title function_">getParents</span><span class="params">(<span class="type">int</span> partitionId)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// çª„ä¾èµ–å®ç°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NarrowDependency</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">Dependency</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NarrowDependency</span><span class="params">(RDD&lt;T&gt; rdd)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(rdd);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¸€å¯¹ä¸€ä¾èµ–</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OneToOneDependency</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">NarrowDependency</span>&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">OneToOneDependency</span><span class="params">(RDD&lt;T&gt; rdd)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>(rdd);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> List&lt;Integer&gt; <span class="title function_">getParents</span><span class="params">(<span class="type">int</span> partitionId)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.singletonList(partitionId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// èŒƒå›´ä¾èµ–</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">RangeDependency</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">NarrowDependency</span>&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> inStart;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> outStart;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> length;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">RangeDependency</span><span class="params">(RDD&lt;T&gt; rdd, <span class="type">int</span> inStart, <span class="type">int</span> outStart, <span class="type">int</span> length)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>(rdd);</span><br><span class="line">            <span class="built_in">this</span>.inStart = inStart;</span><br><span class="line">            <span class="built_in">this</span>.outStart = outStart;</span><br><span class="line">            <span class="built_in">this</span>.length = length;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> List&lt;Integer&gt; <span class="title function_">getParents</span><span class="params">(<span class="type">int</span> partitionId)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (partitionId &gt;= outStart &amp;&amp; partitionId &lt; outStart + length) &#123;</span><br><span class="line">                <span class="keyword">return</span> Collections.singletonList(partitionId - outStart + inStart);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®½ä¾èµ–å®ç°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShuffleDependency</span>&lt;K, V, C&gt; <span class="keyword">extends</span> <span class="title class_">Dependency</span>&lt;Product2&lt;K, V&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> shuffleId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Partitioner partitioner;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Serializer keyOrdering;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Serializer aggregator;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> mapSideCombine;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ShuffleDependency</span><span class="params">(RDD&lt;Product2&lt;K, V&gt;&gt; rdd,</span></span><br><span class="line"><span class="params">                           Partitioner partitioner,</span></span><br><span class="line"><span class="params">                           Serializer keyOrdering,</span></span><br><span class="line"><span class="params">                           Serializer aggregator,</span></span><br><span class="line"><span class="params">                           <span class="type">boolean</span> mapSideCombine)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(rdd);</span><br><span class="line">        <span class="built_in">this</span>.shuffleId = SparkEnv.get().newShuffleId();</span><br><span class="line">        <span class="built_in">this</span>.partitioner = partitioner;</span><br><span class="line">        <span class="built_in">this</span>.keyOrdering = keyOrdering;</span><br><span class="line">        <span class="built_in">this</span>.aggregator = aggregator;</span><br><span class="line">        <span class="built_in">this</span>.mapSideCombine = mapSideCombine;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Integer&gt; <span class="title function_">getParents</span><span class="params">(<span class="type">int</span> partitionId)</span> &#123;</span><br><span class="line">        <span class="comment">// å®½ä¾èµ–ï¼šæ¯ä¸ªåˆ†åŒºä¾èµ–æ‰€æœ‰çˆ¶åˆ†åŒº</span></span><br><span class="line">        <span class="keyword">return</span> IntStream.range(<span class="number">0</span>, rdd.getNumPartitions())</span><br><span class="line">                .boxed()</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-1-2-è¡€ç¼˜å…³ç³»çš„æ„å»ºè¿‡ç¨‹"><a href="#4-1-2-è¡€ç¼˜å…³ç³»çš„æ„å»ºè¿‡ç¨‹" class="headerlink" title="4.1.2 è¡€ç¼˜å…³ç³»çš„æ„å»ºè¿‡ç¨‹"></a>4.1.2 è¡€ç¼˜å…³ç³»çš„æ„å»ºè¿‡ç¨‹</h4><p><strong>åŠ¨æ€è¡€ç¼˜å›¾æ„å»ºï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¡€ç¼˜å…³ç³»ç®¡ç†å™¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LineageManager</span> &#123;</span><br><span class="line">    <span class="comment">// å…¨å±€è¡€ç¼˜å›¾</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Integer, RDDLineage&gt; rddLineages = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// RDDè¡€ç¼˜ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">RDDLineage</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> rddId;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Dependency&lt;?&gt;&gt; dependencies;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String creationSite;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> creationTime;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; metadata;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">RDDLineage</span><span class="params">(<span class="type">int</span> rddId, List&lt;Dependency&lt;?&gt;&gt; dependencies, String creationSite)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.rddId = rddId;</span><br><span class="line">            <span class="built_in">this</span>.dependencies = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(dependencies);</span><br><span class="line">            <span class="built_in">this</span>.creationSite = creationSite;</span><br><span class="line">            <span class="built_in">this</span>.creationTime = System.currentTimeMillis();</span><br><span class="line">            <span class="built_in">this</span>.metadata = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é€’å½’è·å–æ‰€æœ‰ç¥–å…ˆRDD</span></span><br><span class="line">        <span class="keyword">public</span> Set&lt;Integer&gt; <span class="title function_">getAllAncestors</span><span class="params">()</span> &#123;</span><br><span class="line">            Set&lt;Integer&gt; ancestors = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">            collectAncestors(ancestors);</span><br><span class="line">            <span class="keyword">return</span> ancestors;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">collectAncestors</span><span class="params">(Set&lt;Integer&gt; ancestors)</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (Dependency&lt;?&gt; dep : dependencies) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">parentId</span> <span class="operator">=</span> dep.rdd().id();</span><br><span class="line">                <span class="keyword">if</span> (ancestors.add(parentId)) &#123;</span><br><span class="line">                    <span class="comment">// é€’å½’æ”¶é›†çˆ¶RDDçš„ç¥–å…ˆ</span></span><br><span class="line">                    <span class="type">RDDLineage</span> <span class="variable">parentLineage</span> <span class="operator">=</span> rddLineages.get(parentId);</span><br><span class="line">                    <span class="keyword">if</span> (parentLineage != <span class="literal">null</span>) &#123;</span><br><span class="line">                        parentLineage.collectAncestors(ancestors);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerRDD</span><span class="params">(RDD&lt;?&gt; rdd)</span> &#123;</span><br><span class="line">        <span class="type">RDDLineage</span> <span class="variable">lineage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RDDLineage</span>(</span><br><span class="line">            rdd.id(),</span><br><span class="line">            rdd.dependencies(),</span><br><span class="line">            rdd.creationSite().shortForm()</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        rddLineages.put(rdd.id(), lineage);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è®°å½•è¡€ç¼˜å…³ç³»åˆ›å»ºæ—¥å¿—</span></span><br><span class="line">        logLineageCreation(rdd, lineage);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">logLineageCreation</span><span class="params">(RDD&lt;?&gt; rdd, RDDLineage lineage)</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">logBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        logBuilder.append(<span class="string">&quot;RDD[&quot;</span>).append(rdd.id()).append(<span class="string">&quot;] created with dependencies: &quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (Dependency&lt;?&gt; dep : lineage.dependencies) &#123;</span><br><span class="line">            logBuilder.append(<span class="string">&quot;RDD[&quot;</span>).append(dep.rdd().id()).append(<span class="string">&quot;](&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (dep <span class="keyword">instanceof</span> NarrowDependency) &#123;</span><br><span class="line">                logBuilder.append(<span class="string">&quot;Narrow&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dep <span class="keyword">instanceof</span> ShuffleDependency) &#123;</span><br><span class="line">                logBuilder.append(<span class="string">&quot;Shuffle&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            logBuilder.append(<span class="string">&quot;) &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        System.out.println(logBuilder.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-1-3-æ•…éšœæ¢å¤æœºåˆ¶"><a href="#4-1-3-æ•…éšœæ¢å¤æœºåˆ¶" class="headerlink" title="4.1.3 æ•…éšœæ¢å¤æœºåˆ¶"></a>4.1.3 æ•…éšœæ¢å¤æœºåˆ¶</h4><p><strong>åŸºäºè¡€ç¼˜å…³ç³»çš„æ•…éšœæ¢å¤ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ•…éšœæ¢å¤åè°ƒå™¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FaultRecoveryCoordinator</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LineageManager lineageManager;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TaskScheduler taskScheduler;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleTaskFailure</span><span class="params">(TaskFailureEvent event)</span> &#123;</span><br><span class="line">        Task&lt;?&gt; failedTask = event.getTask();</span><br><span class="line">        <span class="type">String</span> <span class="variable">reason</span> <span class="operator">=</span> event.getFailureReason();</span><br><span class="line">        </span><br><span class="line">        System.out.printf(<span class="string">&quot;Task %s failed: %s%n&quot;</span>, failedTask.taskId(), reason);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (isNodeFailure(reason)) &#123;</span><br><span class="line">            <span class="comment">// èŠ‚ç‚¹æ•…éšœï¼šå¯èƒ½éœ€è¦é‡æ–°è®¡ç®—å¤šä¸ªåˆ†åŒº</span></span><br><span class="line">            handleNodeFailure(failedTask, event.getFailedExecutorId());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isDataLoss(reason)) &#123;</span><br><span class="line">            <span class="comment">// æ•°æ®ä¸¢å¤±ï¼šåŸºäºè¡€ç¼˜å…³ç³»é‡æ–°è®¡ç®—</span></span><br><span class="line">            handleDataLoss(failedTask);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æ™®é€šä»»åŠ¡å¤±è´¥ï¼šç®€å•é‡è¯•</span></span><br><span class="line">            retryTask(failedTask);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleDataLoss</span><span class="params">(Task&lt;?&gt; failedTask)</span> &#123;</span><br><span class="line">        RDD&lt;?&gt; targetRDD = failedTask.rdd;</span><br><span class="line">        <span class="type">int</span> <span class="variable">partitionId</span> <span class="operator">=</span> failedTask.partitionId;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. æŸ¥æ‰¾æ•°æ®ä¸¢å¤±çš„RDDåˆ†åŒº</span></span><br><span class="line">        List&lt;RDDPartition&gt; lostPartitions = findLostPartitions(targetRDD, partitionId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. æ„å»ºæ¢å¤è®¡åˆ’</span></span><br><span class="line">        <span class="type">RecoveryPlan</span> <span class="variable">plan</span> <span class="operator">=</span> buildRecoveryPlan(lostPartitions);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. æ‰§è¡Œæ¢å¤è®¡ç®—</span></span><br><span class="line">        executeRecoveryPlan(plan);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> RecoveryPlan <span class="title function_">buildRecoveryPlan</span><span class="params">(List&lt;RDDPartition&gt; lostPartitions)</span> &#123;</span><br><span class="line">        <span class="type">RecoveryPlan</span> <span class="variable">plan</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RecoveryPlan</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (RDDPartition lostPartition : lostPartitions) &#123;</span><br><span class="line">            <span class="comment">// åŸºäºè¡€ç¼˜å…³ç³»å›æº¯åˆ°å¯ç”¨æ•°æ®æº</span></span><br><span class="line">            List&lt;RecoveryTask&gt; recoveryTasks = traceBackToAvailableData(lostPartition);</span><br><span class="line">            plan.addTasks(recoveryTasks);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä¼˜åŒ–æ¢å¤è®¡åˆ’ï¼šåˆå¹¶ç›¸åŒçš„è®¡ç®—è·¯å¾„</span></span><br><span class="line">        plan.optimize();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> plan;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> List&lt;RecoveryTask&gt; <span class="title function_">traceBackToAvailableData</span><span class="params">(RDDPartition lostPartition)</span> &#123;</span><br><span class="line">        List&lt;RecoveryTask&gt; tasks = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        Queue&lt;RDDPartition&gt; toRecover = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        toRecover.offer(lostPartition);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> (!toRecover.isEmpty()) &#123;</span><br><span class="line">            <span class="type">RDDPartition</span> <span class="variable">current</span> <span class="operator">=</span> toRecover.poll();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (isDataAvailable(current)) &#123;</span><br><span class="line">                <span class="comment">// æ•°æ®å¯ç”¨ï¼Œæ— éœ€æ¢å¤</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="type">RDDLineage</span> <span class="variable">lineage</span> <span class="operator">=</span> lineageManager.getRDDLineage(current.rddId);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (Dependency&lt;?&gt; dep : lineage.dependencies) &#123;</span><br><span class="line">                <span class="keyword">if</span> (dep <span class="keyword">instanceof</span> NarrowDependency) &#123;</span><br><span class="line">                    <span class="comment">// çª„ä¾èµ–ï¼šè¿½æº¯åˆ°çˆ¶åˆ†åŒº</span></span><br><span class="line">                    List&lt;Integer&gt; parentPartitions = dep.getParents(current.partitionId);</span><br><span class="line">                    <span class="keyword">for</span> (Integer parentPartitionId : parentPartitions) &#123;</span><br><span class="line">                        <span class="type">RDDPartition</span> <span class="variable">parentPartition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RDDPartition</span>(dep.rdd().id(), parentPartitionId);</span><br><span class="line">                        toRecover.offer(parentPartition);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dep <span class="keyword">instanceof</span> ShuffleDependency) &#123;</span><br><span class="line">                    <span class="comment">// å®½ä¾èµ–ï¼šéœ€è¦æ‰€æœ‰çˆ¶åˆ†åŒº</span></span><br><span class="line">                    ShuffleDependency&lt;?, ?, ?&gt; shuffleDep = (ShuffleDependency&lt;?, ?, ?&gt;) dep;</span><br><span class="line">                    <span class="keyword">if</span> (!isShuffleDataAvailable(shuffleDep.shuffleId())) &#123;</span><br><span class="line">                        <span class="comment">// Shuffleæ•°æ®ä¸¢å¤±ï¼Œéœ€è¦é‡æ–°è®¡ç®—æ‰€æœ‰çˆ¶åˆ†åŒº</span></span><br><span class="line">                        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; dep.rdd().getNumPartitions(); i++) &#123;</span><br><span class="line">                            <span class="type">RDDPartition</span> <span class="variable">parentPartition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RDDPartition</span>(dep.rdd().id(), i);</span><br><span class="line">                            toRecover.offer(parentPartition);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// åˆ›å»ºæ¢å¤ä»»åŠ¡</span></span><br><span class="line">            <span class="type">RecoveryTask</span> <span class="variable">task</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RecoveryTask</span>(current, lineage);</span><br><span class="line">            tasks.add(task);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> tasks;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-2-æ£€æŸ¥ç‚¹æœºåˆ¶è¯¦è§£"><a href="#4-2-æ£€æŸ¥ç‚¹æœºåˆ¶è¯¦è§£" class="headerlink" title="4.2 æ£€æŸ¥ç‚¹æœºåˆ¶è¯¦è§£"></a>4.2 æ£€æŸ¥ç‚¹æœºåˆ¶è¯¦è§£</h3><h4 id="4-2-1-æ£€æŸ¥ç‚¹çš„ç±»å‹ä¸ç­–ç•¥"><a href="#4-2-1-æ£€æŸ¥ç‚¹çš„ç±»å‹ä¸ç­–ç•¥" class="headerlink" title="4.2.1 æ£€æŸ¥ç‚¹çš„ç±»å‹ä¸ç­–ç•¥"></a>4.2.1 æ£€æŸ¥ç‚¹çš„ç±»å‹ä¸ç­–ç•¥</h4><p><strong>ä¸¤ç§æ£€æŸ¥ç‚¹æœºåˆ¶ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ£€æŸ¥ç‚¹ç®¡ç†å™¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CheckpointManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¯é æ£€æŸ¥ç‚¹ï¼šå†™å…¥åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ReliableCheckpointer</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String checkpointDir;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> FileSystem fileSystem;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">ReliableCheckpointer</span><span class="params">(String checkpointDir)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.checkpointDir = checkpointDir;</span><br><span class="line">            <span class="built_in">this</span>.fileSystem = FileSystem.get(<span class="keyword">new</span> <span class="title class_">Configuration</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkpoint</span><span class="params">(RDD&lt;?&gt; rdd)</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">checkpointPath</span> <span class="operator">=</span> generateCheckpointPath(rdd);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å¹¶è¡Œå†™å…¥æ‰€æœ‰åˆ†åŒºæ•°æ®</span></span><br><span class="line">            rdd.mapPartitionsWithIndex((partitionId, iterator) -&gt; &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">partitionPath</span> <span class="operator">=</span> checkpointPath + <span class="string">&quot;/part-&quot;</span> + String.format(<span class="string">&quot;%05d&quot;</span>, partitionId);</span><br><span class="line">                writePartitionToHDFS(iterator, partitionPath);</span><br><span class="line">                <span class="keyword">return</span> Collections.emptyIterator();</span><br><span class="line">            &#125;).count(); <span class="comment">// è§¦å‘å†™å…¥</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// æ ‡è®°RDDä¸ºå·²æ£€æŸ¥ç‚¹</span></span><br><span class="line">            rdd.markCheckpointed();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// æ¸…ç†è¡€ç¼˜å…³ç³»</span></span><br><span class="line">            clearLineage(rdd);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writePartitionToHDFS</span><span class="params">(Iterator&lt;?&gt; data, String path)</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">FSDataOutputStream</span> <span class="variable">output</span> <span class="operator">=</span> fileSystem.create(<span class="keyword">new</span> <span class="title class_">Path</span>(path));</span><br><span class="line">                 <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(output)) &#123;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">while</span> (data.hasNext()) &#123;</span><br><span class="line">                    oos.writeObject(data.next());</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed to write checkpoint&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æœ¬åœ°æ£€æŸ¥ç‚¹ï¼šå†™å…¥æœ¬åœ°ç£ç›˜ï¼ˆå¿«é€Ÿä½†ä¸å¯é ï¼‰</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">LocalCheckpointer</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String localDir;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">LocalCheckpointer</span><span class="params">(String localDir)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.localDir = localDir;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">checkpoint</span><span class="params">(RDD&lt;?&gt; rdd)</span> &#123;</span><br><span class="line">            <span class="comment">// æœ¬åœ°æ£€æŸ¥ç‚¹ä¸æ¸…ç†è¡€ç¼˜å…³ç³»ï¼Œå› ä¸ºæ•°æ®å¯èƒ½ä¸¢å¤±</span></span><br><span class="line">            rdd.localCheckpoint();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// ç«‹å³ç‰©åŒ–æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨</span></span><br><span class="line">            rdd.cache();</span><br><span class="line">            rdd.count(); <span class="comment">// è§¦å‘ç¼“å­˜</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-2-æ™ºèƒ½æ£€æŸ¥ç‚¹ç­–ç•¥"><a href="#4-2-2-æ™ºèƒ½æ£€æŸ¥ç‚¹ç­–ç•¥" class="headerlink" title="4.2.2 æ™ºèƒ½æ£€æŸ¥ç‚¹ç­–ç•¥"></a>4.2.2 æ™ºèƒ½æ£€æŸ¥ç‚¹ç­–ç•¥</h4><p><strong>è‡ªåŠ¨æ£€æŸ¥ç‚¹å†³ç­–ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ™ºèƒ½æ£€æŸ¥ç‚¹å†³ç­–å™¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IntelligentCheckpointDecision</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_LINEAGE_LENGTH</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">double</span> <span class="variable">RECOMPUTATION_COST_THRESHOLD</span> <span class="operator">=</span> <span class="number">0.7</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldCheckpoint</span><span class="params">(RDD&lt;?&gt; rdd)</span> &#123;</span><br><span class="line">        <span class="comment">// å†³ç­–å› å­1ï¼šè¡€ç¼˜å…³ç³»é•¿åº¦</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">lineageLength</span> <span class="operator">=</span> calculateLineageLength(rdd);</span><br><span class="line">        <span class="keyword">if</span> (lineageLength &gt; MAX_LINEAGE_LENGTH) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å†³ç­–å› å­2ï¼šé‡è®¡ç®—æˆæœ¬ä¼°ç®—</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">recomputationCost</span> <span class="operator">=</span> estimateRecomputationCost(rdd);</span><br><span class="line">        <span class="type">double</span> <span class="variable">checkpointCost</span> <span class="operator">=</span> estimateCheckpointCost(rdd);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (recomputationCost / (recomputationCost + checkpointCost) &gt; RECOMPUTATION_COST_THRESHOLD) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å†³ç­–å› å­3ï¼šRDDè¢«å¤šæ¬¡ä½¿ç”¨</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">usageCount</span> <span class="operator">=</span> countRDDUsage(rdd);</span><br><span class="line">        <span class="keyword">if</span> (usageCount &gt; <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å†³ç­–å› å­4ï¼šåŒ…å«å®½ä¾èµ–çš„å¤æ‚è®¡ç®—</span></span><br><span class="line">        <span class="keyword">if</span> (hasExpensiveOperations(rdd)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">calculateLineageLength</span><span class="params">(RDD&lt;?&gt; rdd)</span> &#123;</span><br><span class="line">        Set&lt;Integer&gt; visited = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">return</span> calculateLineageLengthRecursive(rdd, visited);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">calculateLineageLengthRecursive</span><span class="params">(RDD&lt;?&gt; rdd, Set&lt;Integer&gt; visited)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (visited.contains(rdd.id()) || rdd.isCheckpointed()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        visited.add(rdd.id());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (rdd.dependencies().isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">// å¶å­èŠ‚ç‚¹</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">int</span> <span class="variable">maxDepth</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (Dependency&lt;?&gt; dep : rdd.dependencies()) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">depth</span> <span class="operator">=</span> calculateLineageLengthRecursive(dep.rdd(), visited);</span><br><span class="line">            maxDepth = Math.max(maxDepth, depth);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> maxDepth + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> <span class="title function_">estimateRecomputationCost</span><span class="params">(RDD&lt;?&gt; rdd)</span> &#123;</span><br><span class="line">        <span class="type">double</span> <span class="variable">cost</span> <span class="operator">=</span> <span class="number">0.0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// éå†è¡€ç¼˜å…³ç³»ï¼Œç´¯è®¡è®¡ç®—æˆæœ¬</span></span><br><span class="line">        <span class="keyword">for</span> (Dependency&lt;?&gt; dep : rdd.dependencies()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (dep <span class="keyword">instanceof</span> ShuffleDependency) &#123;</span><br><span class="line">                cost += <span class="number">100.0</span>; <span class="comment">// Shuffleæ“ä½œæˆæœ¬é«˜</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                cost += <span class="number">10.0</span>;  <span class="comment">// çª„ä¾èµ–æ“ä½œæˆæœ¬ä½</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// é€’å½’è®¡ç®—çˆ¶RDDçš„æˆæœ¬</span></span><br><span class="line">            cost += estimateRecomputationCost(dep.rdd()) * <span class="number">0.8</span>; <span class="comment">// é€’å‡æƒé‡</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> cost;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> <span class="title function_">estimateCheckpointCost</span><span class="params">(RDD&lt;?&gt; rdd)</span> &#123;</span><br><span class="line">        <span class="comment">// åŸºäºæ•°æ®é‡å’ŒIOé€Ÿåº¦ä¼°ç®—æ£€æŸ¥ç‚¹æˆæœ¬</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">dataSize</span> <span class="operator">=</span> estimateRDDSize(rdd);</span><br><span class="line">        <span class="type">double</span> <span class="variable">ioSpeed</span> <span class="operator">=</span> <span class="number">100.0</span>; <span class="comment">// MB/s</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> dataSize / (<span class="number">1024.0</span> * <span class="number">1024.0</span>) / ioSpeed; <span class="comment">// ç§’</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-3-å®¹é”™æœºåˆ¶çš„æ€§èƒ½å½±å“"><a href="#4-3-å®¹é”™æœºåˆ¶çš„æ€§èƒ½å½±å“" class="headerlink" title="4.3 å®¹é”™æœºåˆ¶çš„æ€§èƒ½å½±å“"></a>4.3 å®¹é”™æœºåˆ¶çš„æ€§èƒ½å½±å“</h3><h4 id="4-3-1-å®¹é”™å¼€é”€åˆ†æ"><a href="#4-3-1-å®¹é”™å¼€é”€åˆ†æ" class="headerlink" title="4.3.1 å®¹é”™å¼€é”€åˆ†æ"></a>4.3.1 å®¹é”™å¼€é”€åˆ†æ</h4><p><strong>å®¹é”™æœºåˆ¶çš„æˆæœ¬æ„æˆï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®¹é”™æˆæœ¬åˆ†æå™¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FaultToleranceCostAnalyzer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">analyzeFaultToleranceCosts</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;=== Sparkå®¹é”™æœºåˆ¶æˆæœ¬åˆ†æ ===&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. è¡€ç¼˜å…³ç³»ç»´æŠ¤æˆæœ¬</span></span><br><span class="line">        analyzeLinage <span class="title function_">Overhead</span><span class="params">()</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. æ£€æŸ¥ç‚¹æˆæœ¬</span></span><br><span class="line">        analyzeCheckpointCosts();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. æ•…éšœæ¢å¤æˆæœ¬</span></span><br><span class="line">        analyzeRecoveryCosts();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">analyzeLineageOverhead</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;1. è¡€ç¼˜å…³ç³»ç»´æŠ¤å¼€é”€ï¼š&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - å†…å­˜å¼€é”€ï¼šæ¯ä¸ªRDDçº¦1KBå…ƒæ•°æ®&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - CPUå¼€é”€ï¼šä¾èµ–å…³ç³»éå†å’Œç®¡ç†&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - ç½‘ç»œå¼€é”€ï¼šè¡€ç¼˜ä¿¡æ¯åœ¨Driverå’ŒExecutoré—´ä¼ è¾“&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - æ€»ä½“å½±å“ï¼šæ­£å¸¸æƒ…å†µä¸‹&lt;5%æ€§èƒ½å¼€é”€&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">analyzeCheckpointCosts</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;2. æ£€æŸ¥ç‚¹æœºåˆ¶å¼€é”€ï¼š&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - ç£ç›˜IOï¼šæ•°æ®å†™å…¥åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - ç½‘ç»œIOï¼šæ•°æ®åœ¨èŠ‚ç‚¹é—´å¤åˆ¶&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - å†…å­˜å ç”¨ï¼šä¸´æ—¶ç¼“å†²åŒº&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - å…¸å‹å¼€é”€ï¼šå¢åŠ 20-40%æ‰§è¡Œæ—¶é—´&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ£€æŸ¥ç‚¹æ”¶ç›Šåˆ†æ</span></span><br><span class="line">        System.out.println(<span class="string">&quot;   - æ”¶ç›Šï¼šæ˜¾è‘—å‡å°‘æ•…éšœæ¢å¤æ—¶é—´&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - é€‚ç”¨åœºæ™¯ï¼šé•¿è¡€ç¼˜é“¾ã€å¤šæ¬¡ä½¿ç”¨çš„RDD&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">analyzeRecoveryCosts</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;3. æ•…éšœæ¢å¤å¼€é”€ï¼š&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - æ— æ£€æŸ¥ç‚¹ï¼šé‡æ–°è®¡ç®—æ•´ä¸ªè¡€ç¼˜é“¾&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - æœ‰æ£€æŸ¥ç‚¹ï¼šä»æœ€è¿‘æ£€æŸ¥ç‚¹å¼€å§‹æ¢å¤&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - ç½‘ç»œå¼€é”€ï¼šé‡æ–°è·å–ä¸¢å¤±çš„æ•°æ®&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;   - è®¡ç®—å¼€é”€ï¼šé‡æ–°æ‰§è¡Œä¸¢å¤±çš„è®¡ç®—&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-3-2-å®¹é”™ä¼˜åŒ–ç­–ç•¥"><a href="#4-3-2-å®¹é”™ä¼˜åŒ–ç­–ç•¥" class="headerlink" title="4.3.2 å®¹é”™ä¼˜åŒ–ç­–ç•¥"></a>4.3.2 å®¹é”™ä¼˜åŒ–ç­–ç•¥</h4><p><strong>å®¹é”™æ€§èƒ½ä¼˜åŒ–ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®¹é”™ä¼˜åŒ–ç­–ç•¥å®ç°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FaultToleranceOptimizer</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">optimizeFaultTolerance</span><span class="params">(SparkContext sc)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. é…ç½®æ£€æŸ¥ç‚¹ç›®å½•</span></span><br><span class="line">        sc.setCheckpointDir(<span class="string">&quot;hdfs://namenode:port/checkpoints&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. æ™ºèƒ½æ£€æŸ¥ç‚¹ç­–ç•¥</span></span><br><span class="line">        enableIntelligentCheckpointing(sc);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. ä¼˜åŒ–è¡€ç¼˜å…³ç³»ç®¡ç†</span></span><br><span class="line">        optimizeLineageManagement(sc);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. é…ç½®æ•…éšœæ¢å¤å‚æ•°</span></span><br><span class="line">        configureFailureRecovery(sc);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">enableIntelligentCheckpointing</span><span class="params">(SparkContext sc)</span> &#123;</span><br><span class="line">        <span class="comment">// è‡ªåŠ¨æ£€æŸ¥ç‚¹å†³ç­–</span></span><br><span class="line">        sc.addSparkListener(<span class="keyword">new</span> <span class="title class_">SparkListener</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onJobEnd</span><span class="params">(SparkListenerJobEnd jobEnd)</span> &#123;</span><br><span class="line">                <span class="comment">// åˆ†æå·²å®Œæˆçš„Jobï¼Œå†³å®šå“ªäº›RDDåº”è¯¥æ£€æŸ¥ç‚¹</span></span><br><span class="line">                <span class="keyword">for</span> (RDD&lt;?&gt; rdd : getActiveRDDs()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (shouldCheckpoint(rdd)) &#123;</span><br><span class="line">                        rdd.checkpoint();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">optimizeLineageManagement</span><span class="params">(SparkContext sc)</span> &#123;</span><br><span class="line">        <span class="comment">// å®šæœŸæ¸…ç†ä¸éœ€è¦çš„è¡€ç¼˜ä¿¡æ¯</span></span><br><span class="line">        sc.addSparkListener(<span class="keyword">new</span> <span class="title class_">SparkListener</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEnd</span><span class="params">(SparkListenerApplicationEnd applicationEnd)</span> &#123;</span><br><span class="line">                cleanupLineageMetadata();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">configureFailureRecovery</span><span class="params">(SparkContext sc)</span> &#123;</span><br><span class="line">        <span class="type">SparkConf</span> <span class="variable">conf</span> <span class="operator">=</span> sc.getConf();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é…ç½®ä»»åŠ¡é‡è¯•æ¬¡æ•°</span></span><br><span class="line">        conf.set(<span class="string">&quot;spark.task.maxAttempts&quot;</span>, <span class="string">&quot;3&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é…ç½®Stageé‡è¯•æ¬¡æ•°</span></span><br><span class="line">        conf.set(<span class="string">&quot;spark.stage.maxConsecutiveAttempts&quot;</span>, <span class="string">&quot;8&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é…ç½®é»‘åå•æœºåˆ¶</span></span><br><span class="line">        conf.set(<span class="string">&quot;spark.blacklist.enabled&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        conf.set(<span class="string">&quot;spark.blacklist.timeout&quot;</span>, <span class="string">&quot;1h&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é…ç½®åŠ¨æ€åˆ†é…</span></span><br><span class="line">        conf.set(<span class="string">&quot;spark.dynamicAllocation.enabled&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        conf.set(<span class="string">&quot;spark.dynamicAllocation.maxExecutors&quot;</span>, <span class="string">&quot;100&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®¹é”™æœºåˆ¶æ˜¯Sparkç¨³å®šæ€§çš„é‡è¦ä¿éšœï¼Œè™½ç„¶ä¼šå¸¦æ¥ä¸€å®šçš„æ€§èƒ½å¼€é”€ï¼Œä½†åœ¨å¤§è§„æ¨¡ç”Ÿäº§ç¯å¢ƒä¸­æ˜¯å¿…ä¸å¯å°‘çš„ã€‚ç†è§£å®¹é”™åŸç†æœ‰åŠ©äºæˆ‘ä»¬åœ¨æ€§èƒ½å’Œå¯é æ€§ä¹‹é—´æ‰¾åˆ°æœ€ä½³å¹³è¡¡ç‚¹ã€‚</p><h2 id="äº”ã€Spark3-x-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥å¤§å…¨"><a href="#äº”ã€Spark3-x-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥å¤§å…¨" class="headerlink" title="äº”ã€Spark3.x æ€§èƒ½ä¼˜åŒ–ç­–ç•¥å¤§å…¨"></a>äº”ã€Spark3.x æ€§èƒ½ä¼˜åŒ–ç­–ç•¥å¤§å…¨</h2><h3 id="5-1-ç®—å­é“¾ä¼˜åŒ–"><a href="#5-1-ç®—å­é“¾ä¼˜åŒ–" class="headerlink" title="5.1 ç®—å­é“¾ä¼˜åŒ–"></a>5.1 ç®—å­é“¾ä¼˜åŒ–</h3><p>Sparkä¼šè‡ªåŠ¨å°†è¿ç»­çš„çª„ä¾èµ–ç®—å­åˆå¹¶æˆå•ä¸ªä»»åŠ¡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">JavaRDD&lt;Integer&gt; result = rdd</span><br><span class="line">    .map(x -&gt; x * <span class="number">2</span>)      <span class="comment">// çª„ä¾èµ–</span></span><br><span class="line">    .filter(x -&gt; x &gt; <span class="number">10</span>)   <span class="comment">// çª„ä¾èµ–</span></span><br><span class="line">    .map(x -&gt; x + <span class="number">1</span>);      <span class="comment">// çª„ä¾èµ–</span></span><br><span class="line"><span class="comment">// è¿™ä¸‰ä¸ªæ“ä½œä¼šè¢«åˆå¹¶æˆä¸€ä¸ªä»»åŠ¡æ‰§è¡Œ</span></span><br></pre></td></tr></table></figure><p><strong>ç®—å­é“¾çš„ä¼˜åŒ–åŸç†ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‰‹åŠ¨æ§åˆ¶ç®—å­é“¾</span></span><br><span class="line">JavaRDD&lt;Integer&gt; chained = rdd</span><br><span class="line">    .map(x -&gt; x * <span class="number">2</span>)</span><br><span class="line">    .filter(x -&gt; x &gt; <span class="number">10</span>)</span><br><span class="line">    .map(x -&gt; x + <span class="number">1</span>)</span><br><span class="line">    .cache(); <span class="comment">// ç¼“å­˜ä¸­é—´ç»“æœ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¼ºåˆ¶è§¦å‘è®¡ç®—</span></span><br><span class="line">chained.count();</span><br></pre></td></tr></table></figure><h3 id="5-2-å®½ä¾èµ–çš„Stageè¾¹ç•Œ"><a href="#5-2-å®½ä¾èµ–çš„Stageè¾¹ç•Œ" class="headerlink" title="5.2 å®½ä¾èµ–çš„Stageè¾¹ç•Œ"></a>5.2 å®½ä¾èµ–çš„Stageè¾¹ç•Œ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">JavaRDD&lt;Integer&gt; result = rdd</span><br><span class="line">    .map(x -&gt; x * <span class="number">2</span>)           <span class="comment">// Stage 1</span></span><br><span class="line">    .filter(x -&gt; x &gt; <span class="number">10</span>)       <span class="comment">// Stage 1</span></span><br><span class="line">    .mapToPair(x -&gt; <span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(x % <span class="number">10</span>, x))     <span class="comment">// Stage 1</span></span><br><span class="line">    .groupByKey()              <span class="comment">// Stage 2 (å®½ä¾èµ–)</span></span><br><span class="line">    .mapValues(iter -&gt; iter.iterator().next());   <span class="comment">// Stage 2</span></span><br></pre></td></tr></table></figure><p><strong>Stageåˆ’åˆ†åŸç†ï¼š</strong></p><pre class="mermaid">graph TD    A[RDD 1] -->|map| B[RDD 2<br/>çª„ä¾èµ–]    B -->|filter| C[RDD 3<br/>çª„ä¾èµ–]    C -->|mapToPair| D[RDD 4<br/>çª„ä¾èµ–]    D -->|groupByKey| E[RDD 5<br/>å®½ä¾èµ–]    E -->|mapValues| F[RDD 6<br/>çª„ä¾èµ–]        G[Stage 1<br/>æ‰€æœ‰çª„ä¾èµ–] --> H[Stage 2<br/>ä»å®½ä¾èµ–å¼€å§‹]</pre><h3 id="5-3-å®é™…æ€§èƒ½æµ‹è¯•"><a href="#5-3-å®é™…æ€§èƒ½æµ‹è¯•" class="headerlink" title="5.3 å®é™…æ€§èƒ½æµ‹è¯•"></a>5.3 å®é™…æ€§èƒ½æµ‹è¯•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æµ‹è¯•æ•°æ®ï¼š100ä¸‡æ¡è®°å½•</span></span><br><span class="line">JavaRDD&lt;Integer&gt; data = sc.parallelize(range(<span class="number">1</span>, <span class="number">1000001</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœºæ™¯1ï¼šçº¯çª„ä¾èµ– - çº¦2ç§’</span></span><br><span class="line">JavaRDD&lt;Integer&gt; result1 = data.map(x -&gt; x * <span class="number">2</span>)</span><br><span class="line">    .filter(x -&gt; x &gt; <span class="number">100</span>)</span><br><span class="line">    .map(x -&gt; x + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœºæ™¯2ï¼šåŒ…å«Shuffle - çº¦15ç§’</span></span><br><span class="line">JavaPairRDD&lt;Integer, Integer&gt; result2 = data.mapToPair(x -&gt; <span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(x % <span class="number">100</span>, x))</span><br><span class="line">    .groupByKey()</span><br><span class="line">    .mapValues(iter -&gt; &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (Integer i : iter) &#123;</span><br><span class="line">            sum += i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœºæ™¯3ï¼šæ’åºæ“ä½œ - çº¦30ç§’</span></span><br><span class="line">JavaRDD&lt;Integer&gt; result3 = data.sortBy(x -&gt; x, <span class="literal">true</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure><p><strong>æ€§èƒ½ç›‘æ§ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¼€å¯æ€§èƒ½ç›‘æ§</span></span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.eventLog.enabled&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.sql.adaptive.logLevel&quot;</span>, <span class="string">&quot;DEBUG&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›‘æ§Shuffleæ•°æ®é‡</span></span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.sql.adaptive.skewJoin.skewedPartitionThresholdInBytes&quot;</span>, <span class="string">&quot;256MB&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="ä¸ƒã€ç®—å­ç»„åˆçš„æ€§èƒ½å½±å“ä¸æœ€ä½³å®è·µ"><a href="#ä¸ƒã€ç®—å­ç»„åˆçš„æ€§èƒ½å½±å“ä¸æœ€ä½³å®è·µ" class="headerlink" title="ä¸ƒã€ç®—å­ç»„åˆçš„æ€§èƒ½å½±å“ä¸æœ€ä½³å®è·µ"></a>ä¸ƒã€ç®—å­ç»„åˆçš„æ€§èƒ½å½±å“ä¸æœ€ä½³å®è·µ</h2><h3 id="7-1-ç®—å­é€‰æ‹©åŸåˆ™"><a href="#7-1-ç®—å­é€‰æ‹©åŸåˆ™" class="headerlink" title="7.1 ç®—å­é€‰æ‹©åŸåˆ™"></a>7.1 ç®—å­é€‰æ‹©åŸåˆ™</h3><ol><li><strong>ä¼˜å…ˆä½¿ç”¨çª„ä¾èµ–ç®—å­</strong>ï¼šmapã€filterã€flatMapç­‰</li><li><strong>é¿å…ä¸å¿…è¦çš„Shuffle</strong>ï¼šåˆç†ä½¿ç”¨map-sideèšåˆ</li><li><strong>æ§åˆ¶æ•°æ®å€¾æ–œ</strong>ï¼šä½¿ç”¨è‡ªå®šä¹‰åˆ†åŒºå™¨æˆ–é¢„èšåˆ</li></ol><h3 id="7-2-å†…å­˜ä¼˜åŒ–"><a href="#7-2-å†…å­˜ä¼˜åŒ–" class="headerlink" title="7.2 å†…å­˜ä¼˜åŒ–"></a>7.2 å†…å­˜ä¼˜åŒ–</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆç†è®¾ç½®åˆ†åŒºæ•°</span></span><br><span class="line">JavaRDD&lt;LargeObject&gt; rdd = sc.parallelize(largeDataset, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨å¹¿æ’­å˜é‡å‡å°‘Shuffle</span></span><br><span class="line">Broadcast&lt;Map&lt;String, String&gt;&gt; broadcastVar = sc.broadcast(largeLookupTable, </span><br><span class="line">    scala.reflect.ClassTag$.MODULE$.apply(Map.class));</span><br><span class="line">JavaRDD&lt;Tuple2&lt;String, String&gt;&gt; result = rdd.mapToPair(x -&gt; </span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(x, broadcastVar.value().get(x)));</span><br></pre></td></tr></table></figure><p><strong>å†…å­˜é…ç½®ä¼˜åŒ–ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è°ƒæ•´å†…å­˜é…ç½®</span></span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.memory.fraction&quot;</span>, <span class="string">&quot;0.8&quot;</span>);</span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.memory.storageFraction&quot;</span>, <span class="string">&quot;0.3&quot;</span>);</span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.memory.offHeap.enabled&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.memory.offHeap.size&quot;</span>, <span class="string">&quot;1g&quot;</span>);</span><br></pre></td></tr></table></figure><h3 id="7-3-ç›‘æ§ä¸è°ƒè¯•"><a href="#7-3-ç›‘æ§ä¸è°ƒè¯•" class="headerlink" title="7.3 ç›‘æ§ä¸è°ƒè¯•"></a>7.3 ç›‘æ§ä¸è°ƒè¯•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¼€å¯è¯¦ç»†æ—¥å¿—</span></span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.eventLog.enabled&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›‘æ§GCæƒ…å†µ</span></span><br><span class="line">spark.conf().set(<span class="string">&quot;spark.executor.extraJavaOptions&quot;</span>, </span><br><span class="line">    <span class="string">&quot;-XX:+PrintGCDetails -XX:+PrintGCTimeStamps&quot;</span>);</span><br></pre></td></tr></table></figure><p><strong>æ€§èƒ½åˆ†æå·¥å…·ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨Spark UIç›‘æ§</span></span><br><span class="line"><span class="comment">// è®¿é—® http://driver-host:4040</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨Spark History Server</span></span><br><span class="line"><span class="comment">// è®¿é—® http://history-server:18080</span></span><br></pre></td></tr></table></figure><h2 id="å…«ã€æ€»ç»“"><a href="#å…«ã€æ€»ç»“" class="headerlink" title="å…«ã€æ€»ç»“"></a>å…«ã€æ€»ç»“</h2><p>ç†è§£Sparkç®—å­çš„æ‰§è¡ŒåŸç†ï¼Œå¯¹äºå†™å‡ºé«˜æ€§èƒ½çš„Sparkç¨‹åºè‡³å…³é‡è¦ã€‚</p><p><strong>å…³é”®è¦ç‚¹ï¼š</strong></p><ol><li><strong>çª„ä¾èµ–æ˜¯æœ‹å‹</strong>ï¼šmapã€filterã€flatMapç­‰ç®—å­æ‰§è¡Œæ•ˆç‡é«˜</li><li><strong>Shuffleæ˜¯æ•Œäºº</strong>ï¼šå°½é‡é¿å…ä¸å¿…è¦çš„Shuffleæ“ä½œ</li><li><strong>æ•°æ®å€¾æ–œæ˜¯æ€æ‰‹</strong>ï¼šåˆç†å¤„ç†æ•°æ®å€¾æ–œé—®é¢˜</li><li><strong>ç›‘æ§æ˜¯å¿…é¡»çš„</strong>ï¼šé€šè¿‡ç›‘æ§äº†è§£ç¨‹åºçš„å®é™…æ‰§è¡Œæƒ…å†µ</li></ol><p><strong>Sparkçš„é»„é‡‘æ³•åˆ™ï¼š</strong> æ•°æ®æœ¬åœ°æ€§ &gt; ç®—å­é€‰æ‹© &gt; å‚æ•°è°ƒä¼˜</p><p>åœ¨å®é™…å¼€å‘ä¸­ï¼Œä¸è¦ç›²ç›®è¿½æ±‚ä»£ç çš„ç®€æ´æ€§ï¼Œè€Œåº”è¯¥æ ¹æ®æ•°æ®ç‰¹ç‚¹å’Œä¸šåŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚çš„ç®—å­ç»„åˆã€‚æœ‰æ—¶å€™ï¼Œå¤šå†™å‡ è¡Œä»£ç ï¼Œæ¢æ¥çš„æ˜¯å‡ å€çš„æ€§èƒ½æå‡ã€‚ </p>]]></content>
      
      
      <categories>
          
          <category> å¤§æ•°æ® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spark </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Sparkä¸“æ æ•´ä½“æ–‡ç« å¤§çº²</title>
      <link href="/2025/07/08/Spark%E4%B8%93%E6%A0%8F%E6%95%B4%E4%BD%93%E6%96%87%E7%AB%A0%E5%A4%A7%E7%BA%B2/"/>
      <url>/2025/07/08/Spark%E4%B8%93%E6%A0%8F%E6%95%B4%E4%BD%93%E6%96%87%E7%AB%A0%E5%A4%A7%E7%BA%B2/</url>
      
        <content type="html"><![CDATA[<h1 id="Sparkä¸“æ æ•´ä½“æ–‡ç« å¤§çº²"><a href="#Sparkä¸“æ æ•´ä½“æ–‡ç« å¤§çº²" class="headerlink" title="Sparkä¸“æ æ•´ä½“æ–‡ç« å¤§çº²"></a>Sparkä¸“æ æ•´ä½“æ–‡ç« å¤§çº²</h1><h2 id="ä¸“æ æ¦‚è¿°"><a href="#ä¸“æ æ¦‚è¿°" class="headerlink" title="ä¸“æ æ¦‚è¿°"></a>ä¸“æ æ¦‚è¿°</h2><p>æœ¬ä¸“æ å°†ç³»ç»Ÿæ€§åœ°æ·±å…¥è§£æApache Sparkçš„æ ¸å¿ƒåŸç†ã€æ¶æ„è®¾è®¡ã€æ€§èƒ½ä¼˜åŒ–å’Œå®é™…åº”ç”¨ã€‚é€šè¿‡å››ä¸ªé˜¶æ®µçš„å­¦ä¹ è·¯å¾„ï¼Œä»åŸºç¡€æ¦‚å¿µåˆ°é«˜çº§ç‰¹æ€§ï¼Œä»ç†è®ºåŸç†åˆ°å®æˆ˜åº”ç”¨ï¼Œè®©æˆ‘ä»¬ä¸€èµ·å…¨é¢æŒæ¡SparkæŠ€æœ¯æ ˆã€‚</p><h2 id="å­¦ä¹ è·¯å¾„è®¾è®¡"><a href="#å­¦ä¹ è·¯å¾„è®¾è®¡" class="headerlink" title="å­¦ä¹ è·¯å¾„è®¾è®¡"></a>å­¦ä¹ è·¯å¾„è®¾è®¡</h2><h3 id="ç¬¬ä¸€é˜¶æ®µï¼šSparkåŸºç¡€æ ¸å¿ƒï¼ˆ4-5ç¯‡ï¼‰"><a href="#ç¬¬ä¸€é˜¶æ®µï¼šSparkåŸºç¡€æ ¸å¿ƒï¼ˆ4-5ç¯‡ï¼‰" class="headerlink" title="ç¬¬ä¸€é˜¶æ®µï¼šSparkåŸºç¡€æ ¸å¿ƒï¼ˆ4-5ç¯‡ï¼‰"></a>ç¬¬ä¸€é˜¶æ®µï¼šSparkåŸºç¡€æ ¸å¿ƒï¼ˆ4-5ç¯‡ï¼‰</h3><h4 id="1-Sparkæ ¸å¿ƒæ¦‚å¿µä¸æ¶æ„è®¾è®¡"><a href="#1-Sparkæ ¸å¿ƒæ¦‚å¿µä¸æ¶æ„è®¾è®¡" class="headerlink" title="1. Sparkæ ¸å¿ƒæ¦‚å¿µä¸æ¶æ„è®¾è®¡"></a>1. Sparkæ ¸å¿ƒæ¦‚å¿µä¸æ¶æ„è®¾è®¡</h4><ul><li><p><strong>RDDæŠ½è±¡ä¸è®¾è®¡å“²å­¦</strong></p><ul><li>RDDçš„æ ¸å¿ƒç‰¹æ€§ï¼šä¸å¯å˜æ€§ã€åˆ†åŒºã€ä¾èµ–å…³ç³»</li><li>å¼¹æ€§åˆ†å¸ƒå¼æ•°æ®é›†çš„è®¾è®¡ç†å¿µ</li><li>RDDçš„äº”å¤§ç‰¹æ€§æ·±åº¦è§£æ</li><li>å‡½æ•°å¼ç¼–ç¨‹åœ¨RDDä¸­çš„åº”ç”¨</li></ul></li><li><p><strong>æ‡’æƒ°è®¡ç®—æœºåˆ¶æ·±åº¦è§£æ</strong></p><ul><li>è½¬æ¢æ“ä½œä¸è¡ŒåŠ¨æ“ä½œçš„åŒºåˆ«</li><li>DAGï¼ˆæœ‰å‘æ— ç¯å›¾ï¼‰æ„å»ºè¿‡ç¨‹</li><li>æ‡’æƒ°è®¡ç®—çš„ä¼˜åŠ¿ä¸å®ç°åŸç†</li><li>è®¡ç®—é“¾çš„ä¼˜åŒ–ç­–ç•¥</li></ul></li><li><p><strong>Sparké›†ç¾¤æ¶æ„ä¸ç»„ä»¶è¯¦è§£</strong></p><ul><li>Driverã€Executorã€Workerçš„è§’è‰²åˆ†å·¥</li><li>é›†ç¾¤ç®¡ç†å™¨ï¼ˆStandaloneã€YARNã€Kubernetesï¼‰</li><li>èµ„æºè°ƒåº¦ä¸ä»»åŠ¡åˆ†é…æœºåˆ¶</li><li>é›†ç¾¤éƒ¨ç½²ä¸é…ç½®æœ€ä½³å®è·µ</li></ul></li><li><p><strong>æ•°æ®æœ¬åœ°æ€§åŸç†ä¸å®è·µ</strong></p><ul><li>æ•°æ®æœ¬åœ°æ€§çš„é‡è¦æ€§</li><li>ç§»åŠ¨è®¡ç®—vsç§»åŠ¨æ•°æ®çš„ç­–ç•¥</li><li>æ•°æ®æœ¬åœ°æ€§çº§åˆ«ä¸ä¼˜åŒ–</li><li>ç½‘ç»œä¼ è¾“æˆæœ¬åˆ†æ</li></ul></li></ul><h4 id="2-Sparkç®—å­åŸç†ä¸æ€§èƒ½åˆ†æ"><a href="#2-Sparkç®—å­åŸç†ä¸æ€§èƒ½åˆ†æ" class="headerlink" title="2. Sparkç®—å­åŸç†ä¸æ€§èƒ½åˆ†æ"></a>2. Sparkç®—å­åŸç†ä¸æ€§èƒ½åˆ†æ</h4><ul><li><p><strong>åŸºç¡€ç®—å­å†…éƒ¨å®ç°</strong></p><ul><li>mapï¼šä¸€å¯¹ä¸€è½¬æ¢çš„å®ç°åŸç†</li><li>filterï¼šæ•°æ®è¿‡æ»¤çš„ä¼˜åŒ–ç­–ç•¥</li><li>flatMapï¼šä¸€å¯¹å¤šè½¬æ¢çš„æœºåˆ¶</li><li>åŸºç¡€ç®—å­çš„æ€§èƒ½ç‰¹å¾åˆ†æ</li></ul></li><li><p><strong>å¤æ‚ç®—å­å·¥ä½œæœºåˆ¶</strong></p><ul><li>distinctï¼šå»é‡ç®—æ³•çš„å®ç°</li><li>sortByï¼šæ’åºç®—æ³•çš„åˆ†å¸ƒå¼å®ç°</li><li>groupByï¼šåˆ†ç»„èšåˆçš„ä¼˜åŒ–</li><li>å¤æ‚ç®—å­çš„å†…å­˜ä½¿ç”¨åˆ†æ</li></ul></li><li><p><strong>ç®—å­æ€§èƒ½å¯¹æ¯”ä¸é€‰æ‹©ç­–ç•¥</strong></p><ul><li>ä¸åŒç®—å­çš„æ—¶é—´å¤æ‚åº¦å¯¹æ¯”</li><li>å†…å­˜ä½¿ç”¨æ•ˆç‡åˆ†æ</li><li>ç®—å­é€‰æ‹©çš„å†³ç­–æ ‘</li><li>æ€§èƒ½æµ‹è¯•ä¸åŸºå‡†æµ‹è¯•æ–¹æ³•</li></ul></li><li><p><strong>ç®—å­ä¼˜åŒ–æœ€ä½³å®è·µ</strong></p><ul><li>ç®—å­é“¾ä¼˜åŒ–æŠ€æœ¯</li><li>å¹¿æ’­å˜é‡ä¸ç´¯åŠ å™¨çš„ä½¿ç”¨</li><li>è‡ªå®šä¹‰ç®—å­çš„å¼€å‘</li><li>ç®—å­è°ƒä¼˜çš„å®æˆ˜æŠ€å·§</li></ul></li></ul><h4 id="3-Spark-Shuffleæœºåˆ¶æ·±åº¦å‰–æ"><a href="#3-Spark-Shuffleæœºåˆ¶æ·±åº¦å‰–æ" class="headerlink" title="3. Spark Shuffleæœºåˆ¶æ·±åº¦å‰–æ"></a>3. Spark Shuffleæœºåˆ¶æ·±åº¦å‰–æ</h4><ul><li><p><strong>Shuffleè§¦å‘æ¡ä»¶ä¸æˆæœ¬åˆ†æ</strong></p><ul><li>ä½•æ—¶è§¦å‘Shuffleæ“ä½œ</li><li>Shuffleçš„æˆæœ¬æ¨¡å‹åˆ†æ</li><li>é¿å…ä¸å¿…è¦çš„Shuffleç­–ç•¥</li><li>Shuffleå¯¹æ€§èƒ½çš„å½±å“è¯„ä¼°</li></ul></li><li><p><strong>Shuffle Write&#x2F;Readè¯¦ç»†æµç¨‹</strong></p><ul><li>Shuffle Writeé˜¶æ®µçš„æ•°æ®å¤„ç†</li><li>æ•°æ®åˆ†åŒºä¸æ’åºæœºåˆ¶</li><li>Shuffle Readé˜¶æ®µçš„æ•°æ®è·å–</li><li>ç½‘ç»œä¼ è¾“ä¸ç£ç›˜I&#x2F;Oä¼˜åŒ–</li></ul></li><li><p><strong>ç½‘ç»œä¼ è¾“ä¸æ•°æ®åˆå¹¶ç­–ç•¥</strong></p><ul><li>ç½‘ç»œä¼ è¾“åè®®ä¸ä¼˜åŒ–</li><li>æ•°æ®åˆå¹¶ç®—æ³•çš„é€‰æ‹©</li><li>å†…å­˜ç¼“å†²åŒºç®¡ç†</li><li>ç½‘ç»œæ‹¥å¡æ§åˆ¶ç­–ç•¥</li></ul></li><li><p><strong>Shuffleä¼˜åŒ–æŠ€æœ¯ä¸å®è·µ</strong></p><ul><li>è‡ªå®šä¹‰åˆ†åŒºå™¨è®¾è®¡</li><li>æ•°æ®å€¾æ–œå¤„ç†æŠ€æœ¯</li><li>Shuffleè°ƒä¼˜å‚æ•°è¯¦è§£</li><li>é«˜çº§Shuffleä¼˜åŒ–ç­–ç•¥</li></ul></li></ul><h4 id="4-Sparkå†…å­˜ç®¡ç†ä¸åºåˆ—åŒ–"><a href="#4-Sparkå†…å­˜ç®¡ç†ä¸åºåˆ—åŒ–" class="headerlink" title="4. Sparkå†…å­˜ç®¡ç†ä¸åºåˆ—åŒ–"></a>4. Sparkå†…å­˜ç®¡ç†ä¸åºåˆ—åŒ–</h4><ul><li><p><strong>å†…å­˜ç®¡ç†æœºåˆ¶è¯¦è§£</strong></p><ul><li>å †å†…å­˜ä¸å †å¤–å†…å­˜çš„ä½¿ç”¨</li><li>å†…å­˜åˆ†é…ç­–ç•¥ä¸å›æ”¶æœºåˆ¶</li><li>å†…å­˜ä¸è¶³æ—¶çš„å¤„ç†ç­–ç•¥</li><li>å†…å­˜ç›‘æ§ä¸è°ƒä¼˜å·¥å…·</li></ul></li><li><p><strong>åºåˆ—åŒ–æŠ€æœ¯å¯¹æ¯”</strong></p><ul><li>Javaåºåˆ—åŒ–çš„ä¼˜ç¼ºç‚¹</li><li>Kryoåºåˆ—åŒ–çš„æ€§èƒ½ä¼˜åŠ¿</li><li>è‡ªå®šä¹‰åºåˆ—åŒ–å™¨çš„å¼€å‘</li><li>åºåˆ—åŒ–æ€§èƒ½æµ‹è¯•æ–¹æ³•</li></ul></li><li><p><strong>å†…å­˜ä¼˜åŒ–ç­–ç•¥</strong></p><ul><li>æ•°æ®ç»“æ„çš„å†…å­˜ä¼˜åŒ–</li><li>ç¼“å­˜ç­–ç•¥çš„é€‰æ‹©</li><li>å†…å­˜æ³„æ¼çš„é¢„é˜²ä¸æ£€æµ‹</li><li>å†…å­˜è°ƒä¼˜çš„æœ€ä½³å®è·µ</li></ul></li><li><p><strong>åºåˆ—åŒ–æ€§èƒ½è°ƒä¼˜</strong></p><ul><li>åºåˆ—åŒ–æ ¼å¼çš„é€‰æ‹©</li><li>åºåˆ—åŒ–æ€§èƒ½çš„ç›‘æ§</li><li>è‡ªå®šä¹‰åºåˆ—åŒ–å™¨çš„ä¼˜åŒ–</li><li>åºåˆ—åŒ–è°ƒä¼˜çš„å®æˆ˜æ¡ˆä¾‹</li></ul></li></ul><h3 id="ç¬¬äºŒé˜¶æ®µï¼šSparké«˜çº§ç‰¹æ€§ï¼ˆ4-5ç¯‡ï¼‰"><a href="#ç¬¬äºŒé˜¶æ®µï¼šSparké«˜çº§ç‰¹æ€§ï¼ˆ4-5ç¯‡ï¼‰" class="headerlink" title="ç¬¬äºŒé˜¶æ®µï¼šSparké«˜çº§ç‰¹æ€§ï¼ˆ4-5ç¯‡ï¼‰"></a>ç¬¬äºŒé˜¶æ®µï¼šSparké«˜çº§ç‰¹æ€§ï¼ˆ4-5ç¯‡ï¼‰</h3><h4 id="5-Spark-SQLæ ¸å¿ƒåŸç†"><a href="#5-Spark-SQLæ ¸å¿ƒåŸç†" class="headerlink" title="5. Spark SQLæ ¸å¿ƒåŸç†"></a>5. Spark SQLæ ¸å¿ƒåŸç†</h4><ul><li><p><strong>Catalystä¼˜åŒ–å™¨å·¥ä½œåŸç†</strong></p><ul><li>æŸ¥è¯¢è§£æä¸è¯­æ³•åˆ†æ</li><li>é€»è¾‘è®¡åˆ’ä¼˜åŒ–è§„åˆ™</li><li>ç‰©ç†è®¡åˆ’ç”Ÿæˆç­–ç•¥</li><li>æˆæœ¬æ¨¡å‹ä¸ä¼˜åŒ–å†³ç­–</li></ul></li><li><p><strong>DataFrame&#x2F;Dataset APIè®¾è®¡</strong></p><ul><li>ç»“æ„åŒ–æ•°æ®çš„æŠ½è±¡</li><li>ç±»å‹å®‰å…¨ä¸ç¼–è¯‘æ—¶æ£€æŸ¥</li><li>DataFrame vs RDDçš„é€‰æ‹©</li><li>APIè®¾è®¡çš„æœ€ä½³å®è·µ</li></ul></li><li><p><strong>æŸ¥è¯¢ä¼˜åŒ–ä¸æ‰§è¡Œè®¡åˆ’</strong></p><ul><li>æŸ¥è¯¢è®¡åˆ’çš„å¯è§†åŒ–åˆ†æ</li><li>ç´¢å¼•ä¸åˆ†åŒºè£å‰ªä¼˜åŒ–</li><li>è¿æ¥ç®—æ³•çš„é€‰æ‹©ç­–ç•¥</li><li>æŸ¥è¯¢æ€§èƒ½çš„ç›‘æ§ä¸è°ƒä¼˜</li></ul></li><li><p><strong>æ•°æ®æºé›†æˆæœºåˆ¶</strong></p><ul><li>æ•°æ®æºAPIçš„è®¾è®¡</li><li>è‡ªå®šä¹‰æ•°æ®æºçš„å¼€å‘</li><li>æ•°æ®æ ¼å¼çš„æ‰©å±•æ”¯æŒ</li><li>å¤šæ•°æ®æºçš„ç»Ÿä¸€è®¿é—®</li></ul></li></ul><h4 id="6-Spark-Streamingä¸Structured-Streamingå®æ—¶å¤„ç†"><a href="#6-Spark-Streamingä¸Structured-Streamingå®æ—¶å¤„ç†" class="headerlink" title="6. Spark Streamingä¸Structured Streamingå®æ—¶å¤„ç†"></a>6. Spark Streamingä¸Structured Streamingå®æ—¶å¤„ç†</h4><ul><li><p><strong>DStreamå¾®æ‰¹å¤„ç† vs Structured Streaming</strong></p><ul><li>DStream APIçš„è®¾è®¡ä¸å±€é™</li><li>Structured Streamingçš„æ ¸å¿ƒæ€æƒ³ä¸ä¼˜åŠ¿</li><li>ç»Ÿä¸€çš„æ‰¹å¤„ç†ä¸æµå¤„ç†API</li><li>ä»DStreamè¿ç§»åˆ°Structured Streaming</li></ul></li><li><p><strong>çŠ¶æ€ç®¡ç†ä¸å®¹é”™æœºåˆ¶</strong></p><ul><li>æœ‰çŠ¶æ€æµå¤„ç†çš„è®¾è®¡</li><li>çŠ¶æ€å­˜å‚¨ä¸æ¢å¤æœºåˆ¶</li><li>å®¹é”™ç­–ç•¥ä¸æ•…éšœæ¢å¤</li><li>çŠ¶æ€ç®¡ç†çš„æ€§èƒ½ä¼˜åŒ–</li></ul></li><li><p><strong>çª—å£æ“ä½œä¸æ—¶é—´è¯­ä¹‰</strong></p><ul><li>æ»‘åŠ¨çª—å£ä¸æ»šåŠ¨çª—å£</li><li>äº‹ä»¶æ—¶é—´ä¸å¤„ç†æ—¶é—´</li><li>æ°´å°æœºåˆ¶ä¸å»¶è¿Ÿæ•°æ®å¤„ç†</li><li>æ—¶é—´è¯­ä¹‰çš„æœ€ä½³å®è·µ</li></ul></li><li><p><strong>å®æ—¶å¤„ç†ä¼˜åŒ–ç­–ç•¥</strong></p><ul><li>èƒŒå‹å¤„ç†æœºåˆ¶</li><li>å®æ—¶å¤„ç†çš„æ€§èƒ½è°ƒä¼˜</li><li>èµ„æºåˆ†é…ä¸æ‰©ç¼©å®¹</li><li>å®æ—¶ç›‘æ§ä¸å‘Šè­¦ç³»ç»Ÿ</li></ul></li></ul><h4 id="7-Spark-MLlibæœºå™¨å­¦ä¹ "><a href="#7-Spark-MLlibæœºå™¨å­¦ä¹ " class="headerlink" title="7. Spark MLlibæœºå™¨å­¦ä¹ "></a>7. Spark MLlibæœºå™¨å­¦ä¹ </h4><ul><li><p><strong>åˆ†å¸ƒå¼æœºå™¨å­¦ä¹ ç®—æ³•</strong></p><ul><li>åˆ†ç±»ç®—æ³•çš„åˆ†å¸ƒå¼å®ç°</li><li>å›å½’ç®—æ³•çš„å¹¶è¡Œè®¡ç®—</li><li>èšç±»ç®—æ³•çš„ä¼˜åŒ–ç­–ç•¥</li><li>æ¨èç³»ç»Ÿçš„è®¾è®¡åŸç†</li></ul></li><li><p><strong>ç‰¹å¾å·¥ç¨‹ä¸æ•°æ®é¢„å¤„ç†</strong></p><ul><li>ç‰¹å¾æå–ä¸è½¬æ¢æŠ€æœ¯</li><li>æ•°æ®æ ‡å‡†åŒ–ä¸å½’ä¸€åŒ–</li><li>ç‰¹å¾é€‰æ‹©ä¸é™ç»´æŠ€æœ¯</li><li>åˆ†å¸ƒå¼ç‰¹å¾å·¥ç¨‹çš„æœ€ä½³å®è·µ</li></ul></li><li><p><strong>æ¨¡å‹è®­ç»ƒä¸è¯„ä¼°</strong></p><ul><li>äº¤å‰éªŒè¯çš„åˆ†å¸ƒå¼å®ç°</li><li>æ¨¡å‹è¯„ä¼°æŒ‡æ ‡çš„è®¡ç®—</li><li>è¶…å‚æ•°è°ƒä¼˜ç­–ç•¥</li><li>æ¨¡å‹éƒ¨ç½²ä¸æ›´æ–°æœºåˆ¶</li></ul></li><li><p><strong>æœºå™¨å­¦ä¹ æµæ°´çº¿</strong></p><ul><li>Pipelineçš„è®¾è®¡ä¸å®ç°</li><li>æ¨¡å‹ç‰ˆæœ¬ç®¡ç†ä¸è¿½è¸ª</li><li>è‡ªåŠ¨åŒ–æœºå™¨å­¦ä¹ æµç¨‹</li><li>ç”Ÿäº§ç¯å¢ƒçš„æ¨¡å‹ç®¡ç†</li></ul></li></ul><h4 id="8-Spark-GraphXå›¾è®¡ç®—"><a href="#8-Spark-GraphXå›¾è®¡ç®—" class="headerlink" title="8. Spark GraphXå›¾è®¡ç®—"></a>8. Spark GraphXå›¾è®¡ç®—</h4><ul><li><p><strong>å›¾æ•°æ®ç»“æ„è®¾è®¡</strong></p><ul><li>é¡¶ç‚¹ä¸è¾¹çš„æŠ½è±¡è¡¨ç¤º</li><li>å›¾çš„åˆ†åŒºç­–ç•¥</li><li>å›¾æ•°æ®çš„å­˜å‚¨ä¼˜åŒ–</li><li>å¤§è§„æ¨¡å›¾çš„å¤„ç†æŠ€æœ¯</li></ul></li><li><p><strong>å›¾ç®—æ³•å®ç°åŸç†</strong></p><ul><li>PageRankç®—æ³•çš„åˆ†å¸ƒå¼å®ç°</li><li>æœ€çŸ­è·¯å¾„ç®—æ³•çš„ä¼˜åŒ–</li><li>è¿é€šåˆ†é‡ç®—æ³•çš„è®¾è®¡</li><li>ç¤¾åŒºå‘ç°ç®—æ³•çš„å®ç°</li></ul></li><li><p><strong>å›¾è®¡ç®—ä¼˜åŒ–æŠ€æœ¯</strong></p><ul><li>å›¾åˆ†åŒºç®—æ³•çš„é€‰æ‹©</li><li>å†…å­˜ä½¿ç”¨ä¼˜åŒ–ç­–ç•¥</li><li>å›¾ç®—æ³•çš„å¹¶è¡ŒåŒ–æŠ€æœ¯</li><li>å›¾è®¡ç®—çš„æ€§èƒ½è°ƒä¼˜</li></ul></li><li><p><strong>å®é™…åº”ç”¨åœºæ™¯</strong></p><ul><li>ç¤¾äº¤ç½‘ç»œåˆ†æ</li><li>æ¨èç³»ç»Ÿçš„å›¾ç®—æ³•</li><li>çŸ¥è¯†å›¾è°±çš„æ„å»º</li><li>å›¾è®¡ç®—åœ¨ç”Ÿäº§ç¯å¢ƒçš„åº”ç”¨</li></ul></li></ul><h3 id="ç¬¬ä¸‰é˜¶æ®µï¼šSparkæ€§èƒ½ä¼˜åŒ–ï¼ˆ3-4ç¯‡ï¼‰"><a href="#ç¬¬ä¸‰é˜¶æ®µï¼šSparkæ€§èƒ½ä¼˜åŒ–ï¼ˆ3-4ç¯‡ï¼‰" class="headerlink" title="ç¬¬ä¸‰é˜¶æ®µï¼šSparkæ€§èƒ½ä¼˜åŒ–ï¼ˆ3-4ç¯‡ï¼‰"></a>ç¬¬ä¸‰é˜¶æ®µï¼šSparkæ€§èƒ½ä¼˜åŒ–ï¼ˆ3-4ç¯‡ï¼‰</h3><h4 id="9-Sparkæ€§èƒ½è°ƒä¼˜å®æˆ˜"><a href="#9-Sparkæ€§èƒ½è°ƒä¼˜å®æˆ˜" class="headerlink" title="9. Sparkæ€§èƒ½è°ƒä¼˜å®æˆ˜"></a>9. Sparkæ€§èƒ½è°ƒä¼˜å®æˆ˜</h4><ul><li><p><strong>æ€§èƒ½ç“¶é¢ˆè¯†åˆ«æ–¹æ³•</strong></p><ul><li>æ€§èƒ½ç›‘æ§å·¥å…·çš„ä½¿ç”¨</li><li>ç“¶é¢ˆåˆ†æçš„æŠ€æœ¯æ‰‹æ®µ</li><li>æ€§èƒ½é—®é¢˜çš„è¯Šæ–­æµç¨‹</li><li>æ€§èƒ½æµ‹è¯•çš„è®¾è®¡æ–¹æ³•</li></ul></li><li><p><strong>èµ„æºé…ç½®ä¼˜åŒ–</strong></p><ul><li>CPUä¸å†…å­˜çš„åˆç†é…ç½®</li><li>å¹¶è¡Œåº¦ä¸åˆ†åŒºæ•°çš„è°ƒä¼˜</li><li>ç½‘ç»œå¸¦å®½çš„ä¼˜åŒ–ç­–ç•¥</li><li>å­˜å‚¨ç³»ç»Ÿçš„æ€§èƒ½è°ƒä¼˜</li></ul></li><li><p><strong>æ•°æ®å€¾æ–œå¤„ç†ç­–ç•¥</strong></p><ul><li>æ•°æ®å€¾æ–œçš„è¯†åˆ«æ–¹æ³•</li><li>å€¾æ–œæ•°æ®çš„é¢„å¤„ç†æŠ€æœ¯</li><li>è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥çš„è®¾è®¡</li><li>å€¾æ–œå¤„ç†çš„ä¼˜åŒ–ç®—æ³•</li></ul></li><li><p><strong>ç›‘æ§ä¸è¯Šæ–­å·¥å…·</strong></p><ul><li>Spark UIçš„æ·±åº¦ä½¿ç”¨</li><li>æ€§èƒ½åˆ†æå·¥å…·çš„é€‰æ‹©</li><li>æ—¥å¿—åˆ†æä¸é—®é¢˜å®šä½</li><li>è‡ªåŠ¨åŒ–ç›‘æ§ç³»ç»Ÿçš„æ„å»º</li></ul></li></ul><h4 id="10-Sparké«˜çº§ä¼˜åŒ–æŠ€æœ¯"><a href="#10-Sparké«˜çº§ä¼˜åŒ–æŠ€æœ¯" class="headerlink" title="10. Sparké«˜çº§ä¼˜åŒ–æŠ€æœ¯"></a>10. Sparké«˜çº§ä¼˜åŒ–æŠ€æœ¯</h4><ul><li><p><strong>è‡ªé€‚åº”æŸ¥è¯¢æ‰§è¡Œï¼ˆAQEï¼‰</strong></p><ul><li>AQEçš„å·¥ä½œåŸç†</li><li>åŠ¨æ€åˆ†åŒºåˆå¹¶æŠ€æœ¯</li><li>åŠ¨æ€è¿æ¥ä¼˜åŒ–ç­–ç•¥</li><li>AQEçš„é…ç½®ä¸è°ƒä¼˜</li></ul></li><li><p><strong>åŠ¨æ€åˆ†åŒºè£å‰ªï¼ˆDPPï¼‰</strong></p><ul><li>DPPçš„å®ç°åŸç†</li><li>åˆ†åŒºè£å‰ªçš„ä¼˜åŒ–æ•ˆæœ</li><li>DPPçš„é€‚ç”¨åœºæ™¯</li><li>åŠ¨æ€åˆ†åŒºè£å‰ªçš„è°ƒä¼˜</li></ul></li><li><p><strong>è‡ªå®šä¹‰åˆ†åŒºå™¨è®¾è®¡</strong></p><ul><li>åˆ†åŒºå™¨çš„è®¾è®¡åŸåˆ™</li><li>è‡ªå®šä¹‰åˆ†åŒºå™¨çš„å®ç°</li><li>åˆ†åŒºç­–ç•¥çš„æ€§èƒ½å½±å“</li><li>åˆ†åŒºå™¨çš„æµ‹è¯•ä¸éªŒè¯</li></ul></li><li><p><strong>é«˜çº§ç¼“å­˜ç­–ç•¥</strong></p><ul><li>ç¼“å­˜çº§åˆ«çš„é€‰æ‹©</li><li>ç¼“å­˜ç­–ç•¥çš„ä¼˜åŒ–</li><li>ç¼“å­˜å¤±æ•ˆä¸æ›´æ–°æœºåˆ¶</li><li>åˆ†å¸ƒå¼ç¼“å­˜çš„è®¾è®¡</li></ul></li></ul><h4 id="11-Sparkä¼ä¸šçº§åº”ç”¨"><a href="#11-Sparkä¼ä¸šçº§åº”ç”¨" class="headerlink" title="11. Sparkä¼ä¸šçº§åº”ç”¨"></a>11. Sparkä¼ä¸šçº§åº”ç”¨</h4><ul><li><p><strong>å¤§è§„æ¨¡æ•°æ®å¤„ç†æœ€ä½³å®è·µ</strong></p><ul><li>å¤§æ•°æ®é›†çš„å¤„ç†ç­–ç•¥</li><li>å¤šé˜¶æ®µä½œä¸šçš„ä¼˜åŒ–</li><li>æ•°æ®è´¨é‡ä¿è¯æœºåˆ¶</li><li>å¤§è§„æ¨¡é›†ç¾¤çš„ç®¡ç†</li></ul></li><li><p><strong>ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ä¸è¿ç»´</strong></p><ul><li>é›†ç¾¤éƒ¨ç½²çš„æœ€ä½³å®è·µ</li><li>é«˜å¯ç”¨æ€§è®¾è®¡</li><li>ç›‘æ§ä¸å‘Šè­¦ç³»ç»Ÿ</li><li>è¿ç»´è‡ªåŠ¨åŒ–å·¥å…·</li></ul></li><li><p><strong>å®‰å…¨ä¸æƒé™ç®¡ç†</strong></p><ul><li>èº«ä»½è®¤è¯ä¸æˆæƒæœºåˆ¶</li><li>æ•°æ®åŠ å¯†ä¸ä¼ è¾“å®‰å…¨</li><li>å®¡è®¡æ—¥å¿—ä¸åˆè§„è¦æ±‚</li><li>å®‰å…¨æœ€ä½³å®è·µ</li></ul></li><li><p><strong>è¿œç¨‹è¿æ¥ä¸Spark Connect</strong></p><ul><li>è§£è€¦çš„å®¢æˆ·ç«¯-æœåŠ¡å™¨æ¶æ„</li><li>å¤šè¯­è¨€ä¸å¤šç‰ˆæœ¬å®¢æˆ·ç«¯æ”¯æŒ</li><li>Spark Connectåº”ç”¨åœºæ™¯</li><li>ä¸ä¼ ç»Ÿæäº¤æ–¹å¼çš„å¯¹æ¯”</li></ul></li><li><p><strong>æ•…éšœæ’æŸ¥ä¸æ¢å¤</strong></p><ul><li>å¸¸è§æ•…éšœçš„è¯Šæ–­æ–¹æ³•</li><li>æ•…éšœæ¢å¤çš„æµç¨‹è®¾è®¡</li><li>ç¾éš¾æ¢å¤ç­–ç•¥</li><li>æ•…éšœé¢„é˜²ä¸ç›‘æ§</li></ul></li></ul><h3 id="ç¬¬å››é˜¶æ®µï¼šSparkç”Ÿæ€é›†æˆï¼ˆ2-3ç¯‡ï¼‰"><a href="#ç¬¬å››é˜¶æ®µï¼šSparkç”Ÿæ€é›†æˆï¼ˆ2-3ç¯‡ï¼‰" class="headerlink" title="ç¬¬å››é˜¶æ®µï¼šSparkç”Ÿæ€é›†æˆï¼ˆ2-3ç¯‡ï¼‰"></a>ç¬¬å››é˜¶æ®µï¼šSparkç”Ÿæ€é›†æˆï¼ˆ2-3ç¯‡ï¼‰</h3><h4 id="12-Sparkä¸å¤§æ•°æ®ç”Ÿæ€"><a href="#12-Sparkä¸å¤§æ•°æ®ç”Ÿæ€" class="headerlink" title="12. Sparkä¸å¤§æ•°æ®ç”Ÿæ€"></a>12. Sparkä¸å¤§æ•°æ®ç”Ÿæ€</h4><ul><li><p><strong>Sparkä¸Hadoopé›†æˆ</strong></p><ul><li>HDFSæ•°æ®è®¿é—®ä¼˜åŒ–</li><li>YARNèµ„æºè°ƒåº¦é›†æˆ</li><li>HBaseçš„Sparké›†æˆ</li><li>Hadoopç”Ÿæ€çš„æ·±åº¦æ•´åˆ</li></ul></li><li><p><strong>Sparkä¸Kafkaå®æ—¶é›†æˆ</strong></p><ul><li>Kafkaè¿æ¥å™¨çš„ä½¿ç”¨</li><li>å®æ—¶æ•°æ®æµçš„å¤„ç†</li><li>æµå¼ETLçš„å®ç°</li><li>å®æ—¶åˆ†æç³»ç»Ÿçš„æ„å»º</li></ul></li><li><p><strong>Sparkä¸Hiveæ•°æ®ä»“åº“</strong></p><ul><li>Hive Metastoreçš„é›†æˆ</li><li>æ•°æ®ä»“åº“çš„æŸ¥è¯¢ä¼˜åŒ–</li><li>æ•°æ®æ¹–æ¶æ„çš„è®¾è®¡</li><li>ç»Ÿä¸€æ•°æ®å¹³å°çš„æ„å»º</li></ul></li><li><p><strong>é›†æˆData Lakehouse (Delta&#x2F;Hudi&#x2F;Iceberg)</strong></p><ul><li>äº‹åŠ¡æ€§æ•°æ®æ¹–çš„æ¦‚å¿µ</li><li>ACIDç‰¹æ€§ä¸Schemaæ¼”è¿›</li><li>Time Travelï¼ˆæ—¶é—´æ—…è¡Œï¼‰æŸ¥è¯¢</li><li>ä¸åŒæ ¼å¼çš„é€‰å‹ä¸å®è·µ</li></ul></li><li><p><strong>å¤šæ•°æ®æºç»Ÿä¸€å¤„ç†</strong></p><ul><li>æ•°æ®æºè¿æ¥æ± ç®¡ç†</li><li>å¤šæ•°æ®æºçš„ç»Ÿä¸€è®¿é—®</li><li>æ•°æ®æ ¼å¼è½¬æ¢ä¸é€‚é…</li><li>å¼‚æ„æ•°æ®æºçš„æ•´åˆ</li></ul></li></ul><h4 id="13-Sparkäº‘åŸç”Ÿä¸å®¹å™¨åŒ–"><a href="#13-Sparkäº‘åŸç”Ÿä¸å®¹å™¨åŒ–" class="headerlink" title="13. Sparkäº‘åŸç”Ÿä¸å®¹å™¨åŒ–"></a>13. Sparkäº‘åŸç”Ÿä¸å®¹å™¨åŒ–</h4><ul><li><p><strong>Spark on Kubernetes</strong></p><ul><li>Kuberneteséƒ¨ç½²æ¶æ„</li><li>å®¹å™¨åŒ–Sparkçš„ä¼˜åŠ¿</li><li>èµ„æºç®¡ç†ä¸è°ƒåº¦</li><li>äº‘åŸç”ŸSparkçš„æœ€ä½³å®è·µ</li></ul></li><li><p><strong>äº‘åŸç”Ÿéƒ¨ç½²ç­–ç•¥</strong></p><ul><li>å¾®æœåŠ¡æ¶æ„è®¾è®¡</li><li>æœåŠ¡ç½‘æ ¼çš„é›†æˆ</li><li>äº‘åŸç”Ÿç›‘æ§æ–¹æ¡ˆ</li><li>å¼¹æ€§ä¼¸ç¼©ç­–ç•¥</li></ul></li><li><p><strong>å¼¹æ€§ä¼¸ç¼©ä¸èµ„æºç®¡ç†</strong></p><ul><li>è‡ªåŠ¨æ‰©ç¼©å®¹æœºåˆ¶</li><li>èµ„æºé¢„æµ‹ä¸è§„åˆ’</li><li>æˆæœ¬ä¼˜åŒ–ç­–ç•¥</li><li>å¤šç§Ÿæˆ·èµ„æºéš”ç¦»</li></ul></li><li><p><strong>å¤šäº‘ç¯å¢ƒé€‚é…</strong></p><ul><li>è·¨äº‘éƒ¨ç½²ç­–ç•¥</li><li>æ•°æ®è¿ç§»ä¸åŒæ­¥</li><li>äº‘æœåŠ¡å•†çš„å·®å¼‚å¤„ç†</li><li>å¤šäº‘ç®¡ç†çš„ç»Ÿä¸€å¹³å°</li></ul></li></ul><h2 id="å­¦ä¹ å»ºè®®"><a href="#å­¦ä¹ å»ºè®®" class="headerlink" title="å­¦ä¹ å»ºè®®"></a>å­¦ä¹ å»ºè®®</h2><h3 id="å­¦ä¹ é¡ºåº"><a href="#å­¦ä¹ é¡ºåº" class="headerlink" title="å­¦ä¹ é¡ºåº"></a>å­¦ä¹ é¡ºåº</h3><ol><li><strong>å¾ªåºæ¸è¿›</strong>ï¼šæŒ‰ç…§å››ä¸ªé˜¶æ®µçš„å­¦ä¹ è·¯å¾„ï¼Œä»åŸºç¡€åˆ°é«˜çº§</li><li><strong>ç†è®ºç»“åˆå®è·µ</strong>ï¼šæ¯ä¸ªç« èŠ‚éƒ½è¦é…åˆå®é™…ä»£ç å’Œæ¡ˆä¾‹</li><li><strong>åŠ¨æ‰‹å®éªŒ</strong>ï¼šæ­å»ºæœ¬åœ°Sparkç¯å¢ƒï¼Œè¿›è¡Œå®é™…æ“ä½œ</li><li><strong>é¡¹ç›®é©±åŠ¨</strong>ï¼šé€šè¿‡å®é™…é¡¹ç›®æ¥å·©å›ºæ‰€å­¦çŸ¥è¯†</li></ol><h3 id="å®è·µè¦æ±‚"><a href="#å®è·µè¦æ±‚" class="headerlink" title="å®è·µè¦æ±‚"></a>å®è·µè¦æ±‚</h3><ul><li>æ­å»ºSparkå¼€å‘ç¯å¢ƒ</li><li>å®Œæˆæ¯ä¸ªç« èŠ‚çš„ä»£ç ç¤ºä¾‹</li><li>å‚ä¸å¼€æºé¡¹ç›®æˆ–å®é™…é¡¹ç›®</li><li>è®°å½•å­¦ä¹ ç¬”è®°å’Œå¿ƒå¾—ä½“ä¼š</li></ul><h3 id="è¿›é˜¶æ–¹å‘"><a href="#è¿›é˜¶æ–¹å‘" class="headerlink" title="è¿›é˜¶æ–¹å‘"></a>è¿›é˜¶æ–¹å‘</h3><ul><li>æ·±å…¥ç ”ç©¶Sparkæºç </li><li>å‚ä¸Sparkç¤¾åŒºè´¡çŒ®</li><li>æ¢ç´¢Sparkä¸å…¶ä»–æŠ€æœ¯çš„ç»“åˆ</li><li>å…³æ³¨Sparkçš„æœ€æ–°å‘å±•åŠ¨æ€</li></ul><h2 id="ä¸“æ ç‰¹è‰²"><a href="#ä¸“æ ç‰¹è‰²" class="headerlink" title="ä¸“æ ç‰¹è‰²"></a>ä¸“æ ç‰¹è‰²</h2><ol><li><strong>ç³»ç»Ÿæ€§</strong>ï¼šä»åŸºç¡€åˆ°é«˜çº§ï¼Œå…¨é¢è¦†ç›–SparkæŠ€æœ¯æ ˆ</li><li><strong>å®ç”¨æ€§</strong>ï¼šæ³¨é‡å®æˆ˜åº”ç”¨ï¼Œæä¾›å¤§é‡ä»£ç ç¤ºä¾‹</li><li><strong>æ·±åº¦æ€§</strong>ï¼šæ·±å…¥è§£æåŸç†ï¼Œä¸ä»…çŸ¥å…¶ç„¶æ›´çŸ¥å…¶æ‰€ä»¥ç„¶</li><li><strong>å‰æ²¿æ€§</strong>ï¼šå…³æ³¨æœ€æ–°æŠ€æœ¯å‘å±•ï¼Œä¿æŒå†…å®¹æ›´æ–°</li></ol><h2 id="é¢„æœŸæ”¶è·"><a href="#é¢„æœŸæ”¶è·" class="headerlink" title="é¢„æœŸæ”¶è·"></a>é¢„æœŸæ”¶è·</h2><p>é€šè¿‡æœ¬ä¸“æ çš„å­¦ä¹ ï¼Œè¯»è€…å°†èƒ½å¤Ÿï¼š</p><ul><li>æ·±å…¥ç†è§£Sparkçš„æ ¸å¿ƒåŸç†å’Œæ¶æ„è®¾è®¡</li><li>æŒæ¡Sparkæ€§èƒ½ä¼˜åŒ–çš„å®æˆ˜æŠ€å·§</li><li>ç†Ÿç»ƒè¿ç”¨Sparkè§£å†³å®é™…ä¸šåŠ¡é—®é¢˜</li><li>å…·å¤‡æ„å»ºå¤§è§„æ¨¡æ•°æ®å¤„ç†ç³»ç»Ÿçš„èƒ½åŠ›</li><li>åœ¨SparkæŠ€æœ¯é¢†åŸŸè¾¾åˆ°é«˜çº§å·¥ç¨‹å¸ˆæ°´å¹³</li></ul><hr><p><em>æœ¬ä¸“æ å°†æŒç»­æ›´æ–°ï¼Œè·ŸéšSparkæŠ€æœ¯å‘å±•ï¼Œä¸ºè¯»è€…æä¾›æœ€æ–°ã€æœ€å…¨é¢çš„Sparkå­¦ä¹ èµ„æºã€‚</em> </p>]]></content>
      
      
      <categories>
          
          <category> å¤§æ•°æ® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spark </tag>
            
            <tag> å¤§æ•°æ® </tag>
            
            <tag> åˆ†å¸ƒå¼è®¡ç®— </tag>
            
            <tag> æŠ€æœ¯ä¸“æ  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mavenä»“åº“å·¥ä½œæœºåˆ¶è¯¦è§£</title>
      <link href="/2025/07/03/Maven%E4%BB%93%E5%BA%93%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3/"/>
      <url>/2025/07/03/Maven%E4%BB%93%E5%BA%93%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<h1 id="Mavenä»“åº“å·¥ä½œæœºåˆ¶è¯¦è§£"><a href="#Mavenä»“åº“å·¥ä½œæœºåˆ¶è¯¦è§£" class="headerlink" title="Mavenä»“åº“å·¥ä½œæœºåˆ¶è¯¦è§£"></a>Mavenä»“åº“å·¥ä½œæœºåˆ¶è¯¦è§£</h1><h2 id="ğŸ“‹-ç›®å½•"><a href="#ğŸ“‹-ç›®å½•" class="headerlink" title="ğŸ“‹ ç›®å½•"></a>ğŸ“‹ ç›®å½•</h2><ul><li><a href="#%E6%A6%82%E8%BF%B0">æ¦‚è¿°</a></li><li><a href="#maven%E4%BB%93%E5%BA%93%E7%B1%BB%E5%9E%8B">Mavenä»“åº“ç±»å‹</a></li><li><a href="#%E4%BE%9D%E8%B5%96%E6%9F%A5%E6%89%BE%E6%9C%BA%E5%88%B6">ä¾èµ–æŸ¥æ‰¾æœºåˆ¶</a></li><li><a href="#%E4%BB%93%E5%BA%93%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F">ä»“åº“é…ç½®æ–¹å¼</a></li><li><a href="#%E9%85%8D%E7%BD%AE%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%94">é…ç½®æ–¹æ¡ˆå¯¹æ¯”</a></li><li><a href="#%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF">å®é™…åº”ç”¨åœºæ™¯</a></li><li><a href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">æœ€ä½³å®è·µ</a></li><li><a href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E7%AD%94">å¸¸è§é—®é¢˜è§£ç­”</a></li><li><a href="#%E6%B7%B1%E5%85%A5%E5%8E%9F%E7%90%86%E4%BE%9D%E8%B5%96%E8%A7%A3%E6%9E%90%E7%AE%97%E6%B3%95">æ·±å…¥åŸç†ï¼šä¾èµ–è§£æç®—æ³•</a></li><li><a href="#%E6%B7%B1%E5%85%A5%E5%8E%9F%E7%90%86%E7%89%88%E6%9C%AC%E5%86%B2%E7%AA%81%E8%A7%A3%E5%86%B3%E6%9C%BA%E5%88%B6">æ·±å…¥åŸç†ï¼šç‰ˆæœ¬å†²çªè§£å†³æœºåˆ¶</a></li><li><a href="#%E6%B7%B1%E5%85%A5%E5%8E%9F%E7%90%86%E4%BB%93%E5%BA%93%E5%85%83%E6%95%B0%E6%8D%AE%E6%9C%BA%E5%88%B6">æ·±å…¥åŸç†ï¼šä»“åº“å…ƒæ•°æ®æœºåˆ¶</a></li><li><a href="#%E6%B7%B1%E5%85%A5%E5%8E%9F%E7%90%86%E4%BE%9D%E8%B5%96%E4%BC%A0%E9%80%92%E6%80%A7%E5%8E%9F%E7%90%86">æ·±å…¥åŸç†ï¼šä¾èµ–ä¼ é€’æ€§åŸç†</a></li><li><a href="#%E6%B7%B1%E5%85%A5%E5%8E%9F%E7%90%86maven%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E4%B8%8E%E4%BB%93%E5%BA%93%E4%BA%A4%E4%BA%92">æ·±å…¥åŸç†ï¼šMavenç”Ÿå‘½å‘¨æœŸä¸ä»“åº“äº¤äº’</a></li><li><a href="#%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7%E4%BB%93%E5%BA%93%E9%95%9C%E5%83%8F%E4%B8%8E%E4%BB%A3%E7%90%86">é«˜çº§ç‰¹æ€§ï¼šä»“åº“é•œåƒä¸ä»£ç†</a></li><li><a href="#%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7snapshot%E7%89%88%E6%9C%AC%E6%9C%BA%E5%88%B6">é«˜çº§ç‰¹æ€§ï¼šSNAPSHOTç‰ˆæœ¬æœºåˆ¶</a></li><li><a href="#%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7%E4%BE%9D%E8%B5%96%E6%8E%92%E9%99%A4%E4%B8%8E%E5%8F%AF%E9%80%89%E4%BE%9D%E8%B5%96">é«˜çº§ç‰¹æ€§ï¼šä¾èµ–æ’é™¤ä¸å¯é€‰ä¾èµ–</a></li><li><a href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E4%B8%8E%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5">æ€§èƒ½ä¼˜åŒ–ä¸æ•…éšœæ’æŸ¥</a></li></ul><hr><h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>Mavenä½œä¸ºJavaç”Ÿæ€ç³»ç»Ÿä¸­æœ€é‡è¦çš„æ„å»ºå·¥å…·ä¹‹ä¸€ï¼Œå…¶ä¾èµ–ç®¡ç†å’Œä»“åº“æœºåˆ¶æ˜¯å…¶æ ¸å¿ƒåŠŸèƒ½ã€‚ç†è§£Mavenä»“åº“çš„å·¥ä½œæœºåˆ¶å¯¹äºé¡¹ç›®æ„å»ºã€ä¾èµ–ç®¡ç†ä»¥åŠCI&#x2F;CDæµç¨‹çš„ä¼˜åŒ–è‡³å…³é‡è¦ã€‚</p><h3 id="ğŸ¯-æ ¸å¿ƒæ¦‚å¿µ"><a href="#ğŸ¯-æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ"></a>ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ</h3><ul><li><strong>Mavenä»“åº“</strong>ï¼šå­˜å‚¨é¡¹ç›®ä¾èµ–ã€æ’ä»¶å’Œæ„ä»¶çš„å­˜å‚¨åº“</li><li><strong>åæ ‡ç³»ç»Ÿ</strong>ï¼šé€šè¿‡ <code>groupId:artifactId:version</code> å”¯ä¸€æ ‡è¯†æ„ä»¶</li><li><strong>ä¾èµ–ä¼ é€’</strong>ï¼šè‡ªåŠ¨è§£æå’Œä¸‹è½½ä¼ é€’æ€§ä¾èµ–</li><li><strong>ä»“åº“ä¼˜å…ˆçº§</strong>ï¼šå¤šä¸ªä»“åº“çš„æŸ¥æ‰¾é¡ºåºå’Œä¼˜å…ˆçº§æœºåˆ¶</li></ul><hr><h2 id="Mavenä»“åº“ç±»å‹"><a href="#Mavenä»“åº“ç±»å‹" class="headerlink" title="Mavenä»“åº“ç±»å‹"></a>Mavenä»“åº“ç±»å‹</h2><h3 id="1-æœ¬åœ°ä»“åº“-Local-Repository"><a href="#1-æœ¬åœ°ä»“åº“-Local-Repository" class="headerlink" title="1. æœ¬åœ°ä»“åº“ (Local Repository)"></a>1. æœ¬åœ°ä»“åº“ (Local Repository)</h3><p><strong>ä½ç½®</strong>ï¼šé»˜è®¤åœ¨ç”¨æˆ·ä¸»ç›®å½•ä¸‹çš„ <code>.m2/repository</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é»˜è®¤è·¯å¾„</span></span><br><span class="line">~/.m2/repository/</span><br><span class="line"></span><br><span class="line"><span class="comment"># è‡ªå®šä¹‰è·¯å¾„ï¼ˆé€šè¿‡settings.xmlé…ç½®ï¼‰</span></span><br><span class="line">&lt;localRepository&gt;/path/to/custom/repository&lt;/localRepository&gt;</span><br></pre></td></tr></table></figure><p><strong>ç‰¹ç‚¹</strong>ï¼š</p><ul><li>âœ… ç¼“å­˜æ‰€æœ‰ä¸‹è½½çš„ä¾èµ–å’Œæ’ä»¶</li><li>âœ… æ„å»ºé€Ÿåº¦æœ€å¿«çš„ä¾èµ–æ¥æº</li><li>âœ… ç¦»çº¿æ„å»ºçš„åŸºç¡€</li><li>âš ï¸ é¦–æ¬¡æ„å»ºæ—¶ä¸ºç©ºï¼Œéœ€è¦ä»è¿œç¨‹ä»“åº“ä¸‹è½½</li></ul><h3 id="2-ä¸­å¤®ä»“åº“-Central-Repository"><a href="#2-ä¸­å¤®ä»“åº“-Central-Repository" class="headerlink" title="2. ä¸­å¤®ä»“åº“ (Central Repository)"></a>2. ä¸­å¤®ä»“åº“ (Central Repository)</h3><p><strong>ä½ç½®</strong>ï¼š<code>https://repo1.maven.org/maven2</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Mavenå†…ç½®çš„é»˜è®¤ä»“åº“ï¼Œæ— éœ€é…ç½® --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">id</span>&gt;</span>central<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>Central Repository<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo1.maven.org/maven2<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>ç‰¹ç‚¹</strong>ï¼š</p><ul><li>âœ… Mavenå®˜æ–¹ç»´æŠ¤çš„å…¬å…±ä»“åº“</li><li>âœ… åŒ…å«ç»å¤§å¤šæ•°å¼€æºJavaåº“</li><li>âœ… é«˜å¯ç”¨æ€§å’Œç¨³å®šæ€§</li><li>âš ï¸ ç½‘ç»œè®¿é—®é€Ÿåº¦å¯èƒ½è¾ƒæ…¢ï¼ˆå›½å†…ï¼‰</li></ul><h3 id="3-è¿œç¨‹ä»“åº“-Remote-Repository"><a href="#3-è¿œç¨‹ä»“åº“-Remote-Repository" class="headerlink" title="3. è¿œç¨‹ä»“åº“ (Remote Repository)"></a>3. è¿œç¨‹ä»“åº“ (Remote Repository)</h3><p><strong>ç±»å‹</strong>ï¼š</p><ul><li><strong>ç§æœ‰ä»“åº“</strong>ï¼šä¼ä¸šå†…éƒ¨æ­å»ºçš„Nexusã€Artifactoryç­‰</li><li><strong>ç¬¬ä¸‰æ–¹ä»“åº“</strong>ï¼šå¦‚Springã€JBossç­‰ç»„ç»‡çš„ä¸“ç”¨ä»“åº“</li><li><strong>é•œåƒä»“åº“</strong>ï¼šä¸­å¤®ä»“åº“çš„é•œåƒï¼Œå¦‚é˜¿é‡Œäº‘é•œåƒ</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ç§æœ‰ä»“åº“ç¤ºä¾‹ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">id</span>&gt;</span>company-nexus<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>Company Internal Repository<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://192.168.*.*:8081/nexus/content/groups/public<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">releases</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">updatePolicy</span>&gt;</span>daily<span class="tag">&lt;/<span class="name">updatePolicy</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">updatePolicy</span>&gt;</span>always<span class="tag">&lt;/<span class="name">updatePolicy</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br></pre></td></tr></table></figure><hr><h2 id="ä¾èµ–æŸ¥æ‰¾æœºåˆ¶"><a href="#ä¾èµ–æŸ¥æ‰¾æœºåˆ¶" class="headerlink" title="ä¾èµ–æŸ¥æ‰¾æœºåˆ¶"></a>ä¾èµ–æŸ¥æ‰¾æœºåˆ¶</h2><h3 id="ğŸ”-æŸ¥æ‰¾é¡ºåº"><a href="#ğŸ”-æŸ¥æ‰¾é¡ºåº" class="headerlink" title="ğŸ” æŸ¥æ‰¾é¡ºåº"></a>ğŸ” æŸ¥æ‰¾é¡ºåº</h3><p>MavenæŸ¥æ‰¾ä¾èµ–æ—¶éµå¾ªä¸¥æ ¼çš„ä¼˜å…ˆçº§é¡ºåºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1. æœ¬åœ°ä»“åº“ (~/.m2/repository)</span><br><span class="line">   â†“ (å¦‚æœæœªæ‰¾åˆ°)</span><br><span class="line">2. pom.xmlä¸­é…ç½®çš„ä»“åº“</span><br><span class="line">   â†“ (å¦‚æœæœªæ‰¾åˆ°)  </span><br><span class="line">3. settings.xmlä¸­é…ç½®çš„ä»“åº“</span><br><span class="line">   â†“ (å¦‚æœæœªæ‰¾åˆ°)</span><br><span class="line">4. Mavenä¸­å¤®ä»“åº“</span><br><span class="line">   â†“ (å¦‚æœæœªæ‰¾åˆ°)</span><br><span class="line">5. æ„å»ºå¤±è´¥</span><br></pre></td></tr></table></figure><h3 id="ğŸ“-è¯¦ç»†æŸ¥æ‰¾æµç¨‹"><a href="#ğŸ“-è¯¦ç»†æŸ¥æ‰¾æµç¨‹" class="headerlink" title="ğŸ“ è¯¦ç»†æŸ¥æ‰¾æµç¨‹"></a>ğŸ“ è¯¦ç»†æŸ¥æ‰¾æµç¨‹</h3><h4 id="æ­¥éª¤1ï¼šæœ¬åœ°ä»“åº“æ£€æŸ¥"><a href="#æ­¥éª¤1ï¼šæœ¬åœ°ä»“åº“æ£€æŸ¥" class="headerlink" title="æ­¥éª¤1ï¼šæœ¬åœ°ä»“åº“æ£€æŸ¥"></a>æ­¥éª¤1ï¼šæœ¬åœ°ä»“åº“æ£€æŸ¥</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ£€æŸ¥è·¯å¾„ï¼š~/.m2/repository/com/example/my-lib/1.0.0/</span></span><br><span class="line"><span class="built_in">ls</span> ~/.m2/repository/com/example/my-lib/1.0.0/my-lib-1.0.0.jar</span><br></pre></td></tr></table></figure><h4 id="æ­¥éª¤2ï¼špom-xmlä»“åº“æŸ¥æ‰¾"><a href="#æ­¥éª¤2ï¼špom-xmlä»“åº“æŸ¥æ‰¾" class="headerlink" title="æ­¥éª¤2ï¼špom.xmlä»“åº“æŸ¥æ‰¾"></a>æ­¥éª¤2ï¼špom.xmlä»“åº“æŸ¥æ‰¾</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Mavenä¼šæŒ‰é¡ºåºè®¿é—®pom.xmlä¸­é…ç½®çš„ä»“åº“ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>repo1<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://repo1.example.com<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>repo2<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://repo2.example.com<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="æ­¥éª¤3ï¼šsettings-xmlä»“åº“æŸ¥æ‰¾"><a href="#æ­¥éª¤3ï¼šsettings-xmlä»“åº“æŸ¥æ‰¾" class="headerlink" title="æ­¥éª¤3ï¼šsettings.xmlä»“åº“æŸ¥æ‰¾"></a>æ­¥éª¤3ï¼šsettings.xmlä»“åº“æŸ¥æ‰¾</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- å…¨å±€æˆ–ç”¨æˆ·çº§åˆ«çš„ä»“åº“é…ç½® --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">profiles</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">id</span>&gt;</span>global-repo<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://global.example.com<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="æ­¥éª¤4ï¼šä¸­å¤®ä»“åº“æŸ¥æ‰¾"><a href="#æ­¥éª¤4ï¼šä¸­å¤®ä»“åº“æŸ¥æ‰¾" class="headerlink" title="æ­¥éª¤4ï¼šä¸­å¤®ä»“åº“æŸ¥æ‰¾"></a>æ­¥éª¤4ï¼šä¸­å¤®ä»“åº“æŸ¥æ‰¾</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æœ€åå°è¯•ä»Mavenä¸­å¤®ä»“åº“ä¸‹è½½</span></span><br><span class="line"><span class="comment"># URL: https://repo1.maven.org/maven2/com/example/my-lib/1.0.0/</span></span><br></pre></td></tr></table></figure><h3 id="âš¡-ç¼“å­˜æœºåˆ¶"><a href="#âš¡-ç¼“å­˜æœºåˆ¶" class="headerlink" title="âš¡ ç¼“å­˜æœºåˆ¶"></a>âš¡ ç¼“å­˜æœºåˆ¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¾èµ–ä¸‹è½½åçš„æœ¬åœ°å­˜å‚¨ç»“æ„</span></span><br><span class="line">~/.m2/repository/</span><br><span class="line">â”œâ”€â”€ com/</span><br><span class="line">â”‚   â””â”€â”€ example/</span><br><span class="line">â”‚       â””â”€â”€ my-lib/</span><br><span class="line">â”‚           â”œâ”€â”€ 1.0.0/</span><br><span class="line">â”‚           â”‚   â”œâ”€â”€ my-lib-1.0.0.jar</span><br><span class="line">â”‚           â”‚   â”œâ”€â”€ my-lib-1.0.0.pom</span><br><span class="line">â”‚           â”‚   â””â”€â”€ my-lib-1.0.0.jar.sha1</span><br><span class="line">â”‚           â””â”€â”€ maven-metadata-central.xml</span><br></pre></td></tr></table></figure><hr><h2 id="ä»“åº“é…ç½®æ–¹å¼"><a href="#ä»“åº“é…ç½®æ–¹å¼" class="headerlink" title="ä»“åº“é…ç½®æ–¹å¼"></a>ä»“åº“é…ç½®æ–¹å¼</h2><h3 id="æ–¹å¼1ï¼špom-xmlé…ç½®ï¼ˆé¡¹ç›®çº§åˆ«ï¼‰"><a href="#æ–¹å¼1ï¼špom-xmlé…ç½®ï¼ˆé¡¹ç›®çº§åˆ«ï¼‰" class="headerlink" title="æ–¹å¼1ï¼špom.xmlé…ç½®ï¼ˆé¡¹ç›®çº§åˆ«ï¼‰"></a>æ–¹å¼1ï¼špom.xmlé…ç½®ï¼ˆé¡¹ç›®çº§åˆ«ï¼‰</h3><h4 id="åŸºæœ¬é…ç½®"><a href="#åŸºæœ¬é…ç½®" class="headerlink" title="åŸºæœ¬é…ç½®"></a>åŸºæœ¬é…ç½®</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- ... å…¶ä»–é…ç½® ... --&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>company-nexus<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>Company Internal Nexus<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://192.168.10.49:8081/nexus/content/groups/public<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">releases</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">updatePolicy</span>&gt;</span>daily<span class="tag">&lt;/<span class="name">updatePolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">checksumPolicy</span>&gt;</span>warn<span class="tag">&lt;/<span class="name">checksumPolicy</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">updatePolicy</span>&gt;</span>always<span class="tag">&lt;/<span class="name">updatePolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">checksumPolicy</span>&gt;</span>fail<span class="tag">&lt;/<span class="name">checksumPolicy</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">&lt;!-- æ’ä»¶ä»“åº“é…ç½® --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>company-nexus<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://192.168.10.49:8081/nexus/content/groups/public<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="é…ç½®é€‰é¡¹è¯´æ˜"><a href="#é…ç½®é€‰é¡¹è¯´æ˜" class="headerlink" title="é…ç½®é€‰é¡¹è¯´æ˜"></a>é…ç½®é€‰é¡¹è¯´æ˜</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- æ›´æ–°ç­–ç•¥ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">updatePolicy</span>&gt;</span>always<span class="tag">&lt;/<span class="name">updatePolicy</span>&gt;</span>     <span class="comment">&lt;!-- æ€»æ˜¯æ£€æŸ¥æ›´æ–° --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">updatePolicy</span>&gt;</span>daily<span class="tag">&lt;/<span class="name">updatePolicy</span>&gt;</span>      <span class="comment">&lt;!-- æ¯æ—¥æ£€æŸ¥ä¸€æ¬¡ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">updatePolicy</span>&gt;</span>interval:60<span class="tag">&lt;/<span class="name">updatePolicy</span>&gt;</span>  <span class="comment">&lt;!-- æ¯60åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">updatePolicy</span>&gt;</span>never<span class="tag">&lt;/<span class="name">updatePolicy</span>&gt;</span>      <span class="comment">&lt;!-- ä»ä¸æ£€æŸ¥æ›´æ–° --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- æ ¡éªŒç­–ç•¥ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">checksumPolicy</span>&gt;</span>fail<span class="tag">&lt;/<span class="name">checksumPolicy</span>&gt;</span>   <span class="comment">&lt;!-- æ ¡éªŒå¤±è´¥æ—¶æ„å»ºå¤±è´¥ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">checksumPolicy</span>&gt;</span>warn<span class="tag">&lt;/<span class="name">checksumPolicy</span>&gt;</span>   <span class="comment">&lt;!-- æ ¡éªŒå¤±è´¥æ—¶æ˜¾ç¤ºè­¦å‘Š --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">checksumPolicy</span>&gt;</span>ignore<span class="tag">&lt;/<span class="name">checksumPolicy</span>&gt;</span> <span class="comment">&lt;!-- å¿½ç•¥æ ¡éªŒ --&gt;</span></span><br></pre></td></tr></table></figure><h3 id="æ–¹å¼2ï¼šsettings-xmlé…ç½®ï¼ˆå…¨å±€çº§åˆ«ï¼‰"><a href="#æ–¹å¼2ï¼šsettings-xmlé…ç½®ï¼ˆå…¨å±€çº§åˆ«ï¼‰" class="headerlink" title="æ–¹å¼2ï¼šsettings.xmlé…ç½®ï¼ˆå…¨å±€çº§åˆ«ï¼‰"></a>æ–¹å¼2ï¼šsettings.xmlé…ç½®ï¼ˆå…¨å±€çº§åˆ«ï¼‰</h3><h4 id="ç”¨æˆ·çº§åˆ«é…ç½®-m2-settings-xml"><a href="#ç”¨æˆ·çº§åˆ«é…ç½®-m2-settings-xml" class="headerlink" title="ç”¨æˆ·çº§åˆ«é…ç½® (~&#x2F;.m2&#x2F;settings.xml)"></a>ç”¨æˆ·çº§åˆ«é…ç½® (~&#x2F;.m2&#x2F;settings.xml)</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- æœ¬åœ°ä»“åº“è·¯å¾„ --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">localRepository</span>&gt;</span>/path/to/custom/repository<span class="tag">&lt;/<span class="name">localRepository</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">&lt;!-- ç¦»çº¿æ¨¡å¼ --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">offline</span>&gt;</span>false<span class="tag">&lt;/<span class="name">offline</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">&lt;!-- é•œåƒé…ç½® --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mirrors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>aliyun-maven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>Aliyun Maven Mirror<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://maven.aliyun.com/repository/central<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mirrors</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">&lt;!-- Profileé…ç½® --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">profiles</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>company-settings<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">id</span>&gt;</span>company-nexus<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://192.168.10.49:8081/nexus/content/groups/public<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">releases</span>&gt;</span><span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span><span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span><span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span><span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">&lt;!-- æ¿€æ´»Profile --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">activeProfiles</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activeProfile</span>&gt;</span>company-settings<span class="tag">&lt;/<span class="name">activeProfile</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">activeProfiles</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="ç³»ç»Ÿçº§åˆ«é…ç½®-MAVEN-HOME-conf-settings-xml"><a href="#ç³»ç»Ÿçº§åˆ«é…ç½®-MAVEN-HOME-conf-settings-xml" class="headerlink" title="ç³»ç»Ÿçº§åˆ«é…ç½® (${MAVEN_HOME}&#x2F;conf&#x2F;settings.xml)"></a>ç³»ç»Ÿçº§åˆ«é…ç½® (${MAVEN_HOME}&#x2F;conf&#x2F;settings.xml)</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- å½±å“æ‰€æœ‰ç”¨æˆ·çš„å…¨å±€é…ç½® --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mirrors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>company-mirror<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>*<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://internal-maven-mirror.company.com<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mirrors</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="æ–¹å¼3ï¼šå‘½ä»¤è¡Œå‚æ•°"><a href="#æ–¹å¼3ï¼šå‘½ä»¤è¡Œå‚æ•°" class="headerlink" title="æ–¹å¼3ï¼šå‘½ä»¤è¡Œå‚æ•°"></a>æ–¹å¼3ï¼šå‘½ä»¤è¡Œå‚æ•°</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŒ‡å®šè‡ªå®šä¹‰settings.xml</span></span><br><span class="line">mvn clean package -s /path/to/custom-settings.xml</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®šè‡ªå®šä¹‰æœ¬åœ°ä»“åº“</span></span><br><span class="line">mvn clean package -Dmaven.repo.local=/path/to/custom/repo</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼ºåˆ¶æ›´æ–°ä¾èµ–</span></span><br><span class="line">mvn clean package -U</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¦»çº¿æ¨¡å¼æ„å»º</span></span><br><span class="line">mvn clean package -o</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®šè¿œç¨‹ä»“åº“</span></span><br><span class="line">mvn clean package -DremoteRepositories=http://repo.example.com/maven2</span><br></pre></td></tr></table></figure><hr><h2 id="é…ç½®æ–¹æ¡ˆå¯¹æ¯”"><a href="#é…ç½®æ–¹æ¡ˆå¯¹æ¯”" class="headerlink" title="é…ç½®æ–¹æ¡ˆå¯¹æ¯”"></a>é…ç½®æ–¹æ¡ˆå¯¹æ¯”</h2><h3 id="ğŸ“Š-å¯¹æ¯”è¡¨æ ¼"><a href="#ğŸ“Š-å¯¹æ¯”è¡¨æ ¼" class="headerlink" title="ğŸ“Š å¯¹æ¯”è¡¨æ ¼"></a>ğŸ“Š å¯¹æ¯”è¡¨æ ¼</h3><table><thead><tr><th>é…ç½®æ–¹å¼</th><th>ä½œç”¨èŒƒå›´</th><th>ä¼˜å…ˆçº§</th><th>ç»´æŠ¤å¤æ‚åº¦</th><th>é€‚ç”¨åœºæ™¯</th><th>å½±å“èŒƒå›´</th></tr></thead><tbody><tr><td><strong>pom.xml</strong></td><td>é¡¹ç›®çº§åˆ«</td><td>é«˜</td><td>â­ ç®€å•</td><td>é¡¹ç›®ç‰¹å®šä¾èµ–</td><td>ä»…å½“å‰é¡¹ç›®</td></tr><tr><td><strong>~&#x2F;.m2&#x2F;settings.xml</strong></td><td>ç”¨æˆ·çº§åˆ«</td><td>ä¸­</td><td>â­â­ ä¸­ç­‰</td><td>ä¸ªäººå¼€å‘ç¯å¢ƒ</td><td>å½“å‰ç”¨æˆ·æ‰€æœ‰é¡¹ç›®</td></tr><tr><td><strong>${MAVEN_HOME}&#x2F;conf&#x2F;settings.xml</strong></td><td>ç³»ç»Ÿçº§åˆ«</td><td>ä½</td><td>â­â­â­ å¤æ‚</td><td>ä¼ä¸šç»Ÿä¸€é…ç½®</td><td>ç³»ç»Ÿæ‰€æœ‰ç”¨æˆ·</td></tr><tr><td><strong>å‘½ä»¤è¡Œå‚æ•°</strong></td><td>ä¸´æ—¶</td><td>æœ€é«˜</td><td>â­ ç®€å•</td><td>ä¸´æ—¶éœ€æ±‚ã€CI&#x2F;CD</td><td>ä»…å½“æ¬¡æ„å»º</td></tr></tbody></table><h3 id="ğŸ¯-è¯¦ç»†åˆ†æ"><a href="#ğŸ¯-è¯¦ç»†åˆ†æ" class="headerlink" title="ğŸ¯ è¯¦ç»†åˆ†æ"></a>ğŸ¯ è¯¦ç»†åˆ†æ</h3><h4 id="pom-xmlé…ç½®ä¼˜ç¼ºç‚¹"><a href="#pom-xmlé…ç½®ä¼˜ç¼ºç‚¹" class="headerlink" title="pom.xmlé…ç½®ä¼˜ç¼ºç‚¹"></a>pom.xmlé…ç½®ä¼˜ç¼ºç‚¹</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">âœ… ä¼˜ç‚¹ï¼š</span><br><span class="line">- é¡¹ç›®ç‹¬ç«‹ï¼Œä¸å½±å“å…¶ä»–é¡¹ç›®</span><br><span class="line">- ç‰ˆæœ¬æ§åˆ¶ï¼Œå›¢é˜Ÿå…±äº«é…ç½®</span><br><span class="line">- æ ‡å‡†Mavenå®è·µ</span><br><span class="line">- é…ç½®ç®€å•ç›´è§‚</span><br><span class="line"></span><br><span class="line">âš ï¸ ç¼ºç‚¹ï¼š</span><br><span class="line">- æ¯ä¸ªé¡¹ç›®éƒ½éœ€è¦é…ç½®</span><br><span class="line">- æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚å¯†ç ï¼‰ä¸é€‚åˆå­˜å‚¨</span><br></pre></td></tr></table></figure><h4 id="settings-xmlé…ç½®ä¼˜ç¼ºç‚¹"><a href="#settings-xmlé…ç½®ä¼˜ç¼ºç‚¹" class="headerlink" title="settings.xmlé…ç½®ä¼˜ç¼ºç‚¹"></a>settings.xmlé…ç½®ä¼˜ç¼ºç‚¹</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">âœ… ä¼˜ç‚¹ï¼š</span><br><span class="line">- ä¸€æ¬¡é…ç½®ï¼Œå¤šé¡¹ç›®å¤ç”¨</span><br><span class="line">- å¯ä»¥é…ç½®è®¤è¯ä¿¡æ¯</span><br><span class="line">- æ”¯æŒProfileæœºåˆ¶ï¼Œçµæ´»åˆ‡æ¢</span><br><span class="line"></span><br><span class="line">âš ï¸ ç¼ºç‚¹ï¼š</span><br><span class="line">- ä¸åœ¨ç‰ˆæœ¬æ§åˆ¶ä¸­ï¼Œå›¢é˜Ÿå…±äº«å›°éš¾</span><br><span class="line">- å¯èƒ½å½±å“æ‰€æœ‰é¡¹ç›®</span><br><span class="line">- ç¯å¢ƒç›¸å…³æ€§å¼º</span><br></pre></td></tr></table></figure><hr><h2 id="å®é™…åº”ç”¨åœºæ™¯"><a href="#å®é™…åº”ç”¨åœºæ™¯" class="headerlink" title="å®é™…åº”ç”¨åœºæ™¯"></a>å®é™…åº”ç”¨åœºæ™¯</h2><h3 id="åœºæ™¯1ï¼šä¼ä¸šå†…ç½‘ç¯å¢ƒ"><a href="#åœºæ™¯1ï¼šä¼ä¸šå†…ç½‘ç¯å¢ƒ" class="headerlink" title="åœºæ™¯1ï¼šä¼ä¸šå†…ç½‘ç¯å¢ƒ"></a>åœºæ™¯1ï¼šä¼ä¸šå†…ç½‘ç¯å¢ƒ</h3><h4 id="é—®é¢˜æè¿°"><a href="#é—®é¢˜æè¿°" class="headerlink" title="é—®é¢˜æè¿°"></a>é—®é¢˜æè¿°</h4><ul><li>ä¼ä¸šå†…ç½‘æ— æ³•ç›´æ¥è®¿é—®Mavenä¸­å¤®ä»“åº“</li><li>æœ‰å†…éƒ¨Nexusç§æœ</li><li>åŒ…å«è‡ªç ”ç»„ä»¶å’Œç¬¬ä¸‰æ–¹ç»„ä»¶</li></ul><h4 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- pom.xml - é¡¹ç›®çº§åˆ«é…ç½®ï¼ˆæ¨èï¼‰ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- å†…ç½‘Nexusï¼ˆåŒ…å«ä¸­å¤®ä»“åº“ä»£ç†ï¼‰ --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>company-nexus<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://nexus.internal.company.com/repository/maven-public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">releases</span>&gt;</span><span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span><span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span><span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span><span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="åœºæ™¯2ï¼šCI-CDç¯å¢ƒ"><a href="#åœºæ™¯2ï¼šCI-CDç¯å¢ƒ" class="headerlink" title="åœºæ™¯2ï¼šCI&#x2F;CDç¯å¢ƒ"></a>åœºæ™¯2ï¼šCI&#x2F;CDç¯å¢ƒ</h3><h4 id="é—®é¢˜æè¿°-1"><a href="#é—®é¢˜æè¿°-1" class="headerlink" title="é—®é¢˜æè¿°"></a>é—®é¢˜æè¿°</h4><ul><li>å¤šä¸ªé¡¹ç›®ä½¿ç”¨ä¸åŒçš„ä»“åº“é…ç½®</li><li>æ„å»ºç¯å¢ƒéœ€è¦éš”ç¦»</li><li>ä¸èƒ½å½±å“æ„å»ºæœºå™¨çš„å…¨å±€é…ç½®</li></ul><h4 id="è§£å†³æ–¹æ¡ˆï¼šä»…ä½¿ç”¨pom-xmlï¼ˆæ¨èï¼‰"><a href="#è§£å†³æ–¹æ¡ˆï¼šä»…ä½¿ç”¨pom-xmlï¼ˆæ¨èï¼‰" class="headerlink" title="è§£å†³æ–¹æ¡ˆï¼šä»…ä½¿ç”¨pom.xmlï¼ˆæ¨èï¼‰"></a>è§£å†³æ–¹æ¡ˆï¼šä»…ä½¿ç”¨pom.xmlï¼ˆæ¨èï¼‰</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># .gitlab-ci.yml</span></span><br><span class="line"><span class="attr">script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mvn</span> <span class="string">clean</span> <span class="string">package</span> <span class="string">-Dmaven.test.skip=true</span></span><br><span class="line">  <span class="comment"># pom.xmlä¸­çš„ä»“åº“é…ç½®ä¼šè‡ªåŠ¨ç”Ÿæ•ˆï¼Œä¸å½±å“æ„å»ºæœºå™¨</span></span><br></pre></td></tr></table></figure><h3 id="åœºæ™¯3ï¼šä¾èµ–ä¸‹è½½åŠ é€Ÿ"><a href="#åœºæ™¯3ï¼šä¾èµ–ä¸‹è½½åŠ é€Ÿ" class="headerlink" title="åœºæ™¯3ï¼šä¾èµ–ä¸‹è½½åŠ é€Ÿ"></a>åœºæ™¯3ï¼šä¾èµ–ä¸‹è½½åŠ é€Ÿ</h3><h4 id="é—®é¢˜æè¿°-2"><a href="#é—®é¢˜æè¿°-2" class="headerlink" title="é—®é¢˜æè¿°"></a>é—®é¢˜æè¿°</h4><ul><li>ä¸­å¤®ä»“åº“è®¿é—®é€Ÿåº¦æ…¢</li><li>å¸Œæœ›ä½¿ç”¨å›½å†…é•œåƒåŠ é€Ÿ</li></ul><h4 id="è§£å†³æ–¹æ¡ˆï¼šé…ç½®é•œåƒ"><a href="#è§£å†³æ–¹æ¡ˆï¼šé…ç½®é•œåƒ" class="headerlink" title="è§£å†³æ–¹æ¡ˆï¼šé…ç½®é•œåƒ"></a>è§£å†³æ–¹æ¡ˆï¼šé…ç½®é•œåƒ</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ~/.m2/settings.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mirrors</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- é˜¿é‡Œäº‘é•œåƒ --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>aliyun-central<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Aliyun Central Mirror<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://maven.aliyun.com/repository/central<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirrors</span>&gt;</span></span><br></pre></td></tr></table></figure><hr><h2 id="æœ€ä½³å®è·µ"><a href="#æœ€ä½³å®è·µ" class="headerlink" title="æœ€ä½³å®è·µ"></a>æœ€ä½³å®è·µ</h2><h3 id="ğŸ¯-é…ç½®åŸåˆ™"><a href="#ğŸ¯-é…ç½®åŸåˆ™" class="headerlink" title="ğŸ¯ é…ç½®åŸåˆ™"></a>ğŸ¯ é…ç½®åŸåˆ™</h3><h4 id="1-æœ€å°å½±å“åŸåˆ™"><a href="#1-æœ€å°å½±å“åŸåˆ™" class="headerlink" title="1. æœ€å°å½±å“åŸåˆ™"></a>1. æœ€å°å½±å“åŸåˆ™</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- âœ… æ¨èï¼šé¡¹ç›®çº§åˆ«é…ç½® --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>project-specific-repo<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://specific.repo.com<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- âŒ é¿å…ï¼šå…¨å±€é…ç½®å½±å“æ‰€æœ‰é¡¹ç›® --&gt;</span></span><br></pre></td></tr></table></figure><h4 id="2-é…ç½®å±‚æ¬¡åŒ–"><a href="#2-é…ç½®å±‚æ¬¡åŒ–" class="headerlink" title="2. é…ç½®å±‚æ¬¡åŒ–"></a>2. é…ç½®å±‚æ¬¡åŒ–</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">é¡¹ç›®ç‰¹å®šéœ€æ±‚ â†’ pom.xml</span><br><span class="line">ä¸ªäººå¼€å‘ç¯å¢ƒ â†’ ~/.m2/settings.xml  </span><br><span class="line">ä¼ä¸šç»Ÿä¸€é…ç½® â†’ $&#123;MAVEN_HOME&#125;/conf/settings.xml</span><br><span class="line">ä¸´æ—¶éœ€æ±‚ â†’ å‘½ä»¤è¡Œå‚æ•°</span><br></pre></td></tr></table></figure><h4 id="3-å®‰å…¨è€ƒè™‘"><a href="#3-å®‰å…¨è€ƒè™‘" class="headerlink" title="3. å®‰å…¨è€ƒè™‘"></a>3. å®‰å…¨è€ƒè™‘</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- âœ… æ•æ„Ÿä¿¡æ¯ä½¿ç”¨settings.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servers</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>private-repo<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">username</span>&gt;</span>$&#123;env.MAVEN_USERNAME&#125;<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">password</span>&gt;</span>$&#123;env.MAVEN_PASSWORD&#125;<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servers</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- âŒ é¿å…åœ¨pom.xmlä¸­å­˜å‚¨å¯†ç  --&gt;</span></span><br></pre></td></tr></table></figure><h3 id="ğŸ”§-è°ƒè¯•å’Œæ•…éšœæ’æŸ¥"><a href="#ğŸ”§-è°ƒè¯•å’Œæ•…éšœæ’æŸ¥" class="headerlink" title="ğŸ”§ è°ƒè¯•å’Œæ•…éšœæ’æŸ¥"></a>ğŸ”§ è°ƒè¯•å’Œæ•…éšœæ’æŸ¥</h3><h4 id="æŸ¥çœ‹æœ‰æ•ˆé…ç½®"><a href="#æŸ¥çœ‹æœ‰æ•ˆé…ç½®" class="headerlink" title="æŸ¥çœ‹æœ‰æ•ˆé…ç½®"></a>æŸ¥çœ‹æœ‰æ•ˆé…ç½®</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹æœ‰æ•ˆçš„POMé…ç½®</span></span><br><span class="line">mvn <span class="built_in">help</span>:effective-pom</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æœ‰æ•ˆçš„settingsé…ç½®  </span></span><br><span class="line">mvn <span class="built_in">help</span>:effective-settings</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ä¾èµ–æ ‘</span></span><br><span class="line">mvn dependency:tree</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯¦ç»†è°ƒè¯•ä¿¡æ¯</span></span><br><span class="line">mvn clean package -X</span><br></pre></td></tr></table></figure><h4 id="å¸¸ç”¨è¯Šæ–­å‘½ä»¤"><a href="#å¸¸ç”¨è¯Šæ–­å‘½ä»¤" class="headerlink" title="å¸¸ç”¨è¯Šæ–­å‘½ä»¤"></a>å¸¸ç”¨è¯Šæ–­å‘½ä»¤</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¼ºåˆ¶æ›´æ–°æ‰€æœ‰ä¾èµ–</span></span><br><span class="line">mvn clean package -U</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¸…ç†æœ¬åœ°ä»“åº“æŸåçš„æ–‡ä»¶</span></span><br><span class="line">mvn dependency:purge-local-repository</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½æºç å’Œæ–‡æ¡£</span></span><br><span class="line">mvn dependency:sources dependency:resolve -Dclassifier=javadoc</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ†æä¾èµ–</span></span><br><span class="line">mvn dependency:analyze</span><br></pre></td></tr></table></figure><hr><h2 id="å¸¸è§é—®é¢˜è§£ç­”"><a href="#å¸¸è§é—®é¢˜è§£ç­”" class="headerlink" title="å¸¸è§é—®é¢˜è§£ç­”"></a>å¸¸è§é—®é¢˜è§£ç­”</h2><h3 id="Q1-pom-xmlä¸­é…ç½®ä»“åº“ä¼šè¦†ç›–ä¸­å¤®ä»“åº“å—ï¼Ÿ"><a href="#Q1-pom-xmlä¸­é…ç½®ä»“åº“ä¼šè¦†ç›–ä¸­å¤®ä»“åº“å—ï¼Ÿ" class="headerlink" title="Q1: pom.xmlä¸­é…ç½®ä»“åº“ä¼šè¦†ç›–ä¸­å¤®ä»“åº“å—ï¼Ÿ"></a>Q1: pom.xmlä¸­é…ç½®ä»“åº“ä¼šè¦†ç›–ä¸­å¤®ä»“åº“å—ï¼Ÿ</h3><p><strong>A:</strong> ä¸ä¼šã€‚pom.xmlä¸­çš„ä»“åº“é…ç½®æ˜¯<strong>è¿½åŠ æ€§</strong>çš„ï¼Œä¸ä¼šè¦†ç›–Mavenä¸­å¤®ä»“åº“ã€‚</p><p>å®é™…ä»“åº“åˆ—è¡¨ä¸ºï¼š</p><ol><li>æœ¬åœ°ä»“åº“</li><li>pom.xmlä¸­é…ç½®çš„ä»“åº“  </li><li>settings.xmlä¸­é…ç½®çš„ä»“åº“</li><li>Mavenä¸­å¤®ä»“åº“</li></ol><h3 id="Q2-å¦‚ä½•ç¡®å®šä¾èµ–ä»å“ªä¸ªä»“åº“ä¸‹è½½çš„ï¼Ÿ"><a href="#Q2-å¦‚ä½•ç¡®å®šä¾èµ–ä»å“ªä¸ªä»“åº“ä¸‹è½½çš„ï¼Ÿ" class="headerlink" title="Q2: å¦‚ä½•ç¡®å®šä¾èµ–ä»å“ªä¸ªä»“åº“ä¸‹è½½çš„ï¼Ÿ"></a>Q2: å¦‚ä½•ç¡®å®šä¾èµ–ä»å“ªä¸ªä»“åº“ä¸‹è½½çš„ï¼Ÿ</h3><p><strong>A:</strong> ä½¿ç”¨è°ƒè¯•æ¨¡å¼æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean package -X | grep <span class="string">&quot;Downloading\|Downloaded&quot;</span></span><br></pre></td></tr></table></figure><h3 id="Q3-CI-CDç¯å¢ƒä¸­å¦‚ä½•é¿å…å½±å“æ„å»ºæœºå™¨é…ç½®ï¼Ÿ"><a href="#Q3-CI-CDç¯å¢ƒä¸­å¦‚ä½•é¿å…å½±å“æ„å»ºæœºå™¨é…ç½®ï¼Ÿ" class="headerlink" title="Q3: CI&#x2F;CDç¯å¢ƒä¸­å¦‚ä½•é¿å…å½±å“æ„å»ºæœºå™¨é…ç½®ï¼Ÿ"></a>Q3: CI&#x2F;CDç¯å¢ƒä¸­å¦‚ä½•é¿å…å½±å“æ„å»ºæœºå™¨é…ç½®ï¼Ÿ</h3><p><strong>A:</strong> æ¨èä»…ä½¿ç”¨pom.xmlé…ç½®ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mvn</span> <span class="string">clean</span> <span class="string">package</span> <span class="string">-Dmaven.test.skip=true</span></span><br></pre></td></tr></table></figure><p>è¿™ç§æ–¹å¼ä¸ä¼šä¿®æ”¹æ„å»ºæœºå™¨çš„ä»»ä½•å…¨å±€é…ç½®ã€‚</p><h3 id="Q4-å¦‚ä½•æé«˜ä¾èµ–ä¸‹è½½é€Ÿåº¦ï¼Ÿ"><a href="#Q4-å¦‚ä½•æé«˜ä¾èµ–ä¸‹è½½é€Ÿåº¦ï¼Ÿ" class="headerlink" title="Q4: å¦‚ä½•æé«˜ä¾èµ–ä¸‹è½½é€Ÿåº¦ï¼Ÿ"></a>Q4: å¦‚ä½•æé«˜ä¾èµ–ä¸‹è½½é€Ÿåº¦ï¼Ÿ</h3><p><strong>A:</strong> å¤šç§ä¼˜åŒ–æ–¹æ³•ï¼š</p><ol><li><p><strong>ä½¿ç”¨å›½å†…é•œåƒ</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">id</span>&gt;</span>aliyun<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://maven.aliyun.com/repository/central<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p><strong>ä½¿ç”¨ä¼ä¸šå†…ç½‘ä»“åº“</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">id</span>&gt;</span>internal-nexus<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://internal-nexus.company.com/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p><strong>å¹¶è¡Œæ„å»º</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean package -T 4  <span class="comment"># ä½¿ç”¨4ä¸ªçº¿ç¨‹</span></span><br></pre></td></tr></table></figure></li></ol><hr><h2 id="æ·±å…¥åŸç†ï¼šä¾èµ–è§£æç®—æ³•"><a href="#æ·±å…¥åŸç†ï¼šä¾èµ–è§£æç®—æ³•" class="headerlink" title="æ·±å…¥åŸç†ï¼šä¾èµ–è§£æç®—æ³•"></a>æ·±å…¥åŸç†ï¼šä¾èµ–è§£æç®—æ³•</h2><h3 id="ğŸ”-ä¾èµ–è§£æçš„æ ¸å¿ƒç®—æ³•"><a href="#ğŸ”-ä¾èµ–è§£æçš„æ ¸å¿ƒç®—æ³•" class="headerlink" title="ğŸ” ä¾èµ–è§£æçš„æ ¸å¿ƒç®—æ³•"></a>ğŸ” ä¾èµ–è§£æçš„æ ¸å¿ƒç®—æ³•</h3><p>Mavençš„ä¾èµ–è§£æåŸºäº**æ·±åº¦ä¼˜å…ˆæœç´¢(DFS)**ç®—æ³•ï¼Œä½†å®é™…å®ç°æ¯”ç®€å•çš„DFSå¤æ‚å¾—å¤šã€‚</p><h4 id="ç®—æ³•æµç¨‹è¯¦è§£"><a href="#ç®—æ³•æµç¨‹è¯¦è§£" class="headerlink" title="ç®—æ³•æµç¨‹è¯¦è§£"></a>ç®—æ³•æµç¨‹è¯¦è§£</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Mavenä¾èµ–è§£æç®—æ³•çš„æ ¸å¿ƒé€»è¾‘ï¼ˆç®€åŒ–ç‰ˆï¼‰</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DependencyResolver</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, DependencyNode&gt; resolvedNodes = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;DependencyConflict&gt; conflicts = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> DependencyNode <span class="title function_">resolveDependencies</span><span class="params">(Project project)</span> &#123;</span><br><span class="line">        <span class="type">DependencyNode</span> <span class="variable">root</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DependencyNode</span>(project);</span><br><span class="line">        resolveNode(root, <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;());</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">resolveNode</span><span class="params">(DependencyNode node, Set&lt;String&gt; visited)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> node.getKey();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. æ£€æŸ¥å¾ªç¯ä¾èµ–</span></span><br><span class="line">        <span class="keyword">if</span> (visited.contains(key)) &#123;</span><br><span class="line">            handleCircularDependency(node, visited);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. æ£€æŸ¥æ˜¯å¦å·²è§£æ</span></span><br><span class="line">        <span class="keyword">if</span> (resolvedNodes.containsKey(key)) &#123;</span><br><span class="line">            node.setResolvedNode(resolvedNodes.get(key));</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. æ ‡è®°ä¸ºå·²è®¿é—®</span></span><br><span class="line">        visited.add(key);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. è§£æç›´æ¥ä¾èµ–</span></span><br><span class="line">        <span class="keyword">for</span> (Dependency dep : node.getDependencies()) &#123;</span><br><span class="line">            <span class="type">DependencyNode</span> <span class="variable">child</span> <span class="operator">=</span> findDependencyInRepositories(dep);</span><br><span class="line">            <span class="keyword">if</span> (child != <span class="literal">null</span>) &#123;</span><br><span class="line">                resolveNode(child, <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(visited));</span><br><span class="line">                node.addChild(child);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5. å¤„ç†ç‰ˆæœ¬å†²çª</span></span><br><span class="line">        resolveVersionConflicts(node);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 6. ç¼“å­˜ç»“æœ</span></span><br><span class="line">        resolvedNodes.put(key, node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ä¾èµ–è§£æçš„è¯¦ç»†æ­¥éª¤"><a href="#ä¾èµ–è§£æçš„è¯¦ç»†æ­¥éª¤" class="headerlink" title="ä¾èµ–è§£æçš„è¯¦ç»†æ­¥éª¤"></a>ä¾èµ–è§£æçš„è¯¦ç»†æ­¥éª¤</h4><pre class="mermaid">graph TD    A[å¼€å§‹è§£æé¡¹ç›®ä¾èµ–] --> B[åˆ›å»ºæ ¹èŠ‚ç‚¹]    B --> C[æ·±åº¦ä¼˜å…ˆéå†ä¾èµ–æ ‘]    C --> D{æ£€æŸ¥å¾ªç¯ä¾èµ–?}    D -->|æ˜¯| E[å¤„ç†å¾ªç¯ä¾èµ–]    D -->|å¦| F{èŠ‚ç‚¹å·²è§£æ?}    F -->|æ˜¯| G[ä½¿ç”¨ç¼“å­˜ç»“æœ]    F -->|å¦| H[ä»ä»“åº“æŸ¥æ‰¾ä¾èµ–]    H --> I{æ‰¾åˆ°ä¾èµ–?}    I -->|å¦| J[è§£æå¤±è´¥]    I -->|æ˜¯| K[é€’å½’è§£æå­ä¾èµ–]    K --> L[ç‰ˆæœ¬å†²çªæ£€æµ‹]    L --> M{å­˜åœ¨å†²çª?}    M -->|æ˜¯| N[åº”ç”¨å†²çªè§£å†³ç­–ç•¥]    M -->|å¦| O[ç¼“å­˜è§£æç»“æœ]    N --> O    O --> P{è¿˜æœ‰æœªè§£æèŠ‚ç‚¹?}    P -->|æ˜¯| C    P -->|å¦| Q[è§£æå®Œæˆ]</pre><h3 id="ğŸ¯-ä¾èµ–è§£æçš„ä¼˜å…ˆçº§è§„åˆ™"><a href="#ğŸ¯-ä¾èµ–è§£æçš„ä¼˜å…ˆçº§è§„åˆ™" class="headerlink" title="ğŸ¯ ä¾èµ–è§£æçš„ä¼˜å…ˆçº§è§„åˆ™"></a>ğŸ¯ ä¾èµ–è§£æçš„ä¼˜å…ˆçº§è§„åˆ™</h3><p>Mavenä½¿ç”¨**æœ€è¿‘ä¼˜å…ˆ(Nearest Definition Wins)**ç­–ç•¥ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- é¡¹ç›®Açš„pom.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>library<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  <span class="comment">&lt;!-- ä¼˜å…ˆçº§æœ€é«˜ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- é¡¹ç›®Aä¾èµ–çš„é¡¹ç›®Bçš„pom.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>library<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  <span class="comment">&lt;!-- ä¼˜å…ˆçº§ä¸­ç­‰ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- é¡¹ç›®Bä¾èµ–çš„é¡¹ç›®Cçš„pom.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>library<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  <span class="comment">&lt;!-- ä¼˜å…ˆçº§æœ€ä½ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>ç»“æœ</strong>ï¼šæœ€ç»ˆä½¿ç”¨ç‰ˆæœ¬ <code>1.0.0</code>ï¼Œå› ä¸ºå®ƒåœ¨ä¾èµ–æ ‘ä¸­è·ç¦»æ ¹èŠ‚ç‚¹æœ€è¿‘ã€‚</p><hr><h2 id="æ·±å…¥åŸç†ï¼šç‰ˆæœ¬å†²çªè§£å†³æœºåˆ¶"><a href="#æ·±å…¥åŸç†ï¼šç‰ˆæœ¬å†²çªè§£å†³æœºåˆ¶" class="headerlink" title="æ·±å…¥åŸç†ï¼šç‰ˆæœ¬å†²çªè§£å†³æœºåˆ¶"></a>æ·±å…¥åŸç†ï¼šç‰ˆæœ¬å†²çªè§£å†³æœºåˆ¶</h2><h3 id="âš”ï¸-ç‰ˆæœ¬å†²çªçš„ç±»å‹"><a href="#âš”ï¸-ç‰ˆæœ¬å†²çªçš„ç±»å‹" class="headerlink" title="âš”ï¸ ç‰ˆæœ¬å†²çªçš„ç±»å‹"></a>âš”ï¸ ç‰ˆæœ¬å†²çªçš„ç±»å‹</h3><h4 id="1-ç›´æ¥å†²çª"><a href="#1-ç›´æ¥å†²çª" class="headerlink" title="1. ç›´æ¥å†²çª"></a>1. ç›´æ¥å†²çª</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- åŒä¸€ä¸ªä¾èµ–åœ¨pom.xmlä¸­å£°æ˜äº†ä¸åŒç‰ˆæœ¬ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.13.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.15.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  <span class="comment">&lt;!-- å†²çªï¼ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="2-ä¼ é€’æ€§å†²çª"><a href="#2-ä¼ é€’æ€§å†²çª" class="headerlink" title="2. ä¼ é€’æ€§å†²çª"></a>2. ä¼ é€’æ€§å†²çª</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- é¡¹ç›®ä¾èµ– --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  <span class="comment">&lt;!-- ä¼ é€’ä¾èµ–jackson 2.13.0 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.15.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  <span class="comment">&lt;!-- ç›´æ¥ä¾èµ–ï¼Œä¼˜å…ˆçº§æ›´é«˜ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="ğŸ”§-å†²çªè§£å†³ç­–ç•¥"><a href="#ğŸ”§-å†²çªè§£å†³ç­–ç•¥" class="headerlink" title="ğŸ”§ å†²çªè§£å†³ç­–ç•¥"></a>ğŸ”§ å†²çªè§£å†³ç­–ç•¥</h3><h4 id="ç­–ç•¥1ï¼šæœ€è¿‘ä¼˜å…ˆï¼ˆé»˜è®¤ï¼‰"><a href="#ç­–ç•¥1ï¼šæœ€è¿‘ä¼˜å…ˆï¼ˆé»˜è®¤ï¼‰" class="headerlink" title="ç­–ç•¥1ï¼šæœ€è¿‘ä¼˜å…ˆï¼ˆé»˜è®¤ï¼‰"></a>ç­–ç•¥1ï¼šæœ€è¿‘ä¼˜å…ˆï¼ˆé»˜è®¤ï¼‰</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ä¾èµ–æ ‘ï¼Œäº†è§£å†²çªæ¥æº</span></span><br><span class="line">mvn dependency:tree -Dverbose</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡ºç¤ºä¾‹</span></span><br><span class="line">[INFO] com.example:my-project:jar:1.0.0</span><br><span class="line">[INFO] +- org.springframework.boot:spring-boot-starter-web:jar:2.7.0:compile</span><br><span class="line">[INFO] |  +- com.fasterxml.jackson.core:jackson-databind:jar:2.13.0:compile</span><br><span class="line">[INFO] |     +- com.fasterxml.jackson.core:jackson-core:jar:2.13.0:compile</span><br><span class="line">[INFO] +- com.fasterxml.jackson.core:jackson-databind:jar:2.15.0:compile (version managed from 2.13.0)</span><br></pre></td></tr></table></figure><h4 id="ç­–ç•¥2ï¼šå¼ºåˆ¶ç‰ˆæœ¬ï¼ˆä½¿ç”¨dependencyManagementï¼‰"><a href="#ç­–ç•¥2ï¼šå¼ºåˆ¶ç‰ˆæœ¬ï¼ˆä½¿ç”¨dependencyManagementï¼‰" class="headerlink" title="ç­–ç•¥2ï¼šå¼ºåˆ¶ç‰ˆæœ¬ï¼ˆä½¿ç”¨dependencyManagementï¼‰"></a>ç­–ç•¥2ï¼šå¼ºåˆ¶ç‰ˆæœ¬ï¼ˆä½¿ç”¨dependencyManagementï¼‰</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.15.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  <span class="comment">&lt;!-- å¼ºåˆ¶æ‰€æœ‰ä¼ é€’ä¾èµ–ä½¿ç”¨æ­¤ç‰ˆæœ¬ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="ç­–ç•¥3ï¼šæ’é™¤å†²çªä¾èµ–"><a href="#ç­–ç•¥3ï¼šæ’é™¤å†²çªä¾èµ–" class="headerlink" title="ç­–ç•¥3ï¼šæ’é™¤å†²çªä¾èµ–"></a>ç­–ç•¥3ï¼šæ’é™¤å†²çªä¾èµ–</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="ğŸ§ -å†²çªæ£€æµ‹ç®—æ³•"><a href="#ğŸ§ -å†²çªæ£€æµ‹ç®—æ³•" class="headerlink" title="ğŸ§  å†²çªæ£€æµ‹ç®—æ³•"></a>ğŸ§  å†²çªæ£€æµ‹ç®—æ³•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VersionConflictResolver</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">detectConflicts</span><span class="params">(DependencyNode root)</span> &#123;</span><br><span class="line">        Map&lt;String, List&lt;DependencyNode&gt;&gt; versionGroups = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. æŒ‰groupId:artifactIdåˆ†ç»„</span></span><br><span class="line">        collectDependencies(root, versionGroups);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. æ£€æµ‹æ¯ç»„ä¸­çš„ç‰ˆæœ¬å†²çª</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, List&lt;DependencyNode&gt;&gt; entry : versionGroups.entrySet()) &#123;</span><br><span class="line">            List&lt;DependencyNode&gt; nodes = entry.getValue();</span><br><span class="line">            Set&lt;String&gt; versions = nodes.stream()</span><br><span class="line">                .map(DependencyNode::getVersion)</span><br><span class="line">                .collect(Collectors.toSet());</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (versions.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">// å‘ç°ç‰ˆæœ¬å†²çª</span></span><br><span class="line">                resolveConflict(nodes, versions);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">resolveConflict</span><span class="params">(List&lt;DependencyNode&gt; nodes, Set&lt;String&gt; versions)</span> &#123;</span><br><span class="line">        <span class="comment">// åº”ç”¨æœ€è¿‘ä¼˜å…ˆç­–ç•¥</span></span><br><span class="line">        <span class="type">DependencyNode</span> <span class="variable">nearest</span> <span class="operator">=</span> findNearestNode(nodes);</span><br><span class="line">        <span class="type">String</span> <span class="variable">selectedVersion</span> <span class="operator">=</span> nearest.getVersion();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ›´æ–°æ‰€æœ‰å†²çªèŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">for</span> (DependencyNode node : nodes) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!node.getVersion().equals(selectedVersion)) &#123;</span><br><span class="line">                node.setResolvedVersion(selectedVersion);</span><br><span class="line">                logConflict(node, selectedVersion);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="æ·±å…¥åŸç†ï¼šä»“åº“å…ƒæ•°æ®æœºåˆ¶"><a href="#æ·±å…¥åŸç†ï¼šä»“åº“å…ƒæ•°æ®æœºåˆ¶" class="headerlink" title="æ·±å…¥åŸç†ï¼šä»“åº“å…ƒæ•°æ®æœºåˆ¶"></a>æ·±å…¥åŸç†ï¼šä»“åº“å…ƒæ•°æ®æœºåˆ¶</h2><h3 id="ğŸ“Š-Mavenå…ƒæ•°æ®ç»“æ„"><a href="#ğŸ“Š-Mavenå…ƒæ•°æ®ç»“æ„" class="headerlink" title="ğŸ“Š Mavenå…ƒæ•°æ®ç»“æ„"></a>ğŸ“Š Mavenå…ƒæ•°æ®ç»“æ„</h3><p>Mavenä»“åº“ä¸­çš„å…ƒæ•°æ®æ–‡ä»¶åŒ…å«ç‰ˆæœ¬ä¿¡æ¯ã€ä¾èµ–å…³ç³»ç­‰å…³é”®æ•°æ®ï¼š</p><h4 id="maven-metadata-xmlç»“æ„"><a href="#maven-metadata-xmlç»“æ„" class="headerlink" title="maven-metadata.xmlç»“æ„"></a>maven-metadata.xmlç»“æ„</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">metadata</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>my-library<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">versioning</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">latest</span>&gt;</span>2.1.0<span class="tag">&lt;/<span class="name">latest</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">release</span>&gt;</span>2.1.0<span class="tag">&lt;/<span class="name">release</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">versions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">versions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lastUpdated</span>&gt;</span>20231201120000<span class="tag">&lt;/<span class="name">lastUpdated</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">versioning</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">metadata</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="ç‰ˆæœ¬èŒƒå›´è§£æ"><a href="#ç‰ˆæœ¬èŒƒå›´è§£æ" class="headerlink" title="ç‰ˆæœ¬èŒƒå›´è§£æ"></a>ç‰ˆæœ¬èŒƒå›´è§£æ</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ç‰ˆæœ¬èŒƒå›´ç¤ºä¾‹ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>library<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>[1.0.0,2.0.0)<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  <span class="comment">&lt;!-- 1.0.0 &lt;= version &lt; 2.0.0 --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- ç‰ˆæœ¬èŒƒå›´è¯­æ³• --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- [1.0.0,2.0.0] - é—­åŒºé—´ --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- (1.0.0,2.0.0) - å¼€åŒºé—´ --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- [1.0.0,) - åŠå¼€åŒºé—´ --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- (,2.0.0] - åŠå¼€åŒºé—´ --&gt;</span></span><br></pre></td></tr></table></figure><h3 id="ğŸ”„-å…ƒæ•°æ®æ›´æ–°æœºåˆ¶"><a href="#ğŸ”„-å…ƒæ•°æ®æ›´æ–°æœºåˆ¶" class="headerlink" title="ğŸ”„ å…ƒæ•°æ®æ›´æ–°æœºåˆ¶"></a>ğŸ”„ å…ƒæ•°æ®æ›´æ–°æœºåˆ¶</h3><h4 id="æ›´æ–°ç­–ç•¥è¯¦è§£"><a href="#æ›´æ–°ç­–ç•¥è¯¦è§£" class="headerlink" title="æ›´æ–°ç­–ç•¥è¯¦è§£"></a>æ›´æ–°ç­–ç•¥è¯¦è§£</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- æ›´æ–°ç­–ç•¥é…ç½® --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>my-repo<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://repo.example.com<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">releases</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">updatePolicy</span>&gt;</span>daily<span class="tag">&lt;/<span class="name">updatePolicy</span>&gt;</span>      <span class="comment">&lt;!-- æ¯æ—¥æ£€æŸ¥ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">checksumPolicy</span>&gt;</span>warn<span class="tag">&lt;/<span class="name">checksumPolicy</span>&gt;</span>   <span class="comment">&lt;!-- æ ¡éªŒå¤±è´¥æ—¶è­¦å‘Š --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">updatePolicy</span>&gt;</span>always<span class="tag">&lt;/<span class="name">updatePolicy</span>&gt;</span>     <span class="comment">&lt;!-- æ€»æ˜¯æ£€æŸ¥æ›´æ–° --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">checksumPolicy</span>&gt;</span>fail<span class="tag">&lt;/<span class="name">checksumPolicy</span>&gt;</span>   <span class="comment">&lt;!-- æ ¡éªŒå¤±è´¥æ—¶å¤±è´¥ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="å…ƒæ•°æ®ç¼“å­˜æœºåˆ¶"><a href="#å…ƒæ•°æ®ç¼“å­˜æœºåˆ¶" class="headerlink" title="å…ƒæ•°æ®ç¼“å­˜æœºåˆ¶"></a>å…ƒæ•°æ®ç¼“å­˜æœºåˆ¶</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MetadataCache</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Metadata&gt; cache = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Long&gt; lastUpdate = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Metadata <span class="title function_">getMetadata</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="type">Metadata</span> <span class="variable">metadata</span> <span class="operator">=</span> cache.get(key);</span><br><span class="line">        <span class="keyword">if</span> (metadata != <span class="literal">null</span> &amp;&amp; !isExpired(key)) &#123;</span><br><span class="line">            <span class="keyword">return</span> metadata;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä»è¿œç¨‹ä»“åº“è·å–æœ€æ–°å…ƒæ•°æ®</span></span><br><span class="line">        metadata = fetchFromRemote(key);</span><br><span class="line">        cache.put(key, metadata);</span><br><span class="line">        lastUpdate.put(key, System.currentTimeMillis());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> metadata;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isExpired</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">last</span> <span class="operator">=</span> lastUpdate.getOrDefault(key, <span class="number">0L</span>);</span><br><span class="line">        <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">return</span> (now - last) &gt; getUpdateInterval(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="æ·±å…¥åŸç†ï¼šä¾èµ–ä¼ é€’æ€§åŸç†"><a href="#æ·±å…¥åŸç†ï¼šä¾èµ–ä¼ é€’æ€§åŸç†" class="headerlink" title="æ·±å…¥åŸç†ï¼šä¾èµ–ä¼ é€’æ€§åŸç†"></a>æ·±å…¥åŸç†ï¼šä¾èµ–ä¼ é€’æ€§åŸç†</h2><h3 id="ğŸ”—-ä¾èµ–ä¼ é€’çš„æ•°å­¦åŸºç¡€"><a href="#ğŸ”—-ä¾èµ–ä¼ é€’çš„æ•°å­¦åŸºç¡€" class="headerlink" title="ğŸ”— ä¾èµ–ä¼ é€’çš„æ•°å­¦åŸºç¡€"></a>ğŸ”— ä¾èµ–ä¼ é€’çš„æ•°å­¦åŸºç¡€</h3><p>ä¾èµ–ä¼ é€’æ€§åŸºäº<strong>ä¼ é€’é—­åŒ…</strong>çš„æ¦‚å¿µï¼Œå¯ä»¥ç”¨å›¾è®ºæ¥ç†è§£ï¼š</p><pre class="mermaid">graph TD    A[é¡¹ç›®A] --> B[åº“B v1.0]    A --> C[åº“C v2.0]    B --> D[åº“D v1.5]    C --> D[åº“D v2.1]    D --> E[åº“E v1.0]        style A fill:#e1f5fe    style D fill:#ffebee</pre><h4 id="ä¼ é€’æ€§ä¾èµ–è§£æç®—æ³•"><a href="#ä¼ é€’æ€§ä¾èµ–è§£æç®—æ³•" class="headerlink" title="ä¼ é€’æ€§ä¾èµ–è§£æç®—æ³•"></a>ä¼ é€’æ€§ä¾èµ–è§£æç®—æ³•</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransitiveDependencyResolver</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Set&lt;Dependency&gt; <span class="title function_">resolveTransitive</span><span class="params">(Dependency root)</span> &#123;</span><br><span class="line">        Set&lt;Dependency&gt; allDependencies = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        Queue&lt;Dependency&gt; queue = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        Set&lt;String&gt; visited = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        queue.offer(root);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> (!queue.isEmpty()) &#123;</span><br><span class="line">            <span class="type">Dependency</span> <span class="variable">current</span> <span class="operator">=</span> queue.poll();</span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> current.getKey();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (visited.contains(key)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>; <span class="comment">// é¿å…å¾ªç¯ä¾èµ–</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            visited.add(key);</span><br><span class="line">            allDependencies.add(current);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// è·å–ä¼ é€’ä¾èµ–</span></span><br><span class="line">            List&lt;Dependency&gt; transitive = getTransitiveDependencies(current);</span><br><span class="line">            <span class="keyword">for</span> (Dependency dep : transitive) &#123;</span><br><span class="line">                queue.offer(dep);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> allDependencies;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ğŸ­-ä¾èµ–ä½œç”¨åŸŸçš„å½±å“"><a href="#ğŸ­-ä¾èµ–ä½œç”¨åŸŸçš„å½±å“" class="headerlink" title="ğŸ­ ä¾èµ–ä½œç”¨åŸŸçš„å½±å“"></a>ğŸ­ ä¾èµ–ä½œç”¨åŸŸçš„å½±å“</h3><h4 id="ä½œç”¨åŸŸä¼ é€’è§„åˆ™"><a href="#ä½œç”¨åŸŸä¼ é€’è§„åˆ™" class="headerlink" title="ä½œç”¨åŸŸä¼ é€’è§„åˆ™"></a>ä½œç”¨åŸŸä¼ é€’è§„åˆ™</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ä½œç”¨åŸŸä¼ é€’çŸ©é˜µ --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- compile -&gt; compile, provided, runtime, test --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- provided -&gt; provided --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- runtime -&gt; runtime, test --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- test -&gt; test --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>runtime-lib<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>  <span class="comment">&lt;!-- åªåœ¨è¿è¡Œæ—¶éœ€è¦ --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>test-lib<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>     <span class="comment">&lt;!-- åªåœ¨æµ‹è¯•æ—¶éœ€è¦ --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><hr><h2 id="æ·±å…¥åŸç†ï¼šMavenç”Ÿå‘½å‘¨æœŸä¸ä»“åº“äº¤äº’"><a href="#æ·±å…¥åŸç†ï¼šMavenç”Ÿå‘½å‘¨æœŸä¸ä»“åº“äº¤äº’" class="headerlink" title="æ·±å…¥åŸç†ï¼šMavenç”Ÿå‘½å‘¨æœŸä¸ä»“åº“äº¤äº’"></a>æ·±å…¥åŸç†ï¼šMavenç”Ÿå‘½å‘¨æœŸä¸ä»“åº“äº¤äº’</h2><h3 id="ğŸ”„-ç”Ÿå‘½å‘¨æœŸä¸­çš„ä»“åº“æ“ä½œ"><a href="#ğŸ”„-ç”Ÿå‘½å‘¨æœŸä¸­çš„ä»“åº“æ“ä½œ" class="headerlink" title="ğŸ”„ ç”Ÿå‘½å‘¨æœŸä¸­çš„ä»“åº“æ“ä½œ"></a>ğŸ”„ ç”Ÿå‘½å‘¨æœŸä¸­çš„ä»“åº“æ“ä½œ</h3><pre class="mermaid">graph LR    A[validate] --> B[compile]    B --> C[test]    C --> D[package]    D --> E[verify]    E --> F[install]    F --> G[deploy]        B --> H[ä¸‹è½½ç¼–è¯‘ä¾èµ–]    C --> I[ä¸‹è½½æµ‹è¯•ä¾èµ–]    F --> J[å®‰è£…åˆ°æœ¬åœ°ä»“åº“]    G --> K[éƒ¨ç½²åˆ°è¿œç¨‹ä»“åº“]</pre><h4 id="ç”Ÿå‘½å‘¨æœŸé˜¶æ®µè¯¦è§£"><a href="#ç”Ÿå‘½å‘¨æœŸé˜¶æ®µè¯¦è§£" class="headerlink" title="ç”Ÿå‘½å‘¨æœŸé˜¶æ®µè¯¦è§£"></a>ç”Ÿå‘½å‘¨æœŸé˜¶æ®µè¯¦è§£</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MavenLifecycle</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç¼–è¯‘é˜¶æ®µï¼šä»ä»“åº“ä¸‹è½½ç¼–è¯‘ä¾èµ–</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">compile</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 1. è§£æcompile scopeçš„ä¾èµ–</span></span><br><span class="line">        Set&lt;Dependency&gt; compileDeps = resolveDependencies(Scope.COMPILE);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. ä»ä»“åº“ä¸‹è½½ç¼ºå¤±çš„ä¾èµ–</span></span><br><span class="line">        <span class="keyword">for</span> (Dependency dep : compileDeps) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!isInLocalRepository(dep)) &#123;</span><br><span class="line">                downloadFromRemote(dep);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. æ‰§è¡Œç¼–è¯‘</span></span><br><span class="line">        executeCompilation(compileDeps);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å®‰è£…é˜¶æ®µï¼šå°†æ„å»ºäº§ç‰©å®‰è£…åˆ°æœ¬åœ°ä»“åº“</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">install</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 1. æ„å»ºé¡¹ç›®äº§ç‰©</span></span><br><span class="line">        <span class="type">Artifact</span> <span class="variable">artifact</span> <span class="operator">=</span> buildArtifact();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. å®‰è£…åˆ°æœ¬åœ°ä»“åº“</span></span><br><span class="line">        installToLocalRepository(artifact);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. æ›´æ–°æœ¬åœ°å…ƒæ•°æ®</span></span><br><span class="line">        updateLocalMetadata(artifact);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// éƒ¨ç½²é˜¶æ®µï¼šå°†æ„å»ºäº§ç‰©éƒ¨ç½²åˆ°è¿œç¨‹ä»“åº“</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deploy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 1. éªŒè¯æ„å»ºäº§ç‰©</span></span><br><span class="line">        validateArtifact();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. éƒ¨ç½²åˆ°è¿œç¨‹ä»“åº“</span></span><br><span class="line">        deployToRemoteRepository(artifact);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. æ›´æ–°è¿œç¨‹å…ƒæ•°æ®</span></span><br><span class="line">        updateRemoteMetadata(artifact);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="é«˜çº§ç‰¹æ€§ï¼šä»“åº“é•œåƒä¸ä»£ç†"><a href="#é«˜çº§ç‰¹æ€§ï¼šä»“åº“é•œåƒä¸ä»£ç†" class="headerlink" title="é«˜çº§ç‰¹æ€§ï¼šä»“åº“é•œåƒä¸ä»£ç†"></a>é«˜çº§ç‰¹æ€§ï¼šä»“åº“é•œåƒä¸ä»£ç†</h2><h3 id="ğŸª-é•œåƒæœºåˆ¶æ·±åº¦è§£æ"><a href="#ğŸª-é•œåƒæœºåˆ¶æ·±åº¦è§£æ" class="headerlink" title="ğŸª é•œåƒæœºåˆ¶æ·±åº¦è§£æ"></a>ğŸª é•œåƒæœºåˆ¶æ·±åº¦è§£æ</h3><h4 id="é•œåƒé…ç½®çš„ä¼˜å…ˆçº§"><a href="#é•œåƒé…ç½®çš„ä¼˜å…ˆçº§" class="headerlink" title="é•œåƒé…ç½®çš„ä¼˜å…ˆçº§"></a>é•œåƒé…ç½®çš„ä¼˜å…ˆçº§</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirrors</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- ç‰¹å®šä»“åº“é•œåƒ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>specific-mirror<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>specific-repo<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://mirror.specific.com<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- å¤–éƒ¨ä»“åº“é•œåƒ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>external-mirror<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>external:*<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://mirror.external.com<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- ä¸­å¤®ä»“åº“é•œåƒ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>central-mirror<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://mirror.central.com<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- æ‰€æœ‰ä»“åº“é•œåƒ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>all-mirror<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>*<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://mirror.all.com<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirrors</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="é•œåƒé€‰æ‹©ç®—æ³•"><a href="#é•œåƒé€‰æ‹©ç®—æ³•" class="headerlink" title="é•œåƒé€‰æ‹©ç®—æ³•"></a>é•œåƒé€‰æ‹©ç®—æ³•</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MirrorSelector</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">selectMirror</span><span class="params">(String repositoryId, String repositoryUrl)</span> &#123;</span><br><span class="line">        List&lt;Mirror&gt; mirrors = getConfiguredMirrors();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æŒ‰ä¼˜å…ˆçº§æ’åºï¼šç‰¹å®š &gt; æ¨¡å¼åŒ¹é… &gt; é€šé…ç¬¦</span></span><br><span class="line">        mirrors.sort((m1, m2) -&gt; &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">p1</span> <span class="operator">=</span> getPriority(m1.getMirrorOf());</span><br><span class="line">            <span class="type">int</span> <span class="variable">p2</span> <span class="operator">=</span> getPriority(m2.getMirrorOf());</span><br><span class="line">            <span class="keyword">return</span> Integer.compare(p2, p1); <span class="comment">// é™åº</span></span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (Mirror mirror : mirrors) &#123;</span><br><span class="line">            <span class="keyword">if</span> (matchesMirror(repositoryId, repositoryUrl, mirror)) &#123;</span><br><span class="line">                <span class="keyword">return</span> mirror.getUrl();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> repositoryUrl; <span class="comment">// æ²¡æœ‰åŒ¹é…çš„é•œåƒ</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">matchesMirror</span><span class="params">(String repoId, String repoUrl, Mirror mirror)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">mirrorOf</span> <span class="operator">=</span> mirror.getMirrorOf();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;*&quot;</span>.equals(mirrorOf)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (mirrorOf.startsWith(<span class="string">&quot;external:&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> !isInternalRepository(repoUrl);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> repoId.equals(mirrorOf);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ğŸ”„-ä»£ç†ä»“åº“æœºåˆ¶"><a href="#ğŸ”„-ä»£ç†ä»“åº“æœºåˆ¶" class="headerlink" title="ğŸ”„ ä»£ç†ä»“åº“æœºåˆ¶"></a>ğŸ”„ ä»£ç†ä»“åº“æœºåˆ¶</h3><h4 id="Nexusä»£ç†ä»“åº“é…ç½®"><a href="#Nexusä»£ç†ä»“åº“é…ç½®" class="headerlink" title="Nexusä»£ç†ä»“åº“é…ç½®"></a>Nexusä»£ç†ä»“åº“é…ç½®</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Nexusä»£ç†ä»“åº“é…ç½®ç¤ºä¾‹ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>nexus-proxy<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Nexus Proxy Repository<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://nexus.company.com/repository/maven-proxy/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">releases</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">updatePolicy</span>&gt;</span>daily<span class="tag">&lt;/<span class="name">updatePolicy</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">updatePolicy</span>&gt;</span>always<span class="tag">&lt;/<span class="name">updatePolicy</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="ä»£ç†ç¼“å­˜ç­–ç•¥"><a href="#ä»£ç†ç¼“å­˜ç­–ç•¥" class="headerlink" title="ä»£ç†ç¼“å­˜ç­–ç•¥"></a>ä»£ç†ç¼“å­˜ç­–ç•¥</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProxyCacheManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, CachedArtifact&gt; cache = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Artifact <span class="title function_">getArtifact</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="type">CachedArtifact</span> <span class="variable">cached</span> <span class="operator">=</span> cache.get(key);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (cached != <span class="literal">null</span> &amp;&amp; !isExpired(cached)) &#123;</span><br><span class="line">            <span class="keyword">return</span> cached.getArtifact();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä»ä¸Šæ¸¸ä»“åº“è·å–</span></span><br><span class="line">        <span class="type">Artifact</span> <span class="variable">artifact</span> <span class="operator">=</span> fetchFromUpstream(key);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ç¼“å­˜åˆ°æœ¬åœ°</span></span><br><span class="line">        cache.put(key, <span class="keyword">new</span> <span class="title class_">CachedArtifact</span>(artifact, System.currentTimeMillis()));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> artifact;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isExpired</span><span class="params">(CachedArtifact cached)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">age</span> <span class="operator">=</span> System.currentTimeMillis() - cached.getTimestamp();</span><br><span class="line">        <span class="keyword">return</span> age &gt; getCacheExpirationTime();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="é«˜çº§ç‰¹æ€§ï¼šSNAPSHOTç‰ˆæœ¬æœºåˆ¶"><a href="#é«˜çº§ç‰¹æ€§ï¼šSNAPSHOTç‰ˆæœ¬æœºåˆ¶" class="headerlink" title="é«˜çº§ç‰¹æ€§ï¼šSNAPSHOTç‰ˆæœ¬æœºåˆ¶"></a>é«˜çº§ç‰¹æ€§ï¼šSNAPSHOTç‰ˆæœ¬æœºåˆ¶</h2><h3 id="ğŸ“¸-SNAPSHOTç‰ˆæœ¬çš„ç‰¹æ®Šæ€§"><a href="#ğŸ“¸-SNAPSHOTç‰ˆæœ¬çš„ç‰¹æ®Šæ€§" class="headerlink" title="ğŸ“¸ SNAPSHOTç‰ˆæœ¬çš„ç‰¹æ®Šæ€§"></a>ğŸ“¸ SNAPSHOTç‰ˆæœ¬çš„ç‰¹æ®Šæ€§</h3><h4 id="SNAPSHOTç‰ˆæœ¬æ ‡è¯†"><a href="#SNAPSHOTç‰ˆæœ¬æ ‡è¯†" class="headerlink" title="SNAPSHOTç‰ˆæœ¬æ ‡è¯†"></a>SNAPSHOTç‰ˆæœ¬æ ‡è¯†</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>my-lib<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  <span class="comment">&lt;!-- SNAPSHOTç‰ˆæœ¬ --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="SNAPSHOTå…ƒæ•°æ®ç»“æ„"><a href="#SNAPSHOTå…ƒæ•°æ®ç»“æ„" class="headerlink" title="SNAPSHOTå…ƒæ•°æ®ç»“æ„"></a>SNAPSHOTå…ƒæ•°æ®ç»“æ„</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">metadata</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>my-lib<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">versioning</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">snapshot</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">timestamp</span>&gt;</span>20231201.120000<span class="tag">&lt;/<span class="name">timestamp</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">buildNumber</span>&gt;</span>123<span class="tag">&lt;/<span class="name">buildNumber</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">snapshot</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lastUpdated</span>&gt;</span>20231201120000<span class="tag">&lt;/<span class="name">lastUpdated</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">snapshotVersions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshotVersion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">extension</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">extension</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>1.0.0-20231201.120000-123<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">updated</span>&gt;</span>20231201120000<span class="tag">&lt;/<span class="name">updated</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshotVersion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshotVersion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">extension</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">extension</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>1.0.0-20231201.120000-123<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">updated</span>&gt;</span>20231201120000<span class="tag">&lt;/<span class="name">updated</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshotVersion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">snapshotVersions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">versioning</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">metadata</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="SNAPSHOTæ›´æ–°ç­–ç•¥"><a href="#SNAPSHOTæ›´æ–°ç­–ç•¥" class="headerlink" title="SNAPSHOTæ›´æ–°ç­–ç•¥"></a>SNAPSHOTæ›´æ–°ç­–ç•¥</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SnapshotUpdateStrategy</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">shouldUpdateSnapshot</span><span class="params">(Dependency dependency)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isSnapshot(dependency.getVersion())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">updatePolicy</span> <span class="operator">=</span> getUpdatePolicy(dependency);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">switch</span> (updatePolicy) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;always&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;daily&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> isOlderThanOneDay(dependency);</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;interval:60&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> isOlderThanMinutes(dependency, <span class="number">60</span>);</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;never&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isSnapshot</span><span class="params">(String version)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> version.endsWith(<span class="string">&quot;-SNAPSHOT&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="é«˜çº§ç‰¹æ€§ï¼šä¾èµ–æ’é™¤ä¸å¯é€‰ä¾èµ–"><a href="#é«˜çº§ç‰¹æ€§ï¼šä¾èµ–æ’é™¤ä¸å¯é€‰ä¾èµ–" class="headerlink" title="é«˜çº§ç‰¹æ€§ï¼šä¾èµ–æ’é™¤ä¸å¯é€‰ä¾èµ–"></a>é«˜çº§ç‰¹æ€§ï¼šä¾èµ–æ’é™¤ä¸å¯é€‰ä¾èµ–</h2><h3 id="ğŸš«-ä¾èµ–æ’é™¤æœºåˆ¶"><a href="#ğŸš«-ä¾èµ–æ’é™¤æœºåˆ¶" class="headerlink" title="ğŸš« ä¾èµ–æ’é™¤æœºåˆ¶"></a>ğŸš« ä¾èµ–æ’é™¤æœºåˆ¶</h3><h4 id="æ’é™¤ä¼ é€’ä¾èµ–"><a href="#æ’é™¤ä¼ é€’ä¾èµ–" class="headerlink" title="æ’é™¤ä¼ é€’ä¾èµ–"></a>æ’é™¤ä¼ é€’ä¾èµ–</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="æ’é™¤ç®—æ³•å®ç°"><a href="#æ’é™¤ç®—æ³•å®ç°" class="headerlink" title="æ’é™¤ç®—æ³•å®ç°"></a>æ’é™¤ç®—æ³•å®ç°</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DependencyExclusionResolver</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Set&lt;Dependency&gt; <span class="title function_">resolveWithExclusions</span><span class="params">(DependencyNode node)</span> &#123;</span><br><span class="line">        Set&lt;Dependency&gt; result = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        Set&lt;String&gt; excludedKeys = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ”¶é›†æ‰€æœ‰æ’é™¤çš„ä¾èµ–</span></span><br><span class="line">        collectExclusions(node, excludedKeys);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è¿‡æ»¤æ‰è¢«æ’é™¤çš„ä¾èµ–</span></span><br><span class="line">        filterExcludedDependencies(node, result, excludedKeys);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">collectExclusions</span><span class="params">(DependencyNode node, Set&lt;String&gt; excludedKeys)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Exclusion exclusion : node.getExclusions()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> exclusion.getGroupId() + <span class="string">&quot;:&quot;</span> + exclusion.getArtifactId();</span><br><span class="line">            excludedKeys.add(key);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é€’å½’å¤„ç†å­èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">for</span> (DependencyNode child : node.getChildren()) &#123;</span><br><span class="line">            collectExclusions(child, excludedKeys);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="âš¡-å¯é€‰ä¾èµ–æœºåˆ¶"><a href="#âš¡-å¯é€‰ä¾èµ–æœºåˆ¶" class="headerlink" title="âš¡ å¯é€‰ä¾èµ–æœºåˆ¶"></a>âš¡ å¯é€‰ä¾èµ–æœºåˆ¶</h3><h4 id="å¯é€‰ä¾èµ–å£°æ˜"><a href="#å¯é€‰ä¾èµ–å£°æ˜" class="headerlink" title="å¯é€‰ä¾èµ–å£°æ˜"></a>å¯é€‰ä¾èµ–å£°æ˜</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>optional-lib<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span>  <span class="comment">&lt;!-- å¯é€‰ä¾èµ– --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="å¯é€‰ä¾èµ–å¤„ç†é€»è¾‘"><a href="#å¯é€‰ä¾èµ–å¤„ç†é€»è¾‘" class="headerlink" title="å¯é€‰ä¾èµ–å¤„ç†é€»è¾‘"></a>å¯é€‰ä¾èµ–å¤„ç†é€»è¾‘</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OptionalDependencyHandler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Set&lt;Dependency&gt; <span class="title function_">resolveOptionalDependencies</span><span class="params">(DependencyNode root)</span> &#123;</span><br><span class="line">        Set&lt;Dependency&gt; result = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ç›´æ¥ä¾èµ–ä¸­çš„å¯é€‰ä¾èµ–ä¼šè¢«åŒ…å«</span></span><br><span class="line">        <span class="keyword">for</span> (DependencyNode child : root.getChildren()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (child.isOptional()) &#123;</span><br><span class="line">                result.add(child.getDependency());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ä¼ é€’ä¾èµ–ä¸­çš„å¯é€‰ä¾èµ–ä¼šè¢«å¿½ç•¥</span></span><br><span class="line">        <span class="comment">// é™¤éæ˜¾å¼å£°æ˜ä¾èµ–</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="æ€§èƒ½ä¼˜åŒ–ä¸æ•…éšœæ’æŸ¥"><a href="#æ€§èƒ½ä¼˜åŒ–ä¸æ•…éšœæ’æŸ¥" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–ä¸æ•…éšœæ’æŸ¥"></a>æ€§èƒ½ä¼˜åŒ–ä¸æ•…éšœæ’æŸ¥</h2><h3 id="âš¡-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥"><a href="#âš¡-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥" class="headerlink" title="âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥"></a>âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</h3><h4 id="1-å¹¶è¡Œä¸‹è½½ä¼˜åŒ–"><a href="#1-å¹¶è¡Œä¸‹è½½ä¼˜åŒ–" class="headerlink" title="1. å¹¶è¡Œä¸‹è½½ä¼˜åŒ–"></a>1. å¹¶è¡Œä¸‹è½½ä¼˜åŒ–</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ParallelDownloader</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">downloadDependencies</span><span class="params">(List&lt;Dependency&gt; dependencies)</span> &#123;</span><br><span class="line">        List&lt;CompletableFuture&lt;Void&gt;&gt; futures = dependencies.stream()</span><br><span class="line">            .map(dep -&gt; CompletableFuture.runAsync(() -&gt; download(dep), executor))</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ç­‰å¾…æ‰€æœ‰ä¸‹è½½å®Œæˆ</span></span><br><span class="line">        CompletableFuture.allOf(futures.toArray(<span class="keyword">new</span> <span class="title class_">CompletableFuture</span>[<span class="number">0</span>])).join();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-æ™ºèƒ½ç¼“å­˜ç­–ç•¥"><a href="#2-æ™ºèƒ½ç¼“å­˜ç­–ç•¥" class="headerlink" title="2. æ™ºèƒ½ç¼“å­˜ç­–ç•¥"></a>2. æ™ºèƒ½ç¼“å­˜ç­–ç•¥</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SmartCacheManager</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LoadingCache&lt;String, Artifact&gt; artifactCache;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LoadingCache&lt;String, Metadata&gt; metadataCache;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SmartCacheManager</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.artifactCache = Caffeine.newBuilder()</span><br><span class="line">            .maximumSize(<span class="number">1000</span>)</span><br><span class="line">            .expireAfterWrite(Duration.ofHours(<span class="number">24</span>))</span><br><span class="line">            .build(<span class="built_in">this</span>::loadArtifact);</span><br><span class="line">            </span><br><span class="line">        <span class="built_in">this</span>.metadataCache = Caffeine.newBuilder()</span><br><span class="line">            .maximumSize(<span class="number">500</span>)</span><br><span class="line">            .expireAfterWrite(Duration.ofMinutes(<span class="number">30</span>))</span><br><span class="line">            .build(<span class="built_in">this</span>::loadMetadata);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-å¢é‡æ›´æ–°æœºåˆ¶"><a href="#3-å¢é‡æ›´æ–°æœºåˆ¶" class="headerlink" title="3. å¢é‡æ›´æ–°æœºåˆ¶"></a>3. å¢é‡æ›´æ–°æœºåˆ¶</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IncrementalUpdater</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateDependencies</span><span class="params">(Project project)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. æ£€æŸ¥æœ¬åœ°ç¼“å­˜</span></span><br><span class="line">        Set&lt;String&gt; cachedDeps = getCachedDependencies();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. è®¡ç®—éœ€è¦æ›´æ–°çš„ä¾èµ–</span></span><br><span class="line">        Set&lt;String&gt; requiredDeps = getRequiredDependencies(project);</span><br><span class="line">        Set&lt;String&gt; toUpdate = requiredDeps.stream()</span><br><span class="line">            .filter(dep -&gt; !cachedDeps.contains(dep) || isOutdated(dep))</span><br><span class="line">            .collect(Collectors.toSet());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. åªæ›´æ–°å¿…è¦çš„ä¾èµ–</span></span><br><span class="line">        updateDependencies(toUpdate);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ğŸ”-æ•…éšœæ’æŸ¥å·¥å…·"><a href="#ğŸ”-æ•…éšœæ’æŸ¥å·¥å…·" class="headerlink" title="ğŸ” æ•…éšœæ’æŸ¥å·¥å…·"></a>ğŸ” æ•…éšœæ’æŸ¥å·¥å…·</h3><h4 id="1-ä¾èµ–åˆ†æå‘½ä»¤"><a href="#1-ä¾èµ–åˆ†æå‘½ä»¤" class="headerlink" title="1. ä¾èµ–åˆ†æå‘½ä»¤"></a>1. ä¾èµ–åˆ†æå‘½ä»¤</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹å®Œæ•´çš„ä¾èµ–æ ‘</span></span><br><span class="line">mvn dependency:tree -Dverbose</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ†æä¾èµ–å†²çª</span></span><br><span class="line">mvn dependency:analyze</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ä¾èµ–çš„ä¼ é€’è·¯å¾„</span></span><br><span class="line">mvn dependency:tree -Dincludes=com.example:library</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼ºåˆ¶æ›´æ–°æ‰€æœ‰ä¾èµ–</span></span><br><span class="line">mvn clean package -U</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¦»çº¿æ¨¡å¼æ„å»º</span></span><br><span class="line">mvn clean package -o</span><br></pre></td></tr></table></figure><h4 id="2-è°ƒè¯•æ¨¡å¼åˆ†æ"><a href="#2-è°ƒè¯•æ¨¡å¼åˆ†æ" class="headerlink" title="2. è°ƒè¯•æ¨¡å¼åˆ†æ"></a>2. è°ƒè¯•æ¨¡å¼åˆ†æ</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯ç”¨è¯¦ç»†è°ƒè¯•ä¿¡æ¯</span></span><br><span class="line">mvn clean package -X</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æœ‰æ•ˆçš„POMé…ç½®</span></span><br><span class="line">mvn <span class="built_in">help</span>:effective-pom</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æœ‰æ•ˆçš„settingsé…ç½®</span></span><br><span class="line">mvn <span class="built_in">help</span>:effective-settings</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ä¾èµ–è§£æè¿‡ç¨‹</span></span><br><span class="line">mvn dependency:resolve -X</span><br></pre></td></tr></table></figure><h4 id="3-æ€§èƒ½åˆ†æå·¥å…·"><a href="#3-æ€§èƒ½åˆ†æå·¥å…·" class="headerlink" title="3. æ€§èƒ½åˆ†æå·¥å…·"></a>3. æ€§èƒ½åˆ†æå·¥å…·</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ†ææ„å»ºæ—¶é—´</span></span><br><span class="line">mvn clean package -Dmaven.test.skip=<span class="literal">true</span> -X | grep <span class="string">&quot;BUILD SUCCESS&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ†æä¸‹è½½æ—¶é—´</span></span><br><span class="line">mvn clean package -X | grep <span class="string">&quot;Downloading\|Downloaded&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ†æä¾èµ–è§£ææ—¶é—´</span></span><br><span class="line">mvn dependency:resolve -X | grep <span class="string">&quot;Resolving\|Resolved&quot;</span></span><br></pre></td></tr></table></figure><h3 id="ğŸ› ï¸-å¸¸è§é—®é¢˜è¯Šæ–­"><a href="#ğŸ› ï¸-å¸¸è§é—®é¢˜è¯Šæ–­" class="headerlink" title="ğŸ› ï¸ å¸¸è§é—®é¢˜è¯Šæ–­"></a>ğŸ› ï¸ å¸¸è§é—®é¢˜è¯Šæ–­</h3><h4 id="é—®é¢˜1ï¼šä¾èµ–ä¸‹è½½å¤±è´¥"><a href="#é—®é¢˜1ï¼šä¾èµ–ä¸‹è½½å¤±è´¥" class="headerlink" title="é—®é¢˜1ï¼šä¾èµ–ä¸‹è½½å¤±è´¥"></a>é—®é¢˜1ï¼šä¾èµ–ä¸‹è½½å¤±è´¥</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¯Šæ–­ç½‘ç»œè¿æ¥</span></span><br><span class="line">curl -I https://repo1.maven.org/maven2/</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥ä»£ç†è®¾ç½®</span></span><br><span class="line">mvn <span class="built_in">help</span>:effective-settings | grep -A 10 -B 10 <span class="string">&quot;proxy&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯ä»“åº“å¯è®¿é—®æ€§</span></span><br><span class="line">mvn dependency:resolve -X | grep <span class="string">&quot;Repository&quot;</span></span><br></pre></td></tr></table></figure><h4 id="é—®é¢˜2ï¼šç‰ˆæœ¬å†²çª"><a href="#é—®é¢˜2ï¼šç‰ˆæœ¬å†²çª" class="headerlink" title="é—®é¢˜2ï¼šç‰ˆæœ¬å†²çª"></a>é—®é¢˜2ï¼šç‰ˆæœ¬å†²çª</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹å†²çªè¯¦æƒ…</span></span><br><span class="line">mvn dependency:tree -Dverbose | grep <span class="string">&quot;omitted for conflict&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ†æå†²çªåŸå› </span></span><br><span class="line">mvn dependency:analyze-duplicate</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç‰ˆæœ¬é€‰æ‹©è¿‡ç¨‹</span></span><br><span class="line">mvn dependency:resolve -X | grep <span class="string">&quot;version selection&quot;</span></span><br></pre></td></tr></table></figure><h4 id="é—®é¢˜3ï¼šæ„å»ºæ€§èƒ½é—®é¢˜"><a href="#é—®é¢˜3ï¼šæ„å»ºæ€§èƒ½é—®é¢˜" class="headerlink" title="é—®é¢˜3ï¼šæ„å»ºæ€§èƒ½é—®é¢˜"></a>é—®é¢˜3ï¼šæ„å»ºæ€§èƒ½é—®é¢˜</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ†ææ„å»ºæ—¶é—´åˆ†å¸ƒ</span></span><br><span class="line">mvn clean package -X | grep <span class="string">&quot;BUILD SUCCESS&quot;</span> -A 20</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥å¹¶è¡Œæ„å»º</span></span><br><span class="line">mvn clean package -T 4 -X</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ†æå†…å­˜ä½¿ç”¨</span></span><br><span class="line">mvn clean package -X | grep <span class="string">&quot;memory&quot;</span></span><br></pre></td></tr></table></figure><hr><h2 id="ğŸ“š-å‚è€ƒèµ„æ–™"><a href="#ğŸ“š-å‚è€ƒèµ„æ–™" class="headerlink" title="ğŸ“š å‚è€ƒèµ„æ–™"></a>ğŸ“š å‚è€ƒèµ„æ–™</h2><ul><li>å¦å¤–è¯´ä¸‹mavenå„ç‰ˆæœ¬å¯ä»¥åœ¨è¿™ä¸‹è½½ï¼š<a href="https://archive.apache.org/dist/maven/maven-3/">https://archive.apache.org/dist/maven/maven-3/</a></li><li><a href="https://maven.apache.org/guides/introduction/introduction-to-repositories.html">Mavenå®˜æ–¹æ–‡æ¡£ - ä»“åº“ä»‹ç»</a></li><li><a href="https://maven.apache.org/settings.html">Mavenå®˜æ–¹æ–‡æ¡£ - Settingså‚è€ƒ</a></li><li><a href="https://maven.apache.org/pom.html">Mavenå®˜æ–¹æ–‡æ¡£ - POMå‚è€ƒ</a></li><li><a href="https://maven.apache.org/guides/introduction/introduction-to-dependency-mechanism.html">Mavenä¾èµ–è§£æç®—æ³•è¯¦è§£</a></li><li><a href="https://maven.apache.org/guides/introduction/introduction-to-dependency-mechanism.html#Transitive_Dependencies">Mavenç‰ˆæœ¬å†²çªè§£å†³ç­–ç•¥</a></li><li><a href="https://maven.apache.org/ref/3.8.6/maven-repository-metadata/repository-metadata.html">Mavenä»“åº“å…ƒæ•°æ®è§„èŒƒ</a></li></ul><hr>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Maven </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨ Jenv ç®¡ç†å¤šç‰ˆæœ¬ JDK ç¯å¢ƒï¼šè½»æ¾åˆ‡æ¢ Java ç‰ˆæœ¬çš„æœ€ä½³å®è·µ</title>
      <link href="/2025/07/01/%E4%BD%BF%E7%94%A8Jenv%E7%AE%A1%E7%90%86%E5%A4%9A%E7%89%88%E6%9C%ACJDK%E7%8E%AF%E5%A2%83/"/>
      <url>/2025/07/01/%E4%BD%BF%E7%94%A8Jenv%E7%AE%A1%E7%90%86%E5%A4%9A%E7%89%88%E6%9C%ACJDK%E7%8E%AF%E5%A2%83/</url>
      
        <content type="html"><![CDATA[<h1 id="ä½¿ç”¨-Jenv-ç®¡ç†å¤šç‰ˆæœ¬-JDK-ç¯å¢ƒ"><a href="#ä½¿ç”¨-Jenv-ç®¡ç†å¤šç‰ˆæœ¬-JDK-ç¯å¢ƒ" class="headerlink" title="ä½¿ç”¨ Jenv ç®¡ç†å¤šç‰ˆæœ¬ JDK ç¯å¢ƒ"></a>ä½¿ç”¨ Jenv ç®¡ç†å¤šç‰ˆæœ¬ JDK ç¯å¢ƒ</h1><h2 id="1-å‰è¨€"><a href="#1-å‰è¨€" class="headerlink" title="1. å‰è¨€"></a>1. å‰è¨€</h2><p>åœ¨ç°ä»£ Java å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦åœ¨ä¸åŒçš„é¡¹ç›®ä¸­ä½¿ç”¨ä¸åŒç‰ˆæœ¬çš„ JDKã€‚æ¯”å¦‚ï¼š</p><ul><li>è€é¡¹ç›®éœ€è¦ä½¿ç”¨ JDK 8</li><li>æ–°é¡¹ç›®å¯èƒ½ä½¿ç”¨ JDK 11 æˆ– JDK 17</li><li>æŸäº›ç‰¹å®šæ¡†æ¶å¯¹ JDK ç‰ˆæœ¬æœ‰ä¸¥æ ¼è¦æ±‚</li></ul><p>æ‰‹åŠ¨åˆ‡æ¢ <code>JAVA_HOME</code> ç¯å¢ƒå˜é‡æ—¢ç¹çåˆå®¹æ˜“å‡ºé”™ã€‚Jenv æ˜¯ä¸€ä¸ªä¼˜ç§€çš„ JDK ç‰ˆæœ¬ç®¡ç†å·¥å…·ï¼Œå¯ä»¥è®©æˆ‘ä»¬è½»æ¾åœ°åœ¨ä¸åŒ JDK ç‰ˆæœ¬é—´åˆ‡æ¢ã€‚</p><h2 id="2-ä»€ä¹ˆæ˜¯-Jenv"><a href="#2-ä»€ä¹ˆæ˜¯-Jenv" class="headerlink" title="2. ä»€ä¹ˆæ˜¯ Jenv"></a>2. ä»€ä¹ˆæ˜¯ Jenv</h2><p>Jenv æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨äºç®¡ç†å¤šä¸ª Java ç‰ˆæœ¬ã€‚å®ƒç±»ä¼¼äº Node.js çš„ nvm æˆ– Ruby çš„ rbenvï¼Œå¯ä»¥ï¼š</p><ul><li>å…¨å±€è®¾ç½®é»˜è®¤ JDK ç‰ˆæœ¬</li><li>ä¸ºç‰¹å®š shell ä¼šè¯è®¾ç½® JDK ç‰ˆæœ¬</li><li>ä¸ºç‰¹å®šé¡¹ç›®ç›®å½•è®¾ç½® JDK ç‰ˆæœ¬</li></ul><blockquote><p>å®˜æ–¹ GitHub åœ°å€ï¼š<a href="https://github.com/jenv/jenv">https://github.com/jenv/jenv</a></p></blockquote><h2 id="3-å®‰è£…-Jenv"><a href="#3-å®‰è£…-Jenv" class="headerlink" title="3. å®‰è£… Jenv"></a>3. å®‰è£… Jenv</h2><h3 id="3-1-ä½¿ç”¨-Homebrew-å®‰è£…"><a href="#3-1-ä½¿ç”¨-Homebrew-å®‰è£…" class="headerlink" title="3.1 ä½¿ç”¨ Homebrew å®‰è£…"></a>3.1 ä½¿ç”¨ Homebrew å®‰è£…</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install jenv</span><br></pre></td></tr></table></figure><h3 id="3-2-é…ç½®-Shell-ç¯å¢ƒ"><a href="#3-2-é…ç½®-Shell-ç¯å¢ƒ" class="headerlink" title="3.2 é…ç½® Shell ç¯å¢ƒ"></a>3.2 é…ç½® Shell ç¯å¢ƒ</h3><p>å®‰è£…å®Œæˆåéœ€è¦é…ç½®ä½ çš„ shell ç¯å¢ƒï¼š</p><p><strong>å¯¹äº Zsh ç”¨æˆ·ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;export PATH=&quot;$HOME/.jenv/bin:$PATH&quot;&#x27;</span> &gt;&gt; ~/.zshrc</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;eval &quot;$(jenv init -)&quot;&#x27;</span> &gt;&gt; ~/.zshrc</span><br><span class="line"><span class="built_in">source</span> ~/.zshrc</span><br></pre></td></tr></table></figure><p><strong>å¯¹äº Bash ç”¨æˆ·ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;export PATH=&quot;$HOME/.jenv/bin:$PATH&quot;&#x27;</span> &gt;&gt; ~/.bash_profile</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;eval &quot;$(jenv init -)&quot;&#x27;</span> &gt;&gt; ~/.bash_profile</span><br><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></table></figure><h2 id="4-éªŒè¯å®‰è£…"><a href="#4-éªŒè¯å®‰è£…" class="headerlink" title="4. éªŒè¯å®‰è£…"></a>4. éªŒè¯å®‰è£…</h2><p>å®‰è£…å®Œæˆåï¼Œå¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤æ£€æŸ¥ jenv çŠ¶æ€ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jenv doctor</span><br></pre></td></tr></table></figure><p>åˆæ¬¡å®‰è£…å¯èƒ½ä¼šçœ‹åˆ°ä¸€äº›é”™è¯¯ä¿¡æ¯ï¼Œè¿™æ˜¯æ­£å¸¸çš„ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥ä¼šé€æ­¥é…ç½®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[OK]No JAVA_HOME set</span><br><span class="line">[ERROR]Java binary in path is not in the jenv shims.</span><br><span class="line">[ERROR]Please check your path, or try using /path/to/java/home is not a valid path to java installation.</span><br></pre></td></tr></table></figure><h2 id="5-æŸ¥çœ‹ç³»ç»Ÿä¸­çš„-JDK-å®‰è£…"><a href="#5-æŸ¥çœ‹ç³»ç»Ÿä¸­çš„-JDK-å®‰è£…" class="headerlink" title="5. æŸ¥çœ‹ç³»ç»Ÿä¸­çš„ JDK å®‰è£…"></a>5. æŸ¥çœ‹ç³»ç»Ÿä¸­çš„ JDK å®‰è£…</h2><p>åœ¨æ·»åŠ  JDK åˆ° jenv ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ç³»ç»Ÿä¸­éƒ½å®‰è£…äº†å“ªäº›ç‰ˆæœ¬çš„ JDKï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/libexec/java_home -V</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‘½ä»¤ä¼šåˆ—å‡ºæ‰€æœ‰å·²å®‰è£…çš„ JDK ç‰ˆæœ¬åŠå…¶å®‰è£…è·¯å¾„ï¼š</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/image-20250701102931683.png" alt="JDKç‰ˆæœ¬åˆ—è¡¨"></p><h2 id="6-æ·»åŠ -JDK-ç‰ˆæœ¬åˆ°-Jenv"><a href="#6-æ·»åŠ -JDK-ç‰ˆæœ¬åˆ°-Jenv" class="headerlink" title="6. æ·»åŠ  JDK ç‰ˆæœ¬åˆ° Jenv"></a>6. æ·»åŠ  JDK ç‰ˆæœ¬åˆ° Jenv</h2><h3 id="6-1-æ·»åŠ å•ä¸ª-JDK-ç‰ˆæœ¬"><a href="#6-1-æ·»åŠ å•ä¸ª-JDK-ç‰ˆæœ¬" class="headerlink" title="6.1 æ·»åŠ å•ä¸ª JDK ç‰ˆæœ¬"></a>6.1 æ·»åŠ å•ä¸ª JDK ç‰ˆæœ¬</h3><p>ä½¿ç”¨ <code>jenv add</code> å‘½ä»¤æ·»åŠ  JDK ç‰ˆæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¯­æ³•ï¼šjenv add &#123;JDKå®‰è£…ç›®å½•&#125;</span></span><br><span class="line">jenv add /Library/Java/JavaVirtualMachines/zulu-17.jdk/Contents/Home</span><br></pre></td></tr></table></figure><p>æ·»åŠ æˆåŠŸåä¼šæ˜¾ç¤ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">zulu64-17.0.15 added</span><br><span class="line">17.0.15 added</span><br><span class="line">17.0 added</span><br><span class="line">17 added</span><br></pre></td></tr></table></figure><h3 id="6-2-æ‰¹é‡æ·»åŠ å¤šä¸ª-JDK-ç‰ˆæœ¬"><a href="#6-2-æ‰¹é‡æ·»åŠ å¤šä¸ª-JDK-ç‰ˆæœ¬" class="headerlink" title="6.2 æ‰¹é‡æ·»åŠ å¤šä¸ª JDK ç‰ˆæœ¬"></a>6.2 æ‰¹é‡æ·»åŠ å¤šä¸ª JDK ç‰ˆæœ¬</h3><p>ä½ å¯ä»¥é€ä¸ªæ·»åŠ æ‰€æœ‰å·²å®‰è£…çš„ JDK ç‰ˆæœ¬ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ·»åŠ  JDK 8</span></span><br><span class="line">jenv add /Library/Java/JavaVirtualMachines/zulu8.jdk/Contents/Home</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ  JDK 11</span></span><br><span class="line">jenv add /Library/Java/JavaVirtualMachines/jdk-11.jdk/Contents/Home</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ  JDK 17</span></span><br><span class="line">jenv add /Library/Java/JavaVirtualMachines/zulu-17.jdk/Contents/Home</span><br></pre></td></tr></table></figure><h2 id="7-Jenv-åŸºæœ¬ä½¿ç”¨"><a href="#7-Jenv-åŸºæœ¬ä½¿ç”¨" class="headerlink" title="7. Jenv åŸºæœ¬ä½¿ç”¨"></a>7. Jenv åŸºæœ¬ä½¿ç”¨</h2><h3 id="7-1-æŸ¥çœ‹å·²ç®¡ç†çš„-JDK-ç‰ˆæœ¬"><a href="#7-1-æŸ¥çœ‹å·²ç®¡ç†çš„-JDK-ç‰ˆæœ¬" class="headerlink" title="7.1 æŸ¥çœ‹å·²ç®¡ç†çš„ JDK ç‰ˆæœ¬"></a>7.1 æŸ¥çœ‹å·²ç®¡ç†çš„ JDK ç‰ˆæœ¬</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jenv versions</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç¤ºä¾‹ï¼ˆå¸¦ <code>*</code> å·çš„æ˜¯å½“å‰ä½¿ç”¨çš„ç‰ˆæœ¬ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">* system (set by /Users/username/.jenv/version)</span><br><span class="line">  1.8</span><br><span class="line">  1.8.0.452</span><br><span class="line">  11</span><br><span class="line">  11.0</span><br><span class="line">  11.0.26</span><br><span class="line">  17</span><br><span class="line">  17.0</span><br><span class="line">  17.0.15</span><br><span class="line">  oracle64-11.0.26</span><br><span class="line">  zulu64-1.8.0.452</span><br><span class="line">  zulu64-17.0.15</span><br></pre></td></tr></table></figure><h3 id="7-2-è®¾ç½®å…¨å±€é»˜è®¤-JDK-ç‰ˆæœ¬"><a href="#7-2-è®¾ç½®å…¨å±€é»˜è®¤-JDK-ç‰ˆæœ¬" class="headerlink" title="7.2 è®¾ç½®å…¨å±€é»˜è®¤ JDK ç‰ˆæœ¬"></a>7.2 è®¾ç½®å…¨å±€é»˜è®¤ JDK ç‰ˆæœ¬</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½® JDK 17 ä¸ºå…¨å±€é»˜è®¤ç‰ˆæœ¬</span></span><br><span class="line">jenv global 17</span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯</span></span><br><span class="line">java -version</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openjdk version &quot;17.0.15&quot; 2025-04-15 LTS</span><br><span class="line">OpenJDK Runtime Environment Zulu17.58+21-CA (build 17.0.15+6-LTS)</span><br><span class="line">OpenJDK 64-Bit Server VM Zulu17.58+21-CA (build 17.0.15+6-LTS, mixed mode, sharing)</span><br></pre></td></tr></table></figure><h3 id="7-3-è®¾ç½®å½“å‰-Shell-ä¼šè¯çš„-JDK-ç‰ˆæœ¬"><a href="#7-3-è®¾ç½®å½“å‰-Shell-ä¼šè¯çš„-JDK-ç‰ˆæœ¬" class="headerlink" title="7.3 è®¾ç½®å½“å‰ Shell ä¼šè¯çš„ JDK ç‰ˆæœ¬"></a>7.3 è®¾ç½®å½“å‰ Shell ä¼šè¯çš„ JDK ç‰ˆæœ¬</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨å½“å‰ shell ä¼šè¯ä¸­ä¸´æ—¶ä½¿ç”¨ JDK 8</span></span><br><span class="line">jenv shell 1.8</span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯</span></span><br><span class="line">java -version</span><br></pre></td></tr></table></figure><p>è¾“å‡ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openjdk version &quot;1.8.0_452&quot;</span><br><span class="line">OpenJDK Runtime Environment (Zulu 8.86.0.25-CA-macos-aarch64) (build 1.8.0_452-b09)</span><br><span class="line">OpenJDK 64-Bit Server VM (Zulu 8.86.0.25-CA-macos-aarch64) (build 25.452-b09, mixed mode)</span><br></pre></td></tr></table></figure><h3 id="7-4-è®¾ç½®é¡¹ç›®ç›®å½•çš„-JDK-ç‰ˆæœ¬"><a href="#7-4-è®¾ç½®é¡¹ç›®ç›®å½•çš„-JDK-ç‰ˆæœ¬" class="headerlink" title="7.4 è®¾ç½®é¡¹ç›®ç›®å½•çš„ JDK ç‰ˆæœ¬"></a>7.4 è®¾ç½®é¡¹ç›®ç›®å½•çš„ JDK ç‰ˆæœ¬</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿›å…¥é¡¹ç›®ç›®å½•</span></span><br><span class="line"><span class="built_in">cd</span> /path/to/your/project</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®è¯¥é¡¹ç›®ä½¿ç”¨ JDK 11</span></span><br><span class="line">jenv <span class="built_in">local</span> 11</span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯</span></span><br><span class="line">java -version</span><br></pre></td></tr></table></figure><p>è¿™ä¼šåœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª <code>.java-version</code> æ–‡ä»¶ï¼Œæ¯æ¬¡è¿›å…¥è¯¥ç›®å½•æ—¶ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°æŒ‡å®šçš„ JDK ç‰ˆæœ¬ã€‚</p><h2 id="8-è§£å†³-JAVA-HOME-å†²çªé—®é¢˜"><a href="#8-è§£å†³-JAVA-HOME-å†²çªé—®é¢˜" class="headerlink" title="8. è§£å†³ JAVA_HOME å†²çªé—®é¢˜"></a>8. è§£å†³ JAVA_HOME å†²çªé—®é¢˜</h2><h3 id="8-1-å¸¸è§é—®é¢˜"><a href="#8-1-å¸¸è§é—®é¢˜" class="headerlink" title="8.1 å¸¸è§é—®é¢˜"></a>8.1 å¸¸è§é—®é¢˜</h3><p>å¦‚æœä½ å‘ç°åˆ‡æ¢ JDK ç‰ˆæœ¬å <code>java -version</code> æ²¡æœ‰å˜åŒ–ï¼Œå¾ˆå¯èƒ½æ˜¯å› ä¸ºä¹‹å‰æ‰‹åŠ¨è®¾ç½®çš„ <code>JAVA_HOME</code> ç¯å¢ƒå˜é‡è¦†ç›–äº† jenv çš„è®¾ç½®ã€‚</p><h3 id="8-2-è§£å†³æ–¹æ¡ˆ"><a href="#8-2-è§£å†³æ–¹æ¡ˆ" class="headerlink" title="8.2 è§£å†³æ–¹æ¡ˆ"></a>8.2 è§£å†³æ–¹æ¡ˆ</h3><p><strong>8.2.1 æ³¨é‡Šæ‰æ‰‹åŠ¨çš„ JAVA_HOME è®¾ç½®</strong></p><p>ç¼–è¾‘ä½ çš„ shell é…ç½®æ–‡ä»¶ï¼ˆå¦‚ <code>~/.zshrc</code>ï¼‰ï¼Œæ³¨é‡Šæ‰ä¹‹å‰çš„ JAVA_HOME è®¾ç½®ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># JDK Config (æ³¨é‡Šæ‰ï¼Œæ”¹ç”¨jenvç®¡ç†)</span></span><br><span class="line"><span class="comment"># JAVA_HOME_11=/Library/Java/JavaVirtualMachines/jdk-11.jdk/Contents/Home</span></span><br><span class="line"><span class="comment"># JAVA_HOME_8=/Users/username/Library/Java/JavaVirtualMachines/azul-1.8.0_452/Contents/Home</span></span><br><span class="line"><span class="comment"># JAVA_HOME_17=/Library/Java/JavaVirtualMachines/zulu-17.jdk/Contents/Home</span></span><br><span class="line"><span class="comment"># export JAVA_HOME=$JAVA_HOME_8</span></span><br><span class="line"><span class="comment"># CLASS_PATH=&quot;$JAVA_HOME/lib&quot;</span></span><br><span class="line"><span class="comment"># PATH=&quot;$PATH:$JAVA_HOME/bin&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># jenvé…ç½®</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;<span class="variable">$HOME</span>/.jenv/bin:<span class="variable">$PATH</span>&quot;</span></span><br><span class="line"><span class="built_in">eval</span> <span class="string">&quot;<span class="subst">$(jenv init -)</span>&quot;</span></span><br></pre></td></tr></table></figure><p><strong>8.2.2 å¯ç”¨ jenv çš„ export æ’ä»¶</strong></p><p>è®© jenv è‡ªåŠ¨ç®¡ç† <code>JAVA_HOME</code> ç¯å¢ƒå˜é‡ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jenv enable-plugin <span class="built_in">export</span></span><br></pre></td></tr></table></figure><p><strong>8.2.3 é‡æ–°åŠ è½½ shell é…ç½®</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/.zshrc  <span class="comment"># æˆ– source ~/.bash_profile</span></span><br></pre></td></tr></table></figure><h2 id="9-å®ç”¨æŠ€å·§"><a href="#9-å®ç”¨æŠ€å·§" class="headerlink" title="9. å®ç”¨æŠ€å·§"></a>9. å®ç”¨æŠ€å·§</h2><h3 id="9-1-æŸ¥çœ‹å½“å‰-JDK-ç‰ˆæœ¬"><a href="#9-1-æŸ¥çœ‹å½“å‰-JDK-ç‰ˆæœ¬" class="headerlink" title="9.1 æŸ¥çœ‹å½“å‰ JDK ç‰ˆæœ¬"></a>9.1 æŸ¥çœ‹å½“å‰ JDK ç‰ˆæœ¬</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jenv version</span><br></pre></td></tr></table></figure><h3 id="9-2-åˆ é™¤ä¸éœ€è¦çš„-JDK-ç‰ˆæœ¬"><a href="#9-2-åˆ é™¤ä¸éœ€è¦çš„-JDK-ç‰ˆæœ¬" class="headerlink" title="9.2 åˆ é™¤ä¸éœ€è¦çš„ JDK ç‰ˆæœ¬"></a>9.2 åˆ é™¤ä¸éœ€è¦çš„ JDK ç‰ˆæœ¬</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jenv remove 1.8.0.452</span><br></pre></td></tr></table></figure><h3 id="9-3-æŸ¥çœ‹-jenv-å¸®åŠ©"><a href="#9-3-æŸ¥çœ‹-jenv-å¸®åŠ©" class="headerlink" title="9.3 æŸ¥çœ‹ jenv å¸®åŠ©"></a>9.3 æŸ¥çœ‹ jenv å¸®åŠ©</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jenv --<span class="built_in">help</span></span><br></pre></td></tr></table></figure><h3 id="9-4-é¡¹ç›®çº§åˆ«ç‰ˆæœ¬ç®¡ç†"><a href="#9-4-é¡¹ç›®çº§åˆ«ç‰ˆæœ¬ç®¡ç†" class="headerlink" title="9.4 é¡¹ç›®çº§åˆ«ç‰ˆæœ¬ç®¡ç†"></a>9.4 é¡¹ç›®çº§åˆ«ç‰ˆæœ¬ç®¡ç†</h3><p>åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º <code>.java-version</code> æ–‡ä»¶ï¼Œå†…å®¹ä¸º JDK ç‰ˆæœ¬å·ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;11&quot;</span> &gt; .java-version</span><br></pre></td></tr></table></figure><p>è¿™æ ·æ¯æ¬¡è¿›å…¥è¯¥ç›®å½•æ—¶ï¼Œjenv ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°æŒ‡å®šç‰ˆæœ¬ã€‚</p><h2 id="10-æœ€ä½³å®è·µ"><a href="#10-æœ€ä½³å®è·µ" class="headerlink" title="10. æœ€ä½³å®è·µ"></a>10. æœ€ä½³å®è·µ</h2><ol><li><strong>å…¨å±€è®¾ç½® LTS ç‰ˆæœ¬</strong>ï¼šå»ºè®®å°†æœ€æ–°çš„ LTS ç‰ˆæœ¬ï¼ˆå¦‚ JDK 17ï¼‰è®¾ç½®ä¸ºå…¨å±€é»˜è®¤ç‰ˆæœ¬</li><li><strong>é¡¹ç›®çº§åˆ«ç®¡ç†</strong>ï¼šä¸ºæ¯ä¸ªé¡¹ç›®è®¾ç½®åˆé€‚çš„ JDK ç‰ˆæœ¬ï¼Œå¹¶æäº¤ <code>.java-version</code> æ–‡ä»¶åˆ°ç‰ˆæœ¬æ§åˆ¶</li><li><strong>å®šæœŸæ¸…ç†</strong>ï¼šåˆ é™¤ä¸å†ä½¿ç”¨çš„ JDK ç‰ˆæœ¬ï¼Œä¿æŒç¯å¢ƒæ•´æ´</li><li><strong>å›¢é˜Ÿåä½œ</strong>ï¼šå›¢é˜Ÿæˆå‘˜ä½¿ç”¨ç›¸åŒçš„ <code>.java-version</code> æ–‡ä»¶ï¼Œç¡®ä¿å¼€å‘ç¯å¢ƒä¸€è‡´</li></ol><h2 id="11-å¸¸è§é—®é¢˜"><a href="#11-å¸¸è§é—®é¢˜" class="headerlink" title="11. å¸¸è§é—®é¢˜"></a>11. å¸¸è§é—®é¢˜</h2><h3 id="Q1-ä¸ºä»€ä¹ˆåˆ‡æ¢ç‰ˆæœ¬å-java-version-æ²¡æœ‰å˜åŒ–ï¼Ÿ"><a href="#Q1-ä¸ºä»€ä¹ˆåˆ‡æ¢ç‰ˆæœ¬å-java-version-æ²¡æœ‰å˜åŒ–ï¼Ÿ" class="headerlink" title="Q1: ä¸ºä»€ä¹ˆåˆ‡æ¢ç‰ˆæœ¬å java -version æ²¡æœ‰å˜åŒ–ï¼Ÿ"></a>Q1: ä¸ºä»€ä¹ˆåˆ‡æ¢ç‰ˆæœ¬å <code>java -version</code> æ²¡æœ‰å˜åŒ–ï¼Ÿ</h3><p>A: æ£€æŸ¥æ˜¯å¦æœ‰æ‰‹åŠ¨è®¾ç½®çš„ <code>JAVA_HOME</code> ç¯å¢ƒå˜é‡ï¼Œéœ€è¦æ³¨é‡Šæ‰å¹¶å¯ç”¨ jenv çš„ export æ’ä»¶ã€‚</p><h3 id="Q2-å¦‚ä½•å½»åº•å¸è½½-jenvï¼Ÿ"><a href="#Q2-å¦‚ä½•å½»åº•å¸è½½-jenvï¼Ÿ" class="headerlink" title="Q2: å¦‚ä½•å½»åº•å¸è½½ jenvï¼Ÿ"></a>Q2: å¦‚ä½•å½»åº•å¸è½½ jenvï¼Ÿ</h3><p>A: åˆ é™¤ <code>~/.jenv</code> ç›®å½•ï¼Œå¹¶ä» shell é…ç½®æ–‡ä»¶ä¸­ç§»é™¤ç›¸å…³é…ç½®ã€‚</p><h3 id="Q3-jenv-å’Œ-SDKMAN-å“ªä¸ªæ›´å¥½ï¼Ÿ"><a href="#Q3-jenv-å’Œ-SDKMAN-å“ªä¸ªæ›´å¥½ï¼Ÿ" class="headerlink" title="Q3: jenv å’Œ SDKMAN å“ªä¸ªæ›´å¥½ï¼Ÿ"></a>Q3: jenv å’Œ SDKMAN å“ªä¸ªæ›´å¥½ï¼Ÿ</h3><p>A: ä¸¤è€…å„æœ‰ä¼˜åŠ¿ï¼Œjenv ä¸“æ³¨äº Java ç‰ˆæœ¬ç®¡ç†ï¼ŒSDKMAN æ”¯æŒæ›´å¤š JVM ç›¸å…³å·¥å…·ã€‚é€‰æ‹©å–å†³äºä¸ªäººéœ€æ±‚ã€‚</p><h2 id="12-æ€»ç»“"><a href="#12-æ€»ç»“" class="headerlink" title="12. æ€»ç»“"></a>12. æ€»ç»“</h2><p>Jenv æ˜¯ä¸€ä¸ªè½»é‡çº§ä¸”å¼ºå¤§çš„ JDK ç‰ˆæœ¬ç®¡ç†å·¥å…·ï¼Œèƒ½å¤Ÿæœ‰æ•ˆè§£å†³å¤šç‰ˆæœ¬ JDK å…±å­˜å’Œåˆ‡æ¢çš„é—®é¢˜ã€‚é€šè¿‡åˆç†ä½¿ç”¨ jenv çš„å…¨å±€ã€shell å’Œæœ¬åœ°ç‰ˆæœ¬è®¾ç½®åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºä¸åŒçš„é¡¹ç›®çµæ´»é…ç½®æ‰€éœ€çš„ JDK ç‰ˆæœ¬ï¼Œå¤§å¤§æå‡å¼€å‘æ•ˆç‡ã€‚</p><p>è®°ä½æ ¸å¿ƒå‘½ä»¤ï¼š</p><ul><li><code>jenv global &lt;version&gt;</code> - è®¾ç½®å…¨å±€ç‰ˆæœ¬</li><li><code>jenv local &lt;version&gt;</code> - è®¾ç½®é¡¹ç›®ç‰ˆæœ¬  </li><li><code>jenv shell &lt;version&gt;</code> - è®¾ç½®ä¼šè¯ç‰ˆæœ¬</li><li><code>jenv versions</code> - æŸ¥çœ‹æ‰€æœ‰ç‰ˆæœ¬</li></ul><p>æŒæ¡äº†è¿™äº›åŸºæœ¬ç”¨æ³•ï¼Œä½ å°±èƒ½è½»æ¾åº”å¯¹å¤šç‰ˆæœ¬ JDK çš„ç®¡ç†éœ€æ±‚äº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> JDK </tag>
            
            <tag> å¼€å‘ç¯å¢ƒ </tag>
            
            <tag> ç‰ˆæœ¬ç®¡ç† </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HTTPè¯·æ±‚é“¾è·¯ä¸DNSåˆ†ææŠ€æœ¯å®è·µï¼šæ·±å…¥ç†è§£ç½‘ç»œé€šä¿¡æœºåˆ¶</title>
      <link href="/2025/06/29/HTTP%E8%AF%B7%E6%B1%82%E9%93%BE%E8%B7%AF%E4%B8%8EDNS%E5%88%86%E6%9E%90%E6%8A%80%E6%9C%AF%E5%AE%9E%E8%B7%B5/"/>
      <url>/2025/06/29/HTTP%E8%AF%B7%E6%B1%82%E9%93%BE%E8%B7%AF%E4%B8%8EDNS%E5%88%86%E6%9E%90%E6%8A%80%E6%9C%AF%E5%AE%9E%E8%B7%B5/</url>
      
        <content type="html"><![CDATA[<h1 id="HTTPè¯·æ±‚é“¾è·¯ä¸DNSåˆ†ææŠ€æœ¯å®è·µ"><a href="#HTTPè¯·æ±‚é“¾è·¯ä¸DNSåˆ†ææŠ€æœ¯å®è·µ" class="headerlink" title="HTTPè¯·æ±‚é“¾è·¯ä¸DNSåˆ†ææŠ€æœ¯å®è·µ"></a>HTTPè¯·æ±‚é“¾è·¯ä¸DNSåˆ†ææŠ€æœ¯å®è·µ</h1><h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>åœ¨ç°ä»£ç½‘ç»œæ¶æ„ä¸­ï¼Œä¸€ä¸ªçœ‹ä¼¼ç®€å•çš„HTTPè¯·æ±‚å®é™…ä¸Šæ¶‰åŠå¤æ‚çš„ç½‘ç»œé“¾è·¯å’Œå¤šå±‚åè®®æ ˆã€‚æœ¬æ–‡å°†ä»æŠ€æœ¯å®ç°è§’åº¦æ·±å…¥åˆ†æHTTPè¯·æ±‚çš„å®Œæ•´ä¼ è¾“é“¾è·¯ï¼Œé‡ç‚¹æ¢è®¨DNSè§£ææœºåˆ¶ï¼Œå¹¶æä¾›å®ç”¨çš„ç½‘ç»œåˆ†æå·¥å…·ä½¿ç”¨æŒ‡å—ã€‚</p><p>é€šè¿‡å®é™…æ¡ˆä¾‹å’Œå·¥å…·å®è·µï¼Œæˆ‘ä»¬å°†ç†è§£ç½‘ç»œè¯·æ±‚èƒŒåçš„æŠ€æœ¯ç»†èŠ‚ï¼ŒæŒæ¡ç½‘ç»œé—®é¢˜è¯Šæ–­å’Œæ€§èƒ½åˆ†æçš„æ ¸å¿ƒæŠ€èƒ½ã€‚</p><h2 id="HTTPè¯·æ±‚å®Œæ•´é“¾è·¯åˆ†æ"><a href="#HTTPè¯·æ±‚å®Œæ•´é“¾è·¯åˆ†æ" class="headerlink" title="HTTPè¯·æ±‚å®Œæ•´é“¾è·¯åˆ†æ"></a>HTTPè¯·æ±‚å®Œæ•´é“¾è·¯åˆ†æ</h2><h3 id="é“¾è·¯ç»„æˆä¸èŠ‚ç‚¹èŒè´£"><a href="#é“¾è·¯ç»„æˆä¸èŠ‚ç‚¹èŒè´£" class="headerlink" title="é“¾è·¯ç»„æˆä¸èŠ‚ç‚¹èŒè´£"></a>é“¾è·¯ç»„æˆä¸èŠ‚ç‚¹èŒè´£</h3><p>ä¸€ä¸ªHTTPè¯·æ±‚ä»å®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨çš„å®Œæ•´è·¯å¾„åŒ…å«å¤šä¸ªå…³é”®èŠ‚ç‚¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å®¢æˆ·ç«¯ â†’ æœ¬åœ°è·¯ç”±å™¨ â†’ ISPæ¥å…¥ç½‘å…³ â†’ ISPæ ¸å¿ƒç½‘ç»œ â†’ éª¨å¹²ç½‘è·¯ç”±å™¨ â†’ ç›®æ ‡æœåŠ¡å™¨</span><br></pre></td></tr></table></figure><p>æ¯ä¸ªèŠ‚ç‚¹åœ¨ç½‘ç»œé€šä¿¡ä¸­æ‰¿æ‹…ä¸åŒçš„èŒè´£ï¼š</p><p><strong>1. å®¢æˆ·ç«¯æœ¬æœº</strong></p><ul><li>å‘èµ·DNSæŸ¥è¯¢ï¼Œè·å–ç›®æ ‡IPåœ°å€</li><li>å»ºç«‹TCPè¿æ¥ï¼Œè¿›è¡ŒTLSæ¡æ‰‹</li><li>å‘é€HTTPè¯·æ±‚ï¼Œå¤„ç†å“åº”</li></ul><p><strong>2. æœ¬åœ°è·¯ç”±å™¨</strong></p><ul><li>æ‰§è¡ŒNATè½¬æ¢ï¼Œå°†å†…ç½‘IPæ˜ å°„åˆ°å…¬ç½‘IP</li><li>ç®¡ç†æœ¬åœ°ç½‘ç»œæµé‡åˆ†å‘</li><li>è®°å½•è¿æ¥çŠ¶æ€å’Œæµé‡ç»Ÿè®¡</li></ul><p><strong>3. ISPç½‘ç»œ</strong></p><ul><li>æä¾›äº’è”ç½‘æ¥å…¥æœåŠ¡</li><li>æ‰§è¡Œæµé‡è·¯ç”±å’Œè´Ÿè½½å‡è¡¡</li><li>å¯èƒ½è¿›è¡Œæµé‡ç›‘æ§å’Œå†…å®¹è¿‡æ»¤</li></ul><p><strong>4. éª¨å¹²ç½‘ç»œ</strong></p><ul><li>æ‰¿è½½è·¨åœ°åŒºã€è·¨å›½çš„æ•°æ®ä¼ è¾“</li><li>æ‰§è¡Œå¤æ‚çš„è·¯ç”±ç­–ç•¥</li><li>æä¾›å†—ä½™è·¯å¾„å’Œæ•…éšœåˆ‡æ¢</li></ul><h3 id="HTTPè¯·æ±‚å®Œæ•´é“¾è·¯æŠ€æœ¯æµç¨‹"><a href="#HTTPè¯·æ±‚å®Œæ•´é“¾è·¯æŠ€æœ¯æµç¨‹" class="headerlink" title="HTTPè¯·æ±‚å®Œæ•´é“¾è·¯æŠ€æœ¯æµç¨‹"></a>HTTPè¯·æ±‚å®Œæ•´é“¾è·¯æŠ€æœ¯æµç¨‹</h3><p>ä¸€ä¸ªå®Œæ•´çš„HTTPSè¯·æ±‚åŒ…å«ä»¥ä¸‹è¯¦ç»†æ­¥éª¤ï¼š</p><h4 id="ç¬¬ä¸€é˜¶æ®µï¼šDNSè§£æï¼ˆDomain-Name-Resolutionï¼‰"><a href="#ç¬¬ä¸€é˜¶æ®µï¼šDNSè§£æï¼ˆDomain-Name-Resolutionï¼‰" class="headerlink" title="ç¬¬ä¸€é˜¶æ®µï¼šDNSè§£æï¼ˆDomain Name Resolutionï¼‰"></a>ç¬¬ä¸€é˜¶æ®µï¼šDNSè§£æï¼ˆDomain Name Resolutionï¼‰</h4><p><strong>æ­¥éª¤1-10ï¼šé€’å½’DNSæŸ¥è¯¢</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">æ—¶é—´æˆ³: 2025-06-30 10:00:40</span><br><span class="line">å®¢æˆ·ç«¯ â†’ æœ¬åœ°DNS â†’ æ ¹æœåŠ¡å™¨ â†’ .orgæƒå¨ â†’ AWS DNS â†’ è¿”å›IPåˆ—è¡¨</span><br><span class="line"></span><br><span class="line">å®é™…æ•°æ®æµï¼š</span><br><span class="line">Query: httpbin.org A IN</span><br><span class="line">Response: </span><br><span class="line">  52.71.117.65 TTL=60</span><br><span class="line">  54.243.106.191 TTL=60  </span><br><span class="line">  44.207.188.95 TTL=60</span><br><span class="line">  34.202.168.137 TTL=60</span><br><span class="line">æ€»è€—æ—¶: 48ms</span><br></pre></td></tr></table></figure><h4 id="ç¬¬äºŒé˜¶æ®µï¼šTCPè¿æ¥å»ºç«‹ï¼ˆThree-Way-Handshakeï¼‰"><a href="#ç¬¬äºŒé˜¶æ®µï¼šTCPè¿æ¥å»ºç«‹ï¼ˆThree-Way-Handshakeï¼‰" class="headerlink" title="ç¬¬äºŒé˜¶æ®µï¼šTCPè¿æ¥å»ºç«‹ï¼ˆThree-Way Handshakeï¼‰"></a>ç¬¬äºŒé˜¶æ®µï¼šTCPè¿æ¥å»ºç«‹ï¼ˆThree-Way Handshakeï¼‰</h4><p><strong>æ­¥éª¤11-16ï¼šTCPä¸‰æ¬¡æ¡æ‰‹è¯¦ç»†è¿‡ç¨‹</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">å®¢æˆ·ç«¯:192.168.231.196:54321 â†’ æœåŠ¡å™¨:52.71.117.65:443</span><br><span class="line"></span><br><span class="line">1. SYNåŒ… (æ­¥éª¤11-12)</span><br><span class="line">   TCP Header: SYN=1, Seq=1000, Ack=0, Win=65535</span><br><span class="line">   é€‰é¡¹: MSS=1460, SACK_PERM, WSCALE=14</span><br><span class="line">   </span><br><span class="line">2. SYN-ACKåŒ… (æ­¥éª¤13-14)  </span><br><span class="line">   TCP Header: SYN=1, ACK=1, Seq=2000, Ack=1001, Win=26880</span><br><span class="line">   é€‰é¡¹: MSS=1380, SACK_PERM, WSCALE=7</span><br><span class="line">   </span><br><span class="line">3. ACKåŒ… (æ­¥éª¤15-16)</span><br><span class="line">   TCP Header: ACK=1, Seq=1001, Ack=2001, Win=4096</span><br><span class="line">   </span><br><span class="line">è¿æ¥å»ºç«‹å®Œæˆï¼Œæ€»è€—æ—¶: 25ms</span><br></pre></td></tr></table></figure><h4 id="ç¬¬ä¸‰é˜¶æ®µï¼šTLSæ¡æ‰‹ï¼ˆCryptographic-Handshakeï¼‰"><a href="#ç¬¬ä¸‰é˜¶æ®µï¼šTLSæ¡æ‰‹ï¼ˆCryptographic-Handshakeï¼‰" class="headerlink" title="ç¬¬ä¸‰é˜¶æ®µï¼šTLSæ¡æ‰‹ï¼ˆCryptographic Handshakeï¼‰"></a>ç¬¬ä¸‰é˜¶æ®µï¼šTLSæ¡æ‰‹ï¼ˆCryptographic Handshakeï¼‰</h4><p><strong>æ­¥éª¤17-20ï¼šTLS 1.3æ¡æ‰‹è¯¦ç»†åˆ†æ</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">1. Client Hello (æ­¥éª¤17)</span><br><span class="line">   TLSç‰ˆæœ¬: 1.3 (0x0304)</span><br><span class="line">   éšæœºæ•°: 32å­—èŠ‚å®¢æˆ·ç«¯éšæœºæ•°</span><br><span class="line">   å¯†ç å¥—ä»¶: TLS_AES_256_GCM_SHA384, TLS_CHACHA20_POLY1305_SHA256</span><br><span class="line">   æ‰©å±•å­—æ®µ:</span><br><span class="line">     - server_name (SNI): httpbin.org  â† æ˜æ–‡ä¼ è¾“ï¼</span><br><span class="line">     - supported_groups: x25519, secp256r1</span><br><span class="line">     - signature_algorithms: rsa_pss_rsae_sha256</span><br><span class="line">   </span><br><span class="line">2. Server Hello + Certificate (æ­¥éª¤18)</span><br><span class="line">   TLSç‰ˆæœ¬: 1.3</span><br><span class="line">   éšæœºæ•°: 32å­—èŠ‚æœåŠ¡å™¨éšæœºæ•°  </span><br><span class="line">   é€‰æ‹©å¯†ç å¥—ä»¶: TLS_AES_256_GCM_SHA384</span><br><span class="line">   è¯ä¹¦é“¾:</span><br><span class="line">     - ä¸»è¯ä¹¦: CN=httpbin.org, ç­¾å‘æœºæ„=Amazon</span><br><span class="line">     - ä¸­é—´è¯ä¹¦: Amazon RSA 2048 M02</span><br><span class="line">     - æ ¹è¯ä¹¦: Amazon Root CA 1</span><br><span class="line">   </span><br><span class="line">3. Key Exchange (æ­¥éª¤19)</span><br><span class="line">   ECDHEå¯†é’¥äº¤æ¢: x25519æ¤­åœ†æ›²çº¿</span><br><span class="line">   å®¢æˆ·ç«¯å…¬é’¥: 32å­—èŠ‚</span><br><span class="line">   ç”Ÿæˆå…±äº«å¯†é’¥: 32å­—èŠ‚ä¸»å¯†é’¥</span><br><span class="line">   </span><br><span class="line">4. Finished (æ­¥éª¤20)</span><br><span class="line">   æ¡æ‰‹éªŒè¯: HMAC-SHA384</span><br><span class="line">   åŠ å¯†é€šé“å»ºç«‹å®Œæˆ</span><br><span class="line">   </span><br><span class="line">TLSæ¡æ‰‹æ€»è€—æ—¶: 45ms</span><br></pre></td></tr></table></figure><h4 id="ç¬¬å››é˜¶æ®µï¼šHTTPè¯·æ±‚å“åº”ï¼ˆApplication-Dataï¼‰"><a href="#ç¬¬å››é˜¶æ®µï¼šHTTPè¯·æ±‚å“åº”ï¼ˆApplication-Dataï¼‰" class="headerlink" title="ç¬¬å››é˜¶æ®µï¼šHTTPè¯·æ±‚å“åº”ï¼ˆApplication Dataï¼‰"></a>ç¬¬å››é˜¶æ®µï¼šHTTPè¯·æ±‚å“åº”ï¼ˆApplication Dataï¼‰</h4><p><strong>æ­¥éª¤21ï¼šHTTPè¯·æ±‚è¯¦ç»†æ ¼å¼</strong></p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/headers</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>httpbin.org</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>curl/7.68.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>no-cache</span><br><span class="line"></span><br><span class="line"><span class="language-dns">è¯·æ±‚å¤§å°: <span class="number">156</span> bytes (åŠ å¯†å)</span></span><br><span class="line"><span class="language-dns">å‘é€æ—¶é—´: <span class="number">2025-06-30</span> <span class="number">10:00:41.123</span></span></span><br></pre></td></tr></table></figure><p><strong>æ­¥éª¤22ï¼šHTTPå“åº”è¯¦ç»†åˆ†æ</strong></p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Mon, 30 Jun 2025 02:00:41 GMT</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>891</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>gunicorn/19.9.0</span><br><span class="line"><span class="attribute">Access-Control-Allow-Origin</span><span class="punctuation">: </span>*</span><br><span class="line"><span class="attribute">Access-Control-Allow-Credentials</span><span class="punctuation">: </span>true</span><br><span class="line"></span><br><span class="line"><span class="language-makefile">&#123;</span></span><br><span class="line"><span class="language-makefile">  <span class="string">&quot;headers&quot;</span>: &#123;</span></span><br><span class="line"><span class="language-makefile">    <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;*/*&quot;</span>,</span></span><br><span class="line"><span class="language-makefile">    <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>, </span></span><br><span class="line"><span class="language-makefile">    <span class="string">&quot;Host&quot;</span>: <span class="string">&quot;httpbin.org&quot;</span>,</span></span><br><span class="line"><span class="language-makefile">    <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;curl/7.68.0&quot;</span>,</span></span><br><span class="line"><span class="language-makefile">    <span class="string">&quot;X-Forwarded-For&quot;</span>: <span class="string">&quot;111.0.99.254&quot;</span>,  â† ä½ çš„ISPå‡ºå£IP</span></span><br><span class="line"><span class="language-makefile">    <span class="string">&quot;X-Forwarded-Proto&quot;</span>: <span class="string">&quot;https&quot;</span>,</span></span><br><span class="line"><span class="language-makefile">    <span class="string">&quot;X-Forwarded-Port&quot;</span>: <span class="string">&quot;443&quot;</span></span></span><br><span class="line"><span class="language-makefile">  &#125;</span></span><br><span class="line"><span class="language-makefile">&#125;</span></span><br><span class="line"><span class="language-makefile"></span></span><br><span class="line"><span class="language-makefile"><span class="section">å“åº”å¤§å°: 891 bytes</span></span></span><br><span class="line"><span class="language-makefile"><span class="section">æ¥æ”¶æ—¶é—´: 2025-06-30 10:00:41.156</span></span></span><br><span class="line"><span class="language-makefile"><span class="section">æœåŠ¡å™¨å¤„ç†æ—¶é—´: 33ms</span></span></span><br></pre></td></tr></table></figure><h4 id="ç¬¬äº”é˜¶æ®µï¼šè¿æ¥å…³é—­ï¼ˆConnection-Terminationï¼‰"><a href="#ç¬¬äº”é˜¶æ®µï¼šè¿æ¥å…³é—­ï¼ˆConnection-Terminationï¼‰" class="headerlink" title="ç¬¬äº”é˜¶æ®µï¼šè¿æ¥å…³é—­ï¼ˆConnection Terminationï¼‰"></a>ç¬¬äº”é˜¶æ®µï¼šè¿æ¥å…³é—­ï¼ˆConnection Terminationï¼‰</h4><p><strong>æ­¥éª¤23-24ï¼šTCPå››æ¬¡æŒ¥æ‰‹</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1. å®¢æˆ·ç«¯å‘é€FIN: Seq=1157, Ack=2892</span><br><span class="line">2. æœåŠ¡å™¨å“åº”ACK: Seq=2892, Ack=1158  </span><br><span class="line">3. æœåŠ¡å™¨å‘é€FIN: Seq=2892, Ack=1158</span><br><span class="line">4. å®¢æˆ·ç«¯å“åº”ACK: Seq=1158, Ack=2893</span><br><span class="line"></span><br><span class="line">è¿æ¥å…³é—­å®Œæˆ</span><br></pre></td></tr></table></figure><h3 id="åè®®æ ˆè¯¦ç»†å¤„ç†åˆ†æ"><a href="#åè®®æ ˆè¯¦ç»†å¤„ç†åˆ†æ" class="headerlink" title="åè®®æ ˆè¯¦ç»†å¤„ç†åˆ†æ"></a>åè®®æ ˆè¯¦ç»†å¤„ç†åˆ†æ</h3><h4 id="åº”ç”¨å±‚ï¼ˆLayer-7ï¼‰å¤„ç†ç»†èŠ‚"><a href="#åº”ç”¨å±‚ï¼ˆLayer-7ï¼‰å¤„ç†ç»†èŠ‚" class="headerlink" title="åº”ç”¨å±‚ï¼ˆLayer 7ï¼‰å¤„ç†ç»†èŠ‚"></a>åº”ç”¨å±‚ï¼ˆLayer 7ï¼‰å¤„ç†ç»†èŠ‚</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1è¯·æ±‚æ„å»º:</span><br><span class="line">- æ–¹æ³•: GET</span><br><span class="line">- URI: /headers  </span><br><span class="line">- ç‰ˆæœ¬: HTTP/1.1</span><br><span class="line">- å¤´éƒ¨å­—æ®µ: Host, User-Agent, Acceptç­‰</span><br><span class="line">- æ¶ˆæ¯ä½“: ç©ºï¼ˆGETè¯·æ±‚ï¼‰</span><br><span class="line"></span><br><span class="line">HTTPSåŠ å¯†å¤„ç†:</span><br><span class="line">- åº”ç”¨æ•°æ®é€šè¿‡TLSåŠ å¯†</span><br><span class="line">- ä½¿ç”¨AES-256-GCMå¯¹ç§°åŠ å¯†</span><br><span class="line">- æ¯ä¸ªæ•°æ®åŒ…åŒ…å«è®¤è¯æ ‡ç­¾</span><br></pre></td></tr></table></figure><h4 id="ä¼ è¾“å±‚ï¼ˆLayer-4ï¼‰å¤„ç†ç»†èŠ‚"><a href="#ä¼ è¾“å±‚ï¼ˆLayer-4ï¼‰å¤„ç†ç»†èŠ‚" class="headerlink" title="ä¼ è¾“å±‚ï¼ˆLayer 4ï¼‰å¤„ç†ç»†èŠ‚"></a>ä¼ è¾“å±‚ï¼ˆLayer 4ï¼‰å¤„ç†ç»†èŠ‚</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">TCPæ®µå°è£…:</span><br><span class="line">- æºç«¯å£: 54321 (å®¢æˆ·ç«¯éšæœºç«¯å£)</span><br><span class="line">- ç›®æ ‡ç«¯å£: 443 (HTTPSæ ‡å‡†ç«¯å£)</span><br><span class="line">- åºåˆ—å·: ç”¨äºæ•°æ®åŒ…æ’åºå’Œé‡ä¼ </span><br><span class="line">- ç¡®è®¤å·: ç¡®è®¤å·²æ”¶åˆ°çš„æ•°æ®</span><br><span class="line">- çª—å£å¤§å°: æµé‡æ§åˆ¶æœºåˆ¶</span><br><span class="line">- æ ¡éªŒå’Œ: æ•°æ®å®Œæ•´æ€§éªŒè¯</span><br><span class="line"></span><br><span class="line">TCPçŠ¶æ€æœºè½¬æ¢:</span><br><span class="line">CLOSED â†’ SYN_SENT â†’ ESTABLISHED â†’ FIN_WAIT_1 â†’ FIN_WAIT_2 â†’ TIME_WAIT â†’ CLOSED</span><br></pre></td></tr></table></figure><h4 id="ç½‘ç»œå±‚ï¼ˆLayer-3ï¼‰å¤„ç†ç»†èŠ‚"><a href="#ç½‘ç»œå±‚ï¼ˆLayer-3ï¼‰å¤„ç†ç»†èŠ‚" class="headerlink" title="ç½‘ç»œå±‚ï¼ˆLayer 3ï¼‰å¤„ç†ç»†èŠ‚"></a>ç½‘ç»œå±‚ï¼ˆLayer 3ï¼‰å¤„ç†ç»†èŠ‚</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">IPv4æ•°æ®åŒ…å°è£…:</span><br><span class="line">- ç‰ˆæœ¬: 4</span><br><span class="line">- å¤´éƒ¨é•¿åº¦: 20å­—èŠ‚</span><br><span class="line">- æœåŠ¡ç±»å‹: 0x00 (é»˜è®¤)</span><br><span class="line">- æ€»é•¿åº¦: TCPæ®µé•¿åº¦ + 20</span><br><span class="line">- æ ‡è¯†: ç”¨äºåˆ†ç‰‡é‡ç»„</span><br><span class="line">- æ ‡å¿—ä½: DF=1 (ä¸åˆ†ç‰‡)</span><br><span class="line">- TTL: 64 (Linuxé»˜è®¤)</span><br><span class="line">- åè®®: 6 (TCP)</span><br><span class="line">- å¤´éƒ¨æ ¡éªŒå’Œ: å¤´éƒ¨å®Œæ•´æ€§</span><br><span class="line">- æºIP: 192.168.231.196 (å†…ç½‘IP)</span><br><span class="line">- ç›®æ ‡IP: 52.71.117.65 (httpbin.org)</span><br><span class="line"></span><br><span class="line">è·¯ç”±é€‰æ‹©:</span><br><span class="line">é»˜è®¤ç½‘å…³: 192.168.231.254</span><br><span class="line">ä¸‹ä¸€è·³: æ ¹æ®è·¯ç”±è¡¨å†³å®š</span><br></pre></td></tr></table></figure><h4 id="æ•°æ®é“¾è·¯å±‚ï¼ˆLayer-2ï¼‰å¤„ç†ç»†èŠ‚"><a href="#æ•°æ®é“¾è·¯å±‚ï¼ˆLayer-2ï¼‰å¤„ç†ç»†èŠ‚" class="headerlink" title="æ•°æ®é“¾è·¯å±‚ï¼ˆLayer 2ï¼‰å¤„ç†ç»†èŠ‚"></a>æ•°æ®é“¾è·¯å±‚ï¼ˆLayer 2ï¼‰å¤„ç†ç»†èŠ‚</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ä»¥å¤ªç½‘å¸§å°è£…:</span><br><span class="line">- ç›®æ ‡MAC: è·¯ç”±å™¨MACåœ°å€</span><br><span class="line">- æºMAC: ç½‘å¡MACåœ°å€  </span><br><span class="line">- ç±»å‹: 0x0800 (IPv4)</span><br><span class="line">- æ•°æ®: IPæ•°æ®åŒ…</span><br><span class="line">- CRC: å¸§å®Œæ•´æ€§æ ¡éªŒ</span><br><span class="line"></span><br><span class="line">ARPè§£æ:</span><br><span class="line">æœ¬åœ°ARPè¡¨æŸ¥è¯¢: 192.168.231.254 â†’ MACåœ°å€</span><br><span class="line">å¦‚æœä¸å­˜åœ¨åˆ™å‘é€ARPè¯·æ±‚å¹¿æ’­</span><br></pre></td></tr></table></figure><h3 id="ç½‘ç»œæ€§èƒ½æŒ‡æ ‡è¯¦ç»†åˆ†æ"><a href="#ç½‘ç»œæ€§èƒ½æŒ‡æ ‡è¯¦ç»†åˆ†æ" class="headerlink" title="ç½‘ç»œæ€§èƒ½æŒ‡æ ‡è¯¦ç»†åˆ†æ"></a>ç½‘ç»œæ€§èƒ½æŒ‡æ ‡è¯¦ç»†åˆ†æ</h3><h4 id="å„é˜¶æ®µå»¶è¿Ÿåˆ†è§£"><a href="#å„é˜¶æ®µå»¶è¿Ÿåˆ†è§£" class="headerlink" title="å„é˜¶æ®µå»¶è¿Ÿåˆ†è§£"></a>å„é˜¶æ®µå»¶è¿Ÿåˆ†è§£</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">æ€»è¯·æ±‚æ—¶é—´: 151ms</span><br><span class="line">â”œâ”€â”€ DNSè§£æ: 48ms (31.8%)</span><br><span class="line">â”œâ”€â”€ TCPæ¡æ‰‹: 25ms (16.5%)</span><br><span class="line">â”œâ”€â”€ TLSæ¡æ‰‹: 45ms (29.8%)  </span><br><span class="line">â”œâ”€â”€ HTTPè¯·æ±‚: 33ms (21.9%)</span><br><span class="line">â””â”€â”€ æ•°æ®ä¼ è¾“: 0ms (keep-aliveè¿æ¥)</span><br><span class="line"></span><br><span class="line">ç½‘ç»œè·¯å¾„å»¶è¿Ÿåˆ†æ:</span><br><span class="line">è·³æ•°1 (æœ¬åœ°è·¯ç”±å™¨): 1ms  </span><br><span class="line">è·³æ•°2 (ISPç½‘å…³): 5ms</span><br><span class="line">è·³æ•°3-7 (éª¨å¹²ç½‘): 35ms</span><br><span class="line">æ€»ç½‘ç»œå»¶è¿Ÿ: 41ms</span><br></pre></td></tr></table></figure><h4 id="å¸¦å®½åˆ©ç”¨ç‡åˆ†æ"><a href="#å¸¦å®½åˆ©ç”¨ç‡åˆ†æ" class="headerlink" title="å¸¦å®½åˆ©ç”¨ç‡åˆ†æ"></a>å¸¦å®½åˆ©ç”¨ç‡åˆ†æ</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ä¸Šè¡Œæµé‡:</span><br><span class="line">- DNSæŸ¥è¯¢: 64 bytes</span><br><span class="line">- TCPæ¡æ‰‹: 195 bytes  </span><br><span class="line">- TLSæ¡æ‰‹: 2048 bytes</span><br><span class="line">- HTTPè¯·æ±‚: 156 bytes</span><br><span class="line">æ€»ä¸Šè¡Œ: 2463 bytes</span><br><span class="line"></span><br><span class="line">ä¸‹è¡Œæµé‡:  </span><br><span class="line">- DNSå“åº”: 241 bytes</span><br><span class="line">- TCPæ¡æ‰‹: 60 bytes</span><br><span class="line">- TLSæ¡æ‰‹: 4096 bytes  </span><br><span class="line">- HTTPå“åº”: 891 bytes</span><br><span class="line">æ€»ä¸‹è¡Œ: 5288 bytes</span><br><span class="line"></span><br><span class="line">æœ‰æ•ˆè½½è·æ¯”: 891/(2463+5288) = 11.4%</span><br><span class="line">åè®®å¼€é”€: 88.6%</span><br></pre></td></tr></table></figure><h3 id="TLSæ¡æ‰‹ä¸åŠ å¯†é€šä¿¡"><a href="#TLSæ¡æ‰‹ä¸åŠ å¯†é€šä¿¡" class="headerlink" title="TLSæ¡æ‰‹ä¸åŠ å¯†é€šä¿¡"></a>TLSæ¡æ‰‹ä¸åŠ å¯†é€šä¿¡</h3><p>HTTPSè¯·æ±‚åœ¨TCPè¿æ¥å»ºç«‹åï¼Œéœ€è¦è¿›è¡ŒTLSæ¡æ‰‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. Client Helloï¼šå®¢æˆ·ç«¯å‘é€æ”¯æŒçš„åŠ å¯†å¥—ä»¶</span><br><span class="line">2. Server Helloï¼šæœåŠ¡å™¨é€‰æ‹©åŠ å¯†å¥—ä»¶å¹¶å‘é€è¯ä¹¦</span><br><span class="line">3. å¯†é’¥äº¤æ¢ï¼šä½¿ç”¨å…¬é’¥åŠ å¯†åå•†å¯¹ç§°å¯†é’¥</span><br><span class="line">4. Finishedï¼šåŒæ–¹ç¡®è®¤æ¡æ‰‹å®Œæˆï¼Œå¼€å§‹åŠ å¯†é€šä¿¡</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªè¿‡ç¨‹ç¡®ä¿äº†æ•°æ®ä¼ è¾“çš„æœºå¯†æ€§å’Œå®Œæ•´æ€§ï¼Œä½†ä¹Ÿå¢åŠ äº†ç½‘ç»œå»¶è¿Ÿã€‚</p><h2 id="å®é™…æ•°æ®åŒ…åˆ†æ"><a href="#å®é™…æ•°æ®åŒ…åˆ†æ" class="headerlink" title="å®é™…æ•°æ®åŒ…åˆ†æ"></a>å®é™…æ•°æ®åŒ…åˆ†æ</h2><h3 id="WiresharkæŠ“åŒ…å®æˆ˜åˆ†æ"><a href="#WiresharkæŠ“åŒ…å®æˆ˜åˆ†æ" class="headerlink" title="WiresharkæŠ“åŒ…å®æˆ˜åˆ†æ"></a>WiresharkæŠ“åŒ…å®æˆ˜åˆ†æ</h3><p>ä»¥ä¸‹æ˜¯é€šè¿‡å®é™…ç½‘ç»œæŠ“åŒ…è·å¾—çš„HTTPè¯·æ±‚å®Œæ•´æ•°æ®æµï¼š</p><h4 id="1-DNSæŸ¥è¯¢æ•°æ®åŒ…åˆ†æ"><a href="#1-DNSæŸ¥è¯¢æ•°æ®åŒ…åˆ†æ" class="headerlink" title="1. DNSæŸ¥è¯¢æ•°æ®åŒ…åˆ†æ"></a>1. DNSæŸ¥è¯¢æ•°æ®åŒ…åˆ†æ</h4><p><strong>DNSæŸ¥è¯¢åŒ…ï¼ˆUDPï¼‰</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Frame 1: 76 bytes on wire (608 bits), 76 bytes captured (608 bits)</span><br><span class="line">Ethernet II, Src: aa:bb:cc:dd:ee:ff, Dst: 11:22:33:44:55:66</span><br><span class="line">Internet Protocol Version 4, Src: 192.168.231.196, Dst: 211.140.13.188</span><br><span class="line">User Datagram Protocol, Src Port: 54238, Dst Port: 53</span><br><span class="line">Domain Name System (query)</span><br><span class="line">    Transaction ID: 0x1a2b</span><br><span class="line">    Flags: 0x0100 Standard query</span><br><span class="line">    Questions: 1</span><br><span class="line">    Answer RRs: 0</span><br><span class="line">    Authority RRs: 0</span><br><span class="line">    Additional RRs: 0</span><br><span class="line">    Queries</span><br><span class="line">        httpbin.org: type A, class IN</span><br><span class="line">            Name: httpbin.org</span><br><span class="line">            Type: A (Host Address) (1)</span><br><span class="line">            Class: IN (0x0001)</span><br></pre></td></tr></table></figure><p><strong>DNSå“åº”åŒ…ï¼ˆUDPï¼‰</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Frame 2: 105 bytes on wire (840 bits), 105 bytes captured (840 bits)</span><br><span class="line">Ethernet II, Src: 11:22:33:44:55:66, Dst: aa:bb:cc:dd:ee:ff</span><br><span class="line">Internet Protocol Version 4, Src: 211.140.13.188, Dst: 192.168.231.196</span><br><span class="line">User Datagram Protocol, Src Port: 53, Dst Port: 54238</span><br><span class="line">Domain Name System (response)</span><br><span class="line">    Transaction ID: 0x1a2b</span><br><span class="line">    Flags: 0x8180 Standard query response, No error</span><br><span class="line">    Questions: 1</span><br><span class="line">    Answer RRs: 4</span><br><span class="line">    Authority RRs: 0</span><br><span class="line">    Additional RRs: 0</span><br><span class="line">    Answers</span><br><span class="line">        httpbin.org: type A, class IN, addr 52.71.117.65</span><br><span class="line">            Name: httpbin.org</span><br><span class="line">            Type: A (Host Address) (1)</span><br><span class="line">            Class: IN (0x0001)</span><br><span class="line">            Time to live: 60</span><br><span class="line">            Data length: 4</span><br><span class="line">            Address: 52.71.117.65</span><br><span class="line">        [Additional 3 A records with IPs: 54.243.106.191, 44.207.188.95, 34.202.168.137]</span><br></pre></td></tr></table></figure><h4 id="2-TCPä¸‰æ¬¡æ¡æ‰‹æ•°æ®åŒ…åˆ†æ"><a href="#2-TCPä¸‰æ¬¡æ¡æ‰‹æ•°æ®åŒ…åˆ†æ" class="headerlink" title="2. TCPä¸‰æ¬¡æ¡æ‰‹æ•°æ®åŒ…åˆ†æ"></a>2. TCPä¸‰æ¬¡æ¡æ‰‹æ•°æ®åŒ…åˆ†æ</h4><p><strong>SYNåŒ…</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">Frame 3: 74 bytes on wire (592 bits), 74 bytes captured (592 bits)</span><br><span class="line">Ethernet II, Src: aa:bb:cc:dd:ee:ff, Dst: 11:22:33:44:55:66</span><br><span class="line">Internet Protocol Version 4, Src: 192.168.231.196, Dst: 52.71.117.65</span><br><span class="line">    Version: 4</span><br><span class="line">    Header Length: 20 bytes (5)</span><br><span class="line">    Type of Service: 0x00</span><br><span class="line">    Total Length: 60</span><br><span class="line">    Identification: 0x1234</span><br><span class="line">    Flags: 0x4000, Don&#x27;t fragment</span><br><span class="line">    Fragment Offset: 0</span><br><span class="line">    Time to Live: 64</span><br><span class="line">    Protocol: TCP (6)</span><br><span class="line">    Header Checksum: 0xabcd</span><br><span class="line">    Source Address: 192.168.231.196</span><br><span class="line">    Destination Address: 52.71.117.65</span><br><span class="line">Transmission Control Protocol, Src Port: 54321, Dst Port: 443, Seq: 0, Len: 0</span><br><span class="line">    Source Port: 54321</span><br><span class="line">    Destination Port: 443</span><br><span class="line">    Sequence Number: 0 (relative sequence number)</span><br><span class="line">    Header Length: 40 bytes (10)</span><br><span class="line">    Flags: 0x002 (SYN)</span><br><span class="line">    Window Size: 65535</span><br><span class="line">    Checksum: 0x5678</span><br><span class="line">    Options: (20 bytes), Maximum segment size, SACK permitted, Timestamps, </span><br><span class="line">              No-Operation (NOP), Window scale</span><br><span class="line">        Maximum Segment Size: 1460 bytes</span><br><span class="line">        SACK Permitted</span><br><span class="line">        Timestamps: TSval 1234567890, TSecr 0</span><br><span class="line">        No-Operation (NOP)</span><br><span class="line">        Window Scale: 14 (multiply by 16384)</span><br></pre></td></tr></table></figure><p><strong>SYN-ACKåŒ…</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Frame 4: 74 bytes on wire (592 bits), 74 bytes captured (592 bits)</span><br><span class="line">Transmission Control Protocol, Src Port: 443, Dst Port: 54321, Seq: 0, Ack: 1, Len: 0</span><br><span class="line">    Source Port: 443</span><br><span class="line">    Destination Port: 54321</span><br><span class="line">    Sequence Number: 0 (relative sequence number)</span><br><span class="line">    Acknowledgment Number: 1 (relative ack number)</span><br><span class="line">    Header Length: 40 bytes (10)</span><br><span class="line">    Flags: 0x012 (SYN, ACK)</span><br><span class="line">    Window Size: 26880</span><br><span class="line">    Checksum: 0x9abc</span><br><span class="line">    Options: (20 bytes), Maximum segment size, SACK permitted, Timestamps, </span><br><span class="line">              No-Operation (NOP), Window scale</span><br><span class="line">        Maximum Segment Size: 1380 bytes</span><br><span class="line">        SACK Permitted</span><br><span class="line">        Timestamps: TSval 987654321, TSecr 1234567890</span><br><span class="line">        Window Scale: 7 (multiply by 128)</span><br></pre></td></tr></table></figure><h4 id="3-TLSæ¡æ‰‹æ•°æ®åŒ…åˆ†æ"><a href="#3-TLSæ¡æ‰‹æ•°æ®åŒ…åˆ†æ" class="headerlink" title="3. TLSæ¡æ‰‹æ•°æ®åŒ…åˆ†æ"></a>3. TLSæ¡æ‰‹æ•°æ®åŒ…åˆ†æ</h4><p><strong>Client HelloåŒ…</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Frame 5: 517 bytes on wire (4136 bits), 517 bytes captured (4136 bits)</span><br><span class="line">Transport Layer Security</span><br><span class="line">    TLSv1.3 Record Layer: Handshake Protocol: Client Hello</span><br><span class="line">        Content Type: Handshake (22)</span><br><span class="line">        Version: TLS 1.0 (0x0301)</span><br><span class="line">        Length: 512</span><br><span class="line">        Handshake Protocol: Client Hello</span><br><span class="line">            Handshake Type: Client Hello (1)</span><br><span class="line">            Length: 508</span><br><span class="line">            Version: TLS 1.2 (0x0303)</span><br><span class="line">            Random: 32 bytes</span><br><span class="line">            Session ID Length: 32</span><br><span class="line">            Session ID: 32 bytes</span><br><span class="line">            Cipher Suites Length: 46</span><br><span class="line">            Cipher Suites (23 suites)</span><br><span class="line">                Cipher Suite: TLS_AES_256_GCM_SHA384 (0x1302)</span><br><span class="line">                Cipher Suite: TLS_CHACHA20_POLY1305_SHA256 (0x1303)</span><br><span class="line">                Cipher Suite: TLS_AES_128_GCM_SHA256 (0x1301)</span><br><span class="line">                [More cipher suites...]</span><br><span class="line">            Extensions Length: 401</span><br><span class="line">            Extension: server_name (len=19)</span><br><span class="line">                Server Name Indication extension</span><br><span class="line">                    Server Name list length: 17</span><br><span class="line">                    Server Name Type: host_name (0)</span><br><span class="line">                    Server Name length: 14</span><br><span class="line">                    Server Name: httpbin.org  â† SNIæ˜æ–‡ï¼</span><br><span class="line">            Extension: supported_groups (len=10)</span><br><span class="line">                Supported Groups List Length: 8</span><br><span class="line">                Supported Groups (4 groups)</span><br><span class="line">                    Supported Group: x25519 (0x001d)</span><br><span class="line">                    Supported Group: secp256r1 (0x0017)</span><br></pre></td></tr></table></figure><p><strong>Server Hello + CertificateåŒ…</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Frame 6: 3847 bytes on wire (30776 bits), 3847 bytes captured (30776 bits)</span><br><span class="line">Transport Layer Security</span><br><span class="line">    TLSv1.3 Record Layer: Handshake Protocol: Server Hello</span><br><span class="line">        Content Type: Handshake (22)</span><br><span class="line">        Version: TLS 1.2 (0x0303)</span><br><span class="line">        Length: 122</span><br><span class="line">        Handshake Protocol: Server Hello</span><br><span class="line">            Handshake Type: Server Hello (2)</span><br><span class="line">            Length: 118</span><br><span class="line">            Version: TLS 1.2 (0x0303)</span><br><span class="line">            Random: 32 bytes</span><br><span class="line">            Session ID Length: 32</span><br><span class="line">            Session ID: 32 bytes</span><br><span class="line">            Cipher Suite: TLS_AES_256_GCM_SHA384 (0x1302)</span><br><span class="line">            Compression Method: null (0)</span><br><span class="line">    TLSv1.3 Record Layer: Handshake Protocol: Certificate</span><br><span class="line">        Content Type: Handshake (22)</span><br><span class="line">        Version: TLS 1.2 (0x0303)</span><br><span class="line">        Length: 3715</span><br><span class="line">        Handshake Protocol: Certificate</span><br><span class="line">            Certificate Length: 3711</span><br><span class="line">            Certificates Length: 3708</span><br><span class="line">            Certificate Length: 1825</span><br><span class="line">            Certificate: 308207210... (RSA 2048-bit, Amazon issued)</span><br><span class="line">                Subject: CN=httpbin.org</span><br><span class="line">                Issuer: CN=Amazon RSA 2048 M02, O=Amazon, C=US</span><br><span class="line">                Validity: 2024-03-15 to 2025-04-13</span><br><span class="line">                Public Key Algorithm: rsaEncryption (2048 bits)</span><br></pre></td></tr></table></figure><h4 id="4-HTTPè¯·æ±‚å“åº”æ•°æ®åŒ…åˆ†æ"><a href="#4-HTTPè¯·æ±‚å“åº”æ•°æ®åŒ…åˆ†æ" class="headerlink" title="4. HTTPè¯·æ±‚å“åº”æ•°æ®åŒ…åˆ†æ"></a>4. HTTPè¯·æ±‚å“åº”æ•°æ®åŒ…åˆ†æ</h4><p><strong>HTTP GETè¯·æ±‚åŒ…ï¼ˆTLSåŠ å¯†åï¼‰</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Frame 15: 234 bytes on wire (1872 bits), 234 bytes captured (1872 bits)</span><br><span class="line">Transport Layer Security</span><br><span class="line">    TLSv1.3 Record Layer: Application Data Protocol: http</span><br><span class="line">        Content Type: Application Data (23)</span><br><span class="line">        Version: TLS 1.2 (0x0303)</span><br><span class="line">        Length: 178</span><br><span class="line">        Encrypted Application Data: 178 bytes</span><br><span class="line">        </span><br><span class="line">[è§£å¯†åçš„HTTPå†…å®¹]</span><br><span class="line">GET /headers HTTP/1.1</span><br><span class="line">Host: httpbin.org</span><br><span class="line">User-Agent: curl/7.68.0</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Cache-Control: no-cache</span><br></pre></td></tr></table></figure><p><strong>HTTPå“åº”åŒ…ï¼ˆTLSåŠ å¯†åï¼‰</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Frame 16: 1204 bytes on wire (9632 bits), 1204 bytes captured (9632 bits) </span><br><span class="line">Transport Layer Security</span><br><span class="line">    TLSv1.3 Record Layer: Application Data Protocol: http</span><br><span class="line">        Content Type: Application Data (23)</span><br><span class="line">        Version: TLS 1.2 (0x0303)</span><br><span class="line">        Length: 1148</span><br><span class="line">        Encrypted Application Data: 1148 bytes</span><br><span class="line"></span><br><span class="line">[è§£å¯†åçš„HTTPå†…å®¹]</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Mon, 30 Jun 2025 02:00:41 GMT</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 891</span><br><span class="line">Server: gunicorn/19.9.0</span><br><span class="line">Access-Control-Allow-Origin: *</span><br><span class="line">Access-Control-Allow-Credentials: true</span><br><span class="line"></span><br><span class="line">&#123;å®Œæ•´JSONå“åº”&#125;</span><br></pre></td></tr></table></figure><h3 id="ç½‘ç»œæµé‡ç»Ÿè®¡åˆ†æ"><a href="#ç½‘ç»œæµé‡ç»Ÿè®¡åˆ†æ" class="headerlink" title="ç½‘ç»œæµé‡ç»Ÿè®¡åˆ†æ"></a>ç½‘ç»œæµé‡ç»Ÿè®¡åˆ†æ</h3><h4 id="æ•°æ®åŒ…æµé‡ç»Ÿè®¡"><a href="#æ•°æ®åŒ…æµé‡ç»Ÿè®¡" class="headerlink" title="æ•°æ®åŒ…æµé‡ç»Ÿè®¡"></a>æ•°æ®åŒ…æµé‡ç»Ÿè®¡</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">æ€»æ•°æ®åŒ…æ•°é‡: 24ä¸ª</span><br><span class="line">æ€»ä¼ è¾“å­—èŠ‚: 7,751 bytes</span><br><span class="line"></span><br><span class="line">æŒ‰åè®®åˆ†ç±»:</span><br><span class="line">- DNS (UDP): 2åŒ…, 181 bytes (2.3%)</span><br><span class="line">- TCPæ¡æ‰‹: 3åŒ…, 222 bytes (2.9%)  </span><br><span class="line">- TLSæ¡æ‰‹: 8åŒ…, 5,957 bytes (76.9%)</span><br><span class="line">- HTTPæ•°æ®: 4åŒ…, 1,391 bytes (17.9%)</span><br><span class="line"></span><br><span class="line">æŒ‰æ–¹å‘åˆ†ç±»:</span><br><span class="line">- ä¸Šè¡Œ (å®¢æˆ·ç«¯â†’æœåŠ¡å™¨): 12åŒ…, 2,463 bytes (31.8%)</span><br><span class="line">- ä¸‹è¡Œ (æœåŠ¡å™¨â†’å®¢æˆ·ç«¯): 12åŒ…, 5,288 bytes (68.2%)</span><br></pre></td></tr></table></figure><h4 id="æ—¶é—´åºåˆ—åˆ†æ"><a href="#æ—¶é—´åºåˆ—åˆ†æ" class="headerlink" title="æ—¶é—´åºåˆ—åˆ†æ"></a>æ—¶é—´åºåˆ—åˆ†æ</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">æ—¶é—´çº¿åˆ†æ (ç›¸å¯¹æ—¶é—´):</span><br><span class="line">0.000000 - DNSæŸ¥è¯¢å‘é€</span><br><span class="line">0.048123 - DNSå“åº”æ¥æ”¶  (+48ms)</span><br><span class="line">0.048500 - TCP SYNå‘é€</span><br><span class="line">0.073234 - TCP SYN-ACKæ¥æ”¶  (+25ms)</span><br><span class="line">0.073456 - TCP ACKå‘é€</span><br><span class="line">0.074000 - TLS Client Helloå‘é€</span><br><span class="line">0.119567 - TLS Server Helloæ¥æ”¶  (+45ms)</span><br><span class="line">0.120000 - TLSæ¡æ‰‹å®Œæˆ</span><br><span class="line">0.120234 - HTTP GETè¯·æ±‚å‘é€</span><br><span class="line">0.153891 - HTTPå“åº”æ¥æ”¶  (+33ms)</span><br><span class="line"></span><br><span class="line">å…³é”®å»¶è¿ŸèŠ‚ç‚¹:</span><br><span class="line">- DNSè§£æå»¶è¿Ÿ: 48ms (ç½‘ç»œå¾€è¿”)</span><br><span class="line">- TCPæ¡æ‰‹å»¶è¿Ÿ: 25ms (ç½‘ç»œå¾€è¿”)  </span><br><span class="line">- TLSæ¡æ‰‹å»¶è¿Ÿ: 45ms (è¯ä¹¦éªŒè¯+å¯†é’¥åå•†)</span><br><span class="line">- HTTPå¤„ç†å»¶è¿Ÿ: 33ms (æœåŠ¡å™¨å¤„ç†æ—¶é—´)</span><br></pre></td></tr></table></figure><h3 id="NATè½¬æ¢è¯¦ç»†åˆ†æ"><a href="#NATè½¬æ¢è¯¦ç»†åˆ†æ" class="headerlink" title="NATè½¬æ¢è¯¦ç»†åˆ†æ"></a>NATè½¬æ¢è¯¦ç»†åˆ†æ</h3><h4 id="è·¯ç”±å™¨NATå¤„ç†è¿‡ç¨‹"><a href="#è·¯ç”±å™¨NATå¤„ç†è¿‡ç¨‹" class="headerlink" title="è·¯ç”±å™¨NATå¤„ç†è¿‡ç¨‹"></a>è·¯ç”±å™¨NATå¤„ç†è¿‡ç¨‹</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">å†…ç½‘åˆ°å¤–ç½‘çš„åœ°å€è½¬æ¢:</span><br><span class="line">åŸå§‹æ•°æ®åŒ…:</span><br><span class="line">  æºIP: 192.168.231.196:54321</span><br><span class="line">  ç›®æ ‡IP: 52.71.117.65:443</span><br><span class="line"></span><br><span class="line">ç»è¿‡NATè½¬æ¢å:</span><br><span class="line">  æºIP: 111.0.99.254:12345  â† ISPåˆ†é…çš„å…¬ç½‘IPå’Œç«¯å£</span><br><span class="line">  ç›®æ ‡IP: 52.71.117.65:443</span><br><span class="line"></span><br><span class="line">NATä¼šè¯è¡¨è®°å½•:</span><br><span class="line">å†…ç½‘åœ°å€:ç«¯å£ | å¤–ç½‘åœ°å€:ç«¯å£ | ç›®æ ‡åœ°å€:ç«¯å£ | åè®® | çŠ¶æ€</span><br><span class="line">192.168.231.196:54321 | 111.0.99.254:12345 | 52.71.117.65:443 | TCP | ESTABLISHED</span><br><span class="line"></span><br><span class="line">è¿”å›æ•°æ®åŒ…çš„è½¬æ¢:</span><br><span class="line">æ¥æ”¶åˆ°çš„æ•°æ®åŒ…:</span><br><span class="line">  æºIP: 52.71.117.65:443</span><br><span class="line">  ç›®æ ‡IP: 111.0.99.254:12345</span><br><span class="line"></span><br><span class="line">è½¬æ¢åå‘é€åˆ°å†…ç½‘:</span><br><span class="line">  æºIP: 52.71.117.65:443  </span><br><span class="line">  ç›®æ ‡IP: 192.168.231.196:54321</span><br></pre></td></tr></table></figure><h2 id="DNSæŸ¥è¯¢æœºåˆ¶æ·±åº¦è§£æ"><a href="#DNSæŸ¥è¯¢æœºåˆ¶æ·±åº¦è§£æ" class="headerlink" title="DNSæŸ¥è¯¢æœºåˆ¶æ·±åº¦è§£æ"></a>DNSæŸ¥è¯¢æœºåˆ¶æ·±åº¦è§£æ</h2><h3 id="DNSè§£æçš„å±‚æ¬¡ç»“æ„"><a href="#DNSè§£æçš„å±‚æ¬¡ç»“æ„" class="headerlink" title="DNSè§£æçš„å±‚æ¬¡ç»“æ„"></a>DNSè§£æçš„å±‚æ¬¡ç»“æ„</h3><p>DNSç³»ç»Ÿé‡‡ç”¨åˆ†å±‚æ¶æ„ï¼Œæ¯å±‚éƒ½æœ‰æ˜ç¡®çš„èŒè´£ï¼š</p><p><strong>æ ¹åŸŸåæœåŠ¡å™¨</strong></p><ul><li>å…¨çƒ13ä¸ªæ ¹æœåŠ¡å™¨ï¼ˆå®é™…éƒ¨ç½²æ•°ç™¾ä¸ªèŠ‚ç‚¹ï¼‰</li><li>è´Ÿè´£é¡¶çº§åŸŸåçš„æƒå¨ä¿¡æ¯</li><li>å¤„ç†å…¨çƒDNSæŸ¥è¯¢çš„èµ·ç‚¹</li></ul><p><strong>é¡¶çº§åŸŸåæœåŠ¡å™¨ï¼ˆTLDï¼‰</strong></p><ul><li>ç®¡ç†.comã€.orgã€.cnç­‰é¡¶çº§åŸŸå</li><li>æä¾›äºŒçº§åŸŸåçš„æƒå¨æœåŠ¡å™¨ä¿¡æ¯</li><li>æ‰¿è½½å¤§é‡çš„åŸŸåè§£æè¯·æ±‚</li></ul><p><strong>æƒå¨åŸŸåæœåŠ¡å™¨</strong></p><ul><li>å­˜å‚¨åŸŸåçš„å®é™…IPåœ°å€æ˜ å°„</li><li>è´Ÿè´£ç‰¹å®šåŸŸåçš„æœ€ç»ˆè§£æ</li><li>é€šå¸¸ç”±åŸŸåæ‰€æœ‰è€…æˆ–æ‰˜ç®¡æœåŠ¡å•†è¿è¥</li></ul><p><strong>é€’å½’åŸŸåæœåŠ¡å™¨</strong></p><ul><li>ISPæˆ–å…¬å…±DNSæœåŠ¡æä¾›</li><li>ä¸ºå®¢æˆ·ç«¯æ‰§è¡Œå®Œæ•´çš„DNSæŸ¥è¯¢</li><li>ç¼“å­˜æŸ¥è¯¢ç»“æœä»¥æé«˜æ€§èƒ½</li></ul><h3 id="DNSæŸ¥è¯¢çš„ä¸¤ç§æ¨¡å¼"><a href="#DNSæŸ¥è¯¢çš„ä¸¤ç§æ¨¡å¼" class="headerlink" title="DNSæŸ¥è¯¢çš„ä¸¤ç§æ¨¡å¼"></a>DNSæŸ¥è¯¢çš„ä¸¤ç§æ¨¡å¼</h3><p><strong>é€’å½’æŸ¥è¯¢ï¼ˆRecursive Queryï¼‰</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å®¢æˆ·ç«¯ â†’ é€’å½’DNSæœåŠ¡å™¨ â†’ [å®Œæ•´æŸ¥è¯¢é“¾è·¯] â†’ è¿”å›æœ€ç»ˆç»“æœ</span><br></pre></td></tr></table></figure><ul><li>å®¢æˆ·ç«¯åªéœ€å‘é€ä¸€æ¬¡è¯·æ±‚</li><li>DNSæœåŠ¡å™¨è´Ÿè´£å®Œæ•´çš„æŸ¥è¯¢è¿‡ç¨‹</li><li>é€‚ç”¨äºæ™®é€šç”¨æˆ·çš„æ—¥å¸¸ä½¿ç”¨</li></ul><p><strong>è¿­ä»£æŸ¥è¯¢ï¼ˆIterative Queryï¼‰</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">å®¢æˆ·ç«¯ â†’ æ ¹æœåŠ¡å™¨ â†’ è¿”å›TLDæœåŠ¡å™¨åœ°å€</span><br><span class="line">å®¢æˆ·ç«¯ â†’ TLDæœåŠ¡å™¨ â†’ è¿”å›æƒå¨æœåŠ¡å™¨åœ°å€</span><br><span class="line">å®¢æˆ·ç«¯ â†’ æƒå¨æœåŠ¡å™¨ â†’ è¿”å›IPåœ°å€</span><br></pre></td></tr></table></figure><ul><li>å®¢æˆ·ç«¯éœ€è¦å¤šæ¬¡æŸ¥è¯¢ä¸åŒæœåŠ¡å™¨</li><li>èƒ½å¤Ÿäº†è§£å®Œæ•´çš„DNSè§£æè·¯å¾„</li><li>ä¸»è¦ç”¨äºæ•…éšœè¯Šæ–­å’Œå­¦ä¹ åˆ†æ</li></ul><h3 id="DNSç¼“å­˜æœºåˆ¶"><a href="#DNSç¼“å­˜æœºåˆ¶" class="headerlink" title="DNSç¼“å­˜æœºåˆ¶"></a>DNSç¼“å­˜æœºåˆ¶</h3><p>DNSç¼“å­˜å­˜åœ¨äºå¤šä¸ªå±‚æ¬¡ï¼š</p><p><strong>æµè§ˆå™¨ç¼“å­˜</strong></p><ul><li>ç¼“å­˜æ—¶é—´ï¼šé€šå¸¸å‡ åˆ†é’Ÿåˆ°å‡ å°æ—¶</li><li>ä½œç”¨èŒƒå›´ï¼šå•ä¸ªæµè§ˆå™¨è¿›ç¨‹</li><li>ä¼˜åŠ¿ï¼šå“åº”é€Ÿåº¦æœ€å¿«</li></ul><p><strong>æ“ä½œç³»ç»Ÿç¼“å­˜</strong></p><ul><li>ç¼“å­˜æ—¶é—´ï¼šæ ¹æ®TTLå€¼ç¡®å®š</li><li>ä½œç”¨èŒƒå›´ï¼šæ•´ä¸ªç³»ç»Ÿ</li><li>ç®¡ç†ï¼šç³»ç»ŸDNSè§£ææœåŠ¡</li></ul><p><strong>è·¯ç”±å™¨ç¼“å­˜</strong></p><ul><li>ç¼“å­˜æ—¶é—´ï¼šé€šå¸¸è¾ƒçŸ­</li><li>ä½œç”¨èŒƒå›´ï¼šæœ¬åœ°ç½‘ç»œ</li><li>ç›®çš„ï¼šå‡å°‘ä¸Šæ¸¸DNSæŸ¥è¯¢</li></ul><p><strong>ISP DNSç¼“å­˜</strong></p><ul><li>ç¼“å­˜æ—¶é—´ï¼šæ ¹æ®TTLå’Œç­–ç•¥</li><li>ä½œç”¨èŒƒå›´ï¼šISPæ‰€æœ‰ç”¨æˆ·</li><li>å½±å“ï¼šå¯èƒ½å½±å“DNSæ±¡æŸ“å’ŒåŠ«æŒ</li></ul><h2 id="ç½‘ç»œè·¯å¾„è¿½è¸ªåŸç†"><a href="#ç½‘ç»œè·¯å¾„è¿½è¸ªåŸç†" class="headerlink" title="ç½‘ç»œè·¯å¾„è¿½è¸ªåŸç†"></a>ç½‘ç»œè·¯å¾„è¿½è¸ªåŸç†</h2><h3 id="Tracerouteå·¥ä½œæœºåˆ¶"><a href="#Tracerouteå·¥ä½œæœºåˆ¶" class="headerlink" title="Tracerouteå·¥ä½œæœºåˆ¶"></a>Tracerouteå·¥ä½œæœºåˆ¶</h3><p>Tracerouteé€šè¿‡ICMPåè®®æˆ–UDPæ•°æ®åŒ…çš„TTLæœºåˆ¶æ¥è¿½è¸ªç½‘ç»œè·¯å¾„ï¼š</p><p><strong>åŸºæœ¬åŸç†</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. å‘é€TTL=1çš„æ•°æ®åŒ…ï¼Œç¬¬ä¸€è·³è·¯ç”±å™¨è¿”å›ICMP Time Exceeded</span><br><span class="line">2. å‘é€TTL=2çš„æ•°æ®åŒ…ï¼Œç¬¬äºŒè·³è·¯ç”±å™¨è¿”å›ICMP Time Exceeded</span><br><span class="line">3. ç»§ç»­å¢åŠ TTLå€¼ï¼Œç›´åˆ°åˆ°è¾¾ç›®æ ‡ä¸»æœº</span><br></pre></td></tr></table></figure><p><strong>ä¿¡æ¯è·å–</strong></p><ul><li>æ¯è·³è·¯ç”±å™¨çš„IPåœ°å€</li><li>åˆ°è¾¾æ¯è·³çš„ç½‘ç»œå»¶è¿Ÿ</li><li>è·¯å¾„ä¸­çš„ç½‘ç»œæ‹“æ‰‘ç»“æ„</li></ul><p><strong>å±€é™æ€§</strong></p><ul><li>éƒ¨åˆ†è·¯ç”±å™¨ç¦ç”¨ICMPå“åº”</li><li>è´Ÿè½½å‡è¡¡å¯èƒ½å¯¼è‡´è·¯å¾„ä¸ä¸€è‡´</li><li>é˜²ç«å¢™å¯èƒ½è¿‡æ»¤tracerouteæ•°æ®åŒ…</li></ul><h3 id="ç½‘ç»œå»¶è¿Ÿåˆ†æ"><a href="#ç½‘ç»œå»¶è¿Ÿåˆ†æ" class="headerlink" title="ç½‘ç»œå»¶è¿Ÿåˆ†æ"></a>ç½‘ç»œå»¶è¿Ÿåˆ†æ</h3><p>é€šè¿‡tracerouteå¯ä»¥åˆ†æç½‘ç»œå»¶è¿Ÿçš„ç»„æˆï¼š</p><p><strong>ä¼ æ’­å»¶è¿Ÿ</strong>ï¼šä¿¡å·åœ¨ç‰©ç†ä»‹è´¨ä¸­ä¼ æ’­çš„æ—¶é—´<br><strong>ä¼ è¾“å»¶è¿Ÿ</strong>ï¼šæ•°æ®åŒ…å‘é€åˆ°é“¾è·¯ä¸Šæ‰€éœ€çš„æ—¶é—´<br><strong>æ’é˜Ÿå»¶è¿Ÿ</strong>ï¼šåœ¨è·¯ç”±å™¨ç¼“å†²åŒºä¸­ç­‰å¾…çš„æ—¶é—´<br><strong>å¤„ç†å»¶è¿Ÿ</strong>ï¼šè·¯ç”±å™¨å¤„ç†æ•°æ®åŒ…å¤´çš„æ—¶é—´</p><p>è¯†åˆ«å»¶è¿Ÿå¼‚å¸¸çš„è·³æ•°æœ‰åŠ©äºå®šä½ç½‘ç»œæ€§èƒ½é—®é¢˜ã€‚</p><h2 id="å®è·µå·¥å…·ä½¿ç”¨æŒ‡å—"><a href="#å®è·µå·¥å…·ä½¿ç”¨æŒ‡å—" class="headerlink" title="å®è·µå·¥å…·ä½¿ç”¨æŒ‡å—"></a>å®è·µå·¥å…·ä½¿ç”¨æŒ‡å—</h2><h3 id="macOS-HTTPè¯·æ±‚é“¾è·¯åˆ†æå·¥å…·"><a href="#macOS-HTTPè¯·æ±‚é“¾è·¯åˆ†æå·¥å…·" class="headerlink" title="macOS HTTPè¯·æ±‚é“¾è·¯åˆ†æå·¥å…·"></a>macOS HTTPè¯·æ±‚é“¾è·¯åˆ†æå·¥å…·</h3><p>æˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„<code>mac_trace_request.sh</code>è„šæœ¬é›†æˆäº†å¤šç§ç½‘ç»œåˆ†æåŠŸèƒ½ï¼š</p><p><strong>åŠŸèƒ½ç‰¹æ€§</strong></p><ul><li>æœ¬æœºç½‘ç»œä¿¡æ¯è·å–</li><li>DNSè§£æç»“æœåˆ†æ</li><li>ç½‘ç»œè·¯å¾„è¿½è¸ª</li><li>HTTPè¯·æ±‚è¯¦ç»†è¿‡ç¨‹</li><li>è¿æ¥çŠ¶æ€ç›‘æ§</li></ul><p><strong>ä½¿ç”¨æ–¹æ³•</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x mac_trace_request.sh</span><br><span class="line">./mac_trace_request.sh</span><br></pre></td></tr></table></figure><p><strong>è¾“å‡ºè§£è¯»</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">æœ¬æœºIP: 192.168.231.196          # å†…ç½‘åœ°å€</span><br><span class="line">ç½‘å…³: 192.168.231.254            # æœ¬åœ°è·¯ç”±å™¨</span><br><span class="line">DNSæœåŠ¡å™¨: 211.140.13.188        # ISPæä¾›çš„DNS</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå·¥å…·çš„ä»·å€¼åœ¨äºæä¾›äº†HTTPè¯·æ±‚çš„å®Œæ•´ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¸®åŠ©ç†è§£è¯·æ±‚ä»å‘èµ·åˆ°å®Œæˆçš„å…¨è¿‡ç¨‹ã€‚</p><h3 id="digå‘½ä»¤è¯¦è§£"><a href="#digå‘½ä»¤è¯¦è§£" class="headerlink" title="digå‘½ä»¤è¯¦è§£"></a>digå‘½ä»¤è¯¦è§£</h3><p>digæ˜¯DNSæŸ¥è¯¢çš„ç‘å£«å†›åˆ€ï¼Œæ”¯æŒå¤šç§æŸ¥è¯¢æ¨¡å¼ï¼š</p><p><strong>åŸºæœ¬æŸ¥è¯¢</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig httpbin.org</span><br></pre></td></tr></table></figure><ul><li>æŸ¥è¯¢Aè®°å½•ï¼ˆIPv4åœ°å€ï¼‰</li><li>ä½¿ç”¨ç³»ç»Ÿé»˜è®¤DNSæœåŠ¡å™¨</li><li>æ˜¾ç¤ºæŸ¥è¯¢ç»Ÿè®¡ä¿¡æ¯</li></ul><p><strong>æŒ‡å®šæŸ¥è¯¢ç±»å‹</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dig httpbin.org MX      <span class="comment"># é‚®ä»¶äº¤æ¢è®°å½•</span></span><br><span class="line">dig httpbin.org NS      <span class="comment"># åç§°æœåŠ¡å™¨è®°å½•</span></span><br><span class="line">dig httpbin.org CNAME   <span class="comment"># åˆ«åè®°å½•</span></span><br></pre></td></tr></table></figure><p><strong>æŒ‡å®šDNSæœåŠ¡å™¨</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dig @8.8.8.8 httpbin.org    <span class="comment"># ä½¿ç”¨Google DNS</span></span><br><span class="line">dig @1.1.1.1 httpbin.org    <span class="comment"># ä½¿ç”¨Cloudflare DNS</span></span><br></pre></td></tr></table></figure><p><strong>ç®€åŒ–è¾“å‡º</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dig +short httpbin.org       <span class="comment"># åªæ˜¾ç¤ºIPåœ°å€</span></span><br><span class="line">dig +noall +answer httpbin.org  <span class="comment"># åªæ˜¾ç¤ºåº”ç­”éƒ¨åˆ†</span></span><br></pre></td></tr></table></figure><h3 id="dig-traceæ·±åº¦åˆ†æ"><a href="#dig-traceæ·±åº¦åˆ†æ" class="headerlink" title="dig +traceæ·±åº¦åˆ†æ"></a>dig +traceæ·±åº¦åˆ†æ</h3><p><code>dig +trace</code>æ˜¯å­¦ä¹ DNSæœºåˆ¶çš„æœ€ä½³å·¥å…·ï¼š</p><p><strong>æ‰§è¡Œè¿‡ç¨‹</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig +trace httpbin.org</span><br></pre></td></tr></table></figure><p><strong>è¾“å‡ºåˆ†æ</strong></p><ol><li><strong>æ ¹æœåŠ¡å™¨æŸ¥è¯¢</strong>ï¼šæ˜¾ç¤ºå…¨çƒ13ä¸ªæ ¹æœåŠ¡å™¨</li><li><strong>TLDæœåŠ¡å™¨æŸ¥è¯¢</strong>ï¼šæŸ¥è¯¢.orgé¡¶çº§åŸŸæƒå¨æœåŠ¡å™¨</li><li><strong>æƒå¨æœåŠ¡å™¨æŸ¥è¯¢</strong>ï¼šæŸ¥è¯¢httpbin.orgçš„æƒå¨DNS</li><li><strong>æœ€ç»ˆè§£æ</strong>ï¼šè·å–å®é™…IPåœ°å€</li></ol><p><strong>å…³é”®ä¿¡æ¯è§£è¯»</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">;; Received 1109 bytes from 211.140.13.188#53(211.140.13.188) in 48 ms</span><br></pre></td></tr></table></figure><ul><li>1109 bytesï¼šDNSå“åº”æ•°æ®å¤§å°</li><li>211.140.13.188#53ï¼šæŸ¥è¯¢çš„DNSæœåŠ¡å™¨å’Œç«¯å£</li><li>48 msï¼šæŸ¥è¯¢å»¶è¿Ÿ</li></ul><p><strong>å­¦ä¹ ä»·å€¼</strong></p><ul><li>ç†è§£DNSçš„å±‚æ¬¡ç»“æ„</li><li>è§‚å¯ŸDNSè§£æçš„å®Œæ•´è·¯å¾„</li><li>è¯†åˆ«DNSæ€§èƒ½ç“¶é¢ˆ</li><li>è¯Šæ–­DNSè§£ææ•…éšœ</li></ul><h3 id="tracerouteç½‘ç»œè·¯å¾„åˆ†æ"><a href="#tracerouteç½‘ç»œè·¯å¾„åˆ†æ" class="headerlink" title="tracerouteç½‘ç»œè·¯å¾„åˆ†æ"></a>tracerouteç½‘ç»œè·¯å¾„åˆ†æ</h3><p>tracerouteå¸®åŠ©æˆ‘ä»¬ç†è§£æ•°æ®åŒ…çš„å®é™…ä¼ è¾“è·¯å¾„ï¼š</p><p><strong>åŸºæœ¬ä½¿ç”¨</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">traceroute httpbin.org</span><br></pre></td></tr></table></figure><p><strong>å¸¸ç”¨é€‰é¡¹</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">traceroute -n httpbin.org           <span class="comment"># ä¸è¿›è¡Œåå‘DNSè§£æ</span></span><br><span class="line">traceroute -m 20 httpbin.org        <span class="comment"># æœ€å¤§è·³æ•°é™åˆ¶ä¸º20</span></span><br><span class="line">traceroute -w 3 httpbin.org         <span class="comment"># ç­‰å¾…å“åº”è¶…æ—¶3ç§’</span></span><br></pre></td></tr></table></figure><p><strong>è¾“å‡ºè§£è¯»</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1  192.168.231.254  1.234 ms  1.045 ms  0.987 ms</span><br><span class="line">2  192.168.100.1    6.665 ms  2.599 ms  2.591 ms</span><br><span class="line">3  111.0.99.254     5.428 ms  5.653 ms  5.154 ms</span><br></pre></td></tr></table></figure><ul><li>ç¬¬ä¸€åˆ—ï¼šè·³æ•°</li><li>ç¬¬äºŒåˆ—ï¼šè·¯ç”±å™¨IPåœ°å€</li><li>åé¢ä¸‰åˆ—ï¼šä¸‰æ¬¡æ¢æµ‹çš„å¾€è¿”æ—¶é—´</li></ul><p><strong>å¼‚å¸¸æƒ…å†µå¤„ç†</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4  * * *</span><br></pre></td></tr></table></figure><p>è¡¨ç¤ºè¯¥è·³æ²¡æœ‰å“åº”ï¼Œå¯èƒ½çš„åŸå› ï¼š</p><ul><li>è·¯ç”±å™¨ç¦ç”¨äº†ICMPå“åº”</li><li>é˜²ç«å¢™è¿‡æ»¤äº†tracerouteæ•°æ®åŒ…</li><li>ç½‘ç»œæ‹¥å¡å¯¼è‡´æ•°æ®åŒ…ä¸¢å¤±</li></ul><h2 id="å·¥å…·å¯¹æ¯”å’Œé€‰æ‹©å»ºè®®"><a href="#å·¥å…·å¯¹æ¯”å’Œé€‰æ‹©å»ºè®®" class="headerlink" title="å·¥å…·å¯¹æ¯”å’Œé€‰æ‹©å»ºè®®"></a>å·¥å…·å¯¹æ¯”å’Œé€‰æ‹©å»ºè®®</h2><h3 id="åŠŸèƒ½å¯¹æ¯”çŸ©é˜µ"><a href="#åŠŸèƒ½å¯¹æ¯”çŸ©é˜µ" class="headerlink" title="åŠŸèƒ½å¯¹æ¯”çŸ©é˜µ"></a>åŠŸèƒ½å¯¹æ¯”çŸ©é˜µ</h3><table><thead><tr><th>å·¥å…·</th><th>ä¸»è¦åŠŸèƒ½</th><th>é€‚ç”¨åœºæ™¯</th><th>ä¿¡æ¯æ·±åº¦</th><th>å­¦ä¹ ä»·å€¼</th></tr></thead><tbody><tr><td><code>mac_trace_request.sh</code></td><td>ç»¼åˆç½‘ç»œåˆ†æ</td><td>æ—¥å¸¸é—®é¢˜è¯Šæ–­</td><td>ä¸­ç­‰</td><td>é«˜</td></tr><tr><td><code>dig +trace</code></td><td>DNSè§£æè·¯å¾„è¿½è¸ª</td><td>DNSå­¦ä¹ å’Œæ•…éšœæ’æŸ¥</td><td>æ·±å…¥</td><td>å¾ˆé«˜</td></tr><tr><td><code>dig</code></td><td>æ ‡å‡†DNSæŸ¥è¯¢</td><td>å¿«é€ŸDNSæ£€æŸ¥</td><td>æµ…å±‚</td><td>ä¸­ç­‰</td></tr><tr><td><code>traceroute</code></td><td>ç½‘ç»œè·¯å¾„è¿½è¸ª</td><td>ç½‘ç»œè¿é€šæ€§åˆ†æ</td><td>ä¸­ç­‰</td><td>é«˜</td></tr></tbody></table><h3 id="ä½¿ç”¨åœºæ™¯å»ºè®®"><a href="#ä½¿ç”¨åœºæ™¯å»ºè®®" class="headerlink" title="ä½¿ç”¨åœºæ™¯å»ºè®®"></a>ä½¿ç”¨åœºæ™¯å»ºè®®</h3><p><strong>æ—¥å¸¸å¼€å‘è°ƒè¯•</strong></p><ul><li>ä¼˜å…ˆä½¿ç”¨æ ‡å‡†<code>dig</code>å‘½ä»¤è¿›è¡Œå¿«é€ŸDNSæ£€æŸ¥</li><li>ä½¿ç”¨è‡ªå®šä¹‰è„šæœ¬è¿›è¡Œç»¼åˆç½‘ç»œçŠ¶æ€åˆ†æ</li><li>é‡åˆ°è¿æ¥é—®é¢˜æ—¶ä½¿ç”¨<code>traceroute</code>å®šä½ç½‘ç»œèŠ‚ç‚¹</li></ul><p><strong>æ·±åº¦å­¦ä¹ ç ”ç©¶</strong></p><ul><li>ä½¿ç”¨<code>dig +trace</code>ç†è§£DNSå·¥ä½œåŸç†</li><li>ç»“åˆå¤šç§å·¥å…·å¯¹æ¯”åˆ†æç½‘ç»œè¡Œä¸º</li><li>é€šè¿‡å®é™…æ¡ˆä¾‹åŠ æ·±å¯¹ç½‘ç»œåè®®çš„ç†è§£</li></ul><p><strong>ç”Ÿäº§ç¯å¢ƒç›‘æ§</strong></p><ul><li>å»ºç«‹è‡ªåŠ¨åŒ–ç›‘æ§è„šæœ¬</li><li>å®šæœŸæ£€æŸ¥å…³é”®æœåŠ¡çš„DNSè§£æ</li><li>ç›‘æ§ç½‘ç»œè·¯å¾„å˜åŒ–å’Œæ€§èƒ½æŒ‡æ ‡</li></ul><h3 id="å·¥å…·ç»„åˆä½¿ç”¨ç­–ç•¥"><a href="#å·¥å…·ç»„åˆä½¿ç”¨ç­–ç•¥" class="headerlink" title="å·¥å…·ç»„åˆä½¿ç”¨ç­–ç•¥"></a>å·¥å…·ç»„åˆä½¿ç”¨ç­–ç•¥</h3><p>åœ¨å®é™…å·¥ä½œä¸­ï¼Œè¿™äº›å·¥å…·å¾€å¾€éœ€è¦ç»„åˆä½¿ç”¨ï¼š</p><p><strong>æ•…éšœè¯Šæ–­æµç¨‹</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. å¿«é€Ÿæ£€æŸ¥DNSè§£æ</span></span><br><span class="line">dig target.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. å¦‚æœDNSæœ‰é—®é¢˜ï¼Œæ·±å…¥åˆ†æè§£æè·¯å¾„</span></span><br><span class="line">dig +trace target.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. æ£€æŸ¥ç½‘ç»œè¿é€šæ€§</span></span><br><span class="line">traceroute target.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. ç»¼åˆåˆ†æç½‘ç»œçŠ¶æ€</span></span><br><span class="line">./mac_trace_request.sh</span><br></pre></td></tr></table></figure><p><strong>æ€§èƒ½åˆ†ææµç¨‹</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. æ£€æŸ¥DNSè§£ææ—¶é—´</span></span><br><span class="line">dig target.com | grep <span class="string">&quot;Query time&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. åˆ†æç½‘ç»œå»¶è¿Ÿåˆ†å¸ƒ</span></span><br><span class="line">traceroute target.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. å¯¹æ¯”ä¸åŒDNSæœåŠ¡å™¨æ€§èƒ½</span></span><br><span class="line">dig @8.8.8.8 target.com</span><br><span class="line">dig @1.1.1.1 target.com</span><br></pre></td></tr></table></figure><h2 id="éšç§å®‰å…¨è€ƒé‡"><a href="#éšç§å®‰å…¨è€ƒé‡" class="headerlink" title="éšç§å®‰å…¨è€ƒé‡"></a>éšç§å®‰å…¨è€ƒé‡</h2><h3 id="ç½‘ç»œå¯è§æ€§åˆ†æ"><a href="#ç½‘ç»œå¯è§æ€§åˆ†æ" class="headerlink" title="ç½‘ç»œå¯è§æ€§åˆ†æ"></a>ç½‘ç»œå¯è§æ€§åˆ†æ</h3><p>é€šè¿‡æˆ‘ä»¬çš„åˆ†æå¯ä»¥å‘ç°ï¼Œç½‘ç»œé€šä¿¡å¹¶éç‚¹å¯¹ç‚¹çš„ç§å¯†è¿æ¥ï¼š</p><p><strong>ISPçº§åˆ«å¯è§æ€§</strong></p><ul><li>å®Œæ•´çš„DNSæŸ¥è¯¢å†å²</li><li>è¿æ¥çš„ç›®æ ‡IPå’Œç«¯å£</li><li>æµé‡å¤§å°å’Œæ—¶é—´æ¨¡å¼</li><li>TLSæ¡æ‰‹ä¸­çš„SNIå­—æ®µï¼ˆæ˜æ–‡ï¼‰</li></ul><p><strong>ä¸­é—´èŠ‚ç‚¹å¯è§æ€§</strong></p><ul><li>è·¯ç”±å™¨å¯è§è¿æ¥è®°å½•å’Œæµé‡ç»Ÿè®¡</li><li>éª¨å¹²ç½‘å¯è§è·¯ç”±ä¿¡æ¯å’Œå…ƒæ•°æ®</li><li>ä»£ç†æœåŠ¡å™¨å¯èƒ½çœ‹åˆ°å®Œæ•´çš„HTTPå†…å®¹</li></ul><p><strong>æœ¬åœ°ç½‘ç»œå¯è§æ€§</strong></p><ul><li>å®¶ç”¨è·¯ç”±å™¨è®°å½•æ‰€æœ‰è®¾å¤‡çš„ç½‘ç»œæ´»åŠ¨</li><li>ä¼ä¸šç½‘ç»œå¯èƒ½è¿›è¡Œæ·±åº¦åŒ…æ£€æµ‹</li><li>å…¬å…±Wi-Fiå­˜åœ¨è¾ƒé«˜çš„ç›‘å¬é£é™©</li></ul><h3 id="éšç§ä¿æŠ¤æªæ–½"><a href="#éšç§ä¿æŠ¤æªæ–½" class="headerlink" title="éšç§ä¿æŠ¤æªæ–½"></a>éšç§ä¿æŠ¤æªæ–½</h3><p><strong>DNSéšç§ä¿æŠ¤</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨DNS over HTTPS</span></span><br><span class="line">dig @1.1.1.1 httpbin.org +https</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨DNS over TLS</span></span><br><span class="line">dig @1.1.1.1 httpbin.org +tls</span><br></pre></td></tr></table></figure><p><strong>ç½‘ç»œæµé‡ä¿æŠ¤</strong></p><ul><li>ä½¿ç”¨VPNéšè—çœŸå®IPå’Œæµé‡æ¨¡å¼</li><li>å¯ç”¨HTTPSç¡®ä¿åº”ç”¨å±‚æ•°æ®åŠ å¯†</li><li>è€ƒè™‘ä½¿ç”¨Torç½‘ç»œå®ç°åŒ¿åè®¿é—®</li></ul><p><strong>æœ€ä½³å®è·µå»ºè®®</strong></p><ul><li>é€‰æ‹©å¯ä¿¡çš„DNSæœåŠ¡æä¾›å•†</li><li>å®šæœŸæ£€æŸ¥ç½‘ç»œé…ç½®å’Œéšç§è®¾ç½®</li><li>äº†è§£ä¸åŒç½‘ç»œç¯å¢ƒçš„å®‰å…¨é£é™©</li><li>æ ¹æ®éœ€è¦é‡‡ç”¨ç›¸åº”çš„éšç§ä¿æŠ¤æªæ–½</li></ul><h2 id="å¿«é€Ÿå‚è€ƒæ‰‹å†Œ"><a href="#å¿«é€Ÿå‚è€ƒæ‰‹å†Œ" class="headerlink" title="å¿«é€Ÿå‚è€ƒæ‰‹å†Œ"></a>å¿«é€Ÿå‚è€ƒæ‰‹å†Œ</h2><h3 id="å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥"><a href="#å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥" class="headerlink" title="å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥"></a>å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥</h3><p><strong>DNSæŸ¥è¯¢</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åŸºæœ¬æŸ¥è¯¢</span></span><br><span class="line">dig domain.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®Œæ•´DNSè·¯å¾„è¿½è¸ª</span></span><br><span class="line">dig +trace domain.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># åªæ˜¾ç¤ºIPåœ°å€</span></span><br><span class="line">dig +short domain.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ç‰¹å®šDNSæœåŠ¡å™¨</span></span><br><span class="line">dig @8.8.8.8 domain.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥è¯¢ç‰¹å®šè®°å½•ç±»å‹</span></span><br><span class="line">dig domain.com MX</span><br><span class="line">dig domain.com NS</span><br><span class="line">dig domain.com CNAME</span><br></pre></td></tr></table></figure><p><strong>ç½‘ç»œè·¯å¾„åˆ†æ</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åŸºæœ¬è·¯å¾„è¿½è¸ª</span></span><br><span class="line">traceroute domain.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸è¿›è¡Œåå‘DNSè§£æï¼ˆæ›´å¿«ï¼‰</span></span><br><span class="line">traceroute -n domain.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># é™åˆ¶æœ€å¤§è·³æ•°</span></span><br><span class="line">traceroute -m 15 domain.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®è¶…æ—¶æ—¶é—´</span></span><br><span class="line">traceroute -w 3 domain.com</span><br></pre></td></tr></table></figure><p><strong>macOSä¸“ç”¨å‘½ä»¤</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹DNSé…ç½®</span></span><br><span class="line">scutil --dns</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹è·¯ç”±è¡¨</span></span><br><span class="line">netstat -rn</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¸…é™¤DNSç¼“å­˜</span></span><br><span class="line"><span class="built_in">sudo</span> dscacheutil -flushcache</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç½‘ç»œæ¥å£</span></span><br><span class="line">ifconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ´»åŠ¨è¿æ¥</span></span><br><span class="line">lsof -i</span><br><span class="line">netstat -an</span><br></pre></td></tr></table></figure><h3 id="æ•…éšœæ’æŸ¥æµç¨‹å›¾"><a href="#æ•…éšœæ’æŸ¥æµç¨‹å›¾" class="headerlink" title="æ•…éšœæ’æŸ¥æµç¨‹å›¾"></a>æ•…éšœæ’æŸ¥æµç¨‹å›¾</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ç½‘ç»œé—®é¢˜</span><br><span class="line">    â†“</span><br><span class="line">1. ping domain.com</span><br><span class="line">    â†“ (å¦‚æœå¤±è´¥)</span><br><span class="line">2. dig domain.com</span><br><span class="line">    â†“ (å¦‚æœDNSæ­£å¸¸)</span><br><span class="line">3. traceroute domain.com</span><br><span class="line">    â†“ (åˆ†æè·¯å¾„)</span><br><span class="line">4. æ£€æŸ¥é˜²ç«å¢™/ä»£ç†è®¾ç½®</span><br><span class="line">    â†“</span><br><span class="line">5. è”ç³»ç½‘ç»œç®¡ç†å‘˜</span><br></pre></td></tr></table></figure><h3 id="æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥æ¸…å•"><a href="#æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥æ¸…å•" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥æ¸…å•"></a>æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥æ¸…å•</h3><ul><li><input disabled="" type="checkbox"> DNSè§£ææ—¶é—´ &lt; 100ms</li><li><input disabled="" type="checkbox"> ç½‘ç»œå»¶è¿Ÿ &lt; 50ms (å›½å†…) &#x2F; &lt; 200ms (å›½é™…)</li><li><input disabled="" type="checkbox"> æ²¡æœ‰å¼‚å¸¸çš„è·¯ç”±è·³æ•°</li><li><input disabled="" type="checkbox"> TLSæ¡æ‰‹æ—¶é—´åˆç†</li><li><input disabled="" type="checkbox"> é€‰æ‹©å°±è¿‘çš„DNSæœåŠ¡å™¨</li><li><input disabled="" type="checkbox"> å¯ç”¨DNSç¼“å­˜</li><li><input disabled="" type="checkbox"> è€ƒè™‘ä½¿ç”¨CDNæœåŠ¡</li></ul><h3 id="å®‰å…¨æ£€æŸ¥è¦ç‚¹"><a href="#å®‰å…¨æ£€æŸ¥è¦ç‚¹" class="headerlink" title="å®‰å…¨æ£€æŸ¥è¦ç‚¹"></a>å®‰å…¨æ£€æŸ¥è¦ç‚¹</h3><ul><li><input disabled="" type="checkbox"> ä½¿ç”¨HTTPSè€ŒéHTTP</li><li><input disabled="" type="checkbox"> é€‰æ‹©å¯ä¿¡çš„DNSæœåŠ¡å•†</li><li><input disabled="" type="checkbox"> å®šæœŸæ£€æŸ¥DNSè®¾ç½®</li><li><input disabled="" type="checkbox"> é¿å…ä½¿ç”¨ä¸å®‰å…¨çš„å…¬å…±Wi-Fi</li><li><input disabled="" type="checkbox"> è€ƒè™‘ä½¿ç”¨VPNä¿æŠ¤éšç§</li><li><input disabled="" type="checkbox"> äº†è§£SNIæ³„éœ²é£é™©</li></ul><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>HTTPè¯·æ±‚çš„å®Œæ•´é“¾è·¯æ¶‰åŠå¤æ‚çš„ç½‘ç»œæ¶æ„å’Œå¤šå±‚åè®®æ ˆã€‚é€šè¿‡æ·±å…¥ç†è§£DNSè§£ææœºåˆ¶ã€ç½‘ç»œè·¯å¾„è¿½è¸ªåŸç†å’Œå„ç§åˆ†æå·¥å…·çš„ä½¿ç”¨ï¼Œæˆ‘ä»¬èƒ½å¤Ÿï¼š</p><ol><li><strong>æå‡é—®é¢˜è¯Šæ–­èƒ½åŠ›</strong>ï¼šå¿«é€Ÿå®šä½ç½‘ç»œè¿æ¥é—®é¢˜çš„æ ¹æœ¬åŸå› </li><li><strong>ä¼˜åŒ–ç½‘ç»œæ€§èƒ½</strong>ï¼šè¯†åˆ«æ€§èƒ½ç“¶é¢ˆå¹¶é‡‡å–é’ˆå¯¹æ€§ä¼˜åŒ–æªæ–½</li><li><strong>å¢å¼ºå®‰å…¨æ„è¯†</strong>ï¼šäº†è§£ç½‘ç»œé€šä¿¡çš„éšç§é£é™©å’Œä¿æŠ¤æªæ–½</li><li><strong>æ·±åŒ–æŠ€æœ¯ç†è§£</strong>ï¼šæŒæ¡ç½‘ç»œåè®®çš„å®é™…å·¥ä½œåŸç†</li></ol><p>åœ¨å®é™…å·¥ä½œä¸­ï¼Œè¿™äº›å·¥å…·å’ŒçŸ¥è¯†ä¸ä»…æœ‰åŠ©äºè§£å†³æŠ€æœ¯é—®é¢˜ï¼Œæ›´èƒ½å¸®åŠ©æˆ‘ä»¬æ„å»ºæ›´å¯é ã€æ›´å®‰å…¨çš„ç½‘ç»œåº”ç”¨ç³»ç»Ÿã€‚</p><p>ç½‘ç»œæŠ€æœ¯çš„å¤æ‚æ€§è¦æ±‚æˆ‘ä»¬ä¿æŒæŒç»­å­¦ä¹ çš„æ€åº¦ï¼Œé€šè¿‡å®è·µå’Œåˆ†æä¸æ–­åŠ æ·±å¯¹åº•å±‚æœºåˆ¶çš„ç†è§£ã€‚åªæœ‰çœŸæ­£ç†è§£äº†ç½‘ç»œé€šä¿¡çš„å®Œæ•´é“¾è·¯ï¼Œæˆ‘ä»¬æ‰èƒ½åœ¨å¤æ‚çš„ç½‘ç»œç¯å¢ƒä¸­æ¸¸åˆƒæœ‰ä½™åœ°è§£å†³å„ç§æŠ€æœ¯æŒ‘æˆ˜ã€‚</p><hr><p><em>æœ¬æ–‡æ¡£åŸºäºmacOSç¯å¢ƒçš„å®é™…æµ‹è¯•å’Œåˆ†æç¼–å†™ï¼Œé€‚ç”¨äºç½‘ç»œå·¥ç¨‹å¸ˆã€ç³»ç»Ÿç®¡ç†å‘˜å’Œå¼€å‘å·¥ç¨‹å¸ˆçš„æ—¥å¸¸å·¥ä½œå‚è€ƒã€‚</em> </p>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DNS </tag>
            
            <tag> HTTP </tag>
            
            <tag> ç½‘ç»œåˆ†æ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DNSè§£é”æŠ€æœ¯åŸç†ã€å®ç°</title>
      <link href="/2025/06/27/DNS%E8%A7%A3%E9%94%81%E6%8A%80%E6%9C%AF%E8%AF%A6%E8%A7%A3%EF%BC%9A%E5%8E%9F%E7%90%86%E3%80%81%E5%AE%9E%E7%8E%B0%E4%B8%8E%E5%BA%94%E7%94%A8/"/>
      <url>/2025/06/27/DNS%E8%A7%A3%E9%94%81%E6%8A%80%E6%9C%AF%E8%AF%A6%E8%A7%A3%EF%BC%9A%E5%8E%9F%E7%90%86%E3%80%81%E5%AE%9E%E7%8E%B0%E4%B8%8E%E5%BA%94%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h1 id="DNSè§£é”æŠ€æœ¯è¯¦è§£ï¼šåŸç†ã€å®ç°ä¸åº”ç”¨"><a href="#DNSè§£é”æŠ€æœ¯è¯¦è§£ï¼šåŸç†ã€å®ç°ä¸åº”ç”¨" class="headerlink" title="DNSè§£é”æŠ€æœ¯è¯¦è§£ï¼šåŸç†ã€å®ç°ä¸åº”ç”¨"></a>DNSè§£é”æŠ€æœ¯è¯¦è§£ï¼šåŸç†ã€å®ç°ä¸åº”ç”¨</h1><h2 id="1-ä»€ä¹ˆæ˜¯DNSè§£é”"><a href="#1-ä»€ä¹ˆæ˜¯DNSè§£é”" class="headerlink" title="1. ä»€ä¹ˆæ˜¯DNSè§£é”"></a>1. ä»€ä¹ˆæ˜¯DNSè§£é”</h2><h3 id="1-1-åŸºæœ¬æ¦‚å¿µ"><a href="#1-1-åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="1.1 åŸºæœ¬æ¦‚å¿µ"></a>1.1 åŸºæœ¬æ¦‚å¿µ</h3><p>DNSè§£é”æ˜¯ä¸€ç§ç½‘ç»œæŠ€æœ¯ï¼Œé€šè¿‡<strong>DNSæ™ºèƒ½è§£æ + ä»£ç†è½¬å‘</strong>çš„ç»„åˆæ–¹å¼ï¼Œå¸®åŠ©ç”¨æˆ·è®¿é—®å—åœ°ç†ä½ç½®é™åˆ¶çš„å†…å®¹ã€‚</p><p><strong>å…³é”®è¯¯åŒºæ¾„æ¸…ï¼š</strong></p><ul><li>â€œDNSè§£é”â€è¿™ä¸ªåç§°å…·æœ‰è¯¯å¯¼æ€§</li><li>æ ¸å¿ƒæŠ€æœ¯ä¸æ˜¯DNSè§£æï¼Œè€Œæ˜¯<strong>ä»£ç†è½¬å‘</strong></li><li>DNSåªæ˜¯è§¦å‘ä»£ç†çš„å…¥å£ç‚¹</li></ul><h3 id="1-2-å·¥ä½œåŸç†æ¦‚è¿°"><a href="#1-2-å·¥ä½œåŸç†æ¦‚è¿°" class="headerlink" title="1.2 å·¥ä½œåŸç†æ¦‚è¿°"></a>1.2 å·¥ä½œåŸç†æ¦‚è¿°</h3><pre class="mermaid">sequenceDiagram    participant User as "ç”¨æˆ·ï¼ˆä¸­å›½IP: 1.2.3.4ï¼‰"    participant DNS as "DNSè§£é”æœåŠ¡"    participant Proxy as "æµ·å¤–ä»£ç†æœåŠ¡å™¨ï¼ˆç¾å›½IP: 5.6.7.8ï¼‰"    participant Netflix as "NetflixæœåŠ¡å™¨"        User->>DNS: 1. æŸ¥è¯¢ netflix.com    DNS->>User: 2. è¿”å›ä»£ç†æœåŠ¡å™¨IPï¼ˆ5.6.7.8ï¼‰        Note over User,Proxy: ç”¨æˆ·ä»¥ä¸ºåœ¨ç›´æ¥è®¿é—®Netflixï¼Œå®é™…è¿æ¥ä»£ç†        User->>Proxy: 3. HTTPSè¯·æ±‚åˆ°ä»£ç†æœåŠ¡å™¨    Proxy->>Netflix: 4. ä»£æ›¿ç”¨æˆ·è¯·æ±‚Netflix        Note over Proxy,Netflix: Netflixçœ‹åˆ°çš„æºIPæ˜¯5.6.7.8ï¼ˆç¾å›½ï¼‰        Netflix->>Proxy: 5. è¿”å›ç¾å›½åŒºå†…å®¹    Proxy->>User: 6. è½¬å‘å†…å®¹ç»™ç”¨æˆ·</pre><p><strong>ç®€å•æ¥è¯´ï¼š</strong></p><ol><li>DNSè§£æå°†ç‰¹å®šåŸŸåæŒ‡å‘ä»£ç†æœåŠ¡å™¨</li><li>ä»£ç†æœåŠ¡å™¨ä»£æ›¿ç”¨æˆ·è®¿é—®çœŸå®æœåŠ¡</li><li>ç›®æ ‡æœåŠ¡å™¨çœ‹åˆ°çš„æ˜¯ä»£ç†æœåŠ¡å™¨çš„IPåœ°å€</li><li>å®ç°åœ°ç†ä½ç½®â€ä¼ªè£…â€</li></ol><h2 id="2-DNSè§£é”çš„ä¸‰ç§æŠ€æœ¯å®ç°æ–¹æ¡ˆ"><a href="#2-DNSè§£é”çš„ä¸‰ç§æŠ€æœ¯å®ç°æ–¹æ¡ˆ" class="headerlink" title="2. DNSè§£é”çš„ä¸‰ç§æŠ€æœ¯å®ç°æ–¹æ¡ˆ"></a>2. DNSè§£é”çš„ä¸‰ç§æŠ€æœ¯å®ç°æ–¹æ¡ˆ</h2><h3 id="2-1-æ–¹æ¡ˆå¯¹æ¯”è¡¨"><a href="#2-1-æ–¹æ¡ˆå¯¹æ¯”è¡¨" class="headerlink" title="2.1 æ–¹æ¡ˆå¯¹æ¯”è¡¨"></a>2.1 æ–¹æ¡ˆå¯¹æ¯”è¡¨</h3><table><thead><tr><th>æŠ€æœ¯æ–¹æ¡ˆ</th><th>éœ€è¦è¯ä¹¦</th><th>èƒ½è§£å¯†HTTPS</th><th>åœ°ç†ä½ç½®ä¼ªè£…æ•ˆæœ</th><th>éšç§é£é™©</th><th>å®ç°å¤æ‚åº¦</th></tr></thead><tbody><tr><td><strong>é€æ˜ä»£ç†</strong></td><td>âŒ</td><td>âŒ</td><td>ğŸŸ¡ æœ‰é™</td><td>ğŸŸ¢ ä½</td><td>ğŸŸ¢ ç®€å•</td></tr><tr><td><strong>HTTPä»£ç†</strong></td><td>âŒ</td><td>âŒ</td><td>ğŸŸ¡ ä¸­ç­‰</td><td>ğŸŸ¢ ä½</td><td>ğŸŸ¢ ç®€å•</td></tr><tr><td><strong>TLSä¸­é—´äºº</strong></td><td>âœ…</td><td>âœ…</td><td>ğŸŸ¢ å®Œæ•´</td><td>ğŸ”´ æé«˜</td><td>ğŸ”´ å¤æ‚</td></tr></tbody></table><h3 id="2-2-æ–¹æ¡ˆ1ï¼šé€æ˜ä»£ç†ï¼ˆæœ€å¸¸è§ï¼‰"><a href="#2-2-æ–¹æ¡ˆ1ï¼šé€æ˜ä»£ç†ï¼ˆæœ€å¸¸è§ï¼‰" class="headerlink" title="2.2 æ–¹æ¡ˆ1ï¼šé€æ˜ä»£ç†ï¼ˆæœ€å¸¸è§ï¼‰"></a>2.2 æ–¹æ¡ˆ1ï¼šé€æ˜ä»£ç†ï¼ˆæœ€å¸¸è§ï¼‰</h3><p><strong>æŠ€æœ¯ç‰¹ç‚¹ï¼š</strong></p><ul><li>åœ¨ç½‘ç»œå±‚è½¬å‘IPæ•°æ®åŒ…</li><li>ä¸è§£å¯†ä»»ä½•HTTPSæµé‡</li><li>ç”¨æˆ·æ— éœ€å®‰è£…è¯ä¹¦</li></ul><p><strong>å·¥ä½œæµç¨‹ï¼š</strong></p><pre class="mermaid">sequenceDiagram    participant User as "ç”¨æˆ·"    participant Proxy as "é€æ˜ä»£ç†"    participant Netflix as "Netflix"        User->>Proxy: TLS Client Hello (netflix.com)    Proxy->>Netflix: è½¬å‘ TLS Client Hello    Netflix->>Proxy: TLS Server Hello + Netflixè¯ä¹¦    Proxy->>User: è½¬å‘ Netflixè¯ä¹¦        Note over User,Netflix: ç”¨æˆ·ç›´æ¥ä¸Netflixè¿›è¡ŒTLSæ¡æ‰‹    Note over Proxy: ä»£ç†åªè½¬å‘åŠ å¯†æ•°æ®åŒ…ï¼Œæ— æ³•è§£å¯†        User->>Proxy: åŠ å¯†çš„HTTPè¯·æ±‚    Proxy->>Netflix: åŸæ ·è½¬å‘    Netflix->>Proxy: åŠ å¯†çš„HTTPå“åº”    Proxy->>User: åŸæ ·è½¬å‘</pre><p><strong>å®ç°ä»£ç ç¤ºä¾‹ï¼š</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TransparentProxy</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">handle_connection</span>(<span class="params">self, client_socket, target_host, target_port</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;é€æ˜è½¬å‘TCPè¿æ¥ï¼Œä¸è§£å¯†HTTPS&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># å»ºç«‹åˆ°ç›®æ ‡æœåŠ¡å™¨çš„è¿æ¥</span></span><br><span class="line">        server_socket = socket.create_connection((target_host, target_port))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># åŒå‘è½¬å‘æ•°æ®åŒ…ï¼Œä¸åšä»»ä½•è§£å¯†</span></span><br><span class="line">        <span class="variable language_">self</span>.forward_data_bidirectionally(client_socket, server_socket)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward_data_bidirectionally</span>(<span class="params">self, client, server</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åŸæ ·è½¬å‘åŠ å¯†æ•°æ®åŒ…&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="comment"># ä»å®¢æˆ·ç«¯è¯»å–æ•°æ®ï¼ˆå¯èƒ½æ˜¯åŠ å¯†çš„TLSæ•°æ®ï¼‰</span></span><br><span class="line">            data = client.recv(<span class="number">4096</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="comment"># åŸæ ·å‘é€ç»™æœåŠ¡å™¨ï¼Œä¸åšè§£å¯†æˆ–ä¿®æ”¹</span></span><br><span class="line">            server.send(data)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># åå‘è½¬å‘æœåŠ¡å™¨å“åº”</span></span><br><span class="line">            response = server.recv(<span class="number">4096</span>)</span><br><span class="line">            <span class="keyword">if</span> response:</span><br><span class="line">                client.send(response)</span><br></pre></td></tr></table></figure><p><strong>ä¼˜ç¼ºç‚¹åˆ†æï¼š</strong></p><ul><li>âœ… <strong>éšç§å®‰å…¨</strong>ï¼šä»£ç†æ— æ³•è§£å¯†HTTPSå†…å®¹</li><li>âœ… <strong>é…ç½®ç®€å•</strong>ï¼šç”¨æˆ·æ— éœ€å®‰è£…è¯ä¹¦</li><li>âœ… <strong>éƒ¨ç½²å®¹æ˜“</strong>ï¼šæœåŠ¡ç«¯å®ç°ç›¸å¯¹ç®€å•</li><li>âŒ <strong>åŠŸèƒ½æœ‰é™</strong>ï¼šæ— æ³•ä¿®æ”¹HTTPè¯·æ±‚å¤´</li><li>âŒ <strong>æ£€æµ‹é£é™©</strong>ï¼šNetflixå¯èƒ½é€šè¿‡å…¶ä»–æ–¹å¼è¯†åˆ«ä»£ç†</li></ul><h3 id="2-3-æ–¹æ¡ˆ2ï¼šHTTPä»£ç†ï¼ˆCONNECTéš§é“ï¼‰"><a href="#2-3-æ–¹æ¡ˆ2ï¼šHTTPä»£ç†ï¼ˆCONNECTéš§é“ï¼‰" class="headerlink" title="2.3 æ–¹æ¡ˆ2ï¼šHTTPä»£ç†ï¼ˆCONNECTéš§é“ï¼‰"></a>2.3 æ–¹æ¡ˆ2ï¼šHTTPä»£ç†ï¼ˆCONNECTéš§é“ï¼‰</h3><p><strong>ğŸ”¥ å›ç­”ï¼šHTTPä»£ç†å¯ä»¥ä»£ç†HTTPSè¯·æ±‚å—ï¼Ÿ</strong></p><p><strong>ç­”æ¡ˆï¼šå¯ä»¥ï¼HTTPä»£ç†é€šè¿‡CONNECTæ–¹æ³•å¤„ç†HTTPSè¯·æ±‚ã€‚</strong></p><p><strong>æŠ€æœ¯åŸç†ï¼š</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HTTPProxy</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">handle_connect_request</span>(<span class="params">self, client_socket, target_host, target_port</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å¤„ç†HTTP CONNECTè¯·æ±‚&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 1. è§£æCONNECTè¯·æ±‚</span></span><br><span class="line">        request_line = client_socket.recv(<span class="number">1024</span>).decode()</span><br><span class="line">        <span class="comment"># ä¾‹å¦‚ï¼šCONNECT netflix.com:443 HTTP/1.1</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2. å»ºç«‹åˆ°ç›®æ ‡çš„TCPè¿æ¥</span></span><br><span class="line">        target_socket = socket.create_connection((target_host, target_port))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 3. å‘Šè¯‰å®¢æˆ·ç«¯éš§é“å·²å»ºç«‹</span></span><br><span class="line">        response = <span class="string">&quot;HTTP/1.1 200 Connection established\r\n\r\n&quot;</span></span><br><span class="line">        client_socket.send(response.encode())</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 4. å¼€å§‹é€æ˜è½¬å‘ï¼ˆæ­¤æ—¶HTTPSæ¡æ‰‹å¼€å§‹ï¼‰</span></span><br><span class="line">        <span class="variable language_">self</span>.tunnel_data(client_socket, target_socket)</span><br></pre></td></tr></table></figure><p><strong>HTTPS over HTTPä»£ç†çš„å®Œæ•´æµç¨‹ï¼š</strong></p><pre class="mermaid">sequenceDiagram    participant User as "ç”¨æˆ·"    participant Proxy as "HTTPä»£ç†"    participant Netflix as "Netflix"        User->>Proxy: HTTP CONNECT netflix.com:443    Proxy->>Netflix: å»ºç«‹TCPè¿æ¥    Proxy->>User: HTTP/1.1 200 Connection established        Note over User,Netflix: éš§é“å»ºç«‹å®Œæˆï¼Œå¼€å§‹HTTPSæ¡æ‰‹        User->>Proxy: TLS Client Hello (netflix.com)    Proxy->>Netflix: è½¬å‘ TLS Client Hello    Netflix->>Proxy: TLS Server Hello + è¯ä¹¦    Proxy->>User: è½¬å‘è¯ä¹¦        Note over User,Netflix: TLSæ¡æ‰‹å®Œæˆï¼Œå¼€å§‹åŠ å¯†é€šä¿¡        User->>Proxy: åŠ å¯†çš„HTTPè¯·æ±‚    Proxy->>Netflix: è½¬å‘    Netflix->>Proxy: åŠ å¯†çš„HTTPå“åº”    Proxy->>User: è½¬å‘</pre><p><strong>Linuxé…ç½®ç¤ºä¾‹ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½ é‡åˆ°çš„é…ç½®æ–¹å¼</span></span><br><span class="line"><span class="built_in">export</span> http_proxy=http://proxy.example.com:8080</span><br><span class="line"><span class="built_in">export</span> https_proxy=http://proxy.example.com:8080</span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ–è€…ä½¿ç”¨curl</span></span><br><span class="line">curl --proxy http://proxy.example.com:8080 https://netflix.com</span><br></pre></td></tr></table></figure><p><strong>ä¸ºä»€ä¹ˆHTTPä»£ç†å¯ä»¥å¤„ç†HTTPSï¼š</strong></p><ol><li><strong>CONNECTæ–¹æ³•</strong>ï¼šHTTP&#x2F;1.1æ ‡å‡†å®šä¹‰çš„éš§é“æ–¹æ³•</li><li><strong>TCPéš§é“</strong>ï¼šåœ¨HTTPä»£ç†å’Œç›®æ ‡æœåŠ¡å™¨ä¹‹é—´å»ºç«‹TCPè¿æ¥</li><li><strong>é€æ˜è½¬å‘</strong>ï¼šTLSæ¡æ‰‹å’ŒåŠ å¯†é€šä¿¡åœ¨å®¢æˆ·ç«¯å’Œç›®æ ‡æœåŠ¡å™¨ä¹‹é—´è¿›è¡Œ</li><li><strong>ä»£ç†ä¸è§£å¯†</strong>ï¼šä»£ç†åªè´Ÿè´£è½¬å‘å­—èŠ‚æµï¼Œä¸å‚ä¸åŠ å¯†è¿‡ç¨‹</li></ol><h3 id="2-4-é€æ˜ä»£ç†-vs-HTTPä»£ç†-æ·±åº¦å¯¹æ¯”"><a href="#2-4-é€æ˜ä»£ç†-vs-HTTPä»£ç†-æ·±åº¦å¯¹æ¯”" class="headerlink" title="2.4 é€æ˜ä»£ç† vs HTTPä»£ç† - æ·±åº¦å¯¹æ¯”"></a>2.4 é€æ˜ä»£ç† vs HTTPä»£ç† - æ·±åº¦å¯¹æ¯”</h3><p>åœ¨æ·±å…¥äº†è§£TLSä¸­é—´äººæ–¹æ¡ˆä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆè¯¦ç»†å¯¹æ¯”é€æ˜ä»£ç†å’ŒHTTPä»£ç†çš„åŒºåˆ«ï¼Œè¿™å¯¹ç†è§£DNSè§£é”æŠ€æœ¯éå¸¸é‡è¦ã€‚</p><h4 id="2-4-1-æ ¸å¿ƒç»´åº¦å¯¹æ¯”è¡¨"><a href="#2-4-1-æ ¸å¿ƒç»´åº¦å¯¹æ¯”è¡¨" class="headerlink" title="2.4.1 æ ¸å¿ƒç»´åº¦å¯¹æ¯”è¡¨"></a>2.4.1 æ ¸å¿ƒç»´åº¦å¯¹æ¯”è¡¨</h4><table><thead><tr><th>ç»´åº¦</th><th>é€æ˜ä»£ç†</th><th>HTTPä»£ç†</th></tr></thead><tbody><tr><td><strong>å·¥ä½œå±‚çº§</strong></td><td>ç½‘ç»œå±‚ï¼ˆLayer 3&#x2F;4ï¼‰</td><td>åº”ç”¨å±‚ï¼ˆLayer 7ï¼‰</td></tr><tr><td><strong>ç”¨æˆ·æ„ŸçŸ¥</strong></td><td>å®Œå…¨é€æ˜ï¼Œç”¨æˆ·ä¸çŸ¥é“</td><td>éœ€è¦æ˜¾å¼é…ç½®ï¼Œç”¨æˆ·æ˜ç¡®æ„ŸçŸ¥</td></tr><tr><td><strong>é…ç½®æ–¹å¼</strong></td><td>DNSè§£æåŠ«æŒæˆ–è·¯ç”±è¡¨ä¿®æ”¹</td><td>åº”ç”¨ç¨‹åºä»£ç†è®¾ç½®</td></tr><tr><td><strong>åè®®æ”¯æŒ</strong></td><td>æ‰€æœ‰TCP&#x2F;UDPåè®®</td><td>ä¸»è¦HTTP&#x2F;HTTPSåè®®</td></tr><tr><td><strong>å®ç°å¤æ‚åº¦</strong></td><td>éœ€è¦ç½‘ç»œåŸºç¡€è®¾æ–½æ§åˆ¶</td><td>åº”ç”¨ç¨‹åºçº§åˆ«å®ç°</td></tr><tr><td><strong>æƒé™è¦æ±‚</strong></td><td>é€šå¸¸éœ€è¦rootæƒé™</td><td>ç”¨æˆ·çº§æƒé™å³å¯</td></tr><tr><td><strong>è°ƒè¯•éš¾åº¦</strong></td><td>è¾ƒéš¾æ’æŸ¥é—®é¢˜</td><td>è¿æ¥è¿‡ç¨‹æ¸…æ™°å¯è§</td></tr></tbody></table><h4 id="2-4-2-å·¥ä½œåŸç†å¯¹æ¯”"><a href="#2-4-2-å·¥ä½œåŸç†å¯¹æ¯”" class="headerlink" title="2.4.2 å·¥ä½œåŸç†å¯¹æ¯”"></a>2.4.2 å·¥ä½œåŸç†å¯¹æ¯”</h4><p><strong>é€æ˜ä»£ç†å·¥ä½œæµç¨‹ï¼š</strong></p><pre class="mermaid">sequenceDiagram    participant User as "ç”¨æˆ·åº”ç”¨"    participant DNS as "DNSæœåŠ¡å™¨"    participant TransProxy as "é€æ˜ä»£ç†"    participant Netflix as "Netflix"        User->>DNS: æŸ¥è¯¢ netflix.com    DNS->>User: è¿”å›ä»£ç†IPï¼ˆç”¨æˆ·ä¸çŸ¥é“ï¼‰        Note over User: ç”¨æˆ·ä»¥ä¸ºç›´æ¥è¿æ¥Netflix        User->>TransProxy: è¿æ¥åˆ°"Netflix"ï¼ˆå®é™…æ˜¯ä»£ç†ï¼‰    TransProxy->>Netflix: ä»£ç†è½¬å‘è¿æ¥    Netflix->>TransProxy: è¿”å›Netflixè¯ä¹¦    TransProxy->>User: è½¬å‘è¯ä¹¦ï¼ˆç”¨æˆ·çœ‹åˆ°çœŸå®è¯ä¹¦ï¼‰        Note over User,Netflix: ç”¨æˆ·å®Œå…¨ä¸çŸ¥é“ä»£ç†å­˜åœ¨</pre><p><strong>HTTPä»£ç†å·¥ä½œæµç¨‹ï¼š</strong></p><pre class="mermaid">sequenceDiagram    participant User as "ç”¨æˆ·åº”ç”¨"    participant HTTPProxy as "HTTPä»£ç†"    participant Netflix as "Netflix"        Note over User: ç”¨æˆ·æ˜ç¡®é…ç½®ä»£ç†        User->>HTTPProxy: CONNECT netflix.com:443 HTTP/1.1    HTTPProxy->>Netflix: å»ºç«‹TCPè¿æ¥    HTTPProxy->>User: HTTP/1.1 200 Connection established        Note over User,Netflix: éš§é“å»ºç«‹ï¼Œå¼€å§‹TLSæ¡æ‰‹        User->>HTTPProxy: TLS Client Hello    HTTPProxy->>Netflix: è½¬å‘TLSæ¡æ‰‹    Netflix->>HTTPProxy: TLS Server Hello + è¯ä¹¦    HTTPProxy->>User: è½¬å‘è¯ä¹¦        Note over User: ç”¨æˆ·çŸ¥é“ä½¿ç”¨äº†ä»£ç†</pre><h4 id="2-4-3-é…ç½®æ–¹å¼è¯¦è§£"><a href="#2-4-3-é…ç½®æ–¹å¼è¯¦è§£" class="headerlink" title="2.4.3 é…ç½®æ–¹å¼è¯¦è§£"></a>2.4.3 é…ç½®æ–¹å¼è¯¦è§£</h4><p><strong>é€æ˜ä»£ç†é…ç½®ï¼š</strong></p><p><em>æœåŠ¡ç«¯é…ç½®ï¼ˆéœ€è¦åŸºç¡€è®¾æ–½æ§åˆ¶ï¼‰ï¼š</em></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ–¹å¼1ï¼šDNSåŠ«æŒ</span></span><br><span class="line"><span class="comment"># DNSæœåŠ¡å™¨è¿”å›ä»£ç†IPè€Œä¸æ˜¯çœŸå®IP</span></span><br><span class="line">netflix.com -&gt; 5.6.7.8 (ä»£ç†æœåŠ¡å™¨IP)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–¹å¼2ï¼šè·¯ç”±è§„åˆ™</span></span><br><span class="line"><span class="comment"># ä½¿ç”¨iptablesé‡å®šå‘ç‰¹å®šæµé‡</span></span><br><span class="line">iptables -t nat -A OUTPUT -p tcp --dport 443 -d netflix.com -j REDIRECT --to-port 8080</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–¹å¼3ï¼šç½‘å…³çº§éƒ¨ç½²</span></span><br><span class="line"><span class="comment"># åœ¨è·¯ç”±å™¨æˆ–ç½‘å…³ä¸Šéƒ¨ç½²é€æ˜ä»£ç†</span></span><br></pre></td></tr></table></figure><p><em>ç”¨æˆ·é…ç½®ï¼ˆæå…¶ç®€å•ï¼‰ï¼š</em></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç”¨æˆ·åªéœ€è¦é…ç½®DNSæœåŠ¡å™¨</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;nameserver dns-unlock-service.com&quot;</span> &gt; /etc/resolv.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ–è€…åœ¨è·¯ç”±å™¨ä¸­é…ç½®DNS</span></span><br><span class="line"><span class="comment"># ç”¨æˆ·è®¾å¤‡æ— éœ€ä»»ä½•é…ç½®</span></span><br></pre></td></tr></table></figure><p><strong>HTTPä»£ç†é…ç½®ï¼š</strong></p><p><em>ç”¨æˆ·é…ç½®ï¼ˆéœ€è¦æ˜¾å¼è®¾ç½®ï¼‰ï¼š</em></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ–¹å¼1ï¼šç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="built_in">export</span> http_proxy=http://proxy.example.com:8080</span><br><span class="line"><span class="built_in">export</span> https_proxy=http://proxy.example.com:8080</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–¹å¼2ï¼šåº”ç”¨ç¨‹åºå‚æ•°</span></span><br><span class="line">curl -x proxy.example.com:8080 https://netflix.com</span><br><span class="line">wget --proxy=on --proxy-user=user --proxy-password=pass</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–¹å¼3ï¼šé…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="comment"># ~/.curlrc</span></span><br><span class="line">proxy = proxy.example.com:8080</span><br><span class="line">proxy-user = username:password</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–¹å¼4ï¼šæµè§ˆå™¨è®¾ç½®</span></span><br><span class="line"><span class="comment"># Chrome: è®¾ç½® -&gt; é«˜çº§ -&gt; ä»£ç†æœåŠ¡å™¨</span></span><br><span class="line"><span class="comment"># Firefox: é¦–é€‰é¡¹ -&gt; ç½‘ç»œè®¾ç½® -&gt; æ‰‹åŠ¨ä»£ç†é…ç½®</span></span><br></pre></td></tr></table></figure><h4 id="2-4-4-åè®®æ”¯æŒå·®å¼‚"><a href="#2-4-4-åè®®æ”¯æŒå·®å¼‚" class="headerlink" title="2.4.4 åè®®æ”¯æŒå·®å¼‚"></a>2.4.4 åè®®æ”¯æŒå·®å¼‚</h4><p><strong>é€æ˜ä»£ç†åè®®æ”¯æŒï¼š</strong></p><ul><li>âœ… <strong>HTTP&#x2F;HTTPS</strong>ï¼šå®Œå…¨æ”¯æŒ</li><li>âœ… <strong>FTP&#x2F;FTPS</strong>ï¼šæ”¯æŒ</li><li>âœ… <strong>SMTP&#x2F;POP3&#x2F;IMAP</strong>ï¼šæ”¯æŒ</li><li>âœ… <strong>SSH&#x2F;SCP</strong>ï¼šæ”¯æŒ</li><li>âœ… <strong>è‡ªå®šä¹‰TCPåè®®</strong>ï¼šæ”¯æŒ</li><li>âœ… <strong>UDPåè®®</strong>ï¼šéƒ¨åˆ†æ”¯æŒï¼ˆæŠ€æœ¯å®ç°å¤æ‚ï¼‰</li><li>âœ… <strong>æ¸¸æˆåè®®</strong>ï¼šå¤§éƒ¨åˆ†æ”¯æŒ</li></ul><p><strong>HTTPä»£ç†åè®®æ”¯æŒï¼š</strong></p><ul><li>âœ… <strong>HTTP</strong>ï¼šåŸç”Ÿæ”¯æŒ</li><li>âœ… <strong>HTTPS</strong>ï¼šé€šè¿‡CONNECTæ–¹æ³•æ”¯æŒ</li><li>âŒ <strong>FTP</strong>ï¼šä¸æ”¯æŒï¼ˆéœ€è¦ä¸“é—¨çš„FTPä»£ç†ï¼‰</li><li>âŒ <strong>SMTPç­‰é‚®ä»¶åè®®</strong>ï¼šä¸æ”¯æŒ</li><li>âŒ <strong>SSH</strong>ï¼šä¸æ”¯æŒ</li><li>âŒ <strong>è‡ªå®šä¹‰TCPåè®®</strong>ï¼šä¸æ”¯æŒ</li><li>âŒ <strong>UDPåè®®</strong>ï¼šä¸æ”¯æŒ</li><li>âŒ <strong>æ¸¸æˆåè®®</strong>ï¼šå¤§éƒ¨åˆ†ä¸æ”¯æŒ</li></ul><h4 id="2-4-5-å®é™…åº”ç”¨åœºæ™¯å¯¹æ¯”"><a href="#2-4-5-å®é™…åº”ç”¨åœºæ™¯å¯¹æ¯”" class="headerlink" title="2.4.5 å®é™…åº”ç”¨åœºæ™¯å¯¹æ¯”"></a>2.4.5 å®é™…åº”ç”¨åœºæ™¯å¯¹æ¯”</h4><p><strong>é€æ˜ä»£ç†æœ€é€‚åˆçš„åœºæ™¯ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">åœºæ™¯1ï¼šå®¶åº­ç½‘ç»œç¯å¢ƒ</span><br><span class="line">â”œâ”€â”€ åœ¨è·¯ç”±å™¨ä¸Šé…ç½®é€æ˜ä»£ç†</span><br><span class="line">â”œâ”€â”€ æ‰€æœ‰è®¾å¤‡è‡ªåŠ¨äº«å—DNSè§£é”</span><br><span class="line">â””â”€â”€ ç”¨æˆ·æ— éœ€ä»»ä½•é…ç½®</span><br><span class="line"></span><br><span class="line">åœºæ™¯2ï¼šä¼ä¸šç½‘ç»œç¯å¢ƒ  </span><br><span class="line">â”œâ”€â”€ ç½‘ç»œç®¡ç†å‘˜ç»Ÿä¸€éƒ¨ç½²</span><br><span class="line">â”œâ”€â”€ å‘˜å·¥æ— æ„ŸçŸ¥ä½¿ç”¨</span><br><span class="line">â””â”€â”€ æ»¡è¶³åˆè§„è¦æ±‚</span><br><span class="line"></span><br><span class="line">åœºæ™¯3ï¼šDNSè§£é”æœåŠ¡</span><br><span class="line">â”œâ”€â”€ ç”¨æˆ·åªéœ€é…ç½®DNSæœåŠ¡å™¨</span><br><span class="line">â”œâ”€â”€ æ”¯æŒæ‰€æœ‰åº”ç”¨ç¨‹åº</span><br><span class="line">â””â”€â”€ é…ç½®ç®€å•ï¼Œç”¨æˆ·å‹å¥½</span><br></pre></td></tr></table></figure><p><strong>HTTPä»£ç†æœ€é€‚åˆçš„åœºæ™¯ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">åœºæ™¯1ï¼šä¸ªäººä¸´æ—¶ä½¿ç”¨</span><br><span class="line">â”œâ”€â”€ éœ€è¦ä¸´æ—¶è®¿é—®ç‰¹å®šç½‘ç«™</span><br><span class="line">â”œâ”€â”€ ä¸æƒ³å½±å“å…¶ä»–ç½‘ç»œè¿æ¥</span><br><span class="line">â””â”€â”€ çµæ´»æ§åˆ¶ä»£ç†ä½¿ç”¨</span><br><span class="line"></span><br><span class="line">åœºæ™¯2ï¼šå¼€å‘æµ‹è¯•ç¯å¢ƒ</span><br><span class="line">â”œâ”€â”€ å¼€å‘è€…éœ€è¦æµ‹è¯•ä¸åŒç½‘ç»œç¯å¢ƒ</span><br><span class="line">â”œâ”€â”€ éœ€è¦æŠ“åŒ…åˆ†æç½‘ç»œè¯·æ±‚</span><br><span class="line">â””â”€â”€ è¦æ±‚è°ƒè¯•è¿‡ç¨‹å¯è§</span><br><span class="line"></span><br><span class="line">åœºæ™¯3ï¼šæµè§ˆå™¨ä¸“ç”¨</span><br><span class="line">â”œâ”€â”€ åªéœ€è¦æµè§ˆå™¨æµé‡èµ°ä»£ç†</span><br><span class="line">â”œâ”€â”€ å…¶ä»–åº”ç”¨ç¨‹åºæ­£å¸¸è¿æ¥</span><br><span class="line">â””â”€â”€ é¿å…å…¨å±€ä»£ç†å½±å“</span><br></pre></td></tr></table></figure><h4 id="2-4-6-æ£€æµ‹å’Œæ’é”™å¯¹æ¯”"><a href="#2-4-6-æ£€æµ‹å’Œæ’é”™å¯¹æ¯”" class="headerlink" title="2.4.6 æ£€æµ‹å’Œæ’é”™å¯¹æ¯”"></a>2.4.6 æ£€æµ‹å’Œæ’é”™å¯¹æ¯”</h4><p><strong>é€æ˜ä»£ç†æ£€æµ‹æ–¹æ³•ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. å¯¹æ¯”DNSè§£æç»“æœ</span></span><br><span class="line">nslookup netflix.com 8.8.8.8        <span class="comment"># æ ‡å‡†DNS</span></span><br><span class="line">nslookup netflix.com current-dns     <span class="comment"># å½“å‰DNS</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. æ£€æŸ¥å®é™…è¿æ¥IP</span></span><br><span class="line">netstat -an | grep :443</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. åˆ†æç½‘ç»œè·¯ç”±</span></span><br><span class="line">traceroute netflix.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. æ£€æŸ¥è¯ä¹¦é“¾ä¸€è‡´æ€§</span></span><br><span class="line">openssl s_client -connect netflix.com:443</span><br></pre></td></tr></table></figure><p><strong>HTTPä»£ç†æ£€æµ‹æ–¹æ³•ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. æ£€æŸ¥ç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$http_proxy</span> <span class="variable">$https_proxy</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. åˆ†æè¿æ¥è¿‡ç¨‹</span></span><br><span class="line">curl -v https://httpbin.org/ip 2&gt;&amp;1 | grep -i connect</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. æ£€æŸ¥ä»£ç†æ—¥å¿—</span></span><br><span class="line"><span class="comment"># ä»£ç†æœåŠ¡å™¨é€šå¸¸æœ‰è¯¦ç»†çš„è¿æ¥æ—¥å¿—</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. æµ‹è¯•ä»£ç†è¿é€šæ€§</span></span><br><span class="line">curl -x proxy.example.com:8080 https://httpbin.org/ip</span><br></pre></td></tr></table></figure><h4 id="2-4-7-æ€§èƒ½å’Œå¯é æ€§å¯¹æ¯”"><a href="#2-4-7-æ€§èƒ½å’Œå¯é æ€§å¯¹æ¯”" class="headerlink" title="2.4.7 æ€§èƒ½å’Œå¯é æ€§å¯¹æ¯”"></a>2.4.7 æ€§èƒ½å’Œå¯é æ€§å¯¹æ¯”</h4><table><thead><tr><th>æ€§èƒ½æŒ‡æ ‡</th><th>é€æ˜ä»£ç†</th><th>HTTPä»£ç†</th></tr></thead><tbody><tr><td><strong>è¿æ¥å»¶è¿Ÿ</strong></td><td>è¾ƒä½ï¼ˆç½‘ç»œå±‚è½¬å‘ï¼‰</td><td>ä¸­ç­‰ï¼ˆåº”ç”¨å±‚å¤„ç†ï¼‰</td></tr><tr><td><strong>ååé‡</strong></td><td>è¾ƒé«˜ï¼ˆå‡å°‘åè®®å¼€é”€ï¼‰</td><td>ä¸­ç­‰ï¼ˆHTTPåè®®å¼€é”€ï¼‰</td></tr><tr><td><strong>èµ„æºæ¶ˆè€—</strong></td><td>è¾ƒä½ï¼ˆå†…æ ¸çº§å¤„ç†ï¼‰</td><td>è¾ƒé«˜ï¼ˆç”¨æˆ·ç©ºé—´å¤„ç†ï¼‰</td></tr><tr><td><strong>æ•…éšœæ’æŸ¥</strong></td><td>å›°éš¾ï¼ˆé€æ˜æ€§å¯¼è‡´ï¼‰</td><td>å®¹æ˜“ï¼ˆè¿‡ç¨‹å¯è§ï¼‰</td></tr><tr><td><strong>å¯æ‰©å±•æ€§</strong></td><td>ä¾èµ–åŸºç¡€è®¾æ–½</td><td>åº”ç”¨çº§åˆ«æ‰©å±•</td></tr></tbody></table><h3 id="2-5-æ–¹æ¡ˆ3ï¼šTLSä¸­é—´äººï¼ˆå®Œå…¨æ§åˆ¶ï¼‰"><a href="#2-5-æ–¹æ¡ˆ3ï¼šTLSä¸­é—´äººï¼ˆå®Œå…¨æ§åˆ¶ï¼‰" class="headerlink" title="2.5 æ–¹æ¡ˆ3ï¼šTLSä¸­é—´äººï¼ˆå®Œå…¨æ§åˆ¶ï¼‰"></a>2.5 æ–¹æ¡ˆ3ï¼šTLSä¸­é—´äººï¼ˆå®Œå…¨æ§åˆ¶ï¼‰</h3><p><strong>æŠ€æœ¯ç‰¹ç‚¹ï¼š</strong></p><ul><li>ä»£ç†æœåŠ¡å™¨è§£å¯†æ‰€æœ‰HTTPSæµé‡</li><li>éœ€è¦ç”¨æˆ·å®‰è£…ä»£ç†çš„CAè¯ä¹¦</li><li>å¯ä»¥å®Œå…¨æ§åˆ¶å’Œä¿®æ”¹HTTPé€šä¿¡</li></ul><p><strong>å®ç°æ–¹å¼ï¼š</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TLSInterceptProxy</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">handle_tls_connection</span>(<span class="params">self, client_socket, target_domain</span>):</span><br><span class="line">        <span class="comment"># 1. åŠ¨æ€ç”Ÿæˆç›®æ ‡åŸŸåçš„è¯ä¹¦</span></span><br><span class="line">        cert, key = <span class="variable language_">self</span>.generate_cert_for_domain(target_domain)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2. ä¸å®¢æˆ·ç«¯å»ºç«‹TLSè¿æ¥ï¼ˆä½¿ç”¨ä¼ªé€ è¯ä¹¦ï¼‰</span></span><br><span class="line">        client_tls = ssl.wrap_socket(</span><br><span class="line">            client_socket, </span><br><span class="line">            certfile=cert, </span><br><span class="line">            keyfile=key, </span><br><span class="line">            server_side=<span class="literal">True</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 3. ä¸ç›®æ ‡æœåŠ¡å™¨å»ºç«‹TLSè¿æ¥</span></span><br><span class="line">        target_tls = ssl.wrap_socket(</span><br><span class="line">            socket.create_connection((target_domain, <span class="number">443</span>)),</span><br><span class="line">            server_hostname=target_domain</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 4. è§£å¯†ã€ä¿®æ”¹ã€é‡æ–°åŠ å¯†æ•°æ®</span></span><br><span class="line">        <span class="variable language_">self</span>.intercept_and_modify_traffic(client_tls, target_tls)</span><br></pre></td></tr></table></figure><p><strong>éœ€è¦ç”¨æˆ·å®‰è£…CAè¯ä¹¦ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># macOS</span></span><br><span class="line"><span class="built_in">sudo</span> security add-trusted-cert -d -r trustRoot proxy-ca.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># Windows  </span></span><br><span class="line">certmgr.msc -&gt; å—ä¿¡ä»»çš„æ ¹è¯ä¹¦é¢å‘æœºæ„ -&gt; å¯¼å…¥proxy-ca.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># Linux</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> proxy-ca.crt /usr/local/share/ca-certificates/</span><br><span class="line"><span class="built_in">sudo</span> update-ca-certificates</span><br></pre></td></tr></table></figure><p><strong>âš ï¸ é‡è¦å®‰å…¨è­¦å‘Šï¼š</strong></p><ul><li>ä»£ç†æœåŠ¡å™¨å¯ä»¥æŸ¥çœ‹æ‰€æœ‰HTTPSå†…å®¹</li><li>åŒ…æ‹¬å¯†ç ã€ä¸ªäººä¿¡æ¯ã€æ”¯ä»˜æ•°æ®ç­‰</li><li>ç”¨æˆ·éšç§å®Œå…¨æš´éœ²ç»™ä»£ç†æœåŠ¡å•†</li><li>éœ€è¦ç»å¯¹ä¿¡ä»»æœåŠ¡æä¾›å•†</li></ul><h2 id="3-å¦‚ä½•æµ‹è¯•ä»£ç†ä½¿ç”¨çš„æŠ€æœ¯æ–¹æ¡ˆ"><a href="#3-å¦‚ä½•æµ‹è¯•ä»£ç†ä½¿ç”¨çš„æŠ€æœ¯æ–¹æ¡ˆ" class="headerlink" title="3. å¦‚ä½•æµ‹è¯•ä»£ç†ä½¿ç”¨çš„æŠ€æœ¯æ–¹æ¡ˆ"></a>3. å¦‚ä½•æµ‹è¯•ä»£ç†ä½¿ç”¨çš„æŠ€æœ¯æ–¹æ¡ˆ</h2><h3 id="3-1-æ£€æµ‹æ–¹æ³•æ±‡æ€»è¡¨"><a href="#3-1-æ£€æµ‹æ–¹æ³•æ±‡æ€»è¡¨" class="headerlink" title="3.1 æ£€æµ‹æ–¹æ³•æ±‡æ€»è¡¨"></a>3.1 æ£€æµ‹æ–¹æ³•æ±‡æ€»è¡¨</h3><table><thead><tr><th>æ£€æµ‹æ–¹æ³•</th><th>é€æ˜ä»£ç†</th><th>HTTPä»£ç†</th><th>TLSä¸­é—´äºº</th></tr></thead><tbody><tr><td><strong>è¯ä¹¦æ£€æŸ¥</strong></td><td>Netflixè¯ä¹¦</td><td>Netflixè¯ä¹¦</td><td>ä»£ç†è¯ä¹¦</td></tr><tr><td><strong>è¿æ¥æ¨¡å¼</strong></td><td>ç›´è¿IP</td><td>CONNECTéš§é“</td><td>åŒé‡TLS</td></tr><tr><td><strong>é…ç½®è¦æ±‚</strong></td><td>æ— éœ€è¯ä¹¦</td><td>æ— éœ€è¯ä¹¦</td><td>éœ€è¦è¯ä¹¦</td></tr><tr><td><strong>æŠ“åŒ…åˆ†æ</strong></td><td>TCPè½¬å‘</td><td>HTTP CONNECT</td><td>TLSé‡æ–°åå•†</td></tr></tbody></table><h3 id="3-2-æ–¹æ³•1ï¼šæ£€æŸ¥HTTPSè¯ä¹¦"><a href="#3-2-æ–¹æ³•1ï¼šæ£€æŸ¥HTTPSè¯ä¹¦" class="headerlink" title="3.2 æ–¹æ³•1ï¼šæ£€æŸ¥HTTPSè¯ä¹¦"></a>3.2 æ–¹æ³•1ï¼šæ£€æŸ¥HTTPSè¯ä¹¦</h3><p><strong>æµ‹è¯•æ­¥éª¤ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. é…ç½®ä»£ç†åè®¿é—®ç›®æ ‡ç½‘ç«™</span></span><br><span class="line">curl -v --proxy http://your-proxy:8080 https://netflix.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. æŸ¥çœ‹è¯ä¹¦ä¿¡æ¯</span></span><br><span class="line">openssl s_client -connect netflix.com:443 -proxy your-proxy:8080 -showcerts</span><br></pre></td></tr></table></figure><p><strong>ç»“æœåˆ¤æ–­ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">é€æ˜ä»£ç†/HTTPä»£ç†ï¼š</span><br><span class="line">è¯ä¹¦é¢å‘è€…ï¼šNetflixå®˜æ–¹è¯ä¹¦</span><br><span class="line">Subject: CN=netflix.com</span><br><span class="line">Issuer: CN=DigiCert Inc</span><br><span class="line"></span><br><span class="line">TLSä¸­é—´äººï¼š</span><br><span class="line">è¯ä¹¦é¢å‘è€…ï¼šä»£ç†æœåŠ¡å•†çš„CA</span><br><span class="line">Subject: CN=netflix.com  </span><br><span class="line">Issuer: CN=ProxyServiceCA  # ä»£ç†çš„CAè¯ä¹¦</span><br></pre></td></tr></table></figure><h3 id="3-3-æ–¹æ³•2ï¼šåˆ†æè¿æ¥å»ºç«‹è¿‡ç¨‹"><a href="#3-3-æ–¹æ³•2ï¼šåˆ†æè¿æ¥å»ºç«‹è¿‡ç¨‹" class="headerlink" title="3.3 æ–¹æ³•2ï¼šåˆ†æè¿æ¥å»ºç«‹è¿‡ç¨‹"></a>3.3 æ–¹æ³•2ï¼šåˆ†æè¿æ¥å»ºç«‹è¿‡ç¨‹</h3><p><strong>ä½¿ç”¨WiresharkæŠ“åŒ…åˆ†æï¼š</strong></p><p><strong>é€æ˜ä»£ç†ç‰¹å¾ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. DNSæŸ¥è¯¢ï¼šnetflix.com -&gt; ä»£ç†IP</span><br><span class="line">2. TCPè¿æ¥ï¼šç›´æ¥è¿æ¥åˆ°ä»£ç†IP:443</span><br><span class="line">3. TLSæ¡æ‰‹ï¼šClient Hello -&gt; netflix.com</span><br><span class="line">4. è¯ä¹¦ï¼šNetflixçš„çœŸå®è¯ä¹¦</span><br></pre></td></tr></table></figure><p><strong>HTTPä»£ç†ç‰¹å¾ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. TCPè¿æ¥ï¼šè¿æ¥åˆ°ä»£ç†IP:8080</span><br><span class="line">2. HTTPè¯·æ±‚ï¼šCONNECT netflix.com:443 HTTP/1.1</span><br><span class="line">3. HTTPå“åº”ï¼š200 Connection established</span><br><span class="line">4. TLSæ¡æ‰‹ï¼šå¼€å§‹ä¸Netflixçš„æ¡æ‰‹</span><br></pre></td></tr></table></figure><p><strong>TLSä¸­é—´äººç‰¹å¾ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. TCPè¿æ¥ï¼šè¿æ¥åˆ°ä»£ç†IP:443</span><br><span class="line">2. TLSæ¡æ‰‹ï¼šæ”¶åˆ°ä»£ç†ç­¾å‘çš„è¯ä¹¦</span><br><span class="line">3. åŒé‡TLSï¼šä»£ç†ä¸ç›®æ ‡æœåŠ¡å™¨å¦å»ºè¿æ¥</span><br><span class="line">4. è¯ä¹¦é“¾ï¼šåŒ…å«ä»£ç†CAè¯ä¹¦</span><br></pre></td></tr></table></figure><h3 id="3-4-æ–¹æ³•3ï¼šåŠŸèƒ½æµ‹è¯•"><a href="#3-4-æ–¹æ³•3ï¼šåŠŸèƒ½æµ‹è¯•" class="headerlink" title="3.4 æ–¹æ³•3ï¼šåŠŸèƒ½æµ‹è¯•"></a>3.4 æ–¹æ³•3ï¼šåŠŸèƒ½æµ‹è¯•</h3><p><strong>æµ‹è¯•ä»£ç†æ˜¯å¦èƒ½ä¿®æ”¹HTTPå¤´ï¼š</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®ä»£ç†</span></span><br><span class="line">proxies = &#123;</span><br><span class="line">    <span class="string">&#x27;http&#x27;</span>: <span class="string">&#x27;http://your-proxy:8080&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;https&#x27;</span>: <span class="string">&#x27;http://your-proxy:8080&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¿é—®æ£€æµ‹æœåŠ¡</span></span><br><span class="line">response = requests.get(<span class="string">&#x27;https://httpbin.org/headers&#x27;</span>, proxies=proxies)</span><br><span class="line"><span class="built_in">print</span>(response.json())</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥å“åº”ä¸­çš„headers</span></span><br><span class="line"><span class="comment"># å¦‚æœä»£ç†ä¿®æ”¹äº†User-Agentã€Accept-Languageç­‰ï¼Œè¯´æ˜æ˜¯TLSä¸­é—´äºº</span></span><br><span class="line"><span class="comment"># å¦‚æœheadersä¿æŒåŸæ ·ï¼Œè¯´æ˜æ˜¯é€æ˜ä»£ç†æˆ–HTTPä»£ç†</span></span><br></pre></td></tr></table></figure><h3 id="3-5-æ–¹æ³•4ï¼šç®€å•å‘½ä»¤è¡Œæ£€æµ‹"><a href="#3-5-æ–¹æ³•4ï¼šç®€å•å‘½ä»¤è¡Œæ£€æµ‹" class="headerlink" title="3.5 æ–¹æ³•4ï¼šç®€å•å‘½ä»¤è¡Œæ£€æµ‹"></a>3.5 æ–¹æ³•4ï¼šç®€å•å‘½ä»¤è¡Œæ£€æµ‹</h3><p><strong>ä¸€é”®æ£€æµ‹è„šæœ¬ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== DNSè§£é”æŠ€æœ¯æ–¹æ¡ˆæ£€æµ‹ ===&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æµ‹1ï¼šæ˜¯å¦éœ€è¦è¯ä¹¦</span></span><br><span class="line"><span class="keyword">if</span> [[ -f <span class="string">&quot;/usr/local/share/ca-certificates/proxy-ca.crt&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;ğŸ”´ å‘ç°ä»£ç†CAè¯ä¹¦ -&gt; å¯èƒ½æ˜¯TLSä¸­é—´äººæ–¹æ¡ˆ&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;ğŸŸ¢ æœªå‘ç°ä»£ç†CAè¯ä¹¦ -&gt; é€æ˜ä»£ç†æˆ–HTTPä»£ç†&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æµ‹2ï¼šè¯ä¹¦é¢å‘è€…</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== è¯ä¹¦æ£€æŸ¥ ===&quot;</span></span><br><span class="line"><span class="built_in">echo</span> | openssl s_client -connect netflix.com:443 -proxy your-proxy:8080 2&gt;/dev/null | openssl x509 -noout -issuer</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æµ‹3ï¼šè¿æ¥æ–¹å¼</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== è¿æ¥æ–¹å¼æ£€æŸ¥ ===&quot;</span></span><br><span class="line">curl -v --proxy http://your-proxy:8080 https://httpbin.org/ip 2&gt;&amp;1 | grep -E <span class="string">&quot;(CONNECT|Proxy-Connection)&quot;</span></span><br></pre></td></tr></table></figure><h2 id="4-åœ°ç†ä½ç½®ç»•è¿‡çš„æŠ€æœ¯å±€é™æ€§"><a href="#4-åœ°ç†ä½ç½®ç»•è¿‡çš„æŠ€æœ¯å±€é™æ€§" class="headerlink" title="4. åœ°ç†ä½ç½®ç»•è¿‡çš„æŠ€æœ¯å±€é™æ€§"></a>4. åœ°ç†ä½ç½®ç»•è¿‡çš„æŠ€æœ¯å±€é™æ€§</h2><h3 id="4-1-å„æ–¹æ¡ˆçš„ç»•è¿‡èƒ½åŠ›å¯¹æ¯”"><a href="#4-1-å„æ–¹æ¡ˆçš„ç»•è¿‡èƒ½åŠ›å¯¹æ¯”" class="headerlink" title="4.1 å„æ–¹æ¡ˆçš„ç»•è¿‡èƒ½åŠ›å¯¹æ¯”"></a>4.1 å„æ–¹æ¡ˆçš„ç»•è¿‡èƒ½åŠ›å¯¹æ¯”</h3><table><thead><tr><th>æ£€æµ‹æ–¹å¼</th><th>é€æ˜ä»£ç†</th><th>HTTPä»£ç†</th><th>TLSä¸­é—´äºº</th></tr></thead><tbody><tr><td><strong>IPåœ°å€æ£€æµ‹</strong></td><td>âœ… å¯ç»•è¿‡</td><td>âœ… å¯ç»•è¿‡</td><td>âœ… å¯ç»•è¿‡</td></tr><tr><td><strong>HTTPå¤´éƒ¨æ£€æµ‹</strong></td><td>âŒ æ— æ³•ä¿®æ”¹</td><td>âŒ æ— æ³•ä¿®æ”¹</td><td>âœ… å®Œå…¨æ§åˆ¶</td></tr><tr><td><strong>TLSæŒ‡çº¹æ£€æµ‹</strong></td><td>âŒ åŸå§‹æŒ‡çº¹</td><td>âŒ åŸå§‹æŒ‡çº¹</td><td>âœ… å¯ä»¥ä¼ªé€ </td></tr><tr><td><strong>æ—¶åŒºæ£€æµ‹</strong></td><td>âŒ å®¢æˆ·ç«¯æ—¶åŒº</td><td>âŒ å®¢æˆ·ç«¯æ—¶åŒº</td><td>âœ… å¯ä»¥ä¿®æ”¹</td></tr><tr><td><strong>DNSè§£ææ¨¡å¼</strong></td><td>ğŸŸ¡ éƒ¨åˆ†ç»•è¿‡</td><td>ğŸŸ¡ éƒ¨åˆ†ç»•è¿‡</td><td>âœ… å®Œå…¨æ§åˆ¶</td></tr></tbody></table><h3 id="4-2-Netflixç­‰æœåŠ¡çš„æ£€æµ‹æŠ€æœ¯å‡çº§"><a href="#4-2-Netflixç­‰æœåŠ¡çš„æ£€æµ‹æŠ€æœ¯å‡çº§" class="headerlink" title="4.2 Netflixç­‰æœåŠ¡çš„æ£€æµ‹æŠ€æœ¯å‡çº§"></a>4.2 Netflixç­‰æœåŠ¡çš„æ£€æµ‹æŠ€æœ¯å‡çº§</h3><p><strong>ç°ä»£æµåª’ä½“æœåŠ¡çš„æ£€æµ‹æ‰‹æ®µï¼š</strong></p><ol><li><strong>IPä¿¡èª‰æ•°æ®åº“</strong>ï¼šæ ‡è®°å·²çŸ¥çš„ä»£ç†æœåŠ¡å™¨IP</li><li><strong>æµé‡ç‰¹å¾åˆ†æ</strong>ï¼šåˆ†æç½‘ç»œå»¶è¿Ÿå’Œè·¯ç”±è·¯å¾„</li><li><strong>è®¾å¤‡æŒ‡çº¹è¯†åˆ«</strong>ï¼šç»¼åˆå¤šç§è®¾å¤‡å’Œç¯å¢ƒä¿¡æ¯</li><li><strong>è¡Œä¸ºæ¨¡å¼åˆ†æ</strong>ï¼šæ£€æµ‹å¼‚å¸¸çš„ä½¿ç”¨æ¨¡å¼</li><li><strong>WebRTC IPæ³„éœ²æ£€æµ‹</strong>ï¼šç»•è¿‡ä»£ç†è·å–çœŸå®IP</li></ol><p><strong>è¿™è§£é‡Šäº†ä¸ºä»€ä¹ˆï¼š</strong></p><ul><li>å¾ˆå¤šDNSè§£é”æœåŠ¡æ•ˆæœè¶Šæ¥è¶Šå·®</li><li>éœ€è¦ç»å¸¸æ›´æ¢ä»£ç†æœåŠ¡å™¨IP</li><li>æŸäº›æœåŠ¡ä¼šæ˜¾ç¤ºâ€æ£€æµ‹åˆ°ä»£ç†â€çš„é”™è¯¯</li></ul><h2 id="5-å®‰å…¨æ€§ä¸éšç§é£é™©è¯„ä¼°"><a href="#5-å®‰å…¨æ€§ä¸éšç§é£é™©è¯„ä¼°" class="headerlink" title="5. å®‰å…¨æ€§ä¸éšç§é£é™©è¯„ä¼°"></a>5. å®‰å…¨æ€§ä¸éšç§é£é™©è¯„ä¼°</h2><h3 id="5-1-é£é™©ç­‰çº§åˆ†æ"><a href="#5-1-é£é™©ç­‰çº§åˆ†æ" class="headerlink" title="5.1 é£é™©ç­‰çº§åˆ†æ"></a>5.1 é£é™©ç­‰çº§åˆ†æ</h3><pre class="mermaid">flowchart TD    A["DNSè§£é”å®‰å…¨é£é™©è¯„ä¼°"] --> B["é€æ˜ä»£ç† ğŸŸ¢"]    A --> C["HTTPä»£ç† ğŸŸ¢"]      A --> D["TLSä¸­é—´äºº ğŸ”´"]        B --> E["ä½é£é™©ï¼šæ— æ³•è§£å¯†HTTPS"]    C --> F["ä½é£é™©ï¼šåªè½¬å‘æ•°æ®"]    D --> G["æé«˜é£é™©ï¼šå®Œå…¨ç›‘æ§"]        E --> H["âœ… éšç§ç›¸å¯¹å®‰å…¨"]    F --> I["âœ… éšç§ç›¸å¯¹å®‰å…¨"]    G --> J["âŒ éšç§å®Œå…¨æš´éœ²"]</pre><h3 id="5-2-ç”¨æˆ·é€‰æ‹©å»ºè®®"><a href="#5-2-ç”¨æˆ·é€‰æ‹©å»ºè®®" class="headerlink" title="5.2 ç”¨æˆ·é€‰æ‹©å»ºè®®"></a>5.2 ç”¨æˆ·é€‰æ‹©å»ºè®®</h3><p><strong>ğŸŸ¢ æ¨èæ–¹æ¡ˆï¼ˆä½é£é™©ï¼‰ï¼š</strong></p><ul><li>ä½¿ç”¨é€æ˜ä»£ç†æˆ–HTTPä»£ç†çš„DNSè§£é”æœåŠ¡</li><li>ä¸éœ€è¦å®‰è£…ä»»ä½•è¯ä¹¦</li><li>éšç§é£é™©è¾ƒä½ï¼Œä½†åŠŸèƒ½å¯èƒ½æœ‰é™</li></ul><p><strong>ğŸŸ¡ è°¨æ…ä½¿ç”¨ï¼ˆä¸­ç­‰é£é™©ï¼‰ï¼š</strong></p><ul><li>çŸ¥åå•†ä¸šDNSè§£é”æœåŠ¡</li><li>äº†è§£å…¶å…·ä½“æŠ€æœ¯å®ç°æ–¹å¼</li><li>åœ¨åŠŸèƒ½å’Œéšç§ä¹‹é—´å¹³è¡¡é€‰æ‹©</li></ul><p><strong>ğŸ”´ é«˜åº¦è­¦æƒ•ï¼ˆé«˜é£é™©ï¼‰ï¼š</strong></p><ul><li>éœ€è¦å®‰è£…è¯ä¹¦çš„TLSä¸­é—´äººæœåŠ¡</li><li>ä»£ç†å¯ä»¥æŸ¥çœ‹æ‰€æœ‰HTTPSå†…å®¹</li><li>åªè€ƒè™‘æœ€å¯ä¿¡çš„å¤§å‹æœåŠ¡æä¾›å•†</li><li>é¿å…è¿›è¡Œæ•æ„Ÿæ“ä½œï¼ˆæ”¯ä»˜ã€ç™»å½•ç­‰ï¼‰</li></ul><h2 id="6-æ€»ç»“ä¸å»ºè®®"><a href="#6-æ€»ç»“ä¸å»ºè®®" class="headerlink" title="6. æ€»ç»“ä¸å»ºè®®"></a>6. æ€»ç»“ä¸å»ºè®®</h2><h3 id="6-1-æŠ€æœ¯æ€»ç»“"><a href="#6-1-æŠ€æœ¯æ€»ç»“" class="headerlink" title="6.1 æŠ€æœ¯æ€»ç»“"></a>6.1 æŠ€æœ¯æ€»ç»“</h3><p><strong>DNSè§£é”çš„æ ¸å¿ƒè®¤çŸ¥ï¼š</strong></p><ol><li><strong>æŠ€æœ¯å¤šæ ·æ€§</strong>ï¼šæœ‰å¤šç§ä¸åŒçš„å®ç°æ–¹å¼ï¼Œå®‰å…¨é£é™©å·®å¼‚å·¨å¤§</li><li><strong>åŠŸèƒ½æƒè¡¡</strong>ï¼šå®‰å…¨æ€§å’ŒåŠŸèƒ½å®Œæ•´æ€§å¾€å¾€æ˜¯çŸ›ç›¾çš„  </li><li><strong>æ£€æµ‹å‡çº§</strong>ï¼šæµåª’ä½“æœåŠ¡çš„åä»£ç†æŠ€æœ¯åœ¨ä¸æ–­è¿›æ­¥</li><li><strong>é€æ˜åº¦é‡è¦</strong>ï¼šäº†è§£æœåŠ¡çš„å…·ä½“æŠ€æœ¯å®ç°éå¸¸é‡è¦</li></ol><h3 id="6-2-ç”¨æˆ·å†³ç­–æ¡†æ¶"><a href="#6-2-ç”¨æˆ·å†³ç­–æ¡†æ¶" class="headerlink" title="6.2 ç”¨æˆ·å†³ç­–æ¡†æ¶"></a>6.2 ç”¨æˆ·å†³ç­–æ¡†æ¶</h3><p><strong>é€‰æ‹©DNSè§£é”æœåŠ¡æ—¶åº”è€ƒè™‘ï¼š</strong></p><ol><li><p><strong>æŠ€æœ¯å®ç°æ–¹å¼</strong></p><ul><li>ä¼˜å…ˆé€‰æ‹©é€æ˜ä»£ç†æˆ–HTTPä»£ç†</li><li>é¿å…éœ€è¦å®‰è£…è¯ä¹¦çš„æœåŠ¡</li></ul></li><li><p><strong>æœåŠ¡å•†ä¿¡èª‰</strong>  </p><ul><li>é€‰æ‹©çŸ¥ååº¦é«˜ã€å†å²æ‚ ä¹…çš„æœåŠ¡å•†</li><li>æŸ¥çœ‹ç”¨æˆ·è¯„ä»·å’ŒæŠ€æœ¯ç¤¾åŒºè®¨è®º</li></ul></li><li><p><strong>åŠŸèƒ½éœ€æ±‚</strong></p><ul><li>æ˜ç¡®è‡ªå·±çš„å®é™…éœ€æ±‚</li><li>ä¸è¦ä¸ºäº†åŠŸèƒ½è€Œç‰ºç‰²å®‰å…¨</li></ul></li><li><p><strong>é£é™©æ‰¿å—èƒ½åŠ›</strong></p><ul><li>è¯„ä¼°è‡ªå·±å¯¹éšç§é£é™©çš„æ‰¿å—ç¨‹åº¦</li><li>åˆ¶å®šç›¸åº”çš„ä½¿ç”¨ç­–ç•¥</li></ul></li></ol><h3 id="6-3-æœªæ¥å‘å±•è¶‹åŠ¿"><a href="#6-3-æœªæ¥å‘å±•è¶‹åŠ¿" class="headerlink" title="6.3 æœªæ¥å‘å±•è¶‹åŠ¿"></a>6.3 æœªæ¥å‘å±•è¶‹åŠ¿</h3><p><strong>æŠ€æœ¯å‘å±•æ–¹å‘ï¼š</strong></p><ul><li><strong>æ›´æ™ºèƒ½çš„æµé‡ä¼ªè£…</strong>ï¼šæ¨¡æ‹ŸçœŸå®ç”¨æˆ·è¡Œä¸º</li><li><strong>è¾¹ç¼˜è®¡ç®—éƒ¨ç½²</strong>ï¼šä½¿ç”¨CDNèŠ‚ç‚¹é™ä½æ£€æµ‹</li><li><strong>åè®®åˆ›æ–°</strong>ï¼šå¼€å‘ä¸“ç”¨çš„ä»£ç†åè®®</li><li><strong>AIæ£€æµ‹å¯¹æŠ—</strong>ï¼šä½¿ç”¨æœºå™¨å­¦ä¹ å¯¹æŠ—æ£€æµ‹ç®—æ³•</li></ul><p><strong>æ³•å¾‹åˆè§„è¶‹åŠ¿ï¼š</strong></p><ul><li>å„å›½å¯¹ä»£ç†æœåŠ¡çš„ç›‘ç®¡åŠ å¼º</li><li>ç‰ˆæƒä¿æŠ¤æŠ€æœ¯çš„ä¸æ–­å‡çº§</li><li>ç”¨æˆ·éœ€è¦æ›´åŠ æ³¨æ„åˆè§„ä½¿ç”¨</li></ul><hr><p><strong>å…è´£å£°æ˜ï¼š</strong> æœ¬æ–‡ä»…ä»æŠ€æœ¯è§’åº¦åˆ†æDNSè§£é”çš„å·¥ä½œåŸç†ï¼Œä¸æ„æˆä»»ä½•ä½¿ç”¨å»ºè®®ã€‚ç”¨æˆ·åœ¨ä½¿ç”¨ç›¸å…³æŠ€æœ¯æ—¶åº”éµå®ˆå½“åœ°æ³•å¾‹æ³•è§„å’ŒæœåŠ¡æ¡æ¬¾ï¼Œæ‰¿æ‹…ç›¸åº”çš„æ³•å¾‹è´£ä»»ã€‚ä»»ä½•æŠ€æœ¯éƒ½åº”è¯¥ç”¨äºåˆæ³•å’Œæ­£å½“çš„ç›®çš„ã€‚ </p>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DNS </tag>
            
            <tag> ä»£ç† </tag>
            
            <tag> ç½‘ç»œå®‰å…¨ </tag>
            
            <tag> æµåª’ä½“è§£é” </tag>
            
            <tag> åœ°ç†ä½ç½®é™åˆ¶ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¨‹åºåŒ–å¹¿å‘Šæ•°æ®å¤„ç†ä¸æŠ•æ”¾æŠ€æœ¯æ¶æ„ä¸ä¸šåŠ¡æ¨¡å¼</title>
      <link href="/2025/06/27/%E7%A8%8B%E5%BA%8F%E5%8C%96%E5%B9%BF%E5%91%8A%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E4%B8%8E%E6%8A%95%E6%94%BE%E4%B8%9A%E5%8A%A1%E6%A8%A1%E5%BC%8F%E4%B8%8E%E6%8A%80%E6%9C%AF%E6%9E%B6%E6%9E%84/"/>
      <url>/2025/06/27/%E7%A8%8B%E5%BA%8F%E5%8C%96%E5%B9%BF%E5%91%8A%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E4%B8%8E%E6%8A%95%E6%94%BE%E4%B8%9A%E5%8A%A1%E6%A8%A1%E5%BC%8F%E4%B8%8E%E6%8A%80%E6%9C%AF%E6%9E%B6%E6%9E%84/</url>
      
        <content type="html"><![CDATA[<h1 id="ç¨‹åºåŒ–å¹¿å‘Šæ•°æ®å¤„ç†ä¸æŠ•æ”¾ä¸šåŠ¡æ¨¡å¼ä¸æŠ€æœ¯æ¶æ„"><a href="#ç¨‹åºåŒ–å¹¿å‘Šæ•°æ®å¤„ç†ä¸æŠ•æ”¾ä¸šåŠ¡æ¨¡å¼ä¸æŠ€æœ¯æ¶æ„" class="headerlink" title="ç¨‹åºåŒ–å¹¿å‘Šæ•°æ®å¤„ç†ä¸æŠ•æ”¾ä¸šåŠ¡æ¨¡å¼ä¸æŠ€æœ¯æ¶æ„"></a>ç¨‹åºåŒ–å¹¿å‘Šæ•°æ®å¤„ç†ä¸æŠ•æ”¾ä¸šåŠ¡æ¨¡å¼ä¸æŠ€æœ¯æ¶æ„</h1><h2 id="ç›®å½•"><a href="#ç›®å½•" class="headerlink" title="ç›®å½•"></a>ç›®å½•</h2><ol><li><a href="#%E7%AC%AC%E4%B8%80%E7%AB%A0%E7%A8%8B%E5%BA%8F%E5%8C%96%E5%B9%BF%E5%91%8A%E6%A6%82%E8%BF%B0">ç¬¬ä¸€ç« ï¼šç¨‹åºåŒ–å¹¿å‘Šæ¦‚è¿°</a></li><li><a href="#%E7%AC%AC%E4%BA%8C%E7%AB%A0%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E4%B8%8E%E8%A7%92%E8%89%B2">ç¬¬äºŒç« ï¼šæ ¸å¿ƒæ¦‚å¿µä¸è§’è‰²</a></li><li><a href="#%E7%AC%AC%E4%B8%89%E7%AB%A0%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B%E8%AF%A6%E8%A7%A3">ç¬¬ä¸‰ç« ï¼šä¸šåŠ¡æµç¨‹è¯¦è§£</a></li><li><a href="#%E7%AC%AC%E5%9B%9B%E7%AB%A0%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E6%9E%B6%E6%9E%84">ç¬¬å››ç« ï¼šæ•°æ®å¤„ç†æ¶æ„</a></li><li><a href="#%E7%AC%AC%E4%BA%94%E7%AB%A0%E6%8A%80%E6%9C%AF%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1">ç¬¬äº”ç« ï¼šæŠ€æœ¯æ¶æ„è®¾è®¡</a></li><li><a href="#%E7%AC%AC%E5%85%AD%E7%AB%A0%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5">ç¬¬å…­ç« ï¼šæ€§èƒ½ä¼˜åŒ–ç­–ç•¥</a></li><li><a href="#%E7%AC%AC%E4%B8%83%E7%AB%A0%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E6%A1%88%E4%BE%8B">ç¬¬ä¸ƒç« ï¼šå®é™…åº”ç”¨æ¡ˆä¾‹</a></li><li><a href="#%E7%AC%AC%E5%85%AB%E7%AB%A0%E6%80%BB%E7%BB%93%E4%B8%8E%E4%B8%9A%E5%8A%A1%E4%BB%B7%E5%80%BC">ç¬¬å…«ç« ï¼šæ€»ç»“ä¸ä¸šåŠ¡ä»·å€¼</a></li></ol><h1 id="ç¬¬ä¸€ç« ï¼šç¨‹åºåŒ–å¹¿å‘Šæ¦‚è¿°"><a href="#ç¬¬ä¸€ç« ï¼šç¨‹åºåŒ–å¹¿å‘Šæ¦‚è¿°" class="headerlink" title="ç¬¬ä¸€ç« ï¼šç¨‹åºåŒ–å¹¿å‘Šæ¦‚è¿°"></a>ç¬¬ä¸€ç« ï¼šç¨‹åºåŒ–å¹¿å‘Šæ¦‚è¿°</h1><p>ç¨‹åºåŒ–å¹¿å‘Šï¼ˆProgrammatic Advertisingï¼‰æ˜¯ä¸€ç§åˆ©ç”¨è½¯ä»¶å’Œç®—æ³•è‡ªåŠ¨åŒ–è´­ä¹°å’ŒæŠ•æ”¾å¹¿å‘Šçš„æŠ€æœ¯ã€‚å®ƒé€šè¿‡å®æ—¶ç«ä»·ï¼ˆRTBï¼‰ã€æ•°æ®é©±åŠ¨å†³ç­–å’Œæœºå™¨å­¦ä¹ ç®—æ³•ï¼Œå®ç°å¹¿å‘ŠæŠ•æ”¾çš„ç²¾å‡†åŒ–ã€è‡ªåŠ¨åŒ–å’Œè§„æ¨¡åŒ–ã€‚</p><h2 id="1-1-ä¸ºä»€ä¹ˆéœ€è¦ç¨‹åºåŒ–å¹¿å‘Šï¼Ÿ"><a href="#1-1-ä¸ºä»€ä¹ˆéœ€è¦ç¨‹åºåŒ–å¹¿å‘Šï¼Ÿ" class="headerlink" title="1.1 ä¸ºä»€ä¹ˆéœ€è¦ç¨‹åºåŒ–å¹¿å‘Šï¼Ÿ"></a>1.1 ä¸ºä»€ä¹ˆéœ€è¦ç¨‹åºåŒ–å¹¿å‘Šï¼Ÿ</h2><p><strong>ä¼ ç»Ÿå¹¿å‘ŠæŠ•æ”¾çš„ç—›ç‚¹ï¼š</strong></p><ol><li><strong>æ•ˆç‡ä½ä¸‹</strong>ï¼šéœ€è¦äººå·¥æ´½è°ˆã€ç­¾çº¦ã€æ’æœŸï¼Œå‘¨æœŸé•¿è¾¾æ•°å¤©ç”šè‡³æ•°å‘¨</li><li><strong>ç²¾å‡†åº¦å·®</strong>ï¼šåªèƒ½åŸºäºåª’ä½“æ•´ä½“ç”¨æˆ·ç”»åƒï¼Œæ— æ³•åšåˆ°ä¸ªæ€§åŒ–æŠ•æ”¾</li><li><strong>é€æ˜åº¦ä½</strong>ï¼šå¹¿å‘Šä¸»æ— æ³•å®æ—¶äº†è§£æŠ•æ”¾æ•ˆæœå’Œèµ„é‡‘ä½¿ç”¨æƒ…å†µ</li><li><strong>è§„æ¨¡å—é™</strong>ï¼šäººå·¥æ“ä½œéš¾ä»¥ç®¡ç†å¤§é‡åª’ä½“èµ„æºå’Œå¹¿å‘Šä½</li></ol><p><strong>ç¨‹åºåŒ–å¹¿å‘Šçš„è§£å†³æ–¹æ¡ˆï¼š</strong></p><ul><li><strong>æ¯«ç§’çº§å†³ç­–</strong>ï¼šä»å¹¿å‘Šè¯·æ±‚åˆ°å±•ç¤ºå†³ç­–åœ¨100mså†…å®Œæˆ</li><li><strong>ä¸ªæ€§åŒ–å®šå‘</strong>ï¼šåŸºäºç”¨æˆ·å®æ—¶è¡Œä¸ºå’Œç”»åƒè¿›è¡Œç²¾å‡†æŠ•æ”¾</li><li><strong>å®æ—¶é€æ˜</strong>ï¼šæŠ•æ”¾æ•°æ®ã€æ•ˆæœæŒ‡æ ‡ã€é¢„ç®—æ¶ˆè€—å®æ—¶å¯è§</li><li><strong>è§„æ¨¡åŒ–ç®¡ç†</strong>ï¼šå•ä¸ªå¹³å°å¯ç®¡ç†æ•°ä¸‡ä¸ªå¹¿å‘Šè®¡åˆ’å’Œæ•°åƒä¸‡ç”¨æˆ·</li></ul><h2 id="1-2-æ ¸å¿ƒä»·å€¼ä¸ä¸šåŠ¡å½±å“"><a href="#1-2-æ ¸å¿ƒä»·å€¼ä¸ä¸šåŠ¡å½±å“" class="headerlink" title="1.2 æ ¸å¿ƒä»·å€¼ä¸ä¸šåŠ¡å½±å“"></a>1.2 æ ¸å¿ƒä»·å€¼ä¸ä¸šåŠ¡å½±å“</h2><h4 id="1-ç²¾å‡†æŠ•æ”¾ï¼šä»â€å¹¿æ’’ç½‘â€åˆ°â€ç²¾å‡†ç‹™å‡»â€"><a href="#1-ç²¾å‡†æŠ•æ”¾ï¼šä»â€å¹¿æ’’ç½‘â€åˆ°â€ç²¾å‡†ç‹™å‡»â€" class="headerlink" title="1. ç²¾å‡†æŠ•æ”¾ï¼šä»â€å¹¿æ’’ç½‘â€åˆ°â€ç²¾å‡†ç‹™å‡»â€"></a>1. ç²¾å‡†æŠ•æ”¾ï¼šä»â€å¹¿æ’’ç½‘â€åˆ°â€ç²¾å‡†ç‹™å‡»â€</h4><p><strong>ä¸šåŠ¡åœºæ™¯ï¼š</strong> ä¸€ä¸ªç”µå•†å¹³å°æƒ³æ¨å¹¿è¿åŠ¨é‹</p><ul><li><strong>ä¼ ç»Ÿæ–¹å¼ï¼š</strong> åœ¨ä½“è‚²ç½‘ç«™è´­ä¹°æ¨ªå¹…å¹¿å‘Šï¼Œè¦†ç›–æ‰€æœ‰è®¿é—®è€…</li><li><strong>ç¨‹åºåŒ–æ–¹å¼ï¼š</strong> åªå¯¹â€25-35å²ç”·æ€§+è¿‘æœŸæœç´¢è¿‡è¿åŠ¨é‹+æ”¶å…¥ä¸­ç­‰â€çš„ç”¨æˆ·å±•ç¤ºå¹¿å‘Š</li></ul><p><strong>æŠ€æœ¯å®ç°ï¼š</strong> é€šè¿‡DMPåˆ†æç”¨æˆ·è¡Œä¸ºï¼Œæ„å»ºç²¾å‡†äººç¾¤åŒ…ï¼ŒDSPæ ¹æ®ç”¨æˆ·æ ‡ç­¾å®æ—¶å†³ç­–</p><h4 id="2-å®æ—¶ä¼˜åŒ–ï¼šä»â€è®¾ç½®åç­‰å¾…â€åˆ°â€å®æ—¶è°ƒæ•´â€"><a href="#2-å®æ—¶ä¼˜åŒ–ï¼šä»â€è®¾ç½®åç­‰å¾…â€åˆ°â€å®æ—¶è°ƒæ•´â€" class="headerlink" title="2. å®æ—¶ä¼˜åŒ–ï¼šä»â€è®¾ç½®åç­‰å¾…â€åˆ°â€å®æ—¶è°ƒæ•´â€"></a>2. å®æ—¶ä¼˜åŒ–ï¼šä»â€è®¾ç½®åç­‰å¾…â€åˆ°â€å®æ—¶è°ƒæ•´â€</h4><p><strong>ä¸šåŠ¡åœºæ™¯ï¼š</strong> å‘ç°æŸä¸ªåˆ›æ„ç´ æCTRï¼ˆç‚¹å‡»ç‡ï¼‰åä½</p><ul><li><strong>ä¼ ç»Ÿæ–¹å¼ï¼š</strong> éœ€è¦ç­‰åˆ°æŠ•æ”¾ç»“æŸååˆ†ææ•°æ®ï¼Œä¸‹æ¬¡æŠ•æ”¾æ—¶è°ƒæ•´</li><li><strong>ç¨‹åºåŒ–æ–¹å¼ï¼š</strong> å®æ—¶ç›‘æµ‹CTRï¼Œè‡ªåŠ¨å‡å°‘ä½æ•ˆåˆ›æ„çš„å±•ç¤ºé¢‘ç‡ï¼Œå¢åŠ é«˜æ•ˆåˆ›æ„çš„æŠ•æ”¾</li></ul><p><strong>æŠ€æœ¯å®ç°ï¼š</strong> é€šè¿‡æµå¼æ•°æ®å¤„ç†å®æ—¶è®¡ç®—æ•ˆæœæŒ‡æ ‡ï¼Œç«ä»·ç®—æ³•åŠ¨æ€è°ƒæ•´å‡ºä»·ç­–ç•¥</p><h4 id="3-è§„æ¨¡åŒ–æ“ä½œï¼šä»â€äººå·¥ç®¡ç†â€åˆ°â€ç®—æ³•é©±åŠ¨â€"><a href="#3-è§„æ¨¡åŒ–æ“ä½œï¼šä»â€äººå·¥ç®¡ç†â€åˆ°â€ç®—æ³•é©±åŠ¨â€" class="headerlink" title="3. è§„æ¨¡åŒ–æ“ä½œï¼šä»â€äººå·¥ç®¡ç†â€åˆ°â€ç®—æ³•é©±åŠ¨â€"></a>3. è§„æ¨¡åŒ–æ“ä½œï¼šä»â€äººå·¥ç®¡ç†â€åˆ°â€ç®—æ³•é©±åŠ¨â€</h4><p><strong>ä¸šåŠ¡åœºæ™¯ï¼š</strong> ç®¡ç†1000ä¸ªä¸åŒçš„å¹¿å‘Šè®¡åˆ’</p><ul><li><strong>ä¼ ç»Ÿæ–¹å¼ï¼š</strong> éœ€è¦å¤§é‡è¿è¥äººå‘˜é€ä¸ªç›‘æ§å’Œè°ƒæ•´</li><li><strong>ç¨‹åºåŒ–æ–¹å¼ï¼š</strong> ç®—æ³•è‡ªåŠ¨æ ¹æ®é¢„è®¾è§„åˆ™å’Œå­¦ä¹ ç»“æœè¿›è¡Œä¼˜åŒ–</li></ul><p><strong>æŠ€æœ¯å®ç°ï¼š</strong> é€šè¿‡æœºå™¨å­¦ä¹ ç®—æ³•é¢„æµ‹CTR&#x2F;CVRï¼Œè‡ªåŠ¨åŒ–ç«ä»·å’Œé¢„ç®—åˆ†é…</p><h4 id="4-æ•°æ®é©±åŠ¨ï¼šä»â€ç»éªŒå†³ç­–â€åˆ°â€æ•°æ®å†³ç­–â€"><a href="#4-æ•°æ®é©±åŠ¨ï¼šä»â€ç»éªŒå†³ç­–â€åˆ°â€æ•°æ®å†³ç­–â€" class="headerlink" title="4. æ•°æ®é©±åŠ¨ï¼šä»â€ç»éªŒå†³ç­–â€åˆ°â€æ•°æ®å†³ç­–â€"></a>4. æ•°æ®é©±åŠ¨ï¼šä»â€ç»éªŒå†³ç­–â€åˆ°â€æ•°æ®å†³ç­–â€</h4><p><strong>ä¸šåŠ¡åœºæ™¯ï¼š</strong> ç¡®å®šæœ€ä½³æŠ•æ”¾æ—¶é—´æ®µ</p><ul><li><strong>ä¼ ç»Ÿæ–¹å¼ï¼š</strong> åŸºäºè¿è¥ç»éªŒæ¨æµ‹ç”¨æˆ·æ´»è·ƒæ—¶é—´</li><li><strong>ç¨‹åºåŒ–æ–¹å¼ï¼š</strong> åˆ†æç›®æ ‡ç”¨æˆ·ç¾¤ä½“çš„å†å²è¡Œä¸ºæ•°æ®ï¼Œæ‰¾å‡ºæœ€ä½³æŠ•æ”¾æ—¶æœº</li></ul><p><strong>æŠ€æœ¯å®ç°ï¼š</strong> é€šè¿‡å¤§æ•°æ®åˆ†æç”¨æˆ·è¡Œä¸ºæ¨¡å¼ï¼Œä¸ºæ¯ä¸ªç”¨æˆ·ç¾¤ä½“å®šåˆ¶æŠ•æ”¾ç­–ç•¥</p><h1 id="ç¬¬äºŒç« ï¼šæ ¸å¿ƒæ¦‚å¿µä¸è§’è‰²"><a href="#ç¬¬äºŒç« ï¼šæ ¸å¿ƒæ¦‚å¿µä¸è§’è‰²" class="headerlink" title="ç¬¬äºŒç« ï¼šæ ¸å¿ƒæ¦‚å¿µä¸è§’è‰²"></a>ç¬¬äºŒç« ï¼šæ ¸å¿ƒæ¦‚å¿µä¸è§’è‰²</h1><h2 id="2-1-ç¨‹åºåŒ–å¹¿å‘Šçš„å•†ä¸šç”Ÿæ€ï¼šè°å‡ºé’±ï¼Œè°èµšé’±ï¼Œè°è´Ÿè´£"><a href="#2-1-ç¨‹åºåŒ–å¹¿å‘Šçš„å•†ä¸šç”Ÿæ€ï¼šè°å‡ºé’±ï¼Œè°èµšé’±ï¼Œè°è´Ÿè´£" class="headerlink" title="2.1 ç¨‹åºåŒ–å¹¿å‘Šçš„å•†ä¸šç”Ÿæ€ï¼šè°å‡ºé’±ï¼Œè°èµšé’±ï¼Œè°è´Ÿè´£"></a>2.1 ç¨‹åºåŒ–å¹¿å‘Šçš„å•†ä¸šç”Ÿæ€ï¼šè°å‡ºé’±ï¼Œè°èµšé’±ï¼Œè°è´Ÿè´£</h2><p>åœ¨äº†è§£æŠ€æœ¯ç»†èŠ‚ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆç†è§£ç¨‹åºåŒ–å¹¿å‘Šçš„å•†ä¸šé€»è¾‘ã€‚ç®€å•æ¥è¯´ï¼š</p><ul><li><strong>å¹¿å‘Šä¸»å‡ºé’±</strong>ä¹°æµé‡è·å¾—æ›å…‰å’Œè½¬åŒ–</li><li><strong>åª’ä½“æ–¹å‡ºæµé‡</strong>èµšå–å¹¿å‘Šè´¹</li><li><strong>æŠ€æœ¯å¹³å°æä¾›æœåŠ¡</strong>ä»ä¸­æ”¶å–æœåŠ¡è´¹</li></ul><h2 id="2-3-ä¸»è¦å‚ä¸æ–¹åŠå…¶åˆ©ç›Šå…³ç³»"><a href="#2-3-ä¸»è¦å‚ä¸æ–¹åŠå…¶åˆ©ç›Šå…³ç³»" class="headerlink" title="2.3 ä¸»è¦å‚ä¸æ–¹åŠå…¶åˆ©ç›Šå…³ç³»"></a>2.3 ä¸»è¦å‚ä¸æ–¹åŠå…¶åˆ©ç›Šå…³ç³»</h2><h4 id="1-å¹¿å‘Šä¸»ï¼ˆAdvertiserï¼‰-å‡ºé’±çš„ä¸€æ–¹"><a href="#1-å¹¿å‘Šä¸»ï¼ˆAdvertiserï¼‰-å‡ºé’±çš„ä¸€æ–¹" class="headerlink" title="1. å¹¿å‘Šä¸»ï¼ˆAdvertiserï¼‰- å‡ºé’±çš„ä¸€æ–¹"></a>1. å¹¿å‘Šä¸»ï¼ˆAdvertiserï¼‰- å‡ºé’±çš„ä¸€æ–¹</h4><ul><li><strong>è§’è‰²å®šä½</strong>ï¼šèŠ±é’±ä¹°å¹¿å‘Šæ•ˆæœçš„ä¼ä¸šæˆ–ä¸ªäºº</li><li><strong>ä»˜è´¹å¯¹è±¡</strong>ï¼šå‘DSPå¹³å°ä»˜è´¹è´­ä¹°å¹¿å‘ŠæŠ•æ”¾æœåŠ¡</li><li><strong>æ ¸å¿ƒè¯‰æ±‚</strong>ï¼šç”¨æœ€å°‘çš„é’±è·å¾—æœ€å¥½çš„å¹¿å‘Šæ•ˆæœï¼ˆé«˜CTRã€é«˜è½¬åŒ–ç‡ï¼‰</li><li><strong>å…¸å‹å®¢æˆ·</strong>ï¼šç”µå•†å¹³å°ã€æ¸¸æˆå…¬å¸ã€é‡‘èæœºæ„ã€å“ç‰Œå‚å•†</li></ul><p><strong>ä¸¾ä¾‹</strong>ï¼šæŸæ‰‹æœºå“ç‰Œè¦æ¨å¹¿æ–°æ¬¾æ‰‹æœºï¼Œé¢„ç®—100ä¸‡å…ƒï¼Œå¸Œæœ›ç²¾å‡†æŠ•æ”¾ç»™â€25-35å²ã€æ”¶å…¥ä¸­ç­‰ã€å…³æ³¨æ•°ç äº§å“â€çš„ç”¨æˆ·ç¾¤ä½“ã€‚</p><h4 id="2-DSPï¼ˆDemand-Side-Platformï¼‰-éœ€æ±‚æ–¹å¹³å°ï¼ˆæœåŠ¡å¹¿å‘Šä¸»ï¼‰"><a href="#2-DSPï¼ˆDemand-Side-Platformï¼‰-éœ€æ±‚æ–¹å¹³å°ï¼ˆæœåŠ¡å¹¿å‘Šä¸»ï¼‰" class="headerlink" title="2. DSPï¼ˆDemand Side Platformï¼‰- éœ€æ±‚æ–¹å¹³å°ï¼ˆæœåŠ¡å¹¿å‘Šä¸»ï¼‰"></a>2. DSPï¼ˆDemand Side Platformï¼‰- éœ€æ±‚æ–¹å¹³å°ï¼ˆæœåŠ¡å¹¿å‘Šä¸»ï¼‰</h4><ul><li><strong>æœåŠ¡å¯¹è±¡</strong>ï¼šå¹¿å‘Šä¸»</li><li><strong>ç›ˆåˆ©æ¨¡å¼</strong>ï¼šæ”¶å–å¹¿å‘ŠæŠ•æ”¾æœåŠ¡è´¹ï¼ˆé€šå¸¸æ˜¯å¹¿å‘ŠèŠ±è´¹çš„10-20%ï¼‰</li><li><strong>æ ¸å¿ƒä»·å€¼</strong>ï¼šå¸®åŠ©å¹¿å‘Šä¸»èŠ±æ›´å°‘çš„é’±è·å¾—æ›´å¥½çš„æ•ˆæœ</li><li><strong>ä¸»è¦å·¥ä½œ</strong>ï¼šç«ä»·å†³ç­–ã€é¢„ç®—ç®¡ç†ã€æ•ˆæœä¼˜åŒ–ã€æŠ¥å‘Šåˆ†æ</li></ul><p><strong>ä¸¾ä¾‹</strong>ï¼šDSPå¹³å°å¸®æ‰‹æœºå“ç‰Œç®¡ç†100ä¸‡é¢„ç®—ï¼Œé€šè¿‡ç®—æ³•ä¼˜åŒ–ï¼Œæœ€ç»ˆèŠ±è´¹95ä¸‡è·å¾—äº†é¢„æœŸæ•ˆæœï¼ŒDSPæ”¶å–15ä¸‡æœåŠ¡è´¹ã€‚</p><h4 id="3-åª’ä½“æ–¹ï¼ˆPublisherï¼‰-å‡ºå”®æµé‡çš„ä¸€æ–¹"><a href="#3-åª’ä½“æ–¹ï¼ˆPublisherï¼‰-å‡ºå”®æµé‡çš„ä¸€æ–¹" class="headerlink" title="3. åª’ä½“æ–¹ï¼ˆPublisherï¼‰- å‡ºå”®æµé‡çš„ä¸€æ–¹"></a>3. åª’ä½“æ–¹ï¼ˆPublisherï¼‰- å‡ºå”®æµé‡çš„ä¸€æ–¹</h4><ul><li><strong>è§’è‰²å®šä½</strong>ï¼šæ‹¥æœ‰ç”¨æˆ·æµé‡çš„ç½‘ç«™ã€APPç­‰</li><li><strong>æ”¶å…¥æ¥æº</strong>ï¼šå‡ºå”®å¹¿å‘Šä½è·å¾—å¹¿å‘Šæ”¶å…¥</li><li><strong>æ ¸å¿ƒè¯‰æ±‚</strong>ï¼šåœ¨ä¸å½±å“ç”¨æˆ·ä½“éªŒçš„å‰æä¸‹æœ€å¤§åŒ–å¹¿å‘Šæ”¶å…¥</li><li><strong>å…¸å‹åª’ä½“</strong>ï¼šæ–°é—»ç½‘ç«™ã€è§†é¢‘å¹³å°ã€ç¤¾äº¤åª’ä½“ã€å·¥å…·APP</li></ul><p><strong>ä¸¾ä¾‹</strong>ï¼šæŸæ–°é—»APPæ¯å¤©æœ‰100ä¸‡æ´»è·ƒç”¨æˆ·ï¼Œé€šè¿‡å±•ç¤ºå¹¿å‘Šæ¯å¤©å¯ä»¥è·å¾—1ä¸‡å…ƒå¹¿å‘Šæ”¶å…¥ã€‚</p><h4 id="4-SSPï¼ˆSupply-Side-Platformï¼‰-ä¾›åº”æ–¹å¹³å°ï¼ˆæœåŠ¡åª’ä½“æ–¹ï¼‰"><a href="#4-SSPï¼ˆSupply-Side-Platformï¼‰-ä¾›åº”æ–¹å¹³å°ï¼ˆæœåŠ¡åª’ä½“æ–¹ï¼‰" class="headerlink" title="4. SSPï¼ˆSupply Side Platformï¼‰- ä¾›åº”æ–¹å¹³å°ï¼ˆæœåŠ¡åª’ä½“æ–¹ï¼‰"></a>4. SSPï¼ˆSupply Side Platformï¼‰- ä¾›åº”æ–¹å¹³å°ï¼ˆæœåŠ¡åª’ä½“æ–¹ï¼‰</h4><ul><li><strong>æœåŠ¡å¯¹è±¡</strong>ï¼šåª’ä½“æ–¹</li><li><strong>ç›ˆåˆ©æ¨¡å¼</strong>ï¼šä»åª’ä½“å¹¿å‘Šæ”¶å…¥ä¸­æŠ½å–åˆ†æˆï¼ˆé€šå¸¸æ˜¯10-30%ï¼‰</li><li><strong>æ ¸å¿ƒä»·å€¼</strong>ï¼šå¸®åŠ©åª’ä½“æ–¹è·å¾—æ›´é«˜çš„å¹¿å‘Šæ”¶å…¥</li><li><strong>ä¸»è¦å·¥ä½œ</strong>ï¼šåº“å­˜ç®¡ç†ã€ä»·æ ¼ä¼˜åŒ–ã€åä½œå¼Šã€æ”¶ç›Šåˆ†æ</li></ul><p><strong>ä¸¾ä¾‹</strong>ï¼šSSPå¸®æ–°é—»APPä¼˜åŒ–å¹¿å‘Šå±•ç¤ºç­–ç•¥ï¼Œå°†æ—¥æ”¶å…¥ä»1ä¸‡å…ƒæå‡åˆ°1.3ä¸‡å…ƒï¼ŒSSPæŠ½å–20%åˆ†æˆï¼ˆ2600å…ƒï¼‰ã€‚</p><h4 id="5-AdXï¼ˆAd-Exchangeï¼‰-å¹¿å‘Šäº¤æ˜“å¹³å°ï¼ˆæ’®åˆäº¤æ˜“ï¼‰"><a href="#5-AdXï¼ˆAd-Exchangeï¼‰-å¹¿å‘Šäº¤æ˜“å¹³å°ï¼ˆæ’®åˆäº¤æ˜“ï¼‰" class="headerlink" title="5. AdXï¼ˆAd Exchangeï¼‰- å¹¿å‘Šäº¤æ˜“å¹³å°ï¼ˆæ’®åˆäº¤æ˜“ï¼‰"></a>5. AdXï¼ˆAd Exchangeï¼‰- å¹¿å‘Šäº¤æ˜“å¹³å°ï¼ˆæ’®åˆäº¤æ˜“ï¼‰</h4><ul><li><strong>æœåŠ¡å¯¹è±¡</strong>ï¼šDSPå’ŒSSPåŒæ–¹</li><li><strong>ç›ˆåˆ©æ¨¡å¼</strong>ï¼šæ”¶å–äº¤æ˜“æ‰‹ç»­è´¹ï¼ˆæ¯æ¬¡äº¤æ˜“æ”¶å–å°é¢è´¹ç”¨ï¼‰</li><li><strong>æ ¸å¿ƒä»·å€¼</strong>ï¼šæä¾›é€æ˜ã€é«˜æ•ˆçš„äº¤æ˜“æ’®åˆæœåŠ¡</li><li><strong>ä¸»è¦å·¥ä½œ</strong>ï¼šå®æ—¶ç«ä»·æ’®åˆã€èµ„é‡‘ç»“ç®—ã€æ•°æ®ä¼ è¾“</li></ul><p><strong>ä¸¾ä¾‹</strong>ï¼šAdXæ¯å¤©æ’®åˆæ•°ç™¾ä¸‡æ¬¡å¹¿å‘Šäº¤æ˜“ï¼Œæ¯æ¬¡äº¤æ˜“æ”¶å–0.01å…ƒæ‰‹ç»­è´¹ã€‚</p><h4 id="6-DMPï¼ˆData-Management-Platformï¼‰-æ•°æ®ç®¡ç†å¹³å°ï¼ˆæä¾›æ•°æ®æœåŠ¡ï¼‰"><a href="#6-DMPï¼ˆData-Management-Platformï¼‰-æ•°æ®ç®¡ç†å¹³å°ï¼ˆæä¾›æ•°æ®æœåŠ¡ï¼‰" class="headerlink" title="6. DMPï¼ˆData Management Platformï¼‰- æ•°æ®ç®¡ç†å¹³å°ï¼ˆæä¾›æ•°æ®æœåŠ¡ï¼‰"></a>6. DMPï¼ˆData Management Platformï¼‰- æ•°æ®ç®¡ç†å¹³å°ï¼ˆæä¾›æ•°æ®æœåŠ¡ï¼‰</h4><ul><li><strong>æœåŠ¡å¯¹è±¡</strong>ï¼šDSPã€SSPã€å¹¿å‘Šä¸»</li><li><strong>ç›ˆåˆ©æ¨¡å¼</strong>ï¼šå‡ºå”®æ•°æ®æœåŠ¡æˆ–æŒ‰ä½¿ç”¨é‡æ”¶è´¹</li><li><strong>æ ¸å¿ƒä»·å€¼</strong>ï¼šæä¾›ç²¾å‡†çš„ç”¨æˆ·æ•°æ®å’Œç”»åƒæœåŠ¡</li><li><strong>ä¸»è¦å·¥ä½œ</strong>ï¼šæ•°æ®æ”¶é›†ã€ç”¨æˆ·ç”»åƒã€äººç¾¤å®šå‘</li></ul><p><strong>ä¸¾ä¾‹</strong>ï¼šDMPå‘DSPæä¾›ç”¨æˆ·æ ‡ç­¾æ•°æ®ï¼ŒæŒ‰æ¯åƒæ¬¡æŸ¥è¯¢æ”¶å–10å…ƒè´¹ç”¨ã€‚</p><h2 id="2-4-èµ„é‡‘æµå‘ä¸åˆ©ç›Šåˆ†é…"><a href="#2-4-èµ„é‡‘æµå‘ä¸åˆ©ç›Šåˆ†é…" class="headerlink" title="2.4 èµ„é‡‘æµå‘ä¸åˆ©ç›Šåˆ†é…"></a>2.4 èµ„é‡‘æµå‘ä¸åˆ©ç›Šåˆ†é…</h2><pre class="mermaid">flowchart TD    A[å¹¿å‘Šä¸»] -->|æŠ•æ”¾é¢„ç®—100ä¸‡| B[DSPå¹³å°]    B -->|æœåŠ¡è´¹15ä¸‡| A    B -->|ç«ä»·85ä¸‡| C[AdXäº¤æ˜“å¹³å°]    C -->|æ‰‹ç»­è´¹1ä¸‡| B    C -->|å¹¿å‘Šè´¹84ä¸‡| D[SSPå¹³å°]    D -->|åˆ†æˆ17ä¸‡| C    D -->|å¹¿å‘Šæ”¶å…¥67ä¸‡| E[åª’ä½“æ–¹]        F[DMPå¹³å°] -->|æ•°æ®æœåŠ¡5ä¸‡| B    B -->|æ•°æ®è´¹ç”¨5ä¸‡| F        subgraph "æ”¶å…¥åˆ†é…"        G[DSPæ”¶å…¥: 15ä¸‡æœåŠ¡è´¹]        H[SSPæ”¶å…¥: 17ä¸‡åˆ†æˆ]        I[AdXæ”¶å…¥: 1ä¸‡æ‰‹ç»­è´¹]        J[DMPæ”¶å…¥: 5ä¸‡æ•°æ®è´¹]        K[åª’ä½“æ”¶å…¥: 67ä¸‡å¹¿å‘Šè´¹]    end        style A fill:#ff9999    style E fill:#99ff99    style B fill:#99ccff    style D fill:#99ccff    style C fill:#ffcc99    style F fill:#cc99ff</pre><h2 id="2-5-æœåŠ¡å…³ç³»ä¸è´£ä»»é“¾"><a href="#2-5-æœåŠ¡å…³ç³»ä¸è´£ä»»é“¾" class="headerlink" title="2.5 æœåŠ¡å…³ç³»ä¸è´£ä»»é“¾"></a>2.5 æœåŠ¡å…³ç³»ä¸è´£ä»»é“¾</h2><h4 id="è°å¯¹è°è´Ÿè´£ï¼Ÿ"><a href="#è°å¯¹è°è´Ÿè´£ï¼Ÿ" class="headerlink" title="è°å¯¹è°è´Ÿè´£ï¼Ÿ"></a>è°å¯¹è°è´Ÿè´£ï¼Ÿ</h4><p><strong>1. DSPå¯¹å¹¿å‘Šä¸»è´Ÿè´£</strong></p><ul><li><strong>è´£ä»»</strong>ï¼šç¡®ä¿å¹¿å‘ŠæŠ•æ”¾æ•ˆæœï¼Œåˆç†ä½¿ç”¨é¢„ç®—</li><li><strong>è€ƒæ ¸æŒ‡æ ‡</strong>ï¼šCTRï¼ˆç‚¹å‡»ç‡ï¼‰ã€CVRï¼ˆè½¬åŒ–ç‡ï¼‰ã€CPAï¼ˆè·å®¢æˆæœ¬ï¼‰</li><li><strong>é—®è´£æœºåˆ¶</strong>ï¼šæ•ˆæœä¸è¾¾æ ‡éœ€è¦é€€æ¬¾æˆ–è¡¥é‡</li></ul><p><strong>2. SSPå¯¹åª’ä½“æ–¹è´Ÿè´£</strong></p><ul><li><strong>è´£ä»»</strong>ï¼šç¡®ä¿åª’ä½“æ–¹å¹¿å‘Šæ”¶å…¥æœ€å¤§åŒ–ï¼Œä¿æŠ¤åª’ä½“å“ç‰Œ</li><li><strong>è€ƒæ ¸æŒ‡æ ‡</strong>ï¼šCPMï¼ˆåƒæ¬¡å±•ç¤ºæ”¶å…¥ï¼‰ã€å¡«å……ç‡ã€ç”¨æˆ·ä½“éªŒ</li><li><strong>é—®è´£æœºåˆ¶</strong>ï¼šæ”¶å…¥ä¸‹é™æˆ–å“ç‰Œå—æŸéœ€è¦èµ”å¿</li></ul><p><strong>3. AdXå¯¹äº¤æ˜“åŒæ–¹è´Ÿè´£</strong></p><ul><li><strong>è´£ä»»</strong>ï¼šç¡®ä¿äº¤æ˜“å…¬å¹³ã€é€æ˜ã€å®‰å…¨</li><li><strong>è€ƒæ ¸æŒ‡æ ‡</strong>ï¼šäº¤æ˜“æˆåŠŸç‡ã€èµ„é‡‘å®‰å…¨ã€æ•°æ®ä¿æŠ¤</li><li><strong>é—®è´£æœºåˆ¶</strong>ï¼šäº¤æ˜“çº çº·éœ€è¦ä»²è£å’Œèµ”ä»˜</li></ul><p><strong>4. DMPå¯¹æ•°æ®ä½¿ç”¨æ–¹è´Ÿè´£</strong></p><ul><li><strong>è´£ä»»</strong>ï¼šç¡®ä¿æ•°æ®å‡†ç¡®æ€§å’Œåˆè§„æ€§</li><li><strong>è€ƒæ ¸æŒ‡æ ‡</strong>ï¼šæ•°æ®è´¨é‡ã€éšç§åˆè§„ã€æœåŠ¡ç¨³å®šæ€§</li><li><strong>é—®è´£æœºåˆ¶</strong>ï¼šæ•°æ®é”™è¯¯æˆ–æ³„éœ²éœ€è¦æ‰¿æ‹…æ³•å¾‹è´£ä»»</li></ul><h2 id="2-6-å®é™…å•†ä¸šæ¡ˆä¾‹è§£æ"><a href="#2-6-å®é™…å•†ä¸šæ¡ˆä¾‹è§£æ" class="headerlink" title="2.6 å®é™…å•†ä¸šæ¡ˆä¾‹è§£æ"></a>2.6 å®é™…å•†ä¸šæ¡ˆä¾‹è§£æ</h2><p><strong>æ¡ˆä¾‹ï¼šç”µå•†å¹³å°åŒ11å¹¿å‘ŠæŠ•æ”¾</strong></p><p><strong>å‚ä¸æ–¹è§’è‰²ï¼š</strong></p><ul><li><strong>å¹¿å‘Šä¸»</strong>ï¼šæŸç”µå•†å¹³å°ï¼Œé¢„ç®—5000ä¸‡å…ƒ</li><li><strong>DSP</strong>ï¼šæŸç¨‹åºåŒ–å¹¿å‘Šå¹³å°ï¼ŒæœåŠ¡è´¹15%</li><li><strong>åª’ä½“æ–¹</strong>ï¼šå„å¤§æ–°é—»ã€è§†é¢‘ã€ç¤¾äº¤å¹³å°</li><li><strong>SSP</strong>ï¼šå„åª’ä½“è‡ªæœ‰æˆ–ç¬¬ä¸‰æ–¹å˜ç°å¹³å°</li><li><strong>AdX</strong>ï¼šç»Ÿä¸€çš„å¹¿å‘Šäº¤æ˜“å¹³å°</li><li><strong>DMP</strong>ï¼šæä¾›åŒ11ç”¨æˆ·è´­ç‰©æ„å‘æ•°æ®</li></ul><p><strong>èµ„é‡‘æµå‘ï¼š</strong></p><ol><li>ç”µå•†å¹³å°å‘DSPæ”¯ä»˜5000ä¸‡é¢„ç®—</li><li>DSPæ”¶å–750ä¸‡æœåŠ¡è´¹ï¼Œç”¨4250ä¸‡è¿›è¡ŒæŠ•æ”¾</li><li>é€šè¿‡AdXå¹³å°ï¼Œæœ€ç»ˆ4000ä¸‡åˆ°è¾¾å„åª’ä½“æ–¹</li><li>å„ç¯èŠ‚å¹³å°æŒ‰çº¦å®šæ¯”ä¾‹åˆ†æˆ</li></ol><p><strong>æ•ˆæœè¯„ä¼°ï¼š</strong></p><ul><li>ç”µå•†å¹³å°è·å¾—1000ä¸‡æ–°ç”¨æˆ·æ³¨å†Œï¼Œå¹³å‡è·å®¢æˆæœ¬50å…ƒ</li><li>åª’ä½“æ–¹è·å¾—4000ä¸‡å¹¿å‘Šæ”¶å…¥ï¼Œç”¨æˆ·ä½“éªŒæœªå—å½±å“  </li><li>å„æŠ€æœ¯å¹³å°è·å¾—åˆç†æœåŠ¡è´¹ï¼ŒæŠ€æœ¯èƒ½åŠ›å¾—åˆ°éªŒè¯</li></ul><p>è¿™ä¸ªç”Ÿæ€ç³»ç»Ÿçš„æ ¸å¿ƒæ˜¯<strong>å¤šæ–¹å…±èµ¢</strong>ï¼šå¹¿å‘Šä¸»è·å¾—ç²¾å‡†æµé‡ï¼Œåª’ä½“æ–¹è·å¾—å¹¿å‘Šæ”¶å…¥ï¼ŒæŠ€æœ¯å¹³å°è·å¾—æœåŠ¡è´¹ï¼Œç”¨æˆ·çœ‹åˆ°ç›¸å…³æ€§æ›´é«˜çš„å¹¿å‘Šã€‚</p><h2 id="2-2-æŠ€æœ¯ç”Ÿæ€å›¾"><a href="#2-2-æŠ€æœ¯ç”Ÿæ€å›¾" class="headerlink" title="2.2 æŠ€æœ¯ç”Ÿæ€å›¾"></a>2.2 æŠ€æœ¯ç”Ÿæ€å›¾</h2><pre class="mermaid">graph TB    A[å¹¿å‘Šä¸»] --> B[DSPéœ€æ±‚æ–¹å¹³å°]    B --> C[AdXå¹¿å‘Šäº¤æ˜“å¹³å°]    D[SSPä¾›åº”æ–¹å¹³å°] --> C    E[åª’ä½“æ–¹] --> D    F[DMPæ•°æ®ç®¡ç†å¹³å°] --> B    F --> D    G[ç”¨æˆ·æ•°æ®æº] --> F    H[ç¬¬ä¸‰æ–¹æ•°æ®] --> F        subgraph "å®æ—¶ç«ä»·ç”Ÿæ€"        C --> I[RTBå®æ—¶ç«ä»·]        I --> J[ç«ä»·å“åº”]        J --> K[å¹¿å‘Šå±•ç¤º]    end        subgraph "æ•°æ®æµè½¬"        L[ç”¨æˆ·è¡Œä¸ºæ•°æ®] --> F        M[å¹¿å‘Šæ•ˆæœæ•°æ®] --> F        N[åª’ä½“åº“å­˜æ•°æ®] --> D    end</pre><h1 id="ç¬¬ä¸‰ç« ï¼šä¸šåŠ¡æµç¨‹è¯¦è§£"><a href="#ç¬¬ä¸‰ç« ï¼šä¸šåŠ¡æµç¨‹è¯¦è§£" class="headerlink" title="ç¬¬ä¸‰ç« ï¼šä¸šåŠ¡æµç¨‹è¯¦è§£"></a>ç¬¬ä¸‰ç« ï¼šä¸šåŠ¡æµç¨‹è¯¦è§£</h1><h2 id="3-1-RTBå®æ—¶ç«ä»·æµç¨‹"><a href="#3-1-RTBå®æ—¶ç«ä»·æµç¨‹" class="headerlink" title="3.1 RTBå®æ—¶ç«ä»·æµç¨‹"></a>3.1 RTBå®æ—¶ç«ä»·æµç¨‹</h2><pre class="mermaid">sequenceDiagram    participant User as ç”¨æˆ·    participant Media as åª’ä½“ç½‘ç«™    participant SSP as SSPå¹³å°    participant AdX as AdXäº¤æ˜“å¹³å°    participant DSP as DSPå¹³å°    participant DMP as DMPå¹³å°    participant Advertiser as å¹¿å‘Šä¸»        User->>Media: è®¿é—®ç½‘é¡µ    Media->>SSP: å‘èµ·å¹¿å‘Šè¯·æ±‚    SSP->>AdX: æäº¤å¹¿å‘Šä½ä¿¡æ¯    AdX->>DSP: å‘é€ç«ä»·è¯·æ±‚ï¼ˆBid Requestï¼‰    DSP->>DMP: æŸ¥è¯¢ç”¨æˆ·ç”»åƒ    DMP-->>DSP: è¿”å›ç”¨æˆ·æ ‡ç­¾    DSP->>DSP: ç«ä»·å†³ç­–ç®—æ³•    DSP-->>AdX: è¿”å›ç«ä»·å“åº”ï¼ˆBid Responseï¼‰    AdX->>AdX: ç«ä»·æ’åºå’Œé€‰æ‹©    AdX-->>SSP: è¿”å›è·èƒœå¹¿å‘Š    SSP-->>Media: è¿”å›å¹¿å‘Šåˆ›æ„    Media-->>User: å±•ç¤ºå¹¿å‘Š        Note over AdX: æ•´ä¸ªRTBæµç¨‹é€šå¸¸åœ¨100mså†…å®Œæˆ</pre><h2 id="3-2-æ•°æ®å¤„ç†æµç¨‹"><a href="#3-2-æ•°æ®å¤„ç†æµç¨‹" class="headerlink" title="3.2 æ•°æ®å¤„ç†æµç¨‹"></a>3.2 æ•°æ®å¤„ç†æµç¨‹</h2><pre class="mermaid">flowchart TD    A[æ•°æ®é‡‡é›†] --> B[æ•°æ®æ¸…æ´—]    B --> C[æ•°æ®æ ‡å‡†åŒ–]    C --> D[æ•°æ®æ•´åˆ]    D --> E[ç”¨æˆ·ç”»åƒæ„å»º]    E --> F[æ ‡ç­¾ä½“ç³»å»ºè®¾]    F --> G[äººç¾¤å®šå‘]    G --> H[æŠ•æ”¾ç­–ç•¥åˆ¶å®š]    H --> I[å®æ—¶ç«ä»·]    I --> J[æ•ˆæœç›‘æµ‹]    J --> K[æ•°æ®åé¦ˆ]    K --> A        subgraph "æ•°æ®æº"        L[ç¬¬ä¸€æ–¹æ•°æ®]        M[ç¬¬äºŒæ–¹æ•°æ®]        N[ç¬¬ä¸‰æ–¹æ•°æ®]        O[å…¬å¼€æ•°æ®]    end        L --> A    M --> A    N --> A    O --> A        subgraph "æœºå™¨å­¦ä¹ "        P[ç‰¹å¾å·¥ç¨‹]        Q[æ¨¡å‹è®­ç»ƒ]        R[æ¨¡å‹è¯„ä¼°]        S[æ¨¡å‹éƒ¨ç½²]    end        F --> P    P --> Q    Q --> R    R --> S    S --> H</pre><h1 id="ç¬¬å››ç« ï¼šæ•°æ®å¤„ç†æ¶æ„"><a href="#ç¬¬å››ç« ï¼šæ•°æ®å¤„ç†æ¶æ„" class="headerlink" title="ç¬¬å››ç« ï¼šæ•°æ®å¤„ç†æ¶æ„"></a>ç¬¬å››ç« ï¼šæ•°æ®å¤„ç†æ¶æ„</h1><h2 id="4-1-å¤§æ•°æ®å¤„ç†æ¶æ„"><a href="#4-1-å¤§æ•°æ®å¤„ç†æ¶æ„" class="headerlink" title="4.1 å¤§æ•°æ®å¤„ç†æ¶æ„"></a>4.1 å¤§æ•°æ®å¤„ç†æ¶æ„</h2><pre class="mermaid">graph TB    subgraph "æ•°æ®é‡‡é›†å±‚"        A1[WebåŸ‹ç‚¹]        A2[App SDK]        A3[æœåŠ¡å™¨æ—¥å¿—]        A4[ç¬¬ä¸‰æ–¹æ•°æ®]    end        subgraph "æ•°æ®ä¼ è¾“å±‚"        B1[Kafkaæ¶ˆæ¯é˜Ÿåˆ—]        B2[Flumeæ—¥å¿—æ”¶é›†]        B3[Canalæ•°æ®åŒæ­¥]    end        subgraph "æ•°æ®å­˜å‚¨å±‚"        C1[HDFSåˆ†å¸ƒå¼å­˜å‚¨]        C2[HBaseå®æ—¶æ•°æ®åº“]        C3[Redisç¼“å­˜]        C4[Elasticsearchæœç´¢]    end        subgraph "æ•°æ®è®¡ç®—å±‚"        D1[Sparkæ‰¹å¤„ç†]        D2[Flinkæµå¤„ç†]        D3[Prestoäº¤äº’æŸ¥è¯¢]    end        subgraph "æ•°æ®æœåŠ¡å±‚"        E1[ç”¨æˆ·ç”»åƒæœåŠ¡]        E2[å®æ—¶æ¨èæœåŠ¡]        E3[ç«ä»·å†³ç­–æœåŠ¡]        E4[æ•ˆæœåˆ†ææœåŠ¡]    end        A1 --> B1    A2 --> B1    A3 --> B2    A4 --> B3        B1 --> C1    B1 --> C2    B2 --> C1    B3 --> C2        C1 --> D1    C2 --> D2    C1 --> D3        D1 --> E1    D2 --> E2    D2 --> E3    D3 --> E4        C3 --> E1    C3 --> E2    C3 --> E3    C4 --> E4</pre><h2 id="4-2-å®æ—¶æ•°æ®å¤„ç†é“¾è·¯"><a href="#4-2-å®æ—¶æ•°æ®å¤„ç†é“¾è·¯" class="headerlink" title="4.2 å®æ—¶æ•°æ®å¤„ç†é“¾è·¯"></a>4.2 å®æ—¶æ•°æ®å¤„ç†é“¾è·¯</h2><pre class="mermaid">flowchart LR    A[ç”¨æˆ·è¡Œä¸º] --> B[æ•°æ®é‡‡é›†]    B --> C[æ¶ˆæ¯é˜Ÿåˆ—]    C --> D[æµå¼å¤„ç†]    D --> E[å®æ—¶å­˜å‚¨]    E --> F[ç«ä»·å†³ç­–]    F --> G[å¹¿å‘ŠæŠ•æ”¾]    G --> H[æ•ˆæœå›ä¼ ]    H --> I[æ•°æ®æ›´æ–°]    I --> D        subgraph "å®æ—¶å¤„ç†ç»„ä»¶"        J[Kafka]        K[Flink]        L[Redis]        M[HBase]    end        C -.-> J    D -.-> K    E -.-> L    E -.-> M</pre><h1 id="ç¬¬äº”ç« ï¼šæŠ€æœ¯æ¶æ„è®¾è®¡"><a href="#ç¬¬äº”ç« ï¼šæŠ€æœ¯æ¶æ„è®¾è®¡" class="headerlink" title="ç¬¬äº”ç« ï¼šæŠ€æœ¯æ¶æ„è®¾è®¡"></a>ç¬¬äº”ç« ï¼šæŠ€æœ¯æ¶æ„è®¾è®¡</h1><h2 id="5-1-DSPæ ¸å¿ƒç³»ç»Ÿæ¶æ„"><a href="#5-1-DSPæ ¸å¿ƒç³»ç»Ÿæ¶æ„" class="headerlink" title="5.1 DSPæ ¸å¿ƒç³»ç»Ÿæ¶æ„"></a>5.1 DSPæ ¸å¿ƒç³»ç»Ÿæ¶æ„</h2><h4 id="ç«ä»·å†³ç­–å¼•æ“ï¼šå¹¿å‘ŠæŠ•æ”¾çš„â€å¤§è„‘â€"><a href="#ç«ä»·å†³ç­–å¼•æ“ï¼šå¹¿å‘ŠæŠ•æ”¾çš„â€å¤§è„‘â€" class="headerlink" title="ç«ä»·å†³ç­–å¼•æ“ï¼šå¹¿å‘ŠæŠ•æ”¾çš„â€å¤§è„‘â€"></a>ç«ä»·å†³ç­–å¼•æ“ï¼šå¹¿å‘ŠæŠ•æ”¾çš„â€å¤§è„‘â€</h4><p><strong>ä¸ºä»€ä¹ˆéœ€è¦ç«ä»·å†³ç­–ç®—æ³•ï¼Ÿ</strong></p><p>ç«ä»·å†³ç­–ç®—æ³•æ˜¯ç¨‹åºåŒ–å¹¿å‘Šçš„æ ¸å¿ƒï¼Œå®ƒè¦åœ¨æçŸ­æ—¶é—´å†…å›ç­”ä¸‰ä¸ªå…³é”®é—®é¢˜ï¼š</p><ol><li><strong>è¦ä¸è¦æŠ•æ”¾ï¼Ÿ</strong> ï¼ˆç”¨æˆ·æ˜¯å¦åŒ¹é…ç›®æ ‡äººç¾¤ï¼‰</li><li><strong>æŠ•æ”¾ä»€ä¹ˆï¼Ÿ</strong> ï¼ˆé€‰æ‹©å“ªä¸ªå¹¿å‘Šåˆ›æ„ï¼‰</li><li><strong>å‡ºä»·å¤šå°‘ï¼Ÿ</strong> ï¼ˆåœ¨ç«äº‰ä¸­è·èƒœåˆä¸æµªè´¹é¢„ç®—ï¼‰</li></ol><p><strong>è§£å†³çš„æ ¸å¿ƒä¸šåŠ¡é—®é¢˜ï¼š</strong></p><p><strong>é—®é¢˜1ï¼šæµ·é‡æµé‡çš„å®æ—¶ç­›é€‰</strong></p><ul><li><strong>ä¸šåŠ¡åœºæ™¯ï¼š</strong> DSPæ¯ç§’æ”¶åˆ°æ•°ä¸‡ä¸ªç«ä»·è¯·æ±‚ï¼Œä½†åªæœ‰å¾ˆå°æ¯”ä¾‹ç¬¦åˆå¹¿å‘Šä¸»è¦æ±‚</li><li><strong>ä¼ ç»Ÿéš¾ç‚¹ï¼š</strong> äººå·¥æ— æ³•å®æ—¶åˆ¤æ–­æ¯ä¸ªç”¨æˆ·æ˜¯å¦å€¼å¾—æŠ•æ”¾</li><li><strong>ç®—æ³•è§£å†³ï¼š</strong> æ¯«ç§’çº§åŒ¹é…ç”¨æˆ·ç”»åƒä¸å¹¿å‘Šå®šå‘æ¡ä»¶</li></ul><p><strong>é—®é¢˜2ï¼šåŠ¨æ€ä»·æ ¼ç«äº‰</strong></p><ul><li><strong>ä¸šåŠ¡åœºæ™¯ï¼š</strong> åŒä¸€ä¸ªå¹¿å‘Šä½å¯èƒ½æœ‰æ•°åä¸ªå¹¿å‘Šä¸»ç«ä»·</li><li><strong>ä¼ ç»Ÿéš¾ç‚¹ï¼š</strong> å‡ºä»·å¤ªä½æ— æ³•è·èƒœï¼Œå‡ºä»·å¤ªé«˜æµªè´¹é¢„ç®—</li><li><strong>ç®—æ³•è§£å†³ï¼š</strong> åŸºäºå†å²æ•°æ®å’Œå®æ—¶åé¦ˆåŠ¨æ€è°ƒæ•´å‡ºä»·ç­–ç•¥</li></ul><p><strong>é—®é¢˜3ï¼šé¢„ç®—ä¼˜åŒ–åˆ†é…</strong></p><ul><li><strong>ä¸šåŠ¡åœºæ™¯ï¼š</strong> å¹¿å‘Šä¸»æœ‰é™çš„é¢„ç®—éœ€è¦åœ¨æœ€æœ‰ä»·å€¼çš„ç”¨æˆ·ä¸ŠèŠ±è´¹</li><li><strong>ä¼ ç»Ÿéš¾ç‚¹ï¼š</strong> éš¾ä»¥é¢„æµ‹å“ªäº›ç”¨æˆ·æ›´å¯èƒ½äº§ç”Ÿè½¬åŒ–</li><li><strong>ç®—æ³•è§£å†³ï¼š</strong> é€šè¿‡æœºå™¨å­¦ä¹ é¢„ä¼°ç”¨æˆ·ä»·å€¼ï¼Œä¼˜å…ˆæŠ•æ”¾é«˜ä»·å€¼ç”¨æˆ·</li></ul><p><strong>ç«ä»·å†³ç­–çš„ä¸šåŠ¡é€»è¾‘ï¼š</strong></p><pre class="mermaid">flowchart TD    A[æ”¶åˆ°ç«ä»·è¯·æ±‚] --> B{ç”¨æˆ·ç”»åƒåŒ¹é…}    B -->|ä¸åŒ¹é…| C[æ”¾å¼ƒç«ä»·]    B -->|åŒ¹é…| D{é¢„ç®—å……è¶³?}    D -->|ä¸è¶³| C    D -->|å……è¶³| E[è®¡ç®—ç”¨æˆ·ä»·å€¼]    E --> F{ä»·å€¼è¶…è¿‡é˜ˆå€¼?}    F -->|å¦| C    F -->|æ˜¯| G[é€‰æ‹©æœ€ä½³åˆ›æ„]    G --> H[è®¡ç®—æœ€ä¼˜å‡ºä»·]    H --> I[æäº¤ç«ä»·]        subgraph "æ ¸å¿ƒç®—æ³•"        J[ç”¨æˆ·ä»·å€¼é¢„ä¼°<br/>CTRé¢„æµ‹æ¨¡å‹]        K[å‡ºä»·ç­–ç•¥ä¼˜åŒ–<br/>åŠ¨æ€å®šä»·ç®—æ³•]        L[åˆ›æ„åŒ¹é…ç®—æ³•<br/>ä¸ªæ€§åŒ–æ¨è]    end        E -.-> J    H -.-> K    G -.-> L</pre><h4 id="ç”¨æˆ·ç”»åƒæœåŠ¡ï¼šç”¨æˆ·çš„â€æ•°å­—åŒ–èº«â€"><a href="#ç”¨æˆ·ç”»åƒæœåŠ¡ï¼šç”¨æˆ·çš„â€æ•°å­—åŒ–èº«â€" class="headerlink" title="ç”¨æˆ·ç”»åƒæœåŠ¡ï¼šç”¨æˆ·çš„â€æ•°å­—åŒ–èº«â€"></a>ç”¨æˆ·ç”»åƒæœåŠ¡ï¼šç”¨æˆ·çš„â€æ•°å­—åŒ–èº«â€</h4><p><strong>ä¸ºä»€ä¹ˆéœ€è¦ç”¨æˆ·ç”»åƒï¼Ÿ</strong></p><p>ç”¨æˆ·ç”»åƒæ˜¯ç¨‹åºåŒ–å¹¿å‘Šç²¾å‡†æŠ•æ”¾çš„åŸºç¡€ï¼Œå®ƒè¦è§£å†³â€è¿™ä¸ªç”¨æˆ·æ˜¯è°ï¼Œå–œæ¬¢ä»€ä¹ˆï¼Œä¼šä¹°ä»€ä¹ˆâ€çš„é—®é¢˜ã€‚</p><p><strong>è§£å†³çš„æ ¸å¿ƒä¸šåŠ¡é—®é¢˜ï¼š</strong></p><p><strong>é—®é¢˜1ï¼šç”¨æˆ·èº«ä»½è¯†åˆ«</strong></p><ul><li><strong>ä¸šåŠ¡æŒ‘æˆ˜ï¼š</strong> åŒä¸€ç”¨æˆ·åœ¨ä¸åŒè®¾å¤‡ã€ä¸åŒæ—¶é—´è®¿é—®ï¼Œå¦‚ä½•è¯†åˆ«ä¸ºåŒä¸€äººï¼Ÿ</li><li><strong>ä¸šåŠ¡ä»·å€¼ï¼š</strong> é¿å…å¯¹åŒä¸€ç”¨æˆ·é‡å¤æŠ•æ”¾ï¼Œæå‡å¹¿å‘Šæ•ˆæœ</li><li><strong>æŠ€æœ¯æ–¹æ¡ˆï¼š</strong> é€šè¿‡è®¾å¤‡æŒ‡çº¹ã€CookieåŒæ­¥ã€ç™»å½•æ€å…³è”ç­‰æŠ€æœ¯å»ºç«‹ç”¨æˆ·ç»Ÿä¸€ID</li></ul><p><strong>é—®é¢˜2ï¼šå…´è¶£åå¥½æŒ–æ˜</strong></p><ul><li><strong>ä¸šåŠ¡æŒ‘æˆ˜ï¼š</strong> ç”¨æˆ·ä¸ä¼šä¸»åŠ¨å‘Šè¯‰ä½ å–œæ¬¢ä»€ä¹ˆï¼Œå¦‚ä½•ä»è¡Œä¸ºä¸­æ¨æ–­å…´è¶£ï¼Ÿ</li><li><strong>ä¸šåŠ¡ä»·å€¼ï¼š</strong> æŠ•æ”¾ç”¨æˆ·çœŸæ­£æ„Ÿå…´è¶£çš„å¹¿å‘Šï¼Œæå‡ç‚¹å‡»ç‡å’Œè½¬åŒ–ç‡</li><li><strong>æŠ€æœ¯æ–¹æ¡ˆï¼š</strong> åˆ†ææµè§ˆå†…å®¹ã€åœç•™æ—¶é—´ã€äº’åŠ¨è¡Œä¸ºç­‰ï¼Œæ„å»ºå…´è¶£æ ‡ç­¾</li></ul><p><strong>é—®é¢˜3ï¼šè´­ä¹°èƒ½åŠ›è¯„ä¼°</strong></p><ul><li><strong>ä¸šåŠ¡æŒ‘æˆ˜ï¼š</strong> å¦‚ä½•åˆ¤æ–­ç”¨æˆ·çš„æ¶ˆè´¹èƒ½åŠ›å’Œè´­ä¹°æ„å‘ï¼Ÿ</li><li><strong>ä¸šåŠ¡ä»·å€¼ï¼š</strong> é«˜ä»·å€¼å•†å“ä¼˜å…ˆæŠ•æ”¾ç»™é«˜æ¶ˆè´¹èƒ½åŠ›ç”¨æˆ·ï¼Œæå‡ROI</li><li><strong>æŠ€æœ¯æ–¹æ¡ˆï¼š</strong> åˆ†æè´­ä¹°å†å²ã€æµè§ˆå•†å“ä»·ä½ã€æ”¶å…¥æ°´å¹³ç­‰ç‰¹å¾</li></ul><p><strong>ç”¨æˆ·ç”»åƒçš„åˆ†å±‚ç»“æ„ï¼š</strong></p><pre class="mermaid">flowchart TD    subgraph Layer1 ["é™æ€å±æ€§å±‚"]        A1[äººå£ç»Ÿè®¡å­¦ç‰¹å¾]        A2[å¹´é¾„æ€§åˆ«åœ°åŸŸ]        A3[æ”¶å…¥æ•™è‚²èŒä¸š]    end        subgraph Layer2 ["åŠ¨æ€è¡Œä¸ºå±‚"]        B1[æµè§ˆè¡Œä¸ºç‰¹å¾]        B2[æœç´¢å…³é”®è¯]        B3[å†…å®¹åå¥½]        B4[æ—¶é—´æ¨¡å¼]    end        subgraph Layer3 ["å…´è¶£åå¥½å±‚"]        C1[å…´è¶£æ ‡ç­¾]        C2[å“ç‰Œåå¥½]        C3[ä»·æ ¼æ•æ„Ÿåº¦]        C4[è´­ä¹°å‘¨æœŸ]    end        subgraph Layer4 ["ä»·å€¼è¯„ä¼°å±‚"]        D1[ç”Ÿå‘½å‘¨æœŸä»·å€¼]        D2[è½¬åŒ–æ¦‚ç‡]        D3[æ´»è·ƒåº¦æŒ‡æ•°]        D4[é£é™©ç­‰çº§]    end        Layer1 --> Layer2    Layer2 --> Layer3    Layer3 --> Layer4</pre><p><strong>å®é™…ä¸šåŠ¡åº”ç”¨åœºæ™¯ï¼š</strong></p><p><strong>åœºæ™¯1ï¼šç”µå•†ç”¨æˆ·ç”»åƒ</strong></p><ul><li><strong>æ ‡ç­¾ä½“ç³»ï¼š</strong> å“ç±»åå¥½ã€ä»·æ ¼æ•æ„Ÿåº¦ã€è´­ä¹°é¢‘æ¬¡ã€å“ç‰Œå¿ è¯šåº¦</li><li><strong>åº”ç”¨ä»·å€¼ï¼š</strong> æ–°å“æ¨èã€ä¿ƒé”€æ´»åŠ¨å®šå‘ã€å¤è´­æé†’</li></ul><p><strong>åœºæ™¯2ï¼šé‡‘èç”¨æˆ·ç”»åƒ</strong></p><ul><li><strong>æ ‡ç­¾ä½“ç³»ï¼š</strong> é£é™©åå¥½ã€æŠ•èµ„ç»éªŒã€èµ„äº§è§„æ¨¡ã€ä¿¡ç”¨ç­‰çº§</li><li><strong>åº”ç”¨ä»·å€¼ï¼š</strong> ç†è´¢äº§å“æ¨èã€é£é™©æ§åˆ¶ã€ç²¾å‡†è¥é”€</li></ul><p><strong>åœºæ™¯3ï¼šå†…å®¹å¹³å°ç”¨æˆ·ç”»åƒ</strong></p><ul><li><strong>æ ‡ç­¾ä½“ç³»ï¼š</strong> å†…å®¹åå¥½ã€æ´»è·ƒæ—¶é—´ã€ç¤¾äº¤å±æ€§ã€ä»˜è´¹æ„æ„¿</li><li><strong>åº”ç”¨ä»·å€¼ï¼š</strong> å†…å®¹æ¨èã€ä¼šå‘˜æ¨å¹¿ã€å¹¿å‘Šå®šå‘</li></ul><h2 id="5-2-å®æ—¶æ•°æ®å¤„ç†ï¼šè®©æ•°æ®â€æ´»â€èµ·æ¥"><a href="#5-2-å®æ—¶æ•°æ®å¤„ç†ï¼šè®©æ•°æ®â€æ´»â€èµ·æ¥" class="headerlink" title="5.2 å®æ—¶æ•°æ®å¤„ç†ï¼šè®©æ•°æ®â€æ´»â€èµ·æ¥"></a>5.2 å®æ—¶æ•°æ®å¤„ç†ï¼šè®©æ•°æ®â€æ´»â€èµ·æ¥</h2><p><strong>ä¸ºä»€ä¹ˆéœ€è¦å®æ—¶æ•°æ®å¤„ç†ï¼Ÿ</strong></p><p>åœ¨ç¨‹åºåŒ–å¹¿å‘Šä¸­ï¼Œæ•°æ®çš„æ—¶æ•ˆæ€§ç›´æ¥å½±å“æŠ•æ”¾æ•ˆæœã€‚ä¸€ä¸ªç”¨æˆ·åˆšåˆšæœç´¢äº†â€iPhone 15â€ï¼Œå¦‚æœèƒ½åœ¨å‡ åˆ†é’Ÿå†…æŠ•æ”¾ç›¸å…³å¹¿å‘Šï¼Œè½¬åŒ–ç‡ä¼šæ¯”å‡ å°æ—¶åæŠ•æ”¾é«˜å‡ºæ•°å€ã€‚</p><p><strong>è§£å†³çš„æ ¸å¿ƒä¸šåŠ¡é—®é¢˜ï¼š</strong></p><p><strong>é—®é¢˜1ï¼šç”¨æˆ·å…´è¶£çš„æ—¶æ•ˆæ€§</strong></p><ul><li><strong>ä¸šåŠ¡åœºæ™¯ï¼š</strong> ç”¨æˆ·åˆšæœç´¢äº†æ—…æ¸¸æ”»ç•¥ï¼Œæ­¤æ—¶æŠ•æ”¾æ—…æ¸¸å¹¿å‘Šæ•ˆæœæœ€ä½³</li><li><strong>ä¼ ç»Ÿé—®é¢˜ï¼š</strong> æ‰¹å¤„ç†å»¶è¿Ÿæ•°å°æ—¶ï¼Œé”™è¿‡æœ€ä½³æŠ•æ”¾æ—¶æœº</li><li><strong>å®æ—¶æ–¹æ¡ˆï¼š</strong> æµå¤„ç†å‡ ç§’å†…æ›´æ–°ç”¨æˆ·å…´è¶£æ ‡ç­¾ï¼Œç«‹å³è°ƒæ•´æŠ•æ”¾ç­–ç•¥</li></ul><p><strong>é—®é¢˜2ï¼šå¹¿å‘Šæ•ˆæœçš„å¿«é€Ÿåé¦ˆ</strong></p><ul><li><strong>ä¸šåŠ¡åœºæ™¯ï¼š</strong> æŸä¸ªå¹¿å‘Šåˆ›æ„CTRå¼‚å¸¸ä½ï¼Œéœ€è¦ç«‹å³æš‚åœ</li><li><strong>ä¼ ç»Ÿé—®é¢˜ï¼š</strong> ç­‰å¾…æ—¥æŠ¥å‘ç°é—®é¢˜æ—¶å·²æµªè´¹å¤§é‡é¢„ç®—</li><li><strong>å®æ—¶æ–¹æ¡ˆï¼š</strong> å®æ—¶ç›‘æ§æ•ˆæœæŒ‡æ ‡ï¼Œè‡ªåŠ¨è§¦å‘é¢„è­¦å’Œè°ƒæ•´</li></ul><p><strong>é—®é¢˜3ï¼šåº“å­˜åŠ¨æ€ç®¡ç†</strong></p><ul><li><strong>ä¸šåŠ¡åœºæ™¯ï¼š</strong> ç”µå•†å¤§ä¿ƒæœŸé—´å•†å“åº“å­˜å¿«é€Ÿå˜åŒ–</li><li><strong>ä¼ ç»Ÿé—®é¢˜ï¼š</strong> æ¨å¹¿å·²å”®ç½„å•†å“ï¼Œå½±å“ç”¨æˆ·ä½“éªŒ</li><li><strong>å®æ—¶æ–¹æ¡ˆï¼š</strong> å®æ—¶åŒæ­¥åº“å­˜çŠ¶æ€ï¼ŒåŠ¨æ€è°ƒæ•´å¹¿å‘ŠæŠ•æ”¾</li></ul><p><strong>å®æ—¶å¤„ç†çš„ä¸šåŠ¡ä»·å€¼é“¾ï¼š</strong></p><pre class="mermaid">flowchart LR    A[ç”¨æˆ·è¡Œä¸ºå‘ç”Ÿ] --> B[æ¯«ç§’çº§æ•°æ®é‡‡é›†]    B --> C[ç§’çº§æµå¼å¤„ç†]    C --> D[å®æ—¶æ ‡ç­¾æ›´æ–°]    D --> E[æŠ•æ”¾ç­–ç•¥è°ƒæ•´]    E --> F[æ•ˆæœç«‹å³åé¦ˆ]    F --> G[ç­–ç•¥æŒç»­ä¼˜åŒ–]        subgraph "ä¸šåŠ¡ä»·å€¼"        H[æå‡è½¬åŒ–ç‡<br/>é™ä½è·å®¢æˆæœ¬]        I[å¿«é€Ÿæ­¢æŸ<br/>é¢„ç®—ä¿æŠ¤]        J[ç”¨æˆ·ä½“éªŒä¼˜åŒ–<br/>å“ç‰Œå½¢è±¡æå‡]    end        E -.-> H    F -.-> I    G -.-> J</pre><p><strong>ä¸åŒä¸šåŠ¡åœºæ™¯çš„å®æ—¶æ€§è¦æ±‚ï¼š</strong></p><table><thead><tr><th>ä¸šåŠ¡åœºæ™¯</th><th>å®æ—¶æ€§è¦æ±‚</th><th>ä¸šåŠ¡å½±å“</th><th>æŠ€æœ¯æ–¹æ¡ˆ</th></tr></thead><tbody><tr><td>æœç´¢å¹¿å‘Š</td><td>æ¯«ç§’çº§</td><td>ç›´æ¥å½±å“æœç´¢ç»“æœå±•ç¤º</td><td>å†…å­˜ç¼“å­˜+é¢„è®¡ç®—</td></tr><tr><td>ä¿¡æ¯æµå¹¿å‘Š</td><td>ç§’çº§</td><td>å½±å“ä¸ªæ€§åŒ–æ¨èæ•ˆæœ</td><td>Kafka+Flinkæµå¤„ç†</td></tr><tr><td>æ•ˆæœç›‘æ§</td><td>åˆ†é’Ÿçº§</td><td>å½±å“æŠ•æ”¾ç­–ç•¥è°ƒæ•´é€Ÿåº¦</td><td>æµå¼èšåˆ+å®æ—¶å‘Šè­¦</td></tr><tr><td>ç”¨æˆ·ç”»åƒ</td><td>å°æ—¶çº§</td><td>å½±å“é•¿æœŸæŠ•æ”¾ç²¾å‡†åº¦</td><td>æ‰¹æµç»“åˆå¤„ç†</td></tr></tbody></table><h2 id="5-3-é«˜æ€§èƒ½ç«ä»·ç³»ç»Ÿæ¶æ„"><a href="#5-3-é«˜æ€§èƒ½ç«ä»·ç³»ç»Ÿæ¶æ„" class="headerlink" title="5.3 é«˜æ€§èƒ½ç«ä»·ç³»ç»Ÿæ¶æ„"></a>5.3 é«˜æ€§èƒ½ç«ä»·ç³»ç»Ÿæ¶æ„</h2><h4 id="ç«ä»·ç³»ç»Ÿæ¶æ„è®¾è®¡"><a href="#ç«ä»·ç³»ç»Ÿæ¶æ„è®¾è®¡" class="headerlink" title="ç«ä»·ç³»ç»Ÿæ¶æ„è®¾è®¡"></a>ç«ä»·ç³»ç»Ÿæ¶æ„è®¾è®¡</h4><pre class="mermaid">graph TB    subgraph "æ¥å…¥å±‚"        A1[è´Ÿè½½å‡è¡¡å™¨]        A2[APIç½‘å…³]    end        subgraph "ä¸šåŠ¡å±‚"        B1[ç«ä»·å†³ç­–æœåŠ¡]        B2[ç”¨æˆ·ç”»åƒæœåŠ¡]        B3[å¹¿å‘ŠåŒ¹é…æœåŠ¡]        B4[å®šä»·ç­–ç•¥æœåŠ¡]    end        subgraph "ç¼“å­˜å±‚"        C1[Redis Cluster]        C2[æœ¬åœ°ç¼“å­˜]    end        subgraph "å­˜å‚¨å±‚"        D1[HBaseç”¨æˆ·æ•°æ®]        D2[MySQLå¹¿å‘Šæ•°æ®]        D3[MongoDBæ—¥å¿—æ•°æ®]    end        subgraph "æ¶ˆæ¯å±‚"        E1[Kafkaé›†ç¾¤]    end        A1 --> A2    A2 --> B1    B1 --> B2    B1 --> B3    B1 --> B4        B2 --> C1    B2 --> C2    B3 --> C1    B4 --> C1        C1 --> D1    B3 --> D2    B1 --> D3        B1 --> E1    E1 --> D3</pre><h4 id="ç³»ç»Ÿè®¾è®¡è¦ç‚¹"><a href="#ç³»ç»Ÿè®¾è®¡è¦ç‚¹" class="headerlink" title="ç³»ç»Ÿè®¾è®¡è¦ç‚¹"></a>ç³»ç»Ÿè®¾è®¡è¦ç‚¹</h4><p><strong>1. é«˜å¹¶å‘å¤„ç†èƒ½åŠ›</strong></p><ul><li><strong>æŒ‘æˆ˜ï¼š</strong> å•ä¸ªDSPæ¯ç§’éœ€è¦å¤„ç†æ•°ä¸‡æ¬¡ç«ä»·è¯·æ±‚</li><li><strong>è§£å†³æ–¹æ¡ˆï¼š</strong> å¼‚æ­¥å¤„ç† + ä¸“ç”¨çº¿ç¨‹æ±  + è¿æ¥æ± ä¼˜åŒ–</li><li><strong>æŠ€æœ¯é€‰å‹ï¼š</strong> CompletableFuture + è‡ªå®šä¹‰ThreadPoolExecutor</li></ul><p><strong>2. æä½å»¶è¿Ÿè¦æ±‚</strong></p><ul><li><strong>æŒ‘æˆ˜ï¼š</strong> RTBåè®®è¦æ±‚100mså†…å®Œæˆç«ä»·å†³ç­–</li><li><strong>è§£å†³æ–¹æ¡ˆï¼š</strong> å¤šçº§ç¼“å­˜ + é¢„è®¡ç®— + ç®—æ³•ä¼˜åŒ–</li><li><strong>æ€§èƒ½ç›®æ ‡ï¼š</strong> 95%è¯·æ±‚åœ¨50mså†…å®Œæˆ</li></ul><p><strong>3. é«˜å¯ç”¨ä¿éšœ</strong></p><ul><li><strong>æŒ‘æˆ˜ï¼š</strong> 7Ã—24å°æ—¶ä¸é—´æ–­æœåŠ¡ï¼Œå•ç‚¹æ•…éšœå½±å“æ”¶å…¥</li><li><strong>è§£å†³æ–¹æ¡ˆï¼š</strong> å¤šæœºæˆ¿éƒ¨ç½² + ç†”æ–­é™çº§ + æ•…éšœè½¬ç§»</li><li><strong>å¯ç”¨æ€§ç›®æ ‡ï¼š</strong> 99.95%ä»¥ä¸Š</li></ul><h1 id="ç¬¬å…­ç« ï¼šæ€§èƒ½ä¼˜åŒ–ç­–ç•¥"><a href="#ç¬¬å…­ç« ï¼šæ€§èƒ½ä¼˜åŒ–ç­–ç•¥" class="headerlink" title="ç¬¬å…­ç« ï¼šæ€§èƒ½ä¼˜åŒ–ç­–ç•¥"></a>ç¬¬å…­ç« ï¼šæ€§èƒ½ä¼˜åŒ–ç­–ç•¥</h1><h2 id="6-1-ç¼“å­˜ç­–ç•¥"><a href="#6-1-ç¼“å­˜ç­–ç•¥" class="headerlink" title="6.1 ç¼“å­˜ç­–ç•¥"></a>6.1 ç¼“å­˜ç­–ç•¥</h2><pre class="mermaid">flowchart TD    A[è¯·æ±‚] --> B{æœ¬åœ°ç¼“å­˜}    B -->|å‘½ä¸­| C[è¿”å›ç»“æœ]    B -->|æœªå‘½ä¸­| D{Redisç¼“å­˜}    D -->|å‘½ä¸­| E[æ›´æ–°æœ¬åœ°ç¼“å­˜]    E --> C    D -->|æœªå‘½ä¸­| F[æ•°æ®åº“æŸ¥è¯¢]    F --> G[æ›´æ–°Redisç¼“å­˜]    G --> E        subgraph L1["L1æœ¬åœ°ç¼“å­˜"]        H1[å®¹é‡å°é€Ÿåº¦æå¿«]        H2[æ¯«ç§’çº§å“åº”]    end        subgraph L2["L2Redisç¼“å­˜"]        I1[å®¹é‡å¤§é€Ÿåº¦å¿«]        I2[æ¯«ç§’åˆ°åæ¯«ç§’çº§]    end        subgraph L3["L3æ•°æ®åº“"]        J1[å®¹é‡æœ€å¤§é€Ÿåº¦æ…¢]        J2[åæ¯«ç§’åˆ°ç™¾æ¯«ç§’çº§]    end</pre><h4 id="ç¼“å­˜ç­–ç•¥çš„ä¸šåŠ¡ä»·å€¼"><a href="#ç¼“å­˜ç­–ç•¥çš„ä¸šåŠ¡ä»·å€¼" class="headerlink" title="ç¼“å­˜ç­–ç•¥çš„ä¸šåŠ¡ä»·å€¼"></a>ç¼“å­˜ç­–ç•¥çš„ä¸šåŠ¡ä»·å€¼</h4><p><strong>ä¸ºä»€ä¹ˆéœ€è¦å¤šçº§ç¼“å­˜ï¼Ÿ</strong></p><p>ç¨‹åºåŒ–å¹¿å‘Šé¢ä¸´çš„æ ¸å¿ƒæŒ‘æˆ˜æ˜¯<strong>æè‡´çš„å“åº”æ—¶é—´è¦æ±‚</strong>ï¼š</p><ul><li>RTBåè®®è¦æ±‚åœ¨100mså†…å®Œæˆæ•´ä¸ªç«ä»·æµç¨‹</li><li>ç”¨æˆ·ç”»åƒæŸ¥è¯¢ã€å¹¿å‘ŠåŒ¹é…ã€å®šä»·è®¡ç®—éƒ½éœ€è¦åœ¨è¿™100mså†…å®Œæˆ</li><li>ä¼ ç»Ÿæ•°æ®åº“æŸ¥è¯¢ï¼ˆ50-200msï¼‰æ— æ³•æ»¡è¶³æ—¶å»¶è¦æ±‚</li></ul><p><strong>è§£å†³çš„ä¸šåŠ¡é—®é¢˜ï¼š</strong></p><ol><li><strong>å“åº”æ—¶å»¶é—®é¢˜</strong>ï¼šæ•°æ®åº“æŸ¥è¯¢æ—¶é—´è¿‡é•¿å¯¼è‡´ç«ä»·å¤±è´¥</li><li><strong>å¹¶å‘å‹åŠ›é—®é¢˜</strong>ï¼šå•ä¸ªDSPæ¯ç§’éœ€è¦å¤„ç†æ•°ä¸‡æ¬¡ç«ä»·è¯·æ±‚</li><li><strong>æ•°æ®ä¸€è‡´æ€§é—®é¢˜</strong>ï¼šç”¨æˆ·ç”»åƒæ•°æ®éœ€è¦åœ¨å¤šä¸ªæœåŠ¡é—´å¿«é€Ÿå…±äº«</li><li><strong>æˆæœ¬æ§åˆ¶é—®é¢˜</strong>ï¼šé™ä½æ•°æ®åº“æŸ¥è¯¢å‹åŠ›ï¼Œå‡å°‘åŸºç¡€è®¾æ–½æˆæœ¬</li></ol><h2 id="6-2-æ•°æ®é¢„å¤„ç†å’Œé¢„è®¡ç®—ç­–ç•¥"><a href="#6-2-æ•°æ®é¢„å¤„ç†å’Œé¢„è®¡ç®—ç­–ç•¥" class="headerlink" title="6.2 æ•°æ®é¢„å¤„ç†å’Œé¢„è®¡ç®—ç­–ç•¥"></a>6.2 æ•°æ®é¢„å¤„ç†å’Œé¢„è®¡ç®—ç­–ç•¥</h2><p><strong>ä¸ºä»€ä¹ˆéœ€è¦é¢„è®¡ç®—ï¼Ÿ</strong></p><p>åœ¨ç«ä»·å†³ç­–çš„100msæ—¶é—´é™åˆ¶å†…ï¼Œå¾ˆå¤šå¤æ‚è®¡ç®—æ— æ³•å®æ—¶å®Œæˆï¼Œéœ€è¦é€šè¿‡é¢„è®¡ç®—æ¥æå‡å“åº”é€Ÿåº¦ã€‚</p><p><strong>é¢„è®¡ç®—çš„æ ¸å¿ƒç­–ç•¥ï¼š</strong></p><p><strong>ç­–ç•¥1ï¼šç”¨æˆ·ç”»åƒé¢„è®¡ç®—</strong></p><ul><li><strong>åœºæ™¯ï¼š</strong> æ´»è·ƒç”¨æˆ·çš„ç”»åƒæ›´æ–°é¢‘ç‡é«˜ï¼Œå®æ—¶è®¡ç®—å‹åŠ›å¤§</li><li><strong>æ–¹æ¡ˆï¼š</strong> å®šæœŸæ‰¹é‡æ›´æ–°æ´»è·ƒç”¨æˆ·ç”»åƒï¼Œå­˜å‚¨åˆ°Redisç¼“å­˜</li><li><strong>é¢‘ç‡ï¼š</strong> æ¯5åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡ï¼Œè¦†ç›–æœ€è¿‘1å°æ—¶å†…æ´»è·ƒç”¨æˆ·</li></ul><p><strong>ç­–ç•¥2ï¼šå¹¿å‘Šå®šå‘è§„åˆ™é¢„è®¡ç®—</strong></p><ul><li><strong>åœºæ™¯ï¼š</strong> å¤æ‚çš„å®šå‘è§„åˆ™åŒ¹é…è€—æ—¶è¾ƒé•¿</li><li><strong>æ–¹æ¡ˆï¼š</strong> é¢„å…ˆè®¡ç®—å¹¿å‘Šå®šå‘è§„åˆ™ï¼Œå»ºç«‹å€’æ’ç´¢å¼•</li><li><strong>é¢‘ç‡ï¼š</strong> æ¯å¤©å‡Œæ™¨æ›´æ–°ï¼ŒåŒæ­¥æœ€æ–°çš„å¹¿å‘Šè®¡åˆ’é…ç½®</li></ul><p><strong>ç­–ç•¥3ï¼šç‰¹å¾å·¥ç¨‹é¢„è®¡ç®—</strong></p><ul><li><strong>åœºæ™¯ï¼š</strong> æœºå™¨å­¦ä¹ ç‰¹å¾è®¡ç®—å¤æ‚åº¦é«˜</li><li><strong>æ–¹æ¡ˆï¼š</strong> é¢„è®¡ç®—å¸¸ç”¨ç‰¹å¾ï¼Œå®æ—¶ç»„åˆä½¿ç”¨</li><li><strong>é¢‘ç‡ï¼š</strong> å®æ—¶å¢é‡æ›´æ–° + ç¦»çº¿å…¨é‡é‡å»º</li></ul><h2 id="6-3-æ¨¡å‹ä¼˜åŒ–å’ŒABæµ‹è¯•ä½“ç³»"><a href="#6-3-æ¨¡å‹ä¼˜åŒ–å’ŒABæµ‹è¯•ä½“ç³»" class="headerlink" title="6.3 æ¨¡å‹ä¼˜åŒ–å’ŒABæµ‹è¯•ä½“ç³»"></a>6.3 æ¨¡å‹ä¼˜åŒ–å’ŒABæµ‹è¯•ä½“ç³»</h2><p><strong>æ¨¡å‹æŒç»­ä¼˜åŒ–çš„ä¸šåŠ¡ä»·å€¼ï¼š</strong></p><p>ç¨‹åºåŒ–å¹¿å‘Šçš„æ•ˆæœç›´æ¥å½±å“æ”¶å…¥ï¼Œ1%çš„CTRæå‡å¯èƒ½å¸¦æ¥æ•°ç™¾ä¸‡çš„é¢å¤–æ”¶å…¥ã€‚å› æ­¤éœ€è¦å»ºç«‹å®Œå–„çš„æ¨¡å‹ä¼˜åŒ–ä½“ç³»ã€‚</p><p><strong>ABæµ‹è¯•é©±åŠ¨çš„æ¨¡å‹è¿­ä»£ï¼š</strong></p><p><strong>é˜¶æ®µ1ï¼šç¦»çº¿è¯„ä¼°</strong></p><ul><li>åŸºäºå†å²æ•°æ®è¯„ä¼°æ–°æ¨¡å‹æ€§èƒ½</li><li>å…³é”®æŒ‡æ ‡ï¼šAUCã€ç²¾å‡†ç‡ã€å¬å›ç‡</li><li>é€šè¿‡é˜ˆå€¼ï¼šç›¸æ¯”åŸºå‡†æ¨¡å‹æå‡5%ä»¥ä¸Š</li></ul><p><strong>é˜¶æ®µ2ï¼šå°æµé‡éªŒè¯</strong></p><ul><li>åœ¨10%çš„æµé‡ä¸Šæµ‹è¯•æ–°æ¨¡å‹</li><li>è§‚å¯ŸæŒ‡æ ‡ï¼šCTRã€CVRã€ROI</li><li>éªŒè¯å‘¨æœŸï¼š7-14å¤©</li></ul><p><strong>é˜¶æ®µ3ï¼šå…¨é‡å‘å¸ƒ</strong></p><ul><li>é€æ­¥æ‰©å¤§æ–°æ¨¡å‹çš„æµé‡æ¯”ä¾‹</li><li>æŒç»­ç›‘æ§æ ¸å¿ƒä¸šåŠ¡æŒ‡æ ‡</li><li>å»ºç«‹å¿«é€Ÿå›æ»šæœºåˆ¶</li></ul><p><strong>æ¨¡å‹ä¼˜åŒ–çš„å…³é”®æŠ€æœ¯ï¼š</strong></p><ul><li><strong>ç‰¹å¾å·¥ç¨‹ä¼˜åŒ–</strong>ï¼šè‡ªåŠ¨åŒ–ç‰¹å¾é€‰æ‹©å’Œç»„åˆ</li><li><strong>ç®—æ³•æ¨¡å‹å‡çº§</strong>ï¼šä»LRåˆ°XGBoostå†åˆ°æ·±åº¦å­¦ä¹ </li><li><strong>åœ¨çº¿å­¦ä¹ èƒ½åŠ›</strong>ï¼šå®æ—¶æ ¹æ®åé¦ˆè°ƒæ•´æ¨¡å‹å‚æ•°</li></ul><h1 id="ç¬¬ä¸ƒç« ï¼šå®é™…åº”ç”¨æ¡ˆä¾‹"><a href="#ç¬¬ä¸ƒç« ï¼šå®é™…åº”ç”¨æ¡ˆä¾‹" class="headerlink" title="ç¬¬ä¸ƒç« ï¼šå®é™…åº”ç”¨æ¡ˆä¾‹"></a>ç¬¬ä¸ƒç« ï¼šå®é™…åº”ç”¨æ¡ˆä¾‹</h1><h2 id="7-1-æ¡ˆä¾‹1ï¼šç”µå•†å¹³å°ç¨‹åºåŒ–å¹¿å‘Šç³»ç»Ÿ"><a href="#7-1-æ¡ˆä¾‹1ï¼šç”µå•†å¹³å°ç¨‹åºåŒ–å¹¿å‘Šç³»ç»Ÿ" class="headerlink" title="7.1 æ¡ˆä¾‹1ï¼šç”µå•†å¹³å°ç¨‹åºåŒ–å¹¿å‘Šç³»ç»Ÿ"></a>7.1 æ¡ˆä¾‹1ï¼šç”µå•†å¹³å°ç¨‹åºåŒ–å¹¿å‘Šç³»ç»Ÿ</h2><h4 id="ä¸šåŠ¡åœºæ™¯"><a href="#ä¸šåŠ¡åœºæ™¯" class="headerlink" title="ä¸šåŠ¡åœºæ™¯"></a>ä¸šåŠ¡åœºæ™¯</h4><p>æŸå¤§å‹ç”µå•†å¹³å°éœ€è¦æ„å»ºç¨‹åºåŒ–å¹¿å‘Šç³»ç»Ÿï¼Œå®ç°ï¼š</p><ul><li>å•†å“æ¨å¹¿çš„ç²¾å‡†æŠ•æ”¾</li><li>ç”¨æˆ·è¡Œä¸ºæ•°æ®çš„å®æ—¶å¤„ç†</li><li>å¤šæ¸ é“å¹¿å‘Šèµ„æºçš„ç»Ÿä¸€ç®¡ç†</li></ul><h4 id="æŠ€æœ¯æ¶æ„"><a href="#æŠ€æœ¯æ¶æ„" class="headerlink" title="æŠ€æœ¯æ¶æ„"></a>æŠ€æœ¯æ¶æ„</h4><pre class="mermaid">graph TB    subgraph "å‰ç«¯å±•ç¤ºå±‚"        A1[Webå‰ç«¯]        A2[Mobile App]        A3[å°ç¨‹åº]    end        subgraph "ç½‘å…³å±‚"        B1[API Gateway]        B2[CDN]    end        subgraph "ä¸šåŠ¡æœåŠ¡å±‚"        C1[å¹¿å‘ŠæœåŠ¡]        C2[æ¨èæœåŠ¡]        C3[ç”¨æˆ·æœåŠ¡]        C4[å•†å“æœåŠ¡]    end        subgraph "æ•°æ®å¤„ç†å±‚"        D1[å®æ—¶è®¡ç®—]        D2[ç¦»çº¿è®¡ç®—]        D3[æœºå™¨å­¦ä¹ ]    end        subgraph "å­˜å‚¨å±‚"        E1[MySQL]        E2[Redis]        E3[HBase]        E4[HDFS]    end        A1 --> B1    A2 --> B1    A3 --> B1    B1 --> C1    C1 --> C2    C1 --> C3    C1 --> C4    C1 --> D1    D1 --> D2    D2 --> D3    D3 --> E1    C1 --> E2    D1 --> E3    D2 --> E4</pre><h4 id="æ ¸å¿ƒå®ç°ç­–ç•¥"><a href="#æ ¸å¿ƒå®ç°ç­–ç•¥" class="headerlink" title="æ ¸å¿ƒå®ç°ç­–ç•¥"></a>æ ¸å¿ƒå®ç°ç­–ç•¥</h4><p><strong>1. ç”¨æˆ·è¡Œä¸ºå®æ—¶åˆ†æ</strong></p><ul><li><strong>è´­ç‰©è½¦è¡Œä¸ºè¿½è¸ª</strong>ï¼šå®æ—¶åˆ†æç”¨æˆ·åŠ è´­ã€æ”¶è—ã€æµè§ˆè¡Œä¸º</li><li><strong>å…´è¶£è¡°å‡æ¨¡å‹</strong>ï¼šæ ¹æ®æ—¶é—´è¡°å‡è°ƒæ•´ç”¨æˆ·å…´è¶£æƒé‡</li><li><strong>è´­ä¹°æ„å›¾è¯†åˆ«</strong>ï¼šé€šè¿‡è¡Œä¸ºåºåˆ—è¯†åˆ«ç”¨æˆ·è´­ä¹°æ„å›¾å¼ºå¼±</li></ul><p><strong>2. å•†å“æ™ºèƒ½åŒ¹é…</strong></p><ul><li><strong>ååŒè¿‡æ»¤ç®—æ³•</strong>ï¼šåŸºäºç›¸ä¼¼ç”¨æˆ·è¡Œä¸ºæ¨èå•†å“</li><li><strong>å†…å®¹è¿‡æ»¤ç®—æ³•</strong>ï¼šåŸºäºå•†å“å±æ€§å’Œç”¨æˆ·åå¥½åŒ¹é…</li><li><strong>åº“å­˜çŠ¶æ€å®æ—¶åŒæ­¥</strong>ï¼šé¿å…æ¨å¹¿ç¼ºè´§å•†å“</li></ul><p><strong>3. åŠ¨æ€å®šä»·ç­–ç•¥</strong></p><ul><li><strong>ç«äº‰å¯¹æ‰‹ä»·æ ¼ç›‘æ§</strong>ï¼šå®æ—¶è·å–å¸‚åœºä»·æ ¼ä¿¡æ¯</li><li><strong>è½¬åŒ–ç‡é¢„ä¼°æ¨¡å‹</strong>ï¼šé¢„æµ‹ä¸åŒä»·æ ¼ä¸‹çš„è½¬åŒ–å¯èƒ½æ€§</li><li><strong>åˆ©æ¶¦æœ€å¤§åŒ–ç®—æ³•</strong>ï¼šåœ¨è½¬åŒ–ç‡å’Œåˆ©æ¶¦é—´å¯»æ‰¾å¹³è¡¡ç‚¹</li></ul><h2 id="7-2-æ¡ˆä¾‹2ï¼šè§†é¢‘å¹³å°ç¨‹åºåŒ–å¹¿å‘Š"><a href="#7-2-æ¡ˆä¾‹2ï¼šè§†é¢‘å¹³å°ç¨‹åºåŒ–å¹¿å‘Š" class="headerlink" title="7.2 æ¡ˆä¾‹2ï¼šè§†é¢‘å¹³å°ç¨‹åºåŒ–å¹¿å‘Š"></a>7.2 æ¡ˆä¾‹2ï¼šè§†é¢‘å¹³å°ç¨‹åºåŒ–å¹¿å‘Š</h2><h4 id="ä¸šåŠ¡ç‰¹ç‚¹"><a href="#ä¸šåŠ¡ç‰¹ç‚¹" class="headerlink" title="ä¸šåŠ¡ç‰¹ç‚¹"></a>ä¸šåŠ¡ç‰¹ç‚¹</h4><ul><li><strong>è§†é¢‘å†…å®¹çš„ä¸Šä¸‹æ–‡ç†è§£</strong>ï¼šåˆ†æè§†é¢‘ç±»å‹ã€æƒ…ç»ªã€å—ä¼—ç¾¤ä½“</li><li><strong>ç”¨æˆ·è§‚çœ‹è¡Œä¸ºçš„æ·±åº¦åˆ†æ</strong>ï¼šè§‚çœ‹æ—¶é•¿ã€è·³å‡ºç‚¹ã€äº’åŠ¨è¡Œä¸º</li><li><strong>åˆ›æ„ç´ æçš„åŠ¨æ€ä¼˜åŒ–</strong>ï¼šæ ¹æ®è§†é¢‘å†…å®¹å’Œç”¨æˆ·ç‰¹å¾é€‰æ‹©æœ€ä½³å¹¿å‘Šå½¢å¼</li></ul><h4 id="æ ¸å¿ƒä¼˜åŒ–ç­–ç•¥"><a href="#æ ¸å¿ƒä¼˜åŒ–ç­–ç•¥" class="headerlink" title="æ ¸å¿ƒä¼˜åŒ–ç­–ç•¥"></a>æ ¸å¿ƒä¼˜åŒ–ç­–ç•¥</h4><p><strong>1. è§†é¢‘å†…å®¹æ™ºèƒ½åˆ†æ</strong></p><ul><li><strong>å†…å®¹æ ‡ç­¾æå–</strong>ï¼šè‡ªåŠ¨è¯†åˆ«è§†é¢‘çš„ç±»å‹ã€ä¸»é¢˜ã€æƒ…æ„Ÿè‰²å½©</li><li><strong>å—ä¼—ç”»åƒåŒ¹é…</strong>ï¼šåˆ†æè§†é¢‘è§‚ä¼—çš„äººç¾¤ç‰¹å¾</li><li><strong>å¹¿å‘Šæ¤å…¥æ—¶æœº</strong>ï¼šè¯†åˆ«è§†é¢‘ä¸­çš„è‡ªç„¶å¹¿å‘Šæ’å…¥ç‚¹</li></ul><p><strong>2. ç”¨æˆ·è§‚çœ‹è¡Œä¸ºå»ºæ¨¡</strong></p><ul><li><strong>æ³¨æ„åŠ›æ¨¡å‹</strong>ï¼šé¢„æµ‹ç”¨æˆ·åœ¨ä¸åŒæ—¶åˆ»çš„æ³¨æ„åŠ›é›†ä¸­åº¦</li><li><strong>æµå¤±é¢„è­¦</strong>ï¼šè¯†åˆ«ç”¨æˆ·å¯èƒ½è·³å‡ºçš„æ—¶é—´ç‚¹</li><li><strong>äº’åŠ¨åå¥½åˆ†æ</strong>ï¼šåˆ†æç”¨æˆ·å¯¹ä¸åŒå¹¿å‘Šå½¢å¼çš„ååº”</li></ul><p><strong>3. åˆ›æ„ç´ ææ™ºèƒ½ä¼˜åŒ–</strong></p><ul><li><strong>A&#x2F;Bæµ‹è¯•é©±åŠ¨</strong>ï¼šæŒç»­æµ‹è¯•ä¸åŒåˆ›æ„ç´ æçš„æ•ˆæœ</li><li><strong>å®æ—¶ä¸ªæ€§åŒ–</strong>ï¼šæ ¹æ®ç”¨æˆ·ç‰¹å¾åŠ¨æ€è°ƒæ•´å¹¿å‘Šå†…å®¹</li><li><strong>è·¨å±é€‚é…</strong>ï¼šé’ˆå¯¹ä¸åŒè®¾å¤‡ä¼˜åŒ–å¹¿å‘Šå±•ç¤ºå½¢å¼</li></ul><h1 id="ç¬¬å…«ç« ï¼šæ€»ç»“ä¸ä¸šåŠ¡ä»·å€¼"><a href="#ç¬¬å…«ç« ï¼šæ€»ç»“ä¸ä¸šåŠ¡ä»·å€¼" class="headerlink" title="ç¬¬å…«ç« ï¼šæ€»ç»“ä¸ä¸šåŠ¡ä»·å€¼"></a>ç¬¬å…«ç« ï¼šæ€»ç»“ä¸ä¸šåŠ¡ä»·å€¼</h1><h2 id="8-1-ç¨‹åºåŒ–å¹¿å‘Šçš„å•†ä¸šä»·å€¼"><a href="#8-1-ç¨‹åºåŒ–å¹¿å‘Šçš„å•†ä¸šä»·å€¼" class="headerlink" title="8.1 ç¨‹åºåŒ–å¹¿å‘Šçš„å•†ä¸šä»·å€¼"></a>8.1 ç¨‹åºåŒ–å¹¿å‘Šçš„å•†ä¸šä»·å€¼</h2><p>ç¨‹åºåŒ–å¹¿å‘Šä¸ä»…æ˜¯ä¸€é¡¹æŠ€æœ¯åˆ›æ–°ï¼Œæ›´æ˜¯ä¸€åœºå•†ä¸šé©å‘½ã€‚å®ƒé‡æ–°å®šä¹‰äº†å¹¿å‘ŠæŠ•æ”¾çš„æ•ˆç‡å’Œç²¾å‡†åº¦ã€‚</p><p><strong>é‡åŒ–çš„ä¸šåŠ¡æå‡ï¼š</strong></p><ul><li><strong>CTRæå‡</strong>ï¼šç›¸æ¯”ä¼ ç»Ÿå±•ç¤ºå¹¿å‘Šï¼ŒCTRå¹³å‡æå‡2-5å€</li><li><strong>ROIä¼˜åŒ–</strong>ï¼šé€šè¿‡ç²¾å‡†å®šå‘å’Œå®æ—¶ä¼˜åŒ–ï¼ŒROIå¹³å‡æå‡30-50%</li><li><strong>æˆæœ¬é™ä½</strong>ï¼šè‡ªåŠ¨åŒ–è¿è¥å‡å°‘äººå·¥æˆæœ¬60-80%</li><li><strong>æŠ•æ”¾é€Ÿåº¦</strong>ï¼šä»ä¼ ç»Ÿçš„æ•°å¤©ç¼©çŸ­è‡³æ•°åˆ†é’Ÿå†…å¯åŠ¨æŠ•æ”¾</li></ul><p><strong>è¡Œä¸šå½±å“åŠ›ï¼š</strong></p><ul><li><strong>åª’ä½“è¡Œä¸š</strong>ï¼šå¸®åŠ©åª’ä½“æœ€å¤§åŒ–å¹¿å‘Šæ”¶ç›Šï¼Œæå‡å¡«å……ç‡</li><li><strong>å“ç‰Œå¹¿å‘Šä¸»</strong>ï¼šæä¾›ç²¾å‡†çš„å“ç‰Œæ›å…‰å’Œæ•ˆæœè½¬åŒ–</li><li><strong>ä¸­å°ä¼ä¸š</strong>ï¼šé™ä½å¹¿å‘ŠæŠ•æ”¾é—¨æ§›ï¼Œå®ç°ç²¾å‡†è¥é”€</li><li><strong>æ¶ˆè´¹è€…</strong>ï¼šå‡å°‘æ— å…³å¹¿å‘Šå¹²æ‰°ï¼Œæå‡æµè§ˆä½“éªŒ</li></ul><h2 id="8-2-æŠ€æœ¯å®ç°çš„å…³é”®æˆåŠŸå› ç´ "><a href="#8-2-æŠ€æœ¯å®ç°çš„å…³é”®æˆåŠŸå› ç´ " class="headerlink" title="8.2 æŠ€æœ¯å®ç°çš„å…³é”®æˆåŠŸå› ç´ "></a>8.2 æŠ€æœ¯å®ç°çš„å…³é”®æˆåŠŸå› ç´ </h2><h4 id="1-æŠ€æœ¯è¦ç‚¹"><a href="#1-æŠ€æœ¯è¦ç‚¹" class="headerlink" title="1. æŠ€æœ¯è¦ç‚¹"></a>1. æŠ€æœ¯è¦ç‚¹</h4><ol><li><strong>é«˜å¹¶å‘å¤„ç†èƒ½åŠ›</strong>ï¼šRTBè¦æ±‚100mså†…å®Œæˆç«ä»·å†³ç­–</li><li><strong>å®æ—¶æ•°æ®å¤„ç†</strong>ï¼šç”¨æˆ·è¡Œä¸ºæ•°æ®çš„å®æ—¶æ”¶é›†å’Œå¤„ç†</li><li><strong>æœºå™¨å­¦ä¹ åº”ç”¨</strong>ï¼šCTR&#x2F;CVRé¢„ä¼°ã€ç”¨æˆ·ç”»åƒæ„å»º</li><li><strong>ç³»ç»Ÿç¨³å®šæ€§</strong>ï¼š7Ã—24å°æ—¶ä¸é—´æ–­æœåŠ¡</li><li><strong>æ•°æ®å®‰å…¨</strong>ï¼šç”¨æˆ·éšç§ä¿æŠ¤å’Œæ•°æ®åˆè§„</li></ol><h4 id="2-ä¸šåŠ¡ä»·å€¼å®ç°è·¯å¾„"><a href="#2-ä¸šåŠ¡ä»·å€¼å®ç°è·¯å¾„" class="headerlink" title="2. ä¸šåŠ¡ä»·å€¼å®ç°è·¯å¾„"></a>2. ä¸šåŠ¡ä»·å€¼å®ç°è·¯å¾„</h4><pre class="mermaid">flowchart TD    A[æ•°æ®é‡‡é›†ä¸æ•´åˆ] --> B[ç”¨æˆ·ç”»åƒæ„å»º]    B --> C[ç²¾å‡†å®šå‘èƒ½åŠ›]    C --> D[å®æ—¶ç«ä»·å†³ç­–]    D --> E[æŠ•æ”¾æ•ˆæœä¼˜åŒ–]    E --> F[å•†ä¸šä»·å€¼å®ç°]        subgraph "æŠ€æœ¯æ”¯æ’‘"        G[å¤§æ•°æ®å¹³å°]        H[æœºå™¨å­¦ä¹ ç®—æ³•]        I[å®æ—¶è®¡ç®—å¼•æ“]        J[é«˜å¹¶å‘æ¶æ„]    end        subgraph "ä¸šåŠ¡æˆæœ"        K[æå‡CTR/CVR]        L[é™ä½CPC/CPA]        M[æå‡ROI]        N[å¢å¼ºç”¨æˆ·ä½“éªŒ]    end        A -.-> G    B -.-> H    D -.-> I    E -.-> J        F --> K    F --> L    F --> M    F --> N</pre><h4 id="3-å…³é”®ä¸šåŠ¡æŒ‡æ ‡"><a href="#3-å…³é”®ä¸šåŠ¡æŒ‡æ ‡" class="headerlink" title="3. å…³é”®ä¸šåŠ¡æŒ‡æ ‡"></a>3. å…³é”®ä¸šåŠ¡æŒ‡æ ‡</h4><table><thead><tr><th>æŒ‡æ ‡ç±»å‹</th><th>æ ¸å¿ƒæŒ‡æ ‡</th><th>ä¸šåŠ¡æ„ä¹‰</th><th>æŠ€æœ¯å®ç°</th></tr></thead><tbody><tr><td>æ•ˆæœæŒ‡æ ‡</td><td>CTRã€CVR</td><td>å¹¿å‘ŠæŠ•æ”¾æ•ˆæœ</td><td>æœºå™¨å­¦ä¹ é¢„æµ‹æ¨¡å‹</td></tr><tr><td>æˆæœ¬æŒ‡æ ‡</td><td>CPCã€CPA</td><td>æŠ•æ”¾æˆæœ¬æ§åˆ¶</td><td>åŠ¨æ€å®šä»·ç®—æ³•</td></tr><tr><td>æ•ˆç‡æŒ‡æ ‡</td><td>å¡«å……ç‡ã€å“åº”æ—¶é—´</td><td>ç³»ç»Ÿè¿è¡Œæ•ˆç‡</td><td>é«˜å¹¶å‘æ¶æ„è®¾è®¡</td></tr><tr><td>è´¨é‡æŒ‡æ ‡</td><td>å“ç‰Œå®‰å…¨ã€ç”¨æˆ·ä½“éªŒ</td><td>æŠ•æ”¾è´¨é‡ä¿éšœ</td><td>åä½œå¼Šå’Œå†…å®¹å®¡æ ¸</td></tr></tbody></table><h2 id="8-3-æœªæ¥å‘å±•è¶‹åŠ¿ä¸æœºé‡"><a href="#8-3-æœªæ¥å‘å±•è¶‹åŠ¿ä¸æœºé‡" class="headerlink" title="8.3 æœªæ¥å‘å±•è¶‹åŠ¿ä¸æœºé‡"></a>8.3 æœªæ¥å‘å±•è¶‹åŠ¿ä¸æœºé‡</h2><h4 id="1-æŠ€æœ¯å‘å±•æ–¹å‘"><a href="#1-æŠ€æœ¯å‘å±•æ–¹å‘" class="headerlink" title="1. æŠ€æœ¯å‘å±•æ–¹å‘"></a>1. æŠ€æœ¯å‘å±•æ–¹å‘</h4><ol><li><strong>AIæŠ€æœ¯æ·±åº¦åº”ç”¨</strong>ï¼šæ·±åº¦å­¦ä¹ ã€å¼ºåŒ–å­¦ä¹ åœ¨å¹¿å‘Šä¼˜åŒ–ä¸­çš„åº”ç”¨</li><li><strong>éšç§è®¡ç®—æŠ€æœ¯</strong>ï¼šè”é‚¦å­¦ä¹ ã€å¤šæ–¹å®‰å…¨è®¡ç®—ä¿æŠ¤ç”¨æˆ·éšç§</li><li><strong>å®æ—¶ä¸ªæ€§åŒ–</strong>ï¼šæ›´åŠ ç²¾ç»†åŒ–çš„ä¸ªæ€§åŒ–å¹¿å‘ŠæŠ•æ”¾</li><li><strong>è·¨åª’ä½“æ•´åˆ</strong>ï¼šç»Ÿä¸€çš„è·¨åª’ä½“å¹¿å‘ŠæŠ•æ”¾å’Œæ•ˆæœè¡¡é‡</li></ol><h4 id="2-ä¸šåŠ¡å‘å±•æœºé‡"><a href="#2-ä¸šåŠ¡å‘å±•æœºé‡" class="headerlink" title="2. ä¸šåŠ¡å‘å±•æœºé‡"></a>2. ä¸šåŠ¡å‘å±•æœºé‡</h4><ol><li><strong>æ–°å…´åª’ä½“å½¢æ€</strong>ï¼šçŸ­è§†é¢‘ã€ç›´æ’­ã€AR&#x2F;VRç­‰æ–°åœºæ™¯çš„ç¨‹åºåŒ–å¹¿å‘Š</li><li><strong>ä¸‹æ²‰å¸‚åœº</strong>ï¼šä¸‰å››çº¿åŸå¸‚ç”¨æˆ·çš„ç²¾å‡†è¥é”€éœ€æ±‚</li><li><strong>B2Bé¢†åŸŸ</strong>ï¼šä¼ä¸šçº§å®¢æˆ·çš„ç¨‹åºåŒ–è¥é”€éœ€æ±‚å¢é•¿</li><li><strong>å‡ºæµ·ä¸šåŠ¡</strong>ï¼šä¸­å›½ä¼ä¸šæµ·å¤–è¥é”€çš„ç¨‹åºåŒ–å¹¿å‘Šéœ€æ±‚</li></ol><h4 id="3-æŒ‘æˆ˜ä¸åº”å¯¹"><a href="#3-æŒ‘æˆ˜ä¸åº”å¯¹" class="headerlink" title="3. æŒ‘æˆ˜ä¸åº”å¯¹"></a>3. æŒ‘æˆ˜ä¸åº”å¯¹</h4><p><strong>éšç§ä¿æŠ¤æŒ‘æˆ˜</strong></p><ul><li><strong>é—®é¢˜ï¼š</strong> å„å›½éšç§æ³•è§„æ—¥è¶‹ä¸¥æ ¼ï¼Œç¬¬ä¸‰æ–¹Cookieé€æ­¥é€€å‡º</li><li><strong>åº”å¯¹ï¼š</strong> å‘å±•ç¬¬ä¸€æ–¹æ•°æ®èƒ½åŠ›ï¼Œå»ºè®¾éšç§å‹å¥½çš„æŠ€æœ¯æ–¹æ¡ˆ</li></ul><p><strong>æŠ€æœ¯å¤æ‚åº¦æŒ‘æˆ˜</strong></p><ul><li><strong>é—®é¢˜ï¼š</strong> ç³»ç»Ÿå¤æ‚åº¦æŒç»­å¢åŠ ï¼ŒæŠ€æœ¯é—¨æ§›æé«˜</li><li><strong>åº”å¯¹ï¼š</strong> æ ‡å‡†åŒ–æŠ€æœ¯ç»„ä»¶ï¼Œé™ä½æŠ€æœ¯å®ç°å¤æ‚åº¦</li></ul><p><strong>å¸‚åœºç«äº‰æŒ‘æˆ˜</strong></p><ul><li><strong>é—®é¢˜ï¼š</strong> è¡Œä¸šå·¨å¤´å„æ–­ï¼Œä¸­å°ä¼ä¸šéš¾ä»¥ç«äº‰</li><li><strong>åº”å¯¹ï¼š</strong> ä¸“æ³¨ç»†åˆ†é¢†åŸŸï¼Œæä¾›å·®å¼‚åŒ–æŠ€æœ¯æœåŠ¡</li></ul><h2 id="8-4-ç»“è¯­"><a href="#8-4-ç»“è¯­" class="headerlink" title="8.4 ç»“è¯­"></a>8.4 ç»“è¯­</h2><p>ç¨‹åºåŒ–å¹¿å‘Šä½œä¸ºæ•°å­—è¥é”€çš„æ ¸å¿ƒåŸºç¡€è®¾æ–½ï¼Œæ­£åœ¨é‡å¡‘æ•´ä¸ªå¹¿å‘Šè¡Œä¸šçš„æ ¼å±€ã€‚å®ƒä¸ä»…æå‡äº†å¹¿å‘ŠæŠ•æ”¾çš„æ•ˆç‡å’Œç²¾å‡†åº¦ï¼Œæ›´é‡è¦çš„æ˜¯ä¸ºå¹¿å‘Šä¸»ã€åª’ä½“æ–¹å’Œæœ€ç»ˆç”¨æˆ·åˆ›é€ äº†å¤šèµ¢çš„ä»·å€¼ã€‚</p><p>éšç€äººå·¥æ™ºèƒ½ã€å¤§æ•°æ®ã€äº‘è®¡ç®—ç­‰æŠ€æœ¯çš„ä¸æ–­å‘å±•ï¼Œç¨‹åºåŒ–å¹¿å‘Šå°†å‘æ›´åŠ æ™ºèƒ½åŒ–ã€è‡ªåŠ¨åŒ–ã€ä¸ªæ€§åŒ–çš„æ–¹å‘æ¼”è¿›ã€‚åŒæ—¶ï¼Œåœ¨éšç§ä¿æŠ¤å’Œæ•°æ®å®‰å…¨æ—¥ç›Šé‡è¦çš„ä»Šå¤©ï¼Œå¦‚ä½•åœ¨ä¿æŠ¤ç”¨æˆ·éšç§çš„å‰æä¸‹å®ç°ç²¾å‡†è¥é”€ï¼Œå°†æ˜¯è¡Œä¸šå‘å±•çš„é‡è¦è¯¾é¢˜ã€‚</p><p>å¯¹äºæŠ€æœ¯ä»ä¸šè€…è€Œè¨€ï¼Œç¨‹åºåŒ–å¹¿å‘Šé¢†åŸŸæä¾›äº†ä¸°å¯Œçš„æŠ€æœ¯æŒ‘æˆ˜å’Œå‘å±•æœºé‡ã€‚ä»å¤§æ•°æ®å¤„ç†åˆ°æœºå™¨å­¦ä¹ ï¼Œä»å®æ—¶è®¡ç®—åˆ°é«˜å¹¶å‘æ¶æ„ï¼Œæ¯ä¸€ä¸ªæŠ€æœ¯ç¯èŠ‚éƒ½éœ€è¦ç²¾ç›Šæ±‚ç²¾ã€‚åªæœ‰æ·±å…¥ç†è§£ä¸šåŠ¡éœ€æ±‚ï¼ŒæŒæ¡æ ¸å¿ƒæŠ€æœ¯ï¼Œæ‰èƒ½åœ¨è¿™ä¸ªå¿«é€Ÿå‘å±•çš„é¢†åŸŸä¸­ç«‹è¶³å¹¶åˆ›é€ ä»·å€¼ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¹¿å‘ŠæŠ•æ”¾ </tag>
            
            <tag> RTB </tag>
            
            <tag> DSP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æœºå¯†è®¡ç®—ç¯å¢ƒå®æ–½ï¼šä»ç¡¬ä»¶é€‰å‹åˆ°åº”ç”¨éƒ¨ç½²</title>
      <link href="/2025/06/26/confidential_computing_implementation_guide/"/>
      <url>/2025/06/26/confidential_computing_implementation_guide/</url>
      
        <content type="html"><![CDATA[<h1 id="æœºå¯†è®¡ç®—ç¯å¢ƒå®æ–½ï¼šä»ç¡¬ä»¶é€‰å‹åˆ°åº”ç”¨éƒ¨ç½²"><a href="#æœºå¯†è®¡ç®—ç¯å¢ƒå®æ–½ï¼šä»ç¡¬ä»¶é€‰å‹åˆ°åº”ç”¨éƒ¨ç½²" class="headerlink" title="æœºå¯†è®¡ç®—ç¯å¢ƒå®æ–½ï¼šä»ç¡¬ä»¶é€‰å‹åˆ°åº”ç”¨éƒ¨ç½²"></a>æœºå¯†è®¡ç®—ç¯å¢ƒå®æ–½ï¼šä»ç¡¬ä»¶é€‰å‹åˆ°åº”ç”¨éƒ¨ç½²</h1><p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬æ¢è®¨äº†å¤šç§æœºå¯†è®¡ç®—ç¯å¢ƒæ–¹æ¡ˆçš„â€æ˜¯ä»€ä¹ˆâ€ã€‚æœ¬æ–‡å°†ä½œä¸ºå…¶å§Šå¦¹ç¯‡ï¼Œæ·±å…¥æ¢è®¨â€æ€ä¹ˆåšâ€â€”â€”å³å¦‚ä½•åŠ¨æ‰‹å®æ–½è¿™äº›æ–¹æ¡ˆã€‚æˆ‘ä»¬å°†é€ä¸€åˆ†æSGXã€TDXã€CSVã€å¼‚æ„è®¡ç®—å’ŒEnclaveè®¡ç®—è¿™äº”ç§ç¯å¢ƒçš„å®æ–½æ¡ä»¶ï¼ˆè½¯ç¡¬ä»¶è¦æ±‚ï¼‰å’Œè¯¦ç»†æ­¥éª¤ã€‚</p><p>éœ€è¦æ˜ç¡®çš„æ˜¯ï¼Œä¸åŒæ–¹æ¡ˆçš„å®æ–½å¤æ‚åº¦å·®å¼‚å·¨å¤§ã€‚åŸºäºIaaSçš„æ–¹æ¡ˆï¼ˆå¦‚ç›´æ¥ä½¿ç”¨SGX&#x2F;TDXå®ä¾‹ï¼‰èµ‹äºˆç”¨æˆ·æœ€å¤§æ§åˆ¶æƒï¼Œä½†ä¹Ÿè¦æ±‚ç”¨æˆ·å¤„ç†æ›´å¤šåº•å±‚ç»†èŠ‚ï¼›è€ŒPaaSåŒ–çš„æ–¹æ¡ˆï¼ˆå¦‚Enclaveè®¡ç®—æœåŠ¡ï¼‰åˆ™æŠ½è±¡äº†åº•å±‚å¤æ‚æ€§ï¼Œè®©å¼€å‘è€…æ›´ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ã€‚</p><p>å…¶æ¬¡ç”±äºæˆ‘æ²¡æœ‰å¯æ”¯æŒæœºå¯†è®¡ç®—çš„ç¡¬ä»¶è®¾å¤‡å»åšå°è¯•å’Œæµ‹è¯•ï¼Œæœ¬æ–‡æ‰€æœ‰çš„è®¡ç®—ç¯å¢ƒå®æ–½æ­¥éª¤å’Œç¯èŠ‚éƒ½æš‚æ— å®é™…è®ºè¯ï¼Œä»…åšå‚è€ƒäº†è§£ã€‚</p><h2 id="ä¸€-SGXæœºå¯†è®¡ç®—ç¯å¢ƒå®æ–½"><a href="#ä¸€-SGXæœºå¯†è®¡ç®—ç¯å¢ƒå®æ–½" class="headerlink" title="ä¸€. SGXæœºå¯†è®¡ç®—ç¯å¢ƒå®æ–½"></a>ä¸€. SGXæœºå¯†è®¡ç®—ç¯å¢ƒå®æ–½</h2><p>æ­¤æ–¹æ¡ˆä¸ºåº”ç”¨æä¾›ç»†ç²’åº¦çš„Enclaveçº§ä¿æŠ¤ï¼Œä½†å¯¹å¼€å‘è€…çš„æŠ€æœ¯è¦æ±‚æœ€é«˜ã€‚</p><h3 id="1-å®æ–½æ¡ä»¶"><a href="#1-å®æ–½æ¡ä»¶" class="headerlink" title="1. å®æ–½æ¡ä»¶"></a>1. å®æ–½æ¡ä»¶</h3><h4 id="ç¡¬ä»¶è¦æ±‚"><a href="#ç¡¬ä»¶è¦æ±‚" class="headerlink" title="ç¡¬ä»¶è¦æ±‚"></a>ç¡¬ä»¶è¦æ±‚</h4><ul><li><strong>CPU</strong>: å¿…é¡»æ˜¯æ”¯æŒIntel SGXæŒ‡ä»¤é›†çš„CPUã€‚<ul><li><strong>æ”¯æŒç³»åˆ—</strong>: Intel ç¬¬6ä»£è‡³ç¬¬10ä»£é…·ç¿å¤„ç†å™¨ã€è‡³å¼ºE3&#x2F;Eç³»åˆ—ã€ç¬¬ä¸‰ä»£è‡³å¼ºå¯æ‰©å±•å¤„ç†å™¨ï¼ˆIce Lake-SPï¼‰ç­‰ã€‚</li><li><strong>æ³¨æ„</strong>: Intelå·²åœ¨ç¬¬11ä»£åŠæ›´æ–°çš„<strong>å®¢æˆ·ç«¯</strong>CPUä¸­ç§»é™¤äº†SGXæ”¯æŒï¼Œå› æ­¤æ–°æ¬¾ç¬”è®°æœ¬&#x2F;å°å¼æœºåè€Œå¯èƒ½æ— æ³•ä½¿ç”¨ã€‚</li></ul></li><li><strong>ä¸»æ¿&#x2F;BIOS</strong>:<ul><li>BIOSä¸­å¿…é¡»æœ‰æ˜ç¡®å¼€å¯<code>Intel SGX</code>çš„é€‰é¡¹ï¼Œå¹¶è®¾ç½®ä¸º<code>Enabled</code>æˆ–<code>Software Controlled</code>ã€‚</li><li>BIOSä¸­å¿…é¡»èƒ½å¤Ÿè®¾ç½®<code>Enclave Page Cache (EPC)</code>çš„å¤§å°ï¼ˆå¦‚32MB, 64MB, 128MBï¼‰ï¼Œè¿™å—é¢„ç•™å†…å­˜å°†ç”¨äºå­˜æ”¾æ‰€æœ‰Enclaveã€‚</li></ul></li></ul><h4 id="è½¯ä»¶è¦æ±‚"><a href="#è½¯ä»¶è¦æ±‚" class="headerlink" title="è½¯ä»¶è¦æ±‚"></a>è½¯ä»¶è¦æ±‚</h4><ul><li><strong>Linuxå†…æ ¸</strong>: å†…æ ¸ç‰ˆæœ¬éœ€æ”¯æŒ<code>intel_sgx</code>é©±åŠ¨ï¼ˆKernel 5.11åŠä»¥ä¸Šç‰ˆæœ¬å·²é»˜è®¤é›†æˆï¼‰ã€‚</li><li><strong>å¹³å°è½¯ä»¶(PSW)</strong>: å¿…é¡»å®‰è£…Intel SGX Platform Softwareï¼Œå®ƒåŒ…å«<code>aesmd</code>å®ˆæŠ¤è¿›ç¨‹ï¼ˆç”¨äºå¤„ç†è¯æ˜æœåŠ¡ï¼‰å’Œä¸€ç³»åˆ—è¿è¡Œåº“ã€‚</li><li><strong>å¼€å‘å·¥å…·(SDK)</strong>: è‹¥è¦å¼€å‘åº”ç”¨ï¼Œåˆ™å¿…é¡»å®‰è£…Intel SGX SDKï¼Œå®ƒæä¾›å¤´æ–‡ä»¶ã€åº“ã€<code>Edger8r</code>ä»£ç ç”Ÿæˆå·¥å…·ç­‰ã€‚</li></ul><h3 id="2-å®æ–½æ­¥éª¤"><a href="#2-å®æ–½æ­¥éª¤" class="headerlink" title="2. å®æ–½æ­¥éª¤"></a>2. å®æ–½æ­¥éª¤</h3><h4 id="æ–¹æ¡ˆAï¼šä½¿ç”¨äº‘å‚å•†æœåŠ¡ï¼ˆæ¨èï¼‰"><a href="#æ–¹æ¡ˆAï¼šä½¿ç”¨äº‘å‚å•†æœåŠ¡ï¼ˆæ¨èï¼‰" class="headerlink" title="æ–¹æ¡ˆAï¼šä½¿ç”¨äº‘å‚å•†æœåŠ¡ï¼ˆæ¨èï¼‰"></a>æ–¹æ¡ˆAï¼šä½¿ç”¨äº‘å‚å•†æœåŠ¡ï¼ˆæ¨èï¼‰</h4><p>è¿™æ˜¯æœ€ç®€å•ã€æœ€é«˜æ•ˆçš„æ–¹å¼ï¼Œå±è”½äº†æ‰€æœ‰ç¡¬ä»¶å’Œåº•å±‚è½¯ä»¶çš„é…ç½®éº»çƒ¦ã€‚</p><ol><li><strong>é€‰æ‹©å®ä¾‹</strong>: åœ¨äº‘å¹³å°ï¼ˆå¦‚Azure, é˜¿é‡Œäº‘ï¼‰æ§åˆ¶å°ï¼Œé€‰æ‹©æ˜ç¡®æ”¯æŒSGXçš„è™šæ‹Ÿæœºè§„æ ¼ï¼ˆå¦‚Azureçš„DCsv3&#x2F;DCsv4ç³»åˆ—ï¼‰ã€‚</li><li><strong>å®‰è£…è½¯ä»¶æ ˆ</strong>: ç™»å½•åˆ°åˆ›å»ºå¥½çš„è™šæ‹Ÿæœºå®ä¾‹ä¸­ï¼Œæ ¹æ®äº‘å‚å•†çš„æ–‡æ¡£æŒ‡å¼•ï¼Œé€šè¿‡åŒ…ç®¡ç†å™¨ï¼ˆ<code>apt</code>æˆ–<code>yum</code>ï¼‰å®‰è£…SGXçš„é©±åŠ¨ã€PSWå’ŒSDKã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä»¥Ubuntuä¸ºä¾‹</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;deb [arch=amd64] https://download.01.org/intel-sgx/sgx_repo/ubuntu focal main&#x27;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/apt/sources.list.d/intel-sgx.list</span><br><span class="line">wget -qO - https://download.01.org/intel-sgx/sgx_repo/ubuntu/intel-sgx-deb.key | <span class="built_in">sudo</span> apt-key add -</span><br><span class="line"><span class="built_in">sudo</span> apt-get update</span><br><span class="line"><span class="built_in">sudo</span> apt-get install libsgx-enclave-common libsgx-launch libsgx-urts sgx-aesm-service libsgx-quote-ex <span class="comment"># å®‰è£…PSW</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get install libsgx-dcap-ql libsgx-dcap-ql-dev <span class="comment"># å®‰è£…DCAPï¼ˆæ–°ä¸€ä»£è¯æ˜åº“ï¼‰</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get install libsgx-epid libsgx-epid-dev <span class="comment"># ï¼ˆå¯é€‰ï¼‰å®‰è£…EPIDï¼ˆè€ä¸€ä»£è¯æ˜åº“ï¼‰</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get install build-essential python <span class="comment"># å®‰è£…ç¼–è¯‘å·¥å…·</span></span><br><span class="line"><span class="comment"># æ ¹æ®éœ€è¦ä»Intelå®˜ç½‘ä¸‹è½½å¹¶å®‰è£…SDK</span></span><br></pre></td></tr></table></figure></li><li><strong>å¼€å‘ä¸è¿è¡Œ</strong>: ç¼–å†™æˆ–ç¼–è¯‘ä½ çš„SGXåº”ç”¨ç¨‹åºï¼Œç„¶ååƒæ™®é€šç¨‹åºä¸€æ ·è¿è¡Œã€‚</li></ol><h4 id="æ–¹æ¡ˆBï¼šæœ¬åœ°ï¼ˆOn-Premiseï¼‰æ­å»ºï¼ˆä¸“å®¶æ¨¡å¼ï¼‰"><a href="#æ–¹æ¡ˆBï¼šæœ¬åœ°ï¼ˆOn-Premiseï¼‰æ­å»ºï¼ˆä¸“å®¶æ¨¡å¼ï¼‰" class="headerlink" title="æ–¹æ¡ˆBï¼šæœ¬åœ°ï¼ˆOn-Premiseï¼‰æ­å»ºï¼ˆä¸“å®¶æ¨¡å¼ï¼‰"></a>æ–¹æ¡ˆBï¼šæœ¬åœ°ï¼ˆOn-Premiseï¼‰æ­å»ºï¼ˆä¸“å®¶æ¨¡å¼ï¼‰</h4><p>å¯¹äºå¸Œæœ›åœ¨è‡ªæœ‰ç¡¬ä»¶ä¸Šå®ç°å®Œå…¨æ§åˆ¶çš„ä¼ä¸šï¼Œæœ¬åœ°æ­å»ºæ˜¯å¿…ç”±ä¹‹è·¯ã€‚ä»¥ä¸‹æ­¥éª¤ä»¥Ubuntu 22.04 LTSä¸ºä¾‹ï¼š</p><ol><li><p><strong>ç¡¬ä»¶ä¸BIOSç¡®è®¤</strong>: ç¡®ä¿æ‚¨å·²é‡‡è´­äº†ç¬¦åˆè¦æ±‚çš„ç¡¬ä»¶ï¼Œå¹¶åœ¨BIOSä¸­æ­£ç¡®å¼€å¯äº†SGXå¹¶åˆ†é…äº†EPCå¤§å°ã€‚</p></li><li><p><strong>ç³»ç»Ÿä¸é©±åŠ¨éªŒè¯</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…åŸºç¡€æ„å»ºå·¥å…·</span></span><br><span class="line"><span class="built_in">sudo</span> apt update &amp;&amp; <span class="built_in">sudo</span> apt install -y build-essential git python3 ocaml ocaml-native-compilers pkg-config libssl-dev libcurl4-openssl-dev libprotobuf-c-dev protobuf-c-compiler</span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯SGXå†…æ ¸é©±åŠ¨æ˜¯å¦æ­£å¸¸å·¥ä½œ</span></span><br><span class="line"><span class="comment"># æ£€æŸ¥è®¾å¤‡æ–‡ä»¶ï¼Œè¿™æ˜¯å…³é”®æ ‡å¿—</span></span><br><span class="line"><span class="built_in">ls</span> -l /dev/sgx_enclave</span><br><span class="line"><span class="comment"># å¦‚æœä¸å­˜åœ¨ï¼Œå¯èƒ½æ˜¯BIOSæœªå¼€å¯æˆ–å†…æ ¸ç‰ˆæœ¬è¿‡ä½ã€‚ç°ä»£å†…æ ¸é€šå¸¸å·²è‡ªåŠ¨åŠ è½½ã€‚</span></span><br><span class="line"><span class="comment"># æ£€æŸ¥dmesgæ—¥å¿—ä¸­æ˜¯å¦æœ‰EPCå†…å­˜æ®µçš„ä¿¡æ¯</span></span><br><span class="line">dmesg | grep -i sgx_epc</span><br></pre></td></tr></table></figure></li><li><p><strong>ä¸‹è½½å¹¶å®‰è£…Intel SGX PSWä¸SDK</strong>:<br>æœ€å¯é çš„æ–¹å¼æ˜¯ä»Intelå®˜æ–¹çš„GitHubä»“åº“è¿›è¡Œæ„å»ºã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…‹éš†å®˜æ–¹ä»“åº“</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/intel/linux-sgx.git</span><br><span class="line"><span class="built_in">cd</span> linux-sgx</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½é¢„ç¼–è¯‘å¥½çš„ä¾èµ–åº“ï¼Œè¿™æ¯”ä»æºç ç¼–è¯‘æ‰€æœ‰å†…å®¹è¦å¿«å¾—å¤š</span></span><br><span class="line">./download_prebuilt.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¯‘æ•´ä¸ªè½¯ä»¶æ ˆ</span></span><br><span class="line">make -j$(<span class="built_in">nproc</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ†åˆ«å®‰è£…PSW (å¹³å°è¿è¡Œåº“) å’Œ SDK (å¼€å‘å·¥å…·)</span></span><br><span class="line"><span class="built_in">sudo</span> make install</span><br><span class="line"><span class="built_in">sudo</span> make sdk_install</span><br></pre></td></tr></table></figure></li><li><p><strong>é…ç½®å¹¶è¿è¡ŒaesmdæœåŠ¡</strong>:<br><code>aesmd</code>æ˜¯å¤„ç†è¿œç¨‹è¯æ˜çš„å…³é”®åå°æœåŠ¡ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl daemon-reload</span><br><span class="line"><span class="built_in">sudo</span> systemctl start aesmd</span><br><span class="line"><span class="comment"># éªŒè¯æœåŠ¡æ˜¯å¦æˆåŠŸè¿è¡Œ</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl status aesmd</span><br><span class="line"><span class="comment"># (æ¨è) è®¾ç½®ä¸ºå¼€æœºè‡ªå¯</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> aesmd</span><br></pre></td></tr></table></figure></li><li><p><strong>é…ç½®ç¯å¢ƒå¹¶ç«¯åˆ°ç«¯éªŒè¯</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ¿€æ´»SDKç¯å¢ƒå˜é‡ï¼Œå»ºè®®å°†æ­¤è¡ŒåŠ å…¥ ~/.bashrc</span></span><br><span class="line"><span class="built_in">source</span> /opt/intel/sgxsdk/environment</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¯‘å¹¶è¿è¡Œå®˜æ–¹çš„æœ¬åœ°è¯æ˜ç¤ºä¾‹ä»¥å®ŒæˆéªŒè¯</span></span><br><span class="line"><span class="built_in">cd</span> SampleCode/LocalAttestation</span><br><span class="line">make</span><br><span class="line">./app</span><br></pre></td></tr></table></figure><p>å¦‚æœæœ€åçš„è¾“å‡ºæ˜¾ç¤ºæˆåŠŸï¼ˆå¦‚ <code>A grand success!</code>ï¼‰ï¼Œåˆ™ä»£è¡¨æ‚¨çš„æœ¬åœ°SGXå¼€å‘å’Œè¿è¡Œç¯å¢ƒå·²å®Œå…¨å°±ç»ªã€‚</p></li></ol><h2 id="äºŒ-TDXæœºå¯†è®¡ç®—ç¯å¢ƒå®æ–½"><a href="#äºŒ-TDXæœºå¯†è®¡ç®—ç¯å¢ƒå®æ–½" class="headerlink" title="äºŒ. TDXæœºå¯†è®¡ç®—ç¯å¢ƒå®æ–½"></a>äºŒ. TDXæœºå¯†è®¡ç®—ç¯å¢ƒå®æ–½</h2><p>æ­¤æ–¹æ¡ˆä¿æŠ¤æ•´ä¸ªè™šæ‹Ÿæœºï¼Œæ˜“ç”¨æ€§é«˜ï¼Œæ˜¯ä¿æŠ¤é—ç•™åº”ç”¨çš„ä¸»æµé€‰æ‹©ã€‚<strong>ä¸ªäººæˆ–åœ¨éäº‘ç¯å¢ƒæœ¬åœ°æ­å»ºTDXç¯å¢ƒæå…¶å¤æ‚ï¼Œå¼ºçƒˆä¸æ¨èã€‚</strong></p><h3 id="1-å®æ–½æ¡ä»¶-1"><a href="#1-å®æ–½æ¡ä»¶-1" class="headerlink" title="1. å®æ–½æ¡ä»¶"></a>1. å®æ–½æ¡ä»¶</h3><h4 id="ç¡¬ä»¶è¦æ±‚-1"><a href="#ç¡¬ä»¶è¦æ±‚-1" class="headerlink" title="ç¡¬ä»¶è¦æ±‚"></a>ç¡¬ä»¶è¦æ±‚</h4><ul><li><strong>CPU</strong>: å¿…é¡»æ˜¯æ”¯æŒIntel TDXçš„CPUï¼Œç›®å‰ä¸»è¦æ˜¯ç¬¬å››ä»£Intelè‡³å¼ºå¯æ‰©å±•å¤„ç†å™¨ï¼ˆSapphire Rapidsï¼‰åŠæ›´æ–°çš„æœåŠ¡å™¨CPUã€‚</li><li><strong>ä¸»æ¿&#x2F;BIOS</strong>: BIOSä¸­å¿…é¡»åŒæ—¶å¼€å¯<code>VT-x</code>, <code>VT-d</code>, <code>TME</code> å’Œ <code>TDX</code>ã€‚</li></ul><h4 id="è½¯ä»¶è¦æ±‚-1"><a href="#è½¯ä»¶è¦æ±‚-1" class="headerlink" title="è½¯ä»¶è¦æ±‚"></a>è½¯ä»¶è¦æ±‚</h4><ul><li><strong>ä¸»æœºç«¯(Host)</strong>: éœ€è¦ä¸€ä¸ªç»è¿‡æ·±åº¦å®šåˆ¶å’Œæ‰“è¡¥ä¸çš„è½¯ä»¶æ ˆï¼ŒåŒ…æ‹¬ç‰¹å®šçš„Linuxå†…æ ¸ç‰ˆæœ¬ã€QEMUç‰ˆæœ¬ã€ä»¥åŠTDXæ¨¡å—çš„é©±åŠ¨ã€‚</li><li><strong>å®¢æˆ·æœºç«¯(Guest)</strong>: è™šæ‹Ÿæœºå†…éƒ¨ä¹Ÿéœ€è¦ç‰¹å®šçš„å›ºä»¶ï¼ˆTD-Shimï¼‰å’Œæ”¯æŒTDXçš„Guestå†…æ ¸ã€‚</li></ul><h3 id="2-å®æ–½æ­¥éª¤ï¼ˆä»…æ¨èäº‘å‚å•†æ–¹æ¡ˆï¼‰"><a href="#2-å®æ–½æ­¥éª¤ï¼ˆä»…æ¨èäº‘å‚å•†æ–¹æ¡ˆï¼‰" class="headerlink" title="2. å®æ–½æ­¥éª¤ï¼ˆä»…æ¨èäº‘å‚å•†æ–¹æ¡ˆï¼‰"></a>2. å®æ–½æ­¥éª¤ï¼ˆä»…æ¨èäº‘å‚å•†æ–¹æ¡ˆï¼‰</h3><ol><li><strong>é€‰æ‹©å®ä¾‹</strong>: åœ¨äº‘å¹³å°æ§åˆ¶å°ï¼Œé€‰æ‹©æ”¯æŒTDXçš„æœºå¯†è™šæ‹Ÿæœºè§„æ ¼ã€‚</li><li><strong>é€‰æ‹©é•œåƒ</strong>: é€‰æ‹©äº‘å‚å•†æä¾›çš„ã€ä¸“é—¨ä¸ºTDXä¼˜åŒ–çš„æ“ä½œç³»ç»Ÿé•œåƒã€‚è¿™äº›é•œåƒå·²ç»å†…ç½®äº†æ‰€æœ‰å¿…è¦çš„Guestç«¯é©±åŠ¨å’Œå›ºä»¶ã€‚</li><li><strong>ä¸€é”®å¯åŠ¨</strong>: åƒåˆ›å»ºæ™®é€šè™šæ‹Ÿæœºä¸€æ ·ï¼Œç‚¹å‡»åˆ›å»ºå³å¯ã€‚äº‘å¹³å°åå°ä¼šè‡ªåŠ¨å¤„ç†æ‰€æœ‰ä¸»æœºç«¯å’Œå®¢æˆ·æœºçš„å¤æ‚é…ç½®ã€‚</li><li><strong>éªŒè¯ç¯å¢ƒ</strong>: ç™»å½•åˆ°è™šæ‹Ÿæœºåï¼Œå¯ä»¥é€šè¿‡<code>dmesg</code>æ—¥å¿—æˆ–å‚å•†æä¾›çš„å·¥å…·æ¥éªŒè¯TDXæ˜¯å¦å·²æˆåŠŸå¯ç”¨ã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¤ºä¾‹ï¼šæ£€æŸ¥dmesgæ—¥å¿—ä¸­æ˜¯å¦æœ‰TDXæˆ–TDVMCALLç›¸å…³ä¿¡æ¯</span></span><br><span class="line">dmesg | grep -i tdx</span><br></pre></td></tr></table></figure></li><li><strong>éƒ¨ç½²åº”ç”¨</strong>: ç›´æ¥å°†ä½ çš„åº”ç”¨ç¨‹åºæˆ–æœåŠ¡éƒ¨ç½²åˆ°è¿™ä¸ªè™šæ‹Ÿæœºä¸­ï¼Œæ— éœ€ä»»ä½•ä»£ç ä¿®æ”¹ã€‚</li></ol><h4 id="æ–¹æ¡ˆBï¼šæœ¬åœ°ï¼ˆOn-Premiseï¼‰æ­å»ºï¼ˆä¸“å®¶æ¨¡å¼ï¼‰-1"><a href="#æ–¹æ¡ˆBï¼šæœ¬åœ°ï¼ˆOn-Premiseï¼‰æ­å»ºï¼ˆä¸“å®¶æ¨¡å¼ï¼‰-1" class="headerlink" title="æ–¹æ¡ˆBï¼šæœ¬åœ°ï¼ˆOn-Premiseï¼‰æ­å»ºï¼ˆä¸“å®¶æ¨¡å¼ï¼‰"></a>æ–¹æ¡ˆBï¼šæœ¬åœ°ï¼ˆOn-Premiseï¼‰æ­å»ºï¼ˆä¸“å®¶æ¨¡å¼ï¼‰</h4><p><strong>è­¦å‘Šï¼š</strong> æœ¬åœ°æ­å»ºTDXç¯å¢ƒæ˜¯ä¸€é¡¹æå…¶å¤æ‚çš„ç³»ç»Ÿå·¥ç¨‹ï¼Œæ¶‰åŠä¸€æ•´å¥—ç›¸äº’ä¾èµ–çš„åº•å±‚è½¯ä»¶æ ˆçš„ç¼–è¯‘å’Œé…ç½®ï¼Œä»…æ¨èç»™æœ‰æ·±åšåº•å±‚è½¯ä»¶ç»éªŒçš„ä¸“å®¶ç”¨äºç ”ç©¶ã€‚</p><p><strong>æ ¸å¿ƒæ€è·¯ï¼š</strong> å¼ºçƒˆå»ºè®®ä½¿ç”¨Intelå®˜æ–¹æä¾›çš„ <code>tdx-tools</code> é¡¹ç›®ï¼Œå®ƒé€šè¿‡è‡ªåŠ¨åŒ–è„šæœ¬ç®¡ç†äº†å¤§éƒ¨åˆ†å¤æ‚æ€§ã€‚</p><ol><li><p><strong>ç¡¬ä»¶ä¸BIOSç¡®è®¤</strong>: ç¡®è®¤æ‚¨æ‹¥æœ‰æ”¯æŒTDXçš„æœåŠ¡å™¨ç¡¬ä»¶ï¼ˆå¦‚æ­è½½Sapphire Rapids CPUï¼‰ï¼Œå¹¶å·²åœ¨BIOSä¸­æ­£ç¡®å¼€å¯æ‰€æœ‰ç›¸å…³è™šæ‹ŸåŒ–å’Œå®‰å…¨é€‰é¡¹ã€‚</p></li><li><p><strong>å…‹éš†å¹¶è¿›å…¥tdx-toolsä»“åº“</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/intel/tdx-tools.git</span><br><span class="line"><span class="built_in">cd</span> tdx-tools/tdx-builder</span><br></pre></td></tr></table></figure></li><li><p><strong>æ„å»ºä¸»æœºç«¯è½¯ä»¶æ ˆ</strong>:<br>æ­¤è„šæœ¬ä¼šä¸‹è½½å†…æ ¸ã€QEMUç­‰æºç ï¼Œåº”ç”¨TDXè¡¥ä¸å¹¶ç¼–è¯‘ã€‚è¿‡ç¨‹è€—æ—¶è¾ƒé•¿ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ„å»ºæ‰€æœ‰ä¸»æœºç«¯ç»„ä»¶</span></span><br><span class="line">./build.sh -t host</span><br></pre></td></tr></table></figure><p>æ„å»ºå®Œæˆåï¼Œç”Ÿæˆçš„debåŒ…ä½äº <code>output/host_packages</code> ç›®å½•ã€‚</p></li><li><p><strong>å®‰è£…ä¸»æœºè½¯ä»¶åŒ…å¹¶é‡å¯</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> output/host_packages</span><br><span class="line"><span class="built_in">sudo</span> dpkg -i *.deb</span><br><span class="line"><span class="comment"># ä¿®å¤å¯èƒ½å­˜åœ¨çš„ä¾èµ–é—®é¢˜</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get install -f</span><br><span class="line"><span class="comment"># å¿…é¡»é‡å¯ä»¥åŠ è½½æ–°çš„TDXå†…æ ¸</span></span><br><span class="line"><span class="built_in">sudo</span> reboot</span><br></pre></td></tr></table></figure></li><li><p><strong>æ„å»ºå®¢æˆ·æœºé•œåƒ</strong>:<br>é‡å¯åï¼Œå›åˆ°<code>tdx-builder</code>ç›®å½•ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ„å»ºä¸€ä¸ªåŸºäºUbuntuçš„TDX Guesté•œåƒ</span></span><br><span class="line">./build.sh -t guest -o ubuntu</span><br></pre></td></tr></table></figure><p>ç”Ÿæˆçš„qcow2é•œåƒæ–‡ä»¶å°†ä½äº<code>output/</code>ç›®å½•ã€‚</p></li><li><p><strong>å¯åŠ¨å¹¶éªŒè¯TDXè™šæ‹Ÿæœº</strong>:<br><code>tdx-tools</code>æä¾›äº†ä¸€ä¸ªä¾¿æ·çš„å¯åŠ¨è„šæœ¬ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ../../tdx-qemu-run</span><br><span class="line"><span class="comment"># ä½¿ç”¨ä¸Šä¸€æ­¥ç”Ÿæˆçš„é•œåƒå¯åŠ¨VM</span></span><br><span class="line">./tdx-qemu-run.sh -i ../tdx-builder/output/tdx-guest-ubuntu-*.qcow2</span><br></pre></td></tr></table></figure><p>æˆåŠŸå¯åŠ¨åï¼Œç™»å½•è™šæ‹Ÿæœºï¼ˆé»˜è®¤å‡­æ®è¯·æŸ¥é˜…<code>tdx-tools</code>æ–‡æ¡£ï¼‰ï¼Œåœ¨Guestå†…éƒ¨è¿›è¡ŒéªŒè¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ£€æŸ¥dmesgæ—¥å¿—ï¼Œåº”èƒ½çœ‹åˆ°TDXæˆ–Trust Domainç›¸å…³ä¿¡æ¯</span></span><br><span class="line">dmesg | grep -i tdx</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨TDXå·¥å…·è·å–å¹¶éªŒè¯è¿œç¨‹è¯æ˜æŠ¥å‘Š (Quote)</span></span><br><span class="line"><span class="comment"># tdx-attestå·¥å…·é€šå¸¸å·²ç”±æ„å»ºè„šæœ¬å†…ç½®åœ¨Guesté•œåƒä¸­</span></span><br><span class="line">tdx-attest --report-data <span class="string">&quot;some-verification-data&quot;</span> --out-file report.dat</span><br><span class="line">tdx-attest --verify --in-file report.dat</span><br></pre></td></tr></table></figure><p>æˆåŠŸè·å–å¹¶éªŒè¯Quoteï¼Œæ ‡å¿—ç€ç«¯åˆ°ç«¯çš„æœ¬åœ°TDXç¯å¢ƒæ­å»ºå®Œæˆã€‚</p></li></ol><h2 id="ä¸‰-CSVæœºå¯†è®¡ç®—ç¯å¢ƒå®æ–½ï¼ˆåŸºäºæµ·å…‰CPUï¼‰"><a href="#ä¸‰-CSVæœºå¯†è®¡ç®—ç¯å¢ƒå®æ–½ï¼ˆåŸºäºæµ·å…‰CPUï¼‰" class="headerlink" title="ä¸‰. CSVæœºå¯†è®¡ç®—ç¯å¢ƒå®æ–½ï¼ˆåŸºäºæµ·å…‰CPUï¼‰"></a>ä¸‰. CSVæœºå¯†è®¡ç®—ç¯å¢ƒå®æ–½ï¼ˆåŸºäºæµ·å…‰CPUï¼‰</h2><p>æ­¤æ–¹æ¡ˆä¸TDXç±»ä¼¼ï¼Œæ˜¯åŸºäºå›½äº§ç¡¬ä»¶çš„æœºå¯†è™šæ‹Ÿæœºæ–¹æ¡ˆã€‚ç›®å‰ä¸»è¦é€šè¿‡äº‘å‚å•†æä¾›æœåŠ¡ã€‚</p><h3 id="1-å®æ–½æ¡ä»¶-2"><a href="#1-å®æ–½æ¡ä»¶-2" class="headerlink" title="1. å®æ–½æ¡ä»¶"></a>1. å®æ–½æ¡ä»¶</h3><ul><li><strong>ç¡¬ä»¶è¦æ±‚</strong>: åŸºäºå›½äº§æµ·å…‰ï¼ˆHygonï¼‰CPUçš„ç‰¹å®šæœåŠ¡å™¨ã€‚</li><li><strong>è½¯ä»¶è¦æ±‚</strong>: äº‘å‚å•†æŒ‡å®šçš„æ“ä½œç³»ç»Ÿé•œåƒï¼Œå¦‚é˜¿é‡Œäº‘æŒ‡å®šçš„<code>Alibaba Cloud Linux 3</code>ã€‚</li></ul><h3 id="2-å®æ–½æ­¥éª¤ï¼ˆäº‘å‚å•†æ–¹æ¡ˆï¼‰"><a href="#2-å®æ–½æ­¥éª¤ï¼ˆäº‘å‚å•†æ–¹æ¡ˆï¼‰" class="headerlink" title="2. å®æ–½æ­¥éª¤ï¼ˆäº‘å‚å•†æ–¹æ¡ˆï¼‰"></a>2. å®æ–½æ­¥éª¤ï¼ˆäº‘å‚å•†æ–¹æ¡ˆï¼‰</h3><ol><li><strong>é€‰æ‹©å®ä¾‹</strong>: åœ¨é˜¿é‡Œäº‘ç­‰å¹³å°ï¼Œé€‰æ‹©åŸºäºæµ·å…‰CPUçš„ç‰¹å®šå®ä¾‹è§„æ ¼æ—ï¼ˆå¦‚g7hï¼‰ã€‚</li><li><strong>é€‰æ‹©é•œåƒ</strong>: å¿…é¡»å‹¾é€‰<code>æœºå¯†è™šæ‹Ÿæœº</code>é€‰é¡¹ï¼Œå¹¶é€‰æ‹©å®˜æ–¹æŒ‡å®šçš„æ“ä½œç³»ç»Ÿé•œåƒã€‚</li><li><strong>å¯åŠ¨ä¸éªŒè¯</strong>:<ul><li>å¯åŠ¨å®ä¾‹åï¼Œç™»å½•å¹¶æ£€æŸ¥CSVä½¿èƒ½çŠ¶æ€ã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ£€æŸ¥MSRå¯„å­˜å™¨ç¡®è®¤CSVæ˜¯å¦å¼€å¯</span></span><br><span class="line"><span class="built_in">sudo</span> yum install -y msr-tools</span><br><span class="line"><span class="built_in">sudo</span> rdmsr 0xC0010131 --bitfield 1:0 <span class="comment"># é¢„æœŸè¾“å‡ºä¸º 0x3</span></span><br><span class="line"><span class="comment"># æ£€æŸ¥å†…æ ¸æ—¥å¿—</span></span><br><span class="line">dmesg | grep SEV</span><br><span class="line"><span class="comment"># æ£€æŸ¥Guesté©±åŠ¨</span></span><br><span class="line"><span class="built_in">ls</span> -l /dev/csv-guest</span><br></pre></td></tr></table></figure></li><li>ï¼ˆå¯é€‰ï¼‰ä¸‹è½½å¹¶è¿è¡Œå‚å•†æä¾›çš„è¯æ˜å·¥å…·ï¼Œæ¥ç”Ÿæˆå’ŒéªŒè¯è¿œç¨‹è¯æ˜æŠ¥å‘Šã€‚</li></ul></li></ol><h2 id="å››-Enclaveæœºå¯†è®¡ç®—ç¯å¢ƒå®æ–½"><a href="#å››-Enclaveæœºå¯†è®¡ç®—ç¯å¢ƒå®æ–½" class="headerlink" title="å››. Enclaveæœºå¯†è®¡ç®—ç¯å¢ƒå®æ–½"></a>å››. Enclaveæœºå¯†è®¡ç®—ç¯å¢ƒå®æ–½</h2><p>è¿™æ˜¯ä¸€ç§PaaSåŒ–çš„æ–¹æ¡ˆï¼Œç›®æ ‡æ˜¯è®©å¼€å‘è€…å®Œå…¨æ— éœ€å…³å¿ƒåº•å±‚ç¡¬ä»¶å’ŒTEEç»†èŠ‚ã€‚</p><h3 id="1-å®æ–½æ¡ä»¶-3"><a href="#1-å®æ–½æ¡ä»¶-3" class="headerlink" title="1. å®æ–½æ¡ä»¶"></a>1. å®æ–½æ¡ä»¶</h3><ul><li><strong>ç¡¬ä»¶è¦æ±‚</strong>: å¯¹ç”¨æˆ·é€æ˜ï¼Œç”±äº‘å¹³å°è´Ÿè´£ã€‚</li><li><strong>è½¯ä»¶è¦æ±‚</strong>:<ul><li>ç†Ÿæ‚‰å®¹å™¨åŒ–æŠ€æœ¯ï¼Œå¦‚Dockerã€‚</li><li>å®‰è£…äº‘å‚å•†æä¾›çš„å‘½ä»¤è¡Œå·¥å…·ï¼ˆCLIï¼‰æˆ–ä½¿ç”¨å…¶Webæ§åˆ¶å°ã€‚</li><li>éµå¾ªå‚å•†å®šä¹‰çš„Enclaveåº”ç”¨æ‰“åŒ…è§„èŒƒï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªç‰¹å®šçš„Dockerfileæˆ–é…ç½®æ–‡ä»¶ï¼‰ã€‚</li></ul></li></ul><h3 id="2-å®æ–½æ­¥éª¤-1"><a href="#2-å®æ–½æ­¥éª¤-1" class="headerlink" title="2. å®æ–½æ­¥éª¤"></a>2. å®æ–½æ­¥éª¤</h3><p>è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„PaaSåº”ç”¨å¼€å‘å’Œéƒ¨ç½²æµç¨‹ï¼š</p><ol><li><strong>ç¼–å†™ä¸šåŠ¡ä»£ç </strong>: ä½¿ç”¨ä½ ç†Ÿæ‚‰çš„è¯­è¨€ï¼ˆå¦‚Python, Go, Javaï¼‰ç¼–å†™åº”ç”¨é€»è¾‘ã€‚</li><li><strong>å®¹å™¨åŒ–å°è£…</strong>: æ ¹æ®äº‘å‚å•†çš„æ–‡æ¡£ï¼Œç¼–å†™ä¸€ä¸ªDockerfileã€‚è¿™ä¸ªDockerfileé™¤äº†å¸¸è§„çš„åº”ç”¨æ„å»ºæŒ‡ä»¤å¤–ï¼Œå¯èƒ½ä¼šåŒ…å«ä¸€äº›ç‰¹æ®Šçš„å…ƒæ•°æ®æˆ–åŸºç¡€é•œåƒï¼Œç”¨äºå‘Šè¯‰å¹³å°è¿™æ˜¯ä¸€ä¸ªæœºå¯†åº”ç”¨ã€‚</li><li><strong>æ„å»ºä¸æ¨é€</strong>: ä½¿ç”¨<code>docker build</code>æ„å»ºé•œåƒï¼Œå¹¶å°†å…¶æ¨é€åˆ°äº‘å‚å•†çš„å®¹å™¨é•œåƒä»“åº“ã€‚</li><li><strong>æœåŠ¡éƒ¨ç½²</strong>: é€šè¿‡ä¸€è¡ŒCLIå‘½ä»¤æˆ–åœ¨Webæ§åˆ¶å°ç‚¹å‡»å‡ ä¸‹ï¼Œå°†è¯¥é•œåƒéƒ¨ç½²ä¸ºä¸€ä¸ªæœåŠ¡ã€‚ä¾‹å¦‚ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ¦‚å¿µæ€§å‘½ä»¤ï¼ŒéçœŸå®</span></span><br><span class="line">aliyun-enclave-cli deploy --image my-registry/my-confidential-app:v1 --cpu 1 --mem 2G</span><br></pre></td></tr></table></figure></li><li><strong>å¹³å°è‡ªåŠ¨åŒ–</strong>: äº‘å¹³å°ä¼šè‡ªåŠ¨æ‹‰å–ä½ çš„é•œåƒï¼Œåœ¨åº•å±‚çš„SGXç­‰ç¡¬ä»¶ç¯å¢ƒä¸­è§£åŒ…ã€åŠ è½½å¹¶å®‰å…¨åœ°è¿è¡Œä½ çš„åº”ç”¨ï¼ŒåŒæ—¶è‡ªåŠ¨å¤„ç†ç½‘ç»œã€æ‰©ç¼©å®¹ç­‰é—®é¢˜ã€‚</li></ol><h2 id="äº”-å¼‚æ„æœºå¯†è®¡ç®—ç¯å¢ƒå®æ–½"><a href="#äº”-å¼‚æ„æœºå¯†è®¡ç®—ç¯å¢ƒå®æ–½" class="headerlink" title="äº”. å¼‚æ„æœºå¯†è®¡ç®—ç¯å¢ƒå®æ–½"></a>äº”. å¼‚æ„æœºå¯†è®¡ç®—ç¯å¢ƒå®æ–½</h2><p>è¿™å¹¶éä¸€ä¸ªç‹¬ç«‹çš„äº§å“ï¼Œè€Œæ˜¯ä¸€ä¸ª<strong>è§£å†³æ–¹æ¡ˆæ¶æ„</strong>ï¼Œå…¶å®æ–½æ­¥éª¤æ˜¯ä¸€ä¸ªç³»ç»Ÿè®¾è®¡å’Œé›†æˆçš„è¿‡ç¨‹ã€‚</p><h3 id="1-å®æ–½æ¡ä»¶-4"><a href="#1-å®æ–½æ¡ä»¶-4" class="headerlink" title="1. å®æ–½æ¡ä»¶"></a>1. å®æ–½æ¡ä»¶</h3><ul><li>éœ€è¦è®¢é˜…äº‘å¹³å°ä¸Šå¤šç§ä¸åŒçš„è®¡ç®—æœåŠ¡ï¼Œè‡³å°‘åŒ…æ‹¬ï¼š<ul><li>ä¸€ç§æˆ–å¤šç§æœºå¯†è®¡ç®—å®ä¾‹ï¼ˆå¦‚SGXå®ä¾‹ã€TDXå®ä¾‹ï¼‰ã€‚</li><li>é«˜æ€§èƒ½è®¡ç®—èµ„æºï¼ˆå¦‚GPUå®ä¾‹ï¼‰ã€‚</li><li>å®‰å…¨çš„äº‘å­˜å‚¨ã€æ¶ˆæ¯é˜Ÿåˆ—ã€å¯†é’¥ç®¡ç†æœåŠ¡ï¼ˆKMSï¼‰ç­‰ã€‚</li></ul></li></ul><h3 id="2-å®æ–½æ­¥éª¤ï¼ˆè®¾è®¡ä¸é›†æˆï¼‰"><a href="#2-å®æ–½æ­¥éª¤ï¼ˆè®¾è®¡ä¸é›†æˆï¼‰" class="headerlink" title="2. å®æ–½æ­¥éª¤ï¼ˆè®¾è®¡ä¸é›†æˆï¼‰"></a>2. å®æ–½æ­¥éª¤ï¼ˆè®¾è®¡ä¸é›†æˆï¼‰</h3><ol><li><strong>å·¥ä½œæµåˆ†è§£</strong>: åˆ†æä½ çš„ä¸šåŠ¡æµç¨‹ï¼Œå°†å…¶åˆ†è§£ä¸ºå¤šä¸ªç‹¬ç«‹çš„é˜¶æ®µã€‚</li><li><strong>ç»„ä»¶é€‰å‹</strong>: ä¸ºæ¯ä¸ªé˜¶æ®µé€‰æ‹©æœ€é€‚åˆçš„æŠ€æœ¯ã€‚<ul><li><strong>ç¤ºä¾‹</strong>: ä¸€ä¸ªæœºå¯†AIæ¨ç†æµç¨‹ã€‚<ul><li><strong>é˜¶æ®µ1ï¼šå¯†é’¥ç®¡ç†</strong> -&gt; å¯¹å®‰å…¨æ€§è¦æ±‚æœ€é«˜ï¼Œä½†è®¡ç®—é‡å°ï¼Œé€‰æ‹©<strong>SGXæœºå¯†è®¡ç®—</strong>ç¯å¢ƒæ¥è¿è¡Œå¯†é’¥ç®¡ç†æœåŠ¡ã€‚</li><li><strong>é˜¶æ®µ2ï¼šæ¨¡å‹åŠ è½½ä¸æ•°æ®è§£å¯†</strong> -&gt; éœ€è¦ä¸€ä¸ªå®Œæ•´çš„ã€å—ä¿æŠ¤çš„OSç¯å¢ƒæ¥å¤„ç†æ¨¡å‹å’Œæ•°æ®ï¼Œé€‰æ‹©<strong>TDXæœºå¯†è®¡ç®—</strong>è™šæ‹Ÿæœºã€‚</li><li><strong>é˜¶æ®µ3ï¼šAIæ¨ç†</strong> -&gt; éœ€è¦å¼ºå¤§çš„å¹¶è¡Œè®¡ç®—èƒ½åŠ›ï¼Œåœ¨TDXè™šæ‹Ÿæœºå†…éƒ¨ï¼Œé€šè¿‡é©±åŠ¨è°ƒç”¨<strong>GPU</strong>èµ„æºè¿›è¡ŒåŠ é€Ÿã€‚</li><li><strong>é˜¶æ®µ4ï¼šç»“æœè¾“å‡º</strong> -&gt; å°†åŠ å¯†åçš„æ¨ç†ç»“æœå­˜å…¥<strong>å¯¹è±¡å­˜å‚¨</strong>ã€‚</li></ul></li></ul></li><li><strong>å®‰å…¨é›†æˆ</strong>: è®¾è®¡å„ç»„ä»¶ä¹‹é—´çš„å®‰å…¨é€šä¿¡å’Œæ•°æ®äº¤æ¥æ–¹æ¡ˆã€‚ä¾‹å¦‚ï¼ŒSGXæœåŠ¡ç”Ÿæˆçš„æ•°æ®å¯†é’¥ï¼Œå¦‚ä½•å®‰å…¨åœ°ä¼ é€’ç»™TDXè™šæ‹Ÿæœºï¼Ÿé€šå¸¸éœ€è¦ç»“åˆè¿œç¨‹è¯æ˜å’Œå¯†é’¥ç®¡ç†æœåŠ¡ï¼ˆKMSï¼‰æ¥å®ç°ã€‚</li><li><strong>éƒ¨ç½²ä¸ç¼–æ’</strong>: åˆ†åˆ«éƒ¨ç½²ä¸Šè¿°å„ä¸ªç»„ä»¶ï¼Œå¹¶ä½¿ç”¨å·¥ä½œæµå¼•æ“æˆ–è‡ªå®šä¹‰è„šæœ¬å°†å®ƒä»¬ä¸²è”èµ·æ¥ï¼Œå½¢æˆè‡ªåŠ¨åŒ–çš„ä¸šåŠ¡æµæ°´çº¿ã€‚</li></ol><hr><p><strong>æ€»ç»“</strong>: ä»å®æ–½è§’åº¦çœ‹ï¼Œæœ€ç›´æ¥æœ‰æ•ˆçš„æ–¹å¼æ˜¯ä»äº‘å‚å•†æä¾›çš„PaaSåŒ–<strong>Enclaveè®¡ç®—æœåŠ¡</strong>æˆ–IaaS<strong>æœºå¯†è™šæ‹Ÿæœºï¼ˆTDX&#x2F;CSVï¼‰</strong>å…¥æ‰‹ã€‚è¿™èƒ½è®©ä½ å¿«é€Ÿä½“éªŒåˆ°æœºå¯†è®¡ç®—çš„ä»·å€¼ã€‚è€ŒSGXå¼€å‘å’Œæœ¬åœ°æ­å»ºTEEç¯å¢ƒï¼Œåˆ™æ›´é€‚åˆæœ‰æ·±åº¦å®šåˆ¶éœ€æ±‚å’Œå¼ºå¤§æŠ€æœ¯å‚¨å¤‡çš„ä¸“ä¸šå›¢é˜Ÿã€‚ </p>]]></content>
      
      
      <categories>
          
          <category> å¤§æ•°æ® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TME </tag>
            
            <tag> SGX </tag>
            
            <tag> TDX </tag>
            
            <tag> TEE </tag>
            
            <tag> éšç§è®¡ç®— </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HDFSæŠ€æœ¯è¯¦è§£ï¼šæ¶æ„ã€å­˜å‚¨ä¸æ•°æ®å®‰å…¨æœºåˆ¶</title>
      <link href="/2025/06/25/HDFS%E6%8A%80%E6%9C%AF%E8%AF%A6%E8%A7%A3%EF%BC%9A%E6%9E%B6%E6%9E%84%E3%80%81%E5%AD%98%E5%82%A8%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6/"/>
      <url>/2025/06/25/HDFS%E6%8A%80%E6%9C%AF%E8%AF%A6%E8%A7%A3%EF%BC%9A%E6%9E%B6%E6%9E%84%E3%80%81%E5%AD%98%E5%82%A8%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<h1 id="HDFSæŠ€æœ¯è¯¦è§£ï¼šæ¶æ„ã€å­˜å‚¨ä¸æ•°æ®å®‰å…¨æœºåˆ¶"><a href="#HDFSæŠ€æœ¯è¯¦è§£ï¼šæ¶æ„ã€å­˜å‚¨ä¸æ•°æ®å®‰å…¨æœºåˆ¶" class="headerlink" title="HDFSæŠ€æœ¯è¯¦è§£ï¼šæ¶æ„ã€å­˜å‚¨ä¸æ•°æ®å®‰å…¨æœºåˆ¶"></a>HDFSæŠ€æœ¯è¯¦è§£ï¼šæ¶æ„ã€å­˜å‚¨ä¸æ•°æ®å®‰å…¨æœºåˆ¶</h1><h2 id="ä¸€ã€æ•´ä½“æ¶æ„"><a href="#ä¸€ã€æ•´ä½“æ¶æ„" class="headerlink" title="ä¸€ã€æ•´ä½“æ¶æ„"></a>ä¸€ã€æ•´ä½“æ¶æ„</h2><p>HDFSé‡‡ç”¨ä¸»ä»ï¼ˆMaster&#x2F;Slaveï¼‰æ¶æ„æ¨¡å¼ï¼Œç”±ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶æ„æˆï¼š</p><h3 id="1-1-æ ¸å¿ƒç»„ä»¶"><a href="#1-1-æ ¸å¿ƒç»„ä»¶" class="headerlink" title="1.1 æ ¸å¿ƒç»„ä»¶"></a>1.1 æ ¸å¿ƒç»„ä»¶</h3><ul><li><p><strong>NameNode</strong>ï¼šé›†ç¾¤çš„ç®¡ç†è€…ï¼Œè´Ÿè´£ï¼š</p><ul><li>ç®¡ç†æ–‡ä»¶ç³»ç»Ÿå‘½åç©ºé—´</li><li>ç»´æŠ¤æ–‡ä»¶ä¸æ•°æ®å—çš„æ˜ å°„å…³ç³»</li><li>è®°å½•æ•°æ®å—çš„å‰¯æœ¬ä¿¡æ¯</li><li>å¤„ç†å®¢æˆ·ç«¯çš„å…ƒæ•°æ®æ“ä½œè¯·æ±‚</li></ul></li><li><p><strong>DataNode</strong>ï¼šæ•°æ®å­˜å‚¨èŠ‚ç‚¹ï¼Œè´Ÿè´£ï¼š</p><ul><li>å­˜å‚¨å®é™…çš„æ•°æ®å—</li><li>æ‰§è¡Œæ•°æ®å—çš„è¯»å†™æ“ä½œ</li><li>å®šæœŸå‘NameNodeå‘é€å¿ƒè·³å’Œå—æŠ¥å‘Š</li></ul></li><li><p><strong>Secondary NameNode</strong>ï¼šè¾…åŠ©èŠ‚ç‚¹ï¼Œè´Ÿè´£ï¼š</p><ul><li>å®šæœŸåˆå¹¶NameNodeçš„ç¼–è¾‘æ—¥å¿—ï¼ˆEditLogï¼‰å’Œé•œåƒæ–‡ä»¶ï¼ˆFSImageï¼‰</li><li>å‡è½»NameNodeçš„è´Ÿæ‹…ï¼Œä½†ä¸æä¾›æ•…éšœè½¬ç§»èƒ½åŠ›</li></ul></li></ul><h3 id="1-2-æ¶æ„å›¾"><a href="#1-2-æ¶æ„å›¾" class="headerlink" title="1.2 æ¶æ„å›¾"></a>1.2 æ¶æ„å›¾</h3><pre class="mermaid">graph TD    Client[å®¢æˆ·ç«¯] -->|å…ƒæ•°æ®æ“ä½œ| NameNode    Client -->|æ•°æ®è¯»å†™| DataNode1    Client -->|æ•°æ®è¯»å†™| DataNode2    Client -->|æ•°æ®è¯»å†™| DataNode3    NameNode -->|å¿ƒè·³æ£€æµ‹| DataNode1    NameNode -->|å¿ƒè·³æ£€æµ‹| DataNode2    NameNode -->|å¿ƒè·³æ£€æµ‹| DataNode3    SecondaryNameNode -->|åˆå¹¶æ—¥å¿—| NameNode    DataNode1 <-->|å‰¯æœ¬å¤åˆ¶| DataNode2    DataNode2 <-->|å‰¯æœ¬å¤åˆ¶| DataNode3</pre><h2 id="äºŒã€æ–‡ä»¶å­˜å‚¨ç»“æ„"><a href="#äºŒã€æ–‡ä»¶å­˜å‚¨ç»“æ„" class="headerlink" title="äºŒã€æ–‡ä»¶å­˜å‚¨ç»“æ„"></a>äºŒã€æ–‡ä»¶å­˜å‚¨ç»“æ„</h2><h3 id="2-1-æ•°æ®å—ï¼ˆBlockï¼‰"><a href="#2-1-æ•°æ®å—ï¼ˆBlockï¼‰" class="headerlink" title="2.1 æ•°æ®å—ï¼ˆBlockï¼‰"></a>2.1 æ•°æ®å—ï¼ˆBlockï¼‰</h3><ul><li>é»˜è®¤å—å¤§å°ï¼š128MBï¼ˆå¯é€šè¿‡<code>dfs.blocksize</code>é…ç½®ï¼‰</li><li>å¤§æ–‡ä»¶ä¼šè¢«åˆ†å‰²æˆå¤šä¸ªå—ï¼Œå°æ–‡ä»¶ä¸ä¼šå ç”¨æ•´ä¸ªå—ç©ºé—´</li><li>æ¯ä¸ªå—ä¼šå­˜å‚¨å¤šä¸ªå‰¯æœ¬ï¼Œé»˜è®¤3ä¸ªï¼ˆå¯é€šè¿‡<code>dfs.replication</code>é…ç½®ï¼‰</li></ul><h3 id="2-2-å‰¯æœ¬æ”¾ç½®ç­–ç•¥"><a href="#2-2-å‰¯æœ¬æ”¾ç½®ç­–ç•¥" class="headerlink" title="2.2 å‰¯æœ¬æ”¾ç½®ç­–ç•¥"></a>2.2 å‰¯æœ¬æ”¾ç½®ç­–ç•¥</h3><ul><li>ç¬¬ä¸€ä¸ªå‰¯æœ¬ï¼šæ”¾ç½®åœ¨å®¢æˆ·ç«¯æ‰€åœ¨èŠ‚ç‚¹ï¼ˆå¦‚æœå®¢æˆ·ç«¯ä¸åœ¨é›†ç¾¤å†…ï¼Œåˆ™éšæœºé€‰æ‹©ï¼‰</li><li>ç¬¬äºŒä¸ªå‰¯æœ¬ï¼šæ”¾ç½®åœ¨ä¸ç¬¬ä¸€ä¸ªå‰¯æœ¬ä¸åŒçš„æœºæ¶ä¸Š</li><li>ç¬¬ä¸‰ä¸ªå‰¯æœ¬ï¼šæ”¾ç½®åœ¨ä¸ç¬¬äºŒä¸ªå‰¯æœ¬ç›¸åŒæœºæ¶çš„ä¸åŒèŠ‚ç‚¹ä¸Š</li><li>æ›´å¤šå‰¯æœ¬ï¼šéšæœºåˆ†é…</li></ul><h3 id="2-3-å­˜å‚¨ç»“æ„å›¾"><a href="#2-3-å­˜å‚¨ç»“æ„å›¾" class="headerlink" title="2.3 å­˜å‚¨ç»“æ„å›¾"></a>2.3 å­˜å‚¨ç»“æ„å›¾</h3><pre class="mermaid">graph LR    File[å¤§æ–‡ä»¶] --> Block1[æ•°æ®å—1128MB]    File --> Block2[æ•°æ®å—2128MB]    File --> Block3[æ•°æ®å—364MB]    Block1 --> DN1[å‰¯æœ¬1DataNode A]    Block1 --> DN2[å‰¯æœ¬2DataNode Bä¸åŒæœºæ¶]    Block1 --> DN3[å‰¯æœ¬3DataNode CåŒæœºæ¶B]    Block2 --> DN4[å‰¯æœ¬1DataNode B]    Block2 --> DN5[å‰¯æœ¬2DataNode Cä¸åŒæœºæ¶]    Block2 --> DN6[å‰¯æœ¬3DataNode DåŒæœºæ¶C]</pre><h2 id="ä¸‰ã€æ•°æ®æ¨¡å‹"><a href="#ä¸‰ã€æ•°æ®æ¨¡å‹" class="headerlink" title="ä¸‰ã€æ•°æ®æ¨¡å‹"></a>ä¸‰ã€æ•°æ®æ¨¡å‹</h2><h3 id="3-1-å‘½åç©ºé—´"><a href="#3-1-å‘½åç©ºé—´" class="headerlink" title="3.1 å‘½åç©ºé—´"></a>3.1 å‘½åç©ºé—´</h3><ul><li>å±‚æ¬¡åŒ–æ–‡ä»¶ç³»ç»Ÿç»“æ„ï¼Œä¸Linuxæ–‡ä»¶ç³»ç»Ÿç±»ä¼¼</li><li>æ”¯æŒç›®å½•å’Œæ–‡ä»¶çš„åˆ›å»ºã€åˆ é™¤ã€é‡å‘½åç­‰æ“ä½œ</li><li>é€šè¿‡URIæ ‡è¯†æ–‡ä»¶ï¼š<code>hdfs://namenode:port/path/to/file</code></li></ul><h3 id="3-2-å…ƒæ•°æ®"><a href="#3-2-å…ƒæ•°æ®" class="headerlink" title="3.2 å…ƒæ•°æ®"></a>3.2 å…ƒæ•°æ®</h3><ul><li><strong>å†…å­˜å…ƒæ•°æ®</strong>ï¼šNameNodeå†…å­˜ä¸­ç»´æŠ¤çš„æ–‡ä»¶ç³»ç»Ÿæ ‘åŠæ–‡ä»¶&#x2F;ç›®å½•å…ƒæ•°æ®</li><li><strong>æŒä¹…åŒ–å…ƒæ•°æ®</strong>ï¼š<ul><li>FSImageï¼šæ–‡ä»¶ç³»ç»Ÿå…ƒæ•°æ®çš„å¿«ç…§</li><li>EditLogï¼šè®°å½•æ–‡ä»¶ç³»ç»Ÿçš„æ‰€æœ‰ä¿®æ”¹æ“ä½œ</li></ul></li></ul><h3 id="3-3-æ•°æ®æ¨¡å‹ç‰¹ç‚¹"><a href="#3-3-æ•°æ®æ¨¡å‹ç‰¹ç‚¹" class="headerlink" title="3.3 æ•°æ®æ¨¡å‹ç‰¹ç‚¹"></a>3.3 æ•°æ®æ¨¡å‹ç‰¹ç‚¹</h3><ul><li>ä¸€æ¬¡å†™å…¥ï¼Œå¤šæ¬¡è¯»å–ï¼ˆä¸æ”¯æŒéšæœºå†™å…¥ï¼‰</li><li>æ”¯æŒè¿½åŠ å†™å…¥</li><li>æ–‡ä»¶ä¸€æ—¦åˆ›å»ºã€å†™å…¥å¹¶å…³é—­åï¼Œä¸èƒ½ä¿®æ”¹</li></ul><h2 id="å››ã€æ•°æ®å†™å…¥æµç¨‹"><a href="#å››ã€æ•°æ®å†™å…¥æµç¨‹" class="headerlink" title="å››ã€æ•°æ®å†™å…¥æµç¨‹"></a>å››ã€æ•°æ®å†™å…¥æµç¨‹</h2><h3 id="4-1-è¯¦ç»†æ­¥éª¤"><a href="#4-1-è¯¦ç»†æ­¥éª¤" class="headerlink" title="4.1 è¯¦ç»†æ­¥éª¤"></a>4.1 è¯¦ç»†æ­¥éª¤</h3><ol><li><p><strong>å®¢æˆ·ç«¯è¯·æ±‚åˆ›å»ºæ–‡ä»¶</strong></p><ul><li>å®¢æˆ·ç«¯è°ƒç”¨<code>DistributedFileSystem.create()</code>æ–¹æ³•</li><li>NameNodeæ£€æŸ¥æƒé™ã€è·¯å¾„æ˜¯å¦å­˜åœ¨ç­‰</li><li>NameNodeè¿”å›FSDataOutputStreamå¯¹è±¡</li></ul></li><li><p><strong>å®¢æˆ·ç«¯å†™å…¥æ•°æ®</strong></p><ul><li>å®¢æˆ·ç«¯å°†æ•°æ®åˆ†æˆæ•°æ®åŒ…ï¼ˆPacketï¼Œé»˜è®¤64KBï¼‰</li><li>å®¢æˆ·ç«¯åˆ›å»ºDataStreamerå’ŒResponseProcessor</li><li>DataStreamerè´Ÿè´£å°†æ•°æ®åŒ…å‘é€åˆ°DataNode</li></ul></li><li><p><strong>æ„å»ºæ•°æ®ç®¡é“</strong></p><ul><li>NameNodeé€‰æ‹©åˆé€‚çš„DataNodeç»„æˆç®¡é“</li><li>ä¾‹å¦‚ï¼šDataNode1 -&gt; DataNode2 -&gt; DataNode3</li></ul></li><li><p><strong>æ•°æ®ä¼ è¾“</strong></p><ul><li>å®¢æˆ·ç«¯å°†æ•°æ®åŒ…å†™å…¥ç®¡é“çš„ç¬¬ä¸€ä¸ªDataNode</li><li>æ¯ä¸ªDataNodeæ¥æ”¶æ•°æ®åŒ…åå­˜å‚¨ï¼Œå¹¶è½¬å‘ç»™ä¸‹ä¸€ä¸ªDataNode</li><li>æœ€åä¸€ä¸ªDataNodeè¿”å›ç¡®è®¤ä¿¡æ¯</li></ul></li><li><p><strong>å®Œæˆå†™å…¥</strong></p><ul><li>æ‰€æœ‰æ•°æ®å†™å…¥å®Œæˆåï¼Œå®¢æˆ·ç«¯è°ƒç”¨<code>close()</code>æ–¹æ³•</li><li>NameNodeæäº¤æ–‡ä»¶åˆ›å»ºæ“ä½œ</li></ul></li></ol><h3 id="4-2-å†™å…¥æµç¨‹å›¾"><a href="#4-2-å†™å…¥æµç¨‹å›¾" class="headerlink" title="4.2 å†™å…¥æµç¨‹å›¾"></a>4.2 å†™å…¥æµç¨‹å›¾</h3><pre class="mermaid">sequenceDiagram    participant Client    participant NameNode    participant DN1    participant DN2    participant DN3    Client->>NameNode: è¯·æ±‚åˆ›å»ºæ–‡ä»¶    NameNode-->>Client: è¿”å›FSDataOutputStream    Client->>NameNode: è¯·æ±‚æ•°æ®å—å­˜å‚¨ä½ç½®    NameNode-->>Client: è¿”å›DN1, DN2, DN3    Client->>DN1: å»ºç«‹æ•°æ®ç®¡é“(DN1->DN2->DN3)    DN1->>DN2: ç¡®è®¤ç®¡é“    DN2->>DN3: ç¡®è®¤ç®¡é“    DN3-->>DN2: ç®¡é“ç¡®è®¤    DN2-->>DN1: ç®¡é“ç¡®è®¤    DN1-->>Client: ç®¡é“å»ºç«‹å®Œæˆ    loop å†™å…¥æ•°æ®åŒ…        Client->>DN1: å‘é€æ•°æ®åŒ…        DN1->>DN2: è½¬å‘æ•°æ®åŒ…        DN2->>DN3: è½¬å‘æ•°æ®åŒ…        DN3-->>DN2: ACK        DN2-->>DN1: ACK        DN1-->>Client: ACK    end    Client->>NameNode: å®Œæˆå†™å…¥ï¼Œå…³é—­æ–‡ä»¶    NameNode-->>Client: ç¡®è®¤å…³é—­</pre><h2 id="äº”ã€æ•°æ®è¯»å–æµç¨‹"><a href="#äº”ã€æ•°æ®è¯»å–æµç¨‹" class="headerlink" title="äº”ã€æ•°æ®è¯»å–æµç¨‹"></a>äº”ã€æ•°æ®è¯»å–æµç¨‹</h2><h3 id="5-1-è¯¦ç»†æ­¥éª¤"><a href="#5-1-è¯¦ç»†æ­¥éª¤" class="headerlink" title="5.1 è¯¦ç»†æ­¥éª¤"></a>5.1 è¯¦ç»†æ­¥éª¤</h3><ol><li><p><strong>å®¢æˆ·ç«¯è¯·æ±‚è¯»å–æ–‡ä»¶</strong></p><ul><li>å®¢æˆ·ç«¯è°ƒç”¨<code>DistributedFileSystem.open()</code>æ–¹æ³•</li><li>NameNodeè¿”å›æ–‡ä»¶çš„æ•°æ®å—ä¿¡æ¯åŠå¯¹åº”DataNodeä½ç½®</li></ul></li><li><p><strong>é€‰æ‹©æœ€ä¼˜DataNode</strong></p><ul><li>å®¢æˆ·ç«¯æ ¹æ®ç½‘ç»œæ‹“æ‰‘é€‰æ‹©æœ€è¿‘çš„DataNode</li><li>ä¼˜å…ˆè¯»å–æœ¬åœ°èŠ‚ç‚¹æ•°æ®ï¼Œå…¶æ¬¡åŒæœºæ¶èŠ‚ç‚¹ï¼Œæœ€åè·¨æœºæ¶èŠ‚ç‚¹</li></ul></li><li><p><strong>è¯»å–æ•°æ®</strong></p><ul><li>å®¢æˆ·ç«¯åˆ›å»ºFSDataInputStreamå¯¹è±¡</li><li>æŒ‰é¡ºåºè¯»å–æ•°æ®å—</li><li>è‹¥æŸDataNodeæ•…éšœï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°å…¶ä»–å‰¯æœ¬</li></ul></li><li><p><strong>æ•°æ®æ ¡éªŒ</strong></p><ul><li>è¯»å–æ•°æ®æ—¶éªŒè¯æ ¡éªŒå’Œ</li><li>è‹¥æ ¡éªŒå¤±è´¥ï¼Œè¯»å–å…¶ä»–å‰¯æœ¬å¹¶æ ‡è®°åå—</li></ul></li><li><p><strong>ç»„è£…æ–‡ä»¶</strong></p><ul><li>å®¢æˆ·ç«¯å°†è¯»å–çš„æ•°æ®å—ç»„è£…æˆå®Œæ•´æ–‡ä»¶</li></ul></li></ol><h3 id="5-2-è¯»å–æµç¨‹å›¾"><a href="#5-2-è¯»å–æµç¨‹å›¾" class="headerlink" title="5.2 è¯»å–æµç¨‹å›¾"></a>5.2 è¯»å–æµç¨‹å›¾</h3><pre class="mermaid">sequenceDiagram    participant Client    participant NameNode    participant DN1    participant DN2    participant DN3    Client->>NameNode: è¯·æ±‚è¯»å–æ–‡ä»¶å…ƒæ•°æ®    NameNode-->>Client: è¿”å›æ•°æ®å—åŠå‰¯æœ¬ä½ç½®    Client->>DN1: è¯·æ±‚è¯»å–æ•°æ®å—1(æœ€è¿‘èŠ‚ç‚¹)    DN1-->>Client: è¿”å›æ•°æ®å—1    Client->>DN2: è¯·æ±‚è¯»å–æ•°æ®å—2(æœ€è¿‘èŠ‚ç‚¹)    DN2-->>Client: è¿”å›æ•°æ®å—2    alt æ•°æ®å—3è¯»å–å¤±è´¥        Client->>DN3: è¯·æ±‚è¯»å–æ•°æ®å—3        DN3-->>Client: è¿”å›æ•°æ®å—3    end    Client->>Client: ç»„è£…æ•°æ®å—ä¸ºå®Œæ•´æ–‡ä»¶</pre><h2 id="å…­ã€æ•°æ®é˜²ä¸¢å¤±æœºåˆ¶"><a href="#å…­ã€æ•°æ®é˜²ä¸¢å¤±æœºåˆ¶" class="headerlink" title="å…­ã€æ•°æ®é˜²ä¸¢å¤±æœºåˆ¶"></a>å…­ã€æ•°æ®é˜²ä¸¢å¤±æœºåˆ¶</h2><h3 id="6-1-å‰¯æœ¬æœºåˆ¶"><a href="#6-1-å‰¯æœ¬æœºåˆ¶" class="headerlink" title="6.1 å‰¯æœ¬æœºåˆ¶"></a>6.1 å‰¯æœ¬æœºåˆ¶</h3><ul><li>é»˜è®¤3å‰¯æœ¬ç­–ç•¥ï¼Œç¡®ä¿æ•°æ®å†—ä½™</li><li>å¯é’ˆå¯¹é‡è¦æ–‡ä»¶è®¾ç½®æ›´é«˜çš„å‰¯æœ¬æ•°</li><li>å‰¯æœ¬åˆ†å¸ƒåœ¨ä¸åŒæœºæ¶ï¼Œæé«˜å®¹é”™æ€§</li></ul><h3 id="6-2-å¿ƒè·³æ£€æµ‹"><a href="#6-2-å¿ƒè·³æ£€æµ‹" class="headerlink" title="6.2 å¿ƒè·³æ£€æµ‹"></a>6.2 å¿ƒè·³æ£€æµ‹</h3><ul><li>DataNodeæ¯3ç§’å‘NameNodeå‘é€å¿ƒè·³</li><li>NameNodeè‹¥10åˆ†é’Ÿæœªæ”¶åˆ°å¿ƒè·³ï¼Œæ ‡è®°DataNodeä¸ºæ­»äº¡</li><li>è‡ªåŠ¨å¤åˆ¶æ­»äº¡èŠ‚ç‚¹ä¸Šçš„æ•°æ®å—åˆ°å…¶ä»–èŠ‚ç‚¹</li></ul><h3 id="6-3-æ•°æ®å®Œæ•´æ€§æ ¡éªŒ"><a href="#6-3-æ•°æ®å®Œæ•´æ€§æ ¡éªŒ" class="headerlink" title="6.3 æ•°æ®å®Œæ•´æ€§æ ¡éªŒ"></a>6.3 æ•°æ®å®Œæ•´æ€§æ ¡éªŒ</h3><ul><li>æ¯ä¸ªæ•°æ®å—éƒ½æœ‰å¯¹åº”çš„æ ¡éªŒå’Œï¼ˆChecksumï¼‰</li><li>å†™å…¥æ—¶è®¡ç®—æ ¡éªŒå’Œå¹¶å­˜å‚¨</li><li>è¯»å–æ—¶é‡æ–°è®¡ç®—å¹¶æ¯”å¯¹æ ¡éªŒå’Œ</li><li>æ ¡éªŒå¤±è´¥æ—¶è¯»å–å…¶ä»–å‰¯æœ¬ï¼Œå¹¶æ ‡è®°åå—</li></ul><h3 id="6-4-å®‰å…¨æ¨¡å¼"><a href="#6-4-å®‰å…¨æ¨¡å¼" class="headerlink" title="6.4 å®‰å…¨æ¨¡å¼"></a>6.4 å®‰å…¨æ¨¡å¼</h3><ul><li>å¯åŠ¨æ—¶è‡ªåŠ¨è¿›å…¥å®‰å…¨æ¨¡å¼</li><li>NameNodeæ¥æ”¶æ‰€æœ‰DataNodeçš„å—æŠ¥å‘Š</li><li>å½“æœ€å°å‰¯æœ¬æ¡ä»¶æ»¡è¶³æ—¶ï¼Œè‡ªåŠ¨é€€å‡ºå®‰å…¨æ¨¡å¼</li><li>å¯æ‰‹åŠ¨è¿›å…¥æˆ–é€€å‡ºå®‰å…¨æ¨¡å¼</li></ul><h3 id="6-5-å…ƒæ•°æ®å¤‡ä»½"><a href="#6-5-å…ƒæ•°æ®å¤‡ä»½" class="headerlink" title="6.5 å…ƒæ•°æ®å¤‡ä»½"></a>6.5 å…ƒæ•°æ®å¤‡ä»½</h3><ul><li>FSImageå’ŒEditLogå®šæœŸå¤‡ä»½</li><li>æ”¯æŒé…ç½®å¤šä¸ªå…ƒæ•°æ®å­˜å‚¨ç›®å½•</li><li>å¯é…ç½®è‡ªåŠ¨å¤‡ä»½åˆ°è¿œç¨‹å­˜å‚¨</li></ul><h2 id="ä¸ƒã€ç£ç›˜æŸååº”å¯¹æªæ–½"><a href="#ä¸ƒã€ç£ç›˜æŸååº”å¯¹æªæ–½" class="headerlink" title="ä¸ƒã€ç£ç›˜æŸååº”å¯¹æªæ–½"></a>ä¸ƒã€ç£ç›˜æŸååº”å¯¹æªæ–½</h2><h3 id="7-1-åå—æ£€æµ‹ä¸å¤„ç†"><a href="#7-1-åå—æ£€æµ‹ä¸å¤„ç†" class="headerlink" title="7.1 åå—æ£€æµ‹ä¸å¤„ç†"></a>7.1 åå—æ£€æµ‹ä¸å¤„ç†</h3><ul><li>DataNodeå®šæœŸæ‰«æç£ç›˜ä¸Šçš„æ•°æ®å—</li><li>å‘ç°åå—åå‘NameNodeæŠ¥å‘Š</li><li>NameNodeå®‰æ’ä»å…¶ä»–å‰¯æœ¬å¤åˆ¶æ•°æ®</li><li>è¾¾åˆ°æœ€å°å‰¯æœ¬æ•°åï¼Œæ ‡è®°åå—ä¸ºå¯åˆ é™¤</li></ul><h3 id="7-2-æ•°æ®å‡è¡¡"><a href="#7-2-æ•°æ®å‡è¡¡" class="headerlink" title="7.2 æ•°æ®å‡è¡¡"></a>7.2 æ•°æ®å‡è¡¡</h3><ul><li>HDFS Balancerå·¥å…·è‡ªåŠ¨å¹³è¡¡é›†ç¾¤æ•°æ®åˆ†å¸ƒ</li><li>é¿å…ä¸ªåˆ«èŠ‚ç‚¹å­˜å‚¨å‹åŠ›è¿‡å¤§</li><li>å¯æ‰‹åŠ¨è§¦å‘æˆ–é…ç½®å®šæœŸæ‰§è¡Œ</li></ul><h3 id="7-3-èŠ‚ç‚¹é€€å½¹"><a href="#7-3-èŠ‚ç‚¹é€€å½¹" class="headerlink" title="7.3 èŠ‚ç‚¹é€€å½¹"></a>7.3 èŠ‚ç‚¹é€€å½¹</h3><ul><li>æ”¯æŒDataNodeå¹³æ»‘é€€å½¹</li><li>ç®¡ç†å‘˜å¯å°†èŠ‚ç‚¹åŠ å…¥é€€å½¹åˆ—è¡¨</li><li>NameNodeè‡ªåŠ¨è¿ç§»æ•°æ®åˆ°å…¶ä»–èŠ‚ç‚¹</li><li>æ•°æ®è¿ç§»å®Œæˆåï¼ŒèŠ‚ç‚¹å¯å®‰å…¨ä¸‹çº¿</li></ul><h3 id="7-4-ç¾éš¾æ¢å¤"><a href="#7-4-ç¾éš¾æ¢å¤" class="headerlink" title="7.4 ç¾éš¾æ¢å¤"></a>7.4 ç¾éš¾æ¢å¤</h3><ul><li>åˆ©ç”¨Secondary NameNodeçš„å…ƒæ•°æ®å¤‡ä»½</li><li>é…ç½®NameNodeé«˜å¯ç”¨ï¼ˆHAï¼‰</li><li>ä½¿ç”¨QJMï¼ˆQuorum Journal Managerï¼‰å…±äº«ç¼–è¾‘æ—¥å¿—</li><li>é…ç½®è‡ªåŠ¨æ•…éšœè½¬ç§»</li></ul><h2 id="å…«ã€HDFSé«˜çº§ç‰¹æ€§ä¸ä¼˜åŒ–"><a href="#å…«ã€HDFSé«˜çº§ç‰¹æ€§ä¸ä¼˜åŒ–" class="headerlink" title="å…«ã€HDFSé«˜çº§ç‰¹æ€§ä¸ä¼˜åŒ–"></a>å…«ã€HDFSé«˜çº§ç‰¹æ€§ä¸ä¼˜åŒ–</h2><h3 id="8-1-HDFSè”é‚¦ï¼ˆFederationï¼‰"><a href="#8-1-HDFSè”é‚¦ï¼ˆFederationï¼‰" class="headerlink" title="8.1 HDFSè”é‚¦ï¼ˆFederationï¼‰"></a>8.1 HDFSè”é‚¦ï¼ˆFederationï¼‰</h3><p>HDFSè”é‚¦é€šè¿‡å¼•å…¥å¤šä¸ªç‹¬ç«‹çš„NameNode&#x2F;Namespaceè§£å†³äº†å•NameNodeçš„æ‰©å±•æ€§ç“¶é¢ˆï¼Œæ¯ä¸ªNameNodeç®¡ç†æ–‡ä»¶ç³»ç»Ÿå‘½åç©ºé—´çš„ä¸€éƒ¨åˆ†ï¼Œå½¼æ­¤ç‹¬ç«‹ä¸”ä¸å…±äº«çŠ¶æ€ã€‚</p><h4 id="æ ¸å¿ƒç»„ä»¶"><a href="#æ ¸å¿ƒç»„ä»¶" class="headerlink" title="æ ¸å¿ƒç»„ä»¶"></a>æ ¸å¿ƒç»„ä»¶</h4><ul><li><strong>NameNode&#x2F;Namespace</strong>ï¼šå¤šä¸ªç‹¬ç«‹çš„å‘½åç©ºé—´ï¼Œæ¯ä¸ªç®¡ç†ä¸€éƒ¨åˆ†æ–‡ä»¶ç³»ç»Ÿ</li><li><strong>Block Pool</strong>ï¼šæ¯ä¸ªå‘½åç©ºé—´å…³è”ä¸€ç»„æ•°æ®å—æ± ï¼ŒåŒ…å«è¯¥å‘½åç©ºé—´ä¸‹æ–‡ä»¶çš„æ‰€æœ‰æ•°æ®å—</li><li><strong>ClusterID</strong>ï¼šæ ‡è¯†æ•´ä¸ªé›†ç¾¤çš„å”¯ä¸€IDï¼Œæ‰€æœ‰NameNodeå…±äº«æ­¤ID</li></ul><h4 id="æ¶æ„ä¼˜åŠ¿"><a href="#æ¶æ„ä¼˜åŠ¿" class="headerlink" title="æ¶æ„ä¼˜åŠ¿"></a>æ¶æ„ä¼˜åŠ¿</h4><ul><li>å‘½åç©ºé—´æ°´å¹³æ‰©å±•ï¼Œæ”¯æŒæ›´å¤šæ–‡ä»¶å’Œæ›´å¤§å­˜å‚¨å®¹é‡</li><li>æ€§èƒ½éš”ç¦»ï¼Œä¸åŒä¸šåŠ¡å¯ä½¿ç”¨ä¸åŒå‘½åç©ºé—´</li><li>æ•…éšœéš”ç¦»ï¼Œå•ä¸ªNameNodeæ•…éšœä¸å½±å“å…¶ä»–å‘½åç©ºé—´</li><li>å¯ç‹¬ç«‹å‡çº§å„ä¸ªNameNode</li></ul><pre class="mermaid">graph TD    Client[å®¢æˆ·ç«¯] -->|æŒ‚è½½è¡¨| NS1[å‘½åç©ºé—´1NameNode A]    Client -->|æŒ‚è½½è¡¨| NS2[å‘½åç©ºé—´2NameNode B]    Client -->|æŒ‚è½½è¡¨| NS3[å‘½åç©ºé—´3NameNode C]    NS1 --> BP1[å—æ± 1DataNodeé›†ç¾¤]    NS2 --> BP2[å—æ± 2DataNodeé›†ç¾¤]    NS3 --> BP3[å—æ± 3DataNodeé›†ç¾¤]    BP1 & BP2 & BP3 --> CommonDataNodes[å…±äº«DataNodeå­˜å‚¨]</pre><h3 id="8-2-HDFSé«˜å¯ç”¨ï¼ˆHAï¼‰å®ç°"><a href="#8-2-HDFSé«˜å¯ç”¨ï¼ˆHAï¼‰å®ç°" class="headerlink" title="8.2 HDFSé«˜å¯ç”¨ï¼ˆHAï¼‰å®ç°"></a>8.2 HDFSé«˜å¯ç”¨ï¼ˆHAï¼‰å®ç°</h3><p>HDFS HAé€šè¿‡ä¸»å¤‡NameNodeæœºåˆ¶è§£å†³å•ç‚¹æ•…éšœé—®é¢˜ï¼Œé¿å…äº†Secondary NameNodeæ— æ³•æä¾›æ•…éšœè½¬ç§»çš„å±€é™ã€‚</p><h4 id="æ ¸å¿ƒç»„ä»¶-1"><a href="#æ ¸å¿ƒç»„ä»¶-1" class="headerlink" title="æ ¸å¿ƒç»„ä»¶"></a>æ ¸å¿ƒç»„ä»¶</h4><ul><li><strong>Active NameNode</strong>ï¼šå¤„ç†æ‰€æœ‰å®¢æˆ·ç«¯è¯·æ±‚</li><li><strong>Standby NameNode</strong>ï¼šåŒæ­¥Activeçš„å…ƒæ•°æ®ï¼Œéšæ—¶å‡†å¤‡æ¥ç®¡</li><li><strong>JournalNodes</strong>ï¼šé›†ç¾¤ï¼ˆé€šå¸¸3-5ä¸ªèŠ‚ç‚¹ï¼‰ï¼Œå­˜å‚¨EditLogçš„å…±äº«å­˜å‚¨</li><li><strong>ZKFC</strong>ï¼šZooKeeperæ•…éšœæ£€æµ‹å™¨ï¼Œç›‘æ§NameNodeå¥åº·çŠ¶æ€</li></ul><h4 id="æ•…éšœè½¬ç§»æµç¨‹"><a href="#æ•…éšœè½¬ç§»æµç¨‹" class="headerlink" title="æ•…éšœè½¬ç§»æµç¨‹"></a>æ•…éšœè½¬ç§»æµç¨‹</h4><ol><li>ZKFCå®šæœŸå‘NameNodeå‘é€å¥åº·æ£€æŸ¥</li><li>ActiveèŠ‚ç‚¹æ•…éšœæ—¶ï¼ŒZKFCé‡Šæ”¾ZooKeeperé”</li><li>StandbyèŠ‚ç‚¹çš„ZKFCè·å–é”ï¼Œé€šè¿‡ fencing æœºåˆ¶ç¡®ä¿ActiveèŠ‚ç‚¹å®Œå…¨ä¸‹çº¿</li><li>StandbyèŠ‚ç‚¹å‡çº§ä¸ºActiveï¼Œå¼€å§‹å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚</li></ol><pre class="mermaid">graph TD    Client[å®¢æˆ·ç«¯] -->|è‡ªåŠ¨è·¯ç”±| AN[Active NameNode]    Client -->|æ•…éšœæ—¶åˆ‡æ¢| SN[Standby NameNode]    AN -->|å†™å…¥EditLog| JN[JournalNodesé›†ç¾¤(>=3èŠ‚ç‚¹)]    SN -->|è¯»å–EditLog| JN    AN --> ZKFC1[ZKFC]    SN --> ZKFC2[ZKFC]    ZKFC1 & ZKFC2 --> ZK[ZooKeeperé€‰ä¸¾ä¸å¥åº·ç›‘æ§]    AN -->|éš”ç¦»æœºåˆ¶| Fencing[Fencingé˜²æ­¢è„‘è£‚]    SN -->|æ¥ç®¡æœåŠ¡| Fencing</pre><h3 id="8-3-çº åˆ ç ï¼ˆErasure-Codingï¼‰"><a href="#8-3-çº åˆ ç ï¼ˆErasure-Codingï¼‰" class="headerlink" title="8.3 çº åˆ ç ï¼ˆErasure Codingï¼‰"></a>8.3 çº åˆ ç ï¼ˆErasure Codingï¼‰</h3><p>Hadoop 3.0å¼•å…¥çº åˆ ç æœºåˆ¶ï¼Œåœ¨æä¾›åŒç­‰å®¹é”™èƒ½åŠ›çš„åŒæ—¶å¤§å¹…é™ä½å­˜å‚¨å¼€é”€ï¼Œé€‚ç”¨äºå†·æ•°æ®å­˜å‚¨ã€‚</p><h4 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h4><ul><li>ä½¿ç”¨Reed-Solomonç ï¼šå°†nä¸ªæ•°æ®å—ç¼–ç ä¸ºmä¸ªæ ¡éªŒå—ï¼Œä»»æ„nä¸ªå—å¯æ¢å¤åŸå§‹æ•°æ®</li><li>é»˜è®¤é…ç½®(6,3)ï¼š6ä¸ªæ•°æ®å—+3ä¸ªæ ¡éªŒå—ï¼Œç›¸æ¯”3å‰¯æœ¬èŠ‚çœ50%å­˜å‚¨ç©ºé—´</li><li>æ”¯æŒæŒ‰ç›®å½•é…ç½®ï¼šé€šè¿‡<code>dfs.namenode.ec.system.default.policy</code>è®¾ç½®é»˜è®¤ç­–ç•¥</li></ul><h4 id="ä¼˜ç¼ºç‚¹å¯¹æ¯”"><a href="#ä¼˜ç¼ºç‚¹å¯¹æ¯”" class="headerlink" title="ä¼˜ç¼ºç‚¹å¯¹æ¯”"></a>ä¼˜ç¼ºç‚¹å¯¹æ¯”</h4><table><thead><tr><th>ç‰¹æ€§</th><th>çº åˆ ç (6,3)</th><th>3å‰¯æœ¬æœºåˆ¶</th></tr></thead><tbody><tr><td>å­˜å‚¨å¼€é”€</td><td>150%</td><td>200%</td></tr><tr><td>å®¹é”™èƒ½åŠ›</td><td>æœ€å¤š3ä¸ªå—ä¸¢å¤±</td><td>æœ€å¤š2ä¸ªå‰¯æœ¬ä¸¢å¤±</td></tr><tr><td>è¯»å†™æ€§èƒ½</td><td>å†™æ€§èƒ½è¾ƒä½ï¼Œè¯»æ€§èƒ½æ¥è¿‘</td><td>è¯»å†™æ€§èƒ½å‡è¡¡</td></tr><tr><td>é€‚ç”¨åœºæ™¯</td><td>å†·æ•°æ®ã€å½’æ¡£æ•°æ®</td><td>çƒ­æ•°æ®ã€é¢‘ç¹è®¿é—®æ•°æ®</td></tr></tbody></table><h3 id="8-4-HDFSç¼“å­˜æœºåˆ¶"><a href="#8-4-HDFSç¼“å­˜æœºåˆ¶" class="headerlink" title="8.4 HDFSç¼“å­˜æœºåˆ¶"></a>8.4 HDFSç¼“å­˜æœºåˆ¶</h3><p>HDFSæä¾›é›†ä¸­å¼ç¼“å­˜ç®¡ç†ï¼Œå…è®¸å°†é¢‘ç¹è®¿é—®çš„æ•°æ®å—ç¼“å­˜åœ¨æŒ‡å®šDataNodeçš„å†…å­˜ä¸­ï¼Œæé«˜è¯»å–æ€§èƒ½ã€‚</p><h4 id="æ ¸å¿ƒæ¦‚å¿µ"><a href="#æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="æ ¸å¿ƒæ¦‚å¿µ"></a>æ ¸å¿ƒæ¦‚å¿µ</h4><ul><li><strong>ç¼“å­˜æ± ï¼ˆCache Poolï¼‰</strong>ï¼šç®¡ç†å‘˜åˆ›å»ºçš„èµ„æºåˆ†é…å•å…ƒï¼ŒåŒ…å«ç¼“å­˜ç©ºé—´é…é¢å’Œæƒé™æ§åˆ¶</li><li><strong>ç¼“å­˜æŒ‡ä»¤ï¼ˆCache Directiveï¼‰</strong>ï¼šæŒ‡å®šè¦ç¼“å­˜çš„è·¯å¾„å’Œç¼“å­˜å‰¯æœ¬æ•°</li><li><strong>ç¼“å­˜å—ï¼ˆCached Blockï¼‰</strong>ï¼šè¢«ç¼“å­˜çš„æ•°æ®å—ï¼Œä¿ç•™åœ¨DataNodeå†…å­˜ä¸­</li></ul><h4 id="å·¥ä½œæµç¨‹"><a href="#å·¥ä½œæµç¨‹" class="headerlink" title="å·¥ä½œæµç¨‹"></a>å·¥ä½œæµç¨‹</h4><ol><li>ç®¡ç†å‘˜åˆ›å»ºç¼“å­˜æ± å¹¶åˆ†é…èµ„æº</li><li>ç”¨æˆ·æäº¤ç¼“å­˜æŒ‡ä»¤æŒ‡å®šè¦ç¼“å­˜çš„æ–‡ä»¶&#x2F;ç›®å½•</li><li>NameNodeé€‰æ‹©åˆé€‚çš„DataNodeç¼“å­˜æ•°æ®å—</li><li>DataNodeå°†æ•°æ®å—åŠ è½½åˆ°å†…å­˜å¹¶å‘NameNodeç¡®è®¤</li><li>å®¢æˆ·ç«¯è¯»å–æ—¶ä¼˜å…ˆé€‰æ‹©ç¼“å­˜å‰¯æœ¬</li></ol><h3 id="8-5-HDFSå®‰å…¨æœºåˆ¶"><a href="#8-5-HDFSå®‰å…¨æœºåˆ¶" class="headerlink" title="8.5 HDFSå®‰å…¨æœºåˆ¶"></a>8.5 HDFSå®‰å…¨æœºåˆ¶</h3><h4 id="8-5-1-èº«ä»½è®¤è¯"><a href="#8-5-1-èº«ä»½è®¤è¯" class="headerlink" title="8.5.1 èº«ä»½è®¤è¯"></a>8.5.1 èº«ä»½è®¤è¯</h4><ul><li><strong>Kerberosè®¤è¯</strong>ï¼šHDFSé»˜è®¤çš„å¼ºè®¤è¯æœºåˆ¶ï¼Œé€šè¿‡ç¥¨æ®éªŒè¯ç”¨æˆ·èº«ä»½</li><li><strong>ç®€å•è®¤è¯</strong>ï¼šé€‚ç”¨äºæµ‹è¯•ç¯å¢ƒï¼ŒåŸºäºä¸»æœºåæˆ–ç”¨æˆ·åçš„ä¿¡ä»»æœºåˆ¶</li><li><strong>Delegation Tokens</strong>ï¼šå…è®¸åº”ç”¨ç¨‹åºä»£è¡¨ç”¨æˆ·è®¿é—®HDFSï¼Œé¿å…é‡å¤è®¤è¯</li></ul><h4 id="8-5-2-æˆæƒæ§åˆ¶"><a href="#8-5-2-æˆæƒæ§åˆ¶" class="headerlink" title="8.5.2 æˆæƒæ§åˆ¶"></a>8.5.2 æˆæƒæ§åˆ¶</h4><ul><li><strong>POSIXé£æ ¼æƒé™</strong>ï¼šåŸºäºç”¨æˆ·ã€ç»„å’Œå…¶ä»–ç”¨æˆ·çš„è¯»&#x2F;å†™&#x2F;æ‰§è¡Œæƒé™</li><li><strong>ACLï¼ˆè®¿é—®æ§åˆ¶åˆ—è¡¨ï¼‰</strong>ï¼šæ›´ç»†ç²’åº¦çš„æƒé™æ§åˆ¶ï¼Œæ”¯æŒä¸ºç‰¹å®šç”¨æˆ·&#x2F;ç»„è®¾ç½®æƒé™</li><li><strong>NameNodeæƒé™æ£€æŸ¥</strong>ï¼šæ‰€æœ‰å…ƒæ•°æ®æ“ä½œéœ€é€šè¿‡æƒé™éªŒè¯</li><li><strong>DataNodeæƒé™æ£€æŸ¥</strong>ï¼šæ•°æ®å—è®¿é—®éœ€éªŒè¯å—æ‰€æœ‰æƒ</li></ul><h4 id="8-5-3-æ•°æ®ä¿æŠ¤"><a href="#8-5-3-æ•°æ®ä¿æŠ¤" class="headerlink" title="8.5.3 æ•°æ®ä¿æŠ¤"></a>8.5.3 æ•°æ®ä¿æŠ¤</h4><ul><li><strong>ä¼ è¾“åŠ å¯†</strong>ï¼šä½¿ç”¨SSL&#x2F;TLSåŠ å¯†èŠ‚ç‚¹é—´æ•°æ®ä¼ è¾“</li><li><strong>å­˜å‚¨åŠ å¯†</strong>ï¼šé€æ˜æ•°æ®åŠ å¯†ï¼ˆTDEï¼‰ä¿æŠ¤ç£ç›˜ä¸Šçš„æ•°æ®</li><li><strong>æ•°æ®è„±æ•</strong>ï¼šé€šè¿‡HDFSåŠ å¯†åŒºï¼ˆEncryption Zonesï¼‰å®ç°æ•æ„Ÿæ•°æ®éš”ç¦»</li></ul><h2 id="ä¹ã€HDFSæ€§èƒ½ä¼˜åŒ–"><a href="#ä¹ã€HDFSæ€§èƒ½ä¼˜åŒ–" class="headerlink" title="ä¹ã€HDFSæ€§èƒ½ä¼˜åŒ–"></a>ä¹ã€HDFSæ€§èƒ½ä¼˜åŒ–</h2><h3 id="9-1-å…³é”®é…ç½®ä¼˜åŒ–"><a href="#9-1-å…³é”®é…ç½®ä¼˜åŒ–" class="headerlink" title="9.1 å…³é”®é…ç½®ä¼˜åŒ–"></a>9.1 å…³é”®é…ç½®ä¼˜åŒ–</h3><h4 id="NameNodeä¼˜åŒ–"><a href="#NameNodeä¼˜åŒ–" class="headerlink" title="NameNodeä¼˜åŒ–"></a>NameNodeä¼˜åŒ–</h4><ul><li><code>dfs.namenode.handler.count</code>ï¼šå¤„ç†RPCè¯·æ±‚çš„çº¿ç¨‹æ•°ï¼Œå»ºè®®è®¾ç½®ä¸ºé›†ç¾¤è§„æ¨¡çš„2-4å€</li><li><code>dfs.namenode.fs-limits.max-directory-items</code>ï¼šå•ä¸ªç›®å½•æœ€å¤§æ–‡ä»¶æ•°ï¼Œé»˜è®¤1048576</li><li><code>dfs.namenode.name.dir</code>ï¼šé…ç½®å¤šä¸ªå­˜å‚¨ç›®å½•ï¼ˆæœ€å¥½åŒ…å«SSDï¼‰æé«˜å…ƒæ•°æ®å¯é æ€§</li></ul><h4 id="DataNodeä¼˜åŒ–"><a href="#DataNodeä¼˜åŒ–" class="headerlink" title="DataNodeä¼˜åŒ–"></a>DataNodeä¼˜åŒ–</h4><ul><li><code>dfs.datanode.handler.count</code>ï¼šDataNodeå¤„ç†RPCçš„çº¿ç¨‹æ•°ï¼Œå»ºè®®10-20</li><li><code>dfs.datanode.max.transfer.threads</code>ï¼šæ•°æ®ä¼ è¾“çº¿ç¨‹æ•°ï¼Œå»ºè®®4096</li><li><code>dfs.datanode.balance.bandwidthPerSec</code>ï¼šå¹³è¡¡æ•°æ®æ—¶çš„å¸¦å®½é™åˆ¶ï¼Œé»˜è®¤1048576ï¼ˆ1MB&#x2F;sï¼‰</li></ul><h4 id="å®¢æˆ·ç«¯ä¼˜åŒ–"><a href="#å®¢æˆ·ç«¯ä¼˜åŒ–" class="headerlink" title="å®¢æˆ·ç«¯ä¼˜åŒ–"></a>å®¢æˆ·ç«¯ä¼˜åŒ–</h4><ul><li><code>dfs.client.read.shortcircuit</code>ï¼šå¯ç”¨çŸ­è·¯è¯»å–ï¼Œç»•è¿‡DataNodeç›´æ¥è¯»å–æœ¬åœ°æ•°æ®</li><li><code>dfs.client.block.write.replace-datanode-on-failure.policy</code>ï¼šå†™å…¥å¤±è´¥æ—¶æ›¿æ¢DataNodeç­–ç•¥</li><li><code>io.file.buffer.size</code>ï¼šæ–‡ä»¶ç¼“å†²åŒºå¤§å°ï¼Œå»ºè®®64KB-128KB</li></ul><h3 id="9-2-å—å¤§å°ä¸å‰¯æœ¬ç­–ç•¥ä¼˜åŒ–"><a href="#9-2-å—å¤§å°ä¸å‰¯æœ¬ç­–ç•¥ä¼˜åŒ–" class="headerlink" title="9.2 å—å¤§å°ä¸å‰¯æœ¬ç­–ç•¥ä¼˜åŒ–"></a>9.2 å—å¤§å°ä¸å‰¯æœ¬ç­–ç•¥ä¼˜åŒ–</h3><h4 id="å—å¤§å°é€‰æ‹©"><a href="#å—å¤§å°é€‰æ‹©" class="headerlink" title="å—å¤§å°é€‰æ‹©"></a>å—å¤§å°é€‰æ‹©</h4><ul><li>å¤§æ–‡ä»¶ï¼ˆå¦‚æ—¥å¿—ã€è§†é¢‘ï¼‰ï¼š256MB-512MBï¼Œå‡å°‘å—æ•°é‡å’Œå…ƒæ•°æ®å¼€é”€</li><li>å°æ–‡ä»¶ï¼ˆå¦‚æ–‡æ¡£ã€å›¾ç‰‡ï¼‰ï¼š64MBï¼Œæé«˜å¹¶è¡Œå¤„ç†æ•ˆç‡</li><li>è®¡ç®—å¯†é›†å‹ä½œä¸šï¼šè¾ƒå°å—å¤§å°ï¼Œå¢åŠ å¹¶è¡Œåº¦</li><li>IOå¯†é›†å‹ä½œä¸šï¼šè¾ƒå¤§å—å¤§å°ï¼Œå‡å°‘å¯»å€å¼€é”€</li></ul><h4 id="å‰¯æœ¬ç­–ç•¥è°ƒæ•´"><a href="#å‰¯æœ¬ç­–ç•¥è°ƒæ•´" class="headerlink" title="å‰¯æœ¬ç­–ç•¥è°ƒæ•´"></a>å‰¯æœ¬ç­–ç•¥è°ƒæ•´</h4><ul><li>çƒ­æ•°æ®ï¼š3-5ä¸ªå‰¯æœ¬ï¼Œæé«˜å¯ç”¨æ€§</li><li>æ¸©æ•°æ®ï¼š2-3ä¸ªå‰¯æœ¬ï¼Œå¹³è¡¡å¯ç”¨æ€§å’Œå­˜å‚¨æˆæœ¬</li><li>å†·æ•°æ®ï¼š1ä¸ªå‰¯æœ¬+çº åˆ ç ï¼Œé™ä½å­˜å‚¨æˆæœ¬</li><li>æœ¬åœ°æ€§ä¼˜åŒ–ï¼šæ ¹æ®è®¡ç®—èŠ‚ç‚¹ä½ç½®è°ƒæ•´å‰¯æœ¬åˆ†å¸ƒ</li></ul><h3 id="9-3-å°æ–‡ä»¶é—®é¢˜è§£å†³æ–¹æ¡ˆ"><a href="#9-3-å°æ–‡ä»¶é—®é¢˜è§£å†³æ–¹æ¡ˆ" class="headerlink" title="9.3 å°æ–‡ä»¶é—®é¢˜è§£å†³æ–¹æ¡ˆ"></a>9.3 å°æ–‡ä»¶é—®é¢˜è§£å†³æ–¹æ¡ˆ</h3><p>HDFSå¯¹å¤§é‡å°æ–‡ä»¶å¤„ç†æ•ˆç‡ä½ä¸‹ï¼Œå¯é€šè¿‡ä»¥ä¸‹æ–¹æ¡ˆä¼˜åŒ–ï¼š</p><h4 id="åˆå¹¶å°æ–‡ä»¶"><a href="#åˆå¹¶å°æ–‡ä»¶" class="headerlink" title="åˆå¹¶å°æ–‡ä»¶"></a>åˆå¹¶å°æ–‡ä»¶</h4><ul><li>ä½¿ç”¨Hadoop Archiveï¼ˆHARï¼‰å°†å¤šä¸ªå°æ–‡ä»¶æ‰“åŒ…æˆä¸€ä¸ªå½’æ¡£æ–‡ä»¶</li><li>åº”ç”¨å±‚é¢„å¤„ç†ï¼Œåˆå¹¶å°æ–‡ä»¶åå†™å…¥HDFS</li></ul><h4 id="è”é‚¦ä¸å‘½åç©ºé—´éš”ç¦»"><a href="#è”é‚¦ä¸å‘½åç©ºé—´éš”ç¦»" class="headerlink" title="è”é‚¦ä¸å‘½åç©ºé—´éš”ç¦»"></a>è”é‚¦ä¸å‘½åç©ºé—´éš”ç¦»</h4><ul><li>å°†ä¸åŒç±»å‹å°æ–‡ä»¶åˆ†å¸ƒåˆ°ä¸åŒå‘½åç©ºé—´</li><li>å‡è½»å•ä¸ªNameNodeçš„å†…å­˜å‹åŠ›</li></ul><h4 id="ç¼“å­˜å°æ–‡ä»¶å…ƒæ•°æ®"><a href="#ç¼“å­˜å°æ–‡ä»¶å…ƒæ•°æ®" class="headerlink" title="ç¼“å­˜å°æ–‡ä»¶å…ƒæ•°æ®"></a>ç¼“å­˜å°æ–‡ä»¶å…ƒæ•°æ®</h4><ul><li>é…ç½®<code>dfs.namenode.metacache.size</code>å¢åŠ å…ƒæ•°æ®ç¼“å­˜</li><li>å‡å°‘NameNodeç£ç›˜IO</li></ul><h2 id="åã€æ€»ç»“"><a href="#åã€æ€»ç»“" class="headerlink" title="åã€æ€»ç»“"></a>åã€æ€»ç»“</h2><p>HDFSé€šè¿‡ç²¾å¿ƒè®¾è®¡çš„åˆ†å¸ƒå¼æ¶æ„ã€å‰¯æœ¬æœºåˆ¶å’Œæ•°æ®æ ¡éªŒç­‰æŠ€æœ¯ï¼Œåœ¨å¤§è§„æ¨¡é›†ç¾¤ç¯å¢ƒä¸‹æä¾›äº†é«˜ååé‡å’Œé«˜å¯é æ€§çš„æ•°æ®å­˜å‚¨æœåŠ¡ã€‚å…¶æ ¸å¿ƒè®¾è®¡æ€æƒ³æ˜¯é€šè¿‡ç‰ºç‰²éƒ¨åˆ†ç¡¬ä»¶æˆæœ¬å’Œå»¶è¿Ÿï¼Œæ¢å–ç³»ç»Ÿçš„å¯æ‰©å±•æ€§å’Œå®¹é”™æ€§ï¼Œéå¸¸é€‚åˆå­˜å‚¨æµ·é‡æ•°æ®å¹¶è¿›è¡Œæ‰¹å¤„ç†åˆ†æã€‚</p><p>ç†è§£HDFSçš„å†…éƒ¨å·¥ä½œåŸç†ï¼Œå¯¹äºä¼˜åŒ–å¤§æ•°æ®å¤„ç†æ€§èƒ½ã€ä¿éšœæ•°æ®å®‰å…¨ä»¥åŠè§£å†³å®é™…ç”Ÿäº§ç¯å¢ƒä¸­çš„é—®é¢˜å…·æœ‰é‡è¦æ„ä¹‰ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å¤§æ•°æ® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HDFS </tag>
            
            <tag> åˆ†å¸ƒå¼å­˜å‚¨ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä»ç‰©ç†æ”»å‡»åˆ°äº‘ç«¯ä¿¡ä»»ï¼šè®©æˆ‘ä»¬ä¸€èµ·äº†è§£å¯ä¿¡æ‰§è¡Œç¯å¢ƒä¸æœºå¯†è®¡ç®—æŠ€æœ¯æ ˆ</title>
      <link href="/2025/06/24/confidential_computing_overview/"/>
      <url>/2025/06/24/confidential_computing_overview/</url>
      
        <content type="html"><![CDATA[<h1 id="ä»ç‰©ç†æ”»å‡»åˆ°äº‘ç«¯ä¿¡ä»»ï¼šè®©æˆ‘ä»¬ä¸€èµ·äº†è§£å¯ä¿¡æ‰§è¡Œç¯å¢ƒä¸æœºå¯†è®¡ç®—æŠ€æœ¯æ ˆ"><a href="#ä»ç‰©ç†æ”»å‡»åˆ°äº‘ç«¯ä¿¡ä»»ï¼šè®©æˆ‘ä»¬ä¸€èµ·äº†è§£å¯ä¿¡æ‰§è¡Œç¯å¢ƒä¸æœºå¯†è®¡ç®—æŠ€æœ¯æ ˆ" class="headerlink" title="ä»ç‰©ç†æ”»å‡»åˆ°äº‘ç«¯ä¿¡ä»»ï¼šè®©æˆ‘ä»¬ä¸€èµ·äº†è§£å¯ä¿¡æ‰§è¡Œç¯å¢ƒä¸æœºå¯†è®¡ç®—æŠ€æœ¯æ ˆ"></a>ä»ç‰©ç†æ”»å‡»åˆ°äº‘ç«¯ä¿¡ä»»ï¼šè®©æˆ‘ä»¬ä¸€èµ·äº†è§£å¯ä¿¡æ‰§è¡Œç¯å¢ƒä¸æœºå¯†è®¡ç®—æŠ€æœ¯æ ˆ</h1><p>ä½œä¸ºä¸€ä¸ªJavaåç«¯å¼€å‘ï¼Œä»¥å¾€åœ¨æ•°æ®å®‰å…¨é¢†åŸŸï¼Œæˆ‘ä»¬ä¹ æƒ¯äºè®¨è®ºé™æ€åŠ å¯†ï¼ˆat-restï¼‰å’Œä¼ è¾“åŠ å¯†ï¼ˆin-transitï¼‰ï¼Œæ¯”å¦‚å„ç§åŠ å¯†ç®—æ³•ã€httpsã€‚ç„¶è€Œåœ¨æ¥è§¦å¤§æ•°æ®ä¸éšç§è®¡ç®—åï¼Œæ‰çŸ¥é“å…¶å®ä¸€ç›´æœ‰ä¸€ä¸ªé•¿æœŸå­˜åœ¨çš„ç—›ç‚¹æ˜¯â€”â€”æ•°æ®åœ¨è®¡ç®—è¿‡ç¨‹ä¸­ï¼Œå³â€ä½¿ç”¨ä¸­ï¼ˆin-useï¼‰â€çš„çŠ¶æ€ã€‚å½“æ•°æ®è¢«åŠ è½½åˆ°å†…å­˜ä¸­è¿›è¡Œå¤„ç†æ—¶ï¼Œå®ƒé€šå¸¸æ˜¯ä»¥æ˜æ–‡å½¢å¼å­˜åœ¨çš„ï¼Œè¿™ä½¿å…¶æš´éœ²åœ¨å„ç§é«˜çº§æ”»å‡»ä¹‹ä¸‹ã€‚å¯ä¿¡æ‰§è¡Œç¯å¢ƒï¼ˆTEEï¼‰æ­£æ˜¯ä¸ºäº†è§£å†³è¿™ä¸€æ ¹æœ¬é—®é¢˜è€Œå‡ºç°çš„æŠ€æœ¯ã€‚</p><p>æœ¬æ–‡å°†æ·±å…¥æ¢è®¨å†…å­˜æ•°æ®é¢ä¸´çš„ä¸»è¦å¨èƒï¼Œå¹¶è¯¦ç»†è§£æä»¥Intelä¸ºä»£è¡¨çš„ä¸»æµç¡¬ä»¶å‚å•†å¦‚ä½•é€šè¿‡TMEã€SGXå’ŒTDXç­‰æŠ€æœ¯æ ˆæ„å»ºæœºå¯†è®¡ç®—ç¯å¢ƒï¼Œæœ€åå¯¹ä¸šç•Œçš„å‡ ç§ä¸»æµæ–¹æ¡ˆè¿›è¡Œæ¢³ç†å’Œå¯¹æ¯”ã€‚</p><h2 id="ä¸€-å¨èƒæ¨¡å‹ï¼šå†…å­˜ä¸­æ•°æ®çš„â€è£¸å¥”â€é£é™©"><a href="#ä¸€-å¨èƒæ¨¡å‹ï¼šå†…å­˜ä¸­æ•°æ®çš„â€è£¸å¥”â€é£é™©" class="headerlink" title="ä¸€. å¨èƒæ¨¡å‹ï¼šå†…å­˜ä¸­æ•°æ®çš„â€è£¸å¥”â€é£é™©"></a>ä¸€. å¨èƒæ¨¡å‹ï¼šå†…å­˜ä¸­æ•°æ®çš„â€è£¸å¥”â€é£é™©</h2><p>åœ¨è®¨è®ºè§£å†³æ–¹æ¡ˆä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»æ¸…æ™°åœ°å®šä¹‰é—®é¢˜ã€‚é’ˆå¯¹å†…å­˜æ•°æ®çš„æ”»å‡»å¤§è‡´å¯åˆ†ä¸ºä¸¤ç±»ï¼šç‰©ç†æ”»å‡»å’Œè½¯ä»¶æ”»å‡»ã€‚</p><h3 id="1-ç‰©ç†æ”»å‡»-Physical-Attacks"><a href="#1-ç‰©ç†æ”»å‡»-Physical-Attacks" class="headerlink" title="1. ç‰©ç†æ”»å‡» (Physical Attacks)"></a>1. ç‰©ç†æ”»å‡» (Physical Attacks)</h3><p>æŒ‡æ”»å‡»è€…èƒ½å¤Ÿç‰©ç†æ¥è§¦åˆ°ç¡¬ä»¶è®¾å¤‡ã€‚è¿™ç±»æ”»å‡»çš„ç›®æ ‡æ˜¯ç›´æ¥ä»ç¡¬ä»¶ä¸­æŠŠæ•°æ®â€æŠ â€å‡ºæ¥ã€‚</p><ul><li><p><strong>å†·å¯åŠ¨æ”»å‡»(Cold Boot Attack</strong>ï¼šä¸€ä¸ªç»å…¸çš„æ”»å‡»ã€‚DRAMæ–­ç”µåï¼Œå†…éƒ¨ç”µå®¹å­˜å‚¨çš„ç”µè·ä¸ä¼šç¬é—´æ¶ˆå¤±ï¼Œæ•°æ®ä¼šæ®‹ç•™å‡ åç§’åˆ°æ•°åˆ†é’Ÿã€‚é€šè¿‡ä½¿ç”¨æ¶²æ°®ç­‰åˆ¶å†·å‰‚å¯¹å†…å­˜æ¡é™æ¸©ï¼Œå¯ä»¥æ˜¾è‘—å»¶é•¿æ•°æ®æ®‹ç•™æ—¶é—´ã€‚æ”»å‡»è€…å¯åˆ©ç”¨è¿™æ®µæ—¶é—´é‡å¯è®¾å¤‡è¿›å…¥ä¸€ä¸ªè½»é‡çº§çš„è‡ªæœ‰ç³»ç»Ÿï¼Œå¹¶å¿«é€Ÿdumpæ•´ä¸ªç‰©ç†å†…å­˜çš„å†…å®¹ã€‚</p></li><li><p><strong>æ€»çº¿çª¥æ¢(Bus Snooping</strong>ï¼šé€šè¿‡ç‰©ç†æ¢é’ˆè¿æ¥åˆ°CPUå’Œå†…å­˜ä¹‹é—´çš„æ•°æ®æ€»çº¿ï¼Œç›´æ¥ç›‘å¬ä¸¤è€…ä¹‹é—´çš„é€šä¿¡ä¿¡å·ï¼Œä»è€Œçªƒå–æµç»æ€»çº¿çš„æ‰€æœ‰æ•°æ®ã€‚</p></li><li><p><strong>å†…å­˜èŠ¯ç‰‡ç§»æ¤</strong>ï¼šæ›´åŠ æç«¯çš„æ–¹å¼ï¼Œç›´æ¥å°†å†…å­˜é¢—ç²’ä»ä¸»æ¿ä¸Šç„Šä¸‹æ¥ï¼Œå†é€šè¿‡ä¸“ç”¨è®¾å¤‡è¯»å–å…¶ä¸­çš„æ•°æ®ã€‚</p></li><li><p><strong>ä¾§ä¿¡é“æ”»å‡»(Side-Channel Attacks</strong>ï¼šè¿™æ˜¯ä¸€ç±»æ›´éšè”½ä½†å¨èƒå·¨å¤§çš„æ”»å‡»æ–¹å¼ã€‚æ”»å‡»è€…ä¸ç›´æ¥è®¿é—®æ•°æ®æœ¬èº«ï¼Œè€Œæ˜¯é€šè¿‡åˆ†æç³»ç»Ÿåœ¨å¤„ç†æ•°æ®æ—¶äº§ç”Ÿçš„â€å‰¯ä½œç”¨â€æ¥æ¨æ–­å‡ºæ•æ„Ÿä¿¡æ¯ï¼š</p><ul><li><strong>æ—¶åºæ”»å‡»</strong>ï¼šé€šè¿‡æµ‹é‡ç³»ç»Ÿæ‰§è¡Œä¸åŒæ“ä½œçš„æ—¶é—´å·®å¼‚æ¥æ¨æ–­å¯†é’¥æˆ–æ•°æ®å†…å®¹</li><li><strong>åŠŸè€—åˆ†ææ”»å‡»</strong>ï¼šç›‘æµ‹CPUåœ¨å¤„ç†ä¸åŒæ•°æ®æ—¶çš„åŠŸè€—å˜åŒ–æ¨¡å¼ï¼Œä»åŠŸè€—æ›²çº¿ä¸­æå–æ•æ„Ÿä¿¡æ¯</li><li><strong>ç”µç£è¾å°„æ”»å‡»</strong>ï¼šæ•è·è®¾å¤‡è¿è¡Œæ—¶äº§ç”Ÿçš„ç”µç£ä¿¡å·ï¼Œé€šè¿‡ä¿¡å·åˆ†æè¿˜åŸå‡ºå†…éƒ¨å¤„ç†çš„æ•°æ®</li><li><strong>ç¼“å­˜ä¾§ä¿¡é“æ”»å‡»</strong>ï¼šåˆ©ç”¨CPUç¼“å­˜çš„è®¿é—®æ¨¡å¼å˜åŒ–æ¥æ¨æ–­å…¶ä»–è¿›ç¨‹æˆ–Enclaveçš„è¡Œä¸ºå’Œæ•°æ®</li></ul><p>ä¾§ä¿¡é“æ”»å‡»çš„ç‰¹ç‚¹æ˜¯é€šå¸¸ä¸éœ€è¦ç ´åç³»ç»Ÿçš„å®Œæ•´æ€§ï¼Œæ”»å‡»è¿‡ç¨‹ç›¸å¯¹éšè”½ï¼Œæ˜¯TEEç¯å¢ƒé¢ä¸´çš„é‡è¦æŒ‘æˆ˜ä¹‹ä¸€ã€‚</p></li></ul><h3 id="2-è½¯ä»¶æ”»å‡»-Software-Attacks"><a href="#2-è½¯ä»¶æ”»å‡»-Software-Attacks" class="headerlink" title="2. è½¯ä»¶æ”»å‡» (Software Attacks)"></a>2. è½¯ä»¶æ”»å‡» (Software Attacks)</h3><p>è¿™æ˜¯æ›´å¸¸è§ã€æ›´å¹¿æ³›çš„æ”»å‡»é¢ï¼ŒæŒ‡æ”»å‡»è€…åˆ©ç”¨è½¯ä»¶æ¼æ´æˆ–ç³»ç»Ÿæƒé™è¿›è¡Œæ”»å‡»ã€‚</p><ul><li><strong>æ¥è‡ªåŒçº§çš„æ”»å‡»</strong>ï¼šæ¶æ„è¿›ç¨‹è¯•å›¾è¯»å–å…¶ä»–è¿›ç¨‹çš„å†…å­˜ã€‚ç°ä»£æ“ä½œç³»ç»Ÿé€šè¿‡è™šæ‹Ÿå†…å­˜å’Œç¡¬ä»¶MMUæä¾›çš„åœ°å€ç©ºé—´éš”ç¦»ï¼ŒåŸºæœ¬å¯ä»¥é˜²å¾¡æ­¤ç±»æ”»å‡»ã€‚ä¸€ä¸ªè¿›ç¨‹æ— æ³•ç›´æ¥è®¿é—®ä¸å±äºå®ƒçš„ç‰©ç†å†…å­˜é¡µã€‚</li><li><strong>æ¥è‡ªé«˜æƒé™çš„æ”»å‡»</strong>ï¼šè¿™æ˜¯TEEæŠ€æœ¯è¦è§£å†³çš„æ ¸å¿ƒé—®é¢˜ã€‚å¦‚æœæ”»å‡»è€…æ”»é™·äº†æ“ä½œç³»ç»Ÿï¼ˆOSï¼‰å†…æ ¸æˆ–è™šæ‹Ÿæœºç›‘æ§å™¨ï¼ˆHypervisor&#x2F;VMMï¼‰ï¼Œä»–å°±æ‹¥æœ‰äº†ç³»ç»Ÿçš„æœ€é«˜æƒé™ã€‚æ­¤æ—¶ï¼Œä»–å¯ä»¥åƒä¸Šå¸ä¸€æ ·ä¿¯ç°æ‰€æœ‰è¿›ç¨‹å’Œè™šæ‹Ÿæœºçš„å†…å­˜ï¼Œè½»æ¾dumpä»»ä½•ä»–æƒ³è¦çš„æ•°æ®ã€‚åœ¨å…¬æœ‰äº‘ç¯å¢ƒä¸­ï¼Œè¿™ä¸ªâ€é«˜æƒé™è§’è‰²â€ç”šè‡³å¯èƒ½æ˜¯äº‘æœåŠ¡å•†è‡ªå·±ã€‚</li></ul><h2 id="äºŒ-Intelæœºå¯†è®¡ç®—æŠ€æœ¯æ ˆè§£æ"><a href="#äºŒ-Intelæœºå¯†è®¡ç®—æŠ€æœ¯æ ˆè§£æ" class="headerlink" title="äºŒ. Intelæœºå¯†è®¡ç®—æŠ€æœ¯æ ˆè§£æ"></a>äºŒ. Intelæœºå¯†è®¡ç®—æŠ€æœ¯æ ˆè§£æ</h2><p>ä¸ºäº†åº”å¯¹ä¸Šè¿°å¨èƒï¼ŒIntelæ„å»ºäº†ä¸€ä¸ªå¤šå±‚æ¬¡çš„é˜²å¾¡ä½“ç³»ã€‚ç†è§£è¿™ä¸ªä½“ç³»éœ€è¦æˆ‘ä»¬é€ä¸€æ‹†è§£å…¶æ ¸å¿ƒç»„ä»¶ï¼šTMEã€SGXå’ŒTDXã€‚</p><h3 id="1-Intel-TME-Total-Memory-Encryption-ï¼šç‰©ç†é˜²çº¿çš„åŸºçŸ³"><a href="#1-Intel-TME-Total-Memory-Encryption-ï¼šç‰©ç†é˜²çº¿çš„åŸºçŸ³" class="headerlink" title="1. Intel TME (Total Memory Encryption)ï¼šç‰©ç†é˜²çº¿çš„åŸºçŸ³"></a>1. Intel TME (Total Memory Encryption)ï¼šç‰©ç†é˜²çº¿çš„åŸºçŸ³</h3><ul><li><p><strong>è§£å†³çš„é—®é¢˜</strong>ï¼šä¸“é—¨é’ˆå¯¹ä¸Šè¿°æ‰€æœ‰<strong>ç‰©ç†æ”»å‡»</strong>ã€‚</p></li><li><p><strong>åŸç†ä¸å®ç°</strong>ï¼šTMEçš„æ ¸å¿ƒæ˜¯åœ¨CPUçš„å†…å­˜æ§åˆ¶å™¨ä¸­é›†æˆäº†ä¸€ä¸ªé«˜æ€§èƒ½çš„AES-XTSç¡¬ä»¶åŠ å¯†å¼•æ“ã€‚å½“CPUæ ¸å¿ƒè¦å°†æ•°æ®å†™å…¥RAMæ—¶ï¼Œæ•°æ®åœ¨ç¦»å¼€CPUå°è£…å‰ä¼šè¢«è¯¥å¼•æ“è‡ªåŠ¨åŠ å¯†ï¼›å½“æ•°æ®ä»RAMè¯»å›CPUæ—¶ï¼Œåˆ™è¢«è‡ªåŠ¨è§£å¯†ã€‚æ•´ä¸ªè¿‡ç¨‹ç”±ç¡¬ä»¶å®Œæˆï¼Œå¯¹ä¸Šå±‚è½¯ä»¶ï¼ˆåŒ…æ‹¬OSï¼‰å®Œå…¨é€æ˜ã€‚åŠ å¯†å¯†é’¥åœ¨CPUæ¯æ¬¡ä¸Šç”µæ—¶éšæœºç”Ÿæˆï¼Œå¹¶å®‰å…¨åœ°å­˜å‚¨åœ¨CPUå†…éƒ¨ï¼Œè½¯ä»¶æ— æ³•è®¿é—®ã€‚</p><p><strong>æ¶æ„åŸç†å›¾å¦‚ä¸‹ï¼š</strong></p><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    subgraph &quot;CPUå°è£…&quot;        CPU_Core[&quot;CPUæ ¸å¿ƒ&lt;br&#x2F;&gt;(æ˜æ–‡æ•°æ®)&quot;]        subgraph &quot;å†…å­˜æ§åˆ¶å™¨&quot;            AES_Engine[&quot;AES-XTSå¼•æ“&lt;br&#x2F;&gt;(ç¡¬ä»¶)&quot;]        end        CPU_Core -- &quot;è¯»&#x2F;å†™&quot; --&gt; AES_Engine    end    subgraph &quot;å¤–éƒ¨ä¸–ç•Œ&quot;        Memory_Bus[&quot;å†…å­˜æ€»çº¿&quot;]        DRAM[&quot;ç‰©ç†å†…å­˜ (DRAM)&quot;]        Attacker[&quot;ç‰©ç†æ”»å‡»è€…&lt;br&#x2F;&gt;(ä¾‹å¦‚ å†·å¯åŠ¨, æ¢é’ˆ)&quot;]    end    AES_Engine -- &quot;åŠ å¯†æ•°æ®&quot; --&gt; Memory_Bus    Memory_Bus -- &quot; &quot; --&gt; DRAM    Attacker -- &quot;æ”»å‡»&quot; --&gt; Memory_Bus    Attacker -- &quot;æ”»å‡»&quot; --&gt; DRAM        style Attacker fill:#ffb3b3,stroke:#333    style AES_Engine fill:#bbf,stroke:#333    linkStyle 2 stroke:red,stroke-width:2px;    linkStyle 3 stroke:red,stroke-width:2px;  </pre></div><p>ä»å›¾ä¸­å¯è§ï¼Œæ˜æ–‡æ•°æ®ä»…å­˜åœ¨äºCPUæ ¸å¿ƒå†…éƒ¨ã€‚ä¸€æ—¦æ•°æ®éœ€è¦ç¦»å¼€CPUæ ¸å¿ƒè¿›å…¥å†…å­˜æ§åˆ¶å™¨ï¼Œå°±ä¼šè¢«AESå¼•æ“å¤„ç†ã€‚æœ€ç»ˆåœ¨å†…å­˜æ€»çº¿å’ŒDRAMèŠ¯ç‰‡ä¸Šå­˜åœ¨çš„æ•°æ®å‡æ˜¯å¯†æ–‡ï¼Œä»è€Œä½¿ç‰©ç†æ”»å‡»å¤±æ•ˆã€‚</p></li><li><p><strong>æ•ˆæœ</strong>ï¼šç”±äºæ•°æ®åœ¨å†…å­˜æ€»çº¿å’ŒDRAMèŠ¯ç‰‡ä¸Šå§‹ç»ˆæ˜¯å¯†æ–‡å½¢æ€ï¼Œæ— è®ºæ˜¯å†·å¯åŠ¨æ”»å‡»ã€æ€»çº¿çª¥æ¢è¿˜æ˜¯ç›´æ¥ç›—å–å†…å­˜æ¡ï¼Œæ”»å‡»è€…è·å–åˆ°çš„éƒ½åªæ˜¯ä¸€å †æ— æ„ä¹‰çš„ä¹±ç ã€‚</p></li><li><p><strong>å±€é™</strong>ï¼š</p><ul><li><strong>è½¯ä»¶æ”»å‡»é˜²æŠ¤ç¼ºå¤±</strong>ï¼šTMEçš„ä¿¡ä»»è¾¹ç•Œæ­¢äºCPUå°è£…ã€‚å®ƒä¿¡ä»»è¿è¡Œåœ¨CPUä¸Šçš„OSå’ŒVMMï¼Œå› æ­¤æ— æ³•é˜²å¾¡æ¥è‡ªé«˜æƒé™è½¯ä»¶çš„æ”»å‡»ã€‚</li><li><strong>ä¾§ä¿¡é“æ”»å‡»æŠµæŠ—æœ‰é™</strong>ï¼šè™½ç„¶TMEåŠ å¯†äº†å†…å­˜æ•°æ®ï¼Œä½†æ— æ³•å®Œå…¨æ¶ˆé™¤ä¾§ä¿¡é“æ”»å‡»çš„å¨èƒã€‚ä¾‹å¦‚ï¼Œæ”»å‡»è€…ä»å¯èƒ½é€šè¿‡åˆ†æå†…å­˜è®¿é—®çš„æ—¶åºæ¨¡å¼ã€åŠŸè€—å˜åŒ–ç­‰æ–¹å¼è·å–æ•æ„Ÿä¿¡æ¯ã€‚é’ˆå¯¹ä¾§ä¿¡é“æ”»å‡»çš„é˜²æŠ¤éœ€è¦æ›´ä¸Šå±‚çš„TEEæŠ€æœ¯ï¼ˆå¦‚SGXã€TDXï¼‰é…åˆä¸“é—¨çš„ç¼“è§£æªæ–½ã€‚</li></ul></li></ul><h3 id="2-Intel-SGX-Software-Guard-Extensions-ï¼šåº”ç”¨å†…çš„â€ä¿é™©ç®±â€"><a href="#2-Intel-SGX-Software-Guard-Extensions-ï¼šåº”ç”¨å†…çš„â€ä¿é™©ç®±â€" class="headerlink" title="2. Intel SGX (Software Guard Extensions)ï¼šåº”ç”¨å†…çš„â€ä¿é™©ç®±â€"></a>2. Intel SGX (Software Guard Extensions)ï¼šåº”ç”¨å†…çš„â€ä¿é™©ç®±â€</h3><ul><li><p><strong>è§£å†³çš„é—®é¢˜</strong>ï¼šä¿æŠ¤åº”ç”¨çš„æ ¸å¿ƒä»£ç å’Œæ•°æ®ï¼ŒæŠµå¾¡æ¥è‡ª<strong>é«˜æƒé™è½¯ä»¶ï¼ˆOS&#x2F;VMMï¼‰</strong> çš„æ”»å‡»ã€‚SGXæ˜¯Intelç¬¬ä¸€ä»£æˆç†Ÿçš„TEEå®ç°ã€‚</p></li><li><p><strong>åŸç†ä¸å®ç°</strong>ï¼šSGXå…è®¸ä¸€ä¸ªåº”ç”¨ç¨‹åºåœ¨è‡ªå·±çš„åœ°å€ç©ºé—´å†…ï¼Œåˆ’å®šå‡ºä¸€å—æˆ–å¤šå—å—ç¡¬ä»¶ä¿æŠ¤çš„å†…å­˜åŒºåŸŸï¼Œç§°ä¸ºâ€é£åœ°â€ï¼ˆEnclaveï¼‰ã€‚CPUä¼šä¸ºè¿™å—åŒºåŸŸï¼ˆç‰©ç†ä¸Šä½äºEPCï¼ŒEnclave Page Cacheï¼‰æä¾›å¼ºéš”ç¦»å’Œå†…å­˜åŠ å¯†ã€‚OS&#x2F;VMMä½œä¸ºç³»ç»Ÿç®¡ç†è€…ï¼Œå¯ä»¥ç®¡ç†Enclaveï¼ˆä¾‹å¦‚åˆ†é…ã€å›æ”¶å†…å­˜é¡µï¼‰ï¼Œä½†ç»å¯¹æ— æ³•è¯»å–æˆ–ä¿®æ”¹å…¶å†…éƒ¨å†…å®¹ã€‚åº”ç”¨ç¨‹åºé€šè¿‡ç‰¹å®šçš„æŒ‡ä»¤ï¼ˆECALL&#x2F;OCALLï¼‰åœ¨â€å®‰å…¨ä¸–ç•Œâ€ï¼ˆEnclaveå†…éƒ¨ï¼‰å’Œâ€éå®‰å…¨ä¸–ç•Œâ€ï¼ˆç¨‹åºå…¶ä»–éƒ¨åˆ†ï¼‰ä¹‹é—´åˆ‡æ¢ã€‚åŒæ—¶ï¼ŒSGXæä¾›äº†å¼ºå¤§çš„<strong>è¿œç¨‹è¯æ˜ï¼ˆRemote Attestationï¼‰</strong>æœºåˆ¶ï¼ŒEnclaveå¯ä»¥è·å–ä¸€ä»½ç”±CPUç¡¬ä»¶ç­¾åçš„æ•°æ®æŠ¥å‘Šï¼ˆQuoteï¼‰ï¼Œå‘ç»™è¿œç¨‹æ–¹ä»¥è¯æ˜è‡ªå·±æ˜¯ä¸€ä¸ªè¿è¡Œåœ¨çœŸå®SGXç¡¬ä»¶ä¸Šã€ä¸”æœªè¢«ç¯¡æ”¹çš„ç‰¹å®šç¨‹åºã€‚</p><p><strong>è¿œç¨‹è¯æ˜æœºåˆ¶æ˜¯SGXçš„çµé­‚æ‰€åœ¨ã€‚</strong> å…¶æ ¸å¿ƒæµç¨‹æ˜¯ï¼šEnclaveè¯·æ±‚CPUç”Ÿæˆä¸€ä»½åŒ…å«å…¶ä»£ç åº¦é‡å€¼ï¼ˆå¯ä»¥ç†è§£ä¸ºç¨‹åºçš„â€™æŒ‡çº¹â€™ï¼‰å’Œé…ç½®ä¿¡æ¯çš„æŠ¥å‘Šï¼ˆQuoteï¼‰ï¼Œè¿™ä»½æŠ¥å‘Šç”±CPUç¡¬ä»¶åŸºäºå…¶ç‰¹æœ‰çš„ç§é’¥ç›´æ¥ç­¾åï¼Œä»»ä½•è½¯ä»¶æ— æ³•ä¼ªé€ ã€‚è¿œç¨‹çš„å®¢æˆ·ç«¯åœ¨æ”¶åˆ°è¿™ä»½æŠ¥å‘Šåï¼Œä½¿ç”¨å…¬å¼€çš„Intelå®˜æ–¹å…¬é’¥è¿›è¡ŒéªŒç­¾ï¼Œå¹¶æ¯”å¯¹å…¶ä¸­çš„ç¨‹åºâ€™æŒ‡çº¹â€™ã€‚åªæœ‰ç­¾åæœ‰æ•ˆä¸”â€™æŒ‡çº¹â€™ç¬¦åˆé¢„æœŸï¼Œå®¢æˆ·ç«¯æ‰èƒ½ç¡®ä¿¡è¿™ä¸ªEnclaveæ˜¯çœŸå®ã€æ­£ç¡®ä¸”æœªè¢«ç¯¡æ”¹çš„ï¼Œä»è€Œæ”¾å¿ƒåœ°å°†å¯†é’¥ã€æ•°æ®ç­‰æ•æ„Ÿä¿¡æ¯ä¼ é€’ç»™å®ƒã€‚å®ƒè§£å†³äº†ä¿¡ä»»é“¾æ¡ä¸­â€æœ€åä¸€å…¬é‡Œâ€çš„é—®é¢˜ï¼Œæ˜¯å»ºç«‹è¿œç¨‹ä¿¡ä»»çš„æ ¹åŸºã€‚</p><p><strong>æ¶æ„åŸç†å›¾å¦‚ä¸‹ï¼š</strong></p><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    subgraph &quot;ç”¨æˆ·è¿›ç¨‹åœ°å€ç©ºé—´&quot;        App_Normal[&quot;åº”ç”¨ç¨‹åºä»£ç &lt;br&#x2F;&gt;(éå¯ä¿¡éƒ¨åˆ†)&quot;]        subgraph &quot;SGX Enclave (å—CPUä¿æŠ¤)&quot;            App_Secure[&quot;å®‰å…¨ä»£ç ä¸æ•°æ®&quot;]        end    end    subgraph &quot;é«˜æƒé™è½¯ä»¶&quot;        OS_VMM[&quot;æ“ä½œç³»ç»Ÿ &#x2F; VMM&quot;]    end        subgraph &quot;ç¡¬ä»¶&quot;        CPU[&quot;CPU&quot;]    end        App_Normal -- &quot;ECALL (è¿›å…¥Enclave)&quot; --&gt; App_Secure    App_Secure -- &quot;OCALL (ç¦»å¼€Enclave)&quot; --&gt; App_Normal        OS_VMM -- &quot;ç®¡ç†Enclave (ä¾‹å¦‚ åˆ†é¡µ)&quot; --&gt; App_Secure    OS_VMM -- &quot;&lt;b&gt;CPUç¡¬ä»¶æ‹’ç»è®¿é—®&lt;&#x2F;b&gt;&quot; --&gt; App_Secure    CPU -- &quot;å¼ºåˆ¶æ‰§è¡Œè¾¹ç•Œ&quot; --&gt; App_Secure        style App_Secure fill:#d5e8d4,stroke:#333    style OS_VMM fill:#ffd6b3,stroke:#333    linkStyle 3 stroke:green,stroke-width:1px,stroke-dasharray: 5 5;    linkStyle 4 stroke:red,stroke-width:2px;  </pre></div><p>æ­¤å›¾å±•ç¤ºäº†SGXçš„æ ¸å¿ƒæ€æƒ³ï¼šå³ä¾¿OS&#x2F;VMMæ‹¥æœ‰é«˜æƒé™ï¼ŒCPUç¡¬ä»¶ä¹Ÿä¼šå¼ºåˆ¶æ‰§è¡Œéš”ç¦»ç­–ç•¥ï¼Œé˜»æ­¢å…¶ç›´æ¥è®¿é—®Enclaveçš„å†…å­˜ã€‚åº”ç”¨çš„éå¯ä¿¡éƒ¨åˆ†é€šè¿‡å®šä¹‰çš„æ¥å£ï¼ˆECALL&#x2F;OCALLï¼‰ä¸Enclaveäº¤äº’ï¼Œå®ç°äº†æœ€å°æƒé™åŸåˆ™ã€‚</p></li><li><p><strong>å±€é™</strong>ï¼šSGXçš„ä¿æŠ¤ç²’åº¦åœ¨åº”ç”¨å±‚ï¼Œéœ€è¦å¼€å‘è€…å¯¹ç¨‹åºè¿›è¡Œå¤§é‡çš„ã€ä¾µå…¥å¼çš„æ”¹é€ ï¼Œå°†æ ¸å¿ƒé€»è¾‘å’Œéæ ¸å¿ƒé€»è¾‘æ‹†åˆ†å¼€ï¼Œå¼€å‘æˆæœ¬å’ŒæŠ€æœ¯é—¨æ§›éƒ½ç›¸å½“é«˜ã€‚è¿™å¯¹äºè¿ç§»åºå¤§çš„é—ç•™åº”ç”¨ç³»ç»Ÿæ¥è¯´å‡ ä¹æ˜¯ä¸ç°å®çš„ã€‚</p></li></ul><h3 id="3-Intel-TDX-Trust-Domain-Extensions-ï¼šä¸ºè™šæ‹Ÿæœºæ‰“é€ çš„â€å®‰å…¨å±‹â€"><a href="#3-Intel-TDX-Trust-Domain-Extensions-ï¼šä¸ºè™šæ‹Ÿæœºæ‰“é€ çš„â€å®‰å…¨å±‹â€" class="headerlink" title="3. Intel TDX (Trust Domain Extensions)ï¼šä¸ºè™šæ‹Ÿæœºæ‰“é€ çš„â€å®‰å…¨å±‹â€"></a>3. Intel TDX (Trust Domain Extensions)ï¼šä¸ºè™šæ‹Ÿæœºæ‰“é€ çš„â€å®‰å…¨å±‹â€</h3><ul><li><p><strong>è§£å†³çš„é—®é¢˜</strong>ï¼šåŒæ ·æ˜¯æŠµå¾¡æ¥è‡ª<strong>é«˜æƒé™VMM&#x2F;Hypervisor</strong>çš„æ”»å‡»ï¼Œä½†ç›®æ ‡æ˜¯ä¿æŠ¤<strong>æ•´ä¸ªè™šæ‹Ÿæœº</strong>ï¼Œè€Œéåº”ç”¨çš„ä¸€éƒ¨åˆ†ã€‚è¿™æ˜¯é¢å‘äº‘ç¯å¢ƒè®¾è®¡çš„TEEæ–¹æ¡ˆã€‚</p></li><li><p><strong>åŸç†ä¸å®ç°</strong>ï¼šTDXå°†æ•´ä¸ªè™šæ‹Ÿæœºï¼ˆGuest VMï¼‰ç½®äºä¸€ä¸ªç¡¬ä»¶éš”ç¦»çš„â€ä¿¡ä»»åŸŸâ€ï¼ˆTrust Domain, TDï¼‰ä¸­ã€‚ä¸SGXç±»ä¼¼ï¼ŒTDçš„å†…å­˜è¢«åŠ å¯†ä¸”å—åˆ°CPUè®¿é—®æ§åˆ¶çš„å¼ºåˆ¶ä¿æŠ¤ï¼ŒVMMè™½ç„¶è´Ÿè´£ç®¡ç†TDçš„ç”Ÿå‘½å‘¨æœŸå’Œèµ„æºè°ƒåº¦ï¼Œä½†æ— æ³•è®¿é—®å…¶å†…éƒ¨ã€‚ä¸ºå®ç°è¿™ä¸€ç‚¹ï¼ŒCPUçš„é¡µè¡¨ç»“æ„ä¸­å¼•å…¥äº†â€å…±äº«ä½â€ï¼ˆShared Bitï¼‰ï¼Œç”¨æ¥åŒºåˆ†è¯¥å†…å­˜é¡µæ˜¯å±äºGuestç§æœ‰è¿˜æ˜¯ä¸VMMå…±äº«ï¼Œç¡¬ä»¶ä»¥æ­¤ä¸ºä¾æ®æ‰§è¡Œè®¿é—®æ§åˆ¶ã€‚TDXåŒæ ·æ”¯æŒè¿œç¨‹è¯æ˜ï¼Œå¯ä»¥ä¸ºæ•´ä¸ªTDç”Ÿæˆä¸€ä»½Quoteï¼Œå‘è¿œç¨‹æ–¹è¯æ˜è¿™ä¸ªVMçš„åˆå§‹çŠ¶æ€ï¼ˆå›ºä»¶ã€å†…æ ¸ç­‰ï¼‰æ˜¯å¯ä¿¡çš„ã€‚</p><p><strong>æ¶æ„åŸç†å›¾å¦‚ä¸‹ï¼š</strong></p><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    subgraph &quot;ä¸å¯ä¿¡ä¸»æœºç¯å¢ƒ&quot;        VMM[&quot;Hypervisor &#x2F; VMM&quot;]    end    subgraph &quot;ç¡¬ä»¶ä¿æŠ¤çš„ä¿¡ä»»åŸŸ (TD)&quot;        Guest_App[&quot;Gueståº”ç”¨&quot;]        Guest_OS[&quot;Guestæ“ä½œç³»ç»Ÿ&quot;]        TD_Shim[&quot;TD-Shim (å›ºä»¶)&quot;]    end        subgraph &quot;CPUç¡¬ä»¶&quot;        TDX_Module[&quot;TDX æ¨¡å—&quot;]    end        VMM -- &quot;ç®¡ç†VMç”Ÿå‘½å‘¨æœŸ&quot; --&gt; TD_Shim    VMM -- &quot;&lt;b&gt;CPUç¡¬ä»¶æ‹’ç»å†…å­˜è®¿é—®&lt;&#x2F;b&gt;&quot; --&gt; Guest_OS        TDX_Module -- &quot;å¼ºåˆ¶éš”ç¦»ä¸åŠ å¯†&quot; --&gt; Guest_OS        Guest_OS -- &quot;é€šè¿‡ TDVMCALL&lt;br&#x2F;&gt;è¯·æ±‚è¯æ˜Quote&quot; --&gt; TDX_Module        style VMM fill:#ffd6b3,stroke:#333    style Guest_App fill:#d5e8d4,stroke:#333    style Guest_OS fill:#d5e8d4,stroke:#333    style TD_Shim fill:#d5e8d4,stroke:#333    style TDX_Module fill:#bbf,stroke:#333    linkStyle 1 stroke:red,stroke-width:2px;  </pre></div><p>ä¸Šå›¾æç»˜äº†TDXçš„å·¥ä½œæ¨¡å¼ã€‚VMMï¼ˆHypervisorï¼‰ä½œä¸ºä¸å¯ä¿¡çš„ä¸»æœºç¯å¢ƒï¼Œå¯ä»¥å¯åŠ¨å’Œç®¡ç†TDï¼Œä½†å…¶å¯¹TDå†…éƒ¨å†…å­˜çš„è®¿é—®ä¼šè¢«CPUç¡¬ä»¶ï¼ˆTDXæ¨¡å—ï¼‰æ˜ç¡®æ‹’ç»ã€‚TDå†…éƒ¨æ˜¯ä¸€ä¸ªå®Œæ•´çš„è½¯ä»¶æ ˆï¼ŒåŒ…æ‹¬å›ºä»¶ï¼ˆTD-Shimï¼‰ã€æ“ä½œç³»ç»Ÿå’Œåº”ç”¨ï¼Œå®ƒä»¬ä½œä¸ºä¸€ä¸ªæ•´ä½“å—åˆ°ä¿æŠ¤ã€‚Guest OSå¯ä»¥é€šè¿‡ç‰¹å®šçš„è™šæ‹Ÿæœºè°ƒç”¨ï¼ˆTDVMCALLï¼‰ä¸TDXæ¨¡å—äº¤äº’ï¼Œä»¥æ‰§è¡Œè·å–è¯æ˜æŠ¥å‘Šç­‰å®‰å…¨æ“ä½œã€‚</p></li><li><p><strong>ä¼˜åŠ¿</strong>ï¼šå¯¹è™šæ‹Ÿæœºå†…çš„åº”ç”¨ç¨‹åºæ¥è¯´ï¼ŒTDXå‡ ä¹æ˜¯é€æ˜çš„ã€‚ä¼ä¸šå¯ä»¥å°†ç°æœ‰çš„åº”ç”¨ç³»ç»Ÿâ€ç›´æ¥å¹³ç§»ï¼ˆLift-and-Shiftï¼‰â€åˆ°TDXç¯å¢ƒä¸­ï¼Œæ— éœ€ä¿®æ”¹ä»£ç ï¼Œæå¤§åœ°é™ä½äº†æœºå¯†è®¡ç®—çš„è½åœ°é—¨æ§›ã€‚</p></li></ul><h3 id="åŒºåˆ«ä¸å…³ç³»æ¢³ç†"><a href="#åŒºåˆ«ä¸å…³ç³»æ¢³ç†" class="headerlink" title="åŒºåˆ«ä¸å…³ç³»æ¢³ç†"></a>åŒºåˆ«ä¸å…³ç³»æ¢³ç†</h3><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">Intel TME</th><th align="left">Intel SGX</th><th align="left">Intel TDX</th><th align="left">AMD SEV-SNP</th></tr></thead><tbody><tr><td align="left"><strong>ä¿æŠ¤ç›®æ ‡</strong></td><td align="left">æ•´ä¸ªç‰©ç†å†…å­˜</td><td align="left">åº”ç”¨å†…éƒ¨çš„Enclave</td><td align="left">æ•´ä¸ªè™šæ‹Ÿæœº</td><td align="left">æ•´ä¸ªè™šæ‹Ÿæœº</td></tr><tr><td align="left"><strong>é˜²å¾¡å¯¹è±¡</strong></td><td align="left"><strong>ç‰©ç†æ”»å‡»</strong> (éä¾§ä¿¡é“)</td><td align="left">é«˜æƒé™è½¯ä»¶ (OS&#x2F;VMM)</td><td align="left">é«˜æƒé™è½¯ä»¶ (VMM)</td><td align="left">é«˜æƒé™è½¯ä»¶ (VMM)</td></tr><tr><td align="left"><strong>ä¿æŠ¤ç²’åº¦</strong></td><td align="left">ç³»ç»Ÿçº§</td><td align="left">åº”ç”¨çº§ (ç»†ç²’åº¦)</td><td align="left">VMçº§ (ç²—ç²’åº¦)</td><td align="left">VMçº§ (ç²—ç²’åº¦)</td></tr><tr><td align="left"><strong>åº”ç”¨æ”¹é€ </strong></td><td align="left"><strong>æ— </strong>ï¼Œå¯¹è½¯ä»¶é€æ˜</td><td align="left"><strong>å·¨å¤§</strong>ï¼Œä¾µå…¥å¼å¼€å‘</td><td align="left"><strong>æå°æˆ–æ— </strong>ï¼Œå¹³ç§»ä¸Šäº‘</td><td align="left"><strong>æå°æˆ–æ— </strong>ï¼Œå¹³ç§»ä¸Šäº‘</td></tr><tr><td align="left"><strong>ä¿¡ä»»æ ¹</strong></td><td align="left">CPUç¡¬ä»¶</td><td align="left">CPUç¡¬ä»¶</td><td align="left">CPUç¡¬ä»¶</td><td align="left">CPUç¡¬ä»¶ (AMD-SP)</td></tr></tbody></table><p>æ€»ç»“ä¸€ä¸‹å…³ç³»ï¼š<strong>TEEæ˜¯ä¸€ä¸ªè®¾è®¡ç†å¿µï¼ŒSGXã€TDXå’ŒSEV-SNPæ˜¯Intelå’ŒAMDå®ç°è¿™ä¸ªç†å¿µçš„ä¸åŒäº§å“ï¼Œè€ŒTMEæ˜¯ä¸ºIntelæ–¹æ¡ˆæä¾›åº•å±‚ç‰©ç†é˜²å¾¡çš„é…å¥—åŸºç¡€æŠ€æœ¯ã€‚</strong></p><h2 id="ä¸‰-é»„é‡‘ç»„åˆï¼šTDX-TME-çš„æ·±åº¦é˜²å¾¡"><a href="#ä¸‰-é»„é‡‘ç»„åˆï¼šTDX-TME-çš„æ·±åº¦é˜²å¾¡" class="headerlink" title="ä¸‰. é»„é‡‘ç»„åˆï¼šTDX + TME çš„æ·±åº¦é˜²å¾¡"></a>ä¸‰. é»„é‡‘ç»„åˆï¼šTDX + TME çš„æ·±åº¦é˜²å¾¡</h2><p>ä¸€ä¸ªçœŸæ­£å¥å£®çš„æœºå¯†è®¡ç®—ç¯å¢ƒï¼Œå¿…é¡»èƒ½åŒæ—¶æŠµå¾¡è½¯ä»¶å’Œç‰©ç†æ”»å‡»ã€‚TDXå’ŒTMEçš„ç»„åˆæ°å¥½å½¢æˆäº†è¿™æ ·ä¸€ä¸ªæ·±åº¦é˜²å¾¡ä½“ç³»ï¼š</p><ul><li>**TDXè´Ÿè´£â€å¯¹å†…â€**ï¼šå®ƒåœ¨è½¯ä»¶å±‚é¢åˆ’æ¸…äº†è™šæ‹Ÿæœºå’Œäº‘å¹³å°ä¹‹é—´çš„ä¿¡ä»»è¾¹ç•Œï¼Œç¡®ä¿å³ä½¿äº‘å¹³å°è¢«æ”»ç ´ï¼Œè¿è¡Œåœ¨TDé‡Œçš„è™šæ‹Ÿæœºæ•°æ®ä¾ç„¶å®‰å…¨ã€‚</li><li>**TMEè´Ÿè´£â€å¯¹å¤–â€**ï¼šå®ƒåœ¨ç‰©ç†å±‚é¢ä¸ºæ•´ä¸ªç³»ç»Ÿå†…å­˜æä¾›äº†åŠ å¯†ï¼Œç¡®ä¿äº†ä»»ä½•ç‰©ç†å±‚é¢çš„æ”»å‡»éƒ½æ— æ³•çªƒå–åˆ°æœ‰æ•ˆæ•°æ®ã€‚</li></ul><p>è¿™ä¸ªç»„åˆå®ç°äº†æ•°æ®åœ¨ä½¿ç”¨ä¸­ï¼ˆin-useï¼‰çš„å…¨æ–¹ä½ä¿æŠ¤ï¼Œæ˜¯ç›®å‰å…¬æœ‰äº‘ä¸Šæœºå¯†è®¡ç®—è™šæ‹Ÿæœºï¼ˆConfidential VMï¼‰çš„æ ‡å‡†æŠ€æœ¯æ¶æ„ã€‚</p><h2 id="å››-ä¸šç•Œä¸»æµæœºå¯†è®¡ç®—ç¯å¢ƒæ–¹æ¡ˆæ¦‚è§ˆ"><a href="#å››-ä¸šç•Œä¸»æµæœºå¯†è®¡ç®—ç¯å¢ƒæ–¹æ¡ˆæ¦‚è§ˆ" class="headerlink" title="å››. ä¸šç•Œä¸»æµæœºå¯†è®¡ç®—ç¯å¢ƒæ–¹æ¡ˆæ¦‚è§ˆ"></a>å››. ä¸šç•Œä¸»æµæœºå¯†è®¡ç®—ç¯å¢ƒæ–¹æ¡ˆæ¦‚è§ˆ</h2><blockquote><p>é˜¿é‡Œäº‘ç­‰äº‘å‚å•†æä¾›äº†å¤šç§æœºå¯†è®¡ç®—ç¯å¢ƒæ–¹æ¡ˆï¼Œè¿™äº›æ–¹æ¡ˆåŸºäºä¸åŒçš„æŠ€æœ¯ï¼Œå„æœ‰ä¾§é‡ï¼š<a href="https://help.aliyun.com/zh/ecs/user-guide/confidential-computing-capabilities/">https://help.aliyun.com/zh/ecs/user-guide/confidential-computing-capabilities/</a></p></blockquote><h3 id="1-SGXæœºå¯†è®¡ç®—"><a href="#1-SGXæœºå¯†è®¡ç®—" class="headerlink" title="1. SGXæœºå¯†è®¡ç®—"></a>1. SGXæœºå¯†è®¡ç®—</h3><ul><li><strong>æ¦‚å¿µ</strong>ï¼šè¿™é€šå¸¸æŒ‡ä¸€ç§<strong>IaaSï¼ˆåŸºç¡€è®¾æ–½å³æœåŠ¡ï¼‰</strong>æ¨¡å¼çš„æ–¹æ¡ˆã€‚äº‘å‚å•†æä¾›æ­è½½äº†æ”¯æŒIntel SGX CPUçš„ç‰©ç†æœºæˆ–è™šæ‹Ÿæœºå®ä¾‹ã€‚</li><li><strong>æ–¹æ¡ˆ</strong>ï¼šç”¨æˆ·è·å¾—ä¸€ä¸ªå…·å¤‡SGXç¡¬ä»¶èƒ½åŠ›çš„åº•å±‚ç¯å¢ƒï¼Œæ‹¥æœ‰å®Œæ•´çš„æ§åˆ¶æƒã€‚ä½†åŒæ—¶ï¼Œç”¨æˆ·ä¹Ÿéœ€è¦è‡ªè¡Œè´Ÿè´£æ•´ä¸ªSGXè½¯ä»¶æ ˆçš„éƒ¨ç½²ã€å¼€å‘å’Œç»´æŠ¤ï¼ŒåŒ…æ‹¬ä½¿ç”¨SGX SDKæ¥å¼€å‘æˆ–æ”¹é€ åº”ç”¨ï¼Œå°†æ ¸å¿ƒé€»è¾‘å°è£…åœ¨Enclaveä¸­ã€‚</li><li><strong>åŒºåˆ«</strong>ï¼šæ­¤æ–¹æ¡ˆæä¾›äº†æœ€å¤§çš„çµæ´»æ€§å’Œæ§åˆ¶åŠ›ï¼Œä½†å¯¹å¼€å‘è€…çš„æŠ€æœ¯è¦æ±‚æœ€é«˜ã€‚å®ƒé€‚ç”¨äºéœ€è¦æ·±åº¦å®šåˆ¶ã€æˆ–å¸Œæœ›å®Œå…¨æŒæ§å®‰å…¨æ ˆçš„ä¸“ä¸šå›¢é˜Ÿã€‚</li></ul><h3 id="2-TDXæœºå¯†è®¡ç®—"><a href="#2-TDXæœºå¯†è®¡ç®—" class="headerlink" title="2. TDXæœºå¯†è®¡ç®—"></a>2. TDXæœºå¯†è®¡ç®—</h3><ul><li><strong>æ¦‚å¿µ</strong>ï¼šä¸SGXç±»ä¼¼ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ç§<strong>IaaS</strong>æ–¹æ¡ˆï¼Œæ—¨åœ¨ä¸ºç”¨æˆ·æä¾›ä¸€ä¸ªå®Œæ•´çš„ã€å—ç¡¬ä»¶ä¿æŠ¤çš„æœºå¯†è™šæ‹Ÿæœºã€‚</li><li><strong>æ–¹æ¡ˆ</strong>ï¼šäº‘å‚å•†æä¾›åŸºäºIntel TDXæŠ€æœ¯çš„æœºå¯†è™šæ‹Ÿæœºå®ä¾‹ã€‚ç”¨æˆ·å¯ä»¥åƒä½¿ç”¨æ™®é€šè™šæ‹Ÿæœºä¸€æ ·ï¼Œå°†æ•´ä¸ªæ“ä½œç³»ç»Ÿå’Œåº”ç”¨â€å¹³ç§»ï¼ˆLift-and-Shiftï¼‰â€éƒ¨ç½²è¿›å»ï¼Œæ— éœ€ä¿®æ”¹åº”ç”¨ä»£ç ã€‚</li><li><strong>åŒºåˆ«</strong>ï¼šæ ¸å¿ƒä¼˜åŠ¿æ˜¯æé«˜çš„æ˜“ç”¨æ€§å’Œé€šç”¨æ€§ï¼Œæå¤§åœ°é™ä½äº†ä½¿ç”¨é—¨æ§›ï¼Œæ˜¯å½“å‰ä¿æŠ¤é—ç•™ç³»ç»Ÿå’Œå¤æ‚åº”ç”¨çš„ä¸»æµé€‰æ‹©ã€‚</li></ul><h3 id="3-AMD-SEV-SNP-æœºå¯†è®¡ç®—"><a href="#3-AMD-SEV-SNP-æœºå¯†è®¡ç®—" class="headerlink" title="3. AMD SEV&#x2F;SNP æœºå¯†è®¡ç®—"></a>3. AMD SEV&#x2F;SNP æœºå¯†è®¡ç®—</h3><ul><li><strong>æ¦‚å¿µ</strong>: è¿™æ˜¯Intel TDXæŠ€æœ¯åœ¨ä¸šç•Œæœ€ç›´æ¥çš„ç«äº‰å¯¹æ‰‹ï¼ŒåŒæ ·æ˜¯ä¸€ç§<strong>IaaS</strong>æ–¹æ¡ˆï¼Œç”±AMDæ¨å‡ºï¼Œæ—¨åœ¨ä¿æŠ¤æ•´ä¸ªè™šæ‹Ÿæœºçš„æœºå¯†æ€§ã€‚</li><li><strong>æ–¹æ¡ˆä¸æŠ€æœ¯æ¼”è¿›</strong>:<ul><li><strong>SEV (Secure Encrypted Virtualization)</strong>: è¿™æ˜¯æ—©æœŸç‰ˆæœ¬ï¼Œå®ƒä¸ºæ¯ä¸ªVMåˆ†é…ä¸€ä¸ªç‹¬ç«‹çš„åŠ å¯†å¯†é’¥ï¼ŒVMMæ— æ³•è§£å¯†VMçš„å†…å­˜ã€‚ä½†å®ƒæ— æ³•é˜»æ­¢æ¶æ„çš„VMMå¯¹VMå†…å­˜è¿›è¡Œç¯¡æ”¹ï¼ˆå¦‚é‡æ”¾ã€æ›¿æ¢å†…å­˜é¡µç­‰ï¼‰ã€‚</li><li><strong>SEV-ES (Encrypted State)</strong>: å¢å¼ºç‰ˆï¼Œè¿›ä¸€æ­¥åŠ å¯†äº†CPUå¯„å­˜å™¨çš„çŠ¶æ€ï¼Œé˜²æ­¢VMMè¯»å–æˆ–ä¿®æ”¹å¯„å­˜å™¨å†…å®¹ã€‚</li><li><strong>SEV-SNP (Secure Nested Paging)</strong>: è¿™æ˜¯ç›®å‰æœ€æˆç†Ÿçš„ç‰ˆæœ¬ï¼Œä¹Ÿæ˜¯ä¸Intel TDXå¯¹æ ‡çš„æŠ€æœ¯ã€‚å®ƒå¼•å…¥äº†â€å†…å­˜å®Œæ•´æ€§ä¿æŠ¤â€æœºåˆ¶ï¼Œé€šè¿‡åœ¨ç¡¬ä»¶ä¸­ç»´æŠ¤ä¸€ä¸ªç§°ä¸ºRMPï¼ˆReverse Map Tableï¼‰çš„è¡¨ï¼Œå¯ä»¥æœ‰æ•ˆé˜»æ­¢VMå¤–éƒ¨ï¼ˆå¦‚æ¶æ„VMMï¼‰å¯¹è™šæ‹Ÿæœºå†…å­˜çš„å®Œæ•´æ€§ç ´åï¼ˆå¦‚å†…å­˜é‡æ”¾æ”»å‡»ï¼‰ï¼Œå¹¶æä¾›äº†æ›´å¼ºçš„è¿œç¨‹è¯æ˜èƒ½åŠ›ã€‚</li></ul></li><li><strong>åŒºåˆ«</strong>: AMD SEV-SNPå’ŒIntel TDXåœ¨é¡¶å±‚ç›®æ ‡ä¸Šä¸€è‡´ï¼Œéƒ½æ˜¯ä¿æŠ¤VMä¸å—VMMçš„ä¾µå®³ã€‚å®ƒä»¬åœ¨æŠ€æœ¯å®ç°ç»†èŠ‚ã€æ€§èƒ½å¼€é”€å’Œç”Ÿæ€ç³»ç»Ÿæ”¯æŒä¸Šå„æœ‰åƒç§‹ã€‚å°†ä¸¤è€…å¹¶åˆ—çœ‹å¾…ï¼Œæ›´èƒ½ä½“ç°æœºå¯†è™šæ‹ŸåŒ–æŠ€æœ¯çš„å…¨è²Œã€‚</li></ul><h3 id="4-CSVæœºå¯†è®¡ç®—-åŸºäºæµ·å…‰-CPU"><a href="#4-CSVæœºå¯†è®¡ç®—-åŸºäºæµ·å…‰-CPU" class="headerlink" title="4. CSVæœºå¯†è®¡ç®— (åŸºäºæµ·å…‰ CPU)"></a>4. CSVæœºå¯†è®¡ç®— (åŸºäºæµ·å…‰ CPU)</h3><ul><li><strong>æ¦‚å¿µ</strong>ï¼šè¿™åŒæ ·æ˜¯ä¸€ç§<strong>IaaS</strong>æ–¹æ¡ˆï¼Œé‡‡ç”¨å›½äº§æµ·å…‰CPUçš„<strong>China Secure Virtualization</strong>æŠ€æœ¯ï¼Œæä¾›ä¸AMD SEVã€Intel TDXåŠŸèƒ½å¯¹æ ‡çš„æœºå¯†è™šæ‹Ÿæœºã€‚</li><li><strong>æ–¹æ¡ˆ</strong>ï¼šäº‘å‚å•†æä¾›åŸºäºæµ·å…‰g7hç­‰ç‰¹å®šè§„æ ¼æ—çš„CSVå®ä¾‹ã€‚ç”¨æˆ·å¯ä»¥å°†ç°æœ‰åº”ç”¨ç›´æ¥è¿ç§»è‡³CSVå®ä¾‹ï¼Œä»¥é˜²å¾¡æ¥è‡ªäº‘å¹³å°ç­‰é«˜æƒé™è§’è‰²çš„æ”»å‡»ã€‚</li><li><strong>åŒºåˆ«</strong>ï¼šæ­¤æ–¹æ¡ˆçš„æ ¸å¿ƒæ˜¯é‡‡ç”¨äº†å›½äº§åŒ–çš„CPUç¡¬ä»¶ä½œä¸ºä¿¡ä»»æ ¹ã€‚ä»å…¬å¼€æ–‡æ¡£æ¥çœ‹ï¼Œå…¶ä¸Šå±‚è½¯ä»¶æ¥å£ä¸AMD SEVæŠ€æœ¯æ ˆä¿æŒäº†è¾ƒé«˜çš„å…¼å®¹æ€§ï¼Œä½†åº•å±‚æ˜¯ç”±æµ·å…‰CPUçš„å®‰å…¨å¤„ç†å™¨ï¼ˆPlatform Security Processorï¼‰æä¾›æ”¯æŒã€‚è¿™æ˜¯ä¸€ä¸ªåœ¨è‡ªä¸»å¯æ§ä¾›åº”é“¾èƒŒæ™¯ä¸‹çš„é‡è¦TEEå®ç°ã€‚ <a href="https://help.aliyun.com/zh/ecs/user-guide/build-csv-encrypted-computing-environment?spm=a2c4g.11186623.0.i3">æ¥æºï¼šé˜¿é‡Œäº‘æ–‡æ¡£</a></li></ul><h3 id="5-å¼‚æ„æœºå¯†è®¡ç®—-Heterogeneous-Confidential-Computing"><a href="#5-å¼‚æ„æœºå¯†è®¡ç®—-Heterogeneous-Confidential-Computing" class="headerlink" title="5. å¼‚æ„æœºå¯†è®¡ç®— (Heterogeneous Confidential Computing)"></a>5. å¼‚æ„æœºå¯†è®¡ç®— (Heterogeneous Confidential Computing)</h3><ul><li><strong>æ¦‚å¿µ</strong>ï¼šè¿™å¹¶éä¸€ç§å…·ä½“çš„äº§å“ï¼Œè€Œæ˜¯ä¸€ç§<strong>è§£å†³æ–¹æ¡ˆæ¶æ„</strong>ã€‚å®ƒæ—¨åœ¨å°†ä¸åŒç±»å‹çš„TEEï¼ˆå¦‚SGXã€TDXã€SEVï¼‰ä¸éTEEçš„åŠ é€Ÿè®¡ç®—å•å…ƒï¼ˆå¦‚GPUã€FPGAï¼‰ç­‰å¼‚æ„èµ„æºç»„åˆèµ·æ¥ï¼Œä»¥æ»¡è¶³å¤æ‚ä¸šåŠ¡åœºæ™¯ä¸‹å¯¹å®‰å…¨å’Œæ€§èƒ½çš„åŒé‡éœ€æ±‚ã€‚</li><li><strong>æ–¹æ¡ˆ</strong>ï¼šä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ªä¸šåŠ¡æµä¸­ï¼Œä½¿ç”¨SGX Enclaveæ¥å®‰å…¨åœ°ç®¡ç†å’Œåˆ†å‘AIæ¨¡å‹çš„å¯†é’¥ï¼Œç„¶åå°†å¯†é’¥å’ŒåŠ å¯†çš„æ¨¡å‹æ•°æ®äº¤ç»™ä¸€å°TDXæˆ–SEV-SNPæœºå¯†è™šæ‹Ÿæœºï¼Œåœ¨VMå†…è§£å¯†æ¨¡å‹å¹¶ä½¿ç”¨GPUè¿›è¡Œé«˜æ€§èƒ½çš„åŠ å¯†æ¨ç†ã€‚</li><li><strong>åŒºåˆ«</strong>ï¼šå®ƒæ˜¯ä¸€ç§æ›´çµæ´»ã€æ›´é«˜æ•ˆçš„ç»„åˆæ¨¡å¼ï¼Œæ—¨åœ¨ä¸ºAIã€å¤§æ•°æ®ç­‰å¤æ‚åœºæ™¯æä¾›ç«¯åˆ°ç«¯çš„ã€æ€§èƒ½ä¸å®‰å…¨å…¼é¡¾çš„è§£å†³æ–¹æ¡ˆã€‚</li></ul><h3 id="6-æœºå¯†å®¹å™¨-Confidential-Containers"><a href="#6-æœºå¯†å®¹å™¨-Confidential-Containers" class="headerlink" title="6. æœºå¯†å®¹å™¨ (Confidential Containers)"></a>6. æœºå¯†å®¹å™¨ (Confidential Containers)</h3><ul><li><strong>æ¦‚å¿µ</strong>: è¿™æ˜¯ä¸€ç§æ›´ä¸Šå±‚çš„ã€<strong>PaaSï¼ˆå¹³å°å³æœåŠ¡ï¼‰</strong>åŒ–çš„æ–¹æ¡ˆï¼Œä¹Ÿæ˜¯ç›®å‰ä¸šç•Œçš„çƒ­ç‚¹æ–¹å‘ã€‚å®ƒå°†åº•å±‚çš„SGXã€TDXã€SEVç­‰ç¡¬ä»¶ç»†èŠ‚å®Œå…¨å°è£…èµ·æ¥ï¼Œä¸ºå¼€å‘è€…æä¾›ä¸€ä¸ªæ¥è¿‘æ ‡å‡†å®¹å™¨ï¼ˆå¦‚Dockerï¼‰çš„è¿è¡Œç¯å¢ƒã€‚</li><li><strong>æ–¹æ¡ˆ</strong>: å¼€å‘è€…ä¸å†ç›´æ¥æ“ä½œè™šæ‹Ÿæœºæˆ–TEE SDKï¼Œè€Œæ˜¯å°†ä»–ä»¬çš„åº”ç”¨æ‰“åŒ…æˆä¸€ä¸ªæ ‡å‡†çš„å®¹å™¨é•œåƒã€‚äº‘å¹³å°åˆ™è´Ÿè´£åœ¨ä¸€ä¸ªæœºå¯†çš„ï¼ˆåŠ å¯†å’Œéš”ç¦»çš„ï¼‰ç¯å¢ƒä¸­å¯åŠ¨è¿™ä¸ªå®¹å™¨ï¼Œç¡®ä¿å®¹å™¨è¿è¡Œæ—¶ä¸å®¿ä¸»æœºç¯å¢ƒå®Œå…¨éš”ç¦»ã€‚è¿™ä¸ªè¿‡ç¨‹å¯¹å¼€å‘è€…æ¥è¯´æ˜¯é€æ˜çš„ã€‚</li><li><strong>åŒºåˆ«</strong>: è¿™æ˜¯å¯¹æœºå¯†è®¡ç®—<strong>æ˜“ç”¨æ€§çš„ç»ˆæè¿½æ±‚</strong>ã€‚å®ƒå®Œå…¨æŠ½è±¡äº†åº•å±‚ç¡¬ä»¶çš„å¤æ‚æ€§ï¼Œè®©å¼€å‘è€…å¯ä»¥é›¶ä»£ç ä¿®æ”¹åœ°äº«å—TEEå¸¦æ¥çš„å®‰å…¨ä¼˜åŠ¿ã€‚ç›¸æ¯”IaaSå½¢æ€çš„æœºå¯†è™šæ‹Ÿæœºï¼Œå®ƒç‰ºç‰²äº†ä¸€éƒ¨åˆ†çµæ´»æ€§ï¼Œæ¢æ¥äº†æœ€é«˜çš„å¼€å‘æ•ˆç‡å’Œä¸äº‘åŸç”Ÿç”Ÿæ€çš„æœ€ä½³é›†æˆï¼Œæ˜¯Serverlessã€å¾®æœåŠ¡ç­‰ç°ä»£åº”ç”¨æ¶æ„ä¸æœºå¯†è®¡ç®—ç»“åˆçš„ç†æƒ³æ¨¡å¼ã€‚</li></ul><h2 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h2><p>ä¿æŠ¤â€ä½¿ç”¨ä¸­æ•°æ®â€çš„æŒ‘æˆ˜ï¼Œæ­£è¢«ä»¥ç¡¬ä»¶ä¸ºæ ¹åŸºçš„TEEæŠ€æœ¯æ‰€å…‹æœã€‚ä»TMEçš„ç‰©ç†é˜²å¾¡ï¼Œåˆ°SGXçš„ç²¾ç»†åŒ–ä¿æŠ¤ï¼Œå†åˆ°TDXä¸SEV-SNPé¢å‘äº‘çš„æ˜“ç”¨æ€§æ¼”è¿›ï¼Œå…¶å®æˆ‘ä»¬çœ‹åˆ°äº†ä¸€æ¡æ¸…æ™°çš„æŠ€æœ¯å‘å±•è„‰ç»œã€‚å¯¹äºæˆ‘ä»¬æŠ€æœ¯å¼€å‘è€…è€Œè¨€ï¼Œç†è§£ä¸åŒæ–¹æ¡ˆçš„åŸç†ã€è¾¹ç•Œå’Œé€‚ç”¨åœºæ™¯ï¼Œæ˜¯æ„å»ºä¸‹ä¸€ä»£å®‰å…¨æ¶æ„çš„å…³é”®ã€‚å•ä¸€æŠ€æœ¯ä»æ¥ä¸æ˜¯é“¶å¼¹ï¼Œæˆ‘ä»¬æ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼Œçµæ´»åœ°ç»„åˆè¿ç”¨è¿™äº›æœºå¯†è®¡ç®—â€ç§¯æœ¨â€ï¼Œå°†æˆä¸ºå¸¸æ€ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å¤§æ•°æ® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> TME </tag>
            
            <tag> SGX </tag>
            
            <tag> TDX </tag>
            
            <tag> TEE </tag>
            
            <tag> éšç§è®¡ç®— </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è°æ¥ä¿è¯InnoDBçš„åŸå­æ€§ã€ä¸€è‡´æ€§ä¸æŒä¹…æ€§çš„ï¼Ÿ</title>
      <link href="/2025/06/24/redo%20log%E3%80%81undo%20log%20%E5%A6%82%E4%BD%95%E4%BF%9D%E9%9A%9C%20InnoDB%20%E4%BA%8B%E5%8A%A1/"/>
      <url>/2025/06/24/redo%20log%E3%80%81undo%20log%20%E5%A6%82%E4%BD%95%E4%BF%9D%E9%9A%9C%20InnoDB%20%E4%BA%8B%E5%8A%A1/</url>
      
        <content type="html"><![CDATA[<h1 id="è°æ¥ä¿è¯InnoDBçš„åŸå­æ€§ã€ä¸€è‡´æ€§ä¸æŒä¹…æ€§çš„ï¼Ÿ"><a href="#è°æ¥ä¿è¯InnoDBçš„åŸå­æ€§ã€ä¸€è‡´æ€§ä¸æŒä¹…æ€§çš„ï¼Ÿ" class="headerlink" title="è°æ¥ä¿è¯InnoDBçš„åŸå­æ€§ã€ä¸€è‡´æ€§ä¸æŒä¹…æ€§çš„ï¼Ÿ"></a>è°æ¥ä¿è¯InnoDBçš„åŸå­æ€§ã€ä¸€è‡´æ€§ä¸æŒä¹…æ€§çš„ï¼Ÿ</h1><h2 id="ä¸€ã€äº‹åŠ¡çš„-ACID-ç‰¹æ€§ä¸æ—¥å¿—çš„è§’è‰²"><a href="#ä¸€ã€äº‹åŠ¡çš„-ACID-ç‰¹æ€§ä¸æ—¥å¿—çš„è§’è‰²" class="headerlink" title="ä¸€ã€äº‹åŠ¡çš„ ACID ç‰¹æ€§ä¸æ—¥å¿—çš„è§’è‰²"></a>ä¸€ã€äº‹åŠ¡çš„ ACID ç‰¹æ€§ä¸æ—¥å¿—çš„è§’è‰²</h2><p>InnoDBä¸­çš„äº‹åŠ¡å®Œå…¨ç¬¦åˆ ACID ç‰¹æ€§ï¼Œå³</p><p>â— <strong>åŸå­æ€§</strong>ï¼šåŸå­æ€§æ˜¯æŒ‡æ•´ä¸ªæ•°æ®åº“äº‹åŠ¡æ˜¯ä¸å¯åˆ†å‰²çš„å·¥ä½œå•ä½ã€‚åªæœ‰ äº‹åŠ¡ä¸­æ‰€æœ‰çš„æ•°æ®åº“æ“ä½œéƒ½æ‰§è¡ŒæˆåŠŸï¼Œæ‰ç®—æ•´ä¸ªäº‹åŠ¡æˆåŠŸã€‚å¦‚æœäº‹åŠ¡ä¸­ä»»ä½•ä¸€ä¸ªæ“ä½œæ‰§è¡Œå¤±è´¥ï¼Œåˆ™å·²ç»æ‰§è¡ŒæˆåŠŸçš„æ“ä½œä¹Ÿå¿…é¡»æ’¤é”€ï¼Œå°†æ•°æ®åº“çŠ¶æ€é€€å›åˆ°æ‰§è¡Œäº‹åŠ¡ä¹‹å‰ã€‚<br>â— <strong>ä¸€è‡´æ€§</strong>ï¼šäº‹åŠ¡å¼€å§‹ä¹‹å‰å’Œäº‹åŠ¡ç»“æŸä»¥åï¼Œæ•°æ®åº“çš„å®Œæ•´æ€§çº¦æŸæ²¡æœ‰è¢«ç ´åã€‚<br>â— <strong>éš”ç¦»æ€§</strong>ï¼šäº‹åŠ¡çš„éš”ç¦»æ€§è¦æ±‚æ¯ä¸ªè¯»å†™äº‹åŠ¡çš„å¯¹è±¡å¯¹å…¶ä»–äº‹åŠ¡çš„æ“ä½œå¯¹è±¡èƒ½ç›¸äº’åˆ†ç¦»ï¼Œå³åœ¨äº‹åŠ¡æäº¤å‰å¯¹å…¶ä»–äº‹åŠ¡ä¸å¯è§ã€‚<br>â— <strong>æŒä¹…æ€§</strong>ï¼šäº‹åŠ¡ä¸€æ—¦æäº¤ï¼Œå…¶ç»“æœæ˜¯æ°¸ä¹…æ€§çš„ã€‚å³ä½¿å‘ç”Ÿå®•æœºç­‰æ•…éšœï¼Œæ•°æ®åº“ä¹Ÿèƒ½å°†æ•°æ®æ¢å¤ã€‚è¿™ç§ä¿è¯ï¼Œæ˜¯ä»äº‹åŠ¡è§’åº¦æ¥ä¿è¯ç»“æœçš„æ°¸ä¹…æ€§çš„ã€‚ä¸æ˜¯è¯´ï¼Œæ‰€æœ‰çš„ç¡¬ç›˜éƒ½æŸåä¹Ÿå¯ä»¥ä¿è¯æ•°æ®ä¸ä¸¢å¤±ã€‚</p><p>äº‹åŠ¡çš„éš”ç¦»æ€§æ˜¯ç”± é”ã€MVCCå®ç°çš„ã€‚è€ŒåŸå­æ€§ã€ä¸€è‡´æ€§å’ŒæŒä¹…æ€§ï¼Œåˆ™æ˜¯ç”± <code>redo log</code> å’Œ <code>undo log</code> ååŒå®ç°çš„ï¼š</p><ul><li>**åŸå­æ€§ (Atomicity)**ï¼šä¸»è¦ç”± <code>undo log</code> æ¥ä¿è¯ã€‚å½“äº‹åŠ¡éœ€è¦å›æ»šæ—¶ï¼Œç³»ç»Ÿä¼šåˆ©ç”¨<code>undo log</code>è®°å½•çš„â€åå‘â€æ“ä½œï¼Œå°†æ•°æ®æ¢å¤åˆ°äº‹åŠ¡å¼€å§‹å‰çš„çŠ¶æ€ï¼Œå®ç°â€å…¨æœ‰æˆ–å…¨æ— â€çš„æ•ˆæœã€‚</li><li>**æŒä¹…æ€§ (Durability)**ï¼šä¸»è¦ç”± <code>redo log</code> æ¥ä¿è¯ã€‚å½“äº‹åŠ¡æäº¤æ—¶ï¼Œ<code>redo log</code> å¿…é¡»è¢«æŒä¹…åŒ–åˆ°ç£ç›˜ã€‚å³ä½¿æ•°æ®åº“å‘ç”Ÿå®•æœºï¼Œä¹Ÿå¯ä»¥é€šè¿‡ <code>redo log</code> æ¢å¤å·²æäº¤äº‹åŠ¡çš„ä¿®æ”¹ï¼Œç¡®ä¿æ•°æ®ä¸ä¸¢å¤±ã€‚</li><li>**ä¸€è‡´æ€§ (Consistency)**ï¼šä¸€è‡´æ€§æ˜¯ä¸€ä¸ªæ›´å®è§‚çš„æ¦‚å¿µï¼Œå®ƒå»ºç«‹åœ¨åŸå­æ€§å’ŒæŒä¹…æ€§ä¹‹ä¸Šã€‚æ•°æ®åº“çš„çº¦æŸï¼ˆå¦‚ä¸»é”®ã€å¤–é”®ï¼‰ä¿è¯äº†æ•°æ®è§„åˆ™çš„æ­£ç¡®ï¼Œè€Œ <code>undo log</code> å’Œ <code>redo log</code> åˆ™ä¿è¯äº†äº‹åŠ¡æœ¬èº«è¦ä¹ˆå®Œæ•´åœ°ä»ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€è½¬æ¢åˆ°å¦ä¸€ä¸ªï¼Œè¦ä¹ˆåœ¨å¤±è´¥æ—¶å®Œå…¨é€€å›ï¼Œä¸ä¼šç•™ä¸‹ä¸­é—´çŠ¶æ€ã€‚</li></ul><pre class="mermaid">graph TD;    subgraph InnoDBå®ç°æœºåˆ¶        UndoLog["undo log"];        RedoLog["redo log"];        Locking["é” & MVCC"];    end    subgraph äº‹åŠ¡ç‰¹æ€§ACID        A(åŸå­æ€§ Atomicity);        C(ä¸€è‡´æ€§ Consistency);        I(éš”ç¦»æ€§ Isolation);        D(æŒä¹…æ€§ Durability);    end    UndoLog -- "ä¿è¯" --> A;    UndoLog -- "ä¿è¯" --> C;    RedoLog -- "ä¿è¯" --> A;    RedoLog -- "ä¿è¯" --> D;    Locking -- "ä¿è¯" --> I;</pre><h2 id="äºŒã€redo-logï¼šä¿è¯äº‹åŠ¡æŒä¹…æ€§çš„å…³é”®"><a href="#äºŒã€redo-logï¼šä¿è¯äº‹åŠ¡æŒä¹…æ€§çš„å…³é”®" class="headerlink" title="äºŒã€redo logï¼šä¿è¯äº‹åŠ¡æŒä¹…æ€§çš„å…³é”®"></a>äºŒã€redo logï¼šä¿è¯äº‹åŠ¡æŒä¹…æ€§çš„å…³é”®</h2><p>undo ä¸æ˜¯ redo çš„é€†è¿‡ç¨‹ã€‚redo å’Œ undo çš„ä½œç”¨éƒ½å¯ä»¥è§†ä¸ºæ˜¯ä¸€ç§æ¢å¤æ“ä½œã€‚redo æ¢å¤æäº¤äº‹åŠ¡ä¿®æ”¹çš„é¡µæ“ä½œï¼Œæ‰€ä»¥é€šå¸¸æ˜¯ ç‰©ç†æ—¥å¿—ã€‚è€Œ undo å›æ»šè¡Œè®°å½•åˆ°æŸä¸ªç‰¹å®šç‰ˆæœ¬ï¼Œå…¶å­˜å‚¨çš„æ˜¯é€»è¾‘æ—¥å¿—ï¼Œæ ¹æ®æ¯è¡Œè®°å½•è¿›è¡Œè®°å½•ã€‚</p><h3 id="2-1-redo-log-çš„è¯ç”ŸèƒŒæ™¯"><a href="#2-1-redo-log-çš„è¯ç”ŸèƒŒæ™¯" class="headerlink" title="2.1 redo log çš„è¯ç”ŸèƒŒæ™¯"></a>2.1 redo log çš„è¯ç”ŸèƒŒæ™¯</h3><p>æˆ‘ä»¬çŸ¥é“InnoDBå­˜å‚¨å¼•æ“æ˜¯ä»¥é¡µä¸ºå•ä½æ¥ç®¡ç†å­˜å‚¨ç©ºé—´çš„ï¼Œæˆ‘ä»¬è¿›è¡Œçš„å¢åˆ æ”¹æŸ¥æ“ä½œå…¶å®æœ¬è´¨ä¸Šéƒ½æ˜¯åœ¨è®¿é—®é¡µé¢ï¼ˆåŒ…æ‹¬è¯»é¡µé¢ã€å†™é¡µé¢ã€åˆ›å»ºæ–°é¡µé¢ç­‰æ“ä½œï¼‰ã€‚æˆ‘ä»¬å‰é¢ä»‹ç»Buffer Poolçš„æ—¶å€™è¯´è¿‡ï¼Œåœ¨çœŸæ­£è®¿é—®é¡µé¢ä¹‹å‰ï¼Œéœ€è¦æŠŠåœ¨ç£ç›˜ä¸Šçš„é¡µç¼“å­˜åˆ°å†…å­˜ä¸­çš„Buffer Poolä¹‹åæ‰å¯ä»¥è®¿é—®ã€‚ä½†æ˜¯åœ¨ä»‹ç»äº‹åŠ¡çš„æ—¶å€™åˆå¼ºè°ƒè¿‡ä¸€ä¸ªç§°ä¹‹ä¸ºæŒä¹…æ€§çš„ç‰¹æ€§ï¼Œå°±æ˜¯è¯´å¯¹äºä¸€ä¸ªå·²ç»æäº¤çš„äº‹åŠ¡ï¼Œåœ¨äº‹åŠ¡æäº¤åå³ä½¿ç³»ç»Ÿå‘ç”Ÿäº†å´©æºƒï¼Œè¿™ä¸ªäº‹åŠ¡å¯¹æ•°æ®åº“ä¸­æ‰€åšçš„æ›´æ”¹ä¹Ÿä¸èƒ½ä¸¢å¤±ã€‚ä½†æ˜¯å¦‚æœæˆ‘ä»¬åªåœ¨å†…å­˜çš„Buffer Poolä¸­ä¿®æ”¹äº†é¡µé¢ï¼Œå‡è®¾åœ¨äº‹åŠ¡æäº¤åçªç„¶å‘ç”Ÿäº†æŸä¸ªæ•…éšœï¼Œå¯¼è‡´å†…å­˜ä¸­çš„æ•°æ®éƒ½å¤±æ•ˆäº†ï¼Œé‚£ä¹ˆè¿™ä¸ªå·²ç»æäº¤äº†çš„äº‹åŠ¡å¯¹æ•°æ®åº“ä¸­æ‰€åšçš„æ›´æ”¹ä¹Ÿå°±è·Ÿç€ä¸¢å¤±äº†ï¼Œè¿™æ˜¯æˆ‘ä»¬æ‰€ä¸èƒ½å¿å—çš„ï¼ˆæƒ³æƒ³ATMæœºå·²ç»æç¤ºç‹—å“¥è½¬è´¦æˆåŠŸï¼Œä½†ä¹‹åç”±äºæœåŠ¡å™¨å‡ºç°æ•…éšœï¼Œé‡å¯ä¹‹åçŒ«çˆ·å‘ç°è‡ªå·±æ²¡æ”¶åˆ°é’±ï¼ŒçŒ«çˆ·å°±è¢«ç æ­»äº†ï¼‰ã€‚é‚£ä¹ˆå¦‚ä½•ä¿è¯è¿™ä¸ªæŒä¹…æ€§å‘¢ï¼Ÿä¸€ä¸ªå¾ˆç®€å•çš„åšæ³•å°±æ˜¯åœ¨äº‹åŠ¡æäº¤å®Œæˆä¹‹å‰æŠŠè¯¥äº‹åŠ¡æ‰€ä¿®æ”¹çš„æ‰€æœ‰é¡µé¢éƒ½åˆ·æ–°åˆ°ç£ç›˜ï¼Œä½†æ˜¯è¿™ä¸ªç®€å•ç²—æš´çš„åšæ³•æœ‰äº›é—®é¢˜ï¼š</p><p>â—  <strong>åˆ·æ–°ä¸€ä¸ªå®Œæ•´çš„æ•°æ®é¡µå¤ªæµªè´¹äº†</strong><br>æœ‰æ—¶å€™æˆ‘ä»¬ä»…ä»…ä¿®æ”¹äº†æŸä¸ªé¡µé¢ä¸­çš„ä¸€ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯æˆ‘ä»¬çŸ¥é“åœ¨InnoDBä¸­æ˜¯ä»¥é¡µä¸ºå•ä½æ¥è¿›è¡Œç£ç›˜IOçš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åœ¨è¯¥äº‹åŠ¡æäº¤æ—¶ä¸å¾—ä¸å°†ä¸€ä¸ªå®Œæ•´çš„é¡µé¢ä»å†…å­˜ä¸­åˆ·æ–°åˆ°ç£ç›˜ï¼Œæˆ‘ä»¬åˆçŸ¥é“ä¸€ä¸ªé¡µé¢é»˜è®¤æ˜¯16KBå¤§å°ï¼Œåªä¿®æ”¹ä¸€ä¸ªå­—èŠ‚å°±è¦åˆ·æ–°16KBçš„æ•°æ®åˆ°ç£ç›˜ä¸Šæ˜¾ç„¶æ˜¯å¤ªæµªè´¹äº†ã€‚<br>â—  <strong>éšæœºIOåˆ·èµ·æ¥æ¯”è¾ƒæ…¢</strong><br>ä¸€ä¸ªäº‹åŠ¡å¯èƒ½åŒ…å«å¾ˆå¤šè¯­å¥ï¼Œå³ä½¿æ˜¯ä¸€æ¡è¯­å¥ä¹Ÿå¯èƒ½ä¿®æ”¹è®¸å¤šé¡µé¢ï¼Œå€’éœ‰å‚¬çš„æ˜¯è¯¥äº‹åŠ¡ä¿®æ”¹çš„è¿™äº›é¡µé¢å¯èƒ½å¹¶ä¸ç›¸é‚»ï¼Œè¿™å°±æ„å‘³ç€åœ¨å°†æŸä¸ªäº‹åŠ¡ä¿®æ”¹çš„Buffer Poolä¸­çš„é¡µé¢åˆ·æ–°åˆ°ç£ç›˜æ—¶ï¼Œéœ€è¦è¿›è¡Œå¾ˆå¤šçš„éšæœºIOï¼ŒéšæœºIOæ¯”é¡ºåºIOè¦æ…¢ï¼Œå°¤å…¶å¯¹äºä¼ ç»Ÿçš„æœºæ¢°ç¡¬ç›˜æ¥è¯´ã€‚ </p><p>å’‹åŠå‘¢ï¼Ÿå†æ¬¡å›åˆ°æˆ‘ä»¬çš„åˆå¿ƒï¼šæˆ‘ä»¬åªæ˜¯æƒ³è®©å·²ç»æäº¤äº†çš„äº‹åŠ¡å¯¹æ•°æ®åº“ä¸­æ•°æ®æ‰€åšçš„ä¿®æ”¹æ°¸ä¹…ç”Ÿæ•ˆï¼Œå³ä½¿åæ¥ç³»ç»Ÿå´©æºƒï¼Œåœ¨é‡å¯åä¹Ÿèƒ½æŠŠè¿™ç§ä¿®æ”¹æ¢å¤å‡ºæ¥ã€‚æ‰€ä»¥æˆ‘ä»¬å…¶å®æ²¡æœ‰å¿…è¦åœ¨æ¯æ¬¡äº‹åŠ¡æäº¤æ—¶å°±æŠŠè¯¥äº‹åŠ¡åœ¨å†…å­˜ä¸­ä¿®æ”¹è¿‡çš„å…¨éƒ¨é¡µé¢åˆ·æ–°åˆ°ç£ç›˜ï¼Œåªéœ€è¦æŠŠä¿®æ”¹äº†å“ªäº›ä¸œè¥¿è®°å½•ä¸€ä¸‹å°±å¥½ï¼Œæ¯”æ–¹è¯´æŸä¸ªäº‹åŠ¡å°†ç³»ç»Ÿè¡¨ç©ºé—´ä¸­çš„ç¬¬100å·é¡µé¢ä¸­åç§»é‡ä¸º1000å¤„çš„é‚£ä¸ªå­—èŠ‚çš„å€¼1æ”¹æˆ2æˆ‘ä»¬åªéœ€è¦è®°å½•ä¸€ä¸‹ï¼š</p><blockquote><p>å°†ç¬¬0å·è¡¨ç©ºé—´çš„100å·é¡µé¢çš„åç§»é‡ä¸º1000å¤„çš„å€¼æ›´æ–°ä¸º2ã€‚</p></blockquote><p>è¿™æ ·æˆ‘ä»¬åœ¨äº‹åŠ¡æäº¤æ—¶ï¼ŒæŠŠä¸Šè¿°å†…å®¹åˆ·æ–°åˆ°ç£ç›˜ä¸­ï¼Œå³ä½¿ä¹‹åç³»ç»Ÿå´©æºƒäº†ï¼Œé‡å¯ä¹‹ååªè¦æŒ‰ç…§ä¸Šè¿°å†…å®¹æ‰€è®°å½•çš„æ­¥éª¤é‡æ–°æ›´æ–°ä¸€ä¸‹æ•°æ®é¡µï¼Œé‚£ä¹ˆè¯¥äº‹åŠ¡å¯¹æ•°æ®åº“ä¸­æ‰€åšçš„ä¿®æ”¹åˆå¯ä»¥è¢«æ¢å¤å‡ºæ¥ï¼Œä¹Ÿå°±æ„å‘³ç€æ»¡è¶³æŒä¹…æ€§çš„è¦æ±‚ã€‚å› ä¸ºåœ¨ç³»ç»Ÿå¥”æºƒé‡å¯æ—¶éœ€è¦æŒ‰ç…§ä¸Šè¿°å†…å®¹æ‰€è®°å½•çš„æ­¥éª¤é‡æ–°æ›´æ–°æ•°æ®é¡µï¼Œæ‰€ä»¥ä¸Šè¿°å†…å®¹ä¹Ÿè¢«ç§°ä¹‹ä¸ºé‡åšæ—¥å¿—ï¼Œè‹±æ–‡åä¸ºredo logï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœŸæ´‹ç»“åˆï¼Œç§°ä¹‹ä¸ºredoæ—¥å¿—ã€‚ä¸åœ¨äº‹åŠ¡æäº¤æ—¶å°†æ‰€æœ‰ä¿®æ”¹è¿‡çš„å†…å­˜ä¸­çš„é¡µé¢åˆ·æ–°åˆ°ç£ç›˜ä¸­ç›¸æ¯”ï¼Œåªå°†è¯¥äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„redoæ—¥å¿—åˆ·æ–°åˆ°ç£ç›˜çš„å¥½å¤„å¦‚ä¸‹ï¼š</p><p>â—  <strong>redoæ—¥å¿—å ç”¨çš„ç©ºé—´éå¸¸å°</strong><br>å­˜å‚¨è¡¨ç©ºé—´IDã€é¡µå·ã€åç§»é‡ä»¥åŠéœ€è¦æ›´æ–°çš„å€¼æ‰€éœ€çš„å­˜å‚¨ç©ºé—´æ˜¯å¾ˆå°çš„ï¼Œå…³äºredoæ—¥å¿—çš„æ ¼å¼æˆ‘ä»¬ç¨åä¼šè¯¦ç»†ä»‹ç»ï¼Œç°åœ¨åªè¦çŸ¥é“ä¸€æ¡redoæ—¥å¿—å ç”¨çš„ç©ºé—´ä¸æ˜¯å¾ˆå¤§å°±å¥½äº†ã€‚<br>â—  <strong>redoæ—¥å¿—æ˜¯é¡ºåºå†™å…¥ç£ç›˜çš„</strong><br>åœ¨æ‰§è¡Œäº‹åŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œæ¯æ‰§è¡Œä¸€æ¡è¯­å¥ï¼Œå°±å¯èƒ½äº§ç”Ÿè‹¥å¹²æ¡redoæ—¥å¿—ï¼Œè¿™äº›æ—¥å¿—æ˜¯æŒ‰ç…§äº§ç”Ÿçš„é¡ºåºå†™å…¥ç£ç›˜çš„ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨é¡ºåºIOã€‚ </p><p>ä¸Šé¢å†…å®¹éƒ¨åˆ†æ‘˜è‡ª ã€ŠMySQLæ˜¯æ€ä¹ˆè¿è¡Œçš„ï¼Ÿã€‹ï¼Œä¸Šé¢æˆ‘ä»¬åªæåˆ°äº†ç®€å•çš„redoæ—¥å¿—ç±»å‹ã€‚ä½†æ˜¯å®é™…æƒ…å†µä¸‹ï¼Œä¸€æ¡SQLè¯­å¥ä¼šæ¶‰åŠåˆ°å¾ˆå¤šé¡µä¸­å†…å®¹çš„ä¿®æ”¹ï¼Œæ‰€ä»¥åˆæœ‰å¾ˆå¤šå…¶ä»–å¤æ‚çš„ redoæ—¥å¿—ç±»å‹ï¼Œå¸®åŠ©å»è§£å†³è¿™ä¸ªé—®é¢˜ã€‚è¿™é‡Œå°±ä¸è¯´å¤ªå¤šã€‚</p><h3 id="2-2-redo-log-çš„å†…éƒ¨ç»“æ„ï¼šlog-block-ä¸-log-buffer"><a href="#2-2-redo-log-çš„å†…éƒ¨ç»“æ„ï¼šlog-block-ä¸-log-buffer" class="headerlink" title="2.2 redo log çš„å†…éƒ¨ç»“æ„ï¼šlog block ä¸ log buffer"></a>2.2 redo log çš„å†…éƒ¨ç»“æ„ï¼šlog block ä¸ log buffer</h3><p>ç®€å•redoæ—¥å¿—æ ¼å¼ä¸ºï¼šã€Œè¡¨ç©ºé—´å·+æ•°æ®é¡µå·+åç§»é‡+ä¿®æ”¹å‡ ä¸ªå­—èŠ‚çš„å€¼+å…·ä½“çš„å€¼ã€ï¼Œä½†æ˜¯redo log å¹¶ä¸æ˜¯ä¸€è¡Œä¸€è¡Œå†™å…¥ æ—¥å¿—æ–‡ä»¶çš„ã€‚å®ƒé‡‡ç”¨blockæ¥è¿›è¡Œç®¡ç†ï¼Œblockå†…éƒ¨åŒ…å«äº†12å­—èŠ‚çš„headerå—ï¼Œ496å­—èŠ‚çš„bodyå—ï¼Œå’Œ4å­—èŠ‚çš„trailerå—å°¾ã€‚</p><p>çœŸæ­£çš„redoæ—¥å¿—éƒ½æ˜¯å­˜å‚¨åˆ°å ç”¨496å­—èŠ‚å¤§å°çš„log block bodyä¸­ï¼Œå›¾ä¸­çš„log block headerå’Œlog block trailerå­˜å‚¨çš„æ˜¯ä¸€äº›ç®¡ç†ä¿¡æ¯ã€‚</p><p>è®¾è®¡InnoDBçš„å¤§ä½¬ä¸ºäº†è§£å†³ç£ç›˜é€Ÿåº¦è¿‡æ…¢çš„é—®é¢˜è€Œå¼•å…¥äº†Buffer Poolã€‚åŒç†ï¼Œå†™å…¥redoæ—¥å¿—æ—¶ä¹Ÿä¸èƒ½ç›´æ¥ç›´æ¥å†™åˆ°ç£ç›˜ä¸Šï¼Œå®é™…ä¸Šåœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶å°±å‘æ“ä½œç³»ç»Ÿç”³è¯·äº†ä¸€å¤§ç‰‡ç§°ä¹‹ä¸ºredo log bufferçš„è¿ç»­å†…å­˜ç©ºé—´ï¼Œç¿»è¯‘æˆä¸­æ–‡å°±æ˜¯redoæ—¥å¿—ç¼“å†²åŒºï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç®€ç§°ä¸ºlog bufferã€‚è¿™ç‰‡å†…å­˜ç©ºé—´è¢«åˆ’åˆ†æˆè‹¥å¹²ä¸ªè¿ç»­çš„redo log block</p><p>redo log æ—¥å¿—å…ˆæŒ‰ç…§ redo log block æ ¼å¼ï¼Œå†™å…¥åˆ°ç¼“å†²åŒºä¸­çš„ blockä¸­ï¼ˆredo log bufferï¼‰ï¼Œå†ç”± redo log buffer å†™å…¥åˆ°ç£ç›˜ã€‚<br>redo log buffer å¤§å°å¯ä»¥é€šè¿‡å‚æ•° innodb_log_buffer_size æ¥æŒ‡å®šã€‚MySQL5.7é»˜è®¤æ­¤å‚æ•°ä¸º16MBã€‚</p><pre class="mermaid">graph LR;    subgraph "å†…å­˜åŒºåŸŸ"        BufferPool["Buffer Pool<br/>(æ•°æ®é¡µç¼“å­˜)"];        LogBuffer["redo log buffer"];    end    subgraph "ç£ç›˜åŒºåŸŸ"        DataFile["æ•°æ®æ–‡ä»¶ (.ibd)"];        LogFile["redo log file"];    end    Client -- "1. å‘èµ·DML(UPDATE/INSERT/DELETE)" --> MySQL;    MySQL -- "2. ä¿®æ”¹Buffer Poolä¸­çš„æ•°æ®é¡µ" --> BufferPool;    BufferPool -- "3. ç”Ÿæˆredo log" --> LogBuffer;    MySQL -- "4. äº‹åŠ¡æäº¤ (COMMIT)" --> LogBuffer;    LogBuffer -- "5. åˆ·ç›˜ (fsync)" --> LogFile;    subgraph "åå°çº¿ç¨‹/å´©æºƒæ¢å¤"      BGThread["åå°çº¿ç¨‹"] -- "å¼‚æ­¥åˆ·è„é¡µ" --> DataFile;      CrashRecovery["MySQLé‡å¯/å´©æºƒæ¢å¤"] -- "è¯»å–redo logæ¢å¤æ•°æ®" --> LogFile;      CrashRecovery --> BufferPool;    end</pre><h3 id="2-3-redo-log-çš„åˆ·ç›˜ç­–ç•¥ï¼šwrite-ä¸-fsync"><a href="#2-3-redo-log-çš„åˆ·ç›˜ç­–ç•¥ï¼šwrite-ä¸-fsync" class="headerlink" title="2.3 redo log çš„åˆ·ç›˜ç­–ç•¥ï¼šwrite ä¸ fsync"></a>2.3 redo log çš„åˆ·ç›˜ç­–ç•¥ï¼šwrite ä¸ fsync</h3><p>é€šå¸¸æ¥è¯´ï¼Œredo log åˆ·ç›˜çš„æ—¶æœºæ˜¯åœ¨äº‹åŠ¡æäº¤çš„ commit é˜¶æ®µé‡‡å–çš„ã€‚åœ¨æ­¤ä¹‹å‰ redo log éƒ½å­˜åœ¨äº redo log bufferä¸­ã€‚</p><p>â— **åˆ·ç›˜(write)**ï¼šæŒ‡çš„æ˜¯MySQLä»buffer poolä¸­å°†å†…å®¹å†™åˆ°ç³»ç»Ÿçš„page cacheä¸­ï¼Œå¹¶æ²¡æœ‰æŒä¹…åŒ–åˆ°ç³»ç»Ÿç£ç›˜ä¸Šã€‚è¿™ä¸ªé€Ÿåº¦å…¶å®æ˜¯å¾ˆå¿«çš„ã€‚<br>â— **è½ç›˜(fsync)**ï¼šæŒ‡çš„æ˜¯ä»ç³»ç»Ÿçš„cacheä¸­å°†æ•°æ®æŒä¹…åŒ–åˆ°ç³»ç»Ÿç£ç›˜ä¸Šã€‚è¿™ä¸ªé€Ÿåº¦å¯ä»¥è®¤ä¸ºæ¯”è¾ƒæ…¢ï¼Œè€Œä¸”ä¹Ÿæ˜¯IOPSå‡é«˜çš„çœŸæ­£åŸå› ã€‚</p><p><strong>ç›¸å…³å‚æ•°</strong>ï¼š</p><p><code>innodb_flush_logs_at_trx_commit</code>ï¼ˆè¯¥å‚æ•°é’ˆå¯¹redo logï¼‰</p><p>â— <strong>å–å€¼0</strong>ï¼šæ¯æ¬¡æäº¤äº‹åŠ¡éƒ½åªæŠŠredo logç•™åœ¨redo log bufferä¸­ã€‚<br>â— <strong>å–å€¼1</strong>ï¼šæ¯æ¬¡æäº¤äº‹åŠ¡éƒ½å°†redo log æŒä¹…åŒ–åˆ°ç£ç›˜ä¸Šï¼Œä¹Ÿå°±æ˜¯write+fsync<br>â— <strong>å–å€¼2</strong>ï¼šæ¯æ¬¡éƒ½æŠŠredo logå†™åˆ°ç³»ç»Ÿçš„page cacheä¸­ï¼Œä¹Ÿå°±æ˜¯åªwriteï¼Œä¸fsync</p><p><code>sync_binlog</code>ï¼ˆè¯¥å‚æ•°é’ˆå¯¹binlogï¼‰</p><p>â— <strong>å–å€¼0</strong>ï¼šæ¯æ¬¡æäº¤éƒ½å°†binlog ä»binlog cacheä¸­ writeåˆ°ç£ç›˜ä¸Šï¼Œè€Œä¸fsyncåˆ°ç£ç›˜<br>â— <strong>å–å€¼1</strong>ï¼šæ¯æ¬¡æäº¤äº‹åŠ¡éƒ½å°†binlog fsyncåˆ°ç£ç›˜ä¸Š<br>â— <strong>å–å€¼N</strong>ï¼šæ¯æ¬¡æäº¤äº‹åŠ¡éƒ½å°†binlog writeåˆ°ç£ç›˜ä¸Šï¼Œç´¯è®¡Nä¸ªäº‹åŠ¡ä¹‹åï¼Œæ‰§è¡Œfsync</p><h2 id="ä¸‰ã€undo-logï¼šä¿éšœäº‹åŠ¡åŸå­æ€§ä¸ä¸€è‡´æ€§çš„åŸºçŸ³"><a href="#ä¸‰ã€undo-logï¼šä¿éšœäº‹åŠ¡åŸå­æ€§ä¸ä¸€è‡´æ€§çš„åŸºçŸ³" class="headerlink" title="ä¸‰ã€undo logï¼šä¿éšœäº‹åŠ¡åŸå­æ€§ä¸ä¸€è‡´æ€§çš„åŸºçŸ³"></a>ä¸‰ã€undo logï¼šä¿éšœäº‹åŠ¡åŸå­æ€§ä¸ä¸€è‡´æ€§çš„åŸºçŸ³</h2><p><code>undo log</code> ä¸»è¦æœ‰ä¸¤ä¸ªä½œç”¨ï¼š<strong>äº‹åŠ¡å›æ»š</strong> å’Œ <strong>MVCC</strong>ã€‚</p><ul><li><strong>äº‹åŠ¡å›æ»š</strong>ï¼šå½“äº‹åŠ¡æ‰§è¡Œå¤±è´¥æˆ–ç”¨æˆ·æ˜¾å¼æ‰§è¡Œ<code>ROLLBACK</code>æ—¶ï¼ŒInnoDBä¼šåˆ©ç”¨<code>undo log</code>ä¸­è®°å½•çš„é€»è¾‘â€åå‘â€æ“ä½œï¼Œå°†æ•°æ®æ¢å¤åˆ°äº‹åŠ¡å¼€å§‹å‰çš„çŠ¶æ€ï¼Œä»è€Œä¿è¯åŸå­æ€§ã€‚</li><li><strong>MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰</strong>ï¼šåœ¨è¯»å·²æäº¤ï¼ˆRead Committedï¼‰å’Œå¯é‡å¤è¯»ï¼ˆRepeatable Readï¼‰éš”ç¦»çº§åˆ«ä¸‹ï¼Œå½“ä¸€ä¸ªäº‹åŠ¡éœ€è¦è¯»å–è¢«å…¶ä»–æœªæäº¤äº‹åŠ¡ä¿®æ”¹çš„è¡Œæ—¶ï¼ŒInnoDBä¼šé€šè¿‡<code>undo log</code>æ‰¾åˆ°è¯¥è¡Œä¹‹å‰çš„ç‰ˆæœ¬ï¼Œä»è€Œå®ç°éé”å®šè¯»ï¼Œæé«˜å¹¶å‘æ€§èƒ½ã€‚</li></ul><p><code>undo log</code>è®°å½•çš„æ˜¯é€»è¾‘æ—¥å¿—ï¼Œä¾‹å¦‚ï¼š</p><ul><li>å¯¹<code>INSERT</code>æ“ä½œï¼Œ<code>undo log</code>è®°å½•ä¸€æ¡å¯¹åº”çš„<code>DELETE</code>æ“ä½œã€‚</li><li>å¯¹<code>DELETE</code>æ“ä½œï¼Œ<code>undo log</code>è®°å½•ä¸€æ¡å¯¹åº”çš„<code>INSERT</code>æ“ä½œã€‚</li><li>å¯¹<code>UPDATE</code>æ“ä½œï¼Œ<code>undo log</code>è®°å½•ä¸€æ¡ä¿®æ”¹ä¸ºæ—§å€¼çš„<code>UPDATE</code>æ“ä½œã€‚</li></ul><pre class="mermaid">graph TD    A["å¼€å§‹äº‹åŠ¡ (START TRANSACTION)"] --> B{"æ‰§è¡Œ UPDATE æ“ä½œ<br/>(ä¾‹å¦‚: age ä» 30 æ”¹ä¸º 31)"};    B -- "å†…éƒ¨ç”Ÿæˆ" --> C["Undo Log è®°å½•<br/>(è®°å½•ä¸€ä¸ªåå‘æ“ä½œ: age æ”¹å› 30)"];    B --> D{"äº‹åŠ¡ç»§ç»­æ‰§è¡Œå…¶ä»–æ“ä½œ"};    D -- "é€‰æ‹©æäº¤ (COMMIT)" --> E["æäº¤äº‹åŠ¡<br/>(æ­¤Undo Logå¯è¢«æ¸…ç†)"];    D -- "é€‰æ‹©å›æ»š (ROLLBACK)" --> F["å›æ»šäº‹åŠ¡"];    F -- "æ ¹æ®Undo Logæ¢å¤æ•°æ®" --> C;</pre><h2 id="å››ã€redo-log-ä¸-binlog-çš„æ•°æ®ä¸€è‡´æ€§ï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰"><a href="#å››ã€redo-log-ä¸-binlog-çš„æ•°æ®ä¸€è‡´æ€§ï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰" class="headerlink" title="å››ã€redo log ä¸ binlog çš„æ•°æ®ä¸€è‡´æ€§ï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰"></a>å››ã€redo log ä¸ binlog çš„æ•°æ®ä¸€è‡´æ€§ï¼ˆä¸¤é˜¶æ®µæäº¤ï¼‰</h2><p>binlog çš„ä¸€ä¸ªä¸»è¦åŠŸèƒ½å°±æ˜¯æ•°æ®åº“å»ºçš„ä¸»ä»åŒæ­¥ã€‚<br>binlog æ˜¯é»˜è®¤ä¸å¼€å¯çš„ã€‚ä½†æ˜¯å¦‚æœå¼€å¯äº† binlog åï¼Œå°±éœ€è¦æ³¨æ„ redolog ä¸ binlog çš„æ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚<strong>å¦‚æœæ²¡æœ‰ä¸¤é˜¶æ®µæäº¤æœºåˆ¶ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ</strong></p><ul><li><strong>åœºæ™¯ä¸€ï¼šå…ˆå†™ redo logï¼Œå†å†™ binlog</strong><ul><li>å¦‚æœ <code>redo log</code> å†™å…¥æˆåŠŸåã€<code>binlog</code> å†™å…¥å‰ï¼Œæ•°æ®åº“å‘ç”Ÿå®•æœºï¼Œé‚£ä¹ˆä¸»åº“åœ¨é‡å¯åä¼šé€šè¿‡ <code>redo log</code> æ¢å¤æ•°æ®ï¼Œä½† <code>binlog</code> ä¸­æ²¡æœ‰è¿™æ¡è®°å½•ï¼Œå¯¼è‡´ä»åº“æ— æ³•åŒæ­¥è¯¥äº‹åŠ¡ï¼Œé€ æˆä¸»ä»ä¸ä¸€è‡´ã€‚</li></ul></li><li><strong>åœºæ™¯äºŒï¼šå…ˆå†™ binlogï¼Œå†å†™ redo log</strong><ul><li>å¦‚æœ <code>binlog</code> å†™å…¥æˆåŠŸåã€<code>redo log</code> å†™å…¥å‰ï¼Œæ•°æ®åº“å‘ç”Ÿå®•æœºï¼Œé‚£ä¹ˆä»åº“ä¼šåŒæ­¥è¯¥äº‹åŠ¡ï¼Œä½†ä¸»åº“åœ¨é‡å¯åç”±äºæ²¡æœ‰ <code>redo log</code> è®°å½•ï¼Œäº‹åŠ¡æ— æ•ˆï¼ŒåŒæ ·é€ æˆä¸»ä»ä¸ä¸€è‡´ã€‚</li></ul></li></ul><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒInnoDBæå‡ºäº† ä¸¤æ®µæäº¤æ–¹å¼ã€‚ä¸¤æ®µå³ prepareé˜¶æ®µã€commité˜¶æ®µã€‚å…¶å®å°±æ˜¯å°† redolog çš„å†™å…¥æ‹†åˆ†æˆäº†ä¸¤ä¸ªæ­¥éª¤</p><pre class="mermaid">sequenceDiagram    participant Client as å®¢æˆ·ç«¯    participant MySQL as MySQLæœåŠ¡å±‚    participant InnoDB as InnoDBå¼•æ“    Client->>MySQL: COMMIT;    MySQL->>InnoDB: prepare;    InnoDB-->>InnoDB: 1. å†™å…¥redo log (prepareçŠ¶æ€);    InnoDB->>MySQL: prepareå®Œæˆ;    MySQL-->>MySQL: 2. å†™å…¥binlog;    MySQL->>InnoDB: commit;    InnoDB-->>InnoDB: 3. å†™å…¥redo log (commitçŠ¶æ€);    InnoDB->>MySQL: commitå®Œæˆ;    MySQL->>Client: äº‹åŠ¡æäº¤æˆåŠŸ;</pre><h2 id="äº”ã€å‚è€ƒèµ„æ–™"><a href="#äº”ã€å‚è€ƒèµ„æ–™" class="headerlink" title="äº”ã€å‚è€ƒèµ„æ–™"></a>äº”ã€å‚è€ƒèµ„æ–™</h2><p>å‚è€ƒçš„ä¼˜ç§€æ–‡ç« ï¼š</p><ul><li><a href="https://heapdump.cn/article/3890459">https://heapdump.cn/article/3890459</a></li><li><a href="https://cloud.tencent.com/developer/news/718233">https://cloud.tencent.com/developer/news/718233</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetesç¬”è®°ã€å†å²å­¦ä¹ æ–‡æ¡£ã€‘</title>
      <link href="/2025/06/23/Kubernetes%E5%88%86%E4%BA%AB/"/>
      <url>/2025/06/23/Kubernetes%E5%88%86%E4%BA%AB/</url>
      
        <content type="html"><![CDATA[<h1 id="Kubernetesç¬”è®°ã€å†å²å­¦ä¹ æ–‡æ¡£ã€‘"><a href="#Kubernetesç¬”è®°ã€å†å²å­¦ä¹ æ–‡æ¡£ã€‘" class="headerlink" title="Kubernetesç¬”è®°ã€å†å²å­¦ä¹ æ–‡æ¡£ã€‘"></a>Kubernetesç¬”è®°ã€å†å²å­¦ä¹ æ–‡æ¡£ã€‘</h1><h1 id=""><a href="#" class="headerlink" title=""></a><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753459080-e68ff0af-5121-4b78-afe2-7a5859d8141c.png"></h1><h1 id="ä¸€ã€Kubernetesçš„å‰ä¸–"><a href="#ä¸€ã€Kubernetesçš„å‰ä¸–" class="headerlink" title="ä¸€ã€Kubernetesçš„å‰ä¸–"></a><strong>ä¸€ã€Kubernetesçš„å‰ä¸–</strong></h1><p>çœ‹ä¼¼å¾ˆæ–°ï¼ˆç›¸å¯¹äºåˆšå‡ºç°æ—¶æ¥è¯´ï¼‰ï¼Œä½†å®ƒå´æ˜¯è°·æ­Œåå‡ å¹´ä»¥æ¥å¤§è§„æ¨¡åº”ç”¨å®¹å™¨æŠ€æœ¯çš„ç»éªŒç§¯ç´¯å’Œå‡åçš„é‡è¦æˆæœã€‚ç¡®åˆ‡åœ°è¯´ï¼ŒKubernetesæ˜¯è°·æ­Œä¸¥æ ¼ä¿å¯†åå‡ å¹´çš„ç§˜å¯†æ­¦å™¨â€”â€”Borgçš„ä¸€ä¸ªå¼€æºç‰ˆæœ¬ã€‚Borgæ˜¯è°·æ­Œçš„ä¸€ä¸ªä¹…è´Ÿç››åçš„å†…éƒ¨ä½¿ç”¨çš„å¤§è§„æ¨¡é›†ç¾¤ç®¡ç†ç³»ç»Ÿï¼Œå®ƒåŸºäºå®¹å™¨æŠ€æœ¯ï¼Œç›®çš„æ˜¯å®ç°èµ„æºç®¡ç†çš„è‡ªåŠ¨åŒ–ï¼Œä»¥åŠè·¨è¿‡ä¸ªæ•°æ®ä¸­å¿ƒèµ„æºåˆ©ç”¨ç‡çš„æœ€å¤§åŒ–ã€‚åå‡ å¹´ä»¥æ¥ï¼Œè°·æ­Œä¸€ç›´é€šè¿‡Borgç³»ç»Ÿç®¡ç†è€…æ•°æ®åºå¤§çš„åº”ç”¨ç¨‹åºé›†ç¾¤ï¼Œç”±äºè°·æ­Œå‘˜å·¥éƒ½ç­¾ç½²äº†ä¿å¯†åè®®ï¼Œå³ä½¿ç¦»èŒä¹Ÿä¸èƒ½æ³„éœ²Borgçš„å†…éƒ¨è®¾è®¡ï¼Œæ‰€ä»¥å¤–ç•Œä¸€ç›´æ— æ³•äº†è§£å…³äºå®ƒçš„æ›´å¤šä¿¡æ¯ã€‚ç›´åˆ° 2015 å¹´ 4 æœˆï¼Œä¼ é—»è®¸ä¹…çš„Borgè®ºæ–‡å‘å¸ƒï¼Œä¼´éšç€Kubernetesçš„é«˜è°ƒå®£ä¼ è¢«è°·æ­Œé¦–æ¬¡å…¬å¼€ã€‚</p><p>Borgå°±æ˜¯ä¸€ä¸ªå–·æ°”å¼é£æœºçš„é©¾é©¶ç³»ç»Ÿï¼Œéå¸¸çš„ä¸“ä¸šå’Œé«˜å¤§ä¸Šï¼Œä»–é€‚ç”¨äºè°·æ­Œè¿™æ ·çš„å¤§å…¬å¸ï¼Œå®ƒæœ‰å‡ ç™¾ä¸‡çš„æœºå™¨ã€‚Kubernetesæ˜¯ä¸€ä¸ªå®ƒçš„ç®€åŒ–ç‰ˆï¼Œå®ƒæ˜¯ä¸€è¾†è®¾è®¡ä¼˜è‰¯çš„è½¿è½¦ï¼Œå®ƒé€‚åˆä¸­å°å‹å…¬å¸ï¼Œæ›´æ–¹ä¾¿çš„ç”¨å®ƒæ¥è°ƒåº¦è‡ªå·±çš„é›†ç¾¤ã€‚</p><p>ä½†å³ä½¿æ˜¯ç®€åŒ–ç‰ˆï¼ŒK8sçš„ <a href="https://www.infoq.cn/article/qarzeu4ejouapxuullhc">goæºä»£ç é‡è¶…è¿‡ 430 ä¸‡è¡Œï¼ˆæ€»ä»£ç é‡å·²ç»è¶…è¿‡ 520 ä¸‡è¡Œï¼‰</a></p><h1 id="äºŒã€Kubernetes-ä¸‰é—®"><a href="#äºŒã€Kubernetes-ä¸‰é—®" class="headerlink" title="äºŒã€Kubernetes ä¸‰é—®"></a><strong>äºŒã€Kubernetes ä¸‰é—®</strong></h1><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753458886-9b684b1f-82e0-48d2-a811-753c5a25a1cd.png"></p><h2 id="2-1-Kuberneteså…·ä½“æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#2-1-Kuberneteså…·ä½“æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="2.1 Kuberneteså…·ä½“æ˜¯ä»€ä¹ˆï¼Ÿ"></a><strong>2.1 Kuberneteså…·ä½“æ˜¯ä»€ä¹ˆï¼Ÿ</strong></h2><p>Kubernetesæ˜¯<strong>ç”¨äºè‡ªåŠ¨éƒ¨ç½²ï¼Œæ‰©å±•å’Œ<strong><strong>ç®¡ç†å®¹å™¨åŒ–åº”ç”¨ç¨‹åº</strong></strong>çš„å¼€æºç³»ç»Ÿ</strong>ï¼Œå®ƒå°†ç»„æˆåº”ç”¨ç¨‹åºçš„å®¹å™¨ç»„åˆæˆé€»è¾‘å•å…ƒï¼Œä»¥ä¾¿äºç®¡ç†å’ŒæœåŠ¡å‘ç°ã€‚</p><p>Kubernetesï¼Œæ„å»ºåœ¨ Docker æŠ€æœ¯ä¹‹ä¸Šï¼Œä¸ºè·¨ä¸»æœºçš„å®¹å™¨åŒ–åº”ç”¨æä¾›èµ„æºè°ƒåº¦ã€æœåŠ¡å‘ç°ã€é«˜å¯ç”¨ç®¡ç†å’Œå¼¹æ€§ä¼¸ç¼©ç­‰ä¸€æ•´å¥—åŠŸèƒ½ï¼Œå®ƒæä¾›äº†å®Œå–„çš„ç®¡ç†å·¥å…·ï¼Œæ¶µç›–å¼€å‘ã€éƒ¨ç½²æµ‹è¯•ã€è¿ç»´ç›‘æ§ç­‰å„ä¸ªç¯èŠ‚ã€‚</p><h2 id="2-2-ä¸ºä»€ä¹ˆéœ€è¦Kubernetesï¼Œä¸ç”¨Kuberneteså¯ä»¥å—ï¼Ÿ"><a href="#2-2-ä¸ºä»€ä¹ˆéœ€è¦Kubernetesï¼Œä¸ç”¨Kuberneteså¯ä»¥å—ï¼Ÿ" class="headerlink" title="2.2 ä¸ºä»€ä¹ˆéœ€è¦Kubernetesï¼Œä¸ç”¨Kuberneteså¯ä»¥å—ï¼Ÿ"></a><strong>2.2 ä¸ºä»€ä¹ˆéœ€è¦Kubernetesï¼Œä¸ç”¨Kuberneteså¯ä»¥å—ï¼Ÿ</strong></h2><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753458844-8d580cde-637f-46c1-86d3-212a8da0b2b4.png"></p><p><strong>1.</strong>** **<strong>ä¼ ç»Ÿéƒ¨ç½²æ—¶ä»£ï¼š</strong></p><p>äº’è”ç½‘æ—©æœŸ,ä¼šç›´æ¥å°†åº”ç”¨ç¨‹åºéƒ¨ç½²åœ¨ç‰©ç†æœºä¸Š,ä¾‹å¦‚ç›´æ¥å°†javaç¨‹åºéƒ¨ç½²åˆ°ç‰©ç†æœºä¸­ã€‚åƒæˆ‘æœ‰æ—¶å€™ä¸ºäº†æ–¹ä¾¿å°± springbooté¡¹ç›®ä¸€æ­å»ºï¼Œå†™å¥½ä»£ç ç›´æ¥æ‰“æˆjaråŒ…ã€‚ç„¶åç”¨ java -jar,ç›´æ¥å°±å¯ä»¥è¿è¡Œäº†ï¼ˆå‰ææ˜¯linxuæ­å»ºäº†javaç¯å¢ƒï¼‰ã€‚å¯ä»¥è¯´ç®—æ˜¯å¾ˆæ–¹ä¾¿äº†ï¼Œä¸éœ€è¦å…¶ä»–æŠ€æœ¯çš„å‚ä¸ã€‚ä½†æ˜¯ä¹Ÿæœ‰å¾ˆå¤šä¸è¶³çš„ç‚¹ã€‚</p><p><strong>ç¼ºç‚¹ï¼š</strong></p><p>ï¼ˆ1ï¼‰ä¸èƒ½ä¸ºåº”ç”¨ç¨‹åºå®šä¹‰èµ„æºä½¿ç”¨è¾¹ç•Œ,å¾ˆéš¾åˆç†çš„åˆ†é…è®¡ç®—èµ„æº,è€Œä¸”ç¨‹åºä¹‹é—´å®¹æ˜“äº§ç”Ÿäº’ç›¸å½±å“ã€‚</p><p>ï¼ˆ2ï¼‰å½“1ä¸ªç¨‹åºå‡ºç°æ¼æ´æ—¶ï¼Œå¯¼è‡´æœºå™¨OOMæˆ–è€…å®•æœºã€‚å¦ä¸€ä¸ªç¨‹åºä¹Ÿå—åˆ°å½±å“ã€‚</p><p><strong>æ€»çš„è¯´ï¼šæ— æ³•ä¸ºç‰©ç†æœåŠ¡å™¨ä¸­çš„åº”ç”¨ç¨‹åºå®šä¹‰èµ„æºè¾¹ç•Œï¼Œè¿™ä¼šå¯¼è‡´èµ„æºåˆ†é…é—®é¢˜ã€‚</strong> ä¾‹å¦‚ï¼Œå¦‚æœåœ¨ç‰©ç†æœåŠ¡å™¨ä¸Šè¿è¡Œå¤šä¸ªåº”ç”¨ç¨‹åºï¼Œåˆ™å¯èƒ½ä¼šå‡ºç°ä¸€ä¸ªåº”ç”¨ç¨‹åºå ç”¨å¤§éƒ¨åˆ†èµ„æºçš„æƒ…å†µï¼Œ ç»“æœå¯èƒ½å¯¼è‡´å…¶ä»–åº”ç”¨ç¨‹åºçš„æ€§èƒ½ä¸‹é™ã€‚ ä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯åœ¨ä¸åŒçš„ç‰©ç†æœåŠ¡å™¨ä¸Šè¿è¡Œæ¯ä¸ªåº”ç”¨ç¨‹åºï¼Œä½†æ˜¯ç”±äº<strong>èµ„æºåˆ©ç”¨ä¸è¶³</strong>è€Œæ— æ³•æ‰©å±•ï¼Œ å¹¶ä¸”<strong>ç»´æŠ¤è®¸å¤šç‰©ç†æœåŠ¡å™¨çš„æˆæœ¬å¾ˆé«˜</strong>ã€‚</p><p><strong>2.</strong>** **<strong>è™šæ‹ŸåŒ–éƒ¨ç½²æ—¶ä»£ï¼š</strong></p><p>ä½œä¸ºè§£å†³æ–¹æ¡ˆï¼Œå¼•å…¥äº†è™šæ‹ŸåŒ–ã€‚è™šæ‹ŸåŒ–æŠ€æœ¯å…è®¸ä½ åœ¨å•ä¸ªç‰©ç†æœåŠ¡å™¨çš„ CPU ä¸Šè¿è¡Œå¤šä¸ªè™šæ‹Ÿæœºï¼ˆVMï¼‰ã€‚** è™šæ‹ŸåŒ–å…è®¸åº”ç”¨ç¨‹åºåœ¨ VM ä¹‹é—´éš”ç¦»ï¼ˆ<strong>VMwareã€Hyper-V</strong>ï¼‰**ï¼Œå¹¶æä¾›ä¸€å®šç¨‹åº¦çš„å®‰å…¨ï¼Œå› ä¸ºä¸€ä¸ªåº”ç”¨ç¨‹åºçš„ä¿¡æ¯ ä¸èƒ½è¢«å¦ä¸€åº”ç”¨ç¨‹åºéšæ„è®¿é—®ã€‚</p><p>è™šæ‹ŸåŒ–æŠ€æœ¯èƒ½å¤Ÿæ›´å¥½åœ°åˆ©ç”¨ç‰©ç†æœåŠ¡å™¨ä¸Šçš„èµ„æºï¼Œå¹¶ä¸”å› ä¸ºå¯è½»æ¾åœ°æ·»åŠ æˆ–æ›´æ–°åº”ç”¨ç¨‹åº è€Œå¯ä»¥å®ç°æ›´å¥½çš„å¯ä¼¸ç¼©æ€§ï¼Œé™ä½ç¡¬ä»¶æˆæœ¬ç­‰ç­‰ã€‚<strong>æ¯ä¸ª VM æ˜¯ä¸€å°å®Œæ•´çš„è®¡ç®—æœºï¼Œåœ¨è™šæ‹ŸåŒ–ç¡¬ä»¶ä¹‹ä¸Šè¿è¡Œæ‰€æœ‰ç»„ä»¶ï¼ŒåŒ…æ‹¬å…¶è‡ªå·±çš„æ“ä½œç³»ç»Ÿã€‚</strong></p><p><strong>ç¼ºç‚¹ï¼š</strong></p><p>ï¼ˆ1ï¼‰èµ„æºå¼€é”€å¤§ï¼šæ¯ä¸ªè™šæ‹Ÿæœºéœ€è¦ä¸€ä¸ªå®Œæ•´çš„æ“ä½œç³»ç»Ÿï¼Œå ç”¨è¾ƒå¤šçš„ç¡¬ä»¶èµ„æºã€‚</p><p>ï¼ˆ2ï¼‰å¯åŠ¨é€Ÿåº¦æ…¢ï¼šè™šæ‹Ÿæœºå¯åŠ¨éœ€è¦æ—¶é—´ï¼Œç‰¹åˆ«æ˜¯æ“ä½œç³»ç»Ÿå¯åŠ¨æ—¶é—´è¾ƒé•¿ã€‚</p><p>ï¼ˆ3ï¼‰ç®¡ç†å¤æ‚ï¼šè™šæ‹Ÿæœºç®¡ç†ç›¸å¯¹å¤æ‚ï¼Œç»´æŠ¤æˆæœ¬è¾ƒé«˜ã€‚</p><p>è¿™äº›ç¼ºç‚¹ï¼Œä¹Ÿä¸¥é‡é™åˆ¶äº†å…¶è¿›è¡Œå¤§è§„æ¨¡åº”ç”¨éƒ¨ç½²å’Œç»´æŠ¤çš„å¯èƒ½ã€‚æ‰€ä»¥ç›®å‰ä¹Ÿæå°‘æ•°æœ‰å¾®æœåŠ¡æ¶æ„ä¼šé€‰æ‹©ä½¿ç”¨è™šæ‹Ÿæœºå»éƒ¨ç½²åº”ç”¨ã€‚</p><p><strong>3.</strong>** **<strong>å®¹å™¨åŒ–éƒ¨ç½²æ—¶ä»£ï¼š</strong></p><p>å®¹å™¨ç±»ä¼¼äº VMï¼Œä½†æ˜¯å®ƒä»¬å…·æœ‰è¢«æ”¾å®½çš„éš”ç¦»å±æ€§ï¼Œå¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¹‹é—´å…±äº«æ“ä½œç³»ç»Ÿï¼ˆOSï¼‰ã€‚ å› æ­¤ï¼Œå®¹å™¨è¢«è®¤ä¸ºæ˜¯è½»é‡çº§çš„è™šæ‹Ÿæœºã€‚å®¹å™¨ä¸ VM ç±»ä¼¼ï¼Œå…·æœ‰è‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿã€CPUã€å†…å­˜ã€è¿›ç¨‹ç©ºé—´ç­‰ã€‚</p><p>å®¹å™¨çš„ä¼˜åŠ¿ï¼š</p><p>ï¼ˆ1ï¼‰è½»é‡çº§å’Œé«˜æ•ˆï¼šå®¹å™¨å…±äº«å®¿ä¸»æœºçš„æ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œå¯åŠ¨é€Ÿåº¦å¿«ï¼Œèµ„æºå¼€é”€å°ï¼Œéå¸¸é€‚åˆå¾®æœåŠ¡æ¶æ„ä¸­é¢‘ç¹å¯åŠ¨å’Œé”€æ¯æœåŠ¡çš„éœ€æ±‚ã€‚</p><p>ï¼ˆ2ï¼‰å¿«é€Ÿéƒ¨ç½²å’Œæ‰©å±•ï¼šå®¹å™¨å¯ä»¥å¿«é€Ÿéƒ¨ç½²å’Œæ‰©å±•ï¼Œé€‚åº”å¾®æœåŠ¡æ¶æ„çš„å¿«é€Ÿè¿­ä»£å’Œæ‰©å±•éœ€æ±‚ã€‚</p><p>ï¼ˆ3ï¼‰ç¯å¢ƒä¸€è‡´æ€§ï¼šå¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒä¸€è‡´ï¼Œå‡å°‘äº†ç¯å¢ƒå·®å¼‚å¸¦æ¥çš„é—®é¢˜ï¼Œæé«˜äº†åº”ç”¨çš„ç¨³å®šæ€§å’Œå¯é æ€§ã€‚</p><p>ç›®å‰çš„æ—¶ä»£å°±æ˜¯å±äºå®¹å™¨åŒ–çš„æ—¶ä»£ã€‚ä½¿ç”¨å®¹å™¨åŒ–æ–¹å¼è¿›è¡Œéƒ¨ç½²åº”ç”¨å¸¦æ¥äº†éå¸¸å¤šçš„æ–¹ä¾¿ï¼Œæˆ‘ä»¬å‡ ä¹ä¸ç”¨è€ƒè™‘ç¯å¢ƒçš„å½±å“ã€‚githubä¸Šå¾ˆå¤šé¡¹ç›®éƒ½ç›´æ¥æä¾›dockeréƒ¨ç½²ï¼Œå¾€å¾€ä¸€ä¸ªå‘½ä»¤å°±å¯ä»¥è·‘èµ·æ¥ã€‚ä½†æ˜¯ä¸€æ—¦éœ€è¦å¤§è§„æ¨¡ä½¿ç”¨å®¹å™¨åŒ–éƒ¨ç½²ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä¼šé‡åˆ°ä¸€äº›é—®é¢˜ï¼š</p><p>â— ä¸€ä¸ªå®¹å™¨æ•…éšœåœæœºäº†,æ€ä¹ˆæ ·è®©å¦å¤–ä¸€ä¸ªå®¹å™¨ç«‹åˆ»å¯åŠ¨å»æ›¿è¡¥åœæœºçš„å®¹å™¨?</p><p>â— å¦‚ä½•å°†æœåŠ¡éƒ¨ç½²åˆ°å¤šå°ç‰©ç†æœºä¸Šï¼Œåšåˆ°å……åˆ†åˆ©ç”¨èµ„æºï¼Ÿ</p><p>â— å½“å¹¶å‘è®¿é—®é‡å¤§çš„æ—¶å€™,æ€ä¹ˆæ ·åšçš„æ¨ªå‘æ‰©å±•å®¹å™¨æ•°é‡?</p><p>è¿™äº›å®¹å™¨ç®¡ç†çš„é—®é¢˜ç»Ÿç§°ä¸ºå®¹å™¨ç¼–æ’é—®é¢˜,ä¸ºäº†è§£å†³è¿™äº›å®¹å™¨ç¼–æ’é—®é¢˜,å°±äº§ç”Ÿäº†ä¸€äº›å®¹å™¨ç¼–æ’è½¯ä»¶:</p><p>â— Swarmï¼šDockerè‡ªå·±çš„å®¹å™¨ç¼–æ’å·¥å…·</p><p>â— Mesosï¼šApacheçš„ä¸€ä¸ªèµ„æºç»Ÿä¸€ç®¡æ§çš„å·¥å…·ï¼Œéœ€è¦å’ŒMarathonç»“åˆä½¿ç”¨</p><p>â— Kubernetesï¼šGoogleå¼€æºçš„çš„å®¹å™¨ç¼–æ’å·¥å…·</p><h2 id="2-3-Kubernetesèƒ½åšä»€ä¹ˆï¼Ÿ"><a href="#2-3-Kubernetesèƒ½åšä»€ä¹ˆï¼Ÿ" class="headerlink" title="2.3 Kubernetesèƒ½åšä»€ä¹ˆï¼Ÿ"></a><strong>2.3 Kubernetesèƒ½åšä»€ä¹ˆï¼Ÿ</strong></h2><p>Kubernetes æä¾›çš„æœ€ç®€å•çš„åŠŸèƒ½å°±æ˜¯å®¹å™¨ç¼–æ’ï¼Œå…¶æœ¬è´¨ä¸Šæ˜¯ä¸€ç»„é›†ç¾¤ã€‚å®ƒå¯ä»¥åœ¨é›†ç¾¤çš„æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œå®¹å™¨åŒ–ç¨‹åºï¼Œå¹¶å¯¹è¿™äº›èŠ‚ç‚¹ä¸­çš„å®¹å™¨è¿›è¡Œç®¡ç†ã€‚ç›®çš„æ˜¯å®ç°èµ„æºç®¡ç†çš„è‡ªåŠ¨åŒ–ï¼Œä¸»è¦æä¾›äº†å¦‚ä¸‹çš„ä¸»è¦åŠŸèƒ½ï¼š</p><p>â— è‡ªæˆ‘ä¿®å¤ï¼šä¸€æ—¦æŸä¸€ä¸ªå®¹å™¨å´©æºƒï¼Œèƒ½å¤Ÿåœ¨1ç§’ä¸­å·¦å³è¿…é€Ÿå¯åŠ¨æ–°çš„å®¹å™¨ã€‚</p><p>â— è‡ªåŠ¨å®Œæˆè£…ç®±è®¡ç®—ï¼šä½ å‘Šè¯‰ K8s æ¯ä¸ªå®¹å™¨éœ€è¦å¤šå°‘ CPU å’Œå†…å­˜ (RAM)ã€‚ K8s å¯ä»¥å°†è¿™äº›å®¹å™¨æŒ‰å®é™…æƒ…å†µè°ƒåº¦åˆ°ä½ çš„èŠ‚ç‚¹ä¸Šï¼Œä»¥æœ€ä½³æ–¹å¼åˆ©ç”¨ä½ çš„èµ„æºã€‚</p><p>â— å¼¹æ€§ä¼¸ç¼©ï¼šå¯ä»¥æ ¹æ®éœ€è¦ï¼Œè‡ªåŠ¨å¯¹é›†ç¾¤ä¸­æ­£åœ¨è¿è¡Œçš„å®¹å™¨æ•°é‡è¿›è¡Œè°ƒæ•´</p><p>â— æœåŠ¡å‘ç°ï¼šæœåŠ¡å¯ä»¥é€šè¿‡è‡ªåŠ¨å‘ç°çš„å½¢å¼æ‰¾åˆ°å®ƒæ‰€ä¾èµ–çš„æœåŠ¡</p><p>â— è´Ÿè½½å‡è¡¡ï¼šå¦‚æœä¸€ä¸ªæœåŠ¡èµ·åŠ¨äº†å¤šä¸ªå®¹å™¨ï¼Œèƒ½å¤Ÿè‡ªåŠ¨å®ç°è¯·æ±‚çš„è´Ÿè½½å‡è¡¡</p><p>â— ç‰ˆæœ¬å›é€€ï¼šå¦‚æœå‘ç°æ–°å‘å¸ƒçš„ç¨‹åºç‰ˆæœ¬æœ‰é—®é¢˜ï¼Œå¯ä»¥ç«‹å³å›é€€åˆ°åŸæ¥çš„ç‰ˆæœ¬</p><p>â— å­˜å‚¨ç¼–æ’ï¼šå¯ä»¥æ ¹æ®å®¹å™¨è‡ªèº«çš„éœ€æ±‚è‡ªåŠ¨åˆ›å»ºå­˜å‚¨å·ã€‚</p><h1 id="ä¸‰ã€-Kubernetes-æ ¸å¿ƒæ¦‚å¿µ"><a href="#ä¸‰ã€-Kubernetes-æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="ä¸‰ã€** **Kubernetes æ ¸å¿ƒæ¦‚å¿µ"></a><strong>ä¸‰ã€</strong>** **<strong>Kubernetes æ ¸å¿ƒæ¦‚å¿µ</strong></h1><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753458855-b0196e6c-d391-418c-acd7-440e92affb8c.png"></p><p>Kubernetesçš„å…¨éƒ¨æ¦‚å¿µå¾ˆå¤šï¼Œä¸”å®˜æ–¹æ–‡æ¡£æ‰‹å†Œä¸­è¦†ç›–æ¯”è¾ƒå…¨ã€‚è¿™é‡Œæˆ‘é€‰ä¸€äº›æ ¸å¿ƒå’Œé‡è¦çš„æ¦‚å¿µã€‚</p><p>å®˜æ–¹æ–‡æ¡£<a href="https://kubernetes.io/zh-cn/docs/concepts/">https://kubernetes.io/zh-cn/docs/concepts/</a></p><h2 id="3-1-kubernetesæ¶æ„"><a href="#3-1-kubernetesæ¶æ„" class="headerlink" title="3.1 kubernetesæ¶æ„"></a><strong>3.1 kubernetesæ¶æ„</strong></h2><p>ä¸€ä¸ªKubernetesé›†ç¾¤è‡³å°‘åŒ…å«ä¸€ä¸ªæ§åˆ¶å¹³é¢(control plane)ï¼Œä»¥åŠä¸€ä¸ªæˆ–å¤šä¸ªå·¥ä½œèŠ‚ç‚¹(worker node)ã€‚</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753459053-8f00af08-9ad9-4abc-b551-f546df972c3b.png"></p><h3 id="1ï¼‰æ§åˆ¶å¹³é¢-Control-Plane"><a href="#1ï¼‰æ§åˆ¶å¹³é¢-Control-Plane" class="headerlink" title="**1ï¼‰æ§åˆ¶å¹³é¢(Control Plane) **"></a>**1ï¼‰æ§åˆ¶å¹³é¢(Control Plane) **</h3><p>æ§åˆ¶å¹³é¢ç»„ä»¶æ˜¯æ•´ä¸ªé›†ç¾¤çš„æ ¸å¿ƒï¼Œè´Ÿè´£æ§åˆ¶å’Œç®¡ç†æ•´ä¸ªé›†ç¾¤ã€‚å®ƒè¿è¡Œç€ä¸€äº›å…³é”®çš„ç»„ä»¶ã€‚master èŠ‚ç‚¹å¯ä»¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªï¼Œå¦‚æœæœ‰å¤šä¸ª master èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå®ƒä»¬ä¹‹é—´éœ€è¦é€šè¿‡ etcd è¿™ä¸ªåˆ†å¸ƒå¼é”®å€¼å­˜å‚¨æ¥ä¿æŒæ•°æ®çš„ä¸€è‡´æ€§ã€‚</p><p><strong>kube-apiserverï¼ˆè¡Œæ”¿éƒ¨é—¨ï¼‰</strong></p><p>å¦‚æœéœ€è¦ä¸Kubernetes é›†ç¾¤è¿›è¡Œäº¤äº’ï¼Œå°±è¦é€šè¿‡ APIã€‚apiserveræ˜¯ Kubernetes æ§åˆ¶å¹³é¢çš„å‰ç«¯ï¼Œç”¨äºå¤„ç†å†…éƒ¨å’Œå¤–éƒ¨è¯·æ±‚ã€‚</p><p><strong>kube-schedulerï¼ˆåˆ†ç®¡å‰¯æ€»ï¼‰</strong></p><p>é›†ç¾¤çŠ¶å†µæ˜¯å¦è‰¯å¥½ï¼Ÿå¦‚æœéœ€è¦åˆ›å»ºæ–°çš„å®¹å™¨ï¼Œè¦å°†å®ƒä»¬æ”¾åœ¨å“ªé‡Œï¼Ÿè¿™äº›æ˜¯è°ƒåº¦ç¨‹åºéœ€è¦å…³æ³¨çš„é—®é¢˜ã€‚schedulerè°ƒåº¦ç¨‹åºä¼šè€ƒè™‘å®¹å™¨é›†çš„èµ„æºéœ€æ±‚ï¼ˆä¾‹å¦‚ CPU æˆ–å†…å­˜ï¼‰ä»¥åŠé›†ç¾¤çš„è¿è¡ŒçŠ¶å†µã€‚éšåï¼Œå®ƒä¼šå°†å®¹å™¨é›†å®‰æ’åˆ°é€‚å½“çš„è®¡ç®—èŠ‚ç‚¹ã€‚</p><p><strong>etcdï¼ˆç§˜ä¹¦ï¼‰</strong></p><p>æ˜¯ä¸€ç§å¼€æºçš„åˆ†å¸ƒå¼ç»Ÿä¸€é”®å€¼å­˜å‚¨ï¼Œç”¨äºåˆ†å¸ƒå¼ç³»ç»Ÿæˆ–è®¡ç®—æœºé›†ç¾¤çš„å…±äº«é…ç½®ã€æœåŠ¡å‘ç°å’Œçš„è°ƒåº¦åè°ƒæ˜¯ä¸€ä¸ªé”®å€¼å¯¹æ•°æ®åº“ã€‚åœ¨K8sä¸­ç”¨äºå­˜å‚¨é…ç½®æ•°æ®å’Œé›†ç¾¤çŠ¶æ€ä¿¡æ¯ã€‚</p><p><strong>kube-controller-managerï¼ˆCEOï¼‰</strong></p><p>æ§åˆ¶å™¨è´Ÿè´£å®é™…è¿è¡Œé›†ç¾¤ï¼Œcontroller-manageræ§åˆ¶å™¨ç®¡ç†å™¨åˆ™æ˜¯å°†å¤šä¸ªæ§åˆ¶å™¨åŠŸèƒ½åˆè€Œä¸ºä¸€ï¼Œé™ä½äº†ç¨‹åºçš„å¤æ‚æ€§ã€‚</p><p>controller-manageråŒ…å«äº†è¿™äº›æ§åˆ¶å™¨ï¼š</p><p>â— èŠ‚ç‚¹æ§åˆ¶å™¨ï¼ˆNode Controllerï¼‰ï¼šè´Ÿè´£åœ¨èŠ‚ç‚¹å‡ºç°æ•…éšœæ—¶è¿›è¡Œé€šçŸ¥å’Œå“åº”</p><p>â— ä»»åŠ¡æ§åˆ¶å™¨ï¼ˆJob Controllerï¼‰ï¼šç›‘æµ‹ä»£è¡¨ä¸€æ¬¡æ€§ä»»åŠ¡çš„ Job å¯¹è±¡ï¼Œç„¶ååˆ›å»º Pods æ¥è¿è¡Œè¿™äº›ä»»åŠ¡ç›´è‡³å®Œæˆ</p><p>â— ç«¯ç‚¹æ§åˆ¶å™¨ï¼ˆEndpoints Controllerï¼‰ï¼šå¡«å……ç«¯ç‚¹ï¼ˆEndpointsï¼‰å¯¹è±¡ï¼ˆå³åŠ å…¥ Service ä¸ Podï¼‰</p><p>â— æœåŠ¡å¸æˆ·å’Œä»¤ç‰Œæ§åˆ¶å™¨ï¼ˆService Account &amp; Token Controllersï¼‰ï¼šä¸ºæ–°çš„å‘½åç©ºé—´åˆ›å»ºé»˜è®¤å¸æˆ·å’Œ API è®¿é—®ä»¤ç‰Œ</p><h3 id="2ï¼‰å·¥ä½œèŠ‚ç‚¹-Worker-Node"><a href="#2ï¼‰å·¥ä½œèŠ‚ç‚¹-Worker-Node" class="headerlink" title="2ï¼‰å·¥ä½œèŠ‚ç‚¹(Worker Node) :"></a><strong>2ï¼‰å·¥ä½œèŠ‚ç‚¹(Worker Node) :</strong></h3><p>å·¥ä½œèŠ‚ç‚¹è´Ÿè´£æ‰§è¡Œç”±æ§åˆ¶å¹³é¢åˆ†é…çš„è¯·æ±‚ä»»åŠ¡,è¿è¡Œå®é™…çš„åº”ç”¨å’Œå·¥ä½œè´Ÿè½½ã€‚</p><p><strong>kubeletï¼ˆåˆ†å…¬å¸è´Ÿè´£äººï¼‰</strong></p><p>ä¼šåœ¨é›†ç¾¤ä¸­æ¯ä¸ªèŠ‚ç‚¹ï¼ˆnodeï¼‰ä¸Šè¿è¡Œã€‚ å®ƒä¿è¯å®¹å™¨ï¼ˆcontainersï¼‰éƒ½è¿è¡Œåœ¨ Pod ä¸­ã€‚å½“æ§åˆ¶å¹³é¢éœ€è¦åœ¨èŠ‚ç‚¹ä¸­æ‰§è¡ŒæŸä¸ªæ“ä½œæ—¶ï¼Œkubelet å°±ä¼šæ‰§è¡Œè¯¥æ“ä½œã€‚</p><p><strong>kube-proxyï¼ˆè”ç»œå‘˜ï¼‰</strong></p><p><a href="https://kubernetes.io/zh-cn/docs/reference/command-line-tools-reference/kube-proxy/">kube-proxy | Kubernetes</a> æ˜¯é›†ç¾¤ä¸­æ¯ä¸ª<a href="https://kubernetes.io/zh-cn/docs/concepts/architecture/nodes/">èŠ‚ç‚¹ | Kubernetes</a>ä¸Šè¿è¡Œçš„ç½‘ç»œä»£ç†ï¼Œæ˜¯å®ç° Kubernetes <a href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/">æœåŠ¡ï¼ˆServiceï¼‰ | Kubernetes</a> æ¦‚å¿µçš„ä¸€éƒ¨åˆ†ã€‚kube-proxy ç»´æŠ¤èŠ‚ç‚¹ç½‘ç»œè§„åˆ™å’Œè½¬å‘æµé‡ï¼Œå®ç°ä»é›†ç¾¤å†…éƒ¨æˆ–å¤–éƒ¨çš„ç½‘ç»œä¸ Pod è¿›è¡Œç½‘ç»œé€šä¿¡ã€‚</p><p><strong>å®¹å™¨è¿è¡Œæ—¶ï¼ˆContainer Runtimeï¼‰</strong></p><p>å®¹å™¨è¿è¡Œç¯å¢ƒæ˜¯è´Ÿè´£è¿è¡Œå®¹å™¨çš„è½¯ä»¶ã€‚Kubernetes æ”¯æŒè®¸å¤šå®¹å™¨è¿è¡Œç¯å¢ƒï¼Œä¾‹å¦‚ <a href="https://containerd.io/docs/">containerd docs</a>ã€dockerç­‰ã€‚</p><p>æ€»ç»“ä¸€ä¸‹ï¼ŒKubernetesä¸»è¦å°±æ˜¯ç”±ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒç»„ä»¶ç»„æˆï¼š</p><p>â— etcdä¿å­˜äº†æ•´ä¸ªé›†ç¾¤çš„çŠ¶æ€ï¼›</p><p>â— apiserveræä¾›äº†èµ„æºæ“ä½œçš„å”¯ä¸€å…¥å£ï¼Œå¹¶æä¾›è®¤è¯ã€æˆæƒã€è®¿é—®æ§åˆ¶ã€APIæ³¨å†Œå’Œå‘ç°ç­‰æœºåˆ¶ï¼›</p><p>â— controller managerè´Ÿè´£ç»´æŠ¤é›†ç¾¤çš„çŠ¶æ€ï¼Œæ¯”å¦‚æ•…éšœæ£€æµ‹ã€è‡ªåŠ¨æ‰©å±•ã€æ»šåŠ¨æ›´æ–°ç­‰ï¼›</p><p>â— schedulerè´Ÿè´£èµ„æºçš„è°ƒåº¦ï¼ŒæŒ‰ç…§é¢„å®šçš„è°ƒåº¦ç­–ç•¥å°†Podè°ƒåº¦åˆ°ç›¸åº”çš„æœºå™¨ä¸Šï¼›</p><p>â— kubeletè´Ÿè´£ç»´æŠ¤å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒæ—¶ä¹Ÿè´Ÿè´£Volumeï¼ˆCVIï¼‰å’Œç½‘ç»œï¼ˆCNIï¼‰çš„ç®¡ç†ï¼›</p><p>â— Container runtimeè´Ÿè´£é•œåƒç®¡ç†ä»¥åŠPodå’Œå®¹å™¨çš„çœŸæ­£è¿è¡Œï¼ˆCRIï¼‰ï¼›</p><p>â— kube-proxyè´Ÿè´£ä¸ºServiceæä¾›clusterå†…éƒ¨çš„æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ï¼›</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753459187-d75d044b-0867-4a45-8572-9197f5a98d0a.png"><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753459113-5003c5f1-7ba6-43f0-a1c2-e266f6a6d875.png"></p><h3 id="3ï¼‰å¤šä¸»èŠ‚ç‚¹æ¶æ„ï¼š"><a href="#3ï¼‰å¤šä¸»èŠ‚ç‚¹æ¶æ„ï¼š" class="headerlink" title="3ï¼‰å¤šä¸»èŠ‚ç‚¹æ¶æ„ï¼š"></a><strong>3ï¼‰å¤šä¸»èŠ‚ç‚¹æ¶æ„ï¼š</strong></h3><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753459396-73d93629-90ed-4010-b2ec-4d515f4b4671.png"></p><h2 id="3-2-æ ¸å¿ƒæ¦‚å¿µ"><a href="#3-2-æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="3.2 æ ¸å¿ƒæ¦‚å¿µ"></a><strong>3.2 æ ¸å¿ƒæ¦‚å¿µ</strong></h2><h3 id="1ï¼‰Pod"><a href="#1ï¼‰Pod" class="headerlink" title="1ï¼‰Pod"></a><strong>1ï¼‰Pod</strong></h3><p><strong>Podæ˜¯Kubernetesåˆ›å»ºå’Œç®¡ç†çš„æœ€å°å•å…ƒã€‚</strong>ä¸€ä¸ªPodç”±å•ä¸ªæˆ–å¤šä¸ªå®¹å™¨ç»„æˆï¼Œè¿™äº›å®¹å™¨å…±äº«å­˜å‚¨å’Œç½‘ç»œã€‚</p><p>Podçš„ç‰¹ç‚¹ï¼š</p><p>â— ä¸€ä¸ªPodå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªåº”ç”¨å®ä¾‹ï¼Œæä¾›æœåŠ¡ã€‚</p><p>â— Podä¸­çš„å®¹å™¨éƒ¨ç½²åœ¨NodeèŠ‚ç‚¹ä¸Šã€‚</p><p>â— Podä¸­å¯ä»¥æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªå®¹å™¨ã€‚</p><p>â— Kubernetesç›´æ¥ç®¡ç†Podï¼Œè€Œä¸æ˜¯å®¹å™¨ã€‚</p><p><strong>ç–‘é—®1ï¼šä¸ºä»€ä¹ˆéœ€è¦Podï¼Œç›´æ¥ç”¨å®¹å™¨ä¸è¡Œå—ï¼Ÿ</strong></p><p>Podä¸»è¦ç”¨æ³•ï¼š</p><p>â— è¿è¡Œå•ä¸ªå®¹å™¨ï¼šæœ€å¸¸è§çš„ç”¨æ³•ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹å¯ä»¥å°†podçœ‹ä½œæ˜¯å•ä¸ªå®¹å™¨çš„æŠ½è±¡å°è£…ã€‚</p><p>â— è¿è¡Œå¤šä¸ªå®¹å™¨ï¼šè¾¹è½¦æ¨¡å¼ï¼Œé€šè¿‡åœ¨podä¸­å®šä¹‰ä¸“é—¨å®¹å™¨ï¼Œæ¥æ‰§è¡Œä¸»ä¸šåŠ¡å®¹å™¨éœ€è¦çš„è¾…åŠ©å·¥ä½œï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯å°†è¾…åŠ©åŠŸèƒ½åŒä¸šåŠ¡å®¹å™¨è§£è€¦ï¼Œå®ç°ç‹¬ç«‹å‘å¸ƒå’Œèƒ½åŠ›é‡ç”¨ã€‚</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753459331-5884cdf0-5974-4080-a812-e57e09a9d346.png"></p><p>å®é™…ä½¿ç”¨åœºæ™¯æœ‰ï¼šæ—¥å¿—æ”¶é›†å’Œå¤„ç†ã€ç›‘æ§å’Œåº¦é‡ã€æœåŠ¡ä»£ç†å’Œæµé‡ç®¡ç†ç­‰ç­‰</p><p>è¾¹è½¦æ¨¡å¼é€šè¿‡å°†è¾…åŠ©åŠŸèƒ½ä¸ä¸»åº”ç”¨è§£è€¦ï¼Œä½¿å¾— Kubernetes ä¸­çš„åº”ç”¨ç¨‹åºæ›´æ˜“äºæ‰©å±•ã€ç®¡ç†å’Œç›‘æ§ã€‚åŒæ ·ä¹Ÿå¢å¼ºäº†åº”ç”¨ç¨‹åºçš„çµæ´»æ€§å’Œå¯é æ€§ã€‚</p><p><strong>ç–‘é—®2ï¼šPod å¦‚ä½•å®ç°çš„ç½‘ç»œå’Œå­˜å‚¨çš„å…±äº«ï¼Ÿ</strong></p><p><strong>Podçš„ç½‘ç»œå…±äº«æ˜¯é»˜è®¤çš„ã€‚</strong>æ¯ä¸€ä¸ªpodéƒ½æœ‰ä¸€ä¸ªInfra Containerå®¹å™¨ï¼Œè¿™ä¸ªå®¹å™¨æˆ‘ä»¬ç§°ä¹‹ä¸ºç½‘ç»œå®¹å™¨ï¼Œä»–è´Ÿè´£ä¸€ä¸ªpodå†…çš„æ‰€æœ‰å®¹å™¨çš„ç½‘ç»œå…±äº«ã€‚</p><p>åœ¨podä¸­Infraå®¹å™¨æ°¸è¿œæ˜¯ç¬¬ä¸€ä¸ªè¢«åˆ›å»ºçš„å®¹å™¨ï¼Œç”¨æˆ·å®šä¹‰çš„å…¶ä»–å®¹å™¨åˆ™é€šè¿‡Join Network Namespaceçš„æ–¹å¼ä¸Infraå®¹å™¨å…³è”åœ¨ä¸€èµ·ã€‚</p><p>Infraå®¹å™¨å ç”¨æå°‘çš„èµ„æºï¼Œä½¿ç”¨çš„æ˜¯ä¸€ä¸ªéå¸¸ç‰¹æ®Šçš„é•œåƒï¼Œå«åšk8s.gcr.io&#x2F;pauseã€‚è¿™ä¸ªé•œåƒæ˜¯ä¸€ä¸ªæ±‡ç¼–è¯­è¨€ç¼–å†™çš„ï¼Œæ°¸è¿œå¤„äºâ€æš‚åœâ€çŠ¶æ€çš„å®¹å™¨ï¼Œè§£å‹åçš„å¤§å°ä»…æœ‰100-200KBã€‚</p><p>å¯¹äºpodä¸­çš„å®¹å™¨Aå’Œå®¹å™¨Bæ¥è¯´ï¼š</p><p>â— å®ƒä»¬å¯ä»¥ç›´æ¥é€šè¿‡localhost(127.0.0.1)è¿›è¡Œé€šä¿¡ã€‚</p><p>â— å®ƒä»¬çœ‹åˆ°çš„ç½‘ç»œè®¾å¤‡å’ŒInfraå®¹å™¨çœ‹åˆ°çš„å®Œå…¨ä¸€æ ·ã€‚</p><p>â— ä¸€ä¸ªpodåªæœ‰ä¸€ä¸ªIPåœ°å€ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªpodçš„Network Namespaceå¯¹åº”çš„IPåœ°å€ã€‚</p><p>â— podä¸­çš„ç½‘ç»œèµ„æºä¸€ä¸ªpodä¸€ä»½ï¼Œéƒ½æ˜¯è¢«podä¸­çš„å®¹å™¨å…±äº«ã€‚</p><p>â— podçš„ç”Ÿå‘½å‘¨æœŸåªè·ŸInfraå®¹å™¨ä¸€è‡´ï¼Œå’Œå®¹å™¨Aã€Bæ— å…³ã€‚</p><p>â— podä¸­çš„å¤šä¸ªå®¹å™¨ä¸å…è®¸ç»‘å®šç›¸åŒçš„ç«¯å£ï¼Œå› ä¸ºæ‰€æœ‰å®¹å™¨å…±äº«ç½‘ç»œåè®®æ ˆï¼Œçœ‹åˆ°çš„ç½‘ç»œä¿¡æ¯ä¸€è‡´ã€‚</p><p>å¯¹äºåŒä¸€ä¸ªpodä¸­çš„æ‰€æœ‰ç”¨æˆ·å®¹å™¨æ¥è¯´ï¼Œå®ƒä»¬çš„è¿›å‡ºæµé‡ä¹Ÿå¯ä»¥è®¤ä¸ºéƒ½æ˜¯é€šè¿‡Infraå®¹å™¨å®Œæˆçš„ã€‚</p><p><strong>ä¸ç½‘ç»œå…±äº«ä¸åŒï¼Œpodå†…çš„å­˜å‚¨å…±äº«ä¸æ˜¯é»˜è®¤çš„ã€‚</strong></p><p>å®ƒæ˜¯éœ€è¦å†podçš„yamlæ–‡ä»¶å»è®¾ç½®çš„ã€‚é€šè¿‡åˆ›å»ºæ•°æ®å·çš„æ–¹å¼ï¼Œæ‰€æœ‰å®¹å™¨é€šè¿‡æŒ‚è½½åŒä¸€ä¸ªæ•°æ®å·å®ç°å­˜å‚¨å…±äº«</p><h3 id="2ï¼‰Pod-çš„ç”Ÿå‘½å‘¨æœŸ"><a href="#2ï¼‰Pod-çš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="2ï¼‰Pod çš„ç”Ÿå‘½å‘¨æœŸ"></a><strong>2ï¼‰Pod çš„ç”Ÿå‘½å‘¨æœŸ</strong></h3><p><strong>æ¦‚è¿°ï¼š</strong></p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753459522-d24dcf51-4f28-45d0-ad96-a4ef0a293e81.png"></p><p>æˆ‘ä»¬ä¸€èˆ¬å°†Podå¯¹è±¡ä»åˆ›å»ºåˆ°ç»ˆæ­¢çš„è¿™æ®µæ—¶é—´èŒƒå›´ç§°ä¸ºPodçš„ç”Ÿå‘½å‘¨æœŸï¼Œå®ƒä¸»è¦åŒ…å«ä¸‹é¢çš„è¿‡ç¨‹ï¼š</p><ol><li><p>Podåˆ›å»ºè¿‡ç¨‹</p></li><li><p>è¿è¡Œåˆå§‹åŒ–å®¹å™¨ï¼ˆinit containerï¼‰</p></li><li><p>è¿è¡Œä¸»å®¹å™¨ï¼ˆmain containerï¼‰ </p></li><li><p>å®¹å™¨å¯åŠ¨åé’©å­ï¼ˆpost startï¼‰ã€å®¹å™¨ç»ˆæ­¢å‰é’©å­ï¼ˆpre stopï¼‰</p></li><li><p>å®¹å™¨çš„å­˜æ´»æ€§æ¢æµ‹ï¼ˆliveness probeï¼‰ã€å°±ç»ªæ€§æ¢æµ‹ï¼ˆreadiness probeï¼‰</p></li><li><p>Podç»ˆæ­¢è¿‡ç¨‹</p></li></ol><p>åœ¨æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­ï¼ŒPodä¼šå‡ºç°5ç§çŠ¶æ€ï¼ˆç›¸ä½ï¼‰ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š</p><p>â— æŒ‚èµ·ï¼ˆPendingï¼‰ï¼šAPI Serverå·²ç»åˆ›å»ºäº†Podèµ„æºå¯¹è±¡ï¼Œä½†å®ƒå°šæœªè¢«è°ƒåº¦å®Œæˆæˆ–è€…ä»å¤„äºä¸‹è½½é•œåƒçš„è¿‡ç¨‹ä¸­</p><p>â— è¿è¡Œä¸­ï¼ˆRunningï¼‰ï¼šPodå·²ç»è¢«è°ƒåº¦åˆ°æŸèŠ‚ç‚¹ï¼Œå¹¶ä¸”æ‰€æœ‰å®¹å™¨éƒ½å·²ç»è¢«kubeletåˆ›å»ºå®Œæˆ</p><p>â— æˆåŠŸï¼ˆSucceededï¼‰ï¼šPodä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½å·²ç»æˆåŠŸç»ˆæ­¢å¹¶ä¸”ä¸ä¼šè¢«é‡å¯</p><p>â— å¤±è´¥ï¼ˆFailedï¼‰ï¼šæ‰€æœ‰å®¹å™¨éƒ½å·²ç»ç»ˆæ­¢ï¼Œä½†è‡³å°‘æœ‰ä¸€ä¸ªå®¹å™¨ç»ˆæ­¢å¤±è´¥ï¼Œå³å®¹å™¨è¿”å›äº†é0å€¼çš„é€€å‡ºçŠ¶æ€</p><p>â— æœªçŸ¥ï¼ˆUnknownï¼‰ï¼šAPI Serveræ— æ³•æ­£å¸¸è·å–åˆ°Podå¯¹è±¡çš„çŠ¶æ€ä¿¡æ¯ï¼Œé€šå¸¸ç”±äºç½‘ç»œé€šä¿¡å¤±è´¥æ‰€å¯¼è‡´</p><p><strong>Podçš„åˆ›å»ºè¿‡ç¨‹ï¼š</strong></p><ol><li><p>ç”¨æˆ·é€šè¿‡kubectlæˆ–å…¶ä»–çš„apiå®¢æˆ·ç«¯æäº¤éœ€è¦åˆ›å»ºçš„Podä¿¡æ¯ç»™API Serverã€‚</p></li><li><p>API Serverå¼€å§‹ç”ŸæˆPodå¯¹è±¡çš„ä¿¡æ¯ï¼Œå¹¶å°†ä¿¡æ¯å­˜å…¥etcdï¼Œç„¶åè¿”å›ç¡®è®¤ä¿¡æ¯è‡³å®¢æˆ·ç«¯ã€‚</p></li><li><p>API Serverå¼€å§‹åæ˜ etcdä¸­çš„Podå¯¹è±¡çš„å˜åŒ–ï¼Œå…¶å®ƒç»„ä»¶ä½¿ç”¨watchæœºåˆ¶æ¥è·Ÿè¸ªæ£€æŸ¥API Serverä¸Šçš„å˜åŠ¨ã€‚</p></li><li><p>Schedulerå‘ç°æœ‰æ–°çš„Podå¯¹è±¡è¦åˆ›å»ºï¼Œå¼€å§‹ä¸ºPodåˆ†é…ä¸»æœºå¹¶å°†ç»“æœä¿¡æ¯æ›´æ–°è‡³API Serverã€‚</p></li><li><p>NodeèŠ‚ç‚¹ä¸Šçš„kubeletå‘ç°æœ‰Podè°ƒåº¦è¿‡æ¥ï¼Œå°è¯•è°ƒåº¦Dockerå¯åŠ¨å®¹å™¨ï¼Œå¹¶å°†ç»“æœå›é€è‡³API Serverã€‚</p></li><li><p>API Serverå°†æ¥æ”¶åˆ°çš„PodçŠ¶æ€ä¿¡æ¯å­˜å…¥åˆ°etcdä¸­ã€‚</p></li></ol><p><strong>Podçš„ç»ˆæ­¢è¿‡ç¨‹</strong></p><ol><li><p>ç”¨æˆ·å‘API Serverå‘é€åˆ é™¤Podå¯¹è±¡çš„å‘½ä»¤ã€‚</p></li><li><p>API Serverä¸­çš„Podå¯¹è±¡ä¿¡æ¯ä¼šéšç€æ—¶é—´çš„æ¨ç§»è€Œæ›´æ–°ï¼Œåœ¨å®½é™æœŸå†…ï¼ˆé»˜è®¤30sï¼‰ï¼ŒPodè¢«è§†ä¸ºdeadã€‚</p></li><li><p>å°†Podæ ‡è®°ä¸ºterminatingçŠ¶æ€ã€‚</p></li><li><p>kubeleteåœ¨ç›‘æ§åˆ°Podå¯¹è±¡è½¬ä¸ºterminatingçŠ¶æ€çš„åŒæ—¶å¯åŠ¨Podå…³é—­è¿‡ç¨‹ã€‚</p></li><li><p>ç«¯ç‚¹æ§åˆ¶å™¨ç›‘æ§åˆ°Podå¯¹è±¡çš„å…³é—­è¡Œä¸ºæ—¶å°†å…¶ä»æ‰€æœ‰åŒ¹é…åˆ°æ­¤ç«¯ç‚¹çš„serviceèµ„æºçš„ç«¯ç‚¹åˆ—è¡¨ä¸­ç§»é™¤ã€‚</p></li><li><p>å¦‚æœå½“å‰Podå¯¹è±¡å®šä¹‰äº†preStopé’©å­å¤„ç†å™¨ï¼Œåˆ™åœ¨å…¶æ ‡è®°ä¸ºterminatingåä¼šä»¥åŒæ­¥çš„æ–¹å¼å¯åŠ¨æ‰§è¡Œã€‚</p></li><li><p>Podå¯¹è±¡ä¸­çš„å®¹å™¨è¿›ç¨‹æ”¶åˆ°åœæ­¢ä¿¡å·ã€‚</p></li><li><p>å®½é™æœŸç»“æŸåï¼Œå¦‚æœPodä¸­è¿˜å­˜åœ¨è¿è¡Œçš„è¿›ç¨‹ï¼Œé‚£ä¹ˆPodå¯¹è±¡ä¼šæ”¶åˆ°ç«‹å³ç»ˆæ­¢çš„ä¿¡å·ã€‚</p></li><li><p>kubectlè¯·æ±‚API Serverå°†æ­¤Podèµ„æºçš„å®½é™æœŸè®¾ç½®ä¸º0ä»è€Œå®Œæˆåˆ é™¤æ“ä½œï¼Œæ­¤æ—¶Podå¯¹äºç”¨æˆ·å·²ç»ä¸å¯ç”¨äº†ã€‚</p></li></ol><h3 id="3ï¼‰Pod-æ£€æµ‹æ¢é’ˆ"><a href="#3ï¼‰Pod-æ£€æµ‹æ¢é’ˆ" class="headerlink" title="3ï¼‰Pod æ£€æµ‹æ¢é’ˆ"></a><strong>3ï¼‰Pod æ£€æµ‹æ¢é’ˆ</strong></h3><p>å½“å®¹å™¨è¿›ç¨‹è¿è¡Œæ—¶å¦‚æœå‡ºç°äº†å¼‚å¸¸é€€å‡ºï¼ŒKubernetesåˆ™ä¼šè®¤ä¸ºå®¹å™¨å‘ç”Ÿæ•…éšœï¼Œä¼šå°è¯•è¿›è¡Œé‡å¯è§£å†³è¯¥é—®é¢˜ã€‚ä½†æœ‰ä¸å°‘æƒ…å†µæ˜¯å‘ç”Ÿäº†æ•…éšœï¼Œä½†è¿›ç¨‹å¹¶æ²¡æœ‰é€€å‡ºã€‚æ¯”å¦‚è®¿é—®WebæœåŠ¡å™¨æ—¶å‡ºç°äº†500çš„å†…éƒ¨é”™è¯¯ï¼Œå¯èƒ½æ˜¯ç³»ç»Ÿè¶…è½½ï¼Œä¹Ÿå¯èƒ½æ˜¯èµ„æºæ­»é”ï¼Œä½†Nginxè¿›ç¨‹å¹¶æ²¡æœ‰å¼‚å¸¸é€€å‡ºï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹é‡å¯å®¹å™¨å¯èƒ½æ˜¯æœ€ä½³çš„æ–¹æ³•ã€‚é‚£å¦‚ä½•æ¥å®ç°è¿™ä¸ªæ£€æµ‹å‘¢ã€‚</p><p>Kubernetesä½¿ç”¨æ¢é’ˆï¼ˆprobeï¼‰çš„æ–¹å¼æ¥ä¿éšœå®¹å™¨æ­£å¸¸è¿è¡Œï¼Œå®ç°é›¶å®•æœºã€‚å®ƒé€šè¿‡kubeletå®šæœŸå¯¹å®¹å™¨è¿›è¡Œå¥åº·æ£€æŸ¥ï¼ˆexecã€tcpã€httpï¼‰ï¼Œå½“æ¢é’ˆæ£€æµ‹åˆ°å®¹å™¨çŠ¶æ€å¼‚å¸¸æ—¶ï¼Œä¼šé€šè¿‡é‡å¯ç­–ç•¥æ¥è¿›è¡Œé‡å¯æˆ–é‡å»ºå®Œæˆä¿®å¤ã€‚ä¿®å¤åç»§ç»­è¿›è¡Œæ¢é’ˆæ£€æµ‹ï¼Œå·²ç¡®ä¿å®¹å™¨ç¨³å®šè¿è¡Œã€‚</p><p>æ¢é’ˆç±»å‹ï¼š</p><p>é’ˆå¯¹è¿è¡Œä¸­çš„å®¹å™¨ï¼Œkubeletå¯ä»¥é€‰æ‹©ä»¥ä¸‹ä¸‰ç§æ¢é’ˆæ¥æ¢æµ‹å®¹å™¨çš„çŠ¶æ€ï¼š</p><p>â—  startupProbe å¯åŠ¨æ¢é’ˆ</p><p>ç”¨äºæ£€æµ‹å®¹å™¨ä¸­çš„åº”ç”¨æ˜¯å¦å·²ç»æ­£å¸¸å¯åŠ¨ã€‚å¦‚æœä½¿ç”¨äº†å¯åŠ¨æ¢é’ˆï¼Œåˆ™æ‰€æœ‰å…¶ä»–æ¢é’ˆéƒ½ä¼šè¢«ç¦ç”¨ï¼Œéœ€è¦ç­‰å¾…å¯åŠ¨æ¢é’ˆæ£€æµ‹æˆåŠŸä¹‹åæ‰å¯ä»¥æ‰§è¡Œã€‚å¦‚æœå¯åŠ¨æ¢é’ˆæ¢æµ‹å¤±è´¥ï¼Œåˆ™kubeletä¼šå°†å®¹å™¨æ€æ­»ï¼Œè€Œå®¹å™¨ä¾å…¶é‡å¯ç­–ç•¥è¿›è¡Œé‡å¯ã€‚å¦‚æœå®¹å™¨æ²¡æœ‰æä¾›å¯åŠ¨æ¢æµ‹ï¼Œåˆ™é»˜è®¤çŠ¶æ€ä¸ºSuccessã€‚</p><p>â—  livenessProbe å­˜æ´»æ¢é’ˆ</p><p>ç”¨äºæ£€æµ‹å®¹å™¨æ˜¯å¦å­˜æ´»ï¼Œå¦‚æœå­˜æ´»æ¢æµ‹æ£€æµ‹å¤±è´¥ï¼Œkubeletä¼šæ€æ­»å®¹å™¨ï¼Œç„¶åæ ¹æ®å®¹å™¨é‡å¯ç­–ç•¥ï¼Œå†³å®šæ˜¯å¦é‡å¯è¯¥å®¹å™¨ã€‚å¦‚æœå®¹å™¨ä¸æä¾›å­˜æ´»æ¢é’ˆï¼Œåˆ™é»˜è®¤çŠ¶æ€ä¸ºSuccessã€‚ </p><p>â—  readinessProbe å°±ç»ªæ¢é’ˆ</p><p>æŒ‡å®¹å™¨æ˜¯å¦å‡†å¤‡å¥½æ¥æ”¶ç½‘ç»œè¯·æ±‚ï¼Œå¦‚æœå°±ç»ªæ¢æµ‹å¤±è´¥ï¼Œåˆ™å°†å®¹å™¨è®¾å®šä¸ºæœªå°±ç»ªçŠ¶æ€ï¼Œç„¶åå°†å…¶ä»è´Ÿè½½å‡è¡¡åˆ—è¡¨ä¸­ç§»é™¤ï¼Œè¿™æ ·å°±ä¸ä¼šæœ‰è¯·æ±‚ä¼šè°ƒåº¦åˆ°è¯¥Podä¸Šã€‚å¦‚æœå®¹å™¨ä¸æä¾›å°±ç»ªæ€æ¢é’ˆï¼Œåˆ™é»˜è®¤çŠ¶æ€ä¸ºSuccess </p><h3 id="3ï¼‰Pod-æ§åˆ¶å™¨"><a href="#3ï¼‰Pod-æ§åˆ¶å™¨" class="headerlink" title="3ï¼‰Pod æ§åˆ¶å™¨"></a><strong>3ï¼‰Pod æ§åˆ¶å™¨</strong></h3><p>è™½ç„¶è¯´ Podæ˜¯æœ€å°çš„æ§åˆ¶å•å…ƒï¼Œä½†æ˜¯kuberneteså¾ˆå°‘ç›´æ¥æ§åˆ¶Podï¼Œä¸€èˆ¬éƒ½æ˜¯é€šè¿‡Podæ§åˆ¶å™¨æ¥å®Œæˆçš„ã€‚Podæ§åˆ¶å™¨ç”¨äºPodçš„ç®¡ç†ï¼Œç¡®ä¿Podèµ„æºç¬¦åˆé¢„æœŸçš„çŠ¶æ€ï¼Œå½“Podçš„èµ„æºå‡ºç°æ•…éšœçš„æ—¶å€™ï¼Œä¼šå°è¯•è¿›è¡Œé‡å¯æˆ–é‡å»ºPodã€‚</p><p>åœ¨kubernetesä¸­Podæ§åˆ¶å™¨çš„ç§ç±»æœ‰ä¸å°‘ï¼Œè¿™é‡Œä¸‹ä»‹ç»ï¼šReplicaSetã€Deploymentã€StatefulSetã€‚Deployment ä¹Ÿæ˜¯æˆ‘ä»¬æœåŠ¡ä¸­æœ€å¸¸ç”¨çš„ã€‚</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753459436-a0036d20-9f9c-4b99-9817-3513a7fde5da.png"></p><p>æ›´å¤šçš„å¯ä»¥è§å®˜ç½‘ï¼š<a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/deployment/">Deployments | Kubernetes</a></p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753459413-158145c8-5ffb-4496-9739-e53bba0425ec.png"></p><h3 id="4ï¼‰Podçš„èµ„æºé™åˆ¶"><a href="#4ï¼‰Podçš„èµ„æºé™åˆ¶" class="headerlink" title="4ï¼‰Podçš„èµ„æºé™åˆ¶"></a><strong>4ï¼‰Podçš„èµ„æºé™åˆ¶</strong></h3><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753459757-4daa5610-9888-484b-bb61-b78015e61ea2.png"></p><p>åœ¨Kubernetesé›†ç¾¤ä¸­ï¼Œä¸ºäº†ä½¿ç³»ç»Ÿèƒ½å¤Ÿç¨³å®šçš„è¿è¡Œï¼Œé€šå¸¸ä¼šå¯¹Podçš„èµ„æºä½¿ç”¨é‡è¿›è¡Œé™åˆ¶ã€‚å¦‚æœæœ‰ä¸€ä¸ªç¨‹åºå‡ºç°å¼‚å¸¸ï¼Œå¹¶å ç”¨å¤§é‡çš„ç³»ç»Ÿèµ„æºã€‚å¦‚æœæœªå¯¹è¯¥Podè¿›è¡Œèµ„æºé™åˆ¶çš„è¯ï¼Œå¯èƒ½ä¼šå½±å“å…¶ä»–çš„Podæ­£å¸¸è¿è¡Œï¼Œä»è€Œé€ æˆä¸šåŠ¡çš„ä¸ç¨³å®šæ€§ã€‚</p><p><strong>å¦‚ä½•å®ç°èµ„æºé™åˆ¶ï¼Ÿ</strong></p><p>Kubernetesé€šè¿‡Requestså’ŒLimitså­—æ®µæ¥å®ç°å¯¹Podçš„èµ„æºè¿›è¡Œé™åˆ¶ã€‚</p><p>â— Requestsï¼šå¯åŠ¨Podæ—¶ç”³è¯·åˆ†é…çš„èµ„æºå¤§å°</p><p>â— Limitsï¼šé™åˆ¶Podè¿è¡Œæ—¶æœ€å¤§å¯ç”¨çš„èµ„æºå¤§å°</p><p>åœ¨ Kubernetes ä¸­ï¼ŒReplicaSet å’Œ Deployment æ˜¯ç”¨äºç®¡ç†å®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„æ§åˆ¶å™¨ã€‚</p><p><strong>ReplicaSet</strong>ï¼š</p><p>â— ReplicaSet æ˜¯ä¸€ç§ç¡®ä¿æŒ‡å®šæ•°é‡çš„ Pod å‰¯æœ¬åœ¨ä»»ä½•ç»™å®šæ—¶é—´è¿è¡Œçš„æ§åˆ¶å™¨ã€‚å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯ä¿æŒ Pod çš„æ•°é‡ä¸€è‡´ã€‚</p><p>â— å¦‚æœä¸€ä¸ª Pod å¤±è´¥æˆ–è¢«åˆ é™¤ï¼ŒReplicaSet ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°çš„ Pod æ¥æ›¿æ¢å®ƒã€‚</p><p>â— ReplicaSet æœ¬èº«ä¸ä¼šç®¡ç† Pod çš„æ»šåŠ¨æ›´æ–°æˆ–å›æ»šã€‚å…¶ä¸æ”¯æŒç‰ˆæœ¬</p><p><strong>Deployment</strong>ï¼š</p><p>â— Deployment æ˜¯ä¸€ç§æ›´é«˜çº§åˆ«çš„æ§åˆ¶å™¨ï¼Œå®ƒç®¡ç† ReplicaSetï¼Œä»è€Œé—´æ¥ç®¡ç† Podã€‚</p><p>â— Deployment æä¾›äº†å£°æ˜å¼çš„æ–¹å¼æ¥æ›´æ–°åº”ç”¨ç¨‹åºï¼Œå¯ä»¥<strong>è‡ªåŠ¨æ‰§è¡Œæ»šåŠ¨æ›´æ–°ã€å›æ»šä»¥åŠæš‚åœå’Œæ¢å¤æ›´æ–°ç­‰æ“ä½œ</strong>ã€‚</p><p>â— å½“ä½ åˆ›å»ºä¸€ä¸ª Deployment æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª ReplicaSet æ¥ç»´æŠ¤ Pod çš„å‰¯æœ¬æ•°é‡ã€‚</p><p><strong>StatefulSet</strong></p><p>â— <strong>åŠŸèƒ½</strong>ï¼šStatefulSet ç”¨äºç®¡ç†æœ‰çŠ¶æ€åº”ç”¨ç¨‹åºçš„éƒ¨ç½²å’Œæ‰©å±•ï¼Œä¿è¯ Pod çš„é¡ºåºå’Œç¨³å®šçš„ç½‘ç»œæ ‡è¯†ã€‚</p><p>â— <strong>ä½¿ç”¨åœºæ™¯</strong>ï¼šç”¨äºæœ‰çŠ¶æ€çš„åº”ç”¨ç¨‹åºï¼Œä¾‹å¦‚æ•°æ®åº“ã€åˆ†å¸ƒå¼ç¼“å­˜å’Œåˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿã€‚</p><p>â— <strong>ç‰¹ç‚¹</strong>ï¼šæ¯ä¸ª Pod éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ã€ç¨³å®šçš„æ ‡è¯†ç¬¦ï¼ˆhostnameï¼‰ï¼Œå³ä½¿ Pod è¢«åˆ é™¤å’Œé‡æ–°åˆ›å»ºï¼Œè¿™ä¸ªæ ‡è¯†ç¬¦ä¹Ÿä¸ä¼šæ”¹å˜ã€‚</p><p>â—‹ Pod æŒ‰ç…§å›ºå®šçš„é¡ºåºå¯åŠ¨ã€ç»ˆæ­¢å’Œæ›´æ–°ã€‚</p><p>â—‹ æä¾›äº†æŒä¹…åŒ–å­˜å‚¨çš„æ”¯æŒï¼Œé€šè¿‡ Persistent Volumeï¼ˆPVï¼‰ æ¥ä¿è¯æ•°æ®æŒä¹…æ€§ã€‚</p><p>Kubernetes åŸºæœ¬ä½¿ç”¨æ›´é«˜çº§çš„Controllerçš„æŠ½è±¡å±‚æ§åˆ¶å™¨ï¼Œæ¥ç®¡ç†Podå®ä¾‹ã€‚è¿™äº›æ§åˆ¶å™¨å¸®åŠ©ç”¨æˆ·åœ¨å„ç§åœºæ™¯ä¸­æœ‰æ•ˆåœ°éƒ¨ç½²å’Œç®¡ç†å®¹å™¨åŒ–åº”ç”¨ç¨‹åºï¼Œä½¿ Kubernetes æˆä¸ºä¸€ä¸ªåŠŸèƒ½ä¸°å¯Œä¸”çµæ´»çš„å®¹å™¨ç¼–æ’å¹³å°ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªNodeæ•…éšœï¼ŒControllerå°±èƒ½è‡ªåŠ¨å°†è¯¥èŠ‚ç‚¹ä¸Šçš„Podè°ƒåº¦åˆ°å…¶ä»–å¥åº·çš„Nodeä¸Šã€‚</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753459732-4f4a3f6e-dece-46c0-a6d6-54f144c2dfbf.png"></p><p>å››ã€ å®æˆ˜K8s</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753459905-4a1431b2-29a4-419d-848a-e0dbfc535496.png"></p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753459897-104b3ed8-c7a9-4bab-9816-82342c9e7e77.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deployment</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: docker.awsl9527.cn/library/nginx:1.14.2</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deployment</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  externalTrafficPolicy: Cluster</span><br><span class="line">  ports:</span><br><span class="line">    - nodePort: 20800</span><br><span class="line">      port: 20800</span><br><span class="line">      protocol: TCP</span><br><span class="line">      targetPort: 80</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">  type: NodePort</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  annotations: &#123;&#125;</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">  name: nginx-deployment</span><br><span class="line">  namespace: default</span><br><span class="line">  resourceVersion: &#x27;429034157&#x27;</span><br><span class="line">spec:</span><br><span class="line">  progressDeadlineSeconds: 600</span><br><span class="line">  replicas: 1</span><br><span class="line">  revisionHistoryLimit: 10</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  strategy:</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 25%</span><br><span class="line">      maxUnavailable: 25%</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      annotations:</span><br><span class="line">        kubectl.kubernetes.io/restartedAt: &#x27;2024-08-09T10:01:28+08:00&#x27;</span><br><span class="line">      creationTimestamp: null</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - image: &#x27;docker.awsl9527.cn/library/nginx:1.14.2&#x27;</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          name: nginx</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 80</span><br><span class="line">              protocol: TCP</span><br><span class="line">          resources: &#123;&#125;</span><br><span class="line">          terminationMessagePath: /dev/termination-log</span><br><span class="line">          terminationMessagePolicy: File</span><br><span class="line">      dnsPolicy: ClusterFirst</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">      securityContext: &#123;&#125;</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      </span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  annotations: &#123;&#125;</span><br><span class="line">  name: nginx-deployment</span><br><span class="line">  namespace: default</span><br><span class="line">  resourceVersion: &#x27;429033329&#x27;</span><br><span class="line">spec:</span><br><span class="line">  clusterIP: 10.97.45.150</span><br><span class="line">  externalTrafficPolicy: Cluster</span><br><span class="line">  ports:</span><br><span class="line">    - nodePort: 20800</span><br><span class="line">      port: 20800</span><br><span class="line">      protocol: TCP</span><br><span class="line">      targetPort: 80</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx</span><br><span class="line">  sessionAffinity: None</span><br><span class="line">  type: NodePort</span><br><span class="line">status:</span><br><span class="line">  loadBalancer: &#123;&#125;</span><br></pre></td></tr></table></figure><h1 id="å››ã€-Kubernetesç½‘ç»œ"><a href="#å››ã€-Kubernetesç½‘ç»œ" class="headerlink" title="å››ã€** **Kubernetesç½‘ç»œ"></a><strong>å››ã€</strong>** **<strong>Kubernetesç½‘ç»œ</strong></h1><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753460027-0c6bb51b-9132-43f3-8302-d9d13f62a9c3.png"></p><h2 id="4-1-Kubernetesç½‘ç»œæ¨¡å‹"><a href="#4-1-Kubernetesç½‘ç»œæ¨¡å‹" class="headerlink" title="4.1 Kubernetesç½‘ç»œæ¨¡å‹"></a><strong>4.1 Kubernetesç½‘ç»œæ¨¡å‹</strong></h2><p>è¯¥æ¨¡å‹å®šä¹‰äº†ï¼š</p><p>â— æ¯ä¸ª pod éƒ½æœ‰è‡ªå·±çš„ IP åœ°å€ï¼Œè¿™ä¸ª IP åœ¨é›†ç¾¤èŒƒå›´å†…å¯è¾¾ã€‚</p><p>â— Pod ä¸­çš„æ‰€æœ‰å®¹å™¨å…±äº« pod IP åœ°å€ï¼ˆåŒ…æ‹¬ MAC åœ°å€ï¼‰ï¼Œå¹¶ä¸”å®¹å™¨ä¹‹é—´å¯ä»¥ç›¸äº’é€šä¿¡ï¼ˆä½¿ç”¨ localhostï¼‰</p><p>â— Pod å¯ä»¥ä½¿ç”¨ pod IP åœ°å€ä¸é›†ç¾¤ä¸­ä»»ä¸€èŠ‚ç‚¹ä¸Šçš„å…¶ä»– pod é€šä¿¡ï¼Œæ— éœ€ NAT</p><p>â— Kubernetes çš„ç»„ä»¶ä¹‹é—´å¯ä»¥ç›¸äº’é€šä¿¡ï¼Œä¹Ÿå¯ä»¥ä¸ pod é€šä¿¡</p><p>â— ç½‘ç»œéš”ç¦»å¯ä»¥é€šè¿‡ç½‘ç»œç­–ç•¥å®ç°</p><p>ä¸Šé¢çš„å®šä¹‰ä¸­æåˆ°äº†å‡ ä¸ªç›¸å…³çš„ç»„ä»¶ï¼š</p><p>â— Podï¼šKubernetes ä¸­çš„ pod æœ‰ç‚¹ç±»ä¼¼è™šæ‹Ÿæœºæœ‰å”¯ä¸€çš„ IP åœ°å€ï¼ŒåŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šçš„ pod å…±äº«ç½‘ç»œå’Œå­˜å‚¨ã€‚</p><p>â— Containerï¼špod æ˜¯ä¸€ç»„å®¹å™¨çš„é›†åˆï¼Œè¿™äº›å®¹å™¨å…±äº«åŒä¸€ä¸ªç½‘ç»œå‘½åç©ºé—´ã€‚pod å†…çš„å®¹å™¨å°±åƒè™šæ‹Ÿæœºä¸Šçš„è¿›ç¨‹ï¼Œè¿›ç¨‹ä¹‹é—´å¯ä»¥ä½¿ç”¨ localhost è¿›è¡Œé€šä¿¡ï¼›å®¹å™¨æœ‰è‡ªå·±ç‹¬ç«‹çš„æ–‡ä»¶ç³»ç»Ÿã€CPUã€å†…å­˜å’Œè¿›ç¨‹ç©ºé—´ã€‚éœ€è¦é€šè¿‡åˆ›å»º Pod æ¥åˆ›å»ºå®¹å™¨ã€‚</p><p>â— Nodeï¼špod è¿è¡Œåœ¨èŠ‚ç‚¹ä¸Šï¼Œé›†ç¾¤ä¸­åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªèŠ‚ç‚¹ã€‚æ¯ä¸ª pod çš„ç½‘ç»œå‘½åç©ºé—´éƒ½ä¼šè¿æ¥åˆ°èŠ‚ç‚¹çš„å‘½åç©ºé—´ä¸Šï¼Œä»¥æ‰“é€šç½‘ç»œã€‚</p><p>åŒPodå†…çš„å®¹å™¨é—´é€šä¿¡</p><p>åŒ pod å†…çš„å®¹å™¨é—´é€šä¿¡æœ€ç®€å•ï¼Œè¿™äº›å®¹å™¨å…±äº«ç½‘ç»œå‘½åç©ºé—´ï¼Œæ¯ä¸ªå‘½åç©ºé—´ä¸‹éƒ½æœ‰ lo å›ç¯æ¥å£ï¼Œå¯ä»¥é€šè¿‡ localhost æ¥å®Œæˆé€šä¿¡ã€‚</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753460192-91f45142-4af6-42ba-a1bc-fc6f2e6afe65.png"></p><p>åŒèŠ‚ç‚¹ä¸ŠPodé—´é€šä¿¡</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753460176-21bd1798-2963-47d4-97dd-e2349359eb22.png"></p><p>curl å‘å‡ºçš„è¯·æ±‚æ ¹æ®å®¹å™¨å†…çš„è·¯ç”±è¡¨åˆ°è¾¾äº† pod å†…çš„ eth0 æ¥å£ã€‚ç„¶åé€šè¿‡ä¸ eth0 ç›¸è¿çš„éš§é“ veth1 åˆ°è¾¾èŠ‚ç‚¹çš„æ ¹ç½‘ç»œç©ºé—´ã€‚veth1 é€šè¿‡ç½‘æ¡¥ cni0 ä¸å…¶ä»– pod ç›¸è¿è™šæ‹Ÿä»¥å¤ªæ¥å£ veth0ç›¸è¿ï¼Œç½‘æ¡¥ä¼šè¯¢é—®æ‰€æœ‰ç›¸è¿çš„æ¥å£æ˜¯å¦æ‹¥æœ‰åŸå§‹è¯·æ±‚ä¸­çš„ IP åœ°å€ï¼ˆæ¯”å¦‚è¿™é‡Œçš„ 10.42.1.9ï¼‰ã€‚æ”¶åˆ°å“åº”åï¼Œç½‘æ¡¥ä¼šè®°å½•æ˜ å°„ä¿¡æ¯ï¼ˆ10.42.1.9 &#x3D;&gt; veth0ï¼‰ï¼ŒåŒæ—¶å°†æ•°æ®è½¬å‘è¿‡å»ã€‚æœ€ç»ˆæ•°æ®ç»è¿‡ veth0 éš§é“è¿›å…¥ pod httpbin ä¸­ã€‚</p><p>ä¸åŒèŠ‚ç‚¹ä¸Šçš„Podé—´é€šä¿¡</p><p>è·¨èŠ‚ç‚¹çš„ pod é—´é€šä¿¡ä¼šå¤æ‚ä¸€äº›ï¼Œä¸” ä¸åŒç½‘ç»œæ’ä»¶çš„å¤„ç†æ–¹å¼ä¸åŒï¼Œè¿™é‡Œé€‰æ‹©ä¸€ç§å®¹æ˜“ç†è§£çš„æ–¹å¼æ¥ç®€å•è¯´æ˜ä¸‹ã€‚</p><p>å‰åŠéƒ¨åˆ†çš„æµç¨‹ä¸åŒèŠ‚ç‚¹ pod é—´é€šä¿¡ç±»ä¼¼ï¼Œå½“è¯·æ±‚åˆ°è¾¾ç½‘æ¡¥ï¼Œç½‘æ¡¥è¯¢é—®å“ªä¸ª pod æ‹¥æœ‰è¯¥ IP ä½†æ˜¯æ²¡æœ‰å¾—åˆ°å›åº”ã€‚æµç¨‹è¿›å…¥ä¸»æœºçš„è·¯ç”±å¯»å€è¿‡ç¨‹ï¼Œåˆ°æ›´é«˜çš„é›†ç¾¤å±‚é¢ã€‚</p><p>åœ¨é›†ç¾¤å±‚é¢æœ‰ä¸€å¼ è·¯ç”±è¡¨ï¼Œé‡Œé¢å­˜å‚¨ç€æ¯ä¸ªèŠ‚ç‚¹çš„ Pod IP ç½‘æ®µï¼ˆèŠ‚ç‚¹åŠ å…¥åˆ°é›†ç¾¤æ—¶ä¼šåˆ†é…ä¸€ä¸ª Pod ç½‘æ®µï¼ˆPod CIDRï¼‰ï¼Œæ¯”å¦‚åœ¨ k3s ä¸­é»˜è®¤çš„ Pod CIDR æ˜¯ 10.42.0.0&#x2F;16ï¼ŒèŠ‚ç‚¹è·å–åˆ°çš„ç½‘æ®µæ˜¯ 10.42.0.0&#x2F;24ã€10.42.1.0&#x2F;24ã€10.42.2.0&#x2F;24ï¼Œä¾æ¬¡ç±»æ¨ï¼‰ã€‚é€šè¿‡èŠ‚ç‚¹çš„ Pod IP ç½‘æ®µå¯ä»¥åˆ¤æ–­å‡ºè¯·æ±‚ IP çš„èŠ‚ç‚¹ï¼Œç„¶åè¯·æ±‚è¢«å‘é€åˆ°è¯¥èŠ‚ç‚¹ã€‚</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753460399-45f8881e-c37a-4068-9421-b881ab13f4da.png"></p><p>æ•´ä¸ªé€šä¿¡çš„è¿‡ç¨‹éœ€è¦å„ç§ç»„ä»¶çš„é…åˆï¼Œæ¯”å¦‚ Pod ç½‘ç»œå‘½åç©ºé—´ã€pod ä»¥å¤ªç½‘æ¥å£ eth0ã€è™šæ‹Ÿä»¥å¤ªç½‘æ¥å£ vethXã€ç½‘æ¡¥ï¼ˆnetwork bridgeï¼‰ cni0 ç­‰ã€‚å…¶ä¸­æœ‰äº›ç»„ä»¶ä¸ pod ä¸€ä¸€å¯¹åº”ï¼Œä¸ pod åŒç”Ÿå‘½å‘¨æœŸã€‚è™½ç„¶å¯ä»¥é€šè¿‡æ‰‹åŠ¨çš„æ–¹å¼åˆ›å»ºã€å…³è”å’Œåˆ é™¤ï¼Œä½†å¯¹äº pod è¿™ç§éæ°¸ä¹…æ€§çš„èµ„æºä¼šè¢«é¢‘ç¹åœ°åˆ›å»ºå’Œé”€æ¯ï¼Œå¤ªå¤šäººå·¥çš„å·¥ä½œä¹Ÿæ˜¯ä¸ç°å®çš„ã€‚</p><p>å®é™…ä¸Šè¿™äº›å·¥ä½œéƒ½æ˜¯ç”±å®¹å™¨å§”æ‰˜ç»™ç½‘ç»œæ’ä»¶æ¥å®Œæˆçš„ï¼Œè€Œç½‘ç»œæ’ä»¶æ‰€éµå¾ªçš„è§„èŒƒ CNIï¼ˆContainer Network Interfaceï¼‰ã€‚</p><p>ç½‘ç»œæ’ä»¶éƒ½åšäº†ä»€ä¹ˆï¼Ÿ</p><p>â— åˆ›å»º podï¼ˆå®¹å™¨ï¼‰çš„ç½‘ç»œå‘½åç©ºé—´</p><p>â— åˆ›å»ºæ¥å£</p><p>â— åˆ›å»º veth å¯¹</p><p>â— è®¾ç½®å‘½åç©ºé—´ç½‘ç»œ</p><p>â— è®¾ç½®é™æ€è·¯ç”±</p><p>â— é…ç½®ä»¥å¤ªç½‘æ¡¥æ¥å™¨</p><p>â— åˆ†é… IP åœ°å€</p><p>â— åˆ›å»º NAT è§„åˆ™</p><p>â— ç­‰ç­‰</p><h2 id="4-2-å®è·µ-K8sé›†ç¾¤ç½‘ç»œ"><a href="#4-2-å®è·µ-K8sé›†ç¾¤ç½‘ç»œ" class="headerlink" title="4.2 å®è·µ K8sé›†ç¾¤ç½‘ç»œ"></a><strong>4.2 å®è·µ K8sé›†ç¾¤ç½‘ç»œ</strong></h2><p>kubectl get ippool -o yaml &gt; k8s-ippool.yaml</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753460351-0e5a4e99-2599-4126-b2a5-56f811ec7c39.png"></p><p>cat &#x2F;etc&#x2F;kubernetes&#x2F;manifests&#x2F;kube-controller-manager.yaml</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753460534-d4e46119-30fb-4fed-aae9-e1f61ab76d37.png"></p><p>cluster-cidr&#x3D;172.168.0.0&#x2F;16ï¼ŒæŒ‡å®šäº†é›†ç¾¤ä¸­æ‰€æœ‰ Pod å¯ä»¥ä½¿ç”¨çš„ IP åœ°å€èŒƒå›´ï¼š</p><p>â— æ‰€æœ‰ Pod çš„ IP åœ°å€éƒ½å°†åœ¨ 172.168.0.0 åˆ° 172.168.255.255 çš„èŒƒå›´å†…ã€‚</p><p>â— è¿™ä¸ªèŒƒå›´æ€»å…±æœ‰ 65,536 ä¸ª IP åœ°å€ï¼ˆ2^16 ä¸ªï¼‰ã€‚</p><p>é…ç½®æ–‡ä»¶ä¸­æ˜¯æ²¡æœ‰çœ‹åˆ° node-cidr-mask-sizeï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®çš„è¯ï¼Œ<a href="https://kubernetes.io/zh-cn/docs/reference/command-line-tools-reference/kube-controller-manager/">node-cidr-mask-sizeé»˜è®¤æ˜¯24</a>ã€‚24ä½æ©ç é•¿åº¦ï¼Œå¯¹äºipv4æ¥è¯´å°±æ˜¯åªæœ‰8ä½ä¸»æœºé•¿åº¦ï¼ˆ256ï¼‰ã€‚æ‰€ä»¥å’±ä»¬æ¯ä¸ªèŠ‚ç‚¹æœ€å¤šå¯åˆ†é… 256ä¸ªipv4ï¼ˆç†è®ºä¸Šï¼Œå®é™…ä¸Šä¼šå°‘äº›ï¼Œå› ä¸ºæœ‰äº›IPåœ°å€ä¼šä¿ç•™ï¼‰ã€‚</p><p>å› æ­¤å¯ä»¥çœ‹å‡ºï¼Œç†è®ºä¸Šï¼Œæ•´ä¸ªé›†ç¾¤æœ€å¤šå¯ä»¥æ”¯æŒ 256 ä¸ªèŠ‚ç‚¹ã€‚æ¯ä¸ªèŠ‚ç‚¹æœ€å¤šå¯å®¹çº³ 256 ä¸ª Podã€‚</p><p>cat &#x2F;etc&#x2F;kubernetes&#x2F;manifests&#x2F;kube-apiserver.yaml</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753460580-4484c6f8-a59a-4d15-99f9-da022ce2a00b.png"></p><p>Kubernetesé›†ç¾¤ä¸­æ‰€æœ‰Serviceçš„ClusterIPåœ°å€çš„åˆ†é…èŒƒå›´ï¼Œç®€ç§°ä¸ºService CIDRã€‚</p><p>service-cluster-ip-range&#x3D;10.96.0.0&#x2F;12ï¼š</p><p>è¡¨ç¤ºService IPåœ°å€çš„èŒƒå›´ä»10.96.0.0åˆ°10.111.255.255ï¼Œå¤§æ¦‚ä¸€å…±1,048,576ä¸ª ipåœ°å€ã€‚è¿™ä¸ªèŒƒå›´å…¶å®å¾ˆå¤§äº†ï¼Œæˆ‘ä»¬å®Œå…¨ç”¨ä¸ä¸Šé‚£ä¹ˆå¤šã€‚å®˜æ–¹é»˜è®¤ä¹Ÿæ˜¯ç”¨çš„12ä½æ©ç é•¿åº¦ï¼Œä¸è¿‡ä¹Ÿæœ‰äº›åªé…ç½®äº†16ä½æ©ç é•¿åº¦ï¼ˆ65,534ä¸ªipåœ°å€ï¼‰</p><p>service-node-port-range&#x3D;1-65535ï¼š</p><p>æŒ‡å®šäº†NodePortç±»å‹çš„Serviceåœ¨åˆ†é…ç«¯å£æ—¶ä½¿ç”¨çš„ç«¯å£èŒƒå›´ã€‚</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753460523-7c1ac303-df23-4f4f-8d8f-4b64450cbb13.png"></p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753460839-cc513eec-540b-41ba-b1dc-2f6844f19ea5.png"></p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753460918-c0d1bb0a-8118-4728-a036-34847e13cbc5.png"></p><p>æŒ‡å®šä¸šåŠ¡åº”ç”¨éƒ¨ç½²çš„å‘½åç©ºé—´ï¼ŒæŸ¥çœ‹å®¹å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -n finchina-dev</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe pod finchina-search-57c98cc8c-4sdkw -n finchina-dev</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs -f --tail 10 finchina-search-57c98cc8c-4sdkw -n finchina-dev</span><br><span class="line"># -f æ»šåŠ¨è¾“å‡ºæ—¥å¿—ï¼Œ--tail 10 æŸ¥çœ‹æœ€å10è¡Œæ—¥å¿—</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it finchina-search-57c98cc8c-4sdkw sh -n finchina-dev</span><br><span class="line"># å½“Podæ­£å¸¸è¿è¡Œæ—¶ï¼Œå¯ç™»å½•Podï¼Œåœ¨ Pod ä¸­çš„å®¹å™¨ä¸Šæ‰§è¡Œå‘½ä»¤ï¼Œè¿›è¡Œç¨‹åºè¿è¡Œæ•…éšœæ’æŸ¥ã€‚</span><br></pre></td></tr></table></figure><h1 id="äº”ã€è½åœ°åº”ç”¨"><a href="#äº”ã€è½åœ°åº”ç”¨" class="headerlink" title="äº”ã€è½åœ°åº”ç”¨"></a><strong>äº”ã€è½åœ°åº”ç”¨</strong></h1><h2 id="5-1-å¾®æœåŠ¡ç°åº¦æ›´æ–°ï¼ˆDevï¼‰ï¼š"><a href="#5-1-å¾®æœåŠ¡ç°åº¦æ›´æ–°ï¼ˆDevï¼‰ï¼š" class="headerlink" title="5.1 å¾®æœåŠ¡ç°åº¦æ›´æ–°ï¼ˆDevï¼‰ï¼š"></a><strong>5.1 å¾®æœåŠ¡ç°åº¦æ›´æ–°ï¼ˆDevï¼‰ï¼š</strong></h2><p>å¯åŠ¨æ¢é’ˆä¸æ»šåŠ¨æ›´æ–°é…ç½®ä¿®æ”¹</p><h2 id="5-2-å¾®æœåŠ¡ä¼˜é›…ä¸Šä¸‹çº¿ï¼ˆå†…å¤–ç½‘ï¼‰ï¼š"><a href="#5-2-å¾®æœåŠ¡ä¼˜é›…ä¸Šä¸‹çº¿ï¼ˆå†…å¤–ç½‘ï¼‰ï¼š" class="headerlink" title="5.2 å¾®æœåŠ¡ä¼˜é›…ä¸Šä¸‹çº¿ï¼ˆå†…å¤–ç½‘ï¼‰ï¼š"></a><strong>5.2 å¾®æœåŠ¡ä¼˜é›…ä¸Šä¸‹çº¿ï¼ˆå†…å¤–ç½‘ï¼‰ï¼š</strong></h2><p>å®¹å™¨ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•° PreStop+ä¸»åŠ¨é€šçŸ¥Nacosä¸‹çº¿+å®¹å™¨å»¶è¿Ÿå…³é—­ </p><h2 id="5-3-kuboardæ‰“ä¸å¼€é—®é¢˜ï¼ˆdevï¼‰"><a href="#5-3-kuboardæ‰“ä¸å¼€é—®é¢˜ï¼ˆdevï¼‰" class="headerlink" title="5.3 kuboardæ‰“ä¸å¼€é—®é¢˜ï¼ˆdevï¼‰"></a><strong>5.3 kuboardæ‰“ä¸å¼€é—®é¢˜ï¼ˆdevï¼‰</strong></h2><p>è¿™ä¸ªé—®é¢˜æœ€åå®šä½åˆ°æ˜¯ kuboardå®¹å™¨å†…etcdç©ºé—´æ»¡äº†ã€‚è¿™ä¸ªé—®é¢˜ï¼Œä¸­å°çš„k8så‡ºç°è¿‡è¿™ä¸ªé—®é¢˜ï¼Œç„¶åå®šä½è§£å†³äº†ã€‚åæ¥ç¯ä¿çš„K8sä¹Ÿå‡ºç°äº†è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘æ’æŸ¥åå‘ç°æ˜¯ä¸€æ ·çš„é—®é¢˜ã€‚é‚£ä¹ˆæ€ä¹ˆå»è§£å†³å‘¢ï¼Ÿå½“æ—¶è®°å½•ä¸‹æ¥å•¦ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">1.åœ¨k8sä¸»èŠ‚ç‚¹æ‰¾åˆ° kuboardå®¹å™¨åŠå®¹å™¨id</span><br><span class="line"></span><br><span class="line">docker exec -it 1225430a4689 sh</span><br><span class="line"></span><br><span class="line">2.è¿›å…¥å®¹å™¨æ‰§è¡Œç›¸å…³etcdæ¸…ç†å†å²ç‰ˆæœ¬ç¼“å­˜å’Œå‹ç¼©æ•°æ®</span><br><span class="line"></span><br><span class="line">ETCDCTL_API=3 etcdctl --write-out=table endpoint status</span><br><span class="line"></span><br><span class="line"># è·å–å½“å‰ç‰ˆæœ¬</span><br><span class="line">rev=$(ETCDCTL_API=3 etcdctl --endpoints=http://127.0.0.1:2379 endpoint status --write-out=&quot;json&quot; | egrep -o &#x27;&quot;revision&quot;:[0-9]*&#x27; | egrep -o &#x27;[0-9].*&#x27;)</span><br><span class="line"></span><br><span class="line"># å‹ç¼©æ‰€æœ‰æ—§ç‰ˆæœ¬</span><br><span class="line">ETCDCTL_API=3 etcdctl --endpoints=http://127.0.0.1:2379 compact $rev</span><br><span class="line"></span><br><span class="line"># æ•´ç†å¤šä½™çš„ç©ºé—´</span><br><span class="line">ETCDCTL_API=3 etcdctl --endpoints=http://127.0.0.1:2379 defrag</span><br><span class="line"></span><br><span class="line"># å–æ¶ˆå‘Šè­¦ä¿¡æ¯</span><br><span class="line">ETCDCTL_API=3 etcdctl --endpoints https://127.0.0.1:2379 --insecure-skip-tls-verify alarm disarm</span><br></pre></td></tr></table></figure><h1 id="å…­ã€-æ—¥å¸¸ä½¿ç”¨çŸ¥è¯†ç‚¹"><a href="#å…­ã€-æ—¥å¸¸ä½¿ç”¨çŸ¥è¯†ç‚¹" class="headerlink" title="å…­ã€** **æ—¥å¸¸ä½¿ç”¨çŸ¥è¯†ç‚¹"></a><strong>å…­ã€</strong>** **<strong>æ—¥å¸¸ä½¿ç”¨çŸ¥è¯†ç‚¹</strong></h1><p>è¿™é‡Œç»™å¤§å®¶ä»‹ç»ä¸€ç‚¹ç‚¹æ—¥å¸¸ä½¿ç”¨ k8sçš„ä¸€äº›çŸ¥è¯†ç‚¹</p><h2 id="1ã€-å®¹å™¨æ—¥å¿—åœ¨å“ªï¼Ÿé‡å¯å®¹å™¨åæ—¥å¿—æ˜¯ä¸æ˜¯å°±ä¸¢äº†ï¼Ÿ"><a href="#1ã€-å®¹å™¨æ—¥å¿—åœ¨å“ªï¼Ÿé‡å¯å®¹å™¨åæ—¥å¿—æ˜¯ä¸æ˜¯å°±ä¸¢äº†ï¼Ÿ" class="headerlink" title="1ã€** **å®¹å™¨æ—¥å¿—åœ¨å“ªï¼Ÿé‡å¯å®¹å™¨åæ—¥å¿—æ˜¯ä¸æ˜¯å°±ä¸¢äº†ï¼Ÿ"></a><strong>1ã€</strong>** **<strong>å®¹å™¨æ—¥å¿—åœ¨å“ªï¼Ÿé‡å¯å®¹å™¨åæ—¥å¿—æ˜¯ä¸æ˜¯å°±ä¸¢äº†ï¼Ÿ</strong></h2><p>æƒ³è¦äº†è§£æœåŠ¡çš„æ—¥å¿—ï¼Œå…ˆè¦çœ‹ æœåŠ¡çš„ logback-custom.xml é…ç½®æ–‡ä»¶ã€‚<a href="https://drive.weixin.qq.com/s?k=ALAAYAcbAAggnC2OKwARoAKAbGAKo">logback-custom.xml</a></p><p><strong>æ—¥å¿—çº§åˆ«è¿‡æ»¤ï¼ˆLevelFilterï¼‰</strong>ï¼š</p><p>â— æ¯ä¸ªæ—¥å¿—æ–‡ä»¶ appender éƒ½æœ‰ä¸€ä¸ª LevelFilterï¼Œç”¨äºè¿‡æ»¤ä¸åŒçº§åˆ«çš„æ—¥å¿—ã€‚</p><p>â— ä¾‹å¦‚ï¼ŒDEBUG_FILE åªæ¥å— DEBUG çº§åˆ«çš„æ—¥å¿—ï¼ŒINFO_FILE åªæ¥å— INFO çº§åˆ«- æ—¥å¿—ï¼ŒWARN_FILE åªæ¥å— WARN çº§åˆ«çš„æ—¥å¿—ï¼ŒERROR_FILE åªæ¥å— ERROR çº§åˆ«çš„æ—¥å¿—ã€‚</p><p>â— è¿™ç¡®ä¿äº†ä¸åŒçº§åˆ«çš„æ—¥å¿—è¢«æ­£ç¡®è®°å½•åˆ°ç›¸åº”çš„æ—¥å¿—æ–‡ä»¶ä¸­ã€‚</p><p><strong>æ—¥å¿—æ»šåŠ¨ç­–ç•¥</strong>ï¼š</p><p>â— æ¯ä¸ªæ—¥å¿—æ–‡ä»¶ï¼ˆDEBUG_FILE, INFO_FILE, WARN_FILE, ERROR_FILEï¼‰ä½¿ç”¨äº† RollingFileAppenderï¼Œå¹¶ä¸”æŒ‡å®šäº† TimeBasedRollingPolicyã€‚</p><p>â— è¯¥ç­–ç•¥å…è®¸æ—¥å¿—æŒ‰æ—¥æœŸæ»šåŠ¨ï¼Œå¹¶ç»“åˆæ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆ<maxFileSize>10MB</maxFileSize>ï¼‰ï¼Œå½“æ—¥å¿—æ–‡ä»¶è¾¾åˆ° 10MB æ—¶ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ—¥å¿—æ–‡ä»¶ã€‚</p><p><strong>æ—¥å¿—ä¿ç•™å¤©æ•°</strong>ï¼š</p><p>â— åœ¨æ¯ä¸ª RollingFileAppender é…ç½®ä¸­ï¼Œ<rollingPolicy> çš„ <maxHistory> å…ƒç´ å®šä¹‰äº†æ—¥å¿—çš„ä¿ç•™å¤©æ•°ã€‚æ‰€æœ‰æ—¥å¿—ç±»å‹çš„ <maxHistory> éƒ½è®¾ç½®ä¸º 15</p><p>â— è¿™è¡¨ç¤ºæ¯ä¸ªæ—¥å¿—æ–‡ä»¶çš„å¤‡ä»½æœ€å¤šä¿ç•™ 15 å¤©ã€‚è¶…è¿‡ 15 å¤©çš„æ—¥å¿—æ–‡ä»¶ä¼šè‡ªåŠ¨åˆ é™¤ï¼Œä»¥èŠ‚çœå­˜å‚¨ç©ºé—´ã€‚</p><p>å…¶å®è¿™é‡Œæˆ‘ä»¬ä¹Ÿæ²¡çœ‹åˆ°å®¹å™¨çš„æ—¥å¿—å…·ä½“æ˜¯å­˜åœ¨å“ªï¼Ÿ</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753460975-d28f4827-6634-45d2-8bba-f84d9b883751.png"></p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753460924-efd7c89e-c087-4338-9fa1-1bc315dc30bd.png"></p><p>é‚£ä¹ˆè¿™ä¸ªlogger.logHome æ˜¯åœ¨å“ªå‘¢ï¼Œå…¶å®å®ƒæ˜¯æ”¾åœ¨äº† nacosçš„å…¬å…±é…ç½®æ–‡ä»¶ finchina_middle_common.yml ä¸­</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753460988-93dba953-68bf-49bc-a41b-181dbac93b09.png"></p><p>è¿™æ ·å°±å¤§æ¦‚çŸ¥é“äº†æ–‡ä»¶çš„è·¯å¾„äº†ã€‚åœ¨å®¹å™¨ä¸­æ¯ä¸ªæœåŠ¡çš„æ—¥å¿—æ–‡ä»¶æ˜¯å­˜å‚¨åœ¨ </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/apps/logs/æœåŠ¡å/</span><br><span class="line"># ä¾‹å¦‚informationï¼š/apps/logs/information</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çŸ¥é“å½“å®ä¾‹è¢«é‡å¯æˆ–è€…é”€æ¯æ—¶ï¼Œå®¹å™¨ä¹Ÿä¼šå“åº”çš„é”€æ¯ã€‚é‚£ä¹ˆæ˜¯å¦å®¹å™¨é‡Œçš„æ—¥å¿—æ–‡ä»¶éƒ½ä¼šæ²¡äº†ã€‚è¿™å°±è¦çœ‹ æœåŠ¡å®¹å™¨ç»„çš„yamlæ–‡ä»¶äº†</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753461992-5f0f5de5-aea2-48f8-97c4-f0ec059f59bc.png"></p><p>æ‰€ä»¥èƒ½çŸ¥é“ï¼Œdev informationå®ä¾‹å®¹å™¨é‡Œçš„ &#x2F;apps&#x2F;logs ç›®å½•æ˜¯è¢«æŒä¹…åŒ–æŒ‚è½½åœ¨ç‰©ç†æœºçš„ &#x2F;app&#x2F;pod-logs&#x2F;finchina-release ç›®å½•ä¸‹çš„ã€‚</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753462006-a1103bb4-e61b-4388-948a-242b1da7250d.png"></p><p>ä»ä¸Šå›¾å¯ä»¥çœ‹åˆ° ç‰©ç†æœºipæ˜¯ 10.10.18.244ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥å»è¿™ä¸ªç‰©ç†æœºä¸Šçœ‹åˆ°æ—¥å¿—ã€‚å¹¶ä¸”å› ä¸ºæ˜¯æŒä¹…åŒ–æŒ‚è½½ï¼Œç‰©ç†æœºå¯ä»¥ä¿å­˜å®¹å™¨çš„æ—¥å¿—ï¼Œå¹¶ä¸”å®¹å™¨é”€æ¯åæ—¥å¿—ä¾æ—§å­˜åœ¨ã€‚</p><p>â— å¦‚æœå®ä¾‹é‡å¯åï¼Œéƒ¨ç½²åˆ°å…¶ä»–ç‰©ç†æœºä¸Šåï¼Œæ—§ç‰©ç†æœºä¸Šçš„æ—¥å¿—ä¸ä¼šåˆ é™¤ã€‚å¦‚æœéƒ¨ç½²åœ¨åŸç‰©ç†æœºä¸Šï¼Œåˆ™æ—¥å¿—ä¼šè¿½åŠ ï¼Œå¹¶ä¸ä¼šè¦†ç›–å†å²æ—¥å¿—ã€‚</p><p>â— éƒ¨ç½²åˆ°æ–°ç‰©ç†æœºä¸Šåï¼Œæ–°æ—¥å¿—ä¼šè¿½åŠ åœ¨æ–°ç‰©ç†æœºå¯¹åº”ç›®å½•ä¸Šã€‚</p><p>å®¹å™¨çš„æœåŠ¡æ—¥å¿—éƒ½ä¼šå­˜å‚¨åœ¨ç‰©ç†æœºä¸Šï¼Œä¸ä¼šä¸¢å¤±ã€‚é‚£ä¹ˆæ—¶é—´æ—§äº†ï¼Œé‚£ä¹ˆå¤šæ—¥å¿—æ€ä¹ˆåŠï¼Ÿæˆ‘ä»ç›®å‰æˆ‘ä»¬çš„æ–¹æ¡ˆé‡Œï¼Œå…¶å®æ²¡æœ‰çœ‹åˆ°é’ˆå¯¹è¿™ä¸ªçš„ç‰¹åˆ«å¤„ç†ã€‚åæ¥æˆ‘é—®äº†ä¸‹è¿ç»´ï¼Œå› ä¸ºé‚£ä¹ˆå¤šæ—¥å¿—ä¸èƒ½ä¸å»æ¸…ç†ï¼Œçº¿ä¸Šåº”è¯¥æ˜¯æœ‰å®šæ—¶æ¸…ç†ä»»åŠ¡çš„ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*/30 * * * * /bin/find /app/ -mtime +7  -iname &quot;*.log&quot;| /bin/xargs /bin/rm -rf</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬devèŠ‚ç‚¹æœåŠ¡å™¨æ˜¯æ²¡æœ‰å®šæ—¶æ¸…ç†çš„ï¼Œæ‰€ä»¥ä¼šç§¯æ”’å†å²æ—¥å¿—ã€‚</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753462062-e411c502-1a9b-42a4-9834-fc6900a74e69.png"></p><h2 id="2ã€-é•œåƒæ‹‰ä¸ä¸‹æ¥ï¼Ÿ"><a href="#2ã€-é•œåƒæ‹‰ä¸ä¸‹æ¥ï¼Ÿ" class="headerlink" title="2ã€** **é•œåƒæ‹‰ä¸ä¸‹æ¥ï¼Ÿ"></a><strong>2ã€</strong>** **<strong>é•œåƒæ‹‰ä¸ä¸‹æ¥ï¼Ÿ</strong></h2><p>ç”±äºæ”¿ç­–åŸå› ï¼Œä¹‹å‰23å¹´6æœˆä¸å…è®¸è®¿é—®å®˜æ–¹é•œåƒä»“åº“ Docker Hubï¼Œæ‰€ä»¥å¤§å®¶éƒ½æ˜¯ç”¨å›½å†…é•œåƒç«™ã€‚ä½†æ˜¯ä»Šå¹´6æœˆå›½å†…DockeråŠ é€Ÿé•œåƒä¹Ÿè¢«è¦æ±‚å…¨éƒ¨å…³é—­ã€‚åç»­å„ç§åŒ…ç®¡ç†å·¥å…·å¯èƒ½éƒ½ä¼šä¸‹æ¶ï¼ˆnpmç­‰ï¼‰ã€‚</p><p>è¿™æ¬¡è§£å†³æ˜¯ç”¨äº†ä¸€äº›å›½å¤–é•œåƒç«™ã€‚</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753462119-cc9e4a36-dd1b-47fe-8acb-f4e0a4726478.png"></p><p>ä¿®æ”¹èŠ‚ç‚¹æœºå™¨çš„dockerä»“åº“æºé…ç½®ï¼š</p><p>vim &#x2F;etc&#x2F;docker&#x2F;daemon.json</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">  &quot;log-driver&quot;: &quot;json-file&quot;,</span><br><span class="line">  &quot;log-opts&quot;: &#123;</span><br><span class="line">    &quot;max-size&quot;: &quot;100m&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;storage-driver&quot;: &quot;overlay2&quot;,</span><br><span class="line">  &quot;storage-opts&quot;: [</span><br><span class="line">    &quot;overlay2.override_kernel_check=true&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;insecure-registries&quot;: [&quot;docker-repository.finchina.local&quot;,&quot;10.15.98.150&quot;],</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://hub.uuuadc.top&quot;,</span><br><span class="line">        &quot;https://docker.anyhub.us.kg&quot;,</span><br><span class="line">        &quot;https://dockerhub.jobcher.com&quot;,</span><br><span class="line">        &quot;https://dockerhub.icu&quot;,</span><br><span class="line">        &quot;https://docker.ckyl.me&quot;,</span><br><span class="line">        &quot;https://7myrbfdb.mirror.aliyuncs.com&quot;,</span><br><span class="line">        &quot;https://docker.awsl9527.cn&quot;],</span><br><span class="line">  &quot;graph&quot;:&quot;/app/docker&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶ï¼Œä¸è¡Œçš„è¯å†é‡å¯docker</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure><p>å¦‚æœå­˜åœ¨æœºå™¨ä¾æ—§æ‹‰å–æ…¢ï¼Œå¯ä»¥æ‰¾æœ‰é•œåƒçš„æœºå™¨å°†é•œåƒæ‰“åŒ…æ¨é€åˆ°æˆ‘ä»¬ç§æœ‰çš„harboråº“é‡Œã€‚ä¹‹å‰å°±æœ‰å³ä½¿é…ç½®äº†åŠ é€Ÿæºï¼Œä¹Ÿæ‹‰ä¸åŠ¨é•œåƒã€‚æ‰€ä»¥å°±æŠŠ calicoæ’ä»¶é•œåƒæ¨é€åˆ°ä»“åº“äº†ã€‚è¿™æ ·æ‹‰é•œåƒå°±ç‰¹åˆ«å¿«ï¼Œå¹¶ä¸”ä¹Ÿå¯ä»¥é˜²æ­¢åŠ é€Ÿæºè¢«åºŸå¼ƒã€‚</p><p><a href="http://10.15.98.150/harbor/projects/44/repositories">http://10.15.98.150/harbor/projects/44/repositories</a></p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753462369-c8ec4cdc-00a2-4c3e-b408-d506e6aca4a7.png"></p><h2 id="3-å®¹å™¨ç½‘ç»œé—®é¢˜ï¼Œæ— æ³•è¯·æ±‚åˆ°å…¶ä»–å®¹å™¨ï¼Ÿæ— æ³•è§£æåŸŸåï¼Ÿ"><a href="#3-å®¹å™¨ç½‘ç»œé—®é¢˜ï¼Œæ— æ³•è¯·æ±‚åˆ°å…¶ä»–å®¹å™¨ï¼Ÿæ— æ³•è§£æåŸŸåï¼Ÿ" class="headerlink" title="3.** **** å®¹å™¨ç½‘ç»œé—®é¢˜ï¼Œæ— æ³•è¯·æ±‚åˆ°å…¶ä»–å®¹å™¨ï¼Ÿæ— æ³•è§£æåŸŸåï¼Ÿ**"></a><strong>3.</strong>** **** å®¹å™¨ç½‘ç»œé—®é¢˜ï¼Œæ— æ³•è¯·æ±‚åˆ°å…¶ä»–å®¹å™¨ï¼Ÿæ— æ³•è§£æåŸŸåï¼Ÿ**</h2><h3 id="3-1-ç½‘ç»œpingä¸é€š"><a href="#3-1-ç½‘ç»œpingä¸é€š" class="headerlink" title="3.1 ç½‘ç»œpingä¸é€š"></a><strong>3.1 ç½‘ç»œpingä¸é€š</strong></h3><p>é—®é¢˜å¯ä»¥è¿›å»å…ˆè¿›å»å®¹å™¨ ping å…¶ä»–èŠ‚ç‚¹ä¸Šå®¹å™¨ç»„ipï¼Œçœ‹podä¹‹é—´ç½‘ç»œé€šä¿¡æ˜¯å¦æ­£å¸¸ã€‚å¦‚æœå‘ç°pingä¸åŒï¼Œé‚£å°±åŸºæœ¬å¯ä»¥ç¡®è®¤æ˜¯å®¹å™¨ç½‘ç»œé—®é¢˜ã€‚</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753463288-d1f55e50-6c5a-45d0-a6f0-4f86cb97d673.png"></p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753463215-af4c2b7a-e64c-4dce-939e-740f531b8b61.png"></p><p>è¿™ç§ç½‘ç»œé—®é¢˜ä¸€èˆ¬éƒ½æ˜¯ calicoç½‘ç»œæ’ä»¶é—®é¢˜ï¼Œå¯ä»¥å»çœ‹ä¸‹å¯¹åº”èŠ‚ç‚¹çš„ calico-node æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œå¯ä»¥å°è¯•é‡å¯ä¸‹ã€‚</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753463334-af8c548e-462e-4476-8aec-081d62dc6a7a.png"></p><h3 id="3-2-å¤–éƒ¨åŸŸåè§£æä¸æˆåŠŸ"><a href="#3-2-å¤–éƒ¨åŸŸåè§£æä¸æˆåŠŸ" class="headerlink" title="3.2 å¤–éƒ¨åŸŸåè§£æä¸æˆåŠŸ"></a><strong>3.2 å¤–éƒ¨åŸŸåè§£æä¸æˆåŠŸ</strong></h3><p>è¿™ç§é—®é¢˜ä¸€èˆ¬æ˜¯ corednsç»„ä»¶è¿è¡Œæœ‰é—®é¢˜ã€‚å¦‚æœè¿˜æœ‰é—®é¢˜ï¼Œå¯ä»¥å†æ£€æŸ¥ä¸‹ node-local-dns åœ¨èŠ‚ç‚¹ä¸Šæ˜¯å¦æ­£å¸¸è¿è¡Œã€‚</p><p><img src="https://cdn.nlark.com/yuque/0/2025/png/35838370/1746753463322-98998a56-d079-469f-99f0-78c5d6f1d56a.png"></p><ol start="4"><li>èŠ‚ç‚¹ç£ç›˜æ»¡äº†æ€ä¹ˆåŠï¼Ÿ</li></ol><p>docker system prune -a</p><p>sudo find &#x2F;app&#x2F; -mtime +7 -iname â€œ*.logâ€ | sudo xargs rm -rf</p>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> äº‘åŸç”Ÿ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Argon2å¯†ç å“ˆå¸Œç®—æ³•æ·±åº¦è§£æï¼šåŸç†ã€å®ç°ä¸å®æˆ˜åº”ç”¨</title>
      <link href="/2025/06/22/Argon2%E5%AF%86%E7%A0%81%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%EF%BC%9A%E5%8E%9F%E7%90%86%E5%AE%9E%E7%8E%B0%E4%B8%8E%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8/"/>
      <url>/2025/06/22/Argon2%E5%AF%86%E7%A0%81%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%EF%BC%9A%E5%8E%9F%E7%90%86%E5%AE%9E%E7%8E%B0%E4%B8%8E%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h1 id="Argon2å¯†ç å“ˆå¸Œç®—æ³•æ·±åº¦è§£æï¼šåŸç†ã€å®ç°ä¸å®æˆ˜åº”ç”¨"><a href="#Argon2å¯†ç å“ˆå¸Œç®—æ³•æ·±åº¦è§£æï¼šåŸç†ã€å®ç°ä¸å®æˆ˜åº”ç”¨" class="headerlink" title="Argon2å¯†ç å“ˆå¸Œç®—æ³•æ·±åº¦è§£æï¼šåŸç†ã€å®ç°ä¸å®æˆ˜åº”ç”¨"></a>Argon2å¯†ç å“ˆå¸Œç®—æ³•æ·±åº¦è§£æï¼šåŸç†ã€å®ç°ä¸å®æˆ˜åº”ç”¨</h1><h2 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h2><p>åšåç«¯å¼€å‘è¿™äº›å¹´ï¼Œå¯†ç å­˜å‚¨ä¸€ç›´æ˜¯ä¸ªè®©äººå¤´ç–¼çš„é—®é¢˜ã€‚æ—©æœŸé¡¹ç›®ç”¨MD5ï¼Œåæ¥çŸ¥é“ä¸å®‰å…¨äº†æ”¹SHA-256ï¼Œå†åæ¥å¬è¯´è¦åŠ ç›ï¼Œåˆæäº†SHA-512+éšæœºç›ã€‚ä½†æ€»æ„Ÿè§‰å¿ƒé‡Œä¸è¸å®ï¼Œç›´åˆ°é‡åˆ°äº†Argon2ã€‚</p><p>è¿™ç¯‡æ–‡ç« ä¸æ˜¯ç®€å•çš„APIè°ƒç”¨æ•™ç¨‹ï¼Œè€Œæ˜¯è¦æŠŠArgon2çš„åº•å±‚åŸç†æ°å¼€äº†è®²æ¸…æ¥šï¼Œå‘Šè¯‰ä½ ä¸ºä»€ä¹ˆå®ƒæ¯”ä¼ ç»Ÿå“ˆå¸Œç®—æ³•å®‰å…¨ï¼Œä»¥åŠåœ¨å®é™…é¡¹ç›®ä¸­æ€ä¹ˆç”¨ã€‚</p><h2 id="ç¬¬ä¸€éƒ¨åˆ†ï¼šé—®é¢˜èƒŒæ™¯-ä¸ºä»€ä¹ˆéœ€è¦Argon2"><a href="#ç¬¬ä¸€éƒ¨åˆ†ï¼šé—®é¢˜èƒŒæ™¯-ä¸ºä»€ä¹ˆéœ€è¦Argon2" class="headerlink" title="ç¬¬ä¸€éƒ¨åˆ†ï¼šé—®é¢˜èƒŒæ™¯ - ä¸ºä»€ä¹ˆéœ€è¦Argon2"></a>ç¬¬ä¸€éƒ¨åˆ†ï¼šé—®é¢˜èƒŒæ™¯ - ä¸ºä»€ä¹ˆéœ€è¦Argon2</h2><h3 id="1-1-ä¼ ç»Ÿå“ˆå¸Œç®—æ³•çš„æ ¹æœ¬é—®é¢˜"><a href="#1-1-ä¼ ç»Ÿå“ˆå¸Œç®—æ³•çš„æ ¹æœ¬é—®é¢˜" class="headerlink" title="1.1 ä¼ ç»Ÿå“ˆå¸Œç®—æ³•çš„æ ¹æœ¬é—®é¢˜"></a>1.1 ä¼ ç»Ÿå“ˆå¸Œç®—æ³•çš„æ ¹æœ¬é—®é¢˜</h3><p>æˆ‘ä»¬å…ˆçœ‹çœ‹ä¸ºä»€ä¹ˆSHA-512è¿™ç±»ç®—æ³•åœ¨å¯†ç å­˜å‚¨ä¸Šæœ‰å¤©ç„¶ç¼ºé™·ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># SHA-512çš„è®¡ç®—é€Ÿåº¦æµ‹è¯•</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_sha512_speed</span>():</span><br><span class="line">    password = <span class="string">&quot;user_password_123&quot;</span></span><br><span class="line">    salt = <span class="string">&quot;random_salt_xyz&quot;</span></span><br><span class="line">    </span><br><span class="line">    start_time = time.time()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000000</span>):  <span class="comment"># 100ä¸‡æ¬¡è®¡ç®—</span></span><br><span class="line">        hash_result = hashlib.sha512((password + salt).encode()).hexdigest()</span><br><span class="line">    end_time = time.time()</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;SHA-512è®¡ç®—100ä¸‡æ¬¡è€—æ—¶: <span class="subst">&#123;end_time - start_time:<span class="number">.2</span>f&#125;</span>ç§’&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;å¹³å‡æ¯æ¬¡: <span class="subst">&#123;(end_time - start_time) * <span class="number">1000000</span>:<span class="number">.2</span>f&#125;</span>å¾®ç§’&quot;</span>)</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªé€Ÿåº¦æ„å‘³ç€ä»€ä¹ˆï¼Ÿ<strong>æ”»å‡»è€…ç”¨ä¸€å—æ™®é€šæ˜¾å¡ï¼Œæ¯ç§’å¯ä»¥å°è¯•æ•°åäº¿ä¸ªå¯†ç </strong>ã€‚å³ä½¿ä½ åŠ äº†ç›ï¼Œåªè¦å¯†ç æœ¬èº«ä¸å¤Ÿå¤æ‚ï¼Œè¢«ç ´è§£åªæ˜¯æ—¶é—´é—®é¢˜ã€‚</p><p>é—®é¢˜çš„æ ¸å¿ƒåœ¨äºï¼š<strong>SHA-512è¢«è®¾è®¡ä¸ºå¿«é€Ÿè®¡ç®—å“ˆå¸Œå€¼ï¼Œè€Œå¯†ç éªŒè¯éœ€è¦çš„æ˜¯æ…¢é€Ÿå“ˆå¸Œ</strong>ã€‚</p><h3 id="1-2-çœŸå®ä¸–ç•Œçš„æ”»å‡»æˆæœ¬åˆ†æ"><a href="#1-2-çœŸå®ä¸–ç•Œçš„æ”»å‡»æˆæœ¬åˆ†æ" class="headerlink" title="1.2 çœŸå®ä¸–ç•Œçš„æ”»å‡»æˆæœ¬åˆ†æ"></a>1.2 çœŸå®ä¸–ç•Œçš„æ”»å‡»æˆæœ¬åˆ†æ</h3><p>è®©æˆ‘ä»¬ç®—ç¬”è´¦ã€‚å‡è®¾æ”»å‡»è€…æ‹¿åˆ°äº†ä½ çš„æ•°æ®åº“ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¸¸è§å¯†ç çš„SHA-512ç ´è§£æ—¶é—´ä¼°ç®—</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">crack_time_estimation</span>():</span><br><span class="line">    <span class="comment"># GPUç®—åŠ›ï¼šå‡è®¾RTX 4090ï¼ŒSHA-512çº¦20äº¿æ¬¡/ç§’</span></span><br><span class="line">    gpu_speed = <span class="number">2_000_000_000</span>  </span><br><span class="line">    </span><br><span class="line">    passwords_by_length = &#123;</span><br><span class="line">        <span class="string">&quot;6ä½æ•°å­—&quot;</span>: <span class="number">10</span>**<span class="number">6</span>,                    <span class="comment"># 1,000,000ç§ç»„åˆ</span></span><br><span class="line">        <span class="string">&quot;8ä½å°å†™å­—æ¯&quot;</span>: <span class="number">26</span>**<span class="number">8</span>,                <span class="comment"># 208,827,064,576ç§ç»„åˆ(çº¦2088äº¿)</span></span><br><span class="line">        <span class="string">&quot;8ä½å¤§å°å†™+æ•°å­—&quot;</span>: (<span class="number">26</span>+<span class="number">26</span>+<span class="number">10</span>)**<span class="number">8</span>,     <span class="comment"># 218,340,105,584,896ç§ç»„åˆ(çº¦218ä¸‡äº¿)</span></span><br><span class="line">        <span class="string">&quot;12ä½å¤§å°å†™+æ•°å­—+ç¬¦å·&quot;</span>: (<span class="number">94</span>)**<span class="number">12</span>     <span class="comment"># å¤©æ–‡æ•°å­—</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> desc, combinations <span class="keyword">in</span> passwords_by_length.items():</span><br><span class="line">        <span class="comment"># å¹³å‡éœ€è¦å°è¯•ä¸€åŠçš„ç»„åˆæ•°</span></span><br><span class="line">        avg_attempts = combinations // <span class="number">2</span></span><br><span class="line">        time_seconds = avg_attempts / gpu_speed</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> time_seconds &lt; <span class="number">1</span>:</span><br><span class="line">            time_str = <span class="string">f&quot;<span class="subst">&#123;time_seconds*<span class="number">1000</span>:<span class="number">.1</span>f&#125;</span>æ¯«ç§’&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> time_seconds &lt; <span class="number">60</span>:</span><br><span class="line">            time_str = <span class="string">f&quot;<span class="subst">&#123;time_seconds:<span class="number">.1</span>f&#125;</span>ç§’&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> time_seconds &lt; <span class="number">3600</span>:</span><br><span class="line">            time_str = <span class="string">f&quot;<span class="subst">&#123;time_seconds/<span class="number">60</span>:<span class="number">.1</span>f&#125;</span>åˆ†é’Ÿ&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> time_seconds &lt; <span class="number">86400</span>:</span><br><span class="line">            time_str = <span class="string">f&quot;<span class="subst">&#123;time_seconds/<span class="number">3600</span>:<span class="number">.1</span>f&#125;</span>å°æ—¶&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> time_seconds &lt; <span class="number">86400</span>*<span class="number">365</span>:</span><br><span class="line">            time_str = <span class="string">f&quot;<span class="subst">&#123;time_seconds/<span class="number">86400</span>:<span class="number">.1</span>f&#125;</span>å¤©&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            time_str = <span class="string">f&quot;<span class="subst">&#123;time_seconds/(<span class="number">86400</span>*<span class="number">365</span>):<span class="number">.1</span>f&#125;</span>å¹´&quot;</span></span><br><span class="line">            </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;desc&#125;</span>: å¹³å‡ç ´è§£æ—¶é—´ <span class="subst">&#123;time_str&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®é™…è®¡ç®—ç»“æœï¼š</span></span><br><span class="line"><span class="comment"># 6ä½æ•°å­—: å¹³å‡ç ´è§£æ—¶é—´ 0.3æ¯«ç§’</span></span><br><span class="line"><span class="comment"># 8ä½å°å†™å­—æ¯: å¹³å‡ç ´è§£æ—¶é—´ 52.2ç§’</span></span><br><span class="line"><span class="comment"># 8ä½å¤§å°å†™+æ•°å­—: å¹³å‡ç ´è§£æ—¶é—´ 15.2å°æ—¶</span></span><br><span class="line"><span class="comment"># 12ä½å¤§å°å†™+æ•°å­—+ç¬¦å·: å¹³å‡ç ´è§£æ—¶é—´å¾— 1000å¹´ä»¥ä¸Šï¼ˆé¡¶çº§æ¶ˆè´¹çº§ GPUï¼‰</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œé™¤éç”¨æˆ·å¯†ç ç‰¹åˆ«å¤æ‚ï¼Œå¦åˆ™SHA-512åŸºæœ¬ä¸Šå°±æ˜¯åœ¨è£¸å¥”ã€‚</p><h2 id="ç¬¬äºŒéƒ¨åˆ†ï¼šArgon2åŸºç¡€æ¦‚å¿µ"><a href="#ç¬¬äºŒéƒ¨åˆ†ï¼šArgon2åŸºç¡€æ¦‚å¿µ" class="headerlink" title="ç¬¬äºŒéƒ¨åˆ†ï¼šArgon2åŸºç¡€æ¦‚å¿µ"></a>ç¬¬äºŒéƒ¨åˆ†ï¼šArgon2åŸºç¡€æ¦‚å¿µ</h2><h3 id="2-1-Argon2çš„è¯ç”ŸèƒŒæ™¯"><a href="#2-1-Argon2çš„è¯ç”ŸèƒŒæ™¯" class="headerlink" title="2.1 Argon2çš„è¯ç”ŸèƒŒæ™¯"></a>2.1 Argon2çš„è¯ç”ŸèƒŒæ™¯</h3><p>Argon2ä¸æ˜¯æ‹è„‘è¢‹æƒ³å‡ºæ¥çš„ï¼Œå®ƒæ˜¯2015å¹´Password Hashing Competitionï¼ˆPHCï¼‰çš„è·èƒœè€…ã€‚è¿™ä¸ªç«èµ›å°±æ˜¯ä¸ºäº†è§£å†³å¯†ç å“ˆå¸Œçš„å®‰å…¨é—®é¢˜ï¼Œå…¨ä¸–ç•Œçš„å¯†ç å­¦ä¸“å®¶æäº¤äº†24ä¸ªæ–¹æ¡ˆï¼Œç»è¿‡3å¹´çš„è¯„ä¼°ï¼ŒArgon2èƒœå‡ºã€‚</p><h3 id="2-2-æ ¸å¿ƒè®¾è®¡ç†å¿µ"><a href="#2-2-æ ¸å¿ƒè®¾è®¡ç†å¿µ" class="headerlink" title="2.2 æ ¸å¿ƒè®¾è®¡ç†å¿µ"></a>2.2 æ ¸å¿ƒè®¾è®¡ç†å¿µ</h3><p>Argon2çš„è®¾è®¡å“²å­¦å¾ˆç®€å•ï¼š<strong>æ—¢ç„¶æ— æ³•é˜»æ­¢æ”»å‡»è€…å°è¯•ï¼Œé‚£å°±è®©æ¯æ¬¡å°è¯•éƒ½å˜å¾—æå…¶æ˜‚è´µ</strong>ã€‚</p><p>å…·ä½“æ€ä¹ˆåšï¼Ÿä¸‰ä¸ªç»´åº¦ï¼š</p><ol><li><strong>å†…å­˜æˆæœ¬</strong> - æ¯æ¬¡è®¡ç®—éœ€è¦å¤§é‡å†…å­˜</li><li><strong>æ—¶é—´æˆæœ¬</strong> - å¯ä»¥è°ƒèŠ‚è®¡ç®—æ—¶é—´</li><li><strong>å¹¶è¡Œé™åˆ¶</strong> - é™åˆ¶å¹¶è¡Œæ”»å‡»çš„æ•ˆç‡</li></ol><h3 id="2-3-ä¸‰ä¸ªå˜ç§å¯¹æ¯”"><a href="#2-3-ä¸‰ä¸ªå˜ç§å¯¹æ¯”" class="headerlink" title="2.3 ä¸‰ä¸ªå˜ç§å¯¹æ¯”"></a>2.3 ä¸‰ä¸ªå˜ç§å¯¹æ¯”</h3><p>Argon2æœ‰ä¸‰ä¸ªå˜ç§ï¼š</p><ul><li><strong>Argon2i</strong> - ç‹¬ç«‹äºå†…å­˜çš„è®¿é—®æ¨¡å¼ï¼ŒæŠ—ä¾§ä¿¡é“æ”»å‡»</li><li><strong>Argon2d</strong> - ä¾èµ–æ•°æ®çš„è®¿é—®æ¨¡å¼ï¼ŒæŠ—æ—¶é—´-å†…å­˜æƒè¡¡æ”»å‡»  </li><li><strong>Argon2id</strong> - æ··åˆæ¨¡å¼ï¼Œå¹³è¡¡ä¸¤ç§æ”»å‡»çš„é˜²æŠ¤</li></ul><p>å®é™…é¡¹ç›®ä¸­ï¼Œ<strong>æ¨èä½¿ç”¨Argon2id</strong>ï¼Œå®ƒç»¼åˆäº†å‰ä¸¤è€…çš„ä¼˜åŠ¿ã€‚</p><h3 id="2-4-æ ¸å¿ƒå‚æ•°è§£æ"><a href="#2-4-æ ¸å¿ƒå‚æ•°è§£æ" class="headerlink" title="2.4 æ ¸å¿ƒå‚æ•°è§£æ"></a>2.4 æ ¸å¿ƒå‚æ•°è§£æ</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">argon2_parameters_explained</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Argon2çš„ä¸‰ä¸ªæ ¸å¿ƒå‚æ•°</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    parameters = &#123;</span><br><span class="line">        <span class="string">&quot;time_cost&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;å«ä¹‰&quot;</span>: <span class="string">&quot;æ—¶é—´æˆæœ¬ï¼Œè¿­ä»£æ¬¡æ•°&quot;</span>,</span><br><span class="line">            <span class="string">&quot;æ¨èå€¼&quot;</span>: <span class="string">&quot;3-10&quot;</span>,</span><br><span class="line">            <span class="string">&quot;å½±å“&quot;</span>: <span class="string">&quot;è®¡ç®—æ—¶é—´çº¿æ€§å¢é•¿&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;memory_cost&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;å«ä¹‰&quot;</span>: <span class="string">&quot;å†…å­˜æˆæœ¬ï¼Œä»¥KBä¸ºå•ä½&quot;</span>,</span><br><span class="line">            <span class="string">&quot;æ¨èå€¼&quot;</span>: <span class="string">&quot;65536 (64MB) - 1048576 (1GB)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;å½±å“&quot;</span>: <span class="string">&quot;å†…å­˜ä½¿ç”¨é‡å’Œæ”»å‡»æˆæœ¬&quot;</span></span><br><span class="line">        &#125;,  </span><br><span class="line">        <span class="string">&quot;parallelism&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;å«ä¹‰&quot;</span>: <span class="string">&quot;å¹¶è¡Œåº¦ï¼ŒåŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°&quot;</span>,</span><br><span class="line">            <span class="string">&quot;æ¨èå€¼&quot;</span>: <span class="string">&quot;1-4&quot;</span>,</span><br><span class="line">            <span class="string">&quot;å½±å“&quot;</span>: <span class="string">&quot;CPUåˆ©ç”¨ç‡å’Œè®¡ç®—æ—¶é—´&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> parameters</span><br></pre></td></tr></table></figure><h2 id="ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ ¸å¿ƒå·¥ä½œåŸç†"><a href="#ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ ¸å¿ƒå·¥ä½œåŸç†" class="headerlink" title="ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ ¸å¿ƒå·¥ä½œåŸç†"></a>ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ ¸å¿ƒå·¥ä½œåŸç†</h2><h3 id="3-1-å‚æ•°ç»‘å®šæœºåˆ¶ï¼šä¸ºä»€ä¹ˆä¸åŒå‚æ•°æ— æ³•è®¡ç®—å‡ºç›¸åŒå€¼"><a href="#3-1-å‚æ•°ç»‘å®šæœºåˆ¶ï¼šä¸ºä»€ä¹ˆä¸åŒå‚æ•°æ— æ³•è®¡ç®—å‡ºç›¸åŒå€¼" class="headerlink" title="3.1 å‚æ•°ç»‘å®šæœºåˆ¶ï¼šä¸ºä»€ä¹ˆä¸åŒå‚æ•°æ— æ³•è®¡ç®—å‡ºç›¸åŒå€¼"></a>3.1 å‚æ•°ç»‘å®šæœºåˆ¶ï¼šä¸ºä»€ä¹ˆä¸åŒå‚æ•°æ— æ³•è®¡ç®—å‡ºç›¸åŒå€¼</h3><p>å…¶å®æˆ‘åˆšçœ‹åˆ° Argon2æ˜¯å¯ä»¥é€‰æ‹©å‚æ•°æ¥æ§åˆ¶æ—¶é—´ä¸ç©ºé—´æˆæœ¬çš„æ—¶å€™ï¼Œæˆ‘å°±æœ‰ç‚¹å¥½å¥‡ï¼Œé‚£ä¹ˆä½¿ç”¨ä¸åŒå‚æ•°ï¼Œç»“æœè‚¯å®šä¸ä¸€æ ·å§ã€‚é‚£ä¹ˆæ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ</p><p>ç­”æ¡ˆï¼š<strong>ä½¿ç”¨ä¸åŒçš„å†…å­˜æˆæœ¬å’Œæ—¶é—´æˆæœ¬å‚æ•°ï¼Œç¡®å®æ— æ³•è®¡ç®—å‡ºç›¸åŒçš„å“ˆå¸Œå€¼</strong>ã€‚è¿™ä¸æ˜¯ç¼ºé™·ï¼Œè€Œæ˜¯Argon2çš„å…³é”®å®‰å…¨ç‰¹æ€§ã€‚</p><h4 id="å‚æ•°ç»‘å®šçš„å·¥ä½œåŸç†"><a href="#å‚æ•°ç»‘å®šçš„å·¥ä½œåŸç†" class="headerlink" title="å‚æ•°ç»‘å®šçš„å·¥ä½œåŸç†"></a>å‚æ•°ç»‘å®šçš„å·¥ä½œåŸç†</h4><p>Argon2å°†æ‰€æœ‰å‚æ•°éƒ½ç¼–ç åœ¨æœ€ç»ˆçš„å“ˆå¸Œå­—ç¬¦ä¸²ä¸­ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">demonstrate_parameter_binding</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    æ¼”ç¤ºArgon2å‚æ•°ç»‘å®šæœºåˆ¶</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">import</span> argon2</span><br><span class="line">    </span><br><span class="line">    password = <span class="string">&quot;same_password_123&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ä½¿ç”¨ä¸åŒå‚æ•°åˆ›å»ºå¤šä¸ªå“ˆå¸Œå™¨</span></span><br><span class="line">    hashers = &#123;</span><br><span class="line">        <span class="string">&quot;ä½å®‰å…¨&quot;</span>: argon2.PasswordHasher(time_cost=<span class="number">1</span>, memory_cost=<span class="number">1024</span>, parallelism=<span class="number">1</span>),</span><br><span class="line">        <span class="string">&quot;ä¸­å®‰å…¨&quot;</span>: argon2.PasswordHasher(time_cost=<span class="number">3</span>, memory_cost=<span class="number">65536</span>, parallelism=<span class="number">4</span>), </span><br><span class="line">        <span class="string">&quot;é«˜å®‰å…¨&quot;</span>: argon2.PasswordHasher(time_cost=<span class="number">10</span>, memory_cost=<span class="number">1048576</span>, parallelism=<span class="number">8</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=== ç›¸åŒå¯†ç ï¼Œä¸åŒå‚æ•°çš„å“ˆå¸Œç»“æœ ===&quot;</span>)</span><br><span class="line">    results = &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> level, hasher <span class="keyword">in</span> hashers.items():</span><br><span class="line">        hash_result = hasher.<span class="built_in">hash</span>(password)</span><br><span class="line">        results[level] = hash_result</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n<span class="subst">&#123;level&#125;</span>å‚æ•°:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;å“ˆå¸Œå€¼: <span class="subst">&#123;hash_result&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># è§£æå“ˆå¸Œå­—ç¬¦ä¸²</span></span><br><span class="line">        parts = hash_result.split(<span class="string">&#x27;$&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(parts) &gt;= <span class="number">4</span>:</span><br><span class="line">            params = parts[<span class="number">3</span>]  <span class="comment"># m=65536,t=3,p=4</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;åµŒå…¥å‚æ•°: <span class="subst">&#123;params&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># éªŒè¯ï¼šä¸åŒå‚æ•°çš„å“ˆå¸Œå€¼å®Œå…¨ä¸åŒ</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\n=== å“ˆå¸Œå€¼æ¯”è¾ƒ ===&quot;</span>)</span><br><span class="line">    hash_values = <span class="built_in">list</span>(results.values())</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;ä½å®‰å…¨ == ä¸­å®‰å…¨: <span class="subst">&#123;hash_values[<span class="number">0</span>] == hash_values[<span class="number">1</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;ä¸­å®‰å…¨ == é«˜å®‰å…¨: <span class="subst">&#123;hash_values[<span class="number">1</span>] == hash_values[<span class="number">2</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;ä½å®‰å…¨ == é«˜å®‰å…¨: <span class="subst">&#123;hash_values[<span class="number">0</span>] == hash_values[<span class="number">2</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure><h4 id="å®‰å…¨æ„ä¹‰ï¼šé˜²æ­¢å‚æ•°é™çº§æ”»å‡»"><a href="#å®‰å…¨æ„ä¹‰ï¼šé˜²æ­¢å‚æ•°é™çº§æ”»å‡»" class="headerlink" title="å®‰å…¨æ„ä¹‰ï¼šé˜²æ­¢å‚æ•°é™çº§æ”»å‡»"></a>å®‰å…¨æ„ä¹‰ï¼šé˜²æ­¢å‚æ•°é™çº§æ”»å‡»</h4><p>è¿™ç§å‚æ•°ç»‘å®šæœºåˆ¶çš„å®‰å…¨æ„ä¹‰ï¼š</p><ol><li><strong>é˜²æ­¢å‚æ•°é™çº§æ”»å‡»</strong> - æ”»å‡»è€…ä¸èƒ½ç”¨ä½å‚æ•°é‡æ–°è®¡ç®—æ¥ç»•è¿‡å®‰å…¨è®¾ç½®</li><li><strong>å¼ºåˆ¶å®‰å…¨ç­–ç•¥</strong> - æ—§å“ˆå¸Œå€¼æ— æ³•é€šè¿‡æ–°å‚æ•°éªŒè¯ï¼Œå¼ºåˆ¶å‡çº§</li><li><strong>å®¡è®¡å’Œåˆè§„</strong> - å“ˆå¸Œå€¼æœ¬èº«åŒ…å«äº†å®‰å…¨å‚æ•°ä¿¡æ¯</li><li><strong>é˜²æ­¢æ—¶é—´-ç©ºé—´æƒè¡¡</strong> - å¿…é¡»ä½¿ç”¨å®Œå…¨ç›¸åŒçš„å‚æ•°é…ç½®</li></ol><h3 id="3-2-å†…å­˜è®¿é—®æ¨¡å¼è¯¦è§£"><a href="#3-2-å†…å­˜è®¿é—®æ¨¡å¼è¯¦è§£" class="headerlink" title="3.2 å†…å­˜è®¿é—®æ¨¡å¼è¯¦è§£"></a>3.2 å†…å­˜è®¿é—®æ¨¡å¼è¯¦è§£</h3><p>Argon2çš„æ ¸å¿ƒåˆ›æ–°åœ¨äºå®ƒçš„å†…å­˜è®¿é—®æ¨¡å¼ã€‚ä¼ ç»Ÿå“ˆå¸Œç®—æ³•å†…å­˜å ç”¨å¾ˆå°ï¼Œè€ŒArgon2ä¼šåˆ›å»ºä¸€ä¸ªå¤§å‹çš„å†…å­˜æ•°ç»„ï¼Œç„¶ååœ¨å…¶ä¸­è¿›è¡Œå¤æ‚çš„æ•°æ®ä¾èµ–æ“ä½œã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Argon2å†…å­˜è®¿é—®æ¨¡å¼çš„ç®€åŒ–æ¨¡å‹</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">argon2_memory_pattern_simplified</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    è¿™æ˜¯Argon2å†…å­˜è®¿é—®çš„ç®€åŒ–ç‰ˆæœ¬ï¼Œå¸®åŠ©ç†è§£å…¶å·¥ä½œåŸç†</span></span><br><span class="line"><span class="string">    å®é™…ç®—æ³•è¦å¤æ‚å¾—å¤š</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 1. åˆå§‹åŒ–å†…å­˜å—</span></span><br><span class="line">    memory_size = <span class="number">65536</span>  <span class="comment"># 64MBï¼Œæ¯ä¸ªå—1KB</span></span><br><span class="line">    memory_blocks = [<span class="built_in">bytearray</span>(<span class="number">1024</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(memory_size)]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2. ç¬¬ä¸€è½®ï¼šé¡ºåºå¡«å……å†…å­˜</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(memory_size):</span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">            <span class="comment"># ç¬¬ä¸€ä¸ªå—åŸºäºå¯†ç å’Œç›è®¡ç®—</span></span><br><span class="line">            memory_blocks[i] = initial_hash(password, salt, i)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># åç»­å—åŸºäºå‰ä¸€ä¸ªå—è®¡ç®—</span></span><br><span class="line">            memory_blocks[i] = hash_function(memory_blocks[i-<span class="number">1</span>], i)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 3. åç»­è½®æ¬¡ï¼šéšæœºè®¿é—®å†…å­˜</span></span><br><span class="line">    <span class="keyword">for</span> round_num <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, time_cost):</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(memory_size):</span><br><span class="line">            <span class="comment"># å…³é”®ï¼šè®¿é—®ä½ç½®ä¾èµ–äºå½“å‰å—çš„å†…å®¹</span></span><br><span class="line">            <span class="comment"># è¿™å°±æ˜¯&quot;æ•°æ®ä¾èµ–&quot;çš„å«ä¹‰</span></span><br><span class="line">            access_index = compute_access_index(memory_blocks[i], i, round_num)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># å°†å½“å‰å—ä¸éšæœºè®¿é—®çš„å—è¿›è¡Œæ··åˆ</span></span><br><span class="line">            memory_blocks[i] = mix_blocks(</span><br><span class="line">                memory_blocks[i], </span><br><span class="line">                memory_blocks[access_index]</span><br><span class="line">            )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 4. æœ€ç»ˆå“ˆå¸Œ</span></span><br><span class="line">    <span class="keyword">return</span> final_hash(memory_blocks)</span><br></pre></td></tr></table></figure><h3 id="3-3-ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡èƒ½æé«˜å®‰å…¨æ€§ï¼Ÿ"><a href="#3-3-ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡èƒ½æé«˜å®‰å…¨æ€§ï¼Ÿ" class="headerlink" title="3.3 ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡èƒ½æé«˜å®‰å…¨æ€§ï¼Ÿ"></a>3.3 ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡èƒ½æé«˜å®‰å…¨æ€§ï¼Ÿ</h3><p>å…³é”®åœ¨äº<strong>æ•°æ®ä¾èµ–æ€§</strong>ï¼š</p><ol><li><strong>å†…å­˜æ— æ³•å‹ç¼©</strong> - æ¯ä¸ªå†…å­˜å—çš„å†…å®¹éƒ½ä¸å¯é¢„æµ‹ï¼Œæ”»å‡»è€…å¿…é¡»å­˜å‚¨æ‰€æœ‰ä¸­é—´çŠ¶æ€</li><li><strong>è®¡ç®—æ— æ³•å¹¶è¡Œ</strong> - ä¸‹ä¸€æ­¥çš„è®¡ç®—ä¾èµ–äºå‰é¢çš„ç»“æœï¼Œæ— æ³•è·³è·ƒ</li><li><strong>æ—¶é—´-å†…å­˜æƒè¡¡æ— æ•ˆ</strong> - å³ä½¿æ”»å‡»è€…ç”¨æ›´å¤šè®¡ç®—æ—¶é—´æ¢æ›´å°‘å†…å­˜ï¼Œæ•ˆæœä¹Ÿå¾ˆæœ‰é™</li></ol><h2 id="ç¬¬å››éƒ¨åˆ†ï¼šç®—æ³•å®ç°ç»†èŠ‚"><a href="#ç¬¬å››éƒ¨åˆ†ï¼šç®—æ³•å®ç°ç»†èŠ‚" class="headerlink" title="ç¬¬å››éƒ¨åˆ†ï¼šç®—æ³•å®ç°ç»†èŠ‚"></a>ç¬¬å››éƒ¨åˆ†ï¼šç®—æ³•å®ç°ç»†èŠ‚</h2><h3 id="4-1-ç®—æ³•æ•´ä½“æµç¨‹"><a href="#4-1-ç®—æ³•æ•´ä½“æµç¨‹" class="headerlink" title="4.1 ç®—æ³•æ•´ä½“æµç¨‹"></a>4.1 ç®—æ³•æ•´ä½“æµç¨‹</h3><pre class="mermaid">graph TD    A["è¾“å…¥: å¯†ç P, ç›S, å‚æ•°"] --> B["é˜¶æ®µ1: åˆå§‹åŒ–"]    B --> C["é˜¶æ®µ2: æ„å»ºå†…å­˜çŸ©é˜µ"]    C --> D["é˜¶æ®µ3: å†…å­˜è®¿é—®è½®æ¬¡"]    D --> E["é˜¶æ®µ4: æœ€ç»ˆè¾“å‡º"]        subgraph "é˜¶æ®µ1: åˆå§‹åŒ–"        B1["è®¡ç®—H0 = Blake2b(P||S||å‚æ•°)"]        B2["ç”Ÿæˆåˆå§‹å—B[0][0], B[0][1]"]    end        subgraph "é˜¶æ®µ2: æ„å»ºå†…å­˜çŸ©é˜µ"        C1["å¹¶è¡Œå¡«å……pä¸ªçº¿ç¨‹çš„åˆå§‹è¡Œ"]        C2["æ¯ä¸ªçº¿ç¨‹: B[i][j] = G(B[i][j-1], B[i][j-2])"]    end        subgraph "é˜¶æ®µ3: å†…å­˜è®¿é—®è½®æ¬¡"         D1["for pass = 1 to t-1"]        D2["è®¡ç®—è®¿é—®ç´¢å¼•: Ï†(B[i][j-1])"]        D3["B[i][j] = G(B[i][j-1], B[l][z])"]        D4["l, z åŸºäºÏ†å‡½æ•°å’ŒArgon2å˜ç§"]    end        subgraph "é˜¶æ®µ4: æœ€ç»ˆè¾“å‡º"        E1["å‹ç¼©æœ€åä¸€åˆ—: C = B[0][m-1] âŠ• ... âŠ• B[p-1][m-1]"]        E2["è¾“å‡º: Blake2b(C)[0..Ï„-1]"]    end</pre><h3 id="4-2-æ•°å­¦ç¬¦å·å®šä¹‰"><a href="#4-2-æ•°å­¦ç¬¦å·å®šä¹‰" class="headerlink" title="4.2 æ•°å­¦ç¬¦å·å®šä¹‰"></a>4.2 æ•°å­¦ç¬¦å·å®šä¹‰</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">argon2_mathematical_notation</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Argon2æ•°å­¦ç¬¦å·å®šä¹‰</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    symbols = &#123;</span><br><span class="line">        <span class="string">&quot;åŸºæœ¬å‚æ•°&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;P&quot;</span>: <span class="string">&quot;å¯†ç  (password)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;S&quot;</span>: <span class="string">&quot;ç› (salt)&quot;</span>, </span><br><span class="line">            <span class="string">&quot;p&quot;</span>: <span class="string">&quot;å¹¶è¡Œåº¦ (parallelism)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Ï„&quot;</span>: <span class="string">&quot;è¾“å‡ºé•¿åº¦ (tag length)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;m&quot;</span>: <span class="string">&quot;å†…å­˜æˆæœ¬ï¼Œä»¥KBä¸ºå•ä½&quot;</span>,</span><br><span class="line">            <span class="string">&quot;t&quot;</span>: <span class="string">&quot;æ—¶é—´æˆæœ¬ (iterations)&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;å†…å­˜ç»“æ„&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;B[i][j]&quot;</span>: <span class="string">&quot;å†…å­˜çŸ©é˜µï¼Œiæ˜¯çº¿ç¨‹ç´¢å¼•(0â‰¤i&lt;p)ï¼Œjæ˜¯å—ç´¢å¼•(0â‰¤j&lt;m/p)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;m&#x27;&quot;</span>: <span class="string">&quot;å®é™…å†…å­˜å—æ•°é‡ = 4*m*1024/1024 = 4*m&quot;</span>, </span><br><span class="line">            <span class="string">&quot;q&quot;</span>: <span class="string">&quot;æ¯ä¸ªçº¿ç¨‹çš„å—æ•°é‡ = m&#x27;/p&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;å‡½æ•°å®šä¹‰&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;H&quot;</span>: <span class="string">&quot;Blake2bå“ˆå¸Œå‡½æ•°&quot;</span>,</span><br><span class="line">            <span class="string">&quot;G&quot;</span>: <span class="string">&quot;å‹ç¼©å‡½æ•° (compression function)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Ï†&quot;</span>: <span class="string">&quot;è®¿é—®ç´¢å¼•è®¡ç®—å‡½æ•°&quot;</span>,</span><br><span class="line">            <span class="string">&quot;âŠ•&quot;</span>: <span class="string">&quot;å¼‚æˆ–è¿ç®—&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> symbols</span><br></pre></td></tr></table></figure><h3 id="4-3-å‹ç¼©å‡½æ•°Gçš„æ•°å­¦å®šä¹‰"><a href="#4-3-å‹ç¼©å‡½æ•°Gçš„æ•°å­¦å®šä¹‰" class="headerlink" title="4.3 å‹ç¼©å‡½æ•°Gçš„æ•°å­¦å®šä¹‰"></a>4.3 å‹ç¼©å‡½æ•°Gçš„æ•°å­¦å®šä¹‰</h3><p>å‹ç¼©å‡½æ•°Gæ˜¯Argon2å®‰å…¨æ€§çš„æ ¸å¿ƒï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„æ•°å­¦æ€§è´¨ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">compression_function_analysis</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    å‹ç¼©å‡½æ•°Gçš„æ•°å­¦æ€§è´¨åˆ†æ</span></span><br><span class="line"><span class="string">    å‹ç¼©å‡½æ•°G: &#123;0,1&#125;^2048 â†’ &#123;0,1&#125;^1024</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">compression_G</span>(<span class="params">block1, block2</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        å‹ç¼©å‡½æ•°G(X,Y)çš„å®ç°</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># æ­¥éª¤1: R = X âŠ• Y (å¼‚æˆ–è¿ç®—)</span></span><br><span class="line">        R = <span class="built_in">bytearray</span>(<span class="number">1024</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1024</span>):</span><br><span class="line">            R[i] = block1[i] ^ block2[i]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ­¥éª¤2: Z = P(R) (ç½®æ¢å‡½æ•°P)</span></span><br><span class="line">        Z = permutation_P(R)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æ­¥éª¤3: è¿”å› R âŠ• Z</span></span><br><span class="line">        result = <span class="built_in">bytearray</span>(<span class="number">1024</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1024</span>):</span><br><span class="line">            result[i] = R[i] ^ Z[i]</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bytes</span>(result)</span><br><span class="line">    </span><br><span class="line">    properties = &#123;</span><br><span class="line">        <span class="string">&quot;å‡½æ•°ç­¾å&quot;</span>: <span class="string">&quot;G: &#123;0,1&#125;^2048 â†’ &#123;0,1&#125;^1024&quot;</span>,</span><br><span class="line">        <span class="string">&quot;è¾“å…¥&quot;</span>: <span class="string">&quot;ä¸¤ä¸ª1024å­—èŠ‚çš„å— X, Y&quot;</span>, </span><br><span class="line">        <span class="string">&quot;è¾“å‡º&quot;</span>: <span class="string">&quot;ä¸€ä¸ª1024å­—èŠ‚çš„å—&quot;</span>,</span><br><span class="line">        <span class="string">&quot;æ•°å­¦æ€§è´¨&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;éçº¿æ€§&quot;</span>: <span class="string">&quot;ç”±äºPå‡½æ•°çš„éçº¿æ€§ï¼ŒGä¹Ÿæ˜¯éçº¿æ€§çš„&quot;</span>,</span><br><span class="line">            <span class="string">&quot;æ‰©æ•£æ€§&quot;</span>: <span class="string">&quot;è¾“å…¥çš„å¾®å°æ”¹å˜ä¼šå¯¼è‡´è¾“å‡ºçš„å¤§å¹…æ”¹å˜&quot;</span>,</span><br><span class="line">            <span class="string">&quot;æ··æ·†æ€§&quot;</span>: <span class="string">&quot;è¾“å…¥å’Œè¾“å‡ºä¹‹é—´çš„å…³ç³»å¤æ‚éš¾ä»¥æ¨æ–­&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ä¸å¯é€†&quot;</span>: <span class="string">&quot;ä»G(X,Y)è®¡ç®—Xæˆ–Yåœ¨è®¡ç®—ä¸Šä¸å¯è¡Œ&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> compression_G, properties</span><br></pre></td></tr></table></figure><h2 id="ç¬¬äº”éƒ¨åˆ†ï¼šä¸ä¼ ç»Ÿå“ˆå¸Œç®—æ³•å¯¹æ¯”"><a href="#ç¬¬äº”éƒ¨åˆ†ï¼šä¸ä¼ ç»Ÿå“ˆå¸Œç®—æ³•å¯¹æ¯”" class="headerlink" title="ç¬¬äº”éƒ¨åˆ†ï¼šä¸ä¼ ç»Ÿå“ˆå¸Œç®—æ³•å¯¹æ¯”"></a>ç¬¬äº”éƒ¨åˆ†ï¼šä¸ä¼ ç»Ÿå“ˆå¸Œç®—æ³•å¯¹æ¯”</h2><h3 id="5-1-è®¡ç®—æˆæœ¬å¯¹æ¯”"><a href="#5-1-è®¡ç®—æˆæœ¬å¯¹æ¯”" class="headerlink" title="5.1 è®¡ç®—æˆæœ¬å¯¹æ¯”"></a>5.1 è®¡ç®—æˆæœ¬å¯¹æ¯”</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> argon2</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> psutil</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">performance_comparison</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Argon2 vs SHA-512 æ€§èƒ½å¯¹æ¯”</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    password = <span class="string">&quot;test_password_123&quot;</span></span><br><span class="line">    salt = <span class="string">b&quot;random_salt_bytes&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># SHA-512æµ‹è¯•</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=== SHA-512æ€§èƒ½æµ‹è¯• ===&quot;</span>)</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    start_memory = psutil.Process().memory_info().rss / <span class="number">1024</span> / <span class="number">1024</span>  <span class="comment"># MB</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000</span>):</span><br><span class="line">        sha512_hash = hashlib.sha512(password.encode() + salt).hexdigest()</span><br><span class="line">    </span><br><span class="line">    end_time = time.time()</span><br><span class="line">    end_memory = psutil.Process().memory_info().rss / <span class="number">1024</span> / <span class="number">1024</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;è®¡ç®—1ä¸‡æ¬¡SHA-512è€—æ—¶: <span class="subst">&#123;end_time - start_time:<span class="number">.3</span>f&#125;</span>ç§’&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;å†…å­˜å ç”¨å¢åŠ : <span class="subst">&#123;end_memory - start_memory:<span class="number">.1</span>f&#125;</span>MB&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;å¹³å‡æ¯æ¬¡: <span class="subst">&#123;(end_time - start_time) * <span class="number">100</span>:<span class="number">.3</span>f&#125;</span>æ¯«ç§’&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Argon2æµ‹è¯•</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n=== Argon2æ€§èƒ½æµ‹è¯• ===&quot;</span>)</span><br><span class="line">    ph = argon2.PasswordHasher(</span><br><span class="line">        time_cost=<span class="number">3</span>,        <span class="comment"># 3æ¬¡è¿­ä»£</span></span><br><span class="line">        memory_cost=<span class="number">65536</span>,  <span class="comment"># 64MBå†…å­˜</span></span><br><span class="line">        parallelism=<span class="number">1</span>       <span class="comment"># å•çº¿ç¨‹</span></span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    start_time = time.time()</span><br><span class="line">    start_memory = psutil.Process().memory_info().rss / <span class="number">1024</span> / <span class="number">1024</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):  <span class="comment"># æ³¨æ„ï¼šåªæµ‹è¯•10æ¬¡ï¼Œä¸æ˜¯1ä¸‡æ¬¡</span></span><br><span class="line">        argon2_hash = ph.<span class="built_in">hash</span>(password)</span><br><span class="line">    </span><br><span class="line">    end_time = time.time()</span><br><span class="line">    end_memory = psutil.Process().memory_info().rss / <span class="number">1024</span> / <span class="number">1024</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;è®¡ç®—10æ¬¡Argon2è€—æ—¶: <span class="subst">&#123;end_time - start_time:<span class="number">.3</span>f&#125;</span>ç§’&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;å†…å­˜å ç”¨å¢åŠ : <span class="subst">&#123;end_memory - start_memory:<span class="number">.1</span>f&#125;</span>MB&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;å¹³å‡æ¯æ¬¡: <span class="subst">&#123;(end_time - start_time) * <span class="number">100</span>:<span class="number">.1</span>f&#125;</span>æ¯«ç§’&quot;</span>)</span><br></pre></td></tr></table></figure><p>ä»è¿™ä¸ªå¯¹æ¯”å¯ä»¥çœ‹å‡ºï¼š<strong>Argon2å•æ¬¡è®¡ç®—çš„æ—¶é—´æ˜¯SHA-512çš„æ•°ä¸‡å€ï¼Œå†…å­˜å ç”¨æ˜¯æ•°ç™¾å€</strong>ã€‚</p><h3 id="5-2-æ”»å‡»æˆæœ¬åˆ†æ"><a href="#5-2-æ”»å‡»æˆæœ¬åˆ†æ" class="headerlink" title="5.2 æ”»å‡»æˆæœ¬åˆ†æ"></a>5.2 æ”»å‡»æˆæœ¬åˆ†æ</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">attack_cost_analysis</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    æ”»å‡»æˆæœ¬çš„å®é™…è®¡ç®—</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=== ç ´è§£8ä½å¯†ç çš„æˆæœ¬å¯¹æ¯” ===&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å‡è®¾å¯†ç ç©ºé—´ï¼š8ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯å’Œæ•°å­—</span></span><br><span class="line">    password_space = (<span class="number">26</span> + <span class="number">26</span> + <span class="number">10</span>) ** <span class="number">8</span>  <span class="comment"># çº¦218ä¸‡äº¿</span></span><br><span class="line">    avg_attempts = password_space // <span class="number">2</span>      <span class="comment"># å¹³å‡éœ€è¦å°è¯•ä¸€åŠ</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># SHA-512æ”»å‡»æˆæœ¬</span></span><br><span class="line">    sha512_speed = <span class="number">2_000_000_000</span>  <span class="comment"># GPUæ¯ç§’20äº¿æ¬¡</span></span><br><span class="line">    sha512_time = avg_attempts / sha512_speed / <span class="number">86400</span>  <span class="comment"># è½¬æ¢ä¸ºå¤©</span></span><br><span class="line">    sha512_gpu_cost = <span class="number">1000</span>  <span class="comment"># ä¸€å—GPU 1000ç¾å…ƒ</span></span><br><span class="line">    sha512_power_day = <span class="number">5</span>    <span class="comment"># æ¯å¤©ç”µè´¹5ç¾å…ƒ</span></span><br><span class="line">    sha512_total_cost = sha512_gpu_cost + sha512_time * sha512_power_day</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;SHA-512ç ´è§£æˆæœ¬:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  æ—¶é—´: <span class="subst">&#123;sha512_time:<span class="number">.1</span>f&#125;</span>å¤©&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  ç¡¬ä»¶æˆæœ¬: $<span class="subst">&#123;sha512_gpu_cost&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  ç”µè´¹: $<span class="subst">&#123;sha512_time * sha512_power_day:<span class="number">.0</span>f&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  æ€»æˆæœ¬: $<span class="subst">&#123;sha512_total_cost:<span class="number">.0</span>f&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Argon2æ”»å‡»æˆæœ¬</span></span><br><span class="line">    argon2_speed = <span class="number">10</span>           <span class="comment"># å—å†…å­˜é™åˆ¶ï¼Œæ¯ç§’10æ¬¡</span></span><br><span class="line">    argon2_memory_per_attempt = <span class="number">64</span>  <span class="comment"># æ¯æ¬¡å°è¯•64MB</span></span><br><span class="line">    argon2_time = avg_attempts / argon2_speed / <span class="number">86400</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ä¸ºäº†å¹¶è¡Œæ”»å‡»ï¼Œéœ€è¦å¤§é‡å†…å­˜</span></span><br><span class="line">    parallel_attempts = <span class="number">1000</span>    <span class="comment"># å‡è®¾å¹¶è¡Œ1000æ¬¡å°è¯•</span></span><br><span class="line">    total_memory_gb = argon2_memory_per_attempt * parallel_attempts / <span class="number">1024</span></span><br><span class="line">    memory_cost_per_gb = <span class="number">50</span>     <span class="comment"># æœåŠ¡å™¨å†…å­˜50ç¾å…ƒ/GB</span></span><br><span class="line">    argon2_hardware_cost = total_memory_gb * memory_cost_per_gb</span><br><span class="line">    argon2_power_day = <span class="number">50</span>       <span class="comment"># å¤§å†…å­˜æœåŠ¡å™¨ç”µè´¹æ›´é«˜</span></span><br><span class="line">    argon2_total_cost = argon2_hardware_cost + (argon2_time / parallel_attempts) * argon2_power_day</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\nArgon2ç ´è§£æˆæœ¬:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  æ—¶é—´: <span class="subst">&#123;argon2_time / parallel_attempts:<span class="number">.1</span>f&#125;</span>å¤© (å¹¶è¡Œ<span class="subst">&#123;parallel_attempts&#125;</span>æ¬¡)&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  å†…å­˜éœ€æ±‚: <span class="subst">&#123;total_memory_gb:<span class="number">.0</span>f&#125;</span>GB&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  ç¡¬ä»¶æˆæœ¬: $<span class="subst">&#123;argon2_hardware_cost:<span class="number">.0</span>f&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  ç”µè´¹: $<span class="subst">&#123;(argon2_time / parallel_attempts) * argon2_power_day:<span class="number">.0</span>f&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  æ€»æˆæœ¬: $<span class="subst">&#123;argon2_total_cost:<span class="number">.0</span>f&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\næˆæœ¬å€æ•°: Argon2æ˜¯SHA-512çš„ <span class="subst">&#123;argon2_total_cost / sha512_total_cost:<span class="number">.0</span>f&#125;</span> å€&quot;</span>)</span><br></pre></td></tr></table></figure><h2 id="ç¬¬å…­éƒ¨åˆ†ï¼šå®æˆ˜åº”ç”¨æŒ‡å—"><a href="#ç¬¬å…­éƒ¨åˆ†ï¼šå®æˆ˜åº”ç”¨æŒ‡å—" class="headerlink" title="ç¬¬å…­éƒ¨åˆ†ï¼šå®æˆ˜åº”ç”¨æŒ‡å—"></a>ç¬¬å…­éƒ¨åˆ†ï¼šå®æˆ˜åº”ç”¨æŒ‡å—</h2><h3 id="6-1-ä¸åŒåœºæ™¯çš„å‚æ•°é…ç½®"><a href="#6-1-ä¸åŒåœºæ™¯çš„å‚æ•°é…ç½®" class="headerlink" title="6.1 ä¸åŒåœºæ™¯çš„å‚æ•°é…ç½®"></a>6.1 ä¸åŒåœºæ™¯çš„å‚æ•°é…ç½®</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">argon2_configurations</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ä¸åŒåœºæ™¯ä¸‹çš„Argon2å‚æ•°æ¨è</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    configurations = &#123;</span><br><span class="line">        <span class="string">&quot;é«˜å®‰å…¨ç³»ç»Ÿ&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;time_cost&quot;</span>: <span class="number">10</span>,</span><br><span class="line">            <span class="string">&quot;memory_cost&quot;</span>: <span class="number">1024</span> * <span class="number">1024</span>,  <span class="comment"># 1GB</span></span><br><span class="line">            <span class="string">&quot;parallelism&quot;</span>: <span class="number">4</span>,</span><br><span class="line">            <span class="string">&quot;é€‚ç”¨&quot;</span>: [<span class="string">&quot;é‡‘èç³»ç»Ÿ&quot;</span>, <span class="string">&quot;æ”¿åºœç³»ç»Ÿ&quot;</span>, <span class="string">&quot;å…³é”®åŸºç¡€è®¾æ–½&quot;</span>],</span><br><span class="line">            <span class="string">&quot;ç™»å½•æ—¶é—´&quot;</span>: <span class="string">&quot;2-5ç§’&quot;</span>,</span><br><span class="line">            <span class="string">&quot;è¯´æ˜&quot;</span>: <span class="string">&quot;å¯ä»¥å®¹å¿è¾ƒé•¿ç™»å½•æ—¶é—´ï¼Œè¿½æ±‚æœ€é«˜å®‰å…¨æ€§&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;ä¼ä¸šåº”ç”¨&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;time_cost&quot;</span>: <span class="number">3</span>,</span><br><span class="line">            <span class="string">&quot;memory_cost&quot;</span>: <span class="number">65536</span>,  <span class="comment"># 64MB</span></span><br><span class="line">            <span class="string">&quot;parallelism&quot;</span>: <span class="number">4</span>,</span><br><span class="line">            <span class="string">&quot;é€‚ç”¨&quot;</span>: [<span class="string">&quot;ä¼ä¸šå†…éƒ¨ç³»ç»Ÿ&quot;</span>, <span class="string">&quot;B2Bå¹³å°&quot;</span>, <span class="string">&quot;åå°ç®¡ç†&quot;</span>],</span><br><span class="line">            <span class="string">&quot;ç™»å½•æ—¶é—´&quot;</span>: <span class="string">&quot;0.5-1ç§’&quot;</span>,</span><br><span class="line">            <span class="string">&quot;è¯´æ˜&quot;</span>: <span class="string">&quot;å¹³è¡¡å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒ&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;æ¶ˆè´¹çº§åº”ç”¨&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;time_cost&quot;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="string">&quot;memory_cost&quot;</span>: <span class="number">32768</span>,  <span class="comment"># 32MB</span></span><br><span class="line">            <span class="string">&quot;parallelism&quot;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="string">&quot;é€‚ç”¨&quot;</span>: [<span class="string">&quot;ç§»åŠ¨APP&quot;</span>, <span class="string">&quot;ç½‘ç«™&quot;</span>, <span class="string">&quot;æ¸¸æˆ&quot;</span>],</span><br><span class="line">            <span class="string">&quot;ç™»å½•æ—¶é—´&quot;</span>: <span class="string">&quot;0.2-0.5ç§’&quot;</span>,</span><br><span class="line">            <span class="string">&quot;è¯´æ˜&quot;</span>: <span class="string">&quot;è€ƒè™‘ç§»åŠ¨è®¾å¤‡å’Œç½‘ç»œå»¶è¿Ÿ&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;IoTè®¾å¤‡&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;time_cost&quot;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="string">&quot;memory_cost&quot;</span>: <span class="number">4096</span>,   <span class="comment"># 4MB</span></span><br><span class="line">            <span class="string">&quot;parallelism&quot;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="string">&quot;é€‚ç”¨&quot;</span>: [<span class="string">&quot;åµŒå…¥å¼è®¾å¤‡&quot;</span>, <span class="string">&quot;æ™ºèƒ½ç¡¬ä»¶&quot;</span>],</span><br><span class="line">            <span class="string">&quot;ç™»å½•æ—¶é—´&quot;</span>: <span class="string">&quot;0.1-0.2ç§’&quot;</span>,</span><br><span class="line">            <span class="string">&quot;è¯´æ˜&quot;</span>: <span class="string">&quot;èµ„æºå—é™ç¯å¢ƒ&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> configurations</span><br></pre></td></tr></table></figure><h3 id="6-2-Pythonå®ç°ç¤ºä¾‹"><a href="#6-2-Pythonå®ç°ç¤ºä¾‹" class="headerlink" title="6.2 Pythonå®ç°ç¤ºä¾‹"></a>6.2 Pythonå®ç°ç¤ºä¾‹</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> argon2</span><br><span class="line"><span class="keyword">from</span> argon2 <span class="keyword">import</span> PasswordHasher</span><br><span class="line"><span class="keyword">from</span> argon2.exceptions <span class="keyword">import</span> VerifyMismatchError, HashingError</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SecurePasswordManager</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    åŸºäºArgon2çš„å®‰å…¨å¯†ç ç®¡ç†å™¨</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, time_cost=<span class="number">3</span>, memory_cost=<span class="number">65536</span>, parallelism=<span class="number">4</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.ph = PasswordHasher(</span><br><span class="line">            time_cost=time_cost,</span><br><span class="line">            memory_cost=memory_cost,</span><br><span class="line">            parallelism=parallelism,</span><br><span class="line">            hash_len=<span class="number">32</span>,        <span class="comment"># è¾“å‡ºé•¿åº¦32å­—èŠ‚</span></span><br><span class="line">            salt_len=<span class="number">16</span>,        <span class="comment"># ç›é•¿åº¦16å­—èŠ‚</span></span><br><span class="line">            encoding=<span class="string">&#x27;utf-8&#x27;</span>,   <span class="comment"># å­—ç¬¦ç¼–ç </span></span><br><span class="line">            <span class="built_in">type</span>=argon2.<span class="type">Type</span>.ID <span class="comment"># ä½¿ç”¨Argon2id</span></span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">hash_password</span>(<span class="params">self, password: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;å“ˆå¸Œå¯†ç &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            start_time = time.time()</span><br><span class="line">            hashed = <span class="variable language_">self</span>.ph.<span class="built_in">hash</span>(password)</span><br><span class="line">            end_time = time.time()</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;å¯†ç å“ˆå¸Œè®¡ç®—è€—æ—¶: <span class="subst">&#123;(end_time - start_time) * <span class="number">1000</span>:<span class="number">.1</span>f&#125;</span>ms&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> hashed</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> HashingError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;å¯†ç å“ˆå¸Œå¤±è´¥: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">verify_password</span>(<span class="params">self, hashed: <span class="built_in">str</span>, password: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;éªŒè¯å¯†ç &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            start_time = time.time()</span><br><span class="line">            <span class="variable language_">self</span>.ph.verify(hashed, password)</span><br><span class="line">            end_time = time.time()</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;å¯†ç éªŒè¯è€—æ—¶: <span class="subst">&#123;(end_time - start_time) * <span class="number">1000</span>:<span class="number">.1</span>f&#125;</span>ms&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> VerifyMismatchError:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;å¯†ç éªŒè¯å‡ºé”™: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_hash_info</span>(<span class="params">self, hashed: <span class="built_in">str</span></span>) -&gt; <span class="built_in">dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è§£æå“ˆå¸Œå€¼ä¿¡æ¯&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># Argon2å“ˆå¸Œæ ¼å¼: $argon2id$v=19$m=65536,t=3,p=4$salt$hash</span></span><br><span class="line">            parts = hashed.split(<span class="string">&#x27;$&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(parts) != <span class="number">6</span>:</span><br><span class="line">                <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;Invalid hash format&quot;</span>&#125;</span><br><span class="line">            </span><br><span class="line">            algorithm = parts[<span class="number">1</span>]  <span class="comment"># argon2id</span></span><br><span class="line">            version = parts[<span class="number">2</span>]    <span class="comment"># v=19</span></span><br><span class="line">            params = parts[<span class="number">3</span>]     <span class="comment"># m=65536,t=3,p=4</span></span><br><span class="line">            salt = parts[<span class="number">4</span>]       <span class="comment"># base64ç¼–ç çš„ç›</span></span><br><span class="line">            hash_value = parts[<span class="number">5</span>] <span class="comment"># base64ç¼–ç çš„å“ˆå¸Œå€¼</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># è§£æå‚æ•°</span></span><br><span class="line">            param_dict = &#123;&#125;</span><br><span class="line">            <span class="keyword">for</span> param <span class="keyword">in</span> params.split(<span class="string">&#x27;,&#x27;</span>):</span><br><span class="line">                key, value = param.split(<span class="string">&#x27;=&#x27;</span>)</span><br><span class="line">                param_dict[key] = <span class="built_in">int</span>(value)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;algorithm&quot;</span>: algorithm,</span><br><span class="line">                <span class="string">&quot;version&quot;</span>: version,</span><br><span class="line">                <span class="string">&quot;memory_cost&quot;</span>: param_dict.get(<span class="string">&#x27;m&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;time_cost&quot;</span>: param_dict.get(<span class="string">&#x27;t&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;parallelism&quot;</span>: param_dict.get(<span class="string">&#x27;p&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">                <span class="string">&quot;salt_b64&quot;</span>: salt,</span><br><span class="line">                <span class="string">&quot;hash_b64&quot;</span>: hash_value</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;error&quot;</span>: <span class="string">f&quot;Failed to parse hash: <span class="subst">&#123;e&#125;</span>&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">demo_usage</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ä½¿ç”¨ç¤ºä¾‹&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=== Argon2å¯†ç ç®¡ç†å™¨æ¼”ç¤º ===&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    pm = SecurePasswordManager(time_cost=<span class="number">3</span>, memory_cost=<span class="number">65536</span>, parallelism=<span class="number">4</span>)</span><br><span class="line">    test_password = <span class="string">&quot;MySecurePassword123!&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å“ˆå¸Œå¯†ç </span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n1. å“ˆå¸Œå¯†ç &quot;</span>)</span><br><span class="line">    hashed = pm.hash_password(test_password)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;å“ˆå¸Œç»“æœ: <span class="subst">&#123;hashed&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è§£æå“ˆå¸Œä¿¡æ¯</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n2. å“ˆå¸Œä¿¡æ¯&quot;</span>)</span><br><span class="line">    info = pm.get_hash_info(hashed)</span><br><span class="line">    <span class="keyword">for</span> key, value <span class="keyword">in</span> info.items():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  <span class="subst">&#123;key&#125;</span>: <span class="subst">&#123;value&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># éªŒè¯å¯†ç </span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n3. éªŒè¯æ­£ç¡®å¯†ç &quot;</span>)</span><br><span class="line">    result = pm.verify_password(hashed, test_password)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;éªŒè¯ç»“æœ: <span class="subst">&#123;<span class="string">&#x27;é€šè¿‡&#x27;</span> <span class="keyword">if</span> result <span class="keyword">else</span> <span class="string">&#x27;å¤±è´¥&#x27;</span>&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n4. éªŒè¯é”™è¯¯å¯†ç &quot;</span>)</span><br><span class="line">    result = pm.verify_password(hashed, <span class="string">&quot;WrongPassword&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;éªŒè¯ç»“æœ: <span class="subst">&#123;<span class="string">&#x27;é€šè¿‡&#x27;</span> <span class="keyword">if</span> result <span class="keyword">else</span> <span class="string">&#x27;å¤±è´¥&#x27;</span>&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    demo_usage()</span><br></pre></td></tr></table></figure><h3 id="6-3-å‚æ•°å‡çº§å’Œè¿ç§»ç­–ç•¥"><a href="#6-3-å‚æ•°å‡çº§å’Œè¿ç§»ç­–ç•¥" class="headerlink" title="6.3 å‚æ•°å‡çº§å’Œè¿ç§»ç­–ç•¥"></a>6.3 å‚æ•°å‡çº§å’Œè¿ç§»ç­–ç•¥</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ParameterMigrationManager</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    å‚æ•°è¿ç§»ç®¡ç†å™¨ - å¤„ç†ä¸åŒå®‰å…¨çº§åˆ«çš„å“ˆå¸Œå€¼</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># å®šä¹‰ä¸åŒç‰ˆæœ¬çš„å‚æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.parameter_versions = &#123;</span><br><span class="line">            <span class="string">&quot;v1.0&quot;</span>: &#123;<span class="string">&quot;time_cost&quot;</span>: <span class="number">2</span>, <span class="string">&quot;memory_cost&quot;</span>: <span class="number">16384</span>, <span class="string">&quot;parallelism&quot;</span>: <span class="number">1</span>&#125;,</span><br><span class="line">            <span class="string">&quot;v2.0&quot;</span>: &#123;<span class="string">&quot;time_cost&quot;</span>: <span class="number">3</span>, <span class="string">&quot;memory_cost&quot;</span>: <span class="number">65536</span>, <span class="string">&quot;parallelism&quot;</span>: <span class="number">4</span>&#125;,</span><br><span class="line">            <span class="string">&quot;v3.0&quot;</span>: &#123;<span class="string">&quot;time_cost&quot;</span>: <span class="number">5</span>, <span class="string">&quot;memory_cost&quot;</span>: <span class="number">262144</span>, <span class="string">&quot;parallelism&quot;</span>: <span class="number">8</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable language_">self</span>.current_version = <span class="string">&quot;v3.0&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ä¸ºæ¯ä¸ªç‰ˆæœ¬åˆ›å»ºå“ˆå¸Œå™¨</span></span><br><span class="line">        <span class="variable language_">self</span>.hashers = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> version, params <span class="keyword">in</span> <span class="variable language_">self</span>.parameter_versions.items():</span><br><span class="line">            <span class="variable language_">self</span>.hashers[version] = argon2.PasswordHasher(**params)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">identify_hash_version</span>(<span class="params">self, hash_string</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;è¯†åˆ«å“ˆå¸Œå€¼çš„å‚æ•°ç‰ˆæœ¬&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            parts = hash_string.split(<span class="string">&#x27;$&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(parts) &gt;= <span class="number">4</span>:</span><br><span class="line">                params_str = parts[<span class="number">3</span>]  <span class="comment"># m=65536,t=3,p=4</span></span><br><span class="line">                params = &#123;&#125;</span><br><span class="line">                <span class="keyword">for</span> param <span class="keyword">in</span> params_str.split(<span class="string">&#x27;,&#x27;</span>):</span><br><span class="line">                    key, value = param.split(<span class="string">&#x27;=&#x27;</span>)</span><br><span class="line">                    params[key] = <span class="built_in">int</span>(value)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># åŒ¹é…åˆ°å¯¹åº”ç‰ˆæœ¬</span></span><br><span class="line">                <span class="keyword">for</span> version, version_params <span class="keyword">in</span> <span class="variable language_">self</span>.parameter_versions.items():</span><br><span class="line">                    <span class="keyword">if</span> (params.get(<span class="string">&#x27;m&#x27;</span>) == version_params[<span class="string">&#x27;memory_cost&#x27;</span>] <span class="keyword">and</span></span><br><span class="line">                        params.get(<span class="string">&#x27;t&#x27;</span>) == version_params[<span class="string">&#x27;time_cost&#x27;</span>] <span class="keyword">and</span></span><br><span class="line">                        params.get(<span class="string">&#x27;p&#x27;</span>) == version_params[<span class="string">&#x27;parallelism&#x27;</span>]):</span><br><span class="line">                        <span class="keyword">return</span> version</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;unknown&quot;</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;invalid&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">verify_with_migration</span>(<span class="params">self, username, password, stored_hash</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;éªŒè¯å¯†ç å¹¶åœ¨éœ€è¦æ—¶è¿›è¡Œè¿ç§»&quot;&quot;&quot;</span></span><br><span class="line">        hash_version = <span class="variable language_">self</span>.identify_hash_version(stored_hash)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> hash_version == <span class="string">&quot;invalid&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span>, <span class="string">&quot;invalid_hash&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ç”¨å¯¹åº”ç‰ˆæœ¬çš„å“ˆå¸Œå™¨éªŒè¯</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> hash_version == <span class="string">&quot;unknown&quot;</span>:</span><br><span class="line">                <span class="comment"># å°è¯•ç”¨å½“å‰ç‰ˆæœ¬éªŒè¯</span></span><br><span class="line">                current_hasher = <span class="variable language_">self</span>.hashers[<span class="variable language_">self</span>.current_version]</span><br><span class="line">                current_hasher.verify(stored_hash, password)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span>, stored_hash, <span class="string">&quot;verified&quot;</span></span><br><span class="line">            </span><br><span class="line">            version_hasher = <span class="variable language_">self</span>.hashers[hash_version]</span><br><span class="line">            version_hasher.verify(stored_hash, password)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># éªŒè¯æˆåŠŸï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦å‡çº§</span></span><br><span class="line">            <span class="keyword">if</span> hash_version != <span class="variable language_">self</span>.current_version:</span><br><span class="line">                new_hasher = <span class="variable language_">self</span>.hashers[<span class="variable language_">self</span>.current_version]</span><br><span class="line">                new_hash = new_hasher.<span class="built_in">hash</span>(password)</span><br><span class="line">                </span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;ç”¨æˆ· <span class="subst">&#123;username&#125;</span> çš„å¯†ç ä» <span class="subst">&#123;hash_version&#125;</span> å‡çº§åˆ° <span class="subst">&#123;self.current_version&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span>, new_hash, <span class="string">&quot;upgraded&quot;</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span>, stored_hash, <span class="string">&quot;verified&quot;</span></span><br><span class="line">                </span><br><span class="line">        <span class="keyword">except</span> argon2.exceptions.VerifyMismatchError:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span>, <span class="string">&quot;wrong_password&quot;</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span>, <span class="string">f&quot;error_<span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure><h3 id="6-4-éƒ¨ç½²å’Œç»´æŠ¤å»ºè®®"><a href="#6-4-éƒ¨ç½²å’Œç»´æŠ¤å»ºè®®" class="headerlink" title="6.4 éƒ¨ç½²å’Œç»´æŠ¤å»ºè®®"></a>6.4 éƒ¨ç½²å’Œç»´æŠ¤å»ºè®®</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Argon2DeploymentGuide</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Argon2éƒ¨ç½²å®æˆ˜æŒ‡å—</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">benchmark_parameters</span>(<span class="params">self, target_time_ms=<span class="number">500</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;åŸºå‡†æµ‹è¯•ï¼Œæ‰¾åˆ°åˆé€‚çš„å‚æ•°&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">import</span> argon2</span><br><span class="line">        <span class="keyword">import</span> time</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;ç›®æ ‡è®¡ç®—æ—¶é—´: <span class="subst">&#123;target_time_ms&#125;</span>ms&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;å¼€å§‹å‚æ•°è°ƒä¼˜...&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        password = <span class="string">&quot;benchmark_password&quot;</span></span><br><span class="line">        best_params = <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># æµ‹è¯•ä¸åŒçš„å‚æ•°ç»„åˆ</span></span><br><span class="line">        <span class="keyword">for</span> time_cost <span class="keyword">in</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]:</span><br><span class="line">            <span class="keyword">for</span> memory_cost <span class="keyword">in</span> [<span class="number">16384</span>, <span class="number">32768</span>, <span class="number">65536</span>]:  <span class="comment"># 16MB, 32MB, 64MB</span></span><br><span class="line">                ph = argon2.PasswordHasher(</span><br><span class="line">                    time_cost=time_cost,</span><br><span class="line">                    memory_cost=memory_cost,</span><br><span class="line">                    parallelism=<span class="number">2</span></span><br><span class="line">                )</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># æµ‹è¯•5æ¬¡å–å¹³å‡å€¼</span></span><br><span class="line">                total_time = <span class="number">0</span></span><br><span class="line">                <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">                    start = time.time()</span><br><span class="line">                    ph.<span class="built_in">hash</span>(password)</span><br><span class="line">                    total_time += (time.time() - start)</span><br><span class="line">                </span><br><span class="line">                avg_time_ms = (total_time / <span class="number">5</span>) * <span class="number">1000</span></span><br><span class="line">                </span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;  time_cost=<span class="subst">&#123;time_cost&#125;</span>, memory_cost=<span class="subst">&#123;memory_cost&#125;</span>: <span class="subst">&#123;avg_time_ms:<span class="number">.1</span>f&#125;</span>ms&quot;</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># æ‰¾åˆ°æœ€æ¥è¿‘ç›®æ ‡æ—¶é—´çš„å‚æ•°</span></span><br><span class="line">                <span class="keyword">if</span> best_params <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="built_in">abs</span>(avg_time_ms - target_time_ms) &lt; <span class="built_in">abs</span>(best_params[<span class="string">&#x27;time&#x27;</span>] - target_time_ms):</span><br><span class="line">                    best_params = &#123;</span><br><span class="line">                        <span class="string">&#x27;time_cost&#x27;</span>: time_cost,</span><br><span class="line">                        <span class="string">&#x27;memory_cost&#x27;</span>: memory_cost,</span><br><span class="line">                        <span class="string">&#x27;time&#x27;</span>: avg_time_ms</span><br><span class="line">                    &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\næ¨èå‚æ•°: time_cost=<span class="subst">&#123;best_params[<span class="string">&#x27;time_cost&#x27;</span>]&#125;</span>, memory_cost=<span class="subst">&#123;best_params[<span class="string">&#x27;memory_cost&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;å®é™…è®¡ç®—æ—¶é—´: <span class="subst">&#123;best_params[<span class="string">&#x27;time&#x27;</span>]:<span class="number">.1</span>f&#125;</span>ms&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> best_params</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">production_recommendations</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;ç”Ÿäº§ç¯å¢ƒå»ºè®®&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;é…ç½®ç®¡ç†&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;å°†Argon2å‚æ•°æ”¾åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œä¾¿äºè°ƒæ•´&quot;</span>,</span><br><span class="line">                <span class="string">&quot;ä¸åŒç¯å¢ƒï¼ˆå¼€å‘/æµ‹è¯•/ç”Ÿäº§ï¼‰ä½¿ç”¨ä¸åŒå‚æ•°&quot;</span>,</span><br><span class="line">                <span class="string">&quot;å®šæœŸè¯„ä¼°å’Œè°ƒæ•´å‚æ•°&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;æ€§èƒ½ç›‘æ§&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;ç›‘æ§å¯†ç éªŒè¯çš„å“åº”æ—¶é—´&quot;</span>,</span><br><span class="line">                <span class="string">&quot;ç›‘æ§æœåŠ¡å™¨å†…å­˜ä½¿ç”¨æƒ…å†µ&quot;</span>,</span><br><span class="line">                <span class="string">&quot;è®¾ç½®è¶…æ—¶å’Œé‡è¯•æœºåˆ¶&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;å®‰å…¨è€ƒè™‘&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;å®šæœŸæ›´æ–°Argon2åº“ç‰ˆæœ¬&quot;</span>,</span><br><span class="line">                <span class="string">&quot;ç›‘æ§æ˜¯å¦æœ‰æ–°çš„æ”»å‡»æ–¹æ³•&quot;</span>,</span><br><span class="line">                <span class="string">&quot;è€ƒè™‘æ·»åŠ é¢å¤–çš„å®‰å…¨å±‚ï¼ˆå¦‚MFAï¼‰&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&quot;æ‰©å±•æ€§&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;å¦‚æœç”¨æˆ·é‡å¤§ï¼Œè€ƒè™‘ä½¿ç”¨ç¼“å­˜å‡å°‘é‡å¤è®¡ç®—&quot;</span>,</span><br><span class="line">                <span class="string">&quot;å¯ä»¥è€ƒè™‘å¼‚æ­¥å¤„ç†å¯†ç éªŒè¯&quot;</span>,</span><br><span class="line">                <span class="string">&quot;è´Ÿè½½å‡è¡¡æ—¶æ³¨æ„å†…å­˜åˆ†é…&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>Argon2ä¸æ˜¯ä»€ä¹ˆé»‘ç§‘æŠ€ï¼Œå®ƒçš„æ ¸å¿ƒæ€æƒ³å¾ˆç®€å•ï¼š<strong>è®©æ”»å‡»è€…ä¸ºæ¯æ¬¡å¯†ç å°è¯•ä»˜å‡ºé«˜æ˜‚çš„ä»£ä»·</strong>ã€‚é€šè¿‡å·§å¦™çš„å†…å­˜è®¿é—®æ¨¡å¼å’Œå¯è°ƒèŠ‚çš„å‚æ•°ï¼Œå®ƒåœ¨å¯†ç å“ˆå¸Œé¢†åŸŸç¡®å®æ˜¯ç›®å‰çš„æœ€ä½³é€‰æ‹©ã€‚</p><h3 id="å…³é”®è¦ç‚¹å›é¡¾"><a href="#å…³é”®è¦ç‚¹å›é¡¾" class="headerlink" title="å…³é”®è¦ç‚¹å›é¡¾"></a>å…³é”®è¦ç‚¹å›é¡¾</h3><ol><li><strong>ç†è§£æ ¸å¿ƒé—®é¢˜</strong> - ä¼ ç»Ÿå“ˆå¸Œç®—æ³•å¤ªå¿«ï¼Œç»™äº†æ”»å‡»è€…æœºä¼š</li><li><strong>å‚æ•°ç»‘å®šæœºåˆ¶</strong> - ä¸åŒå‚æ•°æ— æ³•è®¡ç®—å‡ºç›¸åŒå€¼ï¼Œé˜²æ­¢é™çº§æ”»å‡»</li><li><strong>å†…å­˜ä¾èµ–è®¾è®¡</strong> - æ•°æ®ä¾èµ–çš„å†…å­˜è®¿é—®æ¨¡å¼è®©æ”»å‡»æˆæœ¬æŒ‡æ•°å¢é•¿</li><li><strong>å®é™…åº”ç”¨è€ƒè™‘</strong> - æ ¹æ®åœºæ™¯é€‰æ‹©åˆé€‚å‚æ•°ï¼Œåˆ¶å®šå‡çº§ç­–ç•¥</li><li><strong>æŒç»­ç»´æŠ¤</strong> - å®šæœŸè¯„ä¼°å‚æ•°ï¼Œè·Ÿè¿›å®‰å…¨å‘å±•</li></ol><h3 id="æœ€ç»ˆå»ºè®®"><a href="#æœ€ç»ˆå»ºè®®" class="headerlink" title="æœ€ç»ˆå»ºè®®"></a>æœ€ç»ˆå»ºè®®</h3><ul><li><strong>æ–°é¡¹ç›®ç›´æ¥ä½¿ç”¨Argon2id</strong> - ä¸è¦å†ç”¨ä¼ ç»Ÿå“ˆå¸Œç®—æ³•</li><li><strong>è€é¡¹ç›®åˆ¶å®šè¿ç§»è®¡åˆ’</strong> - é€æ­¥å‡çº§åˆ°Argon2</li><li><strong>å‚æ•°é€‰æ‹©è¦å¹³è¡¡</strong> - å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒéƒ½è¦è€ƒè™‘</li><li><strong>ä¿æŒå­¦ä¹ æ€åº¦</strong> - å¯†ç å­¦åœ¨å‘å±•ï¼Œè¦è·Ÿä¸Šæ—¶ä»£</li></ul><p>å®‰å…¨æ˜¯ä¸ªç³»ç»Ÿå·¥ç¨‹ï¼ŒArgon2åªæ˜¯å…¶ä¸­ä¸€ç¯ã€‚å¯†ç ç­–ç•¥ã€å¤šå› ç´ éªŒè¯ã€ç³»ç»Ÿç›‘æ§ç­‰éƒ½åŒæ ·é‡è¦ã€‚ä½†ä½œä¸ºå¯†ç å­˜å‚¨çš„åŸºç¡€ï¼Œé€‰æ‹©Argon2ç¡®å®èƒ½è®©ä½ åœ¨å®‰å…¨æ€§ä¸Šé¢†å…ˆä¸€å¤§æ­¥ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ol><li><a href="https://tools.ietf.org/html/draft-irtf-cfrg-argon2-13">Argon2 Specification</a></li><li><a href="https://password-hashing.net/">Password Hashing Competition</a></li><li><a href="https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html">OWASP Password Storage Cheat Sheet</a></li><li><a href="https://github.com/P-H-C/phc-winner-argon2">Argon2 GitHub Repository</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¯†ç å“ˆå¸Œ </tag>
            
            <tag> Argon2 </tag>
            
            <tag> å¯†ç å­¦ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaç›‘è§†å™¨æœ‰ç­‰å¾…é˜Ÿåˆ—ï¼Œä¸ºä»€ä¹ˆsynchronizedè¿˜æ˜¯éå…¬å¹³é”ï¼Ÿ</title>
      <link href="/2025/06/22/synchronized%E7%9B%91%E8%A7%86%E5%99%A8%E4%B8%8E%E9%9D%9E%E5%85%AC%E5%B9%B3%E9%94%81/"/>
      <url>/2025/06/22/synchronized%E7%9B%91%E8%A7%86%E5%99%A8%E4%B8%8E%E9%9D%9E%E5%85%AC%E5%B9%B3%E9%94%81/</url>
      
        <content type="html"><![CDATA[<h1 id="Javaç›‘è§†å™¨æœ‰ç­‰å¾…é˜Ÿåˆ—ï¼Œä¸ºä»€ä¹ˆsynchronizedè¿˜æ˜¯éå…¬å¹³é”ï¼Ÿ"><a href="#Javaç›‘è§†å™¨æœ‰ç­‰å¾…é˜Ÿåˆ—ï¼Œä¸ºä»€ä¹ˆsynchronizedè¿˜æ˜¯éå…¬å¹³é”ï¼Ÿ" class="headerlink" title="Javaç›‘è§†å™¨æœ‰ç­‰å¾…é˜Ÿåˆ—ï¼Œä¸ºä»€ä¹ˆsynchronizedè¿˜æ˜¯éå…¬å¹³é”ï¼Ÿ"></a>Javaç›‘è§†å™¨æœ‰ç­‰å¾…é˜Ÿåˆ—ï¼Œä¸ºä»€ä¹ˆsynchronizedè¿˜æ˜¯éå…¬å¹³é”ï¼Ÿ</h1><p>ä¹‹å‰åœ¨çœ‹synchronizedçš„æºç æ—¶å‘ç°äº†ä¸€ä¸ªæœ‰è¶£çš„é—®é¢˜ï¼šæ—¢ç„¶Javaçš„ç›‘è§†å™¨ï¼ˆMonitorï¼‰åº•å±‚æœ‰ç­‰å¾…é˜Ÿåˆ—ï¼ˆEntry Setï¼‰æ¥ç®¡ç†ç«äº‰é”çš„çº¿ç¨‹ï¼Œé‚£ä¸ºä»€ä¹ˆsynchronizedè¿˜æ˜¯å®ç°ä¸äº†å…¬å¹³é”å‘¢ï¼Ÿ</p><p>å…¶å®å‡†ç¡®æ¥è¯´ï¼Œä¸æ˜¯â€å®ç°ä¸äº†â€ï¼Œè€Œæ˜¯synchronizedä»è®¾è®¡ä¹‹åˆå°±é€‰æ‹©äº†æ€§èƒ½å’Œç®€ä¾¿æ€§ï¼Œæ‰€ä»¥å‹æ ¹æ²¡æ‰“ç®—åšæˆå…¬å¹³é”ã€‚</p><h2 id="ç›‘è§†å™¨çš„åŸºæœ¬ç»“æ„"><a href="#ç›‘è§†å™¨çš„åŸºæœ¬ç»“æ„" class="headerlink" title="ç›‘è§†å™¨çš„åŸºæœ¬ç»“æ„"></a>ç›‘è§†å™¨çš„åŸºæœ¬ç»“æ„</h2><p>æ¯ä¸ªJavaå¯¹è±¡éƒ½å…³è”ç€ä¸€ä¸ªç›‘è§†å™¨ï¼ŒåŒ…å«å‡ ä¸ªå…³é”®éƒ¨åˆ†ï¼š</p><ul><li><strong>Owner</strong>: å½“å‰æŒæœ‰é”çš„çº¿ç¨‹</li><li><strong>Entry Set</strong>: ç­‰å¾…è·å–é”çš„çº¿ç¨‹é˜Ÿåˆ—  </li><li><strong>Wait Set</strong>: è°ƒç”¨wait()åè¿›å…¥ç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹é˜Ÿåˆ—</li></ul><p>çº¿ç¨‹è·å–synchronizedé”çš„æµç¨‹ï¼š</p><ol><li>é”æ²¡äººç”¨ï¼ˆOwnerä¸ºç©ºï¼‰â†’ ç›´æ¥æ‹¿åˆ°é”</li><li>é”è¢«å ç”¨ â†’ è¿›å…¥Entry Setæ’é˜Ÿç­‰å¾…</li></ol><h2 id="synchronizedä¸ºä»€ä¹ˆæ˜¯éå…¬å¹³çš„ï¼Ÿ"><a href="#synchronizedä¸ºä»€ä¹ˆæ˜¯éå…¬å¹³çš„ï¼Ÿ" class="headerlink" title="synchronizedä¸ºä»€ä¹ˆæ˜¯éå…¬å¹³çš„ï¼Ÿ"></a>synchronizedä¸ºä»€ä¹ˆæ˜¯éå…¬å¹³çš„ï¼Ÿ</h2><p>è™½ç„¶æœ‰Entry Setè¿™ä¸ªé˜Ÿåˆ—ï¼Œä½†synchronizedçš„é”åˆ†é…ç­–ç•¥å°±æ˜¯éå…¬å¹³çš„ï¼Œä¸»è¦åŸå› ï¼š</p><h3 id="1-æ–°çº¿ç¨‹å¯ä»¥â€æ’é˜Ÿâ€"><a href="#1-æ–°çº¿ç¨‹å¯ä»¥â€æ’é˜Ÿâ€" class="headerlink" title="1. æ–°çº¿ç¨‹å¯ä»¥â€æ’é˜Ÿâ€"></a>1. æ–°çº¿ç¨‹å¯ä»¥â€æ’é˜Ÿâ€</h3><p>è¿™æ˜¯æœ€å…³é”®çš„ç‚¹ã€‚å½“é”é‡Šæ”¾æ—¶ï¼Œæ–°æ¥çš„çº¿ç¨‹å¯ä»¥ç›´æ¥å’ŒEntry Setä¸­ç­‰å¾…çš„çº¿ç¨‹ç«äº‰ï¼Œè€Œä¸éœ€è¦æ’é˜Ÿã€‚</p><p><strong>ä¸¾ä¸ªä¾‹å­ï¼š</strong></p><ul><li>çº¿ç¨‹Aé‡Šæ”¾é”</li><li>çº¿ç¨‹Båœ¨Entry Setä¸­ç­‰å¾…</li><li>çº¿ç¨‹Cåˆšå¥½è¿™æ—¶å€™è¦è·å–é”</li><li>ç»“æœï¼šçº¿ç¨‹Cå¯èƒ½ç›´æ¥æŠ¢åˆ°é”ï¼Œè·³è¿‡äº†çº¿ç¨‹B</li></ul><p>ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡ï¼Ÿ<strong>æ€§èƒ½è€ƒè™‘</strong>ã€‚è®©æ–°çº¿ç¨‹ç›´æ¥ç«äº‰å¯ä»¥å‡å°‘çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ï¼Œæå‡æ•´ä½“ååé‡ã€‚</p><h3 id="2-JVMçš„å„ç§é”ä¼˜åŒ–"><a href="#2-JVMçš„å„ç§é”ä¼˜åŒ–" class="headerlink" title="2. JVMçš„å„ç§é”ä¼˜åŒ–"></a>2. JVMçš„å„ç§é”ä¼˜åŒ–</h3><p>ç°ä»£JVMå¯¹synchronizedåšäº†å¾ˆå¤šä¼˜åŒ–ï¼Œè¿™äº›ä¼˜åŒ–è¿›ä¸€æ­¥åŠ å‰§äº†éå…¬å¹³æ€§ï¼š</p><p><strong>åå‘é”ï¼ˆBiased Lockingï¼‰</strong></p><ul><li>é”ä¼šâ€åå¿ƒâ€ç¬¬ä¸€ä¸ªè·å–å®ƒçš„çº¿ç¨‹</li><li>åç»­å¦‚æœæ²¡æœ‰ç«äº‰ï¼Œç›´æ¥è¿›å…¥åŒæ­¥ä»£ç ï¼Œæ ¹æœ¬ä¸èµ°é˜Ÿåˆ—</li></ul><p><strong>è½»é‡çº§é”ï¼ˆLightweight Lockingï¼‰</strong>  </p><ul><li>é€šè¿‡CASæ“ä½œå°è¯•è·å–é”</li><li>å¤±è´¥åä¼šè‡ªæ—‹ï¼ˆspinï¼‰è€Œä¸æ˜¯ç›´æ¥å…¥é˜Ÿ</li><li>æ–°çº¿ç¨‹å¯èƒ½é€šè¿‡è‡ªæ—‹æŠ¢åˆ°é”</li></ul><p><strong>è‡ªæ—‹é”ï¼ˆSpin Lockingï¼‰</strong></p><ul><li>Entry Setä¸­çš„çº¿ç¨‹å¯èƒ½è‡ªæ—‹å°è¯•è·å–é”</li><li>å’Œæ–°çº¿ç¨‹ç«äº‰æ—¶æ²¡æœ‰é¡ºåºä¿è¯</li></ul><h3 id="3-é˜Ÿåˆ—å”¤é†’ç­–ç•¥ä¸ä¿è¯FIFO"><a href="#3-é˜Ÿåˆ—å”¤é†’ç­–ç•¥ä¸ä¿è¯FIFO" class="headerlink" title="3. é˜Ÿåˆ—å”¤é†’ç­–ç•¥ä¸ä¿è¯FIFO"></a>3. é˜Ÿåˆ—å”¤é†’ç­–ç•¥ä¸ä¿è¯FIFO</h3><p>Entry Setä¸­çº¿ç¨‹çš„å”¤é†’é¡ºåºå¹¶ä¸æ˜¯å…ˆè¿›å…ˆå‡ºçš„ã€‚JVMå®ç°ï¼ˆæ¯”å¦‚HotSpotï¼‰å¯èƒ½é‡‡ç”¨ï¼š</p><ul><li>éšæœºå”¤é†’</li><li>ç­–ç•¥æ€§å”¤é†’ï¼ˆä¼˜å…ˆå”¤é†’æœ€è¿‘æ´»è·ƒçš„çº¿ç¨‹ï¼‰</li></ul><p>è€Œä¸æ˜¯æŒ‰è¯·æ±‚é¡ºåºåˆ†é…é”ã€‚</p><h2 id="å…¬å¹³é”æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ"><a href="#å…¬å¹³é”æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ" class="headerlink" title="å…¬å¹³é”æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ"></a>å…¬å¹³é”æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ</h2><p>çœ‹çœ‹ReentrantLockçš„å…¬å¹³é”å®ç°å°±æ˜ç™½äº†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ReentrantLock</span> <span class="variable">fairLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>(<span class="literal">true</span>); <span class="comment">// trueè¡¨ç¤ºå…¬å¹³é”</span></span><br><span class="line"></span><br><span class="line">fairLock.lock();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// ä¸´ç•ŒåŒºä»£ç </span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    fairLock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å…¬å¹³é”çš„ç­–ç•¥ï¼š</strong></p><ul><li>é”é‡Šæ”¾æ—¶ï¼Œä¼˜å…ˆå”¤é†’Entry Setä¸­ç­‰å¾…æ—¶é—´æœ€é•¿çš„çº¿ç¨‹</li><li>æ–°çº¿ç¨‹å¿…é¡»æ’é˜Ÿï¼Œä¸èƒ½æ’é˜Ÿ</li></ul><p><strong>synchronizedçš„å±€é™ï¼š</strong></p><ul><li>æ²¡æœ‰å…¬å¹³æ¨¡å¼é€‰é¡¹</li><li>æ— æ³•æ§åˆ¶Entry Setä¸­çº¿ç¨‹çš„å”¤é†’é¡ºåº</li><li>åº•å±‚å®ç°å§‹ç»ˆæ˜¯éå…¬å¹³çš„</li></ul><h2 id="ä¸ºä»€ä¹ˆsynchronizedé€‰æ‹©éå…¬å¹³ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆsynchronizedé€‰æ‹©éå…¬å¹³ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆsynchronizedé€‰æ‹©éå…¬å¹³ï¼Ÿ"></a>ä¸ºä»€ä¹ˆsynchronizedé€‰æ‹©éå…¬å¹³ï¼Ÿ</h2><p>ä»æŠ€æœ¯è§’åº¦çœ‹ï¼ŒEntry Setå®Œå…¨å¯ä»¥è®¾è®¡æˆFIFOé˜Ÿåˆ—ï¼ŒJVMä¹Ÿå®Œå…¨å¯ä»¥æŒ‰FIFOé¡ºåºå”¤é†’çº¿ç¨‹ã€‚synchronizedå®ç°å…¬å¹³é”åœ¨æŠ€æœ¯ä¸Šæ²¡æœ‰éšœç¢ã€‚</p><p><strong>çœŸæ­£çš„åŸå› æ˜¯è®¾è®¡å–èˆï¼š</strong></p><h3 id="æ€§èƒ½ä¼˜å…ˆçš„è€ƒè™‘"><a href="#æ€§èƒ½ä¼˜å…ˆçš„è€ƒè™‘" class="headerlink" title="æ€§èƒ½ä¼˜å…ˆçš„è€ƒè™‘"></a>æ€§èƒ½ä¼˜å…ˆçš„è€ƒè™‘</h3><p><strong>å‡å°‘çº¿ç¨‹åˆ‡æ¢å¼€é”€</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">åœºæ™¯ï¼šçº¿ç¨‹Aé‡Šæ”¾é”å</span><br><span class="line">- éå…¬å¹³é”ï¼šæ–°çº¿ç¨‹Cå¯èƒ½ç›´æ¥é€šè¿‡è‡ªæ—‹æŠ¢åˆ°é”ï¼Œé¿å…å”¤é†’çº¿ç¨‹B</span><br><span class="line">- å…¬å¹³é”ï¼šå¿…é¡»å…ˆå”¤é†’é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹Bï¼Œæ¶‰åŠæ“ä½œç³»ç»Ÿçº§çš„çº¿ç¨‹è°ƒåº¦</span><br></pre></td></tr></table></figure><p><strong>æå‡ååé‡</strong></p><ul><li>éå…¬å¹³é”åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹å…è®¸æ›´é«˜æ•ˆçš„é”ç«äº‰</li><li>å‡å°‘CPUç©ºé—²æ—¶é—´ï¼Œæœ€å¤§åŒ–åˆ©ç”¨ç‡</li></ul><h3 id="JVMä¼˜åŒ–ç­–ç•¥çš„é…åˆ"><a href="#JVMä¼˜åŒ–ç­–ç•¥çš„é…åˆ" class="headerlink" title="JVMä¼˜åŒ–ç­–ç•¥çš„é…åˆ"></a>JVMä¼˜åŒ–ç­–ç•¥çš„é…åˆ</h3><p>ç°ä»£JVMå¯¹synchronizedçš„å„ç§ä¼˜åŒ–ï¼ˆåå‘é”ã€è½»é‡çº§é”ã€è‡ªæ—‹é”ç­‰ï¼‰éƒ½æ›´é€‚åˆéå…¬å¹³é”çš„ç‰¹æ€§ã€‚å¦‚æœå¼ºè¡Œå®ç°å…¬å¹³é”ï¼Œè¿™äº›ä¼˜åŒ–çš„æ•ˆæœä¼šå¤§æ‰“æŠ˜æ‰£ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>synchronizedçš„éå…¬å¹³æ€§ä¸æ˜¯æŠ€æœ¯é™åˆ¶ï¼Œè€Œæ˜¯è®¾è®¡é€‰æ‹©ã€‚Javaåœ¨è®¾è®¡æ—¶ä¼˜å…ˆè€ƒè™‘äº†æ€§èƒ½å’Œç®€ä¾¿æ€§ï¼Œé€‰æ‹©ç‰ºç‰²å…¬å¹³æ€§æ¥æ¢å–æ›´å¥½çš„ååé‡ã€‚</p><p>å¦‚æœä½ çš„ä¸šåŠ¡åœºæ™¯å¯¹å…¬å¹³æ€§æœ‰ä¸¥æ ¼è¦æ±‚ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ReentrantLockçš„å…¬å¹³æ¨¡å¼ã€‚ä½†è¦è®°ä½ï¼Œå…¬å¹³é”é€šå¸¸ä¼šå¸¦æ¥ä¸€å®šçš„æ€§èƒ½æŸå¤±ã€‚</p><p><strong>ä»€ä¹ˆæ—¶å€™éœ€è¦å…¬å¹³é”ï¼Ÿ</strong></p><ul><li>é˜²æ­¢çº¿ç¨‹é¥¥é¥¿çš„åœºæ™¯</li><li>å¯¹å“åº”æ—¶é—´æœ‰ä¸¥æ ¼è¦æ±‚çš„ç³»ç»Ÿ</li><li>éœ€è¦ä¸¥æ ¼æŒ‰é¡ºåºå¤„ç†è¯·æ±‚çš„ä¸šåŠ¡é€»è¾‘</li></ul><p><strong>ä»€ä¹ˆæ—¶å€™ç”¨synchronizedå°±å¤Ÿäº†ï¼Ÿ</strong></p><ul><li>å¤§éƒ¨åˆ†æ™®é€šçš„åŒæ­¥åœºæ™¯</li><li>è¿½æ±‚é«˜ååé‡çš„ç³»ç»Ÿ</li><li>å¯¹å…¬å¹³æ€§è¦æ±‚ä¸é«˜çš„ä¸šåŠ¡é€»è¾‘</li></ul>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> å¹¶å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ“ä½œç³»ç»Ÿå¯†ç å­˜å‚¨æœºåˆ¶è¯¦è§£ï¼šLinuxã€macOSã€Windowså¯†ç ç®¡ç†æ·±åº¦åˆ†æ</title>
      <link href="/2025/06/22/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AF%86%E7%A0%81%E5%AD%98%E5%82%A8%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3%EF%BC%9ALinux-macOS-Windows%E5%AF%86%E7%A0%81%E7%AE%A1%E7%90%86%E6%B7%B1%E5%BA%A6%E5%88%86%E6%9E%90/"/>
      <url>/2025/06/22/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AF%86%E7%A0%81%E5%AD%98%E5%82%A8%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3%EF%BC%9ALinux-macOS-Windows%E5%AF%86%E7%A0%81%E7%AE%A1%E7%90%86%E6%B7%B1%E5%BA%A6%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<h1 id="æ“ä½œç³»ç»Ÿå¯†ç å­˜å‚¨æœºåˆ¶è¯¦è§£ï¼šLinuxã€macOSã€Windowså¯†ç ç®¡ç†æ·±åº¦åˆ†æ"><a href="#æ“ä½œç³»ç»Ÿå¯†ç å­˜å‚¨æœºåˆ¶è¯¦è§£ï¼šLinuxã€macOSã€Windowså¯†ç ç®¡ç†æ·±åº¦åˆ†æ" class="headerlink" title="æ“ä½œç³»ç»Ÿå¯†ç å­˜å‚¨æœºåˆ¶è¯¦è§£ï¼šLinuxã€macOSã€Windowså¯†ç ç®¡ç†æ·±åº¦åˆ†æ"></a>æ“ä½œç³»ç»Ÿå¯†ç å­˜å‚¨æœºåˆ¶è¯¦è§£ï¼šLinuxã€macOSã€Windowså¯†ç ç®¡ç†æ·±åº¦åˆ†æ</h1><h2 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h2><p>ç”¨æˆ·å¯†ç æ˜¯æ“ä½œç³»ç»Ÿå®‰å…¨çš„ç¬¬ä¸€é“é˜²çº¿ï¼Œä¸åŒæ“ä½œç³»ç»Ÿé‡‡ç”¨äº†å„è‡ªç‹¬ç‰¹çš„å¯†ç å­˜å‚¨å’Œç®¡ç†æœºåˆ¶ã€‚æœ¬æ–‡å°†æ·±å…¥åˆ†æLinuxã€macOSå’ŒWindowsä¸‰å¤§ä¸»æµæ“ä½œç³»ç»Ÿå¦‚ä½•å®‰å…¨åœ°ä¿å­˜ç®¡ç†å‘˜å¯†ç ï¼Œä»¥åŠå®ƒä»¬é‡‡ç”¨çš„åŠ å¯†ç®—æ³•å’Œå®‰å…¨é˜²æŠ¤æªæ–½ã€‚</p><h2 id="1-Linuxç³»ç»Ÿå¯†ç å­˜å‚¨æœºåˆ¶"><a href="#1-Linuxç³»ç»Ÿå¯†ç å­˜å‚¨æœºåˆ¶" class="headerlink" title="1. Linuxç³»ç»Ÿå¯†ç å­˜å‚¨æœºåˆ¶"></a>1. Linuxç³»ç»Ÿå¯†ç å­˜å‚¨æœºåˆ¶</h2><h3 id="1-1-ä¼ ç»Ÿçš„-etc-passwdæ–‡ä»¶"><a href="#1-1-ä¼ ç»Ÿçš„-etc-passwdæ–‡ä»¶" class="headerlink" title="1.1 ä¼ ç»Ÿçš„&#x2F;etc&#x2F;passwdæ–‡ä»¶"></a>1.1 ä¼ ç»Ÿçš„&#x2F;etc&#x2F;passwdæ–‡ä»¶</h3><p>åœ¨æ—©æœŸçš„Unixç³»ç»Ÿä¸­ï¼Œç”¨æˆ·å¯†ç ç›´æ¥å­˜å‚¨åœ¨<code>/etc/passwd</code>æ–‡ä»¶ä¸­ï¼Œä½†è¿™å­˜åœ¨ä¸¥é‡çš„å®‰å…¨éšæ‚£ï¼Œå› ä¸ºè¯¥æ–‡ä»¶å¯¹æ‰€æœ‰ç”¨æˆ·å¯è¯»ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¼ ç»Ÿæ ¼å¼ï¼ˆå·²ä¸æ¨èï¼‰</span></span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br></pre></td></tr></table></figure><h3 id="1-2-ç°ä»£çš„Shadowå¯†ç ç³»ç»Ÿ"><a href="#1-2-ç°ä»£çš„Shadowå¯†ç ç³»ç»Ÿ" class="headerlink" title="1.2 ç°ä»£çš„Shadowå¯†ç ç³»ç»Ÿ"></a>1.2 ç°ä»£çš„Shadowå¯†ç ç³»ç»Ÿ</h3><p>ç°ä»£Linuxç³»ç»Ÿä½¿ç”¨Shadowå¯†ç ç³»ç»Ÿï¼Œå°†å¯†ç å“ˆå¸Œå€¼å­˜å‚¨åœ¨<code>/etc/shadow</code>æ–‡ä»¶ä¸­ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/shadowæ–‡ä»¶æ ¼å¼</span></span><br><span class="line">root:$6$salt<span class="variable">$hashedpassword</span>:18000:0:99999:7:::</span><br></pre></td></tr></table></figure><p><strong>å­—æ®µè§£é‡Šï¼š</strong></p><ul><li>ç”¨æˆ·åï¼šroot</li><li>å¯†ç å“ˆå¸Œï¼š<code>$6$salt$hashedpassword</code></li><li>æœ€åä¿®æ”¹æ—¥æœŸï¼š18000ï¼ˆä»1970å¹´1æœˆ1æ—¥å¼€å§‹çš„å¤©æ•°ï¼‰</li><li>æœ€å°å¯†ç å¹´é¾„ï¼š0å¤©</li><li>æœ€å¤§å¯†ç å¹´é¾„ï¼š99999å¤©</li><li>è­¦å‘ŠæœŸï¼š7å¤©</li><li>ä¸æ´»è·ƒæœŸï¼šç©º</li><li>è¿‡æœŸæ—¥æœŸï¼šç©º</li><li>ä¿ç•™å­—æ®µï¼šç©º</li></ul><h3 id="1-3-Linuxå¯†ç å“ˆå¸Œç®—æ³•"><a href="#1-3-Linuxå¯†ç å“ˆå¸Œç®—æ³•" class="headerlink" title="1.3 Linuxå¯†ç å“ˆå¸Œç®—æ³•"></a>1.3 Linuxå¯†ç å“ˆå¸Œç®—æ³•</h3><p>Linuxæ”¯æŒå¤šç§å“ˆå¸Œç®—æ³•ï¼Œé€šè¿‡<code>$id$</code>å‰ç¼€æ ‡è¯†ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$1$    <span class="comment"># MD5ï¼ˆå·²ä¸å®‰å…¨ï¼‰</span></span><br><span class="line">$2a$   <span class="comment"># Blowfish</span></span><br><span class="line">$5$    <span class="comment"># SHA-256</span></span><br><span class="line">$6$    <span class="comment"># SHA-512ï¼ˆæ¨èï¼‰</span></span><br><span class="line">$y$    <span class="comment"># yescryptï¼ˆæœ€æ–°æ¨èï¼‰</span></span><br></pre></td></tr></table></figure><h3 id="1-4-å®é™…å­˜å‚¨ç¤ºä¾‹"><a href="#1-4-å®é™…å­˜å‚¨ç¤ºä¾‹" class="headerlink" title="1.4 å®é™…å­˜å‚¨ç¤ºä¾‹"></a>1.4 å®é™…å­˜å‚¨ç¤ºä¾‹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹shadowæ–‡ä»¶ï¼ˆéœ€è¦rootæƒé™ï¼‰</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cat</span> /etc/shadow | grep root</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡ºç¤ºä¾‹</span></span><br><span class="line">root:$6$randomsalt<span class="variable">$4Zw8aBcDe5FgHi6JkLmNoP7QrStUvWxYz0123456789AbCdEfGhIjKlMnOpQrStUvWxYz</span>:19000:0:99999:7:::</span><br></pre></td></tr></table></figure><h3 id="1-5-å¯†ç éªŒè¯æµç¨‹"><a href="#1-5-å¯†ç éªŒè¯æµç¨‹" class="headerlink" title="1.5 å¯†ç éªŒè¯æµç¨‹"></a>1.5 å¯†ç éªŒè¯æµç¨‹</h3><pre class="mermaid">graph TD    A["ç”¨æˆ·è¾“å…¥å¯†ç "] --> B["ç³»ç»Ÿè¯»å–/etc/shadow"]    B --> C["æå–saltå’Œç®—æ³•æ ‡è¯†"]    C --> D["ä½¿ç”¨ç›¸åŒç®—æ³•å’Œsaltå“ˆå¸Œè¾“å…¥å¯†ç "]    D --> E["æ¯”è¾ƒå“ˆå¸Œå€¼"]    E --> F{å“ˆå¸Œå€¼åŒ¹é…?}    F -->|æ˜¯| G["è®¤è¯æˆåŠŸ"]    F -->|å¦| H["è®¤è¯å¤±è´¥"]</pre><h2 id="2-macOSç³»ç»Ÿå¯†ç å­˜å‚¨æœºåˆ¶"><a href="#2-macOSç³»ç»Ÿå¯†ç å­˜å‚¨æœºåˆ¶" class="headerlink" title="2. macOSç³»ç»Ÿå¯†ç å­˜å‚¨æœºåˆ¶"></a>2. macOSç³»ç»Ÿå¯†ç å­˜å‚¨æœºåˆ¶</h2><h3 id="2-1-Open-DirectoryæœåŠ¡"><a href="#2-1-Open-DirectoryæœåŠ¡" class="headerlink" title="2.1 Open DirectoryæœåŠ¡"></a>2.1 Open DirectoryæœåŠ¡</h3><p>macOSä½¿ç”¨Open DirectoryæœåŠ¡ç®¡ç†ç”¨æˆ·è®¤è¯ï¼Œå¯†ç å­˜å‚¨åœ¨ä»¥ä¸‹ä½ç½®ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æœ¬åœ°ç”¨æˆ·æ•°æ®åº“</span></span><br><span class="line">/var/db/dslocal/nodes/Default/users/</span><br></pre></td></tr></table></figure><h3 id="2-2-å¯†ç å“ˆå¸Œå­˜å‚¨"><a href="#2-2-å¯†ç å“ˆå¸Œå­˜å‚¨" class="headerlink" title="2.2 å¯†ç å“ˆå¸Œå­˜å‚¨"></a>2.2 å¯†ç å“ˆå¸Œå­˜å‚¨</h3><p>macOSç”¨æˆ·å¯†ç ä»¥plistæ ¼å¼å­˜å‚¨ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- /var/db/dslocal/nodes/Default/users/root.plist --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>ShadowHashData<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">array</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">        SALTED-SHA512-PBKDF2å“ˆå¸Œæ•°æ®çš„Base64ç¼–ç </span><br><span class="line">        <span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="2-3-PBKDF2ç®—æ³•"><a href="#2-3-PBKDF2ç®—æ³•" class="headerlink" title="2.3 PBKDF2ç®—æ³•"></a>2.3 PBKDF2ç®—æ³•</h3><p>macOSä½¿ç”¨PBKDF2ï¼ˆPassword-Based Key Derivation Function 2ï¼‰ç®—æ³•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># PBKDF2ç®—æ³•ä¼ªä»£ç </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pbkdf2_hash</span>(<span class="params">password, salt, iterations=<span class="number">10000</span></span>):</span><br><span class="line">    <span class="keyword">return</span> pbkdf2(password, salt, iterations, <span class="number">32</span>, <span class="string">&#x27;sha512&#x27;</span>)</span><br></pre></td></tr></table></figure><h3 id="2-4-Keychainå¯†ç ç®¡ç†"><a href="#2-4-Keychainå¯†ç ç®¡ç†" class="headerlink" title="2.4 Keychainå¯†ç ç®¡ç†"></a>2.4 Keychainå¯†ç ç®¡ç†</h3><p>macOSè¿˜ä½¿ç”¨KeychainæœåŠ¡ç®¡ç†å¯†ç ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Keychainæ–‡ä»¶ä½ç½®</span></span><br><span class="line">~/Library/Keychains/login.keychain-db  <span class="comment"># ç”¨æˆ·çº§åˆ«</span></span><br><span class="line">/Library/Keychains/System.keychain     <span class="comment"># ç³»ç»Ÿçº§åˆ«</span></span><br></pre></td></tr></table></figure><h3 id="2-5-FileVaultç£ç›˜åŠ å¯†"><a href="#2-5-FileVaultç£ç›˜åŠ å¯†" class="headerlink" title="2.5 FileVaultç£ç›˜åŠ å¯†"></a>2.5 FileVaultç£ç›˜åŠ å¯†</h3><p>å½“å¯ç”¨FileVaultæ—¶ï¼Œæ•´ä¸ªç£ç›˜è¢«åŠ å¯†ï¼Œæä¾›é¢å¤–çš„å®‰å…¨å±‚ï¼š</p><pre class="mermaid">graph TD    A["ç”¨æˆ·ç™»å½•å¯†ç "] --> B["è§£é”Keychain"]    B --> C["è·å–FileVaultå¯†é’¥"]    C --> D["è§£å¯†ç³»ç»Ÿç£ç›˜"]    D --> E["ç³»ç»Ÿæ­£å¸¸å¯åŠ¨"]</pre><h2 id="3-Windowsç³»ç»Ÿå¯†ç å­˜å‚¨æœºåˆ¶"><a href="#3-Windowsç³»ç»Ÿå¯†ç å­˜å‚¨æœºåˆ¶" class="headerlink" title="3. Windowsç³»ç»Ÿå¯†ç å­˜å‚¨æœºåˆ¶"></a>3. Windowsç³»ç»Ÿå¯†ç å­˜å‚¨æœºåˆ¶</h2><h3 id="3-1-SAMæ•°æ®åº“"><a href="#3-1-SAMæ•°æ®åº“" class="headerlink" title="3.1 SAMæ•°æ®åº“"></a>3.1 SAMæ•°æ®åº“</h3><p>Windowså°†ç”¨æˆ·å¯†ç å­˜å‚¨åœ¨SAMï¼ˆSecurity Account Managerï¼‰æ•°æ®åº“ä¸­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ä½ç½®ï¼šC:\Windows\System32\config\SAM</span><br></pre></td></tr></table></figure><h3 id="3-2-å¯†ç å“ˆå¸Œç®—æ³•"><a href="#3-2-å¯†ç å“ˆå¸Œç®—æ³•" class="headerlink" title="3.2 å¯†ç å“ˆå¸Œç®—æ³•"></a>3.2 å¯†ç å“ˆå¸Œç®—æ³•</h3><p>Windowsä½¿ç”¨ä»¥ä¸‹å“ˆå¸Œç®—æ³•ï¼š</p><p><strong>LM Hashï¼ˆå·²å¼ƒç”¨ï¼‰ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># LM Hashç‰¹ç‚¹</span><br><span class="line">- åŸºäºDESç®—æ³•</span><br><span class="line">- ä¸åŒºåˆ†å¤§å°å†™</span><br><span class="line">- æœ€å¤§14å­—ç¬¦</span><br><span class="line">- å­˜åœ¨ä¸¥é‡å®‰å…¨æ¼æ´</span><br></pre></td></tr></table></figure><p><strong>NTLM Hashï¼ˆå½“å‰ä½¿ç”¨ï¼‰ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># NTLM Hashç‰¹ç‚¹</span><br><span class="line">- åŸºäºMD4ç®—æ³•</span><br><span class="line">- åŒºåˆ†å¤§å°å†™</span><br><span class="line">- æ”¯æŒUnicodeå­—ç¬¦</span><br><span class="line">- ç›¸å¯¹æ›´å®‰å…¨</span><br></pre></td></tr></table></figure><h3 id="3-3-SAMæ–‡ä»¶ç»“æ„"><a href="#3-3-SAMæ–‡ä»¶ç»“æ„" class="headerlink" title="3.3 SAMæ–‡ä»¶ç»“æ„"></a>3.3 SAMæ–‡ä»¶ç»“æ„</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SAM Registry Hive:</span><br><span class="line">â”œâ”€â”€ SAM\Domains\Account\Users\</span><br><span class="line">â”‚   â”œâ”€â”€ 000001F4 (Administrator)</span><br><span class="line">â”‚   â”œâ”€â”€ 000001F5 (Guest)</span><br><span class="line">â”‚   â””â”€â”€ [ç”¨æˆ·RID]</span><br><span class="line">â””â”€â”€ å¯†ç å“ˆå¸Œå­˜å‚¨åœ¨ç”¨æˆ·RIDå­é”®ä¸­</span><br></pre></td></tr></table></figure><h3 id="3-4-å¯†ç å­˜å‚¨æ ¼å¼"><a href="#3-4-å¯†ç å­˜å‚¨æ ¼å¼" class="headerlink" title="3.4 å¯†ç å­˜å‚¨æ ¼å¼"></a>3.4 å¯†ç å­˜å‚¨æ ¼å¼</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ç”¨æˆ·è®°å½•æ ¼å¼ï¼š</span><br><span class="line">Username: Administrator</span><br><span class="line">RID: 500</span><br><span class="line">LM Hash: aad3b435b51404eeaad3b435b51404ee (ç©ºå¯†ç )</span><br><span class="line">NTLM Hash: 31d6cfe0d16ae931b73c59d7e0c089c0</span><br></pre></td></tr></table></figure><h3 id="3-5-Windows-TPMé›†æˆä¸å®‰å…¨å¢å¼º"><a href="#3-5-Windows-TPMé›†æˆä¸å®‰å…¨å¢å¼º" class="headerlink" title="3.5 Windows TPMé›†æˆä¸å®‰å…¨å¢å¼º"></a>3.5 Windows TPMé›†æˆä¸å®‰å…¨å¢å¼º</h3><p><strong>Windowsç³»ç»Ÿç¡®å®å¹¿æ³›ä½¿ç”¨TPMï¼ˆå¯ä¿¡å¹³å°æ¨¡å—ï¼‰æ¥å¢å¼ºå¯†ç å®‰å…¨ï¼š</strong></p><h4 id="3-5-1-TPMåœ¨Windowsä¸­çš„ä½œç”¨"><a href="#3-5-1-TPMåœ¨Windowsä¸­çš„ä½œç”¨" class="headerlink" title="3.5.1 TPMåœ¨Windowsä¸­çš„ä½œç”¨"></a>3.5.1 TPMåœ¨Windowsä¸­çš„ä½œç”¨</h4><pre class="mermaid">graph TD    A["Windowså¯åŠ¨"] --> B["TPMåº¦é‡å¯åŠ¨é“¾"]    B --> C["BitLockerç£ç›˜åŠ å¯†"]    C --> D["Windows Helloè®¤è¯"]    D --> E["å‡­æ®ä¿æŠ¤"]    E --> F["è™šæ‹Ÿå®‰å…¨æ¨¡å¼VSM"]</pre><p><strong>TPMä¿æŠ¤çš„å…³é”®åŠŸèƒ½ï¼š</strong></p><ol><li><p><strong>BitLockerç£ç›˜åŠ å¯†</strong></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TPMä¿æŠ¤çš„BitLockerå¯†é’¥</span></span><br><span class="line">manage<span class="literal">-bde</span> <span class="literal">-protectors</span> <span class="literal">-get</span> C:</span><br><span class="line"><span class="comment"># è¾“å‡ºæ˜¾ç¤ºTPMä¿æŠ¤å™¨ä¿¡æ¯</span></span><br></pre></td></tr></table></figure></li><li><p><strong>Windows Hello</strong></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Windows Helloä½¿ç”¨TPMå­˜å‚¨ç”Ÿç‰©è¯†åˆ«æ¨¡æ¿</span></span><br><span class="line"><span class="comment"># å¯†é’¥å­˜å‚¨åœ¨TPMçš„å®‰å…¨å­˜å‚¨ä¸­</span></span><br></pre></td></tr></table></figure></li><li><p><strong>å‡­æ®é˜²æŠ¤ï¼ˆCredential Guardï¼‰</strong></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯ç”¨å‡­æ®é˜²æŠ¤</span></span><br><span class="line"><span class="built_in">Enable-WindowsOptionalFeature</span> <span class="literal">-Online</span> <span class="literal">-FeatureName</span> IsolatedUserMode</span><br></pre></td></tr></table></figure></li></ol><h4 id="3-5-2-TPMå¯†é’¥å°è£…æœºåˆ¶"><a href="#3-5-2-TPMå¯†é’¥å°è£…æœºåˆ¶" class="headerlink" title="3.5.2 TPMå¯†é’¥å°è£…æœºåˆ¶"></a>3.5.2 TPMå¯†é’¥å°è£…æœºåˆ¶</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TPMå¯†é’¥å°è£…ä¼ªä»£ç </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tpm_seal_password_key</span>(<span class="params">password_hash, pcr_values</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    å°†å¯†ç å“ˆå¸Œå¯†é’¥å°è£…åˆ°TPMä¸­</span></span><br><span class="line"><span class="string">    åªæœ‰åœ¨ç‰¹å®šPCRçŠ¶æ€ä¸‹æ‰èƒ½è§£å°</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    sealed_key = tpm2_create_sealed_object(</span><br><span class="line">        parent_handle=SRK_HANDLE,</span><br><span class="line">        data=password_hash,</span><br><span class="line">        auth_policy=pcr_policy(pcr_values)</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> sealed_key</span><br></pre></td></tr></table></figure><h3 id="3-6-Windowså¯†ç éªŒè¯æµç¨‹"><a href="#3-6-Windowså¯†ç éªŒè¯æµç¨‹" class="headerlink" title="3.6 Windowså¯†ç éªŒè¯æµç¨‹"></a>3.6 Windowså¯†ç éªŒè¯æµç¨‹</h3><pre class="mermaid">graph TD    A["ç”¨æˆ·è¾“å…¥å¯†ç "] --> B["è®¡ç®—NTLMå“ˆå¸Œ"]    B --> C["TPMéªŒè¯ç³»ç»Ÿå®Œæ•´æ€§"]    C --> D["ä»SAMæ•°æ®åº“è¯»å–å­˜å‚¨çš„å“ˆå¸Œ"]    D --> E["æ¯”è¾ƒå“ˆå¸Œå€¼"]    E --> F{å“ˆå¸ŒåŒ¹é…?}    F -->|æ˜¯| G["TPMè§£å°è®¿é—®ä»¤ç‰Œ"]    F -->|å¦| H["è®¤è¯å¤±è´¥"]    G --> I["ç”¨æˆ·ç™»å½•æˆåŠŸ"]</pre><h2 id="4-å¯†ç å“ˆå¸Œç®—æ³•æ·±åº¦åˆ†æï¼šä¸ºä»€ä¹ˆArgon2æ¯”SHA-512æ›´å®‰å…¨"><a href="#4-å¯†ç å“ˆå¸Œç®—æ³•æ·±åº¦åˆ†æï¼šä¸ºä»€ä¹ˆArgon2æ¯”SHA-512æ›´å®‰å…¨" class="headerlink" title="4. å¯†ç å“ˆå¸Œç®—æ³•æ·±åº¦åˆ†æï¼šä¸ºä»€ä¹ˆArgon2æ¯”SHA-512æ›´å®‰å…¨"></a>4. å¯†ç å“ˆå¸Œç®—æ³•æ·±åº¦åˆ†æï¼šä¸ºä»€ä¹ˆArgon2æ¯”SHA-512æ›´å®‰å…¨</h2><h3 id="4-1-ç®—æ³•ç±»å‹å¯¹æ¯”"><a href="#4-1-ç®—æ³•ç±»å‹å¯¹æ¯”" class="headerlink" title="4.1 ç®—æ³•ç±»å‹å¯¹æ¯”"></a>4.1 ç®—æ³•ç±»å‹å¯¹æ¯”</h3><h4 id="4-1-1-å¿«é€Ÿå“ˆå¸Œç®—æ³•çš„é—®é¢˜"><a href="#4-1-1-å¿«é€Ÿå“ˆå¸Œç®—æ³•çš„é—®é¢˜" class="headerlink" title="4.1.1 å¿«é€Ÿå“ˆå¸Œç®—æ³•çš„é—®é¢˜"></a>4.1.1 å¿«é€Ÿå“ˆå¸Œç®—æ³•çš„é—®é¢˜</h4><p><strong>SHA-512ç­‰ä¼ ç»Ÿå“ˆå¸Œç®—æ³•çš„ç‰¹ç‚¹ï¼š</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># SHA-512è®¡ç®—ç‰¹ç‚¹</span></span><br><span class="line">- è®¡ç®—é€Ÿåº¦æå¿«ï¼ˆæ¯ç§’æ•°åäº¿æ¬¡ï¼‰</span><br><span class="line">- å†…å­˜å ç”¨æå°‘ï¼ˆå‡ KBï¼‰</span><br><span class="line">- æ˜“äºå¹¶è¡Œè®¡ç®—</span><br><span class="line">- ä¸“ç”¨ç¡¬ä»¶åŠ é€Ÿï¼ˆGPUã€ASICï¼‰</span><br></pre></td></tr></table></figure><p><strong>è¿™äº›ç‰¹ç‚¹å¯¹å¯†ç å®‰å…¨çš„å½±å“ï¼š</strong></p><pre class="mermaid">graph TD    A["å¿«é€Ÿå“ˆå¸Œç®—æ³•"] --> B["æš´åŠ›ç ´è§£å®¹æ˜“"]    A --> C["å½©è™¹è¡¨æ”»å‡»æœ‰æ•ˆ"]    A --> D["GPUåŠ é€Ÿç ´è§£"]    A --> E["ASICä¸“ç”¨è®¾å¤‡ç ´è§£"]</pre><h4 id="4-1-2-Argon2çš„è®¾è®¡ä¼˜åŠ¿"><a href="#4-1-2-Argon2çš„è®¾è®¡ä¼˜åŠ¿" class="headerlink" title="4.1.2 Argon2çš„è®¾è®¡ä¼˜åŠ¿"></a>4.1.2 Argon2çš„è®¾è®¡ä¼˜åŠ¿</h4><p><strong>Argon2æ˜¯ä¸“é—¨ä¸ºå¯†ç å“ˆå¸Œè®¾è®¡çš„ç®—æ³•ï¼š</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Argon2ç®—æ³•å‚æ•°</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">argon2_hash</span>(<span class="params">password, salt, </span></span><br><span class="line"><span class="params">                time_cost=<span class="number">3</span>,      <span class="comment"># æ—¶é—´æˆæœ¬ï¼ˆè¿­ä»£æ¬¡æ•°ï¼‰</span></span></span><br><span class="line"><span class="params">                memory_cost=<span class="number">65536</span>, <span class="comment"># å†…å­˜æˆæœ¬ï¼ˆKBï¼‰</span></span></span><br><span class="line"><span class="params">                parallelism=<span class="number">4</span>,    <span class="comment"># å¹¶è¡Œåº¦</span></span></span><br><span class="line"><span class="params">                hash_length=<span class="number">32</span></span>):  <span class="comment"># è¾“å‡ºé•¿åº¦</span></span><br><span class="line">    <span class="keyword">return</span> argon2.<span class="built_in">hash</span>(password, salt, time_cost, memory_cost, parallelism, hash_length)</span><br></pre></td></tr></table></figure><h3 id="4-2-Argon2çš„ä¸‰é‡é˜²æŠ¤æœºåˆ¶"><a href="#4-2-Argon2çš„ä¸‰é‡é˜²æŠ¤æœºåˆ¶" class="headerlink" title="4.2 Argon2çš„ä¸‰é‡é˜²æŠ¤æœºåˆ¶"></a>4.2 Argon2çš„ä¸‰é‡é˜²æŠ¤æœºåˆ¶</h3><h4 id="4-2-1-å†…å­˜å›°éš¾æ€§ï¼ˆMemory-Hardï¼‰"><a href="#4-2-1-å†…å­˜å›°éš¾æ€§ï¼ˆMemory-Hardï¼‰" class="headerlink" title="4.2.1 å†…å­˜å›°éš¾æ€§ï¼ˆMemory-Hardï¼‰"></a>4.2.1 å†…å­˜å›°éš¾æ€§ï¼ˆMemory-Hardï¼‰</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Argon2å†…å­˜ä½¿ç”¨æ¨¡å¼</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">argon2_memory_pattern</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Argon2éœ€è¦å¤§é‡å†…å­˜æ¥å­˜å‚¨ä¸­é—´çŠ¶æ€</span></span><br><span class="line"><span class="string">    æ”»å‡»è€…å¿…é¡»ä¸ºæ¯ä¸ªå¯†ç å°è¯•åˆ†é…ç›¸åŒçš„å†…å­˜</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    memory_blocks = allocate_memory(memory_cost * <span class="number">1024</span>)  <span class="comment"># åˆ†é…å¤§é‡å†…å­˜</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># åœ¨å†…å­˜ä¸­è¿›è¡Œå¤æ‚çš„æ•°æ®ä¾èµ–æ“ä½œ</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(time_cost):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(memory_cost):</span><br><span class="line">            memory_blocks[j] = complex_operation(</span><br><span class="line">                memory_blocks[j], </span><br><span class="line">                memory_blocks[pseudo_random_index(j)]</span><br><span class="line">            )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> final_hash(memory_blocks)</span><br></pre></td></tr></table></figure><p><strong>å†…å­˜å›°éš¾æ€§çš„å®‰å…¨ä¼˜åŠ¿ï¼š</strong></p><ul><li>æ”»å‡»è€…æ— æ³•é€šè¿‡æ—¶é—´-å†…å­˜æƒè¡¡å‡å°‘æˆæœ¬</li><li>GPU&#x2F;ASICè®¾å¤‡çš„å†…å­˜é™åˆ¶é™ä½æ”»å‡»æ•ˆç‡</li><li>å¤§è§„æ¨¡å¹¶è¡Œæ”»å‡»å˜å¾—æå…¶æ˜‚è´µ</li></ul><h4 id="4-2-2-æ—¶é—´å¤æ‚åº¦æ§åˆ¶"><a href="#4-2-2-æ—¶é—´å¤æ‚åº¦æ§åˆ¶" class="headerlink" title="4.2.2 æ—¶é—´å¤æ‚åº¦æ§åˆ¶"></a>4.2.2 æ—¶é—´å¤æ‚åº¦æ§åˆ¶</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ—¶é—´æˆæœ¬å¯è°ƒèŠ‚</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">compare_time_costs</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    æ¯”è¾ƒä¸åŒæ—¶é—´æˆæœ¬çš„è®¡ç®—æ—¶é—´</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    passwords = [<span class="string">&quot;password123&quot;</span>, <span class="string">&quot;admin&quot;</span>, <span class="string">&quot;123456&quot;</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># SHA-512ï¼šå›ºå®šæ—¶é—´ï¼Œæå¿«</span></span><br><span class="line">    <span class="keyword">for</span> pwd <span class="keyword">in</span> passwords:</span><br><span class="line">        start = time.time()</span><br><span class="line">        sha512_hash = hashlib.sha512(pwd.encode()).hexdigest()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;SHA-512: <span class="subst">&#123;time.time() - start:<span class="number">.6</span>f&#125;</span>s&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Argon2ï¼šå¯è°ƒèŠ‚æ—¶é—´æˆæœ¬</span></span><br><span class="line">    <span class="keyword">for</span> time_cost <span class="keyword">in</span> [<span class="number">1</span>, <span class="number">3</span>, <span class="number">10</span>]:</span><br><span class="line">        start = time.time()</span><br><span class="line">        argon2_hash = argon2.hash_password_raw(</span><br><span class="line">            pwd.encode(), </span><br><span class="line">            salt=<span class="string">b&quot;somesalt&quot;</span>, </span><br><span class="line">            time_cost=time_cost,</span><br><span class="line">            memory_cost=<span class="number">65536</span>,</span><br><span class="line">            parallelism=<span class="number">1</span></span><br><span class="line">        )</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Argon2 (t=<span class="subst">&#123;time_cost&#125;</span>): <span class="subst">&#123;time.time() - start:<span class="number">.6</span>f&#125;</span>s&quot;</span>)</span><br></pre></td></tr></table></figure><h4 id="4-2-3-å¹¶è¡ŒåŒ–é˜»æŠ—"><a href="#4-2-3-å¹¶è¡ŒåŒ–é˜»æŠ—" class="headerlink" title="4.2.3 å¹¶è¡ŒåŒ–é˜»æŠ—"></a>4.2.3 å¹¶è¡ŒåŒ–é˜»æŠ—</h4><pre class="mermaid">graph TD    subgraph "SHA-512å¹¶è¡ŒåŒ–"        A1["å¯†ç 1"] --> B1["SHA-512"]        A2["å¯†ç 2"] --> B2["SHA-512"]        A3["å¯†ç 3"] --> B3["SHA-512"]        A4["å¯†ç 4"] --> B4["SHA-512"]    end        subgraph "Argon2å¹¶è¡ŒåŒ–é™åˆ¶"        C1["å¯†ç 1"] --> D1["å¤§é‡å†…å­˜"]        C2["å¯†ç 2"] --> D2["å¤§é‡å†…å­˜"]        C3["å¯†ç 3"] --> D3["å¤§é‡å†…å­˜"]        C4["å¯†ç 4"] --> D4["å¤§é‡å†…å­˜"]        D1 --> E1["å†…å­˜å¸¦å®½ç“¶é¢ˆ"]        D2 --> E2["å†…å­˜å¸¦å®½ç“¶é¢ˆ"]        D3 --> E3["å†…å­˜å¸¦å®½ç“¶é¢ˆ"]        D4 --> E4["å†…å­˜å¸¦å®½ç“¶é¢ˆ"]    end</pre><h3 id="4-3-ç®—æ³•å®‰å…¨æ€§é‡åŒ–å¯¹æ¯”"><a href="#4-3-ç®—æ³•å®‰å…¨æ€§é‡åŒ–å¯¹æ¯”" class="headerlink" title="4.3 ç®—æ³•å®‰å…¨æ€§é‡åŒ–å¯¹æ¯”"></a>4.3 ç®—æ³•å®‰å…¨æ€§é‡åŒ–å¯¹æ¯”</h3><h4 id="4-3-1-ç ´è§£æˆæœ¬åˆ†æ"><a href="#4-3-1-ç ´è§£æˆæœ¬åˆ†æ" class="headerlink" title="4.3.1 ç ´è§£æˆæœ¬åˆ†æ"></a>4.3.1 ç ´è§£æˆæœ¬åˆ†æ</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç ´è§£æˆæœ¬ä¼°ç®—</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">crack_cost_analysis</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ä¼°ç®—ä¸åŒç®—æ³•çš„ç ´è§£æˆæœ¬</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># SHA-512 + Saltç ´è§£æˆæœ¬</span></span><br><span class="line">    sha512_cost = &#123;</span><br><span class="line">        <span class="string">&quot;gpu_per_second&quot;</span>: <span class="number">10</span>**<span class="number">9</span>,  <span class="comment"># 10äº¿æ¬¡/ç§’</span></span><br><span class="line">        <span class="string">&quot;hardware_cost&quot;</span>: <span class="number">1000</span>,    <span class="comment"># GPUä»·æ ¼</span></span><br><span class="line">        <span class="string">&quot;power_cost&quot;</span>: <span class="number">0.1</span>,        <span class="comment"># ç”µåŠ›æˆæœ¬</span></span><br><span class="line">        <span class="string">&quot;time_to_crack_8char&quot;</span>: <span class="string">&quot;å‡ å°æ—¶&quot;</span>,</span><br><span class="line">        <span class="string">&quot;time_to_crack_12char&quot;</span>: <span class="string">&quot;å‡ å¹´&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Argon2ç ´è§£æˆæœ¬</span></span><br><span class="line">    argon2_cost = &#123;</span><br><span class="line">        <span class="string">&quot;memory_per_attempt&quot;</span>: <span class="number">64</span>,  <span class="comment"># 64MBå†…å­˜</span></span><br><span class="line">        <span class="string">&quot;attempts_per_second&quot;</span>: <span class="number">10</span>, <span class="comment"># å—å†…å­˜é™åˆ¶</span></span><br><span class="line">        <span class="string">&quot;hardware_cost&quot;</span>: <span class="number">50000</span>,    <span class="comment"># éœ€è¦å¤§é‡å†…å­˜</span></span><br><span class="line">        <span class="string">&quot;power_cost&quot;</span>: <span class="number">10</span>,          <span class="comment"># é«˜å†…å­˜åŠŸè€—</span></span><br><span class="line">        <span class="string">&quot;time_to_crack_8char&quot;</span>: <span class="string">&quot;å‡ å¹´&quot;</span>,</span><br><span class="line">        <span class="string">&quot;time_to_crack_12char&quot;</span>: <span class="string">&quot;å‡ åƒå¹´&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> sha512_cost, argon2_cost</span><br></pre></td></tr></table></figure><h4 id="4-3-2-å®é™…å®‰å…¨å»ºè®®"><a href="#4-3-2-å®é™…å®‰å…¨å»ºè®®" class="headerlink" title="4.3.2 å®é™…å®‰å…¨å»ºè®®"></a>4.3.2 å®é™…å®‰å…¨å»ºè®®</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸åŒåº”ç”¨åœºæ™¯çš„Argon2å‚æ•°å»ºè®®</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">argon2_parameters_recommendation</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    æ ¹æ®å®‰å…¨éœ€æ±‚æ¨èArgon2å‚æ•°</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    scenarios = &#123;</span><br><span class="line">        <span class="string">&quot;é«˜å®‰å…¨ç³»ç»Ÿ&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;time_cost&quot;</span>: <span class="number">10</span>,</span><br><span class="line">            <span class="string">&quot;memory_cost&quot;</span>: <span class="number">1024</span>*<span class="number">1024</span>,  <span class="comment"># 1GB</span></span><br><span class="line">            <span class="string">&quot;parallelism&quot;</span>: <span class="number">4</span>,</span><br><span class="line">            <span class="string">&quot;description&quot;</span>: <span class="string">&quot;é€‚ç”¨äºé«˜ä»·å€¼ç³»ç»Ÿï¼Œå¯å®¹å¿è¾ƒé•¿ç™»å½•æ—¶é—´&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;ä¼ä¸šåº”ç”¨&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;time_cost&quot;</span>: <span class="number">3</span>,</span><br><span class="line">            <span class="string">&quot;memory_cost&quot;</span>: <span class="number">65536</span>,      <span class="comment"># 64MB</span></span><br><span class="line">            <span class="string">&quot;parallelism&quot;</span>: <span class="number">4</span>,</span><br><span class="line">            <span class="string">&quot;description&quot;</span>: <span class="string">&quot;å¹³è¡¡å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒ&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;ç§»åŠ¨åº”ç”¨&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;time_cost&quot;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="string">&quot;memory_cost&quot;</span>: <span class="number">32768</span>,      <span class="comment"># 32MB</span></span><br><span class="line">            <span class="string">&quot;parallelism&quot;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="string">&quot;description&quot;</span>: <span class="string">&quot;è€ƒè™‘ç§»åŠ¨è®¾å¤‡èµ„æºé™åˆ¶&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> scenarios</span><br></pre></td></tr></table></figure><h2 id="5-ç£ç›˜æ”»å‡»ä¸é˜²æŠ¤æœºåˆ¶"><a href="#5-ç£ç›˜æ”»å‡»ä¸é˜²æŠ¤æœºåˆ¶" class="headerlink" title="5. ç£ç›˜æ”»å‡»ä¸é˜²æŠ¤æœºåˆ¶"></a>5. ç£ç›˜æ”»å‡»ä¸é˜²æŠ¤æœºåˆ¶</h2><h3 id="5-1-ç¦»çº¿æ”»å‡»çš„å¨èƒ"><a href="#5-1-ç¦»çº¿æ”»å‡»çš„å¨èƒ" class="headerlink" title="5.1 ç¦»çº¿æ”»å‡»çš„å¨èƒ"></a>5.1 ç¦»çº¿æ”»å‡»çš„å¨èƒ</h3><h4 id="5-1-1-ä¼ ç»Ÿç£ç›˜æ”»å‡»æ–¹æ³•"><a href="#5-1-1-ä¼ ç»Ÿç£ç›˜æ”»å‡»æ–¹æ³•" class="headerlink" title="5.1.1 ä¼ ç»Ÿç£ç›˜æ”»å‡»æ–¹æ³•"></a>5.1.1 ä¼ ç»Ÿç£ç›˜æ”»å‡»æ–¹æ³•</h4><p><strong>Linuxç³»ç»Ÿæ”»å‡»ç¤ºä¾‹ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ”»å‡»è€…è·å–ç‰©ç†è®¿é—®æƒé™åçš„æ“ä½œ</span></span><br><span class="line"><span class="comment"># 1. ä½¿ç”¨Live CDå¯åŠ¨ç³»ç»Ÿ</span></span><br><span class="line"><span class="comment"># 2. æŒ‚è½½ç›®æ ‡ç£ç›˜</span></span><br><span class="line"><span class="built_in">sudo</span> mount /dev/sda1 /mnt/target</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. å°è¯•ç›´æ¥ä¿®æ”¹shadowæ–‡ä»¶</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> /mnt/target/etc/shadow /mnt/target/etc/shadow.bak</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. ç”Ÿæˆå·²çŸ¥å¯†ç çš„å“ˆå¸Œ</span></span><br><span class="line">python3 -c <span class="string">&quot;</span></span><br><span class="line"><span class="string">import crypt</span></span><br><span class="line"><span class="string">import getpass</span></span><br><span class="line"><span class="string">password = &#x27;newpassword&#x27;</span></span><br><span class="line"><span class="string">salt = &#x27;$6$randomsalt$&#x27;</span></span><br><span class="line"><span class="string">hashed = crypt.crypt(password, salt)</span></span><br><span class="line"><span class="string">print(f&#x27;æ–°çš„å“ˆå¸Œå€¼: &#123;hashed&#125;&#x27;)</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. æ›¿æ¢rootç”¨æˆ·çš„å¯†ç å“ˆå¸Œ</span></span><br><span class="line"><span class="built_in">sudo</span> sed -i <span class="string">&#x27;s/root:[^:]*:/root:$6$randomsalt$newhash:/&#x27;</span> /mnt/target/etc/shadow</span><br></pre></td></tr></table></figure><p><strong>Windowsç³»ç»Ÿæ”»å‡»ç¤ºä¾‹ï¼š</strong></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨å·¥å…·å¦‚Ophcrackã€John the Ripperç­‰</span></span><br><span class="line"><span class="comment"># 1. æå–SAMæ–‡ä»¶</span></span><br><span class="line"><span class="comment"># 2. ä½¿ç”¨å½©è™¹è¡¨æˆ–æš´åŠ›ç ´è§£</span></span><br><span class="line"><span class="comment"># 3. æˆ–è€…ç›´æ¥æ›¿æ¢å¯†ç å“ˆå¸Œ</span></span><br></pre></td></tr></table></figure><h3 id="5-2-ç°ä»£é˜²æŠ¤æœºåˆ¶"><a href="#5-2-ç°ä»£é˜²æŠ¤æœºåˆ¶" class="headerlink" title="5.2 ç°ä»£é˜²æŠ¤æœºåˆ¶"></a>5.2 ç°ä»£é˜²æŠ¤æœºåˆ¶</h3><h4 id="5-2-1-å…¨ç£ç›˜åŠ å¯†é˜²æŠ¤"><a href="#5-2-1-å…¨ç£ç›˜åŠ å¯†é˜²æŠ¤" class="headerlink" title="5.2.1 å…¨ç£ç›˜åŠ å¯†é˜²æŠ¤"></a>5.2.1 å…¨ç£ç›˜åŠ å¯†é˜²æŠ¤</h4><p><strong>Linux LUKSåŠ å¯†ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºLUKSåŠ å¯†åˆ†åŒº</span></span><br><span class="line">cryptsetup luksFormat /dev/sda1</span><br><span class="line"></span><br><span class="line"><span class="comment"># å³ä½¿æ”»å‡»è€…è·å¾—ç‰©ç†è®¿é—®ï¼Œä¹Ÿæ— æ³•è¯»å–åŠ å¯†æ•°æ®</span></span><br><span class="line"><span class="comment"># éœ€è¦å¯†ç æ‰èƒ½è§£å¯†ç£ç›˜</span></span><br><span class="line">cryptsetup luksOpen /dev/sda1 encrypted_disk</span><br></pre></td></tr></table></figure><p><strong>Windows BitLockerï¼š</strong></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯ç”¨BitLocker with TPM</span></span><br><span class="line"><span class="built_in">Enable-BitLocker</span> <span class="literal">-MountPoint</span> C: <span class="literal">-TpmProtector</span></span><br></pre></td></tr></table></figure><p><strong>macOS FileVaultï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯ç”¨FileVault</span></span><br><span class="line"><span class="built_in">sudo</span> fdesetup <span class="built_in">enable</span></span><br></pre></td></tr></table></figure><h4 id="5-2-2-TPMé›†æˆé˜²æŠ¤"><a href="#5-2-2-TPMé›†æˆé˜²æŠ¤" class="headerlink" title="5.2.2 TPMé›†æˆé˜²æŠ¤"></a>5.2.2 TPMé›†æˆé˜²æŠ¤</h4><pre class="mermaid">graph TD    A["ç³»ç»Ÿå¯åŠ¨"] --> B["TPMåº¦é‡å¯åŠ¨é“¾"]    B --> C["éªŒè¯ç³»ç»Ÿå®Œæ•´æ€§"]    C --> D{å®Œæ•´æ€§æ£€æŸ¥}    D -->|é€šè¿‡| E["è§£å°åŠ å¯†å¯†é’¥"]    D -->|å¤±è´¥| F["æ‹’ç»è®¿é—®"]    E --> G["è§£å¯†ç£ç›˜"]    F --> H["ç³»ç»Ÿæ— æ³•å¯åŠ¨"]</pre><p><strong>TPMå¯†é’¥å°è£…é˜²æŠ¤ï¼š</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">tpm_sealed_key_protection</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    TPMå¯†é’¥å°è£…é˜²æŠ¤æœºåˆ¶</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 1. ç³»ç»Ÿå¯åŠ¨æ—¶åº¦é‡å…³é”®ç»„ä»¶</span></span><br><span class="line">    boot_measurements = measure_boot_components()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2. å°†åº¦é‡å€¼å­˜å‚¨åˆ°PCRå¯„å­˜å™¨</span></span><br><span class="line">    extend_pcr(boot_measurements)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 3. å¯†é’¥å°è£…æ—¶ç»‘å®šåˆ°ç‰¹å®šPCRçŠ¶æ€</span></span><br><span class="line">    sealed_key = tpm_seal(</span><br><span class="line">        data=disk_encryption_key,</span><br><span class="line">        pcr_selection=[<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>]  <span class="comment"># ç»‘å®šåˆ°å¤šä¸ªPCR</span></span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 4. åªæœ‰åœ¨ç›¸åŒPCRçŠ¶æ€ä¸‹æ‰èƒ½è§£å°</span></span><br><span class="line">    <span class="keyword">if</span> current_pcr_values == sealed_pcr_values:</span><br><span class="line">        disk_key = tpm_unseal(sealed_key)</span><br><span class="line">        <span class="keyword">return</span> disk_key</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> SecurityError(<span class="string">&quot;ç³»ç»Ÿå®Œæ•´æ€§éªŒè¯å¤±è´¥&quot;</span>)</span><br></pre></td></tr></table></figure><h4 id="5-2-3-å®‰å…¨å¯åŠ¨é“¾"><a href="#5-2-3-å®‰å…¨å¯åŠ¨é“¾" class="headerlink" title="5.2.3 å®‰å…¨å¯åŠ¨é“¾"></a>5.2.3 å®‰å…¨å¯åŠ¨é“¾</h4><pre class="mermaid">graph TD    A["UEFIå›ºä»¶"] --> B["éªŒè¯Bootloaderç­¾å"]    B --> C["éªŒè¯å†…æ ¸ç­¾å"]    C --> D["éªŒè¯é©±åŠ¨ç­¾å"]    D --> E["éªŒè¯åº”ç”¨ç¨‹åºç­¾å"]    E --> F["å®Œæ•´çš„ä¿¡ä»»é“¾"]        subgraph "æ¯ä¸ªé˜¶æ®µ"        G["åº¦é‡ç»„ä»¶"]        H["æ‰©å±•PCR"]        I["éªŒè¯ç­¾å"]        J["è®°å½•æ—¥å¿—"]    end</pre><h3 id="5-3-é«˜çº§é˜²æŠ¤ç­–ç•¥"><a href="#5-3-é«˜çº§é˜²æŠ¤ç­–ç•¥" class="headerlink" title="5.3 é«˜çº§é˜²æŠ¤ç­–ç•¥"></a>5.3 é«˜çº§é˜²æŠ¤ç­–ç•¥</h3><h4 id="5-3-1-å¤šå› ç´ å¯†é’¥æ´¾ç”Ÿ"><a href="#5-3-1-å¤šå› ç´ å¯†é’¥æ´¾ç”Ÿ" class="headerlink" title="5.3.1 å¤šå› ç´ å¯†é’¥æ´¾ç”Ÿ"></a>5.3.1 å¤šå› ç´ å¯†é’¥æ´¾ç”Ÿ</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">advanced_key_derivation</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ç»“åˆå¤šç§å› ç´ çš„å¯†é’¥æ´¾ç”Ÿ</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 1. ç”¨æˆ·å¯†ç </span></span><br><span class="line">    user_password = <span class="built_in">input</span>(<span class="string">&quot;è¯·è¾“å…¥å¯†ç : &quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2. TPMå¯†é’¥</span></span><br><span class="line">    tpm_key = tpm_get_random(<span class="number">32</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 3. ç¡¬ä»¶æŒ‡çº¹</span></span><br><span class="line">    hardware_fingerprint = get_hardware_id()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 4. æ—¶é—´å› å­ï¼ˆå¯é€‰ï¼‰</span></span><br><span class="line">    time_factor = <span class="built_in">int</span>(time.time() / <span class="number">3600</span>)  <span class="comment"># å°æ—¶çº§åˆ«</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 5. ç»„åˆæ‰€æœ‰å› å­</span></span><br><span class="line">    combined_input = (</span><br><span class="line">        user_password.encode() + </span><br><span class="line">        tpm_key + </span><br><span class="line">        hardware_fingerprint + </span><br><span class="line">        time_factor.to_bytes(<span class="number">8</span>, <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 6. ä½¿ç”¨Argon2æ´¾ç”Ÿæœ€ç»ˆå¯†é’¥</span></span><br><span class="line">    final_key = argon2.hash_password_raw(</span><br><span class="line">        combined_input,</span><br><span class="line">        salt=<span class="string">b&quot;system_salt&quot;</span>,</span><br><span class="line">        time_cost=<span class="number">3</span>,</span><br><span class="line">        memory_cost=<span class="number">65536</span>,</span><br><span class="line">        parallelism=<span class="number">4</span></span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> final_key</span><br></pre></td></tr></table></figure><h4 id="5-3-2-è¿œç¨‹è®¤è¯æœºåˆ¶"><a href="#5-3-2-è¿œç¨‹è®¤è¯æœºåˆ¶" class="headerlink" title="5.3.2 è¿œç¨‹è®¤è¯æœºåˆ¶"></a>5.3.2 è¿œç¨‹è®¤è¯æœºåˆ¶</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">remote_attestation</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    è¿œç¨‹è®¤è¯ç¡®ä¿ç³»ç»Ÿå®Œæ•´æ€§</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 1. è·å–å½“å‰PCRå€¼</span></span><br><span class="line">    current_pcrs = tpm_read_pcrs()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2. ç”Ÿæˆè®¤è¯æŠ¥å‘Š</span></span><br><span class="line">    attestation_report = tpm_quote(</span><br><span class="line">        pcr_selection=<span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">24</span>)),</span><br><span class="line">        nonce=server_nonce</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 3. å‘é€åˆ°è¿œç¨‹æœåŠ¡å™¨éªŒè¯</span></span><br><span class="line">    response = requests.post(</span><br><span class="line">        <span class="string">&quot;https://attestation-server.com/verify&quot;</span>,</span><br><span class="line">        json=&#123;</span><br><span class="line">            <span class="string">&quot;pcr_values&quot;</span>: current_pcrs,</span><br><span class="line">            <span class="string">&quot;quote&quot;</span>: attestation_report,</span><br><span class="line">            <span class="string">&quot;certificate_chain&quot;</span>: tpm_cert_chain</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 4. æ ¹æ®éªŒè¯ç»“æœå†³å®šæ˜¯å¦æˆæƒ</span></span><br><span class="line">    <span class="keyword">if</span> response.json()[<span class="string">&quot;trusted&quot;</span>]:</span><br><span class="line">        <span class="keyword">return</span> grant_access()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> deny_access(<span class="string">&quot;ç³»ç»Ÿå®Œæ•´æ€§éªŒè¯å¤±è´¥&quot;</span>)</span><br></pre></td></tr></table></figure><h2 id="6-ç³»ç»Ÿå®‰å…¨é˜²æŠ¤æœºåˆ¶å¯¹æ¯”"><a href="#6-ç³»ç»Ÿå®‰å…¨é˜²æŠ¤æœºåˆ¶å¯¹æ¯”" class="headerlink" title="6. ç³»ç»Ÿå®‰å…¨é˜²æŠ¤æœºåˆ¶å¯¹æ¯”"></a>6. ç³»ç»Ÿå®‰å…¨é˜²æŠ¤æœºåˆ¶å¯¹æ¯”</h2><h3 id="6-1-æ–‡ä»¶æƒé™ä¿æŠ¤"><a href="#6-1-æ–‡ä»¶æƒé™ä¿æŠ¤" class="headerlink" title="6.1 æ–‡ä»¶æƒé™ä¿æŠ¤"></a>6.1 æ–‡ä»¶æƒé™ä¿æŠ¤</h3><table><thead><tr><th>ç³»ç»Ÿ</th><th>å¯†ç æ–‡ä»¶</th><th>æƒé™è®¾ç½®</th><th>è®¿é—®æ§åˆ¶</th><th>TPMé›†æˆ</th></tr></thead><tbody><tr><td>Linux</td><td>&#x2F;etc&#x2F;shadow</td><td>600 (rwâ€”â€”-)</td><td>ä»…rootå¯è¯»å†™</td><td>å¯é€‰é›†æˆ</td></tr><tr><td>macOS</td><td>.plistæ–‡ä»¶</td><td>600</td><td>ç³»ç»Ÿä¿æŠ¤ + SIP</td><td>T2&#x2F;M1èŠ¯ç‰‡</td></tr><tr><td>Windows</td><td>SAMæ–‡ä»¶</td><td>ç³»ç»Ÿç‹¬å </td><td>è¿è¡Œæ—¶é”å®š</td><td>æ·±åº¦é›†æˆ</td></tr></tbody></table><h3 id="6-2-åŠ å¯†ç®—æ³•å¼ºåº¦"><a href="#6-2-åŠ å¯†ç®—æ³•å¼ºåº¦" class="headerlink" title="6.2 åŠ å¯†ç®—æ³•å¼ºåº¦"></a>6.2 åŠ å¯†ç®—æ³•å¼ºåº¦</h3><pre class="mermaid">graph LR    A["MD5/MD4"] --> B["SHA-1"]    B --> C["SHA-256"]    C --> D["SHA-512"]    D --> E["PBKDF2"]    E --> F["Argon2"]        A --> G["ä¸å®‰å…¨"]    B --> H["å¼±å®‰å…¨"]    C --> I["ä¸­ç­‰å®‰å…¨"]    D --> J["é«˜å®‰å…¨"]    E --> K["é«˜å®‰å…¨"]    F --> L["æœ€é«˜å®‰å…¨"]        style F fill:#90EE90    style L fill:#90EE90</pre><h3 id="6-3-ç›å€¼-Salt-ä½¿ç”¨"><a href="#6-3-ç›å€¼-Salt-ä½¿ç”¨" class="headerlink" title="6.3 ç›å€¼(Salt)ä½¿ç”¨"></a>6.3 ç›å€¼(Salt)ä½¿ç”¨</h3><p><strong>Linux:</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ¯ä¸ªå¯†ç ä½¿ç”¨éšæœºç›å€¼</span></span><br><span class="line">$6$randomsalt<span class="variable">$hashedpassword</span></span><br></pre></td></tr></table></figure><p><strong>macOS:</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># PBKDF2ä½¿ç”¨éšæœºç›å€¼å’Œé«˜è¿­ä»£æ¬¡æ•°</span></span><br><span class="line">PBKDF2(password, salt, 10000+ iterations)</span><br></pre></td></tr></table></figure><p><strong>Windows:</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># NTLMä¸ä½¿ç”¨ç›å€¼ï¼ˆå®‰å…¨ç¼ºé™·ï¼‰</span></span><br><span class="line">MD4(UTF16LE(password))</span><br></pre></td></tr></table></figure><h2 id="7-å¯†ç ç ´è§£é˜²æŠ¤æªæ–½"><a href="#7-å¯†ç ç ´è§£é˜²æŠ¤æªæ–½" class="headerlink" title="7. å¯†ç ç ´è§£é˜²æŠ¤æªæ–½"></a>7. å¯†ç ç ´è§£é˜²æŠ¤æªæ–½</h2><h3 id="7-1-æŠ€æœ¯é˜²æŠ¤"><a href="#7-1-æŠ€æœ¯é˜²æŠ¤" class="headerlink" title="7.1 æŠ€æœ¯é˜²æŠ¤"></a>7.1 æŠ€æœ¯é˜²æŠ¤</h3><p><strong>1. å¯†ç å¤æ‚åº¦è¦æ±‚ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Linux PAMé…ç½®ç¤ºä¾‹</span></span><br><span class="line">password requisite pam_pwquality.so retry=3 minlen=8 difok=3</span><br></pre></td></tr></table></figure><p><strong>2. è´¦æˆ·é”å®šæœºåˆ¶ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¤±è´¥å°è¯•æ¬¡æ•°é™åˆ¶</span></span><br><span class="line">auth required pam_faillock.so deny=5 unlock_time=900</span><br></pre></td></tr></table></figure><p><strong>3. å¯†ç å†å²è®°å½•ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é˜²æ­¢é‡å¤ä½¿ç”¨æœ€è¿‘çš„å¯†ç </span></span><br><span class="line">password sufficient pam_unix.so remember=5</span><br></pre></td></tr></table></figure><h3 id="7-2-ç°ä»£å®‰å…¨å¢å¼º"><a href="#7-2-ç°ä»£å®‰å…¨å¢å¼º" class="headerlink" title="7.2 ç°ä»£å®‰å…¨å¢å¼º"></a>7.2 ç°ä»£å®‰å…¨å¢å¼º</h3><p><strong>å¤šå› ç´ è®¤è¯ï¼ˆMFAï¼‰ï¼š</strong></p><pre class="mermaid">graph TD    A["ç”¨æˆ·åå¯†ç "] --> B["çŸ­ä¿¡éªŒè¯ç "]    B --> C["ç”Ÿç‰©è¯†åˆ«"]    C --> D["ç¡¬ä»¶ä»¤ç‰Œ"]    D --> E["è®¿é—®æˆæƒ"]</pre><p><strong>æ— å¯†ç è®¤è¯ï¼š</strong></p><ul><li>Windows Hello</li><li>Touch ID &#x2F; Face ID</li><li>FIDO2ç¡¬ä»¶å¯†é’¥</li></ul><h2 id="8-å®é™…å®‰å…¨å»ºè®®"><a href="#8-å®é™…å®‰å…¨å»ºè®®" class="headerlink" title="8. å®é™…å®‰å…¨å»ºè®®"></a>8. å®é™…å®‰å…¨å»ºè®®</h2><h3 id="8-1-ç³»ç»Ÿç®¡ç†å‘˜å»ºè®®"><a href="#8-1-ç³»ç»Ÿç®¡ç†å‘˜å»ºè®®" class="headerlink" title="8.1 ç³»ç»Ÿç®¡ç†å‘˜å»ºè®®"></a>8.1 ç³»ç»Ÿç®¡ç†å‘˜å»ºè®®</h3><p><strong>Linuxç³»ç»Ÿï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. å‡çº§åˆ°Argon2å“ˆå¸Œç®—æ³•</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get install libpam-pwquality</span><br><span class="line"><span class="comment"># é…ç½®/etc/pam.d/common-passwordä½¿ç”¨Argon2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. å¯ç”¨å…¨ç£ç›˜åŠ å¯†</span></span><br><span class="line">cryptsetup luksFormat /dev/sda1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. é…ç½®TPMï¼ˆå¦‚æœå¯ç”¨ï¼‰</span></span><br><span class="line">tpm2-tools installation and configuration</span><br></pre></td></tr></table></figure><p><strong>macOSç³»ç»Ÿï¼š</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. å¯ç”¨FileVault</span></span><br><span class="line"><span class="built_in">sudo</span> fdesetup <span class="built_in">enable</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. é…ç½®å¯†ç ç­–ç•¥</span></span><br><span class="line"><span class="built_in">sudo</span> pwpolicy -setglobalpolicy <span class="string">&quot;minChars=8 requiresAlpha=1 requiresNumeric=1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. å¯ç”¨é˜²ç«å¢™</span></span><br><span class="line"><span class="built_in">sudo</span> /usr/libexec/ApplicationFirewall/socketfilterfw --setglobalstate on</span><br></pre></td></tr></table></figure><p><strong>Windowsç³»ç»Ÿï¼š</strong></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. å¯ç”¨BitLocker with TPM</span></span><br><span class="line"><span class="built_in">Enable-BitLocker</span> <span class="literal">-MountPoint</span> C: <span class="literal">-TpmProtector</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. é…ç½®å¯†ç ç­–ç•¥</span></span><br><span class="line">net accounts /minpwlen:<span class="number">8</span> /maxpwage:<span class="number">90</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. å¯ç”¨å‡­æ®é˜²æŠ¤</span></span><br><span class="line"><span class="built_in">Enable-WindowsOptionalFeature</span> <span class="literal">-Online</span> <span class="literal">-FeatureName</span> IsolatedUserMode</span><br></pre></td></tr></table></figure><h3 id="8-2-ç”¨æˆ·å®‰å…¨å®è·µ"><a href="#8-2-ç”¨æˆ·å®‰å…¨å®è·µ" class="headerlink" title="8.2 ç”¨æˆ·å®‰å…¨å®è·µ"></a>8.2 ç”¨æˆ·å®‰å…¨å®è·µ</h3><ol><li><strong>ä½¿ç”¨å¼ºå¯†ç </strong>ï¼šè‡³å°‘12ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦</li><li><strong>å¯ç”¨å¤šå› ç´ è®¤è¯</strong>ï¼šåœ¨æ‰€æœ‰æ”¯æŒçš„ç³»ç»Ÿå’Œåº”ç”¨ä¸­å¯ç”¨MFA</li><li><strong>å®šæœŸæ›´æ–°å¯†ç </strong>ï¼šå®šæœŸæ›´æ¢é‡è¦è´¦æˆ·å¯†ç </li><li><strong>ä½¿ç”¨å¯†ç ç®¡ç†å™¨</strong>ï¼šé¿å…é‡å¤ä½¿ç”¨å¯†ç </li><li><strong>ä¿æŒç³»ç»Ÿæ›´æ–°</strong>ï¼šåŠæ—¶å®‰è£…å®‰å…¨è¡¥ä¸</li><li><strong>å¯ç”¨å…¨ç£ç›˜åŠ å¯†</strong>ï¼šé˜²æ­¢ç‰©ç†è®¿é—®æ”»å‡»</li><li><strong>å¯ç”¨TPMåŠŸèƒ½</strong>ï¼šåˆ©ç”¨ç¡¬ä»¶å®‰å…¨æ¨¡å—å¢å¼ºä¿æŠ¤</li></ol><h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><p>ä¸åŒæ“ä½œç³»ç»Ÿé‡‡ç”¨äº†å„è‡ªç‹¬ç‰¹çš„å¯†ç å­˜å‚¨å’Œç®¡ç†æœºåˆ¶ï¼š</p><ul><li><strong>Linux</strong> ä½¿ç”¨Shadowç³»ç»Ÿå’Œå¼ºå¤§çš„å“ˆå¸Œç®—æ³•ï¼ˆæ¨èå‡çº§åˆ°Argon2ï¼‰ï¼Œæä¾›äº†è‰¯å¥½çš„å®‰å…¨æ€§</li><li><strong>macOS</strong> é‡‡ç”¨PBKDF2å’ŒKeychainæœåŠ¡ï¼Œé›†æˆT2&#x2F;M1å®‰å…¨èŠ¯ç‰‡ï¼Œå®‰å…¨æ€§å¾ˆé«˜</li><li><strong>Windows</strong> é€šè¿‡TPMæ·±åº¦é›†æˆå’ŒBitLockerç­‰ç°ä»£å®‰å…¨åŠŸèƒ½ï¼Œå¤§å¹…å¢å¼ºäº†å®‰å…¨æ€§</li></ul><p><strong>å…³é”®å®‰å…¨è¦ç‚¹ï¼š</strong></p><ol><li><strong>Argon2ä¼˜äºä¼ ç»Ÿå“ˆå¸Œç®—æ³•</strong>ï¼šå†…å­˜å›°éš¾ã€æ—¶é—´å¯è°ƒã€å¹¶è¡Œé˜»æŠ—</li><li><strong>TPMç¡¬ä»¶å®‰å…¨æ¨¡å—</strong>ï¼šæä¾›ç¡¬ä»¶çº§å¯†é’¥ä¿æŠ¤å’Œç³»ç»Ÿå®Œæ•´æ€§éªŒè¯</li><li><strong>å…¨ç£ç›˜åŠ å¯†</strong>ï¼šé˜²æ­¢ç‰©ç†è®¿é—®æ”»å‡»çš„æœ€é‡è¦é˜²æŠ¤æªæ–½</li><li><strong>å¤šå±‚é˜²æŠ¤</strong>ï¼šç»“åˆå¯†ç ç­–ç•¥ã€MFAã€ç”Ÿç‰©è¯†åˆ«ç­‰å¤šç§å®‰å…¨æ‰‹æ®µ</li></ol><p>äº†è§£è¿™äº›æœºåˆ¶æœ‰åŠ©äºç³»ç»Ÿç®¡ç†å‘˜å’Œå®‰å…¨ä¸“ä¸šäººå‘˜æ›´å¥½åœ°é…ç½®å’Œä¿æŠ¤ç³»ç»Ÿå®‰å…¨ã€‚éšç€æŠ€æœ¯å‘å±•ï¼Œæ— å¯†ç è®¤è¯å’Œç”Ÿç‰©è¯†åˆ«ç­‰æ–°æŠ€æœ¯æ­£åœ¨é€æ­¥å–ä»£ä¼ ç»Ÿçš„å¯†ç è®¤è¯æ–¹å¼ï¼Œä¸ºç³»ç»Ÿå®‰å…¨æä¾›æ›´å¼ºçš„ä¿éšœã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ol><li><a href="https://linux-pam.org/Linux-PAM-html/">Linux PAM Documentation</a></li><li><a href="https://developer.apple.com/library/archive/documentation/Security/Conceptual/Security_Overview/">macOS Security Guide</a></li><li><a href="https://docs.microsoft.com/en-us/windows/security/">Windows Security Technical Reference</a></li><li><a href="https://pages.nist.gov/800-63-3/">NIST Password Guidelines</a></li><li><a href="https://tools.ietf.org/html/draft-irtf-cfrg-argon2-13">Argon2 Specification</a></li><li><a href="https://trustedcomputinggroup.org/resource/tpm-library-specification/">TPM 2.0 Library Specification</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¯†ç å­˜å‚¨ </tag>
            
            <tag> ç³»ç»Ÿå®‰å…¨ </tag>
            
            <tag> å“ˆå¸Œç®—æ³• </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…³äºéšç§é›†åˆæ±‚äº¤ (PSI) çš„è®¤è¯†</title>
      <link href="/2025/06/19/%E9%9A%90%E7%A7%81%E6%B1%82%E4%BA%A4%E7%9A%84%E5%AD%A6%E4%B9%A0%E6%80%9D%E8%80%83/"/>
      <url>/2025/06/19/%E9%9A%90%E7%A7%81%E6%B1%82%E4%BA%A4%E7%9A%84%E5%AD%A6%E4%B9%A0%E6%80%9D%E8%80%83/</url>
      
        <content type="html"><![CDATA[<h1 id="å…³äºéšç§é›†åˆæ±‚äº¤-PSI-çš„è®¤è¯†"><a href="#å…³äºéšç§é›†åˆæ±‚äº¤-PSI-çš„è®¤è¯†" class="headerlink" title="å…³äºéšç§é›†åˆæ±‚äº¤ (PSI) çš„è®¤è¯†"></a>å…³äºéšç§é›†åˆæ±‚äº¤ (PSI) çš„è®¤è¯†</h1><p>éšç§é›†åˆæ±‚äº¤ï¼ˆPrivate Set Intersection, PSIï¼‰æ˜¯å¯†ç å­¦å’Œæ•°æ®å·¥ç¨‹äº¤å‰é¢†åŸŸä¸­çš„ä¸€ä¸ªç»å…¸é—®é¢˜ï¼š<strong>ä¸¤ä¸ªæˆ–å¤šä¸ªå‚ä¸æ–¹ï¼Œå¦‚ä½•åœ¨ä¸æ³„éœ²å„è‡ªç§æœ‰æ•°æ®çš„å‰æä¸‹ï¼Œè®¡ç®—å‡ºä»–ä»¬æ•°æ®é›†çš„äº¤é›†ï¼Ÿ</strong></p><p>è¿™ä¸ªéœ€æ±‚åœ¨ç°å®ä¸–ç•Œä¸­éå¸¸æ™®éï¼Œä¾‹å¦‚ï¼š</p><ul><li><strong>å¹¿å‘Šå½’å› </strong>ï¼šå¹¿å‘Šå¹³å°å’Œå¹¿å‘Šä¸»éœ€è¦çŸ¥é“å“ªäº›è§‚çœ‹äº†å¹¿å‘Šçš„ç”¨æˆ·æœ€ç»ˆå®Œæˆäº†è´­ä¹°ï¼Œä½†åŒæ–¹éƒ½ä¸æƒ³ç›´æ¥æš´éœ²è‡ªå·±çš„å…¨éƒ¨ç”¨æˆ·åˆ—è¡¨ã€‚</li><li><strong>è”ç³»äººå‘ç°</strong>ï¼šæ‰‹æœºåº”ç”¨æƒ³çŸ¥é“ä½ çš„é€šè®¯å½•é‡Œæœ‰å“ªäº›äººä¹Ÿæ³¨å†Œäº†è¯¥åº”ç”¨ï¼Œä½†ä½ ä¸æƒ³ä¸Šä¼ æ•´ä¸ªé€šè®¯å½•ã€‚</li><li><strong>å®‰å…¨æƒ…æŠ¥å…±äº«</strong>ï¼šå¤šä¸ªæƒ…æŠ¥æœºæ„å¸Œæœ›æ‰¾å‡ºå…±åŒçš„å«Œç–‘äººåå•ï¼Œä½†å„è‡ªçš„åå•éƒ½æ˜¯é«˜åº¦æœºå¯†çš„ã€‚</li></ul><p>æœ¬æ–‡å°†æ¢³ç†å‡ ç§ä¸»æµçš„ PSI å®ç°æ–¹æ¡ˆï¼Œåˆ†æå®ƒä»¬çš„è®¾è®¡æ€è·¯ã€æ€§èƒ½ã€å®‰å…¨æ€§ï¼Œä»¥åŠå„è‡ªçš„é€‚ç”¨åœºæ™¯ã€‚</p><hr><h2 id="æ ¸å¿ƒå¯†ç å­¦æ¦‚å¿µï¼šå®‰å…¨æ¨¡å‹"><a href="#æ ¸å¿ƒå¯†ç å­¦æ¦‚å¿µï¼šå®‰å…¨æ¨¡å‹" class="headerlink" title="æ ¸å¿ƒå¯†ç å­¦æ¦‚å¿µï¼šå®‰å…¨æ¨¡å‹"></a>æ ¸å¿ƒå¯†ç å­¦æ¦‚å¿µï¼šå®‰å…¨æ¨¡å‹</h2><p>åœ¨æ·±å…¥äº†è§£å„ç§ PSI åè®®ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»å…ˆç†è§£è¯„ä¼°å…¶å®‰å…¨æ€§çš„ä¸¤ä¸ªåŸºæœ¬æ¨¡å‹ã€‚è¿™å†³å®šäº†ä¸€ä¸ªåè®®èƒ½æŠµå¾¡ä»€ä¹ˆæ ·çš„æ”»å‡»è€…ã€‚</p><ul><li><p><strong>åŠè¯šå®æ¨¡å‹ (Semi-Honest &#x2F; Honest-but-Curious)</strong></p><ul><li><strong>å®šä¹‰</strong>ï¼šè¿™æ˜¯å¯†ç å­¦åè®®ä¸­æœ€å¸¸è§çš„å¨èƒæ¨¡å‹ã€‚åœ¨æ­¤æ¨¡å‹ä¸­ï¼Œå‚ä¸æ–¹ä¼š<strong>å®Œå…¨éµå®ˆ</strong>åè®®çš„æ¯ä¸€æ­¥æŒ‡ä»¤ï¼Œå¦‚åŒä¸€ä¸ªè¯šå®çš„å­¦ç”Ÿã€‚ä½†æ˜¯ï¼Œä»–ä»¬ä¼šä¿ç•™åè®®æ‰§è¡Œè¿‡ç¨‹ä¸­æ”¶åˆ°çš„æ‰€æœ‰ä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼Œä¸­é—´è®¡ç®—ç»“æœï¼‰ï¼Œå¹¶è¯•å›¾åœ¨åè®®ç»“æŸåï¼Œé€šè¿‡åˆ†æè¿™äº›ä¿¡æ¯æ¥æ¨æ–­å‡ºè¶…å‡ºåè®®è§„å®šæ³„éœ²èŒƒå›´çš„ã€å¯¹æ–¹çš„é¢å¤–éšç§ã€‚</li><li><strong>ç±»æ¯”</strong>ï¼šä¸€ä¸ªâ€œå¥½å¥‡çš„â€åˆä½œä¼™ä¼´ã€‚ä»–ä¼šæŒ‰åˆåŒåŠäº‹ï¼Œä½†ä¼šè¯•å›¾ä»ä½ ç»™ä»–çš„æ–‡ä»¶ä¸­åˆ†æå‡ºä½ çš„å•†ä¸šç§˜å¯†ã€‚</li><li><strong>æ„ä¹‰</strong>ï¼šç»å¤§å¤šæ•°é«˜æ€§èƒ½çš„ PSI åè®®ï¼ˆå¦‚ OT-PSIï¼‰éƒ½æ˜¯åœ¨åŠè¯šå®æ¨¡å‹ä¸‹è¢«è¯æ˜å®‰å…¨çš„ã€‚è¿™æ„å‘³ç€ï¼Œåªè¦å¤§å®¶éƒ½éµå®ˆè§„åˆ™ï¼Œå°±ä¸å¯èƒ½æ³„éœ²äº¤é›†ä¹‹å¤–çš„ä»»ä½•ä¿¡æ¯ã€‚</li></ul></li><li><p><strong>æ¶æ„æ¨¡å‹ (Malicious)</strong></p><ul><li><strong>å®šä¹‰</strong>ï¼šè¿™æ˜¯ä¸€ä¸ªæ›´å¼ºå¤§ã€æ›´ç¬¦åˆç°å®ä¸–ç•ŒæŸäº›åœºæ™¯çš„å¨èƒæ¨¡å‹ã€‚æ¶æ„æ”»å‡»è€…<strong>ä¸éµå®ˆ</strong>åè®®ï¼Œä»–ä»¬å¯ä»¥é‡‡å–ä»»ä½•è¡ŒåŠ¨æ¥ç ´ååè®®æˆ–çªƒå–ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼šå‘é€ä¼ªé€ çš„æ•°æ®ã€æå‰ä¸­æ­¢åè®®ã€æˆ–è€…æ ¹æ®è‡ªå·±çš„è¾“å…¥æ¥æ”¹å˜åè®®æµç¨‹ã€‚</li><li><strong>ç±»æ¯”</strong>ï¼šä¸€ä¸ªâ€œä¸æ‹©æ‰‹æ®µçš„â€å•†ä¸šé—´è°ã€‚ä»–ä¸ä»…æƒ³åˆ†ææ–‡ä»¶ï¼Œè¿˜å¯èƒ½ä¼ªé€ æ–‡ä»¶ã€è´¿èµ‚ä½ çš„å‘˜å·¥ï¼Œä»¥è¾¾åˆ°ç›®çš„ã€‚</li><li><strong>æ„ä¹‰</strong>ï¼šé˜²å¾¡æ¶æ„æ”»å‡»è€…éœ€è¦å¼•å…¥æ›´å¤æ‚çš„å¯†ç å­¦å·¥å…·ï¼Œå¦‚**é›¶çŸ¥è¯†è¯æ˜ (Zero-Knowledge Proofs)**ï¼Œæ¥å¼ºåˆ¶éªŒè¯æ¯ä¸€æ­¥çš„æ­£ç¡®æ€§ã€‚è¿™é€šå¸¸ä¼šå¯¼è‡´åè®®æ€§èƒ½å¤§å¹…ä¸‹é™ã€‚å› æ­¤ï¼Œæ¶æ„å®‰å…¨çš„ PSI åè®®é€šå¸¸ç”¨åœ¨é‡‘èã€æ”¿åºœç­‰é«˜é£é™©é¢†åŸŸã€‚</li></ul></li></ul><p><strong>ç»“è®º</strong>ï¼šåœ¨é€‰æ‹© PSI æ–¹æ¡ˆæ—¶ï¼Œé¦–å…ˆè¦è¯„ä¼°ä½ çš„å®‰å…¨éœ€æ±‚ã€‚å¯¹äºå¤§å¤šæ•°å•†ä¸šåˆä½œåœºæ™¯ï¼ŒåŠè¯šå®æ¨¡å‹ä¸‹çš„å®‰å…¨é€šå¸¸å·²ç»è¶³å¤Ÿã€‚</p><hr><h2 id="æ–¹æ¡ˆä¸€ï¼šåŸºç¡€å“ˆå¸Œæ–¹æ¡ˆ-ç®€å•ä½†è„†å¼±"><a href="#æ–¹æ¡ˆä¸€ï¼šåŸºç¡€å“ˆå¸Œæ–¹æ¡ˆ-ç®€å•ä½†è„†å¼±" class="headerlink" title="æ–¹æ¡ˆä¸€ï¼šåŸºç¡€å“ˆå¸Œæ–¹æ¡ˆ - ç®€å•ä½†è„†å¼±"></a>æ–¹æ¡ˆä¸€ï¼šåŸºç¡€å“ˆå¸Œæ–¹æ¡ˆ - ç®€å•ä½†è„†å¼±</h2><p>æœ€ç›´è§‚çš„æƒ³æ³•æ˜¯é¿å…æ˜æ–‡ä¼ è¾“ï¼Œåˆ©ç”¨å“ˆå¸Œå‡½æ•°çš„å•å‘æ€§ã€‚</p><p><strong>æ ¸å¿ƒåŸç†</strong></p><ul><li>**å•å‘å“ˆå¸Œå‡½æ•° (One-way Hash Function)**ï¼šå¦‚ SHA-256ï¼Œå¯ä»¥å°†ä»»æ„è¾“å…¥æ•°æ®è½¬æ¢æˆä¸€ä¸ªå›ºå®šé•¿åº¦çš„ã€ç‹¬ä¸€æ— äºŒçš„â€œæŒ‡çº¹â€ã€‚å…³é”®åœ¨äºï¼Œä»æŒ‡çº¹åæ¨å‡ºåŸå§‹è¾“å…¥åœ¨è®¡ç®—ä¸Šæ˜¯ä¸å¯è¡Œçš„ã€‚</li></ul><p><strong>åè®®æµç¨‹</strong></p><ol><li><strong>çº¦å®šå“ˆå¸Œ</strong>: A å’Œ B åŒæ–¹çº¦å®šä¸€ä¸ªæ ‡å‡†çš„å“ˆå¸Œå‡½æ•°ï¼ˆå¦‚ SHA-256ï¼‰ã€‚</li><li><strong>æœ¬åœ°è®¡ç®—</strong>: A å°†è‡ªå·±çš„æ•°æ®é›†å†…æ¯ä¸ªå…ƒç´ è¿›è¡Œå“ˆå¸Œï¼Œå¾—åˆ°å“ˆå¸Œåˆ—è¡¨ <code>Hash(A)</code>ã€‚B ä¹ŸåŒæ ·è®¡ç®—å‡º <code>Hash(B)</code>ã€‚</li><li><strong>äº¤æ¢ä¸æ¯”è¾ƒ</strong>: åŒæ–¹äº¤æ¢å“ˆå¸Œåˆ—è¡¨ï¼Œç„¶åæœ¬åœ°æ¯”è¾ƒ <code>Hash(A)</code> å’Œ <code>Hash(B)</code>ï¼Œæ‰¾å‡ºç›¸åŒçš„å“ˆå¸Œå€¼ï¼Œè¿™äº›å°±ä»£è¡¨äº†åŸå§‹æ•°æ®çš„äº¤é›†ã€‚</li></ol><p><strong>å®ç°ä¼ªä»£ç  (Python)</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hash_items</span>(<span class="params">items</span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;hashlib.sha256(item.encode()).hexdigest() <span class="keyword">for</span> item <span class="keyword">in</span> items&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Client A&#x27;s data</span></span><br><span class="line">data_A = &#123;<span class="string">&quot;apple&quot;</span>, <span class="string">&quot;banana&quot;</span>, <span class="string">&quot;cherry&quot;</span>&#125;</span><br><span class="line"><span class="comment"># Client B&#x27;s data</span></span><br><span class="line">data_B = &#123;<span class="string">&quot;banana&quot;</span>, <span class="string">&quot;date&quot;</span>, <span class="string">&quot;grape&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. Both parties hash their data</span></span><br><span class="line">hashed_A = hash_items(data_A)</span><br><span class="line">hashed_B = hash_items(data_B)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. They exchange these hashed sets</span></span><br><span class="line"><span class="comment"># 3. B finds the intersection of the hashed sets</span></span><br><span class="line">intersection_hashes = hashed_A.intersection(hashed_B)</span><br><span class="line"></span><br><span class="line"><span class="comment"># B might send these back to A for final confirmation, or if hashes are identifiers,</span></span><br><span class="line"><span class="comment"># the process might end here.</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Intersection Hashes: <span class="subst">&#123;intersection_hashes&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><p><strong>åˆ†æ</strong></p><ul><li><strong>ä¼˜ç‚¹</strong>ï¼šå®ç°æå…¶ç®€å•ï¼Œè®¡ç®—é€Ÿåº¦é£å¿«ï¼Œç½‘ç»œé€šä¿¡åªæœ‰ä¸€è½®ã€‚</li><li><strong>ç¼ºç‚¹</strong>ï¼šå®‰å…¨æ€§æä½ã€‚å¦‚æœå…ƒç´ çš„ç©ºé—´æœ‰é™ä¸”å·²çŸ¥ï¼ˆå¦‚æ‰‹æœºå·ã€èº«ä»½è¯å·ã€æ—¥æœŸï¼‰ï¼Œæ”»å‡»è€…å¯ä»¥è½»æ¾æ„å»ºä¸€ä¸ªâ€œå½©è™¹è¡¨â€ï¼Œé€šè¿‡é¢„è®¡ç®—çš„å“ˆå¸Œå€¼åæ¨å‡ºåŸå§‹è¾“å…¥ã€‚å³ä½¿å¯¹æ¯ä¸ªå…ƒç´ åŠ ç›ï¼ˆSaltï¼‰ï¼Œä¹Ÿåªèƒ½å¢åŠ æš´åŠ›ç ´è§£çš„éš¾åº¦ï¼Œæ— æ³•ä»æ ¹æœ¬ä¸Šè§£å†³é—®é¢˜ã€‚</li></ul><p><strong>ç»“è®º</strong>ï¼šè¯¥æ–¹æ¡ˆä»…é€‚ç”¨äºå†…éƒ¨ç³»ç»Ÿæˆ–å®Œå…¨å¯ä¿¡çš„ç¯å¢ƒï¼Œ<strong>ç»å¯¹ä¸èƒ½</strong>ç”¨äºå¯¹æŠ—ä»»ä½•æœ‰åŠ¨æœºçš„å¤–éƒ¨æ”»å‡»è€…ã€‚</p><hr><h2 id="æ–¹æ¡ˆäºŒï¼šå¸ƒéš†è¿‡æ»¤å™¨-é«˜æ€§èƒ½çš„æ¦‚ç‡æ–¹æ¡ˆ"><a href="#æ–¹æ¡ˆäºŒï¼šå¸ƒéš†è¿‡æ»¤å™¨-é«˜æ€§èƒ½çš„æ¦‚ç‡æ–¹æ¡ˆ" class="headerlink" title="æ–¹æ¡ˆäºŒï¼šå¸ƒéš†è¿‡æ»¤å™¨ - é«˜æ€§èƒ½çš„æ¦‚ç‡æ–¹æ¡ˆ"></a>æ–¹æ¡ˆäºŒï¼šå¸ƒéš†è¿‡æ»¤å™¨ - é«˜æ€§èƒ½çš„æ¦‚ç‡æ–¹æ¡ˆ</h2><p>å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆBloom Filterï¼‰æ˜¯ä¸€ç§ç©ºé—´æ•ˆç‡æé«˜çš„æ¦‚ç‡å‹æ•°æ®ç»“æ„ï¼Œå®ƒä»¥ç‰ºç‰²ä¸€å°éƒ¨åˆ†å‡†ç¡®æ€§ä¸ºä»£ä»·ï¼Œæ¢å–äº†å·¨å¤§çš„æ€§èƒ½å’Œç©ºé—´ä¼˜åŠ¿ã€‚</p><p><strong>æ ¸å¿ƒåŸç†</strong></p><ul><li><strong>ä½æ•°ç»„ä¸å“ˆå¸Œå‡½æ•°</strong>: å¸ƒéš†è¿‡æ»¤å™¨ç”±ä¸€ä¸ªå¾ˆé•¿çš„ä½æ•°ç»„ï¼ˆåˆå§‹åŒ–å…¨ä¸º0ï¼‰å’Œå¤šä¸ªç‹¬ç«‹çš„å“ˆå¸Œå‡½æ•°ç»„æˆã€‚</li><li><strong>æ·»åŠ å…ƒç´ </strong>: å½“ä½ å‘è¿‡æ»¤å™¨ä¸­æ·»åŠ ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œä½ ä¼šç”¨æ‰€æœ‰å“ˆå¸Œå‡½æ•°å¯¹è¿™ä¸ªå…ƒç´ è¿›è¡Œè®¡ç®—ï¼Œå¾—åˆ°å¤šä¸ªä¸åŒçš„ä½ç½®ç´¢å¼•ï¼Œç„¶åå°†ä½æ•°ç»„ä¸­è¿™äº›ä½ç½®çš„æ¯”ç‰¹å€¼è®¾ä¸º 1ã€‚</li><li><strong>æŸ¥è¯¢å…ƒç´ </strong>: æŸ¥è¯¢ä¸€ä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨æ—¶ï¼Œä½ ç”¨åŒæ ·çš„å“ˆå¸Œå‡½æ•°å†æ¬¡è®¡ç®—å‡ºæ‰€æœ‰ä½ç½®ç´¢å¼•ã€‚åªæœ‰å½“æ‰€æœ‰è¿™äº›ä½ç½®çš„æ¯”ç‰¹å€¼éƒ½ä¸º 1 æ—¶ï¼Œè¿‡æ»¤å™¨æ‰æŠ¥å‘Šâ€œå…ƒç´ <strong>å¯èƒ½</strong>å­˜åœ¨â€ã€‚åªè¦æœ‰ä¸€ä¸ªä½ç½®æ˜¯ 0ï¼Œé‚£ä¹ˆè¯¥å…ƒç´ <strong>ç»å¯¹ä¸</strong>å­˜åœ¨ã€‚</li><li><strong>å‡é˜³æ€§ (False Positive)</strong>: å½“ä¸€ä¸ªæœ¬ä¸å­˜åœ¨çš„å…ƒç´ ï¼Œå…¶å“ˆå¸Œåˆ°çš„æ‰€æœ‰ä½ç½®æ°å¥½éƒ½è¢«å…¶ä»–å…ƒç´ ç½®ä¸º 1 æ—¶ï¼Œå°±ä¼šå‘ç”Ÿè¯¯åˆ¤ã€‚å‡é˜³æ€§ç‡å¯ä»¥é€šè¿‡è°ƒæ•´ä½æ•°ç»„å¤§å°å’Œå“ˆå¸Œå‡½æ•°æ•°é‡æ¥æ§åˆ¶ã€‚</li></ul><p><strong>åè®®æµç¨‹</strong></p><ol><li><p><strong>é˜¶æ®µä¸€ï¼šA æ„å»ºå¹¶å‘é€è¿‡æ»¤å™¨</strong></p><ul><li>æ•°æ®é‡è¾ƒå°çš„ä¸€æ–¹ï¼ˆAï¼‰ï¼Œæ ¹æ®è‡ªå·±çš„æ•°æ®é›†åˆ›å»ºä¸€ä¸ªå¸ƒéš†è¿‡æ»¤å™¨ã€‚</li><li>A å°†è¿™ä¸ªç´§å‡‘çš„ä½æ•°ç»„å‘é€ç»™æ•°æ®é‡è¾ƒå¤§çš„ä¸€æ–¹ï¼ˆBï¼‰ã€‚é€šä¿¡é‡æå°ï¼Œä¸€ä¸ªå‡ MBçš„è¿‡æ»¤å™¨å°±èƒ½ä»£è¡¨ä¸Šäº¿æ¡æ•°æ®ã€‚</li></ul></li><li><p><strong>é˜¶æ®µäºŒï¼šB æŸ¥è¯¢å¹¶è¿”å›å€™é€‰é›†</strong></p><ul><li>B éå†è‡ªå·±çš„æ•°æ®é›†ï¼Œç”¨ä¸ A ç›¸åŒçš„å“ˆå¸Œå‡½æ•°å»æŸ¥è¯¢æ”¶åˆ°çš„å¸ƒéš†è¿‡æ»¤å™¨ã€‚</li><li>B å°†æ‰€æœ‰åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­æ˜¾ç¤ºâ€œå¯èƒ½å­˜åœ¨â€çš„å…ƒç´ ï¼Œæ„æˆä¸€ä¸ª<strong>å€™é€‰äº¤é›†</strong>ã€‚è¿™ä¸ªé›†åˆç”±äºå‡é˜³æ€§çš„å­˜åœ¨ï¼Œä¼šæ¯”çœŸå®äº¤é›†æ›´å¤§ã€‚</li><li>B å°†è¿™ä¸ª<strong>å€™é€‰é›†çš„åŸå§‹ ID</strong>ï¼ˆæˆ–å…¶å“ˆå¸Œï¼‰å‘å›ç»™ Aã€‚</li></ul></li><li><p><strong>é˜¶æ®µä¸‰ï¼šA ç¡®è®¤æœ€ç»ˆäº¤é›†</strong></p><ul><li>A æ”¶åˆ°å€™é€‰é›†åï¼Œåœ¨è‡ªå·±çš„åŸå§‹æ•°æ®ä¸­è¿›è¡Œç²¾ç¡®åŒ¹é…ï¼Œå‰”é™¤æ‰æ‰€æœ‰å‡é˜³æ€§æˆå‘˜ï¼Œå¾—åˆ°æœ€ç»ˆçš„çœŸå®äº¤é›†ã€‚</li></ul></li></ol><p><strong>åˆ†æ</strong></p><ul><li><strong>ä¼˜ç‚¹</strong>:<ul><li><strong>æ€§èƒ½æé«˜</strong>ï¼šè®¡ç®—å“ˆå¸Œå’Œä½æ“ä½œéå¸¸å¿«ï¼Œæ˜¯æ‰€æœ‰æ–¹æ¡ˆä¸­é€Ÿåº¦æœ€å¿«çš„ä¹‹ä¸€ã€‚</li><li><strong>é€šä¿¡æ•ˆç‡æé«˜</strong>ï¼šA åªéœ€è¦å‘é€ä¸€ä¸ªç´§å‡‘çš„ä½æ•°ç»„ï¼Œé€šä¿¡æˆæœ¬æ˜¯å…¶æœ€å¤§äº®ç‚¹ã€‚</li></ul></li><li><strong>ç¼ºç‚¹</strong>:<ul><li><strong>æœ‰è¯¯æŠ¥</strong>ï¼šå¿…é¡»æœ‰ä¸€ä¸ªé¢å¤–çš„äº¤äº’æ­¥éª¤ï¼ˆB -&gt; Aï¼‰æ¥å‰”é™¤è¯¯æŠ¥ç»“æœã€‚</li><li><strong>å®‰å…¨æ€§æœ‰é™</strong>ï¼šè¿‡æ»¤å™¨æœ¬èº«è™½ç„¶ä¸æ˜¯æ˜æ–‡ï¼Œä½†ä»ç„¶æ³„éœ²äº†å…³äºæ•°æ®é›†çš„ç»Ÿè®¡å­¦ç‰¹å¾ã€‚å¦‚æœ B æ˜¯æ¶æ„çš„ï¼Œå®ƒå¯ä»¥åˆ©ç”¨è¿‡æ»¤å™¨æµ‹è¯•å®ƒçŒœæµ‹çš„å…ƒç´ æ˜¯å¦å­˜åœ¨äº A çš„é›†åˆä¸­ã€‚å› æ­¤ï¼Œå®ƒåªåœ¨åŠè¯šå®æ¨¡å‹ä¸‹æä¾›æœ‰é™çš„éšç§ä¿æŠ¤ã€‚</li></ul></li></ul><p><strong>ç»“è®º</strong>ï¼šåœ¨è¿½æ±‚æè‡´æ€§èƒ½ã€èƒ½æ¥å—å¤šè½®äº¤äº’ã€ä¸”å®‰å…¨è¦æ±‚ä¸æ˜¯æœ€é«˜çº§åˆ«çš„åœºæ™¯ä¸‹ï¼Œå¸ƒéš†è¿‡æ»¤å™¨æ˜¯ä¸šç•Œå¤§è§„æ¨¡æ•°æ®æ±‚äº¤çš„å¸¸ç”¨æ–¹æ¡ˆã€‚å®ƒæ˜¯æ€§èƒ½å’Œéšç§ä¹‹é—´ä¸€ä¸ªå‡ºè‰²çš„å·¥ç¨‹å¹³è¡¡ã€‚</p><hr><h2 id="æ–¹æ¡ˆä¸‰ï¼šåŸºäºå…¬é’¥å¯†ç å­¦çš„å®‰å…¨æ–¹æ¡ˆ"><a href="#æ–¹æ¡ˆä¸‰ï¼šåŸºäºå…¬é’¥å¯†ç å­¦çš„å®‰å…¨æ–¹æ¡ˆ" class="headerlink" title="æ–¹æ¡ˆä¸‰ï¼šåŸºäºå…¬é’¥å¯†ç å­¦çš„å®‰å…¨æ–¹æ¡ˆ"></a>æ–¹æ¡ˆä¸‰ï¼šåŸºäºå…¬é’¥å¯†ç å­¦çš„å®‰å…¨æ–¹æ¡ˆ</h2><p>ä¸ºäº†å®ç°æ•°å­¦ä¸Šå¯è¯æ˜çš„å®‰å…¨æ€§ï¼ˆå³é™¤äº†äº¤é›†æœ¬èº«ï¼Œä¸æ³„éœ²ä»»ä½•é¢å¤–ä¿¡æ¯ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥å…¬é’¥å¯†ç å­¦å·¥å…·ã€‚è¿™äº›æ–¹æ¡ˆé€šå¸¸åœ¨åŠè¯šå®æ¨¡å‹ä¸‹æ˜¯å®‰å…¨çš„ã€‚</p><h3 id="3-1-åŸºäº-Diffie-Hellman-çš„-PSI"><a href="#3-1-åŸºäº-Diffie-Hellman-çš„-PSI" class="headerlink" title="3.1 åŸºäº Diffie-Hellman çš„ PSI"></a>3.1 åŸºäº Diffie-Hellman çš„ PSI</h3><p>è¯¥æ–¹æ¡ˆå·§å¦™åœ°åˆ©ç”¨äº† Diffie-Hellman å¯†é’¥äº¤æ¢åè®®çš„äº¤æ¢å¾‹ï¼Œæ„å»ºäº†ä¸€ä¸ªä¼˜é›…çš„ PSI åè®®ã€‚</p><p><strong>å‰ç½®çŸ¥è¯†ï¼šDiffie-Hellman å¯†é’¥äº¤æ¢</strong><br>è¯¥åè®®çš„æ ¸å¿ƒæ˜¯è®©ä¸¤ä¸ªäº’ä¸ä¿¡ä»»çš„äººï¼ˆAlice å’Œ Bobï¼‰é€šè¿‡å…¬å¼€ä¿¡é“åå•†å‡ºä¸€ä¸ªå…±äº«çš„ç§˜å¯†å¯†é’¥ã€‚</p><ol><li>åŒæ–¹çº¦å®šå…¬å…±å‚æ•° <code>g</code> å’Œ <code>p</code>ã€‚</li><li>Alice ç”Ÿæˆç§é’¥ <code>a</code>ï¼Œè®¡ç®—å…¬é’¥ <code>A = g^a mod p</code>ï¼Œå‘é€ç»™ Bobã€‚</li><li>Bob ç”Ÿæˆç§é’¥ <code>b</code>ï¼Œè®¡ç®—å…¬é’¥ <code>B = g^b mod p</code>ï¼Œå‘é€ç»™ Aliceã€‚</li><li>Alice è®¡ç®—å…±äº«å¯†é’¥ <code>S = B^a mod p = (g^b)^a mod p</code>ã€‚</li><li>Bob è®¡ç®—å…±äº«å¯†é’¥ <code>S = A^b mod p = (g^a)^b mod p</code>ã€‚<br>ç”±äºå¹‚è¿ç®—çš„äº¤æ¢å¾‹ï¼ŒåŒæ–¹å¾—åˆ°äº†å®Œå…¨ç›¸åŒçš„å¯†é’¥ <code>S</code>ï¼Œè€Œçªƒå¬è€…æ— æ³•ä»å…¬å¼€çš„ <code>A</code> å’Œ <code>B</code> ä¸­è®¡ç®—å‡ºå®ƒã€‚</li></ol><p><strong>åè®®æµç¨‹</strong><br>æ­¤ PSI åè®®å°†æ¯ä¸ªæ•°æ®é¡¹éƒ½è§†ä½œä¸€æ¬¡ç‹¬ç«‹çš„å¯†é’¥äº¤æ¢ã€‚</p><ol><li><strong>å„è‡ªå‡†å¤‡</strong>: A å’Œ B å„è‡ªç”Ÿæˆä¸€ä¸ªç§é’¥ï¼ˆéšæœºæ•° <code>a</code> å’Œ <code>b</code>ï¼‰ã€‚</li><li><strong>A æ–¹è®¡ç®—ä¸å‘é€</strong>: A å¯¹è‡ªå·±çš„æ¯ä¸ªå…ƒç´  <code>x</code>ï¼Œå…ˆå“ˆå¸Œåˆ°æ¤­åœ†æ›²çº¿ä¸Šçš„ä¸€ä¸ªç‚¹ <code>H(x)</code>ï¼Œç„¶åç”¨ç§é’¥ <code>a</code> è®¡ç®—â€œå…¬é’¥â€ <code>P_x = a * H(x)</code>ã€‚A å°†æ‰€æœ‰ <code>P_x</code> ç»„æˆçš„åˆ—è¡¨å‘é€ç»™ Bã€‚</li><li><strong>B æ–¹è®¡ç®—ä¸å‘é€</strong>: B æ”¶åˆ°åˆ—è¡¨åï¼Œç”¨è‡ªå·±çš„ç§é’¥ <code>b</code> å¯¹åˆ—è¡¨ä¸­çš„æ¯ä¸ªå…ƒç´ è¿›è¡ŒäºŒæ¬¡â€œåŠ å¯†â€ï¼Œå¾—åˆ° <code>S_x = b * P_x = b * a * H(x)</code>ã€‚åŒæ—¶ï¼ŒB å¯¹è‡ªå·±çš„æ¯ä¸ªå…ƒç´  <code>y</code> è®¡ç®— <code>P_y = b * H(y)</code>ã€‚B å°†æ‰€æœ‰ <code>P_y</code> ç»„æˆçš„åˆ—è¡¨å‘é€ç»™ Aã€‚</li><li><strong>A æ–¹è®¡ç®—</strong>: A æ”¶åˆ° B å‘é€çš„ <code>P_y</code> åˆ—è¡¨åï¼Œç”¨è‡ªå·±çš„ç§é’¥ <code>a</code> å¯¹æ¯ä¸ªå…ƒç´ è®¡ç®—ï¼Œå¾—åˆ° <code>S_y = a * P_y = a * b * H(y)</code>ã€‚</li><li><strong>æ‰¾å‡ºäº¤é›†</strong>: æ­¤æ—¶ï¼Œå¦‚æœ A å’Œ B æœ‰ä¸€ä¸ªå…±åŒå…ƒç´  <code>z</code>ï¼Œé‚£ä¹ˆåœ¨ A çš„æœ¬åœ°ï¼Œå¥¹è®¡ç®—å‡ºäº† <code>S_z = a*b*H(z)</code>ï¼›åœ¨ B çš„æœ¬åœ°ï¼Œä»–è®¡ç®—å‡ºäº† <code>S_z = b*a*H(z)</code>ã€‚ç”±äºäº¤æ¢å¾‹ï¼Œè¿™ä¸¤ä¸ªå€¼æ˜¯ç›¸ç­‰çš„ã€‚A å°†è‡ªå·±è®¡ç®—å‡ºçš„ <code>S_y</code> é›†åˆä¸ B å‘å›çš„ <code>S_x</code> é›†åˆï¼ˆAå¯ä»¥åœ¨æœ¬åœ°é‡æ–°è®¡ç®—ï¼‰æ±‚äº¤ï¼Œå³å¯æ‰¾å‡ºäº¤é›†å¯¹åº”çš„ç§˜å¯†å€¼ï¼Œä»è€Œç¡®å®šäº¤é›†ã€‚é€šå¸¸ï¼Œä¸ºäº†ä¸è®© B ä¹ŸçŸ¥é“äº¤é›†ï¼Œæœ€åä¸€æ­¥æ¯”è¾ƒåªåœ¨ A æ–¹è¿›è¡Œã€‚</li></ol><p><strong>åˆ†æ</strong></p><ul><li><strong>ä¼˜ç‚¹</strong>ï¼šå®‰å…¨æ€§é«˜ï¼ŒåŸºäºæˆç†Ÿçš„å…¬é’¥å¯†ç ä½“ç³»ï¼Œæ— è¯¯æŠ¥ã€‚åœ¨åŠè¯šå®æ¨¡å‹ä¸‹æ˜¯å®‰å…¨çš„ã€‚</li><li><strong>ç¼ºç‚¹</strong>ï¼šè®¡ç®—å¼€é”€å¤§ï¼Œæ¶‰åŠå¤§é‡çš„æ¤­åœ†æ›²çº¿ç‚¹ä¹˜è¿ç®—ï¼ˆæ¯”æ¨¡å¹‚æ›´å¿«ï¼Œä½†ä»æ˜¯é‡è®¡ç®—ï¼‰ï¼Œæ¯”ç®€å•å“ˆå¸Œæ…¢å¾—å¤šã€‚é€šä¿¡æˆæœ¬ä¹Ÿè¾ƒé«˜ï¼Œéœ€è¦äº¤æ¢ä¸¤è½®æ•°æ®ã€‚</li></ul><p><strong>ç»“è®º</strong>ï¼šä¸€ä¸ªä¼˜é›…çš„ã€æ•™ç§‘ä¹¦å¼çš„ PSI æ–¹æ¡ˆã€‚é€‚åˆä¸­ç­‰å¤§å°æ•°æ®é›†ï¼Œæˆ–ä½œä¸ºç†è§£æ›´å¤æ‚åè®®çš„èµ·ç‚¹ã€‚</p><h3 id="3-2-åŸºäºä¸ç»æ„ä¼ è¾“-OT-çš„-PSI"><a href="#3-2-åŸºäºä¸ç»æ„ä¼ è¾“-OT-çš„-PSI" class="headerlink" title="3.2 åŸºäºä¸ç»æ„ä¼ è¾“ (OT) çš„ PSI"></a>3.2 åŸºäºä¸ç»æ„ä¼ è¾“ (OT) çš„ PSI</h3><p>è¿™æ˜¯å½“å‰å…¼é¡¾<strong>é¡¶çº§å®‰å…¨</strong>å’Œ<strong>é¡¶çº§æ€§èƒ½</strong>çš„é»„é‡‘æ ‡å‡†ï¼Œæ˜¯ç°ä»£éšç§è®¡ç®—æ¡†æ¶ï¼ˆå¦‚ FATE, SecretFlowï¼‰çš„æ ¸å¿ƒã€‚å®ƒè™½ç„¶å¤æ‚ï¼Œä½†ç†è§£å…¶æ„ä»¶æ˜¯ç†è§£ç°ä»£å¯†ç å­¦çš„å…³é”®ã€‚</p><p><strong>æ ¸å¿ƒæ„ä»¶ä¸€ï¼šä¸ç»æ„ä¼ è¾“ (Oblivious Transfer, OT)</strong></p><ul><li><strong>æ˜¯ä»€ä¹ˆ</strong>ï¼šä¸€ä¸ªä¸¤æ–¹åè®®ï¼Œå…¶ä¸­å‘é€æ–¹ (Sender) æœ‰ <code>N</code> ä¸ªæ¶ˆæ¯ <code>(m_1, m_2, ..., m_n)</code>ï¼Œæ¥æ”¶æ–¹ (Receiver) æœ‰ä¸€ä¸ªç´¢å¼• <code>i</code>ã€‚åè®®ç»“æŸåï¼Œæ¥æ”¶æ–¹åªå¾—åˆ°äº†æ¶ˆæ¯ <code>m_i</code>ï¼Œè€Œå‘é€æ–¹å®Œå…¨ä¸çŸ¥é“æ¥æ”¶æ–¹å–èµ°äº†ç¬¬å‡ ä¸ªæ¶ˆæ¯ã€‚</li><li><strong>â€œé‚®å±€ä¿¡ç®±â€ç±»æ¯”</strong>: Bob æƒ³ä»é‚®é€’å‘˜ Alice é‚£é‡Œæ‹¿åˆ° N å°ä¿¡ä¸­çš„ç¬¬ <code>i</code> å°ï¼Œä½†ä»–ä¸æƒ³è®© Alice çŸ¥é“ä»–å–äº†å“ªå°ã€‚Bob æœ‰ä¸€æŠŠåªèƒ½æ‰“å¼€ç¬¬ <code>i</code> å·ä¿¡ç®±çš„é’¥åŒ™ã€‚ä»–æŠŠè¿™æŠŠé”ï¼ˆå·²æ‰“å¼€çŠ¶æ€ï¼Œä½†é’¥åŒ™ä¸ç»™ Aliceï¼‰äº¤ç»™ Aliceã€‚Alice æ‹¿åˆ°åï¼Œç”¨å®ƒå’Œå…¶ä»– N-1 æŠŠå¥¹è‡ªå·±å‡†å¤‡çš„é”ï¼Œåˆ†åˆ«é”ä¸Šå¯¹åº”çš„ N å°ä¿¡ï¼Œç„¶åæŠŠæ‰€æœ‰ N ä¸ªä¿¡ç®±éƒ½äº¤ç»™ Bobã€‚Bob åªèƒ½ç”¨è‡ªå·±çš„é’¥åŒ™æ‰“å¼€ç¬¬ <code>i</code> å·ä¿¡ç®±ï¼Œæ‹¿åˆ°ä¿¡ä»¶ã€‚Alice å§‹ç»ˆä¸çŸ¥é“ Bob çš„é€‰æ‹©ã€‚</li><li>**ä¸ç»æ„ä¼ è¾“æ‰©å±• (OTe)**ï¼šåŸºç¡€çš„ OT åè®®æ‰§è¡Œä¸€æ¬¡å¼€é”€å¾ˆå¤§ã€‚OTe æŠ€æœ¯å¯ä»¥ç”¨å¾ˆå°‘çš„â€œç§å­â€OT å®ä¾‹ï¼Œä»¥æä½çš„æˆæœ¬ç”Ÿæˆæµ·é‡çš„ OT å®ä¾‹ï¼Œè¿™ä½¿å¾— OT åœ¨å¤§æ•°æ®åœºæ™¯ä¸‹å˜å¾—å®ç”¨ã€‚</li></ul><p><strong>æ ¸å¿ƒæ„ä»¶äºŒï¼šå¸ƒè°·é¸Ÿå“ˆå¸Œ (Cuckoo Hashing)</strong></p><ul><li><strong>æ˜¯ä»€ä¹ˆ</strong>ï¼šä¸€ç§ç‰¹æ®Šçš„å“ˆå¸Œè¡¨ï¼Œå®ƒä¸ºæ¯ä¸ªå…ƒç´ åˆ†é…<strong>ä¸¤ä¸ªæˆ–å¤šä¸ª</strong>å¤‡é€‰å­˜å‚¨ä½ç½®ã€‚</li><li><strong>â€œå¸ƒè°·é¸Ÿå å·¢â€ç±»æ¯”</strong>: æƒ³è±¡ä¸€æ’é¸Ÿå·¢ï¼ˆä¸€ä¸ªå¤§æ•°ç»„ï¼‰å’Œä¸€ç¾¤å¸ƒè°·é¸Ÿï¼ˆæ•°æ®é¡¹ï¼‰ã€‚æ¯åªé¸Ÿéƒ½æœ‰ä¸¤ä¸ªå›ºå®šçš„å·¢å¯ä»¥å»ï¼ˆç”±ä¸¤ä¸ªå“ˆå¸Œå‡½æ•° <code>h1(x)</code>, <code>h2(x)</code> å†³å®šï¼‰ã€‚å½“ä¸€åªæ–°é¸Ÿé£æ¥ï¼Œå®ƒæ£€æŸ¥ç¬¬ä¸€ä¸ªå®¶ <code>h1(x)</code>ã€‚å¦‚æœç©ºç€ï¼Œå°±ä½è¿›å»ã€‚å¦‚æœè¢«å äº†ï¼Œå®ƒå°±æŠŠé‡Œé¢çš„â€œåŸä½æ°‘â€è¸¢å‡ºå»ï¼Œè‡ªå·±ä½è¿›å»ã€‚è¢«è¸¢å‡ºå»çš„é¸Ÿï¼Œç°åœ¨é£å‘å®ƒçš„<em>å¦ä¸€ä¸ª</em>å¤‡é€‰å®¶ <code>h2(x)</code>â€¦ è¿™ä¸ªè¿‡ç¨‹ä¼šåƒé“¾å¼ååº”ä¸€æ ·ç»§ç»­ä¸‹å»ï¼Œç›´åˆ°æ‰€æœ‰é¸Ÿéƒ½æ‰¾åˆ°å®¶ã€‚</li><li><strong>åœ¨PSIä¸­çš„ä½œç”¨</strong>: æœåŠ¡ç«¯ï¼ˆå¤§æ•°æ®æ–¹ï¼‰å°†è‡ªå·±çš„æ•°æ®å­˜å…¥å¸ƒè°·é¸Ÿå“ˆå¸Œè¡¨ã€‚è¿™æ ·ï¼Œå®¢æˆ·ç«¯ï¼ˆå°æ•°æ®æ–¹ï¼‰æƒ³æŸ¥è¯¢ä¸€ä¸ªå…ƒç´  <code>x</code>ï¼Œå®ƒå°±<strong>æ˜ç¡®åœ°çŸ¥é“</strong> <code>x</code> åªå¯èƒ½å­˜åœ¨äº <code>h1(x)</code> å’Œ <code>h2(x)</code> è¿™ä¸¤ä¸ªä½ç½®ã€‚è¿™é¿å…äº†å…¨è¡¨æ‰«æï¼Œå°†æŸ¥è¯¢èŒƒå›´ç¼©å°åˆ°å¸¸æ•°çº§åˆ«ï¼Œæ˜¯ OT-PSI é«˜æ€§èƒ½çš„å…³é”®ã€‚</li></ul><p><strong>åè®®æµç¨‹ (é«˜åº¦ç®€åŒ–)</strong><br>æˆ‘ä»¬å°†å‚ä¸æ–¹ç§°ä¸ºå®¢æˆ·ç«¯ C (æ•°æ®é‡å°)å’ŒæœåŠ¡ç«¯ S (æ•°æ®é‡å¤§)ã€‚ç›®æ ‡æ˜¯å®¢æˆ·ç«¯å¾—åˆ°äº¤é›†ï¼ŒæœåŠ¡ç«¯ä¸€æ— æ‰€çŸ¥ã€‚</p><ol><li><p><strong>æœåŠ¡ç«¯å‡†å¤‡ (ç¦»çº¿)</strong>:</p><ul><li>S å°†è‡ªå·±çš„æ•°æ®é›† <code>Y</code> å­˜å…¥ä¸€ä¸ªå¸ƒè°·é¸Ÿå“ˆå¸Œè¡¨ä¸­ã€‚è¡¨çš„æ¯ä¸ªæ§½ä½è¦ä¹ˆæ˜¯ <code>y</code>ï¼Œè¦ä¹ˆæ˜¯ç©ºã€‚</li><li>S å¯¹å¸ƒè°·é¸Ÿå“ˆå¸Œè¡¨ä¸­çš„æ¯ä¸ªä½ç½®ï¼Œéƒ½å¡«å……ä¸€ä¸ªéšæœºç”Ÿæˆçš„ç§˜å¯†å€¼ã€‚</li></ul></li><li><p><strong>äº¤äº’ä¸æŸ¥è¯¢ (åœ¨çº¿)</strong>:</p><ul><li>C å¯¹äºè‡ªå·±çš„æ¯ä¸ªå…ƒç´  <code>x</code>ï¼Œä¹Ÿç”¨ç›¸åŒçš„å“ˆå¸Œå‡½æ•°è®¡ç®—å‡ºå®ƒåœ¨å¸ƒè°·é¸Ÿè¡¨ä¸­çš„æ‰€æœ‰å¯èƒ½ä½ç½®ï¼ˆå¦‚ <code>h1(x)</code>, <code>h2(x)</code>ï¼‰ã€‚</li><li>C ä½œä¸º OT åè®®çš„æ¥æ”¶æ–¹ï¼ŒS ä½œä¸ºå‘é€æ–¹ï¼ŒåŒæ–¹æ‰§è¡Œ OTe åè®®ã€‚C å°†ä¸Šä¸€æ­¥è®¡ç®—å‡ºçš„æ‰€æœ‰ä½ç½®ä½œä¸ºæŸ¥è¯¢ç´¢å¼•ã€‚</li><li>é€šè¿‡ OTeï¼ŒC â€œä¸ç»æ„åœ°â€ä» S è·å–äº†å®ƒæƒ³æŸ¥è¯¢çš„æ‰€æœ‰ä½ç½®ä¸Šçš„ç§˜å¯†å€¼ã€‚æ•´ä¸ªè¿‡ç¨‹ S ä¸çŸ¥é“ C æŸ¥è¯¢äº†å“ªäº›ä½ç½®ï¼ŒC ä¹Ÿä¸çŸ¥é“å…¶ä»–ä½ç½®çš„å€¼ã€‚</li></ul></li><li><p><strong>å®¢æˆ·ç«¯è®¡ç®— (ç¦»çº¿)</strong>:</p><ul><li>ä¸ºäº†æ‰¾å‡ºäº¤é›†ï¼Œåè®®æœ‰ä¸€ä¸ªå·§å¦™çš„è®¾è®¡ï¼šå®¢æˆ·ç«¯ä¸ä»…è·å–ç§˜å¯†å€¼ï¼Œè¿˜èƒ½é€šè¿‡å¦ä¸€ä¸ªå‡½æ•° <code>F</code> è®¡ç®—å‡ºè‡ªå·±å…ƒç´ çš„â€œæœŸæœ›ç§˜å¯†å€¼â€ã€‚</li><li>å®¢æˆ·ç«¯æ£€æŸ¥å–å›çš„ç§˜å¯†å€¼ä¸­ï¼Œæ˜¯å¦å­˜åœ¨ä¸€ä¸ªä¸å®ƒä¸º <code>x</code> è®¡ç®—å‡ºçš„æœŸæœ›å€¼ç›¸åŒ¹é…ã€‚å¦‚æœåŒ¹é…ï¼Œ<code>x</code> å°±å±äºäº¤é›†ã€‚</li><li>å®¢æˆ·ç«¯åœ¨æœ¬åœ°å®Œæˆæ‰€æœ‰åŒ¹é…ï¼Œæœ€ç»ˆå¾—åˆ°å®Œæ•´çš„äº¤é›†ï¼Œè€ŒæœåŠ¡ç«¯å¯¹ç»“æœä¸€æ— æ‰€çŸ¥ã€‚</li></ul></li></ol><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  sequenceDiagram    participant Server as æœåŠ¡ç«¯ (å¤§æ•°æ®é›† Y)    participant Client as å®¢æˆ·ç«¯ (å°æ•°æ®é›† X)    Note over Server: é˜¶æ®µä¸€ï¼šç¦»çº¿å‡†å¤‡ (Cuckoo Hashing)    Server-&gt;&gt;Server: 1. å°†æ•°æ®é›† Y å­˜å…¥å¸ƒè°·é¸Ÿå“ˆå¸Œè¡¨    Server-&gt;&gt;Server: 2. ä¸ºå“ˆå¸Œè¡¨ä¸­æ¯ä¸ªæ§½ä½å¡«å……éšæœºç§˜å¯†å€¼    Note over Client,Server: é˜¶æ®µäºŒï¼šåœ¨çº¿äº¤äº’ (OTe)    loop å¯¹å®¢æˆ·ç«¯æ¯ä¸ªå…ƒç´  x        Client-&gt;&gt;Client: 3. è®¡ç®— x çš„ä¸¤ä¸ªæŸ¥è¯¢åœ°å€ h1(x), h2(x)    end    Note over Client,Server: 4. æ‰§è¡Œ OTe åè®®æ‰¹é‡æŸ¥è¯¢    Client-&gt;&gt;Server: ä½œä¸ºæ¥æ”¶æ–¹ï¼Œå°† h1(x), h2(x)... ä½œä¸ºé€‰æ‹©æ¯”ç‰¹    Server--&gt;&gt;Client: ä½œä¸ºå‘é€æ–¹ï¼Œè¿”å›åŠ å¯†çš„ç§˜å¯†å€¼    Note over Client: é˜¶æ®µä¸‰ï¼šæœ¬åœ°è®¡ç®—    Client-&gt;&gt;Client: 5. å°†è·å–çš„ç§˜å¯†å€¼ä¸æœ¬åœ°æœŸæœ›å€¼æ¯”å¯¹    Client-&gt;&gt;Client: 6. æ‰¾å‡ºæ‰€æœ‰åŒ¹é…æˆåŠŸçš„å…ƒç´ ï¼Œæ„æˆäº¤é›†  </pre></div><p><strong>åˆ†æ</strong></p><ul><li><strong>ä¼˜ç‚¹</strong>ï¼šé€šè¿‡å¤æ‚çš„å¯†ç å­¦å·¥ç¨‹ï¼Œå®ç°äº†æé«˜çš„å®‰å…¨ï¼ˆåŠè¯šå®æ¨¡å‹ï¼‰å’Œæé«˜çš„æ€§èƒ½ï¼Œé€šä¿¡è½®æ¬¡å°‘ï¼ˆåŸºæœ¬ä¸€è½®ï¼‰ï¼Œè®¡ç®—é€Ÿåº¦è¿œè¶…å…¶ä»–å…¬é’¥æ–¹æ¡ˆã€‚</li><li><strong>ç¼ºç‚¹</strong>ï¼šå®ç°æä¸ºå¤æ‚ï¼Œä¸ªäººéš¾ä»¥ä»é›¶å¼€å§‹æ­£ç¡®æ„å»ºï¼Œå¿…é¡»ä¾èµ–æˆç†Ÿçš„ã€ç»è¿‡åŒè¡Œè¯„å®¡çš„å¯†ç å­¦åº“ã€‚</li></ul><p><strong>ç»“è®º</strong>ï¼šè¿™æ˜¯ä¸šç•Œå‰æ²¿çš„é€‰æ‹©ï¼Œé€‚ç”¨äºå¯¹å®‰å…¨å’Œæ€§èƒ½éƒ½æœ‰ç€ä¸¥è‹›è¦æ±‚çš„å¤§è§„æ¨¡åœºæ™¯ã€‚</p><h3 id="3-3-å…³äºåŒæ€åŠ å¯†-HE-çš„è¯´æ˜"><a href="#3-3-å…³äºåŒæ€åŠ å¯†-HE-çš„è¯´æ˜" class="headerlink" title="3.3 å…³äºåŒæ€åŠ å¯† (HE) çš„è¯´æ˜"></a>3.3 å…³äºåŒæ€åŠ å¯† (HE) çš„è¯´æ˜</h3><p>åŒæ€åŠ å¯†å…è®¸åœ¨å¯†æ–‡ä¸Šè¿›è¡Œè®¡ç®—ï¼Œå¾—åˆ°çš„ç»“æœè§£å¯†åä¸åœ¨æ˜æ–‡ä¸Šè®¡ç®—çš„ç»“æœç›¸åŒã€‚</p><p><strong>æ ¸å¿ƒåŸç†</strong></p><ul><li><p>ä¸€ä¸ªå‡½æ•° <code>f</code> å’ŒåŠ å¯†ç®—æ³• <code>Enc</code>ï¼Œæ»¡è¶³ <code>Dec(f(Enc(a), Enc(b))) = f(a, b)</code>ã€‚</p></li><li><p><strong>å®ç°æ€è·¯</strong>: A å°†è‡ªå·±çš„é›†åˆ <code>&#123;x&#125;</code> æ¯ä¸ªå…ƒç´ åŠ å¯† <code>Enc(x)</code> å¹¶å‘é€ç»™ Bã€‚B åˆ©ç”¨åŒæ€æ€§è´¨ï¼Œåœ¨å¯†æ–‡ä¸Šæ‰§è¡Œä¸€ä¸ªâ€œæ¯”è¾ƒâ€æ“ä½œï¼Œæ‰¾å‡ºå“ªäº› <code>Enc(x)</code> ä¸è‡ªå·±çš„æŸä¸ª <code>Enc(y)</code> ç›¸ç­‰ã€‚è¿™ä¸ªè¿‡ç¨‹éå¸¸å¤æ‚ï¼Œè¿œä¸æ­¢æ˜¯ç®€å•çš„ <code>==</code> æ¯”è¾ƒã€‚</p></li><li><p><strong>ä¼˜ç‚¹</strong>ï¼šå®‰å…¨æ€§æé«˜ï¼Œç†è®ºä¸Šå¯ä»¥æ”¯æŒéå¸¸å¤æ‚çš„æ•°æ®åˆ†æã€‚</p></li><li><p><strong>ç¼ºç‚¹</strong>ï¼šæ€§èƒ½æå·®ã€‚åŒæ€è¿ç®—æ¯”æ˜æ–‡è¿ç®—æ…¢æ•°ä¸ªæ•°é‡çº§ï¼Œä¸”å¯†æ–‡è†¨èƒ€ä¸¥é‡ã€‚å¯¹äºç®€å•çš„é›†åˆæ±‚äº¤ä»»åŠ¡ï¼Œå…¶å¼€é”€è¿œå¤§äºä¸“ç”¨çš„ OT-PSI ç­‰åè®®ï¼Œå¦‚åŒâ€œç”¨å¤§ç‚®æ‰“èšŠå­â€ã€‚</p></li></ul><p><strong>ç»“è®º</strong>ï¼šHE æ˜¯è§£å†³æ›´å¤æ‚éšç§è®¡ç®—é—®é¢˜çš„å¼ºå¤§å·¥å…·ï¼ˆå¦‚éšç§è”é‚¦å­¦ä¹ ä¸­çš„æ¨¡å‹èšåˆï¼‰ï¼Œä½†å¯¹äºå•çº¯çš„ PSI ä»»åŠ¡ï¼Œé€šå¸¸ä¸æ˜¯æ€§ä»·æ¯”æœ€é«˜çš„é€‰æ‹©ã€‚</p><hr><h2 id="PSI-åè®®å˜ç§"><a href="#PSI-åè®®å˜ç§" class="headerlink" title="PSI åè®®å˜ç§"></a>PSI åè®®å˜ç§</h2><p>æ ‡å‡†çš„ PSI è§£å†³çš„æ˜¯â€œæ‰¾å‡ºäº¤é›†æˆå‘˜â€çš„é—®é¢˜ï¼Œä½†åœ¨ç°å®ä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸æœ‰æ›´ç»†åŒ–çš„éœ€æ±‚ã€‚</p><ul><li><p><strong>PSI-Cardinality (äº¤é›†åŸºæ•°è®¡ç®—)</strong></p><ul><li><strong>ç›®æ ‡</strong>ï¼šåªè®¡ç®—äº¤é›†çš„å¤§å° <code>|X âˆ© Y|</code>ï¼Œä¸æš´éœ²ä»»ä½•äº¤é›†æˆå‘˜ã€‚</li><li><strong>åœºæ™¯</strong>ï¼šä¸¤å®¶å…¬å¸æƒ³çŸ¥é“ä»–ä»¬æœ‰å¤šå°‘å…±åŒå®¢æˆ·ï¼Œä½†ä¸æƒ³çŸ¥é“å…·ä½“æ˜¯å“ªäº›å®¢æˆ·ã€‚</li><li><strong>å®ç°</strong>ï¼šé€šå¸¸æ¯”æ ‡å‡† PSI æ›´é«˜æ•ˆï¼Œå› ä¸ºéœ€è¦æ³„éœ²çš„ä¿¡æ¯æ›´å°‘ã€‚å¯ä»¥åŸºäºå¸ƒéš†è¿‡æ»¤å™¨ï¼ˆA å‘é€è¿‡æ»¤å™¨ï¼ŒB æŸ¥è¯¢åè¿”å›ä¸€ä¸ªè®¡æ•°å€¼ï¼‰ã€æˆ–ä¸“ç”¨çš„å¯†ç å­¦åè®®æ„å»ºã€‚</li></ul></li><li><p><strong>Labeled PSI (å¸¦æ ‡ç­¾çš„ PSI)</strong></p><ul><li><strong>ç›®æ ‡</strong>ï¼šä¸€æ–¹ï¼ˆé€šå¸¸æ˜¯å®¢æˆ·ç«¯ Aï¼‰æ‹¥æœ‰æ•°æ®é›† <code>X</code>ï¼Œå¦ä¸€æ–¹ï¼ˆæœåŠ¡ç«¯ Bï¼‰æ‹¥æœ‰å¸¦æ ‡ç­¾çš„æ•°æ®é›† <code>&#123;(y, l_y)&#125;</code>ã€‚åè®®ç»“æŸåï¼ŒA å¾—åˆ°ä¸äº¤é›†ç›¸å…³çš„æ ‡ç­¾ <code>&#123; (x, l_x) | x âˆˆ X âˆ© Y &#125;</code>ã€‚B é™¤äº†æ•°æ®é›†å¤§å°å¤–ï¼Œä¸€æ— æ‰€çŸ¥ã€‚</li><li><strong>åœºæ™¯</strong>ï¼šå¹¿å‘Šå½’å› ã€‚å¹¿å‘Šå¹³å°ï¼ˆBï¼‰æœ‰<code>ï¼ˆç”¨æˆ·ID, è½¬åŒ–ä»·å€¼ï¼‰</code>æ•°æ®ï¼Œå¹¿å‘Šä¸»ï¼ˆAï¼‰æœ‰<code>ï¼ˆç”¨æˆ·IDï¼‰</code>æ•°æ®ã€‚é€šè¿‡ Labeled PSIï¼Œå¹¿å‘Šä¸»å¯ä»¥çŸ¥é“è‡ªå·±å“ªäº›ç”¨æˆ·äº§ç”Ÿäº†è½¬åŒ–ï¼Œä»¥åŠå…·ä½“çš„ä»·å€¼ï¼Œè€Œå¹³å°æ–¹æ— éœ€æš´éœ²æ‰€æœ‰ç”¨æˆ·çš„ä»·å€¼ä¿¡æ¯ã€‚</li><li><strong>å®ç°</strong>ï¼šé€šå¸¸æ˜¯ OT-PSI çš„ä¸€ä¸ªæ‰©å±•ã€‚</li></ul></li><li><p><strong>Multi-Party PSI (å¤šæ–¹ PSI)</strong></p><ul><li><strong>ç›®æ ‡</strong>ï¼šä¸‰ä¸ªæˆ–æ›´å¤šå‚ä¸æ–¹ï¼Œå…±åŒè®¡ç®—ä»–ä»¬æ•°æ®é›†çš„äº¤é›† <code>X1 âˆ© X2 âˆ© ... âˆ© Xn</code>ã€‚</li><li><strong>åœºæ™¯</strong>ï¼šå¤šä¸ªå®‰å…¨æœºæ„å¸Œæœ›æ‰¾å‡ºä»–ä»¬å…±åŒçš„å«Œç–‘äººåå•ï¼Œä½†ä»»ä½•ä¸¤æ–¹ä¹‹é—´éƒ½ä¸æƒ³æš´éœ²è‡ªå·±çš„ç§æœ‰åå•ã€‚</li><li><strong>å®ç°</strong>ï¼šå¤æ‚åº¦æ˜¾è‘—æé«˜ã€‚å¸¸è§çš„æ–¹æ³•æœ‰ä¸¤ç±»ï¼š<ol><li><strong>åŸºäºä¸­å¿ƒåè°ƒè€…</strong>ï¼šæ‰€æœ‰å‚ä¸æ–¹éƒ½ä¸ä¸€ä¸ªï¼ˆå¯ä¿¡æˆ–ä¸å¯ä¿¡çš„ï¼‰ä¸­å¿ƒæœåŠ¡å™¨è¿›è¡Œä¸¤æ–¹ PSIã€‚</li><li><strong>å»ä¸­å¿ƒåŒ–</strong>ï¼šå‚ä¸æ–¹å½¢æˆä¸€ä¸ªç¯ï¼Œä¾‹å¦‚ <code>P1 -&gt; P2 -&gt; ... -&gt; Pn -&gt; P1</code>ï¼Œæ¯ä¸€æ–¹éƒ½å°†è‡ªå·±ä¸ä¸Šä¸€æ–¹è®¡ç®—çš„ä¸­é—´ç»“æœä¼ é€’ç»™ä¸‹ä¸€æ–¹ï¼Œæœ€ç»ˆå®Œæˆè®¡ç®—ã€‚</li></ol></li></ul></li></ul><hr><h2 id="æ–¹æ¡ˆå¯¹æ¯”ä¸é€‰æ‹©"><a href="#æ–¹æ¡ˆå¯¹æ¯”ä¸é€‰æ‹©" class="headerlink" title="æ–¹æ¡ˆå¯¹æ¯”ä¸é€‰æ‹©"></a>æ–¹æ¡ˆå¯¹æ¯”ä¸é€‰æ‹©</h2><table><thead><tr><th align="left">æ–¹æ¡ˆ</th><th align="left">å®‰å…¨æ¨¡å‹</th><th align="left">æ€§èƒ½</th><th align="left">é€šä¿¡æˆæœ¬</th><th align="left">æ ¸å¿ƒåŸç†</th><th align="left">å®ç°å¤æ‚åº¦</th><th align="left">æ ¸å¿ƒåœºæ™¯</th></tr></thead><tbody><tr><td align="left"><strong>ç®€å•å“ˆå¸Œ</strong></td><td align="left">ä¸å®‰å…¨</td><td align="left">æé«˜</td><td align="left">ä¸­</td><td align="left">å•å‘å“ˆå¸Œ</td><td align="left">ä½</td><td align="left">å†…éƒ¨æˆ–å®Œå…¨å¯ä¿¡ç¯å¢ƒ</td></tr><tr><td align="left"><strong>å¸ƒéš†è¿‡æ»¤å™¨</strong></td><td align="left">å¼±&#x2F;åŠè¯šå®</td><td align="left">æé«˜</td><td align="left"><strong>æä½</strong></td><td align="left">æ¦‚ç‡æ•°æ®ç»“æ„</td><td align="left">ä¸­</td><td align="left">æ€§èƒ½æ•æ„Ÿï¼Œèƒ½æ¥å—é¢å¤–äº¤äº’</td></tr><tr><td align="left"><strong>DH-PSI</strong></td><td align="left"><strong>åŠè¯šå®</strong></td><td align="left">ä¸­</td><td align="left">é«˜</td><td align="left">å¯†é’¥äº¤æ¢</td><td align="left">é«˜</td><td align="left">å®‰å…¨è¦æ±‚é«˜ï¼Œæ•°æ®é›†ä¸å¤§ï¼Œæ•™å­¦</td></tr><tr><td align="left"><strong>OT-PSI</strong></td><td align="left"><strong>åŠè¯šå®</strong></td><td align="left"><strong>é«˜</strong></td><td align="left">ä¸­</td><td align="left">ä¸ç»æ„ä¼ è¾“</td><td align="left"><strong>æé«˜</strong></td><td align="left">å…¼é¡¾é«˜æ€§èƒ½å’Œé«˜å®‰å…¨çš„å‰æ²¿é€‰æ‹©</td></tr><tr><td align="left"><strong>HE-PSI</strong></td><td align="left"><strong>åŠè¯šå®</strong></td><td align="left">æä½</td><td align="left">æé«˜</td><td align="left">åŒæ€åŠ å¯†</td><td align="left">æé«˜</td><td align="left">å­¦æœ¯ç ”ç©¶æˆ–å¤æ‚è®¡ç®—åœºæ™¯</td></tr></tbody></table><h3 id="å¦‚ä½•é€‰æ‹©ï¼Ÿä¸€ä»½å†³ç­–æŒ‡å—"><a href="#å¦‚ä½•é€‰æ‹©ï¼Ÿä¸€ä»½å†³ç­–æŒ‡å—" class="headerlink" title="å¦‚ä½•é€‰æ‹©ï¼Ÿä¸€ä»½å†³ç­–æŒ‡å—"></a>å¦‚ä½•é€‰æ‹©ï¼Ÿä¸€ä»½å†³ç­–æŒ‡å—</h3><ol><li><p><strong>ç¬¬ä¸€æ­¥ï¼šè¯„ä¼°å®‰å…¨å¨èƒä¸ä¿¡ä»»æ¨¡å‹</strong></p><ul><li>ä½ çš„å¯¹æ‰‹æ˜¯ä¼šéµå®ˆè§„åˆ™çš„â€œå¥½å¥‡å®å®â€ï¼ˆåŠè¯šå®ï¼‰ï¼Œè¿˜æ˜¯å¯èƒ½ä½œå¼Šçš„â€œç ´åè€…â€ï¼ˆæ¶æ„ï¼‰ï¼Ÿ</li><li>å¯¹äºç»å¤§å¤šæ•°å•†ä¸šåº”ç”¨ï¼Œ<strong>åŠè¯šå®å®‰å…¨</strong>å·²ç»è¶³å¤Ÿã€‚å¦‚æœéœ€è¦å¯¹æŠ—æ¶æ„æ”»å‡»ï¼Œä½ éœ€è¦å¯»æ‰¾æ˜ç¡®æ”¯æŒ<code>Malicious Secure</code>çš„åº“ï¼Œå¹¶æ¥å—æ˜¾è‘—çš„æ€§èƒ½ä¸‹é™ã€‚</li></ul></li><li><p><strong>ç¬¬äºŒæ­¥ï¼šæ˜ç¡®ä½ çš„è¾“å‡ºéœ€æ±‚</strong></p><ul><li>ä½ çœŸçš„éœ€è¦äº¤é›†çš„<strong>å…·ä½“æˆå‘˜</strong>å—ï¼Ÿè¿˜æ˜¯åªéœ€è¦å®ƒçš„<strong>æ•°é‡</strong>ï¼ˆ-&gt; PSI-Cardinalityï¼‰ï¼Ÿ</li><li>ä½ æ˜¯å¦éœ€è¦åœ¨æ±‚äº¤çš„åŒæ—¶ï¼Œä»å¯¹æ–¹è·å–å…³è”<strong>æ•°æ®</strong>ï¼ˆ-&gt; Labeled PSIï¼‰ï¼Ÿ</li><li>å‚ä¸æ–¹æ˜¯ä¸¤ä¸ªè¿˜æ˜¯å¤šä¸ªï¼ˆ-&gt; Multi-Party PSIï¼‰ï¼Ÿ</li></ul></li><li><p><strong>ç¬¬ä¸‰æ­¥ï¼šè¯„ä¼°æ€§èƒ½ã€æˆæœ¬ä¸æ•°æ®è§„æ¨¡</strong></p><ul><li><strong>æ€§èƒ½å’Œé€šä¿¡æˆæœ¬æ˜¯å”¯ä¸€ç“¶é¢ˆ</strong>ï¼šæ•°æ®é‡å·¨å¤§ï¼Œä½†å®‰å…¨è¦æ±‚ä¸é«˜ï¼Œä¸”å¯ä»¥å®¹å¿å¤šä¸€è½®äº¤äº’æ¥æ¶ˆé™¤è¯¯æŠ¥ -&gt; <strong>å¸ƒéš†è¿‡æ»¤å™¨</strong>ã€‚</li><li><strong>å®‰å…¨æ˜¯é¦–è¦è€ƒè™‘ï¼Œä½†æ•°æ®è§„æ¨¡ä¸å¤§</strong>ï¼šæ•°æ®é›†åœ¨åä¸‡åˆ°ç™¾ä¸‡çº§åˆ«ï¼Œå¸Œæœ›æœ‰ä¸€ä¸ªå¯é ã€æ˜“äºç†è§£çš„å¼ºå®‰å…¨æ–¹æ¡ˆ -&gt; <strong>DH-PSI</strong>ã€‚</li><li><strong>å®‰å…¨å’Œæ€§èƒ½ç¼ºä¸€ä¸å¯</strong>ï¼šæ•°æ®è§„æ¨¡åœ¨ç™¾ä¸‡çº§ä»¥ä¸Šï¼Œéœ€è¦åŠè¯šå®å®‰å…¨ä¿è¯ï¼Œå¹¶ä¸”å¯¹æ€§èƒ½æœ‰å¾ˆé«˜è¦æ±‚ -&gt; <strong>OT-PSI</strong> (å¹¶ä½¿ç”¨ç°æœ‰åº“)ã€‚</li></ul></li><li><p><strong>ç¬¬å››æ­¥ï¼šè€ƒè™‘å·¥ç¨‹å®ç°</strong></p><ul><li>å¯¹äºæ‰€æœ‰å…¬é’¥æ–¹æ¡ˆï¼Œ<strong>æ°¸è¿œä¸è¦è‡ªå·±ä»é›¶å®ç°</strong>ã€‚å¯†ç å­¦å®ç°ä¸­çš„ä»»ä½•å¾®å°é”™è¯¯éƒ½å¯èƒ½å¯¼è‡´ç¾éš¾æ€§çš„å®‰å…¨æ¼æ´ã€‚</li><li><strong>ä¼˜å…ˆä½¿ç”¨å°è£…å¥½çš„é«˜çº§åº“</strong>ï¼šå¦‚ <code>OpenPSI</code>, <code>FALCON-PSI</code>ï¼Œå®ƒä»¬æä¾›äº†æ˜“äºä½¿ç”¨çš„æ¥å£ã€‚</li><li><strong>éœ€è¦æè‡´å®šåˆ¶æˆ–ç ”ç©¶</strong>ï¼šå¯ä»¥æ·±å…¥æ›´åº•å±‚çš„åº“ï¼Œå¦‚ <code>libOTe</code>ã€‚</li></ul></li></ol><hr><h2 id="æœªæ¥å±•æœ›"><a href="#æœªæ¥å±•æœ›" class="headerlink" title="æœªæ¥å±•æœ›"></a>æœªæ¥å±•æœ›</h2><p>éšç§é›†åˆæ±‚äº¤æ˜¯ä¸€ä¸ªæ´»è·ƒçš„ç ”ç©¶é¢†åŸŸï¼Œä»åœ¨ä¸æ–­æ¼”è¿›ã€‚</p><ul><li>**æŠ—é‡å­å¯†ç  (Post-Quantum PSI)**ï¼šå½“å‰ä¸»æµçš„å…¬é’¥æ–¹æ¡ˆï¼ˆDH, OTï¼‰éƒ½åŸºäºä¼ ç»Ÿæ•°è®ºéš¾é¢˜ï¼Œåœ¨æœªæ¥å¯èƒ½å—åˆ°é‡å­è®¡ç®—æœºçš„å¨èƒã€‚å­¦æœ¯ç•Œæ­£åœ¨ç§¯æç ”ç©¶åŸºäºæ ¼å¯†ç ï¼ˆLatticesï¼‰ç­‰æŠ—é‡å­å›°éš¾é—®é¢˜çš„ PSI æ–°èŒƒå¼ã€‚</li><li>**ç¡¬ä»¶åŠ é€Ÿ (Hardware Acceleration)**ï¼šä¸ºäº†è¿›ä¸€æ­¥çªç ´æ€§èƒ½ç“¶é¢ˆï¼Œç ”ç©¶è€…ä»¬æ­£åœ¨æ¢ç´¢ä½¿ç”¨ GPUã€FPGA ç­‰ä¸“ç”¨ç¡¬ä»¶æ¥åŠ é€Ÿåº•å±‚å¤æ‚çš„å¯†ç å­¦è¿ç®—ï¼ˆå¦‚OTeã€æ¤­åœ†æ›²çº¿ç‚¹ä¹˜ï¼‰ï¼Œä»¥æ»¡è¶³æ›´å¤§è§„æ¨¡ã€æ›´ä½å»¶è¿Ÿçš„å®æ—¶è®¡ç®—éœ€æ±‚ã€‚</li></ul><hr><h2 id="èµ„æºä¸åº“"><a href="#èµ„æºä¸åº“" class="headerlink" title="èµ„æºä¸åº“"></a>èµ„æºä¸åº“</h2><p>è¦äº²æ‰‹å®ç°å®‰å…¨çš„ PSI åè®®ï¼Œå»ºè®®ç›´æ¥ä½¿ç”¨ç»è¿‡åŒè¡Œè¯„å®¡å’Œç¤¾åŒºè€ƒéªŒçš„å¼€æºåº“ï¼Œè€Œä¸æ˜¯è‡ªå·±é€ è½®å­ã€‚</p><ul><li><strong>libOTe (C++)</strong>: ç›®å‰æœ€çŸ¥åå’Œæœ€é«˜æ€§èƒ½çš„ OT åº“ä¹‹ä¸€ï¼Œæ˜¯è®¸å¤šå…¶ä»–åº“çš„åŸºç¡€ã€‚</li><li><strong>OpenPSI (C++)</strong>: ä¸€ä¸ªå°è£…äº†å¤šç§ PSI åè®®ï¼ˆåŒ…æ‹¬åŸºäº OT çš„ï¼‰çš„å¼€æºåº“ï¼Œç›¸å¯¹æ˜“äºä½¿ç”¨ã€‚</li><li><strong>FALCON-PSI (Python&#x2F;C++)</strong>: å¾®è½¯ç ”ç©¶é™¢ç­‰æœºæ„æ¨å‡ºçš„é«˜æ€§èƒ½ PSI åº“ã€‚</li></ul><h2 id="ä¸šç•Œäº§å“"><a href="#ä¸šç•Œäº§å“" class="headerlink" title="ä¸šç•Œäº§å“"></a>ä¸šç•Œäº§å“</h2><p><a href="https://m.jrj.com.cn/toutiao/2022/3/17/34839331.shtml">https://m.jrj.com.cn/toutiao/2022/3/17/34839331.shtml</a></p>]]></content>
      
      
      <categories>
          
          <category> å¤§æ•°æ® </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Hadoopç”Ÿæ€ï¼šYARNã€HDFSã€Hiveã€Sparkã€HBaseæ˜¯å¦‚ä½•ååŒå·¥ä½œçš„ï¼Ÿ</title>
      <link href="/2025/06/18/hadoop-ecosystem-explained/"/>
      <url>/2025/06/18/hadoop-ecosystem-explained/</url>
      
        <content type="html"><![CDATA[<p>æˆ‘æƒ³åˆšæ¥è§¦å¤§æ•°æ®é¢†åŸŸçš„åŒå­¦ï¼Œå¸¸å¸¸è¢«ä¸€å †åè¯ç ¸æ™•ï¼šHadoopã€HDFSã€YARNã€Hiveã€Sparkã€HBaseâ€¦ ã€ä¸œè¥¿ä¹Ÿå¤ªå¤šäº†å§ã€‘ï¼Œä¸ªä¸ªçœ‹èµ·æ¥éƒ½å¾ˆæœ‰ç”¨ï¼Œä½†å½¼æ­¤ä¹‹é—´åˆ°åº•æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿè·‘ä¸€ä¸ªä½œä¸šçš„æ—¶å€™ï¼Œæ•°æ®å’ŒæŒ‡ä»¤åˆæ˜¯åœ¨å®ƒä»¬ä¹‹é—´å¦‚ä½•æµè½¬çš„ï¼Ÿ</p><p>è¿™ç¯‡æ–‡ç« ä¸æ‰“ç®—è®²åŸç†è®²æ¦‚å¿µï¼Œæˆ‘ä»¬å°±ä»ä¸€ä¸ªå¼€å‘è€…çš„è§’åº¦ï¼Œç”¨ä¸€ä¸ªå¥½ç†è§£çš„ç±»æ¯”ï¼ŒæŠŠè¿™å‡ ä½çš„å…³ç³»æ‹æ¸…æ¥šã€‚</p><h3 id="ä¸€ä¸ªå…¬å¸è¿ä½œçš„ç±»æ¯”"><a href="#ä¸€ä¸ªå…¬å¸è¿ä½œçš„ç±»æ¯”" class="headerlink" title="ä¸€ä¸ªå…¬å¸è¿ä½œçš„ç±»æ¯”"></a>ä¸€ä¸ªå…¬å¸è¿ä½œçš„ç±»æ¯”</h3><p>æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬å¼€äº†ä¸€å®¶å¤§å‹çš„äº’è”ç½‘å…¬å¸ï¼Œè¿™å®¶å…¬å¸å°±æ˜¯æˆ‘ä»¬çš„ <strong>Hadoopé›†ç¾¤</strong>ã€‚</p><ul><li><p><strong>HDFS (Hadoop Distributed File System)<strong>ï¼šè¿™æ˜¯å…¬å¸çš„</strong>å·¨å‹ä¸­å¤®ä»“åº“</strong>ã€‚æ‰€æœ‰éƒ¨é—¨çš„æ•°æ®ã€èµ„æ–™ã€å†å²æ–‡æ¡£ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„æ•°æ®ï¼Œå„ç§ç»“æ„åŒ–æˆ–è€…åŠç»“æ„åŒ–çš„æ•°æ®éƒ½å¯ä»¥ï¼‰éƒ½å †åœ¨è¿™é‡Œã€‚è¿™ä¸ªä»“åº“éå¸¸å¤§ï¼Œç”±å¾ˆå¤šä¸ªæ™®é€šçš„è´§æ¶ï¼ˆæœåŠ¡å™¨ç¡¬ç›˜ï¼‰ç»„æˆï¼Œä½†å¯¹å¤–çœ‹èµ·æ¥æ˜¯ä¸€ä¸ªæ•´ä½“ã€‚å®ƒæœ‰ä¸ªç®¡ç†å‘˜ï¼ˆNameNodeï¼‰ï¼ŒçŸ¥é“æ¯ä¸ªèµ„æ–™ï¼ˆæ•°æ®å—ï¼‰æ”¾åœ¨äº†å“ªä¸ªè´§æ¶çš„å“ªä¸ªä½ç½®ï¼Œè¿˜åšäº†å¤‡ä»½ï¼Œé˜²æ­¢èµ„æ–™ä¸¢å¤±ã€‚å®ƒçš„ç‰¹ç‚¹æ˜¯ï¼šå­˜ä¸œè¥¿å’Œæ•´æ‰¹å–ä¸œè¥¿å¾ˆæ–¹ä¾¿ï¼Œä½†ä½ è¦æ˜¯æƒ³åœ¨æŸä¸ªæ–‡ä»¶ä¸­é—´æ”¹ä¸ªå­—ï¼Œå°±å¤ªéš¾äº†ã€‚</p></li><li><p><strong>YARN (Yet Another Resource Negotiator)<strong>ï¼šè¿™æ˜¯å…¬å¸çš„</strong>è¡Œæ”¿å’ŒäººåŠ›èµ„æºéƒ¨</strong>ã€‚å®ƒä¸è´Ÿè´£å…·ä½“çš„ä¸šåŠ¡ï¼Œä½†æŒç®¡ç€å…¬å¸æ‰€æœ‰çš„èµ„æºï¼šåº§ä½ï¼ˆCPUï¼‰ã€ç½‘ç»œï¼ˆå†…å­˜ï¼‰ã€ä¼šè®®å®¤ï¼ˆè®¡ç®—æ§½ä½ï¼‰ç­‰ã€‚å“ªä¸ªé¡¹ç›®ç»„ï¼ˆæ¯”å¦‚Sparkæˆ–MapReduceä½œä¸šï¼‰éœ€è¦å¤šå°‘äººæ‰‹å’Œåœ°æ–¹æ¥å¹²æ´»ï¼Œéƒ½å¾—å‘YARNç”³è¯·ã€‚YARNæ‰¹å‡†ï¼Œç„¶åé¡¹ç›®ç»„æ‰èƒ½æ‹¿åˆ°èµ„æºå¼€å·¥ã€‚å®ƒè®©å…¬å¸çš„èµ„æºèƒ½å¤Ÿè¢«ä¸åŒé¡¹ç›®ç»„å…±äº«ï¼Œå¤§å¤§æé«˜äº†åˆ©ç”¨ç‡ã€‚</p></li><li><p><strong>è®¡ç®—å¼•æ“ (MapReduce&#x2F;Spark)<strong>ï¼šè¿™äº›å°±æ˜¯å…¬å¸é‡Œçš„å„ä¸ª</strong>é¡¹ç›®ç»„&#x2F;ä¸šåŠ¡çº¿</strong>ã€‚å®ƒä»¬æ˜¯çœŸæ­£å¹²æ´»çš„ã€‚</p><ul><li><strong>MapReduce</strong>ï¼šå¯ä»¥çœ‹ä½œæ˜¯å…¬å¸çš„<strong>ä¼ ç»Ÿä¸šåŠ¡çº¿</strong>ã€‚å®ƒåšäº‹æ‰‹æ³•å¾ˆç®€å•ï¼Œåªæœ‰ â€œåˆ†æ‹£ï¼ˆMapï¼‰â€å’Œâ€æ±‡æ€»ï¼ˆReduceï¼‰â€ä¸¤ä¸ªå›ºå®šæ­¥éª¤ï¼Œå¤„ç†æµ·é‡æ•°æ®æ²¡é—®é¢˜ï¼Œä½†å°±æ˜¯æµç¨‹æœ‰ç‚¹æ­»æ¿ï¼Œé€Ÿåº¦ä¹Ÿæ¯”è¾ƒæ…¢ï¼ˆä¸­é—´ç»“æœè¦é¢‘ç¹å†™å…¥ä»“åº“HDFSå¯¼è‡´é€Ÿåº¦ä¸è¡Œï¼‰</li><li><strong>Spark</strong>ï¼šè¿™æ˜¯æ–°æ¥çš„<strong>é¡¹ç›®ç»„</strong>ã€‚è„‘å­å¿«ï¼ˆåŸºäºå†…å­˜è®¡ç®—ï¼‰ï¼Œåå…«èˆ¬æ­¦è‰ºæ ·æ ·ç²¾é€šï¼ˆæ”¯æŒæ‰¹å¤„ç†ã€æµè®¡ç®—ã€æœºå™¨å­¦ä¹ ç­‰ï¼‰ã€‚å®ƒå¹²æ´»æ•ˆç‡æé«˜ï¼Œå› ä¸ºå¾ˆå¤šä¸­é—´è¿‡ç¨‹åœ¨å†…å­˜ä¸Šå°±å®Œæˆäº†ï¼Œä¸ç”¨æ€»æ˜¯èµ°HDFSã€ç£ç›˜ã€‘ï¼Œæ¯”è¾ƒç±»ä¼¼flinkã€‚</li></ul></li><li><p><strong>Hive</strong>ï¼šè¿™æ˜¯å…¬å¸çš„<strong>æ•°æ®åˆ†æéƒ¨</strong>ã€‚æ•°æ®åˆ†æå¸ˆä»¬æ“…é•¿ç”¨SQLå†™æŠ¥è¡¨ï¼Œä½†ä»–ä»¬ä¸äº†è§£ç”Ÿäº§çº¿ï¼ˆMapReduce&#x2F;Sparkï¼‰ä¸Šå¤æ‚çš„å¤„ç†ã€‚äºæ˜¯Hiveå°±è¯ç”Ÿäº†ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªSQLæŸ¥è¯¢çš„çª—å£ã€‚åˆ†æå¸ˆæŠŠSQLæŠ¥è¡¨éœ€æ±‚ç»™Hiveï¼ŒHiveå°±ä¼šæŠŠè¿™ä¸ªSQLç¿»è¯‘æˆç”Ÿäº§çº¿èƒ½å¬æ‡‚çš„â€æŒ‡ä»¤â€ï¼ˆMapReduceæˆ–Sparkä»»åŠ¡ï¼‰ï¼Œç„¶åäº¤ç»™YARNå»è°ƒåº¦èµ„æºæ‰§è¡Œã€‚æ‰€ä»¥ï¼Œ<strong>Hiveæœ¬èº«ä¸è®¡ç®—ï¼Œå®ƒæ˜¯ä¸ªç¿»è¯‘å®˜å’Œä»»åŠ¡æäº¤å·¥å…·</strong>ã€‚</p></li><li><p><strong>HBase</strong>ï¼šè¿™æ˜¯å…¬å¸çš„<strong>å‰å°å®æ—¶æŸ¥è¯¢ç³»ç»Ÿ&#x2F;æ¡£æ¡ˆå®¤</strong>ã€‚å½“å®¢æœéœ€è¦åœ¨ä¸€ç§’å†…æŸ¥åˆ°æŸä¸ªå®¢æˆ·çš„è¯¦ç»†ä¿¡æ¯æ—¶ï¼Œä½ æ€»ä¸èƒ½è®©æ•°æ®åˆ†æéƒ¨ï¼ˆHiveï¼‰å»ä»“åº“ï¼ˆHDFSï¼‰é‡ŒæŠŠæ‰€æœ‰å®¢æˆ·æ•°æ®ç¿»ä¸€éå§ï¼Ÿé‚£å¾—ç­‰åˆ°çŒ´å¹´é©¬æœˆã€‚HBaseå°±æ˜¯è§£å†³è¿™ä¸ªé—®é¢˜çš„ï¼Œå®ƒä¹ŸæŠŠæ•°æ®å­˜åœ¨HDFSå¤§ä»“åº“é‡Œï¼Œä½†å®ƒç”¨ä¸€ç§ç‰¹æ®Šçš„æ–¹å¼ï¼ˆåˆ—å¼å­˜å‚¨ã€ç´¢å¼•ï¼‰æ•´ç†äº†è¿™äº›æ•°æ®ï¼Œè®©ä½ èƒ½åƒæŸ¥æ•°æ®åº“ä¸€æ ·ï¼Œæ¯«ç§’çº§åœ°æ‰¾åˆ°ä½ æƒ³è¦çš„é‚£ä¸€è¡Œæˆ–é‚£å‡ è¡Œæ•°æ®ã€‚å®ƒä¸“é—¨è´Ÿè´£<strong>å®æ—¶ã€é«˜å¹¶å‘çš„éšæœºè¯»å†™</strong>ã€‚</p></li></ul><h3 id="å®ƒä»¬çš„å…³ç³»å›¾"><a href="#å®ƒä»¬çš„å…³ç³»å›¾" class="headerlink" title="å®ƒä»¬çš„å…³ç³»å›¾"></a>å®ƒä»¬çš„å…³ç³»å›¾</h3><p>ç”¨ä¸€å¼ å›¾æ¥è¡¨ç¤ºå®ƒä»¬çš„å…³ç³»ï¼Œä¼šæ›´æ¸…æ™°ï¼š</p><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    subgraph &quot;Hadoop Cluster (åŸºç¡€è®¾æ–½)&quot;        YARN(&quot;YARN (èµ„æºè°ƒåº¦ä¸­å¿ƒ)&quot;)        HDFS(&quot;HDFS (ç»Ÿä¸€æ•°æ®å­˜å‚¨)&quot;)    end    subgraph &quot;Computing Engines (è®¡ç®—å¼•æ“)&quot;        Spark(&quot;Spark (å¿«é€Ÿé€šç”¨è®¡ç®—)&quot;)        MapReduce(&quot;MapReduce (ä¼ ç»Ÿæ‰¹å¤„ç†)&quot;)    end    subgraph &quot;Applications (ä¸Šå±‚åº”ç”¨)&quot;        Hive(&quot;Hive (æ•°æ®ä»“åº“&#x2F;SQLæ¥å£)&quot;)        HBase(&quot;HBase (NoSQLå®æ—¶æ•°æ®åº“)&quot;)        OtherApps(&quot;å…¶ä»–åº”ç”¨ Flink, etc.&quot;)    end    Hive -- &quot;ç¿»è¯‘æˆ&quot; --&gt; Spark    Hive -- &quot;ç¿»è¯‘æˆ&quot; --&gt; MapReduce    Spark -- &quot;è¯»å†™æ•°æ®&quot; --&gt; HDFS    MapReduce -- &quot;è¯»å†™æ•°æ®&quot; --&gt; HDFS    HBase -- &quot;åº•å±‚å­˜å‚¨&quot; --&gt; HDFS    Spark -- &quot;ç”³è¯·èµ„æºè¿è¡Œäº&quot; --&gt; YARN    MapReduce -- &quot;ç”³è¯·èµ„æºè¿è¡Œäº&quot; --&gt; YARN    HBase -- &quot;æœåŠ¡è¿è¡Œäº&quot; --&gt; YARN    subgraph User        Developer(&quot;å¼€å‘è€…&#x2F;åˆ†æå¸ˆ&quot;)    end    Developer -- &quot;å†™SQL&quot; --&gt; Hive    Developer -- &quot;å†™ä»£ç &quot; --&gt; Spark    Developer -- &quot;å®æ—¶è¯»å†™&quot; --&gt; HBase  </pre></div><h3 id="ä¸€ä¸ªä½œä¸šçš„æ—…ç¨‹ï¼šå½“ä½ åœ¨Hiveé‡Œæ•²ä¸‹å›è½¦"><a href="#ä¸€ä¸ªä½œä¸šçš„æ—…ç¨‹ï¼šå½“ä½ åœ¨Hiveé‡Œæ•²ä¸‹å›è½¦" class="headerlink" title="ä¸€ä¸ªä½œä¸šçš„æ—…ç¨‹ï¼šå½“ä½ åœ¨Hiveé‡Œæ•²ä¸‹å›è½¦"></a>ä¸€ä¸ªä½œä¸šçš„æ—…ç¨‹ï¼šå½“ä½ åœ¨Hiveé‡Œæ•²ä¸‹å›è½¦</h3><p>ç°åœ¨ï¼Œæˆ‘ä»¬æŠŠä¸Šé¢çš„æ‰€æœ‰ä¸œè¥¿ä¸²èµ·æ¥ï¼Œçœ‹çœ‹å½“ä¸€ä¸ªæ•°æ®åˆ†æå¸ˆæ‰§è¡Œä¸€ä¸ªHive SQLæŸ¥è¯¢æ—¶ï¼Œåˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆã€‚</p><p><strong>åœºæ™¯</strong>ï¼šåˆ†æå¸ˆæƒ³ç»Ÿè®¡æ¯ä¸ªå›½å®¶çš„ç”¨æˆ·æ•°é‡ã€‚</p><p><strong>SQL</strong>: <code>SELECT country, COUNT(*) FROM user_logs GROUP BY country;</code></p><ol><li><p><strong>æäº¤æŸ¥è¯¢</strong>: åˆ†æå¸ˆåœ¨Hiveçš„å®¢æˆ·ç«¯ï¼ˆæ¯”å¦‚Beelineï¼‰é‡Œè¾“å…¥SQLï¼Œæ•²ä¸‹å›è½¦ã€‚</p></li><li><p><strong>Hiveå¤„ç†</strong>: Hive Serveræ¥æ”¶åˆ°è¿™ä¸ªSQLã€‚å®ƒé¦–å…ˆä¼šæ£€æŸ¥è¯­æ³•å¯¹ä¸å¯¹ï¼Œç„¶åæŸ¥è¯¢å®ƒçš„å…ƒæ•°æ®ï¼ˆMetastoreï¼Œè®°å½•äº†<code>user_logs</code>è¡¨åœ¨å“ªï¼Œä»€ä¹ˆæ ¼å¼ç­‰ï¼‰ï¼Œç”Ÿæˆä¸€ä¸ªæ‰§è¡Œè®¡åˆ’ã€‚è¿™ä¸ªè®¡åˆ’æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæœ‰å‘æ— ç¯å›¾ï¼ˆDAGï¼‰ï¼Œæè¿°äº†éœ€è¦å‡ æ­¥ã€æ¯æ­¥å¹²ä»€ä¹ˆæ‰èƒ½å®Œæˆè¿™ä¸ªè®¡ç®—ã€‚</p></li><li><p><strong>å‘YARNç”³è¯·â€åŒ…å·¥å¤´â€</strong>: Hiveï¼ˆæˆ–è€…è¯´å®ƒé…ç½®çš„æ‰§è¡Œå¼•æ“ï¼Œæ¯”å¦‚Tezæˆ–Sparkï¼‰ä½œä¸ºä¸€ä¸ªYARNå®¢æˆ·ç«¯ï¼Œå‘YARNçš„<strong>ResourceManagerï¼ˆèµ„æºæ€»ç®¡ï¼‰</strong> å‘èµ·è¯·æ±‚ï¼šâ€æˆ‘æœ‰ä¸ªå¤§æ´»å„¿ï¼Œéœ€è¦å¯åŠ¨ä¸€ä¸ªâ€™åŒ…å·¥å¤´â€™ï¼ˆApplicationMasterï¼‰ï¼Œè¯·ç»™æˆ‘åˆ†é…ç‚¹èµ„æºã€‚â€</p></li><li><p><strong>YARNå¯åŠ¨â€åŒ…å·¥å¤´â€</strong>: ResourceManagerä¸€çœ‹æœ‰åé¢ï¼Œå°±åœ¨é›†ç¾¤é‡Œæ‰¾ä¸€ä¸ªä¸é‚£ä¹ˆå¿™çš„èŠ‚ç‚¹ï¼ˆNodeManagerï¼‰ï¼Œåœ¨ä¸Šé¢å¯åŠ¨ä¸€ä¸ªContainerï¼ˆå®¹å™¨ï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªéš”ç¦»çš„è¿›ç¨‹ç©ºé—´ï¼‰ï¼Œå¹¶æŠŠApplicationMasterï¼ˆAMï¼‰ç»™è¿è¡Œèµ·æ¥ã€‚</p></li><li><p><strong>åŒ…å·¥å¤´ç”³è¯·å·¥äºº</strong>: è¿™ä¸ªAMå°±æ˜¯æœ¬æ¬¡ä½œä¸šçš„æ€»æŒ‡æŒ¥ã€‚å®ƒä¼šåˆ†æåˆšæ‰Hiveç”Ÿæˆçš„æ‰§è¡Œè®¡åˆ’ï¼Œçœ‹çœ‹å…·ä½“éœ€è¦å¤šå°‘â€å·¥äººâ€ï¼ˆè®¡ç®—ä»»åŠ¡ï¼‰ï¼Œæ¯ä¸ªå·¥äººéœ€è¦å¤šå°‘èµ„æºã€‚ç„¶åå®ƒä¼šåˆ†æ‰¹å‘ResourceManagerå»ç”³è¯·ï¼šâ€è€æ¿ï¼Œæˆ‘éœ€è¦10ä¸ªå·¥äººï¼Œæ¯äººåˆ†é…1GBå†…å­˜å’Œ1ä¸ªCPUã€‚â€</p></li><li><p><strong>YARNåˆ†é…å·¥äºº</strong>: ResourceManagerå†æ¬¡åœ¨é›†ç¾¤çš„å„ä¸ªNodeManagerä¸Šåˆ†é…Containerä½œä¸ºâ€å·¥ä½â€ç»™è¿™äº›å·¥äººã€‚</p></li><li><p><strong>å·¥äººå¼€å·¥</strong>: AMæ‹¿åˆ°â€å·¥ä½â€åˆ—è¡¨åï¼Œç›´æ¥è·Ÿå¯¹åº”çš„NodeManageré€šä¿¡ï¼Œè®©å®ƒä»¬åœ¨è¿™äº›Containeré‡Œå¯åŠ¨çœŸæ­£çš„è®¡ç®—ä»»åŠ¡ï¼ˆTaskï¼‰ã€‚è¿™äº›ä»»åŠ¡ä¼šä»<strong>HDFS</strong>ä¸Šè¯»å–<code>user_logs</code>è¡¨çš„æ•°æ®å—ã€‚YARNä¼šå°½å¯èƒ½åœ°è®©ä»»åŠ¡åœ¨æ•°æ®æ‰€åœ¨çš„èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œè¿™å°±æ˜¯æ‰€è°“çš„â€è®¡ç®—å‘æ•°æ®ç§»åŠ¨â€ï¼Œä»¥å‡å°‘ç½‘ç»œä¼ è¾“å¼€é”€ã€‚</p></li><li><p><strong>æ•°æ®å¤„ç†ä¸æ±‡æ€»</strong>:</p><ul><li><strong>Mapé˜¶æ®µ</strong>ï¼šå„ä¸ªä»»åŠ¡ï¼ˆå·¥äººï¼‰è¯»å–è‡ªå·±åˆ†åˆ°çš„æ•°æ®ï¼Œè§£æå‡º<code>country</code>ï¼Œç„¶åè¾“å‡º <code>(country, 1)</code> è¿™æ ·çš„é”®å€¼å¯¹ã€‚</li><li><strong>Shuffle&#x2F;Reduceé˜¶æ®µ</strong>ï¼šYARNå’Œæ‰§è¡Œå¼•æ“è´Ÿè´£å°†ç›¸åŒ<code>country</code>çš„æ•°æ®æ‹‰åˆ°ä¸€èµ·ï¼Œç„¶åäº¤ç»™Reduceä»»åŠ¡å»åšæœ€ç»ˆçš„<code>COUNT(*)</code>æ±‡æ€»ã€‚</li></ul></li><li><p><strong>è¾“å‡ºç»“æœ</strong>: æœ€ç»ˆçš„ç»Ÿè®¡ç»“æœï¼Œå¯èƒ½ä¼šè¢«å†™å›åˆ°HDFSçš„ä¸€ä¸ªæ–°æ–‡ä»¶é‡Œï¼Œæˆ–è€…ç›´æ¥é€šè¿‡ç½‘ç»œè¿”å›ç»™åˆ†æå¸ˆçš„Hiveå®¢æˆ·ç«¯ã€‚</p></li><li><p><strong>é‡Šæ”¾èµ„æº</strong>: ä½œä¸šå®Œæˆåï¼ŒAMå‘ResourceManageræ³¨é”€è‡ªå·±ï¼Œæ‰€æœ‰å®ƒç”³è¯·çš„Containerä¹Ÿéƒ½è¢«YARNå›æ”¶ï¼Œèµ„æºè¢«é‡Šæ”¾å‡ºæ¥ç»™å…¶ä»–ä½œä¸šä½¿ç”¨ã€‚</p></li></ol><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>å¥½äº†ï¼Œç°åœ¨æˆ‘ä»¬å†å›é¡¾ä¸€ä¸‹ï¼š</p><ul><li><strong>HDFS</strong>æ˜¯åœ°åŸºï¼Œè´Ÿè´£å­˜ã€‚</li><li><strong>YARN</strong>æ˜¯ç®¡å®¶ï¼Œè´Ÿè´£è°ƒåº¦èµ„æºã€‚</li><li><strong>Spark</strong>å’Œ<strong>MapReduce</strong>æ˜¯å·¥äººï¼Œè´Ÿè´£ç®—ã€‚</li><li><strong>Hive</strong>æ˜¯é¡¹ç›®ç»ç†ï¼ŒæŠŠå¤§é¢†å¯¼çš„æ„å›¾ï¼ˆSQLï¼‰ç¿»è¯‘æˆå·¥äººèƒ½æ‡‚çš„è¯­è¨€ï¼Œç„¶åäº¤ç»™ç®¡å®¶å»å®‰æ’ã€‚</li><li><strong>HBase</strong>æ˜¯æ¡£æ¡ˆç®¡ç†å‘˜ï¼Œè´Ÿè´£å¿«é€ŸæŸ¥æ‰¾å’Œå­˜å–ç‰¹å®šè®°å½•ã€‚</li></ul><p>å®ƒä»¬å…±åŒæ„æˆäº† å¸¸è§çš„ç¦»çº¿å¤§æ•°æ®å¤„ç†å¹³å°ã€‚ </p>]]></content>
      
      
      <categories>
          
          <category> å¤§æ•°æ® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HDFS </tag>
            
            <tag> Spark </tag>
            
            <tag> å¤§æ•°æ® </tag>
            
            <tag> Hadoop </tag>
            
            <tag> Hive </tag>
            
            <tag> YARN </tag>
            
            <tag> HBase </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åˆå­¦Hive</title>
      <link href="/2025/06/18/hive%20%E5%AD%A6%E4%B9%A0/"/>
      <url>/2025/06/18/hive%20%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>èŠåˆ°å¤§æ•°æ®å¤„ç†ï¼ŒHadoop æ˜¯ç»•ä¸å¼€çš„è¯é¢˜ï¼Œè€Œæåˆ° Hadoop ç”Ÿæ€ï¼Œå°±ä¸å¾—ä¸è¯´ Hiveã€‚è¿™ç©æ„å„¿åˆ°åº•æ˜¯å•¥ï¼Ÿç®€å•æ¥è¯´ï¼ŒHive å°±æ˜¯ä¸€ä¸ªèƒ½è®©ä½ ç”¨ç±»ä¼¼ SQL çš„è¯­è¨€ï¼ˆå« HQLï¼‰å»æŸ¥ HDFS ä¸Šæµ·é‡æ•°æ®çš„å·¥å…·ã€‚å¯¹äºç†Ÿæ‚‰ SQL çš„äººæ¥è¯´ï¼Œè¿™æå¤§é™ä½äº†æ•°æ®åˆ†æçš„é—¨æ§›ï¼Œä¸ç”¨ä¸Šæ¥å°±æ‰‹å†™å¤æ‚çš„ MapReduce ç¨‹åºäº†ã€‚</p><p>ä½†è¿™å¹¶ä¸æ„å‘³ç€ Hive æ˜¯ä¸‡èƒ½çš„ã€‚å®ƒè·‘çš„æ˜¯ MapReduceï¼ˆæˆ–è€… Tezã€Sparkï¼‰ï¼Œå¤©ç”Ÿå°±æ˜¯ä¸ºæ‰¹å¤„ç†è®¾è®¡çš„ï¼Œæ‰€ä»¥åˆ«æŒ‡æœ›å®ƒèƒ½æœ‰æ¯«ç§’çº§çš„å®æ—¶æŸ¥è¯¢å“åº”ï¼Œé‚£ä¸æ˜¯å®ƒçš„æ´»ã€‚</p><h3 id="Hive-èƒ½å¹²å•¥ï¼Ÿ"><a href="#Hive-èƒ½å¹²å•¥ï¼Ÿ" class="headerlink" title="Hive èƒ½å¹²å•¥ï¼Ÿ"></a>Hive èƒ½å¹²å•¥ï¼Ÿ</h3><p>Hive æœ¬èº«ä¸å­˜å‚¨æ•°æ®ï¼Œå®ƒæ›´åƒä¸€ä¸ªæ•°æ®ç›®å½•å’ŒæŸ¥è¯¢å¼•æ“ã€‚å®ƒèƒ½å¤„ç†çš„æ•°æ®å’Œæ–‡ä»¶ç±»å‹å…¶å®éå¸¸çµæ´»ï¼š</p><ul><li><strong>æ•°æ®æº</strong>: ä¸»è¦å¤„ç†å­˜å‚¨åœ¨ HDFS ä¸Šçš„ç»“æ„åŒ–æˆ–åŠç»“æ„åŒ–æ•°æ®ã€‚</li><li><strong>æ–‡ä»¶æ ¼å¼</strong>: é»˜è®¤å¯ä»¥ç›´æ¥åŠ è½½æ–‡æœ¬æ–‡ä»¶ï¼ˆTEXTFILEï¼‰ï¼Œä½ åªéœ€è¦åœ¨å»ºè¡¨æ—¶å‘Šè¯‰ Hive æ•°æ®çš„åˆ—åˆ†éš”ç¬¦å’Œè¡Œåˆ†éš”ç¬¦ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå®ƒä¹Ÿæ”¯æŒæ›´é«˜æ•ˆçš„åˆ—å¼å­˜å‚¨æ ¼å¼ï¼Œå¦‚ <strong>ORC</strong> å’Œ <strong>Parquet</strong>ï¼Œä»¥åŠ <strong>SequenceFile</strong>ã€<strong>RCFile</strong> ç­‰ã€‚ç”¨å¥½è¿™äº›æ ¼å¼å¯¹æ€§èƒ½æå‡æœ‰å¾ˆå¤§å¸®åŠ©ã€‚</li></ul><p>æ ¸å¿ƒæ€æƒ³æ˜¯ **â€Schema on Readâ€**ã€‚æ•°æ®å¯ä»¥å°±æ˜¯ä¸€å †æ™®æ™®é€šé€šçš„æ–‡æœ¬æ–‡ä»¶ï¼Œåœ¨ä½ æŸ¥è¯¢çš„æ—¶å€™ï¼ŒHive æ‰æ ¹æ®è¡¨çš„å®šä¹‰ï¼ˆå…ƒæ•°æ®ï¼‰æ¥è§£æè¿™äº›æ–‡ä»¶ï¼Œè€Œä¸æ˜¯åœ¨å†™å…¥æ—¶å°±å¼ºåˆ¶æ ¡éªŒæ ¼å¼ã€‚</p><h3 id="è¿è¡Œæ¶æ„"><a href="#è¿è¡Œæ¶æ„" class="headerlink" title="è¿è¡Œæ¶æ„"></a>è¿è¡Œæ¶æ„</h3><p>Hive çš„æ¶æ„å¯ä»¥æ‹†æˆå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¸¤éƒ¨åˆ†ã€‚æˆ‘ä»¬å¯ä»¥ç”¨ä¸‹é¢è¿™å¼ å›¾æ¥ç†è§£å®ƒçš„æ ¸å¿ƒç»„ä»¶ï¼š</p><pre class="mermaid">graph TD    subgraph Client [å®¢æˆ·ç«¯]        A[CLI]        B[JDBC/ODBC]        C[Web UI]    end    subgraph HiveServer [Hive æœåŠ¡ç«¯]        D[Thrift Server]        E[Driver]        F[Metastore]    end    subgraph HadoopEcosystem [Hadoop ç”Ÿæ€]        G[HDFS]        H[YARN / MapReduce]    end    Client --> D    D --> E    E --> H    E -- "å…ƒæ•°æ®è¯·æ±‚" --> F    F -- "å…ƒæ•°æ®å­˜å‚¨" --> RDB[(MySQL/Postgres)]    H -- "è¯»å†™æ•°æ®" --> G</pre><p><strong>æœåŠ¡ç«¯ç»„ä»¶ (Server-side Components):</strong></p><ul><li><strong>Driver</strong>: è¿™æ˜¯ Hive çš„å¤§è„‘ï¼Œè´Ÿè´£æŠŠä½ çš„ HQL æå®šã€‚å®ƒé‡Œé¢åˆåŒ…å«å‡ ä¸ªå°å¼Ÿï¼š<ul><li><strong>Complier (ç¼–è¯‘å™¨)</strong>: æŠŠ HQL è¯­å¥è§£ææˆè¯­æ³•æ ‘ï¼Œç„¶åç”Ÿæˆä¸€ä¸ªæ‰§è¡Œè®¡åˆ’ã€‚</li><li><strong>Optimizer (ä¼˜åŒ–å™¨)</strong>: å¯¹æ‰§è¡Œè®¡åˆ’è¿›è¡Œä¼˜åŒ–ï¼Œæ¯”å¦‚æ€ä¹ˆåš Join æ›´å¿«ã€‚</li><li><strong>Executor (æ‰§è¡Œå™¨)</strong>: æŠŠæœ€ç»ˆçš„æ‰§è¡Œè®¡åˆ’äº¤ç»™ Hadoop å»è¿è¡Œã€‚</li></ul></li><li><strong>Metastore (å…ƒæ•°æ®å­˜å‚¨)</strong>: è¿™æ˜¯ Hive çš„æ ¸å¿ƒï¼Œå­˜ç€æ‰€æœ‰è¡¨çš„ä¿¡æ¯ï¼Œæ¯”å¦‚è¡¨åã€åˆ—ã€æ•°æ®ç±»å‹ã€åˆ†åŒºä¿¡æ¯ã€æ•°æ®åœ¨ HDFS çš„å“ªä¸ªä½ç½®ç­‰ç­‰ã€‚å®ƒé€šå¸¸ä¼šç”¨ä¸€ä¸ªæ­£ç»çš„å…³ç³»å‹æ•°æ®åº“ï¼ˆæ¯”å¦‚ MySQLï¼‰æ¥å­˜è¿™äº›ä¿¡æ¯ï¼Œä¿è¯ç¨³å®šå¯é ã€‚æŠŠ Metastore ç‹¬ç«‹å‡ºæ¥ï¼Œä¹Ÿè®© Hive å˜å¾—æ›´å¥å£®ã€‚</li><li><strong>Thrift Server</strong>: è¿™ç©æ„å„¿æä¾›äº†ä¸€ä¸ª RPC æ¥å£ï¼Œè®©å„ç§è¯­è¨€ï¼ˆJava, Python ç­‰ï¼‰çš„å®¢æˆ·ç«¯éƒ½èƒ½è¿œç¨‹è¿æ¥åˆ° Hive å¹¶æäº¤æŸ¥è¯¢ã€‚</li></ul><p><strong>å®¢æˆ·ç«¯ç»„ä»¶ (Client-side Components):</strong></p><ul><li><strong>CLI (å‘½ä»¤è¡Œæ¥å£)</strong>: å°±æ˜¯æˆ‘ä»¬æœ€å¸¸ç”¨çš„ <code>hive</code> å‘½ä»¤ï¼Œç›´æ¥åœ¨ç»ˆç«¯é‡Œå†™ HQLã€‚</li><li><strong>JDBC&#x2F;ODBC</strong>: æä¾›äº†æ ‡å‡†çš„æ•°æ®åº“è¿æ¥æ–¹å¼ï¼Œè®© BI å·¥å…·æˆ–è€… Java ç¨‹åºèƒ½åƒè¿ MySQL ä¸€æ ·è¿æ¥ Hiveã€‚</li><li><strong>Web GUI</strong>: æä¾›ä¸€ä¸ªç½‘é¡µç•Œé¢æ¥æ“ä½œ Hiveã€‚</li></ul><h3 id="ä¸€æ¬¡æŸ¥è¯¢çš„æ‰§è¡Œæµç¨‹"><a href="#ä¸€æ¬¡æŸ¥è¯¢çš„æ‰§è¡Œæµç¨‹" class="headerlink" title="ä¸€æ¬¡æŸ¥è¯¢çš„æ‰§è¡Œæµç¨‹"></a>ä¸€æ¬¡æŸ¥è¯¢çš„æ‰§è¡Œæµç¨‹</h3><p>å½“æˆ‘ä»¬æ•²ä¸‹ä¸€è¡Œ HQL å›è½¦åï¼ŒèƒŒåå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</p><pre class="mermaid">sequenceDiagram    participant Client as å®¢æˆ·ç«¯    participant Driver as é©±åŠ¨å™¨    participant Compiler as ç¼–è¯‘å™¨    participant Optimizer as ä¼˜åŒ–å™¨    participant Executor as æ‰§è¡Œå™¨    participant Metastore as å…ƒæ•°æ®ä¸­å¿ƒ    participant Hadoop as "Hadoop(YARN/HDFS)"    Client->>Driver: æäº¤ HQL æŸ¥è¯¢    Driver->>Compiler: è§£æ/ç¼–è¯‘æŸ¥è¯¢    Compiler->>Metastore: è·å–è¡¨ç»“æ„ç­‰å…ƒæ•°æ®    Metastore-->>Compiler: è¿”å›å…ƒæ•°æ®    Compiler->>Optimizer: ç”Ÿæˆä¼˜åŒ–çš„æ‰§è¡Œè®¡åˆ’(DAG)    Optimizer-->>Driver: è¿”å›æœ€ç»ˆæ‰§è¡Œè®¡åˆ’    Driver->>Executor: æ‰§è¡Œ    Executor->>Hadoop: æäº¤ MapReduce/Tez/Spark ä½œä¸š    Hadoop->>Hadoop: åœ¨é›†ç¾¤ä¸Šæ‰§è¡Œä½œä¸š, ä» HDFS è¯»æ•°æ®    Hadoop->>Executor: è¿”å›ä½œä¸šç»“æœ/çŠ¶æ€    Executor-->>Driver: è¿”å›æ‰§è¡Œç»“æœ    Driver-->>Client: è¿”å›æœ€ç»ˆæŸ¥è¯¢ç»“æœ</pre><p>ç®€å•æ€»ç»“ä¸€ä¸‹æ­¥éª¤ï¼š</p><ol><li>å®¢æˆ·ç«¯æŠŠ HQL å‘ç»™ Driverã€‚</li><li>Driver é‡Œçš„ç¼–è¯‘å™¨å’Œä¼˜åŒ–å™¨å¼€å§‹å·¥ä½œï¼Œå®ƒä»¬ä¼šå» Metastore æŸ¥è¯¢è¿™å¼ è¡¨åˆ°åº•é•¿å•¥æ ·ï¼ˆæ¯”å¦‚å­—æ®µã€åˆ†åŒºï¼‰ï¼Œç„¶åç”Ÿæˆä¸€ä¸ªæœ€ä¼˜çš„æ‰§è¡Œè®¡åˆ’ã€‚</li><li>æ‰§è¡Œå™¨æ‹¿åˆ°è®¡åˆ’ï¼ŒæŠŠå®ƒç¿»è¯‘æˆä¸€ä¸ªæˆ–å¤šä¸ª MapReduceï¼ˆæˆ– Tez&#x2F;Sparkï¼‰ä½œä¸šã€‚</li><li>æ‰§è¡Œå™¨æŠŠè¿™äº›ä½œä¸šæ‰”ç»™ Hadoop çš„ YARN å»è°ƒåº¦æ‰§è¡Œã€‚</li><li>ä½œä¸šåœ¨ Hadoop é›†ç¾¤ä¸Šè¿è¡Œï¼Œä» HDFS è¯»å–æ•°æ®è¿›è¡Œè®¡ç®—ã€‚</li><li>è®¡ç®—ç»“æœå¯èƒ½ä¼šå†™å› HDFSï¼Œæˆ–è€…ç›´æ¥è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</li></ol><h3 id="æ•°æ®æ¨¡å‹"><a href="#æ•°æ®æ¨¡å‹" class="headerlink" title="æ•°æ®æ¨¡å‹"></a>æ•°æ®æ¨¡å‹</h3><p>Hive æ˜¯æ€ä¹ˆç»„ç»‡æ•°æ®çš„å‘¢ï¼Ÿä¸»è¦æœ‰è¿™ä¹ˆå‡ ä¸ªæ¦‚å¿µï¼š</p><ul><li><strong>Database</strong>: å’Œä¼ ç»Ÿæ•°æ®åº“ä¸€æ ·ï¼Œå°±æ˜¯ä¸ªå‘½åç©ºé—´ï¼Œç”¨æ¥ç»„ç»‡å’Œéš”ç¦»è¡¨ã€‚</li><li><strong>Table</strong>: è¡¨ã€‚åˆ†ä¸ºä¸¤ç§ï¼š<ul><li><strong>å†…éƒ¨è¡¨ (Managed&#x2F;Internal Table)</strong>: Hive å…¨æƒç®¡ç†ã€‚æ•°æ®ä¼šè¢«ç§»åŠ¨åˆ° Hive çš„æ•°æ®ä»“åº“ç›®å½•ï¼ˆé€šå¸¸æ˜¯ <code>/user/hive/warehouse</code>ï¼‰ã€‚ä½  <code>DROP</code> è¿™å¼ è¡¨çš„æ—¶å€™ï¼Œå®ƒçš„å…ƒæ•°æ®å’Œ HDFS ä¸Šçš„æ•°æ®æ–‡ä»¶ä¼šä¸€èµ·è¢«åˆ æ‰ã€‚é€‚åˆå­˜æ”¾åªç»™ Hive ç”¨çš„ä¸´æ—¶è¡¨æˆ–ä¸­é—´è¡¨ã€‚</li><li><strong>å¤–éƒ¨è¡¨ (External Table)</strong>: Hive åªç®¡ç†å…ƒæ•°æ®ï¼Œæ•°æ®æ–‡ä»¶å­˜æ”¾åœ¨ä½ æŒ‡å®šçš„ HDFS è·¯å¾„ä¸‹ã€‚<code>DROP</code> å¤–éƒ¨è¡¨æ—¶ï¼Œåªä¼šåˆ é™¤å…ƒæ•°æ®ï¼ŒHDFS ä¸Šçš„æ–‡ä»¶å®‰ç„¶æ— æ™ã€‚è¿™å¯¹äºå¤šå·¥å…·ï¼ˆæ¯”å¦‚ Sparkã€Presto ä¹Ÿä¼šç”¨ï¼‰å…±äº«æ•°æ®æºçš„åœºæ™¯éå¸¸æœ‰ç”¨ã€‚</li></ul></li><li><strong>Partition (åˆ†åŒº)</strong>: è¿™æ˜¯ Hive ä¸€ä¸ªéå¸¸é‡è¦çš„æ€§èƒ½ä¼˜åŒ–æœºåˆ¶ã€‚ä½ å¯ä»¥æ ¹æ®ä¸€ä¸ªæˆ–å¤šä¸ªåˆ—çš„å€¼æŠŠä¸€å¼ è¡¨çš„æ•°æ®åˆ†æˆä¸åŒçš„éƒ¨åˆ†æ¥å­˜å‚¨ã€‚åœ¨æ–‡ä»¶ç³»ç»Ÿå±‚é¢ï¼Œæ¯ä¸ªåˆ†åŒºå°±æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ–‡ä»¶å¤¹ã€‚<ul><li>æ¯”å¦‚ï¼Œä¸€å¼ æ—¥å¿—è¡¨ <code>logs</code> æŒ‰å¤©åˆ†åŒºï¼ˆ<code>dt</code> åˆ—ï¼‰ï¼Œé‚£ä¹ˆ <code>dt=&#39;2023-10-27&#39;</code> çš„æ‰€æœ‰æ•°æ®éƒ½ä¼šå­˜æ”¾åœ¨ HDFS çš„ <code>.../logs/dt=2023-10-27/</code> ç›®å½•ä¸‹ã€‚</li><li>å½“ä½ æŸ¥è¯¢æ—¶å¸¦ä¸Š <code>WHERE dt=&#39;2023-10-27&#39;</code>ï¼ŒHive å°±åªéœ€è¦æ‰«æè¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹çš„æ•°æ®ï¼Œè€Œä¸ç”¨å…¨è¡¨æ‰«æï¼Œé€Ÿåº¦è‡ªç„¶å°±å¿«äº†ã€‚</li></ul></li><li><strong>Bucket (åˆ†æ¡¶)</strong>: å¦‚æœè¯´åˆ†åŒºæ˜¯â€å®è§‚â€ä¸Šçš„åˆ‡åˆ†ï¼ˆåˆ†æ–‡ä»¶å¤¹ï¼‰ï¼Œé‚£åˆ†æ¡¶å°±æ˜¯â€å¾®è§‚â€ä¸Šçš„åˆ‡åˆ†ï¼ˆåˆ†æ–‡ä»¶ï¼‰ã€‚å®ƒä¼šåœ¨ä¸€ä¸ªåˆ†åŒºå†…ï¼Œæ ¹æ®æŸåˆ—çš„å“ˆå¸Œå€¼æŠŠæ•°æ®å†åˆ‡åˆ†æˆå›ºå®šæ•°é‡çš„æ–‡ä»¶ï¼ˆæ¡¶ï¼‰ã€‚è¿™å¯¹äºé«˜æ•ˆçš„é‡‡æ ·ï¼ˆsamplingï¼‰å’ŒæŸäº› Join æ“ä½œæœ‰å¥‡æ•ˆã€‚</li></ul><h3 id="å¸¸ç”¨æ•°æ®ç±»å‹"><a href="#å¸¸ç”¨æ•°æ®ç±»å‹" class="headerlink" title="å¸¸ç”¨æ•°æ®ç±»å‹"></a>å¸¸ç”¨æ•°æ®ç±»å‹</h3><p>Hive çš„æ•°æ®ç±»å‹è·Ÿæ ‡å‡† SQL å·®ä¸å¤šã€‚</p><ul><li><strong>åŸºæœ¬ç±»å‹</strong>:<ul><li>æ•°å€¼å‹: <code>TINYINT</code>, <code>SMALLINT</code>, <code>INT</code>, <code>BIGINT</code>, <code>FLOAT</code>, <code>DOUBLE</code>, <code>DECIMAL</code></li><li>å¸ƒå°”å‹: <code>BOOLEAN</code></li><li>å­—ç¬¦ä¸²: <code>STRING</code>, <code>VARCHAR</code>, <code>CHAR</code></li><li>æ—¶é—´æˆ³: <code>TIMESTAMP</code>, <code>DATE</code></li></ul></li><li><strong>å¤æ‚ç±»å‹</strong>:<ul><li><code>ARRAY&lt;data_type&gt;</code>: æ•°ç»„ï¼Œæ¯”å¦‚ <code>ARRAY&lt;STRING&gt;</code>ã€‚</li><li><code>MAP&lt;primitive_type, data_type&gt;</code>: Key-Value å¯¹ï¼Œæ¯”å¦‚ <code>MAP&lt;STRING, INT&gt;</code>ã€‚</li><li><code>STRUCT&lt;col_name: data_type, ...&gt;</code>: ç»“æ„ä½“ï¼Œå¯ä»¥æŠŠå¤šä¸ªå­—æ®µåŒ…åœ¨ä¸€èµ·ï¼Œç±»ä¼¼ C è¯­è¨€çš„ structã€‚æ¯”å¦‚ <code>STRUCT&lt;name:STRING, age:INT&gt;</code>ã€‚</li></ul></li></ul><h3 id="Hive-ä¸-HDFS-çš„å…³ç³»"><a href="#Hive-ä¸-HDFS-çš„å…³ç³»" class="headerlink" title="Hive ä¸ HDFS çš„å…³ç³»"></a>Hive ä¸ HDFS çš„å…³ç³»</h3><p>æœ€åå†æ‹ä¸€æ‹ Hive å’Œ HDFS çš„å…³ç³»ï¼š</p><ul><li>**Hive æ˜¯â€ä¸Šå±‚å»ºç­‘â€ï¼ŒHDFS æ˜¯â€ç»æµåŸºç¡€â€**ã€‚</li><li><strong>æ•°æ®å­˜å‚¨</strong>: Hive ä¸è´Ÿè´£å­˜æ•°æ®ï¼Œå®ƒè¡¨é‡Œçš„æ•°æ®å®é™…ä¸Šéƒ½æ˜¯ HDFS ä¸Šçš„æ–‡ä»¶ã€‚Hive çš„å…ƒæ•°æ®ï¼ˆMetastoreï¼‰é‡Œè®°å½•äº†è¡¨çš„æ•°æ®å¯¹åº” HDFS çš„å“ªä¸ªè·¯å¾„ã€‚</li><li><strong>æ•°æ®å¤„ç†</strong>: Hive æŠŠç”¨æˆ·çš„ HQL æŸ¥è¯¢è½¬æ¢æˆåº•å±‚çš„è®¡ç®—ä»»åŠ¡ï¼ˆå¦‚ MapReduceï¼‰ï¼Œè¿™äº›ä»»åŠ¡åœ¨ Hadoop é›†ç¾¤ä¸Šè¿è¡Œï¼Œç›´æ¥æ“ä½œ HDFS ä¸Šçš„æ•°æ®æ–‡ä»¶ã€‚</li></ul><p>æ‰€ä»¥ï¼Œä½ å¯ä»¥æŠŠ Hive ç†è§£æˆä¸€ä¸ªç¿»è¯‘å®˜ + æŒ‡æŒ¥å®˜ã€‚å®ƒæŠŠæˆ‘ä»¬å†™çš„ SQL â€œç¿»è¯‘â€ æˆ Hadoop èƒ½å¬æ‡‚çš„è¯­è¨€ï¼ˆMapReduce ä½œä¸šï¼‰ï¼Œç„¶å â€œæŒ‡æŒ¥â€ Hadoop é›†ç¾¤å» HDFS ä¸Šæ¬ç –å¹²æ´»ã€‚ </p>]]></content>
      
      
      <categories>
          
          <category> å¤§æ•°æ® </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥å“ˆå¸Œå‡½æ•°ï¼šSHA-256çš„æ•°å­¦ä¹‹æ—…</title>
      <link href="/2025/06/18/%E6%B7%B1%E5%85%A5%E5%93%88%E5%B8%8C%E5%87%BD%E6%95%B0%EF%BC%9ASHA-256%E7%9A%84%E6%95%B0%E5%AD%A6%E4%B9%8B%E6%97%85/"/>
      <url>/2025/06/18/%E6%B7%B1%E5%85%A5%E5%93%88%E5%B8%8C%E5%87%BD%E6%95%B0%EF%BC%9ASHA-256%E7%9A%84%E6%95%B0%E5%AD%A6%E4%B9%8B%E6%97%85/</url>
      
        <content type="html"><![CDATA[<h1 id="æ·±å…¥å“ˆå¸Œå‡½æ•°ï¼šSHA-256çš„æ•°å­¦ä¹‹æ—…"><a href="#æ·±å…¥å“ˆå¸Œå‡½æ•°ï¼šSHA-256çš„æ•°å­¦ä¹‹æ—…" class="headerlink" title="æ·±å…¥å“ˆå¸Œå‡½æ•°ï¼šSHA-256çš„æ•°å­¦ä¹‹æ—…"></a>æ·±å…¥å“ˆå¸Œå‡½æ•°ï¼šSHA-256çš„æ•°å­¦ä¹‹æ—…</h1><p>ä¸Šæ¬¡æˆ‘ä»¬èŠäº†å“ˆå¸Œæ˜¯å¹²å•¥çš„ï¼Œè¯´å®ƒæ˜¯ä¸ªâ€å•å‘æ…æ‹Œæœºâ€ã€‚é‚£ä»Šå¤©ï¼Œå’±ä»¬å°±æŠŠè¿™å°æ…æ‹Œæœºçš„ç›–å­æ€å¼€ï¼Œçœ‹çœ‹é‡Œé¢çš„é½¿è½®å’Œåˆ€ç‰‡ï¼ˆä¹Ÿå°±æ˜¯æ•°å­¦åŸç†ï¼‰åˆ°åº•æ˜¯æ€ä¹ˆå·¥ä½œçš„ã€‚</p><p>æˆ‘ä»¬æ‹¿å¤§åé¼é¼çš„ SHA-256 æ¥å¼€åˆ€ã€‚æ”¾å¿ƒï¼Œè¿™ç¯‡æ–‡ç« ä¸æ˜¯è®©ä½ å»å½“æ•°å­¦å®¶ï¼Œä¹Ÿä¸æ˜¯è®©ä½ è‡ªå·±å»å®ç°ä¸€ä¸ªã€‚è€Œæ˜¯ç”¨ä¸€ä¸ªå¼€å‘è€…çš„è§†è§’ï¼Œå»ç†è§£æˆ‘ä»¬æ¯å¤©éƒ½åœ¨ç”¨çš„å·¥å…·ï¼Œå®ƒèƒŒåé‚£äº›ç²¾å¦™çš„è®¾è®¡ã€‚</p><p><strong>ç†è§£åŸç†æ˜¯ä¸ºäº†æ›´å¥½åœ°ä½¿ç”¨å®ƒï¼Œè€Œä¸æ˜¯è®©ä½ è‡ªå·±å»å®ç°ä¸€ä¸ªï¼</strong> ä¸“ä¸šçš„äº‹äº¤ç»™å¯†ç å­¦å®¶ï¼Œæˆ‘ä»¬è´Ÿè´£æŠŠå®ƒç”¨å¯¹ã€‚</p><h2 id="å®è§‚è§†è§’ï¼šMerkleâ€“Damgard-ç»“æ„"><a href="#å®è§‚è§†è§’ï¼šMerkleâ€“Damgard-ç»“æ„" class="headerlink" title="å®è§‚è§†è§’ï¼šMerkleâ€“DamgÃ¥rd ç»“æ„"></a>å®è§‚è§†è§’ï¼šMerkleâ€“DamgÃ¥rd ç»“æ„</h2><p>åœ¨æˆ‘ä»¬ä¸€å¤´æ‰è¿› SHA-256 çš„ç»†èŠ‚ä¹‹å‰ï¼Œå¾—å…ˆäº†è§£å¤§éƒ¨åˆ†å“ˆå¸Œå‡½æ•°ï¼ˆåŒ…æ‹¬ MD5ã€SHA-1ã€SHA-256ï¼‰çš„é€šç”¨è®¾è®¡è“å›¾â€”â€”<strong>Merkleâ€“DamgÃ¥rd ç»“æ„</strong>ã€‚</p><p>è¿™ç»“æ„æ€æƒ³å¾ˆç®€å•ï¼šæ—¢ç„¶æˆ‘ä¸€æ¬¡æ€§å¤„ç†ä¸äº†æ— é™é•¿çš„æ•°æ®ï¼Œé‚£æˆ‘æŠŠå®ƒåˆ‡æˆä¸€å—ä¸€å—çš„ï¼Œä¸å°±è¡Œäº†ï¼Ÿ</p><p>å®ƒå°±åƒä¸€ä¸ªé“¾å¼ååº”ç‚‰ï¼š</p><ol><li>æŠŠä½ çš„è¾“å…¥æ•°æ®ï¼ˆæ¯”å¦‚â€hello worldâ€ï¼‰åˆ‡æˆå›ºå®šå¤§å°çš„å—ï¼ˆBlockï¼‰ã€‚</li><li>å®šä¹‰ä¸€ä¸ªåˆå§‹çš„å“ˆå¸Œå€¼ï¼ˆIV - Initial Valueï¼‰ï¼Œè¿™å¯ä»¥çœ‹ä½œæ˜¯ååº”ç‚‰çš„â€ç§å­â€ã€‚</li><li>æŠŠç¬¬ä¸€ä¸ªæ•°æ®å—å’Œâ€ç§å­â€ä¸€èµ·æ‰”è¿›ä¸€ä¸ªå«åšâ€å‹ç¼©å‡½æ•°ï¼ˆCompression Functionï¼‰â€çš„é»‘ç›’é‡Œã€‚</li><li>è¿™ä¸ªé»‘ç›’ä¼šè¾“å‡ºä¸€ä¸ªæ–°çš„å“ˆå¸Œå€¼ã€‚</li><li>æŠŠè¿™ä¸ªæ–°çš„å“ˆå¸Œå€¼ä½œä¸ºæ–°çš„â€ç§å­â€ï¼Œå’Œä¸‹ä¸€ä¸ªæ•°æ®å—ä¸€èµ·ï¼Œå†æ¬¡æ‰”è¿›é‚£ä¸ªé»‘ç›’é‡Œã€‚</li><li>å¦‚æ­¤å¾ªç¯ï¼Œç›´åˆ°æœ€åä¸€ä¸ªæ•°æ®å—è¢«å¤„ç†å®Œæ¯•ã€‚</li><li>æœ€åè¾“å‡ºçš„é‚£ä¸ªå“ˆå¸Œå€¼ï¼Œå°±æ˜¯ä½ æ•´ä¸ªæ•°æ®çš„æœ€ç»ˆå“ˆå¸Œç»“æœã€‚</li></ol><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    IV(åˆå§‹å“ˆå¸Œå€¼) --&gt; C1(å‹ç¼©å‡½æ•°);    B1(æ•°æ®å—1) --&gt; C1;    C1 --&gt; H1(ä¸­é—´å“ˆå¸Œå€¼1);    H1 --&gt; C2(å‹ç¼©å‡½æ•°);    B2(æ•°æ®å—2) --&gt; C2;    C2 --&gt; H2(ä¸­é—´å“ˆå¸Œå€¼2);    H2 --&gt; Cn(å‹ç¼©å‡½æ•°);    Bn(æ•°æ®å—n) --&gt; Cn;    Cn --&gt; FinalHash(æœ€ç»ˆå“ˆå¸Œå€¼);    style IV fill:#f9f,stroke:#333,stroke-width:2px    style FinalHash fill:#ccf,stroke:#333,stroke-width:2px  </pre></div><p>è¿™ä¸ªç»“æ„çš„æ ¸å¿ƒå°±æ˜¯é‚£ä¸ªâ€å‹ç¼©å‡½æ•°â€ã€‚SHA-256 çš„æ‰€æœ‰é­”æ³•ï¼Œéƒ½å‘ç”Ÿåœ¨è¿™ä¸ªå‡½æ•°é‡Œã€‚</p><h2 id="SHA-256-çš„è§£å‰–è¿‡ç¨‹"><a href="#SHA-256-çš„è§£å‰–è¿‡ç¨‹" class="headerlink" title="SHA-256 çš„è§£å‰–è¿‡ç¨‹"></a>SHA-256 çš„è§£å‰–è¿‡ç¨‹</h2><p>ç°åœ¨ï¼Œæˆ‘ä»¬æ­£å¼å¼€å§‹è§£å‰– SHA-256ã€‚</p><h3 id="ç¬¬ä¸€æ­¥ï¼šæ¶ˆæ¯å¡«å……ï¼ˆPaddingï¼‰"><a href="#ç¬¬ä¸€æ­¥ï¼šæ¶ˆæ¯å¡«å……ï¼ˆPaddingï¼‰" class="headerlink" title="ç¬¬ä¸€æ­¥ï¼šæ¶ˆæ¯å¡«å……ï¼ˆPaddingï¼‰"></a>ç¬¬ä¸€æ­¥ï¼šæ¶ˆæ¯å¡«å……ï¼ˆPaddingï¼‰</h3><p>ååº”ç‚‰è¦æ±‚æ¯ä¸ªæ•°æ®å—å¤§å°éƒ½å¾—ä¸€æ ·ï¼ŒSHA-256 è¦æ±‚æ˜¯ <strong>512 ä½ï¼ˆ64 å­—èŠ‚ï¼‰</strong>ã€‚å¯æˆ‘ä»¬çš„è¾“å…¥æ•°æ®åƒå¥‡ç™¾æ€ªï¼Œæ€ä¹ˆåŠï¼Ÿ</p><p><strong>å¡«å……ï¼</strong> è§„åˆ™å¦‚ä¸‹ï¼š</p><ol><li>åœ¨ä½ çš„åŸå§‹æ•°æ®æœ«å°¾ï¼Œå…ˆè¡¥ä¸€ä¸ª <code>1</code>ã€‚</li><li>ç„¶åï¼Œä¸€ç›´è¡¥ <code>0</code>ï¼Œç›´åˆ°æ¶ˆæ¯çš„æ€»é•¿åº¦è·ç¦»â€512çš„å€æ•°â€åªå·® 64 ä½ä¸ºæ­¢ã€‚</li><li>æœ€åè¿™ 64 ä½ï¼Œç”¨æ¥å­˜æ”¾ä½ <strong>åŸå§‹æ•°æ®</strong>çš„é•¿åº¦ï¼ˆç”¨äºŒè¿›åˆ¶è¡¨ç¤ºï¼‰ã€‚</li></ol><p>ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬è¦å“ˆå¸Œå­—ç¬¦ä¸² â€œabcâ€ã€‚</p><ul><li>â€œabcâ€ çš„ ASCII ç¼–ç æ˜¯ <code>01100001 01100010 01100011</code>ï¼Œå…± 24 ä½ã€‚</li><li><strong>è¡¥ 1</strong>ï¼šå˜æˆ 25 ä½ã€‚</li><li><strong>è¡¥ 0</strong>ï¼šæˆ‘ä»¬éœ€è¦è¡¥åˆ° <code>512 - 64 = 448</code> ä½ã€‚æ‰€ä»¥è¦è¡¥ <code>448 - 25 = 423</code> ä¸ª 0ã€‚</li><li><strong>è¡¥é•¿åº¦</strong>ï¼šæœ€å 64 ä½ï¼Œå¡«å…¥åŸå§‹é•¿åº¦ 24 çš„äºŒè¿›åˆ¶ã€‚</li></ul><p>è¿™æ ·ä¸€æ¥ï¼Œä»»ä½•é•¿åº¦çš„è¾“å…¥ï¼Œéƒ½ä¼šè¢«å¤„ç†æˆä¸€ä¸ªæˆ–å¤šä¸ªç²¾ç¡®çš„ 512 ä½æ•°æ®å—ã€‚è¿™ä¸ªå¡«å……æ–¹æ¡ˆç¡®ä¿äº†ä¸åŒé•¿åº¦çš„åŸå§‹æ¶ˆæ¯ï¼Œä¸ä¼šäº§ç”Ÿç›¸åŒçš„å¡«å……åæ¶ˆæ¯ã€‚</p><h3 id="ç¬¬äºŒæ­¥ï¼šåˆå§‹åŒ–å“ˆå¸Œå€¼ï¼ˆHï¼‰"><a href="#ç¬¬äºŒæ­¥ï¼šåˆå§‹åŒ–å“ˆå¸Œå€¼ï¼ˆHï¼‰" class="headerlink" title="ç¬¬äºŒæ­¥ï¼šåˆå§‹åŒ–å“ˆå¸Œå€¼ï¼ˆHï¼‰"></a>ç¬¬äºŒæ­¥ï¼šåˆå§‹åŒ–å“ˆå¸Œå€¼ï¼ˆHï¼‰</h3><p>è¿˜è®°å¾—ä¸Šé¢è¯´çš„â€ç§å­â€å—ï¼ŸSHA-256 çš„â€ç§å­â€æ˜¯ 8 ä¸ª 32 ä½çš„æ•´æ•°ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º <code>H0</code> åˆ° <code>H7</code>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">H0 = 0x6a09e667</span><br><span class="line">H1 = 0xbb67ae85</span><br><span class="line">H2 = 0x3c6ef372</span><br><span class="line">H3 = 0xa54ff53a</span><br><span class="line">H4 = 0x510e527f</span><br><span class="line">H5 = 0x9b05688c</span><br><span class="line">H6 = 0x1f83d9ab</span><br><span class="line">H7 = 0x5be0cd19</span><br></pre></td></tr></table></figure><p>è¿™äº›â€é­”æ³•æ•°å­—â€å¯ä¸æ˜¯éšä¾¿æ‹è„‘è¢‹æƒ³çš„ã€‚å®ƒä»¬æ˜¯è‡ªç„¶ç•Œæœ€çº¯ç²¹çš„ 8 ä¸ªç´ æ•°ï¼ˆ2, 3, 5, 7, 11, 13, 17, 19ï¼‰çš„å¹³æ–¹æ ¹çš„å°æ•°éƒ¨åˆ†ï¼Œå–å‰ 32 ä½ã€‚è¿™ä¹ˆåšçš„ç›®çš„æ˜¯ä¸ºäº†æ¶ˆé™¤ä»»ä½•å¯èƒ½çš„åé—¨æˆ–äººä¸ºåè§ï¼Œä¿è¯å…¶åˆå§‹çŠ¶æ€çš„â€éšæœºæ€§â€ã€‚</p><p>å¤‡æ³¨ï¼šå…¶å®ä¹Ÿä¸æ˜¯è¯´åªèƒ½æ˜¯è¿™ä¸ª8ä¸ªæ•°å­—è€Œå·²ã€‚å…¶å®ä¸»è¦æ˜¯ä¸ºäº†è¡¨æ˜æ¥æºï¼Œå¯†ç å­¦ä¸­çš„å¸¸æ•°å¦‚æœæ²¡æœ‰æ¥æºä¼šè¢«è®¤ä¸ºæ˜¯åé—¨ã€‚</p><h3 id="ç¬¬ä¸‰æ­¥ï¼šå¤„ç†æ•°æ®å—ï¼ˆæ ¸å¿ƒå‹ç¼©å‡½æ•°ï¼‰"><a href="#ç¬¬ä¸‰æ­¥ï¼šå¤„ç†æ•°æ®å—ï¼ˆæ ¸å¿ƒå‹ç¼©å‡½æ•°ï¼‰" class="headerlink" title="ç¬¬ä¸‰æ­¥ï¼šå¤„ç†æ•°æ®å—ï¼ˆæ ¸å¿ƒå‹ç¼©å‡½æ•°ï¼‰"></a>ç¬¬ä¸‰æ­¥ï¼šå¤„ç†æ•°æ®å—ï¼ˆæ ¸å¿ƒå‹ç¼©å‡½æ•°ï¼‰</h3><p>ç»ˆäºåˆ°äº†æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ã€‚å¯¹äºæ¯ä¸€ä¸ª 512 ä½çš„æ•°æ®å—ï¼ŒSHA-256 ä¼šæ‰§è¡Œä¸€ä¸ªåŒ…å« 64 â€œè½®â€è®¡ç®—çš„å¾ªç¯ã€‚</p><p>åœ¨å¾ªç¯å¼€å§‹å‰ï¼Œä¼šå…ˆåˆå§‹åŒ– 8 ä¸ªâ€å·¥ä½œå˜é‡â€ï¼Œç”¨å½“å‰çš„å“ˆå¸Œå€¼ï¼ˆå¯¹äºç¬¬ä¸€ä¸ªå—ï¼Œå°±æ˜¯åˆå§‹ H å€¼ï¼‰æ¥èµ‹å€¼ï¼š<br><code>a, b, c, d, e, f, g, h = H0, H1, H2, H3, H4, H5, H6, H7</code></p><p>ç„¶åï¼Œå¼€å§‹ 64 è½®çš„â€æ…æ‹Œâ€ï¼š</p><p><strong>1. æ¶ˆæ¯è°ƒåº¦ï¼ˆMessage Scheduleï¼‰</strong></p><p>é¦–å…ˆï¼ŒSHA-256 ä¸ä¼šç›´æ¥ç”¨ 512 ä½çš„æ•°æ®å—ï¼Œè€Œæ˜¯ä¼šæŠŠå®ƒæ‰©å±•æˆ 64 ä¸ª 32 ä½çš„â€å­—â€ï¼ˆwordï¼‰ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º <code>W[0]</code> åˆ° <code>W[63]</code>ã€‚</p><ul><li>å‰ 16 ä¸ªå­— <code>W[0]</code> åˆ° <code>W[15]</code> å°±æ˜¯æŠŠ 512 ä½æ•°æ®å—ç›´æ¥åˆ‡å¼€å¾—åˆ°çš„ã€‚</li><li>åé¢çš„ 48 ä¸ªå­— <code>W[16]</code> åˆ° <code>W[63]</code> æ˜¯é€šè¿‡ä¸€ä¸ªå…¬å¼ï¼Œç”±å‰é¢çš„å­—ç”Ÿæˆçš„ï¼š<br><code>W[t] = Ïƒ1(W[t-2]) + W[t-7] + Ïƒ0(W[t-15]) + W[t-16]</code></li></ul><p>è¿™é‡Œçš„ <code>Ïƒ0</code> å’Œ <code>Ïƒ1</code> æ˜¯ä¸€äº›â€å°é­”æ³•â€ï¼Œå®ƒä»¬åŒ…å«äº†æŒ‰ä½<strong>å¾ªç¯å³ç§»ï¼ˆROTRï¼‰</strong>å’Œ<strong>å³ç§»ï¼ˆSHRï¼‰</strong>æ“ä½œã€‚</p><ul><li><code>Ïƒ0(x) = ROTR(x, 7) ^ ROTR(x, 18) ^ SHR(x, 3)</code></li><li><code>Ïƒ1(x) = ROTR(x, 17) ^ ROTR(x, 19) ^ SHR(x, 10)</code><br>(æ³¨ï¼š<code>^</code> æ˜¯å¼‚æˆ– XOR)</li></ul><p>è¿™ä¸ªè¿‡ç¨‹çš„ç›®çš„æ˜¯<strong>åˆ¶é€ é›ªå´©æ•ˆåº”</strong>ã€‚è¾“å…¥çš„å¾®å°å˜åŒ–ï¼Œä¼šé€šè¿‡è¿™ä¸ªæ‰©å±•è¿‡ç¨‹ï¼Œè¿…é€Ÿæ‰©æ•£åˆ°æ•´ä¸ªæ¶ˆæ¯è°ƒåº¦æ•°ç»„ä¸­ã€‚</p><p><strong>2. 64 è½®å¾ªç¯</strong></p><p>æ¥ä¸‹æ¥å°±æ˜¯é•¿è¾¾ 64 è½®çš„å¾ªç¯ã€‚åœ¨æ¯ä¸€è½®ï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸ºç¬¬ <code>t</code> è½®ï¼‰ï¼Œéƒ½ä¼šè¿›è¡Œå¦‚ä¸‹è®¡ç®—ï¼š</p><p><code>T1 = h + Î£1(e) + Ch(e, f, g) + K[t] + W[t]</code><br><code>T2 = Î£0(a) + Maj(a, b, c)</code></p><p><code>h = g</code><br><code>g = f</code><br><code>f = e</code><br><code>e = d + T1</code><br><code>d = c</code><br><code>c = b</code><br><code>b = a</code><br><code>a = T1 + T2</code></p><p>æ˜¯ä¸æ˜¯çœ‹ç€æœ‰ç‚¹å¤´å¤§ï¼Ÿæˆ‘ä»¬æ‹†è§£ä¸€ä¸‹é‡Œé¢çš„â€å¤§é­”æ³•â€ï¼š</p><ul><li><code>W[t]</code>: ä¸Šä¸€æ­¥æ¶ˆæ¯è°ƒåº¦ä¸­ç”Ÿæˆçš„ç¬¬ <code>t</code> ä¸ªå­—ã€‚</li><li><code>K[t]</code>: ç¬¬ <code>t</code> è½®çš„å¸¸é‡ã€‚å’Œåˆå§‹ H å€¼ä¸€æ ·ï¼Œè¿™äº›ä¹Ÿæ˜¯â€é­”æ³•æ•°å­—â€ï¼Œæ¥è‡ªå‰ 64 ä¸ªç´ æ•°çš„ç«‹æ–¹æ ¹çš„å°æ•°éƒ¨åˆ†ã€‚å®ƒä»¬ä¸ºæ¯ä¸€è½®çš„è®¡ç®—å¼•å…¥äº†ä¸åŒçš„æ‰°åŠ¨ã€‚</li><li><code>Î£0(a)</code> å’Œ <code>Î£1(e)</code>: åˆæ˜¯ä¸¤ä¸ªå¾ªç¯ç§»ä½å’Œå¼‚æˆ–çš„ç»„åˆï¼Œç›®çš„æ˜¯è¿›ä¸€æ­¥æ··æ·†æ•°æ®ã€‚<ul><li><code>Î£0(a) = ROTR(a, 2) ^ ROTR(a, 13) ^ ROTR(a, 22)</code></li><li><code>Î£1(e) = ROTR(e, 6) ^ ROTR(e, 11) ^ ROTR(e, 25)</code></li></ul></li><li><code>Ch(e, f, g)</code>: â€œChooseâ€ å‡½æ•°ã€‚<code>Ch(e, f, g) = (e AND f) ^ ((NOT e) AND g)</code>ã€‚å¦‚æœ <code>e</code> çš„æŸä¸€ä½æ˜¯ 1ï¼Œåˆ™ç»“æœçš„å¯¹åº”ä½å– <code>f</code> çš„ï¼Œå¦åˆ™å– <code>g</code> çš„ã€‚è¿™å¼•å…¥äº†<strong>éçº¿æ€§</strong>ã€‚</li><li><code>Maj(a, b, c)</code>: â€œMajorityâ€ å‡½æ•°ã€‚<code>Maj(a, b, c) = (a AND b) ^ (a AND c) ^ (b AND c)</code>ã€‚å¯¹æ¯ä¸€ä½çœ‹ <code>a, b, c</code> ä¸­å“ªä¸€ä¸ªï¼ˆ0 æˆ– 1ï¼‰å å¤šæ•°ï¼Œç»“æœå°±å–å“ªä¸ªã€‚åŒæ ·æ˜¯ä¸ºäº†å¼•å…¥éçº¿æ€§ã€‚</li></ul><p><strong>ä¸ºä»€ä¹ˆè¦åšè¿™äº›å¥‡æ€ªçš„æ“ä½œï¼Ÿ</strong></p><p>æ‰€æœ‰è¿™äº›çœ¼èŠ±ç¼­ä¹±çš„ç§»ä½ã€å¼‚æˆ–ã€ä¸éæ“ä½œï¼Œæ ¸å¿ƒç›®çš„åªæœ‰ä¸€ä¸ªï¼š<strong>æ··æ·†ï¼ˆConfusionï¼‰ä¸æ‰©æ•£ï¼ˆDiffusionï¼‰</strong>ã€‚</p><ul><li><strong>æ··æ·†</strong>ï¼šè®©å¯†é’¥ï¼ˆåœ¨è¿™é‡Œæ˜¯è¾“å…¥æ•°æ®ï¼‰å’Œæœ€ç»ˆå¯†æ–‡ï¼ˆå“ˆå¸Œå€¼ï¼‰ä¹‹é—´çš„å…³ç³»å˜å¾—å°½å¯èƒ½å¤æ‚ã€‚<code>Ch</code>ã€<code>Maj</code> ç­‰éçº¿æ€§å‡½æ•°æ˜¯ä¸»åŠ›ã€‚</li><li><strong>æ‰©æ•£</strong>ï¼šè¾“å…¥æ•°æ®çš„ä»»ä½•ä¸€ç‚¹å¾®å°æ”¹åŠ¨ï¼Œéƒ½èƒ½è¿…é€Ÿåœ°ã€å¤§èŒƒå›´åœ°å½±å“åˆ°è¾“å‡ºçš„æ¯ä¸€ä½ã€‚è¿™å°±æ˜¯æ‰€è°“çš„â€é›ªå´©æ•ˆåº”â€ã€‚å„ç§å¾ªç¯ç§»ä½ <code>ROTR</code> å°±æ˜¯å¹²è¿™ä¸ªçš„ã€‚</li></ul><p>è¿™ 64 è½®ç–¯ç‹‚â€æ…æ‹Œâ€ä¹‹åï¼Œæˆ‘ä»¬å¾—åˆ°äº† 8 ä¸ªæ–°çš„ <code>a, b, c, d, e, f, g, h</code> å€¼ã€‚</p><h3 id="ç¬¬å››æ­¥ï¼šæ›´æ–°å“ˆå¸Œå€¼"><a href="#ç¬¬å››æ­¥ï¼šæ›´æ–°å“ˆå¸Œå€¼" class="headerlink" title="ç¬¬å››æ­¥ï¼šæ›´æ–°å“ˆå¸Œå€¼"></a>ç¬¬å››æ­¥ï¼šæ›´æ–°å“ˆå¸Œå€¼</h3><p>å¾ªç¯ç»“æŸåï¼Œå°†è¿™ä¸€è½®è®¡ç®—å¾—åˆ°çš„â€å·¥ä½œå˜é‡â€å’Œè¯¥æ•°æ®å—å¤„ç†ä¹‹å‰çš„â€å“ˆå¸Œå€¼â€è¿›è¡Œç›¸åŠ ï¼ˆæ¨¡ 2^32 åŠ æ³•ï¼‰ï¼š</p><p><code>H0 = H0 + a</code><br><code>H1 = H1 + b</code><br><code>...</code><br><code>H7 = H7 + h</code></p><p>å¥½äº†ï¼Œä¸€ä¸ªæ•°æ®å—å¤„ç†å®Œæ¯•ã€‚è¿™ä¸ªæ–°ç”Ÿæˆçš„ <code>H0</code> åˆ° <code>H7</code>ï¼Œå°†ä½œä¸ºä¸‹ä¸€ä¸ªæ•°æ®å—çš„â€ç§å­â€ï¼Œé‡å¤ç¬¬ä¸‰æ­¥ã€‚</p><h3 id="ç¬¬äº”æ­¥ï¼šç”Ÿæˆæœ€ç»ˆç»“æœ"><a href="#ç¬¬äº”æ­¥ï¼šç”Ÿæˆæœ€ç»ˆç»“æœ" class="headerlink" title="ç¬¬äº”æ­¥ï¼šç”Ÿæˆæœ€ç»ˆç»“æœ"></a>ç¬¬äº”æ­¥ï¼šç”Ÿæˆæœ€ç»ˆç»“æœ</h3><p>å½“æ‰€æœ‰çš„æ•°æ®å—éƒ½è¢«å¤„ç†å®Œæ¯•åï¼Œæœ€åå¾—åˆ°çš„ <code>H0</code> åˆ° <code>H7</code> è¿™ 8 ä¸ª 32 ä½æ•´æ•°ï¼ŒæŒ‰é¡ºåºæ‹¼æ¥åœ¨ä¸€èµ·ï¼Œå°±å½¢æˆäº†æœ€ç»ˆçš„ 256 ä½ SHA-256 å“ˆå¸Œå€¼ã€‚</p><p>å¤§åŠŸå‘Šæˆï¼</p><h2 id="ç»ˆæé—®é¢˜ï¼šä¸ºä»€ä¹ˆæˆ‘ä»¬æ‰¾ä¸åˆ°ç¢°æ’ï¼Ÿ"><a href="#ç»ˆæé—®é¢˜ï¼šä¸ºä»€ä¹ˆæˆ‘ä»¬æ‰¾ä¸åˆ°ç¢°æ’ï¼Ÿ" class="headerlink" title="ç»ˆæé—®é¢˜ï¼šä¸ºä»€ä¹ˆæˆ‘ä»¬æ‰¾ä¸åˆ°ç¢°æ’ï¼Ÿ"></a>ç»ˆæé—®é¢˜ï¼šä¸ºä»€ä¹ˆæˆ‘ä»¬æ‰¾ä¸åˆ°ç¢°æ’ï¼Ÿ</h2><p>åœ¨ç†è§£äº† SHA-256 çš„å†…éƒ¨æ„é€ åï¼Œä¸€ä¸ªéå¸¸æ ¸å¿ƒçš„é—®é¢˜æµ®å‡ºæ°´é¢ï¼šâ€æ—¢ç„¶å“ˆå¸Œå‡½æ•°çš„è¾“å…¥æ˜¯æ— é™çš„ï¼Œè¾“å‡ºæ˜¯æœ‰é™çš„ï¼Œé‚£å¿…ç„¶å­˜åœ¨ç¢°æ’ã€‚ä¸ºä»€ä¹ˆæˆ‘ä»¬è¿˜è¯´å®ƒæ˜¯å®‰å…¨çš„ï¼Œè€Œä¸”æ‰¾ä¸åˆ°ç¢°æ’å‘¢ï¼Ÿâ€</p><p>è¿™æ˜¯ä¸€ä¸ªç»ä½³çš„é—®é¢˜ï¼Œå®ƒè§¦åŠäº†å“ˆå¸Œå‡½æ•°å®‰å…¨æ€§çš„æ ¹åŸºã€‚è¦å›ç­”å®ƒï¼Œæˆ‘ä»¬å¾—ä»ä¸¤ä¸ªå±‚é¢æ¥çœ‹ï¼š<strong>ç†è®ºå±‚é¢</strong>å’Œ<strong>ç°å®å±‚é¢</strong>ã€‚</p><h3 id="ç†è®ºä¸Šï¼šç¢°æ’å¿…ç„¶å­˜åœ¨ï¼ˆé¸½å·¢åŸç†ï¼‰"><a href="#ç†è®ºä¸Šï¼šç¢°æ’å¿…ç„¶å­˜åœ¨ï¼ˆé¸½å·¢åŸç†ï¼‰" class="headerlink" title="ç†è®ºä¸Šï¼šç¢°æ’å¿…ç„¶å­˜åœ¨ï¼ˆé¸½å·¢åŸç†ï¼‰"></a>ç†è®ºä¸Šï¼šç¢°æ’å¿…ç„¶å­˜åœ¨ï¼ˆé¸½å·¢åŸç†ï¼‰</h3><p>é¦–å…ˆï¼Œä¸€ä¸ªæ®‹é…·ä½†å¿…é¡»æ‰¿è®¤çš„äº‹å®æ˜¯ï¼š<strong>å“ˆå¸Œç¢°æ’æ˜¯ 100% å­˜åœ¨çš„ã€‚</strong></p><p>è¿™å¯ä»¥ç”¨ä¸€ä¸ªæˆ‘ä»¬åˆä¸­å°±å­¦è¿‡çš„æ•°å­¦çŸ¥è¯†æ¥è§£é‡Šï¼Œå«â€<strong>é¸½å·¢åŸç†</strong>â€œï¼ˆPigeonhole Principleï¼‰ï¼šå¦‚æœä½ æœ‰ 10 åªé¸½å­ï¼Œä½†åªæœ‰ 9 ä¸ªé¸½å·¢ï¼Œé‚£ä¹ˆæ— è®ºä½ æ€ä¹ˆæ”¾ï¼Œè‡³å°‘æœ‰ 1 ä¸ªé¸½å·¢é‡Œå¾—æŒ¤ç€ 2 åªæˆ–æ›´å¤šçš„é¸½å­ã€‚</p><p>æˆ‘ä»¬æŠŠè¿™ä¸ªåŸç†å¥—åœ¨ SHA-256 ä¸Šï¼š</p><ul><li><strong>é¸½å·¢ï¼ˆè¾“å‡ºç©ºé—´ï¼‰</strong>ï¼šSHA-256 çš„è¾“å‡ºé•¿åº¦æ˜¯å›ºå®šçš„ 256 ä½ã€‚æ‰€ä»¥ï¼Œå®ƒèƒ½äº§ç”Ÿçš„ä¸åŒå“ˆå¸Œå€¼çš„æ€»æ•°æ˜¯ <code>2^256</code> ä¸ªã€‚è¿™æ˜¯ä¸€ä¸ªå¤©æ–‡æ•°å­—ï¼Œä½†å®ƒæ˜¯<strong>æœ‰é™çš„</strong>ã€‚</li><li><strong>é¸½å­ï¼ˆè¾“å…¥ç©ºé—´ï¼‰</strong>ï¼šå“ˆå¸Œå‡½æ•°çš„è¾“å…¥å¯ä»¥æ˜¯ä»»æ„é•¿åº¦çš„æ•°æ®ã€‚å­—ç¬¦ä¸² â€œaâ€ã€â€bâ€ã€â€hello worldâ€ã€ä¸€éƒ¨ç”µå½±ã€æ•´ä¸ªäº’è”ç½‘çš„æ•°æ®â€¦â€¦ è¾“å…¥çš„å¯èƒ½æ€§æ˜¯<strong>æ— é™çš„</strong>ã€‚</li></ul><p>å¥½äº†ï¼Œç°åœ¨æˆ‘ä»¬ç”¨ä¸€ä¸ª<strong>æœ‰é™</strong>çš„é¸½å·¢ï¼Œå»è£…<strong>æ— é™</strong>çš„é¸½å­ã€‚ç»“æœä¸è¨€è€Œå–»ï¼š<strong>å¿…ç„¶ä¼šæœ‰æ— æ•°ä¸ªä¸åŒçš„è¾“å…¥ï¼Œæœ€ç»ˆæŒ¤åœ¨åŒä¸€ä¸ªå“ˆå¸Œå€¼çš„â€é¸½å·¢â€é‡Œã€‚</strong></p><p>æ‰€ä»¥ï¼Œä»ç†è®ºä¸Šè®²ï¼Œç»å¯¹å­˜åœ¨ <code>x != y</code>ï¼Œä½† <code>sha(x) = sha(y)</code>ã€‚æˆ‘ä»¬ç®¡è¿™ç§æƒ…å†µå«åšâ€<strong>ç¢°æ’</strong>â€œï¼ˆCollisionï¼‰ã€‚</p><h3 id="ç°å®ä¸­ï¼šä¸ºä»€ä¹ˆä½ å°±æ˜¯æ‰¾ä¸åˆ°å®ƒ"><a href="#ç°å®ä¸­ï¼šä¸ºä»€ä¹ˆä½ å°±æ˜¯æ‰¾ä¸åˆ°å®ƒ" class="headerlink" title="ç°å®ä¸­ï¼šä¸ºä»€ä¹ˆä½ å°±æ˜¯æ‰¾ä¸åˆ°å®ƒ"></a>ç°å®ä¸­ï¼šä¸ºä»€ä¹ˆä½ å°±æ˜¯æ‰¾ä¸åˆ°å®ƒ</h3><p>æ—¢ç„¶ç¢°æ’å¿…ç„¶å­˜åœ¨ï¼Œé‚£ä¸ºä»€ä¹ˆæˆ‘ä»¬è¿˜æ¯å¤©æ”¾å¿ƒåœ°ç”¨ç€å®ƒï¼Œå¹¶è®¤ä¸ºå®ƒæ˜¯å®‰å…¨çš„ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯ï¼š<strong>å› ä¸ºä»ç†è®ºä¸Šçš„â€å­˜åœ¨â€ï¼Œåˆ°å®é™…ä¸Šçš„â€æ‰¾åˆ°â€ï¼Œä¸­é—´éš”ç€ä¸€é“åä¸ºâ€è®¡ç®—ä¸Šä¸å¯è¡Œâ€çš„å¤©å ‘ã€‚</strong></p><p>è¿™é“å¤©å ‘ï¼Œå°±æ˜¯ç”± SHA-256 å†…éƒ¨é‚£äº›å¤æ‚çš„è®¾è®¡ç²¾å¿ƒæ„å»ºçš„ã€‚æˆ‘ä»¬åˆšåˆšæ‹†è§£çš„é‚£äº›çœ¼èŠ±ç¼­ä¹±çš„æ“ä½œï¼Œå°±æ˜¯ä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼š</p><p><strong>1. é›ªå´©æ•ˆåº”ï¼ˆAvalanche Effectï¼‰</strong></p><p>è¿™æ˜¯æœ€æ ¸å¿ƒçš„ä¸€ç‚¹ã€‚ä¸€ä¸ªè®¾è®¡è‰¯å¥½çš„å“ˆå¸Œç®—æ³•ï¼Œè¾“å…¥çš„ä»»ä½•ä¸€ç‚¹å¾®å°å˜åŒ–ï¼ˆå“ªæ€•åªæ”¹åŠ¨ 1 ä¸ª bitï¼‰ï¼Œéƒ½ä¼šå¯¼è‡´è¾“å‡ºç»“æœå¤©ç¿»åœ°è¦†ã€å®Œå…¨ä¸åŒï¼ˆç†æƒ³æƒ…å†µä¸‹ä¼šæœ‰ä¸€åŠçš„ bit ä½å‘ç”Ÿåè½¬ï¼‰ã€‚</p><p>è¿™æ„å‘³ç€ä»€ä¹ˆï¼Ÿ</p><ul><li><strong>æ²¡æœ‰è§„å¾‹å¯å¾ª</strong>ï¼šä½ æ— æ³•é€šè¿‡è§‚å¯Ÿ <code>hash(&quot;abc&quot;)</code> å’Œ <code>hash(&quot;abd&quot;)</code> çš„ç»“æœï¼Œæ¥æ¨æµ‹å¦‚ä½•ä¿®æ”¹è¾“å…¥æ‰èƒ½è®©å®ƒä»¬çš„å“ˆå¸Œå€¼æ›´â€æ¥è¿‘â€ã€‚ä¸¤ä¸ªç»“æœä¹‹é—´çœ‹èµ·æ¥æ˜¯å®Œå…¨éšæœºçš„å…³ç³»ã€‚</li><li><strong>æ— æ³•â€é€¼è¿‘â€ç›®æ ‡</strong>ï¼šå¯»æ‰¾ç¢°æ’ä¸æ˜¯ä¸€ä¸ªå¯ä»¥é€æ­¥ä¼˜åŒ–çš„è¿‡ç¨‹ã€‚ä½ ä¸èƒ½åƒçŒœæ•°å­—æ¸¸æˆé‚£æ ·ï¼Œæ ¹æ®â€å¤§äº†â€æˆ–â€å°äº†â€æ¥è°ƒæ•´ä¸‹ä¸€æ¬¡çŒœæµ‹ã€‚æ¯ä¸€æ¬¡å°è¯•éƒ½æ˜¯ä¸€æ¬¡ç‹¬ç«‹çš„ã€å…¨æ–°çš„â€ç›²çŒœâ€ã€‚</li></ul><p>è¿™è®©å¯»æ‰¾ç¢°æ’å˜æˆäº†ä¸€åœºçº¯ç²¹çš„ã€æš´åŠ›çš„ã€è¿æ°”å·®åˆ°æç‚¹çš„â€æŠ½å¥–â€ã€‚</p><p><strong>2. éçº¿æ€§æ“ä½œï¼ˆNon-linearityï¼‰</strong></p><p>æˆ‘ä»¬åˆšåˆšåˆ†æè¿‡çš„ <code>Ch</code> (Choose) å’Œ <code>Maj</code> (Majority) å‡½æ•°æ˜¯å…³é”®ã€‚å¦‚æœæ•´ä¸ªå“ˆå¸Œè¿‡ç¨‹éƒ½æ˜¯çº¿æ€§çš„ï¼ˆæ¯”å¦‚åªæœ‰åŠ æ³•ã€å¼‚æˆ–ã€ç§»ä½ï¼‰ï¼Œé‚£å¯†ç å­¦å®¶å°±å¯ä»¥æ„å»ºä¸€å¥—å·¨å¤§çš„çº¿æ€§æ–¹ç¨‹ç»„ï¼Œç„¶åç”¨è®¡ç®—æœºâ€è§£æ–¹ç¨‹â€çš„æ–¹å¼æ¥æ‰¾åˆ°ç¢°æ’ã€‚</p><p>ä½†è¿™äº›éçº¿æ€§å‡½æ•°çš„å¼•å…¥ï¼Œå½»åº•æ‰“ä¹±äº†è¿™ç§å¯èƒ½æ€§ã€‚å®ƒè®©æ•´ä¸ªç³»ç»Ÿå˜å¾—æ— æ³•ç”¨ç®€å•çš„æ•°å­¦æ–¹ç¨‹æ¥æè¿°å’Œæ±‚è§£ã€‚å°±å¥½åƒä½ æ²¡æ³•é€šè¿‡åˆ†æä¸€å—è›‹ç³•çš„æˆåˆ†ï¼Œæ¥ç²¾ç¡®åæ¨å‡ºçƒ¤ç®±çš„æ¸©åº¦å’Œçƒ˜ç„™æ—¶é—´ä¸€æ ·ã€‚</p><p><strong>3. ç”Ÿæ—¥æ”»å‡»ï¼ˆBirthday Attackï¼‰ä¸ææ€–çš„ <code>2^128</code></strong></p><p>é»‘å®¢ä»¬ä¹Ÿä¸æ˜¯åªä¼šâ€ç›²çŒœâ€ã€‚ä»–ä»¬èƒ½ç”¨çš„æœ€æœ‰æ•ˆçš„å¯»æ‰¾ç¢°æ’çš„æ·å¾„ï¼Œå«åšâ€<strong>ç”Ÿæ—¥æ”»å‡»</strong>â€œã€‚</p><p>è¿™ä¸ªåå­—æ¥æºäºâ€ç”Ÿæ—¥æ‚–è®ºâ€ï¼šä¸€ä¸ª 23 äººçš„æˆ¿é—´é‡Œï¼Œæœ‰ä¸¤ä¸ªäººåŒä¸€å¤©ç”Ÿæ—¥çš„æ¦‚ç‡å°±è¶…è¿‡äº† 50%ã€‚è¿™æ¯”ç›´è§‰è¦é«˜å¾—å¤šã€‚</p><p>åº”ç”¨åˆ°å“ˆå¸Œç¢°æ’ä¸Šï¼šæˆ‘ä»¬ä¸éœ€è¦å°è¯• <code>2^256</code> æ¬¡æ‰èƒ½æ‰¾åˆ°ä¸€ä¸ªç¢°æ’ã€‚æ ¹æ®æ¦‚ç‡å­¦ï¼Œæˆ‘ä»¬åªéœ€è¦è®¡ç®—å¤§çº¦ <code>sqrt(2^256) = 2^128</code> ä¸ªä¸åŒè¾“å…¥çš„å“ˆå¸Œå€¼ï¼Œå°±æœ‰å¾ˆå¤§æ¦‚ç‡åœ¨è¿™äº›ç»“æœä¸­æ‰¾åˆ°ä¸€å¯¹ç¢°æ’ã€‚</p><p><code>2^128</code> æ¬¡ï¼è¿™çœ‹èµ·æ¥æ¯” <code>2^256</code> å°å¤šäº†ï¼Œå¯¹å§ï¼Ÿ</p><p>ä½†å®ƒä¾ç„¶æ˜¯ä¸ªæ— æ³•æƒ³è±¡çš„æ•°å­—ã€‚è¿™ä¹ˆè¯´å§ï¼š</p><blockquote><p>å‡è®¾ä½ æ‹¥æœ‰å½“å‰åœ°çƒä¸Šæœ€å¼ºçš„ç®—åŠ›ï¼Œç”¨å…¨ä¸–ç•Œæ‰€æœ‰çš„è®¡ç®—æœºä¸€èµ·æ¥ç®—ã€‚è¦æƒ³å®Œæˆ <code>2^128</code> æ¬¡ SHA-256 è®¡ç®—ï¼Œæ‰€éœ€è¦çš„æ—¶é—´ï¼Œå¯èƒ½æ¯”å®‡å®™çš„å¹´é¾„ï¼ˆçº¦ 138 äº¿å¹´ï¼‰è¿˜è¦é•¿å¾—å¤šå¾—å¤šã€‚</p></blockquote><p>è¿™å°±æ˜¯æˆ‘ä»¬è¯´å®ƒâ€<strong>è®¡ç®—ä¸Šä¸å¯è¡Œ</strong>â€œï¼ˆComputationally Infeasibleï¼‰çš„çœŸæ­£å«ä¹‰ã€‚å®ƒåœ¨ç†è®ºä¸Šå¯è¡Œï¼Œä½†åœ¨å¯é¢„è§çš„æœªæ¥ï¼Œä»¥äººç±»å·²çŸ¥çš„ä»»ä½•æŠ€æœ¯ï¼Œéƒ½æ— æ³•å®Œæˆã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æˆ‘ä»¬å†å›é¡¾ä¸€ä¸‹è¿™è¶Ÿæ—…ç¨‹ï¼š</p><ol><li><strong>æ‰“åŒ…è¡Œæï¼ˆå¡«å……ï¼‰</strong>ï¼šæŠŠä»»æ„é•¿åº¦çš„æ•°æ®ï¼ŒæŒ‰ç…§ä¸¥æ ¼è§„å®šæ‰“åŒ…æˆä¸€æˆ–å¤šä¸ª 512 ä½çš„è¡Œæç®±ã€‚</li><li><strong>è®¾å®šèµ·ç‚¹ï¼ˆåˆå§‹Hå€¼ï¼‰</strong>ï¼šæ‹¿å‡ºå¯†ç å­¦å®¶ç»™æˆ‘ä»¬çš„ã€æºäºç´ æ•°å¹³æ–¹æ ¹çš„â€é­”æ³•æ•°å­—â€ä½œä¸ºèµ·ç‚¹ã€‚</li><li><strong>å¾ªç¯æ…æ‹Œï¼ˆå‹ç¼©å‡½æ•°ï¼‰</strong>ï¼šå¯¹æ¯ä¸€ä¸ªè¡Œæç®±ï¼Œéƒ½ç”¨ä¸€å¥—åŒ…å« 64 é“å·¥åºçš„å¤æ‚æµç¨‹ï¼ˆæ¶ˆæ¯è°ƒåº¦ã€ç§»ä½ã€å¼‚æˆ–ã€éçº¿æ€§å‡½æ•°ï¼‰è¿›è¡Œæ…æ‹Œï¼Œå¹¶æŠŠæ…æ‹Œç»“æœå’Œä¸Šä¸€è½®çš„ç»“æœæ··åˆã€‚</li><li><strong>å¾—å‡ºç»ˆç‚¹ï¼ˆæœ€ç»ˆå“ˆå¸Œï¼‰</strong>ï¼šå½“æ‰€æœ‰è¡Œæç®±éƒ½æ…æ‹Œå®Œæ¯•ï¼Œæœ€åè¾“å‡ºçš„ç»“æœå°±æ˜¯æœ€ç»ˆçš„å“ˆå¸Œå€¼ã€‚</li></ol><p>è¿™å¥—æµç¨‹è¢«è®¾è®¡å¾—å¦‚æ­¤å¤æ‚å’Œç²¾å¦™ï¼Œå……æ»¡äº†å„ç§éçº¿æ€§å’Œæ‰©æ•£æ“ä½œï¼Œç›®çš„å°±æ˜¯ä¸ºäº†è®©å®ƒæˆä¸ºä¸€ä¸ªçœŸæ­£çš„â€å•å‘â€è¿‡ç¨‹ï¼Œè®©ä»»ä½•è¯•å›¾ä»ç»“æœåæ¨è¾“å…¥çš„åŠªåŠ›ï¼Œéƒ½æ·¹æ²¡åœ¨è®¡ç®—é‡çš„æ±ªæ´‹å¤§æµ·ä¹‹ä¸­ã€‚</p><p>è€Œæ­£æ˜¯å› ä¸ºè¿™ç§â€è®¡ç®—ä¸Šä¸å¯è¡Œâ€çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬æ‰èƒ½åœ¨ç†è®ºä¸Šæ‰¿è®¤ç¢°æ’å¿…ç„¶å­˜åœ¨çš„åŒæ—¶ï¼Œåœ¨ç°å®ä¸­æ”¾å¿ƒåœ°ä¾èµ– SHA-256 æ¥ç¡®ä¿æ•°æ®çš„å®Œæ•´æ€§ã€‚æˆ‘ä»¬ä¸æ˜¯åœ¨å’Œæ•°å­¦åšå¼ˆï¼Œæˆ‘ä»¬æ˜¯åœ¨å’Œå®‡å®™çš„ç‰©ç†å®šå¾‹ã€èƒ½é‡å’Œæ—¶é—´æœ¬èº«åšå¼ˆã€‚</p><p>ç°åœ¨ï¼Œå½“ä½ å†åœ¨ä»£ç é‡Œè°ƒç”¨ <code>sha256(data)</code> æ—¶ï¼Œå¸Œæœ›ä½ èƒ½ä¼šå¿ƒä¸€ç¬‘ï¼Œå› ä¸ºä½ å·²ç»çŸ¥é“äº†è¿™å°â€æ…æ‹Œæœºâ€å†…éƒ¨çš„ç§˜å¯†ã€‚ </p><h2 id="æ‰©å±•"><a href="#æ‰©å±•" class="headerlink" title="æ‰©å±•"></a>æ‰©å±•</h2><ol><li>å¦‚æœä½ æƒ³äº²çœ¼çœ‹çœ‹å“ˆå¸Œçš„è®¡ç®—è¿‡ç¨‹ï¼Œå…¶å®æœ‰ä¸€ä¸ªåœ¨çº¿å¯è§†åŒ–ç½‘ç«™ï¼š<a href="https://sha256algorithm.com/%EF%BC%8C%E5%8F%AF%E4%BB%A5%E6%8F%90%E4%BE%9B">https://sha256algorithm.com/ï¼Œå¯ä»¥æä¾›</a> sha256çš„å…¨è¿‡ç¨‹å±•ç¤ºï¼Œéå¸¸çš„ç›´è§‚ã€‚</li><li>å¦‚æœä½ æƒ³è¦çœ‹å…·ä½“çš„ç®—æ³•å®ç°ï¼Œå¯ä»¥çœ‹è¿™ä¸ªï¼š<a href="https://zhuanlan.zhihu.com/p/94619052">https://zhuanlan.zhihu.com/p/94619052</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å“ˆå¸Œ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>èŠèŠåŒé‡æ£€æŸ¥é”å®šï¼ˆDouble-Checked Lockingï¼‰è¿™ç‚¹äº‹</title>
      <link href="/2025/06/17/%E8%AF%A6%E7%BB%86%E8%AF%B4%E8%AF%B4%E5%8F%8C%E9%87%8D%E6%A3%80%E6%9F%A5%E9%94%81%E5%AE%9A/"/>
      <url>/2025/06/17/%E8%AF%A6%E7%BB%86%E8%AF%B4%E8%AF%B4%E5%8F%8C%E9%87%8D%E6%A3%80%E6%9F%A5%E9%94%81%E5%AE%9A/</url>
      
        <content type="html"><![CDATA[<p>åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦å»¶è¿Ÿåˆå§‹åŒ–ï¼ˆLazy Initializationï¼‰æŸä¸ªå¯¹è±¡ï¼Œç‰¹åˆ«æ˜¯åœ¨å®ç°å•ä¾‹æ¨¡å¼æ—¶ã€‚æœ€ç®€å•ç²—æš´çš„æ–¹æ³•å½“ç„¶æ˜¯ç›´æ¥ä¸Š <code>synchronized</code>ï¼Œä½†ç”±æ­¤å¸¦æ¥çš„æ€§èƒ½é—®é¢˜ä¹Ÿè®©æˆ‘ä»¬ä¸å¾—ä¸å¯»æ‰¾æ›´ä¼˜çš„æ–¹æ¡ˆã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬å°±æ¥æ·±å…¥èŠèŠå¤§åé¼é¼çš„åŒé‡æ£€æŸ¥é”å®šï¼ˆDouble-Checked Locking, DCLï¼‰ï¼Œçœ‹çœ‹å®ƒåˆ°åº•ç‰›åœ¨å“ªé‡Œï¼Œåˆæœ‰å“ªäº›å‘éœ€è¦æˆ‘ä»¬æ³¨æ„ã€‚</p><h3 id="é—®é¢˜åœ¨å“ªï¼Ÿæ— è„‘-synchronized-çš„æ€§èƒ½ç“¶é¢ˆ"><a href="#é—®é¢˜åœ¨å“ªï¼Ÿæ— è„‘-synchronized-çš„æ€§èƒ½ç“¶é¢ˆ" class="headerlink" title="é—®é¢˜åœ¨å“ªï¼Ÿæ— è„‘ synchronized çš„æ€§èƒ½ç“¶é¢ˆ"></a>é—®é¢˜åœ¨å“ªï¼Ÿæ— è„‘ <code>synchronized</code> çš„æ€§èƒ½ç“¶é¢ˆ</h3><p>å’±ä»¬å…ˆçœ‹ä¸€ä¸ªæœ€ç›´è§‚çš„å•ä¾‹å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton instance;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç›´æ¥åœ¨æ–¹æ³•ä¸ŠåŠ é”</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> Singleton <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> <span class="title class_">Singleton</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç ç®€å•æ˜äº†ï¼Œ<code>synchronized</code> å…³é”®å­—ç¡®ä¿äº† <code>getInstance()</code> æ–¹æ³•åœ¨åŒä¸€æ—¶é—´åªä¼šè¢«ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œä»è€Œä¿è¯äº†çº¿ç¨‹å®‰å…¨ã€‚</p><p>ä½†é—®é¢˜ä¹Ÿéšä¹‹è€Œæ¥ã€‚<code>synchronized</code> æ˜¯ä¸€æŠŠâ€é‡é”â€ï¼Œä¸€æ—¦å®ä¾‹è¢«åˆ›å»ºä¹‹åï¼Œå®é™…ä¸Šæˆ‘ä»¬ä¸å†éœ€è¦ä»»ä½•åŒæ­¥äº†ï¼Œå› ä¸º <code>instance</code> ä¸å†æ˜¯ <code>null</code>ï¼Œåç»­çš„æ‰€æœ‰ <code>if</code> åˆ¤æ–­éƒ½æ˜¯ <code>false</code>ï¼Œç›´æ¥è¿”å›å³å¯ã€‚å¯ <code>synchronized</code> ä¼šè®©æ‰€æœ‰è°ƒç”¨ <code>getInstance()</code> çš„çº¿ç¨‹ï¼Œæ— è®ºå®ä¾‹æ˜¯å¦å·²åˆ›å»ºï¼Œéƒ½å¾—æ’é˜Ÿç­‰å¾…è·å–é”ã€‚åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œè¿™é‡Œä¼šæˆä¸ºä¸€ä¸ªå·¨å¤§çš„æ€§èƒ½ç“¶é¢ˆï¼Œå¤§é‡çš„çº¿ç¨‹éƒ½åœ¨åšæ— æ„ä¹‰çš„ç­‰å¾…ã€‚</p><h3 id="æ›´èªæ˜çš„ç©æ³•ï¼šåŒé‡æ£€æŸ¥é”å®šï¼ˆDCLï¼‰"><a href="#æ›´èªæ˜çš„ç©æ³•ï¼šåŒé‡æ£€æŸ¥é”å®šï¼ˆDCLï¼‰" class="headerlink" title="æ›´èªæ˜çš„ç©æ³•ï¼šåŒé‡æ£€æŸ¥é”å®šï¼ˆDCLï¼‰"></a>æ›´èªæ˜çš„ç©æ³•ï¼šåŒé‡æ£€æŸ¥é”å®šï¼ˆDCLï¼‰</h3><p>ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œå‰è¾ˆä»¬æƒ³å‡ºäº†ä¸€ä¸ªæ›´å·§å¦™çš„åŠæ³•â€”â€”åŒé‡æ£€æŸ¥é”å®šã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š<strong>åªæœ‰åœ¨å®ä¾‹æœªè¢«åˆ›å»ºæ—¶æ‰è¿›è¡ŒåŒæ­¥ï¼Œä¸€æ—¦åˆ›å»ºæˆåŠŸï¼Œå°±å†ä¹Ÿä¸ç”¨é”äº†ã€‚</strong></p><p>ç›´æ¥ä¸Šä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line">    <span class="comment">// å…³é”®ç‚¹1: volatile</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Singleton instance;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// å…³é”®ç‚¹2: ç¬¬ä¸€æ¬¡æ£€æŸ¥ï¼ˆæ— é”ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// å…³é”®ç‚¹3: åŒæ­¥å—</span></span><br><span class="line">            <span class="keyword">synchronized</span> (Singleton.class) &#123;</span><br><span class="line">                <span class="comment">// å…³é”®ç‚¹4: ç¬¬äºŒæ¬¡æ£€æŸ¥ï¼ˆæœ‰é”ï¼‰</span></span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> <span class="title class_">Singleton</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå®ç°çœ‹èµ·æ¥å¤æ‚äº†ä¸€äº›ï¼Œä½†é€»è¾‘éå¸¸æ¸…æ™°ï¼š</p><ol><li><strong>ç¬¬ä¸€æ¬¡æ£€æŸ¥ï¼ˆæ— é”ï¼‰</strong>ï¼š<code>if (instance == null)</code>ã€‚è¿™æ˜¯ä¸€ä¸ªæ— é”çš„è¯»æ“ä½œã€‚å¦‚æœå®ä¾‹å·²ç»å­˜åœ¨ï¼Œçº¿ç¨‹å°±ç›´æ¥è¿”å›ï¼Œå®Œå…¨é¿å…äº†é”çš„å¼€é”€ã€‚è¿™æ˜¯ DCL é«˜æ€§èƒ½çš„å…³é”®ã€‚</li><li><strong>åŒæ­¥å—</strong>ï¼šåªæœ‰å½“ <code>instance</code> ä¸º <code>null</code> æ—¶ï¼Œçº¿ç¨‹æ‰ä¼šå°è¯•è¿›å…¥ <code>synchronized</code> ä»£ç å—ã€‚è¿™ç¡®ä¿äº†åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ‰§è¡Œå®ä¾‹çš„åˆ›å»ºé€»è¾‘ã€‚</li><li><strong>ç¬¬äºŒæ¬¡æ£€æŸ¥ï¼ˆæœ‰é”ï¼‰</strong>ï¼š<code>if (instance == null)</code>ã€‚è¿™æ˜¯ DCL çš„ç²¾é«“æ‰€åœ¨ã€‚å®ƒé˜²æ­¢äº†å¤šä¸ªçº¿ç¨‹åœ¨ç¬¬ä¸€æ¬¡æ£€æŸ¥éƒ½é€šè¿‡åï¼Œé‡å¤åˆ›å»ºå®ä¾‹ã€‚</li></ol><p>ä½ å¯èƒ½ä¼šé—®ï¼Œæ—¢ç„¶å¤–é¢å·²ç»æ£€æŸ¥è¿‡ä¸€æ¬¡äº†ï¼Œä¸ºä»€ä¹ˆè¿›äº†åŒæ­¥å—è¿˜è¦å†æ£€æŸ¥ä¸€æ¬¡ï¼Ÿ</p><p>æƒ³è±¡ä¸€ä¸‹è¿™ä¸ªåœºæ™¯ï¼šçº¿ç¨‹ A å’Œ B åŒæ—¶æ‰§è¡Œåˆ°ç¬¬ä¸€æ¬¡æ£€æŸ¥ï¼Œéƒ½å‘ç° <code>instance</code> æ˜¯ <code>null</code>ã€‚å®ƒä»¬éƒ½æƒ³è¿›å…¥åŒæ­¥å—ï¼Œå‡è®¾çº¿ç¨‹ A æŠ¢åˆ°äº†é”ï¼Œè¿›å…¥ä»£ç å—ï¼Œåˆ›å»ºäº†å®ä¾‹ï¼Œç„¶åé‡Šæ”¾é”ã€‚æ­¤æ—¶çº¿ç¨‹ B æ‹¿åˆ°äº†é”ï¼Œå¦‚æœåŒæ­¥å—é‡Œæ²¡æœ‰ç¬¬äºŒå±‚æ£€æŸ¥ï¼Œçº¿ç¨‹ B å°±ä¼šæ¯«ä¸çŸ¥æƒ…åœ°å†æ¬¡åˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹ï¼Œè¿™å°±ç ´åäº†å•ä¾‹çš„åˆè¡·ã€‚ç¬¬äºŒæ¬¡æ£€æŸ¥æ­£æ˜¯ä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µå‘ç”Ÿã€‚</p><p>ä¸‹é¢è¿™ä¸ªæµç¨‹å›¾èƒ½å¸®ä½ æ›´å¥½åœ°ç†è§£è¿™ä¸ªè¿‡ç¨‹ï¼š</p><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    A[å¼€å§‹] --&gt; B{instance &#x3D;&#x3D; null?}    B --&gt;|å¦| G[è¿”å›å®ä¾‹]    B --&gt;|æ˜¯| C[è¿›å…¥åŒæ­¥å—]    C --&gt; D{instance &#x3D;&#x3D; null?}    D --&gt;|å¦| E[é€€å‡ºåŒæ­¥å—]    D --&gt;|æ˜¯| F[åˆ›å»ºæ–°å®ä¾‹]    F --&gt; E    E --&gt; G  </pre></div><h3 id="çµé­‚æ‹·é—®ï¼švolatile-åˆ°åº•åœ¨å¹²å˜›ï¼Ÿ"><a href="#çµé­‚æ‹·é—®ï¼švolatile-åˆ°åº•åœ¨å¹²å˜›ï¼Ÿ" class="headerlink" title="çµé­‚æ‹·é—®ï¼švolatile åˆ°åº•åœ¨å¹²å˜›ï¼Ÿ"></a>çµé­‚æ‹·é—®ï¼š<code>volatile</code> åˆ°åº•åœ¨å¹²å˜›ï¼Ÿ</h3><p>åœ¨ DCL çš„å®ç°ä¸­ï¼Œ<code>volatile</code> å…³é”®å­—æ˜¯ç»å¯¹ä¸èƒ½å°‘çš„ã€‚å¦‚æœå°‘äº†å®ƒï¼Œçœ‹ä¼¼æ­£å¸¸çš„ä»£ç åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å¯èƒ½ä¼šå‡ºç°è‡´å‘½é—®é¢˜ã€‚è¿™å°±è¦æåˆ° JVM çš„<strong>æŒ‡ä»¤é‡æ’åº</strong>äº†ã€‚</p><p><code>instance = new Singleton()</code> è¿™è¡Œä»£ç ï¼Œåœ¨æˆ‘ä»¬çœ‹æ¥æ˜¯ä¸€æ­¥æ“ä½œï¼Œä½†åœ¨ JVM å†…éƒ¨ï¼Œå®ƒå¤§è‡´åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š</p><ol><li><strong>åˆ†é…å†…å­˜</strong>ï¼šä¸º <code>Singleton</code> å¯¹è±¡åˆ†é…ä¸€å—å†…å­˜ç©ºé—´ã€‚</li><li><strong>åˆå§‹åŒ–å¯¹è±¡</strong>ï¼šè°ƒç”¨ <code>Singleton</code> çš„æ„é€ å‡½æ•°ï¼Œå¯¹å¯¹è±¡è¿›è¡Œåˆå§‹åŒ–ã€‚</li><li><strong>å»ºç«‹è¿æ¥</strong>ï¼šå°† <code>instance</code> å¼•ç”¨æŒ‡å‘åˆ†é…å¥½çš„å†…å­˜åœ°å€ã€‚</li></ol><p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œé¡ºåºæ˜¯ <code>1 -&gt; 2 -&gt; 3</code>ã€‚ä½†ä¸ºäº†æ€§èƒ½ä¼˜åŒ–ï¼ŒJVM å¯èƒ½ä¼šå¯¹æŒ‡ä»¤è¿›è¡Œé‡æ’åºï¼ŒæŠŠé¡ºåºå˜æˆ <code>1 -&gt; 3 -&gt; 2</code>ã€‚</p><p>è¿™æ—¶å€™é—®é¢˜å°±æ¥äº†ï¼š</p><ol><li>çº¿ç¨‹ A æ‰§è¡Œ <code>instance = new Singleton()</code>ã€‚</li><li>ç”±äºæŒ‡ä»¤é‡æ’åºï¼ŒJVM å…ˆæ‰§è¡Œäº†æ­¥éª¤ 1 å’Œ 3ï¼Œ<code>instance</code> å¼•ç”¨è¢«èµ‹å€¼ï¼Œä¸å†æ˜¯ <code>null</code>ã€‚</li><li>æ­¤æ—¶ï¼Œçº¿ç¨‹ B è°ƒç”¨ <code>getInstance()</code>ï¼Œæ‰§è¡Œç¬¬ä¸€æ¬¡æ£€æŸ¥ <code>if (instance == null)</code>ã€‚å®ƒä¼šå‘ç° <code>instance</code> å·²ç»ä¸æ˜¯ <code>null</code> äº†ï¼Œäºæ˜¯ç›´æ¥è¿”å› <code>instance</code>ã€‚</li><li>ä½†å®é™…ä¸Šï¼Œçº¿ç¨‹ A çš„æ­¥éª¤ 2 (åˆå§‹åŒ–å¯¹è±¡) è¿˜æ²¡æ‰§è¡Œå®Œã€‚çº¿ç¨‹ B æ‹¿åˆ°çš„ <code>instance</code> æ˜¯ä¸€ä¸ª<strong>æœªå®Œå…¨åˆå§‹åŒ–çš„å¯¹è±¡</strong>ã€‚å¦‚æœæ­¤æ—¶å»ä½¿ç”¨è¿™ä¸ªå¯¹è±¡ï¼Œå°±å¯èƒ½å¼•å‘å„ç§è¯¡å¼‚çš„é”™è¯¯ã€‚</li></ol><p>è€Œ <code>volatile</code> å…³é”®å­—æœ‰ä¸¤å¤§ä½œç”¨ï¼š</p><ol><li><strong>ç¦æ­¢æŒ‡ä»¤é‡æ’åº</strong>ï¼šç¡®ä¿ <code>instance = new Singleton()</code> çš„æ“ä½œæŒ‰ç…§ <code>1 -&gt; 2 -&gt; 3</code> çš„é¡ºåºæ‰§è¡Œï¼Œä¸ä¼šå‡ºç°ä¸Šé¢é‚£ç§â€åŠæˆå“â€å¯¹è±¡çš„æƒ…å†µã€‚</li><li><strong>ä¿è¯å¯è§æ€§</strong>ï¼šå½“ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº† <code>instance</code> çš„å€¼ï¼Œè¿™ä¸ªæ–°å€¼ä¼šç«‹åˆ»å¯¹å…¶ä»–çº¿ç¨‹å¯è§ã€‚</li></ol><p>æ‰€ä»¥ï¼Œ<code>volatile</code> æ˜¯ç¡®ä¿ DCL çº¿ç¨‹å®‰å…¨çš„æœ€åä¸€é“ï¼Œä¹Ÿæ˜¯æœ€å…³é”®çš„ä¸€é“é˜²çº¿ã€‚</p><h3 id="è¿˜æœ‰æ²¡æœ‰æ›´å¥½çš„é€‰æ‹©ï¼Ÿ"><a href="#è¿˜æœ‰æ²¡æœ‰æ›´å¥½çš„é€‰æ‹©ï¼Ÿ" class="headerlink" title="è¿˜æœ‰æ²¡æœ‰æ›´å¥½çš„é€‰æ‹©ï¼Ÿ"></a>è¿˜æœ‰æ²¡æœ‰æ›´å¥½çš„é€‰æ‹©ï¼Ÿ</h3><p>å½“ç„¶æœ‰ï¼DCL è™½ç„¶é«˜æ•ˆï¼Œä½†å†™æ³•ç›¸å¯¹å¤æ‚ï¼Œå®¹æ˜“å‡ºé”™ã€‚åœ¨ç°ä»£ Java ä¸­ï¼Œæˆ‘ä»¬æœ‰æ›´ç®€æ´ã€æ›´å®‰å…¨çš„å®ç°æ–¹å¼ã€‚</p><h4 id="é™æ€å†…éƒ¨ç±»ï¼ˆLazy-Initialization-Holder-Classï¼‰"><a href="#é™æ€å†…éƒ¨ç±»ï¼ˆLazy-Initialization-Holder-Classï¼‰" class="headerlink" title="é™æ€å†…éƒ¨ç±»ï¼ˆLazy Initialization Holder Classï¼‰"></a>é™æ€å†…éƒ¨ç±»ï¼ˆLazy Initialization Holder Classï¼‰</h4><p>è¿™æ˜¯ç›®å‰æœ€å—æ¨èçš„å•ä¾‹å®ç°æ–¹å¼ä¹‹ä¸€ã€‚å®ƒåˆ©ç”¨äº† JVM ç±»åŠ è½½æœºåˆ¶æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line">    <span class="comment">// ç§æœ‰æ„é€ </span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é™æ€å†…éƒ¨ç±»</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Holder</span> &#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Singleton</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Singleton</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Holder.INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ <code>getInstance()</code> æ–¹æ³•ç¬¬ä¸€æ¬¡è¢«è°ƒç”¨æ—¶ï¼Œ<code>Holder</code> ç±»æ‰ä¼šè¢«åŠ è½½ï¼Œæ­¤æ—¶ JVM ä¼šä¿è¯ <code>INSTANCE</code> åªè¢«åˆå§‹åŒ–ä¸€æ¬¡ï¼Œå¹¶ä¸”è¿™ä¸ªè¿‡ç¨‹æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚è¿™ç§æ–¹å¼æ—¢å®ç°äº†æ‡’åŠ è½½ï¼Œåˆæ— éœ€ä»»ä½•åŒæ­¥é”ï¼Œä»£ç ä¹Ÿæ›´ç®€å•ã€‚</p><h4 id="æšä¸¾å•ä¾‹"><a href="#æšä¸¾å•ä¾‹" class="headerlink" title="æšä¸¾å•ä¾‹"></a>æšä¸¾å•ä¾‹</h4><p>è¿™æ˜¯ã€ŠEffective Javaã€‹ä½œè€… Joshua Bloch æåŠ›æ¨å´‡çš„æ–¹å¼ã€‚å®ƒä¸ä»…å†™æ³•è¶…çº§ç®€å•ï¼Œè¿˜èƒ½å¤©ç„¶é˜²æ­¢åå°„å’Œååºåˆ—åŒ–æ”»å‡»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line">    INSTANCE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">someMethod</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨æ—¶ç›´æ¥ä½¿ç”¨ <code>Singleton.INSTANCE</code> å³å¯ã€‚å¦‚æœä½ ä¸éœ€è¦æ‡’åŠ è½½ï¼Œè¿™æ— ç–‘æ˜¯æœ€ä½³é€‰æ‹©ã€‚</p><h3 id="æ€»ç»“ä¸€ä¸‹"><a href="#æ€»ç»“ä¸€ä¸‹" class="headerlink" title="æ€»ç»“ä¸€ä¸‹"></a>æ€»ç»“ä¸€ä¸‹</h3><p>æˆ‘ä»¬æ¥å¯¹æ¯”ä¸€ä¸‹è¿™å‡ ç§æ–¹æ¡ˆçš„ä¼˜åŠ£ï¼š</p><table><thead><tr><th>æ–¹æ¡ˆ</th><th>ä¼˜ç‚¹</th><th>ç¼ºç‚¹</th></tr></thead><tbody><tr><td><strong>ç›´æ¥ <code>synchronized</code></strong></td><td>å®ç°ç®€å•ï¼Œç»å¯¹çº¿ç¨‹å®‰å…¨</td><td>æ€§èƒ½å·®ï¼Œæ— è®ºæ˜¯å¦éœ€è¦éƒ½ä¼šåŠ é”</td></tr><tr><td><strong>åŒé‡æ£€æŸ¥é”å®š (DCL)</strong></td><td>æ€§èƒ½é«˜ï¼Œåªåœ¨é¦–æ¬¡åˆå§‹åŒ–æ—¶åŠ é”</td><td>å†™æ³•å¤æ‚ï¼Œå¿…é¡»æ­£ç¡®ä½¿ç”¨ <code>volatile</code></td></tr><tr><td><strong>é™æ€å†…éƒ¨ç±»</strong></td><td>æ— é”ã€çº¿ç¨‹å®‰å…¨ã€å†™æ³•ç®€å•ã€æ‡’åŠ è½½</td><td>ç›¸å¯¹DCLä»£ç ç¨å¤šä¸€ç‚¹</td></tr><tr><td><strong>æšä¸¾å•ä¾‹</strong></td><td>æç®€ã€é˜²åå°„ã€é˜²åºåˆ—åŒ–</td><td>éæ‡’åŠ è½½</td></tr></tbody></table><p>æ€»çš„æ¥è¯´ï¼ŒåŒé‡æ£€æŸ¥é”å®šï¼ˆDCLï¼‰æ˜¯ä¸€ä¸ªåœ¨ç‰¹å®šåœºæ™¯ä¸‹ï¼ˆä¾‹å¦‚éœ€è¦æ‡’åŠ è½½ä¸”è¿½æ±‚æè‡´æ€§èƒ½ï¼‰éå¸¸ç»å…¸çš„è§£å†³æ–¹æ¡ˆï¼Œä½†æˆ‘ä»¬å¿…é¡»æ·±åˆ»ç†è§£å…¶èƒŒåçš„ <code>volatile</code> å’ŒæŒ‡ä»¤é‡æ’åºåŸç†ï¼Œæ‰èƒ½æ­£ç¡®åœ°ä½¿ç”¨å®ƒã€‚</p><p>ä¸è¿‡ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œ<strong>é™æ€å†…éƒ¨ç±»</strong>å’Œ<strong>æšä¸¾</strong>é€šå¸¸æ˜¯æ›´æ¨èã€æ›´å®‰å…¨çš„é€‰æ‹©ã€‚ä½œä¸ºå¼€å‘è€…ï¼Œäº†è§£ DCL ä¸ä»…æ˜¯ä¸ºäº†åœ¨é¢è¯•ä¸­è„±é¢–è€Œå‡ºï¼Œæ›´æ˜¯ä¸ºäº†åŠ æ·±æˆ‘ä»¬å¯¹å¹¶å‘ç¼–ç¨‹åº•å±‚åŸç†çš„ç†è§£ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> å¹¶å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è§£å¯† Spring MVCï¼šä» Tomcat åˆ° Controller çš„ä¸€æ¬¡å®Œæ•´è¯·æ±‚ä¹‹æ—…</title>
      <link href="/2025/06/17/%E8%A7%A3%E5%AF%86%20Spring%20MVC%EF%BC%9A%E4%BB%8E%20Tomcat%20%E5%88%B0%20Controller%20%E7%9A%84%E4%B8%80%E6%AC%A1%E5%AE%8C%E6%95%B4%E8%AF%B7%E6%B1%82%E4%B9%8B%E6%97%85/"/>
      <url>/2025/06/17/%E8%A7%A3%E5%AF%86%20Spring%20MVC%EF%BC%9A%E4%BB%8E%20Tomcat%20%E5%88%B0%20Controller%20%E7%9A%84%E4%B8%80%E6%AC%A1%E5%AE%8C%E6%95%B4%E8%AF%B7%E6%B1%82%E4%B9%8B%E6%97%85/</url>
      
        <content type="html"><![CDATA[<h1 id="è§£å¯†-Spring-MVCï¼šä»-Tomcat-åˆ°-Controller-çš„ä¸€æ¬¡å®Œæ•´è¯·æ±‚ä¹‹æ—…"><a href="#è§£å¯†-Spring-MVCï¼šä»-Tomcat-åˆ°-Controller-çš„ä¸€æ¬¡å®Œæ•´è¯·æ±‚ä¹‹æ—…" class="headerlink" title="è§£å¯† Spring MVCï¼šä» Tomcat åˆ° Controller çš„ä¸€æ¬¡å®Œæ•´è¯·æ±‚ä¹‹æ—…"></a>è§£å¯† Spring MVCï¼šä» Tomcat åˆ° Controller çš„ä¸€æ¬¡å®Œæ•´è¯·æ±‚ä¹‹æ—…</h1><p>ä»Šå¤©ï¼Œæƒ³å’Œä½ èŠä¸€ä¸ªæˆ‘ä»¬æ¯å¤©éƒ½åœ¨æ‰“äº¤é“ï¼Œä½†å¯èƒ½ä¸æ›¾æ·±å…¥æ€è€ƒçš„è¯é¢˜ï¼šå½“ä¸€ä¸ª HTTP è¯·æ±‚ä»æµè§ˆå™¨å‘å‡ºï¼Œåˆ°æœ€ç»ˆè¢«æˆ‘ä»¬çš„ Spring Controller å¤„ç†ï¼Œå®ƒåˆ°åº•ç»å†äº†ä¸€åœºæ€æ ·çš„æ—…ç¨‹ï¼Ÿ</p><p>ç†è§£è¿™ä¸ªæµç¨‹ï¼Œä¸ä»…ä»…æ˜¯ä¸ºäº†åº”ä»˜é¢è¯•ï¼Œæ›´æ˜¯ä¸ºäº†åœ¨é‡åˆ°æ£˜æ‰‹é—®é¢˜æ—¶ï¼Œèƒ½åƒåº–ä¸è§£ç‰›ä¸€æ ·ï¼Œç²¾å‡†å®šä½é—®é¢˜æ‰€åœ¨ã€‚è¿™è¶Ÿæ—…ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ™°åœ°åˆ’åˆ†ä¸ºä¸¤å¤§ç«™ï¼š<strong>Tomcat å¤„ç†é˜¶æ®µ</strong>å’Œ <strong>Spring MVC å¤„ç†é˜¶æ®µ</strong>ã€‚</p><hr><h2 id="ç¬¬ä¸€ç«™ï¼šTomcat-çš„å®ˆé—¨ä¸å¼•å¯¼"><a href="#ç¬¬ä¸€ç«™ï¼šTomcat-çš„å®ˆé—¨ä¸å¼•å¯¼" class="headerlink" title="ç¬¬ä¸€ç«™ï¼šTomcat çš„å®ˆé—¨ä¸å¼•å¯¼"></a>ç¬¬ä¸€ç«™ï¼šTomcat çš„å®ˆé—¨ä¸å¼•å¯¼</h2><p>åœ¨è¯·æ±‚è¿›å…¥ Spring çš„ä¸–ç•Œä¹‹å‰ï¼ŒTomcat ä½œä¸ºâ€å‰å“¨ç«™â€ï¼Œéœ€è¦å®Œæˆä¸€ç³»åˆ—çš„æ¥å¾…å’Œå¼•å¯¼å·¥ä½œã€‚</p><h3 id="1-é—¨å£çš„æ¥å¾…å‘˜ï¼šConnector"><a href="#1-é—¨å£çš„æ¥å¾…å‘˜ï¼šConnector" class="headerlink" title="1. é—¨å£çš„æ¥å¾…å‘˜ï¼šConnector"></a>1. é—¨å£çš„æ¥å¾…å‘˜ï¼šConnector</h3><p>å½“ä¸€ä¸ªè¯·æ±‚ï¼Œæ¯”å¦‚ <code>http://localhost:8080/user/info</code>ï¼Œæ•²å“ 8080 ç«¯å£çš„å¤§é—¨æ—¶ï¼ŒTomcat çš„ <strong>Connector</strong> ç»„ä»¶ç¬¬ä¸€ä¸ªç«™å‡ºæ¥è¿æ¥ã€‚å®ƒçš„èŒè´£å°±æ˜¯ç›‘å¬ç½‘ç»œç«¯å£ï¼Œæ¥æ”¶åŸå§‹çš„ TCP è¿æ¥ï¼Œå¹¶å°†å…¶è§£ææˆä¸€ä¸ªæ ‡å‡†çš„ <code>HttpServletRequest</code> å¯¹è±¡ã€‚</p><p>åŒæ—¶ï¼Œä¸ºäº†é«˜æ•ˆå¤„ç†å¹¶å‘ï¼ŒTomcat ä¼šä»ä¸€ä¸ªçº¿ç¨‹æ± ï¼ˆæ¯”å¦‚ <code>http-nio-8080-exec-1</code>ï¼‰ä¸­å–å‡ºä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œä¸“é—¨ä¸ºè¿™ä¸ªè¯·æ±‚æœåŠ¡ï¼Œç›´åˆ°å“åº”å®Œæˆã€‚</p><h3 id="2-å®¹å™¨çš„å±‚å±‚è·¯ç”±"><a href="#2-å®¹å™¨çš„å±‚å±‚è·¯ç”±" class="headerlink" title="2. å®¹å™¨çš„å±‚å±‚è·¯ç”±"></a>2. å®¹å™¨çš„å±‚å±‚è·¯ç”±</h3><p>è¯·æ±‚å¯¹è±¡åˆ›å»ºå¥½åï¼Œå°±è¿›å…¥äº† Tomcat çš„å®¹å™¨å†…éƒ¨ã€‚è¿™ä¸ªè¿‡ç¨‹å°±åƒä¸€ä¸ªä¿„ç½—æ–¯å¥—å¨ƒï¼Œè¯·æ±‚ä¼šä¾æ¬¡ç»è¿‡ <code>Engine</code> â†’ <code>Host</code> â†’ <code>Context</code> â†’ <code>Wrapper</code> è¿™å‡ å±‚ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼ªä»£ç ï¼šæ„Ÿå—ä¸€ä¸‹è¿™ä¸ªè°ƒç”¨é“¾</span></span><br><span class="line">connector.getService().getContainer().getPipeline().getFirst().invoke(request, response);</span><br></pre></td></tr></table></figure><ul><li><strong>Engine</strong>: å…¨å±€å¼•æ“ï¼ŒæœåŠ¡äºæ•´ä¸ª Tomcat å®ä¾‹ã€‚</li><li><strong>Host</strong>: è™šæ‹Ÿä¸»æœºï¼Œå¯¹åº”ä¸€ä¸ªåŸŸåï¼Œæ¯”å¦‚ <code>localhost</code>ã€‚</li><li><strong>Context</strong>: Web åº”ç”¨ï¼Œå¯¹åº”æˆ‘ä»¬çš„é¡¹ç›®ã€‚Tomcat åœ¨è¿™é‡Œæ ¹æ® <code>/</code> ä¹‹åçš„ URL è·¯å¾„ï¼ŒåŒ¹é…åˆ°å¤„ç†è¯¥è·¯å¾„çš„ <code>Context</code>ã€‚</li><li><strong>Wrapper</strong>: Servlet åŒ…è£…å™¨ã€‚æœ€ç»ˆï¼Œ<code>Context</code> ä¼šæ ¹æ® <code>web.xml</code> ä¸­é…ç½®çš„ <code>servlet-mapping</code>ï¼Œæ‰¾åˆ°å¤„ç†è¿™ä¸ªè¯·æ±‚çš„æœ€ç»ˆ Servletã€‚åœ¨ Spring Boot åº”ç”¨ä¸­ï¼Œè¿™ä¸ª Servlet é€šå¸¸å°±æ˜¯å¤§åé¼é¼çš„ <code>DispatcherServlet</code>ã€‚</li></ul><h3 id="3-ç¬¬ä¸€é“å®‰æ£€ï¼šè¿‡æ»¤å™¨é“¾-Filter-Chain"><a href="#3-ç¬¬ä¸€é“å®‰æ£€ï¼šè¿‡æ»¤å™¨é“¾-Filter-Chain" class="headerlink" title="3. ç¬¬ä¸€é“å®‰æ£€ï¼šè¿‡æ»¤å™¨é“¾ (Filter Chain)"></a>3. ç¬¬ä¸€é“å®‰æ£€ï¼šè¿‡æ»¤å™¨é“¾ (Filter Chain)</h3><p>åœ¨è¯·æ±‚è¢«æ­£å¼äº¤ç»™ <code>DispatcherServlet</code> ä¹‹å‰ï¼Œå®ƒå¿…é¡»å…ˆé€šè¿‡ä¸€ç³»åˆ—â€å®‰æ£€â€â€”â€”è¿™å°±æ˜¯<strong>è¿‡æ»¤å™¨ï¼ˆFilterï¼‰</strong>ã€‚</p><p>è¿‡æ»¤å™¨æ˜¯ Servlet è§„èŒƒçš„ä¸€éƒ¨åˆ†ï¼Œåƒä¸€é“é“å…³å¡ï¼ŒæŒ‰é¡ºåºæ‰§è¡Œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿‡æ»¤å™¨é“¾æ‰§è¡Œä¼ªä»£ç </span></span><br><span class="line"><span class="comment">// åªæœ‰å½“æ‰€æœ‰ Filter éƒ½æ”¾è¡Œï¼Œè¯·æ±‚æ‰ä¼šæœ€ç»ˆåˆ°è¾¾ Servlet</span></span><br><span class="line"><span class="keyword">for</span> (Filter filter : filters) &#123;</span><br><span class="line">    filter.doFilter(request, response, chain);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// é“¾çš„æœ«ç«¯ï¼Œè§¦å‘ Servlet çš„ service æ–¹æ³•</span></span><br><span class="line">chain.doFilter(request, response);</span><br></pre></td></tr></table></figure><p><strong>å®æˆ˜åœºæ™¯</strong>:</p><ul><li><code>CharacterEncodingFilter</code>: ç¡®ä¿å…¨ç«™è¯·æ±‚å’Œå“åº”çš„å­—ç¬¦é›†ç»Ÿä¸€ï¼Œé˜²æ­¢ä¹±ç ã€‚</li><li><code>CorsFilter</code>: è§£å†³è·¨åŸŸé—®é¢˜ï¼Œå…è®¸ç‰¹å®šæ¥æºçš„å‰ç«¯åº”ç”¨è®¿é—®ã€‚</li><li>è‡ªå®šä¹‰çš„ <code>JwtAuthFilter</code>: å¯¹å—ä¿æŠ¤çš„ API è¿›è¡Œèº«ä»½éªŒè¯ï¼Œè§£æ Tokenï¼Œå¹¶å°†ç”¨æˆ·ä¿¡æ¯å­˜å…¥ <code>SecurityContext</code>ã€‚</li><li><code>LoggingFilter</code>: è®°å½•æ‰€æœ‰è¯·æ±‚çš„è¯¦ç»†æ—¥å¿—ï¼Œä¾¿äºå®¡è®¡å’Œè°ƒè¯•ã€‚</li></ul><p>åªæœ‰é€šè¿‡äº†æ‰€æœ‰è¿‡æ»¤å™¨çš„â€ç›˜é—®â€ï¼Œè¯·æ±‚æ‰ç®—å®Œæˆäº†åœ¨ Tomcat é˜¶æ®µçš„æ—…ç¨‹ï¼Œæ­£å¼æ•²å“äº† Spring MVC çš„å¤§é—¨ã€‚</p><hr><h2 id="ç¬¬äºŒç«™ï¼šSpring-MVC-çš„è°ƒåº¦ä¸­å¿ƒ-DispatcherServlet"><a href="#ç¬¬äºŒç«™ï¼šSpring-MVC-çš„è°ƒåº¦ä¸­å¿ƒ-DispatcherServlet" class="headerlink" title="ç¬¬äºŒç«™ï¼šSpring MVC çš„è°ƒåº¦ä¸­å¿ƒ - DispatcherServlet"></a>ç¬¬äºŒç«™ï¼šSpring MVC çš„è°ƒåº¦ä¸­å¿ƒ - DispatcherServlet</h2><p><code>DispatcherServlet</code> æ˜¯ Spring MVC çš„ç»å¯¹æ ¸å¿ƒï¼Œå ªç§°â€ä¸­å¤®è°ƒåº¦å‘˜â€ã€‚å®ƒæ¥ç®¡è¯·æ±‚åï¼Œä¼šåœ¨å…¶ <code>doDispatch</code> æ–¹æ³•å†…ï¼Œ orchestrateï¼ˆç²¾å¿ƒå®‰æ’ï¼‰åç»­æ‰€æœ‰æ“ä½œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DispatcherServlet.doDispatch ç²¾ç®€æ ¸å¿ƒé€»è¾‘</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doDispatch</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. æ ¹æ®è¯·æ±‚æŸ¥æ‰¾ Handlerï¼ˆå³ Controller æ–¹æ³•ï¼‰</span></span><br><span class="line">    <span class="type">HandlerExecutionChain</span> <span class="variable">mappedHandler</span> <span class="operator">=</span> getHandler(request);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. è·å–èƒ½æ‰§è¡Œè¿™ä¸ª Handler çš„é€‚é…å™¨ HandlerAdapter</span></span><br><span class="line">    <span class="type">HandlerAdapter</span> <span class="variable">ha</span> <span class="operator">=</span> getHandlerAdapter(mappedHandler.getHandler());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. æ‰§è¡Œæ‹¦æˆªå™¨çš„ preHandle() æ–¹æ³•ï¼Œè¿™æ˜¯è¿›å…¥ Controller å‰çš„æœ€åä¸€é“å…³å¡</span></span><br><span class="line">    <span class="keyword">if</span> (!mappedHandler.applyPreHandle(request, response)) &#123;</span><br><span class="line">        <span class="keyword">return</span>; <span class="comment">// å¦‚æœ preHandle è¿”å› falseï¼Œè¯·æ±‚è¢«ä¸­æ–­</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. çœŸæ­£è°ƒç”¨ Controller æ–¹æ³•</span></span><br><span class="line">    <span class="type">ModelAndView</span> <span class="variable">mv</span> <span class="operator">=</span> ha.handle(request, response, mappedHandler.getHandler());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. æ‰§è¡Œæ‹¦æˆªå™¨çš„ postHandle() æ–¹æ³•</span></span><br><span class="line">    mappedHandler.applyPostHandle(request, response, mv);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6. å¤„ç†æ´¾å‘ç»“æœï¼ˆå¦‚æ¸²æŸ“è§†å›¾æˆ–å¤„ç†å¼‚å¸¸ï¼‰</span></span><br><span class="line">    processDispatchResult(request, response, mappedHandler, mv, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®©æˆ‘ä»¬ä¸€æ­¥æ­¥æ‹†è§£è¿™ä¸ªè¿‡ç¨‹ï¼š</p><h3 id="1-HandlerMappingï¼šæ‰¾åˆ°å¯¹çš„äºº"><a href="#1-HandlerMappingï¼šæ‰¾åˆ°å¯¹çš„äºº" class="headerlink" title="1. HandlerMappingï¼šæ‰¾åˆ°å¯¹çš„äºº"></a>1. HandlerMappingï¼šæ‰¾åˆ°å¯¹çš„äºº</h3><p><code>DispatcherServlet</code> é¦–å…ˆä¼šè¯¢é—® <code>HandlerMapping</code>ï¼šâ€å˜¿ï¼Œè¿™ä¸ª URL (<code>/user/info</code>) åº”è¯¥ç”±å“ªä¸ª Controller çš„å“ªä¸ªæ–¹æ³•æ¥å¤„ç†ï¼Ÿâ€ã€‚<br><code>RequestMappingHandlerMapping</code> ä¼šæ‰«ææ‰€æœ‰è¢« <code>@RequestMapping</code>ã€<code>@GetMapping</code> ç­‰æ³¨è§£æ ‡è®°çš„æ–¹æ³•ï¼Œæ„å»ºä¸€ä¸ª URL ä¸ <code>HandlerMethod</code> çš„æ˜ å°„å…³ç³»ï¼Œç„¶åç²¾å‡†åœ°æ‰¾åˆ°åŒ¹é…é¡¹ã€‚</p><h3 id="2-Interceptor-preHandleï¼šController-å‰çš„æœ€åæœºä¼š"><a href="#2-Interceptor-preHandleï¼šController-å‰çš„æœ€åæœºä¼š" class="headerlink" title="2. Interceptor preHandleï¼šController å‰çš„æœ€åæœºä¼š"></a>2. Interceptor preHandleï¼šController å‰çš„æœ€åæœºä¼š</h3><p>æ‰¾åˆ°ç›®æ ‡ <code>Controller</code> æ–¹æ³•åï¼Œå¹¶ä¸ä¼šç«‹åˆ»æ‰§è¡Œã€‚è€Œæ˜¯å…ˆæ‰§è¡Œæ‰€æœ‰åŒ¹é…è¯¥è·¯å¾„çš„<strong>æ‹¦æˆªå™¨ï¼ˆInterceptorï¼‰</strong>çš„ <code>preHandle</code> æ–¹æ³•ã€‚</p><p>è¿™æ˜¯ä¸€ä¸ªå…³é”®çš„åˆ‡å…¥ç‚¹ã€‚<code>preHandle</code> è¿”å› <code>true</code> åˆ™æ”¾è¡Œï¼Œè¿”å› <code>false</code> åˆ™è¯·æ±‚è¢«ç›´æ¥ä¸­æ–­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‹¦æˆªå™¨ preHandle ç¤ºä¾‹</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> &#123;</span><br><span class="line">    <span class="comment">// æ¯”å¦‚ï¼Œè¿›è¡Œæ›´ç»†ç²’åº¦çš„æƒé™æ ¡éªŒ</span></span><br><span class="line">    <span class="keyword">if</span> (!checkAuth(request, handler)) &#123; <span class="comment">// ç”šè‡³å¯ä»¥æ‹¿åˆ° handler ä¿¡æ¯åšæ›´å¤æ‚çš„åˆ¤æ–­</span></span><br><span class="line">        response.sendError(<span class="number">403</span>, <span class="string">&quot;æƒé™ä¸è¶³&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// ä¸­æ–­è¯·æ±‚</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// æ”¾è¡Œ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-å‚æ•°è§£æä¸-Controller-æ–¹æ³•æ‰§è¡Œ"><a href="#3-å‚æ•°è§£æä¸-Controller-æ–¹æ³•æ‰§è¡Œ" class="headerlink" title="3. å‚æ•°è§£æä¸ Controller æ–¹æ³•æ‰§è¡Œ"></a>3. å‚æ•°è§£æä¸ Controller æ–¹æ³•æ‰§è¡Œ</h3><p>é€šè¿‡äº†æ‰€æœ‰æ‹¦æˆªå™¨çš„ <code>preHandle</code> åï¼Œ<code>HandlerAdapter</code> å¼€å§‹å·¥ä½œã€‚å®ƒä¼šå€ŸåŠ© <code>HandlerMethodArgumentResolver</code> ç­‰ä¸€ç³»åˆ—â€å‚æ•°è§£æå™¨â€ï¼Œç¥å¥‡åœ°å°† HTTP è¯·æ±‚ä¸­çš„å„ç§ä¿¡æ¯ï¼ˆå¦‚ <code>@RequestBody</code> çš„ JSONã€<code>@RequestParam</code> çš„æŸ¥è¯¢å‚æ•°ã€<code>@PathVariable</code> çš„è·¯å¾„å˜é‡ï¼‰è½¬æ¢å¹¶æ³¨å…¥åˆ°ä½  <code>Controller</code> æ–¹æ³•çš„å‚æ•°åˆ—è¡¨ä¸­ã€‚</p><p>ç„¶åï¼Œé€šè¿‡<strong>åå°„</strong>ï¼Œä½ çš„ <code>Controller</code> æ–¹æ³•ç»ˆäºè¢«æ‰§è¡Œäº†ï¼</p><h3 id="4-AOP-åˆ‡é¢ï¼šæ— æ„ŸçŸ¥çš„é€»è¾‘å¢å¼º"><a href="#4-AOP-åˆ‡é¢ï¼šæ— æ„ŸçŸ¥çš„é€»è¾‘å¢å¼º" class="headerlink" title="4. AOP åˆ‡é¢ï¼šæ— æ„ŸçŸ¥çš„é€»è¾‘å¢å¼º"></a>4. AOP åˆ‡é¢ï¼šæ— æ„ŸçŸ¥çš„é€»è¾‘å¢å¼º</h3><p>å°±åœ¨ä½ çš„ <code>Controller</code> æ–¹æ³•æ‰§è¡Œå‰åï¼ŒAOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰å¯èƒ½ä¼šâ€ç¥ä¸çŸ¥é¬¼ä¸è§‰â€åœ°ä»‹å…¥ã€‚å¦‚æœä½ çš„æ–¹æ³•ä¸ŠåŠ äº† <code>@Transactional</code>ã€<code>@Cacheable</code> æˆ–æ˜¯è‡ªå®šä¹‰çš„ AOP æ³¨è§£ï¼Œé‚£ä¹ˆç›¸å…³çš„åˆ‡é¢é€»è¾‘ï¼ˆå¦‚ç¯ç»•é€šçŸ¥ï¼‰ä¼šåœ¨è¿™é‡Œæ‰§è¡Œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¯ç»•é€šçŸ¥ç¤ºä¾‹ï¼šåœ¨ Controller æ–¹æ³•æ‰§è¡Œå‰åç»‡å…¥é€»è¾‘</span></span><br><span class="line"><span class="meta">@Around(&quot;@annotation(com.example.MyCustomLog)&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">logExecutionTime</span><span class="params">(ProceedingJoinPoint joinPoint)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="comment">// æ‰§è¡Œ Controller æ–¹æ³•</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> joinPoint.proceed();</span><br><span class="line">    <span class="type">long</span> <span class="variable">duration</span> <span class="operator">=</span> System.currentTimeMillis() - start;</span><br><span class="line">    log.info(<span class="string">&quot;&#123;&#125; æ‰§è¡Œè€—æ—¶: &#123;&#125; ms&quot;</span>, joinPoint.getSignature(), duration);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AOP çš„ç¾å¦™ä¹‹å¤„åœ¨äºï¼Œå®ƒè®©ä½ çš„ä¸šåŠ¡ä»£ç ä¿æŒçº¯å‡€ï¼ŒåŒæ—¶åˆèƒ½é™„åŠ é¢å¤–çš„é€šç”¨åŠŸèƒ½ã€‚</p><h3 id="5-Interceptor-postHandle-è§†å›¾æ¸²æŸ“"><a href="#5-Interceptor-postHandle-è§†å›¾æ¸²æŸ“" class="headerlink" title="5. Interceptor postHandle &amp; è§†å›¾æ¸²æŸ“"></a>5. Interceptor postHandle &amp; è§†å›¾æ¸²æŸ“</h3><p>Controller æ–¹æ³•æ‰§è¡Œå®Œæ¯•ï¼Œå¹¶è¿”å›äº†ä¸€ä¸ªç»“æœï¼ˆæ¯”å¦‚ä¸€ä¸ª <code>ModelAndView</code> å¯¹è±¡æˆ–è€…ä¸€ä¸ªè¢« <code>@ResponseBody</code> æ ‡è®°çš„å¯¹è±¡ï¼‰ã€‚<br>æ­¤æ—¶ï¼Œæ‹¦æˆªå™¨çš„ <code>postHandle</code> æ–¹æ³•ä¼šè¢«è°ƒç”¨ã€‚ä½ å¯ä»¥åœ¨è¿™é‡Œå¯¹ <code>ModelAndView</code> è¿›è¡Œä¿®æ”¹ï¼Œæˆ–è€…åœ¨å“åº”æäº¤å‰åšä¸€äº›é¢å¤–æ“ä½œã€‚</p><p>å¦‚æœè¿”å›çš„æ˜¯ <code>ModelAndView</code>ï¼Œ<code>DispatcherServlet</code> ä¼šé€šè¿‡ <code>ViewResolver</code>ï¼ˆè§†å›¾è§£æå™¨ï¼‰æ‰¾åˆ°å¯¹åº”çš„è§†å›¾æ¨¡æ¿ï¼ˆå¦‚ Thymeleaf æˆ– JSPï¼‰ï¼Œå¹¶ç”¨æ¨¡å‹æ•°æ®è¿›è¡Œæ¸²æŸ“ï¼Œæœ€ç»ˆç”Ÿæˆ HTML å“åº”ã€‚</p><h3 id="6-Interceptor-afterCompletionï¼šæœ€åçš„æ¸…ç†å·¥ä½œ"><a href="#6-Interceptor-afterCompletionï¼šæœ€åçš„æ¸…ç†å·¥ä½œ" class="headerlink" title="6. Interceptor afterCompletionï¼šæœ€åçš„æ¸…ç†å·¥ä½œ"></a>6. Interceptor afterCompletionï¼šæœ€åçš„æ¸…ç†å·¥ä½œ</h3><p>æ— è®ºè¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­æ˜¯å¦å‘ç”Ÿå¼‚å¸¸ï¼Œåªè¦å®ƒç»è¿‡äº†æ‹¦æˆªå™¨çš„ <code>preHandle</code> å¹¶è¿”å› <code>true</code>ï¼Œé‚£ä¹ˆåœ¨æ•´ä¸ªè¯·æ±‚å®Œæˆï¼ˆè§†å›¾æ¸²æŸ“å®Œæ¯•æˆ–å“åº”å·²æäº¤ï¼‰åï¼Œæ‹¦æˆªå™¨çš„ <code>afterCompletion</code> æ–¹æ³•å°±ä¸€å®šä¼šè¢«è°ƒç”¨ã€‚</p><p>è¿™é‡Œæ˜¯æ‰§è¡Œèµ„æºæ¸…ç†å·¥ä½œçš„æœ€ä½³åœ°ç‚¹ï¼Œæ¯”å¦‚æ¸…ç†çº¿ç¨‹ç»‘å®šçš„å˜é‡ç­‰ã€‚</p><hr><h2 id="å…¨æ™¯å›¾ï¼šä¸€å¼ å›¾çœ‹æ‡‚æ‰§è¡Œé¡ºåº"><a href="#å…¨æ™¯å›¾ï¼šä¸€å¼ å›¾çœ‹æ‡‚æ‰§è¡Œé¡ºåº" class="headerlink" title="å…¨æ™¯å›¾ï¼šä¸€å¼ å›¾çœ‹æ‡‚æ‰§è¡Œé¡ºåº"></a>å…¨æ™¯å›¾ï¼šä¸€å¼ å›¾çœ‹æ‡‚æ‰§è¡Œé¡ºåº</h2><p>ä¸ºäº†æ›´ç›´è§‚åœ°ç†è§£æ•´ä¸ªæµç¨‹ï¼Œæˆ‘ä¸ºä½ ç»˜åˆ¶äº†ä¸€å¼ æµç¨‹å›¾ï¼š</p><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD;    subgraph &quot;å®¢æˆ·ç«¯&quot;        A[å‘èµ· HTTP è¯·æ±‚]    end    subgraph &quot;Tomcat æœåŠ¡å™¨&quot;        A --&gt; B(Connector ç›‘å¬ç«¯å£);        B --&gt; C{çº¿ç¨‹æ± åˆ†é…çº¿ç¨‹};        C --&gt; D[Tomcat å®¹å™¨è·¯ç”±];        D --&gt; E(è¿‡æ»¤å™¨é“¾ Filter Chain);    end    subgraph &quot;Spring MVC æ¡†æ¶&quot;        E --&gt; F(DispatcherServlet);        F -- 1. æŸ¥æ‰¾ Handler --&gt; G{HandlerMapping};        G -- 2. è·å¾— HandlerExecutionChain --&gt; H(æ‹¦æˆªå™¨ preHandle);        H -- 3. æ”¾è¡Œ --&gt; I{å‚æ•°è§£æ&#x2F;AOP};        I -- 4. è°ƒç”¨ --&gt; J[Controller æ–¹æ³•æ‰§è¡Œ];        J -- 5. è¿”å› ModelAndView&#x2F;ç»“æœ --&gt; K(æ‹¦æˆªå™¨ postHandle);        K -- 6. è§†å›¾å¤„ç† --&gt; L{è§†å›¾æ¸²æŸ“ ViewResolver};        L -- 7. å“åº”å®Œæˆå --&gt; M(æ‹¦æˆªå™¨ afterCompletion);    end    subgraph &quot;å“åº”&quot;        M --&gt; N[è¿”å› HTTP å“åº”];    end    style F fill:#f9f,stroke:#333,stroke-width:2px    style J fill:#ccf,stroke:#333,stroke-width:2px  </pre></div><p><strong>è°ƒè¯•æŠ€å·§</strong>ï¼šåœ¨ <code>DispatcherServlet</code> çš„ <code>doDispatch</code> æ–¹æ³•é‡Œæ‰“ä¸Šä¸€ä¸ªæ–­ç‚¹ï¼Œç„¶åå•æ­¥è°ƒè¯•ã€‚ä½ ä¼šæ¸…æ™°åœ°çœ‹åˆ° <code>getHandler</code>ã€<code>applyPreHandle</code>ã€<code>ha.handle</code> ç­‰å…³é”®æ­¥éª¤çš„è°ƒç”¨è¿‡ç¨‹ï¼Œè¿™æ˜¯ç†è§£æ•´ä¸ªæµç¨‹æœ€å¿«çš„æ–¹å¼ã€‚</p><hr><h2 id="å®æˆ˜æ’é›·ï¼šå¸¸è§é—®é¢˜ä¸è°ƒè¯•æŠ€å·§"><a href="#å®æˆ˜æ’é›·ï¼šå¸¸è§é—®é¢˜ä¸è°ƒè¯•æŠ€å·§" class="headerlink" title="å®æˆ˜æ’é›·ï¼šå¸¸è§é—®é¢˜ä¸è°ƒè¯•æŠ€å·§"></a>å®æˆ˜æ’é›·ï¼šå¸¸è§é—®é¢˜ä¸è°ƒè¯•æŠ€å·§</h2><h3 id="1-çµé­‚æ‹·é—®ï¼šFilter-vs-Interceptorï¼Ÿ"><a href="#1-çµé­‚æ‹·é—®ï¼šFilter-vs-Interceptorï¼Ÿ" class="headerlink" title="1. çµé­‚æ‹·é—®ï¼šFilter vs. Interceptorï¼Ÿ"></a>1. çµé­‚æ‹·é—®ï¼šFilter vs. Interceptorï¼Ÿ</h3><p>è¿™æ˜¯ä¸ªè€ç”Ÿå¸¸è°ˆä½†è‡³å…³é‡è¦çš„é—®é¢˜ã€‚</p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">è¿‡æ»¤å™¨ (Filter)</th><th align="left">æ‹¦æˆªå™¨ (Interceptor)</th></tr></thead><tbody><tr><td align="left"><strong>å‡ºèº«</strong></td><td align="left">Servlet è§„èŒƒï¼ŒJ2EE æ ‡å‡†ï¼Œä»»ä½• Web æ¡†æ¶éƒ½èƒ½ç”¨</td><td align="left">Spring MVC æ¡†æ¶ç‰¹æœ‰ï¼Œé«˜åº¦é›†æˆäº Spring ä¸Šä¸‹æ–‡</td></tr><tr><td align="left"><strong>æ‰§è¡Œæ—¶æœº</strong></td><td align="left">åœ¨ <code>DispatcherServlet</code> ä¹‹å‰ï¼Œæ— æ³•è§¦åŠ Controller</td><td align="left">åœ¨ <code>DispatcherServlet</code> ä¹‹åï¼ŒController æ‰§è¡Œå‰å</td></tr><tr><td align="left"><strong>ä¾èµ–æ³¨å…¥</strong></td><td align="left">é»˜è®¤ä¸æ”¯æŒ <code>@Autowired</code>ï¼Œéœ€ç‰¹æ®Šé…ç½®ï¼ˆå¦‚ <code>FilterRegistrationBean</code>ï¼‰</td><td align="left">ç”± Spring IoC å®¹å™¨ç®¡ç†ï¼Œå¯ç›´æ¥ <code>@Autowired</code> æ³¨å…¥ä»»ä½• Bean</td></tr><tr><td align="left"><strong>èƒ½åŠ›èŒƒå›´</strong></td><td align="left">èƒ½å¤„ç†æ‰€æœ‰è¿›å…¥ Tomcat çš„è¯·æ±‚ï¼ŒåŒ…æ‹¬é™æ€èµ„æº</td><td align="left">åªèƒ½æ‹¦æˆªè¿›å…¥ <code>DispatcherServlet</code> çš„è¯·æ±‚</td></tr><tr><td align="left"><strong>è·å–ä¿¡æ¯</strong></td><td align="left">æ— æ³•ç›´æ¥è·å–å³å°†æ‰§è¡Œçš„ Controller æ–¹æ³•ä¿¡æ¯</td><td align="left">å¯ä»¥è·å– <code>HandlerMethod</code>ï¼ŒçŸ¥é“å…·ä½“æ˜¯å“ªä¸ªæ–¹æ³•åœ¨å¤„ç†</td></tr></tbody></table><p><strong>ä¸€å¥è¯æ€»ç»“</strong>ï¼š<code>Filter</code> æ˜¯ç²—ç²’åº¦çš„å…¨å±€â€é—¨å«â€ï¼Œé€‚åˆåšè®¤è¯ã€ç¼–ç ç­‰é€šç”¨å·¥ä½œï¼›<code>Interceptor</code> æ˜¯ç»†ç²’åº¦çš„â€è­¦å«â€ï¼Œé€‚åˆåšæƒé™ã€æ—¥å¿—ç­‰ä¸ä¸šåŠ¡é€»è¾‘ç›¸å…³çš„æ ¡éªŒã€‚</p><h3 id="2-ä¸ºä½•é™æ€èµ„æºä¸ç»è¿‡æˆ‘çš„æ‹¦æˆªå™¨ï¼Ÿ"><a href="#2-ä¸ºä½•é™æ€èµ„æºä¸ç»è¿‡æˆ‘çš„æ‹¦æˆªå™¨ï¼Ÿ" class="headerlink" title="2. ä¸ºä½•é™æ€èµ„æºä¸ç»è¿‡æˆ‘çš„æ‹¦æˆªå™¨ï¼Ÿ"></a>2. ä¸ºä½•é™æ€èµ„æºä¸ç»è¿‡æˆ‘çš„æ‹¦æˆªå™¨ï¼Ÿ</h3><p>å› ä¸º Spring Boot é»˜è®¤é…ç½®ä¸‹ï¼Œå¯¹äº <code>/static</code>ã€<code>/public</code> ç­‰ç›®å½•ä¸‹çš„é™æ€èµ„æºè¯·æ±‚ï¼Œä¼šç”±ä¸€ä¸ªåä¸º <code>DefaultServletHttpRequestHandler</code> çš„å¤„ç†å™¨ç›´æ¥å¤„ç†ï¼Œå®ƒä¼šç»•è¿‡ <code>DispatcherServlet</code>ï¼Œç›´æ¥å°†èµ„æºä»¥æµçš„å½¢å¼è¿”å›ã€‚å› æ­¤ï¼Œä½ çš„æ‹¦æˆªå™¨è‡ªç„¶ä¹Ÿå°±ä¸ä¼šè¢«è§¦å‘ã€‚</p><h3 id="3-å¦‚ä½•ä¼˜é›…åœ°è·³è¿‡æŸäº›è·¯å¾„çš„æ‹¦æˆªå™¨ï¼Ÿ"><a href="#3-å¦‚ä½•ä¼˜é›…åœ°è·³è¿‡æŸäº›è·¯å¾„çš„æ‹¦æˆªå™¨ï¼Ÿ" class="headerlink" title="3. å¦‚ä½•ä¼˜é›…åœ°è·³è¿‡æŸäº›è·¯å¾„çš„æ‹¦æˆªå™¨ï¼Ÿ"></a>3. å¦‚ä½•ä¼˜é›…åœ°è·³è¿‡æŸäº›è·¯å¾„çš„æ‹¦æˆªå™¨ï¼Ÿ</h3><p>åœ¨é…ç½®æ‹¦æˆªå™¨æ—¶ï¼Œä½¿ç”¨ <code>excludePathPatterns</code> æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebMvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">MyAuthInterceptor</span>())</span><br><span class="line">                .addPathPatterns(<span class="string">&quot;/**&quot;</span>) <span class="comment">// æ‹¦æˆªæ‰€æœ‰</span></span><br><span class="line">                .excludePathPatterns(<span class="string">&quot;/login&quot;</span>, <span class="string">&quot;/error&quot;</span>, <span class="string">&quot;/static/**&quot;</span>); <span class="comment">// æ’é™¤ç‰¹å®šè·¯å¾„</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-å¦‚ä½•æ•è·å…¨å±€å¼‚å¸¸ï¼Ÿ"><a href="#4-å¦‚ä½•æ•è·å…¨å±€å¼‚å¸¸ï¼Ÿ" class="headerlink" title="4. å¦‚ä½•æ•è·å…¨å±€å¼‚å¸¸ï¼Ÿ"></a>4. å¦‚ä½•æ•è·å…¨å±€å¼‚å¸¸ï¼Ÿ</h3><p>ä½¿ç”¨ <code>@ControllerAdvice</code> å’Œ <code>@ExceptionHandler</code> çš„ç»„åˆæ‹³ï¼Œå¯ä»¥ä¼˜é›…åœ°å¤„ç†å…¨å±€å¼‚å¸¸ï¼Œé¿å… <code>try-catch</code> éåœ°å¼€èŠ±ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalExceptionHandler</span> &#123;</span><br><span class="line">    <span class="meta">@ExceptionHandler(Exception.class)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title function_">handleGenericException</span><span class="params">(Exception e)</span> &#123;</span><br><span class="line">        <span class="comment">// è®°å½•æ—¥å¿—</span></span><br><span class="line">        log.error(<span class="string">&quot;ç³»ç»Ÿå‘ç”ŸæœªçŸ¥å¼‚å¸¸&quot;</span>, e);</span><br><span class="line">        <span class="comment">// è¿”å›ä¸€ä¸ªå¯¹ç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(<span class="number">500</span>).body(<span class="string">&quot;æœåŠ¡å™¨å¼€å°å·®äº†ï¼Œè¯·ç¨åå†è¯•ï½&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(IllegalArgumentException.class)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title function_">handleIllegalArgumentException</span><span class="params">(IllegalArgumentException e)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(<span class="number">400</span>).body(<span class="string">&quot;è¯·æ±‚å‚æ•°ä¸åˆæ³•: &quot;</span> + e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h2><p>å¥½äº†ï¼Œè¿™æ¬¡ä» Tomcat åˆ° Controller çš„è¯·æ±‚ä¹‹æ—…å°±åˆ°è¿™é‡Œã€‚æˆ‘ä»¬ä¸€èµ·æ¢³ç†äº†å…¶ä¸­çš„æ¯ä¸€ä¸ªå…³é”®èŠ‚ç‚¹å’Œæ ¸å¿ƒç»„ä»¶ã€‚</p><p>æŒæ¡è¿™æ¡æ ¸å¿ƒè·¯å¾„ï¼Œä½ å°±èƒ½ï¼š</p><ol><li><strong>æ¸…æ™°å®šä½é—®é¢˜</strong>ï¼šåˆ°åº•æ˜¯ Filter æ‹¦äº†ï¼Œè¿˜æ˜¯ Interceptor æ²¡è¿‡ï¼Ÿæ˜¯å‚æ•°è§£æé”™äº†ï¼Œè¿˜æ˜¯ AOP å‡ºäº†å¼‚å¸¸ï¼Ÿ</li><li><strong>ä¼˜é›…è®¾è®¡ç³»ç»Ÿ</strong>ï¼šåˆç†åœ°åœ¨ Filterã€Interceptorã€AOPã€ControllerAdvice ä¸­æ”¾ç½®ä½ çš„é€»è¾‘ï¼Œè®©ä»£ç ç»“æ„æ›´æ¸…æ™°ï¼ŒèŒè´£æ›´åˆ†æ˜ã€‚</li><li><strong>æå‡æ€§èƒ½</strong>ï¼šç†è§£äº†æµç¨‹ï¼Œæ‰èƒ½æ›´å¥½åœ°è¿›è¡Œæ€§èƒ½åˆ†æå’Œä¼˜åŒ–ã€‚</li></ol><p>è¿™æ¬¡çš„æ·±åº¦å‰–æï¼Œèƒ½è®©æˆ‘ä»¬éƒ½å¯¹ Spring MVC çš„è¯·æ±‚å¤„ç†æœ‰æ›´æ·±åˆ»çš„ç†è§£ï¼Œä¹Ÿæ˜¯æ—¥å¸¸å­¦ä¹ çš„ä¸€ä¸ªè®°å½•ğŸ“ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring AOP ä¸å¾ªç¯ä¾èµ–ï¼šæ­ç§˜æå‰æš´éœ²ä»£ç†çš„åº•å±‚åŸç†</title>
      <link href="/2025/06/17/Spring%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E4%B8%8EAOP/"/>
      <url>/2025/06/17/Spring%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E4%B8%8EAOP/</url>
      
        <content type="html"><![CDATA[<h3 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h3><p>åœ¨Springå¼€å‘ä¸­ï¼ŒAOPå’Œå¾ªç¯ä¾èµ–æ˜¯ä¸¤ä¸ªæˆ‘ä»¬ç»å¸¸æ‰“äº¤é“çš„è¯é¢˜ã€‚é€šå¸¸çš„è®¤çŸ¥æ˜¯ï¼ŒSpringä¼šåœ¨ä¸€ä¸ªBeanå®Œå…¨åˆå§‹åŒ–ï¼ˆå±æ€§å¡«å……ã€<code>init</code>æ–¹æ³•æ‰§è¡Œå®Œæ¯•ï¼‰ä¹‹åï¼Œæ‰ä¸ºå…¶åˆ›å»ºAOPä»£ç†ã€‚ä½†å½“ä¸€ä¸ªéœ€è¦è¢«ä»£ç†çš„Beanï¼Œæ°å¥½åˆé™·å…¥äº†å¾ªç¯ä¾èµ–ï¼Œæƒ…å†µå°±å˜å¾—æ£˜æ‰‹èµ·æ¥ï¼šSpringå¿…é¡»åœ¨è¿™ä¸ªBeanå°šæœªâ€å®Œå·¥â€æ—¶ï¼Œå°±å°†å®ƒæš´éœ²ç»™ä¾èµ–æ–¹ã€‚</p><p>è¿™å°±å¸¦æ¥ä¸€ä¸ªå¾ˆè‡ªç„¶çš„é—®é¢˜ï¼šä¸€ä¸ªå°šæœªå®Œå…¨åˆå§‹åŒ–çš„Beanï¼Œå¦‚ä½•èƒ½ä»¥å®ƒæœ€ç»ˆçš„ä»£ç†å½¢æ€è¢«æå‰æš´éœ²ï¼Ÿè¿™æ ·åšä¸ä¼šæœ‰çŠ¶æ€ä¸ä¸€è‡´çš„é£é™©å—ï¼Ÿæœ¬æ–‡å°†ä»¥å¼€å‘è€…çš„è§†è§’ï¼Œæ·±å…¥Springå†…éƒ¨ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•é€šè¿‡ç²¾å¦™çš„ä¸‰çº§ç¼“å­˜è®¾è®¡ï¼Œè§£å†³è¿™ä¸ªçœ‹ä¼¼çŸ›ç›¾çš„é—®é¢˜çš„ã€‚</p><hr><h3 id="1-å¾ªç¯ä¾èµ–çš„è§£å†³æœºåˆ¶ï¼šä¸‰çº§ç¼“å­˜"><a href="#1-å¾ªç¯ä¾èµ–çš„è§£å†³æœºåˆ¶ï¼šä¸‰çº§ç¼“å­˜" class="headerlink" title="1. å¾ªç¯ä¾èµ–çš„è§£å†³æœºåˆ¶ï¼šä¸‰çº§ç¼“å­˜"></a>1. <strong>å¾ªç¯ä¾èµ–çš„è§£å†³æœºåˆ¶ï¼šä¸‰çº§ç¼“å­˜</strong></h3><p>è¦ç†è§£å¾ªç¯ä¾èµ–çš„è§£å†³æ–¹æ¡ˆï¼Œæ ¸å¿ƒå°±æ˜¯è¦å¼„æ‡‚Springçš„ä¸‰çº§ç¼“å­˜ã€‚è¿™ä¸‰çº§ç¼“å­˜ï¼Œæœ¬è´¨ä¸Šæ˜¯Springåœ¨Beanç”Ÿå‘½å‘¨æœŸä¸­ï¼Œä¸ºäº†ç®¡ç†ä¸åŒçŠ¶æ€çš„Beanå®ä¾‹è€Œè®¾çš„ä¸‰å±‚å­˜å‚¨ç©ºé—´ï¼š</p><ol><li><strong>ä¸€çº§ç¼“å­˜ï¼ˆsingletonObjectsï¼‰</strong>ï¼šä¸€ä¸ªMapï¼Œå­˜æ”¾çš„æ˜¯<strong>å®Œå…¨åˆå§‹åŒ–å¥½</strong>çš„å•ä¾‹Beanã€‚å¯ä»¥æŠŠå®ƒçœ‹ä½œæ˜¯â€æˆå“ä»“â€ï¼Œé‡Œé¢çš„Beanéšæ—¶å¯ä»¥å–ç”¨ã€‚</li><li><strong>äºŒçº§ç¼“å­˜ï¼ˆearlySingletonObjectsï¼‰</strong>ï¼šä¹Ÿæ˜¯ä¸€ä¸ªMapï¼Œå­˜æ”¾çš„æ˜¯<strong>æå‰æš´éœ²</strong>çš„å•ä¾‹Beançš„æ—©æœŸå¼•ç”¨ã€‚è¿™äº›Beanå·²ç»å®ä¾‹åŒ–ï¼Œä½†å¯èƒ½è¿˜æ²¡å®Œæˆå±æ€§æ³¨å…¥å’Œåˆå§‹åŒ–ã€‚å®ƒä»¬æ˜¯â€åŠæˆå“â€ï¼Œç”¨äºè§£å¼€å¾ªç¯ä¾èµ–ã€‚</li><li><strong>ä¸‰çº§ç¼“å­˜ï¼ˆsingletonFactoriesï¼‰</strong>ï¼šè¿˜æ˜¯ä¸€ä¸ªMapï¼Œä½†å®ƒå­˜æ”¾çš„ä¸æ˜¯Beanï¼Œè€Œæ˜¯åˆ›å»ºBeançš„<strong>å·¥å‚</strong>ï¼ˆ<code>ObjectFactory</code>ï¼‰ã€‚è¿™æ˜¯è§£å†³AOPå¾ªç¯ä¾èµ–çš„å…³é”®ï¼Œå½“Beanéœ€è¦è¢«ä»£ç†æ—¶ï¼Œè¿™ä¸ªå·¥å‚è´Ÿè´£åˆ›å»ºå‡ºä»£ç†å¯¹è±¡ï¼Œè€Œä¸æ˜¯åŸå§‹å¯¹è±¡ã€‚</li></ol><p>å½“Bean Aä¾èµ–Bean Bï¼ŒåŒæ—¶Bean Båˆä¾èµ–Bean Aæ—¶ï¼Œè¿™ä¸ªæœºåˆ¶å°±å¼€å§‹è¿è½¬ï¼š</p><ul><li>Springåœ¨åˆ›å»ºBean Aæ—¶ï¼Œé¦–å…ˆä¼šå®ä¾‹åŒ–Aï¼Œç„¶åå°†ä¸€ä¸ªèƒ½å¤Ÿåˆ›å»ºAçš„æ—©æœŸå¼•ç”¨ï¼ˆå¯èƒ½æ˜¯ä»£ç†ï¼‰çš„<code>ObjectFactory</code>æ”¾å…¥ä¸‰çº§ç¼“å­˜ã€‚</li><li>æ¥ç€Springä¸ºAå¡«å……å±æ€§ï¼Œå‘ç°å®ƒä¾èµ–Bï¼Œäºæ˜¯å»åˆ›å»ºBã€‚</li><li>åœ¨åˆ›å»ºBçš„è¿‡ç¨‹ä¸­ï¼ŒSpringå‘ç°Båˆä¾èµ–Aï¼Œæ­¤æ—¶éœ€è¦è·å–Aã€‚</li><li>Springä¾æ¬¡æ£€æŸ¥ä¸€çº§ã€äºŒçº§ç¼“å­˜ï¼Œéƒ½æ‰¾ä¸åˆ°Aã€‚æœ€ååœ¨ä¸‰çº§ç¼“å­˜ä¸­æ‰¾åˆ°äº†Açš„<code>ObjectFactory</code>ã€‚</li><li>é€šè¿‡è¿™ä¸ªå·¥å‚ï¼ŒSpringåˆ›å»ºå‡ºAçš„æ—©æœŸå¼•ç”¨ï¼ˆå¦‚æœéœ€è¦AOPï¼Œæ­¤æ—¶å°±ä¼šç”Ÿæˆä»£ç†å¯¹è±¡ï¼‰ï¼Œå¹¶å°†å…¶æ”¾å…¥äºŒçº§ç¼“å­˜ï¼Œç„¶åä»ä¸‰çº§ç¼“å­˜ä¸­ç§»é™¤å·¥å‚ã€‚è¿™ä¸ªæ—©æœŸå¼•ç”¨è¢«æ³¨å…¥åˆ°Bä¸­ï¼ŒBé¡ºåˆ©å®Œæˆåˆå§‹åŒ–ï¼Œå¹¶è¢«æ”¾å…¥ä¸€çº§ç¼“å­˜ã€‚</li><li>æœ€åï¼ŒSpringå›åˆ°Açš„åˆ›å»ºæµç¨‹ï¼Œå°†å·²ç»å®Œæˆçš„Bæ³¨å…¥Aï¼ŒAä¹Ÿé¡ºåˆ©å®Œæˆåˆå§‹åŒ–ï¼Œæœ€ç»ˆè¢«æ”¾å…¥ä¸€çº§ç¼“å­˜ã€‚</li></ul><hr><h3 id="2-æµç¨‹å¯è§†åŒ–"><a href="#2-æµç¨‹å¯è§†åŒ–" class="headerlink" title="2. æµç¨‹å¯è§†åŒ–"></a>2. <strong>æµç¨‹å¯è§†åŒ–</strong></h3><p>ä¸ºäº†æ›´ç›´è§‚åœ°ç†è§£ä¸Šè¿°è¿‡ç¨‹ï¼Œå°¤å…¶æ˜¯AOPä»£ç†çš„åˆ›å»ºæ—¶æœºï¼Œä¸‹é¢çš„æµç¨‹å›¾å±•ç¤ºäº†å®Œæ•´çš„äº¤äº’ï¼š</p><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  sequenceDiagram    participant Client as å®¢æˆ·ç«¯    participant Spring as Springå®¹å™¨    participant L3Cache as &quot;ä¸‰çº§ç¼“å­˜ (singletonFactories)&quot;    participant L2Cache as &quot;äºŒçº§ç¼“å­˜ (earlySingletonObjects)&quot;    participant L1Cache as &quot;ä¸€çº§ç¼“å­˜ (singletonObjects)&quot;    participant InstanceA as &quot;Bean A å®ä¾‹&quot;    participant InstanceB as &quot;Bean B å®ä¾‹&quot;    Client-&gt;&gt;+Spring: getBean(&quot;a&quot;)    Spring-&gt;&gt;Spring: 1. åˆ›å»ºBean A    Spring-&gt;&gt;InstanceA: new ServiceA()    Spring-&gt;&gt;L3Cache: 2. æ”¾å…¥Açš„ObjectFactory    Spring-&gt;&gt;Spring: 3. å¡«å……Açš„å±æ€§ (å‘ç°ä¾èµ–B)    Spring-&gt;&gt;+Spring: 4. getBean(&quot;b&quot;)    Spring-&gt;&gt;InstanceB: new ServiceB()    Spring-&gt;&gt;L3Cache: 5. æ”¾å…¥Bçš„ObjectFactory    Spring-&gt;&gt;Spring: 6. å¡«å……Bçš„å±æ€§ (å‘ç°ä¾èµ–A)    Spring-&gt;&gt;Spring: 7. å°è¯•è·å–Bean A (ä¸ºBæ³¨å…¥)    Spring-&gt;&gt;L1Cache: æ£€æŸ¥&quot;a&quot; (æœªå‘½ä¸­)    Spring-&gt;&gt;L2Cache: æ£€æŸ¥&quot;a&quot; (æœªå‘½ä¸­)    Spring-&gt;&gt;L3Cache: æ£€æŸ¥&quot;a&quot; (å‘½ä¸­, è·å–ObjectFactory)    Spring-&gt;&gt;Spring: 8. è°ƒç”¨Açš„ObjectFactory.getObject()    Note right of Spring: æ­¤åˆ»é€šè¿‡getEarlyBeanReference&lt;br&gt;ä¸ºAåˆ›å»ºä»£ç†å¯¹è±¡    Spring-&gt;&gt;L2Cache: 9. å°†Açš„æ—©æœŸå¼•ç”¨(ä»£ç†)æ”¾å…¥äºŒçº§ç¼“å­˜    Spring-&gt;&gt;L3Cache: ä»ä¸‰çº§ç¼“å­˜ç§»é™¤Açš„Factory    Spring--&gt;&gt;InstanceB: 10. å°†Açš„æ—©æœŸå¼•ç”¨æ³¨å…¥B    Spring-&gt;&gt;Spring: 11. å®ŒæˆBçš„åˆå§‹åŒ–    Spring-&gt;&gt;L1Cache: 12. æ”¾å…¥Bçš„å®Œæ•´å®ä¾‹    Spring--&gt;&gt;Spring: è¿”å›Bçš„å®ä¾‹    Spring-&gt;&gt;InstanceA: 13. å°†Bå®ä¾‹æ³¨å…¥A    Spring-&gt;&gt;Spring: 14. å®ŒæˆAçš„åˆå§‹åŒ–    Spring-&gt;&gt;L1Cache: 15. æ”¾å…¥Açš„å®Œæ•´å®ä¾‹(ä»£ç†)    Spring--&gt;&gt;Client: è¿”å›Açš„å®ä¾‹(ä»£ç†)  </pre></div><hr><h3 id="3-ä¸ºä»€ä¹ˆéœ€è¦æå‰ç”Ÿæˆä»£ç†ï¼Ÿ"><a href="#3-ä¸ºä»€ä¹ˆéœ€è¦æå‰ç”Ÿæˆä»£ç†ï¼Ÿ" class="headerlink" title="3. ä¸ºä»€ä¹ˆéœ€è¦æå‰ç”Ÿæˆä»£ç†ï¼Ÿ"></a>3. <strong>ä¸ºä»€ä¹ˆéœ€è¦æå‰ç”Ÿæˆä»£ç†ï¼Ÿ</strong></h3><p>æˆ‘ä»¬å·²ç»æ¸…æ¥šäº†ä¸‰çº§ç¼“å­˜çš„æµç¨‹ï¼Œä½†ä¸€ä¸ªå…³é”®é—®é¢˜æ˜¯ï¼šä¸ºä»€ä¹ˆå¿…é¡»åœ¨è¿™ä¹ˆæ—©çš„é˜¶æ®µå°±åˆ›å»ºä»£ç†å¯¹è±¡ï¼Ÿ</p><p>åŸå› å¾ˆç›´æ¥ï¼š<strong>ä¸ºäº†ä¿è¯ä¾èµ–æ³¨å…¥çš„ä¸€è‡´æ€§ï¼Œé˜²æ­¢AOPå¤±æ•ˆã€‚</strong></p><p>è®¾æƒ³ä¸€ä¸‹ï¼Œå¦‚æœSpringåœ¨è§£å†³Bå¯¹Açš„ä¾èµ–æ—¶ï¼Œä»ç¼“å­˜é‡Œå–å‡ºäº†ä¸€ä¸ª<strong>åŸå§‹çš„ã€æœªè¢«ä»£ç†çš„Aå¯¹è±¡</strong>å¹¶æ³¨å…¥ç»™äº†Bï¼Œé‚£ä¹ˆBå°±æŒæœ‰äº†ä¸€ä¸ªæŒ‡å‘åŸå§‹Aå¯¹è±¡çš„å¼•ç”¨ã€‚å³ä½¿åç»­Aå¯¹è±¡èµ°å®Œäº†æ‰€æœ‰æµç¨‹å¹¶è¢«æˆåŠŸä»£ç†ï¼ŒBå¯¹æ­¤ä¹Ÿä¸€æ— æ‰€çŸ¥ã€‚å½“Bè°ƒç”¨Açš„æ–¹æ³•æ—¶ï¼Œå®ƒä¼šç›´æ¥è®¿é—®åŸå§‹å¯¹è±¡ï¼Œä»è€Œå®Œç¾ç»•è¿‡AOPä»£ç†ï¼Œå¯¼è‡´äº‹åŠ¡ã€æ—¥å¿—ç­‰åˆ‡é¢åŠŸèƒ½å…¨éƒ¨å¤±æ•ˆã€‚</p><p>å› æ­¤ï¼ŒSpringå¿…é¡»åœ¨ä¾èµ–æ³¨å…¥å‘ç”Ÿæ—¶ï¼Œå°±ç¡®ä¿æ³¨å…¥çš„æ˜¯æ­£ç¡®çš„å¯¹è±¡â€”â€”å¦‚æœè¿™ä¸ªBeanæœªæ¥éœ€è¦è¢«ä»£ç†ï¼Œé‚£ä¹ˆæ­¤æ—¶æ³¨å…¥çš„å°±å¿…é¡»æ˜¯ä»£ç†å¯¹è±¡ã€‚ä¸‰çº§ç¼“å­˜ä¸­çš„<code>ObjectFactory</code>å°±æ‰¿æ‹…äº†è¿™ä¸ªèŒè´£ï¼Œå®ƒåœ¨æä¾›æ—©æœŸå¼•ç”¨æ—¶ï¼Œä¼šæ£€æŸ¥å¹¶åº”ç”¨AOPï¼Œè¿”å›ä¸€ä¸ªä»£ç†å¯¹è±¡ã€‚</p><hr><h3 id="4-æå‰ç”Ÿæˆä»£ç†çš„æ½œåœ¨é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ"><a href="#4-æå‰ç”Ÿæˆä»£ç†çš„æ½œåœ¨é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ" class="headerlink" title="4. æå‰ç”Ÿæˆä»£ç†çš„æ½œåœ¨é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ"></a>4. <strong>æå‰ç”Ÿæˆä»£ç†çš„æ½œåœ¨é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ</strong></h3><p>è¿™ç§â€æå‰æš´éœ²â€çš„æœºåˆ¶è™½ç„¶å·§å¦™ï¼Œä½†ä½œä¸ºå¼€å‘è€…ï¼Œæˆ‘ä»¬å¾ˆè‡ªç„¶ä¼šå…³å¿ƒå®ƒæ˜¯å¦å­˜åœ¨é£é™©ã€‚</p><h4 id="é—®é¢˜-1ï¼šæå‰æš´éœ²çš„â€åŠæˆå“â€BeançŠ¶æ€å¯é å—ï¼Ÿ"><a href="#é—®é¢˜-1ï¼šæå‰æš´éœ²çš„â€åŠæˆå“â€BeançŠ¶æ€å¯é å—ï¼Ÿ" class="headerlink" title="é—®é¢˜ 1ï¼šæå‰æš´éœ²çš„â€åŠæˆå“â€BeançŠ¶æ€å¯é å—ï¼Ÿ"></a><strong>é—®é¢˜ 1ï¼šæå‰æš´éœ²çš„â€åŠæˆå“â€BeançŠ¶æ€å¯é å—ï¼Ÿ</strong></h4><ul><li><strong>é£é™©</strong>ï¼šè¿™ä¸ªæå‰ç”Ÿæˆçš„ä»£ç†å¯¹è±¡ï¼Œå…¶å†…éƒ¨åŒ…è£¹çš„ç›®æ ‡å¯¹è±¡åœ¨å½“æ—¶å°šæœªå®Œæˆå±æ€§æ³¨å…¥å’Œåˆå§‹åŒ–ï¼ˆå¦‚<code>@PostConstruct</code>ï¼‰ã€‚æ­¤æ—¶è‹¥æœ‰æ–¹æ³•è°ƒç”¨ï¼Œä¼šä¸ä¼šå¯¼è‡´ç©ºæŒ‡é’ˆæˆ–æ•°æ®ä¸ä¸€è‡´ï¼Ÿ</li><li><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š<br>è¿™å¾—ç›Šäºä»£ç†å¯¹è±¡çš„å·¥ä½œæ¨¡å¼ã€‚æ— è®ºæ˜¯JDKåŠ¨æ€ä»£ç†è¿˜æ˜¯CGLIBï¼Œä»£ç†å¯¹è±¡å†…éƒ¨éƒ½åªç»´æŠ¤äº†ä¸€ä¸ªå¯¹<strong>ç›®æ ‡å¯¹è±¡çš„å¼•ç”¨</strong>ã€‚å½“å¤–éƒ¨é€šè¿‡ä»£ç†è°ƒç”¨æ–¹æ³•æ—¶ï¼Œä»£ç†å¯¹è±¡ä¼šå°†è°ƒç”¨<strong>å®æ—¶è½¬å‘</strong>ç»™å®ƒæŒæœ‰çš„ç›®æ ‡å¯¹è±¡ã€‚åœ¨å¾ªç¯ä¾èµ–çš„åœºæ™¯ä¸‹ï¼Œè™½ç„¶ä»£ç†æš´éœ²å¾—å¾ˆæ—©ï¼Œä½†çœŸæ­£çš„å¤–éƒ¨æ–¹æ³•è°ƒç”¨é€šå¸¸å‘ç”Ÿåœ¨æ‰€æœ‰Beanéƒ½åˆå§‹åŒ–å®Œæˆä¹‹åã€‚å±Šæ—¶ï¼Œç›®æ ‡å¯¹è±¡çš„çŠ¶æ€å·²ç»å®Œæ•´ï¼Œå› æ­¤é€šè¿‡ä»£ç†çš„è°ƒç”¨æ˜¯å®‰å…¨çš„ã€‚</li></ul><h4 id="é—®é¢˜-2ï¼šåæ¥çš„BeanPostProcessorä¼šä¸ä¼šå¤±æ•ˆï¼Ÿ"><a href="#é—®é¢˜-2ï¼šåæ¥çš„BeanPostProcessorä¼šä¸ä¼šå¤±æ•ˆï¼Ÿ" class="headerlink" title="é—®é¢˜ 2ï¼šåæ¥çš„BeanPostProcessorä¼šä¸ä¼šå¤±æ•ˆï¼Ÿ"></a><strong>é—®é¢˜ 2ï¼šåæ¥çš„BeanPostProcessorä¼šä¸ä¼šå¤±æ•ˆï¼Ÿ</strong></h4><ul><li><strong>é£é™©</strong>ï¼šå¦‚æœä»£ç†å¯¹è±¡è¿‡æ—©ç”Ÿæˆï¼Œé‚£æ’åœ¨åé¢çš„ <code>BeanPostProcessor</code> å¯¹åŸå§‹ Bean çš„ä¿®æ”¹ï¼Œè¿˜èƒ½å¦ä½“ç°åœ¨ä»£ç†å¯¹è±¡ä¸Šï¼Ÿ</li><li><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š<br>Springé€šè¿‡<code>BeanPostProcessor</code>çš„æ‰§è¡Œé¡ºåºæ¥ä¿è¯ã€‚è´Ÿè´£AOPçš„<code>AnnotationAwareAspectJAutoProxyCreator</code>ä¼šåœ¨ä¸€ä¸ªéå¸¸æ—©çš„æ—¶é—´ç‚¹ï¼ˆ<code>getEarlyBeanReference</code>é˜¶æ®µï¼‰ä»‹å…¥ã€‚ä¸€æ—¦å®ƒç”Ÿæˆäº†ä»£ç†å¯¹è±¡ï¼Œè¿™ä¸ªä»£ç†çš„AOPé€»è¾‘å°±åŸºæœ¬å›ºå®šäº†ã€‚åç»­å…¶ä»–çš„<code>BeanPostProcessor</code>ä»ç„¶å¯ä»¥å¯¹åŸå§‹Beançš„å±æ€§ç­‰è¿›è¡Œä¿®æ”¹ï¼Œä½†æ— æ³•æ”¹å˜å·²ç»ç»‡å…¥çš„ä»£ç†é€»è¾‘ã€‚</li></ul><blockquote><p>å½“ç„¶ï¼Œè¿™ä¹Ÿæ„å‘³ç€å¦‚æœä½ çš„æŸä¸ªåç½®å¤„ç†å™¨éœ€è¦å½±å“åˆ°ä»£ç†çš„ç”Ÿæˆé€»è¾‘ï¼Œä½ éœ€è¦ç¡®ä¿å®ƒçš„æ‰§è¡Œé¡ºåºåœ¨AOPå¤„ç†å™¨ä¹‹å‰ã€‚</p></blockquote><hr><h3 id="5-Spring-çš„æƒè¡¡ï¼šä¸€ç§åŠ¡å®çš„è®¾è®¡å“²å­¦"><a href="#5-Spring-çš„æƒè¡¡ï¼šä¸€ç§åŠ¡å®çš„è®¾è®¡å“²å­¦" class="headerlink" title="5. Spring çš„æƒè¡¡ï¼šä¸€ç§åŠ¡å®çš„è®¾è®¡å“²å­¦"></a>5. <strong>Spring çš„æƒè¡¡ï¼šä¸€ç§åŠ¡å®çš„è®¾è®¡å“²å­¦</strong></h3><p>Springåœ¨è¿™é‡Œçš„è®¾è®¡ï¼Œä½“ç°äº†ä¸€ç§éå¸¸åŠ¡å®çš„è®¾è®¡å“²å­¦ï¼šåœ¨ä¿è¯æ ¸å¿ƒåŠŸèƒ½çš„å‰æä¸‹ï¼Œåšå‡ºèªæ˜çš„æƒè¡¡ã€‚</p><ol><li><strong>åˆ©ç”¨ä»£ç†çš„è½¬å‘æœºåˆ¶</strong>ï¼š<br>ä»£ç†å¯¹è±¡çš„æ ¸å¿ƒæ˜¯â€è½¬å‘â€ï¼Œè€Œéâ€å­˜å‚¨çŠ¶æ€â€ã€‚è¿™ä¸ºâ€å…ˆåˆ›å»ºä»£ç†ï¼Œåå®Œå–„å¯¹è±¡â€çš„å¼‚æ­¥æ“ä½œæä¾›äº†ç†è®ºåŸºç¡€ã€‚åªè¦ä¿è¯åœ¨æ–¹æ³•è¢«çœŸæ­£è°ƒç”¨æ—¶ï¼Œç›®æ ‡å¯¹è±¡æ˜¯å®Œæ•´çš„å³å¯ã€‚</li><li><strong>æ˜ç¡®çš„è¾¹ç•Œæ¡ä»¶</strong>ï¼š<br>è¿™ä¸ªæœºåˆ¶å¹¶éä¸‡èƒ½ã€‚Springå®˜æ–¹ä¹ŸæŒ‡å‡ºï¼Œåº”å½“<strong>é¿å…åœ¨åˆå§‹åŒ–æ–¹æ³•ï¼ˆå¦‚<code>@PostConstruct</code>ï¼‰ä¸­ï¼Œè°ƒç”¨æœ¬ç±»ä¸­éœ€è¦è¢«AOPæ‹¦æˆªçš„æ–¹æ³•</strong>ã€‚å› ä¸ºåœ¨é‚£ä¸ªæ—¶é—´ç‚¹ï¼Œä»£ç†å¯èƒ½å°šæœªå®Œå…¨åº”ç”¨åˆ°å½“å‰Beançš„è‡ªæˆ‘å¼•ç”¨ä¸Šï¼Œå¯¼è‡´è°ƒç”¨ç»•è¿‡ä»£ç†ã€‚</li></ol><hr><h3 id="6-æ€»ç»“"><a href="#6-æ€»ç»“" class="headerlink" title="6. æ€»ç»“"></a>6. <strong>æ€»ç»“</strong></h3><p>ç°åœ¨æˆ‘ä»¬å†æ¥æ¢³ç†ä¸€ä¸‹ã€‚å½“Springâ€æ‰“ç ´å¸¸è§„â€æå‰æš´éœ²ä»£ç†æ—¶ï¼ŒèƒŒåæ˜¯ä¸€å¥—ä¸¥è°¨çš„æœºåˆ¶åœ¨æ”¯æ’‘ï¼š</p><ol><li><strong>å¾ªç¯ä¾èµ–é ä¸‰çº§ç¼“å­˜è§£è€¦</strong>ï¼šè¿™å¥—ç¼“å­˜æœºåˆ¶ç¡®ä¿äº†Beanä¹‹é—´å³ä½¿ç›¸äº’ä¾èµ–ï¼Œä¹Ÿèƒ½é¡ºåˆ©å®Œæˆè£…é…ã€‚</li><li><strong>AOPæœ‰æ•ˆæ€§é æå‰ä»£ç†</strong>ï¼šåœ¨ä¸‰çº§ç¼“å­˜çš„<code>ObjectFactory</code>ä¸­æå‰ç”Ÿæˆä»£ç†ï¼Œä¿è¯äº†æ³¨å…¥åˆ°å…¶ä»–Beanä¸­çš„å¼•ç”¨æ˜¯æ­£ç¡®çš„ä»£ç†å¯¹è±¡ï¼Œä»è€Œè®©AOPåŠŸèƒ½ä¸å¤±æ•ˆã€‚</li><li><strong>æ•°æ®ä¸€è‡´æ€§é å¼•ç”¨è½¬å‘</strong>ï¼šä»£ç†å¯¹è±¡é€šè¿‡æŒæœ‰å¯¹ç›®æ ‡å¯¹è±¡çš„å¼•ç”¨ï¼Œç¡®ä¿äº†ä»»ä½•æ—¶å€™çš„è°ƒç”¨éƒ½èƒ½è®¿é—®åˆ°ç›®æ ‡å¯¹è±¡çš„æœ€æ–°çŠ¶æ€ï¼Œé¿å…äº†æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚</li></ol><p>æ€»è€Œè¨€ä¹‹ï¼Œè¿™å¥—æ–¹æ¡ˆæ˜¯Springåœ¨æ¡†æ¶çš„å¥å£®æ€§å’ŒåŠŸèƒ½çš„å®Œå¤‡æ€§ä¹‹é—´ï¼Œåšå‡ºçš„ä¸€ä¸ªéå¸¸ç²¾å½©çš„å·¥ç¨‹å†³ç­–ï¼Œä½“ç°äº†è®¾è®¡çš„çµæ´»æ€§å’Œå®ç”¨æ€§ã€‚</p><hr><h3 id="7-è®¾è®¡å¯ç¤ºï¼šä»Springèº«ä¸Šå­¦åˆ°çš„"><a href="#7-è®¾è®¡å¯ç¤ºï¼šä»Springèº«ä¸Šå­¦åˆ°çš„" class="headerlink" title="7. è®¾è®¡å¯ç¤ºï¼šä»Springèº«ä¸Šå­¦åˆ°çš„"></a>7. <strong>è®¾è®¡å¯ç¤ºï¼šä»Springèº«ä¸Šå­¦åˆ°çš„</strong></h3><p>ä»Springå¤„ç†å¾ªç¯ä¾èµ–çš„æ–¹å¼ä¸­ï¼Œæˆ‘ä»¬ä½œä¸ºå¼€å‘è€…å¯ä»¥å¾—åˆ°ä¸€äº›å¯å‘ï¼š</p><ol><li><strong>é—®é¢˜é©±åŠ¨ï¼ŒåŠ¡å®å–èˆ</strong>ï¼šé¢å¯¹å¤æ‚é—®é¢˜ï¼ˆå¦‚å¾ªç¯ä¾èµ–ï¼‰ï¼Œä¸æ‹˜æ³¥äºå•ä¸€åŸåˆ™ï¼Œä¼˜å…ˆä¿è¯æ ¸å¿ƒåŠŸèƒ½å¯ç”¨ï¼Œå†é€šè¿‡ç²¾å·§çš„è®¾è®¡è§„é¿æ½œåœ¨é£é™©ã€‚</li><li><strong>åˆ†å±‚ä¸å»¶è¿Ÿ</strong>ï¼šé€šè¿‡åˆ†å±‚ï¼ˆä¸‰çº§ç¼“å­˜ï¼‰å’Œå»¶è¿Ÿè®¡ç®—ï¼ˆ<code>ObjectFactory</code>ï¼‰ï¼Œå°†å¤æ‚é—®é¢˜åˆ†è§£ï¼Œåœ¨çœŸæ­£éœ€è¦æ—¶æ‰æ‰§è¡Œå…³é”®æ­¥éª¤ï¼ˆå¦‚åˆ›å»ºä»£ç†ï¼‰ï¼Œé™ä½äº†è€¦åˆã€‚</li><li><strong>å¯¹ç”¨æˆ·é€æ˜</strong>ï¼šå°½ç®¡å†…éƒ¨æœºåˆ¶å¤æ‚ï¼Œä½†å¯¹äºå¼€å‘è€…è€Œè¨€ï¼Œä½¿ç”¨<code>@Autowired</code>å’ŒAOPæ³¨è§£çš„ä½“éªŒæ˜¯æ— ç¼çš„ã€‚ä¸€ä¸ªä¼˜ç§€çš„æ¡†æ¶ï¼Œå°±åº”è¯¥å°†å¤æ‚æ€§ç•™åœ¨å†…éƒ¨ã€‚</li></ol><hr><h3 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h3><p>Spring åœ¨è§£å†³å¾ªç¯ä¾èµ–æ—¶â€è¿èƒŒâ€å»¶è¿Ÿç”Ÿæˆä»£ç†çš„åŸåˆ™ï¼Œå®åˆ™æ˜¯<strong>é€šè¿‡ä¸‰çº§ç¼“å­˜å’Œä»£ç†å¯¹è±¡çš„è®¾è®¡ï¼Œåœ¨ç‰¹å®šåœºæ™¯ä¸‹åšå‡ºçš„åˆç†æƒè¡¡</strong>ã€‚è¿™æ ·æ—¢æ”¯æŒäº†å¾ªç¯ä¾èµ–ï¼Œåˆé€šè¿‡æŠ€æœ¯æ‰‹æ®µï¼ˆå¦‚ç›®æ ‡å¯¹è±¡å¼•ç”¨å§”æ‰˜ï¼‰é¿å…äº†çŠ¶æ€ä¸ä¸€è‡´é—®é¢˜ï¼Œæˆ‘æ„Ÿè§‰ä½“ç°äº†Springæ¡†æ¶è®¾è®¡çš„çµæ´»æ€§ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MinIO å­¦ä¹ æŒ‡å—</title>
      <link href="/2025/06/16/minio-learning-guide/"/>
      <url>/2025/06/16/minio-learning-guide/</url>
      
        <content type="html"><![CDATA[<h1 id="MinIO-å­¦ä¹ æŒ‡å—"><a href="#MinIO-å­¦ä¹ æŒ‡å—" class="headerlink" title="MinIO å­¦ä¹ æŒ‡å—"></a>MinIO å­¦ä¹ æŒ‡å—</h1><h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>MinIO æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„åˆ†å¸ƒå¼å¯¹è±¡å­˜å‚¨ç³»ç»Ÿï¼Œä¸“ä¸ºäº‘åŸç”Ÿåº”ç”¨è€Œè®¾è®¡ã€‚å®ƒå®Œå…¨å…¼å®¹ Amazon S3 APIï¼Œå¯ä»¥ç”¨äºå­˜å‚¨éç»“æ„åŒ–æ•°æ®ï¼Œå¦‚å›¾ç‰‡ã€è§†é¢‘ã€æ—¥å¿—æ–‡ä»¶ã€å¤‡ä»½å’Œå®¹å™¨é•œåƒç­‰ã€‚</p><h2 id="æ–‡æ¡£ç»“æ„"><a href="#æ–‡æ¡£ç»“æ„" class="headerlink" title="æ–‡æ¡£ç»“æ„"></a>æ–‡æ¡£ç»“æ„</h2><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    A[MinIOå­¦ä¹ æŒ‡å—] --&gt; B[1.æ ¸å¿ƒæ¦‚å¿µ]    A --&gt; C[2.æ•´ä½“æ¶æ„]    A --&gt; D[3.æ ¸å¿ƒæµç¨‹]    A --&gt; E[4.å­˜å‚¨ç³»ç»Ÿå¯¹æ¯”]    A --&gt; F[5.å‘½ä»¤ä½¿ç”¨æŒ‡å—]    A --&gt; G[6.æœ€ä½³å®è·µ]    A --&gt; H[7.æ€»ç»“]        B --&gt; B1[åŸºæœ¬æ¦‚å¿µ]    B --&gt; B2[é«˜çº§æ¦‚å¿µ]        C --&gt; C1[ç³»ç»Ÿæ¶æ„å›¾]    C --&gt; C2[æ¶æ„ç‰¹ç‚¹]    C --&gt; C3[æ— ä¸»æ¶æ„åŸç†]        D --&gt; D1[æ•°æ®å†™å…¥æµç¨‹]    D --&gt; D2[æ•°æ®è¯»å–æµç¨‹]    D --&gt; D3[æ•…éšœæ¢å¤æµç¨‹]        E --&gt; E1[å­˜å‚¨ç±»å‹å¯¹æ¯”]    E --&gt; E2[MinIO vs HDFS]    E --&gt; E3[é€‰å‹å†³ç­–æ¡†æ¶]        F --&gt; F1[å®‰è£…éƒ¨ç½²]    F --&gt; F2[åŸºæœ¬å‘½ä»¤]    F --&gt; F3[é«˜çº§åŠŸèƒ½]        G --&gt; G1[éƒ¨ç½²å»ºè®®]    G --&gt; G2[æ€§èƒ½ä¼˜åŒ–]    G --&gt; G3[å®‰å…¨å»ºè®®]        H --&gt; H1[æŠ€æœ¯ç‰¹è‰²]    H --&gt; H2[é€‚ç”¨åœºæ™¯]    H --&gt; H3[æœ€ä½³å®è·µ]  </pre></div><h2 id="1-MinIO-æ ¸å¿ƒæ¦‚å¿µ"><a href="#1-MinIO-æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="1. MinIO æ ¸å¿ƒæ¦‚å¿µ"></a>1. MinIO æ ¸å¿ƒæ¦‚å¿µ</h2><h3 id="1-1-åŸºæœ¬æ¦‚å¿µ"><a href="#1-1-åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="1.1 åŸºæœ¬æ¦‚å¿µ"></a>1.1 åŸºæœ¬æ¦‚å¿µ</h3><h4 id="Objectï¼ˆå¯¹è±¡ï¼‰"><a href="#Objectï¼ˆå¯¹è±¡ï¼‰" class="headerlink" title="Objectï¼ˆå¯¹è±¡ï¼‰"></a>Objectï¼ˆå¯¹è±¡ï¼‰</h4><ul><li>MinIO ä¸­çš„åŸºæœ¬å­˜å‚¨å•å…ƒ</li><li>åŒ…å«æ•°æ®æœ¬èº«å’Œç›¸å…³çš„å…ƒæ•°æ®</li><li>å¯¹è±¡å¤§å°å¯ä»¥ä»å‡  KB åˆ° 5TB</li></ul><h4 id="Bucketï¼ˆå­˜å‚¨æ¡¶ï¼‰"><a href="#Bucketï¼ˆå­˜å‚¨æ¡¶ï¼‰" class="headerlink" title="Bucketï¼ˆå­˜å‚¨æ¡¶ï¼‰"></a>Bucketï¼ˆå­˜å‚¨æ¡¶ï¼‰</h4><ul><li>ç”¨äºç»„ç»‡å¯¹è±¡çš„å®¹å™¨</li><li>ç±»ä¼¼äºæ–‡ä»¶ç³»ç»Ÿä¸­çš„é¡¶çº§ç›®å½•</li><li>æ¯ä¸ª MinIO éƒ¨ç½²å¯ä»¥æœ‰å¤šä¸ª bucket</li><li>Bucket åç§°åœ¨åŒä¸€ MinIO é›†ç¾¤å†…å¿…é¡»å”¯ä¸€</li></ul><h4 id="Keyï¼ˆé”®ï¼‰"><a href="#Keyï¼ˆé”®ï¼‰" class="headerlink" title="Keyï¼ˆé”®ï¼‰"></a>Keyï¼ˆé”®ï¼‰</h4><ul><li>å¯¹è±¡åœ¨ bucket ä¸­çš„å”¯ä¸€æ ‡è¯†ç¬¦</li><li>ç±»ä¼¼äºæ–‡ä»¶è·¯å¾„</li><li>æ”¯æŒå±‚æ¬¡ç»“æ„ï¼ˆä½¿ç”¨ <code>/</code> åˆ†éš”ç¬¦ï¼‰</li></ul><h4 id="Nodeï¼ˆèŠ‚ç‚¹ï¼‰"><a href="#Nodeï¼ˆèŠ‚ç‚¹ï¼‰" class="headerlink" title="Nodeï¼ˆèŠ‚ç‚¹ï¼‰"></a>Nodeï¼ˆèŠ‚ç‚¹ï¼‰</h4><ul><li>MinIO é›†ç¾¤ä¸­çš„å•ä¸ªæœåŠ¡å™¨å®ä¾‹</li><li>å¯ä»¥æ˜¯ç‰©ç†æœºå™¨æˆ–è™šæ‹Ÿæœº</li><li>æ¯ä¸ªèŠ‚ç‚¹è¿è¡Œ MinIO æœåŠ¡å™¨è¿›ç¨‹</li></ul><h4 id="Driveï¼ˆé©±åŠ¨å™¨ï¼‰"><a href="#Driveï¼ˆé©±åŠ¨å™¨ï¼‰" class="headerlink" title="Driveï¼ˆé©±åŠ¨å™¨ï¼‰"></a>Driveï¼ˆé©±åŠ¨å™¨ï¼‰</h4><ul><li>èŠ‚ç‚¹ä¸Šçš„å­˜å‚¨è®¾å¤‡</li><li>å¯ä»¥æ˜¯ç¡¬ç›˜ã€SSD æˆ–ç½‘ç»œå­˜å‚¨</li><li>MinIO ä½¿ç”¨çº åˆ ç å°†æ•°æ®åˆ†å¸ƒåœ¨å¤šä¸ªé©±åŠ¨å™¨ä¸Š</li></ul><h3 id="1-2-é«˜çº§æ¦‚å¿µ"><a href="#1-2-é«˜çº§æ¦‚å¿µ" class="headerlink" title="1.2 é«˜çº§æ¦‚å¿µ"></a>1.2 é«˜çº§æ¦‚å¿µ</h3><h4 id="Erasure-Codingï¼ˆçº åˆ ç ï¼‰"><a href="#Erasure-Codingï¼ˆçº åˆ ç ï¼‰" class="headerlink" title="Erasure Codingï¼ˆçº åˆ ç ï¼‰"></a>Erasure Codingï¼ˆçº åˆ ç ï¼‰</h4><ul><li>MinIO çš„æ ¸å¿ƒæ•°æ®ä¿æŠ¤æœºåˆ¶</li><li>å°†æ•°æ®åˆ†å‰²æˆå¤šä¸ªæ•°æ®ç‰‡å’Œæ ¡éªŒç‰‡</li><li>å³ä½¿éƒ¨åˆ†é©±åŠ¨å™¨æ•…éšœä¹Ÿèƒ½æ¢å¤æ•°æ®</li><li>æä¾›æ¯”å‰¯æœ¬æ›´é«˜çš„å­˜å‚¨æ•ˆç‡</li></ul><h4 id="Tenantï¼ˆç§Ÿæˆ·ï¼‰"><a href="#Tenantï¼ˆç§Ÿæˆ·ï¼‰" class="headerlink" title="Tenantï¼ˆç§Ÿæˆ·ï¼‰"></a>Tenantï¼ˆç§Ÿæˆ·ï¼‰</h4><ul><li>å¤šç§Ÿæˆ·ç¯å¢ƒä¸­çš„éš”ç¦»å•å…ƒ</li><li>æ¯ä¸ªç§Ÿæˆ·æœ‰ç‹¬ç«‹çš„å­˜å‚¨ç©ºé—´å’Œæƒé™</li><li>æ”¯æŒç»†ç²’åº¦çš„è®¿é—®æ§åˆ¶</li></ul><h2 id="2-MinIO-æ•´ä½“æ¶æ„"><a href="#2-MinIO-æ•´ä½“æ¶æ„" class="headerlink" title="2. MinIO æ•´ä½“æ¶æ„"></a>2. MinIO æ•´ä½“æ¶æ„</h2><h3 id="2-1-ç³»ç»Ÿæ¶æ„å›¾"><a href="#2-1-ç³»ç»Ÿæ¶æ„å›¾" class="headerlink" title="2.1 ç³»ç»Ÿæ¶æ„å›¾"></a>2.1 ç³»ç»Ÿæ¶æ„å›¾</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TB    subgraph &quot;å®¢æˆ·ç«¯å±‚&quot;        A1[Webæµè§ˆå™¨]        A2[SDKåº”ç”¨]        A3[CLIå·¥å…·]        A4[S3å…¼å®¹å®¢æˆ·ç«¯]    end    subgraph &quot;æ¥å…¥å±‚&quot;        B1[DNS]        B2[è´Ÿè½½å‡è¡¡å™¨]    end    subgraph &quot;MinIOé›†ç¾¤ (ç¤ºä¾‹: 4èŠ‚ç‚¹, 16é©±åŠ¨å™¨)&quot;        C1[èŠ‚ç‚¹1]        C2[èŠ‚ç‚¹2]        C3[èŠ‚ç‚¹3]        C4[èŠ‚ç‚¹4]    end    subgraph &quot;å­˜å‚¨å±‚ (æ¯ä¸ªèŠ‚ç‚¹ç®¡ç†è‡ªå·±çš„é©±åŠ¨å™¨)&quot;        subgraph &quot;èŠ‚ç‚¹1é©±åŠ¨å™¨&quot;            D1_1[Drive]            D1_2[Drive]            D1_3[Drive]            D1_4[Drive]        end        subgraph &quot;èŠ‚ç‚¹2é©±åŠ¨å™¨&quot;            D2_1[Drive]            D2_2[Drive]            D2_3[Drive]            D2_4[Drive]        end        subgraph &quot;èŠ‚ç‚¹3é©±åŠ¨å™¨&quot;            D3_1[Drive]            D3_2[Drive]            D3_3[Drive]            D3_4[Drive]        end        subgraph &quot;èŠ‚ç‚¹4é©±åŠ¨å™¨&quot;            D4_1[Drive]            D4_2[Drive]            D4_3[Drive]            D4_4[Drive]        end    end    A1 --&gt; B1    A2 --&gt; B1    A3 --&gt; B1    A4 --&gt; B1    B1 --&gt; B2    B2 --&gt; C1    B2 --&gt; C2    B2 --&gt; C3    B2 --&gt; C4    C1 --&gt; D1_1    C1 --&gt; D1_2    C1 --&gt; D1_3    C1 --&gt; D1_4    C2 --&gt; D2_1    C2 --&gt; D2_2    C2 --&gt; D2_3    C2 --&gt; D2_4    C3 --&gt; D3_1    C3 --&gt; D3_2    C3 --&gt; D3_3    C3 --&gt; D3_4    C4 --&gt; D4_1    C4 --&gt; D4_2    C4 --&gt; D4_3    C4 --&gt; D4_4  </pre></div><h3 id="2-2-æ¶æ„ç‰¹ç‚¹"><a href="#2-2-æ¶æ„ç‰¹ç‚¹" class="headerlink" title="2.2 æ¶æ„ç‰¹ç‚¹"></a>2.2 æ¶æ„ç‰¹ç‚¹</h3><h4 id="2-2-1-S3å…¼å®¹æ€§"><a href="#2-2-1-S3å…¼å®¹æ€§" class="headerlink" title="2.2.1 S3å…¼å®¹æ€§"></a>2.2.1 S3å…¼å®¹æ€§</h4><ul><li><strong>APIå…¼å®¹</strong>ï¼šå®Œå…¨å…¼å®¹Amazon S3 API</li><li><strong>SDKæ”¯æŒ</strong>ï¼šæ”¯æŒæ‰€æœ‰ä¸»æµç¼–ç¨‹è¯­è¨€çš„S3 SDK</li><li><strong>å·¥å…·å…¼å®¹</strong>ï¼šæ”¯æŒS3å…¼å®¹çš„å·¥å…·å’Œå®¢æˆ·ç«¯</li><li><strong>åŠŸèƒ½å¯¹ç­‰</strong>ï¼šæ”¯æŒS3çš„ä¸»è¦åŠŸèƒ½ï¼Œå¦‚ï¼š<ul><li>å­˜å‚¨æ¡¶æ“ä½œ</li><li>å¯¹è±¡æ“ä½œ</li><li>ç‰ˆæœ¬æ§åˆ¶</li><li>ç”Ÿå‘½å‘¨æœŸç®¡ç†</li><li>åŠ å¯†</li><li>è®¿é—®æ§åˆ¶</li></ul></li></ul><h4 id="2-2-2-æ— ä¸»æ¶æ„"><a href="#2-2-2-æ— ä¸»æ¶æ„" class="headerlink" title="2.2.2 æ— ä¸»æ¶æ„"></a>2.2.2 æ— ä¸»æ¶æ„</h4><ul><li>æ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯å¯¹ç­‰çš„</li><li>æ²¡æœ‰å•ç‚¹æ•…éšœ</li><li>è‡ªåŠ¨æ•…éšœè½¬ç§»å’Œæ¢å¤</li></ul><h4 id="2-2-3-æ¨ªå‘æ‰©å±•"><a href="#2-2-3-æ¨ªå‘æ‰©å±•" class="headerlink" title="2.2.3 æ¨ªå‘æ‰©å±•"></a>2.2.3 æ¨ªå‘æ‰©å±•</h4><ul><li>æ”¯æŒä»å•èŠ‚ç‚¹åˆ°æ•°åƒèŠ‚ç‚¹çš„æ‰©å±•</li><li>çº¿æ€§æ€§èƒ½å¢é•¿</li><li>çƒ­æ·»åŠ æ–°èŠ‚ç‚¹</li></ul><h4 id="2-2-4-é«˜å¯ç”¨æ€§"><a href="#2-2-4-é«˜å¯ç”¨æ€§" class="headerlink" title="2.2.4 é«˜å¯ç”¨æ€§"></a>2.2.4 é«˜å¯ç”¨æ€§</h4><ul><li>æ”¯æŒå¤šæ•°æ®ä¸­å¿ƒéƒ¨ç½²</li><li>è‡ªåŠ¨æ•…éšœæ£€æµ‹å’Œæ¢å¤</li><li>æ•°æ®ä¸€è‡´æ€§ä¿è¯</li></ul><h3 id="2-3-æ— ä¸»æ¶æ„æŠ€æœ¯åŸç†"><a href="#2-3-æ— ä¸»æ¶æ„æŠ€æœ¯åŸç†" class="headerlink" title="2.3 æ— ä¸»æ¶æ„æŠ€æœ¯åŸç†"></a>2.3 æ— ä¸»æ¶æ„æŠ€æœ¯åŸç†</h3><p>MinIOçš„æ— ä¸»æ¶æ„æ˜¯å…¶å®ç°é«˜å¯ç”¨å’Œé«˜æ€§èƒ½çš„æ ¸å¿ƒã€‚è¿™å¥—æ¶æ„ä¾èµ–äºå‡ ä¸ªå…³é”®çš„æŠ€æœ¯æœºåˆ¶ï¼šç¡®å®šæ€§å“ˆå¸Œç®—æ³•ã€çº åˆ ç ã€è‡ªæè¿°çš„å…ƒæ•°æ®ç®¡ç†ä»¥åŠæ™ºèƒ½çš„æ•…éšœæ£€æµ‹ä¸è‡ªæ„ˆã€‚</p><h4 id="2-3-1-æ ¸å¿ƒæœºåˆ¶ï¼šç¡®å®šæ€§å“ˆå¸Œä¸çº åˆ ç "><a href="#2-3-1-æ ¸å¿ƒæœºåˆ¶ï¼šç¡®å®šæ€§å“ˆå¸Œä¸çº åˆ ç " class="headerlink" title="2.3.1 æ ¸å¿ƒæœºåˆ¶ï¼šç¡®å®šæ€§å“ˆå¸Œä¸çº åˆ ç "></a>2.3.1 æ ¸å¿ƒæœºåˆ¶ï¼šç¡®å®šæ€§å“ˆå¸Œä¸çº åˆ ç </h4><h5 id="ç¡®å®šæ€§å“ˆå¸Œåˆ†å¸ƒç®—æ³•"><a href="#ç¡®å®šæ€§å“ˆå¸Œåˆ†å¸ƒç®—æ³•" class="headerlink" title="ç¡®å®šæ€§å“ˆå¸Œåˆ†å¸ƒç®—æ³•"></a>ç¡®å®šæ€§å“ˆå¸Œåˆ†å¸ƒç®—æ³•</h5><p>MinIOä¸ä½¿ç”¨ä¼ ç»Ÿçš„ä¸€è‡´æ€§å“ˆå¸Œç¯ã€‚å®ƒé‡‡ç”¨åŸºäºå¯¹è±¡åç§°ï¼ˆBucket + Objectï¼‰çš„ç¡®å®šæ€§å“ˆå¸Œç®—æ³•ï¼ˆHighwayHashï¼‰æ¥å†³å®šå¯¹è±¡åº”å­˜æ”¾åœ¨å“ªä¸ªçº åˆ ç é›†åˆï¼ˆErasure Setï¼‰ä¸­ã€‚ä¸€ä¸ªçº åˆ ç é›†åˆæ˜¯ä¸€ç»„é©±åŠ¨å™¨çš„ç»„åˆã€‚å› ä¸ºç®—æ³•æ˜¯ç¡®å®šæ€§çš„ï¼Œä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥ç‹¬ç«‹è®¡ç®—å‡ºä»»æ„å¯¹è±¡çš„å­˜æ”¾ä½ç½®ï¼Œä»è€Œæ— éœ€ä¸­å¿ƒèŠ‚ç‚¹åè°ƒã€‚</p><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph LR    subgraph &quot;ç¡®å®šæ€§å“ˆå¸Œåˆ†å¸ƒ&quot;        A[å¯¹è±¡Aåç§°] --&gt; H1[ç¡®å®šæ€§å“ˆå¸Œ]        B[å¯¹è±¡Båç§°] --&gt; H2[ç¡®å®šæ€§å“ˆå¸Œ]                H1 --&gt; ES1[&quot;çº åˆ ç é›†åˆ1 (é©±åŠ¨å™¨ç»„åˆA)&quot;]        H2 --&gt; ES2[&quot;çº åˆ ç é›†åˆ2 (é©±åŠ¨å™¨ç»„åˆB)&quot;]    end  </pre></div><h5 id="Reed-Solomon-çº åˆ ç "><a href="#Reed-Solomon-çº åˆ ç " class="headerlink" title="Reed-Solomon çº åˆ ç "></a>Reed-Solomon çº åˆ ç </h5><p>çº åˆ ç æ˜¯MinIOæ•°æ®ä¿æŠ¤çš„åŸºçŸ³ï¼Œå®ƒå–ä»£äº†ä¼ ç»Ÿçš„å¤šå‰¯æœ¬æ–¹å¼ï¼Œæä¾›äº†æ›´é«˜çš„å­˜å‚¨æ•ˆç‡ã€‚</p><p><strong>åŸºæœ¬åŸç†</strong>:</p><ul><li><strong>ç¼–ç </strong>: å°†åŸå§‹æ•°æ®åˆ†å‰²æˆKä¸ªæ•°æ®åˆ†ç‰‡ï¼Œå¹¶åŸºäºè¿™äº›æ•°æ®åˆ†ç‰‡ç”ŸæˆMä¸ªæ ¡éªŒåˆ†ç‰‡ã€‚æ€»å…±å¾—åˆ°K+Mä¸ªåˆ†ç‰‡ã€‚</li><li><strong>å­˜å‚¨</strong>: å°†è¿™K+Mä¸ªåˆ†ç‰‡å­˜å‚¨åœ¨ä¸åŒçš„é©±åŠ¨å™¨ä¸Šã€‚</li><li><strong>æ¢å¤</strong>: ç³»ç»Ÿæœ€å¤šå¯ä»¥å®¹å¿Mä¸ªåˆ†ç‰‡ï¼ˆå³Mä¸ªé©±åŠ¨å™¨ï¼‰ä¸¢å¤±ã€‚åªè¦æœ‰ä¸å°‘äºKä¸ªåˆ†ç‰‡å­˜åœ¨ï¼ˆæ— è®ºæ˜¯æ•°æ®åˆ†ç‰‡è¿˜æ˜¯æ ¡éªŒåˆ†ç‰‡ï¼‰ï¼Œå°±å¯ä»¥é€šè¿‡Reed-Solomonè§£ç ç®—æ³•å®Œæ•´åœ°æ¢å¤å‡ºåŸå§‹æ•°æ®ã€‚</li></ul><p><strong>çº åˆ ç é…ç½®ç¤ºä¾‹</strong>:<br>MinIOä¼šæ ¹æ®é›†ç¾¤ä¸­é©±åŠ¨å™¨çš„æ€»æ•°è‡ªåŠ¨é€‰æ‹©æœ€åˆé€‚çš„çº åˆ ç é…ç½®ï¼ˆK+Mï¼‰ã€‚ç”¨æˆ·ä¹Ÿå¯ä»¥æ‰‹åŠ¨æŒ‡å®šã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¸¸ç”¨çº åˆ ç é…ç½® (Nä¸ªé©±åŠ¨å™¨ï¼ŒEC:Mè¡¨ç¤ºMä¸ªæ ¡éªŒåˆ†ç‰‡)</span></span><br><span class="line"><span class="comment"># æ•°æ®åˆ†ç‰‡K = N - M</span></span><br><span class="line"></span><br><span class="line">1. 8ä¸ªé©±åŠ¨å™¨, EC:4 (4+4)</span><br><span class="line">   - å­˜å‚¨æ•ˆç‡: 50%, å¯å®¹å¿4ä¸ªé©±åŠ¨å™¨æ•…éšœã€‚</span><br><span class="line">   - é€‚ç”¨åœºæ™¯: é«˜å¯é æ€§è¦æ±‚ã€‚</span><br><span class="line"></span><br><span class="line">2. 16ä¸ªé©±åŠ¨å™¨, EC:4 (12+4)</span><br><span class="line">   - å­˜å‚¨æ•ˆç‡: 75%, å¯å®¹å¿4ä¸ªé©±åŠ¨å™¨æ•…éšœã€‚</span><br><span class="line">   - é€‚ç”¨åœºæ™¯: å¹³è¡¡æ•ˆç‡å’Œå¯é æ€§ã€‚</span><br><span class="line"></span><br><span class="line">3. 16ä¸ªé©±åŠ¨å™¨, EC:8 (8+8)</span><br><span class="line">   - å­˜å‚¨æ•ˆç‡: 50%, å¯å®¹å¿8ä¸ªé©±åŠ¨å™¨æ•…éšœã€‚</span><br><span class="line">   - é€‚ç”¨åœºæ™¯: æœ€é«˜å¯é æ€§è¦æ±‚ã€‚</span><br></pre></td></tr></table></figure><p><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼š<br>ä¸ºäº†åŠ é€Ÿçº åˆ ç çš„ç¼–è§£ç è®¡ç®—ï¼ŒMinIOä½¿ç”¨äº†SIMDæŒ‡ä»¤é›†ï¼ˆå¦‚Intel AVX512ï¼‰ï¼Œå¤§å¹…æå‡äº†CPUå¤„ç†æ•ˆç‡ï¼Œä½¿å¾—çº åˆ ç çš„æ€§èƒ½å¼€é”€é™åˆ°æœ€ä½ã€‚</p><h4 id="2-3-2-æ•°æ®è¯»å†™æœºåˆ¶"><a href="#2-3-2-æ•°æ®è¯»å†™æœºåˆ¶" class="headerlink" title="2.3.2 æ•°æ®è¯»å†™æœºåˆ¶"></a>2.3.2 æ•°æ®è¯»å†™æœºåˆ¶</h4><h5 id="å¹¶è¡Œè¯»å†™çœŸç›¸ï¼šå¹¶éæ‰€æœ‰èŠ‚ç‚¹å‚ä¸"><a href="#å¹¶è¡Œè¯»å†™çœŸç›¸ï¼šå¹¶éæ‰€æœ‰èŠ‚ç‚¹å‚ä¸" class="headerlink" title="å¹¶è¡Œè¯»å†™çœŸç›¸ï¼šå¹¶éæ‰€æœ‰èŠ‚ç‚¹å‚ä¸"></a>å¹¶è¡Œè¯»å†™çœŸç›¸ï¼šå¹¶éæ‰€æœ‰èŠ‚ç‚¹å‚ä¸</h5><p>ä¸€ä¸ªå¸¸è§çš„è¯¯è§£æ˜¯MinIOä¼šå°†æ•°æ®å†™å…¥åˆ°æ‰€æœ‰èŠ‚ç‚¹ã€‚å®é™…ä¸Šï¼ŒMinIOåªå‘å½“å‰å¯¹è±¡æ‰€å±çš„çº åˆ ç é›†åˆï¼ˆErasure Setï¼‰æ‰€åŒ…å«çš„é©±åŠ¨å™¨ï¼ˆåŠå¯¹åº”èŠ‚ç‚¹ï¼‰è¿›è¡Œå¹¶è¡Œè¯»å†™ã€‚</p><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TB    subgraph &quot;16èŠ‚ç‚¹é›†ç¾¤, 8+8çº åˆ ç é…ç½®&quot;        A[å®¢æˆ·ç«¯è¯·æ±‚] --&gt; B[ç¡®å®šæ€§å“ˆå¸Œè®¡ç®—]        B --&gt; C{é€‰æ‹©16ä¸ªé©±åŠ¨å™¨ç»„æˆçº åˆ ç é›†åˆ}                C --&gt; D[8ä¸ªæ•°æ®åˆ†ç‰‡]        C --&gt; E[8ä¸ªæ ¡éªŒåˆ†ç‰‡]                D --&gt; N_Data[å¹¶è¡Œå†™å…¥8ä¸ªé©±åŠ¨å™¨]        E --&gt; N_Parity[å¹¶è¡Œå†™å…¥8ä¸ªé©±åŠ¨å™¨]                subgraph &quot;å¯¹è±¡Açš„å­˜å‚¨&quot;            N_Data --&gt; NA[&quot;èŠ‚ç‚¹1,3,5,...&quot;]            N_Parity --&gt; PA[&quot;èŠ‚ç‚¹2,4,6,...&quot;]        end                subgraph &quot;å¯¹è±¡Bçš„å­˜å‚¨ (ä¸åŒåˆ†å¸ƒ)&quot;            style NB fill:#cce5ff            style PB fill:#fff2cc            B --&gt; NB[&quot;èŠ‚ç‚¹2,5,8,...&quot;]            B --&gt; PB[&quot;èŠ‚ç‚¹1,4,7,...&quot;]        end    end  </pre></div><p><strong>å…³é”®ç‚¹</strong>:</p><ol><li><strong>ç²¾ç¡®å¹¶è¡Œ</strong>ï¼šè¯»å†™æ“ä½œåªæ¶‰åŠæ„æˆçº åˆ ç é›†åˆçš„èŠ‚ç‚¹å’Œé©±åŠ¨å™¨ï¼Œè€Œéæ•´ä¸ªé›†ç¾¤ã€‚</li><li><strong>è´Ÿè½½å‡è¡¡</strong>ï¼šç”±äºä¸åŒå¯¹è±¡çš„å“ˆå¸Œå€¼ä¸åŒï¼Œå®ƒä»¬ä¼šè¢«åˆ†æ•£åˆ°é›†ç¾¤å†…ä¸åŒçš„é©±åŠ¨å™¨ç»„åˆä¸Šï¼Œä»è€Œè‡ªç„¶å®ç°äº†è´Ÿè½½å‡è¡¡ã€‚</li></ol><h5 id="è¯»å†™Quorumæœºåˆ¶"><a href="#è¯»å†™Quorumæœºåˆ¶" class="headerlink" title="è¯»å†™Quorumæœºåˆ¶"></a>è¯»å†™Quorumæœºåˆ¶</h5><p>MinIOçš„è¯»å†™æˆåŠŸä¸å¦ä¾èµ–äºä¸€ä¸ªâ€Quorumâ€æœºåˆ¶ï¼Œè¿™ä¸ªæœºåˆ¶åŸºäºçº åˆ ç çš„ç‰¹æ€§ã€‚</p><ul><li><strong>å†™å…¥Quorum</strong>ï¼šå¯¹äºK+Mçš„é…ç½®ï¼Œä¸€æ¬¡å†™å…¥æ“ä½œå¿…é¡»æˆåŠŸå†™å…¥è‡³å°‘Kä¸ªåˆ†ç‰‡æ‰ç®—æˆåŠŸã€‚è¿™ä¿è¯äº†æ•°æ®è‡³å°‘æœ‰è¶³å¤Ÿçš„â€åŸºç¡€â€å¯ä»¥è¢«æ¢å¤ã€‚åœ¨å®é™…å®ç°ä¸­ï¼ŒMinIOè¦æ±‚æ‰€æœ‰K+Mä¸ªåˆ†ç‰‡éƒ½å†™å…¥æˆåŠŸï¼Œå¦‚æœæŸä¸ªé©±åŠ¨å™¨æš‚æ—¶ä¸å¯ç”¨ï¼Œå†™æ“ä½œä¼šæŠ¥é”™ï¼Œç”±å®¢æˆ·ç«¯é‡è¯•ã€‚</li><li><strong>è¯»å–Quorum</strong>ï¼šä¸€ä¸ªè¯»å–æ“ä½œåªéœ€è¦æˆåŠŸè¯»å–ä»»æ„Kä¸ªåˆ†ç‰‡ï¼ˆæ•°æ®æˆ–æ ¡éªŒï¼‰ï¼Œå°±å¯ä»¥åœ¨å†…å­˜ä¸­é‡æ„å‡ºå®Œæ•´çš„åŸå§‹æ•°æ®ã€‚MinIOä¼šå¹¶è¡Œå‘æ‰€æœ‰K+Mä¸ªåˆ†ç‰‡å‘èµ·è¯»å–ï¼Œå¹¶é‡‡ç”¨æœ€å…ˆè¿”å›çš„Kä¸ªåˆ†ç‰‡ã€‚</li></ul><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    subgraph &quot;å†™å…¥æµç¨‹&quot;        A[å†™è¯·æ±‚] --&gt; B[&quot;è®¡ç®—å“ˆå¸Œ, å®šä½K+Mä¸ªé©±åŠ¨å™¨&quot;]        B --&gt; C[&quot;å¹¶è¡Œå†™å…¥K+Mä¸ªåˆ†ç‰‡&quot;]        C --&gt; D{æˆåŠŸå†™å…¥åˆ†ç‰‡æ•°}        D --&gt;|&gt;&#x3D; K+M| E[å†™å…¥æˆåŠŸ]        D --&gt;|&lt; K+M| F[å†™å…¥å¤±è´¥]    end    subgraph &quot;è¯»å–æµç¨‹&quot;        G[è¯»è¯·æ±‚] --&gt; H[&quot;è®¡ç®—å“ˆå¸Œ, å®šä½K+Mä¸ªé©±åŠ¨å™¨&quot;]        H --&gt; I[å¹¶è¡Œè¯»å–æ‰€æœ‰åˆ†ç‰‡]        I --&gt; J{æˆåŠŸè¿”å›åˆ†ç‰‡æ•°}        J --&gt;|&gt;&#x3D; K| K[æ•°æ®é‡æ„æˆåŠŸ]        J --&gt;|&lt; K| L[è¯»å–å¤±è´¥]    end  </pre></div><h4 id="2-3-3-åˆ†å¸ƒå¼å…ƒæ•°æ®ç®¡ç†"><a href="#2-3-3-åˆ†å¸ƒå¼å…ƒæ•°æ®ç®¡ç†" class="headerlink" title="2.3.3 åˆ†å¸ƒå¼å…ƒæ•°æ®ç®¡ç†"></a>2.3.3 åˆ†å¸ƒå¼å…ƒæ•°æ®ç®¡ç†</h4><p>MinIOçš„å…ƒæ•°æ®ç®¡ç†æ˜¯å…¶æ— ä¸»æ¶æ„è®¾è®¡çš„ç²¾é«“ä¹‹ä¸€ï¼Œå®ƒæ²¡æœ‰ä¸­å¿ƒåŒ–çš„å…ƒæ•°æ®æœåŠ¡å™¨ã€‚å…¶å…ƒæ•°æ®åˆ†ä¸ºä¸¤ç±»ï¼šå¯¹è±¡å…ƒæ•°æ®å’Œé…ç½®å…ƒæ•°æ®ã€‚</p><h5 id="å¯¹è±¡å…ƒæ•°æ®-Object-Metadata"><a href="#å¯¹è±¡å…ƒæ•°æ®-Object-Metadata" class="headerlink" title="å¯¹è±¡å…ƒæ•°æ® (Object Metadata)"></a>å¯¹è±¡å…ƒæ•°æ® (Object Metadata)</h5><ul><li><strong>è‡ªæè¿°æ ¼å¼</strong>ï¼šæ¯ä¸ªå¯¹è±¡åœ¨ç£ç›˜ä¸Šéƒ½åŒ…å«ä¸€ä¸ª <code>xl.json</code> æ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶ä¸å¯¹è±¡çš„æ•°æ®åˆ†ç‰‡ï¼ˆ<code>part.1</code>ï¼‰å­˜å‚¨åœ¨ä¸€èµ·ã€‚</li><li><strong>å†…å®¹</strong>: <code>xl.json</code> åŒ…å«äº†å…³äºè¯¥å¯¹è±¡çš„æ‰€æœ‰å…ƒä¿¡æ¯ï¼Œä¾‹å¦‚çº åˆ ç é…ç½®ï¼ˆç®—æ³•ã€Kå€¼ã€Må€¼ï¼‰ã€åˆ†ç‰‡åˆ†å¸ƒã€æ ¡éªŒå’Œã€åˆ›å»ºæ—¶é—´ç­‰ã€‚</li><li><strong>ä¿æŠ¤æœºåˆ¶</strong>: <code>xl.json</code> æ–‡ä»¶æœ¬èº«ä¹Ÿè¢«è§†ä¸ºå¯¹è±¡çš„ä¸€éƒ¨åˆ†ï¼Œä¸æ•°æ®åˆ†ç‰‡ä¸€æ ·ï¼Œå®ƒä¼šè¢«å¤åˆ¶å¹¶åˆ†å¸ƒåˆ°çº åˆ ç é›†åˆçš„æ‰€æœ‰é©±åŠ¨å™¨ä¸Šã€‚è¿™æ„å‘³ç€å…ƒæ•°æ®å’Œæ•°æ®äº«æœ‰åŒç­‰çº§åˆ«çš„çº åˆ ç ä¿æŠ¤ã€‚</li><li><strong>ä¼˜åŠ¿</strong>: è¿™ç§è®¾è®¡ä½¿å¾—æ¯ä¸ªå¯¹è±¡éƒ½æ˜¯â€è‡ªåŒ…å«â€å’Œâ€è‡ªæè¿°â€çš„ã€‚æ¢å¤æ•°æ®æ—¶ï¼Œç³»ç»Ÿæ— éœ€æŸ¥è¯¢å¤–éƒ¨çš„å…ƒæ•°æ®æœåŠ¡ï¼Œåªéœ€è¯»å–å¯¹è±¡è‡ªèº«çš„ <code>xl.json</code> æ–‡ä»¶å³å¯äº†è§£å¦‚ä½•é‡æ„å®ƒã€‚è¿™æå¤§åœ°ç®€åŒ–äº†ç³»ç»Ÿè®¾è®¡å’Œæ•…éšœæ¢å¤æµç¨‹ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯¹è±¡åœ¨ç£ç›˜ä¸Šçš„å®é™…å­˜å‚¨æ ¼å¼ç¤ºä¾‹</span></span><br><span class="line"><span class="comment"># æ¡¶ MyBucket, å¯¹è±¡ MyObject, å­˜å‚¨åœ¨4ä¸ªé©±åŠ¨å™¨çš„çº åˆ ç é›†åˆä¸­</span></span><br><span class="line">/path/to/drive1/MyBucket/MyObject/</span><br><span class="line">â”œâ”€â”€ xl.json        <span class="comment"># å…ƒæ•°æ®æ–‡ä»¶</span></span><br><span class="line">â””â”€â”€ part.1         <span class="comment"># è¯¥é©±åŠ¨å™¨ä¸Šçš„æ•°æ®/æ ¡éªŒåˆ†ç‰‡</span></span><br><span class="line"></span><br><span class="line">/path/to/drive2/MyBucket/MyObject/</span><br><span class="line">â”œâ”€â”€ xl.json        <span class="comment"># å…ƒæ•°æ®æ–‡ä»¶çš„å‰¯æœ¬</span></span><br><span class="line">â””â”€â”€ part.2         <span class="comment"># è¯¥é©±åŠ¨å™¨ä¸Šçš„æ•°æ®/æ ¡éªŒåˆ†ç‰‡</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><h5 id="é…ç½®å…ƒæ•°æ®-Configuration-Metadata"><a href="#é…ç½®å…ƒæ•°æ®-Configuration-Metadata" class="headerlink" title="é…ç½®å…ƒæ•°æ® (Configuration Metadata)"></a>é…ç½®å…ƒæ•°æ® (Configuration Metadata)</h5><ul><li><strong>èŒƒå›´</strong>: è¿™ç±»å…ƒæ•°æ®åŒ…æ‹¬å­˜å‚¨æ¡¶ç­–ç•¥ã€ç‰ˆæœ¬æ§åˆ¶è®¾ç½®ã€ç”Ÿå‘½å‘¨æœŸè§„åˆ™ï¼ˆILMï¼‰ã€IAMç”¨æˆ·å’Œç­–ç•¥ç­‰ã€‚</li><li><strong>å­˜å‚¨ä½ç½®</strong>: è¿™äº›é…ç½®ä¿¡æ¯å­˜å‚¨åœ¨æ¯ä¸ªèŠ‚ç‚¹çš„æ•°æ®ç›®å½•ä¸‹åä¸º <code>.minio.sys/</code> çš„éšè—ç›®å½•ä¸­ã€‚</li><li><strong>åŒæ­¥æœºåˆ¶</strong>: MinIOé›†ç¾¤å†…çš„æ‰€æœ‰èŠ‚ç‚¹ä¼šé€šè¿‡ä¸€ä¸ªå†…éƒ¨çš„åˆ†å¸ƒå¼å…±è¯†ï¼ˆconsensusï¼‰ç®—æ³•æ¥ä¿è¯ <code>.minio.sys/</code> ç›®å½•ä¸‹çš„å†…å®¹åœ¨æ‰€æœ‰èŠ‚ç‚¹é—´æ˜¯æœ€ç»ˆä¸€è‡´çš„ã€‚å½“ç®¡ç†å‘˜åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šåˆ›å»ºç”¨æˆ·æˆ–ä¿®æ”¹å­˜å‚¨æ¡¶ç­–ç•¥æ—¶ï¼Œè¿™ä¸ªå˜æ›´ä¼šè¢«åŒæ­¥åˆ°æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹ã€‚</li><li><strong>é«˜å¯ç”¨æ€§</strong>: å³ä½¿éƒ¨åˆ†èŠ‚ç‚¹å®•æœºï¼Œåªè¦é›†ç¾¤çš„å¤šæ•°èŠ‚ç‚¹å­˜æ´»ï¼Œé…ç½®ä¿¡æ¯å°±ä¸ä¼šä¸¢å¤±ï¼Œå¹¶ä¸”å¯ä»¥åœ¨æ–°èŠ‚ç‚¹åŠ å…¥æ—¶åŒæ­¥ç»™å®ƒã€‚è¿™ç¡®ä¿äº†é›†ç¾¤ç®¡ç†æ“ä½œçš„é«˜å¯ç”¨æ€§ã€‚</li></ul><h4 id="2-3-4-æ•…éšœæ£€æµ‹ä¸è‡ªæ„ˆæœºåˆ¶"><a href="#2-3-4-æ•…éšœæ£€æµ‹ä¸è‡ªæ„ˆæœºåˆ¶" class="headerlink" title="2.3.4 æ•…éšœæ£€æµ‹ä¸è‡ªæ„ˆæœºåˆ¶"></a>2.3.4 æ•…éšœæ£€æµ‹ä¸è‡ªæ„ˆæœºåˆ¶</h4><h5 id="å®æ—¶æ•…éšœç›‘æ§"><a href="#å®æ—¶æ•…éšœç›‘æ§" class="headerlink" title="å®æ—¶æ•…éšœç›‘æ§"></a>å®æ—¶æ•…éšœç›‘æ§</h5><ul><li><strong>å¿ƒè·³æœºåˆ¶</strong>ï¼šèŠ‚ç‚¹é—´é€šè¿‡å¿ƒè·³åŒ…ï¼ˆé»˜è®¤30ç§’ä¸€æ¬¡ï¼‰ç›¸äº’æ¢æµ‹å¥åº·çŠ¶æ€ã€‚</li><li><strong>å¤šç»´åº¦æ£€æµ‹</strong>ï¼šç›‘æ§ä¸ä»…é™äºèŠ‚ç‚¹å­˜æ´»ï¼Œè¿˜åŒ…æ‹¬ç½‘ç»œå»¶è¿Ÿã€ç£ç›˜å¥åº·ï¼ˆSMARTä¿¡æ¯ï¼‰ã€IOæ€§èƒ½ç­‰ã€‚</li><li><strong>æ¸è¿›å¼åˆ¤æ–­</strong>ï¼šç³»ç»Ÿä¸ä¼šå› ä¸ºçŸ­æš‚çš„ç½‘ç»œæŠ–åŠ¨å°±ç«‹å³åˆ¤å®šèŠ‚ç‚¹æ•…éšœï¼Œè€Œæ˜¯é‡‡ç”¨â€å¯ç–‘â€åˆ°â€æ•…éšœâ€çš„æ¸è¿›å¼ç­–ç•¥ï¼Œé¿å…è¯¯åˆ¤ã€‚</li></ul><h5 id="è‡ªåŠ¨æ•°æ®é‡å»ºï¼ˆè‡ªæ„ˆï¼‰"><a href="#è‡ªåŠ¨æ•°æ®é‡å»ºï¼ˆè‡ªæ„ˆï¼‰" class="headerlink" title="è‡ªåŠ¨æ•°æ®é‡å»ºï¼ˆè‡ªæ„ˆï¼‰"></a>è‡ªåŠ¨æ•°æ®é‡å»ºï¼ˆè‡ªæ„ˆï¼‰</h5><p>å½“ä¸€ä¸ªé©±åŠ¨å™¨è¢«ç¡®è®¤æ•…éšœåï¼ŒMinIOçš„è‡ªæ„ˆï¼ˆHealingï¼‰è¿‡ç¨‹ä¼šè‡ªåŠ¨å¯åŠ¨ï¼š</p><ol><li><strong>é™çº§æ¨¡å¼</strong>ï¼šåŒ…å«æ•…éšœé©±åŠ¨å™¨çš„çº åˆ ç é›†åˆä¼šè¿›å…¥é™çº§ï¼ˆdegradedï¼‰æ¨¡å¼ã€‚æ­¤æ—¶è¯»å†™è¯·æ±‚ä»å¯æ­£å¸¸æœåŠ¡ï¼ˆåªè¦å‰©ä½™é©±åŠ¨å™¨æ•°é‡å¤§äºç­‰äºKï¼‰ã€‚</li><li><strong>åå°æ‰«æ</strong>ï¼šç³»ç»Ÿä¼šæ‰«ææ‰€æœ‰å—è¯¥æ•…éšœé©±åŠ¨å™¨å½±å“çš„å¯¹è±¡ã€‚</li><li><strong>æ•°æ®é‡æ„</strong>ï¼šå¯¹äºæ¯ä¸ªå—å½±å“çš„å¯¹è±¡ï¼ŒMinIOä¼šè¯»å–å…¶å‰©ä½™çš„Kä¸ªå¯ç”¨åˆ†ç‰‡ï¼Œé‡æ„å‡ºä¸¢å¤±çš„åˆ†ç‰‡ã€‚</li><li><strong>å†™å…¥æ–°ä½ç½®</strong>ï¼šå°†é‡æ„å¥½çš„åˆ†ç‰‡å†™å…¥åˆ°é›†ç¾¤ä¸­çš„ä¸€ä¸ªå¥åº·çš„ã€å¯ç”¨çš„æ–°é©±åŠ¨å™¨ä¸Šã€‚</li><li><strong>æ›´æ–°å…ƒæ•°æ®</strong>ï¼šæ›´æ–°ç›¸å…³å¯¹è±¡çš„<code>xl.json</code>æ–‡ä»¶ï¼Œè®°å½•æ–°çš„åˆ†ç‰‡ä½ç½®ã€‚</li><li><strong>æ¢å¤æ­£å¸¸</strong>ï¼šä¸€æ—¦æ‰€æœ‰å—å½±å“çš„æ•°æ®éƒ½å®Œæˆé‡å»ºï¼Œç³»ç»Ÿå°±æ¢å¤åˆ°æ­£å¸¸çŠ¶æ€ã€‚</li></ol><p>è¿™ä¸ªè¿‡ç¨‹å®Œå…¨åœ¨åå°è‡ªåŠ¨è¿›è¡Œï¼Œå¯¹å‰å°åº”ç”¨é€æ˜ã€‚</p><h4 id="2-3-5-æ— ä¸»æ¶æ„çš„ä¼˜ç¼ºç‚¹"><a href="#2-3-5-æ— ä¸»æ¶æ„çš„ä¼˜ç¼ºç‚¹" class="headerlink" title="2.3.5 æ— ä¸»æ¶æ„çš„ä¼˜ç¼ºç‚¹"></a>2.3.5 æ— ä¸»æ¶æ„çš„ä¼˜ç¼ºç‚¹</h4><h5 id="ä¼˜åŠ¿"><a href="#ä¼˜åŠ¿" class="headerlink" title="ä¼˜åŠ¿"></a>ä¼˜åŠ¿</h5><ol><li>**é«˜å¯ç”¨æ€§ (æ— å•ç‚¹æ•…éšœ)**ï¼šæ‰€æœ‰èŠ‚ç‚¹å¯¹ç­‰ï¼Œæ²¡æœ‰ä¸»èŠ‚ç‚¹ã€‚ä»»ä½•èŠ‚ç‚¹çš„æ•…éšœéƒ½ä¸ä¼šå¯¼è‡´æ•´ä¸ªæœåŠ¡ä¸­æ–­ï¼Œåªè¦æ»¡è¶³çº åˆ ç çš„æœ€å°å¯ç”¨é©±åŠ¨å™¨æ•°ã€‚</li><li><strong>çº¿æ€§æ‰©å±•</strong>ï¼šå¢åŠ èŠ‚ç‚¹æˆ–é©±åŠ¨å™¨å¯ä»¥å¸¦æ¥è¿‘ä¹çº¿æ€§çš„æ€§èƒ½å’Œå®¹é‡å¢é•¿ã€‚ç¡®å®šæ€§å“ˆå¸Œç®—æ³•ä¿è¯äº†æ–°åŠ å…¥çš„èµ„æºä¼šè¢«è‡ªåŠ¨åˆ©ç”¨èµ·æ¥ã€‚</li><li><strong>è¿ç»´ç®€åŒ–</strong>ï¼šæ‰€æœ‰èŠ‚ç‚¹é…ç½®ç›¸åŒï¼Œéƒ¨ç½²å’Œç»´æŠ¤éƒ½éå¸¸ç®€å•ã€‚æ‰©å®¹ï¼ˆé€šè¿‡æœåŠ¡å™¨æ± ï¼‰ä¹Ÿæ— éœ€å¤æ‚çš„æ•°æ®é‡åˆ†å¸ƒæ“ä½œã€‚</li><li><strong>æˆæœ¬æ•ˆç›Š</strong>ï¼šçº åˆ ç ç›¸æ¯”3å‰¯æœ¬ç­‰æœºåˆ¶ï¼Œåœ¨åŒç­‰æˆ–æ›´é«˜å¯é æ€§ä¸‹ï¼Œå­˜å‚¨ç©ºé—´åˆ©ç”¨ç‡æ›´é«˜ï¼Œä»è€Œé™ä½äº†ç¡¬ä»¶æˆæœ¬ã€‚</li></ol><h5 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h5><ol><li><strong>æœ€ç»ˆä¸€è‡´æ€§</strong>ï¼šåœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œæ¯”å¦‚é…ç½®ä¿¡æ¯çš„å˜æ›´ï¼ŒèŠ‚ç‚¹é—´çš„åŒæ­¥å­˜åœ¨çŸ­æš‚å»¶è¿Ÿï¼Œå±äºæœ€ç»ˆä¸€è‡´æ€§ã€‚ä½†å¯¹äºå¯¹è±¡æ•°æ®IOï¼ŒMinIOé€šè¿‡å…¶Quorumæœºåˆ¶ä¿è¯äº†å¼ºä¸€è‡´æ€§ã€‚</li><li><strong>ç½‘ç»œå¼€é”€</strong>ï¼šæ— ä¸»æ¶æ„ä¸‹ï¼ŒèŠ‚ç‚¹é—´çš„é€šä¿¡ï¼ˆå¿ƒè·³ã€æ•°æ®ä¿®å¤ç­‰ï¼‰ä¼šæ¯”ä¸»ä»æ¶æ„æ›´é¢‘ç¹ï¼Œå¯¹ç½‘ç»œè´¨é‡è¦æ±‚è¾ƒé«˜ã€‚</li><li><strong>æ‰©å®¹é™åˆ¶</strong>ï¼šå•ä¸ªæœåŠ¡å™¨æ± çš„æ‰©å®¹ï¼ˆå¢åŠ é©±åŠ¨å™¨ï¼‰éœ€è¦é‡å¯ã€‚è™½ç„¶æ”¯æŒé€šè¿‡æ·»åŠ æ–°æœåŠ¡å™¨æ± ï¼ˆServer Poolï¼‰çš„æ–¹å¼åœ¨çº¿æ‰©å®¹ï¼Œä½†è¿™å¢åŠ äº†æ¶æ„çš„é€»è¾‘å±‚æ¬¡ã€‚åŒæ—¶ï¼Œå®˜æ–¹å»ºè®®å•ä¸ªé›†ç¾¤è§„æ¨¡ä¸å®œè¿‡å¤§ï¼ˆå¦‚è¶…è¿‡32ä¸ªèŠ‚ç‚¹ï¼‰ï¼Œè¶…å¤§è§„æ¨¡æ¨èä½¿ç”¨è”é‚¦æ¨¡å¼ã€‚</li></ol><h3 id="2-4-é›†ç¾¤æ‰©å®¹æœºåˆ¶"><a href="#2-4-é›†ç¾¤æ‰©å®¹æœºåˆ¶" class="headerlink" title="2.4 é›†ç¾¤æ‰©å®¹æœºåˆ¶"></a>2.4 é›†ç¾¤æ‰©å®¹æœºåˆ¶</h3><p>MinIO æ”¯æŒä¸¤ç§ä¸»è¦çš„æ‰©å®¹æ–¹å¼ï¼Œæ¯ç§æ–¹å¼éƒ½æœ‰å…¶ç‰¹å®šçš„ä½¿ç”¨åœºæ™¯å’Œé™åˆ¶ã€‚</p><h4 id="2-4-1-å¯¹ç­‰æ‰©å®¹ï¼ˆServer-Poolæ‰©å®¹ï¼‰"><a href="#2-4-1-å¯¹ç­‰æ‰©å®¹ï¼ˆServer-Poolæ‰©å®¹ï¼‰" class="headerlink" title="2.4.1 å¯¹ç­‰æ‰©å®¹ï¼ˆServer Poolæ‰©å®¹ï¼‰"></a>2.4.1 å¯¹ç­‰æ‰©å®¹ï¼ˆServer Poolæ‰©å®¹ï¼‰</h4><p><strong>åŸºæœ¬åŸç†</strong>ï¼š</p><ul><li>MinIO é‡‡ç”¨æœåŠ¡å™¨æ± ï¼ˆServer Poolï¼‰çš„æ¦‚å¿µè¿›è¡Œæ‰©å®¹</li><li>è¦æ±‚æ–°å¢çš„èŠ‚ç‚¹æ•°å’Œç£ç›˜æ•°ä¸åŸé›†ç¾¤ä¿æŒå¯¹ç­‰å…³ç³»</li><li>æ–°è€æ•°æ®ä¿æŒåœ¨å„è‡ªçš„æœåŠ¡å™¨æ± ä¸­ï¼Œä¸è¿›è¡Œé‡æ–°åˆ†å¸ƒ</li></ul><p><strong>æ‰©å®¹æµç¨‹</strong>ï¼š</p><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TB    subgraph &quot;æ‰©å®¹å‰&quot;        SP1[æœåŠ¡å™¨æ± 1]        SP1 --&gt; N1[èŠ‚ç‚¹1-4]        SP1 --&gt; D1[åŸæœ‰æ•°æ®]    end        subgraph &quot;æ‰©å®¹å&quot;        SP1_FINAL[æœåŠ¡å™¨æ± 1]        SP2_FINAL[æœåŠ¡å™¨æ± 2]                SP1_FINAL --&gt; N1_FINAL[èŠ‚ç‚¹1-4]        SP1_FINAL --&gt; D1_FINAL[åŸæœ‰æ•°æ®]                SP2_FINAL --&gt; N2_FINAL[èŠ‚ç‚¹5-8]        SP2_FINAL --&gt; D2_FINAL[æ–°æ•°æ®]                APP[æ–°å¯¹è±¡å†™å…¥] --&gt; BALANCE{è´Ÿè½½å‡è¡¡}        BALANCE --&gt;|åŸºäºå¯ç”¨ç©ºé—´| SP1_FINAL        BALANCE --&gt;|åŸºäºå¯ç”¨ç©ºé—´| SP2_FINAL    end  </pre></div><p><strong>æŠ€æœ¯é™åˆ¶</strong>ï¼š</p><ul><li><strong>å¯¹ç­‰è¦æ±‚</strong>ï¼šæ–°å¢çš„æœåŠ¡å™¨æ± å¿…é¡»ä¸ç°æœ‰æ± å…·æœ‰å®Œå…¨ç›¸åŒçš„èŠ‚ç‚¹æ•°å’Œæ¯èŠ‚ç‚¹çš„é©±åŠ¨å™¨æ•°ã€‚</li><li><strong>æ•°æ®ä¸é‡åˆ†å¸ƒ</strong>ï¼šæ—§æ•°æ®åœç•™åœ¨æ—§æ± ï¼Œæ–°æ•°æ®æ ¹æ®è´Ÿè½½å‡è¡¡ç­–ç•¥å†™å…¥åˆ°æ‰€æœ‰æ± ä¸­ã€‚</li><li><strong>é‡å¯éœ€æ±‚</strong>ï¼šæ‰©å®¹æ“ä½œéœ€è¦é‡å¯æ•´ä¸ªé›†ç¾¤ä»¥åº”ç”¨æ–°çš„æœåŠ¡å™¨æ± é…ç½®ã€‚</li></ul><h4 id="2-4-2-è”é‚¦æ‰©å®¹ï¼ˆFederationï¼‰"><a href="#2-4-2-è”é‚¦æ‰©å®¹ï¼ˆFederationï¼‰" class="headerlink" title="2.4.2 è”é‚¦æ‰©å®¹ï¼ˆFederationï¼‰"></a>2.4.2 è”é‚¦æ‰©å®¹ï¼ˆFederationï¼‰</h4><p><strong>åŸºæœ¬åŸç†</strong>ï¼š</p><ul><li>é€šè¿‡ etcd å°†å¤šä¸ªç‹¬ç«‹çš„ MinIO é›†ç¾¤ï¼ˆæˆ–ç§°ä¸ºç§Ÿæˆ·ï¼‰ç»„æˆä¸€ä¸ªé€»è¾‘ä¸Šçš„å¤§é›†ç¾¤ã€‚</li><li>è”é‚¦æä¾›ç»Ÿä¸€çš„å‘½åç©ºé—´ï¼Œä½†å„ç§Ÿæˆ·é›†ç¾¤åœ¨ç‰©ç†ä¸Šå’Œç®¡ç†ä¸Šæ˜¯ç‹¬ç«‹çš„ã€‚</li><li>etcd è´Ÿè´£ç»´æŠ¤å­˜å‚¨æ¡¶åˆ°å…·ä½“ç§Ÿæˆ·é›†ç¾¤çš„æ˜ å°„å…³ç³»ã€‚</li></ul><p><strong>è”é‚¦æ¶æ„</strong>ï¼š</p><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TB    subgraph &quot;MinIOè”é‚¦é›†ç¾¤&quot;        CLIENT[å®¢æˆ·ç«¯] --&gt; |è¯·æ±‚bucket-A| LB[&quot;ç»Ÿä¸€å…¥å£&#x2F;ç½‘å…³&quot;]        LB --&gt;|æŸ¥è¯¢etcd| ETCD[etcdé›†ç¾¤]        ETCD --&gt;|bucket-A åœ¨ Cluster1| LB                LB --&gt; CLUSTER1[ç§Ÿæˆ·é›†ç¾¤1]                subgraph &quot;ç‹¬ç«‹ç§Ÿæˆ·é›†ç¾¤&quot;            CLUSTER1            CLUSTER2[ç§Ÿæˆ·é›†ç¾¤2]            CLUSTER3[ç§Ÿæˆ·é›†ç¾¤N]        end                CLUSTER1 -- &quot;æ³¨å†Œ&#x2F;å¿ƒè·³&quot; --&gt; ETCD        CLUSTER2 -- &quot;æ³¨å†Œ&#x2F;å¿ƒè·³&quot; --&gt; ETCD        CLUSTER3 -- &quot;æ³¨å†Œ&#x2F;å¿ƒè·³&quot; --&gt; ETCD    end  </pre></div><p><strong>è”é‚¦æ‰©å®¹ä¼˜åŠ¿</strong>ï¼š</p><ul><li><strong>æ— é™æ‰©å±•</strong>ï¼šç†è®ºä¸Šå¯ä»¥æ— é™è¿æ¥æ–°çš„ç§Ÿæˆ·é›†ç¾¤ï¼Œæ‰“ç ´å•é›†ç¾¤çš„èŠ‚ç‚¹æ•°é™åˆ¶ã€‚</li><li><strong>æ•…éšœéš”ç¦»</strong>ï¼šä¸€ä¸ªç§Ÿæˆ·é›†ç¾¤çš„æ•…éšœä¸ä¼šå½±å“å…¶ä»–é›†ç¾¤ã€‚</li><li><strong>çµæ´»æ€§</strong>ï¼šä¸åŒç§Ÿæˆ·é›†ç¾¤å¯ä»¥æœ‰ä¸åŒçš„è§„æ¨¡å’Œé…ç½®ã€‚</li></ul><p><strong>è”é‚¦æ‰©å®¹ç¼ºç‚¹</strong>ï¼š</p><ul><li><strong>å¼•å…¥å¤–éƒ¨ä¾èµ–</strong>ï¼šéœ€è¦éƒ¨ç½²å’Œç»´æŠ¤ä¸€ä¸ªé«˜å¯ç”¨çš„etcdé›†ç¾¤ã€‚</li><li><strong>é…ç½®ä¸ç®¡ç†æ›´å¤æ‚</strong>ï¼šå¢åŠ äº†ç³»ç»Ÿçš„æ•´ä½“å¤æ‚åº¦ã€‚</li></ul><h4 id="2-4-3-æ‰©å®¹æ–¹å¼é€‰æ‹©å»ºè®®"><a href="#2-4-3-æ‰©å®¹æ–¹å¼é€‰æ‹©å»ºè®®" class="headerlink" title="2.4.3 æ‰©å®¹æ–¹å¼é€‰æ‹©å»ºè®®"></a>2.4.3 æ‰©å®¹æ–¹å¼é€‰æ‹©å»ºè®®</h4><table><thead><tr><th>æ‰©å®¹æ–¹å¼</th><th>é€‚ç”¨åœºæ™¯</th><th>ä¼˜åŠ¿</th><th>åŠ£åŠ¿</th></tr></thead><tbody><tr><td><strong>å¯¹ç­‰æ‰©å®¹</strong></td><td>ä¸­å°å‹é›†ç¾¤ï¼ˆ&lt;32èŠ‚ç‚¹ï¼‰</td><td>é…ç½®ç®€å•ï¼Œæ— å¤–éƒ¨ä¾èµ–</td><td>æœ‰èŠ‚ç‚¹æ•°å»ºè®®ä¸Šé™ï¼Œéœ€è¦é‡å¯</td></tr><tr><td><strong>è”é‚¦æ‰©å®¹</strong></td><td>è¶…å¤§è§„æ¨¡ç¯å¢ƒï¼Œå¤šç§Ÿæˆ·åœºæ™¯</td><td>æ— é™æ‰©å±•ï¼Œæ•…éšœéš”ç¦»</td><td>é…ç½®å¤æ‚ï¼Œä¾èµ–etcd</td></tr></tbody></table><h3 id="2-5-MinIOæŠ€æœ¯æ¾„æ¸…ä¸é—®é¢˜è§£ç­”"><a href="#2-5-MinIOæŠ€æœ¯æ¾„æ¸…ä¸é—®é¢˜è§£ç­”" class="headerlink" title="2.5 MinIOæŠ€æœ¯æ¾„æ¸…ä¸é—®é¢˜è§£ç­”"></a>2.5 MinIOæŠ€æœ¯æ¾„æ¸…ä¸é—®é¢˜è§£ç­”</h3><p>åŸºäºå¯¹MinIOæ¶æ„çš„æ·±å…¥ç†è§£ï¼Œæˆ‘ä»¬å¯ä»¥æ¾„æ¸…ä¸€äº›å¸¸è§çš„æŠ€æœ¯è¯¯è§£ï¼Œå¹¶å›ç­”ä¸€äº›æ ¸å¿ƒé—®é¢˜ã€‚</p><h4 id="é‡è¦æŠ€æœ¯æ¾„æ¸…"><a href="#é‡è¦æŠ€æœ¯æ¾„æ¸…" class="headerlink" title="é‡è¦æŠ€æœ¯æ¾„æ¸…"></a>é‡è¦æŠ€æœ¯æ¾„æ¸…</h4><ul><li><strong>MinIOä¸ä½¿ç”¨ä¼ ç»Ÿçš„ä¸€è‡´æ€§å“ˆå¸Œç¯</strong>: å®ƒä½¿ç”¨åŸºäºå¯¹è±¡åç§°çš„ç¡®å®šæ€§å“ˆå¸Œç®—æ³•ï¼Œè¿™ä¸éœ€è¦ç»´æŠ¤å“ˆå¸Œç¯çŠ¶æ€çš„ç³»ç»Ÿæœ‰æœ¬è´¨åŒºåˆ«ã€‚</li><li><strong>MinIOçš„Quorumæœºåˆ¶åŸºäºçº åˆ ç </strong>: å…¶è¯»å†™Quorumç”±Reed-Solomonç®—æ³•çš„æ•°å­¦ç‰¹æ€§ï¼ˆK&#x2F;Må€¼ï¼‰å†³å®šï¼Œè€Œéä¼ ç»Ÿçš„åŸºäºå¤šæ•°æ´¾æŠ•ç¥¨çš„Quorumã€‚</li><li><strong>MinIOçš„å…ƒæ•°æ®ç®¡ç†æ˜¯è‡ªæè¿°å’Œåˆ†å¸ƒå¼çš„</strong>: å¯¹è±¡å…ƒæ•°æ®éšå¯¹è±¡æœ¬èº«å­˜å‚¨å’Œä¿æŠ¤ï¼Œä¸å­˜åœ¨é›†ä¸­å¼çš„å…ƒæ•°æ®ç“¶é¢ˆã€‚</li></ul><h4 id="æ ¸å¿ƒæŠ€æœ¯é—®é¢˜è§£ç­”"><a href="#æ ¸å¿ƒæŠ€æœ¯é—®é¢˜è§£ç­”" class="headerlink" title="æ ¸å¿ƒæŠ€æœ¯é—®é¢˜è§£ç­”"></a>æ ¸å¿ƒæŠ€æœ¯é—®é¢˜è§£ç­”</h4><h5 id="é—®é¢˜1ï¼šMinIOè¯»å†™æ–‡ä»¶ä¼šå¹¶è¡Œå†™åˆ°æ‰€æœ‰èŠ‚ç‚¹å—ï¼Ÿ"><a href="#é—®é¢˜1ï¼šMinIOè¯»å†™æ–‡ä»¶ä¼šå¹¶è¡Œå†™åˆ°æ‰€æœ‰èŠ‚ç‚¹å—ï¼Ÿ" class="headerlink" title="é—®é¢˜1ï¼šMinIOè¯»å†™æ–‡ä»¶ä¼šå¹¶è¡Œå†™åˆ°æ‰€æœ‰èŠ‚ç‚¹å—ï¼Ÿ"></a>é—®é¢˜1ï¼šMinIOè¯»å†™æ–‡ä»¶ä¼šå¹¶è¡Œå†™åˆ°æ‰€æœ‰èŠ‚ç‚¹å—ï¼Ÿ</h5><p><strong>ç­”æ¡ˆï¼šä¸ä¼šï¼Œè¿™æ˜¯ä¸€ä¸ªå¸¸è§è¯¯è§£ã€‚</strong></p><p><strong>æ­£ç¡®ç†è§£</strong>ï¼š</p><ul><li>MinIOåªå‘å½“å‰å¯¹è±¡æ‰€å±çš„çº åˆ ç é›†åˆæ‰€åŒ…å«çš„èŠ‚ç‚¹&#x2F;é©±åŠ¨å™¨å¹¶è¡Œå†™å…¥ï¼Œè€Œéé›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ã€‚</li><li>ä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ª100èŠ‚ç‚¹çš„é›†ç¾¤ä¸­ï¼Œå¦‚æœä½¿ç”¨8+8çš„çº åˆ ç é…ç½®ï¼Œé‚£ä¹ˆä»»ä½•ä¸€ä¸ªå¯¹è±¡çš„è¯»å†™æ“ä½œéƒ½åªæ¶‰åŠå…¶ä¸­çš„16ä¸ªèŠ‚ç‚¹&#x2F;é©±åŠ¨å™¨ã€‚</li><li>é€šè¿‡ç¡®å®šæ€§å“ˆå¸Œç®—æ³•ï¼Œä¸åŒçš„å¯¹è±¡ä¼šè¢«æ™ºèƒ½åœ°åˆ†é…åˆ°ä¸åŒçš„çº åˆ ç é›†åˆä¸Šï¼Œè¿™å°±åœ¨å®è§‚ä¸Šå®ç°äº†æ•´ä¸ªé›†ç¾¤çš„è´Ÿè½½å‡è¡¡ï¼Œé¿å…äº†ä¸å¿…è¦çš„ç½‘ç»œå’ŒIOå¼€é”€ã€‚</li></ul><h5 id="é—®é¢˜2ï¼šåˆ†å¸ƒå¼å…ƒæ•°æ®åœ¨æ‰©å®¹-ç¼©å®¹å’ŒèŠ‚ç‚¹å®•æœºæ—¶å¦‚ä½•å¤„ç†ï¼Ÿ"><a href="#é—®é¢˜2ï¼šåˆ†å¸ƒå¼å…ƒæ•°æ®åœ¨æ‰©å®¹-ç¼©å®¹å’ŒèŠ‚ç‚¹å®•æœºæ—¶å¦‚ä½•å¤„ç†ï¼Ÿ" class="headerlink" title="é—®é¢˜2ï¼šåˆ†å¸ƒå¼å…ƒæ•°æ®åœ¨æ‰©å®¹&#x2F;ç¼©å®¹å’ŒèŠ‚ç‚¹å®•æœºæ—¶å¦‚ä½•å¤„ç†ï¼Ÿ"></a>é—®é¢˜2ï¼šåˆ†å¸ƒå¼å…ƒæ•°æ®åœ¨æ‰©å®¹&#x2F;ç¼©å®¹å’ŒèŠ‚ç‚¹å®•æœºæ—¶å¦‚ä½•å¤„ç†ï¼Ÿ</h5><p><strong>ç­”æ¡ˆ</strong>ï¼šéœ€è¦åŒºåˆ†å¯¹è±¡å…ƒæ•°æ®å’Œé…ç½®å…ƒæ•°æ®ã€‚</p><p>**å¯¹è±¡å…ƒæ•°æ® (<code>xl.json</code>)**ï¼š</p><ul><li><strong>èŠ‚ç‚¹å®•æœº</strong>ï¼šç”±äº <code>xl.json</code> å’Œæ•°æ®åˆ†ç‰‡ä¸€æ ·ï¼Œåœ¨çº åˆ ç é›†åˆçš„æ‰€æœ‰é©±åŠ¨å™¨ä¸Šéƒ½æœ‰å‰¯æœ¬ï¼Œå› æ­¤å®ƒçš„å¯ç”¨æ€§å’Œæ¢å¤æœºåˆ¶ä¸å¯¹è±¡æ•°æ®å®Œå…¨ç›¸åŒã€‚åªè¦æ»¡è¶³è¯»å–Quorumï¼ˆKä¸ªå¯ç”¨åˆ†ç‰‡ï¼‰ï¼Œå¯¹è±¡åŠå…¶å…ƒæ•°æ®å°±å¯ä»¥è¢«è®¿é—®å’Œæ¢å¤ã€‚</li><li><strong>æ‰©å®¹</strong>ï¼šåœ¨æœåŠ¡å™¨æ± æ‰©å®¹æ¨¡å¼ä¸‹ï¼Œç°æœ‰å¯¹è±¡çš„å…ƒæ•°æ®å’Œæ•°æ®éƒ½ä¿ç•™åœ¨åŸæœ‰çš„æœåŠ¡å™¨æ± ä¸­ï¼Œä¸ä¼šå‘ç”Ÿå˜åŠ¨ã€‚æ–°å¯¹è±¡åŠå…¶å…ƒæ•°æ®å°†è¢«å†™å…¥åˆ°åŒ…æ‹¬æ–°æ± åœ¨å†…çš„æ‰€æœ‰å¯ç”¨æ± ä¸­ã€‚</li></ul><p>**é…ç½®å…ƒæ•°æ® (<code>.minio.sys/</code>)**ï¼š</p><ul><li><strong>èŠ‚ç‚¹å®•æœº</strong>ï¼šç”±äºé…ç½®ä¿¡æ¯åœ¨æ‰€æœ‰èŠ‚ç‚¹é—´é€šè¿‡å…±è¯†ç®—æ³•åŒæ­¥ï¼Œå°‘æ•°èŠ‚ç‚¹çš„å®•æœºä¸ä¼šå½±å“é…ç½®çš„å¯ç”¨æ€§ã€‚å­˜æ´»çš„èŠ‚ç‚¹ä»ç„¶æ‹¥æœ‰å®Œæ•´çš„é…ç½®ä¿¡æ¯ã€‚</li><li><strong>æ‰©å®¹&#x2F;æ–°èŠ‚ç‚¹åŠ å…¥</strong>ï¼šæ–°åŠ å…¥çš„èŠ‚ç‚¹ä¼šè‡ªåŠ¨ä»é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹åŒæ­¥æœ€æ–°çš„é…ç½®ä¿¡æ¯ï¼Œä»è€Œå¿«é€Ÿèå…¥é›†ç¾¤ã€‚</li></ul><p><strong>æ€»ç»“</strong>ï¼šMinIOçš„æ— ä¸»æ¶æ„é€šè¿‡ç²¾å·§çš„æŠ€æœ¯è®¾è®¡ï¼ˆç¡®å®šæ€§å“ˆå¸Œã€çº åˆ ç ã€è‡ªæè¿°å…ƒæ•°æ®ï¼‰ï¼ŒæˆåŠŸåœ°è§£å†³äº†åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„ç»å…¸éš¾é¢˜ï¼Œå®ç°äº†é«˜å¯ç”¨ã€é«˜æ€§èƒ½ã€æ˜“æ‰©å±•çš„å­˜å‚¨ç³»ç»Ÿã€‚</p><h2 id="3-MinIO-æ ¸å¿ƒæµç¨‹"><a href="#3-MinIO-æ ¸å¿ƒæµç¨‹" class="headerlink" title="3. MinIO æ ¸å¿ƒæµç¨‹"></a>3. MinIO æ ¸å¿ƒæµç¨‹</h2><h3 id="3-1-æ•°æ®å†™å…¥æµç¨‹"><a href="#3-1-æ•°æ®å†™å…¥æµç¨‹" class="headerlink" title="3.1 æ•°æ®å†™å…¥æµç¨‹"></a>3.1 æ•°æ®å†™å…¥æµç¨‹</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  sequenceDiagram    participant C as å®¢æˆ·ç«¯    participant LB as è´Ÿè½½å‡è¡¡å™¨    participant M as ä»»ä¸€MinIOèŠ‚ç‚¹    participant DSet as é©±åŠ¨å™¨çº åˆ ç é›†åˆ        C-&gt;&gt;LB: PUTå¯¹è±¡è¯·æ±‚ (æºå¸¦æ•°æ®)    LB-&gt;&gt;M: è·¯ç”±åˆ°ä»»ä¸€å¯ç”¨èŠ‚ç‚¹    M-&gt;&gt;M: 1. æ ¹æ®å¯¹è±¡åè®¡ç®—å“ˆå¸Œ, ç¡®å®šé©±åŠ¨å™¨é›†åˆ    M-&gt;&gt;M: 2. å¯¹æ•°æ®è¿›è¡Œçº åˆ ç ç¼–ç (K+Måˆ†ç‰‡)    M-&gt;&gt;DSet: 3. å¹¶è¡Œå°†K+Måˆ†ç‰‡å†™å…¥å¯¹åº”é©±åŠ¨å™¨    DSet--&gt;&gt;M: ç¡®è®¤å†™å…¥å®Œæˆ    M--&gt;&gt;C: 4. è¿”å›æˆåŠŸå“åº” (200 OK)  </pre></div><h3 id="3-2-æ•°æ®è¯»å–æµç¨‹"><a href="#3-2-æ•°æ®è¯»å–æµç¨‹" class="headerlink" title="3.2 æ•°æ®è¯»å–æµç¨‹"></a>3.2 æ•°æ®è¯»å–æµç¨‹</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  sequenceDiagram    participant C as å®¢æˆ·ç«¯    participant LB as è´Ÿè½½å‡è¡¡å™¨    participant M as ä»»ä¸€MinIOèŠ‚ç‚¹    participant DSet as é©±åŠ¨å™¨çº åˆ ç é›†åˆ        C-&gt;&gt;LB: GETå¯¹è±¡è¯·æ±‚    LB-&gt;&gt;M: è·¯ç”±åˆ°ä»»ä¸€å¯ç”¨èŠ‚ç‚¹    M-&gt;&gt;M: 1. æ ¹æ®å¯¹è±¡åè®¡ç®—å“ˆå¸Œ, ç¡®å®šé©±åŠ¨å™¨é›†åˆ    M-&gt;&gt;DSet: 2. å¹¶è¡Œå‘æ‰€æœ‰K+Mä¸ªé©±åŠ¨å™¨è¯·æ±‚åˆ†ç‰‡    DSet--&gt;&gt;M: 3. æœ€å…ˆè¿”å›çš„Kä¸ªåˆ†ç‰‡åˆ°è¾¾    M-&gt;&gt;M: 4. åœ¨å†…å­˜ä¸­é‡æ„åŸå§‹æ•°æ®    M--&gt;&gt;C: 5. å°†æ•°æ®æµå¼ä¼ è¾“ç»™å®¢æˆ·ç«¯  </pre></div><h3 id="3-3-æ•…éšœæ¢å¤æµç¨‹"><a href="#3-3-æ•…éšœæ¢å¤æµç¨‹" class="headerlink" title="3.3 æ•…éšœæ¢å¤æµç¨‹"></a>3.3 æ•…éšœæ¢å¤æµç¨‹</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    A[æ£€æµ‹åˆ°é©±åŠ¨å™¨æ•…éšœ] --&gt; B{&quot;æ£€æŸ¥å†—ä½™æ˜¯å¦å……è¶³&quot;}    B -- &quot;æ˜¯ (å‰©ä½™é©±åŠ¨å™¨ &gt;&#x3D; K)&quot; --&gt; C[&quot;é›†ç¾¤è¿›å…¥é™çº§æ¨¡å¼, æœåŠ¡ä¸ä¸­æ–­&quot;]    B -- &quot;å¦ (å‰©ä½™é©±åŠ¨å™¨ &lt; K)&quot; --&gt; D[&quot;éƒ¨åˆ†æ•°æ®ä¸å¯ç”¨, å‘Šè­¦ç®¡ç†å‘˜&quot;]        C --&gt; E[&quot;åå°è‡ªæ„ˆ(Healing)è¿›ç¨‹å¯åŠ¨&quot;]    E --&gt; F[æ‰«æå—å½±å“çš„å¯¹è±¡]    F --&gt; G[&quot;å¯¹æ¯ä¸ªå¯¹è±¡, è¯»å–Kä¸ªå¯ç”¨åˆ†ç‰‡&quot;]    G --&gt; H[é‡æ„ä¸¢å¤±çš„åˆ†ç‰‡]    H --&gt; I[&quot;å°†æ–°åˆ†ç‰‡å†™å…¥å¥åº·çš„å¤‡ç”¨é©±åŠ¨å™¨&quot;]    I --&gt; J[&quot;æ›´æ–°å¯¹è±¡çš„å…ƒæ•°æ®(xl.json)&quot;]    J --&gt; K[&quot;æ‰€æœ‰æ•°æ®æ¢å¤å, é›†ç¾¤æ¢å¤æ­£å¸¸æ¨¡å¼&quot;]  </pre></div><h2 id="4-MinIO-ä¸å…¶ä»–å­˜å‚¨ç³»ç»Ÿå¯¹æ¯”"><a href="#4-MinIO-ä¸å…¶ä»–å­˜å‚¨ç³»ç»Ÿå¯¹æ¯”" class="headerlink" title="4. MinIO ä¸å…¶ä»–å­˜å‚¨ç³»ç»Ÿå¯¹æ¯”"></a>4. MinIO ä¸å…¶ä»–å­˜å‚¨ç³»ç»Ÿå¯¹æ¯”</h2><h3 id="4-1-å¯¹è±¡å­˜å‚¨-vs-æ–‡ä»¶å­˜å‚¨-vs-å—å­˜å‚¨"><a href="#4-1-å¯¹è±¡å­˜å‚¨-vs-æ–‡ä»¶å­˜å‚¨-vs-å—å­˜å‚¨" class="headerlink" title="4.1 å¯¹è±¡å­˜å‚¨ vs æ–‡ä»¶å­˜å‚¨ vs å—å­˜å‚¨"></a>4.1 å¯¹è±¡å­˜å‚¨ vs æ–‡ä»¶å­˜å‚¨ vs å—å­˜å‚¨</h3><h4 id="å­˜å‚¨ç±»å‹æ¶æ„å¯¹æ¯”"><a href="#å­˜å‚¨ç±»å‹æ¶æ„å¯¹æ¯”" class="headerlink" title="å­˜å‚¨ç±»å‹æ¶æ„å¯¹æ¯”"></a>å­˜å‚¨ç±»å‹æ¶æ„å¯¹æ¯”</h4><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TB    subgraph &quot;å¯¹è±¡å­˜å‚¨ (MinIO)&quot;        OBJ1[åº”ç”¨ç¨‹åº] --&gt; OBJ2[&quot;REST API (HTTP)&quot;]        OBJ2 --&gt; OBJ3[å¯¹è±¡å­˜å‚¨å¼•æ“]        OBJ3 --&gt; OBJ4[&quot;æ‰å¹³åŒ–å‘½åç©ºé—´ + å…ƒæ•°æ®&quot;]        OBJ4 --&gt; OBJ5[åˆ†å¸ƒå¼å­˜å‚¨æ± ]    end        subgraph &quot;æ–‡ä»¶å­˜å‚¨ (NFS&#x2F;HDFS)&quot;        FILE1[åº”ç”¨ç¨‹åº] --&gt; FILE2[&quot;æ–‡ä»¶ç³»ç»Ÿæ¥å£ (POSIX)&quot;]        FILE2 --&gt; FILE3[å±‚çº§ç›®å½•æ ‘ç»“æ„]        FILE3 --&gt; FILE4[å…ƒæ•°æ®æœåŠ¡å™¨]        FILE4 --&gt; FILE5[æ•°æ®èŠ‚ç‚¹]    end        subgraph &quot;å—å­˜å‚¨ (SAN)&quot;        BLOCK1[æ“ä½œç³»ç»Ÿ] --&gt; BLOCK2[&quot;æ–‡ä»¶ç³»ç»Ÿ (ext4&#x2F;xfs)&quot;]        BLOCK2 --&gt; BLOCK3[&quot;å—è®¾å¤‡æ¥å£ (SCSI&#x2F;iSCSI)&quot;]        BLOCK3 --&gt; BLOCK4[å­˜å‚¨æ§åˆ¶å™¨]        BLOCK4 --&gt; BLOCK5[&quot;ç‰©ç†ç£ç›˜é˜µåˆ— (RAID)&quot;]    end  </pre></div><h3 id="4-2-MinIO-vs-HDFS-è¯¦ç»†å¯¹æ¯”"><a href="#4-2-MinIO-vs-HDFS-è¯¦ç»†å¯¹æ¯”" class="headerlink" title="4.2 MinIO vs HDFS è¯¦ç»†å¯¹æ¯”"></a>4.2 MinIO vs HDFS è¯¦ç»†å¯¹æ¯”</h3><h4 id="4-2-1-æ¶æ„å·®å¼‚"><a href="#4-2-1-æ¶æ„å·®å¼‚" class="headerlink" title="4.2.1 æ¶æ„å·®å¼‚"></a>4.2.1 æ¶æ„å·®å¼‚</h4><table><thead><tr><th>å¯¹æ¯”ç»´åº¦</th><th>MinIO</th><th>HDFS</th></tr></thead><tbody><tr><td><strong>æ¶æ„æ¨¡å¼</strong></td><td>æ— ä¸»æ¶æ„ï¼Œæ‰€æœ‰èŠ‚ç‚¹å¯¹ç­‰</td><td>ä¸»ä»æ¶æ„ï¼ŒNameNode + DataNode</td></tr><tr><td><strong>å•ç‚¹æ•…éšœ</strong></td><td>æ— å•ç‚¹æ•…éšœ</td><td>NameNode æ˜¯æ½œåœ¨å•ç‚¹æ•…éšœ (éœ€HAæ–¹æ¡ˆ)</td></tr><tr><td><strong>æ•°æ®ä¿æŠ¤</strong></td><td>Reed-Solomonçº åˆ ç </td><td>å¤šå‰¯æœ¬æœºåˆ¶ï¼ˆé€šå¸¸3å‰¯æœ¬ï¼‰</td></tr><tr><td><strong>å­˜å‚¨æ•ˆç‡</strong></td><td>é«˜ (å¦‚EC:4ä¸º75%)</td><td>ä½ (3å‰¯æœ¬ä¸º33.3%)</td></tr><tr><td><strong>è®¿é—®æ¥å£</strong></td><td>S3 API (HTTP)</td><td>HDFS API, WebHDFS</td></tr><tr><td><strong>å°æ–‡ä»¶å¤„ç†</strong></td><td>è¾ƒä¼˜</td><td>NameNodeå‹åŠ›å¤§ï¼Œæ€§èƒ½è¾ƒå·®</td></tr></tbody></table><h4 id="4-2-2-æŠ€æœ¯å®ç°å¯¹æ¯”"><a href="#4-2-2-æŠ€æœ¯å®ç°å¯¹æ¯”" class="headerlink" title="4.2.2 æŠ€æœ¯å®ç°å¯¹æ¯”"></a>4.2.2 æŠ€æœ¯å®ç°å¯¹æ¯”</h4><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TB    subgraph &quot;MinIO æ¶æ„&quot;        M1[å®¢æˆ·ç«¯] --&gt; M2[&quot;ä»»æ„èŠ‚ç‚¹ (æ— ä¸»)&quot;]        M2 --&gt; M3[ç¡®å®šæ€§å“ˆå¸Œè®¡ç®—]        M3 --&gt; M4[çº åˆ ç åˆ†ç‰‡]        M4 --&gt; M5[çº åˆ ç é›†åˆå­˜å‚¨]    end        subgraph &quot;HDFS æ¶æ„&quot;        H1[å®¢æˆ·ç«¯] --&gt; H2[&quot;NameNode (ä¸»èŠ‚ç‚¹)&quot;]        H2 --&gt; H3[&quot;å…ƒæ•°æ®æŸ¥è¯¢&#x2F;ç®¡ç†&quot;]        H1 --&gt; H4[&quot;DataNode (ä»èŠ‚ç‚¹)&quot;]        H2 --&gt; H4[æŒ‡ä»¤ä¸‹å‘]        H4 --&gt; H5[3å‰¯æœ¬å­˜å‚¨]    end  </pre></div><h4 id="4-2-3-æ€§èƒ½ä¸å¯é æ€§å¯¹æ¯”"><a href="#4-2-3-æ€§èƒ½ä¸å¯é æ€§å¯¹æ¯”" class="headerlink" title="4.2.3 æ€§èƒ½ä¸å¯é æ€§å¯¹æ¯”"></a>4.2.3 æ€§èƒ½ä¸å¯é æ€§å¯¹æ¯”</h4><h5 id="è¯»å†™æ€§èƒ½"><a href="#è¯»å†™æ€§èƒ½" class="headerlink" title="è¯»å†™æ€§èƒ½"></a>è¯»å†™æ€§èƒ½</h5><ul><li><strong>MinIO</strong>ï¼š<ul><li>æ“…é•¿å¤„ç†æ··åˆè´Ÿè½½ï¼Œå¯¹å¤§æ–‡ä»¶å’Œå°æ–‡ä»¶éƒ½æœ‰è‰¯å¥½çš„æ€§èƒ½è¡¨ç°ã€‚</li><li>é€šè¿‡æ™ºèƒ½å¹¶è¡Œè¯»å†™ï¼Œååé‡å¯è¾¾çº åˆ ç èŠ‚ç‚¹ç»„çš„æ€»å¸¦å®½ã€‚</li></ul></li><li><strong>HDFS</strong>ï¼š<ul><li>ä¸ºå¤§æ–‡ä»¶é¡ºåºè¯»å†™ä¼˜åŒ–ï¼Œæµå¼å¤„ç†èƒ½åŠ›å¼ºã€‚</li><li>å°æ–‡ä»¶åœºæ™¯ä¸‹ï¼ŒNameNodeæˆä¸ºç“¶é¢ˆï¼Œæ€§èƒ½ä¸‹é™ä¸¥é‡ã€‚</li></ul></li></ul><h5 id="æ•…éšœæ¢å¤"><a href="#æ•…éšœæ¢å¤" class="headerlink" title="æ•…éšœæ¢å¤"></a>æ•…éšœæ¢å¤</h5><ul><li><strong>MinIO</strong>ï¼š<ul><li>è‡ªåŠ¨æ£€æµ‹ã€è‡ªåŠ¨ä¿®å¤ï¼ˆè‡ªæ„ˆï¼‰ã€‚</li><li>å¯å®¹å¿çš„æ•…éšœæ•°å–å†³äºçº åˆ ç é…ç½®ï¼Œæ›´çµæ´»ã€‚</li><li>æ¢å¤è¿‡ç¨‹å¯¹ä¸šåŠ¡é€æ˜ã€‚</li></ul></li><li><strong>HDFS</strong>ï¼š<ul><li>ä¾èµ–NameNodeåè°ƒå—çš„å¤åˆ¶ã€‚</li><li>NameNodeæ•…éšœéœ€è¦å¤æ‚çš„HAåˆ‡æ¢ï¼ˆå¦‚JournalNode+ZKFCï¼‰ã€‚</li><li>æ¢å¤è¿‡ç¨‹ç®¡ç†ç›¸å¯¹å¤æ‚ã€‚</li></ul></li></ul><h4 id="4-2-4-ä½¿ç”¨åœºæ™¯å¯¹æ¯”"><a href="#4-2-4-ä½¿ç”¨åœºæ™¯å¯¹æ¯”" class="headerlink" title="4.2.4 ä½¿ç”¨åœºæ™¯å¯¹æ¯”"></a>4.2.4 ä½¿ç”¨åœºæ™¯å¯¹æ¯”</h4><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph LR    subgraph &quot;MinIO é€‚ç”¨åœºæ™¯&quot;        MINIO1[äº‘åŸç”Ÿåº”ç”¨å­˜å‚¨]        MINIO2[CDNåŠé™æ€èµ„æº]        MINIO3[å¤‡ä»½å½’æ¡£]        MINIO4[AI&#x2F;MLæ•°æ®æ¹–]        MINIO5[å®¹å™¨é•œåƒä»“åº“]    end        subgraph &quot;HDFS é€‚ç”¨åœºæ™¯&quot;        HDFS1[&quot;æµ·é‡æ•°æ®æ‰¹å¤„ç† (MapReduce&#x2F;Spark)&quot;]        HDFS2[æ•°æ®ä»“åº“]        HDFS3[æ—¥å¿—å­˜å‚¨ä¸åˆ†æ]        HDFS4[ä¼ ç»Ÿå¤§æ•°æ®ç”Ÿæ€]    end  </pre></div><h3 id="4-3-MinIO-vs-å…¶ä»–å¯¹è±¡å­˜å‚¨"><a href="#4-3-MinIO-vs-å…¶ä»–å¯¹è±¡å­˜å‚¨" class="headerlink" title="4.3 MinIO vs å…¶ä»–å¯¹è±¡å­˜å‚¨"></a>4.3 MinIO vs å…¶ä»–å¯¹è±¡å­˜å‚¨</h3><h4 id="4-3-1-MinIO-vs-AWS-S3"><a href="#4-3-1-MinIO-vs-AWS-S3" class="headerlink" title="4.3.1 MinIO vs AWS S3"></a>4.3.1 MinIO vs AWS S3</h4><table><thead><tr><th>ç‰¹æ€§</th><th>MinIO</th><th>AWS S3</th></tr></thead><tbody><tr><td><strong>éƒ¨ç½²æ–¹å¼</strong></td><td>ç§æœ‰äº‘&#x2F;æ··åˆäº‘&#x2F;è¾¹ç¼˜</td><td>å…¬æœ‰äº‘æœåŠ¡</td></tr><tr><td><strong>APIå…¼å®¹æ€§</strong></td><td>100% S3å…¼å®¹</td><td>åŸç”ŸS3 APIæ ‡å‡†</td></tr><tr><td><strong>æˆæœ¬</strong></td><td>ç¡¬ä»¶+è¿ç»´æˆæœ¬ï¼Œå¯æ§</td><td>æŒ‰ä½¿ç”¨é‡ä»˜è´¹ï¼Œæ˜“è¶…æ”¯</td></tr><tr><td><strong>æ•°æ®ä¸»æƒ</strong></td><td>å®Œå…¨è‡ªä¸»æ§åˆ¶</td><td>ä¾èµ–äº‘æœåŠ¡å•†æ”¿ç­–</td></tr><tr><td><strong>æ€§èƒ½</strong></td><td>å–å†³äºç¡¬ä»¶ï¼Œå¯æè‡´ä¼˜åŒ–</td><td>æœåŠ¡ç­‰çº§é™åˆ¶ï¼Œæœ‰ååé‡ä¸Šé™</td></tr><tr><td><strong>å®šåˆ¶åŒ–</strong></td><td>é«˜åº¦å¯å®šåˆ¶</td><td>é»‘ç›’ï¼Œä¸å¯å®šåˆ¶</td></tr></tbody></table><h4 id="4-3-2-MinIO-vs-Ceph"><a href="#4-3-2-MinIO-vs-Ceph" class="headerlink" title="4.3.2 MinIO vs Ceph"></a>4.3.2 MinIO vs Ceph</h4><table><thead><tr><th>å¯¹æ¯”é¡¹</th><th>MinIO</th><th>Ceph</th></tr></thead><tbody><tr><td><strong>è®¾è®¡å“²å­¦</strong></td><td>ç®€æ´ã€é«˜æ€§èƒ½</td><td>ç»Ÿä¸€ã€åŠŸèƒ½å…¨é¢</td></tr><tr><td><strong>å­˜å‚¨ç±»å‹</strong></td><td>çº¯å¯¹è±¡å­˜å‚¨</td><td>ç»Ÿä¸€å­˜å‚¨ï¼ˆå¯¹è±¡+å—+æ–‡ä»¶ï¼‰</td></tr><tr><td><strong>å¤æ‚åº¦</strong></td><td>éå¸¸ç®€å•ï¼Œæ˜“äºéƒ¨ç½²å’Œè¿ç»´</td><td>éå¸¸å¤æ‚ï¼Œå­¦ä¹ æ›²çº¿é™¡å³­</td></tr><tr><td><strong>æ€§èƒ½</strong></td><td>å¯¹è±¡å­˜å‚¨åœºæ™¯ä¸‹æ€§èƒ½æè‡´</td><td>é€šç”¨æ€§å¼ºï¼Œä½†ä¸ºå¯¹è±¡å­˜å‚¨çš„è°ƒä¼˜å¤æ‚</td></tr><tr><td><strong>èµ„æºå ç”¨</strong></td><td>è½»é‡çº§</td><td>é‡é‡çº§</td></tr><tr><td><strong>é€‚ç”¨åœºæ™¯</strong></td><td>éœ€è¦é«˜æ€§èƒ½ã€æ˜“äºç®¡ç†çš„å¯¹è±¡å­˜å‚¨</td><td>éœ€è¦ç»Ÿä¸€å­˜å‚¨å¹³å°ï¼Œæœ‰å¼ºå¤§è¿ç»´å›¢é˜Ÿ</td></tr></tbody></table><h3 id="4-4-é€‰å‹å†³ç­–æ¡†æ¶"><a href="#4-4-é€‰å‹å†³ç­–æ¡†æ¶" class="headerlink" title="4.4 é€‰å‹å†³ç­–æ¡†æ¶"></a>4.4 é€‰å‹å†³ç­–æ¡†æ¶</h3><h4 id="4-4-1-æŠ€æœ¯é€‰å‹çŸ©é˜µ"><a href="#4-4-1-æŠ€æœ¯é€‰å‹çŸ©é˜µ" class="headerlink" title="4.4.1 æŠ€æœ¯é€‰å‹çŸ©é˜µ"></a>4.4.1 æŠ€æœ¯é€‰å‹çŸ©é˜µ</h4><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    A[å­˜å‚¨éœ€æ±‚åˆ†æ] --&gt; B{&quot;ä¸»è¦æ•°æ®è®¿é—®æ¨¡å¼?&quot;}    B -- &quot;HTTP&#x2F;S3 API&quot; --&gt; C[é€‰æ‹©å¯¹è±¡å­˜å‚¨]    B -- &quot;æ–‡ä»¶&#x2F;POSIX API&quot; --&gt; D[é€‰æ‹©æ–‡ä»¶å­˜å‚¨]    B -- &quot;iSCSI&#x2F;å—è®¾å¤‡&quot; --&gt; E[é€‰æ‹©å—å­˜å‚¨]        C --&gt; F{&quot;éƒ¨ç½²ç¯å¢ƒ?&quot;}    F -- &quot;ç§æœ‰äº‘&#x2F;æ··åˆäº‘&quot; --&gt; G{&quot;è¿ç»´å¤æ‚åº¦è¦æ±‚?&quot;}    F -- &quot;å…¬æœ‰äº‘&quot; --&gt; H[&quot;AWS S3&#x2F;é˜¿é‡Œäº‘OSSç­‰&quot;]        G -- &quot;è¿½æ±‚ç®€æ´ã€é«˜æ€§èƒ½&quot; --&gt; I[MinIO]    G -- &quot;éœ€è¦ç»Ÿä¸€å­˜å‚¨å¹³å°&quot; --&gt; J[Ceph]        D --&gt; K{&quot;ä¸»è¦åº”ç”¨åœºæ™¯?&quot;}    K -- &quot;å¤§æ•°æ®åˆ†æ&quot; --&gt; L[HDFS]    K -- &quot;é€šç”¨æ–‡ä»¶å…±äº«&quot; --&gt; M[&quot;NFS&#x2F;GlusterFS&quot;]        E --&gt; N[&quot;SAN&#x2F;iSCSI&#x2F;Ceph RBD&quot;]  </pre></div><h4 id="4-4-2-å†³ç­–è¦ç´ æƒé‡"><a href="#4-4-2-å†³ç­–è¦ç´ æƒé‡" class="headerlink" title="4.4.2 å†³ç­–è¦ç´ æƒé‡"></a>4.4.2 å†³ç­–è¦ç´ æƒé‡</h4><table><thead><tr><th>è¦ç´ </th><th align="center">MinIO</th><th align="center">HDFS</th><th align="center">Ceph</th></tr></thead><tbody><tr><td><strong>æ˜“ç”¨æ€§</strong></td><td align="center">â­â­â­â­â­</td><td align="center">â­â­â­</td><td align="center">â­â­</td></tr><tr><td><strong>å¯¹è±¡å­˜å‚¨æ€§èƒ½</strong></td><td align="center">â­â­â­â­â­</td><td align="center">â­â­</td><td align="center">â­â­â­â­</td></tr><tr><td><strong>å¯é æ€§</strong></td><td align="center">â­â­â­â­â­</td><td align="center">â­â­â­â­</td><td align="center">â­â­â­â­</td></tr><tr><td><strong>æ‰©å±•æ€§</strong></td><td align="center">â­â­â­â­â­</td><td align="center">â­â­â­â­</td><td align="center">â­â­â­â­â­</td></tr><tr><td><strong>è¿ç»´æˆæœ¬</strong></td><td align="center">â­â­â­â­â­</td><td align="center">â­â­â­</td><td align="center">â­â­</td></tr><tr><td><strong>åŠŸèƒ½å…¨é¢æ€§</strong></td><td align="center">â­â­â­</td><td align="center">â­â­â­</td><td align="center">â­â­â­â­â­</td></tr></tbody></table><h3 id="4-5-å®é™…åº”ç”¨æ¡ˆä¾‹åˆ†æ"><a href="#4-5-å®é™…åº”ç”¨æ¡ˆä¾‹åˆ†æ" class="headerlink" title="4.5 å®é™…åº”ç”¨æ¡ˆä¾‹åˆ†æ"></a>4.5 å®é™…åº”ç”¨æ¡ˆä¾‹åˆ†æ</h3><h4 id="4-5-1-ç”µå•†å¹³å°å­˜å‚¨æ¶æ„"><a href="#4-5-1-ç”µå•†å¹³å°å­˜å‚¨æ¶æ„" class="headerlink" title="4.5.1 ç”µå•†å¹³å°å­˜å‚¨æ¶æ„"></a>4.5.1 ç”µå•†å¹³å°å­˜å‚¨æ¶æ„</h4><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TB    subgraph &quot;ç”µå•†å¹³å°å­˜å‚¨å±‚æ¬¡&quot;        APP[ç”µå•†åº”ç”¨] --&gt; CDN[CDNç¼“å­˜å±‚]        CDN --&gt; HOT[&quot;çƒ­æ•°æ®å±‚(å•†å“å›¾ç‰‡&#x2F;è§†é¢‘) - MinIO&quot;]        HOT --&gt; WARM[&quot;æ¸©æ•°æ®å±‚(å†å²è®¢å•å¿«ç…§) - MinIO&quot;]        WARM --&gt; COLD[&quot;å†·æ•°æ®å±‚(å½’æ¡£æ—¥å¿—) - ç£å¸¦&#x2F;äº‘å½’æ¡£å­˜å‚¨&quot;]                DB[æ•°æ®åº“] --&gt; BACKUP[&quot;æ•°æ®åº“å¤‡ä»½ - MinIO&quot;]        LOG[ä¸šåŠ¡æ—¥å¿—ç³»ç»Ÿ] --&gt; LOG_ANALYZE[&quot;æ—¥å¿—åˆ†æå¹³å° - HDFS&#x2F;ClickHouse&quot;]    end  </pre></div><h4 id="4-5-2-AI-MLå¹³å°å­˜å‚¨è®¾è®¡"><a href="#4-5-2-AI-MLå¹³å°å­˜å‚¨è®¾è®¡" class="headerlink" title="4.5.2 AI&#x2F;MLå¹³å°å­˜å‚¨è®¾è®¡"></a>4.5.2 AI&#x2F;MLå¹³å°å­˜å‚¨è®¾è®¡</h4><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph LR    subgraph &quot;AI&#x2F;MLæ•°æ®æµ&quot;        RAW[åŸå§‹æ•°æ®é‡‡é›†] --&gt; MINIO1[&quot;MinIO - æ•°æ®æ¹–(ç»Ÿä¸€å­˜å‚¨)&quot;]        MINIO1 --&gt;|æ•°æ®é¢„å¤„ç†| SPARK[&quot;Spark&#x2F;Dask&quot;]        SPARK --&gt; TRAIN_SET[&quot;è®­ç»ƒ&#x2F;éªŒè¯æ•°æ®é›†&quot;]        TRAIN_SET --&gt; MINIO1                MINIO1 --&gt;|è¯»å–è®­ç»ƒæ•°æ®| TRAIN[&quot;æ¨¡å‹è®­ç»ƒé›†ç¾¤ (GPU)&quot;]        TRAIN --&gt; MINIO2[&quot;MinIO - æ¨¡å‹ä»“åº“&quot;]        MINIO2 --&gt; DEPLOY[&quot;æ¨¡å‹éƒ¨ç½²&#x2F;æ¨ç†æœåŠ¡&quot;]    end  </pre></div><h2 id="5-MinIO-å‘½ä»¤ä½¿ç”¨æŒ‡å—"><a href="#5-MinIO-å‘½ä»¤ä½¿ç”¨æŒ‡å—" class="headerlink" title="5. MinIO å‘½ä»¤ä½¿ç”¨æŒ‡å—"></a>5. MinIO å‘½ä»¤ä½¿ç”¨æŒ‡å—</h2><h3 id="5-1-å®‰è£…å’Œéƒ¨ç½²"><a href="#5-1-å®‰è£…å’Œéƒ¨ç½²" class="headerlink" title="5.1 å®‰è£…å’Œéƒ¨ç½²"></a>5.1 å®‰è£…å’Œéƒ¨ç½²</h3><h4 id="å•æœºéƒ¨ç½²"><a href="#å•æœºéƒ¨ç½²" class="headerlink" title="å•æœºéƒ¨ç½²"></a>å•æœºéƒ¨ç½²</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½ MinIO æœåŠ¡å™¨</span></span><br><span class="line">wget https://dl.min.io/server/minio/release/linux-amd64/minio</span><br><span class="line"><span class="built_in">chmod</span> +x minio</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨ MinIO æœåŠ¡å™¨</span></span><br><span class="line"><span class="comment"># MINIO_ROOT_USER å’Œ MINIO_ROOT_PASSWORD æ˜¯å¯åŠ¨æ‰€å¿…éœ€çš„ç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="built_in">export</span> MINIO_ROOT_USER=minioadmin</span><br><span class="line"><span class="built_in">export</span> MINIO_ROOT_PASSWORD=minioadmin</span><br><span class="line">./minio server /data --console-address <span class="string">&quot;:9001&quot;</span></span><br></pre></td></tr></table></figure><h4 id="é›†ç¾¤éƒ¨ç½²-ç¤ºä¾‹"><a href="#é›†ç¾¤éƒ¨ç½²-ç¤ºä¾‹" class="headerlink" title="é›†ç¾¤éƒ¨ç½² (ç¤ºä¾‹)"></a>é›†ç¾¤éƒ¨ç½² (ç¤ºä¾‹)</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨4ä¸ªèŠ‚ç‚¹ä¸Šåˆ†åˆ«è®¾ç½®ç¯å¢ƒå˜é‡å’Œå¯åŠ¨å‘½ä»¤</span></span><br><span class="line"><span class="comment"># å‡è®¾èŠ‚ç‚¹IPä¸º 192.168.1.101 åˆ° 192.168.1.104</span></span><br><span class="line"><span class="comment"># åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šæ‰§è¡Œ:</span></span><br><span class="line"><span class="built_in">export</span> MINIO_ROOT_USER=myminioadmin</span><br><span class="line"><span class="built_in">export</span> MINIO_ROOT_PASSWORD=minioadmin_secret</span><br><span class="line">minio server http://192.168.1.10&#123;1...4&#125;/data&#123;1...4&#125; --console-address <span class="string">&quot;:9001&quot;</span></span><br></pre></td></tr></table></figure><h3 id="5-2-MinIO-Client-mc-å‘½ä»¤"><a href="#5-2-MinIO-Client-mc-å‘½ä»¤" class="headerlink" title="5.2 MinIO Client (mc) å‘½ä»¤"></a>5.2 MinIO Client (mc) å‘½ä»¤</h3><h4 id="åŸºæœ¬é…ç½®"><a href="#åŸºæœ¬é…ç½®" class="headerlink" title="åŸºæœ¬é…ç½®"></a>åŸºæœ¬é…ç½®</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… mc å®¢æˆ·ç«¯</span></span><br><span class="line">wget https://dl.min.io/client/mc/release/linux-amd64/mc</span><br><span class="line"><span class="built_in">chmod</span> +x mc</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mv</span> mc /usr/local/bin/</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ  MinIO æœåŠ¡å™¨åˆ«å</span></span><br><span class="line">mc <span class="built_in">alias</span> <span class="built_in">set</span> myminio http://localhost:9000 minioadmin minioadmin</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ—å‡ºæ‰€æœ‰åˆ«å</span></span><br><span class="line">mc <span class="built_in">alias</span> list</span><br></pre></td></tr></table></figure><h4 id="Bucket-æ“ä½œ"><a href="#Bucket-æ“ä½œ" class="headerlink" title="Bucket æ“ä½œ"></a>Bucket æ“ä½œ</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»º bucket</span></span><br><span class="line">mc mb myminio/mybucket</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ—å‡ºæ‰€æœ‰ buckets</span></span><br><span class="line">mc <span class="built_in">ls</span> myminio</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤ bucketï¼ˆå¿…é¡»ä¸ºç©ºï¼‰</span></span><br><span class="line">mc rb myminio/mybucket</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼ºåˆ¶åˆ é™¤éç©º bucket</span></span><br><span class="line">mc rb myminio/mybucket --force</span><br></pre></td></tr></table></figure><h4 id="å¯¹è±¡æ“ä½œ"><a href="#å¯¹è±¡æ“ä½œ" class="headerlink" title="å¯¹è±¡æ“ä½œ"></a>å¯¹è±¡æ“ä½œ</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸Šä¼ æ–‡ä»¶</span></span><br><span class="line">mc <span class="built_in">cp</span> localfile.txt myminio/mybucket/</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸Šä¼ ç›®å½•</span></span><br><span class="line">mc <span class="built_in">cp</span> --recursive localdir/ myminio/mybucket/</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½æ–‡ä»¶</span></span><br><span class="line">mc <span class="built_in">cp</span> myminio/mybucket/file.txt .</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½ç›®å½•</span></span><br><span class="line">mc <span class="built_in">cp</span> --recursive myminio/mybucket/dir/ .</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ—å‡ºå¯¹è±¡</span></span><br><span class="line">mc <span class="built_in">ls</span> myminio/mybucket</span><br><span class="line"></span><br><span class="line"><span class="comment"># é€’å½’åˆ—å‡ºæ‰€æœ‰å¯¹è±¡</span></span><br><span class="line">mc <span class="built_in">ls</span> --recursive myminio/mybucket</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤å¯¹è±¡</span></span><br><span class="line">mc <span class="built_in">rm</span> myminio/mybucket/file.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰¹é‡åˆ é™¤</span></span><br><span class="line">mc <span class="built_in">rm</span> --recursive --force myminio/mybucket/dir/</span><br></pre></td></tr></table></figure><h4 id="åŒæ­¥æ“ä½œ"><a href="#åŒæ­¥æ“ä½œ" class="headerlink" title="åŒæ­¥æ“ä½œ"></a>åŒæ­¥æ“ä½œ</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°†æœ¬åœ°ç›®å½•çš„æ›´æ”¹åŒæ­¥åˆ° MinIO</span></span><br><span class="line">mc mirror localdir/ myminio/mybucket/</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°† MinIO ç›®å½•çš„æ›´æ”¹åŒæ­¥åˆ°æœ¬åœ°</span></span><br><span class="line">mc mirror myminio/mybucket/ localdir/</span><br></pre></td></tr></table></figure><h3 id="5-3-æƒé™å’Œç­–ç•¥ç®¡ç†"><a href="#5-3-æƒé™å’Œç­–ç•¥ç®¡ç†" class="headerlink" title="5.3 æƒé™å’Œç­–ç•¥ç®¡ç†"></a>5.3 æƒé™å’Œç­–ç•¥ç®¡ç†</h3><h4 id="ç”¨æˆ·ç®¡ç†"><a href="#ç”¨æˆ·ç®¡ç†" class="headerlink" title="ç”¨æˆ·ç®¡ç†"></a>ç”¨æˆ·ç®¡ç†</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºç”¨æˆ·</span></span><br><span class="line">mc admin user add myminio newuser password123</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ—å‡ºç”¨æˆ·</span></span><br><span class="line">mc admin user list myminio</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¦ç”¨ç”¨æˆ·</span></span><br><span class="line">mc admin user <span class="built_in">disable</span> myminio newuser</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯ç”¨ç”¨æˆ·</span></span><br><span class="line">mc admin user <span class="built_in">enable</span> myminio newuser</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤ç”¨æˆ·</span></span><br><span class="line">mc admin user remove myminio newuser</span><br></pre></td></tr></table></figure><h4 id="ç­–ç•¥ç®¡ç†"><a href="#ç­–ç•¥ç®¡ç†" class="headerlink" title="ç­–ç•¥ç®¡ç†"></a>ç­–ç•¥ç®¡ç†</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ—å‡ºå†…ç½®ç­–ç•¥</span></span><br><span class="line">mc admin policy list myminio</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºè‡ªå®šä¹‰ç­–ç•¥æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">cat</span> &gt; readonly-policy.json &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;Version&quot;: &quot;2012-10-17&quot;,</span></span><br><span class="line"><span class="string">  &quot;Statement&quot;: [</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;Effect&quot;: &quot;Allow&quot;,</span></span><br><span class="line"><span class="string">      &quot;Action&quot;: [&quot;s3:GetObject&quot;],</span></span><br><span class="line"><span class="string">      &quot;Resource&quot;: [&quot;arn:aws:s3:::mybucket/*&quot;]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ ç­–ç•¥</span></span><br><span class="line">mc admin policy add myminio readonly-policy readonly-policy.json</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†ç­–ç•¥åˆ†é…ç»™ç”¨æˆ·</span></span><br><span class="line">mc admin policy <span class="built_in">set</span> myminio readonly-policy user=newuser</span><br></pre></td></tr></table></figure><h4 id="ç»„ç®¡ç†"><a href="#ç»„ç®¡ç†" class="headerlink" title="ç»„ç®¡ç†"></a>ç»„ç®¡ç†</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºç»„</span></span><br><span class="line">mc admin group add myminio mygroup newuser</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ—å‡ºç»„</span></span><br><span class="line">mc admin group list myminio</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†ç­–ç•¥åˆ†é…ç»™ç»„</span></span><br><span class="line">mc admin policy <span class="built_in">set</span> myminio readwrite group=mygroup</span><br></pre></td></tr></table></figure><h3 id="5-4-ç›‘æ§å’Œç®¡ç†"><a href="#5-4-ç›‘æ§å’Œç®¡ç†" class="headerlink" title="5.4 ç›‘æ§å’Œç®¡ç†"></a>5.4 ç›‘æ§å’Œç®¡ç†</h3><h4 id="æœåŠ¡å™¨ä¿¡æ¯"><a href="#æœåŠ¡å™¨ä¿¡æ¯" class="headerlink" title="æœåŠ¡å™¨ä¿¡æ¯"></a>æœåŠ¡å™¨ä¿¡æ¯</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹æœåŠ¡å™¨ä¿¡æ¯ (åŒ…å«å­˜å‚¨ã€ç‰ˆæœ¬ã€è¿è¡Œæ—¶é—´ç­‰)</span></span><br><span class="line">mc admin info myminio</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯æœåŠ¡</span></span><br><span class="line">mc admin service restart myminio</span><br></pre></td></tr></table></figure><h4 id="æ€§èƒ½æµ‹è¯•"><a href="#æ€§èƒ½æµ‹è¯•" class="headerlink" title="æ€§èƒ½æµ‹è¯•"></a>æ€§èƒ½æµ‹è¯•</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿è¡Œ S3 åŸºå‡†æ€§èƒ½æµ‹è¯•</span></span><br><span class="line">mc admin speedtest myminio</span><br></pre></td></tr></table></figure><h4 id="æ—¥å¿—ç®¡ç†"><a href="#æ—¥å¿—ç®¡ç†" class="headerlink" title="æ—¥å¿—ç®¡ç†"></a>æ—¥å¿—ç®¡ç†</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—</span></span><br><span class="line">mc admin logs myminio</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å®¡è®¡æ—¥å¿—</span></span><br><span class="line">mc admin logs myminio --<span class="built_in">type</span> audit --follow</span><br></pre></td></tr></table></figure><h3 id="5-5-é«˜çº§åŠŸèƒ½"><a href="#5-5-é«˜çº§åŠŸèƒ½" class="headerlink" title="5.5 é«˜çº§åŠŸèƒ½"></a>5.5 é«˜çº§åŠŸèƒ½</h3><h4 id="ç‰ˆæœ¬æ§åˆ¶"><a href="#ç‰ˆæœ¬æ§åˆ¶" class="headerlink" title="ç‰ˆæœ¬æ§åˆ¶"></a>ç‰ˆæœ¬æ§åˆ¶</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯ç”¨ç‰ˆæœ¬æ§åˆ¶</span></span><br><span class="line">mc version <span class="built_in">enable</span> myminio/mybucket</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç‰ˆæœ¬æ§åˆ¶çŠ¶æ€</span></span><br><span class="line">mc version info myminio/mybucket</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ—å‡ºå¯¹è±¡æ‰€æœ‰ç‰ˆæœ¬</span></span><br><span class="line">mc <span class="built_in">ls</span> --versions myminio/mybucket</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤ç‰¹å®šç‰ˆæœ¬</span></span><br><span class="line">mc <span class="built_in">rm</span> --vid <span class="string">&quot;version-id&quot;</span> myminio/mybucket/file.txt</span><br></pre></td></tr></table></figure><h4 id="ç”Ÿå‘½å‘¨æœŸç®¡ç†-ILM"><a href="#ç”Ÿå‘½å‘¨æœŸç®¡ç†-ILM" class="headerlink" title="ç”Ÿå‘½å‘¨æœŸç®¡ç† (ILM)"></a>ç”Ÿå‘½å‘¨æœŸç®¡ç† (ILM)</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºç”Ÿå‘½å‘¨æœŸè§„åˆ™ (30å¤©åè¿‡æœŸå¯¹è±¡)</span></span><br><span class="line"><span class="built_in">cat</span> &gt; lifecycle.json &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;Rules&quot;: [</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;ID&quot;: &quot;ExpireAfter30Days&quot;,</span></span><br><span class="line"><span class="string">      &quot;Status&quot;: &quot;Enabled&quot;,</span></span><br><span class="line"><span class="string">      &quot;Filter&quot;: &#123; &quot;Prefix&quot;: &quot;&quot; &#125;,</span></span><br><span class="line"><span class="string">      &quot;Expiration&quot;: &#123; &quot;Days&quot;: 30 &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åº”ç”¨ç”Ÿå‘½å‘¨æœŸè§„åˆ™</span></span><br><span class="line">mc ilm import myminio/mybucket &lt; lifecycle.json</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç”Ÿå‘½å‘¨æœŸè§„åˆ™</span></span><br><span class="line">mc ilm <span class="built_in">ls</span> myminio/mybucket</span><br></pre></td></tr></table></figure><h4 id="åŠ å¯†"><a href="#åŠ å¯†" class="headerlink" title="åŠ å¯†"></a>åŠ å¯†</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯ç”¨æœåŠ¡å™¨ç«¯åŠ å¯† (SSE-S3)</span></span><br><span class="line">mc encrypt <span class="built_in">set</span> sse-s3 myminio/mybucket</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹åŠ å¯†çŠ¶æ€</span></span><br><span class="line">mc encrypt info myminio/mybucket</span><br></pre></td></tr></table></figure><h3 id="5-6-è”é‚¦æ‰©å®¹é…ç½®"><a href="#5-6-è”é‚¦æ‰©å®¹é…ç½®" class="headerlink" title="5.6 è”é‚¦æ‰©å®¹é…ç½®"></a>5.6 è”é‚¦æ‰©å®¹é…ç½®</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. å¯åŠ¨ etcd é›†ç¾¤ (ç¤ºä¾‹)</span></span><br><span class="line"><span class="comment"># èŠ‚ç‚¹1:</span></span><br><span class="line">etcd --name etcd-1 --initial-advertise-peer-urls http://192.168.1.107:2380 \</span><br><span class="line">  --listen-peer-urls http://192.168.1.107:2380 \</span><br><span class="line">  --listen-client-urls http://192.168.1.107:2379,http://127.0.0.1:2379 \</span><br><span class="line">  --advertise-client-urls http://192.168.1.107:2379 \</span><br><span class="line">  --initial-cluster-token etcd-cluster-1 \</span><br><span class="line">  --initial-cluster etcd-1=http://192.168.1.107:2380,etcd-2=http://192.168.1.108:2380 \</span><br><span class="line">  --initial-cluster-state new</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. é…ç½®å¹¶å¯åŠ¨ MinIO ç§Ÿæˆ·é›†ç¾¤</span></span><br><span class="line"><span class="comment"># åœ¨æ‰€æœ‰ MinIO èŠ‚ç‚¹ä¸Šè®¾ç½®ç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="built_in">export</span> MINIO_ETCD_ENDPOINTS=<span class="string">&quot;http://192.168.1.107:2379,http://192.168.1.108:2379&quot;</span></span><br><span class="line"><span class="built_in">export</span> MINIO_PUBLIC_IPS=<span class="string">&quot;192.168.1.103,192.168.1.104&quot;</span> <span class="comment"># ç§Ÿæˆ·é›†ç¾¤çš„å…¬å…±IP</span></span><br><span class="line"><span class="built_in">export</span> MINIO_DOMAIN=minio.example.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨é›†ç¾¤1 (ç§Ÿæˆ·1)</span></span><br><span class="line">minio server http://192.168.1.&#123;103...104&#125;/data&#123;1...2&#125; --console-address <span class="string">&quot;:9001&quot;</span></span><br></pre></td></tr></table></figure><h3 id="5-7-æ•…éšœæ’é™¤å‘½ä»¤"><a href="#5-7-æ•…éšœæ’é™¤å‘½ä»¤" class="headerlink" title="5.7 æ•…éšœæ’é™¤å‘½ä»¤"></a>5.7 æ•…éšœæ’é™¤å‘½ä»¤</h3><h4 id="å¥åº·æ£€æŸ¥"><a href="#å¥åº·æ£€æŸ¥" class="headerlink" title="å¥åº·æ£€æŸ¥"></a>å¥åº·æ£€æŸ¥</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ£€æŸ¥é›†ç¾¤å¥åº·çŠ¶å†µå¹¶ä¿®å¤</span></span><br><span class="line">mc admin heal myminio</span><br><span class="line"></span><br><span class="line"><span class="comment"># é€’å½’åœ°æ£€æŸ¥æ‰€æœ‰å¯¹è±¡</span></span><br><span class="line">mc admin heal --recursive myminio/mybucket</span><br></pre></td></tr></table></figure><h4 id="é…ç½®ç®¡ç†"><a href="#é…ç½®ç®¡ç†" class="headerlink" title="é…ç½®ç®¡ç†"></a>é…ç½®ç®¡ç†</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹å½“å‰é…ç½®</span></span><br><span class="line">mc admin config get myminio</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®é…ç½® (ä¾‹å¦‚ï¼ŒåŒºåŸŸ)</span></span><br><span class="line">mc admin config <span class="built_in">set</span> myminio region name=us-east-1</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡ç½®é…ç½®ä¸ºé»˜è®¤å€¼</span></span><br><span class="line">mc admin config reset myminio</span><br></pre></td></tr></table></figure><h2 id="6-æœ€ä½³å®è·µ"><a href="#6-æœ€ä½³å®è·µ" class="headerlink" title="6. æœ€ä½³å®è·µ"></a>6. æœ€ä½³å®è·µ</h2><h3 id="6-1-éƒ¨ç½²å»ºè®®"><a href="#6-1-éƒ¨ç½²å»ºè®®" class="headerlink" title="6.1 éƒ¨ç½²å»ºè®®"></a>6.1 éƒ¨ç½²å»ºè®®</h3><h4 id="6-1-1-ç¡¬ä»¶é…ç½®å»ºè®®"><a href="#6-1-1-ç¡¬ä»¶é…ç½®å»ºè®®" class="headerlink" title="6.1.1 ç¡¬ä»¶é…ç½®å»ºè®®"></a>6.1.1 ç¡¬ä»¶é…ç½®å»ºè®®</h4><ul><li><strong>å­˜å‚¨è®¾å¤‡</strong>ï¼šå¼ºçƒˆæ¨èä½¿ç”¨åŒè´¨åŒ–çš„ NVMe SSDï¼Œä»¥é¿å…æ…¢ç›˜æ•ˆåº”ã€‚ä½¿ç”¨JBODï¼ˆJust a Bunch of Disksï¼‰æ¨¡å¼ï¼Œé¿å…ä½¿ç”¨ç¡¬ä»¶RAIDã€‚</li><li><strong>ç½‘ç»œå¸¦å®½</strong>ï¼šä¸ºå‘æŒ¥æè‡´æ€§èƒ½ï¼Œå»ºè®®èŠ‚ç‚¹é—´ä½¿ç”¨ 25Gbps åˆ° 100Gbps çš„é«˜é€Ÿç½‘ç»œã€‚</li><li><strong>CPUè¦æ±‚</strong>ï¼šä¸ºæœ€å¤§åŒ–çº åˆ ç æ€§èƒ½ï¼Œæ¨èä½¿ç”¨æ”¯æŒ Intel AVX512 æŒ‡ä»¤é›†çš„CPUã€‚</li><li><strong>å†…å­˜é…ç½®</strong>ï¼šå†…å­˜ä½¿ç”¨ä¸å¹¶å‘è¯·æ±‚æ•°å’Œçº åˆ ç é…ç½®ç›¸å…³ã€‚å®˜æ–¹å»ºè®®ï¼Œå¯¹äº100TBä»¥ä¸‹çš„å°è§„æ¨¡éƒ¨ç½²ï¼Œæ¯èŠ‚ç‚¹è‡³å°‘é…ç½®32GBå†…å­˜ã€‚å¯¹äºæ›´å¤§è§„æ¨¡çš„éƒ¨ç½²ï¼Œåº”æ ¹æ®ç›‘æ§çš„å®é™…å†…å­˜ä½¿ç”¨æƒ…å†µè¿›è¡Œè§„åˆ’ï¼Œä»¥æ”¯æŒé«˜å¹¶å‘è¿æ¥å’Œå…ƒæ•°æ®ç¼“å­˜ã€‚</li></ul><h4 id="6-1-2-é›†ç¾¤è§„åˆ’å»ºè®®"><a href="#6-1-2-é›†ç¾¤è§„åˆ’å»ºè®®" class="headerlink" title="6.1.2 é›†ç¾¤è§„åˆ’å»ºè®®"></a>6.1.2 é›†ç¾¤è§„åˆ’å»ºè®®</h4><ul><li><strong>çº åˆ ç é›†åˆå¤§å°</strong>ï¼šæ¯ä¸ªçº åˆ ç é›†åˆï¼ˆErasure Setï¼‰çš„é©±åŠ¨å™¨æ•°é‡å»ºè®®ä¸º4åˆ°16å—ã€‚</li><li><strong>èŠ‚ç‚¹æ•°é‡é™åˆ¶</strong>ï¼šå¯¹äºå•ä¸ªMinIOé›†ç¾¤ï¼Œä¸ºä¿è¯é€šä¿¡æ•ˆç‡å’Œä¸€è‡´æ€§ï¼Œå»ºè®®èŠ‚ç‚¹æ•°ä¸è¦è¶…è¿‡32ä¸ªã€‚æ›´å¤§è§„æ¨¡è¯·ä½¿ç”¨è”é‚¦æ¨¡å¼ã€‚</li><li><strong>å¯ç”¨åŒºéƒ¨ç½²</strong>ï¼šä¸ºå®ç°é«˜å¯ç”¨æ€§ï¼Œåº”å°†èŠ‚ç‚¹å’Œé©±åŠ¨å™¨åˆ†å¸ƒåœ¨ä¸åŒçš„ç‰©ç†æœºæ¶ã€æ•°æ®ä¸­å¿ƒå¯ç”¨åŒºä¸­ã€‚</li><li><strong>DNSè½®è¯¢</strong>ï¼šé…ç½®DNSè½®è¯¢æˆ–ä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨å°†å®¢æˆ·ç«¯è¯·æ±‚åˆ†å‘åˆ°æ‰€æœ‰MinIOèŠ‚ç‚¹ã€‚</li></ul><h4 id="6-1-3-è¿ç»­IPè§„åˆ’"><a href="#6-1-3-è¿ç»­IPè§„åˆ’" class="headerlink" title="6.1.3 è¿ç»­IPè§„åˆ’"></a>6.1.3 è¿ç»­IPè§„åˆ’</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ¨èä½¿ç”¨è¿ç»­çš„èŠ‚ç‚¹IPå’Œç›¸ä¼¼çš„ç›®å½•ç»“æ„ï¼Œä¾¿äºæ¨¡æ¿åŒ–é…ç½®å’Œç®¡ç†</span></span><br><span class="line">minio server http://192.168.1.&#123;10...13&#125;/data&#123;1...4&#125; --console-address <span class="string">&quot;:9001&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è€Œéåˆ†æ•£çš„IPå’Œä¸è§„åˆ™çš„ç›®å½•</span></span><br><span class="line"><span class="comment"># minio server http://192.168.1.10/disk_a http://192.168.2.20/drive_1 ...</span></span><br></pre></td></tr></table></figure><h3 id="6-2-æ€§èƒ½ä¼˜åŒ–"><a href="#6-2-æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="6.2 æ€§èƒ½ä¼˜åŒ–"></a>6.2 æ€§èƒ½ä¼˜åŒ–</h3><h4 id="6-2-1-çº åˆ ç é…ç½®ä¼˜åŒ–"><a href="#6-2-1-çº åˆ ç é…ç½®ä¼˜åŒ–" class="headerlink" title="6.2.1 çº åˆ ç é…ç½®ä¼˜åŒ–"></a>6.2.1 çº åˆ ç é…ç½®ä¼˜åŒ–</h4><ul><li><strong>å¯é æ€§ä¸æ•ˆç‡çš„å¹³è¡¡</strong>ï¼šæ ¹æ®ä¸šåŠ¡å¯¹æ•°æ®å¯é æ€§çš„è¦æ±‚å’Œæˆæœ¬é¢„ç®—ï¼Œé€‰æ‹©åˆé€‚çš„çº åˆ ç é…ç½®ã€‚<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EC:4 (ä¾‹å¦‚ 12+4) - å­˜å‚¨æ•ˆç‡ 75%ï¼Œå¯å®¹å¿4ä¸ªé©±åŠ¨å™¨æ•…éšœï¼Œæ˜¯æ€§èƒ½å’Œå¯é æ€§çš„è‰¯å¥½å¹³è¡¡ç‚¹ã€‚</span></span><br><span class="line"><span class="comment"># EC:8 (ä¾‹å¦‚ 8+8) - å­˜å‚¨æ•ˆç‡ 50%ï¼Œå¯å®¹å¿8ä¸ªé©±åŠ¨å™¨æ•…éšœï¼Œæä¾›æé«˜çš„å¯é æ€§ï¼Œä½†æˆæœ¬è¾ƒé«˜ã€‚</span></span><br></pre></td></tr></table></figure></li><li><strong>é»˜è®¤é…ç½®æ¨è</strong>ï¼šå¯¹äºå¤§å¤šæ•°åœºæ™¯ï¼ŒMinIOè‡ªåŠ¨é€‰æ‹©çš„é»˜è®¤çº åˆ ç é…ç½®ï¼ˆé€šå¸¸æ˜¯EC:4ï¼‰æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„èµ·ç‚¹ã€‚</li></ul><h4 id="6-2-2-ç¡¬ä»¶æ€§èƒ½ä¼˜åŒ–"><a href="#6-2-2-ç¡¬ä»¶æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="6.2.2 ç¡¬ä»¶æ€§èƒ½ä¼˜åŒ–"></a>6.2.2 ç¡¬ä»¶æ€§èƒ½ä¼˜åŒ–</h4><ul><li><strong>å¯ç”¨AVX512</strong>ï¼šç¡®ä¿CPUæ”¯æŒå¹¶å¯ç”¨äº†AVX512æŒ‡ä»¤é›†ã€‚</li><li><strong>ä½¿ç”¨NVMe SSD</strong>ï¼šå……åˆ†åˆ©ç”¨å…¶é«˜IOPSå’Œä½å»¶è¿Ÿç‰¹æ€§ã€‚</li><li><strong>é¿å…RAID</strong>ï¼šç¡¬ä»¶RAIDä¼šä¸MinIOè‡ªèº«çš„çº åˆ ç å’Œæ•°æ®ä¿æŠ¤æœºåˆ¶å†²çªï¼Œå¹¶å¼•å…¥æ€§èƒ½ç“¶é¢ˆã€‚</li></ul><h4 id="6-2-3-ç½‘ç»œä¼˜åŒ–"><a href="#6-2-3-ç½‘ç»œä¼˜åŒ–" class="headerlink" title="6.2.3 ç½‘ç»œä¼˜åŒ–"></a>6.2.3 ç½‘ç»œä¼˜åŒ–</h4><ul><li><strong>é«˜é€Ÿç½‘ç»œ</strong>ï¼šä½¿ç”¨25&#x2F;100Gbpsç½‘ç»œä»¥æ”¯æŒçº¿é€Ÿè¯»å†™ã€‚</li><li><strong>è´Ÿè½½å‡è¡¡ç­–ç•¥</strong>ï¼šä½¿ç”¨æ”¯æŒæœ€å°è¿æ¥æ•°æˆ–è½®è¯¢çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ã€‚</li><li><strong>ç½‘ç»œæ‹“æ‰‘</strong>ï¼šè®¾è®¡æ‰å¹³åŒ–çš„ç½‘ç»œæ‹“æ‰‘ï¼Œæœ€å°åŒ–èŠ‚ç‚¹é—´çš„ç½‘ç»œè·³æ•°å’Œå»¶è¿Ÿã€‚</li></ul><h4 id="6-2-4-å…³é”®ç›‘æ§æŒ‡æ ‡"><a href="#6-2-4-å…³é”®ç›‘æ§æŒ‡æ ‡" class="headerlink" title="6.2.4 å…³é”®ç›‘æ§æŒ‡æ ‡"></a>6.2.4 å…³é”®ç›‘æ§æŒ‡æ ‡</h4><ul><li>**ååé‡ (Throughput)**ï¼šç›‘æ§é›†ç¾¤çš„è¯»&#x2F;å†™ååé‡æ˜¯å¦ç¬¦åˆé¢„æœŸã€‚</li><li>**å»¶è¿Ÿ (Latency)**ï¼šç›‘æ§S3 APIè¯·æ±‚çš„å¹³å‡å’ŒP99å»¶è¿Ÿã€‚</li><li><strong>é©±åŠ¨å™¨å¥åº·</strong>ï¼šç›‘æ§é©±åŠ¨å™¨çš„SMARTæ•°æ®ã€IOç­‰å¾…æ—¶é—´ã€é”™è¯¯ç‡ç­‰ã€‚</li><li><strong>çº åˆ ç çŠ¶æ€</strong>ï¼šç›‘æ§æ˜¯å¦æœ‰é™çº§çš„çº åˆ ç é›†åˆï¼Œä»¥åŠæ•°æ®é‡å»ºï¼ˆHealingï¼‰çš„è¿›åº¦å’Œé€Ÿåº¦ã€‚</li></ul><h3 id="6-3-å®‰å…¨å»ºè®®"><a href="#6-3-å®‰å…¨å»ºè®®" class="headerlink" title="6.3 å®‰å…¨å»ºè®®"></a>6.3 å®‰å…¨å»ºè®®</h3><ul><li><strong>å¯ç”¨TLS</strong>ï¼šä¸ºæ‰€æœ‰APIå’Œæ§åˆ¶å°æµé‡å¼ºåˆ¶å¯ç”¨TLSåŠ å¯†ä¼ è¾“ã€‚</li><li><strong>ä½¿ç”¨IAM</strong>ï¼šå®æ–½æœ€å°æƒé™åŸåˆ™ï¼Œä¸ºä¸åŒåº”ç”¨åˆ›å»ºä¸“ç”¨çš„ç”¨æˆ·å’Œç­–ç•¥ã€‚</li><li><strong>å¯†é’¥ç®¡ç†</strong>ï¼šå®šæœŸè½®æ¢è®¿é—®å¯†é’¥å’Œå¯†é’¥åŠ å¯†å¯†é’¥ï¼ˆKEKï¼‰ã€‚</li><li><strong>å®¡è®¡æ—¥å¿—</strong>ï¼šå¯ç”¨å¹¶å®šæœŸå®¡è®¡è®¿é—®æ—¥å¿—ï¼Œç›‘æ§å¼‚å¸¸è¡Œä¸ºã€‚</li></ul><h3 id="6-4-ç›‘æ§å’Œç»´æŠ¤"><a href="#6-4-ç›‘æ§å’Œç»´æŠ¤" class="headerlink" title="6.4 ç›‘æ§å’Œç»´æŠ¤"></a>6.4 ç›‘æ§å’Œç»´æŠ¤</h3><ul><li><strong>Prometheusé›†æˆ</strong>ï¼šåˆ©ç”¨MinIOå†…ç½®çš„Prometheusç«¯ç‚¹ï¼Œè¿›è¡Œå…¨é¢çš„ç›‘æ§å’Œå‘Šè­¦ã€‚</li><li><strong>å®šæœŸå¥åº·æ£€æŸ¥</strong>ï¼šå®šæœŸè¿è¡Œ <code>mc admin heal</code> æ£€æŸ¥æ•°æ®å®Œæ•´æ€§ã€‚</li><li><strong>å®¹é‡è§„åˆ’</strong>ï¼šç›‘æ§ç£ç›˜ä½¿ç”¨ç‡ï¼Œå¹¶æ ¹æ®å¢é•¿è¶‹åŠ¿åˆ¶å®šæ‰©å®¹è®¡åˆ’ã€‚</li><li><strong>ç¾éš¾æ¢å¤æ¼”ç»ƒ</strong>ï¼šå®šæœŸè¿›è¡Œç¾å¤‡æ¼”ç»ƒï¼Œç¡®ä¿å¤‡ä»½å’Œæ¢å¤æµç¨‹æœ‰æ•ˆã€‚</li></ul><h2 id="7-æ€»ç»“"><a href="#7-æ€»ç»“" class="headerlink" title="7. æ€»ç»“"></a>7. æ€»ç»“</h2><h3 id="7-1-MinIO-æ ¸å¿ƒä¼˜åŠ¿æ€»è§ˆ"><a href="#7-1-MinIO-æ ¸å¿ƒä¼˜åŠ¿æ€»è§ˆ" class="headerlink" title="7.1 MinIO æ ¸å¿ƒä¼˜åŠ¿æ€»è§ˆ"></a>7.1 MinIO æ ¸å¿ƒä¼˜åŠ¿æ€»è§ˆ</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TB    subgraph &quot;MinIO æ ¸å¿ƒä¼˜åŠ¿&quot;        A[MinIOå¯¹è±¡å­˜å‚¨] --&gt; B[ç®€æ´é«˜æ€§èƒ½]        A --&gt; C[äº‘åŸç”Ÿè®¾è®¡]        A --&gt; D[S3å…¼å®¹æ€§]        A --&gt; E[ä¼ä¸šçº§ç‰¹æ€§]                B --&gt; B1[æ— ä¸»æ¶æ„]        B --&gt; B2[çº åˆ ç ä¼˜åŒ–]        B --&gt; B3[AVX512åŠ é€Ÿ]                C --&gt; C1[è½»é‡çº§å®¹å™¨åŒ–]        C --&gt; C2[æ˜“äºè‡ªåŠ¨åŒ–è¿ç»´]        C --&gt; C3[æ°´å¹³æ‰©å±•]                D --&gt; D1[äº‹å®æ ‡å‡†API]        D --&gt; D2[åºå¤§çš„ç”Ÿæ€ç³»ç»Ÿ]        D --&gt; D3[æ— ç¼è¿ç§»]                E --&gt; E1[åŠ å¯†ä¸å®‰å…¨]        E --&gt; E2[ç”Ÿå‘½å‘¨æœŸç®¡ç†]        E --&gt; E3[å¤šç§Ÿæˆ·ä¸è”é‚¦]    end  </pre></div><h3 id="7-2-æŠ€æœ¯ç‰¹è‰²æ€»ç»“"><a href="#7-2-æŠ€æœ¯ç‰¹è‰²æ€»ç»“" class="headerlink" title="7.2 æŠ€æœ¯ç‰¹è‰²æ€»ç»“"></a>7.2 æŠ€æœ¯ç‰¹è‰²æ€»ç»“</h3><p>MinIO é€šè¿‡ä»¥ä¸‹å…³é”®æŠ€æœ¯å®ç°äº†å…¶ç‹¬ç‰¹çš„ä¼˜åŠ¿ï¼š</p><ul><li><strong>æ¶æ„åˆ›æ–°</strong>ï¼š<ul><li><strong>æ— ä¸»è®¾è®¡</strong>ï¼šé‡‡ç”¨ç¡®å®šæ€§å“ˆå¸Œç®—æ³•å’Œçº åˆ ç é›†åˆï¼Œä»æ ¹æœ¬ä¸Šæ¶ˆé™¤äº†å•ç‚¹æ•…éšœå’Œæ€§èƒ½ç“¶é¢ˆã€‚</li><li><strong>Reed-Solomonçº åˆ ç </strong>ï¼šæä¾›æ¯”ä¼ ç»Ÿå‰¯æœ¬æ›´é«˜çš„å­˜å‚¨æ•ˆç‡å’Œæ›´çµæ´»çš„å®¹é”™èƒ½åŠ›ã€‚</li><li><strong>è‡ªæè¿°å…ƒæ•°æ®</strong>ï¼š<code>xl.json</code>éšå¯¹è±¡å­˜å‚¨ï¼Œç¡®ä¿æ•°æ®çš„å®Œæ•´æ€§ã€å¯ç§»æ¤æ€§å’Œæ¢å¤çš„ç®€ä¾¿æ€§ã€‚</li></ul></li><li><strong>æ€§èƒ½ä¼˜åŒ–</strong>ï¼š<ul><li><strong>SIMDåŠ é€Ÿ</strong>ï¼šåˆ©ç”¨AVX512&#x2F;NEONç­‰æŒ‡ä»¤é›†ï¼Œå°†çº åˆ ç è®¡ç®—çš„CPUå¼€é”€é™è‡³æœ€ä½ã€‚</li><li><strong>æ™ºèƒ½å¹¶è¡Œå¤„ç†</strong>ï¼šè¯»å†™æ“ä½œä»…é™äºçº åˆ ç é›†åˆå†…çš„èŠ‚ç‚¹ï¼Œç²¾å‡†å¹¶è¡Œï¼Œé¿å…äº†ä¸å¿…è¦çš„ç½‘ç»œé£æš´ã€‚</li></ul></li><li><strong>è¿ç»´å‹å¥½</strong>ï¼š<ul><li><strong>æç®€è®¾è®¡</strong>ï¼šå•ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ— å¤æ‚ä¾èµ–ï¼Œé…ç½®ç®€å•ã€‚</li><li><strong>è‡ªåŠ¨ä¿®å¤</strong>ï¼šå†…ç½®æ•°æ®å®Œæ•´æ€§æ£€æŸ¥å’Œè‡ªæ„ˆæœºåˆ¶ï¼Œå¤§å¤§é™ä½äº†è¿ç»´è´Ÿæ‹…ã€‚</li></ul></li></ul><h3 id="7-3-é€‚ç”¨åœºæ™¯æ€»ç»“"><a href="#7-3-é€‚ç”¨åœºæ™¯æ€»ç»“" class="headerlink" title="7.3 é€‚ç”¨åœºæ™¯æ€»ç»“"></a>7.3 é€‚ç”¨åœºæ™¯æ€»ç»“</h3><p>MinIO åœ¨ä»¥ä¸‹åœºæ™¯ä¸­è¡¨ç°å°¤ä¸ºå‡ºè‰²ï¼š</p><ul><li><strong>äº‘åŸç”Ÿåº”ç”¨å­˜å‚¨</strong>ï¼šä½œä¸ºKubernetesç­‰å®¹å™¨åŒ–ç¯å¢ƒçš„æŒä¹…åŒ–å­˜å‚¨åç«¯ã€‚</li><li><strong>æ•°æ®æ¹–ä¸AI&#x2F;ML</strong>ï¼šä¸ºSparkã€Prestoã€TensorFlowç­‰æ¡†æ¶æä¾›é«˜æ€§èƒ½ã€å¯æ‰©å±•çš„ç»Ÿä¸€å­˜å‚¨å±‚ã€‚</li><li><strong>å¤‡ä»½ä¸å½’æ¡£</strong>ï¼šä¸ºæ•°æ®åº“ã€è™šæ‹Ÿæœºã€åº”ç”¨æ—¥å¿—æä¾›é«˜æ€§ä»·æ¯”ã€é«˜å¯é çš„æ•°æ®ä¿æŠ¤æ–¹æ¡ˆã€‚</li><li><strong>CDNä¸åª’ä½“æœåŠ¡</strong>ï¼šä½œä¸ºé™æ€èµ„æºï¼ˆå›¾ç‰‡ã€è§†é¢‘ï¼‰çš„æºç«™ï¼Œæ»¡è¶³é«˜å¹¶å‘è®¿é—®éœ€æ±‚ã€‚</li></ul><h3 id="7-4-æ€»ä½“è¯„ä»·"><a href="#7-4-æ€»ä½“è¯„ä»·" class="headerlink" title="7.4 æ€»ä½“è¯„ä»·"></a>7.4 æ€»ä½“è¯„ä»·</h3><p>MinIO æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ã€æ€§èƒ½å“è¶Šä¸”è®¾è®¡ç®€æ´çš„å¯¹è±¡å­˜å‚¨è§£å†³æ–¹æ¡ˆã€‚å®ƒé€šè¿‡å¯¹åˆ†å¸ƒå¼ç³»ç»Ÿæ ¸å¿ƒé—®é¢˜çš„æ·±åˆ»ç†è§£å’Œåˆ›æ–°æ€§çš„å·¥ç¨‹å®ç°ï¼ŒæˆåŠŸåœ°åœ¨æ€§èƒ½ã€å¯é æ€§ã€å¯æ‰©å±•æ€§å’Œæ˜“ç”¨æ€§ä¹‹é—´å–å¾—äº†å“è¶Šçš„å¹³è¡¡ã€‚</p><p>å¯¹äºå¯»æ±‚åœ¨ç§æœ‰äº‘ã€æ··åˆäº‘æˆ–è¾¹ç¼˜ç¯å¢ƒä¸­éƒ¨ç½²S3å…¼å®¹å­˜å‚¨çš„ç»„ç»‡è€Œè¨€ï¼ŒMinIOæ— ç–‘æ˜¯å½“å‰å¸‚åœºä¸Šæœ€å…·ç«äº‰åŠ›çš„é€‰æ‹©ä¹‹ä¸€ã€‚</p><h3 id="7-5-æœ€ä½³å®è·µå»ºè®®"><a href="#7-5-æœ€ä½³å®è·µå»ºè®®" class="headerlink" title="7.5 æœ€ä½³å®è·µå»ºè®®"></a>7.5 æœ€ä½³å®è·µå»ºè®®</h3><h4 id="åˆ†é˜¶æ®µéƒ¨ç½²ç­–ç•¥"><a href="#åˆ†é˜¶æ®µéƒ¨ç½²ç­–ç•¥" class="headerlink" title="åˆ†é˜¶æ®µéƒ¨ç½²ç­–ç•¥"></a>åˆ†é˜¶æ®µéƒ¨ç½²ç­–ç•¥</h4><ol><li><strong>è§„åˆ’é˜¶æ®µ</strong>ï¼š<ul><li>æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚çš„çº åˆ ç é…ç½®ï¼ˆEC:4æ˜¯è‰¯å¥½èµ·ç‚¹ï¼‰ã€‚</li><li>è§„åˆ’é›†ç¾¤èŠ‚ç‚¹å’Œé©±åŠ¨å™¨æ•°é‡ï¼Œç¡®ä¿å®ƒä»¬å‡åŒ€åˆ†å¸ƒåœ¨ä¸åŒæ•…éšœåŸŸã€‚</li><li>è®¾è®¡é•¿è¿œçš„æ‰©å®¹ç­–ç•¥ï¼ˆå¯¹ç­‰æ‰©å®¹ vs è”é‚¦æ‰©å®¹ï¼‰ã€‚</li></ul></li><li><strong>éƒ¨ç½²é˜¶æ®µ</strong>ï¼š<ul><li>ç¡®ä¿ç¡¬ä»¶å’Œç½‘ç»œé…ç½®æ»¡è¶³æ€§èƒ½è¦æ±‚ï¼ˆé«˜é€Ÿç½‘ç»œ + NVMe SSDï¼‰ã€‚</li><li>ä½¿ç”¨è‡ªåŠ¨åŒ–å·¥å…·ï¼ˆå¦‚Ansible, Terraformï¼‰è¿›è¡Œå£°æ˜å¼éƒ¨ç½²å’Œé…ç½®ç®¡ç†ã€‚</li><li>é…ç½®DNSè½®è¯¢æˆ–è´Ÿè½½å‡è¡¡å™¨ã€‚</li></ul></li><li><strong>è¿ç»´é˜¶æ®µ</strong>ï¼š<ul><li>é›†æˆPrometheuså’ŒGrafanaï¼Œå»ºç«‹å®Œå–„çš„ç›‘æ§å’Œå‘Šè­¦ä½“ç³»ã€‚</li><li>å®šæœŸæ‰§è¡Œ <code>mc admin heal</code> è¿›è¡Œæ•°æ®å·¡æ£€ã€‚</li><li>å®šæœŸè¿›è¡Œå®‰å…¨å®¡è®¡å’Œå¯†é’¥è½®æ¢ã€‚</li></ul></li><li><strong>ä¼˜åŒ–é˜¶æ®µ</strong>ï¼š<ul><li>æ ¹æ®ç›‘æ§æ•°æ®ï¼ŒæŒç»­è°ƒä¼˜ç³»ç»Ÿå‚æ•°ã€‚</li><li>æ ¹æ®ä¸šåŠ¡å¢é•¿ï¼Œæ‰§è¡Œé¢„å…ˆè§„åˆ’çš„æ‰©å®¹ç­–ç•¥ã€‚</li></ul></li></ol><h4 id="å…³é”®æŠ€æœ¯è¦ç‚¹"><a href="#å…³é”®æŠ€æœ¯è¦ç‚¹" class="headerlink" title="å…³é”®æŠ€æœ¯è¦ç‚¹"></a>å…³é”®æŠ€æœ¯è¦ç‚¹</h4><ul><li><strong>ç†è§£çº åˆ ç </strong>ï¼šæ·±å…¥ç†è§£çº åˆ ç çš„Kã€Må€¼å¯¹å¯é æ€§å’Œå­˜å‚¨æ•ˆç‡çš„å½±å“ã€‚</li><li><strong>ç†è§£å…ƒæ•°æ®</strong>ï¼šæ¸…æ™°åŒºåˆ†å¯¹è±¡å…ƒæ•°æ®å’Œé…ç½®å…ƒæ•°æ®çš„ä¸åŒç®¡ç†æ–¹å¼ã€‚</li><li><strong>å–„ç”¨ç¡¬ä»¶ç‰¹æ€§</strong>ï¼šå……åˆ†åˆ©ç”¨AVX512ã€NVMeã€é«˜é€Ÿç½‘ç»œç­‰ç¡¬ä»¶ç‰¹æ€§æ¥é‡Šæ”¾MinIOçš„å…¨éƒ¨æ½œåŠ›ã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åˆ†å¸ƒå¼å­˜å‚¨ </tag>
            
            <tag> MinIO </tag>
            
            <tag> å¯¹è±¡å­˜å‚¨ </tag>
            
            <tag> S3å…¼å®¹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CRC-32æŠ€æœ¯è¯¦è§£ï¼šä»åŸç†åˆ°HDFSåº”ç”¨å®è·µ</title>
      <link href="/2025/06/16/CRC-32%E6%8A%80%E6%9C%AF%E8%AF%A6%E8%A7%A3%EF%BC%9A%E4%BB%8E%E5%8E%9F%E7%90%86%E5%88%B0HDFS%E5%BA%94%E7%94%A8%E5%AE%9E%E8%B7%B5/"/>
      <url>/2025/06/16/CRC-32%E6%8A%80%E6%9C%AF%E8%AF%A6%E8%A7%A3%EF%BC%9A%E4%BB%8E%E5%8E%9F%E7%90%86%E5%88%B0HDFS%E5%BA%94%E7%94%A8%E5%AE%9E%E8%B7%B5/</url>
      
        <content type="html"><![CDATA[<h1 id="CRC-32æŠ€æœ¯è¯¦è§£ï¼šä»åŸç†åˆ°HDFSåº”ç”¨å®è·µ"><a href="#CRC-32æŠ€æœ¯è¯¦è§£ï¼šä»åŸç†åˆ°HDFSåº”ç”¨å®è·µ" class="headerlink" title="CRC-32æŠ€æœ¯è¯¦è§£ï¼šä»åŸç†åˆ°HDFSåº”ç”¨å®è·µ"></a>CRC-32æŠ€æœ¯è¯¦è§£ï¼šä»åŸç†åˆ°HDFSåº”ç”¨å®è·µ</h1><h2 id="ç›®å½•"><a href="#ç›®å½•" class="headerlink" title="ç›®å½•"></a>ç›®å½•</h2><ol><li><a href="#1-crc-32%E6%A6%82%E8%BF%B0">CRC-32æ¦‚è¿°</a></li><li><a href="#2-%E6%95%B0%E5%AD%A6%E5%9F%BA%E7%A1%80%E4%BA%8C%E8%BF%9B%E5%88%B6%E4%B8%8E%E5%A4%9A%E9%A1%B9%E5%BC%8F">æ•°å­¦åŸºç¡€ï¼šäºŒè¿›åˆ¶ä¸å¤šé¡¹å¼</a></li><li><a href="#3-crc%E5%A4%9A%E9%A1%B9%E5%BC%8F%E9%99%A4%E6%B3%95%E5%8E%9F%E7%90%86">CRCå¤šé¡¹å¼é™¤æ³•åŸç†</a><ul><li><a href="#31-crc%E7%9A%84%E6%95%B0%E5%AD%A6%E6%A8%A1%E5%9E%8B">3.1 CRCçš„æ•°å­¦æ¨¡å‹</a></li><li><a href="#32-%E7%94%9F%E6%88%90%E5%A4%9A%E9%A1%B9%E5%BC%8F%E8%AF%A6%E8%A7%A3">3.2 ç”Ÿæˆå¤šé¡¹å¼è¯¦è§£</a></li><li><a href="#33-%E5%A4%9A%E9%A1%B9%E5%BC%8F%E9%99%A4%E6%B3%95%E6%AD%A5%E9%AA%A4%E8%AF%A6%E8%A7%A3">3.3 å¤šé¡¹å¼é™¤æ³•æ­¥éª¤è¯¦è§£</a></li><li><a href="#34-%E9%99%A4%E6%B3%95%E8%A7%84%E5%88%99%E6%80%BB%E7%BB%93">3.4 é™¤æ³•è§„åˆ™æ€»ç»“</a></li></ul></li><li><a href="#4-crc-32%E8%AE%A1%E7%AE%97%E8%BF%87%E7%A8%8B%E8%AF%A6%E8%A7%A3">CRC-32è®¡ç®—è¿‡ç¨‹è¯¦è§£</a></li><li><a href="#5-%E5%AE%9E%E7%8E%B0%E4%BC%98%E5%8C%96%E6%8A%80%E6%9C%AF">å®ç°ä¼˜åŒ–æŠ€æœ¯</a></li><li><a href="#6-hdfs%E4%B8%AD%E7%9A%84crc-32%E5%BA%94%E7%94%A8">HDFSä¸­çš„CRC-32åº”ç”¨</a></li><li><a href="#7-%E6%80%BB%E7%BB%93%E4%B8%8E%E5%B1%95%E6%9C%9B">æ€»ç»“ä¸å±•æœ›</a></li></ol><hr><h2 id="1-CRC-32æ¦‚è¿°"><a href="#1-CRC-32æ¦‚è¿°" class="headerlink" title="1. CRC-32æ¦‚è¿°"></a>1. CRC-32æ¦‚è¿°</h2><h3 id="1-1-ä»€ä¹ˆæ˜¯CRC-32"><a href="#1-1-ä»€ä¹ˆæ˜¯CRC-32" class="headerlink" title="1.1 ä»€ä¹ˆæ˜¯CRC-32"></a>1.1 ä»€ä¹ˆæ˜¯CRC-32</h3><p>CRC-32ï¼ˆCyclic Redundancy Checkï¼Œå¾ªç¯å†—ä½™æ ¡éªŒï¼‰æ˜¯ä¸€ç§å¹¿æ³›ä½¿ç”¨çš„é”™è¯¯æ£€æµ‹ç®—æ³•ã€‚å®ƒé€šè¿‡å¯¹æ•°æ®è¿›è¡Œå¤šé¡¹å¼é™¤æ³•è¿ç®—ï¼Œç”Ÿæˆä¸€ä¸ª32ä½çš„æ ¡éªŒå€¼ï¼Œç”¨äºæ£€æµ‹æ•°æ®åœ¨ä¼ è¾“æˆ–å­˜å‚¨è¿‡ç¨‹ä¸­æ˜¯å¦å‘ç”Ÿé”™è¯¯ã€‚</p><h3 id="1-2-CRC-32çš„ä¸»è¦ç‰¹æ€§"><a href="#1-2-CRC-32çš„ä¸»è¦ç‰¹æ€§" class="headerlink" title="1.2 CRC-32çš„ä¸»è¦ç‰¹æ€§"></a>1.2 CRC-32çš„ä¸»è¦ç‰¹æ€§</h3><ul><li><p><strong>é”™è¯¯æ£€æµ‹èƒ½åŠ›å¼º</strong>ï¼š</p><ul><li>å¯ä»¥æ£€æµ‹æ‰€æœ‰å•æ¯”ç‰¹é”™è¯¯</li><li>å¯ä»¥æ£€æµ‹æ‰€æœ‰åŒæ¯”ç‰¹é”™è¯¯</li><li>å¯ä»¥æ£€æµ‹æ‰€æœ‰å¥‡æ•°ä¸ªæ¯”ç‰¹é”™è¯¯</li><li>å¯ä»¥æ£€æµ‹æ‰€æœ‰é•¿åº¦â‰¤32ä½çš„çªå‘é”™è¯¯</li><li>å¯ä»¥æ£€æµ‹99.9999997%çš„é•¿åº¦&gt;32ä½çš„çªå‘é”™è¯¯</li></ul></li><li><p><strong>è®¡ç®—æ•ˆç‡é«˜</strong>ï¼š</p><ul><li>æ”¯æŒç¡¬ä»¶åŠ é€Ÿï¼ˆSSE4.2æŒ‡ä»¤é›†ï¼‰</li><li>å¯ä»¥ä½¿ç”¨æŸ¥è¡¨æ³•ä¼˜åŒ–</li><li>æ”¯æŒå¹¶è¡Œè®¡ç®—å’Œå¢é‡è®¡ç®—</li></ul></li><li><p><strong>åº”ç”¨å¹¿æ³›</strong>ï¼š</p><ul><li>ç½‘ç»œé€šä¿¡ï¼ˆä»¥å¤ªç½‘ã€WiFiï¼‰</li><li>å­˜å‚¨ç³»ç»Ÿï¼ˆHDFSã€ZFSï¼‰</li><li>æ–‡ä»¶å‹ç¼©ï¼ˆZIPã€PNGï¼‰</li><li>æ•°æ®æ ¡éªŒï¼ˆå„ç§åè®®å’Œæ ¼å¼ï¼‰</li></ul></li></ul><h3 id="1-3-CRC-32çš„å˜ä½“"><a href="#1-3-CRC-32çš„å˜ä½“" class="headerlink" title="1.3 CRC-32çš„å˜ä½“"></a>1.3 CRC-32çš„å˜ä½“</h3><p>ä¸»è¦æœ‰ä¸¤ç§å¸¸ç”¨çš„CRC-32å˜ä½“ï¼š</p><ol><li><p><strong>CRC-32ï¼ˆIEEE 802.3ï¼‰</strong></p><ul><li>å¤šé¡¹å¼ï¼š0x04C11DB7</li><li>ä¹Ÿç§°ä¸ºCRC-32-IEEEæˆ–æ ‡å‡†CRC-32</li></ul></li><li><p><strong>CRC-32Cï¼ˆCastagnoliï¼‰</strong></p><ul><li>å¤šé¡¹å¼ï¼š0x1EDC6F41</li><li>å…·æœ‰æ›´å¥½çš„é”™è¯¯æ£€æµ‹æ€§èƒ½</li><li>æ”¯æŒç¡¬ä»¶åŠ é€Ÿï¼ˆSSE4.2ï¼‰</li><li>HDFSç­‰ç°ä»£ç³»ç»Ÿçš„é¦–é€‰</li></ul></li></ol><hr><h2 id="2-æ•°å­¦åŸºç¡€ï¼šäºŒè¿›åˆ¶ä¸å¤šé¡¹å¼"><a href="#2-æ•°å­¦åŸºç¡€ï¼šäºŒè¿›åˆ¶ä¸å¤šé¡¹å¼" class="headerlink" title="2. æ•°å­¦åŸºç¡€ï¼šäºŒè¿›åˆ¶ä¸å¤šé¡¹å¼"></a>2. æ•°å­¦åŸºç¡€ï¼šäºŒè¿›åˆ¶ä¸å¤šé¡¹å¼</h2><h3 id="2-1-ä¸ºä»€ä¹ˆè¦ç”¨å¤šé¡¹å¼è¡¨ç¤º"><a href="#2-1-ä¸ºä»€ä¹ˆè¦ç”¨å¤šé¡¹å¼è¡¨ç¤º" class="headerlink" title="2.1 ä¸ºä»€ä¹ˆè¦ç”¨å¤šé¡¹å¼è¡¨ç¤º"></a>2.1 ä¸ºä»€ä¹ˆè¦ç”¨å¤šé¡¹å¼è¡¨ç¤º</h3><p>CRCç®—æ³•åŸºäºæœ‰é™åŸŸGF(2)ä¸Šçš„å¤šé¡¹å¼ç®—æœ¯ã€‚åœ¨è¿™ä¸ªæ•°å­¦ä½“ç³»ä¸­ï¼š</p><ul><li>ç³»æ•°åªèƒ½æ˜¯0æˆ–1</li><li>åŠ æ³•å’Œå‡æ³•éƒ½ç­‰åŒäºå¼‚æˆ–ï¼ˆXORï¼‰è¿ç®—</li><li>æ²¡æœ‰è¿›ä½å’Œå€Ÿä½</li></ul><p>è¿™ç§è¡¨ç¤ºæ–¹æ³•ä½¿å¾—å¤æ‚çš„é”™è¯¯æ£€æµ‹ç®—æ³•å¯ä»¥ç”¨ç®€å•çš„ä½è¿ç®—å®ç°ã€‚</p><h3 id="2-2-äºŒè¿›åˆ¶åˆ°å¤šé¡¹å¼çš„è½¬æ¢è§„åˆ™"><a href="#2-2-äºŒè¿›åˆ¶åˆ°å¤šé¡¹å¼çš„è½¬æ¢è§„åˆ™" class="headerlink" title="2.2 äºŒè¿›åˆ¶åˆ°å¤šé¡¹å¼çš„è½¬æ¢è§„åˆ™"></a>2.2 äºŒè¿›åˆ¶åˆ°å¤šé¡¹å¼çš„è½¬æ¢è§„åˆ™</h3><h4 id="è½¬æ¢è§„åˆ™"><a href="#è½¬æ¢è§„åˆ™" class="headerlink" title="è½¬æ¢è§„åˆ™"></a>è½¬æ¢è§„åˆ™</h4><ul><li><strong>ä½ç¼–å·</strong>ï¼šä»å³åˆ°å·¦ï¼Œä»0å¼€å§‹</li><li><strong>è½¬æ¢åŸåˆ™</strong>ï¼šå¦‚æœç¬¬nä½æ˜¯1ï¼Œåˆ™å¤šé¡¹å¼åŒ…å«x^né¡¹</li></ul><h4 id="ç¤ºä¾‹è§£æ"><a href="#ç¤ºä¾‹è§£æ" class="headerlink" title="ç¤ºä¾‹è§£æ"></a>ç¤ºä¾‹è§£æ</h4><p>ä»¥äºŒè¿›åˆ¶æ•° <code>10110101</code> ä¸ºä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">äºŒè¿›åˆ¶æ•°æ®: 1  0  1  1  0  1  0  1</span><br><span class="line">ä½ä½ç½®:     7  6  5  4  3  2  1  0  ï¼ˆä»å³å¾€å·¦ï¼‰</span><br><span class="line">            â†“  â†“  â†“  â†“  â†“  â†“  â†“  â†“</span><br><span class="line">å¯¹åº”å¹‚æ¬¡:  xâ· xâ¶ xâµ xâ´ xÂ³ xÂ² xÂ¹ xâ°</span><br><span class="line">æ˜¯å¦åŒ…å«:   âœ“  âœ—  âœ“  âœ“  âœ—  âœ“  âœ—  âœ“</span><br><span class="line"></span><br><span class="line">ç»“æœå¤šé¡¹å¼: xâ· + xâµ + xâ´ + xÂ² + xâ°</span><br></pre></td></tr></table></figure><h4 id="æ›´å¤šç¤ºä¾‹"><a href="#æ›´å¤šç¤ºä¾‹" class="headerlink" title="æ›´å¤šç¤ºä¾‹"></a>æ›´å¤šç¤ºä¾‹</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¤ºä¾‹1ï¼šå…¨1å­—èŠ‚</span></span><br><span class="line"><span class="number">11111111</span> â†’ xâ· + xâ¶ + xâµ + xâ´ + xÂ³ + xÂ² + xÂ¹ + xâ°</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¤ºä¾‹2ï¼š2çš„å¹‚</span></span><br><span class="line"><span class="number">10000000</span> â†’ xâ·</span><br><span class="line">00000001 â†’ xâ° (å³<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¤ºä¾‹3ï¼šäº¤æ›¿ä½</span></span><br><span class="line"><span class="number">10101010</span> â†’ xâ· + xâµ + xÂ³ + xÂ¹</span><br></pre></td></tr></table></figure><h3 id="2-3-å¤šé¡¹å¼è¿ç®—ä¸äºŒè¿›åˆ¶è¿ç®—çš„å¯¹åº”å…³ç³»"><a href="#2-3-å¤šé¡¹å¼è¿ç®—ä¸äºŒè¿›åˆ¶è¿ç®—çš„å¯¹åº”å…³ç³»" class="headerlink" title="2.3 å¤šé¡¹å¼è¿ç®—ä¸äºŒè¿›åˆ¶è¿ç®—çš„å¯¹åº”å…³ç³»"></a>2.3 å¤šé¡¹å¼è¿ç®—ä¸äºŒè¿›åˆ¶è¿ç®—çš„å¯¹åº”å…³ç³»</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  flowchart LR    subgraph &quot;äºŒè¿›åˆ¶è¿ç®—&quot;        A1[&quot;XORè¿ç®—&quot;]         A2[&quot;å·¦ç§»è¿ç®—&quot;]        A3[&quot;å³ç§»è¿ç®—&quot;]    end        subgraph &quot;å¤šé¡¹å¼è¿ç®—&quot;        B1[&quot;å¤šé¡¹å¼åŠ &#x2F;å‡æ³•&quot;]        B2[&quot;ä¹˜ä»¥x&quot;]        B3[&quot;é™¤ä»¥x&quot;]    end        A1 -.-&gt; B1    A2 -.-&gt; B2    A3 -.-&gt; B3  </pre></div><hr><h2 id="3-CRCå¤šé¡¹å¼é™¤æ³•åŸç†"><a href="#3-CRCå¤šé¡¹å¼é™¤æ³•åŸç†" class="headerlink" title="3. CRCå¤šé¡¹å¼é™¤æ³•åŸç†"></a>3. CRCå¤šé¡¹å¼é™¤æ³•åŸç†</h2><h3 id="3-1-CRCçš„æ•°å­¦æ¨¡å‹"><a href="#3-1-CRCçš„æ•°å­¦æ¨¡å‹" class="headerlink" title="3.1 CRCçš„æ•°å­¦æ¨¡å‹"></a>3.1 CRCçš„æ•°å­¦æ¨¡å‹</h3><p>CRCçš„æ ¸å¿ƒæ˜¯è®¡ç®—æ•°æ®çš„å¤šé¡¹å¼é™¤æ³•ä½™æ•°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CRC = (M(x) Ã— x^n) mod G(x)</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼š</p><ul><li>M(x)ï¼šåŸå§‹æ•°æ®çš„å¤šé¡¹å¼è¡¨ç¤º</li><li>G(x)ï¼šç”Ÿæˆå¤šé¡¹å¼</li><li>nï¼šCRCçš„ä½æ•°ï¼ˆå¯¹äºCRC-32ï¼Œn&#x3D;32ï¼‰</li><li>modï¼šå–ä½™è¿ç®—</li></ul><blockquote><p><strong>å…³é”®ç‚¹</strong>ï¼šM(x) Ã— x^n è¡¨ç¤ºå°†åŸå§‹æ•°æ®å·¦ç§»nä½ï¼Œç­‰åŒäºåœ¨æ•°æ®åé™„åŠ nä¸ª0ã€‚è¿™æ˜¯ä¸ºäº†ç»™CRCå€¼é¢„ç•™ç©ºé—´ï¼Œä½¿å¾—æ•°æ®å’ŒCRCå¯ä»¥ä½œä¸ºä¸€ä¸ªæ•´ä½“è¿›è¡ŒéªŒè¯ã€‚</p></blockquote><h3 id="3-2-ç”Ÿæˆå¤šé¡¹å¼è¯¦è§£"><a href="#3-2-ç”Ÿæˆå¤šé¡¹å¼è¯¦è§£" class="headerlink" title="3.2 ç”Ÿæˆå¤šé¡¹å¼è¯¦è§£"></a>3.2 ç”Ÿæˆå¤šé¡¹å¼è¯¦è§£</h3><h4 id="3-2-1-ä»€ä¹ˆæ˜¯ç”Ÿæˆå¤šé¡¹å¼"><a href="#3-2-1-ä»€ä¹ˆæ˜¯ç”Ÿæˆå¤šé¡¹å¼" class="headerlink" title="3.2.1 ä»€ä¹ˆæ˜¯ç”Ÿæˆå¤šé¡¹å¼"></a>3.2.1 ä»€ä¹ˆæ˜¯ç”Ÿæˆå¤šé¡¹å¼</h4><p>ç”Ÿæˆå¤šé¡¹å¼ï¼ˆGenerator Polynomialï¼‰æ˜¯CRCç®—æ³•çš„æ ¸å¿ƒå‚æ•°ï¼Œå®ƒæ˜¯ä¸€ä¸ªé¢„å…ˆå®šä¹‰çš„ã€å›ºå®šçš„å¤šé¡¹å¼ï¼Œç”¨ä½œé™¤æ³•è¿ç®—ä¸­çš„â€é™¤æ•°â€ã€‚ç†è§£ç”Ÿæˆå¤šé¡¹å¼çš„å…³é”®ç‚¹ï¼š</p><ol><li><p><strong>è§’è‰²å®šä½</strong></p><ul><li>ç”Ÿæˆå¤šé¡¹å¼ &#x3D; é™¤æ•°ï¼ˆå›ºå®šä¸å˜ï¼‰</li><li>æ•°æ® &#x3D; è¢«é™¤æ•°ï¼ˆæ¯æ¬¡ä¸åŒï¼‰</li><li>CRCå€¼ &#x3D; ä½™æ•°</li></ul></li><li><p><strong>æ•°å­¦ç‰¹æ€§</strong></p><ul><li>æœ€é«˜ä½å’Œæœ€ä½ä½å¿…é¡»ä¸º1</li><li>ä½æ•°å†³å®šäº†CRCçš„é•¿åº¦ï¼ˆnä½ç”Ÿæˆå¤šé¡¹å¼äº§ç”Ÿn-1ä½CRCï¼‰</li><li>ä¸åŒçš„ç”Ÿæˆå¤šé¡¹å¼å…·æœ‰ä¸åŒçš„é”™è¯¯æ£€æµ‹èƒ½åŠ›</li></ul></li></ol><h4 id="3-2-2-ä¸ºä»€ä¹ˆéœ€è¦ç”Ÿæˆå¤šé¡¹å¼"><a href="#3-2-2-ä¸ºä»€ä¹ˆéœ€è¦ç”Ÿæˆå¤šé¡¹å¼" class="headerlink" title="3.2.2 ä¸ºä»€ä¹ˆéœ€è¦ç”Ÿæˆå¤šé¡¹å¼"></a>3.2.2 ä¸ºä»€ä¹ˆéœ€è¦ç”Ÿæˆå¤šé¡¹å¼</h4><p>ç”Ÿæˆå¤šé¡¹å¼çš„é€‰æ‹©ç›´æ¥å½±å“CRCçš„é”™è¯¯æ£€æµ‹èƒ½åŠ›ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ç±»æ¯”ç†è§£ï¼š</span><br><span class="line">- ä½¿ç”¨è´¨æ•°7ä½œé™¤æ•°ï¼š13 mod 7 = 6, 20 mod 7 = 6ï¼ˆå¯èƒ½ç¢°æ’ï¼‰</span><br><span class="line">- ä½¿ç”¨è´¨æ•°11ä½œé™¤æ•°ï¼š13 mod 11 = 2, 20 mod 11 = 9ï¼ˆä¸åŒä½™æ•°ï¼‰</span><br><span class="line"></span><br><span class="line">ä¸åŒçš„é™¤æ•°ï¼ˆç”Ÿæˆå¤šé¡¹å¼ï¼‰ä¼šäº§ç”Ÿä¸åŒçš„é”™è¯¯æ£€æµ‹ç‰¹æ€§</span><br></pre></td></tr></table></figure><h4 id="3-2-3-å¸¸è§çš„ç”Ÿæˆå¤šé¡¹å¼"><a href="#3-2-3-å¸¸è§çš„ç”Ÿæˆå¤šé¡¹å¼" class="headerlink" title="3.2.3 å¸¸è§çš„ç”Ÿæˆå¤šé¡¹å¼"></a>3.2.3 å¸¸è§çš„ç”Ÿæˆå¤šé¡¹å¼</h4><p>ä¸åŒçš„CRCæ ‡å‡†ä½¿ç”¨ä¸åŒçš„ç”Ÿæˆå¤šé¡¹å¼ï¼Œè¿™äº›éƒ½æ˜¯ç»è¿‡æ•°å­¦éªŒè¯çš„æœ€ä¼˜é€‰æ‹©ï¼š</p><table><thead><tr><th>CRCç±»å‹</th><th>ç”Ÿæˆå¤šé¡¹å¼ï¼ˆäºŒè¿›åˆ¶ï¼‰</th><th>åå…­è¿›åˆ¶</th><th>å¤šé¡¹å¼è¡¨ç¤º</th></tr></thead><tbody><tr><td>CRC-4</td><td>10011</td><td>0x13</td><td>xâ´ + x + 1</td></tr><tr><td>CRC-8</td><td>100000111</td><td>0x107</td><td>xâ¸ + xÂ² + x + 1</td></tr><tr><td>CRC-16-IBM</td><td>11000000000000101</td><td>0x18005</td><td>xÂ¹â¶ + xÂ¹âµ + xÂ² + 1</td></tr><tr><td>CRC-16-CCITT</td><td>10001000000100001</td><td>0x11021</td><td>xÂ¹â¶ + xÂ¹Â² + xâµ + 1</td></tr><tr><td>CRC-32</td><td>100000100110000010001110110110111</td><td>0x04C11DB7</td><td>xÂ³Â² + xÂ²â¶ + xÂ²Â³ + xÂ²Â² + xÂ¹â¶ + xÂ¹Â² + xÂ¹Â¹ + xÂ¹â° + xâ¸ + xâ· + xâµ + xâ´ + xÂ² + x + 1</td></tr><tr><td>CRC-32C</td><td>11110110111000110111101000000001</td><td>0x1EDC6F41</td><td>xÂ³Â² + xÂ²â¸ + xÂ²â· + xÂ²â¶ + xÂ²âµ + xÂ²Â³ + xÂ²Â² + xÂ²â° + xÂ¹â¹ + xÂ¹â¸ + xÂ¹â´ + xÂ¹Â³ + xÂ¹Â¹ + xÂ¹â° + xâ¹ + xâ¸ + xâ¶ + 1</td></tr></tbody></table><blockquote><p><strong>å¤šé¡¹å¼è¡¨ç¤ºæ³•è¯´æ˜</strong>: ç”Ÿæˆå¤šé¡¹å¼çš„æœ€é«˜æ¬¡å¹‚ï¼ˆä¾‹å¦‚CRC-32ä¸­çš„ <code>xÂ³Â²</code>ï¼‰åœ¨åå…­è¿›åˆ¶è¡¨ç¤ºä¸­æ˜¯éšå«çš„ã€‚<code>0x04C11DB7</code> å®é™…ä¸Šæ˜¯ä¸€ä¸ª32ä½çš„æ•°å­—ï¼Œä»£è¡¨äº†ä» <code>xÂ³Â¹</code>åˆ° <code>xâ°</code> çš„ç³»æ•°ã€‚å› æ­¤ï¼Œä¸€ä¸ªnä½çš„CRCç®—æ³•ä½¿ç”¨çš„ç”Ÿæˆå¤šé¡¹å¼ï¼Œå…¶æœ€é«˜æ¬¡å¹‚ä¸ºnã€‚</p></blockquote><h4 id="3-2-4-ç”Ÿæˆå¤šé¡¹å¼çš„é€‰æ‹©æ ‡å‡†"><a href="#3-2-4-ç”Ÿæˆå¤šé¡¹å¼çš„é€‰æ‹©æ ‡å‡†" class="headerlink" title="3.2.4 ç”Ÿæˆå¤šé¡¹å¼çš„é€‰æ‹©æ ‡å‡†"></a>3.2.4 ç”Ÿæˆå¤šé¡¹å¼çš„é€‰æ‹©æ ‡å‡†</h4><p>é€‰æ‹©ç”Ÿæˆå¤šé¡¹å¼æ—¶éœ€è¦è€ƒè™‘ä»¥ä¸‹å› ç´ ï¼š</p><ol><li><p><strong>æ±‰æ˜è·ç¦»ï¼ˆHamming Distanceï¼‰</strong></p><ul><li>å†³å®šäº†èƒ½æ£€æµ‹çš„æœ€å°‘é”™è¯¯ä½æ•°</li><li>CRC-32Cå¯¹äº2974å­—èŠ‚ä»¥ä¸‹çš„æ•°æ®ï¼Œæ±‰æ˜è·ç¦»ä¸º6</li></ul></li><li><p><strong>é”™è¯¯æ£€æµ‹è¦†ç›–ç‡</strong></p><ul><li>æ£€æµ‹çªå‘é”™è¯¯çš„èƒ½åŠ›</li><li>æ£€æµ‹éšæœºé”™è¯¯çš„æ¦‚ç‡</li></ul></li><li><p><strong>è®¡ç®—æ•ˆç‡</strong></p><ul><li>æŸäº›å¤šé¡¹å¼æ”¯æŒç¡¬ä»¶åŠ é€Ÿ</li><li>CRC-32Cè¢«é€‰ä¸­éƒ¨åˆ†åŸå› æ˜¯Intel SSE4.2çš„æ”¯æŒ</li></ul></li></ol><h4 id="3-2-5-ç”Ÿæˆå¤šé¡¹å¼ä¸æ•°æ®çš„å…³ç³»"><a href="#3-2-5-ç”Ÿæˆå¤šé¡¹å¼ä¸æ•°æ®çš„å…³ç³»" class="headerlink" title="3.2.5 ç”Ÿæˆå¤šé¡¹å¼ä¸æ•°æ®çš„å…³ç³»"></a>3.2.5 ç”Ÿæˆå¤šé¡¹å¼ä¸æ•°æ®çš„å…³ç³»</h4><p>é‡è¦æ¦‚å¿µæ¾„æ¸…ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é”™è¯¯ç†è§£</span></span><br><span class="line">æ•°æ® = <span class="number">1101</span> â†’ ç”Ÿæˆå¤šé¡¹å¼ä¹Ÿåº”è¯¥æ˜¯<span class="number">1101</span>ï¼Ÿ âŒ</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ­£ç¡®ç†è§£</span></span><br><span class="line">æ•°æ® = <span class="number">1101</span>ï¼ˆå˜åŒ–çš„è¾“å…¥ï¼‰</span><br><span class="line">ç”Ÿæˆå¤šé¡¹å¼ = <span class="number">1011</span>ï¼ˆå›ºå®šçš„ç®—æ³•å‚æ•°ï¼‰ âœ“</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç±»æ¯”</span></span><br><span class="line">è®¡ç®—å¹³æ–¹æ ¹ï¼š</span><br><span class="line">- æ•°æ® = <span class="number">16</span>ï¼ˆè¦è®¡ç®—å¹³æ–¹æ ¹çš„æ•°ï¼‰</span><br><span class="line">- ç®—æ³• = ç‰›é¡¿è¿­ä»£æ³•ï¼ˆå›ºå®šçš„æ–¹æ³•ï¼‰</span><br><span class="line">- åˆå§‹å€¼ = <span class="number">4</span>ï¼ˆç®—æ³•çš„å‚æ•°ï¼‰</span><br></pre></td></tr></table></figure><h3 id="3-3-å¤šé¡¹å¼é™¤æ³•æ­¥éª¤è¯¦è§£"><a href="#3-3-å¤šé¡¹å¼é™¤æ³•æ­¥éª¤è¯¦è§£" class="headerlink" title="3.3 å¤šé¡¹å¼é™¤æ³•æ­¥éª¤è¯¦è§£"></a>3.3 å¤šé¡¹å¼é™¤æ³•æ­¥éª¤è¯¦è§£</h3><p>è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­ç†è§£CRCé™¤æ³•è¿‡ç¨‹ï¼š</p><p><strong>ç¤ºä¾‹æ•°æ®</strong>ï¼š</p><ul><li>æ•°æ®ï¼š<code>1101</code>ï¼ˆäºŒè¿›åˆ¶ï¼‰</li><li>ç”Ÿæˆå¤šé¡¹å¼ï¼š<code>1011</code>ï¼ˆxÂ³ + xÂ¹ + xâ°ï¼‰</li><li>é™„åŠ é›¶åï¼š<code>1101000</code></li></ul><blockquote><p><strong>æ³¨æ„</strong>ï¼šè¿™é‡Œçš„ç”Ÿæˆå¤šé¡¹å¼<code>1011</code>æ˜¯ä¸ºäº†æ¼”ç¤ºè€Œé€‰æ‹©çš„ä¸€ä¸ªç®€å•4ä½å¤šé¡¹å¼ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œç”Ÿæˆå¤šé¡¹å¼æ˜¯é¢„å…ˆå®šä¹‰çš„æ ‡å‡†å€¼ï¼ˆå¦‚CRC-32Cä½¿ç”¨0x1EDC6F41ï¼‰ã€‚æ•°æ®å’Œç”Ÿæˆå¤šé¡¹å¼æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„å‚æ•°ï¼Œæ²¡æœ‰å¿…ç„¶è”ç³»ã€‚</p></blockquote><h4 id="ä¸ºä»€ä¹ˆè¦é™„åŠ é›¶ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆè¦é™„åŠ é›¶ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆè¦é™„åŠ é›¶ï¼Ÿ"></a>ä¸ºä»€ä¹ˆè¦é™„åŠ é›¶ï¼Ÿ</h4><p>åœ¨CRCè®¡ç®—ä¸­é™„åŠ é›¶æ˜¯ä¸€ä¸ªå…³é”®æ­¥éª¤ï¼Œå…¶åŸå› å¦‚ä¸‹ï¼š</p><ol><li><p><strong>æ•°å­¦åŸç†</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CRCçš„å®šä¹‰ï¼šCRC = (M(x) Ã— x^n) mod G(x)</span><br><span class="line"></span><br><span class="line">å…¶ä¸­ï¼š</span><br><span class="line">- M(x) Ã— x^n ç›¸å½“äºå°†æ•°æ®å·¦ç§»nä½</span><br><span class="line">- næ˜¯CRCçš„ä½æ•°ï¼ˆç”Ÿæˆå¤šé¡¹å¼ä½æ•°-1ï¼‰</span><br><span class="line">- åœ¨äºŒè¿›åˆ¶ä¸­ï¼Œå·¦ç§»nä½ç­‰åŒäºé™„åŠ nä¸ª0</span><br></pre></td></tr></table></figure></li><li><p><strong>ä¸ºCRCé¢„ç•™ç©ºé—´</strong></p>   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">åŸå§‹æ•°æ®ï¼š    1101</span><br><span class="line">é™„åŠ 3ä¸ªé›¶ï¼š   1101000</span><br><span class="line">                 â†‘</span><br><span class="line">                 é¢„ç•™ç»™3ä½CRCçš„ç©ºé—´</span><br><span class="line"></span><br><span class="line">æœ€ç»ˆä¼ è¾“ï¼š    1101[CRC]</span><br></pre></td></tr></table></figure></li><li><p><strong>ç¡®ä¿é™¤æ³•çš„æ­£ç¡®æ€§</strong></p></li></ol><ul><li>ä¸é™„åŠ é›¶ï¼šç›¸å½“äºè®¡ç®— M(x) mod G(x)ï¼Œä¼šä¸¢å¤±ä½ä½ä¿¡æ¯</li><li>é™„åŠ é›¶åï¼šè®¡ç®— (M(x) Ã— x^n) mod G(x)ï¼Œä¿ç•™æ‰€æœ‰ä¿¡æ¯</li></ul><ol start="4"><li><p><strong>å®é™…ä¾‹å­å¯¹æ¯”</strong></p>   <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸é™„åŠ é›¶ï¼ˆé”™è¯¯åšæ³•ï¼‰</span></span><br><span class="line"><span class="number">1101</span> Ã· <span class="number">1011</span> = <span class="number">1</span> ä½™ <span class="number">00</span>10</span><br><span class="line"></span><br><span class="line"><span class="comment"># é™„åŠ é›¶ï¼ˆæ­£ç¡®åšæ³•ï¼‰</span></span><br><span class="line"><span class="number">1101000</span> Ã· <span class="number">1011</span> = <span class="number">1110</span> ä½™ <span class="number">0</span>101</span><br><span class="line"></span><br><span class="line"><span class="comment"># CRC = 101ï¼Œå¯ä»¥é™„åŠ åˆ°åŸå§‹æ•°æ®åï¼š1101101</span></span><br></pre></td></tr></table></figure></li><li><p><strong>éªŒè¯æ—¶çš„ä½œç”¨</strong></p>   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">æ¥æ”¶æ–¹æ”¶åˆ°ï¼š1101101</span><br><span class="line">éªŒè¯ï¼š1101101 Ã· 1011 = å•† ä½™ 0</span><br><span class="line">ä½™æ•°ä¸º0è¡¨ç¤ºæ•°æ®æ­£ç¡®</span><br></pre></td></tr></table></figure></li></ol><p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨æ‰€æœ‰CRCè®¡ç®—ä¸­éƒ½éœ€è¦å…ˆé™„åŠ ç›¸åº”ä½æ•°çš„é›¶ã€‚å¯¹äºCRC-32ï¼Œéœ€è¦é™„åŠ 32ä¸ªé›¶ï¼›å¯¹äºCRC-16ï¼Œéœ€è¦é™„åŠ 16ä¸ªé›¶ã€‚</p><h4 id="è¯¦ç»†é™¤æ³•è¿‡ç¨‹"><a href="#è¯¦ç»†é™¤æ³•è¿‡ç¨‹" class="headerlink" title="è¯¦ç»†é™¤æ³•è¿‡ç¨‹"></a>è¯¦ç»†é™¤æ³•è¿‡ç¨‹</h4><p>ä»¥ä¸‹æ˜¯æ¨¡2é™¤æ³•ï¼ˆXORé™¤æ³•ï¼‰çš„è¯¦ç»†æ­¥éª¤ã€‚å…³é”®åœ¨äºï¼š<strong>å¯¹é½ã€å¼‚æˆ–ã€ç§»ä½</strong>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">      1110  &lt;-- å•† (å•†åœ¨CRCè®¡ç®—ä¸­ä¸é‡è¦)</span><br><span class="line">    ________</span><br><span class="line">1011|1101000  &lt;-- è¢«é™¤æ•° (æ•°æ® + é™„åŠ çš„é›¶)</span><br><span class="line">    ^1011      &lt;-- ç¬¬ä¸€æ¬¡XOR: 1101 XOR 1011</span><br><span class="line">    ----</span><br><span class="line">     01100     &lt;-- ç»“æœ, å¹¶å¸¦ä¸‹ä¸€ä½</span><br><span class="line">      ^1011    &lt;-- æœ€é«˜ä½æ˜¯1, ä½†110å°äº1011, æ‰€ä»¥å®é™…æ˜¯ä¸0000å¼‚æˆ–, ç„¶åç§»ä½</span><br><span class="line">                 ç›´åˆ°çª—å£æ•°æ®&#x27;1100&#x27;çš„æœ€é«˜ä½æ˜¯1</span><br><span class="line">       ^1011   &lt;-- ç§»ä½ç›´åˆ°æ•°æ®å˜ä¸º1100, 1100 XOR 1011</span><br><span class="line">       ----</span><br><span class="line">        01110  &lt;-- ç»“æœ, å¹¶å¸¦ä¸‹ä¸€ä½</span><br><span class="line">         ^1011 &lt;-- ç§»ä½ç›´åˆ°æ•°æ®å˜ä¸º1110, 1110 XOR 1011</span><br><span class="line">         ----</span><br><span class="line">          0101 &lt;-- æœ€ç»ˆä½™æ•° (CRCå€¼)</span><br></pre></td></tr></table></figure><p><strong>æ­¥éª¤åˆ†è§£:</strong></p><ol><li><p><strong>å¯¹é½</strong>: å°†é™¤æ•°<code>1011</code>ä¸è¢«é™¤æ•°<code>1101000</code>çš„æœ€é«˜ä½å¯¹é½ã€‚</p><ul><li><code>1101000</code></li><li><code>1011</code></li></ul></li><li><p><strong>ç¬¬ä¸€æ¬¡XOR</strong>: æ‰§è¡ŒXORè¿ç®—ã€‚</p><ul><li><code>1101 XOR 1011 = 0110</code></li></ul></li><li><p><strong>ç§»ä½å¹¶å¸¦å…¥æ–°ä½</strong>: å°†ç»“æœ<code>0110</code>ä¸è¢«é™¤æ•°çš„ä¸‹ä¸€ä½<code>0</code>ç»„åˆï¼Œå½¢æˆæ–°çš„å¤„ç†çª—å£<code>1100</code>ã€‚(å‰é¢çš„0è¢«å¿½ç•¥ï¼Œæˆ‘ä»¬æ€»æ˜¯å¤„ç†ä¸é™¤æ•°ç­‰å®½çš„çª—å£)ã€‚</p><ul><li>å½“å‰çŠ¶æ€: <code>(0)110000</code></li><li>å¤„ç†çª—å£: <code>1100</code></li></ul></li><li><p><strong>ç¬¬äºŒæ¬¡XOR</strong>: çª—å£<code>1100</code>çš„æœ€é«˜ä½æ˜¯1ï¼Œæ‰€ä»¥æ‰§è¡ŒXORã€‚</p><ul><li><code>1100 XOR 1011 = 0111</code></li></ul></li><li><p><strong>ç§»ä½å¹¶å¸¦å…¥æ–°ä½</strong>: å°†ç»“æœ<code>0111</code>ä¸ä¸‹ä¸€ä½<code>0</code>ç»„åˆï¼Œå½¢æˆ<code>1110</code>ã€‚</p><ul><li>å½“å‰çŠ¶æ€: <code>(00)11100</code></li><li>å¤„ç†çª—å£: <code>1110</code></li></ul></li><li><p><strong>ç¬¬ä¸‰æ¬¡XOR</strong>: çª—å£<code>1110</code>çš„æœ€é«˜ä½æ˜¯1ï¼Œæ‰€ä»¥æ‰§è¡ŒXORã€‚</p><ul><li><code>1110 XOR 1011 = 0101</code></li></ul></li><li><p><strong>ç»“æŸ</strong>: æ‰€æœ‰æ•°æ®ä½éƒ½å·²å¤„ç†å®Œæ¯•ã€‚æœ€ç»ˆçš„ä½™æ•°æ˜¯<code>0101</code>ã€‚è¿™å°±æ˜¯3ä½çš„CRCæ ¡éªŒç ã€‚</p></li></ol><blockquote><p><strong>æ ¸å¿ƒè§„åˆ™</strong>: åªè¦å¤„ç†çª—å£çš„æœ€é«˜ä½æ˜¯1ï¼Œå°±æ‰§è¡ŒXORï¼›å¦‚æœæ˜¯0ï¼Œåˆ™ç­‰åŒäºå’Œ<code>0000</code>åšXORï¼Œç»“æœä¸å˜ï¼Œåªéœ€å·¦ç§»ä¸€ä½ï¼Œå¸¦å…¥ä¸‹ä¸€ä½æ•°æ®å³å¯ã€‚</p></blockquote><h3 id="3-4-é™¤æ³•è§„åˆ™æ€»ç»“"><a href="#3-4-é™¤æ³•è§„åˆ™æ€»ç»“" class="headerlink" title="3.4 é™¤æ³•è§„åˆ™æ€»ç»“"></a>3.4 é™¤æ³•è§„åˆ™æ€»ç»“</h3><ol><li><strong>å¯¹é½æ‰§è¡ŒXOR</strong>ï¼šå°†ç”Ÿæˆå¤šé¡¹å¼ä¸å½“å‰æ•°æ®çª—å£çš„æœ€é«˜ä½å¯¹é½ï¼Œå¦‚æœçª—å£æœ€é«˜ä½ä¸º1ï¼Œåˆ™æ‰§è¡ŒXORè¿ç®—ã€‚</li><li><strong>ä½¿ç”¨XORä»£æ›¿å‡æ³•</strong>ï¼šåœ¨GF(2)åŸŸä¸­ï¼Œå‡æ³•ç­‰åŒäºXORï¼Œæ²¡æœ‰è¿›ä½å’Œå€Ÿä½ã€‚</li><li><strong>é€ä½å¤„ç†</strong>ï¼šæ¯æ¬¡å¤„ç†åï¼Œçª—å£å‘å³ï¼ˆæˆ–æ•°æ®å‘å·¦ï¼‰ç§»åŠ¨ä¸€ä½ï¼Œçº³å…¥æ–°çš„æ•°æ®ä½ã€‚</li><li><strong>ä½™æ•°å³CRC</strong>ï¼šå½“æ‰€æœ‰æ•°æ®ä½éƒ½å¤„ç†å®Œæ¯•åï¼Œå¯„å­˜å™¨ä¸­å‰©ä¸‹çš„å€¼å°±æ˜¯æœ€ç»ˆçš„ä½™æ•°ï¼Œå³CRCå€¼ã€‚</li></ol><hr><h2 id="4-CRC-32è®¡ç®—è¿‡ç¨‹è¯¦è§£"><a href="#4-CRC-32è®¡ç®—è¿‡ç¨‹è¯¦è§£" class="headerlink" title="4. CRC-32è®¡ç®—è¿‡ç¨‹è¯¦è§£"></a>4. CRC-32è®¡ç®—è¿‡ç¨‹è¯¦è§£</h2><h3 id="4-1-CRC-32Cçš„å‚æ•°"><a href="#4-1-CRC-32Cçš„å‚æ•°" class="headerlink" title="4.1 CRC-32Cçš„å‚æ•°"></a>4.1 CRC-32Cçš„å‚æ•°</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ç”Ÿæˆå¤šé¡¹å¼: 0x1EDC6F41</span><br><span class="line">åˆå§‹å€¼: 0xFFFFFFFF</span><br><span class="line">æœ€ç»ˆå¼‚æˆ–å€¼: 0xFFFFFFFF</span><br><span class="line">è¾“å…¥åè½¬: æ˜¯</span><br><span class="line">è¾“å‡ºåè½¬: æ˜¯</span><br></pre></td></tr></table></figure><h4 id="4-1-1-å‚æ•°è¯¦è§£"><a href="#4-1-1-å‚æ•°è¯¦è§£" class="headerlink" title="4.1.1 å‚æ•°è¯¦è§£"></a>4.1.1 å‚æ•°è¯¦è§£</h4><ul><li><p><strong>ç”Ÿæˆå¤šé¡¹å¼ (Generator Polynomial)</strong>: è¿™æ˜¯CRCç®—æ³•çš„æ ¸å¿ƒï¼Œå†³å®šäº†å…¶é”™è¯¯æ£€æµ‹èƒ½åŠ›ã€‚CRC-32Cä½¿ç”¨çš„<code>0x1EDC6F41</code>åœ¨æ•°å­¦ä¸Šè¢«è¯æ˜å…·æœ‰ä¼˜ç§€çš„æ€§èƒ½ï¼Œå¹¶å¾—åˆ°äº†ç¡¬ä»¶ï¼ˆSSE4.2æŒ‡ä»¤é›†ï¼‰çš„æ”¯æŒã€‚</p></li><li><p><strong>åˆå§‹å€¼ (Initial Value)</strong>: CRCè®¡ç®—å¯„å­˜å™¨çš„èµ·å§‹å€¼ã€‚é€šå¸¸è®¾ä¸ºå…¨1ï¼ˆ<code>0xFFFFFFFF</code>ï¼‰ï¼Œè¿™å¯ä»¥é¿å…å…¨é›¶æ•°æ®å—è®¡ç®—å‡ºçš„CRCå€¼ä¸ºé›¶çš„æƒ…å†µï¼Œå¢å¼ºäº†å¯¹åŒ…å«å¤§é‡è¿ç»­é›¶çš„æ•°æ®çš„æ£€æµ‹èƒ½åŠ›ã€‚</p></li><li><p><strong>æœ€ç»ˆå¼‚æˆ–å€¼ (Final XOR Value)</strong>: åœ¨è®¡ç®—å®Œæˆåï¼ŒCRCç»“æœä¼šä¸è¿™ä¸ªå€¼è¿›è¡ŒXORæ“ä½œã€‚è¿™æ ·åšå¯ä»¥é˜²æ­¢æŸäº›ç®€å•çš„ã€å¯é¢„æµ‹çš„æ•°æ®æ¨¡å¼ï¼ˆä¾‹å¦‚ï¼Œåœ¨æ•°æ®æœ«å°¾é™„åŠ é›¶ï¼‰ä¸ä¼šå¯¼è‡´CRCå€¼å‘ç”Ÿå¯é¢„æµ‹çš„å˜åŒ–ã€‚å¯¹äºCRC-32Cï¼Œè¿™ä¸ªå€¼ä¹Ÿæ˜¯<code>0xFFFFFFFF</code>ã€‚</p></li><li><p><strong>è¾“å…¥&#x2F;è¾“å‡ºåè½¬ (Input&#x2F;Output Reflection)</strong>: è¿™æ˜¯ä¸€ä¸ªéå¸¸å…³é”®ä½†å®¹æ˜“æ··æ·†çš„å‚æ•°ã€‚</p><ul><li><strong>è¾“å…¥åè½¬</strong>: æŒ‡åœ¨å¤„ç†æ¯ä¸ªè¾“å…¥å­—èŠ‚æ—¶ï¼Œå…¶æ¯”ç‰¹ä½é¡ºåºæ˜¯å¦éœ€è¦é¢ å€’ã€‚ä¾‹å¦‚ï¼Œå­—èŠ‚<code>0x41</code> (äºŒè¿›åˆ¶ <code>01000001</code>) å¦‚æœéœ€è¦è¾“å…¥åè½¬ï¼Œä¼šå˜æˆ <code>10000010</code> (åå…­è¿›åˆ¶ <code>0x82</code>) å†å‚ä¸è¿ç®—ã€‚</li><li><strong>è¾“å‡ºåè½¬</strong>: æŒ‡åœ¨æ‰€æœ‰è®¡ç®—å®Œæˆåï¼Œæœ€ç»ˆçš„CRCç»“æœæ˜¯å¦éœ€è¦è¿›è¡Œæ¯”ç‰¹ä½åè½¬ã€‚</li><li><strong>ä¸ºä»€ä¹ˆéœ€è¦åè½¬ï¼Ÿ</strong>: åè½¬é€šå¸¸æ˜¯ä¸ºäº†åŒ¹é…æŸäº›å†å²å®ç°æˆ–ç¡¬ä»¶å¤„ç†æ•°æ®çš„æ–¹å¼ï¼ˆä¾‹å¦‚ï¼Œæœ€ä½æœ‰æ•ˆä½ä¼˜å…ˆ LSB-firstï¼‰ã€‚CRC-32å’ŒCRC-32Cæ ‡å‡†éƒ½è¦æ±‚å¯¹è¾“å…¥å’Œè¾“å‡ºè¿›è¡Œåè½¬ã€‚</li></ul></li></ul><h3 id="4-2-åŸºæœ¬è®¡ç®—æµç¨‹"><a href="#4-2-åŸºæœ¬è®¡ç®—æµç¨‹" class="headerlink" title="4.2 åŸºæœ¬è®¡ç®—æµç¨‹"></a>4.2 åŸºæœ¬è®¡ç®—æµç¨‹</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  flowchart TD    A[&quot;è¾“å…¥æ•°æ®&quot;] --&gt; B[&quot;åˆå§‹åŒ–CRC&#x3D;0xFFFFFFFF&quot;]    B --&gt; C[&quot;è¯»å–ä¸€ä¸ªå­—èŠ‚&quot;]    C --&gt; D{&quot;è¿˜æœ‰æ•°æ®?&quot;}    D --&gt;|æ˜¯| E[&quot;å­—èŠ‚ä¸CRCé«˜8ä½XOR&quot;]    E --&gt; F[&quot;8æ¬¡ä½å¤„ç†å¾ªç¯&quot;]    F --&gt; G{&quot;æœ€é«˜ä½&#x3D;1?&quot;}    G --&gt;|æ˜¯| H[&quot;å·¦ç§»1ä½åä¸å¤šé¡¹å¼XOR&quot;]    G --&gt;|å¦| I[&quot;ä»…å·¦ç§»1ä½&quot;]    H --&gt; J[&quot;ç»§ç»­ä¸‹ä¸€ä½&quot;]    I --&gt; J    J --&gt; K{&quot;8ä½å¤„ç†å®Œ?&quot;}    K --&gt;|å¦| G    K --&gt;|æ˜¯| C    D --&gt;|å¦| L[&quot;CRCå–å&quot;]    L --&gt; M[&quot;è¾“å‡ºæœ€ç»ˆCRC-32å€¼&quot;]  </pre></div><h3 id="4-3-è¯¦ç»†è®¡ç®—ç¤ºä¾‹"><a href="#4-3-è¯¦ç»†è®¡ç®—ç¤ºä¾‹" class="headerlink" title="4.3 è¯¦ç»†è®¡ç®—ç¤ºä¾‹"></a>4.3 è¯¦ç»†è®¡ç®—ç¤ºä¾‹</h3><p>ä»¥è®¡ç®—å­—ç¬¦ä¸² â€œAâ€ï¼ˆASCIIå€¼0x41ï¼‰çš„CRC-32Cä¸ºä¾‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ­¥éª¤1ï¼šåˆå§‹åŒ–</span></span><br><span class="line">CRC = <span class="number">0xFFFFFFFF</span></span><br><span class="line">è¾“å…¥å­—èŠ‚ = <span class="number">0x41</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ­¥éª¤2ï¼šå­—èŠ‚ä¸CRCé«˜8ä½å¼‚æˆ–</span></span><br><span class="line">CRC = <span class="number">0xFFFFFFFF</span></span><br><span class="line">é«˜<span class="number">8</span>ä½ = <span class="number">0xFF</span></span><br><span class="line">CRC = (CRC &amp; <span class="number">0x00FFFFFF</span>) | ((<span class="number">0xFF</span> ^ <span class="number">0x41</span>) &lt;&lt; <span class="number">24</span>)</span><br><span class="line">    = <span class="number">0xBEFFFFFF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ­¥éª¤3ï¼š8æ¬¡ä½å¤„ç†</span></span><br><span class="line">ä½<span class="number">1</span>: <span class="number">0xBEFFFFFF</span>ï¼Œæœ€é«˜ä½=<span class="number">1</span></span><br><span class="line">     CRC = (<span class="number">0xBEFFFFFF</span> &lt;&lt; <span class="number">1</span>) ^ <span class="number">0x1EDC6F41</span></span><br><span class="line">     = <span class="number">0x7DFFFFFE</span> ^ <span class="number">0x1EDC6F41</span></span><br><span class="line">     = <span class="number">0x632390BF</span></span><br><span class="line"></span><br><span class="line">ä½<span class="number">2</span>: <span class="number">0x632390BF</span>ï¼Œæœ€é«˜ä½=<span class="number">0</span></span><br><span class="line">     CRC = <span class="number">0x632390BF</span> &lt;&lt; <span class="number">1</span></span><br><span class="line">     = <span class="number">0xC647217E</span></span><br><span class="line"></span><br><span class="line"><span class="meta">... </span>(ç»§ç»­<span class="number">6</span>æ¬¡)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ­¥éª¤4ï¼šæœ€ç»ˆå–å</span></span><br><span class="line">æœ€ç»ˆCRC = è®¡ç®—ç»“æœ ^ <span class="number">0xFFFFFFFF</span></span><br></pre></td></tr></table></figure><h3 id="4-4-å®Œæ•´çš„Pythonå®ç°"><a href="#4-4-å®Œæ•´çš„Pythonå®ç°" class="headerlink" title="4.4 å®Œæ•´çš„Pythonå®ç°"></a>4.4 å®Œæ•´çš„Pythonå®ç°</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CRC32C</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;CRC-32Cå®Œæ•´å®ç°&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    POLY = <span class="number">0x1EDC6F41</span>      <span class="comment"># Castagnoliå¤šé¡¹å¼</span></span><br><span class="line">    INIT = <span class="number">0xFFFFFFFF</span>      <span class="comment"># åˆå§‹å€¼</span></span><br><span class="line">    XOROUT = <span class="number">0xFFFFFFFF</span>    <span class="comment"># æœ€ç»ˆå¼‚æˆ–å€¼</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># ç”ŸæˆæŸ¥æ‰¾è¡¨ç”¨äºä¼˜åŒ–</span></span><br><span class="line">        <span class="variable language_">self</span>.table = <span class="variable language_">self</span>._generate_table()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_generate_table</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;ç”Ÿæˆ256é¡¹çš„æŸ¥æ‰¾è¡¨&quot;&quot;&quot;</span></span><br><span class="line">        table = []</span><br><span class="line">        <span class="keyword">for</span> byte <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">            crc = byte &lt;&lt; <span class="number">24</span></span><br><span class="line">            <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">                <span class="keyword">if</span> crc &amp; <span class="number">0x80000000</span>:</span><br><span class="line">                    crc = ((crc &lt;&lt; <span class="number">1</span>) ^ <span class="variable language_">self</span>.POLY) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    crc = (crc &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">            table.append(crc)</span><br><span class="line">        <span class="keyword">return</span> table</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">compute_bit_by_bit</span>(<span class="params">self, data</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;é€ä½è®¡ç®—ï¼ˆæ•™å­¦ç”¨ï¼Œå±•ç¤ºåŸç†ï¼‰&quot;&quot;&quot;</span></span><br><span class="line">        crc = <span class="variable language_">self</span>.INIT</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> byte <span class="keyword">in</span> data:</span><br><span class="line">            <span class="comment"># å°†å½“å‰å­—èŠ‚ä¸CRCå¯„å­˜å™¨çš„é«˜8ä½å¯¹é½å¹¶è¿›è¡ŒXOR</span></span><br><span class="line">            <span class="comment"># byte &lt;&lt; 24 å°†8ä½çš„å­—èŠ‚æ•°æ®ç§»åŠ¨åˆ°32ä½å­—çš„é«˜ä½</span></span><br><span class="line">            crc ^= (byte &lt;&lt; <span class="number">24</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># æ¥ä¸‹æ¥å¯¹è¿™8ä¸ªæ–°ä½ä¸­çš„æ¯ä¸€ä½è¿›è¡Œå¤„ç†</span></span><br><span class="line">            <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">                <span class="keyword">if</span> crc &amp; <span class="number">0x80000000</span>:</span><br><span class="line">                    crc = ((crc &lt;&lt; <span class="number">1</span>) ^ <span class="variable language_">self</span>.POLY) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    crc = (crc &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> crc ^ <span class="variable language_">self</span>.XOROUT</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">compute_table_driven</span>(<span class="params">self, data</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;æŸ¥è¡¨æ³•è®¡ç®—ï¼ˆå®é™…ä½¿ç”¨ï¼‰&quot;&quot;&quot;</span></span><br><span class="line">        crc = <span class="variable language_">self</span>.INIT</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> byte <span class="keyword">in</span> data:</span><br><span class="line">            table_idx = ((crc &gt;&gt; <span class="number">24</span>) ^ byte) &amp; <span class="number">0xFF</span></span><br><span class="line">            crc = ((crc &lt;&lt; <span class="number">8</span>) ^ <span class="variable language_">self</span>.table[table_idx]) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> crc ^ <span class="variable language_">self</span>.XOROUT</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ç¤ºä¾‹</span></span><br><span class="line">crc32c = CRC32C()</span><br><span class="line">data = <span class="string">b&quot;Hello, HDFS!&quot;</span></span><br><span class="line">result = crc32c.compute_table_driven(data)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;CRC-32C: 0x<span class="subst">&#123;result:08X&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><hr><h2 id="5-å®ç°ä¼˜åŒ–æŠ€æœ¯"><a href="#5-å®ç°ä¼˜åŒ–æŠ€æœ¯" class="headerlink" title="5. å®ç°ä¼˜åŒ–æŠ€æœ¯"></a>5. å®ç°ä¼˜åŒ–æŠ€æœ¯</h2><h3 id="5-1-æŸ¥è¡¨æ³•ä¼˜åŒ–"><a href="#5-1-æŸ¥è¡¨æ³•ä¼˜åŒ–" class="headerlink" title="5.1 æŸ¥è¡¨æ³•ä¼˜åŒ–"></a>5.1 æŸ¥è¡¨æ³•ä¼˜åŒ–</h3><p>æŸ¥è¡¨æ³•é€šè¿‡é¢„è®¡ç®—æ‰€æœ‰å¯èƒ½çš„å•å­—èŠ‚CRCå€¼ï¼Œå°†8æ¬¡ä½æ“ä½œç®€åŒ–ä¸ºä¸€æ¬¡æŸ¥è¡¨ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥è¡¨æ³•çš„æ ¸å¿ƒé€»è¾‘</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">crc32c_table_driven</span>(<span class="params">data, table</span>):</span><br><span class="line">    crc = <span class="number">0xFFFFFFFF</span></span><br><span class="line">    <span class="keyword">for</span> byte <span class="keyword">in</span> data:</span><br><span class="line">        index = ((crc &gt;&gt; <span class="number">24</span>) ^ byte) &amp; <span class="number">0xFF</span></span><br><span class="line">        crc = ((crc &lt;&lt; <span class="number">8</span>) ^ table[index]) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    <span class="keyword">return</span> crc ^ <span class="number">0xFFFFFFFF</span></span><br></pre></td></tr></table></figure><p><strong>æ€§èƒ½å¯¹æ¯”</strong>ï¼š</p><ul><li>é€ä½è®¡ç®—ï¼šO(8n) ä½æ“ä½œ</li><li>æŸ¥è¡¨æ³•ï¼šO(n) æŸ¥è¡¨æ“ä½œ</li><li>æå‡çº¦8å€æ€§èƒ½</li></ul><h3 id="5-2-ç¡¬ä»¶åŠ é€Ÿ"><a href="#5-2-ç¡¬ä»¶åŠ é€Ÿ" class="headerlink" title="5.2 ç¡¬ä»¶åŠ é€Ÿ"></a>5.2 ç¡¬ä»¶åŠ é€Ÿ</h3><p>ç°ä»£CPUï¼ˆæ”¯æŒSSE4.2ï¼‰æä¾›ä¸“é—¨çš„CRC32æŒ‡ä»¤ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;nmmintrin.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">crc32c_hardware</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span>* data, <span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">    <span class="type">uint32_t</span> crc = <span class="number">0xFFFFFFFF</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 8å­—èŠ‚å¯¹é½å¤„ç†</span></span><br><span class="line">    <span class="type">size_t</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (; i + <span class="number">8</span> &lt;= len; i += <span class="number">8</span>) &#123;</span><br><span class="line">        crc = _mm_crc32_u64(crc, *(<span class="type">uint64_t</span>*)(data + i));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¤„ç†å‰©ä½™å­—èŠ‚</span></span><br><span class="line">    <span class="keyword">for</span> (; i &lt; len; i++) &#123;</span><br><span class="line">        crc = _mm_crc32_u8(crc, data[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> crc ^ <span class="number">0xFFFFFFFF</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ€§èƒ½æå‡</strong>ï¼šæ¯”æŸ¥è¡¨æ³•å¿«10-20å€</p><h3 id="5-3-CRCç»„åˆæŠ€æœ¯"><a href="#5-3-CRCç»„åˆæŠ€æœ¯" class="headerlink" title="5.3 CRCç»„åˆæŠ€æœ¯"></a>5.3 CRCç»„åˆæŠ€æœ¯</h3><p>CRCçš„ä¸€ä¸ªé‡è¦ç‰¹æ€§æ˜¯å¯ç»„åˆæ€§ï¼Œè¿™åœ¨HDFSä¸­ç‰¹åˆ«æœ‰ç”¨ã€‚è¿™æ„å‘³ç€å¯ä»¥ç‹¬ç«‹è®¡ç®—ä¸¤ä¸ªæ•°æ®å—Aå’ŒBçš„CRCå€¼ï¼Œç„¶åé€šè¿‡ä¸€ä¸ªæ•°å­¦è¿ç®—å°†å®ƒä»¬ç»„åˆæˆæ•°æ®å—A+Bçš„æœ€ç»ˆCRCå€¼ï¼Œè€Œæ— éœ€é‡æ–°æ‰«ææ•´ä¸ªA+Bã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">polynomial_multiply_mod</span>(<span class="params">a, b, poly=<span class="number">0x1EDC6F41</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    åœ¨GF(2)åŸŸä¸Šæ‰§è¡Œå¤šé¡¹å¼ä¹˜æ³•ï¼Œç»“æœæ¨¡é™¤ä»¥polyã€‚</span></span><br><span class="line"><span class="string">    è¿™åœ¨æ™®é€šæ•´æ•°è¿ç®—ä¸­ç­‰ä»·äº (a * b) % polyï¼Œä½†è¿™é‡Œå…¨æ˜¯ä½è¿ç®—ã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    result = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> b &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">if</span> b &amp; <span class="number">1</span>:  <span class="comment"># å¦‚æœbçš„å½“å‰æœ€ä½æœ‰æ•ˆä½æ˜¯1</span></span><br><span class="line">            result ^= a</span><br><span class="line">        </span><br><span class="line">        a &lt;&lt;= <span class="number">1</span>  <span class="comment"># a å·¦ç§»ä¸€ä½ï¼Œç›¸å½“äºä¹˜ä»¥ x</span></span><br><span class="line">        <span class="keyword">if</span> a &amp; (<span class="number">1</span> &lt;&lt; <span class="number">32</span>):  <span class="comment"># å¦‚æœ a çš„ç¬¬32ä½æ˜¯1 (å³æº¢å‡º)</span></span><br><span class="line">            a ^= poly  <span class="comment"># æ‰§è¡Œæ¨¡é™¤ (XOR)</span></span><br><span class="line">        </span><br><span class="line">        b &gt;&gt;= <span class="number">1</span>  <span class="comment"># å¤„ç† b çš„ä¸‹ä¸€ä½</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">compute_power_mod</span>(<span class="params">base, exponent, poly=<span class="number">0x1EDC6F41</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    è®¡ç®— base^exponent mod poly (ä½¿ç”¨å¿«é€Ÿå¹‚ç®—æ³•ï¼Œä¹Ÿå«å¹³æ–¹ä¹˜ç®—æ³•)ã€‚</span></span><br><span class="line"><span class="string">    åœ¨GF(2)åŸŸä¸­ï¼Œbaseä¸º2(å³å¤šé¡¹å¼x)ï¼Œç”¨äºè®¡ç®— x çš„é«˜æ¬¡å¹‚ã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    result = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> exponent &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">if</span> exponent &amp; <span class="number">1</span>:</span><br><span class="line">            result = polynomial_multiply_mod(result, base, poly)</span><br><span class="line">        base = polynomial_multiply_mod(base, base, poly)</span><br><span class="line">        exponent &gt;&gt;= <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">combine_crc32c</span>(<span class="params">crc1, crc2, len2, poly=<span class="number">0x1EDC6F41</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ç»„åˆä¸¤ä¸ªCRC-32Cæ ¡éªŒå’Œã€‚</span></span><br><span class="line"><span class="string">    crc1: ç¬¬ä¸€ä¸ªæ•°æ®å—çš„CRCå€¼ã€‚</span></span><br><span class="line"><span class="string">    crc2: ç¬¬äºŒä¸ªæ•°æ®å—çš„CRCå€¼ã€‚</span></span><br><span class="line"><span class="string">    len2: ç¬¬äºŒä¸ªæ•°æ®å—çš„é•¿åº¦ï¼ˆå­—èŠ‚ï¼‰ã€‚</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    åŸç†: CRC(A || B) = CRC(CRC(A) || B) = CRC(B) âŠ• (CRC(A) Ã— x^(|B|*8) mod G(x))</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># æ³¨æ„: ä¼ å…¥çš„crc1å’Œcrc2åº”è¯¥æ˜¯æœªç»æœ€ç»ˆå¼‚æˆ–çš„åŸå§‹CRCå¯„å­˜å™¨å€¼ã€‚</span></span><br><span class="line">    <span class="comment"># å¦‚æœæ˜¯æœ€ç»ˆå€¼, éœ€è¦å…ˆ `crc_val ^ XOROUT` è½¬æ¢å›æ¥ã€‚</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 1. è®¡ç®— x çš„ (len2 * 8) æ¬¡å¹‚ï¼Œæ¨¡é™¤ä»¥ç”Ÿæˆå¤šé¡¹å¼ã€‚</span></span><br><span class="line">    <span class="comment">#    åŸºæ•°æ˜¯ x, åœ¨GF(2)ä¸­å°±æ˜¯2ã€‚</span></span><br><span class="line">    power_of_x = compute_power_mod(<span class="number">2</span>, len2 * <span class="number">8</span>, poly)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2. å°† crc1 å·¦ç§» len2 * 8 ä½, åŒæ ·æ¨¡é™¤ä»¥ç”Ÿæˆå¤šé¡¹å¼ã€‚</span></span><br><span class="line">    <span class="comment">#    è¿™ç­‰ä»·äº crc1 ä¹˜ä»¥ x^(len2*8)ã€‚</span></span><br><span class="line">    crc1_shifted = polynomial_multiply_mod(crc1, power_of_x, poly)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 3. å°†ç§»ä½åçš„crc1ä¸crc2è¿›è¡Œå¼‚æˆ–ï¼Œå¾—åˆ°æœ€ç»ˆçš„ç»„åˆCRCã€‚</span></span><br><span class="line">    <span class="keyword">return</span> crc2 ^ crc1_shifted</span><br></pre></td></tr></table></figure><hr><h2 id="6-HDFSä¸­çš„CRC-32åº”ç”¨"><a href="#6-HDFSä¸­çš„CRC-32åº”ç”¨" class="headerlink" title="6. HDFSä¸­çš„CRC-32åº”ç”¨"></a>6. HDFSä¸­çš„CRC-32åº”ç”¨</h2><h3 id="6-1-HDFSçš„æ•°æ®å®Œæ•´æ€§æ¶æ„"><a href="#6-1-HDFSçš„æ•°æ®å®Œæ•´æ€§æ¶æ„" class="headerlink" title="6.1 HDFSçš„æ•°æ®å®Œæ•´æ€§æ¶æ„"></a>6.1 HDFSçš„æ•°æ®å®Œæ•´æ€§æ¶æ„</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  flowchart TB    subgraph &quot;HDFSæ•°æ®å®Œæ•´æ€§å±‚æ¬¡&quot;        A[&quot;æ–‡ä»¶çº§CRC&quot;] --&gt; B[&quot;å—çº§CRC&quot;]        B --&gt; C[&quot;Chunkçº§CRC&lt;br&#x2F;&gt;(é»˜è®¤512å­—èŠ‚)&quot;]    end        subgraph &quot;å­˜å‚¨ç»“æ„&quot;        D[&quot;æ•°æ®å—æ–‡ä»¶&lt;br&#x2F;&gt;(blk_xxxxx)&quot;]         E[&quot;å…ƒæ•°æ®æ–‡ä»¶&lt;br&#x2F;&gt;(blk_xxxxx.meta)&quot;]        E -.-&gt;|åŒ…å«CRC| D    end        subgraph &quot;æ ¡éªŒæ—¶æœº&quot;        F[&quot;å†™å…¥æ—¶è®¡ç®—&quot;]        G[&quot;ä¼ è¾“æ—¶éªŒè¯&quot;]        H[&quot;åå°æ‰«æ&quot;]        I[&quot;è¯»å–æ—¶æ ¡éªŒ&quot;]    end  </pre></div><h3 id="6-2-CRCåœ¨HDFSä¸­çš„ä½¿ç”¨åœºæ™¯"><a href="#6-2-CRCåœ¨HDFSä¸­çš„ä½¿ç”¨åœºæ™¯" class="headerlink" title="6.2 CRCåœ¨HDFSä¸­çš„ä½¿ç”¨åœºæ™¯"></a>6.2 CRCåœ¨HDFSä¸­çš„ä½¿ç”¨åœºæ™¯</h3><h4 id="6-2-1-æ•°æ®å†™å…¥æµç¨‹"><a href="#6-2-1-æ•°æ®å†™å…¥æµç¨‹" class="headerlink" title="6.2.1 æ•°æ®å†™å…¥æµç¨‹"></a>6.2.1 æ•°æ®å†™å…¥æµç¨‹</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1. å®¢æˆ·ç«¯è®¡ç®—chunk CRC</span><br><span class="line">   â†“</span><br><span class="line">2. å‘é€æ•°æ®+CRCåˆ°DataNode</span><br><span class="line">   â†“</span><br><span class="line">3. DataNodeéªŒè¯CRC</span><br><span class="line">   â†“</span><br><span class="line">4. å­˜å‚¨æ•°æ®å—å’Œ.metaæ–‡ä»¶</span><br><span class="line">   â†“</span><br><span class="line">5. å®šæœŸåå°éªŒè¯</span><br></pre></td></tr></table></figure><h4 id="6-2-2-æ•°æ®è¯»å–æµç¨‹"><a href="#6-2-2-æ•°æ®è¯»å–æµç¨‹" class="headerlink" title="6.2.2 æ•°æ®è¯»å–æµç¨‹"></a>6.2.2 æ•°æ®è¯»å–æµç¨‹</h4><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  sequenceDiagram    participant Client as å®¢æˆ·ç«¯    participant DN as DataNode    participant Disk as ç£ç›˜        Client-&gt;&gt;DN: è¯·æ±‚è¯»å–æ•°æ®å—    DN-&gt;&gt;Disk: è¯»å–æ•°æ®å’ŒCRC    Disk--&gt;&gt;DN: è¿”å›æ•°æ®+CRC    DN-&gt;&gt;DN: éªŒè¯CRC    alt CRCæ­£ç¡®        DN--&gt;&gt;Client: è¿”å›æ•°æ®+CRC        Client-&gt;&gt;Client: å†æ¬¡éªŒè¯CRC    else CRCé”™è¯¯        DN--&gt;&gt;Client: æŠ¥å‘Šé”™è¯¯        Client-&gt;&gt;Client: å°è¯•å…¶ä»–å‰¯æœ¬    end  </pre></div><h3 id="6-3-HDFSçš„åå°æ‰«ææœºåˆ¶"><a href="#6-3-HDFSçš„åå°æ‰«ææœºåˆ¶" class="headerlink" title="6.3 HDFSçš„åå°æ‰«ææœºåˆ¶"></a>6.3 HDFSçš„åå°æ‰«ææœºåˆ¶</h3><h4 id="6-3-1-Block-Scannerï¼ˆå—æ‰«æå™¨ï¼‰"><a href="#6-3-1-Block-Scannerï¼ˆå—æ‰«æå™¨ï¼‰" class="headerlink" title="6.3.1 Block Scannerï¼ˆå—æ‰«æå™¨ï¼‰"></a>6.3.1 Block Scannerï¼ˆå—æ‰«æå™¨ï¼‰</h4><p><strong>åŠŸèƒ½</strong>ï¼šå®šæœŸæ‰«ææ‰€æœ‰æ•°æ®å—ï¼Œä¸»åŠ¨å‘ç°æŸå</p><p><strong>å·¥ä½œæœºåˆ¶</strong>ï¼š</p><ul><li>ç»´æŠ¤æ­£å¸¸æ‰«æé˜Ÿåˆ—å’Œå¯ç–‘å—é˜Ÿåˆ—</li><li>å¯ç–‘å—ï¼ˆè¯»å–æ—¶å‡ºé”™çš„å—ï¼‰ä¼˜å…ˆæ‰«æ</li><li>é€šè¿‡é™æµé¿å…å½±å“æ­£å¸¸IO</li></ul><p><strong>å…³é”®é…ç½®</strong>ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- hdfs-site.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.block.scanner.volume.bytes.per.second<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>1048576<span class="tag">&lt;/<span class="name">value</span>&gt;</span> <span class="comment">&lt;!-- 1MB/s --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>æ‰«æå¸¦å®½é™åˆ¶<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.datanode.scan.period.hours<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>504<span class="tag">&lt;/<span class="name">value</span>&gt;</span> <span class="comment">&lt;!-- 3å‘¨ --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>å®Œæ•´æ‰«æå‘¨æœŸ<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="6-3-2-Directory-Scannerï¼ˆç›®å½•æ‰«æå™¨ï¼‰"><a href="#6-3-2-Directory-Scannerï¼ˆç›®å½•æ‰«æå™¨ï¼‰" class="headerlink" title="6.3.2 Directory Scannerï¼ˆç›®å½•æ‰«æå™¨ï¼‰"></a>6.3.2 Directory Scannerï¼ˆç›®å½•æ‰«æå™¨ï¼‰</h4><p><strong>åŠŸèƒ½</strong>ï¼šæ£€æŸ¥å†…å­˜ä¸­çš„å—ä¿¡æ¯ä¸ç£ç›˜æ–‡ä»¶çš„ä¸€è‡´æ€§</p><p><strong>æ£€æŸ¥å†…å®¹</strong>ï¼š</p><ul><li>å—æ–‡ä»¶å’Œå…ƒæ•°æ®æ–‡ä»¶æ˜¯å¦éƒ½å­˜åœ¨</li><li>æ–‡ä»¶å¤§å°æ˜¯å¦æ­£ç¡®</li><li>æ£€æµ‹å­¤ç«‹æ–‡ä»¶</li></ul><p><strong>è¿è¡Œé¢‘ç‡</strong>ï¼šé»˜è®¤æ¯6å°æ—¶</p><h4 id="6-3-3-Disk-Checkerï¼ˆç£ç›˜æ£€æŸ¥å™¨ï¼‰"><a href="#6-3-3-Disk-Checkerï¼ˆç£ç›˜æ£€æŸ¥å™¨ï¼‰" class="headerlink" title="6.3.3 Disk Checkerï¼ˆç£ç›˜æ£€æŸ¥å™¨ï¼‰"></a>6.3.3 Disk Checkerï¼ˆç£ç›˜æ£€æŸ¥å™¨ï¼‰</h4><p><strong>åŠŸèƒ½</strong>ï¼šæ£€æµ‹ç£ç›˜çº§åˆ«çš„æ•…éšœ</p><p><strong>è§¦å‘æ¡ä»¶</strong>ï¼š</p><ul><li>ä»…åœ¨å‘ç”ŸIOExceptionæ—¶è§¦å‘</li><li>æœ€å¤šæ¯5-6ç§’è¿è¡Œä¸€æ¬¡</li></ul><p><strong>æ£€æŸ¥å†…å®¹</strong>ï¼š</p><ul><li>ç›®å½•å­˜åœ¨æ€§å’Œæƒé™</li><li>åŸºæœ¬çš„è¯»å†™èƒ½åŠ›</li></ul><h3 id="6-4-æ–‡ä»¶çº§CRCçš„æ¼”è¿›"><a href="#6-4-æ–‡ä»¶çº§CRCçš„æ¼”è¿›" class="headerlink" title="6.4 æ–‡ä»¶çº§CRCçš„æ¼”è¿›"></a>6.4 æ–‡ä»¶çº§CRCçš„æ¼”è¿›</h3><h4 id="6-4-1-ä¼ ç»Ÿæ–¹å¼ï¼šMD5MD5CRC32"><a href="#6-4-1-ä¼ ç»Ÿæ–¹å¼ï¼šMD5MD5CRC32" class="headerlink" title="6.4.1 ä¼ ç»Ÿæ–¹å¼ï¼šMD5MD5CRC32"></a>6.4.1 ä¼ ç»Ÿæ–¹å¼ï¼šMD5MD5CRC32</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">åŸç†ï¼šMD5(MD5(chunk_crc1) + MD5(chunk_crc2) + ...)</span><br><span class="line">é—®é¢˜ï¼š</span><br><span class="line">- ä¾èµ–å—å¤§å°å’Œchunkå¤§å°</span><br><span class="line">- ä¸åŒé…ç½®çš„HDFSä¹‹é—´æ— æ³•æ¯”è¾ƒ</span><br><span class="line">- ä¸æ”¯æŒä¸éHDFSç³»ç»Ÿæ¯”è¾ƒ</span><br></pre></td></tr></table></figure><h4 id="6-4-2-æ–°æ–¹å¼ï¼šCOMPOSITE-CRC32"><a href="#6-4-2-æ–°æ–¹å¼ï¼šCOMPOSITE-CRC32" class="headerlink" title="6.4.2 æ–°æ–¹å¼ï¼šCOMPOSITE-CRC32"></a>6.4.2 æ–°æ–¹å¼ï¼šCOMPOSITE-CRC32</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">åŸç†ï¼šç›´æ¥ç»„åˆå„chunkçš„CRCå€¼</span><br><span class="line">ä¼˜åŠ¿ï¼š</span><br><span class="line">- ç‹¬ç«‹äºå—é…ç½®</span><br><span class="line">- æ”¯æŒè·¨ç³»ç»Ÿæ¯”è¾ƒ</span><br><span class="line">- æ”¯æŒå¢é‡è®¡ç®—ï¼ˆå¦‚æ–‡ä»¶è¿½åŠ ï¼‰</span><br></pre></td></tr></table></figure><h3 id="6-5-å®é™…åº”ç”¨ç¤ºä¾‹"><a href="#6-5-å®é™…åº”ç”¨ç¤ºä¾‹" class="headerlink" title="6.5 å®é™…åº”ç”¨ç¤ºä¾‹"></a>6.5 å®é™…åº”ç”¨ç¤ºä¾‹</h3><h4 id="ç¤ºä¾‹1ï¼šæ•°æ®è¿ç§»æ ¡éªŒ"><a href="#ç¤ºä¾‹1ï¼šæ•°æ®è¿ç§»æ ¡éªŒ" class="headerlink" title="ç¤ºä¾‹1ï¼šæ•°æ®è¿ç§»æ ¡éªŒ"></a>ç¤ºä¾‹1ï¼šæ•°æ®è¿ç§»æ ¡éªŒ</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">verify_hdfs_migration</span>(<span class="params">source_hdfs, target_hdfs, file_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;éªŒè¯HDFSé—´çš„æ•°æ®è¿ç§»&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># è·å–æºæ–‡ä»¶çš„COMPOSITE-CRC</span></span><br><span class="line">    source_crc = source_hdfs.get_file_checksum(</span><br><span class="line">        file_path, </span><br><span class="line">        checksum_type=<span class="string">&#x27;COMPOSITE-CRC32C&#x27;</span></span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è·å–ç›®æ ‡æ–‡ä»¶çš„COMPOSITE-CRC</span></span><br><span class="line">    target_crc = target_hdfs.get_file_checksum(</span><br><span class="line">        file_path,</span><br><span class="line">        checksum_type=<span class="string">&#x27;COMPOSITE-CRC32C&#x27;</span></span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ¯”è¾ƒCRC</span></span><br><span class="line">    <span class="keyword">if</span> source_crc == target_crc:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;æ–‡ä»¶ <span class="subst">&#123;file_path&#125;</span> è¿ç§»æˆåŠŸ&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;æ–‡ä»¶ <span class="subst">&#123;file_path&#125;</span> æ ¡éªŒå¤±è´¥!&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure><h4 id="ç¤ºä¾‹2ï¼šå¢é‡è¿½åŠ éªŒè¯"><a href="#ç¤ºä¾‹2ï¼šå¢é‡è¿½åŠ éªŒè¯" class="headerlink" title="ç¤ºä¾‹2ï¼šå¢é‡è¿½åŠ éªŒè¯"></a>ç¤ºä¾‹2ï¼šå¢é‡è¿½åŠ éªŒè¯</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">verify_append_operation</span>(<span class="params">hdfs, file_path, append_data</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;éªŒè¯æ–‡ä»¶è¿½åŠ æ“ä½œçš„å®Œæ•´æ€§&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># è·å–è¿½åŠ å‰çš„CRCå’Œé•¿åº¦</span></span><br><span class="line">    original_checksum = hdfs.get_file_checksum(file_path)</span><br><span class="line">    original_length = hdfs.get_file_status(file_path).length</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># è®¡ç®—è¿½åŠ æ•°æ®çš„CRC</span></span><br><span class="line">    append_crc = calculate_crc32c(append_data)</span><br><span class="line">    append_length = <span class="built_in">len</span>(append_data)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># é¢„è®¡ç®—ç»„åˆåçš„CRC</span></span><br><span class="line">    expected_crc = combine_crc32c(</span><br><span class="line">        original_checksum.crc,</span><br><span class="line">        append_crc,</span><br><span class="line">        append_length</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># æ‰§è¡Œè¿½åŠ </span></span><br><span class="line">    hdfs.append(file_path, append_data)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># éªŒè¯</span></span><br><span class="line">    new_checksum = hdfs.get_file_checksum(file_path)</span><br><span class="line">    <span class="keyword">return</span> new_checksum.crc == expected_crc</span><br></pre></td></tr></table></figure><hr><h2 id="7-æ€»ç»“ä¸å±•æœ›"><a href="#7-æ€»ç»“ä¸å±•æœ›" class="headerlink" title="7. æ€»ç»“ä¸å±•æœ›"></a>7. æ€»ç»“ä¸å±•æœ›</h2><h3 id="7-1-å…³é”®è¦ç‚¹æ€»ç»“"><a href="#7-1-å…³é”®è¦ç‚¹æ€»ç»“" class="headerlink" title="7.1 å…³é”®è¦ç‚¹æ€»ç»“"></a>7.1 å…³é”®è¦ç‚¹æ€»ç»“</h3><ol><li><p><strong>CRC-32çš„æ•°å­¦åŸºç¡€</strong></p><ul><li>åŸºäºGF(2)åŸŸçš„å¤šé¡¹å¼é™¤æ³•</li><li>äºŒè¿›åˆ¶è¿ç®—å¯¹åº”å¤šé¡¹å¼è¿ç®—</li><li>XORè¿ç®—æ˜¯æ ¸å¿ƒæ“ä½œ</li></ul></li><li><p><strong>å®ç°ä¼˜åŒ–</strong></p><ul><li>æŸ¥è¡¨æ³•ï¼š8å€æ€§èƒ½æå‡</li><li>ç¡¬ä»¶åŠ é€Ÿï¼š10-20å€æå‡</li><li>CRCç»„åˆï¼šæ”¯æŒå¹¶è¡Œå’Œå¢é‡è®¡ç®—</li></ul></li><li><p><strong>HDFSåº”ç”¨</strong></p><ul><li>å¤šå±‚æ¬¡çš„å®Œæ•´æ€§ä¿æŠ¤</li><li>ä¸»åŠ¨çš„åå°æ‰«ææœºåˆ¶</li><li>æ”¯æŒè·¨ç³»ç»Ÿçš„æ ¡éªŒæ¯”è¾ƒ</li></ul></li></ol><h3 id="7-2-æœ€ä½³å®è·µå»ºè®®"><a href="#7-2-æœ€ä½³å®è·µå»ºè®®" class="headerlink" title="7.2 æœ€ä½³å®è·µå»ºè®®"></a>7.2 æœ€ä½³å®è·µå»ºè®®</h3><ol><li><p><strong>é€‰æ‹©åˆé€‚çš„CRCå˜ä½“</strong></p><ul><li>æ–°ç³»ç»Ÿä¼˜å…ˆä½¿ç”¨CRC-32Cï¼ˆç¡¬ä»¶æ”¯æŒï¼‰</li><li>è€ƒè™‘æœªæ¥å¯èƒ½çš„CRC-64å‡çº§</li></ul></li><li><p><strong>æ€§èƒ½ä¼˜åŒ–</strong></p><ul><li>ä¼˜å…ˆä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿ</li><li>åˆç†è®¾ç½®æ‰«æå‚æ•°é¿å…å½±å“ä¸šåŠ¡</li><li>åˆ©ç”¨CRCç»„åˆç‰¹æ€§è¿›è¡Œå¹¶è¡Œè®¡ç®—</li></ul></li><li><p><strong>æ•°æ®å®Œæ•´æ€§ç­–ç•¥</strong></p><ul><li>å®æ–½å¤šå±‚æ¬¡çš„æ ¡éªŒæœºåˆ¶</li><li>å®šæœŸè¿›è¡Œå…¨é‡æ‰«æ</li><li>ç›‘æ§å’Œå‘Šè­¦å¼‚å¸¸æƒ…å†µ</li></ul></li></ol><h3 id="7-3-æœªæ¥å‘å±•æ–¹å‘"><a href="#7-3-æœªæ¥å‘å±•æ–¹å‘" class="headerlink" title="7.3 æœªæ¥å‘å±•æ–¹å‘"></a>7.3 æœªæ¥å‘å±•æ–¹å‘</h3><ol><li><p><strong>æ›´é•¿çš„CRC</strong></p><ul><li>CRC-64å°†æä¾›æ›´ä½çš„ç¢°æ’æ¦‚ç‡</li><li>ç­‰å¾…ç¡¬ä»¶åŸç”Ÿæ”¯æŒ</li></ul></li><li><p><strong>æ›´æ™ºèƒ½çš„æ‰«æç­–ç•¥</strong></p><ul><li>åŸºäºæœºå™¨å­¦ä¹ çš„æ•…éšœé¢„æµ‹</li><li>è‡ªé€‚åº”çš„æ‰«æé¢‘ç‡è°ƒæ•´</li></ul></li><li><p><strong>è·¨äº‘å­˜å‚¨çš„ç»Ÿä¸€æ ¡éªŒ</strong></p><ul><li>æ ‡å‡†åŒ–çš„æ ¡éªŒæ¥å£</li><li>æ”¯æŒæ›´å¤šå­˜å‚¨ç³»ç»Ÿ</li></ul></li></ol><p>é€šè¿‡æ·±å…¥ç†è§£CRC-32çš„åŸç†å’Œå®ç°ï¼Œæˆ‘ä»¬å¯ä»¥æ›´å¥½åœ°åˆ©ç”¨è¿™ä¸€æŠ€æœ¯ä¿æŠ¤æ•°æ®å®Œæ•´æ€§ï¼Œæ„å»ºæ›´å¯é çš„åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿã€‚</p>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Hadoop HDFSå­˜å‚¨æœºåˆ¶ä¸å—å¤§å°é€‰æ‹©æƒè¡¡</title>
      <link href="/2025/06/15/Hadoop%20HDFS%E5%AD%98%E5%82%A8%E6%9C%BA%E5%88%B6%E4%B8%8E%E5%9D%97%E5%A4%A7%E5%B0%8F%E9%80%89%E6%8B%A9%E6%9D%83%E8%A1%A1/"/>
      <url>/2025/06/15/Hadoop%20HDFS%E5%AD%98%E5%82%A8%E6%9C%BA%E5%88%B6%E4%B8%8E%E5%9D%97%E5%A4%A7%E5%B0%8F%E9%80%89%E6%8B%A9%E6%9D%83%E8%A1%A1/</url>
      
        <content type="html"><![CDATA[<h1 id="Hadoop-HDFSå­˜å‚¨æœºåˆ¶ä¸å—å¤§å°é€‰æ‹©æƒè¡¡"><a href="#Hadoop-HDFSå­˜å‚¨æœºåˆ¶ä¸å—å¤§å°é€‰æ‹©æƒè¡¡" class="headerlink" title="Hadoop HDFSå­˜å‚¨æœºåˆ¶ä¸å—å¤§å°é€‰æ‹©æƒè¡¡"></a>Hadoop HDFSå­˜å‚¨æœºåˆ¶ä¸å—å¤§å°é€‰æ‹©æƒè¡¡</h1><h2 id="ä¸€ã€HDFSå—å­˜å‚¨æœºåˆ¶æ ¸å¿ƒåŸç†"><a href="#ä¸€ã€HDFSå—å­˜å‚¨æœºåˆ¶æ ¸å¿ƒåŸç†" class="headerlink" title="ä¸€ã€HDFSå—å­˜å‚¨æœºåˆ¶æ ¸å¿ƒåŸç†"></a>ä¸€ã€HDFSå—å­˜å‚¨æœºåˆ¶æ ¸å¿ƒåŸç†</h2><h3 id="1-1-é€»è¾‘å—-vs-ç‰©ç†å­˜å‚¨"><a href="#1-1-é€»è¾‘å—-vs-ç‰©ç†å­˜å‚¨" class="headerlink" title="1.1 é€»è¾‘å— vs ç‰©ç†å­˜å‚¨"></a>1.1 é€»è¾‘å— vs ç‰©ç†å­˜å‚¨</h3><p>HDFSä¸­çš„<strong>å—å¤§å°ï¼ˆblock sizeï¼‰</strong>æ˜¯ä¸€ä¸ªé€»è¾‘æ¦‚å¿µï¼Œè€Œéç‰©ç†é¢„åˆ†é…ï¼š</p><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    A[&quot;HDFSå­˜å‚¨æœºåˆ¶&quot;] --&gt; B[&quot;é€»è¾‘å±‚é¢&quot;]    A --&gt; C[&quot;ç‰©ç†å±‚é¢&quot;]        B --&gt; D[&quot;å—å¤§å°: æœ€å¤§å®¹é‡é™åˆ¶&lt;br&#x2F;&gt;(å¦‚128MB)&quot;]    C --&gt; E[&quot;å®é™…å ç”¨: æ–‡ä»¶çœŸå®å¤§å°&lt;br&#x2F;&gt;(å¦‚1MBæ–‡ä»¶åªå 1MB)&quot;]        F[&quot;1MBæ–‡ä»¶&quot;] --&gt; G[&quot;åˆ›å»º1ä¸ªå—&lt;br&#x2F;&gt;(ä¸Šé™128MB)&quot;]    G --&gt; H[&quot;ç£ç›˜å ç”¨: 1MB&quot;]        I[&quot;150MBæ–‡ä»¶&quot;] --&gt; J[&quot;å—1: 128MB&lt;br&#x2F;&gt;å—2: 22MB&quot;]    J --&gt; K[&quot;ç£ç›˜å ç”¨: 150MB&quot;]        style D fill:#bbf,stroke:#333,stroke-width:2px    style E fill:#bfb,stroke:#333,stroke-width:2px    style H fill:#9f9,stroke:#333,stroke-width:2px    style K fill:#9f9,stroke:#333,stroke-width:2px  </pre></div><h3 id="1-2-æ ¸å¿ƒè®¾è®¡ç‰¹ç‚¹"><a href="#1-2-æ ¸å¿ƒè®¾è®¡ç‰¹ç‚¹" class="headerlink" title="1.2 æ ¸å¿ƒè®¾è®¡ç‰¹ç‚¹"></a>1.2 æ ¸å¿ƒè®¾è®¡ç‰¹ç‚¹</h3><table><thead><tr><th>ç‰¹æ€§</th><th>è¯´æ˜</th><th>ä¼˜åŠ¿</th></tr></thead><tbody><tr><td><strong>æŒ‰éœ€åˆ†é…</strong></td><td>åªå ç”¨æ–‡ä»¶å®é™…å¤§å°çš„ç©ºé—´</td><td>é¿å…ç©ºé—´æµªè´¹</td></tr><tr><td><strong>é€»è¾‘åˆ†å—</strong></td><td>å—æ˜¯ç®¡ç†å•ä½ï¼Œä¸æ˜¯ç‰©ç†å•ä½</td><td>çµæ´»é«˜æ•ˆ</td></tr><tr><td><strong>å¤§å—è®¾è®¡</strong></td><td>é»˜è®¤128MBï¼Œè¿œå¤§äºä¼ ç»Ÿæ–‡ä»¶ç³»ç»Ÿ</td><td>å‡å°‘å…ƒæ•°æ®å¼€é”€</td></tr></tbody></table><h2 id="äºŒã€HDFSå­˜å‚¨è®¾è®¡çš„ä¼˜ç¼ºç‚¹åˆ†æ"><a href="#äºŒã€HDFSå­˜å‚¨è®¾è®¡çš„ä¼˜ç¼ºç‚¹åˆ†æ" class="headerlink" title="äºŒã€HDFSå­˜å‚¨è®¾è®¡çš„ä¼˜ç¼ºç‚¹åˆ†æ"></a>äºŒã€HDFSå­˜å‚¨è®¾è®¡çš„ä¼˜ç¼ºç‚¹åˆ†æ</h2><h3 id="2-1-è®¾è®¡ä¼˜åŠ¿"><a href="#2-1-è®¾è®¡ä¼˜åŠ¿" class="headerlink" title="2.1 è®¾è®¡ä¼˜åŠ¿"></a>2.1 è®¾è®¡ä¼˜åŠ¿</h3><ol><li><strong>ç©ºé—´æ•ˆç‡</strong>ï¼šå°æ–‡ä»¶ä¸ä¼šæµªè´¹é¢„åˆ†é…çš„å—ç©ºé—´</li><li><strong>å…ƒæ•°æ®ä¼˜åŒ–</strong>ï¼šå¤§æ–‡ä»¶ä½¿ç”¨è¾ƒå°‘çš„å—ï¼Œå‡å°‘NameNodeå‹åŠ›</li><li><strong>é¡ºåºè¯»å†™</strong>ï¼šå¤§å—æœ‰åˆ©äºé¡ºåºIOï¼Œæé«˜ååé‡</li><li><strong>ç½‘ç»œæ•ˆç‡</strong>ï¼šå‡å°‘å®¢æˆ·ç«¯ä¸DataNodeçš„äº¤äº’æ¬¡æ•°</li></ol><h3 id="2-2-ä¸»è¦é—®é¢˜ï¼šå°æ–‡ä»¶å›°å¢ƒ"><a href="#2-2-ä¸»è¦é—®é¢˜ï¼šå°æ–‡ä»¶å›°å¢ƒ" class="headerlink" title="2.2 ä¸»è¦é—®é¢˜ï¼šå°æ–‡ä»¶å›°å¢ƒ"></a>2.2 ä¸»è¦é—®é¢˜ï¼šå°æ–‡ä»¶å›°å¢ƒ</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    A[&quot;å°æ–‡ä»¶é—®é¢˜&quot;] --&gt; B[&quot;å…ƒæ•°æ®çˆ†ç‚¸&quot;]    A --&gt; C[&quot;MapReduceæ€§èƒ½&quot;]    A --&gt; D[&quot;èµ„æºåˆ©ç”¨ç‡&quot;]        B --&gt; E[&quot;æ¯ä¸ªæ–‡ä»¶è‡³å°‘1ä¸ªå—&lt;br&#x2F;&gt;æ¯ä¸ªå—çº¦150å­—èŠ‚å…ƒæ•°æ®&lt;br&#x2F;&gt;100ä¸‡å°æ–‡ä»¶&#x3D;150MBå†…å­˜&quot;]        C --&gt; F[&quot;æ¯ä¸ªå—å¯¹åº”1ä¸ªMapä»»åŠ¡&lt;br&#x2F;&gt;ä»»åŠ¡å¯åŠ¨å¼€é”€&gt;å¤„ç†æ—¶é—´&lt;br&#x2F;&gt;è°ƒåº¦å™¨å‹åŠ›å¤§&quot;]        D --&gt; G[&quot;DataNodeç®¡ç†å¼€é”€&lt;br&#x2F;&gt;å¿ƒè·³é€šä¿¡å¢åŠ &lt;br&#x2F;&gt;å—æŠ¥å‘Šè´Ÿæ‹…é‡&quot;]        H[&quot;è§£å†³æ–¹æ¡ˆ&quot;] --&gt; I[&quot;HARå½’æ¡£&quot;]    H --&gt; J[&quot;SequenceFile&quot;]    H --&gt; K[&quot;åˆå¹¶å°æ–‡ä»¶&quot;]    H --&gt; L[&quot;HBaseå­˜å‚¨&quot;]        style A fill:#f99,stroke:#333,stroke-width:3px    style E fill:#faa,stroke:#333,stroke-width:2px    style F fill:#faa,stroke:#333,stroke-width:2px    style G fill:#faa,stroke:#333,stroke-width:2px    style H fill:#9f9,stroke:#333,stroke-width:3px  </pre></div><h2 id="ä¸‰ã€å—å¤§å°é€‰æ‹©çš„æƒè¡¡åˆ†æ"><a href="#ä¸‰ã€å—å¤§å°é€‰æ‹©çš„æƒè¡¡åˆ†æ" class="headerlink" title="ä¸‰ã€å—å¤§å°é€‰æ‹©çš„æƒè¡¡åˆ†æ"></a>ä¸‰ã€å—å¤§å°é€‰æ‹©çš„æƒè¡¡åˆ†æ</h2><h3 id="3-1-ä¸åŒå—å¤§å°çš„å½±å“"><a href="#3-1-ä¸åŒå—å¤§å°çš„å½±å“" class="headerlink" title="3.1 ä¸åŒå—å¤§å°çš„å½±å“"></a>3.1 ä¸åŒå—å¤§å°çš„å½±å“</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph LR    A[&quot;å—å¤§å°é€‰æ‹©&quot;] --&gt; B[&quot;å…³é”®æŒ‡æ ‡&quot;]        B --&gt; C[&quot;å…ƒæ•°æ®é‡&quot;]    B --&gt; D[&quot;å¹¶è¡Œåº¦&quot;]    B --&gt; E[&quot;ä»»åŠ¡ç²’åº¦&quot;]    B --&gt; F[&quot;ç½‘ç»œå¼€é”€&quot;]    B --&gt; G[&quot;å®¹é”™ä»£ä»·&quot;]        C --&gt; C1[&quot;å—è¶Šå¤§ï¼Œå…ƒæ•°æ®è¶Šå°‘&quot;]    D --&gt; D1[&quot;å—è¶Šå°ï¼Œå¹¶è¡Œåº¦è¶Šé«˜&quot;]    E --&gt; E1[&quot;å—å¤§å°å†³å®šMapä»»åŠ¡å¤„ç†æ—¶é—´&quot;]    F --&gt; F1[&quot;å—è¶Šå¤§ï¼Œç½‘ç»œä¼ è¾“æ¬¡æ•°è¶Šå°‘&quot;]    G --&gt; G1[&quot;å—è¶Šå¤§ï¼Œå¤±è´¥é‡ç®—ä»£ä»·è¶Šé«˜&quot;]        style A fill:#bbf,stroke:#333,stroke-width:3px    style B fill:#fbf,stroke:#333,stroke-width:2px  </pre></div><h3 id="3-2-å—å¤§å°å¯¹æ¯”åˆ†æ"><a href="#3-2-å—å¤§å°å¯¹æ¯”åˆ†æ" class="headerlink" title="3.2 å—å¤§å°å¯¹æ¯”åˆ†æ"></a>3.2 å—å¤§å°å¯¹æ¯”åˆ†æ</h3><table><thead><tr><th>å—å¤§å°</th><th>å…ƒæ•°æ®å‹åŠ›</th><th>å¹¶è¡Œåº¦</th><th>ä»»åŠ¡ç²’åº¦</th><th>é€‚ç”¨åœºæ™¯</th><th>é£é™©ç‚¹</th></tr></thead><tbody><tr><td><strong>64MB</strong></td><td>é«˜</td><td>å¾ˆé«˜</td><td>ç»†</td><td>â€¢ å°æ–‡ä»¶å¤š<br>â€¢ è®¡ç®—å¯†é›†å‹<br>â€¢ å°é›†ç¾¤</td><td>â€¢ NameNodeå†…å­˜å‹åŠ›<br>â€¢ è°ƒåº¦å¼€é”€å¤§</td></tr><tr><td><strong>128MB</strong><br>(é»˜è®¤)</td><td>ä¸­ç­‰</td><td>é«˜</td><td>é€‚ä¸­</td><td>â€¢ é€šç”¨åœºæ™¯<br>â€¢ æ··åˆè´Ÿè½½<br>â€¢ ä¸­ç­‰è§„æ¨¡é›†ç¾¤</td><td>â€¢ å¹³è¡¡å„æ–¹é¢<br>â€¢ ç»è¿‡éªŒè¯</td></tr><tr><td><strong>256MB</strong></td><td>ä½</td><td>ä¸­ç­‰</td><td>ç²—</td><td>â€¢ å¤§æ–‡ä»¶ä¸ºä¸»<br>â€¢ æµå¼å¤„ç†<br>â€¢ å¤§è§„æ¨¡é›†ç¾¤</td><td>â€¢ å¹¶è¡Œåº¦ä¸‹é™<br>â€¢ è´Ÿè½½ä¸å‡</td></tr><tr><td><strong>512MB+</strong></td><td>å¾ˆä½</td><td>ä½</td><td>å¾ˆç²—</td><td>â€¢ è¶…å¤§æ–‡ä»¶<br>â€¢ æ‰¹å¤„ç†<br>â€¢ ç‰¹æ®Šä¼˜åŒ–</td><td>â€¢ çµæ´»æ€§å·®<br>â€¢ æ•…éšœå½±å“å¤§</td></tr></tbody></table><h3 id="3-3-128MBæˆä¸ºé»˜è®¤å€¼çš„åŸå› "><a href="#3-3-128MBæˆä¸ºé»˜è®¤å€¼çš„åŸå› " class="headerlink" title="3.3 128MBæˆä¸ºé»˜è®¤å€¼çš„åŸå› "></a>3.3 128MBæˆä¸ºé»˜è®¤å€¼çš„åŸå› </h3><p>é€‰æ‹©128MBä½œä¸ºHDFSé»˜è®¤å—å¤§å°ï¼Œä¸»è¦åŸºäºä¸‰ä¸ªæ–¹é¢çš„ç»¼åˆè€ƒè™‘ï¼šæŠ€æœ¯å› ç´ ã€å®è·µå› ç´ å’Œå¹³è¡¡è€ƒè™‘ã€‚</p><h4 id="3-3-1-æŠ€æœ¯å› ç´ "><a href="#3-3-1-æŠ€æœ¯å› ç´ " class="headerlink" title="3.3.1 æŠ€æœ¯å› ç´ "></a>3.3.1 æŠ€æœ¯å› ç´ </h4><h5 id="1-ç£ç›˜ä¼ è¾“æ—¶é—´"><a href="#1-ç£ç›˜ä¼ è¾“æ—¶é—´" class="headerlink" title="1. ç£ç›˜ä¼ è¾“æ—¶é—´"></a>1. ç£ç›˜ä¼ è¾“æ—¶é—´</h5><ul><li><p>ç›®æ ‡ï¼šå—ä¼ è¾“æ—¶é—´æ§åˆ¶åœ¨1-2ç§’å†…å®Œæˆ</p></li><li><p>è®¡ç®—åŸºç¡€ï¼šå½“æ—¶ä¸»æµç£ç›˜çš„ä¼ è¾“é€Ÿåº¦çº¦ä¸º100MB&#x2F;s</p></li><li><p>ç»“æœï¼š128MBçš„å—å¯ä»¥åœ¨1-2ç§’å†…å®Œæˆä¼ è¾“ï¼Œè¿™æ˜¯ä¸€ä¸ªåˆç†çš„æ—¶é—´èŒƒå›´</p></li></ul><h5 id="2-ç½‘ç»œå¸¦å®½åˆ©ç”¨"><a href="#2-ç½‘ç»œå¸¦å®½åˆ©ç”¨" class="headerlink" title="2. ç½‘ç»œå¸¦å®½åˆ©ç”¨"></a>2. ç½‘ç»œå¸¦å®½åˆ©ç”¨</h5><ul><li><p>éœ€æ±‚ï¼šå……åˆ†åˆ©ç”¨æ•°æ®ä¸­å¿ƒçš„ç½‘ç»œå¸¦å®½</p></li><li><p>è€ƒè™‘ï¼šå—ä¸èƒ½å¤ªå°ï¼ˆä¼šäº§ç”Ÿè¿‡å¤šçš„ç½‘ç»œè¯·æ±‚ï¼‰ï¼Œä¹Ÿä¸èƒ½å¤ªå¤§ï¼ˆå•æ¬¡ä¼ è¾“æ—¶é—´è¿‡é•¿ï¼‰</p></li><li><p>æ•ˆæœï¼š128MBèƒ½å¤Ÿè¾ƒå¥½åœ°åˆ©ç”¨åƒå…†ç½‘ç»œå¸¦å®½</p></li></ul><h5 id="3-NameNodeå†…å­˜å ç”¨"><a href="#3-NameNodeå†…å­˜å ç”¨" class="headerlink" title="3. NameNodeå†…å­˜å ç”¨"></a>3. NameNodeå†…å­˜å ç”¨</h5><ul><li><p>çº¦æŸï¼šæ¯ä¸ªå—åœ¨NameNodeä¸­å ç”¨çº¦150å­—èŠ‚çš„å…ƒæ•°æ®</p></li><li><p>è®¡ç®—ï¼š128MBçš„å—å¤§å°ä½¿å¾—NameNodeèƒ½å¤Ÿç®¡ç†PBçº§æ•°æ®è€Œä¸ä¼šå†…å­˜æº¢å‡º</p></li><li><p>å¹³è¡¡ï¼šåœ¨å¯ç®¡ç†çš„æ–‡ä»¶æ•°é‡å’Œå†…å­˜æ¶ˆè€—ä¹‹é—´å–å¾—å¹³è¡¡</p></li></ul><h4 id="3-3-2-å®è·µå› ç´ "><a href="#3-3-2-å®è·µå› ç´ " class="headerlink" title="3.3.2 å®è·µå› ç´ "></a>3.3.2 å®è·µå› ç´ </h4><h5 id="1-Google-GFSçš„ç»éªŒå€Ÿé‰´"><a href="#1-Google-GFSçš„ç»éªŒå€Ÿé‰´" class="headerlink" title="1. Google GFSçš„ç»éªŒå€Ÿé‰´"></a>1. Google GFSçš„ç»éªŒå€Ÿé‰´</h5><ul><li><p>å‚è€ƒï¼šGoogleæ–‡ä»¶ç³»ç»Ÿï¼ˆGFSï¼‰ä½¿ç”¨64MBçš„å—å¤§å°</p></li><li><p>æ”¹è¿›ï¼šHadoopåŸºäºGFSçš„ç»éªŒï¼Œè€ƒè™‘åˆ°ç¡¬ä»¶å‘å±•ï¼Œå°†å—å¤§å°ç¿»å€åˆ°128MB</p></li><li><p>éªŒè¯ï¼šè¿™ä¸ªé€‰æ‹©è¢«è¯æ˜æ˜¯æˆåŠŸçš„</p></li></ul><h5 id="2-ç¡¬ä»¶æŠ€æœ¯å‘å±•"><a href="#2-ç¡¬ä»¶æŠ€æœ¯å‘å±•" class="headerlink" title="2. ç¡¬ä»¶æŠ€æœ¯å‘å±•"></a>2. ç¡¬ä»¶æŠ€æœ¯å‘å±•</h5><ul><li><p>è¶‹åŠ¿ï¼šä»HDFSè®¾è®¡ä¹‹åˆåˆ°æ­£å¼å‘å¸ƒï¼Œç£ç›˜å®¹é‡å’Œç½‘ç»œé€Ÿåº¦éƒ½æœ‰æ˜¾è‘—æå‡</p></li><li><p>é€‚åº”ï¼š128MBæ¯”64MBæ›´é€‚åˆæ–°ä¸€ä»£ç¡¬ä»¶</p></li><li><p>å‰ç»ï¼šä¸ºæœªæ¥å‡ å¹´çš„ç¡¬ä»¶å‘å±•é¢„ç•™äº†ç©ºé—´</p></li></ul><h5 id="3-å¤§è§„æ¨¡ç”Ÿäº§ç¯å¢ƒéªŒè¯"><a href="#3-å¤§è§„æ¨¡ç”Ÿäº§ç¯å¢ƒéªŒè¯" class="headerlink" title="3. å¤§è§„æ¨¡ç”Ÿäº§ç¯å¢ƒéªŒè¯"></a>3. å¤§è§„æ¨¡ç”Ÿäº§ç¯å¢ƒéªŒè¯</h5><ul><li><p>æµ‹è¯•ï¼šYahooã€Facebookç­‰å…¬å¸çš„å¤§è§„æ¨¡éƒ¨ç½²éªŒè¯</p></li><li><p>åé¦ˆï¼šåœ¨å„ç§å·¥ä½œè´Ÿè½½ä¸‹è¡¨ç°ç¨³å®š</p></li><li><p>ä¼˜åŒ–ï¼šç»è¿‡å¤šæ¬¡è°ƒä¼˜åç¡®å®šçš„æœ€ä½³å€¼</p></li></ul><h4 id="3-3-3-å¹³è¡¡è€ƒè™‘"><a href="#3-3-3-å¹³è¡¡è€ƒè™‘" class="headerlink" title="3.3.3 å¹³è¡¡è€ƒè™‘"></a>3.3.3 å¹³è¡¡è€ƒè™‘</h4><h5 id="1-å…ƒæ•°æ®é‡-vs-å¹¶è¡Œåº¦"><a href="#1-å…ƒæ•°æ®é‡-vs-å¹¶è¡Œåº¦" class="headerlink" title="1. å…ƒæ•°æ®é‡ vs å¹¶è¡Œåº¦"></a>1. å…ƒæ•°æ®é‡ vs å¹¶è¡Œåº¦</h5><ul><li><p>çŸ›ç›¾ï¼šå—è¶Šå¤§ï¼Œå…ƒæ•°æ®è¶Šå°‘ï¼Œä½†å¹¶è¡Œå¤„ç†èƒ½åŠ›ä¸‹é™</p></li><li><p>æƒè¡¡ï¼š128MBåœ¨å‡å°‘å…ƒæ•°æ®å‹åŠ›çš„åŒæ—¶ï¼Œä»ä¿æŒè‰¯å¥½çš„å¹¶è¡Œåº¦</p></li><li><p>æ•ˆæœï¼šé€‚åˆå¤§å¤šæ•°MapReduceä½œä¸šçš„éœ€æ±‚</p></li></ul><h5 id="2-ååé‡-vs-å»¶è¿Ÿ"><a href="#2-ååé‡-vs-å»¶è¿Ÿ" class="headerlink" title="2. ååé‡ vs å»¶è¿Ÿ"></a>2. ååé‡ vs å»¶è¿Ÿ</h5><ul><li><p>ååé‡éœ€æ±‚ï¼šå¤§å—æœ‰åˆ©äºé¡ºåºè¯»å†™ï¼Œæé«˜æ•´ä½“ååé‡</p></li><li><p>å»¶è¿Ÿè¦æ±‚ï¼šå—ä¸èƒ½å¤ªå¤§ï¼Œå¦åˆ™å•ä¸ªä»»åŠ¡å¤„ç†æ—¶é—´è¿‡é•¿</p></li><li><p>å¹³è¡¡ç‚¹ï¼š128MBä½¿å¾—å•ä¸ªMapä»»åŠ¡è¿è¡Œæ—¶é—´åœ¨åˆç†èŒƒå›´å†…ï¼ˆé€šå¸¸å‡ åç§’åˆ°å‡ åˆ†é’Ÿï¼‰</p></li></ul><h5 id="3-æ•ˆç‡-vs-çµæ´»æ€§"><a href="#3-æ•ˆç‡-vs-çµæ´»æ€§" class="headerlink" title="3. æ•ˆç‡ vs çµæ´»æ€§"></a>3. æ•ˆç‡ vs çµæ´»æ€§</h5><ul><li><p>æ•ˆç‡è¿½æ±‚ï¼šå¤§å—å‡å°‘äº†å®¢æˆ·ç«¯ä¸NameNodeã€DataNodeçš„äº¤äº’æ¬¡æ•°</p></li><li><p>çµæ´»æ€§éœ€æ±‚ï¼šä¸èƒ½å¤ªå¤§ï¼Œè¦èƒ½é€‚åº”ä¸åŒå¤§å°çš„æ–‡ä»¶</p></li><li><p>æŠ˜ä¸­æ–¹æ¡ˆï¼š128MBæ—¢é«˜æ•ˆåˆä¿æŒäº†ä¸€å®šçš„çµæ´»æ€§</p></li></ul><h2 id="å››ã€æœ€ä½³å®è·µä¸å»ºè®®"><a href="#å››ã€æœ€ä½³å®è·µä¸å»ºè®®" class="headerlink" title="å››ã€æœ€ä½³å®è·µä¸å»ºè®®"></a>å››ã€æœ€ä½³å®è·µä¸å»ºè®®</h2><h3 id="4-1-å—å¤§å°é€‰æ‹©å†³ç­–æ ‘"><a href="#4-1-å—å¤§å°é€‰æ‹©å†³ç­–æ ‘" class="headerlink" title="4.1 å—å¤§å°é€‰æ‹©å†³ç­–æ ‘"></a>4.1 å—å¤§å°é€‰æ‹©å†³ç­–æ ‘</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">æ–‡ä»¶ç‰¹å¾åˆ†æ</span><br><span class="line">â”œâ”€â”€ å¹³å‡æ–‡ä»¶å¤§å° &lt; 100MB</span><br><span class="line">â”‚   â”œâ”€â”€ æ–‡ä»¶æ•°é‡æå¤š â†’ è€ƒè™‘æ–‡ä»¶åˆå¹¶ç­–ç•¥</span><br><span class="line">â”‚   â””â”€â”€ æ–‡ä»¶æ•°é‡é€‚ä¸­ â†’ ä¿æŒ128MB</span><br><span class="line">â”œâ”€â”€ å¹³å‡æ–‡ä»¶å¤§å° 100MB-1GB</span><br><span class="line">â”‚   â””â”€â”€ é»˜è®¤128MBæœ€ä¼˜</span><br><span class="line">â””â”€â”€ å¹³å‡æ–‡ä»¶å¤§å° &gt; 1GB</span><br><span class="line">    â”œâ”€â”€ æ‰¹å¤„ç†ä¸ºä¸» â†’ è€ƒè™‘256MB</span><br><span class="line">    â””â”€â”€ å®æ—¶æ€§è¦æ±‚é«˜ â†’ ä¿æŒ128MB</span><br></pre></td></tr></table></figure><h3 id="4-2-åŠ¨æ€è°ƒæ•´ç­–ç•¥"><a href="#4-2-åŠ¨æ€è°ƒæ•´ç­–ç•¥" class="headerlink" title="4.2 åŠ¨æ€è°ƒæ•´ç­–ç•¥"></a>4.2 åŠ¨æ€è°ƒæ•´ç­–ç•¥</h3><ol><li><p><strong>ç›‘æ§æŒ‡æ ‡</strong></p><ul><li>NameNodeå†…å­˜ä½¿ç”¨ç‡</li><li>Mapä»»åŠ¡å¹³å‡æ‰§è¡Œæ—¶é—´</li><li>æ•°æ®æœ¬åœ°æ€§æ¯”ä¾‹</li><li>é›†ç¾¤æ•´ä½“ååé‡</li></ul></li><li><p><strong>è°ƒæ•´æ—¶æœº</strong></p><ul><li>NameNodeå†…å­˜ &gt; 80% â†’ å¢å¤§å—å¤§å°</li><li>Mapä»»åŠ¡ &lt; 30ç§’ â†’ è€ƒè™‘å¢å¤§å—å¤§å°</li><li>Mapä»»åŠ¡ &gt; 10åˆ†é’Ÿ â†’ è€ƒè™‘å‡å°å—å¤§å°</li><li>æ–°ç¡¬ä»¶éƒ¨ç½² â†’ é‡æ–°è¯„ä¼°å—å¤§å°</li></ul></li></ol><h3 id="4-3-é…ç½®å»ºè®®"><a href="#4-3-é…ç½®å»ºè®®" class="headerlink" title="4.3 é…ç½®å»ºè®®"></a>4.3 é…ç½®å»ºè®®</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- hdfs-site.xml é…ç½®ç¤ºä¾‹ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- é»˜è®¤å—å¤§å° --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.blocksize<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>134217728<span class="tag">&lt;/<span class="name">value</span>&gt;</span> <span class="comment">&lt;!-- 128MB --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- é’ˆå¯¹ç‰¹å®šç›®å½•è®¾ç½® --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- å¤§æ–‡ä»¶ç›®å½•ä½¿ç”¨256MB --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.blocksize./large-files<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>268435456<span class="tag">&lt;/<span class="name">value</span>&gt;</span> <span class="comment">&lt;!-- 256MB --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="äº”ã€æ€»ç»“"><a href="#äº”ã€æ€»ç»“" class="headerlink" title="äº”ã€æ€»ç»“"></a>äº”ã€æ€»ç»“</h2><h3 id="å…³é”®è¦ç‚¹"><a href="#å…³é”®è¦ç‚¹" class="headerlink" title="å…³é”®è¦ç‚¹"></a>å…³é”®è¦ç‚¹</h3><ol><li><strong>HDFSå—å­˜å‚¨æœ¬è´¨</strong>ï¼šé€»è¾‘åˆ†å—ï¼Œç‰©ç†æŒ‰éœ€ï¼Œé¿å…ç©ºé—´æµªè´¹</li><li><strong>å—å¤§å°æƒè¡¡æ ¸å¿ƒ</strong>ï¼šåœ¨å…ƒæ•°æ®å¼€é”€å’Œå¹¶è¡Œå¤„ç†èƒ½åŠ›ä¹‹é—´æ‰¾å¹³è¡¡</li><li><strong>128MBçš„åˆç†æ€§</strong>ï¼šç»è¿‡å¤§è§„æ¨¡ç”Ÿäº§ç¯å¢ƒéªŒè¯çš„ç»éªŒå€¼</li><li><strong>çµæ´»è°ƒæ•´åŸåˆ™</strong>ï¼šæ ¹æ®å®é™…å·¥ä½œè´Ÿè½½å’Œç¡¬ä»¶æ¡ä»¶åŠ¨æ€ä¼˜åŒ–</li><li><strong>å°æ–‡ä»¶æ˜¯ç¡¬ä¼¤</strong>ï¼šéœ€è¦é¢å¤–çš„ç­–ç•¥å’Œå·¥å…·æ¥è§£å†³</li></ol><h3 id="å‘å±•è¶‹åŠ¿"><a href="#å‘å±•è¶‹åŠ¿" class="headerlink" title="å‘å±•è¶‹åŠ¿"></a>å‘å±•è¶‹åŠ¿</h3><ul><li><strong>ç¡¬ä»¶è¿›æ­¥</strong>ï¼šSSDæ™®åŠã€ç½‘ç»œæé€Ÿï¼Œæ”¯æŒæ›´å¤§çš„å—</li><li><strong>æ–°å‹å­˜å‚¨</strong>ï¼šå¯¹è±¡å­˜å‚¨ã€åˆ—å¼å­˜å‚¨è¡¥å……HDFSä¸è¶³</li><li><strong>æ™ºèƒ½ä¼˜åŒ–</strong>ï¼šè‡ªé€‚åº”å—å¤§å°ã€åŠ¨æ€è°ƒæ•´ç­–ç•¥</li><li><strong>äº‘åŸç”ŸåŒ–</strong>ï¼šå­˜ç®—åˆ†ç¦»æ¶æ„ä¸‹çš„æ–°æŒ‘æˆ˜</li></ul>]]></content>
      
      
      <categories>
          
          <category> å¤§æ•°æ® </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥ç†è§£ iptables NATï¼šDNAT ä¸ SNAT è¯¦è§£</title>
      <link href="/2025/06/13/iptables-nat-dnat-snat/"/>
      <url>/2025/06/13/iptables-nat-dnat-snat/</url>
      
        <content type="html"><![CDATA[<h1 id="æ·±å…¥ç†è§£-iptables-NATï¼šDNAT-ä¸-SNAT-è¯¦è§£"><a href="#æ·±å…¥ç†è§£-iptables-NATï¼šDNAT-ä¸-SNAT-è¯¦è§£" class="headerlink" title="æ·±å…¥ç†è§£ iptables NATï¼šDNAT ä¸ SNAT è¯¦è§£"></a>æ·±å…¥ç†è§£ iptables NATï¼šDNAT ä¸ SNAT è¯¦è§£</h1><h2 id="1-NAT-æŠ€æœ¯èƒŒæ™¯"><a href="#1-NAT-æŠ€æœ¯èƒŒæ™¯" class="headerlink" title="1. NAT æŠ€æœ¯èƒŒæ™¯"></a>1. NAT æŠ€æœ¯èƒŒæ™¯</h2><h3 id="1-1-ä»€ä¹ˆæ˜¯-NAT"><a href="#1-1-ä»€ä¹ˆæ˜¯-NAT" class="headerlink" title="1.1 ä»€ä¹ˆæ˜¯ NAT"></a>1.1 ä»€ä¹ˆæ˜¯ NAT</h3><p>NATï¼ˆNetwork Address Translationï¼Œç½‘ç»œåœ°å€è½¬æ¢ï¼‰æ˜¯ä¸€ç§ç½‘ç»œæŠ€æœ¯ï¼Œç”¨äºåœ¨ IP æ•°æ®åŒ…é€šè¿‡è·¯ç”±å™¨æˆ–é˜²ç«å¢™æ—¶ï¼Œä¿®æ”¹æ•°æ®åŒ…çš„æº IP åœ°å€æˆ–ç›®æ ‡ IP åœ°å€ã€‚NAT æŠ€æœ¯æœ€åˆæ˜¯ä¸ºäº†è§£å†³ IPv4 åœ°å€çŸ­ç¼ºé—®é¢˜è€Œè®¾è®¡çš„ã€‚</p><h3 id="1-2-NAT-çš„é‡è¦æ€§"><a href="#1-2-NAT-çš„é‡è¦æ€§" class="headerlink" title="1.2 NAT çš„é‡è¦æ€§"></a>1.2 NAT çš„é‡è¦æ€§</h3><ol><li><p><strong>è§£å†³ IPv4 åœ°å€çŸ­ç¼º</strong></p><ul><li>å…è®¸å¤šä¸ªç§æœ‰ IP åœ°å€å…±äº«ä¸€ä¸ªå…¬ç½‘ IP</li><li>å»¶ç¼“ IPv4 åœ°å€è€—å°½é—®é¢˜</li></ul></li><li><p><strong>ç½‘ç»œå®‰å…¨</strong></p><ul><li>éšè—å†…éƒ¨ç½‘ç»œç»“æ„</li><li>æä¾›åŸºæœ¬çš„é˜²ç«å¢™åŠŸèƒ½</li></ul></li><li><p><strong>ç½‘ç»œéš”ç¦»</strong></p><ul><li>å®ç°ç§æœ‰ç½‘ç»œä¸å…¬ç½‘çš„éš”ç¦»</li><li>ç®€åŒ–ç½‘ç»œç®¡ç†</li></ul></li></ol><h2 id="2-DNAT-è¯¦è§£"><a href="#2-DNAT-è¯¦è§£" class="headerlink" title="2. DNAT è¯¦è§£"></a>2. DNAT è¯¦è§£</h2><h3 id="2-1-ä»€ä¹ˆæ˜¯-DNAT"><a href="#2-1-ä»€ä¹ˆæ˜¯-DNAT" class="headerlink" title="2.1 ä»€ä¹ˆæ˜¯ DNAT"></a>2.1 ä»€ä¹ˆæ˜¯ DNAT</h3><p>DNATï¼ˆDestination Network Address Translationï¼Œç›®æ ‡åœ°å€è½¬æ¢ï¼‰æ˜¯ä¸€ç§ NAT æŠ€æœ¯ï¼Œç”¨äºä¿®æ”¹æ•°æ®åŒ…çš„ç›®æ ‡ IP åœ°å€å’Œç«¯å£ã€‚å½“å¤–éƒ¨ç½‘ç»œè®¿é—®å†…éƒ¨æœåŠ¡å™¨æ—¶ï¼ŒDNAT å°†ç›®æ ‡åœ°å€è½¬æ¢ä¸ºå†…éƒ¨æœåŠ¡å™¨çš„å®é™…åœ°å€ã€‚</p><h3 id="2-2-DNAT-å·¥ä½œåŸç†"><a href="#2-2-DNAT-å·¥ä½œåŸç†" class="headerlink" title="2.2 DNAT å·¥ä½œåŸç†"></a>2.2 DNAT å·¥ä½œåŸç†</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph LR    A[å¤–éƒ¨è¯·æ±‚] --&gt;|ç›®æ ‡: å…¬ç½‘IP:80| B[è·¯ç”±å™¨]    B --&gt;|DNATè½¬æ¢| C[å†…éƒ¨æœåŠ¡å™¨]    C --&gt;|ç›®æ ‡: å†…ç½‘IP:8080| D[å®é™…æœåŠ¡]  </pre></div><h3 id="2-3-DNAT-ä½¿ç”¨åœºæ™¯"><a href="#2-3-DNAT-ä½¿ç”¨åœºæ™¯" class="headerlink" title="2.3 DNAT ä½¿ç”¨åœºæ™¯"></a>2.3 DNAT ä½¿ç”¨åœºæ™¯</h3><ol><li><p><strong>ç«¯å£è½¬å‘</strong></p><ul><li>å°†å¤–éƒ¨ç«¯å£æ˜ å°„åˆ°å†…éƒ¨æœåŠ¡å™¨</li><li>å®ç°æœåŠ¡å¯¹å¤–æš´éœ²</li></ul></li><li><p><strong>è´Ÿè½½å‡è¡¡</strong></p><ul><li>å°†è¯·æ±‚åˆ†å‘åˆ°å¤šä¸ªå†…éƒ¨æœåŠ¡å™¨</li><li>å®ç°ç®€å•çš„è´Ÿè½½å‡è¡¡</li></ul></li><li><p><strong>æœåŠ¡éšè—</strong></p><ul><li>éšè—å†…éƒ¨æœåŠ¡å™¨çš„çœŸå® IP</li><li>æé«˜å®‰å…¨æ€§</li></ul></li></ol><h3 id="2-4-DNAT-é…ç½®ç¤ºä¾‹"><a href="#2-4-DNAT-é…ç½®ç¤ºä¾‹" class="headerlink" title="2.4 DNAT é…ç½®ç¤ºä¾‹"></a>2.4 DNAT é…ç½®ç¤ºä¾‹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°†å¤–éƒ¨ 80 ç«¯å£è½¬å‘åˆ°å†…éƒ¨æœåŠ¡å™¨çš„ 8080 ç«¯å£</span></span><br><span class="line">iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 192.168.1.100:8080</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†ç‰¹å®š IP çš„è¯·æ±‚è½¬å‘åˆ°å†…éƒ¨æœåŠ¡å™¨</span></span><br><span class="line">iptables -t nat -A PREROUTING -d 203.0.113.1 -j DNAT --to-destination 192.168.1.100</span><br></pre></td></tr></table></figure><h2 id="3-SNAT-è¯¦è§£"><a href="#3-SNAT-è¯¦è§£" class="headerlink" title="3. SNAT è¯¦è§£"></a>3. SNAT è¯¦è§£</h2><h3 id="3-1-ä»€ä¹ˆæ˜¯-SNAT"><a href="#3-1-ä»€ä¹ˆæ˜¯-SNAT" class="headerlink" title="3.1 ä»€ä¹ˆæ˜¯ SNAT"></a>3.1 ä»€ä¹ˆæ˜¯ SNAT</h3><p>SNATï¼ˆSource Network Address Translationï¼Œæºåœ°å€è½¬æ¢ï¼‰æ˜¯ä¸€ç§ NAT æŠ€æœ¯ï¼Œç”¨äºä¿®æ”¹æ•°æ®åŒ…çš„æº IP åœ°å€ã€‚å½“å†…éƒ¨ç½‘ç»œè®¿é—®å¤–éƒ¨ç½‘ç»œæ—¶ï¼ŒSNAT å°†æºåœ°å€è½¬æ¢ä¸ºå…¬ç½‘ IP åœ°å€ã€‚</p><h3 id="3-2-SNAT-å·¥ä½œåŸç†"><a href="#3-2-SNAT-å·¥ä½œåŸç†" class="headerlink" title="3.2 SNAT å·¥ä½œåŸç†"></a>3.2 SNAT å·¥ä½œåŸç†</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph LR    A[å†…éƒ¨ä¸»æœº] --&gt;|æº: å†…ç½‘IP| B[è·¯ç”±å™¨]    B --&gt;|SNATè½¬æ¢| C[å¤–éƒ¨ç½‘ç»œ]    C --&gt;|æº: å…¬ç½‘IP| D[ç›®æ ‡æœåŠ¡å™¨]  </pre></div><h3 id="3-3-SNAT-ä½¿ç”¨åœºæ™¯"><a href="#3-3-SNAT-ä½¿ç”¨åœºæ™¯" class="headerlink" title="3.3 SNAT ä½¿ç”¨åœºæ™¯"></a>3.3 SNAT ä½¿ç”¨åœºæ™¯</h3><ol><li><p><strong>å…±äº«ä¸Šç½‘</strong></p><ul><li>å¤šä¸ªå†…ç½‘ä¸»æœºå…±äº«ä¸€ä¸ªå…¬ç½‘ IP</li><li>å®ç°å†…ç½‘è®¿é—®å¤–ç½‘</li></ul></li><li><p><strong>éšè—å†…ç½‘ç»“æ„</strong></p><ul><li>ä¿æŠ¤å†…éƒ¨ç½‘ç»œæ‹“æ‰‘</li><li>æé«˜å®‰å…¨æ€§</li></ul></li><li><p><strong>è´Ÿè½½å‡è¡¡</strong></p><ul><li>å®ç°å‡ºç«™æµé‡çš„è´Ÿè½½å‡è¡¡</li><li>ä¼˜åŒ–ç½‘ç»œæ€§èƒ½</li></ul></li></ol><h3 id="3-4-SNAT-é…ç½®ç¤ºä¾‹"><a href="#3-4-SNAT-é…ç½®ç¤ºä¾‹" class="headerlink" title="3.4 SNAT é…ç½®ç¤ºä¾‹"></a>3.4 SNAT é…ç½®ç¤ºä¾‹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°†å†…ç½‘æµé‡è½¬æ¢ä¸ºå…¬ç½‘ IP</span></span><br><span class="line">iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -j SNAT --to-source 203.0.113.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨åŠ¨æ€ IP è¿›è¡Œè½¬æ¢</span></span><br><span class="line">iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -j MASQUERADE</span><br></pre></td></tr></table></figure><h2 id="4-DNAT-ä¸-SNAT-çš„åŒºåˆ«"><a href="#4-DNAT-ä¸-SNAT-çš„åŒºåˆ«" class="headerlink" title="4. DNAT ä¸ SNAT çš„åŒºåˆ«"></a>4. DNAT ä¸ SNAT çš„åŒºåˆ«</h2><h3 id="4-1-ä¸»è¦åŒºåˆ«"><a href="#4-1-ä¸»è¦åŒºåˆ«" class="headerlink" title="4.1 ä¸»è¦åŒºåˆ«"></a>4.1 ä¸»è¦åŒºåˆ«</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    A[NATç±»å‹] --&gt; B[DNAT]    A --&gt; C[SNAT]    B --&gt; D[ä¿®æ”¹ç›®æ ‡åœ°å€]    B --&gt; E[åœ¨PREROUTINGé“¾å¤„ç†]    C --&gt; F[ä¿®æ”¹æºåœ°å€]    C --&gt; G[åœ¨POSTROUTINGé“¾å¤„ç†]  </pre></div><h3 id="4-2-åº”ç”¨åœºæ™¯å¯¹æ¯”"><a href="#4-2-åº”ç”¨åœºæ™¯å¯¹æ¯”" class="headerlink" title="4.2 åº”ç”¨åœºæ™¯å¯¹æ¯”"></a>4.2 åº”ç”¨åœºæ™¯å¯¹æ¯”</h3><ol><li><p><strong>DNAT</strong></p><ul><li>ä¸»è¦ç”¨äºå…¥ç«™æµé‡</li><li>å®ç°ç«¯å£è½¬å‘</li><li>éšè—å†…éƒ¨æœåŠ¡å™¨</li></ul></li><li><p><strong>SNAT</strong></p><ul><li>ä¸»è¦ç”¨äºå‡ºç«™æµé‡</li><li>å®ç°å…±äº«ä¸Šç½‘</li><li>ä¿æŠ¤å†…ç½‘å®‰å…¨</li></ul></li></ol><h2 id="5-ä¸-iptables-çš„å…³ç³»"><a href="#5-ä¸-iptables-çš„å…³ç³»" class="headerlink" title="5. ä¸ iptables çš„å…³ç³»"></a>5. ä¸ iptables çš„å…³ç³»</h2><h3 id="5-1-åœ¨-iptables-ä¸­çš„ä½ç½®"><a href="#5-1-åœ¨-iptables-ä¸­çš„ä½ç½®" class="headerlink" title="5.1 åœ¨ iptables ä¸­çš„ä½ç½®"></a>5.1 åœ¨ iptables ä¸­çš„ä½ç½®</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    A[æ•°æ®åŒ…] --&gt; B[PREROUTINGé“¾]    B --&gt; C[è·¯ç”±å†³ç­–]    C --&gt; D[FORWARDé“¾]    D --&gt; E[POSTROUTINGé“¾]    B --&gt; F[DNATå¤„ç†]    E --&gt; G[SNATå¤„ç†]  </pre></div><h3 id="5-2-è§„åˆ™é“¾äº¤äº’"><a href="#5-2-è§„åˆ™é“¾äº¤äº’" class="headerlink" title="5.2 è§„åˆ™é“¾äº¤äº’"></a>5.2 è§„åˆ™é“¾äº¤äº’</h3><ol><li><p><strong>DNAT å¤„ç†æµç¨‹</strong></p><ul><li>åœ¨ PREROUTING é“¾è¿›è¡Œ DNAT</li><li>å½±å“åç»­çš„è·¯ç”±å†³ç­–</li><li>å¯èƒ½è§¦å‘ SNAT å¤„ç†</li></ul></li><li><p><strong>SNAT å¤„ç†æµç¨‹</strong></p><ul><li>åœ¨ POSTROUTING é“¾è¿›è¡Œ SNAT</li><li>åœ¨æ•°æ®åŒ…å‘é€å‰ä¿®æ”¹æºåœ°å€</li><li>ä¸å½±å“è·¯ç”±å†³ç­–</li></ul></li></ol><h2 id="6-æœ€ä½³å®è·µ"><a href="#6-æœ€ä½³å®è·µ" class="headerlink" title="6. æœ€ä½³å®è·µ"></a>6. æœ€ä½³å®è·µ</h2><h3 id="6-1-é…ç½®å»ºè®®"><a href="#6-1-é…ç½®å»ºè®®" class="headerlink" title="6.1 é…ç½®å»ºè®®"></a>6.1 é…ç½®å»ºè®®</h3><ol><li><p><strong>è§„åˆ™é¡ºåº</strong></p><ul><li>å…ˆé…ç½® DNAT è§„åˆ™</li><li>åé…ç½® SNAT è§„åˆ™</li><li>æ³¨æ„è§„åˆ™ä¼˜å…ˆçº§</li></ul></li><li><p><strong>æ€§èƒ½ä¼˜åŒ–</strong></p><ul><li>ä½¿ç”¨ ipset ç®¡ç†å¤§é‡ IP</li><li>åˆç†è®¾ç½®è¿æ¥è·Ÿè¸ª</li><li>é¿å…è¿‡åº¦å¤æ‚çš„è§„åˆ™</li></ul></li><li><p><strong>å®‰å…¨è€ƒè™‘</strong></p><ul><li>é™åˆ¶å…è®¸çš„ç«¯å£èŒƒå›´</li><li>è®°å½•å…³é”® NAT æ“ä½œ</li><li>å®šæœŸå®¡æŸ¥è§„åˆ™</li></ul></li></ol><h3 id="6-2-å¸¸è§é—®é¢˜"><a href="#6-2-å¸¸è§é—®é¢˜" class="headerlink" title="6.2 å¸¸è§é—®é¢˜"></a>6.2 å¸¸è§é—®é¢˜</h3><ol><li><p><strong>è¿æ¥è·Ÿè¸ª</strong></p><ul><li>ç¡®ä¿å¯ç”¨ conntrack</li><li>é€‚å½“è®¾ç½®è¶…æ—¶æ—¶é—´</li><li>å¤„ç†è¿æ¥è·Ÿè¸ªè¡¨æº¢å‡º</li></ul></li><li><p><strong>æ€§èƒ½é—®é¢˜</strong></p><ul><li>ç›‘æ§ NAT æ€§èƒ½</li><li>ä¼˜åŒ–è§„åˆ™ç»“æ„</li><li>è€ƒè™‘ä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿ</li></ul></li></ol><h2 id="7-æ€»ç»“"><a href="#7-æ€»ç»“" class="headerlink" title="7. æ€»ç»“"></a>7. æ€»ç»“</h2><p>DNAT å’Œ SNAT æ˜¯ iptables ä¸­æœ€é‡è¦çš„ NAT æŠ€æœ¯ï¼Œå®ƒä»¬åˆ†åˆ«å¤„ç†å…¥ç«™å’Œå‡ºç«™æµé‡çš„åœ°å€è½¬æ¢ã€‚ç†è§£è¿™ä¸¤ç§æŠ€æœ¯çš„åŸç†å’Œåº”ç”¨åœºæ™¯ï¼Œå¯¹äºç½‘ç»œç®¡ç†å’Œå®‰å…¨é˜²æŠ¤éƒ½è‡³å…³é‡è¦ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> ç½‘ç»œ </tag>
            
            <tag> å®‰å…¨ </tag>
            
            <tag> é˜²ç«å¢™ </tag>
            
            <tag> NAT </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥ç†è§£ iptables è§„åˆ™é“¾ï¼šåŸç†ä¸å®è·µ</title>
      <link href="/2025/06/13/iptables-rule-chains/"/>
      <url>/2025/06/13/iptables-rule-chains/</url>
      
        <content type="html"><![CDATA[<h1 id="æ·±å…¥ç†è§£-iptables-è§„åˆ™é“¾ï¼šåŸç†ä¸å®è·µ"><a href="#æ·±å…¥ç†è§£-iptables-è§„åˆ™é“¾ï¼šåŸç†ä¸å®è·µ" class="headerlink" title="æ·±å…¥ç†è§£ iptables è§„åˆ™é“¾ï¼šåŸç†ä¸å®è·µ"></a>æ·±å…¥ç†è§£ iptables è§„åˆ™é“¾ï¼šåŸç†ä¸å®è·µ</h1><h2 id="1-iptables-ç®€ä»‹"><a href="#1-iptables-ç®€ä»‹" class="headerlink" title="1. iptables ç®€ä»‹"></a>1. iptables ç®€ä»‹</h2><p>iptables æ˜¯ Linux ç³»ç»Ÿä¸­æœ€å¸¸ç”¨çš„é˜²ç«å¢™å·¥å…·ï¼Œå®ƒæä¾›äº†å¼ºå¤§çš„åŒ…è¿‡æ»¤å’Œ NAT åŠŸèƒ½ã€‚é€šè¿‡ iptablesï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ç½‘ç»œè®¿é—®æ§åˆ¶ã€ç«¯å£è½¬å‘ã€è´Ÿè½½å‡è¡¡ç­‰åŠŸèƒ½ã€‚</p><h2 id="2-ä½¿ç”¨åœºæ™¯"><a href="#2-ä½¿ç”¨åœºæ™¯" class="headerlink" title="2. ä½¿ç”¨åœºæ™¯"></a>2. ä½¿ç”¨åœºæ™¯</h2><h3 id="2-1-å¸¸è§åº”ç”¨åœºæ™¯"><a href="#2-1-å¸¸è§åº”ç”¨åœºæ™¯" class="headerlink" title="2.1 å¸¸è§åº”ç”¨åœºæ™¯"></a>2.1 å¸¸è§åº”ç”¨åœºæ™¯</h3><ul><li>æœåŠ¡å™¨å®‰å…¨é˜²æŠ¤</li><li>ç½‘ç»œè®¿é—®æ§åˆ¶</li><li>ç«¯å£è½¬å‘</li><li>NAT è½¬æ¢</li><li>æµé‡ç›‘æ§</li><li>DDoS é˜²æŠ¤</li></ul><h2 id="3-è§„åˆ™é“¾ï¼ˆChainsï¼‰è¯¦è§£"><a href="#3-è§„åˆ™é“¾ï¼ˆChainsï¼‰è¯¦è§£" class="headerlink" title="3. è§„åˆ™é“¾ï¼ˆChainsï¼‰è¯¦è§£"></a>3. è§„åˆ™é“¾ï¼ˆChainsï¼‰è¯¦è§£</h2><h3 id="3-1-å†…ç½®é“¾"><a href="#3-1-å†…ç½®é“¾" class="headerlink" title="3.1 å†…ç½®é“¾"></a>3.1 å†…ç½®é“¾</h3><p>iptables åŒ…å«äº”ä¸ªå†…ç½®é“¾ï¼š</p><ul><li><strong>INPUT</strong>: å¤„ç†è¿›å…¥æœ¬æœºçš„æ•°æ®åŒ…</li><li><strong>OUTPUT</strong>: å¤„ç†ä»æœ¬æœºå‘å‡ºçš„æ•°æ®åŒ…</li><li><strong>FORWARD</strong>: å¤„ç†ç»è¿‡æœ¬æœºè½¬å‘çš„æ•°æ®åŒ…</li><li><strong>PREROUTING</strong>: æ•°æ®åŒ…è¿›å…¥è·¯ç”±è¡¨ä¹‹å‰</li><li><strong>POSTROUTING</strong>: æ•°æ®åŒ…ç¦»å¼€è·¯ç”±è¡¨ä¹‹å</li></ul><h3 id="3-2-å¤„ç†æµç¨‹å›¾"><a href="#3-2-å¤„ç†æµç¨‹å›¾" class="headerlink" title="3.2 å¤„ç†æµç¨‹å›¾"></a>3.2 å¤„ç†æµç¨‹å›¾</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    A[æ•°æ®åŒ…è¿›å…¥] --&gt; B{ç›®æ ‡åœ°å€?}    B --&gt;|æœ¬æœº| C[INPUTé“¾]    B --&gt;|å…¶ä»–ä¸»æœº| D[FORWARDé“¾]    C --&gt; E[æœ¬æœºå¤„ç†]    D --&gt; F[POSTROUTINGé“¾]    E --&gt; G[OUTPUTé“¾]    G --&gt; F    F --&gt; H[å‘é€æ•°æ®åŒ…]  </pre></div><h2 id="4-æŠ€æœ¯åŸç†"><a href="#4-æŠ€æœ¯åŸç†" class="headerlink" title="4. æŠ€æœ¯åŸç†"></a>4. æŠ€æœ¯åŸç†</h2><h3 id="4-1-å·¥ä½œåŸç†"><a href="#4-1-å·¥ä½œåŸç†" class="headerlink" title="4.1 å·¥ä½œåŸç†"></a>4.1 å·¥ä½œåŸç†</h3><p>iptables åŸºäº Netfilter æ¡†æ¶ï¼Œé€šè¿‡é’©å­ï¼ˆhooksï¼‰æœºåˆ¶åœ¨æ•°æ®åŒ…å¤„ç†çš„å…³é”®ä½ç½®æ’å…¥å¤„ç†å‡½æ•°ã€‚æ¯ä¸ªé“¾éƒ½åŒ…å«ä¸€ç³»åˆ—è§„åˆ™ï¼Œæ•°æ®åŒ…ä¼šæŒ‰é¡ºåºåŒ¹é…è¿™äº›è§„åˆ™ã€‚</p><h3 id="4-2-è§„åˆ™åŒ¹é…è¿‡ç¨‹"><a href="#4-2-è§„åˆ™åŒ¹é…è¿‡ç¨‹" class="headerlink" title="4.2 è§„åˆ™åŒ¹é…è¿‡ç¨‹"></a>4.2 è§„åˆ™åŒ¹é…è¿‡ç¨‹</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph LR    A[æ•°æ®åŒ…] --&gt; B[è§„åˆ™1]    B --&gt;|åŒ¹é…| C[æ‰§è¡ŒåŠ¨ä½œ]    B --&gt;|ä¸åŒ¹é…| D[è§„åˆ™2]    D --&gt;|åŒ¹é…| C    D --&gt;|ä¸åŒ¹é…| E[è§„åˆ™3]    E --&gt;|åŒ¹é…| C    E --&gt;|ä¸åŒ¹é…| F[é»˜è®¤ç­–ç•¥]  </pre></div><h2 id="5-è·¯ç”±è¡¨è¯¦è§£"><a href="#5-è·¯ç”±è¡¨è¯¦è§£" class="headerlink" title="5. è·¯ç”±è¡¨è¯¦è§£"></a>5. è·¯ç”±è¡¨è¯¦è§£</h2><h3 id="5-1-è·¯ç”±è¡¨åŸºæœ¬æ¦‚å¿µ"><a href="#5-1-è·¯ç”±è¡¨åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="5.1 è·¯ç”±è¡¨åŸºæœ¬æ¦‚å¿µ"></a>5.1 è·¯ç”±è¡¨åŸºæœ¬æ¦‚å¿µ</h3><p>è·¯ç”±è¡¨æ˜¯ Linux ç³»ç»Ÿä¸­ç”¨äºå†³å®šæ•°æ®åŒ…è½¬å‘è·¯å¾„çš„æ ¸å¿ƒç»„ä»¶ã€‚å®ƒåŒ…å«äº†ç½‘ç»œè·¯ç”±ä¿¡æ¯ï¼Œå‘Šè¯‰ç³»ç»Ÿå¦‚ä½•å°†æ•°æ®åŒ…å‘é€åˆ°ç›®æ ‡åœ°å€ã€‚</p><h3 id="5-2-è·¯ç”±è¡¨ç±»å‹"><a href="#5-2-è·¯ç”±è¡¨ç±»å‹" class="headerlink" title="5.2 è·¯ç”±è¡¨ç±»å‹"></a>5.2 è·¯ç”±è¡¨ç±»å‹</h3><p>Linux ç³»ç»Ÿä¸­æœ‰å¤šä¸ªè·¯ç”±è¡¨ï¼š</p><ol><li><p><strong>ä¸»è·¯ç”±è¡¨ï¼ˆTable 254ï¼‰</strong></p><ul><li>ç³»ç»Ÿé»˜è®¤è·¯ç”±è¡¨</li><li>åŒ…å«æ‰€æœ‰ç½‘ç»œæ¥å£çš„è·¯ç”±ä¿¡æ¯</li></ul></li><li><p><strong>æœ¬åœ°è·¯ç”±è¡¨ï¼ˆTable 255ï¼‰</strong></p><ul><li>åŒ…å«æœ¬åœ°ç½‘ç»œæ¥å£çš„è·¯ç”±</li><li>ç”¨äºæœ¬åœ°é€šä¿¡</li></ul></li><li><p><strong>è‡ªå®šä¹‰è·¯ç”±è¡¨</strong></p><ul><li>ç”¨æˆ·å¯ä»¥æ ¹æ®éœ€è¦åˆ›å»º</li><li>ç”¨äºå®ç°ç­–ç•¥è·¯ç”±</li></ul></li></ol><h3 id="5-3-è·¯ç”±è¡¨ä¸-iptables-çš„å…³ç³»"><a href="#5-3-è·¯ç”±è¡¨ä¸-iptables-çš„å…³ç³»" class="headerlink" title="5.3 è·¯ç”±è¡¨ä¸ iptables çš„å…³ç³»"></a>5.3 è·¯ç”±è¡¨ä¸ iptables çš„å…³ç³»</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    A[æ•°æ®åŒ…] --&gt; B[PREROUTINGé“¾]    B --&gt; C[è·¯ç”±å†³ç­–]    C --&gt; D{ç›®æ ‡åœ°å€?}    D --&gt;|æœ¬æœº| E[INPUTé“¾]    D --&gt;|å…¶ä»–ä¸»æœº| F[FORWARDé“¾]    E --&gt; G[æœ¬åœ°è¿›ç¨‹]    F --&gt; H[POSTROUTINGé“¾]    H --&gt; I[å‘é€æ•°æ®åŒ…]  </pre></div><h3 id="5-4-è·¯ç”±è¡¨æ“ä½œå‘½ä»¤"><a href="#5-4-è·¯ç”±è¡¨æ“ä½œå‘½ä»¤" class="headerlink" title="5.4 è·¯ç”±è¡¨æ“ä½œå‘½ä»¤"></a>5.4 è·¯ç”±è¡¨æ“ä½œå‘½ä»¤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹è·¯ç”±è¡¨</span></span><br><span class="line">ip route show</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ è·¯ç”±</span></span><br><span class="line">ip route add 192.168.1.0/24 via 192.168.0.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤è·¯ç”±</span></span><br><span class="line">ip route del 192.168.1.0/24</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç‰¹å®šè·¯ç”±è¡¨</span></span><br><span class="line">ip route show table 254</span><br></pre></td></tr></table></figure><h3 id="5-5-è·¯ç”±è¡¨å­—æ®µè¯´æ˜"><a href="#5-5-è·¯ç”±è¡¨å­—æ®µè¯´æ˜" class="headerlink" title="5.5 è·¯ç”±è¡¨å­—æ®µè¯´æ˜"></a>5.5 è·¯ç”±è¡¨å­—æ®µè¯´æ˜</h3><ol><li><p><strong>ç›®æ ‡ç½‘ç»œï¼ˆDestinationï¼‰</strong></p><ul><li>æ•°æ®åŒ…è¦åˆ°è¾¾çš„ç½‘ç»œåœ°å€</li><li>å¯ä»¥æ˜¯å…·ä½“ IP æˆ–ç½‘æ®µ</li></ul></li><li><p><strong>ç½‘å…³ï¼ˆGatewayï¼‰</strong></p><ul><li>ä¸‹ä¸€è·³è·¯ç”±å™¨çš„ IP åœ°å€</li><li>ç›´æ¥è¿æ¥æ—¶æ˜¾ç¤º â€œdevâ€ æ¥å£</li></ul></li><li><p><strong>ç½‘ç»œæ¥å£ï¼ˆInterfaceï¼‰</strong></p><ul><li>æ•°æ®åŒ…å‘é€çš„ç½‘ç»œæ¥å£</li><li>å¦‚ eth0ã€wlan0 ç­‰</li></ul></li><li><p><strong>åº¦é‡å€¼ï¼ˆMetricï¼‰</strong></p><ul><li>è·¯ç”±çš„ä¼˜å…ˆçº§</li><li>æ•°å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜</li></ul></li></ol><h3 id="5-6-è·¯ç”±è¡¨ä¸-iptables-çš„äº¤äº’"><a href="#5-6-è·¯ç”±è¡¨ä¸-iptables-çš„äº¤äº’" class="headerlink" title="5.6 è·¯ç”±è¡¨ä¸ iptables çš„äº¤äº’"></a>5.6 è·¯ç”±è¡¨ä¸ iptables çš„äº¤äº’</h3><ol><li><p><strong>PREROUTING é“¾</strong></p><ul><li>åœ¨è·¯ç”±å†³ç­–ä¹‹å‰å¤„ç†æ•°æ®åŒ…</li><li>å¯ä»¥ä¿®æ”¹ç›®æ ‡åœ°å€ï¼ˆDNATï¼‰</li></ul></li><li><p><strong>POSTROUTING é“¾</strong></p><ul><li>åœ¨è·¯ç”±å†³ç­–ä¹‹åå¤„ç†æ•°æ®åŒ…</li><li>å¯ä»¥ä¿®æ”¹æºåœ°å€ï¼ˆSNATï¼‰</li></ul></li><li><p><strong>FORWARD é“¾</strong></p><ul><li>å¤„ç†éœ€è¦è½¬å‘çš„æ•°æ®åŒ…</li><li>åœ¨è·¯ç”±å†³ç­–ä¹‹åæ‰§è¡Œ</li></ul></li></ol><h3 id="5-7-å®é™…åº”ç”¨ç¤ºä¾‹"><a href="#5-7-å®é™…åº”ç”¨ç¤ºä¾‹" class="headerlink" title="5.7 å®é™…åº”ç”¨ç¤ºä¾‹"></a>5.7 å®é™…åº”ç”¨ç¤ºä¾‹</h3><ol><li><p><strong>å¤šç½‘å¡ç¯å¢ƒ</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ·»åŠ é»˜è®¤è·¯ç”±</span></span><br><span class="line">ip route add default via 192.168.1.1 dev eth0</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ ç‰¹å®šç½‘æ®µè·¯ç”±</span></span><br><span class="line">ip route add 10.0.0.0/8 via 192.168.2.1 dev eth1</span><br></pre></td></tr></table></figure></li><li><p><strong>ç­–ç•¥è·¯ç”±</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºè‡ªå®šä¹‰è·¯ç”±è¡¨</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;100 custom&quot;</span> &gt;&gt; /etc/iproute2/rt_tables</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ ç­–ç•¥è·¯ç”±è§„åˆ™</span></span><br><span class="line">ip rule add from 192.168.1.0/24 table custom</span><br></pre></td></tr></table></figure></li></ol><h2 id="6-ä½¿ç”¨æ–¹æ³•"><a href="#6-ä½¿ç”¨æ–¹æ³•" class="headerlink" title="6. ä½¿ç”¨æ–¹æ³•"></a>6. ä½¿ç”¨æ–¹æ³•</h2><h3 id="6-1-åŸºæœ¬å‘½ä»¤"><a href="#6-1-åŸºæœ¬å‘½ä»¤" class="headerlink" title="6.1 åŸºæœ¬å‘½ä»¤"></a>6.1 åŸºæœ¬å‘½ä»¤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹è§„åˆ™</span></span><br><span class="line">iptables -L</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ è§„åˆ™</span></span><br><span class="line">iptables -A INPUT -p tcp --dport 80 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤è§„åˆ™</span></span><br><span class="line">iptables -D INPUT -p tcp --dport 80 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿å­˜è§„åˆ™</span></span><br><span class="line">iptables-save &gt; /etc/iptables/rules.v4</span><br></pre></td></tr></table></figure><h3 id="6-2-å¸¸ç”¨å‚æ•°"><a href="#6-2-å¸¸ç”¨å‚æ•°" class="headerlink" title="6.2 å¸¸ç”¨å‚æ•°"></a>6.2 å¸¸ç”¨å‚æ•°</h3><ul><li><code>-A</code>: æ·»åŠ è§„åˆ™</li><li><code>-D</code>: åˆ é™¤è§„åˆ™</li><li><code>-L</code>: åˆ—å‡ºè§„åˆ™</li><li><code>-F</code>: æ¸…ç©ºè§„åˆ™</li><li><code>-p</code>: æŒ‡å®šåè®®</li><li><code>-s</code>: æºåœ°å€</li><li><code>-d</code>: ç›®æ ‡åœ°å€</li><li><code>--dport</code>: ç›®æ ‡ç«¯å£</li><li><code>-j</code>: æŒ‡å®šåŠ¨ä½œ</li></ul><h2 id="7-Kubernetes-ä¸­çš„-iptables-åº”ç”¨"><a href="#7-Kubernetes-ä¸­çš„-iptables-åº”ç”¨" class="headerlink" title="7. Kubernetes ä¸­çš„ iptables åº”ç”¨"></a>7. Kubernetes ä¸­çš„ iptables åº”ç”¨</h2><h3 id="7-1-kube-proxy-ä¸-iptables"><a href="#7-1-kube-proxy-ä¸-iptables" class="headerlink" title="7.1 kube-proxy ä¸ iptables"></a>7.1 kube-proxy ä¸ iptables</h3><p>åœ¨ Kubernetes ä¸­ï¼Œkube-proxy ç»„ä»¶ä½¿ç”¨ iptables å®ç°ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š</p><ol><li><p><strong>Service è´Ÿè½½å‡è¡¡</strong></p><ul><li>é€šè¿‡ iptables è§„åˆ™å°† Service çš„æµé‡è½¬å‘åˆ°åç«¯ Pod</li><li>å®ç°ç®€å•çš„è½®è¯¢è´Ÿè½½å‡è¡¡</li></ul></li><li><p><strong>Service ç±»å‹æ”¯æŒ</strong></p><ul><li>ClusterIPï¼šå†…éƒ¨è®¿é—®</li><li>NodePortï¼šèŠ‚ç‚¹ç«¯å£æ˜ å°„</li><li>LoadBalancerï¼šå¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨é›†æˆ</li></ul></li></ol><h3 id="7-2-å®ç°åŸç†"><a href="#7-2-å®ç°åŸç†" class="headerlink" title="7.2 å®ç°åŸç†"></a>7.2 å®ç°åŸç†</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    A[å¤–éƒ¨è¯·æ±‚] --&gt; B[NodePort]    B --&gt; C[iptables PREROUTING]    C --&gt; D[Service IP]    D --&gt; E[iptables FORWARD]    E --&gt; F[Pod IP]    F --&gt; G[å®¹å™¨]  </pre></div><h3 id="7-3-å…³é”®-iptables-é“¾"><a href="#7-3-å…³é”®-iptables-é“¾" class="headerlink" title="7.3 å…³é”® iptables é“¾"></a>7.3 å…³é”® iptables é“¾</h3><p>Kubernetes ä¸»è¦ä½¿ç”¨ä»¥ä¸‹ iptables é“¾ï¼š</p><ul><li><strong>KUBE-SERVICES</strong>: å¤„ç†æ‰€æœ‰ Service çš„å…¥å£æµé‡</li><li><strong>KUBE-NODEPORTS</strong>: å¤„ç† NodePort ç±»å‹çš„ Service</li><li><strong>KUBE-POSTROUTING</strong>: å¤„ç† SNATï¼ˆæºåœ°å€è½¬æ¢ï¼‰</li><li><strong>KUBE-MARK-MASQ</strong>: æ ‡è®°éœ€è¦åš SNAT çš„æ•°æ®åŒ…</li></ul><h3 id="7-4-å®é™…æ•ˆæœ"><a href="#7-4-å®é™…æ•ˆæœ" class="headerlink" title="7.4 å®é™…æ•ˆæœ"></a>7.4 å®é™…æ•ˆæœ</h3><ol><li><p><strong>æœåŠ¡å‘ç°</strong></p><ul><li>é€šè¿‡ iptables è§„åˆ™å®ç° Service åˆ° Pod çš„æ˜ å°„</li><li>æ”¯æŒ Pod çš„åŠ¨æ€æ‰©ç¼©å®¹</li></ul></li><li><p><strong>è´Ÿè½½å‡è¡¡</strong></p><ul><li>åŸºäº iptables çš„ç®€å•è½®è¯¢</li><li>æ”¯æŒä¼šè¯äº²å’Œæ€§ï¼ˆSession Affinityï¼‰</li></ul></li><li><p><strong>ç½‘ç»œç­–ç•¥</strong></p><ul><li>å®ç° Pod é—´çš„è®¿é—®æ§åˆ¶</li><li>æ”¯æŒç½‘ç»œéš”ç¦»</li></ul></li></ol><h3 id="7-5-æ€§èƒ½è€ƒè™‘"><a href="#7-5-æ€§èƒ½è€ƒè™‘" class="headerlink" title="7.5 æ€§èƒ½è€ƒè™‘"></a>7.5 æ€§èƒ½è€ƒè™‘</h3><ol><li><p><strong>è§„åˆ™æ•°é‡</strong></p><ul><li>æ¯ä¸ª Service å’Œ Pod éƒ½ä¼šäº§ç”Ÿå¤šæ¡ iptables è§„åˆ™</li><li>å¤§è§„æ¨¡é›†ç¾¤å¯èƒ½å¯¼è‡´è§„åˆ™æ•°é‡æ¿€å¢</li></ul></li><li><p><strong>ä¼˜åŒ–æ–¹æ¡ˆ</strong></p><ul><li>ä½¿ç”¨ ipset ä¼˜åŒ–å¤§é‡ IP åœ°å€çš„åŒ¹é…</li><li>è€ƒè™‘ä½¿ç”¨ IPVS æ¨¡å¼æ›¿ä»£ iptables æ¨¡å¼</li></ul></li></ol><h2 id="8-ç±»ä¼¼æŠ€æœ¯æ‰©å±•"><a href="#8-ç±»ä¼¼æŠ€æœ¯æ‰©å±•" class="headerlink" title="8. ç±»ä¼¼æŠ€æœ¯æ‰©å±•"></a>8. ç±»ä¼¼æŠ€æœ¯æ‰©å±•</h2><h3 id="8-1-ç›¸å…³æŠ€æœ¯"><a href="#8-1-ç›¸å…³æŠ€æœ¯" class="headerlink" title="8.1 ç›¸å…³æŠ€æœ¯"></a>8.1 ç›¸å…³æŠ€æœ¯</h3><ol><li><p><strong>nftables</strong></p><ul><li>iptables çš„ç»§ä»»è€…</li><li>æ›´ç®€æ´çš„è¯­æ³•</li><li>æ›´å¥½çš„æ€§èƒ½</li></ul></li><li><p><strong>eBPF</strong></p><ul><li>æ›´çµæ´»çš„æ•°æ®åŒ…å¤„ç†</li><li>å¯ç¼–ç¨‹æ€§æ›´å¼º</li><li>æ€§èƒ½æ›´å¥½</li></ul></li><li><p><strong>ipset</strong></p><ul><li>é«˜æ•ˆçš„ IP åœ°å€é›†åˆç®¡ç†</li><li>ä¸ iptables é…åˆä½¿ç”¨</li><li>æå‡è§„åˆ™åŒ¹é…æ•ˆç‡</li></ul></li></ol><h3 id="8-2-æŠ€æœ¯å¯¹æ¯”"><a href="#8-2-æŠ€æœ¯å¯¹æ¯”" class="headerlink" title="8.2 æŠ€æœ¯å¯¹æ¯”"></a>8.2 æŠ€æœ¯å¯¹æ¯”</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    A[é˜²ç«å¢™æŠ€æœ¯] --&gt; B[iptables]    A --&gt; C[nftables]    A --&gt; D[eBPF]    B --&gt; E[æˆç†Ÿç¨³å®š]    B --&gt; F[ä½¿ç”¨å¹¿æ³›]    C --&gt; G[è¯­æ³•ç®€æ´]    C --&gt; H[æ€§èƒ½ä¼˜åŒ–]    D --&gt; I[é«˜åº¦å¯ç¼–ç¨‹]    D --&gt; J[æ€§èƒ½æœ€ä½³]  </pre></div><h2 id="9-æœ€ä½³å®è·µ"><a href="#9-æœ€ä½³å®è·µ" class="headerlink" title="9. æœ€ä½³å®è·µ"></a>9. æœ€ä½³å®è·µ</h2><ol><li>è§„åˆ™é¡ºåºä¼˜åŒ–</li><li>ä½¿ç”¨ ipset ç®¡ç†å¤§é‡ IP</li><li>å®šæœŸå¤‡ä»½è§„åˆ™</li><li>ä½¿ç”¨æ³¨é‡Šè¯´æ˜è§„åˆ™ç”¨é€”</li><li>éµå¾ªæœ€å°æƒé™åŸåˆ™</li></ol><h2 id="10-æ€»ç»“"><a href="#10-æ€»ç»“" class="headerlink" title="10. æ€»ç»“"></a>10. æ€»ç»“</h2><p>iptables ä½œä¸º Linux ç³»ç»Ÿä¸­æœ€å¼ºå¤§çš„é˜²ç«å¢™å·¥å…·ï¼Œé€šè¿‡å…¶çµæ´»çš„è§„åˆ™é“¾æœºåˆ¶ï¼Œå¯ä»¥å®ç°å¤æ‚çš„ç½‘ç»œæ§åˆ¶åŠŸèƒ½ã€‚ç†è§£å…¶å·¥ä½œåŸç†å’Œæ­£ç¡®ä½¿ç”¨ï¼Œå¯¹äºç³»ç»Ÿå®‰å…¨å’Œç½‘ç»œç®¡ç†éƒ½è‡³å…³é‡è¦ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ol><li>iptables å®˜æ–¹æ–‡æ¡£</li><li>Linux Netfilter æ–‡æ¡£</li><li>nftables å®˜æ–¹æ–‡æ¡£</li><li>eBPF æŠ€æœ¯æ–‡æ¡£</li></ol>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> ç½‘ç»œ </tag>
            
            <tag> å®‰å…¨ </tag>
            
            <tag> é˜²ç«å¢™ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux ç½‘ç»œåŸºç¡€æ¦‚å¿µè¯¦è§£ï¼šä»ç¡¬ä»¶åˆ°åº”ç”¨</title>
      <link href="/2025/06/13/linux-network-basics/"/>
      <url>/2025/06/13/linux-network-basics/</url>
      
        <content type="html"><![CDATA[<h1 id="Linux-ç½‘ç»œåŸºç¡€æ¦‚å¿µè¯¦è§£ï¼šä»ç¡¬ä»¶åˆ°åº”ç”¨"><a href="#Linux-ç½‘ç»œåŸºç¡€æ¦‚å¿µè¯¦è§£ï¼šä»ç¡¬ä»¶åˆ°åº”ç”¨" class="headerlink" title="Linux ç½‘ç»œåŸºç¡€æ¦‚å¿µè¯¦è§£ï¼šä»ç¡¬ä»¶åˆ°åº”ç”¨"></a>Linux ç½‘ç»œåŸºç¡€æ¦‚å¿µè¯¦è§£ï¼šä»ç¡¬ä»¶åˆ°åº”ç”¨</h1><h2 id="1-ç½‘ç»œç¡¬ä»¶åŸºç¡€"><a href="#1-ç½‘ç»œç¡¬ä»¶åŸºç¡€" class="headerlink" title="1. ç½‘ç»œç¡¬ä»¶åŸºç¡€"></a>1. ç½‘ç»œç¡¬ä»¶åŸºç¡€</h2><h3 id="1-1-ç½‘å¡ï¼ˆNetwork-Interface-Cardï¼ŒNICï¼‰"><a href="#1-1-ç½‘å¡ï¼ˆNetwork-Interface-Cardï¼ŒNICï¼‰" class="headerlink" title="1.1 ç½‘å¡ï¼ˆNetwork Interface Cardï¼ŒNICï¼‰"></a>1.1 ç½‘å¡ï¼ˆNetwork Interface Cardï¼ŒNICï¼‰</h3><p>ç½‘å¡æ˜¯è®¡ç®—æœºä¸ç½‘ç»œä¹‹é—´çš„ç‰©ç†æ¥å£ï¼Œè´Ÿè´£ç½‘ç»œæ•°æ®çš„æ”¶å‘ã€‚å®ƒæ˜¯ç½‘ç»œé€šä¿¡çš„ç‰©ç†åŸºç¡€ã€‚</p><h4 id="1-1-1-ç½‘å¡ç±»å‹"><a href="#1-1-1-ç½‘å¡ç±»å‹" class="headerlink" title="1.1.1 ç½‘å¡ç±»å‹"></a>1.1.1 ç½‘å¡ç±»å‹</h4><ol><li><p><strong>æŒ‰æ¥å£ç±»å‹</strong></p><ul><li>RJ45 æ¥å£ï¼šæœ€å¸¸è§çš„ä»¥å¤ªç½‘æ¥å£</li><li>å…‰çº¤æ¥å£ï¼šæ”¯æŒæ›´é«˜é€Ÿç‡å’Œæ›´é•¿è·ç¦»</li><li>æ— çº¿æ¥å£ï¼šæ”¯æŒ WiFi è¿æ¥</li><li>USB æ¥å£ï¼šä¾¿æºå¼ç½‘å¡</li></ul></li><li><p><strong>æŒ‰é€Ÿç‡åˆ†ç±»</strong></p><ul><li>10Mbpsï¼šæ—©æœŸä»¥å¤ªç½‘</li><li>100Mbpsï¼šå¿«é€Ÿä»¥å¤ªç½‘</li><li>1Gbpsï¼šåƒå…†ä»¥å¤ªç½‘</li><li>10Gbpsï¼šä¸‡å…†ä»¥å¤ªç½‘</li><li>40Gbps&#x2F;100Gbpsï¼šé«˜é€Ÿæ•°æ®ä¸­å¿ƒ</li></ul></li><li><p><strong>æŒ‰åŠŸèƒ½åˆ†ç±»</strong></p><ul><li>æ™®é€šç½‘å¡ï¼šåŸºæœ¬ç½‘ç»œè¿æ¥</li><li>æœåŠ¡å™¨ç½‘å¡ï¼šæ”¯æŒå¤šé˜Ÿåˆ—ã€TOE</li><li>æ™ºèƒ½ç½‘å¡ï¼šæ”¯æŒç¡¬ä»¶å¸è½½</li><li>è™šæ‹ŸåŒ–ç½‘å¡ï¼šæ”¯æŒ SR-IOV</li></ul></li></ol><h4 id="1-1-2-ç½‘å¡å·¥ä½œåŸç†"><a href="#1-1-2-ç½‘å¡å·¥ä½œåŸç†" class="headerlink" title="1.1.2 ç½‘å¡å·¥ä½œåŸç†"></a>1.1.2 ç½‘å¡å·¥ä½œåŸç†</h4><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    A[ç½‘å¡] --&gt; B[ç‰©ç†å±‚]    B --&gt; C[æ•°æ®é“¾è·¯å±‚]    C --&gt; D[ç½‘ç»œå±‚]        B --&gt; E[ä¿¡å·å¤„ç†]    B --&gt; F[æ—¶é’ŸåŒæ­¥]    B --&gt; G[ç¼–ç è§£ç ]        C --&gt; H[MACåœ°å€]    C --&gt; I[å¸§å¤„ç†]    C --&gt; J[é”™è¯¯æ£€æµ‹]        D --&gt; K[æ•°æ®åŒ…å¤„ç†]    D --&gt; L[åè®®æ”¯æŒ]    D --&gt; M[æµé‡æ§åˆ¶]  </pre></div><h4 id="1-1-3-ç½‘å¡å¯„å­˜å™¨"><a href="#1-1-3-ç½‘å¡å¯„å­˜å™¨" class="headerlink" title="1.1.3 ç½‘å¡å¯„å­˜å™¨"></a>1.1.3 ç½‘å¡å¯„å­˜å™¨</h4><ol><li><p><strong>æ§åˆ¶å¯„å­˜å™¨</strong></p><ul><li>å‘½ä»¤å¯„å­˜å™¨ï¼šæ§åˆ¶ç½‘å¡æ“ä½œ</li><li>çŠ¶æ€å¯„å­˜å™¨ï¼šåæ˜ ç½‘å¡çŠ¶æ€</li><li>ä¸­æ–­å¯„å­˜å™¨ï¼šç®¡ç†ä¸­æ–­</li></ul></li><li><p><strong>æ•°æ®å¯„å­˜å™¨</strong></p><ul><li>å‘é€ç¼“å†²åŒº</li><li>æ¥æ”¶ç¼“å†²åŒº</li><li>DMA æ§åˆ¶</li></ul></li><li><p><strong>é…ç½®å¯„å­˜å™¨</strong></p><ul><li>MAC åœ°å€</li><li>å·¥ä½œæ¨¡å¼</li><li>é€Ÿç‡è®¾ç½®</li></ul></li></ol><h3 id="1-2-ç½‘å¡é©±åŠ¨"><a href="#1-2-ç½‘å¡é©±åŠ¨" class="headerlink" title="1.2 ç½‘å¡é©±åŠ¨"></a>1.2 ç½‘å¡é©±åŠ¨</h3><p>ç½‘å¡é©±åŠ¨æ˜¯æ“ä½œç³»ç»Ÿä¸ç½‘å¡ç¡¬ä»¶ä¹‹é—´çš„æ¡¥æ¢ï¼Œè´Ÿè´£ç®¡ç†ç½‘å¡ç¡¬ä»¶èµ„æºï¼Œå®ç°æ•°æ®åŒ…çš„æ”¶å‘ã€‚</p><h4 id="1-2-1-é©±åŠ¨æ¶æ„"><a href="#1-2-1-é©±åŠ¨æ¶æ„" class="headerlink" title="1.2.1 é©±åŠ¨æ¶æ„"></a>1.2.1 é©±åŠ¨æ¶æ„</h4><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    A[åº”ç”¨å±‚] --&gt; B[Socket API]    B --&gt; C[ç½‘ç»œåè®®æ ˆ]    C --&gt; D[ç½‘å¡é©±åŠ¨]    D --&gt; E[ç½‘å¡ç¡¬ä»¶]        D --&gt; F[åˆå§‹åŒ–æ¨¡å—]    D --&gt; G[æ•°æ®æ”¶å‘æ¨¡å—]    D --&gt; H[ä¸­æ–­å¤„ç†æ¨¡å—]    D --&gt; I[çŠ¶æ€ç®¡ç†æ¨¡å—]  </pre></div><h4 id="1-2-2-é©±åŠ¨åŠŸèƒ½è¯¦è§£"><a href="#1-2-2-é©±åŠ¨åŠŸèƒ½è¯¦è§£" class="headerlink" title="1.2.2 é©±åŠ¨åŠŸèƒ½è¯¦è§£"></a>1.2.2 é©±åŠ¨åŠŸèƒ½è¯¦è§£</h4><ol><li><p><strong>åˆå§‹åŒ–åŠŸèƒ½</strong></p><ul><li>ç¡¬ä»¶æ£€æµ‹å’Œè¯†åˆ«</li><li>å¯„å­˜å™¨åˆå§‹åŒ–</li><li>ä¸­æ–­è®¾ç½®</li><li>DMA é…ç½®</li><li>ç¼“å†²åŒºåˆ†é…</li></ul></li><li><p><strong>æ•°æ®æ”¶å‘åŠŸèƒ½</strong></p><ul><li>æ•°æ®åŒ…å°è£…</li><li>æ ¡éªŒå’Œè®¡ç®—</li><li>DMA ä¼ è¾“</li><li>é”™è¯¯å¤„ç†</li><li>æµé‡æ§åˆ¶</li></ul></li><li><p><strong>ä¸­æ–­å¤„ç†åŠŸèƒ½</strong></p><ul><li>æ¥æ”¶ä¸­æ–­</li><li>å‘é€å®Œæˆä¸­æ–­</li><li>é”™è¯¯ä¸­æ–­</li><li>çŠ¶æ€å˜åŒ–ä¸­æ–­</li></ul></li><li><p><strong>çŠ¶æ€ç®¡ç†åŠŸèƒ½</strong></p><ul><li>é“¾è·¯çŠ¶æ€ç›‘æ§</li><li>é”™è¯¯ç»Ÿè®¡</li><li>æ€§èƒ½ç»Ÿè®¡</li><li>ç”µæºç®¡ç†</li></ul></li></ol><h4 id="1-2-3-é©±åŠ¨å·¥ä½œæµç¨‹"><a href="#1-2-3-é©±åŠ¨å·¥ä½œæµç¨‹" class="headerlink" title="1.2.3 é©±åŠ¨å·¥ä½œæµç¨‹"></a>1.2.3 é©±åŠ¨å·¥ä½œæµç¨‹</h4><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  sequenceDiagram    participant App as åº”ç”¨ç¨‹åº    participant Kernel as å†…æ ¸    participant Driver as ç½‘å¡é©±åŠ¨    participant NIC as ç½‘å¡ç¡¬ä»¶        App-&gt;&gt;Kernel: ç³»ç»Ÿè°ƒç”¨    Kernel-&gt;&gt;Driver: é©±åŠ¨æ¥å£è°ƒç”¨    Driver-&gt;&gt;NIC: å†™å¯„å­˜å™¨    NIC-&gt;&gt;Driver: ä¸­æ–­é€šçŸ¥    Driver-&gt;&gt;Kernel: ä¸­æ–­å¤„ç†    Kernel-&gt;&gt;App: è¿”å›ç»“æœ  </pre></div><h2 id="2-ç½‘ç»œæ¥å£"><a href="#2-ç½‘ç»œæ¥å£" class="headerlink" title="2. ç½‘ç»œæ¥å£"></a>2. ç½‘ç»œæ¥å£</h2><h3 id="2-1-ç‰©ç†æ¥å£"><a href="#2-1-ç‰©ç†æ¥å£" class="headerlink" title="2.1 ç‰©ç†æ¥å£"></a>2.1 ç‰©ç†æ¥å£</h3><h4 id="2-1-1-å•ç«¯å£ç½‘å¡"><a href="#2-1-1-å•ç«¯å£ç½‘å¡" class="headerlink" title="2.1.1 å•ç«¯å£ç½‘å¡"></a>2.1.1 å•ç«¯å£ç½‘å¡</h4><ol><li><p><strong>åŸºæœ¬ç‰¹æ€§</strong></p><ul><li>å•ä¸ªç‰©ç†æ¥å£</li><li>æ ‡å‡† MAC åœ°å€</li><li>åŸºæœ¬ç½‘ç»œåŠŸèƒ½</li><li>é€‚ç”¨äºæ™®é€šå·¥ä½œç«™</li></ul></li><li><p><strong>ä½¿ç”¨åœºæ™¯</strong></p><ul><li>ä¸ªäººç”µè„‘</li><li>æ™®é€šæœåŠ¡å™¨</li><li>ç½‘ç»œç»ˆç«¯è®¾å¤‡</li></ul></li></ol><h4 id="2-1-2-å¤šç«¯å£ç½‘å¡"><a href="#2-1-2-å¤šç«¯å£ç½‘å¡" class="headerlink" title="2.1.2 å¤šç«¯å£ç½‘å¡"></a>2.1.2 å¤šç«¯å£ç½‘å¡</h4><ol><li><p><strong>ç±»å‹</strong></p><ul><li>åŒç«¯å£ç½‘å¡</li><li>å››ç«¯å£ç½‘å¡</li><li>å…«ç«¯å£ç½‘å¡</li></ul></li><li><p><strong>é«˜çº§ç‰¹æ€§</strong></p><ul><li>é“¾è·¯èšåˆ</li><li>è´Ÿè½½å‡è¡¡</li><li>æ•…éšœè½¬ç§»</li><li>å¤šé˜Ÿåˆ—æ”¯æŒ</li></ul></li><li><p><strong>åº”ç”¨åœºæ™¯</strong></p><ul><li>æœåŠ¡å™¨</li><li>ç½‘ç»œè®¾å¤‡</li><li>å­˜å‚¨è®¾å¤‡</li></ul></li></ol><h3 id="2-2-è™šæ‹Ÿæ¥å£"><a href="#2-2-è™šæ‹Ÿæ¥å£" class="headerlink" title="2.2 è™šæ‹Ÿæ¥å£"></a>2.2 è™šæ‹Ÿæ¥å£</h3><h4 id="2-2-1-VLAN-æ¥å£"><a href="#2-2-1-VLAN-æ¥å£" class="headerlink" title="2.2.1 VLAN æ¥å£"></a>2.2.1 VLAN æ¥å£</h4><ol><li><p><strong>å·¥ä½œåŸç†</strong></p><ul><li>åŸºäº 802.1Q åè®®</li><li>åœ¨æ•°æ®å¸§ä¸­æ·»åŠ  VLAN æ ‡ç­¾</li><li>å®ç°è™šæ‹Ÿå±€åŸŸç½‘éš”ç¦»</li></ul></li><li><p><strong>é…ç½®ç¤ºä¾‹</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»º VLAN æ¥å£</span></span><br><span class="line">ip <span class="built_in">link</span> add <span class="built_in">link</span> eth0 name eth0.100 <span class="built_in">type</span> vlan <span class="built_in">id</span> 100</span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½® IP åœ°å€</span></span><br><span class="line">ip addr add 192.168.100.1/24 dev eth0.100</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯ç”¨æ¥å£</span></span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> eth0.100 up</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ VLAN ä¿¡æ¯</span></span><br><span class="line">ip -d <span class="built_in">link</span> show eth0.100</span><br></pre></td></tr></table></figure></li><li><p><strong>ä½¿ç”¨åœºæ™¯</strong></p><ul><li>ç½‘ç»œéš”ç¦»</li><li>å®‰å…¨åŒºåŸŸåˆ’åˆ†</li><li>æµé‡æ§åˆ¶</li></ul></li></ol><h4 id="2-2-2-å­æ¥å£"><a href="#2-2-2-å­æ¥å£" class="headerlink" title="2.2.2 å­æ¥å£"></a>2.2.2 å­æ¥å£</h4><ol><li><p><strong>ç‰¹æ€§</strong></p><ul><li>åŸºäºç‰©ç†æ¥å£åˆ›å»º</li><li>æ”¯æŒå¤šä¸ª IP åœ°å€</li><li>ç‹¬ç«‹çš„è·¯ç”±è¡¨</li><li>ç‹¬ç«‹çš„é˜²ç«å¢™è§„åˆ™</li></ul></li><li><p><strong>é…ç½®ç¤ºä¾‹</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºå­æ¥å£</span></span><br><span class="line">ip addr add 192.168.1.100/24 dev eth0:0</span><br><span class="line">ip addr add 192.168.2.100/24 dev eth0:1</span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®è·¯ç”±</span></span><br><span class="line">ip route add 192.168.1.0/24 dev eth0:0</span><br><span class="line">ip route add 192.168.2.0/24 dev eth0:1</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å­æ¥å£</span></span><br><span class="line">ip addr show eth0:0</span><br></pre></td></tr></table></figure></li><li><p><strong>åº”ç”¨åœºæ™¯</strong></p><ul><li>å¤šç½‘æ®µé…ç½®</li><li>ç½‘ç»œéš”ç¦»</li><li>è´Ÿè½½å‡è¡¡</li></ul></li></ol><h4 id="2-2-3-ç½‘æ¡¥æ¥å£"><a href="#2-2-3-ç½‘æ¡¥æ¥å£" class="headerlink" title="2.2.3 ç½‘æ¡¥æ¥å£"></a>2.2.3 ç½‘æ¡¥æ¥å£</h4><ol><li><p><strong>å·¥ä½œåŸç†</strong></p><ul><li>äºŒå±‚äº¤æ¢åŠŸèƒ½</li><li>å­¦ä¹  MAC åœ°å€</li><li>è½¬å‘æ•°æ®å¸§</li><li>æ”¯æŒ STP åè®®</li></ul></li><li><p><strong>é…ç½®ç¤ºä¾‹</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºç½‘æ¡¥</span></span><br><span class="line">brctl addbr br0</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ æ¥å£</span></span><br><span class="line">brctl addif br0 eth0</span><br><span class="line">brctl addif br0 eth1</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯ç”¨ç½‘æ¡¥</span></span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> br0 up</span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½® IP åœ°å€</span></span><br><span class="line">ip addr add 192.168.1.1/24 dev br0</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç½‘æ¡¥ä¿¡æ¯</span></span><br><span class="line">brctl show</span><br></pre></td></tr></table></figure></li><li><p><strong>ä½¿ç”¨åœºæ™¯</strong></p><ul><li>è™šæ‹ŸåŒ–ç¯å¢ƒ</li><li>å®¹å™¨ç½‘ç»œ</li><li>ç½‘ç»œéš”ç¦»</li></ul></li></ol><h4 id="2-2-4-ç»‘å®šæ¥å£ï¼ˆBondï¼‰"><a href="#2-2-4-ç»‘å®šæ¥å£ï¼ˆBondï¼‰" class="headerlink" title="2.2.4 ç»‘å®šæ¥å£ï¼ˆBondï¼‰"></a>2.2.4 ç»‘å®šæ¥å£ï¼ˆBondï¼‰</h4><ol><li><p><strong>ç»‘å®šæ¨¡å¼</strong></p><ul><li>mode&#x3D;0ï¼šè½®è¯¢æ¨¡å¼</li><li>mode&#x3D;1ï¼šä¸»å¤‡æ¨¡å¼</li><li>mode&#x3D;2ï¼šXOR æ¨¡å¼</li><li>mode&#x3D;3ï¼šå¹¿æ’­æ¨¡å¼</li><li>mode&#x3D;4ï¼š802.3ad æ¨¡å¼</li><li>mode&#x3D;5ï¼šé€‚é…å™¨ä¼ è¾“è´Ÿè½½å‡è¡¡</li><li>mode&#x3D;6ï¼šé€‚é…å™¨é€‚åº”æ€§è´Ÿè½½å‡è¡¡</li></ul></li><li><p><strong>é…ç½®ç¤ºä¾‹</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºç»‘å®šæ¥å£</span></span><br><span class="line">ip <span class="built_in">link</span> add bond0 <span class="built_in">type</span> bond</span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®ç»‘å®šæ¨¡å¼</span></span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /sys/class/net/bond0/bonding/mode</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ ä»å±æ¥å£</span></span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> eth0 master bond0</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> eth1 master bond0</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯ç”¨ç»‘å®šæ¥å£</span></span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> bond0 up</span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½® IP åœ°å€</span></span><br><span class="line">ip addr add 192.168.1.100/24 dev bond0</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç»‘å®šçŠ¶æ€</span></span><br><span class="line"><span class="built_in">cat</span> /proc/net/bonding/bond0</span><br></pre></td></tr></table></figure></li><li><p><strong>åº”ç”¨åœºæ™¯</strong></p><ul><li>é«˜å¯ç”¨æ€§</li><li>è´Ÿè½½å‡è¡¡</li><li>å¸¦å®½èšåˆ</li></ul></li></ol><h2 id="3-ç½‘ç»œåè®®æ ˆ"><a href="#3-ç½‘ç»œåè®®æ ˆ" class="headerlink" title="3. ç½‘ç»œåè®®æ ˆ"></a>3. ç½‘ç»œåè®®æ ˆ</h2><h3 id="3-1-åè®®å±‚æ¬¡"><a href="#3-1-åè®®å±‚æ¬¡" class="headerlink" title="3.1 åè®®å±‚æ¬¡"></a>3.1 åè®®å±‚æ¬¡</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    A[åº”ç”¨å±‚] --&gt; B[ä¼ è¾“å±‚]    B --&gt; C[ç½‘ç»œå±‚]    C --&gt; D[æ•°æ®é“¾è·¯å±‚]    D --&gt; E[ç‰©ç†å±‚]        A --&gt; F[HTTP&#x2F;FTP&#x2F;DNS]    A --&gt; G[SMTP&#x2F;POP3]    A --&gt; H[SSH&#x2F;TELNET]        B --&gt; I[TCP]    B --&gt; J[UDP]        C --&gt; K[IP]    C --&gt; L[ICMP]    C --&gt; M[IGMP]        D --&gt; N[ä»¥å¤ªç½‘]    D --&gt; O[ARP]    D --&gt; P[RARP]        E --&gt; Q[ç½‘å¡é©±åŠ¨]    E --&gt; R[ç‰©ç†ä»‹è´¨]  </pre></div><h3 id="3-2-å…³é”®åè®®è¯¦è§£"><a href="#3-2-å…³é”®åè®®è¯¦è§£" class="headerlink" title="3.2 å…³é”®åè®®è¯¦è§£"></a>3.2 å…³é”®åè®®è¯¦è§£</h3><h4 id="3-2-1-TCP-IP-åè®®æ—"><a href="#3-2-1-TCP-IP-åè®®æ—" class="headerlink" title="3.2.1 TCP&#x2F;IP åè®®æ—"></a>3.2.1 TCP&#x2F;IP åè®®æ—</h4><ol><li><p><strong>IP åè®®</strong></p><ul><li>ç‰ˆæœ¬ï¼šIPv4&#x2F;IPv6</li><li>åŠŸèƒ½ï¼šè·¯ç”±å’Œå¯»å€</li><li>ç‰¹ç‚¹ï¼šæ— è¿æ¥ã€ä¸å¯é </li><li>æ•°æ®åŒ…æ ¼å¼ï¼š<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">+------------------+</span><br><span class="line">|    ç‰ˆæœ¬/å¤´é•¿åº¦    |</span><br><span class="line">+------------------+</span><br><span class="line">|    æœåŠ¡ç±»å‹      |</span><br><span class="line">+------------------+</span><br><span class="line">|    æ€»é•¿åº¦        |</span><br><span class="line">+------------------+</span><br><span class="line">|    æ ‡è¯†          |</span><br><span class="line">+------------------+</span><br><span class="line">|    æ ‡å¿—/ç‰‡åç§»    |</span><br><span class="line">+------------------+</span><br><span class="line">|    TTL          |</span><br><span class="line">+------------------+</span><br><span class="line">|    åè®®          |</span><br><span class="line">+------------------+</span><br><span class="line">|    æ ¡éªŒå’Œ        |</span><br><span class="line">+------------------+</span><br><span class="line">|    æºIPåœ°å€      |</span><br><span class="line">+------------------+</span><br><span class="line">|    ç›®æ ‡IPåœ°å€    |</span><br><span class="line">+------------------+</span><br><span class="line">|    é€‰é¡¹          |</span><br><span class="line">+------------------+</span><br><span class="line">|    æ•°æ®          |</span><br><span class="line">+------------------+</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>TCP åè®®</strong></p><ul><li>ç‰¹ç‚¹ï¼šé¢å‘è¿æ¥ã€å¯é ä¼ è¾“</li><li>åŠŸèƒ½ï¼šæµé‡æ§åˆ¶ã€æ‹¥å¡æ§åˆ¶</li><li>æ•°æ®åŒ…æ ¼å¼ï¼š<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">+------------------+</span><br><span class="line">|    æºç«¯å£        |</span><br><span class="line">+------------------+</span><br><span class="line">|    ç›®æ ‡ç«¯å£      |</span><br><span class="line">+------------------+</span><br><span class="line">|    åºåˆ—å·        |</span><br><span class="line">+------------------+</span><br><span class="line">|    ç¡®è®¤å·        |</span><br><span class="line">+------------------+</span><br><span class="line">|    æ ‡å¿—ä½        |</span><br><span class="line">+------------------+</span><br><span class="line">|    çª—å£å¤§å°      |</span><br><span class="line">+------------------+</span><br><span class="line">|    æ ¡éªŒå’Œ        |</span><br><span class="line">+------------------+</span><br><span class="line">|    ç´§æ€¥æŒ‡é’ˆ      |</span><br><span class="line">+------------------+</span><br><span class="line">|    é€‰é¡¹          |</span><br><span class="line">+------------------+</span><br><span class="line">|    æ•°æ®          |</span><br><span class="line">+------------------+</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>UDP åè®®</strong></p><ul><li>ç‰¹ç‚¹ï¼šæ— è¿æ¥ã€ä¸å¯é </li><li>åŠŸèƒ½ï¼šç®€å•é«˜æ•ˆ</li><li>æ•°æ®åŒ…æ ¼å¼ï¼š<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+------------------+</span><br><span class="line">|    æºç«¯å£        |</span><br><span class="line">+------------------+</span><br><span class="line">|    ç›®æ ‡ç«¯å£      |</span><br><span class="line">+------------------+</span><br><span class="line">|    é•¿åº¦          |</span><br><span class="line">+------------------+</span><br><span class="line">|    æ ¡éªŒå’Œ        |</span><br><span class="line">+------------------+</span><br><span class="line">|    æ•°æ®          |</span><br><span class="line">+------------------+</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>ICMP åè®®</strong></p><ul><li>åŠŸèƒ½ï¼šç½‘ç»œè¯Šæ–­</li><li>ç±»å‹ï¼šè¯·æ±‚&#x2F;åº”ç­”</li><li>å¸¸è§æ¶ˆæ¯ï¼š<ul><li>Echo Request&#x2F;Reply</li><li>Destination Unreachable</li><li>Time Exceeded</li><li>Parameter Problem</li></ul></li></ul></li></ol><h4 id="3-2-2-åº”ç”¨å±‚åè®®"><a href="#3-2-2-åº”ç”¨å±‚åè®®" class="headerlink" title="3.2.2 åº”ç”¨å±‚åè®®"></a>3.2.2 åº”ç”¨å±‚åè®®</h4><ol><li><p><strong>HTTP åè®®</strong></p><ul><li>ç‰ˆæœ¬ï¼šHTTP&#x2F;1.0ã€HTTP&#x2F;1.1ã€HTTP&#x2F;2</li><li>ç‰¹ç‚¹ï¼šæ— çŠ¶æ€ã€å¯æ‰©å±•</li><li>è¯·æ±‚æ–¹æ³•ï¼šGETã€POSTã€PUTã€DELETE</li><li>çŠ¶æ€ç ï¼š200ã€404ã€500 ç­‰</li></ul></li><li><p><strong>FTP åè®®</strong></p><ul><li>æ¨¡å¼ï¼šä¸»åŠ¨æ¨¡å¼ã€è¢«åŠ¨æ¨¡å¼</li><li>åŠŸèƒ½ï¼šæ–‡ä»¶ä¼ è¾“</li><li>å‘½ä»¤ï¼šPUTã€GETã€LIST</li><li>å®‰å…¨ï¼šFTPSã€SFTP</li></ul></li><li><p><strong>DNS åè®®</strong></p><ul><li>åŠŸèƒ½ï¼šåŸŸåè§£æ</li><li>è®°å½•ç±»å‹ï¼šAã€AAAAã€CNAMEã€MX</li><li>æŸ¥è¯¢ç±»å‹ï¼šé€’å½’ã€è¿­ä»£</li><li>ç«¯å£ï¼š53</li></ul></li><li><p><strong>SMTP åè®®</strong></p><ul><li>åŠŸèƒ½ï¼šé‚®ä»¶ä¼ è¾“</li><li>å‘½ä»¤ï¼šHELOã€MAILã€RCPTã€DATA</li><li>å®‰å…¨ï¼šSTARTTLSã€SMTPS</li><li>ç«¯å£ï¼š25ã€465</li></ul></li></ol><h2 id="4-ç½‘ç»œç«¯å£"><a href="#4-ç½‘ç»œç«¯å£" class="headerlink" title="4. ç½‘ç»œç«¯å£"></a>4. ç½‘ç»œç«¯å£</h2><h3 id="4-1-ç«¯å£æ¦‚å¿µè¯¦è§£"><a href="#4-1-ç«¯å£æ¦‚å¿µè¯¦è§£" class="headerlink" title="4.1 ç«¯å£æ¦‚å¿µè¯¦è§£"></a>4.1 ç«¯å£æ¦‚å¿µè¯¦è§£</h3><ol><li><p><strong>ç«¯å£èŒƒå›´</strong></p><ul><li>0-1023ï¼šçŸ¥åç«¯å£</li><li>1024-49151ï¼šæ³¨å†Œç«¯å£</li><li>49152-65535ï¼šåŠ¨æ€ç«¯å£</li></ul></li><li><p><strong>ç«¯å£çŠ¶æ€</strong></p><ul><li>LISTENï¼šç›‘å¬çŠ¶æ€</li><li>ESTABLISHEDï¼šå·²å»ºç«‹è¿æ¥</li><li>TIME_WAITï¼šç­‰å¾…å…³é—­</li><li>CLOSE_WAITï¼šç­‰å¾…å…³é—­</li><li>FIN_WAITï¼šç­‰å¾…ç»“æŸ</li></ul></li><li><p><strong>ç«¯å£å¤ç”¨</strong></p><ul><li>SO_REUSEADDR</li><li>SO_REUSEPORT</li><li>å¤šè¿›ç¨‹ç›‘å¬</li><li>è´Ÿè½½å‡è¡¡</li></ul></li></ol><h3 id="4-2-å¸¸è§ç«¯å£åŠæœåŠ¡"><a href="#4-2-å¸¸è§ç«¯å£åŠæœåŠ¡" class="headerlink" title="4.2 å¸¸è§ç«¯å£åŠæœåŠ¡"></a>4.2 å¸¸è§ç«¯å£åŠæœåŠ¡</h3><ol><li><p><strong>Web æœåŠ¡</strong></p><ul><li>80ï¼šHTTP</li><li>443ï¼šHTTPS</li><li>8080ï¼šä»£ç†æœåŠ¡å™¨</li><li>8443ï¼šHTTPS ä»£ç†</li></ul></li><li><p><strong>æ•°æ®åº“æœåŠ¡</strong></p><ul><li>3306ï¼šMySQL</li><li>5432ï¼šPostgreSQL</li><li>6379ï¼šRedis</li><li>27017ï¼šMongoDB</li></ul></li><li><p><strong>é‚®ä»¶æœåŠ¡</strong></p><ul><li>25ï¼šSMTP</li><li>110ï¼šPOP3</li><li>143ï¼šIMAP</li><li>465ï¼šSMTPS</li></ul></li><li><p><strong>æ–‡ä»¶æœåŠ¡</strong></p><ul><li>21ï¼šFTP</li><li>22ï¼šSFTP</li><li>445ï¼šSMB</li><li>2049ï¼šNFS</li></ul></li><li><p><strong>è¿œç¨‹ç®¡ç†</strong></p><ul><li>22ï¼šSSH</li><li>23ï¼šTelnet</li><li>3389ï¼šRDP</li><li>5900ï¼šVNC</li></ul></li></ol><h2 id="5-é˜²ç«å¢™"><a href="#5-é˜²ç«å¢™" class="headerlink" title="5. é˜²ç«å¢™"></a>5. é˜²ç«å¢™</h2><h3 id="5-1-iptables-è¯¦è§£"><a href="#5-1-iptables-è¯¦è§£" class="headerlink" title="5.1 iptables è¯¦è§£"></a>5.1 iptables è¯¦è§£</h3><h4 id="5-1-1-è¡¨ï¼ˆTablesï¼‰"><a href="#5-1-1-è¡¨ï¼ˆTablesï¼‰" class="headerlink" title="5.1.1 è¡¨ï¼ˆTablesï¼‰"></a>5.1.1 è¡¨ï¼ˆTablesï¼‰</h4><ol><li><p><strong>filter è¡¨</strong></p><ul><li>é»˜è®¤è¡¨</li><li>ç”¨äºåŒ…è¿‡æ»¤</li><li>é“¾ï¼šINPUTã€OUTPUTã€FORWARD</li></ul></li><li><p><strong>nat è¡¨</strong></p><ul><li>ç”¨äºåœ°å€è½¬æ¢</li><li>é“¾ï¼šPREROUTINGã€POSTROUTINGã€OUTPUT</li></ul></li><li><p><strong>mangle è¡¨</strong></p><ul><li>ç”¨äºæ•°æ®åŒ…ä¿®æ”¹</li><li>é“¾ï¼šPREROUTINGã€INPUTã€FORWARDã€OUTPUTã€POSTROUTING</li></ul></li><li><p><strong>raw è¡¨</strong></p><ul><li>ç”¨äºè¿æ¥è·Ÿè¸ª</li><li>é“¾ï¼šPREROUTINGã€OUTPUT</li></ul></li></ol><h4 id="5-1-2-é“¾ï¼ˆChainsï¼‰"><a href="#5-1-2-é“¾ï¼ˆChainsï¼‰" class="headerlink" title="5.1.2 é“¾ï¼ˆChainsï¼‰"></a>5.1.2 é“¾ï¼ˆChainsï¼‰</h4><ol><li><p><strong>INPUT é“¾</strong></p><ul><li>å¤„ç†å…¥ç«™æ•°æ®åŒ…</li><li>ç›®æ ‡åœ°å€ä¸ºæœ¬æœº</li><li>å¸¸ç”¨è§„åˆ™ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…è®¸å·²å»ºç«‹çš„è¿æ¥</span></span><br><span class="line">iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…è®¸ç‰¹å®šç«¯å£</span></span><br><span class="line">iptables -A INPUT -p tcp --dport 80 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…è®¸ç‰¹å®š IP</span></span><br><span class="line">iptables -A INPUT -s 192.168.1.100 -j ACCEPT</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>OUTPUT é“¾</strong></p><ul><li>å¤„ç†å‡ºç«™æ•°æ®åŒ…</li><li>æºåœ°å€ä¸ºæœ¬æœº</li><li>å¸¸ç”¨è§„åˆ™ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…è®¸æ‰€æœ‰å‡ºç«™æµé‡</span></span><br><span class="line">iptables -A OUTPUT -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># é™åˆ¶ç‰¹å®šç«¯å£</span></span><br><span class="line">iptables -A OUTPUT -p tcp --dport 25 -j DROP</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>FORWARD é“¾</strong></p><ul><li>å¤„ç†è½¬å‘æ•°æ®åŒ…</li><li>ç»è¿‡æœ¬æœºçš„æ•°æ®åŒ…</li><li>å¸¸ç”¨è§„åˆ™ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…è®¸è½¬å‘</span></span><br><span class="line">iptables -A FORWARD -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># é™åˆ¶ç‰¹å®šç½‘æ®µ</span></span><br><span class="line">iptables -A FORWARD -s 192.168.1.0/24 -j DROP</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>PREROUTING é“¾</strong></p><ul><li>æ•°æ®åŒ…è¿›å…¥è·¯ç”±è¡¨ä¹‹å‰</li><li>ç”¨äº DNAT</li><li>å¸¸ç”¨è§„åˆ™ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç«¯å£è½¬å‘</span></span><br><span class="line">iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 192.168.1.100:8080</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>POSTROUTING é“¾</strong></p><ul><li>æ•°æ®åŒ…ç¦»å¼€è·¯ç”±è¡¨ä¹‹å</li><li>ç”¨äº SNAT</li><li>å¸¸ç”¨è§„åˆ™ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æºåœ°å€è½¬æ¢</span></span><br><span class="line">iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -j SNAT --to-source 203.0.113.1</span><br></pre></td></tr></table></figure></li></ul></li></ol><h4 id="5-1-3-åŒ¹é…æ¡ä»¶"><a href="#5-1-3-åŒ¹é…æ¡ä»¶" class="headerlink" title="5.1.3 åŒ¹é…æ¡ä»¶"></a>5.1.3 åŒ¹é…æ¡ä»¶</h4><ol><li><p><strong>åŸºæœ¬åŒ¹é…</strong></p><ul><li>æºåœ°å€ï¼š-s</li><li>ç›®æ ‡åœ°å€ï¼š-d</li><li>åè®®ï¼š-p</li><li>æ¥å£ï¼š-i&#x2F;-o</li></ul></li><li><p><strong>æ‰©å±•åŒ¹é…</strong></p><ul><li>çŠ¶æ€ï¼š-m state</li><li>å¤šç«¯å£ï¼š-m multiport</li><li>è¿æ¥é™åˆ¶ï¼š-m limit</li><li>å­—ç¬¦ä¸²ï¼š-m string</li></ul></li><li><p><strong>ç›®æ ‡åŠ¨ä½œ</strong></p><ul><li>ACCEPTï¼šæ¥å—</li><li>DROPï¼šä¸¢å¼ƒ</li><li>REJECTï¼šæ‹’ç»</li><li>LOGï¼šè®°å½•</li><li>DNATï¼šç›®æ ‡åœ°å€è½¬æ¢</li><li>SNATï¼šæºåœ°å€è½¬æ¢</li></ul></li></ol><h3 id="5-2-é˜²ç«å¢™è§„åˆ™ç¤ºä¾‹"><a href="#5-2-é˜²ç«å¢™è§„åˆ™ç¤ºä¾‹" class="headerlink" title="5.2 é˜²ç«å¢™è§„åˆ™ç¤ºä¾‹"></a>5.2 é˜²ç«å¢™è§„åˆ™ç¤ºä¾‹</h3><ol><li><p><strong>åŸºæœ¬é˜²æŠ¤</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ¸…é™¤ç°æœ‰è§„åˆ™</span></span><br><span class="line">iptables -F</span><br><span class="line">iptables -X</span><br><span class="line">iptables -Z</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®é»˜è®¤ç­–ç•¥</span></span><br><span class="line">iptables -P INPUT DROP</span><br><span class="line">iptables -P FORWARD DROP</span><br><span class="line">iptables -P OUTPUT ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…è®¸æœ¬åœ°å›ç¯</span></span><br><span class="line">iptables -A INPUT -i lo -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…è®¸å·²å»ºç«‹çš„è¿æ¥</span></span><br><span class="line">iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…è®¸ SSH</span></span><br><span class="line">iptables -A INPUT -p tcp --dport 22 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…è®¸ HTTP/HTTPS</span></span><br><span class="line">iptables -A INPUT -p tcp --dport 80 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp --dport 443 -j ACCEPT</span><br></pre></td></tr></table></figure></li><li><p><strong>NAT é…ç½®</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯ç”¨ IP è½¬å‘</span></span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½® SNAT</span></span><br><span class="line">iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -j SNAT --to-source 203.0.113.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½® DNAT</span></span><br><span class="line">iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 192.168.1.100:8080</span><br></pre></td></tr></table></figure></li><li><p><strong>é«˜çº§è§„åˆ™</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é™åˆ¶è¿æ¥æ•°</span></span><br><span class="line">iptables -A INPUT -p tcp --dport 80 -m <span class="built_in">limit</span> --<span class="built_in">limit</span> 25/minute --limit-burst 100 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># é˜²æ­¢ SYN æ´ªæ°´æ”»å‡»</span></span><br><span class="line">iptables -A INPUT -p tcp --syn -m <span class="built_in">limit</span> --<span class="built_in">limit</span> 1/s --limit-burst 3 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®°å½•ç‰¹å®šæµé‡</span></span><br><span class="line">iptables -A INPUT -p tcp --dport 80 -j LOG --log-prefix <span class="string">&quot;HTTP: &quot;</span></span><br></pre></td></tr></table></figure></li></ol><h2 id="6-å®Œæ•´æ•°æ®æµç¨‹"><a href="#6-å®Œæ•´æ•°æ®æµç¨‹" class="headerlink" title="6. å®Œæ•´æ•°æ®æµç¨‹"></a>6. å®Œæ•´æ•°æ®æµç¨‹</h2><h3 id="6-1-æ•°æ®åŒ…å‘é€æµç¨‹"><a href="#6-1-æ•°æ®åŒ…å‘é€æµç¨‹" class="headerlink" title="6.1 æ•°æ®åŒ…å‘é€æµç¨‹"></a>6.1 æ•°æ®åŒ…å‘é€æµç¨‹</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  sequenceDiagram    participant App as Javaåº”ç”¨    participant Socket as Socket API    participant TCP as TCPå±‚    participant IP as IPå±‚    participant NIC as ç½‘å¡é©±åŠ¨    participant HW as ç½‘å¡ç¡¬ä»¶    participant Net as ç½‘ç»œ    App-&gt;&gt;Socket: è°ƒç”¨write()    Socket-&gt;&gt;Socket: æ•°æ®å¤åˆ¶åˆ°å†…æ ¸ç¼“å†²åŒº    Socket-&gt;&gt;TCP: æ•°æ®å°è£…    TCP-&gt;&gt;TCP: æ·»åŠ TCPå¤´    TCP-&gt;&gt;TCP: è®¡ç®—æ ¡éªŒå’Œ    TCP-&gt;&gt;IP: æ·»åŠ TCPå¤´    IP-&gt;&gt;IP: æ·»åŠ IPå¤´    IP-&gt;&gt;IP: è®¡ç®—æ ¡éªŒå’Œ    IP-&gt;&gt;IP: è·¯ç”±æŸ¥æ‰¾    IP-&gt;&gt;NIC: æ•°æ®åŒ…å‘é€    NIC-&gt;&gt;NIC: DMAä¼ è¾“    NIC-&gt;&gt;HW: æ•°æ®åŒ…å‘é€    HW-&gt;&gt;HW: æ·»åŠ å¸§å¤´    HW-&gt;&gt;HW: è®¡ç®—FCS    HW-&gt;&gt;Net: ç‰©ç†å‘é€  </pre></div><h3 id="6-2-æ•°æ®åŒ…æ¥æ”¶æµç¨‹"><a href="#6-2-æ•°æ®åŒ…æ¥æ”¶æµç¨‹" class="headerlink" title="6.2 æ•°æ®åŒ…æ¥æ”¶æµç¨‹"></a>6.2 æ•°æ®åŒ…æ¥æ”¶æµç¨‹</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  sequenceDiagram    participant Net as ç½‘ç»œ    participant HW as ç½‘å¡ç¡¬ä»¶    participant NIC as ç½‘å¡é©±åŠ¨    participant IP as IPå±‚    participant TCP as TCPå±‚    participant Socket as Socket API    participant App as Javaåº”ç”¨    Net-&gt;&gt;HW: æ¥æ”¶æ•°æ®åŒ…    HW-&gt;&gt;HW: æ ¡éªŒFCS    HW-&gt;&gt;HW: å»é™¤å¸§å¤´    HW-&gt;&gt;NIC: è§¦å‘ä¸­æ–­    NIC-&gt;&gt;NIC: ä¸­æ–­å¤„ç†    NIC-&gt;&gt;NIC: DMAä¼ è¾“    NIC-&gt;&gt;IP: æ•°æ®åŒ…æ¥æ”¶    IP-&gt;&gt;IP: æ ¡éªŒIPå¤´    IP-&gt;&gt;IP: å»é™¤IPå¤´    IP-&gt;&gt;TCP: æ•°æ®åŒ…ä¼ é€’    TCP-&gt;&gt;TCP: æ ¡éªŒTCPå¤´    TCP-&gt;&gt;TCP: å»é™¤TCPå¤´    TCP-&gt;&gt;TCP: é‡ç»„æ•°æ®åŒ…    TCP-&gt;&gt;Socket: æ•°æ®å°±ç»ª    Socket-&gt;&gt;App: é€šçŸ¥åº”ç”¨    App-&gt;&gt;Socket: è°ƒç”¨read()    Socket-&gt;&gt;App: è¿”å›æ•°æ®  </pre></div><h3 id="6-3-è¯¦ç»†å¤„ç†æµç¨‹"><a href="#6-3-è¯¦ç»†å¤„ç†æµç¨‹" class="headerlink" title="6.3 è¯¦ç»†å¤„ç†æµç¨‹"></a>6.3 è¯¦ç»†å¤„ç†æµç¨‹</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    A[å®¢æˆ·ç«¯] --&gt;|å‘é€è¯·æ±‚| B[ç½‘ç»œ]    B --&gt;|æ•°æ®åŒ…åˆ°è¾¾| C[ç½‘å¡]    C --&gt;|è§¦å‘ä¸­æ–­| D[ç½‘å¡é©±åŠ¨]    D --&gt;|DMAä¼ è¾“| E[å†…æ ¸ç¼“å†²åŒº]    E --&gt;|è½¯ä¸­æ–­| F[ç½‘ç»œåè®®æ ˆ]    F --&gt;|åè®®è§£æ| G[Socketå±‚]    G --&gt;|æ•°æ®å°±ç»ª| H[Java NIO]    H --&gt;|äº‹ä»¶é€šçŸ¥| I[Javaåº”ç”¨]    I --&gt;|å¤„ç†è¯·æ±‚| J[ä¸šåŠ¡é€»è¾‘]        C --&gt;|ç¡¬ä»¶æ ¡éªŒ| K[å¸§æ ¡éªŒ]    K --&gt;|æ ¡éªŒé€šè¿‡| D    K --&gt;|æ ¡éªŒå¤±è´¥| L[ä¸¢å¼ƒæ•°æ®åŒ…]        F --&gt;|IPå±‚å¤„ç†| M[è·¯ç”±æŸ¥æ‰¾]    M --&gt;|æ‰¾åˆ°è·¯ç”±| F    M --&gt;|æœªæ‰¾åˆ°è·¯ç”±| N[ICMPé”™è¯¯]        F --&gt;|TCPå±‚å¤„ç†| O[è¿æ¥è·Ÿè¸ª]    O --&gt;|æ–°è¿æ¥| P[åˆ›å»ºè¿æ¥]    O --&gt;|å·²æœ‰è¿æ¥| Q[æ›´æ–°è¿æ¥]        G --&gt;|Socketå¤„ç†| R[ç¼“å†²åŒºç®¡ç†]    R --&gt;|ç¼“å†²åŒºæ»¡| S[æµé‡æ§åˆ¶]    R --&gt;|ç¼“å†²åŒºç©º| T[ç­‰å¾…æ•°æ®]        H --&gt;|NIOå¤„ç†| U[äº‹ä»¶å¾ªç¯]    U --&gt;|è¯»äº‹ä»¶| V[æ•°æ®è¯»å–]    U --&gt;|å†™äº‹ä»¶| W[æ•°æ®å‘é€]        I --&gt;|åº”ç”¨å¤„ç†| X[è¯·æ±‚è§£æ]    X --&gt;|ä¸šåŠ¡å¤„ç†| Y[å“åº”ç”Ÿæˆ]    Y --&gt;|æ•°æ®å‘é€| Z[å“åº”è¿”å›]  </pre></div><h2 id="7-ç½‘ç»œæ€§èƒ½ä¼˜åŒ–"><a href="#7-ç½‘ç»œæ€§èƒ½ä¼˜åŒ–" class="headerlink" title="7. ç½‘ç»œæ€§èƒ½ä¼˜åŒ–"></a>7. ç½‘ç»œæ€§èƒ½ä¼˜åŒ–</h2><h3 id="7-1-ç³»ç»Ÿå±‚é¢"><a href="#7-1-ç³»ç»Ÿå±‚é¢" class="headerlink" title="7.1 ç³»ç»Ÿå±‚é¢"></a>7.1 ç³»ç»Ÿå±‚é¢</h3><h4 id="7-1-1-ç½‘å¡ä¼˜åŒ–"><a href="#7-1-1-ç½‘å¡ä¼˜åŒ–" class="headerlink" title="7.1.1 ç½‘å¡ä¼˜åŒ–"></a>7.1.1 ç½‘å¡ä¼˜åŒ–</h4><ol><li><p><strong>ä¸­æ–­åˆå¹¶</strong></p><ul><li>å‡å°‘ CPU ä¸­æ–­</li><li>æé«˜ååé‡</li><li>é…ç½®ç¤ºä¾‹ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ä¸­æ–­åˆå¹¶è®¾ç½®</span></span><br><span class="line">ethtool -c eth0</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®ä¸­æ–­åˆå¹¶</span></span><br><span class="line">ethtool -C eth0 rx-usecs 100 tx-usecs 100</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>å¤šé˜Ÿåˆ—æ”¯æŒ</strong></p><ul><li>å¤š CPU å¤„ç†</li><li>è´Ÿè½½å‡è¡¡</li><li>é…ç½®ç¤ºä¾‹ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹é˜Ÿåˆ—æ•°</span></span><br><span class="line">ethtool -l eth0</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®é˜Ÿåˆ—æ•°</span></span><br><span class="line">ethtool -L eth0 combined 8</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>å¤§é¡µå†…å­˜</strong></p><ul><li>å‡å°‘ TLB ç¼ºå¤±</li><li>æé«˜æ€§èƒ½</li><li>é…ç½®ç¤ºä¾‹ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ†é…å¤§é¡µ</span></span><br><span class="line"><span class="built_in">echo</span> 1024 &gt; /proc/sys/vm/nr_hugepages</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‚è½½å¤§é¡µæ–‡ä»¶ç³»ç»Ÿ</span></span><br><span class="line">mount -t hugetlbfs none /dev/hugepages</span><br></pre></td></tr></table></figure></li></ul></li></ol><h4 id="7-1-2-åè®®æ ˆä¼˜åŒ–"><a href="#7-1-2-åè®®æ ˆä¼˜åŒ–" class="headerlink" title="7.1.2 åè®®æ ˆä¼˜åŒ–"></a>7.1.2 åè®®æ ˆä¼˜åŒ–</h4><ol><li><p><strong>TCP å‚æ•°è°ƒä¼˜</strong></p><ul><li>ç¼“å†²åŒºå¤§å°</li><li>è¶…æ—¶è®¾ç½®</li><li>æ‹¥å¡æ§åˆ¶</li><li>é…ç½®ç¤ºä¾‹ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½® TCP ç¼“å†²åŒº</span></span><br><span class="line">sysctl -w net.core.rmem_max=16777216</span><br><span class="line">sysctl -w net.core.wmem_max=16777216</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½® TCP è¶…æ—¶</span></span><br><span class="line">sysctl -w net.ipv4.tcp_keepalive_time=300</span><br><span class="line">sysctl -w net.ipv4.tcp_keepalive_intvl=15</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®æ‹¥å¡æ§åˆ¶</span></span><br><span class="line">sysctl -w net.ipv4.tcp_congestion_control=cubic</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>è¿æ¥è·Ÿè¸ª</strong></p><ul><li>ä¼˜åŒ–è¿æ¥è¡¨</li><li>è¶…æ—¶è®¾ç½®</li><li>é…ç½®ç¤ºä¾‹ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®è¿æ¥è·Ÿè¸ªè¡¨å¤§å°</span></span><br><span class="line">sysctl -w net.netfilter.nf_conntrack_max=1000000</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®è¶…æ—¶æ—¶é—´</span></span><br><span class="line">sysctl -w net.netfilter.nf_conntrack_tcp_timeout_established=3600</span><br></pre></td></tr></table></figure></li></ul></li></ol><h3 id="7-2-åº”ç”¨å±‚é¢"><a href="#7-2-åº”ç”¨å±‚é¢" class="headerlink" title="7.2 åº”ç”¨å±‚é¢"></a>7.2 åº”ç”¨å±‚é¢</h3><h4 id="7-2-1-Java-ç½‘ç»œä¼˜åŒ–"><a href="#7-2-1-Java-ç½‘ç»œä¼˜åŒ–" class="headerlink" title="7.2.1 Java ç½‘ç»œä¼˜åŒ–"></a>7.2.1 Java ç½‘ç»œä¼˜åŒ–</h4><ol><li><p><strong>NIO ä½¿ç”¨</strong></p><ul><li>éé˜»å¡ IO</li><li>äº‹ä»¶é©±åŠ¨</li><li>ç¤ºä¾‹ä»£ç ï¼š<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»º Selector</span></span><br><span class="line"><span class="type">Selector</span> <span class="variable">selector</span> <span class="operator">=</span> Selector.open();</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»º ServerSocketChannel</span></span><br><span class="line"><span class="type">ServerSocketChannel</span> <span class="variable">serverChannel</span> <span class="operator">=</span> ServerSocketChannel.open();</span><br><span class="line">serverChannel.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">serverChannel.socket().bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">8080</span>));</span><br><span class="line">serverChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line"></span><br><span class="line"><span class="comment">// äº‹ä»¶å¾ªç¯</span></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    selector.select();</span><br><span class="line">    Set&lt;SelectionKey&gt; keys = selector.selectedKeys();</span><br><span class="line">    Iterator&lt;SelectionKey&gt; it = keys.iterator();</span><br><span class="line">    <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">        <span class="type">SelectionKey</span> <span class="variable">key</span> <span class="operator">=</span> it.next();</span><br><span class="line">        it.remove();</span><br><span class="line">        <span class="keyword">if</span> (key.isAcceptable()) &#123;</span><br><span class="line">            <span class="comment">// å¤„ç†è¿æ¥</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line">            <span class="comment">// å¤„ç†è¯»å–</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key.isWritable()) &#123;</span><br><span class="line">            <span class="comment">// å¤„ç†å†™å…¥</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>è¿æ¥æ± ç®¡ç†</strong></p><ul><li>è¿æ¥å¤ç”¨</li><li>è¶…æ—¶æ§åˆ¶</li><li>ç¤ºä¾‹é…ç½®ï¼š<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºè¿æ¥æ± </span></span><br><span class="line"><span class="type">PoolingHttpClientConnectionManager</span> <span class="variable">cm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PoolingHttpClientConnectionManager</span>();</span><br><span class="line">cm.setMaxTotal(<span class="number">100</span>);</span><br><span class="line">cm.setDefaultMaxPerRoute(<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»º HttpClient</span></span><br><span class="line"><span class="type">CloseableHttpClient</span> <span class="variable">httpClient</span> <span class="operator">=</span> HttpClients.custom()</span><br><span class="line">    .setConnectionManager(cm)</span><br><span class="line">    .setDefaultRequestConfig(RequestConfig.custom()</span><br><span class="line">        .setConnectTimeout(<span class="number">5000</span>)</span><br><span class="line">        .setSocketTimeout(<span class="number">5000</span>)</span><br><span class="line">        .build())</span><br><span class="line">    .build();</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>è¶…æ—¶è®¾ç½®</strong></p><ul><li>è¿æ¥è¶…æ—¶</li><li>è¯»å–è¶…æ—¶</li><li>å†™å…¥è¶…æ—¶</li><li>ç¤ºä¾‹ä»£ç ï¼š<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¾ç½®è¶…æ—¶</span></span><br><span class="line"><span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>();</span><br><span class="line">socket.connect(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(host, port), <span class="number">5000</span>);</span><br><span class="line">socket.setSoTimeout(<span class="number">5000</span>);</span><br></pre></td></tr></table></figure></li></ul></li></ol><h4 id="7-2-2-ç›‘æ§æŒ‡æ ‡"><a href="#7-2-2-ç›‘æ§æŒ‡æ ‡" class="headerlink" title="7.2.2 ç›‘æ§æŒ‡æ ‡"></a>7.2.2 ç›‘æ§æŒ‡æ ‡</h4><ol><li><p><strong>ç½‘ç»œååé‡</strong></p><ul><li>å¸¦å®½ä½¿ç”¨ç‡</li><li>æ•°æ®åŒ…é€Ÿç‡</li><li>é”™è¯¯ç‡</li><li>ç›‘æ§å·¥å…·ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨ iftop ç›‘æ§å¸¦å®½</span></span><br><span class="line">iftop -i eth0</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ nethogs ç›‘æ§è¿›ç¨‹</span></span><br><span class="line">nethogs eth0</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ iperf æµ‹è¯•å¸¦å®½</span></span><br><span class="line">iperf -s</span><br><span class="line">iperf -c server</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>å»¶è¿Ÿç»Ÿè®¡</strong></p><ul><li>å¾€è¿”æ—¶é—´</li><li>è¿æ¥å»¶è¿Ÿ</li><li>å¤„ç†å»¶è¿Ÿ</li><li>ç›‘æ§å·¥å…·ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨ ping æµ‹è¯•å»¶è¿Ÿ</span></span><br><span class="line">ping -c 100 server</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ tcpping æµ‹è¯• TCP å»¶è¿Ÿ</span></span><br><span class="line">tcpping -c 100 server 80</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>é”™è¯¯è®¡æ•°</strong></p><ul><li>ä¸¢åŒ…ç‡</li><li>é‡ä¼ ç‡</li><li>é”™è¯¯ç‡</li><li>ç›‘æ§å·¥å…·ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ç½‘å¡ç»Ÿè®¡</span></span><br><span class="line">ethtool -S eth0</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ TCP ç»Ÿè®¡</span></span><br><span class="line">netstat -s</span><br></pre></td></tr></table></figure></li></ul></li></ol><h2 id="8-å¸¸è§é—®é¢˜æ’æŸ¥"><a href="#8-å¸¸è§é—®é¢˜æ’æŸ¥" class="headerlink" title="8. å¸¸è§é—®é¢˜æ’æŸ¥"></a>8. å¸¸è§é—®é¢˜æ’æŸ¥</h2><h3 id="8-1-ç½‘ç»œè¿æ¥é—®é¢˜"><a href="#8-1-ç½‘ç»œè¿æ¥é—®é¢˜" class="headerlink" title="8.1 ç½‘ç»œè¿æ¥é—®é¢˜"></a>8.1 ç½‘ç»œè¿æ¥é—®é¢˜</h3><h4 id="8-1-1-ç‰©ç†å±‚"><a href="#8-1-1-ç‰©ç†å±‚" class="headerlink" title="8.1.1 ç‰©ç†å±‚"></a>8.1.1 ç‰©ç†å±‚</h4><ol><li><p><strong>ç½‘çº¿è¿æ¥</strong></p><ul><li>æ£€æŸ¥ç½‘çº¿</li><li>æ£€æŸ¥æ¥å£</li><li>æ£€æŸ¥æŒ‡ç¤ºç¯</li><li>æ’æŸ¥æ­¥éª¤ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ç½‘å¡çŠ¶æ€</span></span><br><span class="line">ethtool eth0</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ¥å£ä¿¡æ¯</span></span><br><span class="line">ip <span class="built_in">link</span> show eth0</span><br><span class="line"></span><br><span class="line"><span class="comment"># æµ‹è¯•ç½‘çº¿</span></span><br><span class="line">mii-tool eth0</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>ç½‘å¡çŠ¶æ€</strong></p><ul><li>é©±åŠ¨åŠ è½½</li><li>ä¸­æ–­é…ç½®</li><li>DMA è®¾ç½®</li><li>æ’æŸ¥æ­¥éª¤ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹é©±åŠ¨ä¿¡æ¯</span></span><br><span class="line">lsmod | grep e1000</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ä¸­æ–­</span></span><br><span class="line"><span class="built_in">cat</span> /proc/interrupts</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ DMA</span></span><br><span class="line">dmesg | grep DMA</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>é©±åŠ¨é—®é¢˜</strong></p><ul><li>é©±åŠ¨ç‰ˆæœ¬</li><li>å…¼å®¹æ€§</li><li>é…ç½®å‚æ•°</li><li>æ’æŸ¥æ­¥éª¤ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ›´æ–°é©±åŠ¨</span></span><br><span class="line">modprobe -r e1000</span><br><span class="line">modprobe e1000</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹é©±åŠ¨å‚æ•°</span></span><br><span class="line">modinfo e1000</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®é©±åŠ¨å‚æ•°</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;options e1000 debug=1&quot;</span> &gt; /etc/modprobe.d/e1000.conf</span><br></pre></td></tr></table></figure></li></ul></li></ol><h4 id="8-1-2-ç½‘ç»œå±‚"><a href="#8-1-2-ç½‘ç»œå±‚" class="headerlink" title="8.1.2 ç½‘ç»œå±‚"></a>8.1.2 ç½‘ç»œå±‚</h4><ol><li><p><strong>IP é…ç½®</strong></p><ul><li>åœ°å€è®¾ç½®</li><li>å­ç½‘æ©ç </li><li>ç½‘å…³é…ç½®</li><li>æ’æŸ¥æ­¥éª¤ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ IP é…ç½®</span></span><br><span class="line">ip addr show</span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½® IP åœ°å€</span></span><br><span class="line">ip addr add 192.168.1.100/24 dev eth0</span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®ç½‘å…³</span></span><br><span class="line">ip route add default via 192.168.1.1</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>è·¯ç”±è¡¨</strong></p><ul><li>è·¯ç”±æ¡ç›®</li><li>é»˜è®¤è·¯ç”±</li><li>ç­–ç•¥è·¯ç”±</li><li>æ’æŸ¥æ­¥éª¤ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹è·¯ç”±è¡¨</span></span><br><span class="line">ip route show</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ è·¯ç”±</span></span><br><span class="line">ip route add 192.168.2.0/24 via 192.168.1.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤è·¯ç”±</span></span><br><span class="line">ip route del 192.168.2.0/24</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>é˜²ç«å¢™è§„åˆ™</strong></p><ul><li>è§„åˆ™é…ç½®</li><li>é“¾è®¾ç½®</li><li>ç­–ç•¥é…ç½®</li><li>æ’æŸ¥æ­¥éª¤ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹è§„åˆ™</span></span><br><span class="line">iptables -L -n -v</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ è§„åˆ™</span></span><br><span class="line">iptables -A INPUT -p tcp --dport 80 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿å­˜è§„åˆ™</span></span><br><span class="line">iptables-save &gt; /etc/iptables/rules.v4</span><br></pre></td></tr></table></figure></li></ul></li></ol><h4 id="8-1-3-åº”ç”¨å±‚"><a href="#8-1-3-åº”ç”¨å±‚" class="headerlink" title="8.1.3 åº”ç”¨å±‚"></a>8.1.3 åº”ç”¨å±‚</h4><ol><li><p><strong>ç«¯å£ç›‘å¬</strong></p><ul><li>æœåŠ¡çŠ¶æ€</li><li>ç«¯å£å ç”¨</li><li>è®¿é—®æƒé™</li><li>æ’æŸ¥æ­¥éª¤ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ç«¯å£</span></span><br><span class="line">netstat -tuln</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹è¿›ç¨‹</span></span><br><span class="line">lsof -i :80</span><br><span class="line"></span><br><span class="line"><span class="comment"># æµ‹è¯•ç«¯å£</span></span><br><span class="line">telnet localhost 80</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>æœåŠ¡çŠ¶æ€</strong></p><ul><li>è¿›ç¨‹çŠ¶æ€</li><li>æ—¥å¿—ä¿¡æ¯</li><li>é…ç½®æ£€æŸ¥</li><li>æ’æŸ¥æ­¥éª¤ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹æœåŠ¡çŠ¶æ€</span></span><br><span class="line">systemctl status nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ—¥å¿—</span></span><br><span class="line">journalctl -u nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥é…ç½®</span></span><br><span class="line">nginx -t</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>æ—¥å¿—åˆ†æ</strong></p><ul><li>é”™è¯¯æ—¥å¿—</li><li>è®¿é—®æ—¥å¿—</li><li>ç³»ç»Ÿæ—¥å¿—</li><li>æ’æŸ¥æ­¥éª¤ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—</span></span><br><span class="line"><span class="built_in">tail</span> -f /var/log/syslog</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹åº”ç”¨æ—¥å¿—</span></span><br><span class="line"><span class="built_in">tail</span> -f /var/log/nginx/error.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ†ææ—¥å¿—</span></span><br><span class="line">grep <span class="string">&quot;error&quot;</span> /var/log/nginx/error.log</span><br></pre></td></tr></table></figure></li></ul></li></ol><h3 id="8-2-æ€§èƒ½é—®é¢˜"><a href="#8-2-æ€§èƒ½é—®é¢˜" class="headerlink" title="8.2 æ€§èƒ½é—®é¢˜"></a>8.2 æ€§èƒ½é—®é¢˜</h3><h4 id="8-2-1-ç³»ç»Ÿèµ„æº"><a href="#8-2-1-ç³»ç»Ÿèµ„æº" class="headerlink" title="8.2.1 ç³»ç»Ÿèµ„æº"></a>8.2.1 ç³»ç»Ÿèµ„æº</h4><ol><li><p><strong>CPU ä½¿ç”¨ç‡</strong></p><ul><li>è¿›ç¨‹ CPU</li><li>ä¸­æ–­å¤„ç†</li><li>ä¸Šä¸‹æ–‡åˆ‡æ¢</li><li>æ’æŸ¥æ­¥éª¤ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ CPU ä½¿ç”¨</span></span><br><span class="line">top</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ä¸­æ–­</span></span><br><span class="line"><span class="built_in">cat</span> /proc/interrupts</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ä¸Šä¸‹æ–‡åˆ‡æ¢</span></span><br><span class="line">vmstat 1</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>å†…å­˜ä½¿ç”¨</strong></p><ul><li>ç‰©ç†å†…å­˜</li><li>è™šæ‹Ÿå†…å­˜</li><li>ç¼“å†²åŒº</li><li>æ’æŸ¥æ­¥éª¤ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹å†…å­˜ä½¿ç”¨</span></span><br><span class="line">free -m</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹è™šæ‹Ÿå†…å­˜</span></span><br><span class="line">vmstat 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç¼“å†²åŒº</span></span><br><span class="line"><span class="built_in">cat</span> /proc/meminfo</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>ç½‘ç»œå¸¦å®½</strong></p><ul><li>å¸¦å®½ä½¿ç”¨</li><li>æ•°æ®åŒ…å¤§å°</li><li>åè®®åˆ†å¸ƒ</li><li>æ’æŸ¥æ­¥éª¤ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹å¸¦å®½ä½¿ç”¨</span></span><br><span class="line">iftop -i eth0</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ•°æ®åŒ…</span></span><br><span class="line">tcpdump -i eth0</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹åè®®åˆ†å¸ƒ</span></span><br><span class="line">nethogs eth0</span><br></pre></td></tr></table></figure></li></ul></li></ol><h4 id="8-2-2-åº”ç”¨èµ„æº"><a href="#8-2-2-åº”ç”¨èµ„æº" class="headerlink" title="8.2.2 åº”ç”¨èµ„æº"></a>8.2.2 åº”ç”¨èµ„æº</h4><ol><li><p><strong>è¿æ¥æ•°</strong></p><ul><li>æ´»åŠ¨è¿æ¥</li><li>ç­‰å¾…è¿æ¥</li><li>è¿æ¥é™åˆ¶</li><li>æ’æŸ¥æ­¥éª¤ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹è¿æ¥æ•°</span></span><br><span class="line">netstat -an | grep ESTABLISHED | <span class="built_in">wc</span> -l</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç­‰å¾…è¿æ¥</span></span><br><span class="line">netstat -an | grep LISTEN | <span class="built_in">wc</span> -l</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹è¿æ¥é™åˆ¶</span></span><br><span class="line"><span class="built_in">ulimit</span> -n</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>çº¿ç¨‹æ•°</strong></p><ul><li>æ´»åŠ¨çº¿ç¨‹</li><li>çº¿ç¨‹æ± </li><li>çº¿ç¨‹é™åˆ¶</li><li>æ’æŸ¥æ­¥éª¤ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹çº¿ç¨‹æ•°</span></span><br><span class="line">ps -eLf | <span class="built_in">wc</span> -l</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹çº¿ç¨‹æ± </span></span><br><span class="line">jstack &lt;pid&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹çº¿ç¨‹é™åˆ¶</span></span><br><span class="line"><span class="built_in">ulimit</span> -u</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>ç¼“å†²åŒºå¤§å°</strong></p><ul><li>å‘é€ç¼“å†²åŒº</li><li>æ¥æ”¶ç¼“å†²åŒº</li><li>ç¼“å†²åŒºé™åˆ¶</li><li>æ’æŸ¥æ­¥éª¤ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ç¼“å†²åŒº</span></span><br><span class="line">sysctl -a | grep mem</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®ç¼“å†²åŒº</span></span><br><span class="line">sysctl -w net.core.rmem_max=16777216</span><br><span class="line">sysctl -w net.core.wmem_max=16777216</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹é™åˆ¶</span></span><br><span class="line"><span class="built_in">ulimit</span> -a</span><br></pre></td></tr></table></figure></li></ul></li></ol><h2 id="9-æ€»ç»“"><a href="#9-æ€»ç»“" class="headerlink" title="9. æ€»ç»“"></a>9. æ€»ç»“</h2><p>Linux ç½‘ç»œæ˜¯ä¸€ä¸ªå¤æ‚çš„ç³»ç»Ÿï¼Œæ¶‰åŠä»ç¡¬ä»¶åˆ°åº”ç”¨çš„å¤šä¸ªå±‚æ¬¡ã€‚ç†è§£è¿™äº›åŸºç¡€æ¦‚å¿µå’Œå®Œæ•´çš„æ•°æ®æµç¨‹ï¼Œå¯¹äºç½‘ç»œé—®é¢˜æ’æŸ¥å’Œæ€§èƒ½ä¼˜åŒ–éƒ½è‡³å…³é‡è¦ã€‚é€šè¿‡æœ¬æ–‡çš„è¯¦ç»†ä»‹ç»ï¼Œè¯»è€…å¯ä»¥ï¼š</p><ol><li>ç†è§£ç½‘ç»œç¡¬ä»¶å’Œé©±åŠ¨çš„å·¥ä½œåŸç†</li><li>æŒæ¡ç½‘ç»œæ¥å£çš„é…ç½®å’Œç®¡ç†</li><li>äº†è§£ç½‘ç»œåè®®æ ˆçš„å·¥ä½œæœºåˆ¶</li><li>ç†Ÿæ‚‰é˜²ç«å¢™çš„é…ç½®å’Œä½¿ç”¨</li><li>æŒæ¡ç½‘ç»œæ€§èƒ½ä¼˜åŒ–çš„æ–¹æ³•</li><li>å­¦ä¼šç½‘ç»œé—®é¢˜çš„æ’æŸ¥æŠ€å·§</li></ol><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ol><li>Linux å†…æ ¸ç½‘ç»œå­ç³»ç»Ÿæ–‡æ¡£</li><li>TCP&#x2F;IP åè®®è¯¦è§£</li><li>Java NIO ç¼–ç¨‹æŒ‡å—</li><li>Linux ç½‘ç»œæ€§èƒ½è°ƒä¼˜æŒ‡å—</li><li>iptables å®˜æ–¹æ–‡æ¡£</li><li>ç½‘ç»œæ•…éšœæ’æŸ¥æ‰‹å†Œ</li></ol>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> Linux </tag>
            
            <tag> ç½‘ç»œ </tag>
            
            <tag> ç³»ç»Ÿ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ·±å…¥ç†è§£ç½‘ç»œæ¥å£ã€ç«¯å£ä¸ç½‘å¡ï¼šå…³ç³»ä¸å·¥ä½œæµç¨‹</title>
      <link href="/2025/06/13/network-interfaces-ports-nics/"/>
      <url>/2025/06/13/network-interfaces-ports-nics/</url>
      
        <content type="html"><![CDATA[<h1 id="æ·±å…¥ç†è§£ç½‘ç»œæ¥å£ã€ç«¯å£ä¸ç½‘å¡ï¼šå…³ç³»ä¸å·¥ä½œæµç¨‹"><a href="#æ·±å…¥ç†è§£ç½‘ç»œæ¥å£ã€ç«¯å£ä¸ç½‘å¡ï¼šå…³ç³»ä¸å·¥ä½œæµç¨‹" class="headerlink" title="æ·±å…¥ç†è§£ç½‘ç»œæ¥å£ã€ç«¯å£ä¸ç½‘å¡ï¼šå…³ç³»ä¸å·¥ä½œæµç¨‹"></a>æ·±å…¥ç†è§£ç½‘ç»œæ¥å£ã€ç«¯å£ä¸ç½‘å¡ï¼šå…³ç³»ä¸å·¥ä½œæµç¨‹</h1><h2 id="1-åŸºæœ¬æ¦‚å¿µ"><a href="#1-åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="1. åŸºæœ¬æ¦‚å¿µ"></a>1. åŸºæœ¬æ¦‚å¿µ</h2><h3 id="1-1-ç½‘å¡ï¼ˆNetwork-Interface-Cardï¼ŒNICï¼‰"><a href="#1-1-ç½‘å¡ï¼ˆNetwork-Interface-Cardï¼ŒNICï¼‰" class="headerlink" title="1.1 ç½‘å¡ï¼ˆNetwork Interface Cardï¼ŒNICï¼‰"></a>1.1 ç½‘å¡ï¼ˆNetwork Interface Cardï¼ŒNICï¼‰</h3><p>ç½‘å¡æ˜¯è®¡ç®—æœºç¡¬ä»¶è®¾å¤‡ï¼Œè´Ÿè´£ç½‘ç»œæ•°æ®çš„æ”¶å‘ã€‚å®ƒæ˜¯è¿æ¥è®¡ç®—æœºä¸ç½‘ç»œçš„ç‰©ç†æ¥å£ã€‚</p><p>ä¸»è¦ç‰¹ç‚¹ï¼š</p><ul><li>ç‰©ç†è®¾å¤‡</li><li>å…·æœ‰å”¯ä¸€çš„ MAC åœ°å€</li><li>æ”¯æŒç‰¹å®šçš„ç½‘ç»œåè®®ï¼ˆå¦‚ä»¥å¤ªç½‘ï¼‰</li><li>å¯ä»¥æ˜¯æœ‰çº¿æˆ–æ— çº¿ç½‘å¡</li></ul><h3 id="1-2-ç½‘ç»œæ¥å£ï¼ˆNetwork-Interfaceï¼‰"><a href="#1-2-ç½‘ç»œæ¥å£ï¼ˆNetwork-Interfaceï¼‰" class="headerlink" title="1.2 ç½‘ç»œæ¥å£ï¼ˆNetwork Interfaceï¼‰"></a>1.2 ç½‘ç»œæ¥å£ï¼ˆNetwork Interfaceï¼‰</h3><p>ç½‘ç»œæ¥å£æ˜¯æ“ä½œç³»ç»Ÿå¯¹ç½‘å¡çš„æŠ½è±¡è¡¨ç¤ºï¼Œæ˜¯æ“ä½œç³»ç»Ÿä¸ç½‘å¡äº¤äº’çš„è½¯ä»¶æ¥å£ã€‚</p><p>ä¸»è¦ç‰¹ç‚¹ï¼š</p><ul><li>è½¯ä»¶å±‚é¢çš„æŠ½è±¡</li><li>å…·æœ‰ IP åœ°å€</li><li>å¯ä»¥é…ç½®ç½‘ç»œå‚æ•°</li><li>å¯ä»¥åˆ›å»ºè™šæ‹Ÿæ¥å£</li></ul><h3 id="1-3-ç½‘ç»œç«¯å£ï¼ˆNetwork-Portï¼‰"><a href="#1-3-ç½‘ç»œç«¯å£ï¼ˆNetwork-Portï¼‰" class="headerlink" title="1.3 ç½‘ç»œç«¯å£ï¼ˆNetwork Portï¼‰"></a>1.3 ç½‘ç»œç«¯å£ï¼ˆNetwork Portï¼‰</h3><p>ç½‘ç»œç«¯å£æ˜¯ä¼ è¾“å±‚ï¼ˆTCP&#x2F;UDPï¼‰çš„æ¦‚å¿µï¼Œç”¨äºåŒºåˆ†åŒä¸€ IP åœ°å€ä¸Šçš„ä¸åŒåº”ç”¨ç¨‹åºã€‚</p><p>ä¸»è¦ç‰¹ç‚¹ï¼š</p><ul><li>é€»è¾‘æ¦‚å¿µ</li><li>èŒƒå›´ï¼š0-65535</li><li>ç”¨äºåº”ç”¨ç¨‹åºé€šä¿¡</li><li>å¯ä»¥åŠ¨æ€åˆ†é…</li></ul><h2 id="2-ä¸‰è€…å…³ç³»"><a href="#2-ä¸‰è€…å…³ç³»" class="headerlink" title="2. ä¸‰è€…å…³ç³»"></a>2. ä¸‰è€…å…³ç³»</h2><h3 id="2-1-å±‚æ¬¡å…³ç³»"><a href="#2-1-å±‚æ¬¡å…³ç³»" class="headerlink" title="2.1 å±‚æ¬¡å…³ç³»"></a>2.1 å±‚æ¬¡å…³ç³»</h3><pre class="mermaid">graph TD    A[åº”ç”¨å±‚] --> B[ä¼ è¾“å±‚/ç«¯å£]    B --> C[ç½‘ç»œå±‚/IP]    C --> D[ç½‘ç»œæ¥å£]    D --> E[æ•°æ®é“¾è·¯å±‚/MAC]    E --> F[ç‰©ç†å±‚/ç½‘å¡]</pre><h3 id="2-2-å¯¹åº”å…³ç³»"><a href="#2-2-å¯¹åº”å…³ç³»" class="headerlink" title="2.2 å¯¹åº”å…³ç³»"></a>2.2 å¯¹åº”å…³ç³»</h3><pre class="mermaid">graph LR    A[ç½‘å¡] -->|ç‰©ç†è®¾å¤‡| B[ç½‘ç»œæ¥å£]    B -->|IPåœ°å€| C[ç½‘ç»œç«¯å£]    C -->|åº”ç”¨ç¨‹åº| D[æœåŠ¡]</pre><h2 id="3-å·¥ä½œæµç¨‹"><a href="#3-å·¥ä½œæµç¨‹" class="headerlink" title="3. å·¥ä½œæµç¨‹"></a>3. å·¥ä½œæµç¨‹</h2><h3 id="3-1-æ•°æ®å‘é€æµç¨‹"><a href="#3-1-æ•°æ®å‘é€æµç¨‹" class="headerlink" title="3.1 æ•°æ®å‘é€æµç¨‹"></a>3.1 æ•°æ®å‘é€æµç¨‹</h3><pre class="mermaid">sequenceDiagram    participant App as åº”ç”¨ç¨‹åº    participant Port as ç½‘ç»œç«¯å£    participant IP as IPåœ°å€    participant Interface as ç½‘ç»œæ¥å£    participant NIC as ç½‘å¡    participant Network as ç½‘ç»œ    App->>Port: å‘é€æ•°æ®    Port->>IP: æ·»åŠ ç«¯å£ä¿¡æ¯    IP->>Interface: é€‰æ‹©ç½‘ç»œæ¥å£    Interface->>NIC: é€šè¿‡æ¥å£å‘é€    NIC->>Network: ç‰©ç†å‘é€</pre><h3 id="3-2-æ•°æ®æ¥æ”¶æµç¨‹"><a href="#3-2-æ•°æ®æ¥æ”¶æµç¨‹" class="headerlink" title="3.2 æ•°æ®æ¥æ”¶æµç¨‹"></a>3.2 æ•°æ®æ¥æ”¶æµç¨‹</h3><pre class="mermaid">sequenceDiagram    participant Network as ç½‘ç»œ    participant NIC as ç½‘å¡    participant Interface as ç½‘ç»œæ¥å£    participant IP as IPåœ°å€    participant Port as ç½‘ç»œç«¯å£    participant App as åº”ç”¨ç¨‹åº    Network->>NIC: æ¥æ”¶æ•°æ®    NIC->>Interface: ä¼ é€’ç»™æ¥å£    Interface->>IP: è§£æIPåœ°å€    IP->>Port: è§£æç«¯å£    Port->>App: ä¼ é€’ç»™åº”ç”¨</pre><h2 id="4-å®é™…åº”ç”¨"><a href="#4-å®é™…åº”ç”¨" class="headerlink" title="4. å®é™…åº”ç”¨"></a>4. å®é™…åº”ç”¨</h2><h3 id="4-1-ç½‘å¡é…ç½®"><a href="#4-1-ç½‘å¡é…ç½®" class="headerlink" title="4.1 ç½‘å¡é…ç½®"></a>4.1 ç½‘å¡é…ç½®</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ç½‘å¡ä¿¡æ¯</span></span><br><span class="line">lspci | grep -i ethernet</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç½‘ç»œæ¥å£</span></span><br><span class="line">ip addr show</span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®ç½‘ç»œæ¥å£</span></span><br><span class="line">ip addr add 192.168.1.100/24 dev eth0</span><br></pre></td></tr></table></figure><h3 id="4-2-ç«¯å£ç®¡ç†"><a href="#4-2-ç«¯å£ç®¡ç†" class="headerlink" title="4.2 ç«¯å£ç®¡ç†"></a>4.2 ç«¯å£ç®¡ç†</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ç«¯å£ä½¿ç”¨æƒ…å†µ</span></span><br><span class="line">netstat -tuln</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç‰¹å®šç«¯å£</span></span><br><span class="line">netstat -tuln | grep 80</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼€æ”¾ç«¯å£ï¼ˆä½¿ç”¨ iptablesï¼‰</span></span><br><span class="line">iptables -A INPUT -p tcp --dport 80 -j ACCEPT</span><br></pre></td></tr></table></figure><h3 id="4-3-ç½‘ç»œæ¥å£ç®¡ç†"><a href="#4-3-ç½‘ç»œæ¥å£ç®¡ç†" class="headerlink" title="4.3 ç½‘ç»œæ¥å£ç®¡ç†"></a>4.3 ç½‘ç»œæ¥å£ç®¡ç†</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯ç”¨æ¥å£</span></span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> eth0 up</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¦ç”¨æ¥å£</span></span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> eth0 down</span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®æ¥å£å‚æ•°</span></span><br><span class="line">ethtool -s eth0 speed 1000 duplex full</span><br></pre></td></tr></table></figure><h2 id="5-å¸¸è§åœºæ™¯"><a href="#5-å¸¸è§åœºæ™¯" class="headerlink" title="5. å¸¸è§åœºæ™¯"></a>5. å¸¸è§åœºæ™¯</h2><h3 id="5-1-å¤šç½‘å¡é…ç½®"><a href="#5-1-å¤šç½‘å¡é…ç½®" class="headerlink" title="5.1 å¤šç½‘å¡é…ç½®"></a>5.1 å¤šç½‘å¡é…ç½®</h3><pre class="mermaid">graph TD    A[æœåŠ¡å™¨] --> B[eth0]    A --> C[eth1]    B --> D[å†…ç½‘]    C --> E[å¤–ç½‘]    B --> F[192.168.1.0/24]    C --> G[203.0.113.0/24]</pre><h3 id="5-2-è™šæ‹Ÿæ¥å£"><a href="#5-2-è™šæ‹Ÿæ¥å£" class="headerlink" title="5.2 è™šæ‹Ÿæ¥å£"></a>5.2 è™šæ‹Ÿæ¥å£</h3><pre class="mermaid">graph TD    A[ç‰©ç†ç½‘å¡] --> B[eth0]    B --> C[eth0:0]    B --> D[eth0:1]    C --> E[192.168.1.100]    D --> F[192.168.1.101]</pre><h3 id="5-3-ç«¯å£è½¬å‘"><a href="#5-3-ç«¯å£è½¬å‘" class="headerlink" title="5.3 ç«¯å£è½¬å‘"></a>5.3 ç«¯å£è½¬å‘</h3><pre class="mermaid">graph LR    A[å¤–éƒ¨è¯·æ±‚] -->|80ç«¯å£| B[è·¯ç”±å™¨]    B -->|8080ç«¯å£| C[å†…éƒ¨æœåŠ¡å™¨]</pre><h2 id="6-æ€§èƒ½ä¼˜åŒ–"><a href="#6-æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="6. æ€§èƒ½ä¼˜åŒ–"></a>6. æ€§èƒ½ä¼˜åŒ–</h2><h3 id="6-1-ç½‘å¡ä¼˜åŒ–"><a href="#6-1-ç½‘å¡ä¼˜åŒ–" class="headerlink" title="6.1 ç½‘å¡ä¼˜åŒ–"></a>6.1 ç½‘å¡ä¼˜åŒ–</h3><ol><li><p><strong>ä¸­æ–­åˆå¹¶</strong></p><ul><li>å‡å°‘ CPU ä¸­æ–­</li><li>æé«˜ååé‡</li></ul></li><li><p><strong>é˜Ÿåˆ—ç®¡ç†</strong></p><ul><li>å¤šé˜Ÿåˆ—æ”¯æŒ</li><li>è´Ÿè½½å‡è¡¡</li></ul></li></ol><h3 id="6-2-æ¥å£ä¼˜åŒ–"><a href="#6-2-æ¥å£ä¼˜åŒ–" class="headerlink" title="6.2 æ¥å£ä¼˜åŒ–"></a>6.2 æ¥å£ä¼˜åŒ–</h3><ol><li><p><strong>MTU è°ƒæ•´</strong></p><ul><li>ä¼˜åŒ–æ•°æ®åŒ…å¤§å°</li><li>å‡å°‘åˆ†ç‰‡</li></ul></li><li><p><strong>ç¼“å†²åŒºè®¾ç½®</strong></p><ul><li>è°ƒæ•´æ¥æ”¶ç¼“å†²åŒº</li><li>è°ƒæ•´å‘é€ç¼“å†²åŒº</li></ul></li></ol><h3 id="6-3-ç«¯å£ä¼˜åŒ–"><a href="#6-3-ç«¯å£ä¼˜åŒ–" class="headerlink" title="6.3 ç«¯å£ä¼˜åŒ–"></a>6.3 ç«¯å£ä¼˜åŒ–</h3><ol><li><p><strong>ç«¯å£å¤ç”¨</strong></p><ul><li>å¯ç”¨ SO_REUSEADDR</li><li>æé«˜ç«¯å£åˆ©ç”¨ç‡</li></ul></li><li><p><strong>è¿æ¥ç®¡ç†</strong></p><ul><li>è°ƒæ•´ TIME_WAIT</li><li>ä¼˜åŒ–è¿æ¥æ± </li></ul></li></ol><h2 id="7-æ•…éšœæ’æŸ¥"><a href="#7-æ•…éšœæ’æŸ¥" class="headerlink" title="7. æ•…éšœæ’æŸ¥"></a>7. æ•…éšœæ’æŸ¥</h2><h3 id="7-1-ç½‘å¡æ•…éšœ"><a href="#7-1-ç½‘å¡æ•…éšœ" class="headerlink" title="7.1 ç½‘å¡æ•…éšœ"></a>7.1 ç½‘å¡æ•…éšœ</h3><ol><li><p><strong>ç‰©ç†è¿æ¥</strong></p><ul><li>æ£€æŸ¥ç½‘çº¿</li><li>æ£€æŸ¥ç½‘å¡çŠ¶æ€</li></ul></li><li><p><strong>é©±åŠ¨é—®é¢˜</strong></p><ul><li>æ›´æ–°é©±åŠ¨</li><li>æ£€æŸ¥å…¼å®¹æ€§</li></ul></li></ol><h3 id="7-2-æ¥å£æ•…éšœ"><a href="#7-2-æ¥å£æ•…éšœ" class="headerlink" title="7.2 æ¥å£æ•…éšœ"></a>7.2 æ¥å£æ•…éšœ</h3><ol><li><p><strong>é…ç½®é—®é¢˜</strong></p><ul><li>æ£€æŸ¥ IP é…ç½®</li><li>æ£€æŸ¥è·¯ç”±è¡¨</li></ul></li><li><p><strong>çŠ¶æ€å¼‚å¸¸</strong></p><ul><li>æ£€æŸ¥æ¥å£çŠ¶æ€</li><li>æ£€æŸ¥é”™è¯¯è®¡æ•°</li></ul></li></ol><h3 id="7-3-ç«¯å£æ•…éšœ"><a href="#7-3-ç«¯å£æ•…éšœ" class="headerlink" title="7.3 ç«¯å£æ•…éšœ"></a>7.3 ç«¯å£æ•…éšœ</h3><ol><li><p><strong>ç«¯å£å ç”¨</strong></p><ul><li>æ£€æŸ¥ç«¯å£ä½¿ç”¨</li><li>æ£€æŸ¥æœåŠ¡çŠ¶æ€</li></ul></li><li><p><strong>é˜²ç«å¢™é—®é¢˜</strong></p><ul><li>æ£€æŸ¥é˜²ç«å¢™è§„åˆ™</li><li>æ£€æŸ¥ SELinux</li></ul></li></ol><h2 id="8-æ€»ç»“"><a href="#8-æ€»ç»“" class="headerlink" title="8. æ€»ç»“"></a>8. æ€»ç»“</h2><p>ç½‘ç»œæ¥å£ã€ç«¯å£å’Œç½‘å¡æ˜¯ç½‘ç»œé€šä¿¡ä¸­çš„ä¸‰ä¸ªé‡è¦æ¦‚å¿µï¼Œå®ƒä»¬åˆ†åˆ«ä½äºä¸åŒçš„ç½‘ç»œå±‚æ¬¡ï¼Œå…±åŒåä½œå®Œæˆç½‘ç»œé€šä¿¡ã€‚ç†è§£å®ƒä»¬ä¹‹é—´çš„å…³ç³»å’Œå·¥ä½œæµç¨‹ï¼Œå¯¹äºç½‘ç»œç®¡ç†å’Œæ•…éšœæ’æŸ¥éƒ½è‡³å…³é‡è¦ã€‚</p><h2 id="9-ç½‘å¡å¤šæ¥å£è¯¦è§£"><a href="#9-ç½‘å¡å¤šæ¥å£è¯¦è§£" class="headerlink" title="9. ç½‘å¡å¤šæ¥å£è¯¦è§£"></a>9. ç½‘å¡å¤šæ¥å£è¯¦è§£</h2><h3 id="9-1-ç½‘å¡å¤šæ¥å£ç±»å‹"><a href="#9-1-ç½‘å¡å¤šæ¥å£ç±»å‹" class="headerlink" title="9.1 ç½‘å¡å¤šæ¥å£ç±»å‹"></a>9.1 ç½‘å¡å¤šæ¥å£ç±»å‹</h3><ol><li><p><strong>ç‰©ç†æ¥å£</strong></p><ul><li>ä¸€ä¸ªç½‘å¡å¯ä»¥æ”¯æŒå¤šä¸ªç‰©ç†æ¥å£</li><li>ä¾‹å¦‚ï¼šåŒç«¯å£ç½‘å¡ã€å››ç«¯å£ç½‘å¡</li><li>æ¯ä¸ªç‰©ç†æ¥å£éƒ½æœ‰ç‹¬ç«‹çš„ MAC åœ°å€</li></ul></li><li><p><strong>è™šæ‹Ÿæ¥å£</strong></p><ul><li>åŸºäºå•ä¸ªç‰©ç†ç½‘å¡åˆ›å»ºå¤šä¸ªè™šæ‹Ÿæ¥å£</li><li>å¸¸è§ç±»å‹ï¼š<ul><li>VLAN æ¥å£ï¼ˆ802.1Qï¼‰</li><li>å­æ¥å£ï¼ˆeth0:0, eth0:1ï¼‰</li><li>æ¡¥æ¥æ¥å£</li><li>ç»‘å®šæ¥å£ï¼ˆbondï¼‰</li></ul></li></ul></li></ol><h3 id="9-2-å¤šæ¥å£é…ç½®ç¤ºä¾‹"><a href="#9-2-å¤šæ¥å£é…ç½®ç¤ºä¾‹" class="headerlink" title="9.2 å¤šæ¥å£é…ç½®ç¤ºä¾‹"></a>9.2 å¤šæ¥å£é…ç½®ç¤ºä¾‹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»º VLAN æ¥å£</span></span><br><span class="line">ip <span class="built_in">link</span> add <span class="built_in">link</span> eth0 name eth0.100 <span class="built_in">type</span> vlan <span class="built_in">id</span> 100</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºå­æ¥å£</span></span><br><span class="line">ip addr add 192.168.1.100/24 dev eth0:0</span><br><span class="line">ip addr add 192.168.2.100/24 dev eth0:1</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºç½‘æ¡¥</span></span><br><span class="line">brctl addbr br0</span><br><span class="line">brctl addif br0 eth0</span><br></pre></td></tr></table></figure><h3 id="9-3-å¤šæ¥å£åº”ç”¨åœºæ™¯"><a href="#9-3-å¤šæ¥å£åº”ç”¨åœºæ™¯" class="headerlink" title="9.3 å¤šæ¥å£åº”ç”¨åœºæ™¯"></a>9.3 å¤šæ¥å£åº”ç”¨åœºæ™¯</h3><pre class="mermaid">graph TD    A[ç‰©ç†ç½‘å¡] --> B[eth0]    B --> C[eth0:0]    B --> D[eth0:1]    B --> E[eth0.100]    C --> F[192.168.1.0/24]    D --> G[192.168.2.0/24]    E --> H[VLAN 100]</pre><ol><li><p><strong>ç½‘ç»œéš”ç¦»</strong></p><ul><li>ä¸åŒç½‘æ®µéš”ç¦»</li><li>å®‰å…¨åŒºåŸŸåˆ’åˆ†</li><li>æµé‡æ§åˆ¶</li></ul></li><li><p><strong>è´Ÿè½½å‡è¡¡</strong></p><ul><li>å¤šæ¥å£ç»‘å®š</li><li>æµé‡åˆ†å‘</li><li>é«˜å¯ç”¨æ€§</li></ul></li><li><p><strong>è™šæ‹ŸåŒ–ç¯å¢ƒ</strong></p><ul><li>è™šæ‹Ÿæœºç½‘ç»œ</li><li>å®¹å™¨ç½‘ç»œ</li><li>äº‘å¹³å°ç½‘ç»œ</li></ul></li></ol><h3 id="9-4-å¤šæ¥å£ç®¡ç†"><a href="#9-4-å¤šæ¥å£ç®¡ç†" class="headerlink" title="9.4 å¤šæ¥å£ç®¡ç†"></a>9.4 å¤šæ¥å£ç®¡ç†</h3><ol><li><p><strong>æ¥å£å‘½å</strong></p><ul><li>ç‰©ç†æ¥å£ï¼šeth0, eth1</li><li>å­æ¥å£ï¼šeth0:0, eth0:1</li><li>VLANæ¥å£ï¼šeth0.100</li><li>ç»‘å®šæ¥å£ï¼šbond0</li></ul></li><li><p><strong>é…ç½®ç®¡ç†</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹æ‰€æœ‰æ¥å£</span></span><br><span class="line">ip <span class="built_in">link</span> show</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ¥å£è¯¦ç»†ä¿¡æ¯</span></span><br><span class="line">ip addr show</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ¥å£ç»Ÿè®¡ä¿¡æ¯</span></span><br><span class="line">ip -s <span class="built_in">link</span> show eth0</span><br></pre></td></tr></table></figure></li><li><p><strong>æ€§èƒ½è€ƒè™‘</strong></p><ul><li>æ¥å£å¸¦å®½å…±äº«</li><li>èµ„æºç«äº‰</li><li>ä¼˜å…ˆçº§è®¾ç½®</li></ul></li></ol><h3 id="9-5-å¤šæ¥å£æœ€ä½³å®è·µ"><a href="#9-5-å¤šæ¥å£æœ€ä½³å®è·µ" class="headerlink" title="9.5 å¤šæ¥å£æœ€ä½³å®è·µ"></a>9.5 å¤šæ¥å£æœ€ä½³å®è·µ</h3><ol><li><p><strong>è§„åˆ’å»ºè®®</strong></p><ul><li>åˆç†è§„åˆ’ IP åœ°å€</li><li>è€ƒè™‘ç½‘ç»œæ‹“æ‰‘</li><li>é¢„ç•™æ‰©å±•ç©ºé—´</li></ul></li><li><p><strong>å®‰å…¨å»ºè®®</strong></p><ul><li>æ¥å£è®¿é—®æ§åˆ¶</li><li>æµé‡ç›‘æ§</li><li>æ—¥å¿—è®°å½•</li></ul></li><li><p><strong>ç»´æŠ¤å»ºè®®</strong></p><ul><li>å®šæœŸæ£€æŸ¥çŠ¶æ€</li><li>ç›‘æ§æ€§èƒ½</li><li>åŠæ—¶æ›´æ–°é…ç½®</li></ul></li></ol><h2 id="10-ç½‘å¡æ¥å£ç±»å‹è¯¦è§£"><a href="#10-ç½‘å¡æ¥å£ç±»å‹è¯¦è§£" class="headerlink" title="10. ç½‘å¡æ¥å£ç±»å‹è¯¦è§£"></a>10. ç½‘å¡æ¥å£ç±»å‹è¯¦è§£</h2><h3 id="10-1-ç‰©ç†æ¥å£ç±»å‹"><a href="#10-1-ç‰©ç†æ¥å£ç±»å‹" class="headerlink" title="10.1 ç‰©ç†æ¥å£ç±»å‹"></a>10.1 ç‰©ç†æ¥å£ç±»å‹</h3><ol><li><p><strong>å•ç«¯å£ç½‘å¡</strong></p><ul><li>æœ€åŸºæœ¬çš„ç½‘å¡ç±»å‹</li><li>åªæœ‰ä¸€ä¸ªç‰©ç†ç½‘ç»œæ¥å£</li><li>é€‚ç”¨äºæ™®é€šå·¥ä½œç«™å’ŒæœåŠ¡å™¨</li></ul></li><li><p><strong>å¤šç«¯å£ç½‘å¡</strong></p><ul><li>åŒç«¯å£ç½‘å¡ï¼šä¸¤ä¸ªç‰©ç†æ¥å£</li><li>å››ç«¯å£ç½‘å¡ï¼šå››ä¸ªç‰©ç†æ¥å£</li><li>é€‚ç”¨äºéœ€è¦å¤šç½‘ç»œè¿æ¥çš„æœåŠ¡å™¨</li><li>æ”¯æŒé“¾è·¯èšåˆå’Œè´Ÿè½½å‡è¡¡</li></ul></li><li><p><strong>å…‰çº¤ç½‘å¡</strong></p><ul><li>æ”¯æŒå…‰çº¤è¿æ¥</li><li>æä¾›æ›´é«˜çš„å¸¦å®½</li><li>é€‚ç”¨äºæ•°æ®ä¸­å¿ƒå’Œé«˜é€Ÿç½‘ç»œ</li></ul></li><li><p><strong>æ— çº¿ç½‘å¡</strong></p><ul><li>æ”¯æŒ WiFi è¿æ¥</li><li>ç§»åŠ¨è®¾å¤‡å¸¸ç”¨</li><li>æ”¯æŒå¤šç§æ— çº¿æ ‡å‡†ï¼ˆ802.11a&#x2F;b&#x2F;g&#x2F;n&#x2F;ac&#x2F;axï¼‰</li></ul></li></ol><h3 id="10-2-è™šæ‹Ÿæ¥å£ç±»å‹"><a href="#10-2-è™šæ‹Ÿæ¥å£ç±»å‹" class="headerlink" title="10.2 è™šæ‹Ÿæ¥å£ç±»å‹"></a>10.2 è™šæ‹Ÿæ¥å£ç±»å‹</h3><ol><li><p><strong>VLAN æ¥å£</strong></p><ul><li>åŸºäº 802.1Q åè®®</li><li>å®ç°è™šæ‹Ÿå±€åŸŸç½‘éš”ç¦»</li><li>æ”¯æŒè·¨ç‰©ç†ç½‘ç»œçš„é€»è¾‘éš”ç¦»</li><li>é…ç½®ç¤ºä¾‹ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»º VLAN æ¥å£</span></span><br><span class="line">ip <span class="built_in">link</span> add <span class="built_in">link</span> eth0 name eth0.100 <span class="built_in">type</span> vlan <span class="built_in">id</span> 100</span><br><span class="line">ip addr add 192.168.100.1/24 dev eth0.100</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>å­æ¥å£</strong></p><ul><li>åŸºäºç‰©ç†æ¥å£åˆ›å»º</li><li>æ”¯æŒå¤šä¸ª IP åœ°å€</li><li>é€‚ç”¨äºå¤šç½‘æ®µé…ç½®</li><li>é…ç½®ç¤ºä¾‹ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºå­æ¥å£</span></span><br><span class="line">ip addr add 192.168.1.100/24 dev eth0:0</span><br><span class="line">ip addr add 192.168.2.100/24 dev eth0:1</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>ç½‘æ¡¥æ¥å£</strong></p><ul><li>è¿æ¥å¤šä¸ªç½‘ç»œæ¥å£</li><li>å®ç°äºŒå±‚äº¤æ¢åŠŸèƒ½</li><li>å¸¸ç”¨äºè™šæ‹ŸåŒ–ç¯å¢ƒ</li><li>é…ç½®ç¤ºä¾‹ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºç½‘æ¡¥</span></span><br><span class="line">brctl addbr br0</span><br><span class="line">brctl addif br0 eth0</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> br0 up</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>ç»‘å®šæ¥å£ï¼ˆBondï¼‰</strong></p><ul><li>å¤šä¸ªç‰©ç†æ¥å£ç»‘å®š</li><li>æä¾›é«˜å¯ç”¨æ€§å’Œè´Ÿè½½å‡è¡¡</li><li>æ”¯æŒå¤šç§ç»‘å®šæ¨¡å¼</li><li>é…ç½®ç¤ºä¾‹ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºç»‘å®šæ¥å£</span></span><br><span class="line">ip <span class="built_in">link</span> add bond0 <span class="built_in">type</span> bond</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> eth0 master bond0</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> eth1 master bond0</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>éš§é“æ¥å£</strong></p><ul><li>æ”¯æŒå„ç§éš§é“åè®®</li><li>ç”¨äº VPN å’Œè·¨ç½‘ç»œé€šä¿¡</li><li>å¸¸è§ç±»å‹ï¼šGREã€IPIPã€VXLAN</li><li>é…ç½®ç¤ºä¾‹ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»º GRE éš§é“</span></span><br><span class="line">ip tunnel add tun0 mode gre remote 203.0.113.1 <span class="built_in">local</span> 192.168.1.100</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> tun0 up</span><br></pre></td></tr></table></figure></li></ul></li></ol><h3 id="10-3-ç½‘å¡å¤šæ¥å£çš„ä½œç”¨"><a href="#10-3-ç½‘å¡å¤šæ¥å£çš„ä½œç”¨" class="headerlink" title="10.3 ç½‘å¡å¤šæ¥å£çš„ä½œç”¨"></a>10.3 ç½‘å¡å¤šæ¥å£çš„ä½œç”¨</h3><ol><li><p><strong>ç½‘ç»œéš”ç¦»</strong></p><pre class="mermaid">   graph TD    A[ç‰©ç†ç½‘å¡] --> B[eth0]    B --> C[VLAN 100]    B --> D[VLAN 200]    C --> E[éƒ¨é—¨Aç½‘ç»œ]    D --> F[éƒ¨é—¨Bç½‘ç»œ]</pre></li><li><p><strong>è´Ÿè½½å‡è¡¡</strong></p><pre class="mermaid">   graph LR    A[æµé‡] --> B[eth0]    A --> C[eth1]    B --> D[æœåŠ¡å™¨]    C --> D</pre></li><li><p><strong>é«˜å¯ç”¨æ€§</strong></p><pre class="mermaid">   graph TD    A[ä¸»æ¥å£] --> B[æœåŠ¡]    C[å¤‡ç”¨æ¥å£] --> B    D[æ•…éšœæ£€æµ‹] --> A    D --> C</pre></li></ol><h3 id="10-4-å¤šæ¥å£åº”ç”¨åœºæ™¯"><a href="#10-4-å¤šæ¥å£åº”ç”¨åœºæ™¯" class="headerlink" title="10.4 å¤šæ¥å£åº”ç”¨åœºæ™¯"></a>10.4 å¤šæ¥å£åº”ç”¨åœºæ™¯</h3><ol><li><p><strong>ä¼ä¸šç½‘ç»œ</strong></p><ul><li>éƒ¨é—¨ç½‘ç»œéš”ç¦»</li><li>å®‰å…¨åŒºåŸŸåˆ’åˆ†</li><li>æµé‡æ§åˆ¶</li></ul></li><li><p><strong>æ•°æ®ä¸­å¿ƒ</strong></p><ul><li>æœåŠ¡å™¨é«˜å¯ç”¨</li><li>è´Ÿè½½å‡è¡¡</li><li>ç½‘ç»œè™šæ‹ŸåŒ–</li></ul></li><li><p><strong>äº‘å¹³å°</strong></p><ul><li>è™šæ‹Ÿæœºç½‘ç»œ</li><li>å®¹å™¨ç½‘ç»œ</li><li>å¤šç§Ÿæˆ·éš”ç¦»</li></ul></li><li><p><strong>å®‰å…¨é˜²æŠ¤</strong></p><ul><li>ç½‘ç»œéš”ç¦»</li><li>æµé‡ç›‘æ§</li><li>è®¿é—®æ§åˆ¶</li></ul></li></ol><h3 id="10-5-å¤šæ¥å£ä¼˜åŠ¿"><a href="#10-5-å¤šæ¥å£ä¼˜åŠ¿" class="headerlink" title="10.5 å¤šæ¥å£ä¼˜åŠ¿"></a>10.5 å¤šæ¥å£ä¼˜åŠ¿</h3><ol><li><p><strong>çµæ´»æ€§</strong></p><ul><li>æ”¯æŒå¤šç§ç½‘ç»œé…ç½®</li><li>é€‚åº”ä¸åŒç½‘ç»œéœ€æ±‚</li><li>ä¾¿äºç½‘ç»œæ‰©å±•</li></ul></li><li><p><strong>å¯é æ€§</strong></p><ul><li>æä¾›å†—ä½™è¿æ¥</li><li>æ”¯æŒæ•…éšœè½¬ç§»</li><li>æé«˜ç³»ç»Ÿå¯ç”¨æ€§</li></ul></li><li><p><strong>æ€§èƒ½</strong></p><ul><li>æ”¯æŒè´Ÿè½½å‡è¡¡</li><li>æé«˜å¸¦å®½åˆ©ç”¨ç‡</li><li>ä¼˜åŒ–ç½‘ç»œæ€§èƒ½</li></ul></li><li><p><strong>å®‰å…¨æ€§</strong></p><ul><li>å®ç°ç½‘ç»œéš”ç¦»</li><li>æ§åˆ¶è®¿é—®æƒé™</li><li>ä¿æŠ¤æ•æ„Ÿæ•°æ®</li></ul></li></ol><h3 id="10-6-å¤šæ¥å£æ³¨æ„äº‹é¡¹"><a href="#10-6-å¤šæ¥å£æ³¨æ„äº‹é¡¹" class="headerlink" title="10.6 å¤šæ¥å£æ³¨æ„äº‹é¡¹"></a>10.6 å¤šæ¥å£æ³¨æ„äº‹é¡¹</h3><ol><li><p><strong>èµ„æºæ¶ˆè€—</strong></p><ul><li>å¢åŠ ç³»ç»Ÿè´Ÿè½½</li><li>éœ€è¦æ›´å¤šå†…å­˜</li><li>å¯èƒ½å½±å“æ€§èƒ½</li></ul></li><li><p><strong>é…ç½®å¤æ‚åº¦</strong></p><ul><li>éœ€è¦ä¸“ä¸šçŸ¥è¯†</li><li>é…ç½®å®¹æ˜“å‡ºé”™</li><li>ç»´æŠ¤æˆæœ¬é«˜</li></ul></li><li><p><strong>å…¼å®¹æ€§</strong></p><ul><li>é©±åŠ¨æ”¯æŒ</li><li>åè®®å…¼å®¹</li><li>è®¾å¤‡é™åˆ¶</li></ul></li></ol>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> ç½‘ç»œ </tag>
            
            <tag> ç³»ç»Ÿ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxå†…æ ¸çš„netfilterè¯¦è§£</title>
      <link href="/2025/06/12/Linux%E5%86%85%E6%A0%B8%E7%9A%84netfilter%E8%AF%A6%E8%A7%A3/"/>
      <url>/2025/06/12/Linux%E5%86%85%E6%A0%B8%E7%9A%84netfilter%E8%AF%A6%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<h1 id="Linuxå†…æ ¸çš„netfilterè¯¦è§£"><a href="#Linuxå†…æ ¸çš„netfilterè¯¦è§£" class="headerlink" title="Linuxå†…æ ¸çš„netfilterè¯¦è§£"></a>Linuxå†…æ ¸çš„netfilterè¯¦è§£</h1><p>Linuxå†…æ ¸çš„netfilteræ˜¯ä¸€ä¸ªå¼ºå¤§çš„ç½‘ç»œæ•°æ®åŒ…è¿‡æ»¤å’Œå¤„ç†æ¡†æ¶ï¼Œå®ƒæ˜¯Linuxå†…æ ¸ç½‘ç»œæ ˆçš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ã€‚</p><h2 id="ğŸ”-ä»€ä¹ˆæ˜¯netfilter"><a href="#ğŸ”-ä»€ä¹ˆæ˜¯netfilter" class="headerlink" title="ğŸ” ä»€ä¹ˆæ˜¯netfilter"></a>ğŸ” ä»€ä¹ˆæ˜¯netfilter</h2><p><strong>netfilter</strong>æ˜¯Linuxå†…æ ¸ä¸­çš„ä¸€ä¸ªæ¡†æ¶ï¼Œå®ƒæä¾›äº†ä¸€ç³»åˆ—çš„é’©å­ï¼ˆhooksï¼‰æ¥å…è®¸å†…æ ¸æ¨¡å—åœ¨ç½‘ç»œæ ˆçš„ä¸åŒä½ç½®æ³¨å†Œå›è°ƒå‡½æ•°ï¼Œä»è€Œå®ç°å¯¹ç½‘ç»œæ•°æ®åŒ…çš„æ‹¦æˆªã€ä¿®æ”¹ã€è¿‡æ»¤å’Œå¤„ç†ã€‚</p><h2 id="ğŸ—ï¸-netfilteræ¶æ„"><a href="#ğŸ—ï¸-netfilteræ¶æ„" class="headerlink" title="ğŸ—ï¸ netfilteræ¶æ„"></a>ğŸ—ï¸ netfilteræ¶æ„</h2><h3 id="æ ¸å¿ƒç»„ä»¶"><a href="#æ ¸å¿ƒç»„ä»¶" class="headerlink" title="æ ¸å¿ƒç»„ä»¶"></a>æ ¸å¿ƒç»„ä»¶</h3><ul><li><strong>é’©å­ç‚¹ï¼ˆHook Pointsï¼‰</strong>: åœ¨ç½‘ç»œæ ˆçš„å…³é”®ä½ç½®è®¾ç½®çš„æ‹¦æˆªç‚¹</li><li><strong>é’©å­å‡½æ•°ï¼ˆHook Functionsï¼‰</strong>: æ³¨å†Œåœ¨é’©å­ç‚¹ä¸Šçš„å¤„ç†å‡½æ•°</li><li><strong>ä¼˜å…ˆçº§ç³»ç»Ÿ</strong>: å†³å®šå¤šä¸ªé’©å­å‡½æ•°çš„æ‰§è¡Œé¡ºåº</li><li><strong>è¿”å›å€¼æœºåˆ¶</strong>: æ§åˆ¶æ•°æ®åŒ…çš„åç»­å¤„ç†æµç¨‹</li></ul><h3 id="äº”ä¸ªä¸»è¦é’©å­ç‚¹"><a href="#äº”ä¸ªä¸»è¦é’©å­ç‚¹" class="headerlink" title="äº”ä¸ªä¸»è¦é’©å­ç‚¹"></a>äº”ä¸ªä¸»è¦é’©å­ç‚¹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. NF_INET_PRE_ROUTING    # è·¯ç”±å†³ç­–å‰</span><br><span class="line">2. NF_INET_LOCAL_IN       # æœ¬åœ°è¾“å…¥</span><br><span class="line">3. NF_INET_FORWARD        # è½¬å‘</span><br><span class="line">4. NF_INET_LOCAL_OUT      # æœ¬åœ°è¾“å‡º</span><br><span class="line">5. NF_INET_POST_ROUTING   # è·¯ç”±å†³ç­–å</span><br></pre></td></tr></table></figure><h2 id="ğŸ“Š-æ•°æ®åŒ…å¤„ç†æµç¨‹"><a href="#ğŸ“Š-æ•°æ®åŒ…å¤„ç†æµç¨‹" class="headerlink" title="ğŸ“Š æ•°æ®åŒ…å¤„ç†æµç¨‹"></a>ğŸ“Š æ•°æ®åŒ…å¤„ç†æµç¨‹</h2><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  flowchart TD    A[ç½‘ç»œæ¥å£æ¥æ”¶æ•°æ®åŒ…] --&gt; B[NF_INET_PRE_ROUTING]    B --&gt; C{è·¯ç”±å†³ç­–}    C --&gt;|æœ¬åœ°| D[NF_INET_LOCAL_IN]    C --&gt;|è½¬å‘| E[NF_INET_FORWARD]    D --&gt; F[æœ¬åœ°è¿›ç¨‹]    F --&gt; G[NF_INET_LOCAL_OUT]    E --&gt; H[NF_INET_POST_ROUTING]    G --&gt; H    H --&gt; I[ç½‘ç»œæ¥å£å‘é€æ•°æ®åŒ…]        style B fill:#ff9999    style D fill:#ff9999    style E fill:#ff9999    style G fill:#ff9999    style H fill:#ff9999  </pre></div><h2 id="ğŸŒ-Linuxç½‘ç»œæ•°æ®åŒ…å®Œæ•´æµç¨‹"><a href="#ğŸŒ-Linuxç½‘ç»œæ•°æ®åŒ…å®Œæ•´æµç¨‹" class="headerlink" title="ğŸŒ Linuxç½‘ç»œæ•°æ®åŒ…å®Œæ•´æµç¨‹"></a>ğŸŒ Linuxç½‘ç»œæ•°æ®åŒ…å®Œæ•´æµç¨‹</h2><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    A[ç½‘å¡ç¡¬ä»¶] --&gt; B[ç½‘å¡é©±åŠ¨]    B --&gt; C[å†…æ ¸ç½‘ç»œæ ˆ]    C --&gt; D[netfilteré’©å­ç‚¹]    D --&gt; E[åè®®æ ˆå¤„ç†]    E --&gt; F[Socketå±‚]    F --&gt; G[åº”ç”¨ç¨‹åº]        style D fill:#ff9999    style C fill:#99ccff  </pre></div><h2 id="ğŸ“-netfilterçš„ç²¾ç¡®ä½ç½®"><a href="#ğŸ“-netfilterçš„ç²¾ç¡®ä½ç½®" class="headerlink" title="ğŸ“ netfilterçš„ç²¾ç¡®ä½ç½®"></a>ğŸ“ netfilterçš„ç²¾ç¡®ä½ç½®</h2><p>netfilter<strong>ä¸æ˜¯</strong>ä¸€ä¸ªç‹¬ç«‹çš„ç½‘ç»œå±‚ï¼Œè€Œæ˜¯<strong>åµŒå…¥åœ¨å†…æ ¸ç½‘ç»œåè®®æ ˆä¸­çš„é’©å­ç³»ç»Ÿ</strong>ã€‚</p><h3 id="è¯¦ç»†çš„æ•°æ®åŒ…å¤„ç†æµç¨‹"><a href="#è¯¦ç»†çš„æ•°æ®åŒ…å¤„ç†æµç¨‹" class="headerlink" title="è¯¦ç»†çš„æ•°æ®åŒ…å¤„ç†æµç¨‹"></a>è¯¦ç»†çš„æ•°æ®åŒ…å¤„ç†æµç¨‹</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  flowchart TD    Start([å¼€å§‹]) --&gt; A[ç½‘å¡æ¥æ”¶æ•°æ®åŒ…]    A --&gt; B[ç½‘å¡é©±åŠ¨å¤„ç†]    B --&gt; C[è¿›å…¥å†…æ ¸ç½‘ç»œæ ˆ]    C --&gt; D[PRE_ROUTINGé’©å­]    D --&gt; E{è·¯ç”±å†³ç­–}        E --&gt;|æœ¬æœºæ•°æ®åŒ…| F[LOCAL_INé’©å­]    F --&gt; G[ä¼ é€’ç»™åº”ç”¨ç¨‹åº]    G --&gt; End1([ç»“æŸ])        E --&gt;|éœ€è¦è½¬å‘| H[FORWARDé’©å­]    H --&gt; I[POST_ROUTINGé’©å­]    I --&gt; J[ä»ç½‘å¡å‘å‡º]    J --&gt; End2([ç»“æŸ])        K[åº”ç”¨ç¨‹åº] --&gt; L[LOCAL_OUTé’©å­]    L --&gt; M[POST_ROUTINGé’©å­]    M --&gt; N[ä»ç½‘å¡å‘å‡º]    N --&gt; End3([ç»“æŸ])        style D fill:#ffcccc    style F fill:#ffcccc    style H fill:#ffcccc    style L fill:#ffcccc    style I fill:#ffcccc    style M fill:#ffcccc  </pre></div><h2 id="ğŸ—ï¸-åœ¨ç½‘ç»œåè®®æ ˆä¸­çš„å…·ä½“ä½ç½®"><a href="#ğŸ—ï¸-åœ¨ç½‘ç»œåè®®æ ˆä¸­çš„å…·ä½“ä½ç½®" class="headerlink" title="ğŸ—ï¸ åœ¨ç½‘ç»œåè®®æ ˆä¸­çš„å…·ä½“ä½ç½®"></a>ğŸ—ï¸ åœ¨ç½‘ç»œåè®®æ ˆä¸­çš„å…·ä½“ä½ç½®</h2><h3 id="å®Œæ•´çš„ç½‘ç»œå±‚æ¬¡ç»“æ„"><a href="#å®Œæ•´çš„ç½‘ç»œå±‚æ¬¡ç»“æ„" class="headerlink" title="å®Œæ•´çš„ç½‘ç»œå±‚æ¬¡ç»“æ„"></a>å®Œæ•´çš„ç½‘ç»œå±‚æ¬¡ç»“æ„</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    A[åº”ç”¨ç¨‹åº&lt;br&#x2F;&gt;HTTP, SSHç­‰] --&gt; B[Socket API]    B --&gt; C[ä¼ è¾“å±‚&lt;br&#x2F;&gt;TCP&#x2F;UDP]    C --&gt; D[ç½‘ç»œå±‚ IP + netfilteré’©å­]    D --&gt; E[æ•°æ®é“¾è·¯å±‚&lt;br&#x2F;&gt;Ethernet]    E --&gt; F[ç‰©ç†å±‚&lt;br&#x2F;&gt;ç½‘å¡é©±åŠ¨]        style D fill:#ffcccc        G[netfilteråœ¨è¿™é‡Œ!] -.-&gt; D    style G fill:#yellow  </pre></div><h2 id="ğŸ¯-å®é™…ä¾‹å­ï¼šæ•°æ®åŒ…çš„æ—…ç¨‹"><a href="#ğŸ¯-å®é™…ä¾‹å­ï¼šæ•°æ®åŒ…çš„æ—…ç¨‹" class="headerlink" title="ğŸ¯ å®é™…ä¾‹å­ï¼šæ•°æ®åŒ…çš„æ—…ç¨‹"></a>ğŸ¯ å®é™…ä¾‹å­ï¼šæ•°æ®åŒ…çš„æ—…ç¨‹</h2><h3 id="åœºæ™¯ï¼šå¤–éƒ¨HTTPè¯·æ±‚è®¿é—®æœ¬æœº80ç«¯å£"><a href="#åœºæ™¯ï¼šå¤–éƒ¨HTTPè¯·æ±‚è®¿é—®æœ¬æœº80ç«¯å£" class="headerlink" title="åœºæ™¯ï¼šå¤–éƒ¨HTTPè¯·æ±‚è®¿é—®æœ¬æœº80ç«¯å£"></a>åœºæ™¯ï¼šå¤–éƒ¨HTTPè¯·æ±‚è®¿é—®æœ¬æœº80ç«¯å£</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  flowchart TD    A[ç½‘å¡æ¥æ”¶åˆ°TCPåŒ…&lt;br&#x2F;&gt;ç›®æ ‡ç«¯å£80] --&gt; B[ç½‘å¡é©±åŠ¨å°†åŒ…ä¼ é€’ç»™å†…æ ¸]    B --&gt; C[IPå±‚å¼€å§‹å¤„ç†]    C --&gt; D[PRE_ROUTINGé’©å­]    D --&gt; E[è·¯ç”±å†³ç­–:è¿™æ˜¯å‘ç»™æœ¬æœºçš„åŒ…]    E --&gt; F[LOCAL_INé’©å­]    F --&gt; G[ä¼ é€’ç»™TCPå±‚]    G --&gt; H[ä¼ é€’ç»™ç›‘å¬80ç«¯å£çš„åº”ç”¨ç¨‹åº&lt;br&#x2F;&gt;å¦‚Apache]        D -.-&gt; D1[iptables DNATè§„åˆ™æ£€æŸ¥&lt;br&#x2F;&gt;è¿æ¥è·Ÿè¸ªè®°å½•&lt;br&#x2F;&gt;å¯èƒ½çš„ç«¯å£è½¬å‘]    F -.-&gt; F1[iptables INPUTé“¾è§„åˆ™æ£€æŸ¥&lt;br&#x2F;&gt;é˜²ç«å¢™è¿‡æ»¤&lt;br&#x2F;&gt;ACCEPTç»§ç»­,DROPä¸¢å¼ƒ]        style D fill:#ffcccc    style F fill:#ffcccc    style D1 fill:#ffffcc    style F1 fill:#ffffcc  </pre></div><h3 id="åœºæ™¯ï¼šæœ¬æœºä½œä¸ºè·¯ç”±å™¨è½¬å‘æ•°æ®åŒ…"><a href="#åœºæ™¯ï¼šæœ¬æœºä½œä¸ºè·¯ç”±å™¨è½¬å‘æ•°æ®åŒ…" class="headerlink" title="åœºæ™¯ï¼šæœ¬æœºä½œä¸ºè·¯ç”±å™¨è½¬å‘æ•°æ®åŒ…"></a>åœºæ™¯ï¼šæœ¬æœºä½œä¸ºè·¯ç”±å™¨è½¬å‘æ•°æ®åŒ…</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  flowchart TD    A[ç½‘å¡Aæ¥æ”¶åˆ°æ•°æ®åŒ…] --&gt; B[PRE_ROUTINGé’©å­]    B --&gt; C[è·¯ç”±å†³ç­–:éœ€è¦ä»ç½‘å¡Bè½¬å‘å‡ºå»]    C --&gt; D[FORWARDé’©å­]    D --&gt; E[POST_ROUTINGé’©å­]    E --&gt; F[ä»ç½‘å¡Bå‘å‡º]        B -.-&gt; B1[NAT PREROUTINGè§„åˆ™]    D -.-&gt; D1[iptables FORWARDé“¾æ£€æŸ¥&lt;br&#x2F;&gt;è½¬å‘ç­–ç•¥éªŒè¯]    E -.-&gt; E1[NAT POSTROUTINGè§„åˆ™&lt;br&#x2F;&gt;MASQUERADEå¤„ç†]        style B fill:#ffcccc    style D fill:#ffcccc    style E fill:#ffcccc    style B1 fill:#ffffcc    style D1 fill:#ffffcc    style E1 fill:#ffffcc  </pre></div><h2 id="ğŸ› ï¸-ä¸»è¦åŠŸèƒ½"><a href="#ğŸ› ï¸-ä¸»è¦åŠŸèƒ½" class="headerlink" title="ğŸ› ï¸ ä¸»è¦åŠŸèƒ½"></a>ğŸ› ï¸ ä¸»è¦åŠŸèƒ½</h2><h3 id="netfilteråŠŸèƒ½æ¶æ„"><a href="#netfilteråŠŸèƒ½æ¶æ„" class="headerlink" title="netfilteråŠŸèƒ½æ¶æ„"></a>netfilteråŠŸèƒ½æ¶æ„</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    A[netfilter] --&gt; B[æ•°æ®åŒ…è¿‡æ»¤]    A --&gt; C[ç½‘ç»œåœ°å€è½¬æ¢]    A --&gt; D[æ•°æ®åŒ…ä¿®æ”¹]    A --&gt; E[è¿æ¥è·Ÿè¸ª]        B --&gt; B1[æº&#x2F;ç›®æ ‡IPè¿‡æ»¤]    B --&gt; B2[ç«¯å£å·è¿‡æ»¤]    B --&gt; B3[åè®®ç±»å‹è¿‡æ»¤]    B --&gt; B4[çŠ¶æ€è·Ÿè¸ªè¿‡æ»¤]        C --&gt; C1[SNATæºåœ°å€è½¬æ¢]    C --&gt; C2[DNATç›®æ ‡åœ°å€è½¬æ¢]    C --&gt; C3[MASQUERADEåœ°å€ä¼ªè£…]    C --&gt; C4[ç«¯å£æ˜ å°„]        D --&gt; D1[IPå¤´éƒ¨ä¿®æ”¹]    D --&gt; D2[ä¼ è¾“å±‚å¤´éƒ¨ä¿®æ”¹]    D --&gt; D3[æ•°æ®åŒ…æ ‡è®°]    D --&gt; D4[QoSæ ‡è®°]        E --&gt; E1[TCPè¿æ¥çŠ¶æ€]    E --&gt; E2[UDPä¼ªè¿æ¥]    E --&gt; E3[ç›¸å…³è¿æ¥å¤„ç†]        style A fill:#ff9999    style B fill:#99ccff    style C fill:#99ccff    style D fill:#99ccff    style E fill:#99ccff  </pre></div><h2 id="ğŸ”§-åŸºäºnetfilterçš„å·¥å…·"><a href="#ğŸ”§-åŸºäºnetfilterçš„å·¥å…·" class="headerlink" title="ğŸ”§ åŸºäºnetfilterçš„å·¥å…·"></a>ğŸ”§ åŸºäºnetfilterçš„å·¥å…·</h2><h3 id="å·¥å…·ç”Ÿæ€ç³»ç»Ÿ"><a href="#å·¥å…·ç”Ÿæ€ç³»ç»Ÿ" class="headerlink" title="å·¥å…·ç”Ÿæ€ç³»ç»Ÿ"></a>å·¥å…·ç”Ÿæ€ç³»ç»Ÿ</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    A[netfilterå†…æ ¸æ¡†æ¶] --&gt; B[iptables]    A --&gt; C[nftables]    A --&gt; D[conntrack]    A --&gt; E[ebtables]    A --&gt; F[arptables]        B --&gt; B1[é˜²ç«å¢™è§„åˆ™]    B --&gt; B2[NATé…ç½®]    B --&gt; B3[ç«¯å£è½¬å‘]        C --&gt; C1[æ–°ä¸€ä»£é˜²ç«å¢™]    C --&gt; C2[ç»Ÿä¸€è§„åˆ™è¯­æ³•]    C --&gt; C3[æ›´å¥½çš„æ€§èƒ½]        D --&gt; D1[è¿æ¥è·Ÿè¸ª]    D --&gt; D2[çŠ¶æ€ç›‘æ§]    D --&gt; D3[è¿æ¥ç®¡ç†]        style A fill:#ff9999    style B fill:#99ccff    style C fill:#99ccff    style D fill:#99ccff    style E fill:#99ccff    style F fill:#99ccff  </pre></div><h2 id="ğŸ’»-ç¼–ç¨‹æ¥å£"><a href="#ğŸ’»-ç¼–ç¨‹æ¥å£" class="headerlink" title="ğŸ’» ç¼–ç¨‹æ¥å£"></a>ğŸ’» ç¼–ç¨‹æ¥å£</h2><h3 id="å†…æ ¸æ¨¡å—å¼€å‘"><a href="#å†…æ ¸æ¨¡å—å¼€å‘" class="headerlink" title="å†…æ ¸æ¨¡å—å¼€å‘"></a>å†…æ ¸æ¨¡å—å¼€å‘</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/netfilter.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/netfilter_ipv4.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">hook_func</span><span class="params">(<span class="type">void</span> *priv,</span></span><br><span class="line"><span class="params">                              <span class="keyword">struct</span> sk_buff *skb,</span></span><br><span class="line"><span class="params">                              <span class="type">const</span> <span class="keyword">struct</span> nf_hook_state *state)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// å¤„ç†æ•°æ®åŒ…</span></span><br><span class="line">    <span class="keyword">return</span> NF_ACCEPT;  <span class="comment">// æˆ– NF_DROP, NF_STOLEN, NF_QUEUE, NF_REPEAT</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">nf_hook_ops</span> <span class="title">netfilter_ops</span> =</span> &#123;</span><br><span class="line">    .hook = hook_func,</span><br><span class="line">    .hooknum = NF_INET_PRE_ROUTING,</span><br><span class="line">    .pf = PF_INET,</span><br><span class="line">    .priority = NF_IP_PRI_FIRST,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="ç”¨æˆ·ç©ºé—´æ¥å£"><a href="#ç”¨æˆ·ç©ºé—´æ¥å£" class="headerlink" title="ç”¨æˆ·ç©ºé—´æ¥å£"></a>ç”¨æˆ·ç©ºé—´æ¥å£</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// libnetfilter_queue ç¤ºä¾‹</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;libnetfilter_queue/libnetfilter_queue.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cb</span><span class="params">(<span class="keyword">struct</span> nfq_q_handle *qh, <span class="keyword">struct</span> nfgenmsg *nfmsg,</span></span><br><span class="line"><span class="params">              <span class="keyword">struct</span> nfq_data *nfa, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// å¤„ç†é˜Ÿåˆ—ä¸­çš„æ•°æ®åŒ…</span></span><br><span class="line">    <span class="keyword">return</span> nfq_set_verdict(qh, id, NF_ACCEPT, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ğŸ¯-åº”ç”¨åœºæ™¯"><a href="#ğŸ¯-åº”ç”¨åœºæ™¯" class="headerlink" title="ğŸ¯ åº”ç”¨åœºæ™¯"></a>ğŸ¯ åº”ç”¨åœºæ™¯</h2><h3 id="åº”ç”¨åœºæ™¯åˆ†ç±»"><a href="#åº”ç”¨åœºæ™¯åˆ†ç±»" class="headerlink" title="åº”ç”¨åœºæ™¯åˆ†ç±»"></a>åº”ç”¨åœºæ™¯åˆ†ç±»</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph LR    A[&quot;netfilteråº”ç”¨åœºæ™¯&quot;] --&gt; B[&quot;ç½‘ç»œå®‰å…¨&quot;]    A --&gt; C[&quot;ç½‘ç»œç®¡ç†&quot;]    A --&gt; D[&quot;æ€§èƒ½ä¼˜åŒ–&quot;]    A --&gt; E[&quot;ç›‘æ§å®¡è®¡&quot;]        B --&gt; B1[&quot;é˜²ç«å¢™&quot;]    B --&gt; B2[&quot;å…¥ä¾µé˜²æŠ¤&quot;]    B --&gt; B3[&quot;è®¿é—®æ§åˆ¶&quot;]        C --&gt; C1[&quot;è´Ÿè½½å‡è¡¡&quot;]    C --&gt; C2[&quot;NATç½‘å…³&quot;]    C --&gt; C3[&quot;è·¯ç”±ç­–ç•¥&quot;]        D --&gt; D1[&quot;æµé‡æ•´å½¢&quot;]    D --&gt; D2[&quot;å¸¦å®½æ§åˆ¶&quot;]    D --&gt; D3[&quot;QoSç®¡ç†&quot;]        E --&gt; E1[&quot;æµé‡åˆ†æ&quot;]    E --&gt; E2[&quot;è¿æ¥ç›‘æ§&quot;]    E --&gt; E3[&quot;å®‰å…¨å®¡è®¡&quot;]        style A fill:#ff9999    style B fill:#99ccff    style C fill:#99ccff    style D fill:#99ccff    style E fill:#99ccff  </pre></div><h2 id="âš¡-æ€§èƒ½ç‰¹ç‚¹"><a href="#âš¡-æ€§èƒ½ç‰¹ç‚¹" class="headerlink" title="âš¡ æ€§èƒ½ç‰¹ç‚¹"></a>âš¡ æ€§èƒ½ç‰¹ç‚¹</h2><h3 id="æ€§èƒ½ä¼˜åŠ¿ä¸æ³¨æ„äº‹é¡¹"><a href="#æ€§èƒ½ä¼˜åŠ¿ä¸æ³¨æ„äº‹é¡¹" class="headerlink" title="æ€§èƒ½ä¼˜åŠ¿ä¸æ³¨æ„äº‹é¡¹"></a>æ€§èƒ½ä¼˜åŠ¿ä¸æ³¨æ„äº‹é¡¹</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    A[&quot;netfilteræ€§èƒ½ç‰¹ç‚¹&quot;] --&gt; B[&quot;ä¼˜åŠ¿&quot;]    A --&gt; C[&quot;æ³¨æ„äº‹é¡¹&quot;]        B --&gt; B1[&quot;å†…æ ¸çº§å¤„ç†&lt;br&#x2F;&gt;é«˜æ€§èƒ½ï¼Œä½å»¶è¿Ÿ&quot;]    B --&gt; B2[&quot;é›¶æ‹·è´&lt;br&#x2F;&gt;é¿å…ä¸å¿…è¦çš„æ•°æ®å¤åˆ¶&quot;]    B --&gt; B3[&quot;æ¨¡å—åŒ–è®¾è®¡&lt;br&#x2F;&gt;çµæ´»çš„åŠŸèƒ½ç»„åˆ&quot;]    B --&gt; B4[&quot;çŠ¶æ€è·Ÿè¸ª&lt;br&#x2F;&gt;æ™ºèƒ½çš„è¿æ¥ç®¡ç†&quot;]        C --&gt; C1[&quot;CPUå¼€é”€&lt;br&#x2F;&gt;å¤æ‚è§„åˆ™ä¼šå½±å“æ€§èƒ½&quot;]    C --&gt; C2[&quot;å†…å­˜ä½¿ç”¨&lt;br&#x2F;&gt;è¿æ¥è·Ÿè¸ªè¡¨å ç”¨å†…å­˜&quot;]    C --&gt; C3[&quot;è§„åˆ™ä¼˜åŒ–&lt;br&#x2F;&gt;éœ€è¦åˆç†è®¾è®¡è§„åˆ™é¡ºåº&quot;]        style B fill:#ccffcc    style C fill:#ffcccc  </pre></div><h2 id="ğŸ”„-ä¸å…¶ä»–ç»„ä»¶çš„å…³ç³»"><a href="#ğŸ”„-ä¸å…¶ä»–ç»„ä»¶çš„å…³ç³»" class="headerlink" title="ğŸ”„ ä¸å…¶ä»–ç»„ä»¶çš„å…³ç³»"></a>ğŸ”„ ä¸å…¶ä»–ç»„ä»¶çš„å…³ç³»</h2><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph TD    A[&quot;åº”ç”¨å±‚å·¥å…·&quot;] --&gt; B[&quot;ç”¨æˆ·ç©ºé—´åº“&quot;]    B --&gt; C[&quot;ç³»ç»Ÿè°ƒç”¨æ¥å£&quot;]    C --&gt; D[&quot;netfilteræ¡†æ¶&quot;]    D --&gt; E[&quot;ç½‘ç»œåè®®æ ˆ&quot;]    E --&gt; F[&quot;ç½‘ç»œè®¾å¤‡é©±åŠ¨&quot;]        A1[&quot;iptables&quot;] --&gt; A    A2[&quot;nftables&quot;] --&gt; A        B1[&quot;libnetfilter_*&quot;] --&gt; B        C1[&quot;netlink socket&quot;] --&gt; C    C2[&quot;sysfsæ¥å£&quot;] --&gt; C        D1[&quot;é’©å­ç®¡ç†&quot;] --&gt; D    D2[&quot;è§„åˆ™åŒ¹é…&quot;] --&gt; D    D3[&quot;è¿æ¥è·Ÿè¸ª&quot;] --&gt; D        E1[&quot;TCP&#x2F;IP&quot;] --&gt; E    E2[&quot;è·¯ç”±å­ç³»ç»Ÿ&quot;] --&gt; E        F1[&quot;ä»¥å¤ªç½‘é©±åŠ¨&quot;] --&gt; F    F2[&quot;æ— çº¿ç½‘å¡é©±åŠ¨&quot;] --&gt; F        style D fill:#ff9999    style E fill:#99ccff  </pre></div><h2 id="ğŸ”-netfilteré’©å­è¯¦ç»†æµç¨‹"><a href="#ğŸ”-netfilteré’©å­è¯¦ç»†æµç¨‹" class="headerlink" title="ğŸ” netfilteré’©å­è¯¦ç»†æµç¨‹"></a>ğŸ” netfilteré’©å­è¯¦ç»†æµç¨‹</h2><h3 id="é’©å­æ‰§è¡Œæœºåˆ¶"><a href="#é’©å­æ‰§è¡Œæœºåˆ¶" class="headerlink" title="é’©å­æ‰§è¡Œæœºåˆ¶"></a>é’©å­æ‰§è¡Œæœºåˆ¶</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  sequenceDiagram    participant App as åº”ç”¨ç¨‹åº    participant Kernel as å†…æ ¸ç½‘ç»œæ ˆ    participant Hook as netfilteré’©å­    participant Rule as è§„åˆ™å¼•æ“    participant Target as ç›®æ ‡åŠ¨ä½œ        Note over Kernel: æ•°æ®åŒ…åˆ°è¾¾é’©å­ç‚¹    Kernel-&gt;&gt;Hook: è°ƒç”¨é’©å­å‡½æ•°    Hook-&gt;&gt;Rule: éå†è§„åˆ™é“¾        alt è§„åˆ™åŒ¹é…        Rule-&gt;&gt;Target: æ‰§è¡Œç›®æ ‡åŠ¨ä½œ        Target--&gt;&gt;Hook: è¿”å›å¤„ç†ç»“æœ    else æ— åŒ¹é…è§„åˆ™        Rule--&gt;&gt;Hook: è¿”å›é»˜è®¤ç­–ç•¥    end        alt NF_ACCEPT        Hook--&gt;&gt;Kernel: ç»§ç»­å¤„ç†        Kernel-&gt;&gt;App: ä¼ é€’ç»™åº”ç”¨    else NF_DROP        Hook--&gt;&gt;Kernel: ä¸¢å¼ƒæ•°æ®åŒ…    else NF_QUEUE        Hook--&gt;&gt;App: ä¼ é€’ç»™ç”¨æˆ·ç©ºé—´    end  </pre></div><h2 id="ğŸ’¡-å…³é”®ç†è§£ç‚¹"><a href="#ğŸ’¡-å…³é”®ç†è§£ç‚¹" class="headerlink" title="ğŸ’¡ å…³é”®ç†è§£ç‚¹"></a>ğŸ’¡ å…³é”®ç†è§£ç‚¹</h2><h3 id="netfilteræ ¸å¿ƒæ¦‚å¿µ"><a href="#netfilteræ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="netfilteræ ¸å¿ƒæ¦‚å¿µ"></a>netfilteræ ¸å¿ƒæ¦‚å¿µ</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph LR    A[&quot;netfilteræ ¸å¿ƒæ¦‚å¿µ&quot;] --&gt; B[&quot;é’©å­ç³»ç»Ÿ&quot;]    A --&gt; C[&quot;è¿”å›å€¼æœºåˆ¶&quot;]    A --&gt; D[&quot;ä¼˜å…ˆçº§ç³»ç»Ÿ&quot;]    A --&gt; E[&quot;è®¾è®¡å“²å­¦&quot;]        B --&gt; B1[&quot;åµŒå…¥åœ¨IPå±‚ä¸­&quot;]    B --&gt; B2[&quot;ä¸æ˜¯ç‹¬ç«‹ç½‘ç»œå±‚&quot;]    B --&gt; B3[&quot;æ¯ä¸ªåŒ…éƒ½ç»è¿‡é’©å­ç‚¹&quot;]    B --&gt; B4[&quot;æ”¯æŒå¤šæ¨¡å—æ³¨å†Œ&quot;]        C --&gt; C1[&quot;NF_ACCEPTç»§ç»­å¤„ç†&quot;]    C --&gt; C2[&quot;NF_DROPä¸¢å¼ƒæ•°æ®åŒ…&quot;]    C --&gt; C3[&quot;NF_STOLENé’©å­æ¥ç®¡&quot;]    C --&gt; C4[&quot;NF_QUEUEç”¨æˆ·ç©ºé—´å¤„ç†&quot;]    C --&gt; C5[&quot;NF_REPEATé‡æ–°å¤„ç†&quot;]        D --&gt; D1[&quot;å†³å®šæ‰§è¡Œé¡ºåº&quot;]    D --&gt; D2[&quot;æ”¯æŒå¤šä¸ªé’©å­å‡½æ•°&quot;]    D --&gt; D3[&quot;çµæ´»çš„æ¨¡å—ç»„åˆ&quot;]        E --&gt; E1[&quot;æœºåˆ¶ä¸ç­–ç•¥åˆ†ç¦»&quot;]    E --&gt; E2[&quot;å†…æ ¸æä¾›æœºåˆ¶&quot;]    E --&gt; E3[&quot;ç”¨æˆ·ç©ºé—´å®ç°ç­–ç•¥&quot;]        style A fill:#ff9999    style B fill:#99ccff    style C fill:#99ccff    style D fill:#99ccff    style E fill:#99ccff  </pre></div><h2 id="ğŸ¯-æ€»ç»“"><a href="#ğŸ¯-æ€»ç»“" class="headerlink" title="ğŸ¯ æ€»ç»“"></a>ğŸ¯ æ€»ç»“</h2><p>netfilteræ˜¯Linuxç½‘ç»œå®‰å…¨å’Œç½‘ç»œç®¡ç†çš„åŸºç¡€è®¾æ–½ï¼Œä¸ºæ„å»ºé˜²ç«å¢™ã€NATã€è´Ÿè½½å‡è¡¡ç­‰ç½‘ç»œåŠŸèƒ½æä¾›äº†å¼ºå¤§è€Œçµæ´»çš„åº•å±‚æ”¯æŒã€‚å®ƒçš„è®¾è®¡å“²å­¦æ˜¯â€æœºåˆ¶ä¸ç­–ç•¥åˆ†ç¦»â€ï¼Œå†…æ ¸æä¾›æœºåˆ¶ï¼Œç”¨æˆ·ç©ºé—´å·¥å…·å®ç°ç­–ç•¥ã€‚</p><h3 id="netfilterçš„æœ¬è´¨"><a href="#netfilterçš„æœ¬è´¨" class="headerlink" title="netfilterçš„æœ¬è´¨"></a>netfilterçš„æœ¬è´¨</h3><div class="mermaid-wrap"><pre class="mermaid-src" hidden>  graph LR    A[&quot;æ•°æ®åŒ…&quot;] --&gt; B[&quot;æ£€æŸ¥ç«™1&lt;br&#x2F;&gt;PRE_ROUTING&quot;]    B --&gt; C[&quot;æ£€æŸ¥ç«™2&lt;br&#x2F;&gt;LOCAL_IN&#x2F;FORWARD&quot;]    C --&gt; D[&quot;æ£€æŸ¥ç«™3&lt;br&#x2F;&gt;LOCAL_OUT&quot;]    D --&gt; E[&quot;æ£€æŸ¥ç«™4&lt;br&#x2F;&gt;POST_ROUTING&quot;]    E --&gt; F[&quot;æ•°æ®åŒ…ç»§ç»­ä¼ è¾“&quot;]        style B fill:#ffcccc    style C fill:#ffcccc    style D fill:#ffcccc    style E fill:#ffcccc        G[&quot;netfilter &#x3D; å†…æ ¸ç½‘ç»œæ ˆä¸­çš„æ£€æŸ¥ç«™ç³»ç»Ÿ&quot;] -.-&gt; B    G -.-&gt; C    G -.-&gt; D    G -.-&gt; E        style G fill:#yellow  </pre></div><p>è¿™æ ·ï¼Œnetfilterå°±åƒæ˜¯åœ¨å†…æ ¸ç½‘ç»œæ ˆçš„å…³é”®ä½ç½®è®¾ç½®çš„â€æ£€æŸ¥ç«™â€ï¼Œæ¯ä¸ªæ•°æ®åŒ…éƒ½å¿…é¡»é€šè¿‡è¿™äº›æ£€æŸ¥ç«™ï¼Œåœ¨é‚£é‡Œå¯ä»¥è¢«æ£€æŸ¥ã€ä¿®æ”¹æˆ–ä¸¢å¼ƒã€‚</p>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>JDK çº¿ç¨‹æ± é‡ŒçœŸçš„åŒºåˆ† æ ¸å¿ƒçº¿ç¨‹ä¸éæ ¸å¿ƒçº¿ç¨‹å—ï¼Ÿ</title>
      <link href="/2025/06/07/JDK%20%E7%BA%BF%E7%A8%8B%E6%B1%A0%E9%87%8C%E7%9C%9F%E7%9A%84%E5%8C%BA%E5%88%86%20%E6%A0%B8%E5%BF%83%E7%BA%BF%E7%A8%8B%E4%B8%8E%E9%9D%9E%E6%A0%B8%E5%BF%83%E7%BA%BF%E7%A8%8B%E5%90%97%EF%BC%9F/"/>
      <url>/2025/06/07/JDK%20%E7%BA%BF%E7%A8%8B%E6%B1%A0%E9%87%8C%E7%9C%9F%E7%9A%84%E5%8C%BA%E5%88%86%20%E6%A0%B8%E5%BF%83%E7%BA%BF%E7%A8%8B%E4%B8%8E%E9%9D%9E%E6%A0%B8%E5%BF%83%E7%BA%BF%E7%A8%8B%E5%90%97%EF%BC%9F/</url>
      
        <content type="html"><![CDATA[<h1 id="JDK-çº¿ç¨‹æ± é‡ŒçœŸçš„åŒºåˆ†-æ ¸å¿ƒçº¿ç¨‹ä¸éæ ¸å¿ƒçº¿ç¨‹å—ï¼Ÿ"><a href="#JDK-çº¿ç¨‹æ± é‡ŒçœŸçš„åŒºåˆ†-æ ¸å¿ƒçº¿ç¨‹ä¸éæ ¸å¿ƒçº¿ç¨‹å—ï¼Ÿ" class="headerlink" title="JDK çº¿ç¨‹æ± é‡ŒçœŸçš„åŒºåˆ† æ ¸å¿ƒçº¿ç¨‹ä¸éæ ¸å¿ƒçº¿ç¨‹å—ï¼Ÿ"></a>JDK çº¿ç¨‹æ± é‡ŒçœŸçš„åŒºåˆ† æ ¸å¿ƒçº¿ç¨‹ä¸éæ ¸å¿ƒçº¿ç¨‹å—ï¼Ÿ</h1><p>ä¸å°‘æ ¡æ‹›å°ä¼™ä¼´å¯¹äºçº¿ç¨‹æ± çš„äº†è§£ï¼Œå¤§æ¦‚å°±æ˜¯å¦‚ä¸‹å›¾ï¼š</p><ul><li>å½“æ ¸å¿ƒçº¿ç¨‹æ•°æœªæ»¡ï¼Œåˆ™æ–°å»ºæ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œä»»åŠ¡</li><li>å½“æ ¸å¿ƒçº¿ç¨‹æ•°æ»¡äº†ï¼Œé˜Ÿåˆ—æœªæ»¡ï¼Œåˆ™å°†ä»»åŠ¡æ”¾åœ¨ç­‰å¾…é˜Ÿåˆ—é‡Œï¼Œç­‰å¾…æ ¸å¿ƒçº¿ç¨‹å»æ‰§è¡Œ</li><li>å½“æ ¸å¿ƒçº¿ç¨‹æ•°æ»¡äº†ï¼ˆä½†æœªè¾¾æœ€å¤§çº¿ç¨‹æ•°ï¼‰ï¼Œé˜Ÿåˆ—ä¹Ÿæ»¡äº†ï¼Œæ–°å»ºéæ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œä»»åŠ¡</li><li>å¦‚æœå·²ç»è¾¾åˆ°æœ€å¤§çº¿ç¨‹æ•°ï¼Œä¸”é˜Ÿåˆ—ä¹Ÿæ»¡äº†ï¼Œåˆ™æ‰§è¡Œé¥±å’Œç­–ç•¥ã€‚</li></ul><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1741656129655-700e91f7-bbd8-44f0-8c1b-c8475cd0471f.png" alt="img"></p><p>ä½†æ˜¯è¿™æ ·çš„äº†è§£ï¼Œå¯èƒ½æ˜¯ä¸å¤Ÿçš„ã€‚å› ä¸ºè¿™åªæ˜¯ä¸€ä¸ªåŸºç¡€çš„æµç¨‹ï¼Œç¨å¾®é—®ç»†ä¸€ç‚¹ã€æ·±ä¸€ç‚¹å°±ä¸å¤Ÿç”¨äº†ã€‚æ¯”å¦‚ï¼Œæˆ‘å¯èƒ½ä¼šé—®ä¸‹é¢è¿™äº›é—®é¢˜ï¼š</p><ul><li>éƒ½æ˜¯çŸ¥é“æ ¸å¿ƒçº¿ç¨‹é»˜è®¤æ˜¯ä¸é”€æ¯çš„ï¼Œé‚£ä¹ˆæ ¸å¿ƒçº¿ç¨‹åœ¨é˜Ÿåˆ—ä¸­æ²¡æœ‰ä»»åŠ¡æ—¶<strong>ï¼Œ</strong>å®ƒæ˜¯ä»€ä¹ˆçŠ¶æ€ï¼ˆçº¿ç¨‹çŠ¶æ€ï¼‰ï¼Œå¯¹äºæ“ä½œç³»ç»Ÿæ¥è¯´ä¼šä¸ä¼šåˆ†é…æ—¶é—´ç‰‡ç»™å®ƒï¼Ÿ</li><li>æˆ‘ä»¬ä¸€èˆ¬è‡ªå·±æ–°åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œå¯èƒ½ä½¿ç”¨ new Threadï¼Œç„¶å æ‰§è¡Œä¸€ä¸‹ start æ–¹æ³•ï¼Œç„¶åè¿™ä¸ªçº¿ç¨‹ æ‰§è¡Œå®Œrunæ–¹æ³•å†…ä»£ç ï¼Œå°±é”€æ¯äº†ã€‚çº¿ç¨‹æ±  ThreadPoolExecutor ä¸­æ˜¯å¦‚ä½•å®ç° çº¿ç¨‹å¤ç”¨çš„ï¼Ÿ</li><li>çº¿ç¨‹æ± ä¸­ åŒºåˆ† æ ¸å¿ƒçº¿ç¨‹ä¸éçº¿ç¨‹çº¿ç¨‹å—ï¼Ÿä»–ä»¬æ•°æ®ç»“æ„ä¸Šä»¥åŠè¡Œä¸ºä¸Šæœ‰ä»€ä¹ˆä¸åŒã€‚</li><li>éæ ¸å¿ƒçº¿ç¨‹æ˜¯ä¸æ˜¯åªæ‰§è¡Œ æ–°æäº¤çš„ä»»åŠ¡ï¼Œä¸æ¶ˆè´¹ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚</li></ul><p>è¿™é‡Œæˆ‘è¯¦ç»†è¯´è¯´é—®é¢˜3ï¼šçº¿ç¨‹æ± ä¸­ åŒºåˆ† æ ¸å¿ƒçº¿ç¨‹ä¸éçº¿ç¨‹çº¿ç¨‹å—ï¼Ÿ</p><p>å®é™…ä¸Šä»æºä»£ç ä¸Šçœ‹ï¼Œæ— è®ºæ˜¯ æ•°æ®ç»“æ„è¿˜æ˜¯è¡Œä¸ºä¸Šï¼Œå…¶æ ¹æ®æ²¡æœ‰å­—æ®µæ ‡è®°è¿™ä¸ª çº¿ç¨‹æ˜¯æ ¸å¿ƒçº¿ç¨‹è¿˜æ˜¯éæ ¸å¿ƒçº¿ç¨‹ã€‚çº¿ç¨‹è¢«åŒ…è£…åœ¨ä¸€ä¸ª Workå¯¹è±¡ä¸­ã€‚è¿™ä¸ª Workå¯¹è±¡ä¸­ åŒ…å«ä¸€ä¸ª Threadå¯¹è±¡å’Œ ä¸€ä¸ªRunnableå¯¹è±¡ä»¥åŠä¸€äº›å…¶ä»–å˜é‡ã€‚<strong>ä½†æ˜¯å¹¶æ²¡æœ‰å˜é‡å»åŒºåˆ†è¿™ä¸ª workå¯¹è±¡æ˜¯ æ‰€è°“æ ¸å¿ƒï¼Œè¿˜æ˜¯éæ ¸å¿ƒ<strong><strong>ã€‚</strong></strong>æ‰€ä»¥è¯´æ•°æ®ç»“æ„ä¸Šæ˜¯ä¸€è‡´çš„ã€‚</strong></p><p>æºç ä¸­å”¯ä¸€ å¸¦æœ‰æ˜¯å¦æ ¸å¿ƒçš„å˜é‡ å°±æ˜¯ ä¸‹é¢è¿™ä¸ª coreã€‚ä½†æ˜¯å®ƒçš„ä½œç”¨ï¼Œç”¨äºæ£€æŸ¥ çº¿ç¨‹æ•°æ˜¯å¦è¶…å‡ºé™åˆ¶ã€‚</p><p>å› ä¸ºçº¿ç¨‹æ± æœ‰ä¸¤ä¸ªæ‰©å®¹Workçš„æ—¶æœºï¼šä¸€ä¸ªæ˜¯åˆå§‹æ—¶æ ¸å¿ƒçº¿ç¨‹çš„æ‰©å®¹ï¼Œä¸€ä¸ªæ˜¯éæ ¸å¿ƒçº¿ç¨‹çš„æ‰©å®¹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">addWorker</span><span class="params">(Runnable firstTask, <span class="type">boolean</span> core)</span></span><br></pre></td></tr></table></figure><p>å½“æ ¸å¿ƒçº¿ç¨‹æ‰©å®¹æ—¶ï¼Œç”¨çš„æ˜¯ corePoolSizeï¼›éæ ¸å¿ƒçº¿ç¨‹æ‰©å®¹æ—¶ï¼Œç”¨çš„æ˜¯maximumPoolSizeã€‚</p><p>ä½†æ˜¯åœ¨Workè¿è¡Œåï¼Œå…¶å†…éƒ¨ä»é˜Ÿåˆ—ä¸­å–ä»»åŠ¡æˆ–è€…é”€æ¯æ—¶ï¼Œå¹¶ä¸çŸ¥é“è‡ªå·±å½“åˆæ·»åŠ çš„æ—¶å€™æ˜¯ å½“ä½œæ ¸å¿ƒçº¿ç¨‹æ¥æ‰©å®¹çš„è¿˜æ˜¯éæ ¸å¿ƒçº¿ç¨‹æ‰©å®¹çš„ã€‚</p><p>æˆ‘ä»¬å¯ä»¥çœ‹æºç ä¸­ï¼Œfinal void runWorker(Worker w) ä¸­ï¼š</p><p>æœ‰ä¸€ä¸ªforå¾ªç¯ã€‚å¦‚æœtaskä¸ºç©ºï¼Œå¹¶ä¸”ä»é˜Ÿåˆ—ä¸­å–ä¸åˆ°ä»»åŠ¡ï¼Œåˆ™ç»“æŸforå¾ªç¯ï¼Œè¿›å…¥åˆ° è´Ÿè´£æ¸…ç† Workerå’Œç®¡ç†çº¿ç¨‹çŠ¶æ€çš„processWorkerExitæ–¹æ³•é‡Œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">runWorker</span><span class="params">(Worker w)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">wt</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">Runnable</span> <span class="variable">task</span> <span class="operator">=</span> w.firstTask;</span><br><span class="line">    w.firstTask = <span class="literal">null</span>;</span><br><span class="line">    w.unlock(); <span class="comment">// allow interrupts</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">completedAbruptly</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (task != <span class="literal">null</span> || (task = getTask()) != <span class="literal">null</span>) &#123;</span><br><span class="line">            w.lock();</span><br><span class="line">            <span class="comment">// If pool is stopping, ensure thread is interrupted;</span></span><br><span class="line">            <span class="comment">// if not, ensure thread is not interrupted.  This</span></span><br><span class="line">            <span class="comment">// requires a recheck in second case to deal with</span></span><br><span class="line">            <span class="comment">// shutdownNow race while clearing interrupt</span></span><br><span class="line">            <span class="keyword">if</span> ((runStateAtLeast(ctl.get(), STOP) ||</span><br><span class="line">                 (Thread.interrupted() &amp;&amp;</span><br><span class="line">                  runStateAtLeast(ctl.get(), STOP))) &amp;&amp;</span><br><span class="line">                !wt.isInterrupted())</span><br><span class="line">                wt.interrupt();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                beforeExecute(wt, task);</span><br><span class="line">                <span class="type">Throwable</span> <span class="variable">thrown</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    task.run();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RuntimeException x) &#123;</span><br><span class="line">                    thrown = x; <span class="keyword">throw</span> x;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Error x) &#123;</span><br><span class="line">                    thrown = x; <span class="keyword">throw</span> x;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable x) &#123;</span><br><span class="line">                    thrown = x; <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(x);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    afterExecute(task, thrown);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                task = <span class="literal">null</span>;</span><br><span class="line">                w.completedTasks++;</span><br><span class="line">                w.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        completedAbruptly = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        processWorkerExit(w, completedAbruptly);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç®€å•çš„è¯´ï¼šæ¯ä¸ªWorkå¯¹è±¡ å®ƒæ˜¯ä¸çŸ¥é“è‡ªå·±çš„èº«ä»½çš„ï¼Œæ— è®ºæ˜¯ä»–è·å–é˜Ÿåˆ—ä¸­ä»»åŠ¡ï¼Œè¿˜æ˜¯é”€æ¯çš„åˆ¤æ–­æ¡ä»¶ã€‚éƒ½ä¸ä¾èµ–äºå®ƒåˆ›å»ºæ˜¯å½“ä½œæ ¸å¿ƒçº¿ç¨‹åˆ›å»ºçš„ï¼Œè¿˜æ˜¯éæ ¸å¿ƒçº¿ç¨‹ã€‚<strong>æ‰€ä»¥è¯´ä»–ä»¬çš„è¡Œä¸ºæ˜¯æ²¡æœ‰åŒºåˆ«çš„ã€‚</strong></p><p>åˆ¤æ–­ä¸€ä¸ªworkæ˜¯å¦ä¼šå› ä¸ºè¶…æ—¶é”€æ¯ï¼Œåªçœ‹ <strong>allowCoreThreadTimeOut</strong>ï¼ˆæ˜¯å¦å…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶é”€æ¯ï¼‰ å’Œ <strong>wc &gt; corePoolSize</strong> ï¼ˆå½“å‰çº¿ç¨‹æ˜¯å¦è¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æ•°ï¼‰ã€‚åªè¦ä¸¤ä¸ªæ»¡è¶³å…¶ä¸€ï¼Œå°±å¯èƒ½å› ä¸ºè¶…æ—¶é”€æ¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="variable">timed</span> <span class="operator">=</span> allowCoreThreadTimeOut || wc &gt; corePoolSize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut))</span><br><span class="line">    &amp;&amp; (wc &gt; <span class="number">1</span> || workQueue.isEmpty())) &#123;</span><br><span class="line">    <span class="keyword">if</span> (compareAndDecrementWorkerCount(c))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Rediså­¦ä¹ ç¬”è®°</title>
      <link href="/2025/06/07/Redis%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
      <url>/2025/06/07/Redis%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<h1 id="Rediså­¦ä¹ ç¬”è®°"><a href="#Rediså­¦ä¹ ç¬”è®°" class="headerlink" title="Rediså­¦ä¹ ç¬”è®°"></a>Rediså­¦ä¹ ç¬”è®°</h1><p> Redisè¯ç”Ÿäº2009å¹´ï¼Œä½œä¸ºä¸€ä¸ªåŸºäºå†…å­˜çš„é”®å€¼å‹NoSQLæ•°æ®åº“ã€‚å…¶æœ‰å¦‚ä¸‹ç‰¹ç‚¹</p><ul><li>é”®å€¼ï¼ˆkey-valueï¼‰å‹ï¼Œvalueæ”¯æŒå¤šç§ä¸åŒæ•°æ®ç»“æ„ï¼Œ</li><li>å•çº¿ç¨‹ï¼Œæ¯ä¸ªå‘½ä»¤å…·æœ‰åŸå­æ€§ã€‚ä¸å­˜åœ¨å¾ˆå¤šå¹¶å‘å¸¦æ¥çš„é—®é¢˜ã€‚ä½†æ˜¯æ­¤å•çº¿ç¨‹åªæ˜¯æŒ‡ä»£å‘½ä»¤æ˜¯ä½†çº¿ç¨‹æ‰§è¡Œçš„ï¼Œå…¶ä»–æ¨¡å—è¿˜æœ‰å„è‡ªçš„çº¿ç¨‹ã€‚6.0ç‰ˆæœ¬ä¸­å¼•å…¥äº†å¤šçº¿ç¨‹ï¼Œä½†æŒ‡ä»£çš„æ˜¯ IOå¤šçº¿ç¨‹ï¼Œå¦‚ï¼šç½‘ç»œæ•°æ®çš„è¯»å†™å’Œåè®®è§£ææ—¶å¤šçº¿ç¨‹ã€‚</li><li>ä½å»¶è¿Ÿã€é€Ÿåº¦å¿«ï¼ˆåŸºäºå†…å­˜ã€IOå¤šè·¯å¤ç”¨ã€è‰¯å¥½çš„ç¼–ç ï¼‰</li><li>æ”¯æŒæ•°æ®æŒä¹…åŒ–</li><li>æ”¯æŒä¸»ä»é›†ç¾¤ã€åˆ†ç‰‡é›†ç¾¤</li><li>æ”¯æŒå¤šè¯­è¨€å®¢æˆ·ç«¯</li></ul><h2 id="ä¸€ã€Redis-çš„å®‰è£…"><a href="#ä¸€ã€Redis-çš„å®‰è£…" class="headerlink" title="ä¸€ã€Redis çš„å®‰è£…"></a>ä¸€ã€Redis çš„å®‰è£…</h2><h3 id="1-1-Redis-å®‰è£…ï¼ˆwindowï¼‰"><a href="#1-1-Redis-å®‰è£…ï¼ˆwindowï¼‰" class="headerlink" title="1.1 Redis å®‰è£…ï¼ˆwindowï¼‰"></a>1.1 Redis å®‰è£…ï¼ˆwindowï¼‰</h3><p>ä¸‹æ–¹æä¾› Redis å„ä¸ªç‰ˆæœ¬çš„ä¸‹è½½é¡µé¢ï¼Œæˆ‘è¿™é‡Œä¸‹è½½çš„æ˜¯ 3.2.100 ç‰ˆæœ¬ã€‚</p><p><a href="https://github.com/microsoftarchive/redis/releases">https://github.com/microsoftarchive/redis/releases</a></p><p>å°†ä¸‹è½½åŒ… è§£å‹åˆ°æœ¬åœ°ç›®å½•ï¼Œç„¶ååœ¨ redisç›®å½•ä¸‹è¿›è¡Œ cmd ï¼Œè¾“å…¥ä¸åŒçš„å‘½ä»¤è¿›è¡Œä¸åŒçš„å®‰è£…æ–¹å¼ï¼š</p><ul><li><p>ä¸´æ—¶æœåŠ¡å®‰è£…å¦‚æœä½ ä»…ä»…æ˜¯ç”¨ä½œå­¦ä¹ ä½¿ç”¨ï¼Œå¯ä»¥é€‰æ‹©æ­¤å®‰è£…æ–¹å¼ã€‚åœ¨ redisç›®å½•ä¸‹ ä½¿ç”¨cmd æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼šredis-server.exe  redis.windows.confè¯¥å‘½ä»¤ä¼šåˆ›å»º Redis ä¸´æ—¶æœåŠ¡ï¼Œç”Ÿæˆçš„ä¿¡æ¯è¡¨æ˜äº† redis åœ¨æœ¬æœºçš„ 6379 ç«¯å£æä¾›æœåŠ¡ã€‚è¯¥ç§æ–¹å¼ï¼Œä¸èƒ½å…³é—­æ­¤ cmd çª—å£ï¼Œå¦‚æœå…³é—­åˆ™ä¼šåœæ­¢ Redis æœåŠ¡ã€‚<img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779113128-ac60fad7-e10e-436c-af9d-67273d4e024e.png" alt="img">ä¿æŒ Redis æœåŠ¡çª—å£å¼€å¯çŠ¶æ€ï¼ŒåŒå‡» redisç›®å½•ä¸‹çš„ redis-cli.exe å³å¯ä½¿ç”¨ å‘½ä»¤è¡Œæ“æ§ redis ã€‚æ¯”å¦‚è¿™é‡Œ ä½¿ç”¨ set å‘½ä»¤ï¼Œå­˜å‚¨äº†ä¸€ä¸ªé”®å€¼å¯¹ uidï¼š1ï¼Œç„¶åé€šè¿‡ get å°†é”® uid å¯¹åº”çš„å€¼å–å‡ºã€‚<img src="https://cdn.nlark.com/yuque/0/2023/png/35838370/1682779113107-4136bd49-5e0e-45b0-b024-f5ac7d019f96.png" alt="img"></p></li><li><p>é»˜è®¤æœåŠ¡å®‰è£…è¿™ç§æ–¹å¼ä¸ç”¨åƒä¸´æ—¶å®‰è£…æ–¹å¼ä¸€æ ·ï¼Œæ¯æ¬¡å»æ‰“å¼€ redis ä¸´æ—¶æœåŠ¡ï¼Œè€Œä¸”åƒæ­£å¸¸æœåŠ¡ä¸€æ ·å¼€æœºè‡ªå¯ã€‚è¿›å…¥ Redis ç›®å½•ä¸‹ï¼Œé€šè¿‡cmdè¾“å…¥redis-server.exe â€“service-install redis.windows.conf â€“loglevel verbose<img src="https://cdn.nlark.com/yuque/0/2023/png/35838370/1682779113047-a2d84234-558c-4ca4-ae91-0564d9534dca.png" alt="img">é€šè¿‡å‘½ä»¤è¡Œå¯ä»¥å‘ç°ï¼Œæˆ‘ä»¬å·²ç»å°†redisä½œä¸ºæœåŠ¡å®‰è£…å¥½äº†ã€‚ä½†æ˜¯ä½ å¯èƒ½ä¸èƒ½åœ¨windowçš„æœåŠ¡åˆ—è¡¨ä¸­æ‰¾åˆ°ï¼ŒredisæœåŠ¡å¿…é¡»é€šè¿‡å‘½ä»¤è¡Œå¯åŠ¨ã€æš‚åœå’Œå¸è½½</p></li><li><ul><li>å¯åŠ¨æœåŠ¡ï¼šredis-server.exe â€“service-start</li><li>æš‚åœæœåŠ¡redis-server.exe â€“service-stop</li><li>å¸è½½æœåŠ¡redis-server.exe â€“service-uninstall</li></ul></li><li><p>è‡ªå®šä¹‰æœåŠ¡å®‰è£…è‡ªå®šä¹‰æœåŠ¡å®‰è£…ï¼Œå°±æ˜¯å°†æœåŠ¡é‡å‘½åã€‚è¿›å…¥ Redis å®‰è£…åŒ…ä¸‹ï¼Œè¾“å…¥redis-server.exe â€“service-install redis.windows.conf â€“Service-name RedisServer1 â€“loglevel verboseè¿™é‡Œèµ·çš„åå­—æ˜¯ RedisServer1 ã€‚ä¸é»˜è®¤å®‰è£…ä¸€æ ·ï¼Œä¸åŒçš„æ˜¯åœ¨å¯åŠ¨ã€æš‚åœã€å¸è½½æœåŠ¡æ—¶ éœ€è¦åŠ ä¸Šè‡ªå®šä¹‰çš„ Redis æœåŠ¡åredis-server.exe â€“service-start â€“Service-name RedisServer1redis-server.exe â€“service-stop â€“Service-name RedisServer1redis-server.exe â€“service-uninstall â€“Service-name RedisServer1</p></li><li><p>ä¸»ä»æœåŠ¡å®‰è£…å³åƒä¸€èˆ¬çš„æ•°æ®åº“çš„ä¸»ä»åº“ä¸€æ ·ï¼Œredisä¹Ÿå¯ä»¥é…ç½®ä¸»ä»åº“ã€‚é…ç½®çš„æ–¹æ³•å¾ˆç®€å•ï¼Œå°±æ˜¯é€šè¿‡<strong>è‡ªå®šä¹‰æœåŠ¡å™¨å®‰è£…</strong>æ–¹å¼å®‰è£…ä¸¤ä¸ªæœåŠ¡ã€‚<img src="https://cdn.nlark.com/yuque/0/2023/png/35838370/1682779111633-3351c423-c9db-4128-a4d6-3561b5e963a8.png" alt="img">ä¿®æ”¹ä¸¤ä¸ªæœåŠ¡é‡Œ redis.windows.conf æ–‡ä»¶ï¼šä¸»æœåŠ¡å™¨ï¼ˆRedisServer1ï¼‰ï¼šä¿æŒå…¶ port 6379ä»æœåŠ¡å™¨ï¼ˆRedisServer2ï¼‰ï¼šä¿®æ”¹</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">port 6380</span><br><span class="line"> slaveof 127.0.0.1 6379</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹é…ç½®æ–‡ä»¶åï¼Œä¾æ¬¡å¯åŠ¨æœåŠ¡ã€‚ç„¶åå¯ä»¥åœ¨ åŒå‡»ä¸»æœåŠ¡æ–‡ä»¶å¤¹ä¸‹çš„ redis-cliï¼Œå»æ‰§è¡Œä¸€ä¸ªæ·»åŠ é”®å€¼æ“ä½œã€‚åŒå‡»æ‰§è¡Œ ä»æœåŠ¡å™¨æ–‡ä»¶å¤¹ä¸‹çš„ redis-cliï¼Œå»å–å‡ºé”®name å¯¹åº”çš„å€¼ï¼Œä½ å°±å‘ç°å¯ä»¥å–åˆ°ã€‚åœ¨ Window ä¸Š ç›´æ¥åˆ é™¤æœåŠ¡çš„æ–¹æ³•ï¼šä½¿ç”¨ç®¡ç†å‘˜æƒé™ æ‰“å¼€ cmd ï¼Œç„¶åè¾“å…¥sc delete æœåŠ¡å</p><h3 id="1-2-Redis-å®‰è£…ï¼ˆdockerï¼‰"><a href="#1-2-Redis-å®‰è£…ï¼ˆdockerï¼‰" class="headerlink" title="1.2 Redis å®‰è£…ï¼ˆdockerï¼‰"></a>1.2 Redis å®‰è£…ï¼ˆdockerï¼‰</h3><ul><li>ä¸‹æ‹‰æœ€æ–°çš„ redis é•œåƒï¼Œå¹¶æ£€æŸ¥æ˜¯å¦ä¸‹æ‹‰æˆåŠŸ</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull redis:latest</span><br><span class="line">docker images</span><br></pre></td></tr></table></figure><ul><li>è¿è¡Œå®¹å™¨ï¼Œå¹¶æ˜ å°„åˆ°å®¿ä¸»æœºç«¯å£docker run -it -d â€“name redis-test -p 6379:6379 redis</li><li>æŸ¥çœ‹æ˜¯å¦è¿è¡ŒæˆåŠŸï¼ˆæŸ¥çœ‹å®¹å™¨è¿è¡Œä¿¡æ¯ï¼‰docker ps</li><li>é€šè¿‡ redis-cli è¿æ¥ä½¿ç”¨ redis æœåŠ¡</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it redis-test /bin/bash</span><br><span class="line">redis-cli</span><br></pre></td></tr></table></figure><h3 id="1-3-Redis-é…ç½®"><a href="#1-3-Redis-é…ç½®" class="headerlink" title="1.3 Redis é…ç½®"></a>1.3 Redis é…ç½®</h3><p>redis.config å¸¸è§é…ç½®ï¼š</p><ul><li>bind 0.0.0.0 ç›‘å¬çš„åœ°å€é»˜è®¤æ˜¯127.0.0.1ï¼Œè¿™ä½¿å¾—åªèƒ½æœ¬åœ°è®¿é—®ã€‚å¦‚æœä¿®æ”¹æˆ 0.0.0.0 åˆ™å¯ä»¥åœ¨ä»»æ„ IP åœ°å€è®¿é—®ã€‚</li><li>daemonize yeså®ˆæŠ¤è¿›ç¨‹ï¼Œä¿®æ”¹ä¸º yes ä¹‹åï¼Œå³å¯åå°è¿è¡Œ</li><li>requirepass 111111å¯†ç ï¼Œè®¾ç½®åè®¿é—® Redis å¿…é¡»è¾“å…¥å¯†ç </li><li>port 6379ç›‘å¬çš„ç«¯å£ï¼Œé»˜è®¤å°±æ˜¯ 6379</li><li>dir .å·¥ä½œç›®å½•ï¼Œé»˜è®¤æ˜¯å½“å‰ç›®å½•ï¼Œä¹Ÿå°±æ˜¯è¿è¡Œ redis-server æ—¶çš„å‘½ä»¤ï¼Œæ—¥å¿—ã€æŒä¹…åŒ–ç­‰æ–‡ä»¶éƒ½ä¼šä¿å­˜åœ¨è¿™ä¸ªç›®å½•</li><li>databases 1æ•°æ®åº“æ•°é‡ï¼Œè®¾ç½®ä¸º1ï¼Œä»£è¡¨åªä½¿ç”¨1ä¸ªåº“ï¼Œé»˜è®¤æœ‰16ä¸ªåº“ï¼Œç¼–å· 0-15</li><li>maxmemory 512mbè®¾ç½® redis èƒ½å¤Ÿä½¿ç”¨çš„æœ€å¤§å†…å­˜</li><li>logfile â€œredis.logâ€æ—¥å¿—æ–‡ä»¶ï¼Œé»˜è®¤ä¸ºç©ºï¼Œä¸è®°å½•æ—¥å¿—ï¼Œå¯ä»¥æŒ‡å®šæ—¥å¿—æ–‡ä»¶åã€‚</li></ul><p>å¯åŠ¨æ—¶ï¼ŒæŒ‡å®šé…ç½®æ–‡ä»¶ </p><p>redis-server redis.conf</p><h2 id="äºŒã€Redis-çš„åŸºç¡€ç¯‡"><a href="#äºŒã€Redis-çš„åŸºç¡€ç¯‡" class="headerlink" title="äºŒã€Redis çš„åŸºç¡€ç¯‡"></a>äºŒã€Redis çš„åŸºç¡€ç¯‡</h2><h4 id="2-1-äº”ç§åŸºæœ¬æ•°æ®ç»“æ„"><a href="#2-1-äº”ç§åŸºæœ¬æ•°æ®ç»“æ„" class="headerlink" title="2.1 äº”ç§åŸºæœ¬æ•°æ®ç»“æ„"></a>2.1 äº”ç§åŸºæœ¬æ•°æ®ç»“æ„</h4><p>Redis å…±æœ‰ 5 ç§åŸºæœ¬æ•°æ®ç»“æ„ï¼šStringï¼ˆå­—ç¬¦ä¸²ï¼‰ã€Listï¼ˆåˆ—è¡¨ï¼‰ã€Setï¼ˆé›†åˆï¼‰ã€Hashï¼ˆæ•£åˆ—ï¼‰ã€Zsetï¼ˆæœ‰åºé›†åˆï¼‰ã€‚</p><p>è¿™ 5 ç§æ•°æ®ç»“æ„æ˜¯ç›´æ¥æä¾›ç»™ç”¨æˆ·ä½¿ç”¨çš„ï¼Œæ˜¯æ•°æ®çš„ä¿å­˜å½¢å¼ï¼Œå…¶åº•å±‚å®ç°ä¸»è¦ä¾èµ–è¿™ 8 ç§æ•°æ®ç»“æ„ï¼šç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰ã€LinkedListï¼ˆåŒå‘é“¾è¡¨ï¼‰ã€Hash Tableï¼ˆå“ˆå¸Œè¡¨ï¼‰ã€SkipListï¼ˆè·³è·ƒè¡¨ï¼‰ã€Intsetï¼ˆæ•´æ•°é›†åˆï¼‰ã€ZipListï¼ˆå‹ç¼©åˆ—è¡¨ï¼‰ã€QuickListï¼ˆå¿«é€Ÿåˆ—è¡¨ï¼‰ã€‚</p><p>Redis åŸºæœ¬æ•°æ®ç»“æ„çš„åº•å±‚æ•°æ®ç»“æ„å®ç°å¦‚ä¸‹ï¼š</p><table><thead><tr><th>String</th><th>List</th><th>Hash</th><th>Set</th><th>Zset</th></tr></thead><tbody><tr><td>SDS</td><td>LinkedList&#x2F;ZipList&#x2F;QuickList</td><td>Hash Tableã€ZipList</td><td>ZipListã€Intset</td><td>ZipListã€SkipList</td></tr></tbody></table><p>Redis 3.2 ä¹‹å‰ï¼ŒList åº•å±‚å®ç°æ˜¯ LinkedList æˆ–è€… ZipListã€‚ Redis 3.2 ä¹‹åï¼Œå¼•å…¥äº† LinkedList å’Œ ZipList çš„ç»“åˆ QuickListï¼ŒList çš„åº•å±‚å®ç°å˜ä¸º QuickListã€‚</p><p>ä½ å¯ä»¥åœ¨ Redis å®˜ç½‘ä¸Šæ‰¾åˆ° Redis æ•°æ®ç»“æ„éå¸¸è¯¦ç»†çš„ä»‹ç»ï¼š</p><ul><li><a href="https://redis.com/redis-enterprise/data-structures/">Redis Data Structuresopen in new window</a></li><li><a href="https://redis.io/docs/manual/data-types/data-types-tutorial/">Redis Data types tutorialopen in new window</a></li></ul><p>æœªæ¥éšç€ Redis æ–°ç‰ˆæœ¬çš„å‘å¸ƒï¼Œå¯èƒ½ä¼šæœ‰æ–°çš„æ•°æ®ç»“æ„å‡ºç°ï¼Œé€šè¿‡æŸ¥é˜… Redis å®˜ç½‘å¯¹åº”çš„ä»‹ç»ï¼Œä½ æ€»èƒ½è·å–åˆ°æœ€é è°±çš„ä¿¡æ¯ã€‚</p><h5 id="2-1-1-String"><a href="#2-1-1-String" class="headerlink" title="2.1.1 String"></a>2.1.1 String</h5><p>String æ˜¯ Redis ä¸­æœ€ç®€å•åŒæ—¶ä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„ä¸€ä¸ªæ•°æ®ç»“æ„ã€‚</p><p>String æ˜¯ä¸€ç§äºŒè¿›åˆ¶å®‰å…¨çš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥ç”¨æ¥å­˜å‚¨ä»»ä½•ç±»å‹çš„æ•°æ®æ¯”å¦‚å­—ç¬¦ä¸²ã€æ•´æ•°ã€æµ®ç‚¹æ•°ã€å›¾ç‰‡ï¼ˆå›¾ç‰‡çš„ base64 ç¼–ç æˆ–è€…è§£ç æˆ–è€…å›¾ç‰‡çš„è·¯å¾„ï¼‰ã€åºåˆ—åŒ–åçš„å¯¹è±¡ã€‚</p><p> è™½ç„¶ Redis æ˜¯ç”¨ C è¯­è¨€å†™çš„ï¼Œä½†æ˜¯ Redis å¹¶æ²¡æœ‰ä½¿ç”¨ C çš„å­—ç¬¦ä¸²è¡¨ç¤ºï¼Œè€Œæ˜¯è‡ªå·±æ„å»ºäº†ä¸€ç§ <strong>ç®€å•åŠ¨æ€å­—ç¬¦ä¸²</strong>ï¼ˆSimple Dynamic Stringï¼Œ<strong>SDS</strong>ï¼‰ã€‚ç›¸æ¯”äº C çš„åŸç”Ÿå­—ç¬¦ä¸²ï¼ŒRedis çš„ SDS ä¸å…‰å¯ä»¥ä¿å­˜æ–‡æœ¬æ•°æ®è¿˜å¯ä»¥ä¿å­˜äºŒè¿›åˆ¶æ•°æ®ï¼Œå¹¶ä¸”è·å–å­—ç¬¦ä¸²é•¿åº¦å¤æ‚åº¦ä¸º O(1)ï¼ˆC å­—ç¬¦ä¸²ä¸º O(N)ï¼‰,é™¤æ­¤ä¹‹å¤–ï¼ŒRedis çš„ SDS API æ˜¯å®‰å…¨çš„ï¼Œä¸ä¼šé€ æˆç¼“å†²åŒºæº¢å‡ºã€‚</p><h5 id="2-1-2-List"><a href="#2-1-2-List" class="headerlink" title="2.1.2 List"></a>2.1.2 List</h5><p> è®¸å¤šé«˜çº§ç¼–ç¨‹è¯­è¨€éƒ½å†…ç½®äº†é“¾è¡¨çš„å®ç°æ¯”å¦‚ Java ä¸­çš„ LinkedListï¼Œä½†æ˜¯ C è¯­è¨€å¹¶æ²¡æœ‰å®ç°é“¾è¡¨ï¼Œæ‰€ä»¥ Redis å®ç°äº†è‡ªå·±çš„é“¾è¡¨æ•°æ®ç»“æ„ã€‚Redis çš„ List çš„å®ç°ä¸ºä¸€ä¸ª <strong>åŒå‘é“¾è¡¨</strong>ï¼Œå³å¯ä»¥æ”¯æŒåå‘æŸ¥æ‰¾å’Œéå†ï¼Œæ›´æ–¹ä¾¿æ“ä½œï¼Œä¸è¿‡å¸¦æ¥äº†éƒ¨åˆ†é¢å¤–çš„å†…å­˜å¼€é”€ã€‚</p><h5 id="2-1-3-Hash"><a href="#2-1-3-Hash" class="headerlink" title="2.1.3 Hash"></a>2.1.3 Hash</h5><p>Redis ä¸­çš„ Hash æ˜¯ä¸€ä¸ª String ç±»å‹çš„ field-valueï¼ˆé”®å€¼å¯¹ï¼‰ çš„æ˜ å°„è¡¨ï¼Œç‰¹åˆ«é€‚åˆç”¨äºå­˜å‚¨å¯¹è±¡ï¼Œåç»­æ“ä½œçš„æ—¶å€™ï¼Œä½ å¯ä»¥ç›´æ¥ä¿®æ”¹è¿™ä¸ªå¯¹è±¡ä¸­çš„æŸäº›å­—æ®µçš„å€¼ã€‚</p><p>Hash ç±»ä¼¼äº JDK1.8 å‰çš„ HashMapï¼Œå†…éƒ¨å®ç°ä¹Ÿå·®ä¸å¤š(æ•°ç»„ + é“¾è¡¨)ã€‚ä¸è¿‡ï¼ŒRedis çš„ Hash åšäº†æ›´å¤šä¼˜åŒ–ã€‚</p><h5 id="2-1-4-Set"><a href="#2-1-4-Set" class="headerlink" title="2.1.4 Set"></a>2.1.4 Set</h5><p>Redis ä¸­çš„ Set ç±»å‹æ˜¯ä¸€ç§æ— åºé›†åˆï¼Œé›†åˆä¸­çš„å…ƒç´ æ²¡æœ‰å…ˆåé¡ºåºä½†éƒ½å”¯ä¸€ï¼Œæœ‰ç‚¹ç±»ä¼¼äº Java ä¸­çš„ HashSet ã€‚å½“ä½ éœ€è¦å­˜å‚¨ä¸€ä¸ªåˆ—è¡¨æ•°æ®ï¼Œåˆä¸å¸Œæœ›å‡ºç°é‡å¤æ•°æ®æ—¶ï¼ŒSet æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ï¼Œå¹¶ä¸” Set æä¾›äº†åˆ¤æ–­æŸä¸ªå…ƒç´ æ˜¯å¦åœ¨ä¸€ä¸ª Set é›†åˆå†…çš„é‡è¦æ¥å£ï¼Œè¿™ä¸ªä¹Ÿæ˜¯ List æ‰€ä¸èƒ½æä¾›çš„ã€‚</p><p>ä½ å¯ä»¥åŸºäº Set è½»æ˜“å®ç°äº¤é›†ã€å¹¶é›†ã€å·®é›†çš„æ“ä½œï¼Œæ¯”å¦‚ä½ å¯ä»¥å°†ä¸€ä¸ªç”¨æˆ·æ‰€æœ‰çš„å…³æ³¨äººå­˜åœ¨ä¸€ä¸ªé›†åˆä¸­ï¼Œå°†å…¶æ‰€æœ‰ç²‰ä¸å­˜åœ¨ä¸€ä¸ªé›†åˆã€‚è¿™æ ·çš„è¯ï¼ŒSet å¯ä»¥éå¸¸æ–¹ä¾¿çš„å®ç°å¦‚å…±åŒå…³æ³¨ã€å…±åŒç²‰ä¸ã€å…±åŒå–œå¥½ç­‰åŠŸèƒ½ã€‚è¿™ä¸ªè¿‡ç¨‹ä¹Ÿå°±æ˜¯æ±‚äº¤é›†çš„è¿‡ç¨‹ã€‚</p><h4 id="2-1-5-SortSet"><a href="#2-1-5-SortSet" class="headerlink" title="2.1.5 SortSet"></a>2.1.5 SortSet</h4><p>Sorted Set ç±»ä¼¼äº Setï¼Œä½†å’Œ Set ç›¸æ¯”ï¼ŒSorted Set å¢åŠ äº†ä¸€ä¸ªæƒé‡å‚æ•° scoreï¼Œä½¿å¾—é›†åˆä¸­çš„å…ƒç´ èƒ½å¤ŸæŒ‰ score è¿›è¡Œæœ‰åºæ’åˆ—ï¼Œè¿˜å¯ä»¥é€šè¿‡ score çš„èŒƒå›´æ¥è·å–å…ƒç´ çš„åˆ—è¡¨ã€‚æœ‰ç‚¹åƒæ˜¯ Java ä¸­ HashMap å’Œ TreeSet çš„ç»“åˆä½“ã€‚</p><h4 id="2-2-ä¸‰ç§ç‰¹æ®Šæ•°æ®ç»“æ„"><a href="#2-2-ä¸‰ç§ç‰¹æ®Šæ•°æ®ç»“æ„" class="headerlink" title="2.2 ä¸‰ç§ç‰¹æ®Šæ•°æ®ç»“æ„"></a>2.2 ä¸‰ç§ç‰¹æ®Šæ•°æ®ç»“æ„</h4><h4 id="2-3-Rediså‘½ä»¤"><a href="#2-3-Rediså‘½ä»¤" class="headerlink" title="2.3 Rediså‘½ä»¤"></a>2.3 Rediså‘½ä»¤</h4><h5 id="2-1-1-é€šç”¨å‘½ä»¤"><a href="#2-1-1-é€šç”¨å‘½ä»¤" class="headerlink" title="2.1.1 é€šç”¨å‘½ä»¤"></a>2.1.1 é€šç”¨å‘½ä»¤</h5><p>Redisé€šç”¨æŒ‡ä»¤æ˜¯ä¸åˆ†æ•°æ®ç±»å‹çš„ï¼Œéƒ½å¯ä»¥ä½¿ç”¨çš„æŒ‡ä»¤ï¼Œå¸¸è§çš„æœ‰ï¼š</p><ul><li>KEYSï¼šæŸ¥çœ‹ç¬¦åˆæ¨¡æ¿çš„æ‰€æœ‰ keyï¼Œä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒè®¾å¤‡ä¸Šä½¿ç”¨</li><li>DELï¼šåˆ é™¤ä¸€ä¸ªæŒ‡å®šçš„ key</li><li>EXISTSï¼šåˆ¤æ–­ key æ˜¯å¦å­˜åœ¨</li><li>EXPIREï¼šç»™ä¸€ä¸ª key è®¾ç½®æœ‰æ•ˆæœŸï¼Œæœ‰æ•ˆæœŸåˆ°æœŸæ—¶è¯¥ key è‡ªåŠ¨åˆ é™¤ã€‚å¯ é€šè¿‡ TTL KeyNameï¼ŒæŸ¥çœ‹ key çš„å‰©ä½™æœ‰æ•ˆæœŸ</li></ul><p>é€šè¿‡ help [command] å¯ä»¥æŸ¥çœ‹ä¸€ä¸ªå‘½ä»¤çš„å…·ä½“ç”¨æ³•ã€</p><p>ä½¿ç”¨ redis.cli.exe æ‰“å¼€ redisçš„å‘½ä»¤è¡Œï¼Œå®æ“ï¼š</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/35838370/1682779112046-b5cf96d3-7890-4471-a0ce-0c02c4c4d789.png" alt="img"></p><h5 id="2-1-2-Stringç±»å‹"><a href="#2-1-2-Stringç±»å‹" class="headerlink" title="2.1.2 Stringç±»å‹"></a>2.1.2 Stringç±»å‹</h5><p>String ç±»å‹ï¼Œä¹Ÿå°±æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œæ˜¯ Redis ä¸­æœ€ç®€å•çš„å­˜å‚¨ç±»å‹ã€‚å…¶ value æ˜¯å­—ç¬¦ä¸²ï¼Œä¸è¿‡æ ¹æ®å­—ç¬¦ä¸²çš„æ ¼å¼ä¸åŒï¼Œåˆå¯ä»¥åˆ†ä¸º3ç±»:</p><ul><li>Stringï¼šæ™®é€šå­—ç¬¦ä¸²</li><li>intï¼šæ•´æ•°ç±»å‹ï¼Œå¯ä»¥åšè‡ªå¢ã€è‡ªå‡æ“ä½œ</li><li>floatï¼šæµ®ç‚¹ç±»å‹ï¼Œå¯ä»¥åšè‡ªå¢ã€è‡ªå‡æ“ä½œï¼Œä½†æ˜¯å¿…é¡»æŒ‡å®š å¢å‡çš„ å€¼ã€‚</li></ul><p>ä¸ç®¡ä½•ç§æ ¼å¼ï¼Œåº•å±‚éƒ½æ˜¯å­—èŠ‚æ•°ç»„å½¢å¼å­˜å‚¨ï¼Œåªä¸è¿‡æ˜¯ç¼–ç æ–¹å¼ä¸åŒã€‚</p><p>Redisçš„å­—ç¬¦ä¸²æ˜¯åŠ¨æ€å­—ç¬¦ä¸²ï¼Œæ˜¯å¯ä»¥ä¿®æ”¹çš„å­—ç¬¦ä¸²ï¼Œå†…éƒ¨ç»“æ„å®ç°ç±»ä¼¼äºJavaçš„ArrayListï¼Œé¢„åˆ†é…å†—ä½™ç©ºé—´çš„æ–¹å¼æ¥å‡å°‘å†…å­˜çš„é¢‘ç¹åˆ†é…ã€‚å­—ç¬¦ä¸²é•¿åº¦å°äº1Mï¼Œæ‰©å®¹éƒ½æ˜¯åŠ å€ç°æœ‰ç©ºé—´ï¼Œå¦‚æœé•¿åº¦å¤§äº1Mï¼Œæ¯æ¬¡æ‰©å®¹å¢åŠ 1Mã€‚å­—ç¬¦ä¸²ç±»å‹çš„æœ€å¤§ç©ºé—´ä¸èƒ½è¶…è¿‡ 512M</p><p>Stringçš„å¸¸è§å‘½ä»¤æœ‰ï¼š</p><ul><li>SETï¼šæ·»åŠ æˆ–è€…ä¿®æ”¹ å·²ç»å­˜åœ¨çš„ä¸€ä¸ª String ç±»å‹çš„é”®å€¼å¯¹</li><li>GETï¼šæ ¹æ® key è·å– String ç±»å‹çš„ value</li><li>MSETï¼šæ‰¹é‡æ·»åŠ å¤šä¸ª String ç±»å‹çš„é”®å€¼å¯¹</li><li>MGETï¼šæ ¹æ®å¤šä¸ª key è·å–å¤šä¸ª String ç±»å‹çš„ value</li><li>INCRï¼šè®©ä¸€ä¸ªæ•´å‹çš„ key è‡ªå¢ 1 </li><li>INCRBYï¼šè®©ä¸€ä¸ªæ•´å‹çš„ key è‡ªå¢å¹¶æŒ‡å®šæ­¥é•¿ï¼Œä¾‹å¦‚ï¼šINCRBY num 2ï¼Œå³å¯è®© key &#x3D; num çš„å€¼ï¼Œè‡ªå¢2</li><li>SETNXï¼šæ·»åŠ ä¸€ä¸ª String ç±»å‹çš„é”®å€¼å¯¹ï¼Œå‰ææ˜¯ è¿™ä¸ª key ä¸å­˜åœ¨ï¼Œå¦åˆ™ä¸æ‰§è¡Œ</li><li>SETEXï¼šæ·»åŠ ä¸€ä¸ªString ç±»å‹çš„é”®å€¼å¯¹ï¼Œå¹¶æŒ‡å®šæœ‰æ•ˆæœŸ</li></ul><h5 id="2-1-3-Keyçš„å±‚çº§æ ¼å¼"><a href="#2-1-3-Keyçš„å±‚çº§æ ¼å¼" class="headerlink" title="2.1.3 Keyçš„å±‚çº§æ ¼å¼"></a>2.1.3 Keyçš„å±‚çº§æ ¼å¼</h5><p>Redisæ²¡æœ‰ç±»ä¼¼ MySQL ä¸­çš„ Table çš„æ¦‚å¿µï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•åŒºåˆ†ä¸åŒç±»å‹çš„ key å‘¢ï¼Ÿä¸€èˆ¬é‡‡ç”¨å°† key åç§°è¿›è¡Œ åˆ†å±‚è®¾è®¡ã€‚ä¾‹å¦‚ï¼šå­¦ç”Ÿçš„keyï¼Œkey ä»¥ studen_ å¼€å¤´ã€‚</p><p>Redis çš„ key å…è®¸æœ‰å¤šä¸ªå•è¯ç»„æˆå±‚çº§ç»“æ„ï¼Œå¤šä¸ªå•è¯ä¹‹é—´ç”¨ â€œ:â€ éš”å¼€ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š</p><p>é¡¹ç›®å:ä¸šåŠ¡å:ç±»å‹:id</p><p>å½“ç„¶è¿™ç§æ ¼å¼æ˜¯å¯ä»¥è‡ªå·±å®šä¹‰çš„ï¼Œæœ‰äº›å…¬å¸æ˜¯ä½¿ç”¨ â€__â€œçº¿é—´éš”ã€‚</p><p>å¦‚æœå­˜å‚¨å¯¹è±¡æ˜¯ Javaå¯¹è±¡ï¼Œåˆ™å¯å°†å¯¹è±¡è½¬åŒ–ä¸º JSON å­—ç¬¦ä¸²å½“ä½œvalueå­˜å‚¨ä¸‹æ¥ã€‚</p><h5 id="2-1-4-Hashç±»å‹"><a href="#2-1-4-Hashç±»å‹" class="headerlink" title="2.1.4 Hashç±»å‹"></a>2.1.4 Hashç±»å‹</h5><p>Hashç±»å‹ï¼Œä¹Ÿå«æ•£åˆ—ï¼Œå…¶ä¸­valueæ˜¯ä¸€ä¸ªæ— åºå­—å…¸ï¼Œç±»å‹äº Java ä¸­çš„ HashMap ç»“æ„</p><p>String ç»“æ„æ˜¯å°†å¯¹è±¡åºåˆ—åŒ–ä¸º JSON å­—ç¬¦ä¸²å å­˜å‚¨ï¼Œå½“éœ€è¦ä¿®æ”¹å¯¹è±¡æŸä¸ªå­—æ®µæ—¶ å¾ˆä¸æ–¹ä¾¿ã€‚Hash ç»“æ„å¯ä»¥å°†å¯¹è±¡ä¸­çš„æ¯ä¸ªå­—æ®µç‹¬ç«‹å­˜å‚¨ï¼Œå¯ä»¥é’ˆå¯¹ å•ä¸ªå­—æ®µ CRUD</p><p>Hashç±»å‹å¸¸è§å‘½ä»¤æœ‰ï¼š</p><ul><li>HSET key field valueï¼šæ·»åŠ æˆ–è€…ä¿®æ”¹ hashç±»å‹ keyçš„field çš„å€¼</li><li>HGET key fieldï¼šè·å–ä¸€ä¸ª hash ç±»å‹ keyçš„fieldçš„å€¼</li><li>HMSETï¼šæ‰¹é‡æ·»åŠ  å¤šä¸ª hashç±»å‹ keyçš„field çš„å€¼HMSET student_1 name liming sex ç”·   &#x2F;&#x2F;ä¸ºkey&#x3D;student_1 çš„å­—æ®µ æ·»åŠ å±æ€§ nameã€sex å€¼åˆ†åˆ«ä¸º limingã€ç”·</li><li>HGETALLï¼šè·å–ä¸€ä¸ª hash ç±»å‹çš„keyä¸­æ‰€æœ‰çš„ fieldå’Œvalue</li><li>HKEYSï¼šè·å–ä¸€ä¸ª hash ç±»å‹çš„keyä¸­æ‰€æœ‰çš„ field</li><li>HVALSï¼šè·å–ä¸€ä¸ªhash ç±»å‹çš„keyä¸­æ‰€æœ‰çš„ value</li><li>HINCRBYï¼šè®©ä¸€ä¸ªhashç±»å‹ key çš„å­—æ®µå€¼è‡ªå¢ï¼Œå¹¶æŒ‡å®šæ­¥é•¿</li><li>HSETNXï¼šæ·»åŠ ä¸€ä¸ª hash ç±»å‹çš„ key çš„ fieldå€¼ï¼Œå‰ææ—¶ è¿™ä¸ª field ä¸å­˜åœ¨ï¼Œå¦åˆ™ä¸æ‰§è¡Œ</li></ul><p>åº•å±‚åŸç†ï¼š</p><p>Javaçš„HashMapåœ¨å­—å…¸å¾ˆå¤§æ—¶ï¼Œrehashæ˜¯ä¸ªè€—æ—¶æ“ä½œï¼Œéœ€è¦ä¸€æ¬¡æ€§å…¨éƒ¨rehashã€‚Redisä¸ºäº†é«˜æ€§èƒ½ï¼Œä¸èƒ½å µå¡æœåŠ¡ï¼Œå°±é‡‡ç”¨äº†æ¸è¿›å¼rehashç­–ç•¥</p><p>æ¸è¿›å¼rehashï¼šåœ¨rehashçš„åŒæ—¶ï¼Œä¿ç•™æ–°æ—§ä¸¤ä¸ªhashç»“æ„ï¼ŒæŸ¥è¯¢æ—¶ä¼šåŒæ—¶æŸ¥è¯¢ä¸¤ä¸ªhashç»“æ„ï¼Œç„¶åå†åç»­çš„å®šæ—¶ä»»åŠ¡ä¸­ä»¥åŠhashçš„å­æŒ‡ä»¤ä¸­ï¼Œå¾ªåºæ¸è¿›åœ°å°†æ—§hashçš„å†…å®¹ä¸€ç‚¹ç‚¹è¿ç§»åˆ°æ–°çš„hashç»“æ„ä¸­ã€‚</p><h5 id="2-1-4-Listç±»å‹"><a href="#2-1-4-Listç±»å‹" class="headerlink" title="2.1.4 Listç±»å‹"></a>2.1.4 Listç±»å‹</h5><p>Redisä¸­çš„ List ç±»å‹ä¸ Java ä¸­çš„LinkedList ç±»ä¼¼ï¼Œå¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ç»“æ„ã€‚æ—¢å¯ä»¥æ”¯æŒæ­£å‘æ£€ç´¢ï¼Œä¹Ÿæ”¯æŒåå‘æ£€ç´¢ã€‚ç‰¹ç‚¹ä¹Ÿå’ŒLinkedListç±»ä¼¼ï¼š</p><ul><li>æœ‰åº</li><li>å…ƒç´ å¯ä»¥é‡å¤</li><li>æ’å…¥å’Œåˆ é™¤å¿«</li><li>æŸ¥è¯¢é€Ÿåº¦ä¸€èˆ¬</li></ul><p>Listçš„å¸¸è§å‘½ä»¤ï¼š</p><ul><li>LPUSH key element ï¼šåƒåˆ—è¡¨å·¦ä¾§æ’å…¥ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ </li><li>LPOP key ï¼šç§»é™¤å¹¶è¿”å›åˆ—è¡¨å·¦ä¾§çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œæ²¡æœ‰åˆ™è¿”å›nil</li><li>RPUSH key elementï¼šå‘åˆ—è¡¨å³ä¾§æ’å…¥ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ </li><li>RPOP keyï¼šç§»é™¤å¹¶è¿”å›åˆ—è¡¨å³ä¾§ç¬¬ä¸€ä¸ªå…ƒç´ </li><li>LRANGE key start endï¼šè¿”å›ä¸€æ®µè§’æ ‡èŒƒå›´å†…çš„æ‰€æœ‰å…ƒç´ </li><li>BLPOPå’ŒBRPOPï¼šä¸LPOPã€RPOPç±»ä¼¼ï¼Œåªä¸è¿‡åœ¨æ²¡æœ‰å…ƒç´ æ—¶ç­‰å¾…æŒ‡å®šæ—¶é—´ï¼Œè€Œä¸æ˜¯ç›´æ¥è¿”å›nil</li><li>lindex key indexï¼šlindex ç›¸å½“äº Java é“¾è¡¨çš„ get(index) æ–¹æ³•ï¼Œå®ƒéœ€è¦å¯¹é“¾è¡¨è¿›è¡Œéå†ã€‚å…¶æ€§èƒ½éšç€å‚æ•°indexå¢å¤§è€Œå˜å·®ã€‚</li><li>ltrim key startIndex endIndexï¼šä½¿ç”¨startIndex ã€endIndexå®šä¹‰äº†ä¸€ä¸ªåŒºé—´ï¼Œä¿ç•™ç€åŒºé—´å†…çš„å€¼ï¼ŒåŒºé—´å¤–ç»Ÿç»Ÿå»é™¤ã€‚è¿™æ ·å¯ä»¥å®ç°ä¸€ä¸ªå®šé•¿çš„é“¾è¡¨ã€‚indexå¯ä»¥ä¸ºè´Ÿæ•°ï¼Œ-1è¡¨ç¤ºå€’æ•°ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œ-2è¡¨ç¤ºå€’æ•°ç¬¬äºŒä¸ªå…ƒç´ ã€‚</li></ul><p>åº”ç”¨åœºæ™¯ï¼šå¸¸ç”¨æ¥åšå¼‚æ­¥é˜Ÿåˆ—ä½¿ç”¨ã€‚å°†éœ€è¦å»¶åå¤„ç†çš„ä»»åŠ¡ç»“æ„ä½“åºåˆ—åŒ–æˆå­—ç¬¦ä¸²å¡è¿›Redisçš„åˆ—è¡¨ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ä»è¿™ä¸ªåˆ—è¡¨ä¸­è½®è¯¢æ•°æ®è¿›è¡Œå¤„ç†ã€‚é€šè¿‡æ§åˆ¶ï¼Œå³è¾¹è¿›å·¦è¾¹å‡ºï¼Œå¯ä»¥å®ç°é˜Ÿåˆ—ã€‚é€šè¿‡æ§åˆ¶ï¼Œå³è¾¹è¿›å³è¾¹å‡ºï¼Œå¯ä»¥å®ç°æ ˆã€‚</p><p>åŸç†ï¼šRedisåˆ—è¡¨åº•å±‚å­˜å‚¨ä¸æ˜¯ä¸€ä¸ªç®€å•çš„ linkedlistï¼Œè€Œæ˜¯æˆä¸ºå¿«é€Ÿåˆ—è¡¨quicklistçš„ä¸€ä¸ªç»“æ„ã€‚é¦–å…ˆåœ¨åˆ—è¡¨å…ƒç´ è¾ƒå°‘çš„æƒ…å†µä¸‹ä¼šä½¿ç”¨ä¸€å—è¿ç»­çš„å†…å­˜å­˜å‚¨ï¼Œè¿™ä¸ªç»“æ„æ˜¯å‹ç¼©åˆ—è¡¨ziplistã€‚å®ƒå°†æ‰€æœ‰çš„å…ƒç´ ç´§ç´§æŒ¨åœ¨ä¸€èµ·å­˜å‚¨ï¼Œåˆ†é…çš„æ˜¯ä¸€å—è¿ç»­çš„å†…å­˜ã€‚å½“æ•°æ®é‡æ¯”è¾ƒå¤šæ—¶ï¼Œæ‰ä¼šæ”¹æˆ quicklistã€‚å› ä¸ºæ™®é€šçš„é“¾è¡¨éœ€è¦çš„é™„ä»¶æŒ‡é’ˆç©ºé—´å¤ªå¤§ï¼Œä¼šæ¯”è¾ƒæµªè´¹ç©ºé—´ï¼Œè€Œä¸”åŠ é‡å†…å­˜çš„ç¢ç‰‡åŒ–ã€‚æ‰€ä»¥Rediså°† å¤šä¸ª ziplistä½¿ç”¨åŒå‘æŒ‡é’ˆä¸²èµ·æ¥ä½¿ç”¨ã€‚è¿™æ ·æ—¢æ»¡è¶³äº†å¿«é€Ÿçš„æ’å…¥åˆ é™¤æ€§èƒ½ï¼Œæœ‰ä¸ä¼šå‡ºç°å¤ªå¤§çš„ç©ºé—´å†—ä½™ã€‚</p><h5 id="2-1-5-Setç±»å‹"><a href="#2-1-5-Setç±»å‹" class="headerlink" title="2.1.5 Setç±»å‹"></a>2.1.5 Setç±»å‹</h5><p>Redisçš„Setç»“æ„ä¸ Java ä¸­çš„HashSetç±»ä¼¼ï¼Œå¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ª value ä¸º null çš„ HashMapã€‚å› ä¸ºä¹Ÿæ˜¯ä¸€ä¸ª hash è¡¨ï¼Œå› æ­¤å…·å¤‡ä¸ HashSetç±»ä¼¼çš„ç‰¹å¾</p><ul><li>æ— åº</li><li>å…ƒç´ ä¸å¯é‡å¤</li><li>æŸ¥æ‰¾å¿«</li><li>æ”¯æŒäº¤é›†ã€å¹¶é›†ã€å·®é›†ç­‰åŠŸèƒ½</li></ul><p>Setå¸¸è§å‘½ä»¤ï¼š</p><ul><li>SADD key memberï¼šå‘setä¸­æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ </li><li>SREM key memberï¼šç§»é™¤setä¸­æŒ‡å®šçš„å…ƒç´ </li><li>SCARD keyï¼šè¿”å›setä¸­å…ƒç´ çš„ä¸ªæ•°</li><li>SISMEMBER key memberï¼šåˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨äº set ä¸­</li><li>SMEMBERSï¼šè·å– set ä¸­çš„æ‰€æœ‰å…ƒç´ </li><li>SINTER key1 key2 ï¼šæ±‚ key1 ä¸ key2 çš„äº¤é›†</li><li>SDIFF key1 key2ï¼šæ±‚ key1 ä¸ key2 çš„å·®é›† </li><li>SUNION key1 key2 ï¼šæ±‚ key1 ä¸ key2 çš„å¹¶é›†</li></ul><h5 id="2-1-6-SortedSetç±»å‹"><a href="#2-1-6-SortedSetç±»å‹" class="headerlink" title="2.1.6 SortedSetç±»å‹"></a>2.1.6 SortedSetç±»å‹</h5><p>Redis çš„ SortedSet æ˜¯ä¸€ä¸ªå¯æ’åºçš„ set é›†åˆï¼Œä¸ Java ä¸­çš„ TreeSet æœ‰äº›ç±»ä¼¼ï¼Œä½†åº•å±‚æ•°æ®ç»“æ„å´å·®åˆ«å¾ˆå¤§ã€‚SortedSet ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½å¸¦æœ‰ä¸€ä¸ª score å±æ€§ï¼Œå¯ä»¥åŸºäº score å±æ€§å¯¹ å…ƒç´ æ’åºï¼Œåº•å±‚çš„å®ç°æ˜¯ä¸€ä¸ªè·³è¡¨ï¼ˆSkipListï¼‰åŠ hashè¡¨ã€‚</p><p>SortedSetå…·å¤‡ä¸‹åˆ—ç‰¹æ€§ï¼š</p><ul><li>å¯æ’åº</li><li>å…ƒç´ ä¸é‡å¤</li><li>æŸ¥è¯¢é€Ÿåº¦å¿«</li></ul><p>å› ä¸º SortedSet çš„å¯æ’åºç‰¹æ€§ï¼Œç»å¸¸è¢«ç”¨æ¥å®ç°æ’è¡Œæ¦œè¿™æ ·çš„åŠŸèƒ½ã€‚</p><p>SortedSetçš„å¸¸è§å‘½ä»¤æœ‰ï¼š</p><ul><li>ZADD key score memberï¼šæ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ åˆ° SortedSetï¼Œå¦‚æœå·²ç»å­˜åœ¨åˆ™æ›´æ–°å…¶ score å€¼</li><li>ZREM key memberï¼šåˆ é™¤ SortedSetä¸­çš„ä¸€ä¸ªæŒ‡å®šå…ƒç´ </li><li>ZSCORE key memberï¼šè·å– SortedSet ä¸­çš„æŒ‡å®šå…ƒç´ çš„ score å€¼</li><li>ZRANK key memberï¼šè·å– SortedSet ä¸­çš„æŒ‡å®šå…ƒç´ çš„æ’å</li><li>ZCAED keyï¼šè·å– SortedSet ä¸­çš„å…ƒç´ ä¸ªæ•°</li><li>ZCOUNT key min maxï¼šç»Ÿè®¡ score å€¼åœ¨ç»™å®šèŒƒå›´å†…çš„æ‰€æœ‰å…ƒç´ çš„ä¸ªæ•°</li><li>ZINCRBY key increment memberï¼šè®© SortedSetä¸­çš„æŒ‡å®šå…ƒç´ è‡ªå¢ï¼Œæ­¥é•¿ä¸ºæŒ‡å®šçš„incrementå€¼</li><li>ZRANGE key min maxï¼šæŒ‰ç…§ score æ’åºåï¼Œè·å–æŒ‡å®š score èŒƒå›´å†…çš„å…ƒç´ </li><li>ZRANGEBYSCORE key min maxï¼šæŒ‰ç…§ score æ’åºåï¼Œè·å–æŒ‡å®š score èŒƒå›´å†…çš„å…ƒç´ </li><li>ZDIFFã€ZINTERã€ZUNIONï¼šæ±‚å·®é›†ã€äº¤é›†ã€å¹¶é›†</li></ul><p>æ³¨æ„ï¼šæ‰€æœ‰çš„æ’åé»˜è®¤éƒ½æ˜¯ å‡åºï¼Œå¦‚æœè¦é™åºåˆ™åœ¨å‘½ä»¤çš„Zåé¢æ·»åŠ REVå³å¯</p><h4 id="2-2-Rediså®¢æˆ·ç«¯"><a href="#2-2-Rediså®¢æˆ·ç«¯" class="headerlink" title="2.2 Rediså®¢æˆ·ç«¯"></a>2.2 Rediså®¢æˆ·ç«¯</h4><p>Redisçš„å®¢æˆ·ç«¯ä¸»è¦æœ‰</p><ul><li>Jedisï¼šä»¥Rediså‘½ä»¤ä½œä¸ºæ–¹æ³•åç§°ï¼Œå­¦ä¹ æˆæœ¬ä½ï¼Œç®€å•å®ç”¨ã€‚ä½†æ˜¯Jediså®ä¾‹æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œå¤šçº¿ç¨‹æƒ…å†µä¸‹éœ€è¦åŸºäºè¿æ¥æ± å®ç”¨</li><li>Lettuceï¼šåŸºäºNettyå®ç°çš„ï¼Œæ”¯æŒåŒæ­¥ã€å¼‚æ­¥å’Œå“åº”å¼ç¼–ç¨‹æ–¹å¼ï¼Œå¹¶ä¸”æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚æ”¯æŒRedisçš„å“¨å…µæ¨¡å¼ã€é›†ç¾¤æ¨¡å¼å’Œç®¡é“æ¨¡å¼ã€‚</li><li>Redissonï¼šæ˜¯ä¸€ä¸ªåŸºäºRediså®ç°çš„åˆ†å¸ƒå¼ã€å¯ä¼¸ç¼©çš„ Java æ•°æ®ç»“æ„é›†åˆã€‚åŒ…å«äº†è¯¸å¦‚ Mapã€Queueã€Lockã€Semaphoreã€AtomicLongç­‰å¼ºå¤§åŠŸèƒ½ã€‚</li></ul><p>è€Œ SpringData Redis é›†æˆäº† Jedisã€Lettuce</p><h5 id="2-2-1-Jedis-å®¢æˆ·ç«¯"><a href="#2-2-1-Jedis-å®¢æˆ·ç«¯" class="headerlink" title="2.2.1 Jedis å®¢æˆ·ç«¯"></a>2.2.1 Jedis å®¢æˆ·ç«¯</h5><p><a href="https://github.com/kongxiaoran/redisDemo">https://github.com/kongxiaoran/redisDemo</a></p><p>å¯ä»¥ä¸‹æ‹‰è¯¥é¡¹ç›®çš„ Jedis åˆ†æ”¯ï¼Œè¯¥åˆ†æ”¯å·²ç» å®ç°äº† springboot æ•´åˆ jedis ã€‚å¯ä»¥ä¸‹æ‹‰çœ‹çœ‹</p><p>Jedisæœ¬èº«æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œå¹¶ä¸”é¢‘ç¹çš„åˆ›å»ºå’Œé”€æ¯è¿æ¥ä¼šæœ‰æ€§èƒ½æŸè€—ï¼Œå› æ­¤æˆ‘ä»¬æ¨èå¤§å®¶ä½¿ç”¨ Jedis è¿æ¥æ± ä»£æ›¿ Jedis çš„ç›´è¿æ–¹å¼ã€‚</p><h5 id="2-2-2-SpringDataRedis"><a href="#2-2-2-SpringDataRedis" class="headerlink" title="2.2.2 SpringDataRedis"></a>2.2.2 SpringDataRedis</h5><p>SpringData æ˜¯ Spring ä¸­æ•°æ®æ“ä½œçš„æ¨¡å—ï¼ŒåŒ…å«å¯¹å„ç§æ•°æ®åº“çš„é›†æˆï¼Œå…¶ä¸­å¯¹ Redis çš„é›†æˆæ¨¡å—å°±å«åš SpringDataRedisï¼Œå®˜ç½‘åœ°å€ï¼š</p><ul><li>æä¾›äº†å¯¹ä¸åŒ Redis å®¢æˆ·ç«¯çš„æ•´åˆï¼ˆLettuceã€Jedisï¼‰</li><li>æä¾›äº† RedisTemplate ç»Ÿä¸€ API æ¥æ“ä½œ</li><li>æ”¯æŒ Redis çš„å‘å¸ƒè®¢é˜…æ¨¡å‹</li><li>æ”¯æŒ Redis å“¨å…µå’Œ Redis é›†ç¾¤</li><li>æ”¯æŒåŸºäº Lettuce çš„å“åº”å¼ç¼–ç¨‹</li><li>æ”¯æŒåŸºäº JDKã€JSONã€å­—ç¬¦ä¸²ã€Springå¯¹è±¡çš„æ•°æ®åºåˆ—åŒ–åŠååºåˆ—åŒ–</li><li>æ”¯æŒåŸºäº Redistributionçš„ JDK Collectionå®ç°</li></ul><h4 id="2-3-SpringDataRedis-å®¢æˆ·ç«¯ä½¿ç”¨"><a href="#2-3-SpringDataRedis-å®¢æˆ·ç«¯ä½¿ç”¨" class="headerlink" title="2.3 SpringDataRedis å®¢æˆ·ç«¯ä½¿ç”¨"></a>2.3 SpringDataRedis å®¢æˆ·ç«¯ä½¿ç”¨</h4><p>SpringDataRedis æä¾›äº† RedisTemplate å·¥å…·ç±»ï¼Œå…¶ä¸­å°è£…äº†å„ç§å¯¹ Redis çš„æ“ä½œã€‚å¹¶ä¸”å°†ä¸åŒæ•°æ®ç±»å‹çš„æ“ä½œAPI å°è£…åˆ°äº†ä¸åŒç±»å‹ä¸­ï¼š</p><table><thead><tr><th><strong>API</strong></th><th><strong>è¿”å›å€¼ç±»å‹</strong></th><th><strong>è¯´æ˜</strong></th></tr></thead><tbody><tr><td>redisTemplate.opsForValue()</td><td>ValueOperations</td><td>æ“ä½œ String ç±»å‹æ•°æ®</td></tr><tr><td>redisTemplate.opsForHash()</td><td>HashOperations</td><td>æ“ä½œ Hash ç±»å‹æ•°æ®</td></tr><tr><td>redisTemplate.opsForList()</td><td>ListIOperations</td><td>æ“ä½œ List ç±»å‹æ•°æ®</td></tr><tr><td>redisTemplate.opsForSet()</td><td>SetOperations</td><td>æ“ä½œ Set ç±»å‹æ•°æ®</td></tr><tr><td>redisTemplate.opsForZSet()</td><td>ZSetOperations</td><td>æ“ä½œ SortedSet ç±»å‹æ•°æ®</td></tr><tr><td>redisTemplate</td><td></td><td>é€šç”¨å‘½ä»¤</td></tr></tbody></table><p><a href="https://github.com/kongxiaoran/redisDemo">https://github.com/kongxiaoran/redisDemo</a></p><p>è¯¥é¡¹ç›®çš„ master åˆ†æ”¯ï¼Œä½¿ç”¨ SpringBoot æ•´åˆäº† SpringDataRedisï¼Œå¯ä»¥è‡ªè¡Œä¸‹æ‹‰è¿è¡Œã€‚</p><h5 id="2-3-1-SpringDataRedis-çš„é»˜è®¤åºåˆ—åŒ–"><a href="#2-3-1-SpringDataRedis-çš„é»˜è®¤åºåˆ—åŒ–" class="headerlink" title="2.3.1 SpringDataRedis çš„é»˜è®¤åºåˆ—åŒ–"></a>2.3.1 SpringDataRedis çš„é»˜è®¤åºåˆ—åŒ–</h5><p>RedisTemplate å¯ä»¥æ¥æ”¶ä»»æ„ Object ä½œä¸ºå€¼ å†™å…¥ Redisï¼Œåªä¸è¿‡å†™å…¥ å‰ä¼šæŠŠ Object åºåˆ—åŒ–ä¸ºå­—èŠ‚å½¢å¼ï¼Œé»˜è®¤æ˜¯é‡‡ç”¨ JDK åºåˆ—åŒ–ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redisTemplate.opsForValue().set(&quot;springboot&quot;,&quot;ä½ å¥½å‘€ï¼Œspringboot&quot;);   </span><br><span class="line">String springboot = (String) redisTemplate.opsForValue().get(&quot;springboot&quot;);</span><br><span class="line">System.out.println(springboot);</span><br></pre></td></tr></table></figure><p>å¾—åˆ°çš„ç»“æœæ˜¯è¿™æ ·çš„ï¼š</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/35838370/1682779112780-bf2ddbf3-24a4-47aa-b14d-5ba839abecdd.png" alt="img"></p><p>ç¼ºç‚¹å¾ˆæ˜æ˜¾ï¼š</p><ul><li>å¯è¯»æ€§å·®</li><li>å†…å­˜å ç”¨è¾ƒå¤§</li></ul><p>è¿™æ˜¯å› ä¸ºä»€ä¹ˆå‘¢ï¼ŸæŸ¥çœ‹ RedisTemplate ç±»ï¼Œå¯ä»¥çŸ¥é“ å½“æ²¡æœ‰ç‰¹åˆ«é…ç½® keyã€valueã€hashKey çš„ åºåˆ—åŒ–ç­–ç•¥æ—¶ï¼Œ</p><p>RedisTemplate ä¼šé€‰æ‹©ä½¿ç”¨ JDKåºåˆ—åŒ–å™¨ï¼ˆJdkSerializationRedisSerializer)ï¼Œè€Œæ­¤åºåˆ—åŒ–å™¨æ˜¯ä¸æ˜¯é€‚åˆå­—ç¬¦ä¸²çš„åºåˆ—åŒ–çš„ã€‚æ‰€ä»¥å¦‚æœä½ çš„ key é€šå¸¸æ˜¯ç”¨ å­—ç¬¦ä¸²æ ¼å¼ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘ åœ¨åºåˆ—åŒ–keyæ—¶ï¼Œé‡‡ç”¨å…¶ä»–åºåˆ—åŒ–å™¨ã€‚æ¯”å¦‚ï¼šString</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/35838370/1682779116223-bc409176-9ef0-4441-87c3-073ae4c8bc51.png" alt="img"></p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779116227-ff9eae7b-6954-4282-91dc-cd89ac3f5cd8.png" alt="img"></p><h5 id="2-3-2-SpringDataRedis-æä¾›çš„åºåˆ—åŒ–å™¨"><a href="#2-3-2-SpringDataRedis-æä¾›çš„åºåˆ—åŒ–å™¨" class="headerlink" title="2.3.2 SpringDataRedis æä¾›çš„åºåˆ—åŒ–å™¨"></a>2.3.2 SpringDataRedis æä¾›çš„åºåˆ—åŒ–å™¨</h5><p>æŸ¥çœ‹ RedisSerializer çš„å®ç°ï¼Œå¯ä»¥çœ‹åˆ°æœ‰ 7 ç§åºåˆ—åŒ–å™¨ï¼š</p><ul><li><p>ByteArrayRedisSerializerï¼šå­—èŠ‚æ•°ç»„åºåˆ—åŒ–</p></li><li><p>GenericJackson2JsonRedisSerializerï¼šåŒ FastJsonRedisSerializer ç±»ä¼¼ï¼Œè€Œ FastJsonRedisSerializer æ˜¯ç”±é˜¿é‡Œå·´å·´FastJsonåŒ…æä¾›ã€‚å…·æœ‰ï¼š1. é€Ÿåº¦å¿« 2. å…¼å®¹æ€§å¼º 3. å ç”¨å†…å­˜å°</p></li><li><ul><li>åº•å±‚ä½¿ç”¨Jacksonè¿›è¡Œåºåˆ—åŒ–å¹¶å­˜å…¥Redisã€‚å¯¹äºæ™®é€šç±»å‹(å¦‚æ•°å€¼ç±»å‹ï¼Œå­—ç¬¦</li><li>å­˜å…¥å¯¹è±¡æ—¶ç”±äºæ²¡æœ‰å­˜å…¥ç±»ä¿¡æ¯ï¼Œåˆ™æ— æ³•ååºåˆ—åŒ–ã€‚</li></ul></li><li><p>GenericToStringSerializerï¼šåŒStringRedisSerializerä¸€æ ·ï¼Œä½†å®ƒå¯ä»¥å°†ä»»ä½•å¯¹è±¡æ³›åŒ–ä¸ºå­—ç¬¦ä¸²å¹¶åºåˆ—åŒ–ã€‚æ³¨æ„äº‹é¡¹ï¼šGenericToStringSerializeréœ€è¦è°ƒç”¨è€…ç»™ä¼ ä¸€ä¸ªå¯¹è±¡åˆ°å­—ç¬¦ä¸²äº’è½¬çš„Converterï¼Œä½¿ç”¨èµ·æ¥å…¶æ¯”è¾ƒéº»çƒ¦ï¼Œæ‰€ä»¥ä¸å¤ªæ¨èä½¿ç”¨ã€‚</p></li><li><p>Jackson2JsonRedisSerializerï¼šå°†å¯¹è±¡åºåˆ—åŒ–ä¸ºjsonå­—ç¬¦ä¸²</p></li><li><ul><li>Â·ä¼˜ç‚¹ï¼šé€Ÿåº¦å¿«ã€åºåˆ—åŒ–åçš„å­—ç¬¦ä¸²çŸ­å°ç²¾æ‚ã€ä¸éœ€è¦å®ç° Serializable</li><li>ç¼ºç‚¹ï¼šå¿…é¡»è¦æä¾›è¦åºåˆ—åŒ–å¯¹è±¡çš„ç±»å‹ä¿¡æ¯ï¼ˆ.classå¯¹è±¡ï¼‰</li></ul></li><li><p>JdkSerializationRedisSerializerï¼šä½¿ç”¨Javaè‡ªå¸¦çš„åºåˆ—åŒ–æœºåˆ¶å°†å¯¹è±¡åºåˆ—åŒ–ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ã€‚</p></li><li><ul><li>ä¼˜ç‚¹åœ¨äºï¼šé€šç”¨æ€§å¼ºã€ååºåˆ—åŒ–æ—¶ä¸éœ€è¦æä¾›ç±»å‹ä¿¡æ¯ã€‚ã€</li><li>ç¼ºç‚¹åœ¨äºï¼šåºåˆ—åŒ–é€Ÿåº¦æ…¢ã€åºåˆ—åŒ–å†…å­˜å ç”¨å¤§ã€åºåˆ—åŒ–å¯¹è±¡å¿…é¡»å®ç° Serializable æ¥å£ã€å¯è¯»æ€§å·®</li></ul></li><li><p>OxmSerializerï¼šå°†å¯¹è±¡åºåˆ—åŒ–ä¸ºxmlå­—ç¬¦ä¸²ã€‚ä»¥ xml æ ¼å¼å­˜å‚¨ï¼ˆä½†è¿˜æ˜¯Stringç±»å‹ï¼‰ï¼Œè§£æèµ·æ¥æ¯”è¾ƒå¤æ‚ï¼Œä¸”å ç”¨ç©ºé—´å¤§</p></li><li><p>StringRedisSerializerï¼šStringRedisTemplateé»˜è®¤çš„åºåˆ—åŒ–å™¨ã€‚</p></li><li><ul><li>ä¼˜ç‚¹ï¼šå¯è¯»æ€§å¼ºã€ä¸éœ€è¦è½¬æ¢</li><li>ç¼ºç‚¹ï¼šåªèƒ½å¯¹å­—ç¬¦ä¸²åºåˆ—åŒ–ï¼Œä¸èƒ½å¯¹ å¯¹è±¡ åºåˆ—åŒ–</li></ul></li></ul><h5 id="2-3-3-è‡ªå®šä¹‰åºåˆ—åŒ–å™¨"><a href="#2-3-3-è‡ªå®šä¹‰åºåˆ—åŒ–å™¨" class="headerlink" title="2.3.3 è‡ªå®šä¹‰åºåˆ—åŒ–å™¨"></a>2.3.3 è‡ªå®šä¹‰åºåˆ—åŒ–å™¨</h5><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é’ˆå¯¹è‡ªå·±çš„éœ€è¦ï¼Œè‡ªå®šä¹‰ RedisTemplateï¼Œæ¥å®ç°å¯¹ä¸åŒ keyã€value ä½¿ç”¨ä¸åŒçš„åºåˆ—åŒ–å™¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">public RedisTemplate&lt;String,Object&gt; redisTemplate(RedisConnectionFactory redisConnectionFactory)</span><br><span class="line">    throws UnknownHostException&#123;</span><br><span class="line"></span><br><span class="line">    // åˆ›å»º Template</span><br><span class="line">    RedisTemplate&lt;String,Object&gt; redisTemplate = new RedisTemplate&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    // è®¾ç½®è¿æ¥å·¥å‚</span><br><span class="line">    redisTemplate.setConnectionFactory(redisConnectionFactory);</span><br><span class="line"></span><br><span class="line">    // è®¾ç½®åºåˆ—åŒ–å·¥å…·</span><br><span class="line">    GenericJackson2JsonRedisSerializer jackson2JsonRedisSerializer =</span><br><span class="line">    new GenericJackson2JsonRedisSerializer();</span><br><span class="line"></span><br><span class="line">    // key å’Œ hashKey é‡‡ç”¨ Stringåºåˆ—åŒ–</span><br><span class="line">    redisTemplate.setKeySerializer(RedisSerializer.string());</span><br><span class="line">    redisTemplate.setHashKeySerializer(RedisSerializer.string());</span><br><span class="line"></span><br><span class="line">    // value å’Œ hashValue é‡‡ç”¨ JOSNåºåˆ—åŒ–</span><br><span class="line">    redisTemplate.setValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line">    redisTemplate.setHashValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line"></span><br><span class="line">    return redisTemplate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-3-4-ä½¿ç”¨è‡ªå®šä¹‰åºåˆ—åŒ–å™¨å­˜å‚¨å¯¹è±¡"><a href="#2-3-4-ä½¿ç”¨è‡ªå®šä¹‰åºåˆ—åŒ–å™¨å­˜å‚¨å¯¹è±¡" class="headerlink" title="2.3.4 ä½¿ç”¨è‡ªå®šä¹‰åºåˆ—åŒ–å™¨å­˜å‚¨å¯¹è±¡"></a>2.3.4 ä½¿ç”¨è‡ªå®šä¹‰åºåˆ—åŒ–å™¨å­˜å‚¨å¯¹è±¡</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void testEmployee()&#123;</span><br><span class="line">    Employee employee = new Employee(3,&quot;ç¾½&quot;,&quot;28235x02x7&quot;,1,1);</span><br><span class="line">    // å†™å…¥æ•°æ®</span><br><span class="line">    redisTemplate.opsForValue().set(&quot;user_3&quot;,employee);</span><br><span class="line"></span><br><span class="line">    // è·å–æ•°æ®</span><br><span class="line">    Employee getEmployee = (Employee) redisTemplate.opsForValue().get(&quot;user_3&quot;);</span><br><span class="line">    System.out.println(getEmployee.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2023/png/35838370/1682779116323-2e3c4c31-c032-4f95-985f-2c0da0eb6c51.png" alt="img"></p><p>ç”±å›¾å¯ä»¥çŸ¥é“ï¼Œè¯¥åºåˆ—åŒ–å™¨åœ¨åºåˆ—åŒ–å¯¹è±¡ï¼Œä¹Ÿä¼šå°† å¯¹è±¡çš„å­—èŠ‚ç åç§°å†™å…¥ã€‚è¿™æ ·åœ¨æˆ‘ä»¬ååºåˆ—åŒ–æ—¶çŸ¥é“å¯¹è±¡çš„ç±»å‹ï¼Œä»è€Œååºåˆ—åŒ–æˆå¯¹åº”å¯¹è±¡ã€‚</p><h5 id="2-3-5-ä½¿ç”¨StringRedisTemplateå­˜å‚¨JSONå¯¹è±¡"><a href="#2-3-5-ä½¿ç”¨StringRedisTemplateå­˜å‚¨JSONå¯¹è±¡" class="headerlink" title="2.3.5 ä½¿ç”¨StringRedisTemplateå­˜å‚¨JSONå¯¹è±¡"></a>2.3.5 ä½¿ç”¨StringRedisTemplateå­˜å‚¨JSONå¯¹è±¡</h5><p>ä½†æ˜¯è¿™ä¸€ä¸ªå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼ŒJSONåºåˆ—åŒ–å™¨å°†ç±»çš„classç±»å‹å†™å…¥äº† JSONç»“æœä¸­ï¼Œå­˜å…¥äº† Redis ï¼Œä¼šå¸¦æ¥é¢å¤–çš„å†…å­˜å¼€é”€ã€‚ä¸ºäº†èŠ‚çœå†…å­˜ç©ºé—´ï¼Œæˆ‘ä»¬å¹¶ä¸ä¼šä½¿ç”¨ JSON åºåˆ—åŒ–å™¨æ¥å¤„ç† valueï¼Œè€Œæ˜¯ç»Ÿä¸€ä½¿ç”¨ String åºåˆ—åŒ–å™¨ï¼Œè¦æ±‚åªèƒ½å­˜å‚¨ String ç±»å‹çš„ key å’Œ valueã€‚å½“éœ€è¦å­˜å‚¨ Java å¯¹è±¡æ—¶ï¼Œ<strong>æ‰‹åŠ¨å®Œæˆå¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–</strong>ã€‚</p><p>æ‰€ä»¥è¿˜æ˜¯å»ºè®®æ‰‹åŠ¨å®Œæˆå¯¹è±¡çš„åºåˆ—åŒ–ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void testEmployeeStringRedisTemplate()&#123;</span><br><span class="line">    Employee employee = new Employee(3,&quot;ç¾½&quot;,&quot;2823x302x7&quot;,1,1);</span><br><span class="line">    // å†™å…¥æ•°æ® ï¼ˆè¿™é‡Œä½¿ç”¨çš„æ—¶ fastJson2è¿›è¡Œåºåˆ—åŒ–ï¼‰</span><br><span class="line">    stringRedisTemplate.opsForValue().set(&quot;user_4&quot;, JSON.toJSONString(employee));</span><br><span class="line">    // è·å–æ•°æ®</span><br><span class="line">    Employee getEmployee = JSON.parseObject(stringRedisTemplate.opsForValue().get(&quot;user_4&quot;), Employee.class);</span><br><span class="line">    System.out.println(getEmployee.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-3-6-RedisTemplate-æ“ä½œ-Hash-ç±»å‹"><a href="#2-3-6-RedisTemplate-æ“ä½œ-Hash-ç±»å‹" class="headerlink" title="2.3.6 RedisTemplate æ“ä½œ Hash ç±»å‹"></a>2.3.6 RedisTemplate æ“ä½œ Hash ç±»å‹</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void testHash()&#123;</span><br><span class="line">    stringRedisTemplate.opsForHash().put(&quot;xiucheng&quot;,&quot;user1&quot;,&quot;å‡Œéœ„&quot;);</span><br><span class="line">    stringRedisTemplate.opsForHash().put(&quot;xiucheng&quot;,&quot;user2&quot;,&quot;ç¾½&quot;);</span><br><span class="line"></span><br><span class="line">    Map&lt;Object, Object&gt; xiucheng = stringRedisTemplate.opsForHash().entries(&quot;xiucheng&quot;);</span><br><span class="line">    System.out.println(xiucheng.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä¸‰ã€Redis-å®æˆ˜"><a href="#ä¸‰ã€Redis-å®æˆ˜" class="headerlink" title="ä¸‰ã€Redis å®æˆ˜"></a>ä¸‰ã€Redis å®æˆ˜</h2><h3 id="3-1-Redisä¸MySQLåŒå†™ä¸€è‡´æ€§å¦‚ä½•ä¿è¯ï¼Ÿ"><a href="#3-1-Redisä¸MySQLåŒå†™ä¸€è‡´æ€§å¦‚ä½•ä¿è¯ï¼Ÿ" class="headerlink" title="3.1 Redisä¸MySQLåŒå†™ä¸€è‡´æ€§å¦‚ä½•ä¿è¯ï¼Ÿ"></a>3.1 Redisä¸MySQLåŒå†™ä¸€è‡´æ€§å¦‚ä½•ä¿è¯ï¼Ÿ</h3><h4 id="3-1-1-ä¸€è‡´æ€§"><a href="#3-1-1-ä¸€è‡´æ€§" class="headerlink" title="3.1.1 ä¸€è‡´æ€§"></a>3.1.1 ä¸€è‡´æ€§</h4><p>ä¸€è‡´æ€§å°±æ˜¯æ•°æ®ä¿æŒä¸€è‡´ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¯ä»¥ç†è§£ä¸ºå¤šä¸ªèŠ‚ç‚¹ä¸­æ•°æ®çš„å€¼æ˜¯ä¸€è‡´çš„ã€‚</p><ul><li><strong>å¼ºä¸€è‡´æ€§</strong>ï¼šè¿™ç§ä¸€è‡´æ€§çº§åˆ«æ˜¯æœ€ç¬¦åˆç”¨æˆ·ç›´è§‰çš„ï¼Œå®ƒè¦æ±‚ç³»ç»Ÿå†™å…¥ä»€ä¹ˆï¼Œè¯»å‡ºæ¥çš„ä¹Ÿä¼šæ˜¯ä»€ä¹ˆï¼Œç”¨æˆ·ä½“éªŒå¥½ï¼Œä½†å®ç°èµ·æ¥å¾€å¾€å¯¹ç³»ç»Ÿçš„æ€§èƒ½å½±å“å¤§</li><li><strong>å¼±ä¸€è‡´æ€§</strong>ï¼šè¿™ç§ä¸€è‡´æ€§çº§åˆ«çº¦æŸäº†ç³»ç»Ÿåœ¨å†™å…¥æˆåŠŸåï¼Œä¸æ‰¿è¯ºç«‹å³å¯ä»¥è¯»åˆ°å†™å…¥çš„å€¼ï¼Œä¹Ÿä¸æ‰¿è¯ºå¤šä¹…ä¹‹åæ•°æ®èƒ½å¤Ÿè¾¾åˆ°ä¸€è‡´ï¼Œä½†ä¼šå°½å¯èƒ½åœ°ä¿è¯åˆ°æŸä¸ªæ—¶é—´çº§åˆ«ï¼ˆæ¯”å¦‚ç§’çº§åˆ«ï¼‰åï¼Œæ•°æ®èƒ½å¤Ÿè¾¾åˆ°ä¸€è‡´çŠ¶æ€</li><li><strong>æœ€ç»ˆä¸€è‡´æ€§</strong>ï¼šæœ€ç»ˆä¸€è‡´æ€§æ˜¯å¼±ä¸€è‡´æ€§çš„ä¸€ä¸ªç‰¹ä¾‹ï¼Œç³»ç»Ÿä¼šä¿è¯åœ¨ä¸€å®šæ—¶é—´å†…ï¼Œèƒ½å¤Ÿè¾¾åˆ°ä¸€ä¸ªæ•°æ®ä¸€è‡´çš„çŠ¶æ€ã€‚è¿™é‡Œä¹‹æ‰€ä»¥å°†æœ€ç»ˆä¸€è‡´æ€§å•ç‹¬æå‡ºæ¥ï¼Œæ˜¯å› ä¸ºå®ƒæ˜¯å¼±ä¸€è‡´æ€§ä¸­éå¸¸æ¨å´‡çš„ä¸€ç§ä¸€è‡´æ€§æ¨¡å‹ï¼Œä¹Ÿæ˜¯ä¸šç•Œåœ¨å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ•°æ®ä¸€è‡´æ€§ä¸Šæ¯”è¾ƒæ¨å´‡çš„æ¨¡å‹</li></ul><h4 id="3-1-2-ä¸‰ç§ç»å…¸çš„ç¼“å­˜æ¨¡å¼"><a href="#3-1-2-ä¸‰ç§ç»å…¸çš„ç¼“å­˜æ¨¡å¼" class="headerlink" title="3.1.2 ä¸‰ç§ç»å…¸çš„ç¼“å­˜æ¨¡å¼"></a>3.1.2 ä¸‰ç§ç»å…¸çš„ç¼“å­˜æ¨¡å¼</h4><p>ç¼“å­˜å¯ä»¥æå‡æ€§èƒ½ã€ç¼“è§£æ•°æ®åº“å‹åŠ›ï¼Œä½†æ˜¯ä½¿ç”¨ç¼“å­˜ä¹Ÿä¼šå¯¼è‡´æ•°æ®<strong>ä¸ä¸€è‡´æ€§</strong>çš„é—®é¢˜ã€‚ä¸€èˆ¬æˆ‘ä»¬æ˜¯å¦‚ä½•ä½¿ç”¨ç¼“å­˜å‘¢ï¼Ÿæœ‰ä¸‰ç§ç»å…¸çš„ç¼“å­˜æ¨¡å¼ï¼š</p><ul><li><strong>Cache-Aside Pattern</strong>Cache-Aside Patternï¼Œå³<strong>æ—è·¯ç¼“å­˜æ¨¡å¼</strong>ï¼Œå®ƒçš„æå‡ºæ˜¯ä¸ºäº†å°½å¯èƒ½åœ°è§£å†³ç¼“å­˜ä¸æ•°æ®åº“çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚è¯»ï¼šå†™ï¼šæ›´æ–°çš„æ—¶å€™ï¼Œå…ˆ<strong>æ›´æ–°æ•°æ®åº“ï¼Œç„¶åå†åˆ é™¤ç¼“å­˜</strong>ã€‚</li></ul><ol><li><ol><li>è¯»çš„æ—¶å€™ï¼Œå…ˆè¯»ç¼“å­˜ï¼Œç¼“å­˜å‘½ä¸­çš„è¯ï¼Œç›´æ¥è¿”å›æ•°æ®</li><li>ç¼“å­˜æ²¡æœ‰å‘½ä¸­çš„è¯ï¼Œå°±å»è¯»æ•°æ®åº“ï¼Œä»æ•°æ®åº“å–å‡ºæ•°æ®ï¼Œæ”¾å…¥ç¼“å­˜åï¼ŒåŒæ—¶è¿”å›å“åº”ã€‚</li></ol></li></ol><ul><li><strong>Read-Through&#x2F;Write through</strong>Read&#x2F;Write Throughæ¨¡å¼ä¸­ï¼ŒæœåŠ¡ç«¯æŠŠç¼“å­˜ä½œä¸ºä¸»è¦æ•°æ®å­˜å‚¨ã€‚åº”ç”¨ç¨‹åºè·Ÿæ•°æ®åº“ç¼“å­˜äº¤äº’ï¼Œéƒ½æ˜¯é€šè¿‡<strong>æŠ½è±¡ç¼“å­˜å±‚</strong>å®Œæˆçš„ã€‚è¯»ï¼š<img src="https://cdn.nlark.com/yuque/0/2023/webp/35838370/1682779116373-baeadbf7-a12c-4bb1-9fae-bff4afb23d3b.webp" alt="img">è¿™ä¸ªç®€è¦æµç¨‹æ˜¯ä¸æ˜¯è·Ÿ<strong>Cache-Aside</strong>å¾ˆåƒå‘¢ï¼Ÿå…¶å®<strong>Read-Through</strong>å°±æ˜¯å¤šäº†ä¸€å±‚<strong>Cache-Provider</strong>ã€‚å†™ï¼šå½“å‘ç”Ÿå†™è¯·æ±‚æ—¶ï¼Œä¹Ÿæ˜¯ç”±<strong>ç¼“å­˜æŠ½è±¡å±‚</strong>å®Œæˆæ•°æ®æºå’Œç¼“å­˜æ•°æ®çš„æ›´æ–°ï¼šå…ˆæ›´æ–°æ•°æ®æºï¼Œå†æ›´æ–°ç¼“å­˜ã€‚</li></ul><ol><li><ol><li>ä»ç¼“å­˜è¯»å–æ•°æ®ï¼Œè¯»åˆ°ç›´æ¥è¿”å›</li><li>å¦‚æœè¯»å–ä¸åˆ°çš„è¯ï¼Œä»æ•°æ®åº“åŠ è½½ï¼Œå†™å…¥ç¼“å­˜åï¼Œå†è¿”å›å“åº”ã€‚</li></ol></li></ol><ul><li><strong>Write behind****Write behind</strong>è·Ÿ<strong>Read-Through&#x2F;Write-Through</strong>æœ‰ç›¸ä¼¼çš„åœ°æ–¹ï¼Œéƒ½æ˜¯ç”±Cache Provideræ¥è´Ÿè´£ç¼“å­˜å’Œæ•°æ®åº“çš„è¯»å†™ã€‚å®ƒä¸¤åˆæœ‰ä¸ªå¾ˆå¤§çš„ä¸åŒï¼š<strong>Read&#x2F;Write Through</strong>æ˜¯åŒæ­¥æ›´æ–°ç¼“å­˜å’Œæ•°æ®çš„ï¼Œ<strong>Write Behind</strong>åˆ™æ˜¯åªæ›´æ–°ç¼“å­˜ï¼Œä¸ç›´æ¥æ›´æ–°æ•°æ®åº“ï¼Œé€šè¿‡<strong>æ‰¹é‡å¼‚æ­¥</strong>çš„æ–¹å¼æ¥æ›´æ–°æ•°æ®åº“ã€‚è¿™ç§æ–¹å¼ä¸‹ï¼Œç¼“å­˜å’Œæ•°æ®åº“çš„ä¸€è‡´æ€§ä¸å¼ºï¼Œ<strong>å¯¹ä¸€è‡´æ€§è¦æ±‚é«˜çš„ç³»ç»Ÿè¦è°¨æ…ä½¿ç”¨</strong>ã€‚ä½†æ˜¯å®ƒé€‚åˆé¢‘ç¹å†™çš„åœºæ™¯ï¼ŒMySQLçš„<strong>InnoDB Buffer Poolæœºåˆ¶</strong>å°±ä½¿ç”¨åˆ°è¿™ç§æ¨¡å¼ã€‚</li></ul><h4 id="3-1-3-æ“ä½œç¼“å­˜çš„æ—¶å€™ï¼Œåˆ é™¤ç¼“å­˜å‘¢ï¼Œè¿˜æ˜¯æ›´æ–°ç¼“å­˜ï¼Ÿ"><a href="#3-1-3-æ“ä½œç¼“å­˜çš„æ—¶å€™ï¼Œåˆ é™¤ç¼“å­˜å‘¢ï¼Œè¿˜æ˜¯æ›´æ–°ç¼“å­˜ï¼Ÿ" class="headerlink" title="3.1.3 æ“ä½œç¼“å­˜çš„æ—¶å€™ï¼Œåˆ é™¤ç¼“å­˜å‘¢ï¼Œè¿˜æ˜¯æ›´æ–°ç¼“å­˜ï¼Ÿ"></a>3.1.3 æ“ä½œç¼“å­˜çš„æ—¶å€™ï¼Œåˆ é™¤ç¼“å­˜å‘¢ï¼Œè¿˜æ˜¯æ›´æ–°ç¼“å­˜ï¼Ÿ</h4><p>ä¸€èˆ¬ä¸šåŠ¡åœºæ™¯ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„å°±æ˜¯<strong>Cache-Aside</strong>æ¨¡å¼ã€‚ æœ‰äº›å°ä¼™ä¼´å¯èƒ½ä¼šé—®ï¼Œ <strong>Cache-Aside</strong>åœ¨å†™å…¥è¯·æ±‚çš„æ—¶å€™ï¼Œä¸ºä»€ä¹ˆæ˜¯<strong>åˆ é™¤ç¼“å­˜è€Œä¸æ˜¯æ›´æ–°ç¼“å­˜</strong>å‘¢ï¼Ÿæˆ‘ä»¬åœ¨æ“ä½œç¼“å­˜çš„æ—¶å€™ï¼Œåˆ°åº•åº”è¯¥åˆ é™¤ç¼“å­˜è¿˜æ˜¯æ›´æ–°ç¼“å­˜å‘¢ï¼Ÿæˆ‘ä»¬å…ˆæ¥çœ‹ä¸ªä¾‹å­ï¼š</p><p><img src="https://cdn.nlark.com/yuque/0/2023/webp/35838370/1682779116395-a6501b26-db7f-4d05-87f6-60706161333e.webp" alt="img"></p><ol><li>çº¿ç¨‹Aå…ˆå‘èµ·ä¸€ä¸ªå†™æ“ä½œï¼Œç¬¬ä¸€æ­¥å…ˆæ›´æ–°æ•°æ®åº“</li><li>çº¿ç¨‹Bå†å‘èµ·ä¸€ä¸ªå†™æ“ä½œï¼Œç¬¬äºŒæ­¥æ›´æ–°äº†æ•°æ®åº“</li><li>ç”±äºç½‘ç»œç­‰åŸå› ï¼Œçº¿ç¨‹Bå…ˆæ›´æ–°äº†ç¼“å­˜</li><li>çº¿ç¨‹Aåæ›´æ–°ç¼“å­˜ã€‚</li></ol><p>è¿™æ—¶å€™ï¼Œç¼“å­˜ä¿å­˜çš„æ˜¯Açš„æ•°æ®ï¼ˆè€æ•°æ®ï¼‰ï¼Œæ•°æ®åº“ä¿å­˜çš„æ˜¯Bçš„æ•°æ®ï¼ˆæ–°æ•°æ®ï¼‰ï¼Œæ•°æ®<strong>ä¸ä¸€è‡´</strong>äº†ï¼Œè„æ•°æ®å‡ºç°å•¦ã€‚å¦‚æœæ˜¯<strong>åˆ é™¤ç¼“å­˜å–ä»£æ›´æ–°ç¼“å­˜</strong>åˆ™ä¸ä¼šå‡ºç°è¿™ä¸ªè„æ•°æ®é—®é¢˜ã€‚</p><p><strong>æ›´æ–°ç¼“å­˜ç›¸å¯¹äºåˆ é™¤ç¼“å­˜</strong>ï¼Œè¿˜æœ‰ä¸¤ç‚¹åŠ£åŠ¿ï¼š</p><ul><li>å¦‚æœä½ å†™å…¥çš„ç¼“å­˜å€¼ï¼Œæ˜¯ç»è¿‡å¤æ‚è®¡ç®—æ‰å¾—åˆ°çš„è¯ã€‚æ›´æ–°ç¼“å­˜é¢‘ç‡é«˜çš„è¯ï¼Œå°±æµªè´¹æ€§èƒ½å•¦ã€‚</li><li>åœ¨å†™æ•°æ®åº“åœºæ™¯å¤šï¼Œè¯»æ•°æ®åœºæ™¯å°‘çš„æƒ…å†µä¸‹ï¼Œæ•°æ®å¾ˆå¤šæ—¶å€™è¿˜æ²¡è¢«è¯»å–åˆ°ï¼Œåˆè¢«æ›´æ–°äº†ï¼Œè¿™ä¹Ÿæµªè´¹äº†æ€§èƒ½å‘¢(å®é™…ä¸Šï¼Œå†™å¤šçš„åœºæ™¯ï¼Œç”¨ç¼“å­˜ä¹Ÿä¸æ˜¯å¾ˆåˆ’ç®—äº†)</li></ul><h4 id="3-1-3-åŒå†™çš„æƒ…å†µä¸‹ï¼Œå…ˆæ“ä½œæ•°æ®åº“è¿˜æ˜¯å…ˆæ“ä½œç¼“å­˜ï¼Ÿ"><a href="#3-1-3-åŒå†™çš„æƒ…å†µä¸‹ï¼Œå…ˆæ“ä½œæ•°æ®åº“è¿˜æ˜¯å…ˆæ“ä½œç¼“å­˜ï¼Ÿ" class="headerlink" title="3.1.3 åŒå†™çš„æƒ…å†µä¸‹ï¼Œå…ˆæ“ä½œæ•°æ®åº“è¿˜æ˜¯å…ˆæ“ä½œç¼“å­˜ï¼Ÿ"></a>3.1.3 åŒå†™çš„æƒ…å†µä¸‹ï¼Œå…ˆæ“ä½œæ•°æ®åº“è¿˜æ˜¯å…ˆæ“ä½œç¼“å­˜ï¼Ÿ</h4><p>Cache-Asideç¼“å­˜æ¨¡å¼ä¸­ï¼Œæœ‰äº›å°ä¼™ä¼´è¿˜æ˜¯æœ‰ç–‘é—®ï¼Œåœ¨å†™å…¥è¯·æ±‚çš„æ—¶å€™ï¼Œä¸ºä»€ä¹ˆæ˜¯<strong>å…ˆæ“ä½œæ•°æ®åº“å‘¢</strong>ï¼Ÿä¸ºä»€ä¹ˆ<strong>ä¸å…ˆæ“ä½œç¼“å­˜</strong>å‘¢ï¼Ÿ</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779117654-0e13d67f-a1bb-47ad-93a2-85dc01b9fa12.webp" alt="img"></p><ol><li>çº¿ç¨‹Aå‘èµ·ä¸€ä¸ªå†™æ“ä½œï¼Œç¬¬ä¸€æ­¥del cache</li><li>æ­¤æ—¶çº¿ç¨‹Bå‘èµ·ä¸€ä¸ªè¯»æ“ä½œï¼Œcache miss</li><li>çº¿ç¨‹Bç»§ç»­è¯»DBï¼Œè¯»å‡ºæ¥ä¸€ä¸ªè€æ•°æ®</li><li>ç„¶åçº¿ç¨‹BæŠŠè€æ•°æ®è®¾ç½®å…¥cache</li><li>çº¿ç¨‹Aå†™å…¥DBæœ€æ–°çš„æ•°æ®</li></ol><p>é…±ç´«å°±æœ‰é—®é¢˜å•¦ï¼Œ<strong>ç¼“å­˜å’Œæ•°æ®åº“çš„æ•°æ®ä¸ä¸€è‡´äº†ã€‚ç¼“å­˜ä¿å­˜çš„æ˜¯è€æ•°æ®ï¼Œæ•°æ®åº“ä¿å­˜çš„æ˜¯æ–°æ•°æ®</strong>ã€‚å› æ­¤ï¼ŒCache-Aside ç¼“å­˜æ¨¡å¼ï¼Œé€‰æ‹©äº†å…ˆæ“ä½œæ•°æ®åº“è€Œä¸æ˜¯å…ˆæ“ä½œç¼“å­˜ã€‚</p><h4 id="3-1-4-ç¼“å­˜å»¶æ—¶åŒåˆ "><a href="#3-1-4-ç¼“å­˜å»¶æ—¶åŒåˆ " class="headerlink" title="3.1.4 ç¼“å­˜å»¶æ—¶åŒåˆ "></a>3.1.4 ç¼“å­˜å»¶æ—¶åŒåˆ </h4><p>æœ‰äº›å°ä¼™ä¼´å¯èƒ½ä¼šè¯´ï¼Œä¸ä¸€å®šè¦å…ˆæ“ä½œæ•°æ®åº“å‘€ï¼Œé‡‡ç”¨<strong>ç¼“å­˜å»¶æ—¶åŒåˆ </strong>ç­–ç•¥å°±å¥½å•¦ï¼Ÿä»€ä¹ˆæ˜¯å»¶æ—¶åŒåˆ å‘¢ï¼Ÿ</p><ol><li>å…ˆåˆ é™¤ç¼“å­˜</li><li>å†æ›´æ–°æ•°æ®åº“</li><li>ä¼‘çœ ä¸€ä¼šï¼ˆæ¯”å¦‚1ç§’ï¼‰ï¼Œå†æ¬¡åˆ é™¤ç¼“å­˜ã€‚</li></ol><p>è¿™ä¸ªä¼‘çœ ä¸€ä¼šï¼Œä¸€èˆ¬å¤šä¹…å‘¢ï¼Ÿéƒ½æ˜¯1ç§’ï¼Ÿ</p><p>è¿™ä¸ªä¼‘çœ æ—¶é—´ &#x3D; è¯»ä¸šåŠ¡é€»è¾‘æ•°æ®çš„è€—æ—¶ + å‡ ç™¾æ¯«ç§’ã€‚ ä¸ºäº†ç¡®ä¿è¯»è¯·æ±‚ç»“æŸï¼Œå†™è¯·æ±‚å¯ä»¥åˆ é™¤è¯»è¯·æ±‚å¯èƒ½å¸¦æ¥çš„ç¼“å­˜è„æ•°æ®ã€‚</p><h4 id="3-1-5-åˆ é™¤ç¼“å­˜é‡è¯•æœºåˆ¶"><a href="#3-1-5-åˆ é™¤ç¼“å­˜é‡è¯•æœºåˆ¶" class="headerlink" title="3.1.5 åˆ é™¤ç¼“å­˜é‡è¯•æœºåˆ¶"></a>3.1.5 åˆ é™¤ç¼“å­˜é‡è¯•æœºåˆ¶</h4><p>ä¸ç®¡æ˜¯<strong>å»¶æ—¶åŒåˆ </strong>è¿˜æ˜¯<strong>Cache-Asideçš„å…ˆæ“ä½œæ•°æ®åº“å†åˆ é™¤ç¼“å­˜</strong>ï¼Œå¦‚æœç¬¬äºŒæ­¥çš„åˆ é™¤ç¼“å­˜å¤±è´¥å‘¢ï¼Œåˆ é™¤å¤±è´¥ä¼šå¯¼è‡´è„æ•°æ®å“¦~</p><p><img src="https://cdn.nlark.com/yuque/0/2023/webp/35838370/1682779117889-0a62c399-8c30-4227-9a71-ef940b73fba0.webp" alt="img"></p><p>åˆ é™¤ç¼“å­˜é‡è¯•æœºåˆ¶ï¼Œä¼šé€ æˆå¾ˆå¤šä¸šåŠ¡ä»£ç å…¥ä¾µã€‚å…¶å®ä¹Ÿå¯ä»¥é€šè¿‡ æ•°æ®åº“çš„CDC æ¥å¼‚æ­¥æ·˜æ±° Keyã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€äº›é‡è¯•æœºåˆ¶ï¼Œç¡®ä¿ redis key è¢«åˆ é™¤äº†</p><h5 id="é˜Ÿåˆ—-é‡è¯•æœºåˆ¶"><a href="#é˜Ÿåˆ—-é‡è¯•æœºåˆ¶" class="headerlink" title="é˜Ÿåˆ—+é‡è¯•æœºåˆ¶"></a>é˜Ÿåˆ—+é‡è¯•æœºåˆ¶</h5><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779118664-a9c22f28-ced6-4e2d-a840-99031155209e.png" alt="img"></p><p>æµç¨‹å¦‚ä¸‹æ‰€ç¤º</p><ul><li>æ›´æ–°æ•°æ®åº“æ•°æ®</li><li>ç¼“å­˜å› ä¸ºç§ç§é—®é¢˜åˆ é™¤å¤±è´¥</li><li>å°†éœ€è¦åˆ é™¤çš„keyå‘é€è‡³æ¶ˆæ¯é˜Ÿåˆ—</li><li>è‡ªå·±æ¶ˆè´¹æ¶ˆæ¯ï¼Œè·å¾—éœ€è¦åˆ é™¤çš„key</li><li>ç»§ç»­é‡è¯•åˆ é™¤æ“ä½œï¼Œç›´åˆ°æˆåŠŸ</li></ul><p>ç„¶è€Œï¼Œè¯¥æ–¹æ¡ˆæœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œå¯¹ä¸šåŠ¡çº¿ä»£ç é€ æˆå¤§é‡çš„ä¾µå…¥ã€‚äºæ˜¯æœ‰äº†æ–¹æ¡ˆäºŒï¼Œåœ¨æ–¹æ¡ˆäºŒä¸­ï¼Œå¯åŠ¨ä¸€ä¸ªè®¢é˜…ç¨‹åºå»è®¢é˜…æ•°æ®åº“çš„binlogï¼Œè·å¾—éœ€è¦æ“ä½œçš„æ•°æ®ã€‚åœ¨åº”ç”¨ç¨‹åºä¸­ï¼Œå¦èµ·ä¸€æ®µç¨‹åºï¼Œè·å¾—è¿™ä¸ªè®¢é˜…ç¨‹åºä¼ æ¥çš„ä¿¡æ¯ï¼Œè¿›è¡Œåˆ é™¤ç¼“å­˜æ“ä½œã€‚</p><h5 id="åŸºäºè®¢é˜…binlogçš„åŒæ­¥æœºåˆ¶"><a href="#åŸºäºè®¢é˜…binlogçš„åŒæ­¥æœºåˆ¶" class="headerlink" title="åŸºäºè®¢é˜…binlogçš„åŒæ­¥æœºåˆ¶"></a>åŸºäºè®¢é˜…binlogçš„åŒæ­¥æœºåˆ¶</h5><p><img src="https://cdn.nlark.com/yuque/0/2023/png/35838370/1682779118663-d1ce53ca-9fdb-4552-89cc-0f3b181677a5.png" alt="img"><strong>æŠ€æœ¯æ•´ä½“æ€è·¯</strong>ï¼š</p><p>MySQL binlogå¢é‡è®¢é˜…æ¶ˆè´¹+æ¶ˆæ¯é˜Ÿåˆ—+å¢é‡æ•°æ®æ›´æ–°åˆ°redis</p><p>1ï¼‰è¯»Redisï¼šçƒ­æ•°æ®åŸºæœ¬éƒ½åœ¨Redis</p><p>2ï¼‰å†™MySQL: å¢åˆ æ”¹éƒ½æ˜¯æ“ä½œMySQL</p><p>3ï¼‰æ›´æ–°Redisæ•°æ®ï¼šMySQçš„æ•°æ®æ“ä½œbinlogï¼Œæ¥æ›´æ–°åˆ°Redis</p><p><strong>Redisæ›´æ–°</strong></p><p>1ï¼‰<strong>æ•°æ®æ“ä½œ</strong>ä¸»è¦åˆ†ä¸ºä¸¤å¤§å—ï¼š</p><ul><li>ä¸€ä¸ªæ˜¯å…¨é‡(å°†å…¨éƒ¨æ•°æ®ä¸€æ¬¡å†™å…¥åˆ°redis)</li><li>ä¸€ä¸ªæ˜¯å¢é‡ï¼ˆå®æ—¶æ›´æ–°ï¼‰</li></ul><p>è¿™é‡Œè¯´çš„æ˜¯å¢é‡,æŒ‡çš„æ˜¯mysqlçš„updateã€insertã€delateå˜æ›´æ•°æ®ã€‚</p><p>2ï¼‰<strong>è¯»å–binlogååˆ†æ ï¼Œåˆ©ç”¨æ¶ˆæ¯é˜Ÿåˆ—,æ¨é€æ›´æ–°å„å°çš„redisç¼“å­˜æ•°æ®</strong>ã€‚</p><p>è¿™æ ·ä¸€æ—¦MySQLä¸­äº§ç”Ÿäº†æ–°çš„å†™å…¥ã€æ›´æ–°ã€åˆ é™¤ç­‰æ“ä½œï¼Œå°±å¯ä»¥æŠŠbinlogç›¸å…³çš„æ¶ˆæ¯æ¨é€è‡³Redisï¼ŒRediså†æ ¹æ®binlogä¸­çš„è®°å½•ï¼Œå¯¹Redisè¿›è¡Œæ›´æ–°ã€‚</p><p>å…¶å®è¿™ç§æœºåˆ¶ï¼Œå¾ˆç±»ä¼¼MySQLçš„ä¸»ä»å¤‡ä»½æœºåˆ¶ï¼Œå› ä¸ºMySQLçš„ä¸»å¤‡ä¹Ÿæ˜¯é€šè¿‡binlogæ¥å®ç°çš„æ•°æ®ä¸€è‡´æ€§ã€‚</p><p>è¿™é‡Œå¯ä»¥ç»“åˆä½¿ç”¨canal(é˜¿é‡Œçš„ä¸€æ¬¾å¼€æºæ¡†æ¶)ï¼Œé€šè¿‡è¯¥æ¡†æ¶å¯ä»¥å¯¹MySQLçš„binlogè¿›è¡Œè®¢é˜…ï¼Œè€Œcanalæ­£æ˜¯æ¨¡ä»¿äº†mysqlçš„slaveæ•°æ®åº“çš„å¤‡ä»½è¯·æ±‚ï¼Œä½¿å¾—Redisçš„æ•°æ®æ›´æ–°è¾¾åˆ°äº†ç›¸åŒçš„æ•ˆæœã€‚</p><p>å½“ç„¶ï¼Œè¿™é‡Œçš„æ¶ˆæ¯æ¨é€å·¥å…·ä½ ä¹Ÿå¯ä»¥é‡‡ç”¨åˆ«çš„ç¬¬ä¸‰æ–¹ï¼škafkaã€rabbitMQç­‰æ¥å®ç°æ¨é€æ›´æ–°Redisã€‚</p><h3 id="3-2-ç¼“å­˜é›ªå´©ã€ç©¿é€ã€å‡»ç©¿ã€æ±¡æŸ“"><a href="#3-2-ç¼“å­˜é›ªå´©ã€ç©¿é€ã€å‡»ç©¿ã€æ±¡æŸ“" class="headerlink" title="3.2 ç¼“å­˜é›ªå´©ã€ç©¿é€ã€å‡»ç©¿ã€æ±¡æŸ“"></a>3.2 ç¼“å­˜é›ªå´©ã€ç©¿é€ã€å‡»ç©¿ã€æ±¡æŸ“</h3><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1683633583708-42a49740-34d1-42e6-a6e8-8489be91fc87.png" alt="img"></p><h4 id="3-2-1-ç¼“å­˜é›ªå´©"><a href="#3-2-1-ç¼“å­˜é›ªå´©" class="headerlink" title="3.2.1 ç¼“å­˜é›ªå´©"></a>3.2.1 ç¼“å­˜é›ªå´©</h4><p>å¯¹äºç³»ç»Ÿ Aï¼Œå‡è®¾æ¯å¤©é«˜å³°æœŸæ¯ç§’ 5000 ä¸ªè¯·æ±‚ï¼Œæœ¬æ¥ç¼“å­˜åœ¨é«˜å³°æœŸå¯ä»¥æ‰›ä½æ¯ç§’ 4000 ä¸ªè¯·æ±‚ï¼Œä½†æ˜¯ç¼“å­˜æœºå™¨æ„å¤–å‘ç”Ÿäº†å…¨ç›˜å®•æœºã€‚ç¼“å­˜æŒ‚äº†ï¼Œæ­¤æ—¶ 1 ç§’ 5000 ä¸ªè¯·æ±‚å…¨éƒ¨è½æ•°æ®åº“ï¼Œæ•°æ®åº“å¿…ç„¶æ‰›ä¸ä½ï¼Œå®ƒä¼šæŠ¥ä¸€ä¸‹è­¦ï¼Œç„¶åå°±æŒ‚äº†ã€‚æ­¤æ—¶ï¼Œå¦‚æœæ²¡æœ‰é‡‡ç”¨ä»€ä¹ˆç‰¹åˆ«çš„æ–¹æ¡ˆæ¥å¤„ç†è¿™ä¸ªæ•…éšœï¼ŒDBA å¾ˆç€æ€¥ï¼Œé‡å¯æ•°æ®åº“ï¼Œä½†æ˜¯æ•°æ®åº“ç«‹é©¬åˆè¢«æ–°çš„æµé‡ç»™æ‰“æ­»äº†ã€‚æˆ–è€…ç¼“å­˜ä¸­ æ•°æ®å¤§æ‰¹é‡åˆ°è¿‡æœŸæ—¶é—´ï¼Œå¤§æ‰¹é‡æ•°æ®åŒæ—¶æŸ¥è¯¢æ•°æ®åº“ï¼Œå¼•èµ·æ•°æ®åº“å‹åŠ›è¿‡å¤§ç”šè‡³å®•æœºã€‚</p><p>è¿™å°±æ˜¯ç¼“å­˜é›ªå´©ã€‚</p><p><a href="https://github.com/doocs/advanced-java/blob/main/docs/high-concurrency/images/redis-caching-avalanche.png"><img src="https://github.com/doocs/advanced-java/raw/main/docs/high-concurrency/images/redis-caching-avalanche.png" alt="img"></a></p><p>å¤§çº¦åœ¨ 3 å¹´å‰ï¼Œå›½å†…æ¯”è¾ƒçŸ¥åçš„ä¸€ä¸ªäº’è”ç½‘å…¬å¸ï¼Œæ›¾å› ä¸ºç¼“å­˜äº‹æ•…ï¼Œå¯¼è‡´é›ªå´©ï¼Œåå°ç³»ç»Ÿå…¨éƒ¨å´©æºƒï¼Œäº‹æ•…ä»å½“å¤©ä¸‹åˆæŒç»­åˆ°æ™šä¸Šå‡Œæ™¨ 3~4 ç‚¹ï¼Œå…¬å¸æŸå¤±äº†å‡ åƒä¸‡ã€‚</p><p>ç¼“å­˜é›ªå´©çš„äº‹å‰äº‹ä¸­äº‹åçš„è§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼š</p><ul><li>äº‹å‰ï¼šRedis é«˜å¯ç”¨ï¼Œä¸»ä»+å“¨å…µï¼ŒRedis clusterï¼Œé¿å…å…¨ç›˜å´©æºƒã€‚</li><li>äº‹ä¸­ï¼šæœ¬åœ° ehcache ç¼“å­˜ + hystrix é™æµ&amp;é™çº§ï¼Œé¿å… MySQL è¢«æ‰“æ­»ã€‚</li><li>äº‹åï¼šRedis æŒä¹…åŒ–ï¼Œä¸€æ—¦é‡å¯ï¼Œè‡ªåŠ¨ä»ç£ç›˜ä¸ŠåŠ è½½æ•°æ®ï¼Œå¿«é€Ÿæ¢å¤ç¼“å­˜æ•°æ®ã€‚</li></ul><p>é™¤æ­¤ä¹‹å¤–å®é™…ä½¿ç”¨æ—¶ï¼š</p><ul><li>ç¼“å­˜æ•°æ®çš„è¿‡æœŸæ—¶é—´è®¾ç½®éšæœºï¼Œé˜²æ­¢åŒä¸€æ—¶é—´å¤§é‡æ•°æ®è¿‡æœŸç°è±¡å‘ç”Ÿã€‚</li><li>å¦‚æœç¼“å­˜æ•°æ®åº“æ˜¯åˆ†å¸ƒå¼éƒ¨ç½²ï¼Œå°†çƒ­ç‚¹æ•°æ®å‡åŒ€åˆ†å¸ƒåœ¨ä¸åŒçš„ç¼“å­˜æ•°æ®åº“ä¸­ã€‚</li><li>çƒ­ç‚¹æ•°æ®çš„è¿‡æœŸæ—¶é—´å°½é‡è®¾ç½®é•¿</li></ul><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/redis-caching-avalanche-solution.png" alt="img"></p><p>ç”¨æˆ·å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œç³»ç»Ÿ A æ”¶åˆ°è¯·æ±‚åï¼Œå…ˆæŸ¥æœ¬åœ° ehcache ç¼“å­˜ï¼Œå¦‚æœæ²¡æŸ¥åˆ°å†æŸ¥ Redisã€‚å¦‚æœ ehcache å’Œ Redis éƒ½æ²¡æœ‰ï¼Œå†æŸ¥æ•°æ®åº“ï¼Œå°†æ•°æ®åº“ä¸­çš„ç»“æœï¼Œå†™å…¥ ehcache å’Œ Redis ä¸­ã€‚</p><p>é™æµç»„ä»¶ï¼Œå¯ä»¥è®¾ç½®æ¯ç§’çš„è¯·æ±‚ï¼Œæœ‰å¤šå°‘èƒ½é€šè¿‡ç»„ä»¶ï¼Œå‰©ä½™çš„æœªé€šè¿‡çš„è¯·æ±‚ï¼Œæ€ä¹ˆåŠï¼Ÿ<strong>èµ°é™çº§</strong>ï¼å¯ä»¥è¿”å›ä¸€äº›é»˜è®¤çš„å€¼ï¼Œæˆ–è€…å‹æƒ…æç¤ºï¼Œæˆ–è€…ç©ºå€¼ã€‚</p><p>å¥½å¤„ï¼š</p><ul><li>æ•°æ®åº“ç»å¯¹ä¸ä¼šæ­»ï¼Œé™æµç»„ä»¶ç¡®ä¿äº†æ¯ç§’åªæœ‰å¤šå°‘ä¸ªè¯·æ±‚èƒ½é€šè¿‡ã€‚</li><li>åªè¦æ•°æ®åº“ä¸æ­»ï¼Œå°±æ˜¯è¯´ï¼Œå¯¹ç”¨æˆ·æ¥è¯´ï¼Œ2&#x2F;5 çš„è¯·æ±‚éƒ½æ˜¯å¯ä»¥è¢«å¤„ç†çš„ã€‚</li><li>åªè¦æœ‰ 2&#x2F;5 çš„è¯·æ±‚å¯ä»¥è¢«å¤„ç†ï¼Œå°±æ„å‘³ç€ä½ çš„ç³»ç»Ÿæ²¡æ­»ï¼Œå¯¹ç”¨æˆ·æ¥è¯´ï¼Œå¯èƒ½å°±æ˜¯ç‚¹å‡»å‡ æ¬¡åˆ·ä¸å‡ºæ¥é¡µé¢ï¼Œä½†æ˜¯å¤šç‚¹å‡ æ¬¡ï¼Œå°±å¯ä»¥åˆ·å‡ºæ¥äº†ã€‚</li></ul><h4 id="3-2-2-ç¼“å­˜ç©¿é€"><a href="#3-2-2-ç¼“å­˜ç©¿é€" class="headerlink" title="3.2.2 ç¼“å­˜ç©¿é€"></a>3.2.2 ç¼“å­˜ç©¿é€</h4><p>å¯¹äºç³»ç»Ÿ Aï¼Œå‡è®¾ä¸€ç§’ 5000 ä¸ªè¯·æ±‚ï¼Œç»“æœå…¶ä¸­ 4000 ä¸ªè¯·æ±‚æ˜¯é»‘å®¢å‘å‡ºçš„æ¶æ„æ”»å‡»ã€‚</p><p>é»‘å®¢å‘å‡ºçš„é‚£ 4000 ä¸ªæ”»å‡»ï¼Œç¼“å­˜ä¸­æŸ¥ä¸åˆ°ï¼Œæ¯æ¬¡ä½ å»æ•°æ®åº“é‡ŒæŸ¥ï¼Œä¹ŸæŸ¥ä¸åˆ°ã€‚</p><p>ä¸¾ä¸ªæ —å­ã€‚æ•°æ®åº“ id æ˜¯ä» 1 å¼€å§‹çš„ï¼Œç»“æœé»‘å®¢å‘è¿‡æ¥çš„è¯·æ±‚ id å…¨éƒ¨éƒ½æ˜¯è´Ÿæ•°ã€‚è¿™æ ·çš„è¯ï¼Œç¼“å­˜ä¸­ä¸ä¼šæœ‰ï¼Œè¯·æ±‚æ¯æ¬¡éƒ½â€œ<strong>è§†ç¼“å­˜äºæ— ç‰©</strong>â€ï¼Œç›´æ¥æŸ¥è¯¢æ•°æ®åº“ã€‚è¿™ç§æ¶æ„æ”»å‡»åœºæ™¯çš„ç¼“å­˜ç©¿é€å°±ä¼šç›´æ¥æŠŠæ•°æ®åº“ç»™æ‰“æ­»ã€‚</p><p><a href="https://github.com/doocs/advanced-java/blob/main/docs/high-concurrency/images/redis-caching-penetration.png"><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/redis-caching-penetration.png" alt="img"></a></p><p>è§£å†³æ–¹æ¡ˆï¼š</p><ul><li>è®¾ç½®ç©ºå€¼è§£å†³æ–¹å¼å¾ˆç®€å•ï¼Œæ¯æ¬¡ç³»ç»Ÿ A ä»æ•°æ®åº“ä¸­åªè¦æ²¡æŸ¥åˆ°ï¼Œå°±å†™ä¸€ä¸ªç©ºå€¼åˆ°ç¼“å­˜é‡Œå»ï¼Œæ¯”å¦‚ set -999 UNKNOWN ã€‚ç„¶åè®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œè¿™æ ·çš„è¯ï¼Œä¸‹æ¬¡æœ‰ç›¸åŒçš„ key æ¥è®¿é—®çš„æ—¶å€™ï¼Œåœ¨ç¼“å­˜å¤±æ•ˆä¹‹å‰ï¼Œéƒ½å¯ä»¥ç›´æ¥ä»ç¼“å­˜ä¸­å–æ•°æ®ã€‚</li></ul><p><a href="https://github.com/doocs/advanced-java/blob/main/docs/high-concurrency/images/redis-caching-avoid-penetration.png"><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/redis-caching-avoid-penetration.png" alt="img"></a></p><ul><li><p>å¸ƒéš†è¿‡æ»¤å™¨ã€‚å½“ç„¶ï¼Œå¦‚æœé»‘å®¢å¦‚æœæ¯æ¬¡ä½¿ç”¨ä¸åŒçš„è´Ÿæ•° id æ¥æ”»å‡»ï¼Œå†™ç©ºå€¼çš„æ–¹æ³•å¯èƒ½å°±ä¸å¥æ•ˆäº†ã€‚æ›´ä¸ºç»å¸¸çš„åšæ³•æ˜¯åœ¨ç¼“å­˜ä¹‹å‰å¢åŠ å¸ƒéš†è¿‡æ»¤å™¨ï¼Œå°†æ•°æ®åº“ä¸­æ‰€æœ‰å¯èƒ½çš„æ•°æ®å“ˆå¸Œæ˜ å°„åˆ°å¸ƒéš†è¿‡æ»¤å™¨ä¸­ã€‚ç„¶åå¯¹æ¯ä¸ªè¯·æ±‚è¿›è¡Œå¦‚ä¸‹åˆ¤æ–­ï¼šä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨èƒ½å¤Ÿå¯¹è®¿é—®çš„è¯·æ±‚èµ·åˆ°äº†ä¸€å®šçš„åˆç­›ä½œç”¨ï¼Œé¿å…äº†å› æ•°æ®ä¸å­˜åœ¨å¼•èµ·çš„æŸ¥è¯¢å‹åŠ›ã€‚</p></li><li><ul><li>è¯·æ±‚æ•°æ®çš„ key ä¸å­˜åœ¨äºå¸ƒéš†è¿‡æ»¤å™¨ä¸­ï¼Œå¯ä»¥ç¡®å®šæ•°æ®å°±ä¸€å®šä¸ä¼šå­˜åœ¨äºæ•°æ®åº“ä¸­ï¼Œç³»ç»Ÿå¯ä»¥ç«‹å³è¿”å›ä¸å­˜åœ¨ã€‚</li><li>è¯·æ±‚æ•°æ®çš„ key å­˜åœ¨äºå¸ƒéš†è¿‡æ»¤å™¨ä¸­ï¼Œåˆ™ç»§ç»­å†å‘ç¼“å­˜ä¸­æŸ¥è¯¢ã€‚</li></ul></li><li><p>Keyæ ¡éªŒå¯¹æ‰€æœ‰å¯èƒ½æŸ¥è¯¢çš„å‚æ•°ä»¥hashå½¢å¼å­˜å‚¨ï¼Œåœ¨æ§åˆ¶å±‚å…ˆè¿›è¡Œæ ¡éªŒï¼Œä¸ç¬¦åˆåˆ™ä¸¢å¼ƒã€‚</p></li></ul><h4 id="3-2-3-ç¼“å­˜å‡»ç©¿"><a href="#3-2-3-ç¼“å­˜å‡»ç©¿" class="headerlink" title="3.2.3 ç¼“å­˜å‡»ç©¿"></a>3.2.3 ç¼“å­˜å‡»ç©¿</h4><p>ç¼“å­˜å‡»ç©¿ï¼Œå°±æ˜¯è¯´æŸä¸ª key éå¸¸çƒ­ç‚¹ï¼Œè®¿é—®éå¸¸é¢‘ç¹ï¼Œå¤„äºé›†ä¸­å¼é«˜å¹¶å‘è®¿é—®çš„æƒ…å†µï¼Œå½“è¿™ä¸ª key åœ¨å¤±æ•ˆçš„ç¬é—´ï¼Œå¤§é‡çš„è¯·æ±‚å°±å‡»ç©¿äº†ç¼“å­˜ï¼Œç›´æ¥è¯·æ±‚æ•°æ®åº“ï¼Œå°±åƒæ˜¯åœ¨ä¸€é“å±éšœä¸Šå‡¿å¼€äº†ä¸€ä¸ªæ´ã€‚</p><p>ä¸åŒåœºæ™¯ä¸‹çš„è§£å†³æ–¹å¼å¯å¦‚ä¸‹ï¼š</p><ul><li>è‹¥ç¼“å­˜çš„æ•°æ®æ˜¯åŸºæœ¬ä¸ä¼šå‘ç”Ÿæ›´æ–°çš„ï¼Œåˆ™å¯å°è¯•å°†è¯¥çƒ­ç‚¹æ•°æ®è®¾ç½®ä¸ºæ°¸ä¸è¿‡æœŸã€‚</li><li>è‹¥ç¼“å­˜çš„æ•°æ®æ›´æ–°ä¸é¢‘ç¹ï¼Œä¸”ç¼“å­˜åˆ·æ–°çš„æ•´ä¸ªæµç¨‹è€—æ—¶è¾ƒå°‘çš„æƒ…å†µä¸‹ï¼Œåˆ™å¯ä»¥é‡‡ç”¨åŸºäº Redisã€zookeeper ç­‰åˆ†å¸ƒå¼ä¸­é—´ä»¶çš„åˆ†å¸ƒå¼äº’æ–¥é”ï¼Œæˆ–è€…æœ¬åœ°äº’æ–¥é”ä»¥ä¿è¯ä»…å°‘é‡çš„è¯·æ±‚èƒ½è¯·æ±‚æ•°æ®åº“å¹¶é‡æ–°æ„å»ºç¼“å­˜ï¼Œå…¶ä½™çº¿ç¨‹åˆ™åœ¨é”é‡Šæ”¾åèƒ½è®¿é—®åˆ°æ–°ç¼“å­˜ã€‚åœ¨ç¼“å­˜å¤±æ•ˆåï¼Œé€šè¿‡åŠ é”æˆ–è€…é˜Ÿåˆ—æ¥æ§åˆ¶è¯»æ•°æ®åº“å†™ç¼“å­˜çš„çº¿ç¨‹æ•°é‡ã€‚æ¯”å¦‚å¯¹æŸä¸ªkeyåªå…è®¸ä¸€ä¸ªçº¿ç¨‹æŸ¥è¯¢æ•°æ®å’Œå†™ç¼“å­˜ï¼Œå…¶ä»–çº¿ç¨‹ç­‰å¾…ã€‚</li><li>è‹¥ç¼“å­˜çš„æ•°æ®æ›´æ–°é¢‘ç¹æˆ–è€…åœ¨ç¼“å­˜åˆ·æ–°çš„æµç¨‹è€—æ—¶è¾ƒé•¿çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥åˆ©ç”¨å®šæ—¶çº¿ç¨‹åœ¨ç¼“å­˜è¿‡æœŸå‰ä¸»åŠ¨åœ°é‡æ–°æ„å»ºç¼“å­˜æˆ–è€…å»¶åç¼“å­˜çš„è¿‡æœŸæ—¶é—´ï¼Œä»¥ä¿è¯æ‰€æœ‰çš„è¯·æ±‚èƒ½ä¸€ç›´è®¿é—®åˆ°å¯¹åº”çš„ç¼“å­˜ã€‚</li></ul><h4 id="3-2-4-ç¼“å­˜æ±¡æŸ“"><a href="#3-2-4-ç¼“å­˜æ±¡æŸ“" class="headerlink" title="3.2.4 ç¼“å­˜æ±¡æŸ“"></a>3.2.4 ç¼“å­˜æ±¡æŸ“</h4><p>ç¼“å­˜æ±¡æŸ“é—®é¢˜è¯´çš„æ˜¯ç¼“å­˜ä¸­ä¸€äº›åªä¼šè¢«è®¿é—®ä¸€æ¬¡æˆ–è€…å‡ æ¬¡çš„çš„æ•°æ®ï¼Œè¢«è®¿é—®å®Œåï¼Œå†ä¹Ÿä¸ä¼šè¢«è®¿é—®åˆ°ï¼Œä½†è¿™éƒ¨åˆ†æ•°æ®ä¾ç„¶ç•™å­˜åœ¨ç¼“å­˜ä¸­ï¼Œæ¶ˆè€—ç¼“å­˜ç©ºé—´ã€‚</p><p>ç¼“å­˜æ±¡æŸ“ä¼šéšç€æ•°æ®çš„æŒç»­å¢åŠ è€Œé€æ¸æ˜¾éœ²ï¼Œéšç€æœåŠ¡çš„ä¸æ–­è¿è¡Œï¼Œç¼“å­˜ä¸­ä¼šå­˜åœ¨å¤§é‡çš„æ°¸è¿œä¸ä¼šå†æ¬¡è¢«è®¿é—®çš„æ•°æ®ã€‚ç¼“å­˜ç©ºé—´æ˜¯æœ‰é™çš„ï¼Œå¦‚æœç¼“å­˜ç©ºé—´æ»¡äº†ï¼Œå†å¾€ç¼“å­˜é‡Œå†™æ•°æ®æ—¶å°±ä¼šæœ‰é¢å¤–å¼€é”€ï¼Œå½±å“Redisæ€§èƒ½ã€‚è¿™éƒ¨åˆ†é¢å¤–å¼€é”€ä¸»è¦æ˜¯æŒ‡å†™çš„æ—¶å€™åˆ¤æ–­æ·˜æ±°ç­–ç•¥ï¼Œæ ¹æ®æ·˜æ±°ç­–ç•¥å»é€‰æ‹©è¦æ·˜æ±°çš„æ•°æ®ï¼Œç„¶åè¿›è¡Œåˆ é™¤æ“ä½œã€‚</p><h5 id="ç¼“å­˜æ·˜æ±°ç­–ç•¥"><a href="#ç¼“å­˜æ·˜æ±°ç­–ç•¥" class="headerlink" title="ç¼“å­˜æ·˜æ±°ç­–ç•¥"></a>ç¼“å­˜æ·˜æ±°ç­–ç•¥</h5><p>Rediså…±æ”¯æŒå…«ç§æ·˜æ±°ç­–ç•¥ï¼Œåˆ†åˆ«æ˜¯noevictionã€volatile-randomã€volatile-ttlã€volatile-lruã€volatile-lfuã€allkeys-lruã€allkeys-random å’Œ allkeys-lfu ç­–ç•¥ã€‚</p><p><strong>æ€ä¹ˆç†è§£å‘¢</strong>ï¼Ÿä¸»è¦çœ‹åˆ†ä¸‰ç±»çœ‹ï¼š</p><ul><li><p>ä¸æ·˜æ±° </p></li><li><ul><li>noeviction ï¼ˆv4.0åé»˜è®¤çš„ï¼‰</li></ul></li><li><p>å¯¹è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„æ•°æ®ä¸­è¿›è¡Œæ·˜æ±° </p></li><li><ul><li>éšæœºï¼švolatile-random</li><li>ttlï¼švolatile-ttl</li><li>lruï¼švolatile-lru</li><li>lfuï¼švolatile-lfu</li></ul></li><li><p>å…¨éƒ¨æ•°æ®è¿›è¡Œæ·˜æ±° </p></li><li><ul><li>éšæœºï¼šallkeys-random</li><li>lruï¼šallkeys-lru</li><li>lfuï¼šallkeys-lfu</li></ul></li></ul><ol><li>noevictionè¯¥ç­–ç•¥æ˜¯Redisçš„é»˜è®¤ç­–ç•¥ã€‚åœ¨è¿™ç§ç­–ç•¥ä¸‹ï¼Œä¸€æ—¦ç¼“å­˜è¢«å†™æ»¡äº†ï¼Œå†æœ‰å†™è¯·æ±‚æ¥æ—¶ï¼ŒRedis ä¸å†æä¾›æœåŠ¡ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›é”™è¯¯ã€‚è¿™ç§ç­–ç•¥ä¸ä¼šæ·˜æ±°æ•°æ®ï¼Œæ‰€ä»¥æ— æ³•è§£å†³ç¼“å­˜æ±¡æŸ“é—®é¢˜ã€‚ä¸€èˆ¬ç”Ÿäº§ç¯å¢ƒä¸å»ºè®®ä½¿ç”¨ã€‚å…¶ä»–ä¸ƒç§è§„åˆ™éƒ½ä¼šæ ¹æ®è‡ªå·±ç›¸åº”çš„è§„åˆ™æ¥é€‰æ‹©æ•°æ®è¿›è¡Œåˆ é™¤æ“ä½œã€‚</li><li>volatile-randomã€‚è¿™ä¸ªç®—æ³•æ¯”è¾ƒç®€å•ï¼Œåœ¨è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®å€¼å¯¹ä¸­ï¼Œè¿›è¡Œéšæœºåˆ é™¤ã€‚å› ä¸ºæ˜¯éšæœºåˆ é™¤ï¼Œæ— æ³•æŠŠä¸å†è®¿é—®çš„æ•°æ®ç­›é€‰å‡ºæ¥ï¼Œæ‰€ä»¥å¯èƒ½ä¾ç„¶ä¼šå­˜åœ¨ç¼“å­˜æ±¡æŸ“ç°è±¡ï¼Œæ— æ³•è§£å†³ç¼“å­˜æ±¡æŸ“é—®é¢˜ã€‚</li><li>volatile-ttlã€‚è¿™ç§ç®—æ³•åˆ¤æ–­æ·˜æ±°æ•°æ®æ—¶å‚è€ƒçš„æŒ‡æ ‡æ¯”éšæœºåˆ é™¤æ—¶å¤šè¿›è¡Œä¸€æ­¥è¿‡æœŸæ—¶é—´çš„æ’åºã€‚Redisåœ¨ç­›é€‰éœ€åˆ é™¤çš„æ•°æ®æ—¶ï¼Œè¶Šæ—©è¿‡æœŸçš„æ•°æ®è¶Šä¼˜å…ˆè¢«é€‰æ‹©ã€‚</li><li>volatile-lruã€‚LRUç®—æ³•ï¼šLRU ç®—æ³•çš„å…¨ç§°æ˜¯ Least Recently Usedï¼ŒæŒ‰ç…§æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„åŸåˆ™æ¥ç­›é€‰æ•°æ®ã€‚è¿™ç§æ¨¡å¼ä¸‹ä¼šä½¿ç”¨ LRU ç®—æ³•ç­›é€‰è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®å€¼å¯¹ã€‚Redisä¼˜åŒ–çš„ <strong>LRUç®—æ³•å®ç°</strong>ï¼šRedisä¼šè®°å½•æ¯ä¸ªæ•°æ®çš„æœ€è¿‘ä¸€æ¬¡è¢«è®¿é—®çš„æ—¶é—´æˆ³ã€‚åœ¨Redisåœ¨å†³å®šæ·˜æ±°çš„æ•°æ®æ—¶ï¼Œç¬¬ä¸€æ¬¡ä¼šéšæœºé€‰å‡º N ä¸ªæ•°æ®ï¼ŒæŠŠå®ƒä»¬ä½œä¸ºä¸€ä¸ªå€™é€‰é›†åˆã€‚æ¥ä¸‹æ¥ï¼ŒRedis ä¼šæ¯”è¾ƒè¿™ N ä¸ªæ•°æ®çš„ lru å­—æ®µï¼ŒæŠŠ lru å­—æ®µå€¼æœ€å°çš„æ•°æ®ä»ç¼“å­˜ä¸­æ·˜æ±°å‡ºå»ã€‚é€šè¿‡éšæœºè¯»å–å¾…åˆ é™¤é›†åˆï¼Œå¯ä»¥è®©Redisä¸ç”¨ç»´æŠ¤ä¸€ä¸ªå·¨å¤§çš„é“¾è¡¨ï¼Œä¹Ÿä¸ç”¨æ“ä½œé“¾è¡¨ï¼Œè¿›è€Œæå‡æ€§èƒ½ã€‚Redis é€‰å‡ºçš„æ•°æ®ä¸ªæ•° Nï¼Œé€šè¿‡ é…ç½®å‚æ•° maxmemory-samples è¿›è¡Œé…ç½®ã€‚ä¸ªæ•°Nè¶Šå¤§ï¼Œåˆ™å€™é€‰é›†åˆè¶Šå¤§ï¼Œé€‰æ‹©åˆ°çš„æœ€ä¹…æœªè¢«ä½¿ç”¨çš„å°±æ›´å‡†ç¡®ï¼ŒNè¶Šå°ï¼Œé€‰æ‹©åˆ°æœ€ä¹…æœªè¢«ä½¿ç”¨çš„æ•°æ®çš„æ¦‚ç‡ä¹Ÿä¼šéšä¹‹å‡å°ã€‚</li><li>volatile-lfuã€‚ä¼šä½¿ç”¨ LFU ç®—æ³•é€‰æ‹©è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®å€¼å¯¹ã€‚<strong>LFU ç®—æ³•</strong>ï¼šLFU ç¼“å­˜ç­–ç•¥æ˜¯åœ¨ LRU ç­–ç•¥åŸºç¡€ä¸Šï¼Œä¸ºæ¯ä¸ªæ•°æ®å¢åŠ äº†ä¸€ä¸ªè®¡æ•°å™¨ï¼Œæ¥ç»Ÿè®¡è¿™ä¸ªæ•°æ®çš„è®¿é—®æ¬¡æ•°ã€‚å½“ä½¿ç”¨ LFU ç­–ç•¥ç­›é€‰æ·˜æ±°æ•°æ®æ—¶ï¼Œé¦–å…ˆä¼šæ ¹æ®æ•°æ®çš„è®¿é—®æ¬¡æ•°è¿›è¡Œç­›é€‰ï¼ŒæŠŠè®¿é—®æ¬¡æ•°æœ€ä½çš„æ•°æ®æ·˜æ±°å‡ºç¼“å­˜ã€‚å¦‚æœä¸¤ä¸ªæ•°æ®çš„è®¿é—®æ¬¡æ•°ç›¸åŒï¼ŒLFU ç­–ç•¥å†æ¯”è¾ƒè¿™ä¸¤ä¸ªæ•°æ®çš„è®¿é—®æ—¶æ•ˆæ€§ï¼ŒæŠŠè·ç¦»ä¸Šä¸€æ¬¡è®¿é—®æ—¶é—´æ›´ä¹…çš„æ•°æ®æ·˜æ±°å‡ºç¼“å­˜ã€‚ Redisçš„LFUç®—æ³•å®ç°:å½“ LFU ç­–ç•¥ç­›é€‰æ•°æ®æ—¶ï¼ŒRedis ä¼šåœ¨å€™é€‰é›†åˆä¸­ï¼Œæ ¹æ®æ•°æ® lru å­—æ®µçš„å 8bit é€‰æ‹©è®¿é—®æ¬¡æ•°æœ€å°‘çš„æ•°æ®è¿›è¡Œæ·˜æ±°ã€‚å½“è®¿é—®æ¬¡æ•°ç›¸åŒæ—¶ï¼Œå†æ ¹æ® lru å­—æ®µçš„å‰ 16bit å€¼å¤§å°ï¼Œé€‰æ‹©è®¿é—®æ—¶é—´æœ€ä¹…è¿œçš„æ•°æ®è¿›è¡Œæ·˜æ±°ã€‚Redis åªä½¿ç”¨äº† 8bit è®°å½•æ•°æ®çš„è®¿é—®æ¬¡æ•°ï¼Œè€Œ 8bit è®°å½•çš„æœ€å¤§å€¼æ˜¯ 255ï¼Œè¿™æ ·åœ¨è®¿é—®å¿«é€Ÿçš„æƒ…å†µä¸‹ï¼Œå¦‚æœæ¯æ¬¡è¢«è®¿é—®å°±å°†è®¿é—®æ¬¡æ•°åŠ ä¸€ï¼Œå¾ˆå¿«æŸæ¡æ•°æ®å°±è¾¾åˆ°æœ€å¤§å€¼255ï¼Œå¯èƒ½å¾ˆå¤šæ•°æ®éƒ½æ˜¯255ï¼Œé‚£ä¹ˆé€€åŒ–æˆLRUç®—æ³•äº†ã€‚æ‰€ä»¥Redisä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ç°äº†ä¸€ä¸ªæ›´ä¼˜çš„è®¡æ•°è§„åˆ™ï¼Œå¹¶å¯ä»¥é€šè¿‡é…ç½®é¡¹ï¼Œæ¥æ§åˆ¶è®¡æ•°å™¨å¢åŠ çš„é€Ÿåº¦ã€‚<strong>å‚æ•°</strong> ï¼šlfu-log-factor ï¼Œç”¨è®¡æ•°å™¨å½“å‰çš„å€¼ä¹˜ä»¥é…ç½®é¡¹ lfu_log_factor å†åŠ  1ï¼Œå†å–å…¶å€’æ•°ï¼Œå¾—åˆ°ä¸€ä¸ª p å€¼ï¼›ç„¶åï¼ŒæŠŠè¿™ä¸ª p å€¼å’Œä¸€ä¸ªå–å€¼èŒƒå›´åœ¨ï¼ˆ0ï¼Œ1ï¼‰é—´çš„éšæœºæ•° r å€¼æ¯”å¤§å°ï¼Œåªæœ‰ p å€¼å¤§äº r å€¼æ—¶ï¼Œè®¡æ•°å™¨æ‰åŠ  1ã€‚lfu-decay-timeï¼Œ æ§åˆ¶è®¿é—®æ¬¡æ•°è¡°å‡ã€‚LFU ç­–ç•¥ä¼šè®¡ç®—å½“å‰æ—¶é—´å’Œæ•°æ®æœ€è¿‘ä¸€æ¬¡è®¿é—®æ—¶é—´çš„å·®å€¼ï¼Œå¹¶æŠŠè¿™ä¸ªå·®å€¼æ¢ç®—æˆä»¥åˆ†é’Ÿä¸ºå•ä½ã€‚ç„¶åï¼ŒLFU ç­–ç•¥å†æŠŠè¿™ä¸ªå·®å€¼é™¤ä»¥ lfu_decay_time å€¼ï¼Œæ‰€å¾—çš„ç»“æœå°±æ˜¯æ•°æ® counter è¦è¡°å‡çš„å€¼ã€‚lfu-log-factorè®¾ç½®è¶Šå¤§ï¼Œé€’å¢æ¦‚ç‡è¶Šä½ï¼Œlfu-decay-timeè®¾ç½®è¶Šå¤§ï¼Œè¡°å‡é€Ÿåº¦ä¼šè¶Šæ…¢ã€‚æˆ‘ä»¬åœ¨åº”ç”¨ LFU ç­–ç•¥æ—¶ï¼Œä¸€èˆ¬å¯ä»¥å°† lfu_log_factor å–å€¼ä¸º 10ã€‚ å¦‚æœä¸šåŠ¡åº”ç”¨ä¸­æœ‰çŸ­æ—¶é«˜é¢‘è®¿é—®çš„æ•°æ®çš„è¯ï¼Œå»ºè®®æŠŠ lfu_decay_time å€¼è®¾ç½®ä¸º 1ã€‚å¯ä»¥å¿«é€Ÿè¡°å‡è®¿é—®æ¬¡æ•°ã€‚volatile-lfu ç­–ç•¥æ˜¯ Redis 4.0 åæ–°å¢ã€‚</li><li><strong>allkeys-lru</strong>ä½¿ç”¨ LRU ç®—æ³•åœ¨æ‰€æœ‰æ•°æ®ä¸­è¿›è¡Œç­›é€‰ã€‚å…·ä½“LFUç®—æ³•è·Ÿä¸Šè¿° volatile-lru ä¸­ä»‹ç»çš„ä¸€è‡´ï¼Œåªæ˜¯ç­›é€‰çš„æ•°æ®èŒƒå›´æ˜¯å…¨éƒ¨ç¼“å­˜ï¼Œè¿™é‡Œå°±ä¸åœ¨é‡å¤ã€‚</li><li>allkeys-randomä»æ‰€æœ‰é”®å€¼å¯¹ä¸­éšæœºé€‰æ‹©å¹¶åˆ é™¤æ•°æ®ã€‚volatile-random è·Ÿ allkeys-randomç®—æ³•ä¸€æ ·ï¼Œéšæœºåˆ é™¤å°±æ— æ³•è§£å†³ç¼“å­˜æ±¡æŸ“é—®é¢˜ã€‚</li><li>allkeys-lfuä½¿ç”¨ LFU ç®—æ³•åœ¨æ‰€æœ‰æ•°æ®ä¸­è¿›è¡Œç­›é€‰ã€‚å…·ä½“LFUç®—æ³•è·Ÿä¸Šè¿° volatile-lfu ä¸­ä»‹ç»çš„ä¸€è‡´ï¼Œåªæ˜¯ç­›é€‰çš„æ•°æ®èŒƒå›´æ˜¯å…¨éƒ¨ç¼“å­˜ï¼Œè¿™é‡Œå°±ä¸åœ¨é‡å¤ã€‚</li></ol><p>allkeys-lfu ç­–ç•¥æ˜¯ Redis 4.0 åæ–°å¢ã€‚</p><h3 id="3-3-I-Oå¤šè·¯å¤ç”¨"><a href="#3-3-I-Oå¤šè·¯å¤ç”¨" class="headerlink" title="3.3 I&#x2F;Oå¤šè·¯å¤ç”¨"></a>3.3 I&#x2F;Oå¤šè·¯å¤ç”¨</h3><h4 id="3-3-1-æœ‰å“ªå‡ ç§I-Oæ¨¡å‹"><a href="#3-3-1-æœ‰å“ªå‡ ç§I-Oæ¨¡å‹" class="headerlink" title="3.3.1 æœ‰å“ªå‡ ç§I&#x2F;Oæ¨¡å‹"></a>3.3.1 æœ‰å“ªå‡ ç§I&#x2F;Oæ¨¡å‹</h4><p>ä¸ºä»€ä¹ˆ Redis ä¸­è¦ä½¿ç”¨ I&#x2F;O å¤šè·¯å¤ç”¨è¿™ç§æŠ€æœ¯å‘¢ï¼Ÿ</p><p>é¦–å…ˆï¼ŒRedis æ˜¯è·‘åœ¨å•çº¿ç¨‹ä¸­çš„ï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯æŒ‰ç…§é¡ºåºçº¿æ€§æ‰§è¡Œçš„ï¼Œä½†æ˜¯ç”±äºè¯»å†™æ“ä½œç­‰å¾…ç”¨æˆ·è¾“å…¥æˆ–è¾“å‡ºéƒ½æ˜¯é˜»å¡çš„ï¼Œæ‰€ä»¥ I&#x2F;O æ“ä½œåœ¨ä¸€èˆ¬æƒ…å†µä¸‹å¾€å¾€ä¸èƒ½ç›´æ¥è¿”å›ï¼Œè¿™ä¼šå¯¼è‡´æŸä¸€æ–‡ä»¶çš„ I&#x2F;O é˜»å¡å¯¼è‡´æ•´ä¸ªè¿›ç¨‹æ— æ³•å¯¹å…¶å®ƒå®¢æˆ·æä¾›æœåŠ¡ï¼Œè€Œ <strong>I&#x2F;O å¤šè·¯å¤ç”¨</strong>å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜è€Œå‡ºç°çš„ã€‚</p><ul><li><strong>Blocking I&#x2F;Oã€‚</strong>å…ˆæ¥çœ‹ä¸€ä¸‹ä¼ ç»Ÿçš„é˜»å¡ I&#x2F;O æ¨¡å‹åˆ°åº•æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼šå½“ä½¿ç”¨ read æˆ–è€… write å¯¹æŸä¸€ä¸ª**æ–‡ä»¶æè¿°ç¬¦ï¼ˆFile Descriptor ä»¥ä¸‹ç®€ç§° FD)**è¿›è¡Œè¯»å†™æ—¶ï¼Œå¦‚æœå½“å‰ FD ä¸å¯è¯»æˆ–ä¸å¯å†™ï¼Œæ•´ä¸ª Redis æœåŠ¡å°±ä¸ä¼šå¯¹å…¶å®ƒçš„æ“ä½œä½œå‡ºå“åº”ï¼Œå¯¼è‡´æ•´ä¸ªæœåŠ¡ä¸å¯ç”¨ã€‚è¿™ä¹Ÿå°±æ˜¯ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨ç¼–ç¨‹ä¸­ä½¿ç”¨æœ€å¤šçš„é˜»å¡æ¨¡å‹ã€‚ä½†æ˜¯ç”±äºå®ƒä¼šå½±å“å…¶ä»– FD å¯¹åº”çš„æœåŠ¡ï¼Œæ‰€ä»¥éœ€è¦å¤„ç†å¤šä¸ªå®¢æˆ·ç«¯ä»»åŠ¡çš„æ—¶å€™ï¼Œå¾€å¾€éƒ½ä¸ä¼šä½¿ç”¨é˜»å¡æ¨¡å‹ã€‚</li><li><strong>I&#x2F;Oå¤šè·¯å¤ç”¨ã€‚</strong>é˜»å¡å¼çš„ I&#x2F;O æ¨¡å‹å¹¶ä¸èƒ½æ»¡è¶³è¿™é‡Œçš„éœ€æ±‚ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æ•ˆç‡æ›´é«˜çš„ I&#x2F;O æ¨¡å‹æ¥æ”¯æ’‘ Redis çš„å¤šä¸ªå®¢æˆ·ï¼ˆredis-cliï¼‰ï¼Œè¿™é‡Œæ¶‰åŠçš„å°±æ˜¯ I&#x2F;O å¤šè·¯å¤ç”¨æ¨¡å‹äº†ã€‚åœ¨ I&#x2F;O å¤šè·¯å¤ç”¨æ¨¡å‹ä¸­ï¼Œæœ€é‡è¦çš„å‡½æ•°è°ƒç”¨å°±æ˜¯ selectï¼Œè¯¥æ–¹æ³•çš„èƒ½å¤ŸåŒæ—¶ç›‘æ§å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦çš„å¯è¯»å¯å†™æƒ…å†µï¼Œå½“å…¶ä¸­çš„æŸäº›æ–‡ä»¶æè¿°ç¬¦å¯è¯»æˆ–è€…å¯å†™æ—¶ï¼Œselect æ–¹æ³•å°±ä¼šè¿”å›å¯è¯»ä»¥åŠå¯å†™çš„æ–‡ä»¶æè¿°ç¬¦ä¸ªæ•°ã€‚ä¸æ­¤åŒæ—¶ä¹Ÿæœ‰å…¶å®ƒçš„ I&#x2F;O å¤šè·¯å¤ç”¨å‡½æ•° epoll&#x2F;kqueue&#x2F;evportï¼Œå®ƒä»¬ç›¸æ¯” select æ€§èƒ½æ›´ä¼˜ç§€ï¼ŒåŒæ—¶ä¹Ÿèƒ½æ”¯æ’‘æ›´å¤šçš„æœåŠ¡ã€‚</li></ul><h4 id="3-3-2-Reactorè®¾è®¡æ¨¡å¼"><a href="#3-3-2-Reactorè®¾è®¡æ¨¡å¼" class="headerlink" title="3.3.2 Reactorè®¾è®¡æ¨¡å¼"></a>3.3.2 Reactorè®¾è®¡æ¨¡å¼</h4><p>Redis æœåŠ¡é‡‡ç”¨ Reactor çš„æ–¹å¼æ¥å®ç°æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼ˆæ¯ä¸€ä¸ªç½‘ç»œè¿æ¥å…¶å®éƒ½å¯¹åº”ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼‰</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/35838370/1682779118964-d5b2cf6f-b475-4166-bbc7-fcdb1c5a8759.png" alt="img"></p><p>æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ä½¿ç”¨ I&#x2F;O å¤šè·¯å¤ç”¨æ¨¡å—åŒæ—¶ç›‘å¬å¤šä¸ª FDï¼Œå½“ acceptã€readã€write å’Œ close æ–‡ä»¶äº‹ä»¶äº§ç”Ÿæ—¶ï¼Œæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨å°±ä¼šå›è°ƒ FD ç»‘å®šçš„äº‹ä»¶å¤„ç†å™¨ã€‚</p><p>è™½ç„¶æ•´ä¸ªæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨æ˜¯åœ¨å•çº¿ç¨‹ä¸Šè¿è¡Œçš„ï¼Œä½†æ˜¯é€šè¿‡ I&#x2F;O å¤šè·¯å¤ç”¨æ¨¡å—çš„å¼•å…¥ï¼Œå®ç°äº†åŒæ—¶å¯¹å¤šä¸ª FD è¯»å†™çš„ç›‘æ§ï¼Œæé«˜äº†ç½‘ç»œé€šä¿¡æ¨¡å‹çš„æ€§èƒ½ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥ä¿è¯æ•´ä¸ª Redis æœåŠ¡å®ç°çš„ç®€å•ã€‚</p><h4 id="3-3-3-I-Oå¤šè·¯å¤ç”¨æ¨¡å—"><a href="#3-3-3-I-Oå¤šè·¯å¤ç”¨æ¨¡å—" class="headerlink" title="3.3.3 I&#x2F;Oå¤šè·¯å¤ç”¨æ¨¡å—"></a>3.3.3 I&#x2F;Oå¤šè·¯å¤ç”¨æ¨¡å—</h4><p>I&#x2F;O å¤šè·¯å¤ç”¨æ¨¡å—å°è£…äº†åº•å±‚çš„ selectã€epollã€avport ä»¥åŠ kqueue è¿™äº› I&#x2F;O å¤šè·¯å¤ç”¨å‡½æ•°ï¼Œä¸ºä¸Šå±‚æä¾›äº†ç›¸åŒçš„æ¥å£ã€‚</p><p>å› ä¸º Redis éœ€è¦åœ¨å¤šä¸ªå¹³å°ä¸Šè¿è¡Œï¼ŒåŒæ—¶ä¸ºäº†æœ€å¤§åŒ–æ‰§è¡Œçš„æ•ˆç‡ä¸æ€§èƒ½ï¼Œæ‰€ä»¥ä¼šæ ¹æ®ç¼–è¯‘å¹³å°çš„ä¸åŒé€‰æ‹©ä¸åŒçš„ I&#x2F;O å¤šè·¯å¤ç”¨å‡½æ•°ä½œä¸ºå­æ¨¡å—ï¼Œæä¾›ç»™ä¸Šå±‚ç»Ÿä¸€çš„æ¥å£ï¼›åœ¨ Redis ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡å®å®šä¹‰çš„ä½¿ç”¨ï¼Œåˆç†çš„é€‰æ‹©ä¸åŒçš„å­æ¨¡å—ã€‚</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779120227-db19f80f-4483-408b-8c31-bf41394af344.jpeg" alt="img"></p><p>Redis ä¼šä¼˜å…ˆé€‰æ‹©æ—¶é—´å¤æ‚åº¦ä¸º O(1) çš„ I&#x2F;O å¤šè·¯å¤ç”¨å‡½æ•°ä½œä¸ºåº•å±‚å®ç°ï¼ŒåŒ…æ‹¬ Solaries 10 ä¸­çš„ evportã€Linux ä¸­çš„ epoll å’Œ macOS&#x2F;FreeBSD ä¸­çš„ kqueueï¼Œä¸Šè¿°çš„è¿™äº›å‡½æ•°éƒ½ä½¿ç”¨äº†å†…æ ¸å†…éƒ¨çš„ç»“æ„ï¼Œå¹¶ä¸”èƒ½å¤ŸæœåŠ¡å‡ åä¸‡çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</p><p>ä½†æ˜¯å¦‚æœå½“å‰ç¼–è¯‘ç¯å¢ƒæ²¡æœ‰ä¸Šè¿°å‡½æ•°ï¼Œå°±ä¼šé€‰æ‹© select ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆï¼Œç”±äºå…¶åœ¨ä½¿ç”¨æ—¶ä¼šæ‰«æå…¨éƒ¨ç›‘å¬çš„æè¿°ç¬¦ï¼Œæ‰€ä»¥å…¶æ—¶é—´å¤æ‚åº¦è¾ƒå·® O(n)O(n)ï¼Œå¹¶ä¸”åªèƒ½åŒæ—¶æœåŠ¡ 1024 ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œæ‰€ä»¥ä¸€èˆ¬å¹¶ä¸ä¼šä»¥ select ä½œä¸ºç¬¬ä¸€æ–¹æ¡ˆä½¿ç”¨ã€‚</p><h3 id="3-4-è„‘è£‚é—®é¢˜"><a href="#3-4-è„‘è£‚é—®é¢˜" class="headerlink" title="3.4 è„‘è£‚é—®é¢˜"></a>3.4 è„‘è£‚é—®é¢˜</h3><p>å¦‚æœåœ¨ Redis ä¸­ï¼Œå½¢å¼ä¸Šå°±æ˜¯æœ‰äº†ä¸¤ä¸ª masterï¼Œè®°ä½äº†ä¸¤ä¸ª master æ‰æ˜¯è„‘è£‚çš„å‰æ</p><h4 id="3-4-1-å“¨å…µæ¨¡å¼ä¸‹çš„è„‘è£‚"><a href="#3-4-1-å“¨å…µæ¨¡å¼ä¸‹çš„è„‘è£‚" class="headerlink" title="3.4.1 å“¨å…µæ¨¡å¼ä¸‹çš„è„‘è£‚"></a>3.4.1 å“¨å…µæ¨¡å¼ä¸‹çš„è„‘è£‚</h4><p>1ä¸ª master ä¸ 3ä¸ª slaveç»„æˆçš„å“¨å…µæ¨¡å¼ï¼ˆå“¨å…µç‹¬ç«‹éƒ¨ç½²äºå…¶ä»–èŠ‚ç‚¹ï¼‰ã€‚ä¸¤ä¸ªå®¢æˆ·ç«¯ server1ã€server2 éƒ½è¿æ¥ä¸Šäº† masterã€‚ä½†æ˜¯å¦‚æœ master ä¸ slave åŠå“¨å…µä¹‹é—´ ç½‘ç»œå‘ç”Ÿäº†æ•…éšœï¼Œä½†æ˜¯å“¨å…µä¸slaveä¹‹é—´é€šè®¯æ­£å¸¸ï¼Œè¿™æ—¶3ä¸ªslaveå…¶ä¸­1ä¸ªç»è¿‡å“¨å…µæŠ•ç¥¨åï¼Œæå‡ä¸ºæ–°masterã€‚å¦‚æœæ°å¥½æ­¤æ—¶ server1 ä»ç„¶è¿æ¥çš„æ˜¯æ—§çš„masterï¼Œè€Œserver2è¿æ¥åˆ°äº†æ–°çš„masterã€‚</p><p>æ•°æ®å°±ä¸ä¸€è‡´äº†ï¼ŒåŸºäº setNX æŒ‡ä»¤çš„åˆ†å¸ƒå¼é”ï¼Œå¯èƒ½ä¼šæ‹¿åˆ°ç›¸åŒçš„é”ï¼›åŸºäº incr ç”Ÿæˆçš„å…¨å±€å”¯ä¸€ idï¼Œä¹Ÿå¯èƒ½å‡ºç°é‡å¤ã€‚</p><h4 id="3-4-2-cluster-æ¨¡å¼ä¸‹çš„è„‘è£‚"><a href="#3-4-2-cluster-æ¨¡å¼ä¸‹çš„è„‘è£‚" class="headerlink" title="3.4.2 cluster æ¨¡å¼ä¸‹çš„è„‘è£‚"></a>3.4.2 cluster æ¨¡å¼ä¸‹çš„è„‘è£‚</h4><p><img src="https://cdn.nlark.com/yuque/0/2023/png/35838370/1682779121684-93b3e741-7f57-49e9-b067-ea538dd0980b.png" alt="img"></p><p>cluster æ¨¡å¼ä¸‹ï¼Œè¿™ç§æƒ…å†µè¦æ›´å¤æ‚ï¼Œä¾‹å¦‚é›†ç¾¤ä¸­æœ‰ 6 ç»„åˆ†ç‰‡ï¼Œæ¯ç»™åˆ†ç‰‡èŠ‚ç‚¹éƒ½æœ‰ 1 ä¸» 1 ä»ï¼Œå¦‚æœå‡ºç°ç½‘ç»œåˆ†åŒºæ—¶ï¼Œå„ç§èŠ‚ç‚¹ä¹‹é—´çš„åˆ†åŒºç»„åˆéƒ½æœ‰å¯èƒ½ã€‚</p><h5 id="æ‰‹åŠ¨è§£å†³é—®é¢˜"><a href="#æ‰‹åŠ¨è§£å†³é—®é¢˜" class="headerlink" title="æ‰‹åŠ¨è§£å†³é—®é¢˜"></a>æ‰‹åŠ¨è§£å†³é—®é¢˜</h5><p>åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œå¦‚æœ master æŒ‚äº†ï¼Œé‚£ä¹ˆå†™å…¥å°±ä¼šå¤±è´¥ï¼Œå¦‚æœæ˜¯æ‰‹åŠ¨è§£å†³ï¼Œé‚£ä¹ˆäººä¸ºä¼šæ£€æµ‹ master ä»¥åŠ slave çš„ç½‘ç»œçŠ¶å†µï¼Œç„¶åè§†æƒ…å†µï¼Œå¦‚æœæ˜¯ master æŒ‚äº†ï¼Œé‡å¯ masterï¼Œå¦‚æœæ˜¯ master ä¸ slave ä¹‹é—´çš„è¿æ¥æ–­äº†ï¼Œå¯ä»¥è°ƒè¯•ç½‘ç»œï¼Œè¿™æ ·è™½ç„¶éº»çƒ¦ï¼Œä½†æ˜¯æ˜¯å¯ä»¥ä¿è¯åªæœ‰ä¸€ä¸ª master çš„ï¼Œæ‰€ä»¥åªè¦è®¤çœŸè´Ÿè´£ï¼Œä¸ä¼šå‡ºç°è„‘è£‚ã€‚</p><h5 id="è‡ªåŠ¨è§£å†³é—®é¢˜"><a href="#è‡ªåŠ¨è§£å†³é—®é¢˜" class="headerlink" title="è‡ªåŠ¨è§£å†³é—®é¢˜"></a>è‡ªåŠ¨è§£å†³é—®é¢˜</h5><p>Redis ä¸­æœ‰ä¸€ä¸ªå“¨å…µæœºåˆ¶ï¼Œå“¨å…µæœºåˆ¶çš„ä½œç”¨å°±æ˜¯é€šè¿‡ redis å“¨å…µæ¥æ£€æµ‹ redis æœåŠ¡çš„çŠ¶æ€ï¼Œå¦‚æœä¸€æ—¦å‘ç° master æŒ‚äº†ï¼Œå°±åœ¨ slave ä¸­é€‰ä¸¾æ–°çš„ master èŠ‚ç‚¹ä»¥å®ç°æ•…éšœè‡ªåŠ¨è½¬ç§»ã€‚</p><h5 id="å¦‚ä½•é¿å…è„‘è£‚"><a href="#å¦‚ä½•é¿å…è„‘è£‚" class="headerlink" title="å¦‚ä½•é¿å…è„‘è£‚"></a>å¦‚ä½•é¿å…è„‘è£‚</h5><p>åˆç†è®¾ç½® min-slaves-to-writeã€min-slaves-max-lagä¸¤ä¸ªå‚æ•°</p><ul><li>ç¬¬ä¸€ä¸ªå‚æ•°æ ‡è¯†è¿æ¥åˆ° master çš„æœ€å°‘ slave æ•°é‡</li><li>ç¬¬äºŒä¸ªå‚æ•°æ ‡è¯† slaveè¿æ¥åˆ° master çš„æœ€å¤§å»¶è¿Ÿæ—¶é—´</li></ul><p>é—®é¢˜ï¼Œå°±å‡ºç°åœ¨è¿™ä¸ªè‡ªåŠ¨æ•…éšœè½¬ç§»ä¸Šï¼Œå¦‚æœæ˜¯å“¨å…µå’Œ slave åŒæ—¶ä¸ master æ–­äº†è”ç³»ï¼Œå³å“¨å…µå¯ä»¥ç›‘æµ‹åˆ° slaveï¼Œä½†æ˜¯ç›‘æµ‹ä¸åˆ° masterï¼Œè€Œ master è™½ç„¶è¿æ¥ä¸ä¸Š slave å’Œå“¨å…µï¼Œä½†æ˜¯è¿˜æ˜¯åœ¨æ­£å¸¸è¿è¡Œï¼Œè¿™æ ·å¦‚æœå“¨å…µå› ä¸ºç›‘æµ‹ä¸åˆ° masterï¼Œè®¤ä¸ºå®ƒæŒ‚äº†ï¼Œä¼šåœ¨ slave ä¸­é€‰ä¸¾æ–°çš„ masterï¼Œè€Œæœ‰ä¸€éƒ¨åˆ†åº”ç”¨ä»ç„¶ä¸æ—§çš„ master äº¤äº’ã€‚å½“æ—§çš„ master ä¸æ–°çš„ master é‡æ–°å»ºç«‹è¿æ¥ï¼Œæ—§çš„ master ä¼šåŒæ­¥æ–°çš„ master ä¸­çš„æ•°æ®ï¼Œè€Œæ—§çš„ master ä¸­çš„æ•°æ®å°±ä¼šä¸¢å¤±ã€‚æ‰€ä»¥æˆ‘è®¤ä¸º redis è„‘è£‚å°±æ˜¯è‡ªåŠ¨æ•…éšœè½¬ç§»é€ æˆçš„ã€‚</p><h3 id="3-4-æ­å»ºå“¨å…µé›†ç¾¤"><a href="#3-4-æ­å»ºå“¨å…µé›†ç¾¤" class="headerlink" title="3.4 æ­å»ºå“¨å…µé›†ç¾¤"></a>3.4 æ­å»ºå“¨å…µé›†ç¾¤</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-9-centos ~]# docker run -it -d --name redis3 -p 6378:6378 redis</span><br><span class="line">1d3ab7315ac93a217136fe0fb0837104ca4e5500b0671d2acb989f92ecd8e38b</span><br><span class="line">[root@VM-4-9-centos ~]#  docker inspect -f &#x27;&#123;&#123;.Name&#125;&#125; - &#123;&#123;.NetworkSettings.IPAddress &#125;&#125;&#x27; $(docker ps -aq)</span><br><span class="line">/redis3 - 172.17.0.6</span><br><span class="line">/redis2 - 172.17.0.5</span><br><span class="line">/redis1 - 172.17.0.4</span><br><span class="line">[root@VM-4-9-centos ~]# docker exec -it redis3 /bin/bash</span><br><span class="line">root@1d3ab7315ac9:/data# redis-cli</span><br><span class="line">127.0.0.1:6379&gt; replicaof 172.17.0.4 6379</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line">&quot;kongxr&quot;</span><br><span class="line"># https://segmentfault.com/a/1190000040755506</span><br><span class="line">#1.æ–°å»ºä¸€ä¸ªæ–‡ä»¶ï¼š docker-compose.yml å†…å®¹å¦‚ä¸‹ï¼š</span><br><span class="line">version: &#x27;3.7&#x27;</span><br><span class="line">services:</span><br><span class="line">  sentinel1:</span><br><span class="line">    image: redis</span><br><span class="line">    container_name: redis-sentinel-1</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - 26379:26379</span><br><span class="line">    command: redis-sentinel /usr/local/etc/redis/sentinel.conf</span><br><span class="line">    volumes:</span><br><span class="line">      - ./sentinel1.conf:/usr/local/etc/redis/sentinel.conf</span><br><span class="line">  sentinel2:</span><br><span class="line">    image: redis</span><br><span class="line">    container_name: redis-sentinel-2</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">    - 26380:26379</span><br><span class="line">    command: redis-sentinel /usr/local/etc/redis/sentinel.conf</span><br><span class="line">    volumes:</span><br><span class="line">      - ./sentinel2.conf:/usr/local/etc/redis/sentinel.conf</span><br><span class="line">  sentinel3:</span><br><span class="line">    image: redis</span><br><span class="line">    container_name: redis-sentinel-3</span><br><span class="line">    ports:</span><br><span class="line">      - 26381:26379</span><br><span class="line">    command: redis-sentinel /usr/local/etc/redis/sentinel.conf</span><br><span class="line">    volumes:</span><br><span class="line">      - ./sentinel3.conf:/usr/local/etc/redis/sentinel.conf</span><br><span class="line">      </span><br><span class="line">#2.åˆ†åˆ«æ–°å»ºä¸‰ä¸ªæ–‡ä»¶ï¼š sentinel1.confã€sentinel2.confã€sentinel1.conf å†…å®¹éƒ½å¦‚ä¸‹ï¼š</span><br><span class="line"># è‡ªå®šä¹‰é›†ç¾¤åï¼Œå…¶ä¸­172.17.0.4 ä¸º redis-master çš„ ipï¼Œ6380 ä¸º redis-master çš„ç«¯å£ï¼Œ2 ä¸ºæœ€å°æŠ•ç¥¨æ•°ï¼ˆå› ä¸ºæœ‰ 3 å° Sentinel æ‰€ä»¥å¯ä»¥è®¾ç½®æˆ 2ï¼‰</span><br><span class="line"></span><br><span class="line">port 26379</span><br><span class="line">dir /tmp</span><br><span class="line">sentinel monitor mymaster 172.17.0.4 6380 2</span><br><span class="line">sentinel down-after-milliseconds mymaster 30000</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line">sentinel auth-pass mymaster redispwd</span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br><span class="line">sentinel deny-scripts-reconfig yes</span><br><span class="line"></span><br><span class="line">#3.å››ä¸ªæ–‡ä»¶éƒ½æ”¾åœ¨åŒä¹‰ç›®å½•ä¸‹ï¼Œå¹¶ä½¿ç”¨å‘½ä»¤</span><br><span class="line">[root@VM-4-9-centos redis-sentinel]# docker-compose up -d</span><br><span class="line">Creating network &quot;redis-sentinel_default&quot; with the default driver</span><br><span class="line">Creating redis-sentinel-1 ... done</span><br><span class="line">Creating redis-sentinel-3 ... done</span><br><span class="line">Creating redis-sentinel-2 ... done</span><br><span class="line"></span><br><span class="line">#4.æµ‹è¯•ï¼šè¿›å…¥redis1 å‘ç°ï¼Œå½“å‰redisä¸ºä¸»èŠ‚ç‚¹ã€‚ç„¶åå°†è¯¥rediså…³é—­ã€‚</span><br><span class="line">[root@VM-4-9-centos redis-sentinel]#  docker exec -it redis1 /bin/bash</span><br><span class="line">root@f21ca2cacfea:/data# redis-cli</span><br><span class="line">127.0.0.1:6379&gt; info replication</span><br><span class="line"># Replication</span><br><span class="line">role:master</span><br><span class="line">[root@VM-4-9-centos redis-sentinel]# docker stop redis1</span><br><span class="line">redis1</span><br></pre></td></tr></table></figure><h2 id="å››ã€Redisåº”ç”¨"><a href="#å››ã€Redisåº”ç”¨" class="headerlink" title="å››ã€Redisåº”ç”¨"></a>å››ã€Redisåº”ç”¨</h2><h3 id="4-1-åˆ†å¸ƒå¼é”"><a href="#4-1-åˆ†å¸ƒå¼é”" class="headerlink" title="4.1 åˆ†å¸ƒå¼é”"></a>4.1 åˆ†å¸ƒå¼é”</h3><p>åˆ†å¸ƒå¼é”æœ¬è´¨ä¸Šè¦å®ç°çš„ç›®æ ‡å°±æ˜¯åœ¨ Redis é‡Œé¢å ä¸€ä¸ªèŒ…å‘ï¼Œå½“åˆ«çš„è¿›ç¨‹ä¹Ÿè¦è¿›æ¥å æ—¶ï¼Œå‘ç°å·²ç»æœ‰äººè¹²åœ¨é‚£é‡Œäº†ï¼Œå°±åªå¥½æ”¾å¼ƒæˆ–è€…ç¨åå†è¯•ã€‚</p><p>å å‘ä¸€èˆ¬æ˜¯ä½¿ç”¨ setnx æŒ‡ä»¤ï¼Œåªå…è®¸è¢«ä¸€ä¸ªå®¢æˆ·ç«¯å å‘ã€‚å…ˆæ¥å…ˆå ï¼Œç”¨å®Œäº†ï¼Œå†è°ƒç”¨ del æŒ‡ä»¤é‡Šæ”¾èŒ…å‘ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; setnx lock01 true</span><br><span class="line">OK</span><br><span class="line">... do something critical ...</span><br><span class="line">&gt;del lock01</span><br><span class="line">(integer)1</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯å¦‚æœ é€»è¾‘æ‰§è¡Œåˆ°ä¸­é—´ å‡ºç°å¼‚å¸¸äº†ï¼Œå¯èƒ½ä¼šå¯¼è‡´ del æŒ‡ä»¤æ²¡æœ‰è¢«è°ƒç”¨ï¼Œè¿™æ ·å°±ä¼šé™·å…¥æ­»é”ï¼Œé”æ°¸è¿œå¾—ä¸å¾—é‡Šæ”¾ã€‚äºæ˜¯æˆ‘ä»¬åœ¨æ‹¿åˆ°é”ä¹‹åï¼Œå†ç»™é”åŠ ä¸Šä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œæ¯”å¦‚5sï¼Œè¿™æ ·å³ä½¿ä¸­é—´å‡ºç°å¼‚å¸¸ä¹Ÿå¯ä»¥ä¿è¯5sä¹‹åé”ä¼šè‡ªåŠ¨é‡Šæ”¾ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; setnx lock01 true</span><br><span class="line">OK</span><br><span class="line">&gt;expire lock01 5</span><br><span class="line">... do something critical</span><br><span class="line">&gt;del lock01</span><br><span class="line">(integer)1</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ä»¥ä¸Šé€»è¾‘è¿˜æ˜¯æœ‰é—®é¢˜ï¼Œå› ä¸ºå¦‚æœåœ¨ setnx å’Œ expire ä¹‹é—´æœåŠ¡å™¨è¿›ç¨‹çªç„¶æŒ‚æ‰äº†ï¼Œå°±ä¼šå¯¼è‡´ expire å¾—ä¸åˆ°æ‰§è¡Œï¼Œä¹Ÿä¼šé€ æˆæ­»é”ã€‚</p><p>è¿™ç§é—®é¢˜çš„æ ¹æºåœ¨äº setnex å’Œ expire æ˜¯ä¸¤æ¡æŒ‡ä»¤è€Œä¸æ˜¯åŸå­æŒ‡ä»¤ã€‚å¦‚æœè¿™ä¸¤æ¡æŒ‡ä»¤å¯ä»¥ä¸€èµ·æ‰§è¡Œå°±ä¸ä¼šå‡ºç°é—®é¢˜ã€‚è¿™é‡Œä¹Ÿä¸å¯ä»¥ä½¿ç”¨Redisäº‹åŠ¡æ¥è§£å†³ã€‚å› ä¸º expire æ˜¯ä¾èµ–äº setnx çš„æ‰§è¡Œç»“æœçš„ï¼Œå¦‚æœ setnx æ²¡æŠ¢åˆ°é”ï¼Œexpire æ˜¯ä¸åº”è¯¥æ‰§è¡Œçš„ã€‚äº‹åŠ¡é‡Œæ²¡æœ‰ if-else åˆ†æ”¯é€»è¾‘ï¼Œäº‹åŠ¡çš„ç‰¹ç‚¹æ˜¯ä¸€å£æ°”æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œè¦ä¹ˆä¸€ä¸ªéƒ½ä¸æ‰§è¡Œã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒRediså¼€æºç¤¾åŒºæ¶Œç°å‡ºå¾ˆå¤§åˆ†å¸ƒå¼é”çš„libraryï¼Œä¸“é—¨ç”¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå…¶å®ç°æ–¹å¼æä¸ºå¤æ‚ã€‚å¦‚æœéœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼é”ï¼Œä¸èƒ½ä»…ä»…ä½¿ç”¨ Jedis æˆ–è€… redis-py å°±è¡Œäº†ï¼Œè¿˜å¾—å¼•å…¥åˆ†å¸ƒå¼é”çš„ libraryã€‚ä¸ºäº†æ²»ç†è¿™ä¸ªä¹±è±¡ï¼ŒRedis2.8ç‰ˆæœ¬ä¸­ åŠ å…¥äº† set æŒ‡ä»¤çš„æ‰©å±•å‚æ•°ï¼Œæ˜¯çš„ setnx å’Œ expire å¯ä»¥ä¸€èµ·æ‰§è¡Œï¼Œå½»åº•è§£å†³äº†åˆ†å¸ƒå¼é”çš„ä¹±è±¡ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; set lock01 true ex 5 nx</span><br><span class="line">OK</span><br><span class="line">&gt; del lock01</span><br></pre></td></tr></table></figure><p>Redis çš„åˆ†å¸ƒå¼é”ä¸èƒ½è§£å†³è¶…æ—¶é—®é¢˜ï¼Œå¦‚æœåœ¨åŠ é”å’Œé‡Šæ”¾ä¹‹é—´çš„é€»è¾‘æ‰§è¡Œçš„å¤ªé•¿ï¼Œä»¥è‡³äºè¶…å‡ºäº†é”çš„è¶…æ—¶é™åˆ¶ï¼Œå°±ä¼šå‡ºç°é—®é¢˜ã€‚å› ä¸ºè¿™æ—¶å€™é”è¿‡æœŸäº†ï¼Œç¬¬äºŒä¸ªçº¿ç¨‹é‡æ–°æŒæœ‰äº†è¿™æŠŠé”ï¼Œä½†æ˜¯ç´§æ¥ç€ç¬¬ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œäº†ä¸šåŠ¡é€»è¾‘ï¼Œå°±æŠŠé”ç»™é‡Šæ”¾äº†ï¼Œç¬¬ä¸‰ä¸ªçº¿ç¨‹å°±ä¼šåœ¨ç¬¬äºŒä¸ªçº¿ç¨‹æ‰§è¡Œå®Œä¹‹å‰å°±æ‹¿åˆ°äº†é”ã€‚</p><p>ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼ŒRedis åˆ†å¸ƒå¼é”ä¸è¦ç”¨äºè¾ƒé•¿æ—¶é—´çš„ä»»åŠ¡ã€‚å¦‚æœçœŸçš„å¶å°”å‡ºç°äº†ï¼Œæ•°æ®å‡ºç°å°æ³¢é”™ä¹±å¯èƒ½éœ€è¦äººå·¥ä»‹å…¥è§£å†³</p><p>æœ‰ä¸€ä¸ªæ›´å®‰å…¨çš„æ–¹æ¡ˆæ˜¯ä¸º set æŒ‡ä»¤çš„ value å‚æ•°è®¾ç½®ä¸º ä¸€ä¸ªéšæœºæ•°ï¼Œé‡Šæ”¾é”æ—¶å…ˆåŒ¹é…éšæœºæ•°æ˜¯å¦ä¸€è‡´ï¼Œç„¶åå†åˆ é™¤ keyã€‚ä½†æ˜¯åŒ¹é… value å’Œåˆ é™¤ key ä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼ŒRedisä¹Ÿæ²¡æœ‰æä¾›ç±»ä¼¼äº delifequals è¿™æ ·çš„æŒ‡ä»¤ï¼Œè¿™å°±éœ€è¦ä½¿ç”¨ Lua è„šæœ¬æ¥å¤„ç†äº†ï¼Œå› ä¸º Lua è„šæœ¬å¯ä»¥ä¿è¯è¿ç»­å¤šä¸ªæŒ‡ä»¤çš„åŸå­æ€§æ‰§è¡Œã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># delifequals</span><br><span class="line">if redis.call(&quot;get&quot;,KEYS[1])==ARGV[1] then return redis.call(&quot;del&quot;,KEYS[1]) else return 0 end</span><br></pre></td></tr></table></figure><p>å¯é‡å…¥æ€§</p><p>å¯é‡å…¥æ€§å°±æ˜¯æŒ‡ çº¿ç¨‹åœ¨æŒæœ‰é”çš„æƒ…å†µä¸‹å†æ¬¡è¯·æ±‚åŠ é”ï¼Œå¦‚æœä¸€ä¸ªé”æ”¯æŒåŒä¸€ä¸ªçº¿ç¨‹çš„å¤šæ¬¡åŠ é”ï¼Œé‚£ä¹ˆè¿™ä¸ªé”å°±æ˜¯å¯é‡å…¥çš„ã€‚Redisåˆ†å¸ƒå¼é”å¦‚æœéœ€è¦æ”¯æŒå¯é‡å…¥ï¼Œéœ€è¦å¯¹å®¢æˆ·ç«¯çš„ set æ–¹æ³•è¿›è¡ŒåŒ…è£…ï¼Œä½¿ç”¨çº¿ç¨‹çš„ Threadlocal å˜é‡å­˜å‚¨å½“å‰æŒæœ‰é”çš„è®¡æ•°ã€‚</p><h3 id="4-2-å»¶æ—¶é˜Ÿåˆ—"><a href="#4-2-å»¶æ—¶é˜Ÿåˆ—" class="headerlink" title="4.2 å»¶æ—¶é˜Ÿåˆ—"></a>4.2 å»¶æ—¶é˜Ÿåˆ—</h3><p>å¹³æ—¶ä¹ æƒ¯ä½¿ç”¨ RabbitMQå’ŒKafkaä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ï¼Œæ¥ç»™åº”ç”¨ç¨‹åºä¹‹é—´å¢åŠ å¼‚æ­¥æ¶ˆæ¯ä¼ é€’åŠŸèƒ½ã€‚è¿™ä¸ªä¸¤ä¸ªä¸­é—´ä»¶éƒ½æ˜¯ä¸“ä¸šçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ï¼Œå…¶èƒ½åŠ›å¾ˆå¼ºï¼Œä½†æ˜¯ä½¿ç”¨èµ·æ¥ä¹Ÿè¾ƒä¸ºç¹çã€‚Redisçš„æ¶ˆæ¯é˜Ÿåˆ—å®ç°å¾ˆç®€å•ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯ä¸“ä¸šçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ƒæ²¡æœ‰éå¸¸å¤šçš„é«˜çº§ç‰¹æ€§ï¼Œæ²¡æœ‰ackä¿è¯ï¼Œå¦‚æœå¯¹æ¶ˆæ¯çš„å¯é æ€§æœ‰ç€æè‡´çš„è¿½æ±‚ï¼Œé‚£ä¹ˆå®ƒå°±ä¸é€‚åˆä½¿ç”¨ã€‚</p><h4 id="4-2-1-å¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—"><a href="#4-2-1-å¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="4.2.1 å¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—"></a>4.2.1 å¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—</h4><p>Redis çš„ listï¼ˆåˆ—è¡¨ï¼‰æ•°æ®ç»“æ„ å¸¸ç”¨æ¥ä½œä¸ºå¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—ä½¿ç”¨ï¼Œä½¿ç”¨ rpush&#x2F;lpush æ“ä½œå…¥é˜Ÿåˆ—ï¼Œä½¿ç”¨ lpop å’Œ rpop æ¥å‡ºé˜Ÿåˆ—ã€‚</p><p>å®¢æˆ·ç«¯æ˜¯é€šè¿‡é˜Ÿåˆ—çš„ pop æ“ä½œæ¥è·å–æ¶ˆæ¯ï¼Œç„¶åè¿›è¡Œå¤„ç†ã€‚å¤„ç†å®Œäº†å†æ¥ç€è·å–æ¶ˆæ¯ï¼Œå†è¿›è¡Œå¤„ç†ï¼Œå¦‚æ­¤å¾€å¤ã€‚</p><p>å¦‚æœé˜Ÿåˆ—ç©ºäº†ï¼Œå®¢æˆ·ç«¯å°±ä¼šé™·å…¥ pop çš„æ­»å¾ªç¯ï¼Œä¸åœåœ° popã€‚è¿™å°±æ˜¯æµªè´¹ç”Ÿå‘½çš„ç©ºå¾ªç¯ã€‚ç©ºè½®è¯¢ä¸ä½†æ‹‰é«˜äº†å®¢æˆ·ç«¯çš„CPUï¼Œredisçš„QPSä¹Ÿä¼šè¢«æ‹‰é«˜ï¼Œå¦‚æœè¿™æ ·ç©ºè½®è¯¢çš„å®¢æˆ·ç«¯æœ‰å‡ åæ¥ä¸ªï¼ŒRedis çš„æ…¢æŸ¥è¯¢å¯èƒ½ä¼šæ˜¾è‘—å¢å¤šã€‚</p><p>é€šå¸¸ä½¿ç”¨ sleep æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè®©çº¿ç¨‹ä¼‘çœ ä¸€ä¼šã€‚ä½†æ˜¯è¿™æ ·ä¼šé€ æˆæ¶ˆè´¹è€…çš„å»¶è¿Ÿã€‚å¯ä»¥æœ‰æ›´å¥½çš„è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ blpopã€brpopï¼Œå‰ç¼€å­—ç¬¦bä»£è¡¨çš„å°±æ˜¯ blockingï¼Œå³å µå¡è¯»ã€‚å µå¡è¯»åœ¨é˜Ÿåˆ—æ²¡æœ‰æ•°æ®çš„æ—¶å€™ï¼Œä¼šç«‹å³è¿›è¡Œä¼‘çœ çŠ¶æ€ï¼Œä¸€æ—¦æ•°æ®åˆ°æ¥ï¼Œåˆ™ç«‹åˆ»é†’è¿‡æ¥ã€‚æ¶ˆæ¯çš„å»¶è¿Ÿå‡ ä¹ä¸º0ã€‚è¿™ä¸ªæ–¹æ¡ˆæœ‰ä¸ªå¼Šç«¯ï¼Œå°±æ˜¯æ³¨æ„ç©ºè¿æ¥é—®é¢˜ã€‚å› ä¸ºçº¿ç¨‹ä¸€ç›´å µå¡åœ¨é‚£ï¼ŒRedisçš„å®¢æˆ·ç«¯è¿æ¥å°±æˆäº†é—²ç½®è¿æ¥ï¼Œé—²ç½®è¿‡ä¹…ï¼ŒæœåŠ¡å™¨ä¸€èˆ¬å°±ä¼šä¸»åŠ¨æ–­å¼€è¿æ¥ï¼Œå‡å°‘é—²ç½®èµ„æºçš„å ç”¨ã€‚è¿™æ—¶ blpopã€brpop ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚æ‰€ä»¥åœ¨ ç¼–å†™å®¢æˆ·ç«¯æ¶ˆè´¹è€…æ—¶ï¼Œæ³¨æ„æ•è·å¼‚å¸¸å’Œé‡è¯•ã€‚</p><h4 id="4-2-2-å»¶è¿Ÿé˜Ÿåˆ—çš„å®ç°"><a href="#4-2-2-å»¶è¿Ÿé˜Ÿåˆ—çš„å®ç°" class="headerlink" title="4.2.2 å»¶è¿Ÿé˜Ÿåˆ—çš„å®ç°"></a>4.2.2 å»¶è¿Ÿé˜Ÿåˆ—çš„å®ç°</h4><p>ä¸Šä¸€èŠ‚æåŠçš„ åˆ†å¸ƒå¼é”ã€‚å½“å®¢æˆ·ç«¯åœ¨å¤„ç†è¯·æ±‚æ—¶ åŠ é”æ²¡åŠ æˆåŠŸ æ€ä¹ˆåŠã€‚ä¸€èˆ¬æ˜¯æœ‰ 3ç§ ç­–ç•¥æ¥å¤„ç†åŠ é”å¤±è´¥ï¼š</p><ul><li>ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œé€šçŸ¥ç”¨æˆ·ç¨åé‡è¯•ã€‚</li><li>sleepï¼Œä¸€ä¼šå†é‡è¯•ã€‚è¿™ç§æ–¹å¼ï¼Œä¼šå µå¡å½“å‰çš„æ¶ˆæ¯å¤„ç†çº¿ç¨‹ï¼Œå¯¼è‡´é˜Ÿåˆ—çš„åç»­æ¶ˆæ¯å¤„ç†å‡ºç°å»¶è¿Ÿã€‚å¦‚æœç¢°æ’å‡ºç°è¾ƒå¤šæˆ–è€…é˜Ÿåˆ—é‡Œçš„æ¶ˆæ¯è¾ƒå¤šï¼Œsleep å¯èƒ½å¹¶ä¸åˆé€‚ã€‚å› ä¸ºä¸ªåˆ« æ­»é”çš„key å¯¼è‡´åŠ é”ä¸æˆåŠŸï¼Œçº¿ç¨‹ä¼šå½»åº•å µæ­»ï¼Œå¯¼è‡´åç»­æ¶ˆæ¯æ°¸è¿œå¾—ä¸åˆ°åŠæ—¶å¤„ç†ã€‚</li><li>å°†è¯·æ±‚è½¬ç§»åˆ°å»¶è¿Ÿé˜Ÿåˆ—ï¼Œè¿‡ä¼šå†è¯•ã€‚è¿™ç§æ–¹å¼è¾ƒå¥½ã€‚</li></ul><p>å»¶æ—¶é˜Ÿåˆ—å¯ä»¥é€šè¿‡ Redisçš„ zset(æœ‰åºåˆ—è¡¨)æ¥å®ç°ã€‚æˆ‘ä»¬å°†æ¶ˆæ¯åºåˆ—åŒ–æˆä¸€ä¸ªå­—ç¬¦ä¸²ä½œä¸º zset çš„ valueï¼Œè¿™ä¸ªæ¶ˆæ¯çš„åˆ°æœŸå¤„ç†æ—¶é—´ä½œä¸º scoreï¼Œç„¶åç”¨å¤šä¸ªçº¿ç¨‹è½®è¯¢ zset è·å–åˆ°æœŸçš„ä»»åŠ¡è¿›è¡Œå¤„ç†ï¼Œå¤šä¸ªçº¿ç¨‹æ˜¯ä¸ºäº†ä¿éšœå¯ç”¨æ€§ï¼Œä¸‡ä¸€æŒ‚äº†ä¸€ä¸ªçº¿ç¨‹è¿˜æœ‰å…¶ä»–çº¿ç¨‹å¯ä»¥ç»§ç»­å¤„ç†ã€‚å› ä¸ºæœ‰å¤šä¸ªçº¿ç¨‹ï¼Œæ‰€ä»¥éœ€è¦è€ƒè™‘å¹¶å‘äº‰æŠ¢ä»»åŠ¡ï¼Œç¡®ä¿ä»»åŠ¡ä¸èƒ½è¢«å¤šæ¬¡æ‰§è¡Œã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">def delay(msg):</span><br><span class="line">msg.id = str(uuid.uuid4())</span><br><span class="line">value = json.dumps(msg)</span><br><span class="line">retry_ts = time.time() + 5</span><br><span class="line">redis.zadd(&quot;delay-queue&quot;,retry_ts,value)</span><br><span class="line">def loop():</span><br><span class="line">while True:</span><br><span class="line">values = redis.zrangebyscore(&quot;delay-queue&quot;,0,time.time(),start=0,num=1)</span><br><span class="line">if not values:</span><br><span class="line">time.sleep(1)#å»¶è¿Ÿé˜Ÿåˆ—æ˜¯ç©ºå½“ï¼Œä¼‘æ¯1s</span><br><span class="line">continue</span><br><span class="line">value = value[0]</span><br><span class="line">success = redis.zrem(&quot;delay-queue&quot;,value)</span><br><span class="line">if success:</span><br><span class="line">msg = json.loads(value)</span><br><span class="line">handle_msg(msg)</span><br></pre></td></tr></table></figure><p>Redis çš„ zrem æ–¹æ³•æ˜¯å¤šçº¿ç¨‹å¤šè¿›ç¨‹æŠ¢ä»»åŠ¡çš„å…³é”®ï¼Œå®ƒçš„è¿”å›å€¼å†³å®šäº†å½“å‰å®ä¾‹æœ‰æ²¡æœ‰æŠ¢åˆ°ä»»åŠ¡ï¼Œå› ä¸ºloopæ–¹æ³•å¯èƒ½è¢«å¤šä¸ªçº¿ç¨‹ã€å¤šä¸ªè¿›ç¨‹è°ƒç”¨ï¼ŒåŒä¸€ä»»åŠ¡å¯èƒ½ä¼šè¢«å¤šä¸ªè¿›ç¨‹çº¿ç¨‹æŠ¢åˆ°ï¼Œé€šè¿‡ zrem æ¥å†³å®šå”¯ä¸€çš„å±ä¸»ã€‚åŒæ—¶æ³¨æ„å¯¹ handle_msg è¿›è¡Œå¼‚å¸¸æ•è·ã€‚</p><p>ä¸Šè¿°æ–¹æ¡ˆè¿˜æ˜¯å­˜åœ¨æ˜æ˜¾ç¼ºç‚¹ï¼š1.åŸå­æ€§é—®é¢˜ï¼šå…ˆæŸ¥è¯¢å†åˆ é™¤ è¿™ä¸¤ä¸ªæ“ä½œä¸æ˜¯åŸå­çš„ï¼Œæ˜æ˜¾ä¼šå‡ºç°å¹¶å‘é—®é¢˜ï¼Œè™½ç„¶æˆ‘è¿™é‡Œåˆ¤æ–­äº† zrem çš„æ•°é‡ï¼Œä½†æ˜¯å¯èƒ½ä¼šå‡ºç°éƒ¨åˆ† key è¢«å…¶ä»–æœºå™¨ç»™æ¶ˆè´¹çš„æƒ…å†µï¼›2.æ€§èƒ½é—®é¢˜ï¼šzrangebyscoreè¿˜å¥½ï¼Œä½†æ˜¯å¦‚æœåœ¨æ—¶é—´é—´éš”å†…äº§ç”Ÿäº†å¤§é‡æ¶ˆæ¯ï¼Œå¦‚æœåŒæ—¶å¤„ç†ï¼Œzrem çš„æ€§èƒ½ä¼šæ€¥å‰§ä¸‹é™ã€‚</p><p>æ€§èƒ½é—®é¢˜è§£å†³ï¼š</p><ul><li>å¤šçº¿ç¨‹å¹¶å‘æ¶ˆè´¹</li><li>å°†å®šæ—¶ä»»åŠ¡çš„å¯åŠ¨å»¶è¿Ÿæ—¶é—´æˆ–è€…æ¯æ¬¡å¾ªç¯çš„æ—¶é—´éšæœºï¼Œè®©æ¯å°æœºå™¨å¤„ç†æ¶ˆæ¯ç‚¹æœ‰ä¸€å®šé—´éš”ï¼Œè¿™æ ·å•æ¬¡æ—¶é—´é—´éš”å†…è¦å¤„ç†çš„æ¶ˆæ¯çš„æ•°æ®ä¼šå¤§å¤§å‡å°‘ã€‚</li><li>zrangebyscore å‘½ä»¤è®¾ç½® limitï¼Œé™åˆ¶å•æ¬¡å¤„ç†æ¶ˆæ¯çš„æ•°æ®</li></ul><p>åŸå­æ€§é—®é¢˜è§£å†³ï¼š</p><p>ä½¿ç”¨Luaè„šæœ¬ è§£å†³zrangebyscore å’Œ zrem ä¸æ˜¯åŸå­åŒ–æ“ä½œçš„é—®é¢˜ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">local key = KEYS[1]</span><br><span class="line">local min = ARGV[1]</span><br><span class="line">local max = ARGV[2]</span><br><span class="line">local result = redis.call(&#x27;zrangebyscore&#x27;,key,min,max,&#x27;LIMIT&#x27;,0,10)</span><br><span class="line">if next(result) ~= nil and #result &gt; 0 then</span><br><span class="line">local re = redis.call(&#x27;zrem&#x27;,key,unpack(reslut));</span><br><span class="line">if(re &gt; 0) then</span><br><span class="line">return result;</span><br><span class="line">end</span><br><span class="line">else</span><br><span class="line">return &#123;&#125;</span><br><span class="line">end</span><br></pre></td></tr></table></figure><h3 id="4-3-ä½å›¾"><a href="#4-3-ä½å›¾" class="headerlink" title="4.3 ä½å›¾"></a>4.3 ä½å›¾</h3><p>åœ¨å¹³æ—¶å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä¼šæœ‰ä¸€äº›boolå‹æ•°æ®éœ€è¦å­˜å–ï¼Œæ¯”å¦‚ç”¨æˆ·ä¸€å¹´çš„ç­¾åˆ°è®°å½•ï¼Œç­¾äº†æ˜¯1ï¼Œæ²¡ç­¾æ˜¯0ï¼Œè¦è®°å½•365å¤©ã€‚å¦‚æœä½¿ç”¨æ™®é€šçš„ key&#x2F;valueï¼Œæ¯ä¸ªç”¨æˆ·è¦è®°å½• 365ä¸ªï¼Œå½“ç”¨æˆ·ä¸Šäº¿æ—¶ï¼Œéœ€è¦çš„å­˜å‚¨ç©ºé—´æ˜¯æƒŠäººçš„ã€‚</p><p>ä½å›¾ä¸æ˜¯ç‰¹æ®Šçš„æ•°æ®ç»“æ„ï¼Œå®ƒçš„å†…å®¹å…¶å®å°±æ˜¯æ™®é€šçš„å­—ç¬¦ä¸²ï¼Œä¹Ÿå°±æ˜¯ byte æ•°ç»„ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ™®é€šçš„ get&#x2F;set ç›´æ¥è·å–å’Œè®¾ç½®æ•´ä¸ªä½å›¾çš„å†…å®¹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ ä½å›¾æ“ä½œ getbit&#x2F;setbit ç­‰ å°†byteæ•°ç»„çœ‹æˆ ä½æ•°ç»„ æ¥å¤„ç†ã€‚</p><p>Redis çš„ä½æ•°ç»„æ˜¯è‡ªåŠ¨æ‰©å±•ï¼Œå¦‚æœè®¾ç½®äº†æŸä¸ªåç§»ä½ç½®è¶…è¿‡äº†ç°æœ‰çš„å†…å®¹èŒƒå›´ï¼Œå°±ä¼šè‡ªåŠ¨å°†ä½æ•°ç»„è¿›è¡Œé›¶æ‰©å……ã€‚</p><h4 id="4-3-1-åŸºæœ¬ä½¿ç”¨"><a href="#4-3-1-åŸºæœ¬ä½¿ç”¨" class="headerlink" title="4.3.1 åŸºæœ¬ä½¿ç”¨"></a>4.3.1 åŸºæœ¬ä½¿ç”¨</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&gt; setbit bitArray01 1 1</span><br><span class="line">(integer)0</span><br><span class="line">&gt; setbit bitArray01 2 1</span><br><span class="line">(integer)0</span><br><span class="line">&gt; setbit bitArray01 4 1</span><br><span class="line">(integer)0</span><br><span class="line">&gt; setbit bitArray01 9 1</span><br><span class="line">(integer)0</span><br><span class="line">&gt; setbit bitArray01 10 1</span><br><span class="line">(integer)0</span><br><span class="line">&gt; setbit bitArray01 13 1</span><br><span class="line">(integer)0</span><br><span class="line">&gt; setbit bitArray01 15 1</span><br><span class="line">(integer)0</span><br><span class="line">&gt; get bitArray01</span><br><span class="line">&quot;he&quot;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä¾‹å­ï¼Œå¯ä»¥ç†è§£ä¸º é›¶å­˜æ•´å–ï¼ŒåŒæ ·ä¹Ÿå¯ä»¥ é›¶å­˜é›¶å–ï¼Œæ•´å­˜æ•´å–ã€‚é›¶å­˜ï¼šå°±æ˜¯ä½¿ç”¨ setbit å¯¹ä½å€¼ è¿›è¡Œé€ä¸ªè®¾ç½®ã€‚æ•´å­˜ï¼šå°±æ˜¯ä½¿ç”¨å­—ç¬¦ä¸²ä¸€æ¬¡æ€§å¡«å……æ‰€æœ‰ä½æ•°ç»„ï¼Œè¦†ç›–æ‰æ—§å€¼ã€‚</p><h4 id="4-3-2-ç»Ÿè®¡å’ŒæŸ¥æ‰¾"><a href="#4-3-2-ç»Ÿè®¡å’ŒæŸ¥æ‰¾" class="headerlink" title="4.3.2 ç»Ÿè®¡å’ŒæŸ¥æ‰¾"></a>4.3.2 ç»Ÿè®¡å’ŒæŸ¥æ‰¾</h4><p>Redis æä¾›äº†ä½å›¾ç»Ÿè®¡æŒ‡ä»¤ bitcount å’Œä½å›¾æŸ¥æ‰¾æŒ‡ä»¤ bitposï¼Œbitcount ç”¨æ¥ç»Ÿè®¡æŒ‡å®šä½ç½®èŒƒå›´å†… 1 çš„ä¸ªæ•°ï¼Œbitops ç”¨æ¥æŸ¥æ‰¾æŒ‡å®šèŒƒå›´å†…å‡ºç°çš„ç¬¬ä¸€ä¸ª 0æˆ–1ã€‚</p><p>é—æ†¾çš„æ˜¯ï¼Œstart å’Œ end å‚æ•°æ˜¯ å­—èŠ‚ç´¢å¼•ï¼Œä¹Ÿå°±æ˜¯è¯´æŒ‡å®šçš„ä½èŒƒå›´å¿…é¡»æ˜¯ 8çš„å€æ•°ï¼Œè€Œä¸èƒ½ä»»æ„æŒ‡å®šã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">set w hello# æ•´å­˜</span><br><span class="line">bitcount w 0 0 # ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸­1çš„ä½æ•°</span><br><span class="line">bitcount w 0 1 # å‰ä¸¤ä¸ªå­—ç¬¦ä¸­1çš„ä½æ•°</span><br><span class="line">bitops w 0 # ç¬¬ä¸€ä¸ªé›¶ä½</span><br><span class="line">bitops w 1 0 1 2 # ç¬¬äºŒåˆ°ç¬¬ä¸‰å­—ç¬¦ä¸­ ç¬¬ä¸€ä¸ªå‡ºç°1çš„ä½ç½®</span><br></pre></td></tr></table></figure><h4 id="4-3-3-é­”æœ¯æŒ‡ä»¤-bitfield"><a href="#4-3-3-é­”æœ¯æŒ‡ä»¤-bitfield" class="headerlink" title="4.3.3 é­”æœ¯æŒ‡ä»¤ bitfield"></a>4.3.3 é­”æœ¯æŒ‡ä»¤ bitfield</h4><p>ä¹‹å‰æˆ‘ä»¬è®¾ç½®æˆ–è€…è·å– æŒ‡å®šä½çš„å€¼ éƒ½æ˜¯å•ä¸ªä½çš„ï¼Œå¦‚æœè¦ä¸€æ¬¡æ“ä½œå¤šä¸ªä½ï¼Œå°±å¿…é¡»è¦ä½¿ç”¨ç®¡é“æ¥å¤„ç†ã€‚Redis3.2ä¹‹åï¼Œæ–°å¢å‘½ä»¤ bitfield å¯ä»¥ä½¿ç”¨ã€‚å…¶ä¸‹æœ‰ä¸‰ä¸ªå­æŒ‡ä»¤åˆ†åˆ«æ˜¯ get&#x2F;set&#x2F;incrbyï¼Œå®ƒä»¬éƒ½å¯ä»¥å¯¹æŒ‡å®šä½ç‰‡æ®µè¿›è¡Œè¯»å†™ï¼Œä½†æ˜¯æœ€å¤šåªèƒ½å¤„ç†64ä¸ªè¿ç»­çš„ä½ï¼Œå¦‚æœè¶…è¿‡64ä½ï¼Œå°±å¾—ä½¿ç”¨å¤šä¸ªå­æŒ‡ä»¤ï¼Œbitfield å¯ä»¥ä¸€æ¬¡æ‰§è¡Œå¤šä¸ªå­æŒ‡ä»¤ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">set w hello</span><br><span class="line">bitfield w get u4 0 # ä»ç¬¬ä¸€ä½å¼€å§‹å–4ä¸ªä½ï¼Œå–å‡ºç»“æœä¸ºæ— ç¬¦å·æ•°ï¼ˆuï¼‰</span><br><span class="line">bitfield w get i3 2 # ä»ç¬¬ä¸‰ä½å¼€å§‹å–3ä¸ªä½ï¼Œå–å‡ºç»“æœä¸ºæœ‰ç¬¦å·æ•°ï¼ˆiï¼‰</span><br><span class="line">bitfield w get u4 0 get i3 2 # å¯ä»¥ä¸€æ¬¡æ‰§è¡Œå¤šä¸ªå­æŒ‡ä»¤</span><br><span class="line">bitfield w et u8 8 97 #ä»ç¬¬8ä¸ªä½å¼€å§‹ï¼Œå°†æ¥ä¸‹æ¥çš„8ä¸ªä½ ç”¨æ— ç¬¦å·æ•°97 æ›¿æ¢</span><br></pre></td></tr></table></figure><p>æ‰€è°“æœ‰ç¬¦å·æ•°æ˜¯æŒ‡ å–å‡ºæ¥çš„ä½æ•°ç»„ä¸­ç¬¬ä¸€ä¸ªä½æ˜¯å½“ä½œç¬¦å·ä½ï¼Œå‰©ä¸‹çš„æ‰æ˜¯å€¼ã€‚å¦‚æœç¬¬ä¸€ä½æ˜¯1ï¼Œé‚£å°±æ˜¯è´Ÿæ•°ã€‚æ— ç¬¦å·æ•°è¡¨ç¤ºéè´Ÿæ•°ï¼Œæ²¡æœ‰ç¬¦å·ä½ï¼Œè·å–åˆ°ä½æ•°ç»„å…¨éƒ¨éƒ½æ˜¯å€¼ã€‚æœ‰ç¬¦å·æ•° æœ€å¤šå¯ä»¥è·å–64ä½ï¼Œæ— ç¬¦å·æ•° åªèƒ½è·å–63ä½ã€‚</p><p>ç¬¬ä¸‰ä¸ªæŒ‡ä»¤ incrbyï¼Œå®ƒç”¨æ¥å¯¹æŒ‡å®šèŒƒå›´çš„ä½è¿›è¡Œè‡ªå¢æ“ä½œã€‚æ—¢ç„¶æåˆ°äº†è‡ªå¢ï¼Œå°±æœ‰å¯èƒ½å‡ºç°æº¢å‡ºã€‚å¦‚æœå¢åŠ äº†æ­£æ•°ï¼Œä¼šå‡ºç°ä¸Šæº¢ã€‚å¦‚æœå¢åŠ è´Ÿæ•°ï¼Œä¼šå‡ºç°ä¸‹æº¢å‡ºã€‚å¦‚æœå‡ºç°æº¢å‡ºï¼Œå°±å°†æº¢å‡ºçš„ç¬¦å·ä½ä¸¢æ‰ã€‚å¦‚æœæ˜¯8ä½æ— ç¬¦å·æ•°255ï¼ŒåŠ 1å°±å˜æˆ 0ã€‚</p><h3 id="4-4-HyperLogLog"><a href="#4-4-HyperLogLog" class="headerlink" title="4.4 HyperLogLog"></a>4.4 HyperLogLog</h3><p>HyperLogLogæä¾›çš„æ˜¯ä¸€ä¸ªä¸ç²¾ç¡®ä½†æ˜¯èŠ‚çœç©ºé—´çš„å»é‡è®¡æ•°æ–¹æ¡ˆï¼šå¦‚æœé¡µé¢è®¿é—®é‡éå¸¸å¤§ï¼Œæ¯”å¦‚ä¸€ä¸ªçˆ†æ¬¾é¡µé¢å‡ åƒä¸‡çš„ UVï¼Œå°±éœ€è¦ä¸€ä¸ªå¾ˆå¤§çš„ Seté›†åˆ æ¥ç»Ÿè®¡ï¼Œè¿™å°±éå¸¸æµªè´¹ç©ºé—´ã€‚å¦‚æœè¿™æ ·çš„é¡µé¢å¾ˆå¤šï¼Œé‚£æ‰€éœ€è¦çš„å­˜å‚¨ç©ºé—´æ˜¯æƒŠäººçš„ã€‚å¦‚æœå¯¹ç»Ÿè®¡ç²¾ç¡®åº¦ä¸éœ€è¦å¤ªç²¾ç¡®ï¼Œå°±å¯ä»¥ä½¿ç”¨HyperLogLogï¼Œå®ƒçš„æ ‡å‡†è¯¯å·®æ˜¯0.81%ã€‚</p><h4 id="4-4-1-ä½¿ç”¨æ–¹æ³•"><a href="#4-4-1-ä½¿ç”¨æ–¹æ³•" class="headerlink" title="4.4.1 ä½¿ç”¨æ–¹æ³•"></a>4.4.1 ä½¿ç”¨æ–¹æ³•</h4><p>HyperLogLog æä¾›äº†ä¸¤ä¸ªæŒ‡ä»¤ pfadd å’Œ pfcountï¼Œä¸€ä¸ªæ˜¯å¢åŠ è®¡æ•°ï¼Œä¸€ä¸ªæ˜¯è·å–è®¡æ•°ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; pfadd w user1</span><br><span class="line">(integer)1</span><br><span class="line">&gt; pcount w</span><br><span class="line">(integer)1</span><br></pre></td></tr></table></figure><p>é™¤äº†ä¸Šé¢ä¸¤ä¸ªæŒ‡ä»¤ï¼Œè¿˜æœ‰ä¸€ä¸ª pfmergeï¼Œç”¨äºå°†å¤šä¸ª pf è®¡æ•°å€¼ç´¯è®¡åœ¨ä¸€èµ·å½¢æˆä¸€ä¸ªæ–°çš„ pf å€¼ã€‚</p><h4 id="4-4-2-æ•°å­¦åŸç†"><a href="#4-4-2-æ•°å­¦åŸç†" class="headerlink" title="4.4.2 æ•°å­¦åŸç†"></a>4.4.2 æ•°å­¦åŸç†</h4><p><strong>æå¤§ä¼¼ç„¶ä¼°è®¡çš„ç›´è§‚ç†è§£</strong></p><p>å…¶ä½¿ç”¨çš„æ•°å­¦åŸç†æ˜¯ç»Ÿè®¡å­¦ä¸­çš„æå¤§ä¼¼ç„¶ä¼°è®¡ã€‚æ¥ä¸‹å»æˆ‘å°†ç”¨å¤šä¸ªåœºæ™¯é€æ­¥æ·±å…¥è§£æã€‚<br><strong>åœºæ™¯1ï¼š</strong>ç°åœ¨æœ‰2ä¸ªä¸é€æ˜çš„å£è¢‹ï¼Œå…¶ä¸­éƒ½è£…æœ‰100ä¸ªçƒï¼ŒAå£è¢‹ä¸­æ˜¯99ä¸ªç™½çƒ1ä¸ªé»‘çƒï¼ŒBå£è¢‹ä¸­æ˜¯99ä¸ªé»‘çƒ1ä¸ªç™½çƒã€‚å½“æˆ‘ä»¬éšæœºæŒ‘é€‰ä¸€ä¸ªå£è¢‹ï¼Œç„¶åä»ä¸­æ‹¿å‡ºä¸€ä¸ªçƒã€‚å¦‚æœæ‹¿å‡ºçš„çƒæ˜¯ç™½è‰²çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è¯´â€œå¤§æ¦‚ç‡â€æˆ‘ä»¬å–å‡ºçš„æ˜¯Aå£è¢‹ã€‚è¿™ç§ç›´è§‰çš„æ¨æµ‹å…¶å®å°±åŒ…å«äº†â€œæå¤§ä¼¼ç„¶ä¼°è®¡â€çš„æ€æƒ³ã€‚</p><p><strong>åœºæ™¯2ï¼š</strong>æˆ‘ä»¬åªä¿ç•™Aå£è¢‹ï¼Œå…¶ä¸­99ä¸ªç™½çƒï¼Œ1ä¸ªé»‘çƒã€‚å¾ˆå®¹æ˜“æˆ‘ä»¬å°±å¯ä»¥å¾—å‡ºç»“è®ºï¼Œä»ä¸­å–å‡ºä»»æ„ä¸€ä¸ªçƒï¼Œæ˜¯ç™½çƒçš„æ¦‚ç‡ä¸º99%ï¼Œæ˜¯é»‘çƒçš„æ¦‚ç‡ä¸º1%ã€‚è¿™æ˜¯ä¸€ç§<strong>æ­£å‘çš„æ¨æµ‹</strong>ï¼š<br><em>æˆ‘ä»¬çŸ¥é“äº†</em>**<em>æ¡ä»¶ï¼ˆ99ä¸ªç™½çƒï¼Œ1ä¸ªé»‘çƒï¼‰*<em><strong>ï¼Œä»è€Œæ¨æµ‹å‡º</strong></em></em>ç»“æœï¼ˆå–å‡ºä»»æ„ä¸€ä¸ªçƒï¼Œæ˜¯ç™½çƒçš„æ¦‚ç‡ä¸º99%ï¼‰***ã€‚<br>ä½†è¿™åªæ˜¯ç†è®ºä¸Šçš„æ¨æµ‹ï¼Œå¦‚æœå®é™…å–çƒ100æ¬¡ï¼Œæ¯æ¬¡éƒ½æ”¾å›ï¼Œé‚£ä¹ˆå–å‡ºé»‘çƒçš„æ¬¡æ•°å¹¶ä¸ä¸€å®šæ˜¯1æ¬¡ï¼Œå¯èƒ½æ˜¯0æ¬¡ï¼Œä¹Ÿå¯èƒ½è¶…è¿‡1æ¬¡ã€‚æˆ‘ä»¬å–çƒçš„æ¬¡æ•°è¶Šå¤šï¼Œå®é™…æƒ…å†µå°†è¶Šç¬¦åˆç†è®ºæƒ…å†µã€‚</p><p><strong>åœºæ™¯3ï¼š</strong>è¿˜æ˜¯Aå£è¢‹ï¼Œåªä¸è¿‡æ­¤æ—¶å…¶ä¸­ç™½çƒå’Œé»‘çƒçš„æ•°é‡æˆ‘ä»¬å¹¶ä¸çŸ¥æ™“ã€‚äºæ˜¯æˆ‘ä»¬å¼€å§‹ä»ä¸­æ‹¿çƒï¼Œæ¯æ‹¿å‡ºä¸€ä¸ªçƒéƒ½è®°å½•ä¸‹ç»“æœï¼Œå¹¶å°†å…¶æ”¾å›ã€‚å¦‚æœæˆ‘ä»¬å–çƒ100æ¬¡ï¼Œå…¶ä¸­99æ¬¡æ˜¯ç™½çƒï¼Œ1æ¬¡æ˜¯é»‘çƒï¼Œæˆ‘ä»¬å¯ä»¥è¯´Aå£è¢‹ä¸­å¯èƒ½æ˜¯99ä¸ªç™½çƒï¼Œä½†å¹¶ä¸èƒ½éå¸¸è‚¯å®šã€‚å½“æˆ‘ä»¬å–çƒ10000æ¬¡çš„æ—¶å€™ï¼Œå…¶ä¸­9900æ¬¡æ˜¯ç™½çƒï¼Œ100æ¬¡æ˜¯é»‘çƒï¼Œæ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥å¤§æ¦‚ç‡ç¡®å®šAå£è¢‹ä¸­æ˜¯99ä¸ªç™½çƒï¼Œè€Œè¿™ç§ç¡®å®šç¨‹åº¦éšç€æˆ‘ä»¬å®é™…å–çƒæ¬¡æ•°çš„å¢åŠ ä¹Ÿå°†ä¸æ–­å¢åŠ ã€‚è¿™å°±æ˜¯ä¸€ç§<strong>åå‘çš„æ¨æµ‹</strong>ï¼š<br><em>æˆ‘ä»¬è§‚å¯Ÿäº†</em>**<em>ç»“æœï¼ˆå–10000æ¬¡çƒï¼Œ9900æ¬¡æ˜¯ç™½çƒï¼Œ100æ¬¡æ˜¯é»‘çƒï¼‰*<em><strong>ï¼Œå¯ä»¥æ¨æµ‹å‡º</strong></em></em>æ¡ä»¶ï¼ˆAå£è¢‹ä¸­æ”¾äº†99ä¸ªç™½çƒï¼Œ1ä¸ªé»‘çƒï¼‰***ã€‚<br>å½“ç„¶è¿™ç§æ¨æµ‹çš„ç»“æœå¹¶éæ˜¯å‡†ç¡®çš„ï¼Œè€Œæ˜¯ä¸€ç§å¤§æ¦‚ç‡çš„ä¼°è®¡ã€‚<br>æ— è®ºæ˜¯æ­£å‘æ¨æµ‹æˆ–æ˜¯åå‘æ¨æµ‹ï¼Œåªæœ‰å½“å®é™…æ‰§è¡Œæ“ä½œçš„æ¬¡æ•°è¶³å¤Ÿå¤šçš„æ—¶å€™ï¼Œæ‰èƒ½ä½¿å¾—å®é™…æƒ…å†µæ›´æ¥è¿‘ç†è®ºæ¨æµ‹ã€‚è¿™å°±éå¸¸ç¬¦åˆhyperloglogçš„ç‰¹ç‚¹ï¼Œåªæœ‰å½“æ•°æ®é‡è¶³å¤Ÿå¤§çš„æ—¶å€™ï¼Œè¯¯å·®æ‰ä¼šè¶³å¤Ÿå°ã€‚</p><p>å› æ­¤æå¤§ä¼¼ç„¶ä¼°è®¡çš„æœ¬è´¨å°±æ˜¯ï¼šå½“èƒ½è§‚å¯Ÿçš„ç»“æœæ•°é‡è¶³å¤Ÿå¤šæ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¤§æ¦‚ç‡ç¡®å®šäº§ç”Ÿç›¸åº”ç»“æœæ‰€éœ€è¦çš„æ¡ä»¶çš„çŠ¶æ€ã€‚è¿™ç§é€šè¿‡å¤§é‡ç»“æœåå‘ä¼°è®¡æ¡ä»¶çš„æ•°å­¦æ–¹æ³•å°±æ˜¯æå¤§ä¼¼ç„¶ä¼°è®¡ã€‚</p><p><strong>ä¼¯åŠªåˆ©å®éªŒä¸æå¤§ä¼¼ç„¶ä¼°è®¡</strong></p><p>äº†è§£æå¤§ä¼¼ç„¶ä¼°è®¡ä¹‹åï¼Œæˆ‘ä»¬å°±éœ€è¦å¼•å…¥ç¬¬äºŒä¸ªæ•°å­¦æ¦‚å¿µï¼Œä¼¯åŠªåˆ©å®éªŒã€‚<br>ä¸è¦è¢«è¿™ä¸ªåå­—å”¬ä½ï¼Œä¼¯åŠªåˆ©å®éªŒå…¶å®å°±æ˜¯æ‰”ç¡¬å¸ï¼Œæ¥ä¸‹å»æˆ‘ä»¬å°±æ¥äº†è§£ä¸‹è¿™æšç¡¬å¸è¦æ€ä¹ˆæ‰”ã€‚ä¸‹æ–‡æ‰€è¯´çš„ç¡¬å¸éƒ½æ˜¯æœ€æ™®é€šçš„ç¡¬å¸ï¼Œåªæœ‰æ­£åä¸¤é¢ï¼Œä¸”æ¯ä¸€é¢æœä¸Šçš„æ¦‚ç‡éƒ½æ˜¯50%ã€‚<br><strong>åœºæ™¯1ï¼š</strong>æˆ‘ä»¬éšæœºæ‰”ä¸€æ¬¡ç¡¬å¸ï¼Œé‚£ä¹ˆå¾—åˆ°æ­£é¢æˆ–åé¢çš„å¯èƒ½æ€§æ˜¯ç›¸åŒçš„ã€‚å¦‚æœæˆ‘ä»¬æ‰”10000æ¬¡ç¡¬å¸ï¼Œé‚£ä¹ˆå¯ä»¥ä¼°è®¡åˆ°å¤§æ¦‚ç‡æ˜¯æ¥è¿‘5000æ¬¡æ­£é¢ï¼Œ5000æ¬¡åé¢ã€‚è¿™æ˜¯æœ€ç®€å•çš„æ­£å‘æ¨æµ‹ã€‚</p><p><strong>åœºæ™¯2ï¼š</strong>å¦‚æœæˆ‘ä»¬æ‰”2æ¬¡ç¡¬å¸ï¼Œæ˜¯å¦å¯èƒ½2æ¬¡éƒ½æ˜¯æ­£é¢ï¼Ÿå½“ç„¶æœ‰å¯èƒ½ï¼Œå¹¶ä¸”æ¦‚ç‡ä¸º1&#x2F;4ã€‚å¦‚æœæˆ‘ä»¬æ‰”10æ¬¡ç¡¬å¸å‘¢ï¼Œæ˜¯å¦å¯èƒ½10æ¬¡éƒ½æ˜¯æ­£é¢ï¼Ÿè™½ç„¶æ¦‚ç‡å¾ˆå°ï¼Œä½†ä¾ç„¶æ˜¯æœ‰å¯èƒ½çš„ï¼Œæ¦‚ç‡ä¸º1&#x2F;1024ã€‚åŒæ ·çš„ï¼Œæ— è®ºæ˜¯100æ¬¡ã€1000æ¬¡ï¼Œå³ä½¿æ¦‚ç‡å¾ˆå°ï¼Œä¹Ÿä¾ç„¶å­˜åœ¨å…¨éƒ¨éƒ½æ˜¯æ­£é¢æœä¸Šçš„æƒ…å†µï¼Œå‡å¦‚æ‰”äº†næ¬¡ï¼Œé‚£ä¹ˆnæ¬¡éƒ½æ˜¯æ­£é¢çš„æ¦‚ç‡ä¸º12ğ‘›12ï¿½ã€‚è¿™ä¹Ÿæ˜¯æ­£å‘çš„æ¨æµ‹ï¼Œåªä¸è¿‡å¢åŠ äº†å…¨éƒ½æ˜¯æ­£é¢æœä¸Šçš„é™å®šã€‚</p><p><strong>åœºæ™¯3ï¼š</strong>ç°åœ¨æˆ‘ä»¬æŒ‰ä¸‹é¢è¿™ç§è§„åˆ™æ‰”ç¡¬å¸ï¼šä¸æ–­æ‰”ç¡¬å¸ï¼Œå¦‚æœæ˜¯æ­£é¢æœä¸Šï¼Œé‚£ä¹ˆå°±ç»§ç»­æ‰”ï¼Œç›´åˆ°å‡ºç°åé¢æœä¸Šï¼Œæ­¤æ—¶è®°å½•ä¸‹æ‰”ç¡¬å¸çš„æ€»æ¬¡æ•°ã€‚ä¾‹å¦‚æˆ‘ä»¬æŠ›äº†5æ¬¡ç¡¬å¸ï¼Œå‰4æ¬¡éƒ½æ˜¯æ­£é¢æœä¸Šï¼Œç¬¬5æ¬¡æ˜¯åé¢æœä¸Šï¼Œæˆ‘ä»¬å°±è®°å½•ä¸‹æ¬¡æ•°5ã€‚é€šè¿‡åœºæ™¯2ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“è¿™ç§æƒ…å†µå‘ç”Ÿçš„æ¦‚ç‡ä¸º1&#x2F;32ã€‚æŒ‰æˆ‘ä»¬çš„ç›´è§‰å¯ä»¥æ¨æµ‹ï¼Œå¦‚æœä¸€ä¸ªç»“æœå‘ç”Ÿçš„æ¦‚ç‡æ˜¯1&#x2F;32ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¤§ä½“ä¸Šå°±éœ€è¦åš32æ¬¡åŒæ ·çš„äº‹æƒ…æ‰èƒ½å¾—åˆ°è¿™ä¸ªç»“æœï¼ˆå½“ç„¶ä»æ›´ä¸¥è°¨çš„æ•°å­¦è§’åº¦ï¼Œå¹¶ä¸èƒ½è¿™ä¹ˆè¯´ï¼Œä½†æœ¬æ–‡ä¸æƒ³æ¶‰åŠä¸“ä¸šçš„æ•°å­¦æè¿°ï¼Œæ‰€ä»¥å§‘ä¸”è¿™ä¹ˆç†è§£ï¼Œå…¶å®ä¹ŸæŒºç¬¦åˆä¸€èˆ¬å¸¸è¯†åˆ¤æ–­çš„ï¼‰ã€‚<br>é‚£ä¹ˆå‡å¦‚å¼ ä¸‰åšäº†è‹¥å¹²æ¬¡è¿™ç§å®éªŒï¼Œæˆ‘è§‚å¯Ÿç»“æœï¼Œå‘ç°è®°å½•ä¸‹çš„æ€»æ¬¡æ•°çš„<strong>æœ€å¤§å€¼</strong>æ˜¯5ï¼Œé‚£å°±è¯´æ˜åœ¨è¿™è‹¥å¹²æ¬¡å®éªŒä¸­ï¼Œè‡³å°‘å‘ç”Ÿäº†ä¸€æ¬¡4æ¬¡æ­£é¢æœä¸Šï¼Œç¬¬5æ¬¡åé¢æœä¸Šçš„æƒ…å†µï¼Œè€Œè¿™ç§æƒ…å†µå‘ç”Ÿçš„æ¦‚ç‡æ˜¯1&#x2F;32ï¼Œäºæ˜¯æˆ‘æ¨æµ‹ï¼Œå¼ ä¸‰å¤§æ¦‚ç‡æ€»å…±åšäº†32æ¬¡å®éªŒã€‚è¿™å°±æ˜¯ä¸€ç§åå‘æ¨æµ‹ï¼š<br><em>å³æ ¹æ®</em><strong><em>ç»“æœï¼ˆå‘ç”Ÿäº†ä¸€æ¬¡1&#x2F;32æ¦‚ç‡æ‰ä¼šå‡ºç°çš„ç»“æœï¼‰*<em><strong>ï¼Œæ¨æµ‹</strong></em></em>æ¡ä»¶ï¼ˆå¤§æ¦‚ç‡åšäº†32æ¬¡å®éªŒï¼‰*<strong>ã€‚<br>æ›´é€šä¿—æ¥è¯´ï¼Œå¦‚æœä¸€ä¸ªç»“æœå‡ºç°çš„æ¦‚ç‡å¾ˆå°ï¼Œä½†å´å®é™…å‘ç”Ÿäº†äº†ï¼Œå°±å¯ä»¥æ¨æµ‹è¿™ä»¶äº‹æƒ…è¢«é‡å¤æ‰§è¡Œäº†å¾ˆå¤šæ¬¡ã€‚ç»“æœå‡ºç°çš„æ¦‚ç‡è¶Šå°ï¼Œäº‹æƒ…è¢«é‡å¤æ‰§è¡Œçš„æ¬¡æ•°å°±åº”å½“è¶Šå¤šã€‚å°±åƒç”Ÿæ´»ä¸­ä¸­å½©ç¥¨çš„æ¦‚ç‡å¾ˆä½ï¼Œæ™®é€šäººå¦‚æœæƒ³ä¸­é‚£å¯ä¸å°±å¾—ä¹°å¾ˆå¤šæ¬¡å˜›ï¼Œä¸­å¥–æ¦‚ç‡è¶Šä½ï¼Œä¸€èˆ¬éœ€è¦è´­ä¹°å½©ç¥¨çš„æ¬¡æ•°å°±è¶Šå¤šã€‚ç›¸åº”çš„å¦‚æœä¸€ä¸ªäººä¸­å¥–äº†ï¼Œæˆ‘ä»¬å¯ä»¥è¯´è¿™ä¸ªäºº</strong>å¤§æ¦‚ç‡</strong>ä¸Šè´­ä¹°äº†éå¸¸å¤šæ¬¡å½©ç¥¨ã€‚è¿™å°±æ˜¯ä¼¯åŠªåˆ©å®éªŒä¸æå¤§ä¼¼ç„¶ä¼°è®¡ç»“åˆçš„é€šä¿—ç†è§£ã€‚</p><p><strong>å¦å¤–ç‰¹åˆ«æ³¨æ„çš„ï¼Œæˆ‘ä»¬æ¨æµ‹æ¡ä»¶æ—¶ï¼Œéœ€è¦è§‚å¯Ÿçš„æ€»æ¬¡æ•°çš„æœ€å¤§å€¼ï¼Œå› ä¸ºæœ€å¤§å€¼ä»£è¡¨äº†æœ€å°æ¦‚ç‡ï¼Œè€Œæœ€å°æ¦‚ç‡æ‰æ˜¯æ¨æµ‹æ¡ä»¶çš„ä¾æ®ã€‚ä¸‹æ–‡redisåŒç†ã€‚</strong></p><h4 id="4-4-3-rediså®ç°"><a href="#4-4-3-rediså®ç°" class="headerlink" title="4.4.3 rediså®ç°"></a>4.4.3 rediså®ç°</h4><p>rediså®ç°æœ¬è´¨ä¹Ÿæ˜¯åˆ©ç”¨äº†â€œæ‰”ç¡¬å¸â€äº§ç”Ÿçš„â€œæå¤§ä¼¼ç„¶ä¼°è®¡â€åŸç†ï¼Œå› æ­¤æ¥ä¸‹å»æˆ‘ä»¬å°±è¯¦ç»†çœ‹çœ‹redisæ˜¯æ€ä¹ˆæ‰”ç¡¬å¸çš„ã€‚<br>åœ¨ä¼¯åŠªåˆ©è¯•éªŒçš„åœºæ™¯3ä¸­ï¼Œæˆ‘ä»¬åšçš„å®éªŒæœ‰3ä¸ªç‰¹ç‚¹ï¼š<br>1.ç¡¬å¸åªæœ‰æ­£åä¸¤é¢ã€‚<br>2.ç¡¬å¸æ­£åé¢å‡ºç°çš„æ¦‚ç‡ç›¸åŒã€‚<br>2.å•æ¬¡å®éªŒéœ€è¦æŠ•æ·å¤šæ¬¡ç¡¬å¸ã€‚</p><p>è€Œè®¡ç®—æœºä¸­çš„hashç®—æ³•æ­£å¥½å¯ä»¥æ»¡è¶³è¿™3ä¸ªæ¡ä»¶ï¼š<br>1.hashç»“æœçš„æ¯ä¸€ä¸ªbitåªæœ‰0å’Œ1ï¼Œä»£è¡¨ç¡¬å¸çš„æ­£åä¸¤é¢ã€‚<br>2.å¦‚æœhashç®—æ³•è¶³å¤Ÿå¥½ï¼Œå¾—åˆ°çš„ç»“æœå°±è¶³å¤Ÿéšæœºï¼Œå¯ä»¥è¿‘ä¼¼è®¤ä¸ºæ¯ä¸€ä¸ªbitçš„0å’Œ1äº§ç”Ÿçš„æ¦‚ç‡æ˜¯ç›¸åŒçš„ã€‚<br>3.hashçš„ç»“æœå¦‚æœæ˜¯64ä¸ªbitï¼Œæ­£å¥½ä»£è¡¨æŠ•æ·äº†64æ¬¡ç¡¬å¸ã€‚</p><p>å› æ­¤æ‰§è¡Œä¸€æ¬¡hashï¼Œå°±ç›¸å½“äºå®Œæ•´åœ°è¿›è¡Œäº†ä¸€æ¬¡åœºæ™¯3ä¸­çš„æŠ•å¸å®éªŒã€‚æŒ‰ç…§çº¦å®šï¼Œå®éªŒå®Œæˆåï¼Œæˆ‘ä»¬éœ€è¦è®°å½•ç¡¬å¸æŠ•æ·çš„ç»“æœã€‚<br>å‡å®šç°åœ¨æœ‰2ä¸ªç”¨æˆ·idï¼›user1ã€user2<br>å…ˆå¯¹user1è¿›è¡Œhashï¼Œå‡å®šå¾—åˆ°å¦‚ä¸‹8ä¸ªbitçš„ç»“æœï¼š<br>10100100<br>æ­¤æ—¶ä»å³åˆ°å·¦ï¼Œæˆ‘ä»¬çº¦å®š0è¡¨ç¤ºåé¢ï¼Œ1è¡¨ç¤ºæ­£é¢ï¼Œäºæ˜¯åœ¨è¿™æ¬¡å®éªŒä¸­ï¼Œç¬¬ä¸€ä¸ªä¸º1çš„bitå‡ºç°åœ¨ç¬¬ä¸‰ä½ï¼Œç›¸å½“äºå…ˆæŠ•å‡ºäº†2æ¬¡åé¢ï¼Œç„¶åæŠ•å‡º1æ¬¡æ­£é¢ï¼Œäºæ˜¯æˆ‘ä»¬è®°å½•ä¸‹è¿™æ¬¡å®éªŒçš„æŠ•æ·æ¬¡æ•°ä¸º3ã€‚å› ä¸ºçº¦å®šåªè¦æŠ•å‡ºæ­£é¢ï¼Œå½“æ¬¡å®éªŒå°±ç»“æŸï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ª1å·¦è¾¹çš„æ‰€æœ‰bitå°±ä¸å†è€ƒè™‘äº†ã€‚<br>å†å¯¹user2è¿›è¡Œhashï¼Œå‡å®šå¾—åˆ°ï¼š<br>01101000<br>ç¬¬ä¸€ä¸ªä¸º1çš„bitå‡ºç°åœ¨ç¬¬4ä½ï¼Œäºæ˜¯è®°å½•ä¸‹4ã€‚<br>å¯¹äº<strong>æ¯ä¸ªç”¨æˆ·çš„è®¿é—®è¯·æ±‚ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥å¯¹ç”¨æˆ·çš„idè¿›è¡Œhash</strong>ï¼ˆç›¸å½“äºåœºæ™¯3ä¸­è¿›è¡Œä¸€æ¬¡å®éªŒï¼‰ï¼Œå¹¶è®°å½•ä¸‹ç¬¬ä¸€ä¸ªä¸º1çš„bitå‡ºç°çš„ä½æ•°ï¼ˆç›¸å½“äºåœºæ™¯3ä¸­è®°å½•ä¸‹ç¡¬å¸çš„æŠ•æ·æ¬¡æ•°ï¼‰ï¼Œé‚£ä¹ˆ<strong>é€šè¿‡è®°å½•åˆ°çš„ä½æ•°çš„æœ€å¤§å€¼ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¤§æ¦‚ä¼°è®¡å‡ºä¸€å…±è¿›è¡Œäº†å¤šå°‘æ¬¡å®éªŒ</strong>ï¼ˆç›¸å½“äºåœºæ™¯3ä¸­çš„åå‘æ¨æµ‹ï¼‰ï¼Œä¹Ÿå°±æ˜¯æœ‰å¤šå°‘ä¸ªä¸åŒçš„ç”¨æˆ·å‘ç”Ÿäº†è®¿é—®ã€‚<br>ä¾‹å¦‚æŸä¸ªé¡µé¢æœ‰è‹¥å¹²ä¸ªç”¨æˆ·è¿›è¡Œäº†è®¿é—®ï¼Œæˆ‘ä»¬è§‚å¯Ÿè®°å½•ä¸‹çš„æ•°æ®ï¼Œå‘ç°è®°å½•ä¸‹çš„æœ€å¤§å€¼æ˜¯10ï¼Œå°±æ„å‘³ç€hashçš„ç»“æœè‡³å°‘å‡ºç°äº†ä¸€æ¬¡å³è¾¹9ä¸ªbitéƒ½ä¸º0çš„æƒ…å†µã€‚è€Œè¿™ç§æƒ…å†µå‘ç”Ÿçš„æ¦‚ç‡ä¸º1&#x2F;1024ï¼Œäºæ˜¯æˆ‘ä»¬å¯ä»¥æ¨æµ‹å¤§æ¦‚æœ‰1024ä¸ªç”¨æˆ·è®¿é—®è¿‡è¯¥é¡µé¢ï¼Œæ‰æœ‰å¯èƒ½å‡ºç°ä¸€æ¬¡è¿™ç§ç»“æœã€‚</p><p>æ‰€ä»¥å…¶å®å¯ä»¥è¿™æ ·ç†è§£ï¼š</p><p>æ¯ä¸ªç”¨æˆ·IDçš„ hashç»“æœç›¸å½“äºæ­¤ç”¨æˆ·çš„æŠ•å¸ç»“æœï¼Œæˆ‘ä»¬çœ‹ä¸‹ hashå€¼ä»å³å‘å·¦ç¬¬ä¸€æ¬¡å‡ºç°1çš„ä½ç½®ã€‚å¦‚æœæ¯”ä¹‹å‰ç”¨æˆ·hashè®°å½•å‡ºç°1çš„ä½ç½®æ›´é å·¦ï¼Œåˆ™è®°å½•ã€‚è¿™æ ·å¦‚æœæœ€åè®°å½•çš„æœ€å¤§å€¼æ˜¯10ï¼Œåˆ™å¯ä»¥æ¨æµ‹1024ä¸ªç”¨æˆ·è®¿é—®è¿‡ã€‚</p><p>åˆå› ä¸ºåŒä¸€ç”¨æˆ·ID hashç»“æœæ˜¯å”¯ä¸€çš„ï¼Œæ‰€ä»¥åŒä¸€ä¸ªç”¨æˆ·IDå³ä½¿å¤šæ¬¡å®éªŒï¼Œä¹Ÿä¸ä¼šå½±å“ç²¾å‡†æ€§ã€‚å½“ç”¨æˆ·è¶Šå¤šï¼Œåˆ™æˆ‘ä»¬é€šè¿‡æ¦‚ç‡æ¨æµ‹çš„ç”¨æˆ·æ•°é‡ è¶Šæ¥è¿‘å®é™…æƒ…å†µã€‚</p><h3 id="4-5-å¸ƒéš†è¿‡æ»¤å™¨"><a href="#4-5-å¸ƒéš†è¿‡æ»¤å™¨" class="headerlink" title="4.5 å¸ƒéš†è¿‡æ»¤å™¨"></a>4.5 å¸ƒéš†è¿‡æ»¤å™¨</h3><p>HyperLogLog å¯ä»¥ç”¨æ¥è¿›è¡Œä¼°å€¼ï¼Œå®ƒéå¸¸æœ‰ä»·å€¼ï¼Œå¯ä»¥è§£å†³å¾ˆå¤šç²¾ç¡®åº¦è¦æ±‚ä¸é«˜çš„ç»Ÿè®¡éœ€æ±‚ã€‚ä½†æ˜¯å¦‚æœæˆ‘ä»¬æƒ³è¦çŸ¥é“æŸä¸€ä¸ªå€¼æ˜¯ä¸æ˜¯å·²ç»ä¸åœ¨ HyperLogLog ç»“æ„é‡Œé¢äº†ï¼Œå®ƒå°±æ— èƒ½ä¸ºåŠ›çš„ã€‚</p><p>ç°å®ä¸­ï¼Œæ¯”å¦‚æ¨èç³»ç»Ÿï¼šç”¨æˆ·çš„è§†é¢‘æ¨èç³»ç»Ÿï¼Œæ¯æ¬¡æ¨è éœ€è¦æŸ¥çœ‹ç”¨æˆ·æ˜¯å¦è§‚çœ‹è¿‡æ­¤è§†é¢‘ã€‚é—®é¢˜æ˜¯ï¼Œå½“ç”¨æˆ·é‡å¾ˆå¤§ï¼Œæ¯ä¸ªç”¨æˆ·è§‚çœ‹è¿‡çš„è§†é¢‘æ€»æ•°åˆå¾ˆå¤§çš„æƒ…å†µä¸‹ï¼Œå»é‡å·¥ä½œåœ¨åœ¨æ€§èƒ½ä¸Šè€ƒéªŒå¾ˆå¤§ã€‚å¦‚æœæ•°æ®å­˜å‚¨åœ¨ å…³ç³»æ•°æ®åº“ä¸­ï¼Œå»é‡å°±éœ€è¦é¢‘ç¹åœ°å¯¹æ•°æ®åº“è¿›è¡Œ exists æŸ¥è¯¢ã€‚</p><p>å¦‚æœä½¿ç”¨ç¼“å­˜ï¼Œä½†æ˜¯è¿™ä¹ˆå¤šå†å²è®°å½•å…¨éƒ¨ç¼“å­˜èµ·æ¥ï¼Œå°±å¾—æµªè´¹å¾ˆå¤šå­˜å‚¨ç©ºé—´ã€‚å¸ƒéš†è¿‡æ»¤å™¨å¯ä»¥è§£å†³æ­¤é—®é¢˜ï¼Œå®ƒå¯ä»¥èµ·åˆ°å»é‡çš„åŒæ—¶ï¼Œåœ¨ç©ºé—´ä¸Šè¿˜èƒ½èŠ‚çœ90%ä»¥ä¸Šï¼Œåªæ˜¯ç¨å¾®é‚£ä¹ˆä¸ç²¾ç¡®ã€‚</p><p>å½“å¸ƒéš†è¿‡æ»¤å™¨è¯´ æŸä¸ªå€¼å­˜åœ¨æ—¶ï¼Œè¿™ä¸ªå€¼å¯èƒ½ä¸å­˜åœ¨ï¼›å½“å®ƒè¯´è¿™ä¸ªå€¼ä¸å­˜åœ¨æ—¶ï¼Œé‚£å°±è‚¯å®šä¸å­˜åœ¨ã€‚</p><p>é‚£ä¹ˆå¯ä»¥ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ åˆ¤æ–­ éœ€è¦æ¨èçš„æ—¶å€™ï¼Œæ˜¯å¦åœ¨ç”¨æˆ·è§‚çœ‹å†å²è®°å½•é›†åˆä¸­ã€‚å¦‚æœä¸åœ¨ï¼Œåˆ™æ¨èã€‚å¦‚æœåˆ¤æ–­åœ¨å†å²è®°å½•ä¸­ï¼Œå®é™…å¯èƒ½åœ¨ ä¹Ÿå¯èƒ½ä¸åœ¨ï¼Œå› ä¸ºä¼šæœ‰æ¦‚ç‡è¯¯åˆ¤ã€‚æ‰€ä»¥ å¯ä»¥ä¿è¯æ¨èçš„å†…å®¹è‚¯å®šæ˜¯ç”¨æˆ·æ²¡çœ‹è¿‡çš„ï¼Œä½†å¯èƒ½ ä¹Ÿä¼šæŠŠæå°‘é‡ç”¨æˆ·æ²¡æœ‰çœ‹è¿‡çš„å†…å®¹ è¯¯åˆ¤æˆç”¨æˆ·çœ‹è¿‡ï¼Œè€Œè¿‡æ»¤æ‰ã€‚</p><h4 id="4-5-1-åŸºæœ¬ä½¿ç”¨"><a href="#4-5-1-åŸºæœ¬ä½¿ç”¨" class="headerlink" title="4.5.1 åŸºæœ¬ä½¿ç”¨"></a>4.5.1 åŸºæœ¬ä½¿ç”¨</h4><p>Rediså®˜æ–¹æä¾›çš„å¸ƒéš†è¿‡æ»¤å™¨åˆ°äº†Redis4.0æä¾›äº†æ’ä»¶åŠŸèƒ½ä¹‹åæ­£å¼ç™»åœºã€‚å¯ä»¥é€šè¿‡dockerç›´æ¥ä½“éªŒ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; docker pull redislabs/rebloom</span><br><span class="line">&gt; docker run -p 6379:6379 redislabs/rebloom</span><br><span class="line">&gt; redis-cli</span><br></pre></td></tr></table></figure><p>å¸ƒéš†è¿‡æ»¤å™¨åŸºæœ¬æŒ‡ä»¤ï¼š</p><ul><li>bf.add [collection] [element]ï¼šæ·»åŠ  å…ƒç´ element è¿›å…¥ è¿‡æ»¤å™¨collection</li><li>bf.exists [collection] [element]ï¼šæŸ¥è¯¢ å…ƒç´ element æ˜¯å¦å­˜åœ¨ï¼Œè¿”å›1è¡¨ç¤ºå­˜åœ¨ï¼Œ0è¡¨ç¤ºä¸å­˜åœ¨</li><li>bf.madd [collection] [element01] [element02]ï¼šä¸€æ¬¡ æ·»åŠ å¤šä¸ª å…ƒç´ è¿›å…¥ è¿‡æ»¤å™¨</li><li>bf.mexistsï¼šä¸€æ¬¡ æŸ¥è¯¢å¤šä¸ªå…ƒç´  æ˜¯å¦åœ¨è¿‡æ»¤å™¨</li></ul><p>ä¸Šé¢æŒ‡ä»¤ä½¿ç”¨çš„å¸ƒéš†è¿‡æ»¤å™¨åªæ˜¯é»˜è®¤å‚æ•°çš„å¸ƒéš†è¿‡æ»¤å™¨ï¼Œå®ƒåœ¨å¤–é¢ç¬¬ä¸€æ¬¡addçš„æ—¶å€™è¢«è‡ªåŠ¨åˆ›å»ºã€‚Redisè¿˜æä¾›äº†è‡ªå®šä¹‰å‚æ•°çš„å¸ƒéš†è¿‡æ»¤å™¨ï¼Œéœ€è¦æˆ‘ä»¬åœ¨ add ä¹‹å‰ï¼Œä½¿ç”¨ bf.reserve æŒ‡ä»¤æ˜¾å¼åˆ›å»ºã€‚å¦‚æœå¯¹åº”çš„keyå·²ç»å­˜åœ¨äº†ï¼Œbf.reserve ä¼šæŠ¥é”™ã€‚bf.reserve æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ keyï¼Œerror_rate å’Œ initial_sizeã€‚é”™è¯¯ç‡è¶Šä½ï¼Œéœ€è¦çš„ç©ºé—´è¶Šå¤§ã€‚initial_size å‚æ•°è¡¨ç¤ºé¢„è®¡æ”¾å…¥çš„å…ƒç´ æ•°é‡ï¼Œå½“å®é™…æ•°é‡è¶…è¿‡è¿™ä¸ªå€¼ï¼Œè¯¯åˆ¤ç‡ä¼šä¸Šå‡ã€‚æ‰€ä»¥ä¸€èˆ¬ initial_size éœ€è¦è®¾ç½®ä¸€ä¸ªè¾ƒå¤§çš„æ•°å€¼ï¼Œé¿å…è¶…è¿‡ï¼Œå¯¼è‡´è¯¯åˆ¤ç‡å‡é«˜ã€‚å¦‚æœä¸ä½¿ç”¨ bf.reserveï¼Œé»˜è®¤çš„ error_rate æ˜¯ 0.01,é»˜è®¤çš„ initial_size æ˜¯ 100ã€‚</p><p>æ³¨æ„ï¼šå¦‚æœ initial_size ä¼°è®¡çš„è¿‡å¤§ï¼Œä¹Ÿä¼šæµªè´¹å­˜å‚¨ç©ºé—´ï¼Œä¼°è®¡çš„è¿‡å°ï¼Œå°±ä¼šå½±å“å‡†ç¡®ç‡ã€‚</p><h4 id="4-5-2-åŸç†"><a href="#4-5-2-åŸç†" class="headerlink" title="4.5.2 åŸç†"></a>4.5.2 åŸç†</h4><p>æ¯ä¸ªå¸ƒéš†è¿‡æ»¤å™¨åœ¨Redisçš„æ•°æ®ç»“æ„é‡Œé¢å°±æ˜¯ ä¸€ä¸ªå¤§å‹çš„ä½æ•°ç»„å’Œå‡ ä¸ªä¸ä¸€æ ·çš„æ— åhashå‡½æ•°ã€‚æ‰€ä»¥æ— åå°±æ˜¯èƒ½å¤ŸæŠŠå…ƒç´ çš„ hashå€¼ ç®—çš„æ¯”è¾ƒå‡åŒ€ã€‚</p><p>å‘è¿‡æ»¤å™¨ä¸­æ·»åŠ keyæ—¶ï¼Œä¼šä½¿ç”¨å¤šä¸ª hash å‡½æ•°å¯¹ key è¿›è¡Œ hashç®—å¾—ä¸€ä¸ªæ•´æ•°ç´¢å¼•å€¼ï¼Œç„¶åå¯¹ä½æ•°ç»„é•¿åº¦è¿›è¡Œå–æ¨¡è¿ç®—ï¼Œå¾—åˆ°ä¸€ä¸ªä½ç½®ã€‚æ¯ä¸ª hash å‡½æ•°éƒ½ä¼šç®—å¾—ä¸€ä¸ªä¸åŒçš„ä½ç½®ã€‚å†æŠŠä½æ•°ç»„çš„è¿™å‡ ä¸ªä½ç½®éƒ½ç½®ä¸º1ï¼Œå°±å®Œæˆäº† add æ“ä½œã€‚</p><p>å‘å¸ƒéš†è¿‡æ»¤å™¨è¯¢é—® key æ˜¯å¦å­˜åœ¨æ—¶ï¼Œè·Ÿ add ä¸€æ ·ï¼Œä¹Ÿä¼šæŠŠ hash å‡½æ•°çš„å‡ ä¸ªä½ç½®éƒ½è®¡ç®—å‡ºæ¥ï¼Œçœ‹çœ‹ ä½æ•°ç»„ä¸­ è¿™å‡ ä¸ªä½ç½®æ˜¯å¦éƒ½ ä¸º1ï¼Œåªè¦æœ‰ä¸€ä¸ªä¸º 0ï¼Œé‚£ä¹ˆè¯´æ˜å¸ƒéš†è¿‡æ»¤å™¨ä¸­ è¿™ä¸ªkeyä¸å­˜åœ¨ã€‚å¦‚æœéƒ½æ˜¯1ï¼Œè¿™å¹¶ä¸èƒ½è¯´æ˜è¿™ä¸ªkeyå°±ä¸€å®šå­˜åœ¨ï¼Œåªæ˜¯ææœ‰å¯èƒ½å­˜åœ¨ã€‚å› ä¸ºè¿™äº›ä½è¢«ç½®æˆ1ï¼Œå¯èƒ½æ˜¯å› ä¸ºæ·»åŠ å…¶ä»– key æ—¶å¯¼è‡´çš„ã€‚</p><p>å¦‚æœè¿™ä¸ª ä½æ•°ç»„æ¯”è¾ƒç¨€ç–ï¼Œè¿™ä¸ªè¯¯åˆ¤çš„æ¦‚ç‡å°±å¾ˆå°ï¼Œå¦‚æœè¿™ä¸ªæ•°ç»„æ¯”è¾ƒæ‹¥æŒ¤ï¼Œè¯¯åˆ¤çš„æ¦‚ç‡å°±ä¼šå˜å¤§ã€‚ä½¿ç”¨æ—¶å¦‚æœå®é™…å…ƒç´ å¼€å§‹è¶…è¿‡åˆå§‹åŒ–å¤§å°ï¼Œåº”è¯¥å¯¹å¸ƒéš†è¿‡æ»¤å™¨è¿›è¡Œé‡å»ºï¼Œé‡æ–°åˆ†é…ä¸€ä¸ªsizeæ›´å¤§çš„è¿‡æ»¤å™¨ï¼Œå†å°†æ‰€æœ‰å†å²å…ƒç´ æ‰¹é‡ add è¿›å»ã€‚</p><h4 id="4-5-3-ç©ºé—´å ç”¨ä¼°è®¡"><a href="#4-5-3-ç©ºé—´å ç”¨ä¼°è®¡" class="headerlink" title="4.5.3 ç©ºé—´å ç”¨ä¼°è®¡"></a>4.5.3 ç©ºé—´å ç”¨ä¼°è®¡</h4><p>å¸ƒéš†è¿‡æ»¤å™¨æœ‰ä¸¤ä¸ªå‚æ•°ï¼šç¬¬ä¸€ä¸ªæ˜¯é¢„è®¡å…ƒç´ çš„æ•°é‡nï¼Œç¬¬äºŒä¸ªæ˜¯é”™è¯¯ç‡ fã€‚å…¬å¼æ ¹æ®è¿™ä¸¤ä¸ªè¾“å…¥ å¾—åˆ°ä¸¤ä¸ªè¾“å‡ºï¼Œç¬¬ä¸€ä¸ªè¾“å‡ºæ˜¯ ä½æ•°ç»„çš„é•¿åº¦iï¼Œä¹Ÿå°±æ˜¯éœ€è¦çš„å­˜å‚¨ç©ºé—´å¤§å°ï¼ˆbitï¼‰ï¼Œç¬¬äºŒä¸ªè¾“å‡ºæ˜¯ hash å‡½æ•°çš„æœ€ä½³æ•°é‡ kã€‚hashå‡½æ•°çš„æ•°é‡ä¹Ÿä¼šç›´æ¥å½±å“åˆ°é”™è¯¯ç‡ï¼Œæœ€ä½³çš„æ•°æ®ä¼šæœ‰æœ€ä½çš„é”™è¯¯ç‡ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">k = 0.7 * (i/n)  # çº¦ç­‰äº</span><br><span class="line">f = 0.6185^(i/n)# ^è¡¨ç¤ºæ¬¡æ–¹è®¡ç®—</span><br></pre></td></tr></table></figure><p>ä»å…¬å¼å¯ä»¥çœ‹å‡ºï¼š</p><ul><li>ä½æ•°ç»„ ç›¸å¯¹è¶Šé•¿(i&#x2F;n)ï¼Œé”™è¯¯ç‡ f è¶Šä½</li><li>ä½æ•°ç»„ ç›¸å¯¹è¶Šé•¿(i&#x2F;n)ï¼Œhashå‡½æ•°éœ€è¦çš„æœ€ä½³æ•°é‡ä¹Ÿè¶Šå¤šï¼Œå½±å“è®¡ç®—æ•ˆç‡</li><li>å½“ä¸€ä¸ªå…ƒç´ å¹³å‡éœ€è¦ 1ä¸ªå­—èŠ‚(8 bit)çš„æŒ‡çº¹ç©ºé—´(i&#x2F;n&#x3D;8)ï¼Œé”™è¯¯ç‡å¤§çº¦2%</li><li>é”™è¯¯ç‡ä¸º10%ï¼Œä¸€ä¸ªå…ƒç´ éœ€è¦çš„å¹³å‡æŒ‡çº¹ç©ºé—´ä¸º 4.792ä¸ªbit</li><li>é”™è¯¯ç‡ä¸º0.1%ï¼Œä¸€ä¸ªå…ƒç´ éœ€è¦çš„å¹³å‡æŒ‡çº¹ç©ºé—´ä¸º 14.377ä¸ªbit</li></ul><p>ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼Œä¸€ä¸ªå…ƒç´ éœ€è¦å æ®15bitï¼Œé‚£ç›¸å¯¹seté›†åˆçš„ç©ºé—´ä¼˜åŠ¿æ˜¯ä¸æ˜¯å°±æ²¡æœ‰é‚£ä¹ˆæ˜æ˜¾äº†ï¼Ÿsetä¸­ä¼šå­˜å‚¨æ¯ä¸ªå…ƒç´ çš„å†…å®¹ï¼Œè€Œå¸ƒéš†è¿‡æ»¤å™¨ä»…ä»…å­˜å‚¨å…ƒç´ çš„æŒ‡çº¹ã€‚å…ƒç´ çš„å†…å®¹å¤§å°å°±æ˜¯å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œå®ƒä¸€èˆ¬æœ‰å¤šä¸ªå­—èŠ‚ç”šè‡³å‡ åä¸ªå­—èŠ‚ï¼Œæ¯ä¸ªå…ƒç´ æœ¬èº«è¿˜éœ€è¦ä¸€ä¸ªæŒ‡é’ˆè¢«seté›†åˆæ¥å¼•ç”¨ã€‚</p><h3 id="4-6-ç®€å•é™æµ"><a href="#4-6-ç®€å•é™æµ" class="headerlink" title="4.6 ç®€å•é™æµ"></a>4.6 ç®€å•é™æµ</h3><p>åœ¨Redisä¸­ï¼Œå¯ä»¥ä½¿ç”¨ ZSet æ•°æ®ç»“æ„ å®ç°è¯¥åŠŸèƒ½ã€‚å¯ä»¥æŠŠ zset ä¸­çš„ score å€¼è®¾ç½®ä¸º æ—¶é—´æˆ³ ï¼Œè¿™æ ·å°±å¯ä»¥åœˆå‡ºä¸€ä¸ªæ—¶é—´æ®µå†…çš„æ‰€æœ‰æ•°æ®ã€‚å³ åªè¦ æ—¶é—´çª—å£å†…çš„æ•°æ®ï¼Œæ—¶é—´çª—å£å¤–çš„æ•°æ®éƒ½å¯ä»¥ç æ‰ã€‚é‚£ä¹ˆ zset çš„value å¡«ä»€ä¹ˆå€¼å‘¢ï¼Œä¹Ÿå¯ä»¥å¡«æ—¶é—´æˆ³ï¼Œåªéœ€ä¿è¯å…¶å”¯ä¸€æ€§å°±è¡Œã€‚</p><p>è¿™æ ·å°±å¯ä»¥ ç”¨ ZSet è®°å½•ç”¨æˆ·çš„è¡Œä¸ºå†å²ï¼Œæ¯ä¸ªè¡Œä¸ºéƒ½ä¼šä½œä¸ºä¸€ä¸ª zset ä¸­çš„ä¸€ä¸ª key ä¿å­˜ä¸‹æ¥ã€‚åŒä¸€ä¸ªç”¨æˆ·åŒä¸€ç§è¡Œä¸º ä¼šä½¿ç”¨ä¸€ä¸ª zset è®°å½•ã€‚ä¸ºäº†èŠ‚çœå†…å­˜ï¼Œæˆ‘ä»¬åªéœ€è¦ä¿ç•™æ—¶é—´çª—å£å†…çš„è¡Œä¸ºè®°å½•ï¼ŒåŒæ—¶å¦‚æœç”¨æˆ·æ˜¯å†·ç”¨æˆ·ï¼Œæ»‘åŠ¨æ—¶é—´çª—å£å†…çš„è¡Œä¸ºæ˜¯ç©ºè®°å½•ï¼Œé‚£ä¹ˆè¿™ä¸ª zset å°±å¯ä»¥ä»å†…å­˜ä¸­ç§»é™¤ï¼Œä¸å†å ç”¨ç©ºé—´ã€‚</p><p>é€šè¿‡ç»Ÿè®¡æ»‘åŠ¨çª—å£å†…çš„è¡Œä¸ºæ•°é‡ä¸é˜ˆå€¼ max_count è¿›è¡Œæ¯”è¾ƒå°±å¯ä»¥å¾—å‡ºå½“å‰çš„è¡Œä¸ºæ˜¯å¦å…è®¸ã€‚</p><p>æ•´ä½“æ€è·¯ï¼šæ¯ä¸€ä¸ªè¡Œä¸ºåˆ°æ¥æ—¶ï¼Œéƒ½ç»´æŠ¤ä¸€æ¬¡æ—¶é—´çª—å£ã€‚å°†æ—¶é—´çª—å£å¤–çš„è®°å½•å…¨éƒ¨æ¸…ç†æ‰ï¼Œåªä¿ç•™çª—å£å†…çš„è®°å½•ã€‚zseté›†åˆä¸­ åªæœ‰ score å€¼éå¸¸é‡è¦ï¼Œvalueæ²¡æœ‰ç‰¹åˆ«çš„æ„ä¹‰ã€‚</p><p>ç¼ºç‚¹ï¼šè¦è®°å½•æ—¶é—´çª—å£å†…æ‰€æœ‰çš„è¡Œä¸ºè®°å½•ã€‚å¦‚æœè¿™ä¸ªé‡å¾ˆå¤§ï¼Œæ¯”å¦‚é™å®š 60s å†…æ“ä½œä¸å¾—è¶…è¿‡ 100w æ¬¡ï¼Œé‚£ä¹ˆè¿™å°±ä¸é€‚åˆè¿™æ ·åšé™æµäº†ï¼Œå› ä¸ºä¼šæ¶ˆè€—å¤§é‡çš„å­˜å‚¨ç©ºé—´ã€‚</p><h3 id="4-7-æ¼æ–—é™æµ"><a href="#4-7-æ¼æ–—é™æµ" class="headerlink" title="4.7 æ¼æ–—é™æµ"></a>4.7 æ¼æ–—é™æµ</h3><p>Redis4.0 æä¾›äº†ä¸€ä¸ªé™æµ Redis æ¨¡å—ï¼Œå®ƒå« redis-cellã€‚è¯¥æ¨¡å—ä¹Ÿä½¿ç”¨äº†æ¼æ–—ç®—æ³•ï¼Œå¹¶æä¾›äº†åŸå­çš„é™æµæŒ‡ä»¤ã€‚</p><p>è¯¥æ¨¡å—åªæœ‰1æ¡æŒ‡ä»¤ cl.throttle ï¼Œå®ƒçš„å‚æ•°å’Œè¿”å›å€¼éƒ½ç•¥æ˜¾å¤æ‚ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt; cl.throttle key 15 30 60 1</span><br><span class="line"># keyæ˜¯é”®å </span><br><span class="line"># ç¬¬äºŒä¸ªå‚æ•°æ˜¯ æ¼æ–—å®¹é‡</span><br><span class="line"># ç¬¬ä¸‰ä¸ªå‚æ•°ã€ç¬¬å››ä¸ªå‚æ•° è¡¨ç¤º 60så†… æœ€å¤š 30æ¬¡ï¼ˆå¯ä»¥å½“ä½œæ¼æ–—çš„æµé€Ÿï¼‰</span><br><span class="line"># ç¬¬äº”ä¸ªå‚æ•°ä¸º å¯é€‰å‚æ•°,é»˜è®¤ä¸º1.</span><br><span class="line"> </span><br><span class="line">æŒ‡ä»¤ä¼šè¿”å›äº”ä¸ªå‚æ•°ï¼Œåˆ†åˆ«è¡¨ç¤ºï¼š</span><br><span class="line"># 0è¡¨ç¤ºå…è®¸ï¼Œ1è¡¨ç¤ºæ‹’æ¥</span><br><span class="line"># æ¼æ–—å®¹é‡</span><br><span class="line"># æ¼æ–—å‰©ä½™ç©ºé—´</span><br><span class="line"># å¦‚æœæ‹’æ¥äº†ï¼Œéœ€è¦å¤šé•¿æ—¶é—´ä¹‹åå†è¯•ï¼ˆå¤šä¹…åæ¼æ–—æœ‰ç©ºé—´ï¼Œå•ä½ç§’ï¼‰</span><br><span class="line"># å¤šé•¿æ—¶é—´åï¼Œæ¼æ–—å®Œå…¨ç©ºå‡ºæ¥ï¼ˆå•ä½ç§’ï¼‰</span><br></pre></td></tr></table></figure><p>åœ¨æ‰§è¡Œé™æµæŒ‡ä»¤æ—¶ï¼Œå¦‚æœè¢«æ‹’ç»äº†ï¼Œå°±éœ€è¦ä¸¢å¼ƒæˆ–é‡è¯•ï¼Œcl.throttle æŒ‡ä»¤è€ƒè™‘çš„éå¸¸å‘¨åˆ°ï¼Œè¿é‡è¯•æ—¶é—´ç»™æˆ‘ä»¬äº†ï¼Œç›´æ¥å–è¿”å›ç»“æœæ•°ç»„çš„ç¬¬å››ä¸ªå€¼è¿›è¡Œ sleep å³å¯ï¼Œå¦‚æœä¸æƒ³å µå¡çº¿ç¨‹ï¼Œä¹Ÿå¯ä»¥å¼‚æ­¥å®šæ—¶ä»»åŠ¡æ¥é‡è¯•ã€‚</p><h3 id="4-8-è¿‘æ°´æ¥¼å°-GeoHash"><a href="#4-8-è¿‘æ°´æ¥¼å°-GeoHash" class="headerlink" title="4.8 è¿‘æ°´æ¥¼å°-GeoHash"></a>4.8 è¿‘æ°´æ¥¼å°-GeoHash</h3><p>Redisåœ¨ 3.2 ç‰ˆæœ¬ä»¥åå¢åŠ äº† GEO æ¨¡å—ï¼Œæ„å‘³ç€æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Redis æ¥å®ç° å¾®ä¿¡[é™„è¿‘çš„äºº]ã€ç¾å›¢[é™„ä»¶çš„é¤é¦†]è¿™æ ·çš„åŠŸèƒ½äº†ã€‚</p><h4 id="4-8-1-ç”¨æ•°æ®åº“æ¥ç®—é™„è¿‘çš„äºº"><a href="#4-8-1-ç”¨æ•°æ®åº“æ¥ç®—é™„è¿‘çš„äºº" class="headerlink" title="4.8.1 ç”¨æ•°æ®åº“æ¥ç®—é™„è¿‘çš„äºº"></a>4.8.1 ç”¨æ•°æ®åº“æ¥ç®—é™„è¿‘çš„äºº</h4><p>åœ°å›¾å…ƒç´ çš„ä½ç½®æ•°æ®ä½¿ç”¨äºŒç»´çš„ç»çº¬åº¦è¡¨ç¤ºï¼Œç»åº¦èŒƒå›´ (-180,180]ï¼Œçº¬åº¦èŒƒå›´ (-90,90],çº¬åº¦æ­£è´Ÿä»¥èµ¤é“ä¸ºç•Œï¼ŒåŒ—æ­£å—è´Ÿï¼Œç»åº¦æ­£è´Ÿä»¥æœ¬åˆå­åˆçº¿ä¸ºç•Œï¼Œä¸œæ­£è¥¿è´Ÿã€‚</p><p>å½“ä¸¤ä¸ªè·ç¦»ä¸æ˜¯å¾ˆè¿œæ—¶ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨å‹¾è‚¡å®šç†å°±èƒ½ç®—å¾—å…ƒç´ ä¹‹é—´çš„è·ç¦»ã€‚å¹³æ—¶ä½¿ç”¨çš„ [é™„è¿‘çš„äºº] çš„åŠŸèƒ½ï¼Œå…ƒç´ è·ç¦»éƒ½ä¸æ˜¯å¾ˆå¤§ï¼Œå‹¾è‚¡å®šç†ç®—è·ç¦»è¶³ä»¥ã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç»çº¬åº¦åæ ‡çš„å¯†åº¦ä¸ä¸€æ ·ï¼ˆç»åº¦æ€»å…±360åº¦ï¼Œçº¬åº¦æ€»å…±180åº¦ï¼‰ï¼Œå‹¾è‚¡å®šç†è®¡ç®—å¹³æ–¹å·®æ—¶ä¹‹åå†æ±‚å’Œæ—¶ï¼Œéœ€è¦æŒ‰ä¸€å®šçš„ç³»æ•°æ¯”åŠ æƒæ±‚å’Œã€‚</p><p>å¦‚æœä½¿ç”¨å…³ç³»å‹æ•°æ®åº“ï¼ŒåŸºæœ¬é‡‡ç”¨ï¼ˆå…ƒç´ ID,ç»åº¦,çº¬åº¦ï¼‰å­˜å‚¨ã€‚é‚£æ­¤æ—¶å°±å¾ˆéš¾é€šè¿‡éå†æ¥è®¡ç®—æ‰€æœ‰çš„å…ƒç´ å’Œç›®æ ‡å…ƒç´ çš„è·ç¦»ç„¶åå†è¿›è¡Œæ’åºï¼Œè¿™ä¸ªè®¡ç®—é‡å¤ªå¤§äº†ï¼Œæ€§èƒ½æŒ‡æ ‡è‚¯å®šæ— æ³•æ»¡è¶³ã€‚ä¸€èˆ¬çš„æ–¹æ³•éƒ½æ˜¯é€šè¿‡çŸ©å½¢åŒºåŸŸæ¥é™å®šå…ƒç´ çš„æ•°é‡ï¼Œç„¶åå¯¹åŒºåŸŸå†…çš„å…ƒç´ è¿›è¡Œ å…¨é‡è·ç¦» è®¡ç®—å†æ’åºã€‚</p><p>ä¸ºäº†æ»¡è¶³é«˜æ€§èƒ½çš„çŸ©å½¢åŒºåŸŸç®—æ³•ï¼Œæ•°æ®è¡¨éœ€è¦åœ¨ç»çº¬åº¦åæ ‡ä¸ŠåŠ ä¸ŠåŒå‘å¤åˆç´¢å¼•ï¼ˆx,yï¼‰ï¼Œè¿™æ ·å¯ä»¥æœ€å¤§ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ã€‚ä½†æ˜¯æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½æ¯•ç«Ÿæœ‰é™ï¼Œå¦‚æœ é™„è¿‘çš„äºº æŸ¥è¯¢è¯·æ±‚éå¸¸å¤šï¼Œåœ¨é«˜å¹¶å‘åœºåˆï¼Œè¿™å¯èƒ½å¹¶ä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ–¹æ¡ˆã€‚</p><h4 id="4-8-2-GeoHashç®—æ³•"><a href="#4-8-2-GeoHashç®—æ³•" class="headerlink" title="4.8.2 GeoHashç®—æ³•"></a>4.8.2 GeoHashç®—æ³•</h4><p>ä¸šç•Œæ¯”è¾ƒé€šç”¨çš„åœ°ç†è·ç¦»æ’åºç®—æ³•æ˜¯ GeoHash ç®—æ³•ï¼ŒRedis ä¹Ÿä½¿ç”¨ GeoHash ç®—æ³•ã€‚GeoHash ç®—æ³•å°†äºŒç»´çš„ç»çº¬åº¦æ•°æ®æ˜ å°„åˆ°ä¸€ç»´çš„æ•´æ•°ï¼Œè¿™æ ·æ‰€æœ‰çš„å…ƒç´ éƒ½å°†æŒ‚è½½åˆ°ä¸€æ¡çº¿ä¸Šï¼Œè·ç¦»é è¿‘çš„äºŒç»´åæ ‡æ˜ å°„åˆ°ä¸€ç»´åçš„ç‚¹ä¹‹é—´è·ç¦»ä¹Ÿä¼šå¾ˆè¿‘ã€‚å½“æˆ‘ä»¬æƒ³è¦è®¡ç®— [é™„è¿‘çš„äººæ—¶]ï¼Œé¦–å…ˆå°†ç›®æ ‡çš„ä½ç½® æ˜ å°„åˆ°è¿™æ¡çº¿ä¸Šï¼Œç„¶ååœ¨è¿™ä¸ªä¸€ç»´çš„çº¿ä¸Šè·å–é™„è¿‘çš„ç‚¹å°±è¡Œäº†ã€‚</p><p>é‚£è¿™ä¸ªæ˜ å°„ç®—æ³•å…·ä½“æ˜¯æ€ä¹ˆè®¡ç®—çš„ï¼Ÿå®ƒå°†æ•´ä¸ªåœ°çƒçœ‹æˆä¸€ä¸ªäºŒç»´å¹³é¢ï¼Œç„¶ååˆ’åˆ†æˆäº†ä¸€ç³»åˆ—æ­£æ–¹å½¢çš„æ–¹æ ¼ï¼Œå°±å¥½æ¯”å›´æ£‹æ£‹ç›˜ã€‚æ‰€æœ‰çš„åœ°å›¾å…ƒç´ åæ ‡éƒ½å°†æ”¾ç½®äºå”¯ä¸€çš„æ–¹æ ¼ä¸­ã€‚æ–¹æ ¼è¶Šå°ï¼Œåæ ‡è¶Šç²¾ç¡®ã€‚ç„¶åå¯¹è¿™äº›æ–¹æ ¼è¿›è¡Œæ•´æ•°ç¼–ç ï¼Œè¶Šæ˜¯é è¿‘çš„æ–¹æ ¼ç¼–ç è¶Šæ˜¯æ¥è¿‘ã€‚é‚£å¦‚ä½•ç¼–ç å‘¢ï¼Ÿä¸€ä¸ªæœ€ç®€å•çš„æ–¹æ¡ˆå°±æ˜¯åˆ‡è›‹ç³•æ³•ã€‚è®¾æƒ³ä¸€ä¸ªæ­£æ–¹å½¢çš„è›‹ç³•æ‘†åœ¨ä½ é¢å‰ï¼ŒäºŒåˆ€ä¸‹å»å‡åˆ†åˆ†æˆå››ä¸ªå°æ­£æ–¹å½¢ï¼Œè¿™å››ä¸ªå°æ­£æ–¹å½¢å¯ä»¥åˆ†åˆ«æ ‡è®°ä¸º00ï¼Œ01ï¼Œ10ï¼Œ11å››ä¸ªäºŒè¿›åˆ¶æ•´æ•°ã€‚ç„¶åå¯¹æ¯ä¸ªå°æ­£æ–¹å½¢ç»§ç»­ç”¨äºŒåˆ†åˆ€æ³•åˆ‡å‰²ä¸€ä¸‹ï¼Œè¿™æ—¶æ¯ä¸ªå°å°æ­£æ–¹å½¢ä½¿ç”¨4bitçš„äºŒè¿›åˆ¶æ•´æ•°äºˆä»¥è¡¨ç¤ºã€‚ç„¶åç»§ç»­åˆ‡ä¸‹å»ï¼Œæ­£æ–¹å½¢å°±ä¼šè¶Šæ¥è¶Šå°ï¼ŒäºŒè¿›åˆ¶æ•´æ•°ä¹Ÿä¼šè¶Šæ¥è¶Šé•¿ï¼Œç²¾ç¡®åº¦å°±ä¼šè¶Šæ¥è¶Šé«˜ã€‚</p><p>ä¸Šé¢ä½¿ç”¨çš„æ˜¯äºŒåˆ€æ³•ï¼Œè¿›è¡Œç¼–ç ã€‚å®é™…ä¸Šè¿˜æœ‰å…¶ä»–å¾ˆå¤šæ–¹æ³•è¿›è¡Œç¼–ç ã€‚</p><p>ç¼–ç ä¹‹åï¼Œæ¯ä¸ªåœ°å›¾å…ƒç´ çš„åæ ‡éƒ½å°†å˜æˆä¸€ä¸ªæ•´æ•°ï¼Œé€šè¿‡è¿™ä¸ªæ•´æ•°å¯ä»¥è¿˜åŸå‡ºå…ƒç´ çš„åæ ‡ï¼Œæ•´æ•°è¶Šé•¿ï¼Œè¿˜åŸå‡ºæ¥çš„åæ ‡å€¼çš„æŸå¤±ç¨‹åº¦å°±è¶Šå°ã€‚GeoHashç®—æ³•ä¼šç»§ç»­å¯¹è¿™ä¸ªæ•´æ•°åšä¸€æ¬¡ base32 ç¼–ç ï¼ˆ0-9,a-zå»æ‰a,i,l,oå››ä¸ªå­—æ¯ï¼‰å˜æˆä¸€ä¸ªå­—ç¬¦ä¸²ã€‚åœ¨Redisé‡Œé¢ï¼Œç»çº¬åº¦ä½¿ç”¨52ä½çš„æ•´æ•°è¿›è¡Œç¼–ç ï¼Œæ”¾è¿›äº†zseté‡Œé¢ï¼Œzsetçš„ value å…ƒç´ çš„keyï¼Œscore æ˜¯ GeoHash çš„52ä½çš„æ•´æ•°å€¼ã€‚zset çš„ score è™½ç„¶æ˜¯æµ®ç‚¹æ•°ï¼Œä½†æ˜¯å¯¹äº 52ä½çš„æ•´æ•°å€¼ï¼Œå®ƒå¯ä»¥æ— æŸå­˜å‚¨ã€‚</p><p>åœ¨ä½¿ç”¨ Redis è¿›è¡Œ Geo æŸ¥è¯¢æ—¶ï¼Œæˆ‘ä»¬è¦æ—¶åˆ»æƒ³åˆ°å®ƒçš„å†…éƒ¨ç»“æ„å®é™…ä¸Šåªæ˜¯ä¸€ä¸ª zset(skiplist)ã€‚é€šè¿‡ zset çš„ score æ’åºå°±è¦å¯ä»¥å¾—åˆ°åæ ‡é™„è¿‘çš„å…¶ä»–å…ƒç´ ï¼ˆå®é™…æƒ…å†µè¦å¤æ‚ä¸€ç‚¹ï¼‰ï¼Œé€šè¿‡å°† score è¿˜åŸæˆåæ ‡å€¼å°±å¯ä»¥å¾—åˆ°å…ƒç´ çš„åŸå§‹åæ ‡ã€‚</p><h4 id="4-8-3-åŸºæœ¬ä½¿ç”¨"><a href="#4-8-3-åŸºæœ¬ä½¿ç”¨" class="headerlink" title="4.8.3 åŸºæœ¬ä½¿ç”¨"></a>4.8.3 åŸºæœ¬ä½¿ç”¨</h4><p>Redis æä¾›çš„ Geo æŒ‡ä»¤åªæœ‰ 6 ä¸ªã€‚</p><ul><li>å¢åŠ geoadd æŒ‡ä»¤æºå¸¦ é›†åˆåç§°ä»¥åŠå¤šä¸ªç»çº¬åº¦åç§°ä¸‰å…ƒç»„ã€‚è¿™é‡Œä¹Ÿå¯ä»¥ä¸€æ¬¡æ€§ æ·»åŠ å¤šä¸ªå…ƒç»„ã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># å®é™…ä½¿ç”¨</span><br><span class="line">127.0.0.1:6379&gt; geoadd company 116.48105 39.996794 x</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; geoadd company 116.48105 39.996794 xr</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; geoadd company 116.48110 39.996894 xrt</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; geoadd company 116.48410 39.996294 xrty 112.14517 38.12541 xrtu</span><br><span class="line">(integer) 2</span><br></pre></td></tr></table></figure><p>Redis æ²¡æœ‰æä¾› geo åˆ é™¤æŒ‡ä»¤ï¼Œä½†æ˜¯å› ä¸º geo çš„åº•å±‚å®ç°æ˜¯ zsetï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨ zrem key member å‘½ä»¤å®ç°å¯¹ åœ°ç†ä½ç½®ä¿¡æ¯çš„åˆ é™¤ã€‚</p><ul><li>æŸ¥çœ‹è·ç¦»geodist å¯ä»¥ç”¨æ¥è®¡ç®—ä¸¤ä¸ªå…ƒç´ ä¹‹é—´çš„è·ç¦»ï¼Œæºå¸¦ é›†åˆåç§°ã€2ä¸ªåç§°å’Œè·ç¦»å•ä½</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geodist company xr xrt km</span><br><span class="line">&quot;0.0120&quot;</span><br></pre></td></tr></table></figure><ul><li>è·å–å…ƒç´ ä½ç½®geopos æŒ‡ä»¤å¯ä»¥è·å–é›†åˆä¸­ä»»æ„å…ƒç´ çš„ç»çº¬åº¦åæ ‡ï¼Œå¯ä»¥ä¸€æ¬¡è·å–å¤šä¸ªã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geopos company xr</span><br><span class="line">1) 1) &quot;116.48104995489120483&quot;</span><br><span class="line">   2) &quot;39.99679348858259686&quot;</span><br><span class="line">127.0.0.1:6379&gt; geopos company xr xrt</span><br><span class="line">1) 1) &quot;116.48104995489120483&quot;</span><br><span class="line">   2) &quot;39.99679348858259686&quot;</span><br><span class="line">2) 1) &quot;116.4810982346534729&quot;</span><br><span class="line">   2) &quot;39.99689487742897143&quot;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬è§‚å¯Ÿåˆ°è·å–çš„ç»çº¬åº¦åæ ‡å’Œ geoadd è¿›å»çš„åæ ‡æœ‰è½»å¾®çš„è¯¯å·®ï¼ŒåŸå› æ˜¯ geohash å¯¹äºŒç»´åæ ‡è¿›è¡Œçš„ä¸€ç»´æ˜ å°„æ˜¯æœ‰æŸçš„ï¼Œé€šè¿‡æ˜ å°„å†è¿˜åŸå›æ¥çš„å€¼ä¼šå‡ºç°è¾ƒå°çš„å·®åˆ«ã€‚</p><ul><li>è·å–å…ƒç´ çš„ Hash å€¼geohash å¯ä»¥è·å–å…ƒç´ çš„ç»çº¬åº¦ç¼–ç å­—ç¬¦ä¸²ï¼Œä¸Šé¢è¯´è¿‡å®ƒæ˜¯ base32 ç¼–ç ã€‚ä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªç¼–ç å€¼å» <a href="http://geohash.org/$%7Bhash%7D">http://geohash.org/${hash}</a> ä¸­ç›´æ¥å®šä½ï¼Œå®ƒæ˜¯ geohash çš„æ ‡å‡†ç¼–ç å€¼ã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geohash company xr</span><br><span class="line">1) &quot;wx4gd94yjn0&quot;</span><br></pre></td></tr></table></figure><ul><li>é™„è¿‘çš„georadiusbymember æŒ‡ä»¤æ˜¯æœ€ä¸ºå…³é”®çš„æŒ‡ä»¤ï¼Œå®ƒå¯ä»¥ç”¨æ¥æŸ¥è¯¢æŒ‡å®šå…ƒç´ é™„è¿‘çš„å…¶ä»–å…ƒç´ ï¼Œå®ƒçš„å‚æ•°éå¸¸å¤æ‚ã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># èŒƒå›´20å…¬é‡Œä»¥å†…æœ€å¤š3ä¸ªå…ƒç´ æŒ‰è·ç¦»æ­£æ’ï¼Œå®ƒä¸ä¼šæ’é™¤è‡ªèº«</span><br><span class="line">127.0.0.1:6379&gt; georadiusbymember company xr 20 km count 3 asc</span><br><span class="line">1) &quot;finchina&quot;</span><br><span class="line">2) &quot;xr&quot;</span><br><span class="line">3) &quot;xrt&quot;</span><br><span class="line"># ä¸‰ä¸ªå¯é€‰å‚æ•° withcoord withdist withhash ç”¨æ¥æºå¸¦é™„åŠ å‚æ•°</span><br><span class="line">127.0.0.1:6379&gt; georadiusbymember company xr 20 km withcoord withdist withhash count 3 asc</span><br><span class="line">1) 1) &quot;finchina&quot;</span><br><span class="line">   2) &quot;0.0000&quot;</span><br><span class="line">   3) (integer) 4069887154388167</span><br><span class="line">   4) 1) &quot;116.48104995489120483&quot;</span><br><span class="line">      2) &quot;39.99679348858259686&quot;</span><br><span class="line">2) 1) &quot;xr&quot;</span><br><span class="line">   2) &quot;0.0000&quot;</span><br><span class="line">   3) (integer) 4069887154388167</span><br><span class="line">   4) 1) &quot;116.48104995489120483&quot;</span><br><span class="line">      2) &quot;39.99679348858259686&quot;</span><br><span class="line">3) 1) &quot;xrt&quot;</span><br><span class="line">   2) &quot;0.0120&quot;</span><br><span class="line">   3) (integer) 4069887154432781</span><br><span class="line">   4) 1) &quot;116.4810982346534729&quot;</span><br><span class="line">      2) &quot;39.99689487742897143&quot;</span><br></pre></td></tr></table></figure><ul><li>æŸ¥è¯¢æŒ‡å®šåæ ‡é™„è¿‘çš„å…ƒç´ é™¤äº† georadiusbymember æŒ‡ä»¤æ ¹æ®å…ƒç´ æŸ¥è¯¢é™„è¿‘çš„å…ƒç´ ï¼ŒRedisè¿˜æä¾›äº†æ ¹æ®åæ ‡å€¼æ¥æŸ¥è¯¢é™„è¿‘çš„å…ƒç´  georadiusï¼Œè¿™ä¸ªæŒ‡ä»¤æ›´åŠ æœ‰ç”¨ï¼Œå®ƒå¯ä»¥æ ¹æ®ç”¨æˆ·çš„å®šä½æ¥è®¡ç®—ã€‚å®ƒçš„å‚æ•°å’Œ georadiusbymember åŸºæœ¬ä¸€è‡´ï¼Œé™¤äº†å°†ç›®æ ‡å…ƒç´ æ”¹æˆç»çº¬åº¦åæ ‡å€¼</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; georadius company 116.18119895 39.9977934 100 km withdist count 2 desc</span><br><span class="line">1) 1) &quot;xrty&quot;</span><br><span class="line">   2) &quot;25.8103&quot;</span><br><span class="line">2) 1) &quot;xrt&quot;</span><br><span class="line">   2) &quot;25.5539&quot;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸€ä¸ªåœ°å›¾åº”ç”¨ä¸­ï¼Œè½¦çš„æ•°æ®ã€é¤é¦†çš„æ•°æ®ã€äººçš„æ•°æ® å¯èƒ½ä¼šæœ‰ç™¾ä¸‡åƒä¸‡æ¡ï¼Œå¦‚æœä½¿ç”¨ Redis çš„ geo æ•°æ®ç»“æ„ï¼Œå®ƒä»¬å°†å…¨éƒ¨æ”¾åœ¨ä¸€ä¸ª zset é›†åˆä¸­ã€‚åœ¨ Redis çš„é›†ç¾¤ç¯å¢ƒä¸­ï¼Œé›†åˆå¯èƒ½ä»ä¸€ä¸ªèŠ‚ç‚¹è¿ç§»åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœå•ä¸ªkeyçš„æ•°æ®è¿‡å¤§ï¼Œä¼šå¯¹é›†ç¾¤çš„è¿ç§»å·¥ä½œé€ æˆè¾ƒå¤§å½±å“ï¼Œåœ¨é›†ç¾¤ç¯å¢ƒä¸­çš„å•ä¸ªkeyå¯¹åº”çš„æ•°æ®é‡ä¸å®œè¶…è¿‡ 1Mï¼Œå¦åˆ™ä¼šå¯¼è‡´é›†ç¾¤è¿ç§»å‡ºç°å¡é¡¿ç°è±¡ï¼Œå½±å“çº¿ä¸ŠæœåŠ¡çš„æ­£å¸¸è¿è¡Œã€‚</p><p>æ‰€ä»¥ï¼Œè¿™é‡Œå»ºè®® geo çš„æ•°æ®ä½¿ç”¨å•ç‹¬çš„ Redis å®ä¾‹éƒ¨ç½²ï¼Œä¸ä½¿ç”¨é›†ç¾¤ç¯å¢ƒã€‚</p><p>å¦‚æœæ•°æ®é‡è¿‡äº¿ç”šè‡³æ›´å¤§ï¼Œå°±éœ€è¦å¯¹ geo æ•°æ®è¿›è¡Œæ‹†åˆ†ã€‚åœ¨äººå£ç‰¹å¤§çš„åŸå¸‚ï¼Œç”šè‡³å¯ä»¥æŒ‰åŒºåˆ’åˆ†ï¼Œè¿™æ ·å°±å¯ä»¥æ˜¾è‘—é™ä½å•ä¸ª zset é›†åˆçš„å¤§å°ã€‚</p><h3 id="4-9-å¤§æµ·æé’ˆ-scan"><a href="#4-9-å¤§æµ·æé’ˆ-scan" class="headerlink" title="4.9 å¤§æµ·æé’ˆ scan"></a>4.9 å¤§æµ·æé’ˆ scan</h3><p>æœ‰æ—¶å€™éœ€è¦ä» Redis å®ä¾‹æˆåƒä¸Šä¸‡çš„ key ä¸­æ‰¾å‡ºç‰¹å®šå‰ç¼€çš„ key åˆ—è¡¨æ¥æ‰‹åŠ¨å¤„ç†æ•°æ®ï¼Œå¯èƒ½æ˜¯ä¿®æ”¹å®ƒçš„å€¼ï¼Œä¹Ÿå¯èƒ½æ˜¯åˆ é™¤keyã€‚è¿™é‡Œå°±æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚ä½•ä»æµ·é‡ key ä¸­æ‰¾åˆ°æ»¡è¶³ç‰¹å®šå‰ç¼€çš„ key åˆ—è¡¨ï¼Ÿ</p><p>Redis æä¾›äº†ä¸€ä¸ªç®€å•æš´åŠ›çš„æŒ‡ä»¤ keys ç”¨æ¥åˆ—å‡ºæ‰€æœ‰æ»¡è¶³ ç‰¹å®šæ­£åˆ™å­—ç¬¦ä¸²è§„åˆ™çš„ keyã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set code1 a</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; mset code2 2 code3 3 code4 4 code5 5</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; keys code*</span><br><span class="line">1) &quot;code5&quot;</span><br><span class="line">2) &quot;code4&quot;</span><br><span class="line">3) &quot;code1&quot;</span><br><span class="line">4) &quot;code3&quot;</span><br><span class="line">5) &quot;code2&quot;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæŒ‡ä»¤éå¸¸ç®€å•ï¼Œæä¾›ä¸€ä¸ªç®€å•çš„æ­£åˆ™å­—ç¬¦ä¸²å³å¯ï¼Œä½†æ˜¯æœ‰å¾ˆæ˜æ˜¾çš„ä¸¤ä¸ªç¼ºç‚¹ã€‚ </p><p>1.æ²¡æœ‰ offsetã€limitå‚æ•°ï¼Œä¸€æ¬¡æ€§åå‡ºæ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„ keyï¼Œä¸‡ä¸€å®ä¾‹ä¸­æœ‰å‡ ç™¾ä¸‡ä¸ª key æ»¡è¶³æ¡ä»¶ï¼Œåˆ™æ‰“å°å­—ç¬¦ä¸²å¤ªå¤šã€‚</p><p>2.keys ç®—æ³•æ˜¯ éå†ç®—æ³•ï¼Œå¤æ‚åº¦æ˜¯ O(n)ï¼Œå¦‚æœå®ä¾‹ä¸­æœ‰ä¸Šåƒä¸‡çº§ä»¥ä¸Šçš„ keyï¼Œè¿™ä¸ªæŒ‡ä»¤å°±ä¼šå¯¼è‡´ redis æœåŠ¡å¡é¡¿ï¼Œæ‰€æœ‰è¯»å†™ redis çš„å…¶ä»–æŒ‡ä»¤éƒ½ä¼šè¢«å»¶åç”šè‡³è¶…æ—¶ï¼Œå› ä¸ºredisæ˜¯å•çº¿ç¨‹ç¨‹åºï¼Œé¡ºåºæ‰§è¡Œæ‰€æœ‰æŒ‡ä»¤ï¼Œå…¶ä»–æŒ‡ä»¤å¿…é¡»ç­‰åˆ°å½“å‰ keys æŒ‡ä»¤æ‰§è¡Œå®Œæˆåæ‰å¯ä»¥ç»§ç»­ã€‚</p><p>Redisä¸ºè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œåœ¨2.8ç‰ˆæœ¬åŠ å…¥äº† scan ã€‚scan ç›¸æ¯” keyså…·å¤‡ä»¥ä¸‹ä¼˜ç‚¹ï¼š</p><ul><li>å¤æ‚åº¦è™½ç„¶ä¹Ÿæ˜¯0(n)ï¼Œä½†æ˜¯å®ƒæ˜¯é€šè¿‡æ¸¸æ ‡åˆ†å¸ƒè¿›è¡Œçš„ï¼Œä¸ä¼šå µå¡çº¿ç¨‹ã€‚</li><li>æä¾› limit å‚æ•°ï¼Œå¯ä»¥æ§åˆ¶æ¯æ¬¡è¿”å›ç»“æœçš„æœ€å¤§æ¡æ•°ï¼Œlimit åªæ˜¯è¦ç»™ hintï¼Œè¿”å›çš„å‚æ•°å¯å¤šå¯å°‘ã€‚</li><li>åŒ keys ä¸€æ ·æä¾› æ¨¡å¼åŒ¹é…åŠŸèƒ½ã€‚</li><li>æœåŠ¡å™¨ä¸éœ€è¦ä¸ºæ¸¸æ ‡ä¿å­˜çŠ¶æ€ï¼Œæ¸¸æ ‡çš„å”¯ä¸€çŠ¶æ€å°±æ˜¯ scan è¿”å›ç»™å®¢æˆ·ç«¯çš„æ¸¸æ ‡æ•´æ•°ã€‚</li><li>éå†çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæœ‰æ•°æ®ä¿®æ”¹ï¼Œæ”¹åŠ¨åçš„æ•°æ®èƒ½ä¸èƒ½è¢«éå†åˆ°æ˜¯ä¸ç¡®å®šçš„ã€‚</li><li>å•æ¬¡è¿”å›çš„ç»“æœæ˜¯ç©ºçš„å¹¶ä¸æ„å‘³ç€éå†ç»“æŸï¼Œè€Œè¦çœ‹è¿”å›çš„æ¸¸æ ‡å€¼æ˜¯å¦ä¸ºé›¶ã€‚</li></ul><h4 id="4-9-1-scan-åŸºç¡€ä½¿ç”¨"><a href="#4-9-1-scan-åŸºç¡€ä½¿ç”¨" class="headerlink" title="4.9.1 scan åŸºç¡€ä½¿ç”¨"></a>4.9.1 scan åŸºç¡€ä½¿ç”¨</h4><p>å¾€redisæ’å…¥äº†10æ¡æ•°æ®ï¼Œcode1åˆ°code10ã€‚</p><p>scan æä¾›äº†ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯ cursor æ•´æ•°å€¼ï¼Œç¬¬äºŒä¸ªæ˜¯ key çš„æ­£åˆ™æ¨¡å¼ï¼Œç¬¬ä¸‰ä¸ªæ˜¯ éå†çš„ limit hintã€‚ç¬¬ä¸€æ¬¡éå†æ—¶ï¼Œcursorå€¼ä¸º0ï¼Œç„¶åå°†è¿”å›ç»“æœä¸­ç¬¬ä¸€ä¸ªæ•´æ•°å€¼ä½œä¸ºä¸‹ä¸€æ¬¡éå†çš„ cursorã€‚ä¸€ç›´éå†åˆ°è¿”å›çš„ cursor å€¼ä¸º 0æ—¶ç»“æŸã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; scan 0 match code* count 4</span><br><span class="line">1) &quot;6&quot;</span><br><span class="line">2) 1) &quot;code8&quot;</span><br><span class="line">   2) &quot;code1&quot;</span><br><span class="line">   3) &quot;code4&quot;</span><br><span class="line">   </span><br><span class="line">127.0.0.1:6379&gt; scan 6 match code* count 4</span><br><span class="line">1) &quot;9&quot;</span><br><span class="line">2) 1) &quot;code2&quot;</span><br><span class="line">   2) &quot;code6&quot;</span><br><span class="line">   3) &quot;code9&quot;</span><br><span class="line">   4) &quot;codex&quot;</span><br><span class="line">   </span><br><span class="line">127.0.0.1:6379&gt; scan 9 match code* count 4</span><br><span class="line">1) &quot;7&quot;</span><br><span class="line">2) 1) &quot;code5&quot;</span><br><span class="line">   2) &quot;code3&quot;</span><br><span class="line">   3) &quot;code10&quot;</span><br><span class="line">   4) &quot;code7&quot;</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; scan 7 match code* count 4</span><br><span class="line">1) &quot;0&quot;</span><br><span class="line">2) 1) &quot;code11&quot;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢å®é™…æµ‹è¯•ä¸­å¯ä»¥çŸ¥é“ï¼Œæ¸¸æ ‡ä¸æ˜¯æ¯æ¬¡é€’å¢ï¼Œå¹¶ä¸”æ‰€å¡«çš„ limit hint ä¸æ˜¯æŒ‡ä»£è¿”å›çš„ç»“æœæ•°é‡ï¼Œè€Œæ˜¯å•æ¬¡éå†çš„å­—å…¸æ§½ä½æ•°é‡(çº¦ç­‰äº)ã€‚å¯èƒ½ å•æ¬¡çš„ è¿”å›ç»“æœä¸ºç©ºï¼Œä½†æ˜¯è¿™å¹¶ä¸æ„å‘³ç€ éå†å·²ç»ç»“æŸã€‚åªæœ‰å½“è¿”å›çš„æ¸¸æ ‡å€¼ä¸º 0 ï¼Œæ‰ç®—æ•´ä¸ªéå†ç»“æŸã€‚</p><h4 id="4-9-2-å­—å…¸çš„ç»“æ„"><a href="#4-9-2-å­—å…¸çš„ç»“æ„" class="headerlink" title="4.9.2 å­—å…¸çš„ç»“æ„"></a>4.9.2 å­—å…¸çš„ç»“æ„</h4><p>åœ¨ Redis ä¸­æ‰€æœ‰çš„ key éƒ½å­˜å‚¨åœ¨ä¸€ä¸ªå¾ˆå¤§çš„å­—å…¸ä¸­ï¼Œæ•´ä¸ªå­—å…¸çš„ç»“æ„å’Œ Javaä¸­çš„ HashMap ä¸€æ ·ï¼Œæ˜¯ä¸€ç»´æ•°ç»„+äºŒç»´é“¾è¡¨ç»“æ„ã€‚ç¬¬ä¸€ç»´æ•°ç»„çš„å¤§å°æ€»æ˜¯ 2^n ï¼ˆn&gt;&#x3D;0)ï¼Œæ‰©å®¹ä¸€æ¬¡æ•°ç»„å¤§å°ç©ºé—´åŠ å€ï¼Œä¹Ÿå°±æ˜¯ n++</p><p>scan æŒ‡ä»¤è¿”å›çš„æ¸¸æ ‡å°±æ˜¯ç¬¬ä¸€ä¸ªç»´æ•°ç»„çš„ä½ç½®ç´¢å¼•ï¼Œæˆ‘ä»¬å°†æ•´ä¸ªä½ç½®ç´¢å¼•ç§°ä½œæ§½ã€‚å¦‚æœä¸è€ƒè™‘å­—å…¸çš„æ‰©å®¹ç¼©å®¹ï¼Œç›´æ¥æŒ‰æ•°ç»„ä¸‹æ ‡æŒ¨ä¸ªéå†å°±è¡Œäº†ã€‚limit å‚æ•°å°±è¡¨ç¤ºéœ€è¦éå†çš„æ§½ä½æ•°ï¼Œä¹‹æ‰€ä»¥è¿”å›çš„ç»“æœå¯èƒ½å¤šå¯èƒ½å°‘ï¼Œæ˜¯å› ä¸ºä¸æ˜¯æ‰€æœ‰çš„æ§½ä½éƒ½ä¼šæŒ‚æ¥ é“¾è¡¨ï¼Œæœ‰äº›æ§½ä½å¯èƒ½æ˜¯ç©ºçš„ï¼Œè¿˜æœ‰äº›æ§½ä½ä¸ŠæŒ‚æ¥çš„é“¾è¡¨ä¸Šçš„å…ƒç´ å¯èƒ½ä¼šæœ‰å¤šä¸ªã€‚æ¯æ¬¡éå†éƒ½ä¼šå°† limit æ•°é‡çš„æ§½ä½ä¸ŠæŒ‚æ¥çš„æ‰€æœ‰é“¾è¡¨å…ƒç´ è¿›è¡Œæ¨¡å¼åŒ¹é…è¿‡æ»¤åï¼Œä¸€æ¬¡æ€§è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p><h4 id="4-9-3-scan-éå†é¡ºåº"><a href="#4-9-3-scan-éå†é¡ºåº" class="headerlink" title="4.9.3 scan éå†é¡ºåº"></a>4.9.3 scan éå†é¡ºåº</h4><p><img src="https://cdn.nlark.com/yuque/0/2023/png/35838370/1684724453802-b8a3e03e-5bad-4829-9d57-ec6e6b10696d.png" alt="img"></p><p>scançš„éå†é¡ºåºéå¸¸ç‰¹åˆ«ã€‚å®ƒä¸æ˜¯ä»ç¬¬ä¸€ç»´æ•°ç»„çš„ç¬¬0ä½ä¸€ç›´éå†åˆ°æœ«å°¾ï¼Œè€Œæ˜¯é‡‡ç”¨äº†é«˜ä½è¿›ä½åŠ æ³•æ¥éå†ã€‚ä¹‹æ‰€ä»¥ä½¿ç”¨è¿™æ ·ç‰¹æ®Šçš„æ–¹å¼è¿›è¡Œéå†ã€‚æ˜¯è€ƒè™‘åˆ°å­—å…¸çš„æ‰©å®¹å’Œç¼©å®¹æ—¶é¿å…æ§½ä½å’Œéå†é‡å¤å’Œé—æ¼ï¼ˆåé¢æœ‰å…·ä½“åˆ†æï¼‰ã€‚é«˜ä½è¿›ä½æ³•ä»å·¦è¾¹åŠ ï¼Œè¿›ä½å¾€å³è¾¹ç§»åŠ¨ï¼ŒåŒæ™®é€šåŠ æ³•æ­£å¥½ç›¸åã€‚ä½†æ˜¯å®ƒä»¬éƒ½ä¼šéå†æ‰€æœ‰çš„æ§½ä½å¹¶ä¸”æ²¡æœ‰é‡å¤ã€‚</p><h4 id="4-9-4-å­—å…¸æ‰©å®¹"><a href="#4-9-4-å­—å…¸æ‰©å®¹" class="headerlink" title="4.9.4 å­—å…¸æ‰©å®¹"></a>4.9.4 å­—å…¸æ‰©å®¹</h4><p>Java ä¸­çš„ HashMap æœ‰æ‰©å®¹çš„æ¦‚å¿µï¼Œå½“ loadFactor è¾¾åˆ°é˜ˆå€¼æ—¶ï¼Œéœ€è¦é‡æ–°åˆ†é…ä¸€ä¸ªæ–°çš„ 2 å€å¤§å°çš„æ•°ç»„ï¼Œç„¶åå°†æ‰€æœ‰çš„å…ƒç´ å…¨éƒ¨ rehash æŒ‚åˆ°æ–°çš„æ•°ç»„ä¸‹é¢ã€‚rehash å°±æ˜¯å°†å…ƒç´ çš„ hashå€¼å¯¹æ•°ç»„é•¿åº¦è¿›è¡Œå–æ¨¡è¿ç®—ï¼Œå› ä¸ºé•¿åº¦å˜äº†ï¼Œæ‰€ä»¥æ¯ä¸ªå…ƒç´ æŒ‚æ¥çš„æ§½ä½å¯èƒ½ä¹Ÿå‘ç”Ÿäº†å˜åŒ–ã€‚æœ‰å› ä¸ºæ•°ç»„çš„é•¿åº¦æ˜¯ 2^n æ¬¡æ–¹ï¼Œæ‰€ä»¥å–æ¨¡è¿ç®—ç­‰ä»·äº ä½ä¸ æ“ä½œã€‚</p><p>a%8 &#x3D; a&amp;(8-1) &#x3D; a&amp;7</p><p>a%16 &#x3D; a&amp;(16-1) &#x3D; a&amp;15</p><p>a%32 &#x3D; a&amp;(32-1) &#x3D; a&amp;31</p><p>è¿™é‡Œçš„ 7ã€15ã€31 åˆç§°ä¹‹ä¸ºå­—å…¸çš„ maskå€¼ï¼Œmaskçš„ä½œç”¨å°±æ˜¯ä¿ç•™ hash å€¼çš„ä½ä½ï¼Œé«˜ä½éƒ½è¢«è®¾ç½®ä¸º 0ã€‚</p><p>çœ‹çœ‹ rehash å‰åå…ƒç´ æ§½ä½çš„å˜åŒ–</p><p>å‡è®¾å½“å‰çš„å­—æ®µçš„æ•°ç»„é•¿åº¦ç”± 8 ä½æ‰©å®¹åˆ° 16ä½ï¼Œé‚£ä¹ˆ 3å·æ§½ä½ 011 å°†ä¼šè¢« rehash åˆ°3å·æ§½ä½å’Œ11å·æ§½ä½ï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥æ§½ä½é“¾è¡¨ä¸­å¤§çº¦æœ‰ä¸€åŠçš„å…ƒç´ è¿˜æ˜¯3å·æ§½ä½ï¼Œå…¶å®ƒçš„å…ƒç´ ä¼šæ”¾åˆ°11å·æ§½ä½ï¼Œ11è¿™ä¸ªæ•°å­—çš„äºŒè¿›åˆ¶æ˜¯ 1011ï¼Œå°±æ˜¯å¯¹ 3 çš„äºŒè¿›åˆ¶ 011 å¢åŠ äº†ä¸€ä¸ªé«˜ä½1ã€‚</p><p>æŠ½è±¡ä¸€ç‚¹è¯´ï¼Œå‡è®¾å¼€å§‹æ§½ä½çš„äºŒè¿›åˆ¶æ˜¯ xxxï¼Œé‚£ä¹ˆè¯¥æ§½ä½ä¸­çš„å…ƒç´ å°†è¢« rehash åˆ° 0xxx å’Œ 1xxx å³ xxx+8ä¸­ã€‚å¦‚æœå­—å…¸é•¿åº¦ç”±16ä½æ‰©å®¹åˆ°32ä½ï¼Œé‚£ä¹ˆå¯¹äºäºŒè¿›åˆ¶æ§½ä½ xxxx ä¸­çš„å…ƒç´ å°†è¢« rehash åˆ° 0xxxx å’Œ 1xxxxä¸­ã€‚</p><p><strong>å¯¹æ¯”æ‰©å®¹å‰åçš„éå†é¡ºåºï¼š</strong></p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/35838370/1684724547827-d86608c6-5109-46c3-8cc2-843deba5e1f6.png" alt="img"></p><p>è§‚å¯Ÿè¿™å¼ å›¾ç‰‡ï¼Œæˆ‘ä»¬å‘ç°é‡‡ç”¨é«˜ä½è¿›ä½åŠ æ³•çš„éå†é¡ºåºï¼Œrehash åçš„æ§½ä½ åœ¨éå†é¡ºåºä¸Šæ˜¯ç›¸é‚»çš„ã€‚</p><p>å‡è®¾å½“å‰å³å°†éå† 110è¿™ä¸ªä½ç½®ï¼Œé‚£ä¹ˆæ‰©å®¹åï¼Œå½“å‰æ§½ä½ä¸Šæ‰€æœ‰çš„å…ƒç´ å¯¹åº”çš„æ–°æ§½ä½æ˜¯ 0110 å’Œ 1110ï¼Œä¹Ÿå°±æ˜¯åœ¨æ§½ä½çš„äºŒè¿›åˆ¶æ•°å¢åŠ ä¸€ä¸ªé«˜ä½0æˆ–1.è¿™æ—¶æˆ‘ä»¬å¯ä»¥iç›´æ¥ä» 0110 è¿™ä¸ªæ§½ä½å¼€å§‹å¾€åç»§ç»­éå†ï¼Œ0110 æ§½ä½ä¹‹å‰çš„æ‰€æœ‰æ§½ä½éƒ½æ˜¯å·²ç»éå†è¿‡çš„ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…æ‰©å®¹åå¯¹å·²ç»éå†è¿‡çš„æ§½ä½è¿›è¡Œé‡å¤éå†ã€‚</p><p>å†è€ƒè™‘ç¼©å®¹ï¼Œå‡è®¾å½“å‰å³å°†éå† 110 è¿™ä¸ªä½ç½®ï¼Œé‚£ä¹ˆç¼©å®¹åï¼Œå½“å‰æ§½ä½æ‰€æœ‰çš„å…ƒç´ å¯¹åº”çš„æ–°æ§½ä½æ˜¯ 10ï¼Œä¹Ÿå°±æ˜¯å»æ‰æ§½ä½äºŒè¿›åˆ¶æœ€é«˜ä½ã€‚è¿™æ—¶æˆ‘ä»¬å¯ä»¥ç›´æ¥ä»10è¿™ä¸ªæ§½ä½ç»§ç»­å¾€åéå†ï¼Œ10æ§½ä½ä¹‹å‰çš„æ‰€æœ‰æ§½ä½éƒ½æ˜¯éå†è¿‡çš„ï¼Œè¿™æ ·å¯ä»¥é¿å…ç¼©å®¹çš„é‡å¤éå†ã€‚ä¸é¡¾ç¼©å®¹è¿˜æ˜¯ä¸å¤ªä¸€æ ·ï¼Œå®ƒä¼šå¯¹å›¾ä¸­ 010 è¿™ä¸ªæ§½ä½ä¸Šçš„å…ƒç´ è¿›è¡Œé‡å¤éå†ï¼Œå› ä¸ºç¼©å®¹å 10 æ§½ä½çš„å…ƒç´ æ˜¯ 010 å’Œ 110ä¸ŠæŒ‚æ¥çš„å…ƒç´ çš„èåˆã€‚</p><h4 id="4-9-5-scan-è€ƒè™‘-æ¸è¿›å¼-rehash"><a href="#4-9-5-scan-è€ƒè™‘-æ¸è¿›å¼-rehash" class="headerlink" title="4.9.5 scan è€ƒè™‘ æ¸è¿›å¼ rehash"></a>4.9.5 scan è€ƒè™‘ æ¸è¿›å¼ rehash</h4><p>Javaçš„ HashMap åœ¨æ‰©å®¹æ—¶ä¼šä¸€æ¬¡æ€§å°†æ—§æ•°ç»„ä¸‹æŒ‚æ¥çš„å…ƒç´ å…¨éƒ¨è½¬ç§»åˆ°æ–°çš„æ•°ç»„ä¸‹é¢ã€‚å¦‚æœ Map ä¸­å…ƒç´ ç‰¹åˆ«å¤šï¼Œçº¿ç¨‹å°±ä¼šå‡ºç°å¡é¡¿ç°è±¡ã€‚Redisä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ƒé‡‡ç”¨æ¸è¿›å¼ rehashã€‚</p><p>å®ƒåŒæ—¶ä¿ç•™æ—§æ•°ç»„å’Œæ–°æ•°ç»„ï¼Œç„¶ååœ¨å®šæ—¶ä»»åŠ¡ä¸­ä»¥åŠåç»­å¯¹ hash çš„æŒ‡ä»¤æ“ä½œä¸­æ¸æ¸å°†æ—§çš„æ•°ç»„ä¸­æŒ‚æ¥çš„å…ƒç´ è¿ç§»åˆ°æ–°æ•°ç»„ä¸Šã€‚è¿™æ„å‘³ç€è¦æ“ä½œå¤„äº rehash ä¸­çš„å­—å…¸ï¼Œéœ€è¦åŒæ—¶è®¿é—®æ–°æ—§ä¸¤ä¸ªæ•°ç»„ç»“æ„ã€‚å¦‚æœåœ¨æ—§æ•°ç»„ä¸‹é¢æ‰¾ä¸åˆ°å…ƒç´ ï¼Œè¿˜éœ€è¦å»æ–°æ•°ç»„ä¸‹é¢å¯»æ‰¾ã€‚</p><p>scan ä¹Ÿéœ€è¦è€ƒè™‘è¿™ä¸ªé—®é¢˜ï¼Œå¯¹äº rehashä¸­çš„å­—å…¸ï¼Œå®ƒéœ€è¦åŒæ—¶æ‰«ææ–°æ—§æ§½ä½ï¼Œç„¶åå°†ç»“æœèåˆåè¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p><h4 id="4-9-6-æ›´å¤š-scan-æŒ‡ä»¤"><a href="#4-9-6-æ›´å¤š-scan-æŒ‡ä»¤" class="headerlink" title="4.9.6 æ›´å¤š scan æŒ‡ä»¤"></a>4.9.6 æ›´å¤š scan æŒ‡ä»¤</h4><p>scanæŒ‡ä»¤æ˜¯ä¸€ç³»åˆ—æŒ‡ä»¤ï¼Œå¤„ç†å¯ä»¥éå†æ‰€æœ‰çš„ keyä»¥å¤–ï¼Œè¿˜å¯ä»¥å¯¹æŒ‡å®šçš„å®¹å™¨é›†åˆè¿›è¡Œéå†ã€‚æ¯”å¦‚ zscan éå† zset é›†åˆå…ƒç´ ï¼Œhscan éå† hash å­—å…¸çš„å…ƒç´ ã€‚</p><h4 id="4-9-7-å¤§Keyçš„æ‰«æ"><a href="#4-9-7-å¤§Keyçš„æ‰«æ" class="headerlink" title="4.9.7 å¤§Keyçš„æ‰«æ"></a>4.9.7 å¤§Keyçš„æ‰«æ</h4><p>å› ä¸ºä¸šåŠ¡äººå‘˜çš„ä½¿ç”¨ä¸å½“ï¼Œåœ¨ Redis å®ä¾‹ä¸­ä¼šå½¢æˆå¾ˆå¤§çš„å¯¹è±¡ï¼Œæ¯”å¦‚ä¸€ä¸ªå¾ˆå¤§çš„ hashï¼Œä¸€ä¸ªå¾ˆå¤§çš„ zsetã€‚è¿™æ ·çš„å¯¹è±¡å¯¹Redisçš„é›†ç¾¤æ•°æ®è¿ç§»å¸¦æ¥äº†å¾ˆå¤§é—®é¢˜ï¼Œå› ä¸ºåœ¨é›†ç¾¤ç¯å¢ƒä¸‹ï¼Œå¦‚æœæŸä¸€ä¸ªkeyå¤ªå¤§ï¼Œä¼šå¯¼è‡´æ•°æ®è¿ç§»å¡é¡¿ã€‚å¦å¤–åœ¨å†…å­˜åˆ†é…ä¸Šï¼Œå¦‚æœä¸€ä¸ªkeyå¤ªå¤§ï¼Œé‚£ä¹ˆå½“å®ƒéœ€è¦æ‰©å®¹æ—¶ï¼Œä¼šä¸€æ¬¡æ€§ç”³è¯·æ›´å¤§çš„ä¸€å—å†…å­˜ï¼Œè¿™ä¹Ÿä¼šå¯¼è‡´å¡é¡¿ã€‚å¦‚æœè¿™ä¸ªå¤§keyè¢«åˆ é™¤ï¼Œå†…å­˜ä¼šä¸€æ¬¡æ€§å›æ”¶ï¼Œå¡é¡¿ç°è±¡å†ä¸€æ¬¡äº§ç”Ÿã€‚</p><p>æ‰€ä»¥åœ¨å¼€å‘ä¸­è¯·é¿å…å¤§keyçš„äº§ç”Ÿã€‚å¦‚ä½•å®šä½åˆ° å¤§keyå‘¢ï¼Ÿå¯ä»¥ä½¿ç”¨ scan å‘½ä»¤ï¼Œå¯¹äºæ‰«æå‡ºæ¥çš„æ¯ä¸€ä¸ªkeyï¼Œä½¿ç”¨ type æŒ‡ä»¤è·å–ç±»å‹ï¼Œç„¶åä½¿ç”¨ç›¸åº”çš„æ•°æ®ç»“æ„çš„ size æˆ–è€… len æ–¹æ³•æ¥å¾—åˆ° å®ƒçš„å¤§å°ï¼Œå¯¹äºæ¯ä¸€ç§ç±»å‹ï¼Œä¿ç•™å¤§å°çš„å‰ Nåä½œä¸ºæ‰«æç»“æœå±•ç¤ºå‡ºæ¥ã€‚</p><p>Redis å®˜æ–¹å·²ç»æä¾›äº† å®ç°ä¸Šé¢åŠŸèƒ½çš„ æŒ‡ä»¤ï¼šredis-cli -h 127.0.0.1 -p 6379 â€“bigkeys ã€‚å¦‚æœæ‹…å¿ƒè¿™ä¸ªæŒ‡ä»¤ä¼šå¤§å¹…æŠ¬å‡ Redis çš„ opsï¼Œè¿˜å¯ä»¥å¢åŠ ä¸€ä¸ªä¼‘çœ å‚æ•°ã€‚redis-cli -h 127.0.0.1 -p 6379 â€“bigkeys -i 0.1ï¼Œè¿™ä¸ªæŒ‡ä»¤æ¯éš”100æ¡ scan æŒ‡ä»¤å°±ä¼šä¼‘çœ  0.1sï¼Œops å°±ä¸ä¼šå‰§çƒˆæŠ¬å‡ï¼Œä½†æ˜¯æ‰«æçš„æ—¶é—´ä¼šå˜é•¿ã€‚</p><h2 id="äº”ã€Redis-åŸç†"><a href="#äº”ã€Redis-åŸç†" class="headerlink" title="äº”ã€Redis åŸç†"></a>äº”ã€Redis åŸç†</h2><h3 id="5-1-çº¿ç¨‹-IO-æ¨¡å‹"><a href="#5-1-çº¿ç¨‹-IO-æ¨¡å‹" class="headerlink" title="5.1 çº¿ç¨‹ IO æ¨¡å‹"></a>5.1 çº¿ç¨‹ IO æ¨¡å‹</h3><p>è®°ä½é«˜å¹¶å‘çš„ Redis ä¸­é—´ä»¶æ˜¯ å•çº¿ç¨‹çš„ï¼Œé™¤æ­¤ä¹‹å¤–ï¼ŒNode.jsã€Nginx ä¹Ÿæ˜¯å•çº¿ç¨‹ï¼Œä½†æ˜¯å®ƒä»¬éƒ½æ˜¯æœåŠ¡å™¨é«˜æ€§èƒ½çš„å…¸èŒƒã€‚</p><p>è¯¦ç»†å¯ä»¥çœ‹ 3.3</p><h3 id="5-2-é€šä¿¡åè®®"><a href="#5-2-é€šä¿¡åè®®" class="headerlink" title="5.2 é€šä¿¡åè®®"></a>5.2 é€šä¿¡åè®®</h3><p>Redis çš„ä½œè€…è®¤ä¸º æ•°æ®åº“ç³»ç»Ÿçš„ç“¶é¢ˆä¸€èˆ¬ä¸åœ¨äºç½‘ç»œæµé‡ï¼Œè€Œæ˜¯æ•°æ®åº“è‡ªèº«å†…éƒ¨é€»è¾‘å¤„ç†ä¸Šã€‚æ‰€ä»¥å³ä½¿ redis ä½¿ç”¨äº†æµªè´¹æµé‡çš„æ–‡æœ¬åè®®ï¼Œä¾ç„¶å¯ä»¥å–å¾—æé«˜çš„è®¿é—®æ€§èƒ½ã€‚</p><h4 id="5-2-1-RESP-ï¼ˆRedis-Serialization-Protocolï¼‰"><a href="#5-2-1-RESP-ï¼ˆRedis-Serialization-Protocolï¼‰" class="headerlink" title="5.2.1 RESP ï¼ˆRedis Serialization Protocolï¼‰"></a>5.2.1 RESP ï¼ˆRedis Serialization Protocolï¼‰</h4><p>RESP æ˜¯ Redis åºåˆ—åŒ–åè®®çš„ç®€å†™ã€‚å®ƒæ˜¯ä¸€ç§ç›´è§‚çš„æ–‡æœ¬åè®®ï¼Œä¼˜åŠ¿åœ¨äºå®ç°å¼‚å¸¸ç®€å•ï¼Œè§£ææ€§èƒ½æå¥½ã€‚Redis åè®®å°†ä¼ è¾“çš„ç»“æ„æ•°æ® åˆ†ä¸º5ç§å•å…ƒç±»å‹ï¼Œå•å…ƒç»“æŸæ—¶ç»Ÿä¸€åŠ ä¸Šå›è½¦æ¢è¡Œç¬¦å·\r\nã€‚</p><ul><li>å•è¡Œå­—ç¬¦ä¸² ä»¥ + ç¬¦å·å¼€å¤´ã€‚</li><li>å¤šè¡Œå­—ç¬¦ä¸² ä»¥ $ ç¬¦å·å¼€å¤´ï¼Œåè·Ÿå­—ç¬¦ä¸²é•¿åº¦</li><li>æ•´æ•°å€¼ ä»¥ : ç¬¦å·å¼€å¤´ï¼Œåè·Ÿæ•´æ•°çš„å­—ç¬¦ä¸²å½¢å¼</li><li>é”™è¯¯ä¿¡æ¯ ä»¥ - ç¬¦å·å¼€å¤´</li><li>æ•°ç»„ ä»¥ * å·å¼€å¤´ï¼Œåè·Ÿæ•°ç»„é•¿åº¦</li></ul><h4 id="5-2-2-å°ç»“"><a href="#5-2-2-å°ç»“" class="headerlink" title="5.2.2 å°ç»“"></a>5.2.2 å°ç»“</h4><p>Redis åè®®é‡Œæœ‰å¤§é‡å†—ä½™çš„å›è½¦æ¢è¡Œç¬¦ï¼Œä½†æ˜¯è¿™ä¸ªå¹¶ä¸å½±å“å®ƒæˆä¸ºäº’è”ç½‘æŠ€æœ¯é¢†åŸŸéå¸¸å—æ¬¢è¿çš„ä¸€ä¸ªæ–‡æœ¬åè®®ã€‚æœ‰å¾ˆå¤šå¼€æºé¡¹ç›®ä½¿ç”¨ RESP ä½œä¸ºå®ƒçš„é€šè®¯åè®®ã€‚åœ¨æŠ€æœ¯é¢†åŸŸæ€§èƒ½å¹¶ä¸æ€»æ˜¯ä¸€åˆ‡ï¼Œè¿˜æœ‰ç®€å•æ€§ã€æ˜“ç†è§£æ€§å’Œæ˜“å®ç°æ€§ï¼Œè¿™äº›éƒ½éœ€è¦è¿›è¡Œé€‚å½“æƒè¡¡ã€‚</p><h3 id="5-3-æŒä¹…åŒ–"><a href="#5-3-æŒä¹…åŒ–" class="headerlink" title="5.3 æŒä¹…åŒ–"></a>5.3 æŒä¹…åŒ–</h3><p>Redis çš„æ•°æ®å…¨éƒ¨åœ¨å†…å­˜ä¸­ï¼Œå¦‚æœçªç„¶å®•æœºï¼Œæ•°æ®å°±ä¼šå…¨éƒ¨ä¸¢å¤±ï¼Œå› æ­¤å¿…é¡»æœ‰ä¸€ç§æœºåˆ¶æ¥ä¿è¯ Redis çš„æ•°æ®ä¸ä¼šå› ä¸ºæ•…éšœè€Œä¸¢å¤±ï¼Œè¿™ç§æœºåˆ¶å°±æ˜¯ Redis çš„æŒä¹…åŒ–æœºåˆ¶ã€‚</p><p>Redis æŒä¹…åŒ–æœºåˆ¶æœ‰ä¸¤ç§ï¼Œç¬¬ä¸€ç§æ˜¯å¿«ç…§ï¼Œç¬¬äºŒç§æ˜¯AOFæ—¥å¿—ã€‚</p><ul><li>RDB å°†æ•°æ®åº“çš„å¿«ç…§ï¼ˆsnapshotï¼‰ä»¥äºŒè¿›åˆ¶çš„æ–¹å¼ä¿å­˜åˆ°ç£ç›˜ä¸­ã€‚</li><li>AOF åˆ™ä»¥åè®®æ–‡æœ¬çš„æ–¹å¼ï¼Œå°†æ‰€æœ‰å¯¹æ•°æ®åº“è¿›è¡Œè¿‡å†™å…¥çš„å‘½ä»¤ï¼ˆåŠå…¶å‚æ•°ï¼‰è®°å½•åˆ° AOF æ–‡ä»¶ï¼Œä»¥æ­¤è¾¾åˆ°è®°å½•æ•°æ®åº“çŠ¶æ€çš„ç›®çš„ã€‚</li></ul><p>AOF æ—¥å¿—åœ¨é•¿æœŸçš„è¿è¡Œè¿‡ç¨‹ä¸­ä¼šå˜çš„æ— æ¯”åºå¤§ï¼Œæ•°æ®åº“é‡å¯æ—¶éœ€è¦åŠ è½½ AOF æ—¥å¿—è¿›è¡ŒæŒ‡ä»¤é‡æ”¾ï¼Œè¿™ä¸ªæ—¶é—´å°±ä¼šæ— æ¯”æ¼«é•¿ã€‚æ‰€ä»¥éœ€è¦å®šæœŸè¿›è¡ŒAOFé‡å†™ï¼Œç»™AOFæ—¥å¿—è¿›è¡Œç˜¦èº«ã€‚</p><h4 id="5-3-1-å¿«ç…§"><a href="#5-3-1-å¿«ç…§" class="headerlink" title="5.3.1 å¿«ç…§"></a>5.3.1 å¿«ç…§</h4><p>æˆ‘ä»¬éƒ½çŸ¥é“ Redis æ˜¯å•çº¿ç¨‹ç¨‹åºï¼Œè¿™ä¸ªçº¿ç¨‹è¦åŒæ—¶è´Ÿè´£å¤šä¸ªå®¢æˆ·ç«¯å¥—æ¥å­—çš„å¹¶å‘è¯»å†™æ“ä½œå’Œå†…å­˜æ•°æ®ç»“æ„çš„é€»è¾‘è¯»å†™ã€‚åœ¨æœåŠ¡çº¿ä¸Šè¯·æ±‚çš„åŒæ—¶ï¼ŒRedis å¦‚æœè¿˜éœ€è¦è¿›è¡Œå†…å­˜å¿«ç…§ï¼ˆéœ€è¦ä½¿ç”¨ æ–‡ä»¶IOæ“ä½œï¼‰ï¼Œé‚£å°±å¾ˆéš¾ä¿æŒä¸å µå¡ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒæŒä¹…åŒ–çš„åŒæ—¶ï¼Œå†…å­˜æ•°æ®ç»“æ„è¿˜åœ¨æ”¹å˜ã€‚è¿™å¦‚ä½•åº”å¯¹ï¼Ÿ</p><p>Redis ä½¿ç”¨æ“ä½œç³»ç»Ÿçš„å¤šè¿›ç¨‹ COW (copy on write) æœºåˆ¶æ¥å®ç°å¿«ç…§æŒä¹…åŒ–ã€‚</p><p>Redis åœ¨æŒä¹…åŒ–æ—¶ä¼šè°ƒç”¨ glibc çš„å‡½æ•° fork äº§ç”Ÿä¸€ä¸ªå­è¿›ç¨‹ï¼Œå¿«ç…§æŒä¹…åŒ–å®Œå…¨äº¤ç»™å­è¿›ç¨‹æ¥å¤„ç†ï¼Œçˆ¶è¿›ç¨‹ç»§ç»­å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ã€‚å­è¿›ç¨‹åˆšåˆšäº§ç”Ÿæ—¶ï¼Œå®ƒå’Œçˆ¶è¿›ç¨‹å…±äº«å†…å­˜é‡Œé¢çš„ä»£ç æ®µå’Œæ•°æ®æ®µã€‚ï¼ˆè¿™æ˜¯Linuxä¸ºèŠ‚çº¦å†…å­˜èµ„æºï¼Œæ‰€ä»¥è®©å…¶å…±äº«èµ·æ¥ï¼Œåœ¨å­è¿›ç¨‹åˆ›å»ºæ—¶ï¼Œå†…å­˜å¢é•¿å‡ ä¹æ²¡æœ‰æ˜æ˜¾å˜åŒ–ï¼‰</p><p>å­è¿›ç¨‹åšæ•°æ®æŒä¹…åŒ–ï¼Œå®ƒä¸ä¼šä¿®æ”¹ç°æœ‰çš„å†…å­˜æ•°æ®ç»“æ„ï¼Œå®ƒåªæ˜¯å¯¹æ•°æ®ç»“æ„è¿›è¡Œéå†è¯»å–ï¼Œç„¶ååºåˆ—åŒ–å†™å…¥åˆ°ç£ç›˜ã€‚ä½†æ˜¯çˆ¶è¿›ç¨‹ä¸ä¸€æ ·ï¼Œå®ƒå¿…é¡»æŒç»­æ¥å—å®¢æˆ·ç«¯è¯·æ±‚ï¼Œç„¶åå¯¹å†…å­˜æ•°æ®ç»“æ„è¿›è¡Œä¸é—´æ–­ä¿®æ”¹ã€‚</p><p>è¿™æ—¶å€™å°±ä¼šä½¿ç”¨æ“ä½œç³»ç»Ÿçš„ COW æœºåˆ¶æ¥è¿›è¡Œæ•°æ®æ®µé¡µé¢çš„åˆ†ç¦»ã€‚æ•°æ®æ®µé¡µé¢æ˜¯ç”±å¾ˆå¤šæ“ä½œç³»ç»Ÿçš„é¡µé¢ç»„åˆè€Œæˆï¼Œå½“çˆ¶è¿›ç¨‹å¯¹å…¶ä¸­ä¸€ä¸ªé¡µé¢çš„æ•°æ®è¿›è¡Œä¿®æ”¹æ—¶ï¼Œä¼šå°†è¢«å…±äº«çš„é¡µé¢å¤åˆ¶ä¸€ä»½åˆ†ç¦»å‡ºæ¥ï¼Œç„¶åå¯¹è¿™ä¸ªå¤åˆ¶çš„é¡µé¢è¿›è¡Œä¿®æ”¹ã€‚è¿™æ—¶å­è¿›ç¨‹ç›¸åº”çš„é¡µé¢æ˜¯æ²¡æœ‰å˜åŒ–çš„ï¼Œè¿˜æ˜¯è¿›ç¨‹äº§ç”Ÿæ—¶é‚£ä¸€ç¬é—´çš„æ•°æ®ã€‚</p><p>éšç€çˆ¶è¿›ç¨‹ä¿®æ”¹æ“ä½œçš„æŒç»­è¿›è¡Œï¼Œè¶Šæ¥è¶Šå¤šçš„å…±äº«é¡µé¢è¢«åˆ†ç¦»å‡ºæ¥ï¼Œå†…å­˜å°±ä¼šæŒç»­å¢é•¿ã€‚ä½†æ˜¯ä¹Ÿä¸ä¼šè¶…è¿‡åŸæœ‰æ•°æ®å†…å­˜çš„2å€å¤§å°ã€‚å¦ä¸€ä¸ªRediså®ä¾‹é‡Œå†·æ•°æ®å çš„æ¯”ä¾‹å¾€å¾€æ˜¯æ¯”è¾ƒé«˜çš„ï¼Œæ‰€ä»¥å¾ˆå°‘ä¼šå‡ºç°æ‰€æœ‰çš„é¡µé¢éƒ½ä¼šè¢«åˆ†ç¦»ï¼Œè¢«åˆ†ç¦»çš„å¾€å¾€åªæœ‰å…¶ä¸­ä¸€éƒ¨åˆ†é¡µé¢ã€‚æ¯ä¸ªé¡µé¢çš„å¤§å°åªæœ‰ 4kï¼Œä¸€ä¸ª Redis å®ä¾‹é‡Œé¢ä¸€èˆ¬éƒ½ä¼šæœ‰æˆåƒä¸Šä¸‡çš„é¡µé¢ã€‚</p><p>å­è¿›ç¨‹å› ä¸ºæ•°æ®æ²¡æœ‰å˜åŒ–ï¼Œå®ƒèƒ½çœ‹åˆ°çš„å†…å­˜é‡Œçš„æ•°æ®åœ¨è¿›ç¨‹äº§ç”Ÿçš„é‚£ä¸€ç¬é—´å°±å‡å›ºäº†ï¼Œå†ä¹Ÿä¸ä¼šæ”¹å˜ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ Redis çš„æŒä¹…åŒ–å« å¿«ç…§çš„åŸå› ã€‚</p><h4 id="5-3-2-AOFçš„å†™å…¥"><a href="#5-3-2-AOFçš„å†™å…¥" class="headerlink" title="5.3.2 AOFçš„å†™å…¥"></a>5.3.2 AOFçš„å†™å…¥</h4><p>Redis å°†æ‰€æœ‰å¯¹æ•°æ®åº“è¿›è¡Œè¿‡å†™å…¥çš„å‘½ä»¤ï¼ˆåŠå…¶å‚æ•°ï¼‰è®°å½•åˆ° AOF æ–‡ä»¶ï¼Œ ä»¥æ­¤è¾¾åˆ°è®°å½•æ•°æ®åº“çŠ¶æ€çš„ç›®çš„ï¼Œ ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œ æˆ‘ä»¬ç§°å‘¼è¿™ç§è®°å½•è¿‡ç¨‹ä¸ºåŒæ­¥ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œ å¦‚æœæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; RPUSH list 1 2 3 4</span><br><span class="line">(integer) 4</span><br><span class="line"></span><br><span class="line">redis&gt; LRANGE list 0 -1</span><br><span class="line">1) &quot;1&quot;</span><br><span class="line">2) &quot;2&quot;</span><br><span class="line">3) &quot;3&quot;</span><br><span class="line">4) &quot;4&quot;</span><br><span class="line"></span><br><span class="line">redis&gt; KEYS *</span><br><span class="line">1) &quot;list&quot;</span><br><span class="line"></span><br><span class="line">redis&gt; RPOP list</span><br><span class="line">&quot;4&quot;</span><br><span class="line"></span><br><span class="line">redis&gt; LPOP list</span><br><span class="line">&quot;1&quot;</span><br><span class="line"></span><br><span class="line">redis&gt; LPUSH list 1</span><br><span class="line">(integer) 3</span><br><span class="line"></span><br><span class="line">redis&gt; LRANGE list 0 -1</span><br><span class="line">1) &quot;1&quot;</span><br><span class="line">2) &quot;2&quot;</span><br><span class="line">3) &quot;3&quot;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå…¶ä¸­å››æ¡å¯¹æ•°æ®åº“æœ‰ä¿®æ”¹çš„å†™å…¥å‘½ä»¤å°±ä¼šè¢«åŒæ­¥åˆ° AOF æ–‡ä»¶ä¸­</p><p>é™¤äº† SELECT å‘½ä»¤æ˜¯ AOF ç¨‹åºè‡ªå·±åŠ ä¸Šå»çš„ä¹‹å¤–ï¼Œ å…¶ä»–å‘½ä»¤éƒ½æ˜¯ä¹‹å‰æˆ‘ä»¬åœ¨ç»ˆç«¯é‡Œæ‰§è¡Œçš„å‘½ä»¤ã€‚</p><p>åŒæ­¥å‘½ä»¤åˆ° AOF æ–‡ä»¶çš„æ•´ä¸ªè¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š</p><ol><li>å‘½ä»¤ä¼ æ’­ï¼šRedis å°†æ‰§è¡Œå®Œçš„å‘½ä»¤ã€å‘½ä»¤çš„å‚æ•°ã€å‘½ä»¤çš„å‚æ•°ä¸ªæ•°ç­‰ä¿¡æ¯å‘é€åˆ° AOF ç¨‹åºä¸­ã€‚</li><li>ç¼“å­˜è¿½åŠ ï¼šAOF ç¨‹åºæ ¹æ®æ¥æ”¶åˆ°çš„å‘½ä»¤æ•°æ®ï¼Œå°†å‘½ä»¤è½¬æ¢ä¸ºç½‘ç»œé€šè®¯åè®®çš„æ ¼å¼ï¼Œç„¶åå°†åè®®å†…å®¹è¿½åŠ åˆ°æœåŠ¡å™¨çš„ AOF ç¼“å­˜ä¸­ã€‚</li><li>æ–‡ä»¶å†™å…¥å’Œä¿å­˜ï¼šAOF ç¼“å­˜ä¸­çš„å†…å®¹è¢«å†™å…¥åˆ° AOF æ–‡ä»¶æœ«å°¾ï¼Œå¦‚æœè®¾å®šçš„ AOF ä¿å­˜æ¡ä»¶è¢«æ»¡è¶³çš„è¯ï¼Œ fsync å‡½æ•°æˆ–è€… fdatasync å‡½æ•°ä¼šè¢«è°ƒç”¨ï¼Œå°†å†™å…¥çš„å†…å®¹çœŸæ­£åœ°ä¿å­˜åˆ°ç£ç›˜ä¸­ã€‚</li></ol><p>ä»¥ä¸‹å‡ ä¸ªå°èŠ‚å°†è¯¦ç»†åœ°ä»‹ç»è¿™ä¸‰ä¸ªæ­¥éª¤ã€‚</p><h5 id="å‘½ä»¤ä¼ æ’­"><a href="#å‘½ä»¤ä¼ æ’­" class="headerlink" title="å‘½ä»¤ä¼ æ’­"></a>å‘½ä»¤ä¼ æ’­</h5><p>å½“ä¸€ä¸ª Redis å®¢æˆ·ç«¯éœ€è¦æ‰§è¡Œå‘½ä»¤æ—¶ï¼Œ å®ƒé€šè¿‡ç½‘ç»œè¿æ¥ï¼Œ å°†åè®®æ–‡æœ¬å‘é€ç»™ Redis æœåŠ¡å™¨ã€‚æ¯”å¦‚è¯´ï¼Œ è¦æ‰§è¡Œå‘½ä»¤ SET KEY VALUE ï¼Œ å®¢æˆ·ç«¯å°†å‘æœåŠ¡å™¨å‘é€æ–‡æœ¬ â€œ*3\r\n$3\r\nSET\r\n$3\r\nKEY\r\n$5\r\nVALUE\r\nâ€ ã€‚</p><p>æœåŠ¡å™¨åœ¨æ¥åˆ°å®¢æˆ·ç«¯çš„è¯·æ±‚ä¹‹åï¼Œ å®ƒä¼šæ ¹æ®åè®®æ–‡æœ¬çš„å†…å®¹ï¼Œ é€‰æ‹©é€‚å½“çš„å‘½ä»¤å‡½æ•°ï¼Œ å¹¶å°†å„ä¸ªå‚æ•°ä»å­—ç¬¦ä¸²æ–‡æœ¬è½¬æ¢ä¸º Redis å­—ç¬¦ä¸²å¯¹è±¡ï¼ˆStringObjectï¼‰ã€‚</p><p>æ¯”å¦‚è¯´ï¼Œ é’ˆå¯¹ä¸Šé¢çš„ <a href="http://redis.readthedocs.org/en/latest/string/set.html#set">SET</a> å‘½ä»¤ä¾‹å­ï¼Œ Redis å°†å®¢æˆ·ç«¯çš„å‘½ä»¤æŒ‡é’ˆæŒ‡å‘å®ç° <a href="http://redis.readthedocs.org/en/latest/string/set.html#set">SET</a> å‘½ä»¤çš„ setCommand å‡½æ•°ï¼Œ å¹¶åˆ›å»ºä¸‰ä¸ª Redis å­—ç¬¦ä¸²å¯¹è±¡ï¼Œ åˆ†åˆ«ä¿å­˜ SET ã€ KEY å’Œ VALUE ä¸‰ä¸ªå‚æ•°ï¼ˆå‘½ä»¤ä¹Ÿç®—ä½œå‚æ•°ï¼‰ã€‚</p><p>æ¯å½“å‘½ä»¤å‡½æ•°æˆåŠŸæ‰§è¡Œä¹‹åï¼Œ å‘½ä»¤å‚æ•°éƒ½ä¼šè¢«ä¼ æ’­åˆ° AOF ç¨‹åºï¼Œ ä»¥åŠ REPLICATION ç¨‹åºï¼ˆæœ¬èŠ‚ä¸è®¨è®ºè¿™ä¸ªï¼Œåˆ—åœ¨è¿™é‡Œåªæ˜¯ä¸ºäº†å®Œæ•´æ€§çš„è€ƒè™‘ï¼‰ã€‚</p><h5 id="ç¼“å­˜è¿½åŠ "><a href="#ç¼“å­˜è¿½åŠ " class="headerlink" title="ç¼“å­˜è¿½åŠ "></a>ç¼“å­˜è¿½åŠ </h5><p>å½“å‘½ä»¤è¢«ä¼ æ’­åˆ° AOF ç¨‹åºä¹‹åï¼Œ ç¨‹åºä¼šæ ¹æ®å‘½ä»¤ä»¥åŠå‘½ä»¤çš„å‚æ•°ï¼Œ å°†å‘½ä»¤ä»å­—ç¬¦ä¸²å¯¹è±¡è½¬æ¢å›åŸæ¥çš„åè®®æ–‡æœ¬ã€‚</p><p>æ¯”å¦‚è¯´ï¼Œ å¦‚æœ AOF ç¨‹åºæ¥å—åˆ°çš„ä¸‰ä¸ªå‚æ•°åˆ†åˆ«ä¿å­˜ç€ SET ã€ KEY å’Œ VALUE ä¸‰ä¸ªå­—ç¬¦ä¸²ï¼Œ é‚£ä¹ˆå®ƒå°†ç”Ÿæˆåè®®æ–‡æœ¬ â€œ*3\r\n$3\r\nSET\r\n$3\r\nKEY\r\n$5\r\nVALUE\r\nâ€ ã€‚</p><p>åè®®æ–‡æœ¬ç”Ÿæˆä¹‹åï¼Œ å®ƒä¼šè¢«è¿½åŠ åˆ° redis.h&#x2F;redisServer ç»“æ„çš„ aof_buf æœ«å°¾ã€‚</p><p>redisServer ç»“æ„ç»´æŒç€ Redis æœåŠ¡å™¨çš„çŠ¶æ€ï¼Œ aof_buf åŸŸåˆ™ä¿å­˜ç€æ‰€æœ‰ç­‰å¾…å†™å…¥åˆ° AOF æ–‡ä»¶çš„åè®®æ–‡æœ¬ï¼š</p><h5 id="æ–‡ä»¶å†™å…¥å’Œä¿å­˜"><a href="#æ–‡ä»¶å†™å…¥å’Œä¿å­˜" class="headerlink" title="æ–‡ä»¶å†™å…¥å’Œä¿å­˜"></a>æ–‡ä»¶å†™å…¥å’Œä¿å­˜</h5><p>æ¯å½“æœåŠ¡å™¨å¸¸è§„ä»»åŠ¡å‡½æ•°è¢«æ‰§è¡Œã€ æˆ–è€…äº‹ä»¶å¤„ç†å™¨è¢«æ‰§è¡Œæ—¶ï¼Œ aof.c&#x2F;flushAppendOnlyFile å‡½æ•°éƒ½ä¼šè¢«è°ƒç”¨ï¼Œ è¿™ä¸ªå‡½æ•°æ‰§è¡Œä»¥ä¸‹ä¸¤ä¸ªå·¥ä½œï¼š</p><p>WRITEï¼šæ ¹æ®æ¡ä»¶ï¼Œå°† aof_buf ä¸­çš„ç¼“å­˜å†™å…¥åˆ° AOF æ–‡ä»¶ã€‚</p><p>SAVEï¼šæ ¹æ®æ¡ä»¶ï¼Œè°ƒç”¨ fsync æˆ– fdatasync å‡½æ•°ï¼Œå°† AOF æ–‡ä»¶ä¿å­˜åˆ°ç£ç›˜ä¸­ã€‚</p><p>ä¸¤ä¸ªæ­¥éª¤éƒ½éœ€è¦æ ¹æ®ä¸€å®šçš„æ¡ä»¶æ¥æ‰§è¡Œï¼Œ è€Œè¿™äº›æ¡ä»¶ç”± AOF æ‰€ä½¿ç”¨çš„ä¿å­˜æ¨¡å¼æ¥å†³å®šï¼Œ ä»¥ä¸‹å°èŠ‚å°±æ¥ä»‹ç» AOF æ‰€ä½¿ç”¨çš„ä¸‰ç§ä¿å­˜æ¨¡å¼ï¼Œ ä»¥åŠåœ¨è¿™äº›æ¨¡å¼ä¸‹ï¼Œ æ­¥éª¤ WRITE å’Œ SAVE çš„è°ƒç”¨æ¡ä»¶ã€‚</p><h5 id="AOF-ä¿å­˜æ¨¡å¼"><a href="#AOF-ä¿å­˜æ¨¡å¼" class="headerlink" title="AOF ä¿å­˜æ¨¡å¼"></a>AOF ä¿å­˜æ¨¡å¼</h5><p>Redis ç›®å‰æ”¯æŒä¸‰ç§ AOF ä¿å­˜æ¨¡å¼ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ï¼š</p><ul><li><p>AOF_FSYNC_NO ï¼šä¸ä¿å­˜åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œ æ¯æ¬¡è°ƒç”¨ flushAppendOnlyFile å‡½æ•°ï¼Œ WRITE éƒ½ä¼šè¢«æ‰§è¡Œï¼Œ ä½† SAVE ä¼šè¢«ç•¥è¿‡ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œ SAVE åªä¼šåœ¨ä»¥ä¸‹ä»»æ„ä¸€ç§æƒ…å†µä¸­è¢«æ‰§è¡Œï¼šè¿™ä¸‰ç§æƒ…å†µä¸‹çš„ SAVE æ“ä½œéƒ½ä¼šå¼•èµ· Redis ä¸»è¿›ç¨‹é˜»å¡ã€‚</p></li><li><ul><li>Redis è¢«å…³é—­</li><li>AOF åŠŸèƒ½è¢«å…³é—­</li><li>ç³»ç»Ÿçš„å†™ç¼“å­˜è¢«åˆ·æ–°ï¼ˆå¯èƒ½æ˜¯ç¼“å­˜å·²ç»è¢«å†™æ»¡ï¼Œæˆ–è€…å®šæœŸä¿å­˜æ“ä½œè¢«æ‰§è¡Œï¼‰</li></ul></li><li><p>AOF_FSYNC_EVERYSEC ï¼šæ¯ä¸€ç§’é’Ÿä¿å­˜ä¸€æ¬¡ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸­ï¼Œ SAVE åŸåˆ™ä¸Šæ¯éš”ä¸€ç§’é’Ÿå°±ä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œ å› ä¸º SAVE æ“ä½œæ˜¯ç”±åå°å­çº¿ç¨‹è°ƒç”¨çš„ï¼Œ æ‰€ä»¥å®ƒä¸ä¼šå¼•èµ·æœåŠ¡å™¨ä¸»è¿›ç¨‹é˜»å¡ã€‚æ³¨æ„ï¼Œ åœ¨ä¸Šä¸€å¥çš„è¯´æ˜é‡Œé¢ä½¿ç”¨äº†è¯è¯­â€œåŸåˆ™ä¸Šâ€ï¼Œ åœ¨å®é™…è¿è¡Œä¸­ï¼Œ ç¨‹åºåœ¨è¿™ç§æ¨¡å¼ä¸‹å¯¹ fsync æˆ– fdatasync çš„è°ƒç”¨å¹¶ä¸æ˜¯æ¯ç§’ä¸€æ¬¡ï¼Œ å®ƒå’Œè°ƒç”¨ flushAppendOnlyFile å‡½æ•°æ—¶ Redis æ‰€å¤„çš„çŠ¶æ€æœ‰å…³ã€‚æ¯å½“ flushAppendOnlyFile å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œ å¯èƒ½ä¼šå‡ºç°ä»¥ä¸‹å››ç§æƒ…å†µï¼šæ ¹æ®ä»¥ä¸Šè¯´æ˜å¯ä»¥çŸ¥é“ï¼Œ åœ¨â€œæ¯ä¸€ç§’é’Ÿä¿å­˜ä¸€æ¬¡â€æ¨¡å¼ä¸‹ï¼Œ å¦‚æœåœ¨æƒ…å†µ 1 ä¸­å‘ç”Ÿæ•…éšœåœæœºï¼Œ é‚£ä¹ˆç”¨æˆ·æœ€å¤šæŸå¤±å°äº 2 ç§’å†…æ‰€äº§ç”Ÿçš„æ‰€æœ‰æ•°æ®ã€‚å¦‚æœåœ¨æƒ…å†µ 2 ä¸­å‘ç”Ÿæ•…éšœåœæœºï¼Œ é‚£ä¹ˆç”¨æˆ·æŸå¤±çš„æ•°æ®æ˜¯å¯ä»¥è¶…è¿‡ 2 ç§’çš„ã€‚Redis å®˜ç½‘ä¸Šæ‰€è¯´çš„ï¼Œ AOF åœ¨â€œæ¯ä¸€ç§’é’Ÿä¿å­˜ä¸€æ¬¡â€æ—¶å‘ç”Ÿæ•…éšœï¼Œ åªä¸¢å¤± 1 ç§’é’Ÿæ•°æ®çš„è¯´æ³•ï¼Œ å®é™…ä¸Šå¹¶ä¸å‡†ç¡®ã€‚</p></li><li><ul><li>å­çº¿ç¨‹æ­£åœ¨æ‰§è¡Œ SAVE ï¼Œå¹¶ä¸”ï¼š</li></ul></li></ul><ol><li><ol><li><ol><li>è¿™ä¸ª SAVE çš„æ‰§è¡Œæ—¶é—´æœªè¶…è¿‡ 2 ç§’ï¼Œé‚£ä¹ˆç¨‹åºç›´æ¥è¿”å›ï¼Œå¹¶ä¸æ‰§è¡Œ WRITE æˆ–æ–°çš„ SAVE ã€‚</li><li>è¿™ä¸ª SAVE å·²ç»æ‰§è¡Œè¶…è¿‡ 2 ç§’ï¼Œé‚£ä¹ˆç¨‹åºæ‰§è¡Œ WRITE ï¼Œä½†ä¸æ‰§è¡Œæ–°çš„ SAVE ã€‚æ³¨æ„ï¼Œå› ä¸ºè¿™æ—¶ WRITE çš„å†™å…¥å¿…é¡»ç­‰å¾…å­çº¿ç¨‹å…ˆå®Œæˆï¼ˆæ—§çš„ï¼‰ SAVE ï¼Œå› æ­¤è¿™é‡Œ WRITE ä¼šæ¯”å¹³æ—¶é˜»å¡æ›´é•¿æ—¶é—´ã€‚</li></ol></li></ol></li></ol><ul><li><ul><li>å­çº¿ç¨‹æ²¡æœ‰åœ¨æ‰§è¡Œ SAVE ï¼Œå¹¶ä¸”ï¼š</li></ul></li></ul><ol><li><ol><li><ol><li>ä¸Šæ¬¡æˆåŠŸæ‰§è¡Œ SAVE è·ä»Šä¸è¶…è¿‡ 1 ç§’ï¼Œé‚£ä¹ˆç¨‹åºæ‰§è¡Œ WRITE ï¼Œä½†ä¸æ‰§è¡Œ SAVE ã€‚</li><li>ä¸Šæ¬¡æˆåŠŸæ‰§è¡Œ SAVE è·ä»Šå·²ç»è¶…è¿‡ 1 ç§’ï¼Œé‚£ä¹ˆç¨‹åºæ‰§è¡Œ WRITE å’Œ SAVE ã€‚</li></ol></li></ol></li></ol><ul><li>AOF_FSYNC_ALWAYS ï¼šæ¯æ‰§è¡Œä¸€ä¸ªå‘½ä»¤ä¿å­˜ä¸€æ¬¡ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œæ¯æ¬¡æ‰§è¡Œå®Œä¸€ä¸ªå‘½ä»¤ä¹‹åï¼Œ WRITE å’Œ SAVE éƒ½ä¼šè¢«æ‰§è¡Œã€‚å¦å¤–ï¼Œå› ä¸º SAVE æ˜¯ç”± Redis ä¸»è¿›ç¨‹æ‰§è¡Œçš„ï¼Œæ‰€ä»¥åœ¨ SAVE æ‰§è¡ŒæœŸé—´ï¼Œä¸»è¿›ç¨‹ä¼šè¢«é˜»å¡ï¼Œä¸èƒ½æ¥å—å‘½ä»¤è¯·æ±‚ã€‚</li></ul><p>æ€»ç»“ï¼š</p><table><thead><tr><th><strong>æ¨¡å¼</strong></th><th><strong>WRITE æ˜¯å¦é˜»å¡ï¼Ÿ</strong></th><th><strong>SAVE æ˜¯å¦é˜»å¡ï¼Ÿ</strong></th><th><strong>åœæœºæ—¶ä¸¢å¤±çš„æ•°æ®é‡</strong></th></tr></thead><tbody><tr><td>AOF_FSYNC_NO</td><td>é˜»å¡</td><td>é˜»å¡</td><td>æ“ä½œç³»ç»Ÿæœ€åä¸€æ¬¡å¯¹ AOF æ–‡ä»¶è§¦å‘ SAVE æ“ä½œä¹‹åçš„æ•°æ®ã€‚</td></tr><tr><td>AOF_FSYNC_EVERYSEC</td><td>é˜»å¡</td><td>ä¸é˜»å¡</td><td>ä¸€èˆ¬æƒ…å†µä¸‹ä¸è¶…è¿‡ 2 ç§’é’Ÿçš„æ•°æ®ã€‚</td></tr><tr><td>AOF_FSYNC_ALWAYS</td><td>é˜»å¡</td><td>é˜»å¡</td><td>æœ€å¤šåªä¸¢å¤±ä¸€ä¸ªå‘½ä»¤çš„æ•°æ®ã€‚</td></tr></tbody></table><h4 id="5-3-3-AOF-æ–‡ä»¶çš„è¯»å–å’Œæ•°æ®è¿˜åŸ"><a href="#5-3-3-AOF-æ–‡ä»¶çš„è¯»å–å’Œæ•°æ®è¿˜åŸ" class="headerlink" title="5.3.3 AOF æ–‡ä»¶çš„è¯»å–å’Œæ•°æ®è¿˜åŸ"></a>5.3.3 AOF æ–‡ä»¶çš„è¯»å–å’Œæ•°æ®è¿˜åŸ</h4><p>AOF æ–‡ä»¶ä¿å­˜äº† Redis çš„æ•°æ®åº“çŠ¶æ€ï¼Œ è€Œæ–‡ä»¶é‡Œé¢åŒ…å«çš„éƒ½æ˜¯ç¬¦åˆ Redis é€šè®¯åè®®æ ¼å¼çš„å‘½ä»¤æ–‡æœ¬ã€‚</p><p>è¿™ä¹Ÿå°±æ˜¯è¯´ï¼Œ åªè¦æ ¹æ® AOF æ–‡ä»¶é‡Œçš„åè®®ï¼Œ é‡æ–°æ‰§è¡Œä¸€éé‡Œé¢æŒ‡ç¤ºçš„æ‰€æœ‰å‘½ä»¤ï¼Œ å°±å¯ä»¥è¿˜åŸ Redis çš„æ•°æ®åº“çŠ¶æ€äº†ã€‚</p><p>Redis è¯»å– AOF æ–‡ä»¶å¹¶è¿˜åŸæ•°æ®åº“çš„è¯¦ç»†æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>åˆ›å»ºä¸€ä¸ªä¸å¸¦ç½‘ç»œè¿æ¥çš„ä¼ªå®¢æˆ·ç«¯ï¼ˆfake clientï¼‰ã€‚</li><li>è¯»å– AOF æ‰€ä¿å­˜çš„æ–‡æœ¬ï¼Œå¹¶æ ¹æ®å†…å®¹è¿˜åŸå‡ºå‘½ä»¤ã€å‘½ä»¤çš„å‚æ•°ä»¥åŠå‘½ä»¤çš„ä¸ªæ•°ã€‚</li><li>æ ¹æ®å‘½ä»¤ã€å‘½ä»¤çš„å‚æ•°å’Œå‘½ä»¤çš„ä¸ªæ•°ï¼Œä½¿ç”¨ä¼ªå®¢æˆ·ç«¯æ‰§è¡Œè¯¥å‘½ä»¤ã€‚</li><li>æ‰§è¡Œ 2 å’Œ 3 ï¼Œç›´åˆ° AOF æ–‡ä»¶ä¸­çš„æ‰€æœ‰å‘½ä»¤æ‰§è¡Œå®Œæ¯•ã€‚</li></ol><p>å®Œæˆç¬¬ 4 æ­¥ä¹‹åï¼Œ AOF æ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®åº“å°±ä¼šè¢«å®Œæ•´åœ°è¿˜åŸå‡ºæ¥ã€‚</p><p>æ³¨æ„ï¼Œ å› ä¸º Redis çš„å‘½ä»¤åªèƒ½åœ¨å®¢æˆ·ç«¯çš„ä¸Šä¸‹æ–‡ä¸­è¢«æ‰§è¡Œï¼Œ è€Œ AOF è¿˜åŸæ—¶æ‰€ä½¿ç”¨çš„å‘½ä»¤æ¥è‡ªäº AOF æ–‡ä»¶ï¼Œ è€Œä¸æ˜¯ç½‘ç»œï¼Œ æ‰€ä»¥ç¨‹åºä½¿ç”¨äº†ä¸€ä¸ªæ²¡æœ‰ç½‘ç»œè¿æ¥çš„ä¼ªå®¢æˆ·ç«¯æ¥æ‰§è¡Œå‘½ä»¤ã€‚ ä¼ªå®¢æˆ·ç«¯æ‰§è¡Œå‘½ä»¤çš„æ•ˆæœï¼Œ å’Œå¸¦ç½‘ç»œè¿æ¥çš„å®¢æˆ·ç«¯æ‰§è¡Œå‘½ä»¤çš„æ•ˆæœï¼Œ å®Œå…¨ä¸€æ ·ã€‚</p><h4 id="5-3-4-AOF-é‡å†™"><a href="#5-3-4-AOF-é‡å†™" class="headerlink" title="5.3.4 AOF é‡å†™"></a>5.3.4 AOF é‡å†™</h4><p>AOF æ–‡ä»¶é€šè¿‡åŒæ­¥ Redis æœåŠ¡å™¨æ‰€æ‰§è¡Œçš„å‘½ä»¤ï¼Œ ä»è€Œå®ç°äº†æ•°æ®åº“çŠ¶æ€çš„è®°å½•ï¼Œ ä½†æ˜¯ï¼Œ è¿™ç§åŒæ­¥æ–¹å¼ä¼šé€ æˆä¸€ä¸ªé—®é¢˜ï¼š éšç€è¿è¡Œæ—¶é—´çš„æµé€ï¼Œ AOF æ–‡ä»¶ä¼šå˜å¾—è¶Šæ¥è¶Šå¤§ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œ å¦‚æœæœåŠ¡å™¨æ‰§è¡Œäº†ä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">RPUSH list 1 2 3 4      // [1, 2, 3, 4]</span><br><span class="line"></span><br><span class="line">RPOP list               // [1, 2, 3]</span><br><span class="line"></span><br><span class="line">LPOP list               // [2, 3]</span><br><span class="line"></span><br><span class="line">LPUSH list 1            // [1, 2, 3]</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå…‰æ˜¯è®°å½• list é”®çš„çŠ¶æ€ï¼Œ AOF æ–‡ä»¶å°±éœ€è¦ä¿å­˜å››æ¡å‘½ä»¤ã€‚è€Œå®è´¨ä¸Šï¼Œæˆ‘ä»¬å…¶å®åªè¦ä¿å­˜ list æœ€æ–°çŠ¶æ€çš„å†…å­˜æ•°æ®ï¼Œå°±å¯ä»¥ã€‚</p><p>å¦ä¸€æ–¹é¢ï¼Œ æœ‰äº›è¢«é¢‘ç¹æ“ä½œçš„é”®ï¼Œ å¯¹å®ƒä»¬æ‰€è°ƒç”¨çš„å‘½ä»¤å¯èƒ½æœ‰æˆç™¾ä¸Šåƒã€ç”šè‡³ä¸Šä¸‡æ¡ï¼Œ å¦‚æœè¿™æ ·è¢«é¢‘ç¹æ“ä½œçš„é”®æœ‰å¾ˆå¤šçš„è¯ï¼Œ AOF æ–‡ä»¶çš„ä½“ç§¯å°±ä¼šæ€¥é€Ÿè†¨èƒ€ï¼Œ å¯¹ Redis ã€ç”šè‡³æ•´ä¸ªç³»ç»Ÿçš„é€ æˆå½±å“ã€‚</p><p>ä¸ºäº†è§£å†³ä»¥ä¸Šçš„é—®é¢˜ï¼Œ Redis éœ€è¦å¯¹ AOF æ–‡ä»¶è¿›è¡Œé‡å†™ï¼ˆrewriteï¼‰ï¼š åˆ›å»ºä¸€ä¸ªæ–°çš„ AOF æ–‡ä»¶æ¥ä»£æ›¿åŸæœ‰çš„ AOF æ–‡ä»¶ï¼Œ æ–° AOF æ–‡ä»¶å’ŒåŸæœ‰ AOF æ–‡ä»¶ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€å®Œå…¨ä¸€æ ·ï¼Œ ä½†æ–° AOF æ–‡ä»¶çš„ä½“ç§¯å°äºç­‰äºåŸæœ‰ AOF æ–‡ä»¶çš„ä½“ç§¯ã€‚</p><h5 id="AOF-é‡å†™çš„å®ç°"><a href="#AOF-é‡å†™çš„å®ç°" class="headerlink" title="AOF é‡å†™çš„å®ç°"></a>AOF é‡å†™çš„å®ç°</h5><p>æ‰€è°“çš„â€œé‡å†™â€å…¶å®æ˜¯ä¸€ä¸ªæœ‰æ­§ä¹‰çš„è¯è¯­ï¼Œ å®é™…ä¸Šï¼Œ AOF é‡å†™å¹¶ä¸éœ€è¦å¯¹åŸæœ‰çš„ AOF æ–‡ä»¶è¿›è¡Œä»»ä½•å†™å…¥å’Œè¯»å–ï¼Œ å®ƒé’ˆå¯¹çš„æ˜¯æ•°æ®åº“ä¸­é”®çš„å½“å‰å€¼ã€‚</p><p>å¦‚åŒä¸Šé¢å¯¹ list è¿›è¡Œçš„å››ä¸ªæ“ä½œåï¼Œé‚£ä¹ˆå½“å‰ åˆ—è¡¨é”®åœ¨ Redisé‡Œçš„å€¼å°±ä¸º [1,2,3]ã€‚å¦‚æœæˆ‘ä»¬è¦ä¿å­˜è¿™ä¸ªåˆ—è¡¨çš„å½“å‰çŠ¶æ€ï¼Œ å¹¶ä¸”å°½é‡å‡å°‘æ‰€ä½¿ç”¨çš„å‘½ä»¤æ•°ï¼Œ é‚£ä¹ˆæœ€ç®€å•çš„æ–¹å¼ä¸æ˜¯å» AOF æ–‡ä»¶ä¸Šåˆ†æå‰é¢æ‰§è¡Œçš„å››æ¡å‘½ä»¤ï¼Œ è€Œæ˜¯ç›´æ¥è¯»å– list é”®åœ¨æ•°æ®åº“çš„å½“å‰å€¼ï¼Œ ç„¶åç”¨ä¸€æ¡ RPUSH 1 2 3 å‘½ä»¤æ¥ä»£æ›¿å‰é¢çš„å››æ¡å‘½ä»¤ã€‚</p><p>é™¤äº†åˆ—è¡¨å’Œé›†åˆä¹‹å¤–ï¼Œ å­—ç¬¦ä¸²ã€æœ‰åºé›†ã€å“ˆå¸Œè¡¨ç­‰é”®ä¹Ÿå¯ä»¥ç”¨ç±»ä¼¼çš„æ–¹æ³•æ¥ä¿å­˜çŠ¶æ€ï¼Œ å¹¶ä¸”ä¿å­˜è¿™äº›çŠ¶æ€æ‰€ä½¿ç”¨çš„å‘½ä»¤æ•°é‡ï¼Œ æ¯”èµ·ä¹‹å‰å»ºç«‹è¿™äº›é”®çš„çŠ¶æ€æ‰€ä½¿ç”¨å‘½ä»¤çš„æ•°é‡è¦å¤§å¤§å‡å°‘ã€‚</p><h5 id="AOF-åå°é‡å†™"><a href="#AOF-åå°é‡å†™" class="headerlink" title="AOF åå°é‡å†™"></a>AOF åå°é‡å†™</h5><p>ä¸Šä¸€èŠ‚å±•ç¤ºçš„ AOF é‡å†™ç¨‹åºå¯ä»¥å¾ˆå¥½åœ°å®Œæˆåˆ›å»ºä¸€ä¸ªæ–° AOF æ–‡ä»¶çš„ä»»åŠ¡ï¼Œ ä½†æ˜¯ï¼Œ åœ¨æ‰§è¡Œè¿™ä¸ªç¨‹åºçš„æ—¶å€™ï¼Œ è°ƒç”¨è€…çº¿ç¨‹ä¼šè¢«é˜»å¡ã€‚</p><p>å¾ˆæ˜æ˜¾ï¼Œ ä½œä¸ºä¸€ç§è¾…ä½æ€§çš„ç»´æŠ¤æ‰‹æ®µï¼Œ Redis ä¸å¸Œæœ› AOF é‡å†™é€ æˆæœåŠ¡å™¨æ— æ³•å¤„ç†è¯·æ±‚ï¼Œ æ‰€ä»¥ Redis å†³å®šå°† AOF é‡å†™ç¨‹åºæ”¾åˆ°ï¼ˆåå°ï¼‰å­è¿›ç¨‹é‡Œæ‰§è¡Œï¼Œ è¿™æ ·å¤„ç†çš„æœ€å¤§å¥½å¤„æ˜¯ï¼š</p><ol><li>å­è¿›ç¨‹è¿›è¡Œ AOF é‡å†™æœŸé—´ï¼Œä¸»è¿›ç¨‹å¯ä»¥ç»§ç»­å¤„ç†å‘½ä»¤è¯·æ±‚ã€‚</li><li>å­è¿›ç¨‹å¸¦æœ‰ä¸»è¿›ç¨‹çš„æ•°æ®å‰¯æœ¬ï¼Œä½¿ç”¨å­è¿›ç¨‹è€Œä¸æ˜¯çº¿ç¨‹ï¼Œå¯ä»¥åœ¨é¿å…é”çš„æƒ…å†µä¸‹ï¼Œä¿è¯æ•°æ®çš„å®‰å…¨æ€§ã€‚</li></ol><p>ä¸è¿‡ï¼Œ ä½¿ç”¨å­è¿›ç¨‹ä¹Ÿæœ‰ä¸€ä¸ªé—®é¢˜éœ€è¦è§£å†³ï¼š å› ä¸ºå­è¿›ç¨‹åœ¨è¿›è¡Œ AOF é‡å†™æœŸé—´ï¼Œ ä¸»è¿›ç¨‹è¿˜éœ€è¦ç»§ç»­å¤„ç†å‘½ä»¤ï¼Œ è€Œæ–°çš„å‘½ä»¤å¯èƒ½å¯¹ç°æœ‰çš„æ•°æ®è¿›è¡Œä¿®æ”¹ï¼Œ è¿™ä¼šè®©å½“å‰æ•°æ®åº“çš„æ•°æ®å’Œé‡å†™åçš„ AOF æ–‡ä»¶ä¸­çš„æ•°æ®ä¸ä¸€è‡´ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ Redis å¢åŠ äº†ä¸€ä¸ª AOF é‡å†™ç¼“å­˜ï¼Œ è¿™ä¸ªç¼“å­˜åœ¨ fork å‡ºå­è¿›ç¨‹ä¹‹åå¼€å§‹å¯ç”¨ï¼Œ Redis ä¸»è¿›ç¨‹åœ¨æ¥åˆ°æ–°çš„å†™å‘½ä»¤ä¹‹åï¼Œ é™¤äº†ä¼šå°†è¿™ä¸ªå†™å‘½ä»¤çš„åè®®å†…å®¹è¿½åŠ åˆ°ç°æœ‰çš„ AOF æ–‡ä»¶ä¹‹å¤–ï¼Œ è¿˜ä¼šè¿½åŠ åˆ°è¿™ä¸ªç¼“å­˜ä¸­ã€‚</p><p>æ¢è¨€ä¹‹ï¼Œ å½“å­è¿›ç¨‹åœ¨æ‰§è¡Œ AOF é‡å†™æ—¶ï¼Œ ä¸»è¿›ç¨‹éœ€è¦æ‰§è¡Œä»¥ä¸‹ä¸‰ä¸ªå·¥ä½œï¼š</p><ol><li>å¤„ç†å‘½ä»¤è¯·æ±‚ã€‚</li><li>å°†å†™å‘½ä»¤è¿½åŠ åˆ°ç°æœ‰çš„ AOF æ–‡ä»¶ä¸­ã€‚</li><li>å°†å†™å‘½ä»¤è¿½åŠ åˆ° AOF é‡å†™ç¼“å­˜ä¸­ã€‚</li></ol><p>è¿™æ ·ä¸€æ¥å¯ä»¥ä¿è¯ï¼š</p><ol><li>ç°æœ‰çš„ AOF åŠŸèƒ½ä¼šç»§ç»­æ‰§è¡Œï¼Œå³ä½¿åœ¨ AOF é‡å†™æœŸé—´å‘ç”Ÿåœæœºï¼Œä¹Ÿä¸ä¼šæœ‰ä»»ä½•æ•°æ®ä¸¢å¤±ã€‚</li><li>æ‰€æœ‰å¯¹æ•°æ®åº“è¿›è¡Œä¿®æ”¹çš„å‘½ä»¤éƒ½ä¼šè¢«è®°å½•åˆ° AOF é‡å†™ç¼“å­˜ä¸­ã€‚</li></ol><p>å½“å­è¿›ç¨‹å®Œæˆ AOF é‡å†™ä¹‹åï¼Œ å®ƒä¼šå‘çˆ¶è¿›ç¨‹å‘é€ä¸€ä¸ªå®Œæˆä¿¡å·ï¼Œ çˆ¶è¿›ç¨‹åœ¨æ¥åˆ°å®Œæˆä¿¡å·ä¹‹åï¼Œ ä¼šè°ƒç”¨ä¸€ä¸ªä¿¡å·å¤„ç†å‡½æ•°ï¼Œ å¹¶å®Œæˆä»¥ä¸‹å·¥ä½œï¼š</p><ol><li>å°† AOF é‡å†™ç¼“å­˜ä¸­çš„å†…å®¹å…¨éƒ¨å†™å…¥åˆ°æ–° AOF æ–‡ä»¶ä¸­ã€‚</li><li>å¯¹æ–°çš„ AOF æ–‡ä»¶è¿›è¡Œæ”¹åï¼Œè¦†ç›–åŸæœ‰çš„ AOF æ–‡ä»¶ã€‚</li></ol><p>å½“æ­¥éª¤ 1 æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œ ç°æœ‰ AOF æ–‡ä»¶ã€æ–° AOF æ–‡ä»¶å’Œæ•°æ®åº“ä¸‰è€…çš„çŠ¶æ€å°±å®Œå…¨ä¸€è‡´äº†ã€‚</p><p>å½“æ­¥éª¤ 2 æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œ ç¨‹åºå°±å®Œæˆäº†æ–°æ—§ä¸¤ä¸ª AOF æ–‡ä»¶çš„äº¤æ›¿ã€‚</p><p>è¿™ä¸ªä¿¡å·å¤„ç†å‡½æ•°æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œ ä¸»è¿›ç¨‹å°±å¯ä»¥ç»§ç»­åƒå¾€å¸¸ä¸€æ ·æ¥å—å‘½ä»¤è¯·æ±‚äº†ã€‚ åœ¨æ•´ä¸ª AOF åå°é‡å†™è¿‡ç¨‹ä¸­ï¼Œ åªæœ‰æœ€åçš„å†™å…¥ç¼“å­˜å’Œæ”¹åæ“ä½œä¼šé€ æˆä¸»è¿›ç¨‹é˜»å¡ï¼Œ åœ¨å…¶ä»–æ—¶å€™ï¼Œ AOF åå°é‡å†™éƒ½ä¸ä¼šå¯¹ä¸»è¿›ç¨‹é€ æˆé˜»å¡ï¼Œ è¿™å°† AOF é‡å†™å¯¹æ€§èƒ½é€ æˆçš„å½±å“é™åˆ°äº†æœ€ä½ã€‚</p><h4 id="5-3-5-æ··åˆæŒä¹…åŒ–"><a href="#5-3-5-æ··åˆæŒä¹…åŒ–" class="headerlink" title="5.3.5 æ··åˆæŒä¹…åŒ–"></a>5.3.5 æ··åˆæŒä¹…åŒ–</h4><p>ä¸ºäº†é›†æˆäº†ä¸¤è€…çš„ä¼˜ç‚¹ï¼Œ Redis 4.0 æå‡ºäº†æ··åˆä½¿ç”¨ AOF æ—¥å¿—å’Œå†…å­˜å¿«ç…§ï¼Œä¹Ÿå«æ··åˆæŒä¹…åŒ–ï¼Œæ—¢ä¿è¯äº† Redis é‡å¯é€Ÿåº¦ï¼Œåˆé™ä½æ•°æ®ä¸¢å¤±é£é™©ã€‚</p><p>æ··åˆæŒä¹…åŒ–å·¥ä½œåœ¨ AOF æ—¥å¿—é‡å†™è¿‡ç¨‹ï¼Œå½“å¼€å¯äº†æ··åˆæŒä¹…åŒ–æ—¶ï¼Œåœ¨ AOF é‡å†™æ—¥å¿—æ—¶ï¼Œfork å‡ºæ¥çš„é‡å†™å­è¿›ç¨‹ä¼šå…ˆå°†ä¸ä¸»çº¿ç¨‹å…±äº«çš„å†…å­˜æ•°æ®ä»¥ RDB æ–¹å¼å†™å…¥åˆ° AOF æ–‡ä»¶ï¼Œç„¶åä¸»çº¿ç¨‹å¤„ç†çš„æ“ä½œå‘½ä»¤ä¼šè¢«è®°å½•åœ¨é‡å†™ç¼“å†²åŒºé‡Œï¼Œé‡å†™ç¼“å†²åŒºé‡Œçš„å¢é‡å‘½ä»¤ä¼šä»¥ AOF æ–¹å¼å†™å…¥åˆ° AOF æ–‡ä»¶ï¼Œå†™å…¥å®Œæˆåé€šçŸ¥ä¸»è¿›ç¨‹å°†æ–°çš„å«æœ‰ RDB æ ¼å¼å’Œ AOF æ ¼å¼çš„ AOF æ–‡ä»¶æ›¿æ¢æ—§çš„çš„ AOF æ–‡ä»¶ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨äº†æ··åˆæŒä¹…åŒ–ï¼ŒAOF æ–‡ä»¶çš„å‰åŠéƒ¨åˆ†æ˜¯ RDB æ ¼å¼çš„å…¨é‡æ•°æ®ï¼ŒååŠéƒ¨åˆ†æ˜¯ AOF æ ¼å¼çš„å¢é‡æ•°æ®ã€‚</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1684770620104-4c8fc4d7-0964-4354-9ccf-ec35e2064483.jpeg" alt="img"></p><p>è¿™æ ·çš„å¥½å¤„åœ¨äºï¼Œé‡å¯ Redis åŠ è½½æ•°æ®çš„æ—¶å€™ï¼Œç”±äºå‰åŠéƒ¨åˆ†æ˜¯ RDB å†…å®¹ï¼Œè¿™æ ·åŠ è½½çš„æ—¶å€™é€Ÿåº¦ä¼šå¾ˆå¿«ã€‚</p><p>åŠ è½½å®Œ RDB çš„å†…å®¹åï¼Œæ‰ä¼šåŠ è½½ååŠéƒ¨åˆ†çš„ AOF å†…å®¹ï¼Œè¿™é‡Œçš„å†…å®¹æ˜¯ Redis åå°å­è¿›ç¨‹é‡å†™ AOF æœŸé—´ï¼Œä¸»çº¿ç¨‹å¤„ç†çš„æ“ä½œå‘½ä»¤ï¼Œå¯ä»¥ä½¿å¾—æ•°æ®æ›´å°‘çš„ä¸¢å¤±ã€‚</p><p>æ··åˆæŒä¹…åŒ–ä¼˜ç‚¹ï¼š</p><p>æ··åˆæŒä¹…åŒ–ç»“åˆäº† RDB å’Œ AOF æŒä¹…åŒ–çš„ä¼˜ç‚¹ï¼Œå¼€å¤´ä¸º RDB çš„æ ¼å¼ï¼Œä½¿å¾— Redis å¯ä»¥æ›´å¿«çš„å¯åŠ¨ï¼ŒåŒæ—¶ç»“åˆ AOF çš„ä¼˜ç‚¹ï¼Œæœ‰å‡ä½äº†å¤§é‡æ•°æ®ä¸¢å¤±çš„é£é™©ã€‚</p><p>æ··åˆæŒä¹…åŒ–ç¼ºç‚¹ï¼š</p><p>AOF æ–‡ä»¶ä¸­æ·»åŠ äº† RDB æ ¼å¼çš„å†…å®¹ï¼Œä½¿å¾— AOF æ–‡ä»¶çš„å¯è¯»æ€§å˜å¾—å¾ˆå·®ï¼›</p><p>å…¼å®¹æ€§å·®ï¼Œå¦‚æœå¼€å¯æ··åˆæŒä¹…åŒ–ï¼Œé‚£ä¹ˆæ­¤æ··åˆæŒä¹…åŒ– AOF æ–‡ä»¶ï¼Œå°±ä¸èƒ½ç”¨åœ¨ Redis 4.0 ä¹‹å‰ç‰ˆæœ¬äº†ã€‚</p><h3 id="5-4-ç®¡é“"><a href="#5-4-ç®¡é“" class="headerlink" title="5.4 ç®¡é“"></a>5.4 ç®¡é“</h3><p>Redis ç®¡é“å¹¶ä¸æ˜¯ Redis æœåŠ¡å™¨ç›´æ¥æä¾›çš„æŠ€æœ¯ï¼Œè¿™ä¸ªæŠ€æœ¯å®é™…æ˜¯ç”±å®¢æˆ·ç«¯æä¾›çš„ï¼Œè·ŸæœåŠ¡å™¨æ²¡æœ‰æœ¬è´¨å…³ç³»ã€‚</p><p><strong>Redis çš„æ¶ˆæ¯äº¤äº’ï¼š</strong></p><p>å½“æˆ‘ä»¬ä½¿ç”¨å®¢æˆ·ç«¯å¯¹ Redis è¿›è¡Œä¸€æ¬¡æ“ä½œæ—¶ã€‚å®¢æˆ·ç«¯å°†è¯·æ±‚ä¼ é€ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨å¤„ç†å®Œæˆåï¼Œå†å°†å“åº”å›å¤ç»™å®¢æˆ·ç«¯ã€è¿™å°±éœ€è¦èŠ±è´¹ä¸€ä¸ªç½‘ç»œæ•°æ®åŒ…æ¥å›çš„æ—¶é—´ã€‚</p><p>å¦‚æœè¿ç»­æ‰§è¡Œå¤šæ¡æŒ‡ä»¤ï¼Œé‚£å°±ä¼šèŠ±è´¹å¤šä¸ªç½‘ç»œæ•°æ®åŒ…æ¥å›çš„æ—¶é—´ã€‚ä»å®¢æˆ·ç«¯å±‚é¢ä¸Šæ¥çœ‹ï¼Œå®¢æˆ·ç«¯æ—¶ç»å†äº† å‘é€è¯·æ±‚1-æ¥å—å“åº”1-å‘é€è¯·æ±‚2-æ¥å—å“åº”2â€” è¿™æ ·ã€‚é‚£ä¹ˆæˆ‘ä»¬å®é™…ä¸Šå¯ä»¥è°ƒæ•´ä¸€ä¸‹ï¼Œå¤šä¸ªæŒ‡ä»¤è¯·æ±‚çš„è¯·æ±‚å“åº”é¡ºåºã€‚å³ å‘é€è¯·æ±‚1-å‘é€è¯·æ±‚2-æ¥å—è¯·æ±‚1-æ¥å—è¯·æ±‚2ã€‚è¿™è¿™æ ·ä¸¤ä¸ªè¿ç»­çš„å‘é€è¯·æ±‚æ“ä½œå’Œä¸¤ä¸ªè¿ç»­çš„ç­‰å¾…è¯·æ±‚å“åº”æ“ä½œ æ€»å…±åªä¼šèŠ±è´¹ä¸€æ¬¡ç½‘ç»œæ¥å›ã€‚</p><p>è¿™ä¾¿æ˜¯ç®¡é“æ“ä½œçš„æœ¬è´¨ï¼ŒæœåŠ¡å™¨æ ¹æœ¬æ²¡æœ‰åŒºåˆ«å¯¹å¾…ï¼Œè¿˜æ˜¯æ”¶åˆ°ä¸€æ¡æ¶ˆæ¯ï¼Œæ‰§è¡Œä¸€æ¡æ¶ˆæ¯ï¼Œå›å¤ä¸€æ¡æ¶ˆæ¯çš„æ­£å¸¸æµç¨‹ã€‚å®¢æˆ·ç«¯é€šè¿‡å¯¹ç®¡é“ä¸­æŒ‡ä»¤åˆ—è¡¨æ”¹å˜æ“ä½œé¡ºåºå°±å¯ä»¥å¤§å¹…èŠ‚çœ IO æ—¶é—´ã€‚ç®¡é“ä¸­çš„æŒ‡ä»¤è¶Šå¤šï¼Œæ•ˆæœè¶Šå¥½ã€‚</p><h5 id="ç®¡é“å‹åŠ›æµ‹è¯•"><a href="#ç®¡é“å‹åŠ›æµ‹è¯•" class="headerlink" title="ç®¡é“å‹åŠ›æµ‹è¯•"></a>ç®¡é“å‹åŠ›æµ‹è¯•</h5><p>Redis è‡ªå¸¦äº†ä¸€ä¸ªå‹åŠ›æµ‹è¯•å·¥å…· redis-benchmarkï¼Œä½¿ç”¨è¿™ä¸ªå·¥å…·å°±å¯ä»¥è¿›è¡Œç®¡é“æµ‹è¯•ã€‚é¦–å…ˆæˆ‘ä»¬å¯¹ä¸€ä¸ªæ™®é€šçš„ set æŒ‡ä»¤è¿›è¡Œå‹æµ‹ï¼ŒQPSå¤§çº¦ 2.5w&#x2F;sã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@b7ba9713c11c:/data# redis-benchmark -t set -q</span><br><span class="line">SET: 24319.07 requests per second, p50=0.959 msec</span><br></pre></td></tr></table></figure><p>åŠ å…¥ç®¡é“é€‰é¡¹ -P å‚æ•°ï¼Œå®ƒè¡¨ç¤ºå•ä¸ªç®¡é“å†…å¹¶è¡Œçš„è¯·æ±‚æ•°é‡ï¼Œçœ‹ä¸‹é¢ P&#x3D;2æ—¶ï¼ŒQPSå°±å¯ä»¥è¾¾åˆ° 5w&#x2F;s</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@b7ba9713c11c:/data# redis-benchmark -t set -q -P 2</span><br><span class="line">SET: 50200.80 requests per second, p50=0.943 msec   </span><br><span class="line">root@b7ba9713c11c:/data# redis-benchmark -t set -q -P 40</span><br><span class="line">SET: 175131.36 requests per second, p50=10.391 msec </span><br><span class="line">root@b7ba9713c11c:/data# redis-benchmark -t set -q -P 100</span><br><span class="line">SET: 182149.36 requests per second, p50=26.671 msec</span><br></pre></td></tr></table></figure><p>å‘ç°åˆ°åé¢æé«˜ P å‚æ•°ï¼Œå·²ç»æ— æ³•æé«˜ QPSäº†ï¼Œè¿™ä¸€èˆ¬éƒ½æ˜¯å› ä¸º CPU å¤„ç†èƒ½åŠ›å·²ç»è¾¾åˆ°äº†ç“¶é¢ˆã€‚</p><h5 id="ç®¡é“æœ¬è´¨"><a href="#ç®¡é“æœ¬è´¨" class="headerlink" title="ç®¡é“æœ¬è´¨"></a>ç®¡é“æœ¬è´¨</h5><p>ä¸‹é¢å°±ä»‹ç»ä¸€ä¸‹ä¸€ä¸ªè¯·æ±‚çš„äº¤äº’æµç¨‹ï¼š</p><ol><li>å®¢æˆ·ç«¯è¿›è¡Œè°ƒç”¨ write å°†æ¶ˆæ¯å†™åˆ° æ“ä½œç³»ç»Ÿå†…æ ¸ ä¸ºå¥—æ¥å­—åˆ†é…çš„ å‘é€ç¼“å†² sendbuffer</li><li>å®¢æˆ·ç«¯æ“ä½œç³»ç»Ÿå†…æ ¸å°† å‘é€ç¼“å†²çš„å†…å®¹ å‘é€åˆ°ç½‘å¡ï¼Œç½‘å¡ç¡¬ä»¶å°†æ•°æ®é€šè¿‡ ç½‘é™…è·¯ç”± é€åˆ°æœåŠ¡å™¨ç½‘å¡ã€‚</li><li>æœåŠ¡å™¨æ“ä½œç³»ç»Ÿå†…æ ¸å°† ç½‘å¡çš„æ•°æ® æ”¾åˆ°å†…æ ¸ä¸ºå¥—æ¥å­—åˆ†é…çš„æ¥å—ç¼“å†² recv bufferã€‚</li><li>æœåŠ¡å™¨è¿›ç¨‹è°ƒç”¨ read ä»æ¥å—ç¼“å†²åŒºä¸­ å–å‡ºæ¶ˆæ¯è¿›è¡Œå¤„ç†ã€‚</li><li>æœåŠ¡å™¨è¿›ç¨‹è°ƒç”¨ write å°†å“åº”æ¶ˆæ¯å†™åˆ° å†…æ ¸ä¸ºå¥—æ¥å­—åˆ†é…çš„å‘é€ç¼“å†² send bufferã€‚</li><li>æœåŠ¡å™¨æ“ä½œç³»ç»Ÿå†…æ ¸ å°†å‘é€ç¼“å†²çš„å†…å®¹ å‘é€åˆ°ç½‘å¡ï¼Œç½‘å¡ç¡¬ä»¶å°†æ•°æ®é€šè¿‡ ç½‘é™…è·¯ç”± å‘é€åˆ°å®¢æˆ·ç«¯çš„ç½‘å¡ã€‚</li><li>å®¢æˆ·ç«¯æ“ä½œç³»ç»Ÿå†…æ ¸ å°†ç½‘å¡çš„æ•°æ® æ”¾åˆ°å†…æ ¸ä¸ºå¥—æ¥å­—åˆ†é…çš„ æ¥å—ç¼“å†² recv buffer</li><li>å®¢æˆ·ç«¯è¿›ç¨‹è°ƒç”¨ read ä»æ¥æ”¶ç¼“å†²åŒºä¸­ å–å‡ºæ¶ˆæ¯ è¿”å›ç»™ä¸Šå±‚ä¸šåŠ¡é€»è¾‘ è¿›è¡Œå¤„ç†ã€‚</li></ol><p>æˆ‘ä»¬ä¸€å¼€å§‹å¯èƒ½ä»¥ä¸º write æ“ä½œè¦ç­‰åˆ°å¯¹æ–¹æ”¶åˆ°æ¶ˆæ¯æ‰è¿”å›ï¼Œä½†å®é™…ä¸Šä¸æ˜¯è¿™æ ·çš„ã€‚write æ“ä½œåªè´Ÿè´£ å°†æ•°æ®å†™åˆ°æœ¬åœ°æ“ä½œç³»ç»Ÿå†…æ ¸çš„ å‘é€ç¼“å†²åŒºç„¶åå°±è¿”å›äº†ã€‚å‰©ä¸‹çš„äº‹ äº¤ç»™æ“ä½œç³»ç»Ÿå†…æ ¸å¼‚æ­¥ å°†æ•°æ®é€åˆ°ç›®æ ‡æœºå™¨ã€‚ä½†æ˜¯å¦‚æœå‘é€ç¼“å†²åŒºæ»¡äº†ï¼Œé‚£ä¹ˆå°±éœ€è¦ç­‰å¾… ç¼“å†²åŒº ç©ºå‡ºï¼Œè¿™ä¸ªå°±æ˜¯ å†™æ“ä½œ IO æ“ä½œçš„çœŸæ­£è€—æ—¶ã€‚</p><p>åŒç†ï¼Œread æ“ä½œå¹¶ä¸æ˜¯ä»ç›®æ ‡æœºå™¨æ‹‰å–æ•°æ®ã€‚read æ“ä½œåªè´Ÿè´£å°† æ•°æ®ä»æœ¬åœ°æ“ä½œç³»ç»Ÿå†…æ ¸çš„ æ¥æ”¶ç¼“å†²åŒº å–å‡ºæ¥å°±äº†äº‹ã€‚ä½†æ˜¯å¦‚æœ ç¼“å†²åŒºæ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆå°±éœ€è¦ç­‰å¾…æ•°æ®åˆ°æ¥ï¼Œè¿™ä¸ªå°±æ˜¯ è¯»æ“ä½œ IO æ“ä½œçš„çœŸæ­£è€—æ—¶ã€‚</p><p>æ‰€ä»¥å¯¹äº å®¢æˆ·ç«¯çš„ redis.get(key) è¿™æ ·çš„å‘½ä»¤æ¥è¯´ï¼Œwrite æ“ä½œå‡ ä¹æ²¡æœ‰è€—æ—¶ï¼Œç›´æ¥å†™åˆ° å‘é€ç¼“å†²åŒºå°±è¿”å›ï¼Œè€Œ read æ“ä½œæ¯”è¾ƒè€—æ—¶äº†ï¼Œå› ä¸ºå®ƒè¦ç­‰å¾…æ¶ˆæ¯ç»è¿‡ç½‘ç»œè·¯ç”±åˆ°ç›®æ ‡æœºå™¨å¤„ç†åçš„å“åº”æ¶ˆæ¯ï¼Œå†å‘é€åˆ°å½“å‰å†…æ ¸è¯»ç¼“å†² æ‰å¯ä»¥è¿”å›ã€‚è¿™æ‰æ˜¯ä¸€ä¸ªç½‘ç»œæ¥å›çš„çœŸæ­£å¼€é”€ã€‚</p><p>è€Œå¯¹äºç®¡é“æ¥è¯´ï¼Œè¿ç»­çš„ write æ“ä½œæ ¹æœ¬å°±æ²¡æœ‰è€—æ—¶ï¼Œä¹‹åç¬¬ä¸€ä¸ª read æ“ä½œä¼šç­‰å¾… ä¸€ä¸ªç½‘ç»œçš„æ¥å›å¼€é”€ï¼Œç„¶åå“åº”ä¿¡æ¯åˆ°è¾¾ å®¢æˆ·ç«¯ç³»ç»Ÿå†…æ ¸çš„è¯»ç¼“å†²äº†ã€‚å› ä¸º write æ˜¯è¿ç»­å‘é€ï¼Œä¸”å‡ ä¹æ²¡æœ‰è€—æ—¶ï¼Œæ‰€ä»¥å½“ ç¬¬ä¸€ä¸ªreadä¹‹åï¼Œåç»­æ‰€æœ‰readåŸºæœ¬ä¹ŸåŒæ—¶éšä¹‹åˆ°è¾¾ è¯»ç¼“å†²ã€‚</p><h3 id="5-5-äº‹åŠ¡"><a href="#5-5-äº‹åŠ¡" class="headerlink" title="5.5 äº‹åŠ¡"></a>5.5 äº‹åŠ¡</h3><p>Redis é€šè¿‡ MULTIã€DISCARD ã€EXEC å’Œ WATCH å››ä¸ªå‘½ä»¤æ¥å®ç°äº‹åŠ¡åŠŸèƒ½ã€‚äº‹åŠ¡æä¾›äº†ä¸€ç§ â€œå°†å¤šä¸ªå‘½ä»¤æ‰“åŒ…ï¼Œç„¶åä¸€æ¬¡æ€§ã€æŒ‰é¡ºåºåœ°æ‰§è¡Œâ€çš„æœºåˆ¶ï¼Œå¹¶ä¸”äº‹åŠ¡åœ¨æ‰§è¡Œçš„æœŸé—´ä¸ä¼šä¸»åŠ¨ä¸­æ–­â€”â€”æœåŠ¡å™¨åœ¨æ‰§è¡Œå®Œäº‹åŠ¡ä¸­çš„æ‰€æœ‰å‘½ä»¤ä¹‹åï¼Œæ‰ä¼šç»§ç»­å¤„ç†å…¶ä»–å®¢æˆ·ç«¯çš„å‘½ä»¤ã€‚</p><p>ä¾‹å­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; MULTI</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379(TX)&gt; set name &quot;kxr&quot;</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; get name</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; sadd name-list &quot;kxr&quot; &quot;jyl&quot;</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; smembers name-list</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; exec</span><br><span class="line">1) OK</span><br><span class="line">2) &quot;kxr&quot;</span><br><span class="line">3) (integer) 2</span><br><span class="line">4) 1) &quot;jyl&quot;</span><br><span class="line">   2) &quot;kxr&quot;</span><br></pre></td></tr></table></figure><h4 id="5-5-1-äº‹åŠ¡æµç¨‹"><a href="#5-5-1-äº‹åŠ¡æµç¨‹" class="headerlink" title="5.5.1 äº‹åŠ¡æµç¨‹"></a>5.5.1 äº‹åŠ¡æµç¨‹</h4><p>ä¸€ä¸ªäº‹åŠ¡ä»å¼€å§‹åˆ°æ‰§è¡Œä¼šç»å†ä¸‰ä¸ªé˜¶æ®µï¼š</p><ol><li>å¼€å§‹äº‹åŠ¡</li><li>å‘½ä»¤å…¥é˜Ÿ</li><li>æ‰§è¡Œäº‹åŠ¡</li></ol><h5 id="å¼€å§‹äº‹åŠ¡"><a href="#å¼€å§‹äº‹åŠ¡" class="headerlink" title="å¼€å§‹äº‹åŠ¡"></a>å¼€å§‹äº‹åŠ¡</h5><p>MULTI å‘½ä»¤çš„æ‰§è¡Œ æ ‡è®°ç€äº‹åŠ¡çš„å¼€å§‹ã€‚è¿™ä¸ªå‘½ä»¤å”¯ä¸€åšçš„å°±æ˜¯ï¼Œå°†å®¢æˆ·ç«¯çš„ REDIS_MULTI é€‰é¡¹æ‰“å¼€ï¼Œè®©å®¢æˆ·ç«¯ä»éäº‹åŠ¡çŠ¶æ€åˆ‡æ¢åˆ°äº‹åŠ¡çŠ¶æ€ã€‚</p><h5 id="å‘½ä»¤å…¥é˜Ÿ"><a href="#å‘½ä»¤å…¥é˜Ÿ" class="headerlink" title="å‘½ä»¤å…¥é˜Ÿ"></a>å‘½ä»¤å…¥é˜Ÿ</h5><p>å½“å®¢æˆ·ç«¯å¤„äºéäº‹åŠ¡çŠ¶æ€ä¸‹æ—¶ï¼Œæ‰€æœ‰å‘é€ç»™æœåŠ¡ç«¯çš„å‘½ä»¤éƒ½ä¼šç«‹å³è¢«æœåŠ¡å™¨æ‰§è¡Œã€‚ä½†æ˜¯ï¼Œå½“å®¢æˆ·ç«¯è¿›å…¥äº‹åŠ¡çŠ¶æ€ä¹‹åï¼ŒæœåŠ¡å™¨åœ¨æ”¶åˆ°æ¥è‡ªå®¢æˆ·ç«¯çš„å‘½ä»¤æ—¶ï¼Œä¸ä¼šç«‹å³æ‰§è¡Œå‘½ä»¤ï¼Œè€Œæ˜¯å°†è¿™äº›å‘½ä»¤å…¨éƒ¨æ”¾è¿›ä¸€ä¸ªäº‹åŠ¡é˜Ÿåˆ—é‡Œï¼Œç„¶åè¿”å› QUEUEDï¼Œè¡¨ç¤ºå‘½ä»¤å·²å…¥é˜Ÿã€‚</p><p>äº‹åŠ¡é˜Ÿåˆ—æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªæ•°ç»„é¡¹æ˜¯éƒ½åŒ…å«ä¸‰ä¸ªå±æ€§ï¼š</p><ol><li>è¦æ‰§è¡Œçš„å‘½ä»¤ï¼ˆcmdï¼‰</li><li>å‘½ä»¤çš„å‚æ•°ï¼ˆargvï¼‰</li><li>å‚æ•°çš„ä¸ªæ•°ï¼ˆargcï¼‰</li></ol><h5 id="æ‰§è¡Œäº‹åŠ¡"><a href="#æ‰§è¡Œäº‹åŠ¡" class="headerlink" title="æ‰§è¡Œäº‹åŠ¡"></a>æ‰§è¡Œäº‹åŠ¡</h5><p>å‰é¢è¯´åˆ°ï¼Œå½“å®¢æˆ·ç«¯è¿›å…¥äº‹åŠ¡çŠ¶æ€ä¹‹åï¼Œå®¢æˆ·å‘é€çš„å‘½ä»¤å°±ä¼šè¢«æ”¾è¿›äº‹åŠ¡é˜Ÿåˆ—é‡Œã€‚</p><p>ä½†å…¶å®å¹¶ä¸æ˜¯æ‰€æœ‰çš„å‘½ä»¤éƒ½ä¼šè¢«æ”¾è¿›äº‹åŠ¡é˜Ÿåˆ—ï¼Œå…¶ä¸­çš„ä¾‹å¤–å°±æ˜¯ EXECã€DISCARDã€MULTI å’Œ WATCH è¿™å››ä¸ªå‘½ä»¤ â€”â€” å½“è¿™å››ä¸ªå‘½ä»¤ä»å®¢æˆ·ç«¯å‘é€åˆ°æœåŠ¡å™¨æ—¶ï¼Œå®ƒä»¬ä¼šåƒå®¢æˆ·ç«¯å¤„äºéäº‹åŠ¡çŠ¶æ€ä¸€æ ·ï¼Œç›´æ¥è¢«æœåŠ¡å™¨æ‰§è¡Œã€‚</p><p>å¦‚æœå®¢æˆ·ç«¯æ­£å¤„äºäº‹åŠ¡çŠ¶æ€ï¼Œé‚£ä¹ˆå½“ EXEC å‘½ä»¤æ‰§è¡Œæ—¶ï¼ŒæœåŠ¡å™¨æ ¹æ®å®¢æˆ·ç«¯æ‰€ä¿å­˜çš„äº‹åŠ¡é˜Ÿåˆ—ï¼Œä»¥å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„æ–¹å¼æ‰§è¡Œäº‹åŠ¡é˜Ÿåˆ—ä¸­çš„å‘½ä»¤ï¼š æœ€å…ˆå…¥é˜Ÿçš„å‘½ä»¤æœ€å…ˆæ‰§è¡Œï¼Œè€Œæœ€åå…¥é˜Ÿçš„å‘½ä»¤æœ€åæ‰§è¡Œã€‚</p><p>å½“äº‹åŠ¡é˜Ÿåˆ—é‡Œçš„ æ‰€æœ‰å‘½ä»¤è¢«æ‰§è¡Œå®Œä¹‹åï¼ŒEXEC å‘½ä»¤ä¼šå°†å›å¤é˜Ÿåˆ—ä½œä¸ºè‡ªå·±çš„æ‰§è¡Œç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯ä»äº‹åŠ¡çŠ¶æ€è¿”å›åˆ°éäº‹åŠ¡çŠ¶æ€ï¼Œè‡³æ­¤ï¼Œäº‹åŠ¡æ‰§è¡Œå®Œæ¯•ã€‚</p><p>äº‹åŠ¡çš„æ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹çš„ä¼ªä»£ç è¡¨ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">def <span class="title function_">execute_transaction</span><span class="params">()</span>:</span><br><span class="line"></span><br><span class="line">    # åˆ›å»ºç©ºç™½çš„å›å¤é˜Ÿåˆ—</span><br><span class="line">    reply_queue = []</span><br><span class="line"></span><br><span class="line">    # å–å‡ºäº‹åŠ¡é˜Ÿåˆ—é‡Œçš„æ‰€æœ‰å‘½ä»¤ã€å‚æ•°å’Œå‚æ•°æ•°é‡</span><br><span class="line">    <span class="keyword">for</span> cmd, argv, argc in client.transaction_queue:</span><br><span class="line"></span><br><span class="line">        # æ‰§è¡Œå‘½ä»¤ï¼Œå¹¶å–å¾—å‘½ä»¤çš„è¿”å›å€¼</span><br><span class="line">        reply = execute_redis_command(cmd, argv, argc)</span><br><span class="line"></span><br><span class="line">    # å°†è¿”å›å€¼è¿½åŠ åˆ°å›å¤é˜Ÿåˆ—æœ«å°¾</span><br><span class="line">    reply_queue.append(reply)</span><br><span class="line"></span><br><span class="line">    # æ¸…é™¤å®¢æˆ·ç«¯çš„äº‹åŠ¡çŠ¶æ€</span><br><span class="line">    clear_transaction_state(client)</span><br><span class="line"></span><br><span class="line">    # æ¸…ç©ºäº‹åŠ¡é˜Ÿåˆ—</span><br><span class="line">    clear_transaction_queue(client)</span><br><span class="line"></span><br><span class="line">    # å°†äº‹åŠ¡çš„æ‰§è¡Œç»“æœè¿”å›ç»™å®¢æˆ·ç«¯</span><br><span class="line">    send_reply_to_client(client, reply_queue)</span><br></pre></td></tr></table></figure><p>ä¼˜åŒ–ï¼šä¸Šé¢çš„ Redis äº‹åŠ¡åœ¨å‘é€æ¯ä¸ªæŒ‡ä»¤åˆ°äº‹åŠ¡ç¼“å­˜é˜Ÿåˆ—æ—¶éƒ½è¦ç»è¿‡ä¸€æ¬¡ç½‘ç»œè¯»å†™ï¼Œå½“ä¸€ä¸ªäº‹åŠ¡å†…éƒ¨çš„æŒ‡ä»¤è¾ƒå¤šæ—¶ï¼Œéœ€è¦çš„ç½‘ç»œ IO æ—¶é—´ä¹Ÿä¼šçº¿æ€§å¢é•¿ã€‚æ‰€ä»¥é€šå¸¸ Redis å®¢æˆ·ç«¯åœ¨æ‰§è¡Œäº‹åŠ¡æ—¶éƒ½ä¼šç»“åˆ pipline ä¸€èµ·ä½¿ç”¨ï¼Œè¿™æ ·å¯ä»¥å°†å¤šæ¬¡ IO æ“ä½œå‹ç¼©ä¸ºå•æ¬¡ IO æ“ä½œã€‚</p><h4 id="5-5-2-äº‹åŠ¡é‡Œçš„å‘½ä»¤"><a href="#5-5-2-äº‹åŠ¡é‡Œçš„å‘½ä»¤" class="headerlink" title="5.5.2 äº‹åŠ¡é‡Œçš„å‘½ä»¤"></a>5.5.2 äº‹åŠ¡é‡Œçš„å‘½ä»¤</h4><p>æ— è®ºæ˜¯åœ¨äº‹åŠ¡çŠ¶æ€ä¸‹ï¼Œè¿˜æ˜¯éäº‹åŠ¡çŠ¶æ€ä¸‹ï¼ŒRedis å‘½ä»¤éƒ½æ˜¯ç”±åŒä¸€ä¸ªå‡½æ•°æ‰§è¡Œï¼Œæ‰€æœ‰å®ƒä»¬å…±äº«å¾ˆå¤šæœåŠ¡å™¨çš„ä¸€èˆ¬è®¾ç½®ï¼Œæ¯”å¦‚ AOF é…ç½®ã€RDB çš„é…ç½®ï¼Œä»¥åŠå†…å­˜é™åˆ¶ç­‰ç­‰ã€‚</p><p>äº‹åŠ¡ä¸­çš„å‘½ä»¤æ‰§è¡Œå’Œæ™®é€šå‘½ä»¤æ‰§è¡Œä¸»è¦æ˜¯ä¸¤å¤©åŒºåˆ«ï¼š</p><ol><li>éäº‹åŠ¡çŠ¶æ€ä¸‹çš„å‘½ä»¤ä»¥å•ä¸ªå‘½ä»¤æ‰§è¡Œä¸ºå•ä½ï¼Œå‰ä¸€ä¸ªå‘½ä»¤å’Œåä¸€ä¸ªå‘½ä»¤ä¸ä¸€å®šæ˜¯åŒä¸€ä¸ªå®¢æˆ·ç«¯ã€‚è€Œäº‹åŠ¡çŠ¶æ€åˆ™æ˜¯ä»¥ä¸€ä¸ªäº‹åŠ¡ä¸ºå•ä½ï¼Œæ‰§è¡Œäº‹åŠ¡é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å‘½ä»¤ï¼šé™¤éå½“å‰äº‹åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œå¦åˆ™æœåŠ¡å™¨ä¸ä¼šä¸­æ–­äº‹åŠ¡ï¼Œä¹Ÿä¸ä¼šæ‰§è¡Œå…¶ä»–å®¢æˆ·ç«¯çš„å‘½ä»¤ã€‚</li><li>åœ¨éäº‹åŠ¡çŠ¶æ€ä¸‹ï¼Œæ‰§è¡Œå‘½ä»¤æ‰€å¾—çš„ç»“æœä¼šç«‹å³è¢«è¿”å›ç»™å®¢æˆ·ç«¯ã€‚è€Œäº‹åŠ¡åˆ™å°†æ‰€æœ‰å‘½ä»¤æ‰€å¾—è¿”å›ç»“æœé›†åˆåˆ°å›å¤é˜Ÿåˆ—ï¼Œå†ä½œä¸º EXEC å‘½ä»¤çš„ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚</li></ol><h4 id="5-5-3-DISCARD-ã€-MULTI-å’Œ-WATCH-å‘½ä»¤"><a href="#5-5-3-DISCARD-ã€-MULTI-å’Œ-WATCH-å‘½ä»¤" class="headerlink" title="5.5.3 DISCARD ã€ MULTI å’Œ WATCH å‘½ä»¤"></a>5.5.3 DISCARD ã€ MULTI å’Œ WATCH å‘½ä»¤</h4><p>é™¤äº† EXEC ä¹‹å¤–ï¼ŒæœåŠ¡å™¨åœ¨å®¢æˆ·ç«¯å¤„äºäº‹åŠ¡çŠ¶æ€ä¸‹ï¼Œä¸åŠ å…¥åˆ°äº‹åŠ¡é˜Ÿåˆ—è€Œæ‰§è¡Œçš„å¦å¤–ä¸‰ä¸ªå‘½ä»¤æ˜¯ï¼šDISCARD ã€ MULTI å’Œ WATCH</p><ul><li>DISCARDï¼šå‘½ä»¤ç”¨äºå–æ¶ˆä¸€ä¸ªäº‹åŠ¡ï¼Œ å®ƒæ¸…ç©ºå®¢æˆ·ç«¯çš„æ•´ä¸ªäº‹åŠ¡é˜Ÿåˆ—ï¼Œ ç„¶åå°†å®¢æˆ·ç«¯ä»äº‹åŠ¡çŠ¶æ€è°ƒæ•´å›éäº‹åŠ¡çŠ¶æ€ï¼Œ æœ€åè¿”å›å­—ç¬¦ä¸² OK ç»™å®¢æˆ·ç«¯ï¼Œ è¯´æ˜äº‹åŠ¡å·²è¢«å–æ¶ˆã€‚</li><li>MULTIï¼šRedis çš„äº‹åŠ¡æ˜¯ä¸å¯åµŒå¥—çš„ï¼Œ å½“å®¢æˆ·ç«¯å·²ç»å¤„äºäº‹åŠ¡çŠ¶æ€ï¼Œ è€Œå®¢æˆ·ç«¯åˆå†å‘æœåŠ¡å™¨å‘é€ <a href="http://redis.readthedocs.org/en/latest/transaction/multi.html#multi">MULTI</a> æ—¶ï¼Œ æœåŠ¡å™¨åªæ˜¯ç®€å•åœ°å‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªé”™è¯¯ï¼Œ ç„¶åç»§ç»­ç­‰å¾…å…¶ä»–å‘½ä»¤çš„å…¥é˜Ÿã€‚ <a href="http://redis.readthedocs.org/en/latest/transaction/multi.html#multi">MULTI</a> å‘½ä»¤çš„å‘é€ä¸ä¼šé€ æˆæ•´ä¸ªäº‹åŠ¡å¤±è´¥ï¼Œ ä¹Ÿä¸ä¼šä¿®æ”¹äº‹åŠ¡é˜Ÿåˆ—ä¸­å·²æœ‰çš„æ•°æ®ã€‚</li><li>WATCHï¼šåªèƒ½åœ¨å®¢æˆ·ç«¯è¿›å…¥äº‹åŠ¡çŠ¶æ€ä¹‹å‰æ‰§è¡Œï¼Œ åœ¨äº‹åŠ¡çŠ¶æ€ä¸‹å‘é€ WATCH å‘½ä»¤ä¼šå¼•å‘ä¸€ä¸ªé”™è¯¯ï¼Œ ä½†å®ƒä¸ä¼šé€ æˆæ•´ä¸ªäº‹åŠ¡å¤±è´¥ï¼Œ ä¹Ÿä¸ä¼šä¿®æ”¹äº‹åŠ¡é˜Ÿåˆ—ä¸­å·²æœ‰çš„æ•°æ®ï¼ˆå’Œå‰é¢å¤„ç† MULTI çš„æƒ…å†µä¸€æ ·ï¼‰</li></ul><h4 id="5-5-4-å¸¦-WATCH-çš„äº‹åŠ¡"><a href="#5-5-4-å¸¦-WATCH-çš„äº‹åŠ¡" class="headerlink" title="5.5.4 å¸¦ WATCH çš„äº‹åŠ¡"></a>5.5.4 å¸¦ WATCH çš„äº‹åŠ¡</h4><p>WATCH å‘½ä»¤ç”¨äºåœ¨äº‹åŠ¡å¼€å§‹ä¹‹å‰ç›‘è§†ä»»æ„æ•°é‡çš„é”®ï¼š å½“è°ƒç”¨ EXEC å‘½ä»¤æ‰§è¡Œäº‹åŠ¡æ—¶ï¼Œ å¦‚æœä»»æ„ä¸€ä¸ªè¢«ç›‘è§†çš„é”®å·²ç»è¢«å…¶ä»–å®¢æˆ·ç«¯ä¿®æ”¹äº†ï¼Œ é‚£ä¹ˆæ•´ä¸ªäº‹åŠ¡ä¸å†æ‰§è¡Œï¼Œ ç›´æ¥è¿”å›å¤±è´¥ã€‚</p><p>ä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºäº†ä¸€ä¸ªæ‰§è¡Œå¤±è´¥çš„äº‹åŠ¡ä¾‹å­ï¼š</p><p>ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯æ‰§è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; watch name</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379(TX)&gt; set name t</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; exec</span><br><span class="line">(nil)</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒä¸ªå®¢æˆ·ç«¯æ‰§è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set name tt</span><br><span class="line">OK</span><br></pre></td></tr></table></figure><p>åœ¨ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯watch name ä¹‹åï¼Œäº‹åŠ¡æ‰§è¡Œä¹‹å‰ï¼Œåœ¨ç¬¬äºŒä¸ªå®¢æˆ·ç«¯ä¸­ ä¿®æ”¹ name çš„å€¼ã€‚è¿™æ ·å½“ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯çš„æ‰§è¡Œäº‹åŠ¡æ—¶ï¼ŒRedis ä¼šå‘ç° name æ•´ä¸ªè¢«ç›‘è§†çš„é”® å·²ç»è¢«ä¿®æ”¹ï¼Œå› æ­¤å®¢æˆ·ç«¯Açš„äº‹åŠ¡ä¸ä¼šè¢«æ‰§è¡Œï¼Œè€Œæ˜¯ç›´æ¥è¿”å›å¤±è´¥ã€‚</p><h5 id="WATCH-å‘½ä»¤çš„å®ç°"><a href="#WATCH-å‘½ä»¤çš„å®ç°" class="headerlink" title="WATCH å‘½ä»¤çš„å®ç°"></a>WATCH å‘½ä»¤çš„å®ç°</h5><p>åœ¨æ¯ä¸ªä»£è¡¨æ•°æ®çš„ redis.h&#x2F;redisDb ç»“æ„ç±»å‹ä¸­ï¼Œéƒ½ä¿å­˜äº†ä¸€ä¸ª watched_keys å­—å…¸ï¼Œå­—å…¸çš„é”®è¿™ä¸ªæ•°æ®åº“è¢«ç›‘è§†çš„é”®ï¼Œè€Œå­—å…¸çš„å€¼åˆ™æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œé“¾è¡¨ä¸­ä¿å­˜äº†æ‰€æœ‰ç›‘è§†è¿™ä¸ªé”®çš„å®¢æˆ·ç«¯ã€‚</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779123785-9effddfb-dddd-4212-917f-061e49039521.svg" alt="img"></p><p>å…¶ä¸­ï¼Œé”® key1 æ­£åœ¨è¢« client2ã€client5 å’Œ client1 ä¸‰ä¸ªå®¢æˆ·ç«¯ç›‘è§†ï¼Œå…¶ä»–ä¸€äº›é”®ä¹Ÿåˆ†åˆ«è¢«å…¶ä»–å®¢æˆ·ç«¯ç›‘è§†ç€ã€‚</p><p>WATCH å‘½ä»¤çš„ä½œç”¨ï¼Œå°±æ˜¯å°† å½“å‰å®¢æˆ·ç«¯å’Œè¦ç›‘è§†çš„é”®åœ¨ watched_keys ä¸­è¿›è¡Œå…³è”ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œ å¦‚æœå½“å‰å®¢æˆ·ç«¯ä¸º client10086 ï¼Œ é‚£ä¹ˆå½“å®¢æˆ·ç«¯æ‰§è¡Œ WATCH key1 key2 æ—¶ï¼Œ å‰é¢å±•ç¤ºçš„ watched_keys å°†è¢«ä¿®æ”¹æˆè¿™ä¸ªæ ·å­ï¼š</p><p><img src="https://cdn.nlark.com/yuque/0/2023/svg/35838370/1682779124149-f5a1f0b8-25ae-428c-8927-910b8c86e485.svg" alt="img"></p><p>é€šè¿‡ watched_keys å­—å…¸ï¼Œ å¦‚æœç¨‹åºæƒ³æ£€æŸ¥æŸä¸ªé”®æ˜¯å¦è¢«ç›‘è§†ï¼Œ é‚£ä¹ˆå®ƒåªè¦æ£€æŸ¥å­—å…¸ä¸­æ˜¯å¦å­˜åœ¨è¿™ä¸ªé”®å³å¯ï¼› å¦‚æœç¨‹åºè¦è·å–ç›‘è§†æŸä¸ªé”®çš„æ‰€æœ‰å®¢æˆ·ç«¯ï¼Œ é‚£ä¹ˆåªè¦å–å‡ºé”®çš„å€¼ï¼ˆä¸€ä¸ªé“¾è¡¨ï¼‰ï¼Œ ç„¶åå¯¹é“¾è¡¨è¿›è¡Œéå†å³å¯ã€‚</p><h5 id="WATCH-çš„è§¦å‘"><a href="#WATCH-çš„è§¦å‘" class="headerlink" title="WATCH çš„è§¦å‘"></a>WATCH çš„è§¦å‘</h5><p>åœ¨ä»»ä½•å¯¹æ•°æ®åº“é”®ç©ºé—´ï¼ˆkey spaceï¼‰è¿›è¡Œä¿®æ”¹çš„å‘½ä»¤æˆåŠŸæ‰§è¡Œä¹‹å ï¼ˆæ¯”å¦‚ FLUSHDB ã€SETã€DELã€LPUSHã€SADD ï¼Œè¯¸å¦‚æ­¤ç±»ï¼‰ï¼Œ multi.c&#x2F;touchWatchedKey å‡½æ•°éƒ½ä¼šè¢«è°ƒç”¨ â€”â€” å®ƒæ£€æŸ¥æ•°æ®åº“çš„ watched_keys å­—å…¸ï¼Œ çœ‹æ˜¯å¦æœ‰å®¢æˆ·ç«¯åœ¨ç›‘è§†å·²ç»è¢«å‘½ä»¤ä¿®æ”¹çš„é”®ï¼Œ å¦‚æœæœ‰çš„è¯ï¼Œ ç¨‹åºå°†æ‰€æœ‰ç›‘è§†è¿™ä¸ª&#x2F;è¿™äº›è¢«ä¿®æ”¹é”®çš„å®¢æˆ·ç«¯çš„ REDIS_DIRTY_CAS é€‰é¡¹æ‰“å¼€ï¼š</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779123291-8a135c71-3565-4c56-9dfe-533d255158e9.svg" alt="img"></p><p>å½“å®¢æˆ·ç«¯å‘é€ <a href="http://redis.readthedocs.org/en/latest/transaction/exec.html#exec">EXEC</a> å‘½ä»¤ã€è§¦å‘äº‹åŠ¡æ‰§è¡Œæ—¶ï¼Œ æœåŠ¡å™¨ä¼šå¯¹å®¢æˆ·ç«¯çš„çŠ¶æ€è¿›è¡Œæ£€æŸ¥ï¼š</p><ul><li>å¦‚æœå®¢æˆ·ç«¯çš„ REDIS_DIRTY_CAS é€‰é¡¹å·²ç»è¢«æ‰“å¼€ï¼Œé‚£ä¹ˆè¯´æ˜è¢«å®¢æˆ·ç«¯ç›‘è§†çš„é”®è‡³å°‘æœ‰ä¸€ä¸ªå·²ç»è¢«ä¿®æ”¹äº†ï¼Œäº‹åŠ¡çš„å®‰å…¨æ€§å·²ç»è¢«ç ´åã€‚æœåŠ¡å™¨ä¼šæ”¾å¼ƒæ‰§è¡Œè¿™ä¸ªäº‹åŠ¡ï¼Œç›´æ¥å‘å®¢æˆ·ç«¯è¿”å›ç©ºå›å¤ï¼Œè¡¨ç¤ºäº‹åŠ¡æ‰§è¡Œå¤±è´¥ã€‚</li><li>å¦‚æœ REDIS_DIRTY_CAS é€‰é¡¹æ²¡æœ‰è¢«æ‰“å¼€ï¼Œé‚£ä¹ˆè¯´æ˜æ‰€æœ‰ç›‘è§†é”®éƒ½å®‰å…¨ï¼ŒæœåŠ¡å™¨æ­£å¼æ‰§è¡Œäº‹åŠ¡ã€‚</li></ul><p>ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æ•°æ®åº“çš„ watched_keys å­—å…¸å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://cdn.nlark.com/yuque/0/2023/svg/35838370/1682779124835-ac785dae-6d6d-4247-bd7f-8209ea924ea4.svg" alt="img"></p><p>å¦‚æœæŸä¸ªå®¢æˆ·ç«¯å¯¹ key1 è¿›è¡Œäº†ä¿®æ”¹ï¼ˆæ¯”å¦‚æ‰§è¡Œ DEL key1 ï¼‰ï¼Œ é‚£ä¹ˆæ‰€æœ‰ç›‘è§† key1 çš„å®¢æˆ·ç«¯ï¼Œ åŒ…æ‹¬ client2 ã€ client5 å’Œ client1 çš„ REDIS_DIRTY_CAS é€‰é¡¹éƒ½ä¼šè¢«æ‰“å¼€ï¼Œ å½“å®¢æˆ·ç«¯ client2 ã€ client5 å’Œ client1 æ‰§è¡Œ <a href="http://redis.readthedocs.org/en/latest/transaction/exec.html#exec">EXEC</a> çš„æ—¶å€™ï¼Œ å®ƒä»¬çš„äº‹åŠ¡éƒ½ä¼šä»¥å¤±è´¥å‘Šç»ˆã€‚</p><p>æœ€åï¼Œå½“ä¸€ä¸ªå®¢æˆ·ç«¯ç»“æŸå®ƒçš„äº‹åŠ¡æ—¶ï¼Œæ— è®ºäº‹åŠ¡æ˜¯æˆåŠŸæ‰§è¡Œï¼Œè¿˜æ˜¯å¤±è´¥ï¼Œ watched_keys å­—å…¸ä¸­å’Œè¿™ä¸ªå®¢æˆ·ç«¯ç›¸å…³çš„èµ„æ–™éƒ½ä¼šè¢«æ¸…é™¤ã€‚</p><h4 id="5-5-6-äº‹åŠ¡çš„-ACID-æ€§è´¨"><a href="#5-5-6-äº‹åŠ¡çš„-ACID-æ€§è´¨" class="headerlink" title="5.5.6 äº‹åŠ¡çš„ ACID æ€§è´¨"></a>5.5.6 äº‹åŠ¡çš„ ACID æ€§è´¨</h4><p>ä¼ ç»Ÿæ•°æ®åº“ï¼Œå¸¸å¸¸ç”¨ ACID æ€§è´¨æ¥æ£€éªŒ äº‹åŠ¡æ˜¯å¦å®‰å…¨ã€‚Redis äº‹åŠ¡ä¿è¯äº† ä¸€è‡´æ€§ï¼ˆCï¼‰ã€éš”ç¦»æ€§ï¼ˆIï¼‰ï¼Œä½†å¹¶ä¸èƒ½ä¿è¯ åŸå­æ€§ï¼ˆAï¼‰å’Œ æŒä¹…æ€§ï¼ˆDï¼‰ã€‚</p><h5 id="åŸå­æ€§ï¼ˆAtomicityï¼‰"><a href="#åŸå­æ€§ï¼ˆAtomicityï¼‰" class="headerlink" title="åŸå­æ€§ï¼ˆAtomicityï¼‰"></a>åŸå­æ€§ï¼ˆAtomicityï¼‰</h5><p>å•ä¸ª Redis å‘½ä»¤æ‰§è¡Œè‚¯å®šæ˜¯ åŸå­æ€§çš„ï¼Œä½† Redis æ²¡æœ‰åœ¨äº‹åŠ¡ä¸Šå¢åŠ ä»»ä½•ç»´æŒåŸå­æ€§çš„æœºåˆ¶ï¼Œæ‰€æœ‰ Redis äº‹åŠ¡çš„æ‰§è¡Œå¹¶ä¸æ˜¯åŸå­æ€§çš„ã€‚</p><p>å¦‚æœä¸€ä¸ªäº‹åŠ¡é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å‘½ä»¤éƒ½è¢«æˆåŠŸåœ°æ‰§è¡Œï¼Œé‚£ä¹ˆç§°è¿™ä¸ªäº‹åŠ¡æ‰§è¡ŒæˆåŠŸã€‚å¦ä¸€æ–¹é¢ï¼Œå¦‚æœ Redis æœåŠ¡å™¨è¿›ç¨‹åœ¨æ‰§è¡Œäº‹åŠ¡çš„è¿‡ç¨‹ä¸­è¢«åœæ­¢ â€”â€” æ¯”å¦‚æ¥åˆ° KILL ä¿¡å·ã€å®¿ä¸»æœºå™¨åœæœºï¼Œç­‰ç­‰ï¼Œé‚£ä¹ˆäº‹åŠ¡æ‰§è¡Œå¤±è´¥ã€‚å½“äº‹åŠ¡å¤±è´¥æ—¶ï¼ŒRedis ä¹Ÿä¸ä¼šè¿›è¡Œä»»ä½•çš„é‡è¯•æˆ–è€…å›æ»šåŠ¨ä½œã€‚</p><p>ç®€å•æ€»ç»“ï¼š</p><ul><li>å‘½ä»¤å…¥é˜Ÿæ—¶å°±æŠ¥é”™ï¼Œä¼šæ”¾å¼ƒäº‹åŠ¡æ‰§è¡Œï¼Œä¿è¯åŸå­æ€§ã€‚</li><li>å‘½ä»¤å…¥é˜Ÿæ—¶æ²¡æŠ¥é”™ï¼Œå®é™…æ‰§è¡Œæ—¶æŠ¥é”™ï¼Œä¸ä¿è¯åŸå­æ€§ã€‚</li><li>EXEC å‘½ä»¤æ‰§è¡Œæ—¶å®ä¾‹æ•…éšœï¼Œå¦‚æœå¼€å¯ AOF æ—¥å¿—ï¼Œå¯ä»¥ä¿è¯åŸå­æ€§ã€‚</li></ul><p>å…¶ä¿è¯çš„æ˜¯éƒ¨åˆ†åŸå­æ€§ï¼Œ<strong>å¯ä»¥ä¿è¯å¤šä¸ªå‘½ä»¤è¦ä¹ˆå°±ä¸€èµ·æ‰§è¡Œï¼Œè¦ä¹ˆå°±ä¸€èµ·ä¸æ‰§è¡Œ</strong>ã€‚ä½†æ˜¯<strong>ä¸èƒ½ä¿è¯ å¤šä¸ªå‘½ä»¤è¦ä¹ˆä¸€èµ·æ‰§è¡ŒæˆåŠŸï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡ŒæˆåŠŸ</strong>ã€‚å…¥é˜Ÿåï¼Œå¦‚æœæœ‰å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œå…¶ä¹‹å‰å‘½ä»¤æ‰§è¡Œæ“ä½œå¹¶ä¸ä¼šå›é€€ï¼Œå…¶ä¹‹åå‘½ä»¤ä¹Ÿç…§å¸¸æ‰§è¡Œã€‚</p><h5 id="ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰"><a href="#ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰" class="headerlink" title="ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰"></a>ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰</h5><p>ä¸€è‡´æ€§è¡¨ç¤ºï¼šäº‹åŠ¡æ‰§è¡Œç»“æŸåï¼Œæ•°æ®åº“çš„å®Œæ•´æ€§çº¦æŸæ²¡æœ‰è¢«ç ´åï¼Œäº‹åŠ¡æ‰§è¡Œçš„å‰åé¡ºåºéƒ½æ˜¯åˆæ³•æ•°æ®çŠ¶æ€ã€‚</p><ul><li>å®ä½“å®Œæ•´æ€§(å¦‚è¡Œçš„ä¸»é”®å­˜åœ¨ä¸”å”¯ä¸€);</li><li>åˆ—å®Œæ•´æ€§(å¦‚å­—æ®µçš„ç±»å‹ã€å¤§å°ã€é•¿åº¦è¦ç¬¦åˆè¦æ±‚)</li><li>å¤–é”®çº¦æŸ;</li><li>ç”¨æˆ·è‡ªå®šä¹‰å®Œæ•´æ€§(å¦‚è½¬è´¦å‰åï¼Œä¸¤ä¸ªè´¦æˆ·ä½™é¢çš„å’Œåº”è¯¥ä¸å˜)ã€‚</li></ul><p>Redis çš„ä¸€è‡´æ€§é—®é¢˜ å¯ä»¥åˆ†ä¸ºä¸‰éƒ¨åˆ†æ¥è®¨è®ºï¼šå…¥é˜Ÿé”™è¯¯ã€æ‰§è¡Œé”™è¯¯ã€Redis è¿›ç¨‹è¢«ç»ˆç»“ã€‚</p><ol><li>å…¥é˜Ÿé”™è¯¯ï¼šåœ¨å‘½ä»¤å…¥é˜Ÿçš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€äº†é”™è¯¯çš„å‘½ä»¤ï¼Œæ¯”å¦‚å‘½ä»¤çš„å‚æ•°æ•°é‡ä¸å¯¹ï¼Œç­‰ç­‰ï¼Œ é‚£ä¹ˆæœåŠ¡å™¨å°†å‘å®¢æˆ·ç«¯è¿”å›ä¸€ä¸ªå‡ºé”™ä¿¡æ¯ï¼Œ å¹¶ä¸”å°†å®¢æˆ·ç«¯çš„äº‹åŠ¡çŠ¶æ€è®¾ä¸º REDIS_DIRTY_EXEC ã€‚å½“å®¢æˆ·ç«¯æ‰§è¡Œ EXEC å‘½ä»¤æ—¶ï¼Œ Redis ä¼šæ‹’ç»æ‰§è¡ŒçŠ¶æ€ä¸º REDIS_DIRTY_EXEC çš„äº‹åŠ¡ï¼Œ å¹¶è¿”å›å¤±è´¥ä¿¡æ¯ã€‚å› æ­¤ï¼Œå¸¦æœ‰ä¸æ­£ç¡®å…¥é˜Ÿå‘½ä»¤çš„äº‹åŠ¡ä¸ä¼šè¢«æ‰§è¡Œï¼Œä¹Ÿä¸ä¼šå½±å“æ•°æ®åº“çš„ä¸€è‡´æ€§ã€‚</li><li>æ‰§è¡Œé”™è¯¯ï¼šå¦‚æœå‘½ä»¤åœ¨äº‹åŠ¡æ‰§è¡Œçš„è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œæ¯”å¦‚è¯´ï¼Œå¯¹ä¸€ä¸ªä¸åŒç±»å‹çš„ key æ‰§è¡Œäº†é”™è¯¯çš„æ“ä½œï¼Œ é‚£ä¹ˆ Redis åªä¼šå°†é”™è¯¯åŒ…å«åœ¨äº‹åŠ¡çš„ç»“æœä¸­ï¼Œ è¿™ä¸ä¼šå¼•èµ·äº‹åŠ¡ä¸­æ–­æˆ–æ•´ä¸ªå¤±è´¥ï¼Œä¸ä¼šå½±å“å·²æ‰§è¡Œäº‹åŠ¡å‘½ä»¤çš„ç»“æœï¼Œä¹Ÿä¸ä¼šå½±å“åé¢è¦æ‰§è¡Œçš„äº‹åŠ¡å‘½ä»¤ï¼Œ æ‰€ä»¥å®ƒå¯¹äº‹åŠ¡çš„ä¸€è‡´æ€§ä¹Ÿæ²¡æœ‰å½±å“ã€‚</li><li>Redis è¿›ç¨‹è¢«ç»ˆç»“å¦‚æœ Redis æœåŠ¡å™¨è¿›ç¨‹åœ¨æ‰§è¡Œäº‹åŠ¡çš„è¿‡ç¨‹ä¸­è¢«å…¶ä»–è¿›ç¨‹ç»ˆç»“ï¼Œæˆ–è€…è¢«ç®¡ç†å‘˜å¼ºåˆ¶æ€æ­»ï¼Œé‚£ä¹ˆæ ¹æ® Redis æ‰€ä½¿ç”¨çš„æŒä¹…åŒ–æ¨¡å—ï¼Œå¯èƒ½ç”±ä»¥ä¸‹æƒ…å†µå‡ºç°ï¼š</li></ol><ul><li><ul><li>å†…å­˜æ¨¡å—ï¼šå¦‚æœ Redis æ²¡æœ‰é‡‡å–ä»»ä½•æŒä¹…åŒ–æœºåˆ¶ï¼Œé‚£ä¹ˆé‡å¯åçš„æ•°æ®åº“æ€»æ˜¯ç©ºç™½çš„ï¼Œæ‰€ä»¥æ•°æ®æ€»æ˜¯ä¸€è‡´çš„ã€‚</li><li>RDB æ¨¡å—ï¼šåœ¨æ‰§è¡Œäº‹åŠ¡æ—¶ï¼ŒRedis ä¸ä¼šä¸­æ–­äº‹åŠ¡å»æ‰§è¡Œä¿å­˜ RDB çš„å·¥ä½œï¼Œåªæœ‰åœ¨äº‹åŠ¡æ‰§è¡Œä¹‹åï¼Œä¿å­˜ RDB çš„å·¥ä½œæ‰å¯èƒ½å¼€å§‹ã€‚æ‰€ä»¥å½“RDB æ¨¡å¼ä¸‹çš„ Redis æœåŠ¡å™¨è¿›ç¨‹åœ¨äº‹åŠ¡ä¸­é€”è¢«æ€æ­»æ—¶ï¼Œäº‹åŠ¡å†…æ‰§è¡Œçš„å‘½ä»¤ï¼Œä¸ç®¡æˆåŠŸäº†å¤šå°‘ï¼Œéƒ½ä¸ä¼šè¢«ä¿å­˜åˆ° RDB æ–‡ä»¶é‡Œã€‚æ¢å¤æ•°æ®åº“éœ€è¦ä½¿ç”¨ç°æœ‰çš„ RDB æ–‡ä»¶ï¼Œè€Œè¿™ä¸ª RDB æ–‡ä»¶çš„æ•°æ®ä¿å­˜çš„æ˜¯æœ€è¿‘ä¸€æ¬¡çš„æ•°æ®åº“å¿«ç…§ï¼ˆsnapshotï¼‰ï¼Œæ‰€ä»¥å®ƒçš„æ•°æ®å¯èƒ½ä¸æ˜¯æœ€æ–°çš„ï¼Œä½†åªè¦ RDB æ–‡ä»¶æœ¬èº«æ²¡æœ‰å› ä¸ºå…¶ä»–é—®é¢˜è€Œå‡ºé”™ï¼Œé‚£ä¹ˆè¿˜åŸåçš„æ•°æ®åº“å°±æ˜¯ä¸€è‡´çš„ã€‚</li><li>AOF æ¨¡å¼ï¼šå› ä¸ºä¿å­˜ AOF æ–‡ä»¶çš„å·¥ä½œåœ¨åå°çº¿ç¨‹è¿›è¡Œï¼Œæ‰€ä»¥å³ä½¿æ˜¯åœ¨äº‹åŠ¡æ‰§è¡Œçš„ä¸­é€”ï¼Œä¿å­˜ AOF æ–‡ä»¶çš„å·¥ä½œä¹Ÿå¯ä»¥ç»§ç»­è¿›è¡Œï¼Œå› æ­¤ï¼Œæ ¹æ®äº‹åŠ¡è¯­å¥æ˜¯å¦è¢«å†™å…¥å¹¶ä¿å­˜åˆ° AOF æ–‡ä»¶ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç§æƒ…å†µå‘é€ï¼š</li></ul></li><li><ul><li><ul><li>å¦‚æœäº‹åŠ¡è¯­å¥ æœªå†™å…¥åˆ° AOF æ–‡ä»¶ï¼Œæˆ– AOF æœªè¢« SYNC è°ƒç”¨ä¿å­˜åˆ°ç£ç›˜ï¼Œé‚£ä¹ˆå½“è¿›ç¨‹è¢«æ€æ­»ä¹‹åï¼ŒRedis å¯ä»¥æ ¹æ® æœ€è¿‘ä¸€æ¬¡æˆåŠŸä¿å­˜åˆ° ç£ç›˜çš„ AOF æ–‡ä»¶ æ¥è¿˜åŸæ•°æ®åº“ï¼Œåªè¦ AOF æ–‡ä»¶æœ¬èº«æ²¡æœ‰å› ä¸ºå…¶ä»–é—®é¢˜è€Œå‡ºé”™ï¼Œé‚£ä¹ˆè¿˜åŸåçš„æ•°æ®åº“æ€»æ˜¯ä¸€è‡´çš„ï¼Œä½†å…¶ä¸­çš„æ•°æ®ä¸ä¸€å®šæ˜¯æœ€æ–°çš„ã€‚</li><li>å¦‚æœäº‹åŠ¡çš„éƒ¨åˆ†è¯­å¥ è¢«å†™å…¥åˆ° AOF æ–‡ä»¶ä¸­ï¼Œå¹¶ä¸” AOF æ–‡ä»¶è¢«æˆåŠŸä¿å­˜ï¼Œé‚£ä¹ˆä¸å®Œæ•´çš„äº‹åŠ¡æ‰§è¡Œä¿¡æ¯å°±ä¼šé—ç•™åœ¨ AOF æ–‡ä»¶é‡Œï¼Œå½“é‡å¯ Redis æ—¶ï¼Œç¨‹åºä¼šæ£€æµ‹åˆ° AOF æ–‡ä»¶å¹¶ä¸å®Œæ•´ï¼ŒRedis ä¼šé€€å‡ºï¼Œå¹¶æŠ¥å‘Šé”™è¯¯ã€‚éœ€è¦ä½¿ç”¨ redis-check-aof å·¥å…·å°†éƒ¨åˆ†æˆåŠŸçš„äº‹åŠ¡å‘½ä»¤ç§»é™¤ä¹‹åï¼Œæ‰èƒ½å†æ¬¡å¯åŠ¨æœåŠ¡å™¨ã€‚è¿˜åŸä¹‹åçš„æ•°æ®æ€»æ˜¯ä¸€è‡´çš„ï¼Œè€Œä¸”æ•°æ®ä¹Ÿæ˜¯æœ€æ–°çš„ï¼ˆç›´åˆ°äº‹åŠ¡æ‰§è¡Œä¹‹å‰ä¸ºæ­¢ï¼‰ã€‚</li></ul></li></ul></li></ul><h5 id="éš”ç¦»æ€§ï¼ˆIsolationï¼‰"><a href="#éš”ç¦»æ€§ï¼ˆIsolationï¼‰" class="headerlink" title="éš”ç¦»æ€§ï¼ˆIsolationï¼‰"></a>éš”ç¦»æ€§ï¼ˆIsolationï¼‰</h5><p>Redis æ˜¯å•è¿›ç¨‹ç¨‹åºï¼Œå¹¶ä¸”å®ƒä¿è¯åœ¨æ‰§è¡Œäº‹åŠ¡æ—¶ï¼Œä¸ä¼šå¯¹äº‹åŠ¡è¿›è¡Œä¸­æ–­ï¼Œäº‹åŠ¡å¯ä»¥è¿è¡Œç›´åˆ°æ‰§è¡Œå®Œæ‰€æœ‰äº‹åŠ¡é˜Ÿåˆ—ä¸­çš„å‘½ä»¤ä¸ºæ­¢ã€‚å› æ­¤ï¼ŒRedis çš„äº‹åŠ¡æ˜¯æ€»æ˜¯å¸¦æœ‰éš”ç¦»æ€§çš„ã€‚</p><h5 id="æŒä¹…æ€§ï¼ˆDurabilityï¼‰"><a href="#æŒä¹…æ€§ï¼ˆDurabilityï¼‰" class="headerlink" title="æŒä¹…æ€§ï¼ˆDurabilityï¼‰"></a>æŒä¹…æ€§ï¼ˆDurabilityï¼‰</h5><p>å› ä¸ºäº‹åŠ¡ä¸è¿‡æ˜¯ç”¨é˜Ÿåˆ—åŒ…è£¹äº†ä¸€ç»„ Redis å‘½ä»¤ï¼Œå¹¶æ²¡æœ‰æä¾›ä»»ä½•é¢å¤–çš„æŒä¹…æ€§åŠŸèƒ½ï¼Œæ‰€ä»¥äº‹åŠ¡çš„æŒä¹…æ€§ç”± Redis æ‰€ä½¿ç”¨çš„æŒä¹…åŒ–æ¨¡å—å†³å®š</p><ul><li>å•çº¯çš„å†…å­˜æ¨¡å¼ä¸‹ï¼Œäº‹åŠ¡è‚¯å®šæ˜¯ä¸æŒä¹…çš„ã€‚</li><li>åœ¨ RDB æ¨¡å—ä¸‹ï¼ŒæœåŠ¡å™¨å¯èƒ½åœ¨äº‹åŠ¡æ‰§è¡Œä¹‹åã€RDB æ–‡ä»¶æ›´æ–°ä¹‹å‰çš„è¿™æ®µæ—¶é—´å¤±è´¥ï¼Œæ‰€ä»¥ RDB æ¨¡å¼ä¸‹çš„ Redis äº‹åŠ¡ä¹Ÿä¸æŒä¹…çš„ã€‚</li><li>åœ¨ AOF çš„ â€œæ€»æ˜¯SYNCâ€ æ¨¡å¼ä¸‹ï¼Œäº‹åŠ¡çš„æ¯æ¡å‘½ä»¤åœ¨æ‰§è¡ŒæˆåŠŸä¹‹åï¼Œéƒ½ä¼šç«‹å³è°ƒç”¨ fsync æˆ– fdatasync å°†äº‹åŠ¡æ•°æ®å†™å…¥åˆ° AOFæ–‡ä»¶ã€‚ä½†æ˜¯ï¼Œè¿™ç§ä¿å­˜æ˜¯ç”±åå°çº¿ç¨‹è¿›è¡Œçš„ï¼Œä¸»çº¿ç¨‹ä¸ä¼šå µå¡ç›´åˆ°ä¿å­˜æˆåŠŸã€‚æ‰€ä»¥å‘½ä»¤æ‰§è¡ŒæˆåŠŸåˆ°æ•°æ®ä¿å­˜åˆ°ç¡¬ç›˜ä¹‹é—´ï¼Œè¿˜æ˜¯æœ‰ä¸€æ®µéå¸¸å°çš„é—´éš”ï¼Œæ‰€ä»¥è¿™ç§æ¨¡å¼ä¸‹çš„äº‹åŠ¡ä¹Ÿæ˜¯ä¸æŒä¹…çš„ã€‚</li></ul><p>å…¶ä»– AOF æ¨¡å¼ä¹Ÿå’Œ â€œæ€»æ˜¯SYNCâ€ æ¨¡å¼ç±»ä¼¼ï¼Œæ‰€ä»¥å®ƒä»¬éƒ½æ˜¯ä¸æŒä¹…çš„ã€‚</p><h4 id="5-5-7-å°ç»“"><a href="#5-5-7-å°ç»“" class="headerlink" title="5.5.7 å°ç»“"></a>5.5.7 å°ç»“</h4><ul><li>äº‹åŠ¡æä¾›äº†ä¸€ç§å°†å¤šä¸ªå‘½ä»¤æ‰“åŒ…ï¼Œç„¶åä¸€æ¬¡æ€§ã€æœ‰åºåœ°æ‰§è¡Œçš„æœºåˆ¶ã€‚</li><li>äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸ä¼šè¢«ä¸­æ–­ï¼Œæ‰€æœ‰äº‹åŠ¡å‘½ä»¤æ‰§è¡Œå®Œä¹‹åï¼Œäº‹åŠ¡æ‰èƒ½ç»“æŸã€‚</li><li>å¤šä¸ªå‘½ä»¤ä¼šè¢«å…¥é˜Ÿåˆ°äº‹åŠ¡é˜Ÿåˆ—ä¸­ï¼Œç„¶åæŒ‰å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„é¡ºåºæ‰§è¡Œã€‚</li><li>å¸¦ WATCH å‘½ä»¤çš„äº‹åŠ¡ä¼šå°†å®¢æˆ·ç«¯å’Œè¢«ç›‘è§†çš„é”®åœ¨æ•°æ®åº“çš„ watched_keys å­—å…¸ä¸­è¿›è¡Œå…³è”ï¼Œå½“é”®è¢«ä¿®æ”¹æ—¶ï¼Œç¨‹åºä¼šå°†æ‰€æœ‰ç›‘è§†è¢«ä¿®æ”¹é”®çš„å®¢æˆ·ç«¯çš„ REDIS_DIRTY_CAS é€‰é¡¹æ‰“å¼€ã€‚</li><li>åªæœ‰åœ¨å®¢æˆ·ç«¯çš„ REDIS_DIRTY_CAS é€‰é¡¹æœªè¢«æ‰“å¼€æ—¶ï¼Œæ‰èƒ½æ‰§è¡Œäº‹åŠ¡ï¼Œå¦åˆ™äº‹åŠ¡ç›´æ¥è¿”å›å¤±è´¥ã€‚</li><li>Redis çš„äº‹åŠ¡ä¿è¯äº† ACID ä¸­çš„ä¸€è‡´æ€§ï¼ˆCï¼‰å’Œéš”ç¦»æ€§ï¼ˆIï¼‰ï¼Œä½†å¹¶ä¸ä¿è¯åŸå­æ€§ï¼ˆAï¼‰å’ŒæŒä¹…æ€§ï¼ˆDï¼‰ã€‚</li></ul><h3 id="5-6-è®¢é˜…ä¸å‘å¸ƒ"><a href="#5-6-è®¢é˜…ä¸å‘å¸ƒ" class="headerlink" title="5.6 è®¢é˜…ä¸å‘å¸ƒ"></a>5.6 è®¢é˜…ä¸å‘å¸ƒ</h3><p>Redis é€šè¿‡ PUBLISHã€SUBSCRIBEç­‰å‘½ä»¤å®ç°äº†è®¢é˜…ä¸å‘å¸ƒæ¨¡å¼ï¼Œ è¿™ä¸ªåŠŸèƒ½æä¾›ä¸¤ç§ä¿¡æ¯æœºåˆ¶ï¼Œ åˆ†åˆ«æ˜¯è®¢é˜…&#x2F;å‘å¸ƒåˆ°é¢‘é“å’Œè®¢é˜…&#x2F;å‘å¸ƒåˆ°æ¨¡å¼ï¼Œ ä¸‹æ–‡å…ˆè®¨è®ºè®¢é˜…&#x2F;å‘å¸ƒåˆ°é¢‘é“çš„å®ç°ï¼Œ å†è®¨è®ºè®¢é˜…&#x2F;å‘å¸ƒåˆ°æ¨¡å¼çš„å®ç°ã€‚</p><h4 id="5-6-1-é¢‘é“çš„è®¢é˜…ä¸ä¿¡æ¯å‘é€"><a href="#5-6-1-é¢‘é“çš„è®¢é˜…ä¸ä¿¡æ¯å‘é€" class="headerlink" title="5.6.1 é¢‘é“çš„è®¢é˜…ä¸ä¿¡æ¯å‘é€"></a>5.6.1 é¢‘é“çš„è®¢é˜…ä¸ä¿¡æ¯å‘é€</h4><p>Redis çš„ SUBSCRIBE å‘½ä»¤å¯ä»¥è®©å®¢æˆ·ç«¯è®¢é˜…ä»»æ„æ•°é‡çš„é¢‘é“ï¼Œæ¯å½“æœ‰æ–°æ¶ˆæ¯å‘é€åˆ°è¢«è®¢é˜…çš„é¢‘é“æ—¶ï¼Œä¿¡æ¯å°±ä¼šè¢«å‘é€ç»™æ‰€æœ‰è®¢é˜…æŒ‡å®šé¢‘é“çš„å®¢æˆ·ç«¯ã€‚</p><p><img src="https://cdn.nlark.com/yuque/0/2023/svg/35838370/1682779124262-ac7f1f60-b21b-44a8-810f-6f10ac13eab1.svg" alt="img"></p><p>å½“æœ‰æ–°æ¶ˆæ¯é€šè¿‡ <a href="http://redis.readthedocs.org/en/latest/pub_sub/publish.html#publish">PUBLISH</a> å‘½ä»¤å‘é€ç»™é¢‘é“ channel1 æ—¶ï¼Œ è¿™ä¸ªæ¶ˆæ¯å°±ä¼šè¢«å‘é€ç»™è®¢é˜…å®ƒçš„ä¸‰ä¸ªå®¢æˆ·ç«¯ï¼š</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779126625-3d2dbe1a-b372-47b6-9a25-e937747ce3fa.svg" alt="img"></p><h5 id="è®¢é˜…é¢‘é“"><a href="#è®¢é˜…é¢‘é“" class="headerlink" title="è®¢é˜…é¢‘é“"></a>è®¢é˜…é¢‘é“</h5><p>æ¯ä¸ª Redis æœåŠ¡å™¨è¿›ç¨‹éƒ½ç»´æŒç€ä¸€ä¸ªè¡¨ç¤ºæœåŠ¡å™¨çŠ¶æ€çš„ redis.h&#x2F;redisServer ç»“æ„ï¼Œç»“æ„çš„ pubsub_channels å±æ€§æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œè¿™ä¸ªå­—å…¸å°±ç”¨äºä¿å­˜è®¢é˜…é¢‘é“çš„ä¿¡æ¯ã€‚</p><p>å…¶ä¸­ï¼Œå­—å…¸çš„é”®ä¸ºæ­£åœ¨è¢«è®¢é˜…çš„é¢‘é“ï¼Œè€Œå­—å…¸çš„å€¼åˆ™æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œé“¾è¡¨ä¸­ä¿å­˜äº†æ‰€æœ‰è®¢é˜…è¿™ä¸ªé¢‘é“çš„å®¢æˆ·ç«¯ã€‚</p><p>æ¯”å¦‚è¯´ï¼Œåœ¨ä¸‹å›¾å±•ç¤ºçš„è¿™ä¸ª pubsub_channels ç¤ºä¾‹ä¸­ï¼Œ client2 ã€ client5 å’Œ client1 å°±è®¢é˜…äº† channel1 ï¼Œ è€Œå…¶ä»–é¢‘é“ä¹Ÿåˆ†åˆ«è¢«åˆ«çš„å®¢æˆ·ç«¯æ‰€è®¢é˜…ï¼š</p><p><img src="https://cdn.nlark.com/yuque/0/2023/svg/35838370/1682779126861-01cd5b87-621a-4c11-8997-fd32e7124cde.svg" alt="img"></p><p>å½“å®¢æˆ·ç«¯è°ƒç”¨ <a href="http://redis.readthedocs.org/en/latest/pub_sub/subscribe.html#subscribe">SUBSCRIBE</a> å‘½ä»¤æ—¶ï¼Œ ç¨‹åºå°±å°†å®¢æˆ·ç«¯å’Œè¦è®¢é˜…çš„é¢‘é“åœ¨ pubsub_channels å­—å…¸ä¸­å…³è”èµ·æ¥ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœå®¢æˆ·ç«¯ client10086 æ‰§è¡Œå‘½ä»¤ SUBSCRIBE channel1 channel2 channel3 ï¼Œé‚£ä¹ˆå‰é¢å±•ç¤ºçš„ pubsub_channels å°†å˜æˆä¸‹é¢è¿™ä¸ªæ ·å­ï¼š</p><p><img src="https://cdn.nlark.com/yuque/0/2023/svg/35838370/1682779127981-4b8e7194-f9c9-4e88-b812-b9f8594061e9.svg" alt="img"></p><p>é€šè¿‡ pubsub_channels å­—å…¸ï¼Œ ç¨‹åºåªè¦æ£€æŸ¥æŸä¸ªé¢‘é“æ˜¯å¦ä¸ºå­—å…¸çš„é”®ï¼Œ å°±å¯ä»¥çŸ¥é“è¯¥é¢‘é“æ˜¯å¦æ­£åœ¨è¢«å®¢æˆ·ç«¯è®¢é˜…ï¼› åªè¦å–å‡ºæŸä¸ªé”®çš„å€¼ï¼Œ å°±å¯ä»¥å¾—åˆ°æ‰€æœ‰è®¢é˜…è¯¥é¢‘é“çš„å®¢æˆ·ç«¯çš„ä¿¡æ¯ã€‚</p><h5 id="å‘é€ä¿¡æ¯åˆ°é¢‘é“"><a href="#å‘é€ä¿¡æ¯åˆ°é¢‘é“" class="headerlink" title="å‘é€ä¿¡æ¯åˆ°é¢‘é“"></a>å‘é€ä¿¡æ¯åˆ°é¢‘é“</h5><p>äº†è§£äº† pubsub_channels å­—å…¸çš„ç»“æ„ä¹‹åï¼Œ è§£é‡Š <a href="http://redis.readthedocs.org/en/latest/pub_sub/publish.html#publish">PUBLISH</a> å‘½ä»¤çš„å®ç°å°±éå¸¸ç®€å•äº†ï¼š å½“è°ƒç”¨ PUBLISH channel message å‘½ä»¤ï¼Œ ç¨‹åºé¦–å…ˆæ ¹æ® channel å®šä½åˆ°å­—å…¸çš„é”®ï¼Œ ç„¶åå°†ä¿¡æ¯å‘é€ç»™å­—å…¸å€¼é“¾è¡¨ä¸­çš„æ‰€æœ‰å®¢æˆ·ç«¯ã€‚</p><p>æ¯”å¦‚è¯´ï¼Œå¯¹äºä»¥ä¸‹è¿™ä¸ª pubsub_channels å®ä¾‹ï¼Œ å¦‚æœæŸä¸ªå®¢æˆ·ç«¯æ‰§è¡Œå‘½ä»¤ PUBLISH channel1 â€œhello motoâ€ ï¼Œé‚£ä¹ˆ client2 ã€ client5 å’Œ client1 ä¸‰ä¸ªå®¢æˆ·ç«¯éƒ½å°†æ¥æ”¶åˆ° â€œhello motoâ€ ä¿¡æ¯ï¼š</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779127370-c53aa587-36b5-4a1e-8777-e74917f5ece7.svg" alt="img"></p><h5 id="é€€è®¢é¢‘é“"><a href="#é€€è®¢é¢‘é“" class="headerlink" title="é€€è®¢é¢‘é“"></a>é€€è®¢é¢‘é“</h5><p>ä½¿ç”¨ UNSUBSCRIBE å‘½ä»¤å¯ä»¥é€€è®¢æŒ‡å®šçš„é¢‘é“ï¼Œ è¿™ä¸ªå‘½ä»¤æ‰§è¡Œçš„æ˜¯è®¢é˜…çš„åæ“ä½œï¼š å®ƒä» pubsub_channels å­—å…¸çš„ç»™å®šé¢‘é“ï¼ˆé”®ï¼‰ä¸­ï¼Œ åˆ é™¤å…³äºå½“å‰å®¢æˆ·ç«¯çš„ä¿¡æ¯ï¼Œ è¿™æ ·è¢«é€€è®¢é¢‘é“çš„ä¿¡æ¯å°±ä¸ä¼šå†å‘é€ç»™è¿™ä¸ªå®¢æˆ·ç«¯ã€‚</p><h4 id="5-6-2-æ¨¡å¼çš„è®¢é˜…ä¸ä¿¡æ¯å‘é€"><a href="#5-6-2-æ¨¡å¼çš„è®¢é˜…ä¸ä¿¡æ¯å‘é€" class="headerlink" title="5.6.2 æ¨¡å¼çš„è®¢é˜…ä¸ä¿¡æ¯å‘é€"></a>5.6.2 æ¨¡å¼çš„è®¢é˜…ä¸ä¿¡æ¯å‘é€</h4><p>å½“ä½¿ç”¨ PUBLISH å‘½ä»¤å‘é€ä¿¡æ¯åˆ°æŸä¸ªé¢‘é“æ—¶ï¼Œä¸ä»…æ‰€æœ‰è®¢é˜…è¯¥é¢‘é“çš„å®¢æˆ·ç«¯ä¼šæ”¶åˆ°ä¿¡æ¯ï¼Œå¦‚æœæœ‰ æŸä¸ª&#x2F;æŸäº› æ¨¡å¼å’Œ è¿™ä¸ªé¢‘é“åŒ¹é…çš„è¯ï¼Œé‚£ä¹ˆæ‰€æœ‰è®¢é˜… è¿™ä¸ª&#x2F;è¿™äº› é¢‘é“çš„å®¢æˆ·ç«¯ä¹ŸåŒæ ·ä¼šå—åˆ°ä¿¡æ¯ã€‚</p><p>ä¸‹å›¾å±•ç¤ºäº†ä¸€ä¸ªå¸¦æœ‰é¢‘é“å’Œæ¨¡å¼çš„ä¾‹å­ï¼Œ å…¶ä¸­ tweet.shop.* æ¨¡å¼åŒ¹é…äº† tweet.shop.kindle é¢‘é“å’Œ tweet.shop.ipad é¢‘é“ï¼Œ å¹¶ä¸”æœ‰ä¸åŒçš„å®¢æˆ·ç«¯åˆ†åˆ«è®¢é˜…å®ƒä»¬ä¸‰ä¸ªï¼š</p><p><img src="https://cdn.nlark.com/yuque/0/2023/svg/35838370/1682779128616-e784de68-42e6-4095-bcf0-60e9c43986ec.svg" alt="img"></p><p>å½“æœ‰ä¿¡æ¯å‘é€åˆ° tweet.shop.kindle é¢‘é“æ—¶ï¼Œ ä¿¡æ¯é™¤äº†å‘é€ç»™ clientX å’Œ clientY ä¹‹å¤–ï¼Œ è¿˜ä¼šå‘é€ç»™è®¢é˜… tweet.shop.* æ¨¡å¼çš„ client123 å’Œ client256 ï¼š</p><p><img src="https://cdn.nlark.com/yuque/0/2023/svg/35838370/1682779128540-cc69dd3a-5458-471e-aaeb-84a2e7a04712.svg" alt="img"></p><p>å¦ä¸€æ–¹é¢ï¼Œ å¦‚æœæ¥æ”¶åˆ°ä¿¡æ¯çš„æ˜¯é¢‘é“ tweet.shop.ipad ï¼Œ é‚£ä¹ˆ client123 å’Œ client256 åŒæ ·ä¼šæ”¶åˆ°ä¿¡æ¯ï¼š</p><p><img src="https://cdn.nlark.com/yuque/0/2023/svg/35838370/1682779131307-fa5396f0-9c11-438a-b6ed-492143caca5c.svg" alt="img"></p><h5 id="è®¢é˜…æ¨¡å¼"><a href="#è®¢é˜…æ¨¡å¼" class="headerlink" title="è®¢é˜…æ¨¡å¼"></a>è®¢é˜…æ¨¡å¼</h5><p>redisServer.pubsub_patterns å±æ€§æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œé“¾è¡¨ä¸­ä¿å­˜ç€æ‰€æœ‰å’Œæ¨¡å¼ç›¸å…³çš„ä¿¡æ¯ã€‚</p><p>é“¾è¡¨ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½åŒ…å«ä¸€ä¸ª redis.h&#x2F;pubsubPattern ç»“æ„ï¼š</p><p>client å±æ€§ä¿å­˜ç€è®¢é˜…æ¨¡å¼çš„å®¢æˆ·ç«¯ï¼Œè€Œ pattern å±æ€§åˆ™ä¿å­˜ç€è¢«è®¢é˜…çš„æ¨¡å¼ã€‚</p><p>æ¯å½“è°ƒç”¨ PSUBSCRIBE å‘½ä»¤è®¢é˜…ä¸€ä¸ªæ¨¡å¼æ—¶ï¼Œ ç¨‹åºå°±åˆ›å»ºä¸€ä¸ªåŒ…å«å®¢æˆ·ç«¯ä¿¡æ¯å’Œè¢«è®¢é˜…æ¨¡å¼çš„ pubsubPattern ç»“æ„ï¼Œ å¹¶å°†è¯¥ç»“æ„æ·»åŠ åˆ° redisServer.pubsub_patterns é“¾è¡¨ä¸­ã€‚</p><p>ä½œä¸ºä¾‹å­ï¼Œä¸‹å›¾å±•ç¤ºäº†ä¸€ä¸ªåŒ…å«ä¸¤ä¸ªæ¨¡å¼çš„ pubsub_patterns é“¾è¡¨ï¼Œ å…¶ä¸­ client123 å’Œ client256 éƒ½æ­£åœ¨è®¢é˜… tweet.shop.* æ¨¡å¼ï¼š</p><p><img src="https://cdn.nlark.com/yuque/0/2023/svg/35838370/1682779131253-176aab8f-481e-490a-8bdd-e31d5c0d0268.svg" alt="img"></p><p>å¦‚æœè¿™æ—¶å®¢æˆ·ç«¯ client10086 æ‰§è¡Œ PSUBSCRIBE broadcast.list.* ï¼Œ é‚£ä¹ˆ pubsub_patterns é“¾è¡¨å°†è¢«æ›´æ–°æˆè¿™æ ·ï¼š</p><p><img src="https://cdn.nlark.com/yuque/0/2023/svg/35838370/1682779133621-3a05dd6e-3664-4953-abb2-eca5a3de291e.svg" alt="img"></p><p>é€šè¿‡éå†æ•´ä¸ª pubsub_patterns é“¾è¡¨ï¼Œç¨‹åºå¯ä»¥æ£€æŸ¥æ‰€æœ‰æ­£åœ¨è¢«è®¢é˜…çš„æ¨¡å¼ï¼Œä»¥åŠè®¢é˜…è¿™äº›æ¨¡å¼çš„å®¢æˆ·ç«¯ã€‚</p><h5 id="å‘é€ä¿¡æ¯åˆ°æ¨¡å¼"><a href="#å‘é€ä¿¡æ¯åˆ°æ¨¡å¼" class="headerlink" title="å‘é€ä¿¡æ¯åˆ°æ¨¡å¼"></a>å‘é€ä¿¡æ¯åˆ°æ¨¡å¼</h5><p>å‘é€ä¿¡æ¯åˆ°æ¨¡å¼çš„å·¥ä½œä¹Ÿæ˜¯ç”± PUBLISH å‘½ä»¤è¿›è¡Œçš„ã€‚ PUBLISH é™¤äº†å°† message å‘é€åˆ°æ‰€æœ‰è®¢é˜… channel çš„å®¢æˆ·ç«¯ä¹‹å¤–ï¼Œå®ƒè¿˜ä¼šå°† channel å’Œ pubsub_pattern ä¸­çš„æ¨¡å¼è¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æœ channel å’ŒæŸä¸ªæ¨¡å¼åŒ¹é…çš„è¯ï¼Œé‚£ä¹ˆä¹Ÿå°† message å‘é€åˆ°è®¢é˜…é‚£ä¸ªæ¨¡å¼çš„å®¢æˆ·ç«¯ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœ Redis æœåŠ¡å™¨çš„ pubsub_patterns çŠ¶æ€å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.nlark.com/yuque/0/2023/svg/35838370/1682779131145-01a1aea3-c788-4cfa-aae6-91390a521463.svg" alt="img"></p><p>é‚£ä¹ˆå½“æŸä¸ªå®¢æˆ·ç«¯å‘é€ä¿¡æ¯ â€œAmazon Kindle, $69.â€ åˆ° tweet.shop.kindle é¢‘é“æ—¶ï¼Œ é™¤äº†æ‰€æœ‰è®¢é˜…äº† tweet.shop.kindle é¢‘é“çš„å®¢æˆ·ç«¯ä¼šæ”¶åˆ°ä¿¡æ¯ä¹‹å¤–ï¼Œ å®¢æˆ·ç«¯ client123 å’Œ client256 ä¹ŸåŒæ ·ä¼šæ”¶åˆ°ä¿¡æ¯ï¼Œ å› ä¸ºè¿™ä¸¤ä¸ªå®¢æˆ·ç«¯è®¢é˜…çš„ tweet.shop.* æ¨¡å¼å’Œ tweet.shop.kindle é¢‘é“åŒ¹é…ã€‚</p><h5 id="é€€è®¢æ¨¡å¼"><a href="#é€€è®¢æ¨¡å¼" class="headerlink" title="é€€è®¢æ¨¡å¼"></a>é€€è®¢æ¨¡å¼</h5><p>ä½¿ç”¨ PUNSUBSCRIBE å‘½ä»¤å¯ä»¥é€€è®¢æŒ‡å®šçš„æ¨¡å¼ï¼Œ è¿™ä¸ªå‘½ä»¤æ‰§è¡Œçš„æ˜¯è®¢é˜…æ¨¡å¼çš„åæ“ä½œï¼š ç¨‹åºä¼šåˆ é™¤ redisServer.pubsub_patterns é“¾è¡¨ä¸­ï¼Œ æ‰€æœ‰å’Œè¢«é€€è®¢æ¨¡å¼ç›¸å…³è”çš„ pubsubPattern ç»“æ„ï¼Œ è¿™æ ·å®¢æˆ·ç«¯å°±ä¸ä¼šå†æ”¶åˆ°å’Œæ¨¡å¼ç›¸åŒ¹é…çš„é¢‘é“å‘æ¥çš„ä¿¡æ¯ã€‚</p><h4 id="5-6-3-å°ç»“"><a href="#5-6-3-å°ç»“" class="headerlink" title="5.6.3 å°ç»“"></a>5.6.3 å°ç»“</h4><p>è¦ç‚¹ï¼š</p><ul><li>è®¢é˜…ä¿¡æ¯ç”±æœåŠ¡å™¨è¿›ç¨‹ç»´æŒçš„ redisServer.pubsub_channels å­—å…¸ä¿å­˜ï¼Œå­—å…¸çš„é”®ä¸ºè¢«è®¢é˜…çš„é¢‘é“ï¼Œå­—å…¸çš„å€¼ä¸ºè®¢é˜…é¢‘é“çš„æ‰€æœ‰å®¢æˆ·ç«¯ã€‚</li><li>å½“æœ‰æ–°æ¶ˆæ¯å‘é€åˆ°é¢‘é“æ—¶ï¼Œç¨‹åºéå†é¢‘é“ï¼ˆé”®ï¼‰æ‰€å¯¹åº”çš„ï¼ˆå€¼ï¼‰æ‰€æœ‰å®¢æˆ·ç«¯ï¼Œç„¶åå°†æ¶ˆæ¯å‘é€åˆ°æ‰€æœ‰è®¢é˜…é¢‘é“çš„å®¢æˆ·ç«¯ä¸Šã€‚</li><li>è®¢é˜…æ¨¡å¼çš„ä¿¡æ¯ç”±æœåŠ¡å™¨è¿›ç¨‹ç»´æŒçš„ redisServer.pubsub_patterns é“¾è¡¨ä¿å­˜ï¼Œé“¾è¡¨çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¿å­˜ç€ä¸€ä¸ª pubsubPattern ç»“æ„ï¼Œç»“æ„ä¸­ä¿å­˜ç€è¢«è®¢é˜…çš„æ¨¡å¼ï¼Œä»¥åŠè®¢é˜…è¯¥æ¨¡å¼çš„å®¢æˆ·ç«¯ã€‚ç¨‹åºé€šè¿‡éå†é“¾è¡¨æ¥æŸ¥æ‰¾æŸä¸ªé¢‘é“æ˜¯å¦å’ŒæŸä¸ªæ¨¡å¼åŒ¹é…ã€‚</li><li>å½“æœ‰æ–°æ¶ˆæ¯å‘é€åˆ°é¢‘é“æ—¶ï¼Œé™¤äº†è®¢é˜…é¢‘é“çš„å®¢æˆ·ç«¯ä¼šæ”¶åˆ°æ¶ˆæ¯ä¹‹å¤–ï¼Œæ‰€æœ‰è®¢é˜…äº†åŒ¹é…é¢‘é“çš„æ¨¡å¼çš„å®¢æˆ·ç«¯ï¼Œä¹ŸåŒæ ·ä¼šæ”¶åˆ°æ¶ˆæ¯ã€‚</li><li>é€€è®¢é¢‘é“å’Œé€€è®¢æ¨¡å¼åˆ†åˆ«æ˜¯è®¢é˜…é¢‘é“å’Œè®¢é˜…æ¨¡å¼çš„åæ“ä½œã€‚</li></ul><p>ç¼ºç‚¹ï¼š</p><p>PubSub çš„ç”Ÿäº§è€…äº§åœ°è¿‡æ¥ä¸€ä¸ªæ¶ˆæ¯ï¼ŒRedis ä¼šç›´æ¥æ‰¾åˆ°ç›¸åº”çš„æ¶ˆè´¹è€…ä¼ é€’è¿‡å»ã€‚å¦‚æœä¸€ä¸ªæ¶ˆè´¹è€…ä¹Ÿæ²¡æœ‰ï¼Œé‚£ä¹ˆæ¶ˆæ¯ç›´æ¥ä¸¢å¼ƒã€‚å¦‚æœå¼€å§‹æœ‰ä¸‰ä¸ªæ¶ˆè´¹è€…ï¼Œä¸€ä¸ªæ¶ˆè´¹è€…çªç„¶æŒ‚æ‰äº†ï¼Œç”Ÿäº§è€…ä¼šç»§ç»­å‘é€æ¶ˆæ¯ï¼Œå¦å¤–ä¸¤ä¸ªæ¶ˆè´¹è€…å¯ä»¥æŒç»­å—åˆ°æ¶ˆæ¯ã€‚ä½†æ˜¯æŒ‚æ‰çš„æ¶ˆè´¹è€…é‡æ–°è¿ä¸Šçš„æ—¶å€™ï¼Œè¿™æ–­è¿æœŸé—´ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ï¼Œå¯¹äºè¿™ä¸ªæ¶ˆè´¹è€…æ¥è¯´å°±å½»åº•æ¶ˆå¤±äº†ã€‚</p><p>å¦‚æœ Redis åœæœºé‡å¯ï¼ŒPubSub çš„æ¶ˆæ¯æ˜¯ä¸ä¼šæŒä¹…åŒ–çš„ï¼Œæ¯•ç«Ÿ Redis å®•æœºå°±ç›¸å½“äºä¸€ä¸ªæ¶ˆè´¹è€…éƒ½æ²¡æœ‰ï¼Œæ‰€æœ‰çš„æ¶ˆæ¯ç›´æ¥ä¸¢å¼ƒã€‚</p><p>æ­£æ˜¯å› ä¸º PubSub æœ‰è¿™äº›ç¼ºç‚¹ï¼Œå®ƒå‡ ä¹æ‰¾ä¸åˆ°åˆé€‚çš„åº”ç”¨åœºæ™¯ã€‚æ‰€ä»¥ Redis çš„ä½œè€…å•ç‹¬å¼€å¯äº†ä¸€ä¸ªé¡¹ç›® Disque ä¸“é—¨åš å¤šæ’­æ¶ˆæ¯é˜Ÿåˆ—ã€‚</p><p>githubåœ°å€ï¼š<a href="https://github.com/antirez/disque-module%E3%80%82%E4%BD%86%E6%98%AF%E5%9C%A8">https://github.com/antirez/disque-moduleã€‚ä½†æ˜¯åœ¨</a> Redis5.0 æ–°å¢äº† Stream æ•°æ®ç»“æ„ï¼Œè¿™ä¸ªåŠŸèƒ½ç»™ Redis å¸¦æ¥äº†æŒä¹…åŒ–æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä»æ­¤ PubSub å¯ä»¥æ¶ˆå¤±äº†ï¼ŒDisqueue ä¼°è®¡ä¹Ÿä¸ä¼šå‘å‡ºå®ƒçš„æ­£å¼ç‰ˆäº†ã€‚</p><h3 id="5-7-Redisé›†ç¾¤æ¨¡å¼â€”ä¸»ä»å¤åˆ¶"><a href="#5-7-Redisé›†ç¾¤æ¨¡å¼â€”ä¸»ä»å¤åˆ¶" class="headerlink" title="5.7 Redisé›†ç¾¤æ¨¡å¼â€”ä¸»ä»å¤åˆ¶"></a>5.7 Redisé›†ç¾¤æ¨¡å¼â€”ä¸»ä»å¤åˆ¶</h3><p><a href="https://pdai.tech/md/db/nosql-redis/db-redis-x-copy.html">https://pdai.tech/md/db/nosql-redis/db-redis-x-copy.html</a></p><p>æˆ‘ä»¬çŸ¥é“è¦é¿å…å•ç‚¹æ•…éšœï¼Œå³ä¿è¯é«˜å¯ç”¨ï¼Œä¾¿éœ€è¦å†—ä½™ï¼ˆå‰¯æœ¬ï¼‰æ–¹å¼æä¾›é›†ç¾¤æœåŠ¡ã€‚è€Œ Redis æä¾›äº†ä¸»ä»åº“æ¨¡å¼ï¼Œä»¥ä¿è¯æ•°æ®å‰¯æœ¬çš„ä¸€è‡´ï¼Œä¸»ä»åº“ä¹‹é—´é‡‡ç”¨çš„æ˜¯è¯»å†™åˆ†ç¦» çš„æ–¹å¼ã€‚</p><h4 id="5-7-1-ä¸»ä»å¤åˆ¶æ¦‚è¿°"><a href="#5-7-1-ä¸»ä»å¤åˆ¶æ¦‚è¿°" class="headerlink" title="5.7.1 ä¸»ä»å¤åˆ¶æ¦‚è¿°"></a>5.7.1 ä¸»ä»å¤åˆ¶æ¦‚è¿°</h4><p>ä¸»ä»å¤åˆ¶ï¼Œæ˜¯æŒ‡å°†ä¸€å° Redis æœåŠ¡å™¨çš„æ•°æ®ï¼Œå¤åˆ¶åˆ°å…¶ä»–çš„ Redis æœåŠ¡å™¨ã€‚å‰è€…ç§°ä¸º ä¸»èŠ‚ç‚¹ï¼ˆmasterï¼‰ï¼Œåè€…ç§°ä¸º ä»èŠ‚ç‚¹ï¼ˆslaveï¼‰ã€‚æ•°æ®çš„å¤åˆ¶æ˜¯å•å‘çš„ï¼Œåªèƒ½ä» ä¸»èŠ‚ç‚¹ åˆ° ä»èŠ‚ç‚¹ã€‚</p><p><strong>ä¸»ä»å¤åˆ¶çš„ä½œç”¨</strong>ä¸»è¦åŒ…æ‹¬ï¼š</p><ul><li><strong>æ•°æ®å†—ä½™</strong>ï¼šä¸»ä»å¤åˆ¶å®ç°äº†æ•°æ®çš„çƒ­å¤‡ä»½ï¼Œæ˜¯æŒä¹…åŒ–ä¹‹å¤–çš„ä¸€ç§æ•°æ®å†—ä½™æ–¹å¼ã€‚</li><li><strong>æ•…éšœæ¢å¤</strong>ï¼šå½“ä¸»èŠ‚ç‚¹å‡ºç°é—®é¢˜æ—¶ï¼Œå¯ä»¥ç”±ä»èŠ‚ç‚¹æä¾›æœåŠ¡ï¼Œå®ç°å¿«é€Ÿçš„æ•…éšœæ¢å¤ï¼›å®é™…ä¸Šæ˜¯ä¸€ç§æœåŠ¡çš„å†—ä½™ã€‚</li><li><strong>è´Ÿè½½å‡è¡¡</strong>ï¼šåœ¨ä¸»ä»å¤åˆ¶çš„åŸºç¡€ä¸Šï¼Œé…åˆè¯»å†™åˆ†ç¦»ï¼Œå¯ä»¥ç”±ä¸»èŠ‚ç‚¹æä¾›å†™æœåŠ¡ï¼Œç”±ä»èŠ‚ç‚¹æä¾›è¯»æœåŠ¡ï¼ˆå³å†™Redisæ•°æ®æ—¶åº”ç”¨è¿æ¥ä¸»èŠ‚ç‚¹ï¼Œè¯»Redisæ•°æ®æ—¶åº”ç”¨è¿æ¥ä»èŠ‚ç‚¹ï¼‰ï¼Œåˆ†æ‹…æœåŠ¡å™¨è´Ÿè½½ï¼›å°¤å…¶æ˜¯åœ¨å†™å°‘è¯»å¤šçš„åœºæ™¯ä¸‹ï¼Œé€šè¿‡å¤šä¸ªä»èŠ‚ç‚¹åˆ†æ‹…è¯»è´Ÿè½½ï¼Œå¯ä»¥å¤§å¤§æé«˜RedisæœåŠ¡å™¨çš„å¹¶å‘é‡ã€‚</li><li><strong>é«˜å¯ç”¨åŸºçŸ³</strong>ï¼šé™¤äº†ä¸Šè¿°ä½œç”¨ä»¥å¤–ï¼Œä¸»ä»å¤åˆ¶è¿˜æ˜¯å“¨å…µå’Œé›†ç¾¤èƒ½å¤Ÿå®æ–½çš„åŸºç¡€ï¼Œå› æ­¤è¯´ä¸»ä»å¤åˆ¶æ˜¯Redisé«˜å¯ç”¨çš„åŸºç¡€ã€‚</li></ul><p>ä¸»ä»åº“ä¹‹é—´é‡‡ç”¨çš„æ˜¯<strong>è¯»å†™åˆ†ç¦»</strong>çš„æ–¹å¼ã€‚</p><ul><li>è¯»æ“ä½œï¼šä¸»åº“ã€ä»åº“éƒ½å¯ä»¥æ¥æ”¶ï¼›</li><li>å†™æ“ä½œï¼šé¦–å…ˆåˆ°ä¸»åº“æ‰§è¡Œï¼Œç„¶åï¼Œä¸»åº“å°†å†™æ“ä½œåŒæ­¥ç»™ä»åº“ã€‚</li></ul><p>åœ¨ 2.8 ç‰ˆæœ¬ä¹‹å‰ï¼Œåªæœ‰å…¨é‡å¤åˆ¶ï¼Œè€Œ2.8ç‰ˆæœ¬ä¹‹åæœ‰å…¨é‡å’Œå¢é‡å¤åˆ¶</p><ul><li>å…¨é‡ï¼ˆåŒæ­¥ï¼‰å¤åˆ¶ï¼šæ¯”å¦‚ç¬¬ä¸€æ¬¡åŒæ­¥æ—¶</li><li>å¢é‡ï¼ˆåŒæ­¥ï¼‰å¤åˆ¶ï¼šåªä¼šæŠŠä¸»ä»åº“ç½‘ç»œæ–­è¿æœŸé—´ä¸»åº“æ”¶åˆ°çš„å‘½ä»¤ï¼ŒåŒæ­¥ç»™ä»åº“ã€‚</li></ul><h4 id="5-7-2-å…¨é‡å¤åˆ¶"><a href="#5-7-2-å…¨é‡å¤åˆ¶" class="headerlink" title="5.7.2 å…¨é‡å¤åˆ¶"></a>5.7.2 å…¨é‡å¤åˆ¶</h4><p>å½“æˆ‘ä»¬å¯åŠ¨å¤šä¸ª Redis å®ä¾‹çš„æ—¶å€™ï¼Œå®ƒä»¬ç›¸äº’ä¹‹é—´å°±å¯ä»¥é€šè¿‡ replicaofï¼ˆRedis 5.0 ä¹‹å‰ä½¿ç”¨ slaveofï¼‰å‘½ä»¤å½¢æˆä¸»åº“å’Œä»åº“çš„å…³ç³»ï¼Œä¹‹åä¼šæŒ‰ç…§ä¸‰ä¸ªé˜¶æ®µå®Œæˆæ•°æ®çš„ç¬¬ä¸€æ¬¡åŒæ­¥</p><ul><li>å»ºç«‹ä¸»ä»å…³ç³»</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># è¿™é‡Œæˆ‘ä»¬åˆ›å»ºäº† ä¸¤ä¸ª redis å®ä¾‹</span><br><span class="line">[root@VM-4-9-centos ~]# docker run -it -d --name redis2 -p 6379:6379 redis</span><br><span class="line">9865ef807588457b05a4353a5c4a1699486343abab71d6682f98a6bc27497961</span><br><span class="line">[root@VM-4-9-centos ~]# docker run -it -d --name redis1 -p 6380:6379 redis</span><br><span class="line">f21ca2cacfea46f1b05baffffdafc9c46f76482cdea3d018ff7196469b75c6e9</span><br><span class="line"></span><br><span class="line"># æŸ¥çœ‹æ‰€æœ‰å®¹å™¨çš„ ipåœ°å€</span><br><span class="line">[root@VM-4-9-centos ~]# docker inspect -f &#x27;&#123;&#123;.Name&#125;&#125; - &#123;&#123;.NetworkSettings.IPAddress &#125;&#125;&#x27; $(docker ps -aq)</span><br><span class="line">/redis2 - 172.17.0.5</span><br><span class="line">/redis1 - 172.17.0.4</span><br><span class="line"></span><br><span class="line"># ä½¿ç”¨ redis1 å®¹å™¨çš„ rediså‘½ä»¤è¡Œï¼Œå­˜å…¥ key=name,value=kongxr</span><br><span class="line">[root@VM-4-9-centos ~]#  docker exec -it redis1 /bin/bash</span><br><span class="line">root@f21ca2cacfea:/data# redis-cli</span><br><span class="line">127.0.0.1:6379&gt; set name kongxr</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line"># ä½¿ç”¨ reids2å®¹å™¨å†…çš„ rediså‘½ä»¤è¡Œã€‚æŸ¥è¯¢key=nameï¼Œæœªè·å–åˆ°å€¼ã€‚</span><br><span class="line"># ç„¶åä½¿ç”¨åŒæ­¥å‘½ä»¤å°†redis2 ä½œä¸ºä»åº“ï¼Œå»ºç«‹ä¸»ä»å…³ç³»ï¼Œå¹¶åŒæ­¥æ•°æ®</span><br><span class="line">[root@VM-4-9-centos ~]# docker exec -it redis2 /bin/bash</span><br><span class="line">root@9865ef807588:/data# redis-cli</span><br><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line">(nil)</span><br><span class="line">127.0.0.1:6379&gt; replicaof 172.17.0.4 6379</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line">(nil)</span><br><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line">&quot;kongxr&quot;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„æµ‹è¯•ï¼Œå¯ä»¥çœ‹åˆ° åœ¨å»ºç«‹ä¸»ä»å…³ç³»åï¼Œä»åº“ä¼šæ…¢æ…¢ä»ä¸»åº“ä¸­åŒæ­¥å…¨é‡æ•°æ®ã€‚</p><ul><li><p>å…¨é‡å¤åˆ¶çš„ä¸‰ä¸ªé˜¶æ®µ</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779131543-769d79b6-8fbc-49bd-9f96-2cd53b6554a7-20250605100935711.jpeg" alt="img"></p></li></ul><ol><li><ol><li><strong>ç¬¬ä¸€é˜¶æ®µæ˜¯ä¸»ä»åº“é—´å»ºç«‹è¿æ¥ã€åå•†åŒæ­¥çš„è¿‡ç¨‹ï¼Œä¸»è¦æ˜¯ä¸ºäº†å…¨é‡å¤åˆ¶åšå‡†å¤‡ã€‚</strong>åœ¨è¿™ä¸€æ­¥ï¼Œä»åº“å’Œä¸»åº“å»ºç«‹è¿æ¥ï¼Œå¹¶å‘Šè¯‰ä¸»åº“å³å°†å¼€å§‹è¿›è¡ŒåŒæ­¥ï¼Œä¸»åº“ç¡®è®¤å›å¤åï¼Œä¸»ä»åº“é—´å°±å¯ä»¥å¼€å§‹åŒæ­¥äº†ã€‚å…·ä½“çš„æ¥è¯´ï¼Œä»åº“ç»™ä¸»åº“å‘é€ psync å‘½ä»¤ï¼Œè¡¨ç¤ºè¦è¿›è¡Œæ•°æ®åŒæ­¥ï¼Œä¸»åº“æ ¹æ®è¿™ä¸ªå‘½ä»¤çš„å‚æ•°æ¥å¯åŠ¨å¤åˆ¶ã€‚psync å‘½ä»¤åŒ…æ‹¬äº†ä¸»åº“çš„ runID å’Œ å¤åˆ¶è¿›åº¦ offset ä¸¤ä¸ªå‚æ•°ã€‚runIDï¼Œæ˜¯æ¯ä¸ª Redis å®ä¾‹å¯åŠ¨æ—¶éƒ½ä¼šè‡ªåŠ¨ç”Ÿæˆçš„ä¸€ä¸ªéšæœºIDï¼Œç”¨æ¥å”¯ä¸€æ ‡è®°è¿™ä¸ªå®ä¾‹ã€‚å½“ä»åº“å’Œä¸»åº“ç¬¬ä¸€æ¬¡å¤åˆ¶æ—¶ï¼Œå› ä¸ºä¸çŸ¥é“ä¸»åº“çš„ runIDï¼Œæ‰€ä»¥å°† runID è®¾ä¸º â€œ?â€ ã€‚offsetï¼Œæ­¤æ—¶è®¾ä¸º -1ï¼Œè¡¨ç¤ºç¬¬ä¸€æ¬¡å¤åˆ¶ã€‚ä¸»åº“æ”¶åˆ° psync å‘½ä»¤åï¼Œä¼šç”¨ FULLRESYNC å“åº”å‘½ä»¤å¸¦ä¸Š ä¸¤ä¸ªå‚æ•°ï¼šä¸»åº“ runID å’Œä¸»åº“ç›®å‰çš„å¤åˆ¶è¿›åº¦ offset ï¼Œè¿”å›ç»™ä»åº“ã€‚ä»åº“æ”¶åˆ°å“åº”åï¼Œä¼šè®°å½•ä¸‹è¿™ä¸¤ä¸ªå‚æ•°ã€‚è¿™é‡Œæœ‰ä¸ªåœ°æ–¹éœ€è¦æ³¨æ„ï¼ŒFULLRESYNC å“åº”è¡¨ç¤ºç¬¬ä¸€æ¬¡å¤åˆ¶é‡‡ç”¨çš„å…¨é‡å¤åˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸»åº“ä¼šæŠŠå½“å‰æ‰€æœ‰çš„æ•°æ®éƒ½å¤åˆ¶ç»™ä»åº“ã€‚</li><li><strong>ç¬¬äºŒä¸ªé˜¶æ®µï¼Œä¸»åº“å°†æ‰€æœ‰æ•°æ®åŒæ­¥ç»™ä»åº“ã€‚</strong>ä»åº“æ”¶åˆ°æ•°æ®åï¼Œåœ¨æœ¬åœ°å®Œæˆæ•°æ®åŠ è½½ã€‚è¿™ä¸ªè¿‡ç¨‹ä¾èµ–äºå†…å­˜å¿«ç…§ç”Ÿæˆ RDB æ–‡ä»¶ã€‚å…·ä½“æ¥è¯´ï¼Œä¸»åº“æ‰§è¡Œ bgsave å‘½ä»¤ï¼Œç”Ÿæˆ RDB æ–‡ä»¶ï¼Œæ¥ç€å°†æ–‡ä»¶å‘é€ç»™ä»åº“ã€‚ä»åº“æ¥æ”¶åˆ° RDB æ–‡ä»¶åï¼Œä¼šå…ˆæ¸…ç©ºå½“å‰æ•°æ®åº“ï¼Œç„¶ååŠ è½½ RDB æ–‡ä»¶ã€‚è¿™æ˜¯å› ä¸ºä»åº“åœ¨é€šè¿‡ replicaof å‘½ä»¤å¼€å§‹å’Œä¸»åº“åŒæ­¥å‰ï¼Œå¯èƒ½ä¿å­˜äº†å…¶ä»–æ•°æ®ã€‚ä¸ºäº†é¿å…ä¹‹å‰æ•°æ®çš„å½±å“ï¼Œä»åº“éœ€è¦å…ˆæŠŠå½“å‰æ•°æ®åº“æ¸…ç©ºã€‚åœ¨ä¸»åº“å°†æ•°æ®åŒæ­¥ç»™ä»åº“çš„è¿‡ç¨‹ä¸­ï¼Œä¸»åº“ä¸ä¼šè¢«å µå¡ï¼Œä»ç„¶å¯ä»¥æ­£å¸¸æ¥å—è¯·æ±‚ã€‚ä½†æ˜¯ï¼Œè¯·æ±‚ä¸­çš„å†™æ“ä½œå¹¶æ²¡æœ‰è®°å½•åˆ°åˆšåˆšç”Ÿæˆçš„ RDB æ–‡ä»¶ä¸­ã€‚ä¸ºäº†ä¿è¯ä¸»ä»åº“çš„æ•°æ®ä¸€è‡´æ€§ï¼Œä¸»åº“ä¼šåœ¨å†…å­˜ä¸­ç”¨ä¸“é—¨çš„ replication bufferï¼Œè®°å½• RDB æ–‡ä»¶ç”Ÿæˆåæ”¶åˆ°çš„æ‰€æœ‰å†™æ“ä½œã€‚</li><li><strong>ç¬¬ä¸‰ä¸ªé˜¶æ®µï¼Œä¸»åº“ä¼šæŠŠç¬¬äºŒé˜¶æ®µæ‰§è¡Œè¿‡ç¨‹ä¸­æ–°æ”¶åˆ°çš„å†™å‘½ä»¤ï¼Œå†å‘ç»™ä»åº“ã€‚</strong>å…·ä½“çš„æ“ä½œæ˜¯ï¼Œå½“ä¸»åº“å®Œæˆ RDB æ–‡ä»¶å‘é€åï¼Œå°±ä¼šæŠŠæ­¤æ—¶ replication buffer ä¸­çš„ä¿®æ”¹æ“ä½œå‘ç»™ä»åº“ï¼Œä»åº“å†é‡æ–°æ‰§è¡Œè¿™äº›æ“ä½œã€‚è¿™æ ·ä»¥æ¥ï¼Œä¸»ä»åº“å°±å®ç°åŒæ­¥äº†ã€‚</li></ol></li></ol><h4 id="5-7-3-å¢é‡å¤åˆ¶"><a href="#5-7-3-å¢é‡å¤åˆ¶" class="headerlink" title="5.7.3 å¢é‡å¤åˆ¶"></a>5.7.3 å¢é‡å¤åˆ¶</h4><p>åœ¨ Redis 2.8 ç‰ˆæœ¬å¼•å…¥äº†å¢é‡å¤åˆ¶</p><ul><li><p>ä¸ºä»€ä¹ˆä¼šè®¾è®¡å¢é‡å¤åˆ¶ï¼Ÿå¦‚æœä¸»ä»åº“åœ¨å‘½ä»¤ä¼ æ’­æ—¶å‡ºç°äº†ç½‘ç»œé—ªæ–­ï¼Œé‚£ä¹ˆä»åº“å°±ä¼šå’Œä¸»åº“é‡æ–°è¿›è¡Œä¸€æ¬¡å…¨é‡å¤åˆ¶ï¼Œå¼€é”€éå¸¸å¤§ã€‚ä» Redis 2.8å¼€å§‹ï¼Œç½‘ç»œæ–­äº†ä¹‹åï¼Œä¸»ä»åº“ä¼šé‡‡ç”¨å¢é‡å¤åˆ¶çš„æ–¹å¼ç»§ç»­åŒæ­¥ã€‚</p></li><li><p>å¢é‡å¤åˆ¶æµç¨‹</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779133615-180cf488-8310-45f7-9e35-8cea064b2119-20250605100916148.jpeg" alt="img"></p></li><li><p>å…ˆçœ‹ä¸¤ä¸ªæ¦‚å¿µï¼š replication buffer å’Œ repl_backlog_bufferrepl_backlog_bufferï¼šå®ƒæ˜¯ä¸ºäº†ä»åº“æ–­å¼€ä¹‹åï¼Œå¦‚ä½•æ‰¾åˆ°ä¸»ä»å·®å¼‚æ•°æ®è€Œè®¾è®¡çš„ç¯å½¢ç¼“å†²åŒºï¼Œä»è€Œé¿å…å…¨é‡å¤åˆ¶å¸¦æ¥çš„æ€§èƒ½å¼€é”€ã€‚å¦‚æœä»åº“æ–­å¼€æ—¶é—´å¤ªä¹…ï¼Œrepl_backlog_bufferç¯å½¢ç¼“å†²åŒºè¢«ä¸»åº“çš„å†™å‘½ä»¤è¦†ç›–äº†ï¼Œé‚£ä¹ˆä»åº“è¿ä¸Šä¸»åº“ååªèƒ½ä¹–ä¹–åœ°è¿›è¡Œä¸€æ¬¡å…¨é‡å¤åˆ¶ï¼Œæ‰€ä»¥<strong>repl_backlog_bufferé…ç½®å°½é‡å¤§ä¸€äº›ï¼Œå¯ä»¥é™ä½ä¸»ä»æ–­å¼€åå…¨é‡å¤åˆ¶çš„æ¦‚ç‡</strong>ã€‚è€Œåœ¨repl_backlog_bufferä¸­æ‰¾ä¸»ä»å·®å¼‚çš„æ•°æ®åï¼Œå¦‚ä½•å‘ç»™ä»åº“å‘¢ï¼Ÿè¿™å°±ç”¨åˆ°äº†replication bufferã€‚replication bufferï¼šRediså’Œå®¢æˆ·ç«¯é€šä¿¡ä¹Ÿå¥½ï¼Œå’Œä»åº“é€šä¿¡ä¹Ÿå¥½ï¼ŒRediséƒ½éœ€è¦ç»™åˆ†é…ä¸€ä¸ª å†…å­˜bufferè¿›è¡Œæ•°æ®äº¤äº’ï¼Œå®¢æˆ·ç«¯æ˜¯ä¸€ä¸ªclientï¼Œä»åº“ä¹Ÿæ˜¯ä¸€ä¸ªclientï¼Œæˆ‘ä»¬æ¯ä¸ªclientè¿ä¸ŠRedisåï¼ŒRediséƒ½ä¼šåˆ†é…ä¸€ä¸ªclient bufferï¼Œæ‰€æœ‰æ•°æ®äº¤äº’éƒ½æ˜¯é€šè¿‡è¿™ä¸ªbufferè¿›è¡Œçš„ï¼šRediså…ˆæŠŠæ•°æ®å†™åˆ°è¿™ä¸ªbufferä¸­ï¼Œç„¶åå†æŠŠbufferä¸­çš„æ•°æ®å‘åˆ°client socketä¸­å†é€šè¿‡ç½‘ç»œå‘é€å‡ºå»ï¼Œè¿™æ ·å°±å®Œæˆäº†æ•°æ®äº¤äº’ã€‚æ‰€ä»¥ä¸»ä»åœ¨å¢é‡åŒæ­¥æ—¶ï¼Œä»åº“ä½œä¸ºä¸€ä¸ªclientï¼Œä¹Ÿä¼šåˆ†é…ä¸€ä¸ªbufferï¼Œåªä¸è¿‡è¿™ä¸ªbufferä¸“é—¨ç”¨æ¥ä¼ æ’­ç”¨æˆ·çš„å†™å‘½ä»¤åˆ°ä»åº“ï¼Œä¿è¯ä¸»ä»æ•°æ®ä¸€è‡´ï¼Œæˆ‘ä»¬é€šå¸¸æŠŠå®ƒå«åšreplication bufferã€‚å¯¹äºè¿™ä¸ªé—®é¢˜æ¥è¯´ï¼Œæœ‰ä¸¤ä¸ªå…³é”®ç‚¹ï¼š</p></li><li><ul><li><strong>å¦‚æœåœ¨ç½‘ç»œæ–­å¼€æœŸé—´ï¼Œrepl_backlog_sizeç¯å½¢ç¼“å†²åŒºå†™æ»¡ä¹‹åï¼Œä»åº“æ˜¯ä¼šä¸¢å¤±æ‰é‚£éƒ¨åˆ†è¢«è¦†ç›–æ‰çš„æ•°æ®ï¼Œè¿˜æ˜¯ç›´æ¥è¿›è¡Œå…¨é‡å¤åˆ¶å‘¢</strong>ï¼Ÿ</li></ul></li></ul><ol><li><ol><li>ä¸€ä¸ªä»åº“å¦‚æœå’Œä¸»åº“æ–­è¿æ—¶é—´è¿‡é•¿ï¼Œé€ æˆå®ƒåœ¨ä¸»åº“repl_backlog_bufferçš„slave_repl_offsetä½ç½®ä¸Šçš„æ•°æ®å·²ç»è¢«è¦†ç›–æ‰äº†ï¼Œæ­¤æ—¶ä»åº“å’Œä¸»åº“é—´å°†è¿›è¡Œå…¨é‡å¤åˆ¶ã€‚</li><li>æ¯ä¸ªä»åº“ä¼šè®°å½•è‡ªå·±çš„slave_repl_offsetï¼Œæ¯ä¸ªä»åº“çš„å¤åˆ¶è¿›åº¦ä¹Ÿä¸ä¸€å®šç›¸åŒã€‚åœ¨å’Œä¸»åº“é‡è¿è¿›è¡Œæ¢å¤æ—¶ï¼Œä»åº“ä¼šé€šè¿‡psyncå‘½ä»¤æŠŠè‡ªå·±è®°å½•çš„slave_repl_offsetå‘ç»™ä¸»åº“ï¼Œä¸»åº“ä¼šæ ¹æ®ä»åº“å„è‡ªçš„å¤åˆ¶è¿›åº¦ï¼Œæ¥å†³å®šè¿™ä¸ªä»åº“å¯ä»¥è¿›è¡Œå¢é‡å¤åˆ¶ï¼Œè¿˜æ˜¯å…¨é‡å¤åˆ¶ã€‚</li></ol></li></ol><h4 id="5-7-4-æ›´å¤šç†è§£"><a href="#5-7-4-æ›´å¤šç†è§£" class="headerlink" title="5.7.4 æ›´å¤šç†è§£"></a>5.7.4 æ›´å¤šç†è§£</h4><h5 id="1-å½“ä¸»æœåŠ¡å™¨ä¸è¿›è¡ŒæŒä¹…åŒ–æ—¶-å¤åˆ¶çš„å®‰å…¨æ€§"><a href="#1-å½“ä¸»æœåŠ¡å™¨ä¸è¿›è¡ŒæŒä¹…åŒ–æ—¶-å¤åˆ¶çš„å®‰å…¨æ€§" class="headerlink" title="1.å½“ä¸»æœåŠ¡å™¨ä¸è¿›è¡ŒæŒä¹…åŒ–æ—¶ å¤åˆ¶çš„å®‰å…¨æ€§"></a>1.å½“ä¸»æœåŠ¡å™¨ä¸è¿›è¡ŒæŒä¹…åŒ–æ—¶ å¤åˆ¶çš„å®‰å…¨æ€§</h5><p>å¼ºçƒˆå»ºè®®ä¸»æœåŠ¡å™¨å¼€å¯æŒä¹…åŒ–ã€‚å¦‚æœçœŸçš„ä¸èƒ½å¼€å¯æŒä¹…åŒ–ï¼Œé‚£ä¹ˆä¸€å®šè¦ç¦æ­¢Rediså®ä¾‹è‡ªåŠ¨é‡å¯ã€‚</p><p>ä¸ºä»€ä¹ˆä¸æŒä¹…åŒ–çš„ä¸»æœåŠ¡å™¨è‡ªåŠ¨é‡å¯éå¸¸å±é™©å‘¢ï¼Ÿä¸ºäº†æ›´å¥½çš„ç†è§£è¿™ä¸ªé—®é¢˜ï¼Œçœ‹ä¸‹é¢è¿™ä¸ªå¤±è´¥çš„ä¾‹å­ï¼Œå…¶ä¸­ä¸»æœåŠ¡å™¨å’Œä»æœåŠ¡å™¨ä¸­æ•°æ®åº“éƒ½è¢«åˆ é™¤äº†ã€‚</p><ul><li>æˆ‘ä»¬è®¾ç½®èŠ‚ç‚¹Aä¸ºä¸»æœåŠ¡å™¨ï¼Œå…³é—­æŒä¹…åŒ–ï¼ŒèŠ‚ç‚¹Bå’ŒCä»èŠ‚ç‚¹Aå¤åˆ¶æ•°æ®ã€‚</li><li>è¿™æ—¶å‡ºç°äº†ä¸€ä¸ªå´©æºƒï¼Œä½†Rediså…·æœ‰è‡ªåŠ¨é‡å¯ç³»ç»Ÿï¼Œé‡å¯äº†è¿›ç¨‹ï¼Œå› ä¸ºå…³é—­äº†æŒä¹…åŒ–ï¼ŒèŠ‚ç‚¹é‡å¯ååªæœ‰ä¸€ä¸ªç©ºçš„æ•°æ®é›†ã€‚</li><li>èŠ‚ç‚¹Bå’ŒCä»èŠ‚ç‚¹Aè¿›è¡Œå¤åˆ¶ï¼Œç°åœ¨èŠ‚ç‚¹Aæ˜¯ç©ºçš„ï¼Œæ‰€ä»¥èŠ‚ç‚¹Bå’ŒCä¸Šçš„å¤åˆ¶æ•°æ®ä¹Ÿä¼šè¢«åˆ é™¤ã€‚</li><li>å½“åœ¨é«˜å¯ç”¨ç³»ç»Ÿä¸­ä½¿ç”¨Redis Sentinelï¼Œå…³é—­äº†ä¸»æœåŠ¡å™¨çš„æŒä¹…åŒ–ï¼Œå¹¶ä¸”å…è®¸è‡ªåŠ¨é‡å¯ï¼Œè¿™ç§æƒ…å†µæ˜¯å¾ˆå±é™©çš„ã€‚æ¯”å¦‚ä¸»æœåŠ¡å™¨å¯èƒ½åœ¨å¾ˆçŸ­çš„æ—¶é—´å°±å®Œæˆäº†é‡å¯ï¼Œä»¥è‡³äºSentineléƒ½æ— æ³•æ£€æµ‹åˆ°è¿™æ¬¡å¤±è´¥ï¼Œé‚£ä¹ˆä¸Šé¢è¯´çš„è¿™ç§å¤±è´¥çš„æƒ…å†µå°±å‘ç”Ÿäº†ã€‚</li></ul><p>å¦‚æœæ•°æ®æ¯”è¾ƒé‡è¦ï¼Œå¹¶ä¸”åœ¨ä½¿ç”¨ä¸»ä»å¤åˆ¶æ—¶å…³é—­äº†ä¸»æœåŠ¡å™¨æŒä¹…åŒ–åŠŸèƒ½çš„åœºæ™¯ä¸­ï¼Œéƒ½åº”è¯¥ç¦æ­¢å®ä¾‹è‡ªåŠ¨é‡å¯ã€‚</p><h5 id="2-ä¸ºä»€ä¹ˆä¸»ä»å…¨é‡å¤åˆ¶ä½¿ç”¨-RDB-è€Œä¸ä½¿ç”¨-AOFï¼Ÿ"><a href="#2-ä¸ºä»€ä¹ˆä¸»ä»å…¨é‡å¤åˆ¶ä½¿ç”¨-RDB-è€Œä¸ä½¿ç”¨-AOFï¼Ÿ" class="headerlink" title="2.ä¸ºä»€ä¹ˆä¸»ä»å…¨é‡å¤åˆ¶ä½¿ç”¨ RDB è€Œä¸ä½¿ç”¨ AOFï¼Ÿ"></a>2.ä¸ºä»€ä¹ˆä¸»ä»å…¨é‡å¤åˆ¶ä½¿ç”¨ RDB è€Œä¸ä½¿ç”¨ AOFï¼Ÿ</h5><ul><li>RDB æ–‡ä»¶å†…å®¹æ—¶ç»è¿‡å‹ç¼©çš„ äºŒè¿›åˆ¶æ•°æ®ï¼ˆä¸åŒæ•°æ®ç±»å‹æ•°æ®åšäº†é’ˆå¯¹æ€§ä¼˜åŒ–ï¼‰ï¼Œæ–‡ä»¶å¾ˆå°ã€‚è€Œ AOF æ–‡ä»¶è®°å½•çš„æ˜¯ æ¯ä¸€æ¬¡å†™æ“ä½œçš„å‘½ä»¤ï¼Œå†™æ“ä½œè¶Šå¤šæ–‡ä»¶ä¼šå˜å¾—å¾ˆå¤§ï¼Œå…¶ä¸­è¿˜åŒ…æ‹¬å¾ˆå¤šå¯¹åŒä¸€ä¸ª key çš„å¤šæ¬¡å†—ä½™æ“ä½œã€‚åœ¨ä¸»ä»å…¨é‡æ•°æ®åŒæ­¥æ—¶ï¼Œä¼ è¾“ RDB æ–‡ä»¶å¯ä»¥å°½é‡é™ä½å¯¹ä¸»åº“æœºå™¨ç½‘ç»œå¸¦å®½çš„æ¶ˆè€—ï¼Œä»åº“åœ¨åŠ è½½ RDB æ–‡ä»¶æ—¶ï¼Œä¸€æ˜¯æ–‡ä»¶å°ï¼Œè¯»å–æ•´ä¸ªæ–‡ä»¶çš„é€Ÿåº¦ä¼šå¾ˆå¿«ï¼ŒäºŒæ˜¯å› ä¸ºRDBæ–‡ä»¶å­˜å‚¨çš„éƒ½æ˜¯äºŒè¿›åˆ¶æ•°æ®ï¼Œä»åº“ç›´æ¥æŒ‰ç…§RDBåè®®è§£æè¿˜åŸæ•°æ®å³å¯ï¼Œé€Ÿåº¦ä¼šéå¸¸å¿«ï¼Œè€ŒAOFéœ€è¦ä¾æ¬¡é‡æ”¾æ¯ä¸ªå†™å‘½ä»¤ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šç»å†å†—é•¿çš„å¤„ç†é€»è¾‘ï¼Œæ¢å¤é€Ÿåº¦ç›¸æ¯” RDB ä¼šæ…¢å¾—å¤šï¼Œæ‰€ä»¥ä½¿ç”¨ RDB è¿›è¡Œä¸»ä»å…¨é‡å¤åˆ¶çš„æˆæœ¬æœ€ä½ã€‚</li><li>å‡è®¾è¦ä½¿ç”¨ AOF åšå…¨é‡å¤åˆ¶ï¼Œæ„å‘³ç€å¿…é¡»æ‰“å¼€ AOF åŠŸèƒ½ï¼Œæ‰“å¼€ AOF åŠŸèƒ½å°±è¦é€‰æ‹©æ–‡ä»¶çš„åˆ·ç›˜çš„ç­–ç•¥ï¼Œé€‰æ‹©ä¸å½“ä¼šä¸¥é‡å½±å“ Redis æ€§èƒ½ã€‚è€Œ RDB åªæœ‰åœ¨éœ€è¦å®šæ—¶å¤‡ä»½å’Œä¸»ä»å…¨é‡å¤åˆ¶æ•°æ®æ—¶ï¼Œæ‰ä¼šè§¦å‘ç”Ÿæˆä¸€æ¬¡å¿«ç…§ã€‚è€Œåœ¨å¾ˆå¤šå°±æ˜¯æ•°æ®ä¸æ•æ„Ÿçš„ä¸šåŠ¡åœºæ™¯ï¼Œå…¶å®æ—¶ä¸éœ€è¦å¼€å¯ AOF çš„ã€‚</li></ul><h5 id="3-ä¸ºä»€ä¹ˆæœ‰æ— ç£ç›˜å¤åˆ¶æ¨¡å¼ï¼Ÿ"><a href="#3-ä¸ºä»€ä¹ˆæœ‰æ— ç£ç›˜å¤åˆ¶æ¨¡å¼ï¼Ÿ" class="headerlink" title="3.ä¸ºä»€ä¹ˆæœ‰æ— ç£ç›˜å¤åˆ¶æ¨¡å¼ï¼Ÿ"></a>3.ä¸ºä»€ä¹ˆæœ‰æ— ç£ç›˜å¤åˆ¶æ¨¡å¼ï¼Ÿ</h5><p>Redis é»˜è®¤æ—¶ç£ç›˜å¤åˆ¶ï¼Œä½†æ˜¯å¦‚æœä½¿ç”¨æ¯”è¾ƒä½é€Ÿçš„ç£ç›˜ï¼Œè¿™ç§æ“ä½œä¼šç»™ä¸»æœåŠ¡å™¨å¸¦æ¥æ¯”è¾ƒå¤§çš„å‹åŠ›ã€‚Redisä»2.8.18ç‰ˆæœ¬å¼€å§‹å°è¯•æ”¯æŒæ— ç£ç›˜çš„å¤åˆ¶ã€‚ä½¿ç”¨è¿™ç§è®¾ç½®æ—¶ï¼Œå­è¿›ç¨‹ç›´æ¥å°†RDBé€šè¿‡ç½‘ç»œå‘é€ç»™ä»æœåŠ¡å™¨ï¼Œä¸ä½¿ç”¨ç£ç›˜ä½œä¸ºä¸­é—´å­˜å‚¨ã€‚</p><p><strong>æ— ç£ç›˜å¤åˆ¶æ¨¡å¼</strong>ï¼šmasteråˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹ç›´æ¥dump RDBåˆ°slaveçš„socketï¼Œä¸ç»è¿‡ä¸»è¿›ç¨‹ï¼Œä¸ç»è¿‡ç¡¬ç›˜ã€‚é€‚ç”¨äºdiskè¾ƒæ…¢ï¼Œå¹¶ä¸”ç½‘ç»œè¾ƒå¿«çš„æ—¶å€™ã€‚</p><p>ä½¿ç”¨repl-diskless-syncé…ç½®å‚æ•°æ¥å¯åŠ¨æ— ç£ç›˜å¤åˆ¶ã€‚</p><p>ä½¿ç”¨repl-diskless-sync-delay å‚æ•°æ¥é…ç½®ä¼ è¾“å¼€å§‹çš„å»¶è¿Ÿæ—¶é—´ï¼›masterç­‰å¾…ä¸€ä¸ªrepl-diskless-sync-delayçš„ç§’æ•°ï¼Œå¦‚æœæ²¡slaveæ¥çš„è¯ï¼Œå°±ç›´æ¥ä¼ ï¼Œåæ¥çš„å¾—æ’é˜Ÿç­‰äº†; å¦åˆ™å°±å¯ä»¥ä¸€èµ·ä¼ ã€‚</p><h5 id="4-ä¸ºä»€ä¹ˆè¿˜æœ‰-ä»åº“çš„ä»åº“çš„è®¾è®¡ï¼Ÿ"><a href="#4-ä¸ºä»€ä¹ˆè¿˜æœ‰-ä»åº“çš„ä»åº“çš„è®¾è®¡ï¼Ÿ" class="headerlink" title="4.ä¸ºä»€ä¹ˆè¿˜æœ‰ ä»åº“çš„ä»åº“çš„è®¾è®¡ï¼Ÿ"></a>4.ä¸ºä»€ä¹ˆè¿˜æœ‰ ä»åº“çš„ä»åº“çš„è®¾è®¡ï¼Ÿ</h5><p>é€šè¿‡åˆ†æä¸»ä»åº“é—´ç¬¬ä¸€æ¬¡æ•°æ®åŒæ­¥çš„è¿‡ç¨‹ï¼Œä½ å¯ä»¥çœ‹åˆ°ï¼Œä¸€æ¬¡å…¨é‡å¤åˆ¶ä¸­ï¼Œå¯¹äºä¸»åº“æ¥è¯´ï¼Œéœ€è¦å®Œæˆä¸¤ä¸ªè€—æ—¶çš„æ“ä½œï¼š<strong>ç”Ÿæˆ RDB æ–‡ä»¶å’Œä¼ è¾“ RDB æ–‡ä»¶</strong>ã€‚</p><p>å¦‚æœä»åº“æ•°é‡å¾ˆå¤šï¼Œè€Œä¸”éƒ½è¦å’Œä¸»åº“è¿›è¡Œå…¨é‡å¤åˆ¶çš„è¯ï¼Œå°±ä¼šå¯¼è‡´ä¸»åº“å¿™äº fork å­è¿›ç¨‹ç”Ÿæˆ RDB æ–‡ä»¶ï¼Œè¿›è¡Œæ•°æ®å…¨é‡å¤åˆ¶ã€‚fork è¿™ä¸ªæ“ä½œä¼šé˜»å¡ä¸»çº¿ç¨‹å¤„ç†æ­£å¸¸è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´ä¸»åº“å“åº”åº”ç”¨ç¨‹åºçš„è¯·æ±‚é€Ÿåº¦å˜æ…¢ã€‚æ­¤å¤–ï¼Œä¼ è¾“ RDB æ–‡ä»¶ä¹Ÿä¼šå ç”¨ä¸»åº“çš„ç½‘ç»œå¸¦å®½ï¼ŒåŒæ ·ä¼šç»™ä¸»åº“çš„èµ„æºä½¿ç”¨å¸¦æ¥å‹åŠ›ã€‚é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰å¥½çš„è§£å†³æ–¹æ³•å¯ä»¥åˆ†æ‹…ä¸»åº“å‹åŠ›å‘¢ï¼Ÿ</p><p>å…¶å®æ˜¯æœ‰çš„ï¼Œè¿™å°±æ˜¯â€œä¸» - ä» - ä»â€æ¨¡å¼ã€‚</p><p>åœ¨åˆšæ‰ä»‹ç»çš„ä¸»ä»åº“æ¨¡å¼ä¸­ï¼Œæ‰€æœ‰çš„ä»åº“éƒ½æ˜¯å’Œä¸»åº“è¿æ¥ï¼Œæ‰€æœ‰çš„å…¨é‡å¤åˆ¶ä¹Ÿéƒ½æ˜¯å’Œä¸»åº“è¿›è¡Œçš„ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡â€œä¸» - ä» - ä»â€æ¨¡å¼<strong>å°†ä¸»åº“ç”Ÿæˆ RDB å’Œä¼ è¾“ RDB çš„å‹åŠ›ï¼Œä»¥çº§è”çš„æ–¹å¼åˆ†æ•£åˆ°ä»åº“ä¸Š</strong>ã€‚</p><p>ç®€å•æ¥è¯´ï¼Œæˆ‘ä»¬åœ¨éƒ¨ç½²ä¸»ä»é›†ç¾¤çš„æ—¶å€™ï¼Œå¯ä»¥æ‰‹åŠ¨é€‰æ‹©ä¸€ä¸ªä»åº“ï¼ˆæ¯”å¦‚é€‰æ‹©å†…å­˜èµ„æºé…ç½®è¾ƒé«˜çš„ä»åº“ï¼‰ï¼Œç”¨äºçº§è”å…¶ä»–çš„ä»åº“ã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥å†é€‰æ‹©ä¸€äº›ä»åº“ï¼ˆä¾‹å¦‚ä¸‰åˆ†ä¹‹ä¸€çš„ä»åº“ï¼‰ï¼Œåœ¨è¿™äº›ä»åº“ä¸Šæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œè®©å®ƒä»¬å’Œåˆšæ‰æ‰€é€‰çš„ä»åº“ï¼Œå»ºç«‹èµ·ä¸»ä»å…³ç³»ã€‚</p><p>replicaof æ‰€é€‰ä»åº“çš„IP 6379</p><p>è¿™æ ·ä¸€æ¥ï¼Œè¿™äº›ä»åº“å°±ä¼šçŸ¥é“ï¼Œåœ¨è¿›è¡ŒåŒæ­¥æ—¶ï¼Œä¸ç”¨å†å’Œä¸»åº“è¿›è¡Œäº¤äº’äº†ï¼Œåªè¦å’Œçº§è”çš„ä»åº“è¿›è¡Œå†™æ“ä½œåŒæ­¥å°±è¡Œäº†ï¼Œè¿™å°±å¯ä»¥å‡è½»ä¸»åº“ä¸Šçš„å‹åŠ›ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779133018-6c82f9a9-6735-48d3-953f-9a4410adf454-20250605100846437.jpeg" alt="img"></p><p>çº§è”çš„â€œä¸»-ä»-ä»â€æ¨¡å¼å¥½äº†ï¼Œåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬äº†è§£äº†ä¸»ä»åº“é—´é€šè¿‡å…¨é‡å¤åˆ¶å®ç°æ•°æ®åŒæ­¥çš„è¿‡ç¨‹ï¼Œä»¥åŠé€šè¿‡â€œä¸» - ä» - ä»â€æ¨¡å¼åˆ†æ‹…ä¸»åº“å‹åŠ›çš„æ–¹å¼ã€‚é‚£ä¹ˆï¼Œä¸€æ—¦ä¸»ä»åº“å®Œæˆäº†å…¨é‡å¤åˆ¶ï¼Œå®ƒä»¬ä¹‹é—´å°±ä¼šä¸€ç›´ç»´æŠ¤ä¸€ä¸ªç½‘ç»œè¿æ¥ï¼Œä¸»åº“ä¼šé€šè¿‡è¿™ä¸ªè¿æ¥å°†åç»­é™†ç»­æ”¶åˆ°çš„å‘½ä»¤æ“ä½œå†åŒæ­¥ç»™ä»åº“ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¹Ÿç§°ä¸ºåŸºäºé•¿è¿æ¥çš„å‘½ä»¤ä¼ æ’­ï¼Œå¯ä»¥é¿å…é¢‘ç¹å»ºç«‹è¿æ¥çš„å¼€é”€ã€‚</p><h5 id="5-è¯»å†™åˆ†ç¦»åŠå…¶ä¸­çš„é—®é¢˜"><a href="#5-è¯»å†™åˆ†ç¦»åŠå…¶ä¸­çš„é—®é¢˜" class="headerlink" title="5.è¯»å†™åˆ†ç¦»åŠå…¶ä¸­çš„é—®é¢˜"></a>5.è¯»å†™åˆ†ç¦»åŠå…¶ä¸­çš„é—®é¢˜</h5><p>åœ¨ä¸»ä»å¤åˆ¶åŸºç¡€ä¸Šå®ç°çš„è¯»å†™åˆ†ç¦»ï¼Œå¯ä»¥å®ç° Redis çš„è¯»è´Ÿè½½å‡è¡¡ï¼šç”±ä¸»èŠ‚ç‚¹æä¾›å†™æœåŠ¡ï¼Œç”±ä¸€ä¸ªæˆ–è€…å¤šä¸ªä»èŠ‚ç‚¹æä¾›è¯»æœåŠ¡ï¼ˆå¤šä¸ªä»èŠ‚ç‚¹æ—¢å¯ä»¥æä¾›æ•°æ®å†—ä½™ç¨‹åº¦ï¼Œä¹Ÿå¯ä»¥æœ€å¤§åŒ–è¯»è´Ÿè½½èƒ½åŠ›ï¼‰ï¼›åœ¨è¯»è´Ÿè½½è¾ƒå¤§çš„åº”ç”¨åœºæ™¯ä¸‹ï¼Œå¯ä»¥å¤§å¤§æé«˜ Redis æœåŠ¡å™¨çš„å¹¶å‘é‡ã€‚ä¸‹é¢ä»‹ç»åœ¨ä½¿ç”¨ Redis è¯»å†™åˆ†ç¦»æ—¶ï¼Œéœ€è¦æ³¨æ„çš„é—®é¢˜ï¼š</p><ul><li><strong>å»¶è¿Ÿä¸ä¸ä¸€è‡´é—®é¢˜</strong></li></ul><p>å‰é¢å·²ç»è®²åˆ°ï¼Œç”±äºä¸»ä»å¤åˆ¶çš„å‘½ä»¤ä¼ æ’­æ˜¯å¼‚æ­¥çš„ï¼Œå»¶è¿Ÿä¸æ•°æ®çš„ä¸ä¸€è‡´ä¸å¯é¿å…ã€‚å¦‚æœåº”ç”¨å¯¹æ•°æ®ä¸ä¸€è‡´çš„æ¥å—ç¨‹åº¦ç¨‹åº¦è¾ƒä½ï¼Œå¯èƒ½çš„ä¼˜åŒ–æªæ–½åŒ…æ‹¬ï¼šä¼˜åŒ–ä¸»ä»èŠ‚ç‚¹ä¹‹é—´çš„ç½‘ç»œç¯å¢ƒï¼ˆå¦‚åœ¨åŒæœºæˆ¿éƒ¨ç½²ï¼‰ï¼›ç›‘æ§ä¸»ä»èŠ‚ç‚¹å»¶è¿Ÿï¼ˆé€šè¿‡offsetï¼‰åˆ¤æ–­ï¼Œå¦‚æœä»èŠ‚ç‚¹å»¶è¿Ÿè¿‡å¤§ï¼Œé€šçŸ¥åº”ç”¨ä¸å†é€šè¿‡è¯¥ä»èŠ‚ç‚¹è¯»å–æ•°æ®ï¼›ä½¿ç”¨é›†ç¾¤åŒæ—¶æ‰©å±•å†™è´Ÿè½½å’Œè¯»è´Ÿè½½ç­‰ã€‚</p><p>åœ¨å‘½ä»¤ä¼ æ’­é˜¶æ®µä»¥å¤–çš„å…¶ä»–æƒ…å†µä¸‹ï¼Œä»èŠ‚ç‚¹çš„æ•°æ®ä¸ä¸€è‡´å¯èƒ½æ›´åŠ ä¸¥é‡ï¼Œä¾‹å¦‚è¿æ¥åœ¨æ•°æ®åŒæ­¥é˜¶æ®µï¼Œæˆ–ä»èŠ‚ç‚¹å¤±å»ä¸ä¸»èŠ‚ç‚¹çš„è¿æ¥æ—¶ç­‰ã€‚ä»èŠ‚ç‚¹çš„slave-serve-stale-dataå‚æ•°ä¾¿ä¸æ­¤æœ‰å…³ï¼šå®ƒæ§åˆ¶è¿™ç§æƒ…å†µä¸‹ä»èŠ‚ç‚¹çš„è¡¨ç°ï¼›å¦‚æœä¸ºyesï¼ˆé»˜è®¤å€¼ï¼‰ï¼Œåˆ™ä»èŠ‚ç‚¹ä»èƒ½å¤Ÿå“åº”å®¢æˆ·ç«¯çš„å‘½ä»¤ï¼Œå¦‚æœä¸ºnoï¼Œåˆ™ä»èŠ‚ç‚¹åªèƒ½å“åº”infoã€slaveofç­‰å°‘æ•°å‘½ä»¤ã€‚è¯¥å‚æ•°çš„è®¾ç½®ä¸åº”ç”¨å¯¹æ•°æ®ä¸€è‡´æ€§çš„è¦æ±‚æœ‰å…³ï¼›å¦‚æœå¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚å¾ˆé«˜ï¼Œåˆ™åº”è®¾ç½®ä¸ºnoã€‚</p><ul><li><strong>æ•°æ®è¿‡æœŸé—®é¢˜</strong></li></ul><p>åœ¨å•æœºç‰ˆRedisä¸­ï¼Œå­˜åœ¨ä¸¤ç§åˆ é™¤ç­–ç•¥ï¼š</p><ul><li>æƒ°æ€§åˆ é™¤ï¼šæœåŠ¡å™¨ä¸ä¼šä¸»åŠ¨åˆ é™¤æ•°æ®ï¼Œåªæœ‰å½“å®¢æˆ·ç«¯æŸ¥è¯¢æŸä¸ªæ•°æ®æ—¶ï¼ŒæœåŠ¡å™¨åˆ¤æ–­è¯¥æ•°æ®æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸåˆ™åˆ é™¤ã€‚</li><li>å®šæœŸåˆ é™¤ï¼šæœåŠ¡å™¨æ‰§è¡Œå®šæ—¶ä»»åŠ¡åˆ é™¤è¿‡æœŸæ•°æ®ï¼Œä½†æ˜¯è€ƒè™‘åˆ°å†…å­˜å’ŒCPUçš„æŠ˜ä¸­ï¼ˆåˆ é™¤ä¼šé‡Šæ”¾å†…å­˜ï¼Œä½†æ˜¯é¢‘ç¹çš„åˆ é™¤æ“ä½œå¯¹CPUä¸å‹å¥½ï¼‰ï¼Œè¯¥åˆ é™¤çš„é¢‘ç‡å’Œæ‰§è¡Œæ—¶é—´éƒ½å—åˆ°äº†é™åˆ¶ã€‚</li></ul><p>åœ¨ä¸»ä»å¤åˆ¶åœºæ™¯ä¸‹ï¼Œä¸ºäº†ä¸»ä»èŠ‚ç‚¹çš„æ•°æ®ä¸€è‡´æ€§ï¼Œä»èŠ‚ç‚¹ä¸ä¼šä¸»åŠ¨åˆ é™¤æ•°æ®ï¼Œè€Œæ˜¯ç”±ä¸»èŠ‚ç‚¹æ§åˆ¶ä»èŠ‚ç‚¹ä¸­è¿‡æœŸæ•°æ®çš„åˆ é™¤ã€‚ç”±äºä¸»èŠ‚ç‚¹çš„æƒ°æ€§åˆ é™¤å’Œå®šæœŸåˆ é™¤ç­–ç•¥ï¼Œéƒ½ä¸èƒ½ä¿è¯ä¸»èŠ‚ç‚¹åŠæ—¶å¯¹è¿‡æœŸæ•°æ®æ‰§è¡Œåˆ é™¤æ“ä½œï¼Œå› æ­¤ï¼Œå½“å®¢æˆ·ç«¯é€šè¿‡Redisä»èŠ‚ç‚¹è¯»å–æ•°æ®æ—¶ï¼Œå¾ˆå®¹æ˜“è¯»å–åˆ°å·²ç»è¿‡æœŸçš„æ•°æ®ã€‚</p><p>Redis 3.2ä¸­ï¼Œä»èŠ‚ç‚¹åœ¨è¯»å–æ•°æ®æ—¶ï¼Œå¢åŠ äº†å¯¹æ•°æ®æ˜¯å¦è¿‡æœŸçš„åˆ¤æ–­ï¼šå¦‚æœè¯¥æ•°æ®å·²è¿‡æœŸï¼Œåˆ™ä¸è¿”å›ç»™å®¢æˆ·ç«¯ï¼›å°†Rediså‡çº§åˆ°3.2å¯ä»¥è§£å†³æ•°æ®è¿‡æœŸé—®é¢˜ã€‚</p><ul><li><strong>æ•…éšœåˆ‡æ¢é—®é¢˜</strong></li></ul><p>åœ¨æ²¡æœ‰ä½¿ç”¨å“¨å…µçš„è¯»å†™åˆ†ç¦»åœºæ™¯ä¸‹ï¼Œåº”ç”¨é’ˆå¯¹è¯»å’Œå†™åˆ†åˆ«è¿æ¥ä¸åŒçš„RedisèŠ‚ç‚¹ï¼›å½“ä¸»èŠ‚ç‚¹æˆ–ä»èŠ‚ç‚¹å‡ºç°é—®é¢˜è€Œå‘ç”Ÿæ›´æ”¹æ—¶ï¼Œéœ€è¦åŠæ—¶ä¿®æ”¹åº”ç”¨ç¨‹åºè¯»å†™Redisæ•°æ®çš„è¿æ¥ï¼›è¿æ¥çš„åˆ‡æ¢å¯ä»¥æ‰‹åŠ¨è¿›è¡Œï¼Œæˆ–è€…è‡ªå·±å†™ç›‘æ§ç¨‹åºè¿›è¡Œåˆ‡æ¢ï¼Œä½†å‰è€…å“åº”æ…¢ã€å®¹æ˜“å‡ºé”™ï¼Œåè€…å®ç°å¤æ‚ï¼Œæˆæœ¬éƒ½ä¸ç®—ä½ã€‚</p><ul><li><strong>æ€»ç»“</strong></li></ul><p>åœ¨ä½¿ç”¨è¯»å†™åˆ†ç¦»ä¹‹å‰ï¼Œå¯ä»¥è€ƒè™‘å…¶ä»–æ–¹æ³•å¢åŠ Redisçš„è¯»è´Ÿè½½èƒ½åŠ›ï¼šå¦‚å°½é‡ä¼˜åŒ–ä¸»èŠ‚ç‚¹ï¼ˆå‡å°‘æ…¢æŸ¥è¯¢ã€å‡å°‘æŒä¹…åŒ–ç­‰å…¶ä»–æƒ…å†µå¸¦æ¥çš„é˜»å¡ç­‰ï¼‰æé«˜è´Ÿè½½èƒ½åŠ›ï¼›ä½¿ç”¨Redisé›†ç¾¤åŒæ—¶æé«˜è¯»è´Ÿè½½èƒ½åŠ›å’Œå†™è´Ÿè½½èƒ½åŠ›ç­‰ã€‚å¦‚æœä½¿ç”¨è¯»å†™åˆ†ç¦»ï¼Œå¯ä»¥ä½¿ç”¨å“¨å…µï¼Œä½¿ä¸»ä»èŠ‚ç‚¹çš„æ•…éšœåˆ‡æ¢å°½å¯èƒ½è‡ªåŠ¨åŒ–ï¼Œå¹¶å‡å°‘å¯¹åº”ç”¨ç¨‹åºçš„ä¾µå…¥ã€‚</p><h3 id="5-8-Redisé›†ç¾¤æ¨¡å¼â€”-å“¨å…µæœºåˆ¶ï¼ˆRedis-Sentinelï¼‰"><a href="#5-8-Redisé›†ç¾¤æ¨¡å¼â€”-å“¨å…µæœºåˆ¶ï¼ˆRedis-Sentinelï¼‰" class="headerlink" title="5.8 Redisé›†ç¾¤æ¨¡å¼â€” å“¨å…µæœºåˆ¶ï¼ˆRedis Sentinelï¼‰"></a>5.8 Redisé›†ç¾¤æ¨¡å¼â€” å“¨å…µæœºåˆ¶ï¼ˆRedis Sentinelï¼‰</h3><p>åœ¨ä¸Šæ–‡ä¸»ä»å¤åˆ¶çš„åŸºç¡€ä¸Šï¼Œå¦‚æœèŠ‚ç‚¹å‡ºç°æ•…éšœè¯¥æ€ä¹ˆåŠï¼Ÿåœ¨ Redis é›†ç¾¤ä¸­ï¼Œå“¨å…µæœºåˆ¶æ˜¯å®ç°ä¸»ä»åº“è‡ªåŠ¨åˆ‡æ¢çš„å…³é”®æœºåˆ¶ï¼Œå®ƒæœ‰æ•ˆçš„è§£å†³äº†ä¸»ä»å¤åˆ¶æ¨¡å¼ä¸‹çš„æ•…éšœè½¬ç§»çš„é—®é¢˜ã€‚å…¶ä¸Redis2.8ç‰ˆæœ¬å¼€å§‹å¼•ç”¨ã€‚</p><p><a href="https://xie.infoq.cn/article/f6a8c0c5218394d56f4ae329b">https://xie.infoq.cn/article/f6a8c0c5218394d56f4ae329b</a></p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779133444-1385070f-a6ee-4915-83e1-ec451d704df0-20250605100839770.png" alt="img"></p><p><strong>å“¨å…µæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹ï¼Œä½œä¸ºè¿›ç¨‹ï¼Œå®ƒä¼šç‹¬ç«‹è¿è¡Œå…¶åŸç†æ˜¯å“¨å…µé€šè¿‡å‘é€å‘½ä»¤ï¼Œç­‰å¾…RedisæœåŠ¡å™¨å“åº”ï¼Œä»è€Œç›‘æ§è¿è¡Œçš„å¤šä¸ª Redis å®ä¾‹</strong></p><p>å“¨å…µå®ç°äº†ä»€ä¹ˆåŠŸèƒ½å‘¢ï¼Ÿä¸‹é¢æ˜¯ Redis å®˜æ–¹æ–‡æ¡£çš„æè¿°ï¼š</p><ul><li><strong>ç›‘æ§ï¼ˆMonitoringï¼‰</strong>ï¼šå“¨å…µä¼šä¸æ–­åœ°æ£€æŸ¥ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹æ˜¯å¦è¿ä½œæ­£å¸¸ã€‚</li><li><strong>è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼ˆAutomatic failoverï¼‰</strong>ï¼šå½“ä¸»èŠ‚ç‚¹ä¸èƒ½æ­£å¸¸å·¥ä½œæ—¶ï¼Œå“¨å…µä¼šå¼€å§‹è‡ªåŠ¨æ•…éšœè½¬ç§»æ“ä½œï¼Œå®ƒä¼šå°†å¤±æ•ˆä¸»èŠ‚ç‚¹çš„å…¶ä¸­ä¸€ä¸ªä»èŠ‚ç‚¹å‡çº§ä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œå¹¶è®©å…¶ä»–ä»èŠ‚ç‚¹æ”¹ä¸ºå¤åˆ¶æ–°çš„ä¸»èŠ‚ç‚¹ã€‚</li><li><strong>é…ç½®æä¾›è€…ï¼ˆConfiguration providerï¼‰</strong>ï¼šå®¢æˆ·ç«¯åœ¨åˆå§‹åŒ–æ—¶ï¼Œé€šè¿‡è¿æ¥å“¨å…µæ¥è·å¾—å½“å‰RedisæœåŠ¡çš„ä¸»èŠ‚ç‚¹åœ°å€ã€‚</li><li><strong>é€šçŸ¥ï¼ˆNotificationï¼‰</strong>ï¼šå“¨å…µå¯ä»¥å°†æ•…éšœè½¬ç§»çš„ç»“æœå‘é€ç»™å®¢æˆ·ç«¯ã€‚</li></ul><p>å…¶ä¸­ï¼Œç›‘æ§å’Œè‡ªåŠ¨æ•…éšœè½¬ç§»åŠŸèƒ½ï¼Œä½¿å¾—å“¨å…µå¯ä»¥åŠæ—¶å‘ç°ä¸»èŠ‚ç‚¹æ•…éšœå¹¶å®Œæˆè½¬ç§»ï¼›è€Œé…ç½®æä¾›è€…å’Œé€šçŸ¥åŠŸèƒ½ï¼Œåˆ™éœ€è¦åœ¨ä¸å®¢æˆ·ç«¯çš„äº¤äº’ä¸­æ‰èƒ½ä½“ç°ã€‚</p><h4 id="5-8-1-å“¨å…µé›†ç¾¤çš„æ­å»º"><a href="#5-8-1-å“¨å…µé›†ç¾¤çš„æ­å»º" class="headerlink" title="5.8.1 å“¨å…µé›†ç¾¤çš„æ­å»º"></a>5.8.1 å“¨å…µé›†ç¾¤çš„æ­å»º</h4><p>ä¸Šå›¾ä¸­å“¨å…µé›†ç¾¤å¼å¦‚ä½•ç»„å»ºèµ·æ¥çš„ï¼Ÿå“¨å…µå®ä¾‹ä¹‹é—´ç›¸äº’å‘ç°ï¼Œè¦å½’åŠŸäº Redis æä¾›çš„ pub&#x2F;sub æœºåˆ¶ï¼Œå³ å‘å¸ƒ&#x2F;è®¢é˜…æœºåˆ¶</p><p>åœ¨ä¸»ä»é›†ç¾¤ä¸­ï¼Œä¸»åº“ä¸Šç”±ä¸€ä¸ªåä¸º <strong>sentinel</strong>:hello çš„é¢‘é“ï¼Œä¸åŒå“¨å…µå°±æ˜¯é€šè¿‡å®ƒæ¥ç›¸äº’å‘ç°ï¼Œå®ç°äº’ç›¸é€šä¿¡çš„ã€‚åœ¨ä¸‹å›¾ï¼Œå“¨å…µ1æŠŠè‡ªå·±çš„ IPï¼ˆ172.16.19.3ï¼‰å’Œç«¯å£ï¼ˆ26579ï¼‰å‘å¸ƒåˆ°__sentinel__:helloé¢‘é“ä¸Šï¼Œå“¨å…µ2å’Œ3è®¢é˜…äº†è¯¥é¢‘é“ã€‚é‚£ä¹ˆæ­¤æ—¶ï¼Œå“¨å…µ2å’Œ3å°±å¯ä»¥ä»è¿™ä¸ªé¢‘é“ç›´æ¥è·å–å“¨å…µ1çš„ IP åœ°å€å’Œç«¯å£å·ã€‚ç„¶åï¼Œå“¨å…µ2ã€3å¯ä»¥å’Œå“¨å…µ1å»ºç«‹ç½‘ç»œè¿æ¥ã€‚</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779137211-0ab99635-9d14-4bb2-a004-b883c255b4df-20250605100831797.jpeg" alt="img"></p><p>é€šè¿‡è¿™ä¸ªæ–¹å¼ï¼Œå“¨å…µ2ã€3ä¹Ÿå¯ä»¥å»ºç«‹ç½‘ç»œè¿æ¥ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå“¨å…µé›†ç¾¤å°±å½¢æˆäº†ã€‚å®ƒä»¬ç›¸äº’é—´å¯ä»¥é€šè¿‡ç½‘ç»œè¿æ¥è¿›è¡Œé€šä¿¡ï¼Œæ¯”å¦‚è¯´å¯¹ä¸»åº“æœ‰æ²¡æœ‰ä¸‹çº¿è¿™ä»¶äº‹å„¿è¿›è¡Œåˆ¤æ–­å’Œåå•†ã€‚</p><h4 id="5-8-2-å“¨å…µç›‘æ§-Redis-åº“"><a href="#5-8-2-å“¨å…µç›‘æ§-Redis-åº“" class="headerlink" title="5.8.2 å“¨å…µç›‘æ§ Redis åº“"></a>5.8.2 å“¨å…µç›‘æ§ Redis åº“</h4><p>å“¨å…µç›‘æ§ä»€ä¹ˆï¼Ÿå¹¶ä¸”å¦‚ä½•å®Œæˆç›‘æ§çš„ï¼Ÿ</p><p>è¿™æ˜¯ç”±å“¨å…µå‘ä¸»åº“å‘é€ INFOå‘½ä»¤å®Œæˆçš„ã€‚å¦‚ä¸‹å›¾ï¼Œå“¨å…µ2ç»™ä¸»åº“å‘é€ INFOå‘½ä»¤ï¼Œä¸»åº“æ¥å—åˆ°è¿™ä¸ªå‘½ä»¤åï¼Œå°±ä¼šæŠŠä»åº“åˆ—è¡¨è¿”å›ç»™å“¨å…µã€‚æ¥ç€ï¼Œå“¨å…µå°±å¯ä»¥æ ¹æ®ä»åº“åˆ—è¡¨ä¸­çš„è¿æ¥ä¿¡æ¯ï¼Œå’Œæ¯ä¸ªä»åº“å»ºç«‹è¿æ¥ï¼Œå¹¶åœ¨è¿™ä¸ªè¿æ¥ä¸ŠæŒç»­çš„å¯¹ä»åº“è¿›è¡Œç›‘æ§ã€‚å“¨å…µ1å’Œ3 å¯ä»¥é€šè¿‡ç›¸åŒçš„æ–¹æ³•å’Œä»åº“å»ºç«‹è¿æ¥ã€‚</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779137974-8096b7fe-4c89-4541-99ac-b892ab0c5489-20250605100826937.jpeg" alt="img"></p><p>å“¨å…µçš„å·¥ä½œå†…å®¹ï¼š</p><ul><li><strong>æ¯ä¸ª Sentinel ä»¥æ¯ç§’é’Ÿä¸€æ¬¡çš„é¢‘ç‡å‘å®ƒæ‰€çŸ¥çš„ Masterï¼ŒSlave ä»¥åŠå…¶ä»– Sentinel å®ä¾‹å‘é€ä¸€ä¸ª PING å‘½ä»¤</strong>ã€‚(<strong>å¿ƒè·³æœºåˆ¶</strong>)</li><li><strong>å¦‚æœä¸€ä¸ªå®ä¾‹ï¼ˆinstanceï¼‰è·ç¦»æœ€åä¸€æ¬¡æœ‰æ•ˆå›å¤ PING å‘½ä»¤çš„æ—¶é—´è¶…è¿‡ down-after-milliseconds é€‰é¡¹æ‰€æŒ‡å®šçš„å€¼ï¼Œ åˆ™è¿™ä¸ªå®ä¾‹ä¼šè¢« Sentinel æ ‡è®°ä¸ºä¸»è§‚ä¸‹çº¿</strong>ã€‚</li><li><strong>å¦‚æœä¸€ä¸ª Master è¢«æ ‡è®°ä¸ºä¸»è§‚ä¸‹çº¿ï¼Œåˆ™æ­£åœ¨ç›‘è§†è¿™ä¸ª Master çš„æ‰€æœ‰ Sentinel è¦ä»¥æ¯ç§’ä¸€æ¬¡çš„é¢‘ç‡ç¡®è®¤ Master çš„ç¡®è¿›å…¥äº†ä¸»è§‚ä¸‹çº¿çŠ¶æ€</strong>ã€‚ï¼ˆ<strong>ç¡®è®¤æŠ•ç¥¨ä¸‹çº¿</strong>ï¼‰</li><li><strong>å½“æœ‰è¶³å¤Ÿæ•°é‡çš„ Sentinelï¼ˆå¤§äºç­‰äºé…ç½®æ–‡ä»¶æŒ‡å®šçš„å€¼ï¼‰åœ¨æŒ‡å®šçš„æ—¶é—´èŒƒå›´å†…ç¡®è®¤ Master çš„ç¡®è¿›å…¥äº†ä¸»è§‚ä¸‹çº¿çŠ¶æ€ï¼Œ åˆ™ Master ä¼šè¢«æ ‡è®°ä¸ºå®¢è§‚ä¸‹çº¿</strong> ã€‚</li><li><strong>åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ æ¯ä¸ª Sentinel ä¼šä»¥æ¯ 10 ç§’ä¸€æ¬¡çš„é¢‘ç‡å‘å®ƒå·²çŸ¥çš„æ‰€æœ‰ Masterï¼ŒSlave å‘é€ INFO å‘½ä»¤</strong>ã€‚ï¼ˆåŒæ­¥æ•°æ®ï¼‰</li><li><strong>å½“ Master è¢« Sentinel æ ‡è®°ä¸ºå®¢è§‚ä¸‹çº¿æ—¶ï¼ŒSentinel å‘ä¸‹çº¿çš„ Master çš„æ‰€æœ‰ Slave å‘é€ INFO å‘½ä»¤çš„é¢‘ç‡ä¼šä» 10 ç§’ä¸€æ¬¡æ”¹ä¸ºæ¯ç§’ä¸€æ¬¡</strong>ã€‚</li><li><strong>è‹¥æ²¡æœ‰è¶³å¤Ÿæ•°é‡çš„ Sentinel åŒæ„ Master å·²ç»ä¸‹çº¿ï¼Œ Master çš„å®¢è§‚ä¸‹çº¿çŠ¶æ€å°±ä¼šè¢«ç§»é™¤</strong>ã€‚</li><li><strong>è‹¥ Master é‡æ–°å‘ Sentinel çš„ PING å‘½ä»¤è¿”å›æœ‰æ•ˆå›å¤ï¼Œ Master çš„ä¸»è§‚ä¸‹çº¿çŠ¶æ€å°±ä¼šè¢«ç§»é™¤</strong>ã€‚</li></ul><h4 id="5-8-3-ä¸»åº“ä¸‹çº¿çš„åˆ¤å®š"><a href="#5-8-3-ä¸»åº“ä¸‹çº¿çš„åˆ¤å®š" class="headerlink" title="5.8.3 ä¸»åº“ä¸‹çº¿çš„åˆ¤å®š"></a>5.8.3 ä¸»åº“ä¸‹çº¿çš„åˆ¤å®š</h4><p>å“¨å…µå¦‚ä½•åˆ¤æ–­ä¸»åº“å·²ç»ä¸‹çº¿äº†ï¼Ÿ</p><p>é¦–å…ˆè¦åŒºåˆ«ä¸¤ä¸ªæ¦‚å¿µï¼š</p><ul><li>ä¸»è§‚ä¸‹çº¿ï¼šä»»ä½•ä¸€ä¸ªå“¨å…µéƒ½æ˜¯å¯ä»¥ç›‘æ§æ¢æµ‹ï¼Œå¹¶ä½œå‡º Redis ä¸‹çº¿çš„åˆ¤æ–­</li><li>å®¢è§‚ä¸‹çº¿ï¼šæœ‰å“¨å…µé›†ç¾¤å…±åŒå†³å®š Redis èŠ‚ç‚¹æ˜¯å¦ä¸‹çº¿</li></ul><p>å½“æŸä¸ªå“¨å…µ åˆ¤æ–­ä¸»åº“ â€œä¸»è§‚ä¸‹çº¿â€åï¼Œå°±ä¼šç»™å…¶ä»–å“¨å…µå‘é€ is-master-down-by-addrå‘½ä»¤ã€‚æ¥ç€ï¼Œå…¶ä»–å“¨å…µä¼šæ ¹æ®è‡ªå·±å’Œä¸»åº“çš„è¿æ¥æƒ…å†µï¼Œåšå‡º Y æˆ– N çš„å“åº”ï¼ŒYç›¸å½“äºèµæˆç¥¨ï¼ŒNç›¸å½“äºåå¯¹ç¥¨ã€‚å¦‚æœèµæˆç¥¨æ•°æ˜¯å¤§äºç­‰äº å“¨å…µé…ç½®æ–‡ä»¶ä¸­çš„ quorum é…ç½®é¡¹ï¼ˆæ¯”å¦‚è¿™é‡Œå¦‚æœ quorum &#x3D; 2ï¼‰ï¼Œåˆ™å°±å¯ä»¥åˆ¤å®š ä¸»åº“å®¢è§‚ä¸‹çº¿äº†ã€‚</p><h4 id="5-8-4-å“¨å…µé›†ç¾¤çš„é€‰ä¸¾"><a href="#5-8-4-å“¨å…µé›†ç¾¤çš„é€‰ä¸¾" class="headerlink" title="5.8.4 å“¨å…µé›†ç¾¤çš„é€‰ä¸¾"></a>5.8.4 å“¨å…µé›†ç¾¤çš„é€‰ä¸¾</h4><p>åˆ¤æ–­å®Œä¸»åº“ä¸‹çº¿åï¼Œç”±å“ªä¸ªå“¨å…µèŠ‚ç‚¹æ¥æ‰§è¡Œä¸»ä»åˆ‡æ¢å‘¢ï¼Ÿè¿™é‡Œå°±éœ€è¦å“¨å…µé›†ç¾¤çš„é€‰ä¸¾æœºåˆ¶äº†</p><ul><li>ä¸ºä»€ä¹ˆå¿…ç„¶ä¼šå‡ºç° é€‰ä¸¾&#x2F;å…±è¯† æœºåˆ¶ï¼Ÿä¸ºäº†é¿å…å“¨å…µçš„å•ç‚¹æƒ…å†µå‘ç”Ÿï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªå“¨å…µçš„åˆ†å¸ƒå¼é›†ç¾¤ã€‚ä½œä¸ºåˆ†å¸ƒå¼é›†ç¾¤ï¼Œå¿…ç„¶æ¶‰åŠåˆ°å…±è¯†é—®é¢˜ï¼ˆå³é€‰ä¸¾é—®é¢˜ï¼‰</li><li>å“¨å…µçš„é€‰ä¸¾æœºåˆ¶æ˜¯ä»€ä¹ˆæ ·çš„?</li></ul><ol><li><ol><li><strong>å‘ç°ä¸»åº“å®¢è§‚ä¸‹çº¿çš„å“¨å…µèŠ‚ç‚¹ï¼ˆè¿™é‡Œç§°ä¸º Aï¼‰å‘æ¯ä¸ªå“¨å…µèŠ‚ç‚¹å‘é€å‘½ä»¤è¦æ±‚å¯¹æ–¹é€‰ä¸¾è‡ªå·±ä¸ºé¢†å¤´å“¨å…µï¼ˆleaderï¼‰</strong>ï¼›</li><li><strong>å¦‚æœç›®æ ‡å“¨å…µæ²¡æœ‰é€‰ä¸¾è¿‡å…¶ä»–äººï¼Œåˆ™åŒæ„å°† A é€‰ä¸¾ä¸ºé¢†å¤´å“¨å…µ</strong>ï¼›</li><li><strong>å¦‚æœ A å‘ç°æœ‰è¶…è¿‡åŠæ•°ä¸”è¶…è¿‡ quorum å‚æ•°å€¼çš„å“¨å…µèŠ‚ç‚¹åŒæ„é€‰è‡ªå·±æˆä¸ºé¢†å¤´å“¨å…µï¼Œåˆ™ A å“¨å…µæˆåŠŸé€‰ä¸¾ä¸ºé¢†å¤´å“¨å…µ</strong>ã€‚ã€<strong>sentinel é›†ç¾¤æ‰§è¡Œæ•…éšœè½¬ç§»æ—¶éœ€è¦é€‰ä¸¾ leaderï¼Œæ­¤æ—¶æ¶‰åŠåˆ° majorityï¼Œmajority ä»£è¡¨ sentinel é›†ç¾¤ä¸­å¤§éƒ¨åˆ† sentinel èŠ‚ç‚¹çš„ä¸ªæ•°ï¼Œåªæœ‰å¤§äºç­‰äº max(quorum, majority) ä¸ªèŠ‚ç‚¹ç»™æŸä¸ª sentinel èŠ‚ç‚¹æŠ•ç¥¨ï¼Œæ‰èƒ½ç¡®å®šè¯¥ sentinel èŠ‚ç‚¹ä¸º leaderï¼Œmajority çš„è®¡ç®—æ–¹å¼ä¸ºï¼šnum(sentinels) &#x2F; 2 + 1</strong>ã€‘</li><li><strong>å½“æœ‰å¤šä¸ªå“¨å…µèŠ‚ç‚¹åŒæ—¶å‚ä¸é¢†å¤´å“¨å…µé€‰ä¸¾æ—¶ï¼Œå‡ºç°æ²¡æœ‰ä»»ä½•èŠ‚ç‚¹å½“é€‰å¯èƒ½ï¼Œæ­¤æ—¶æ¯ä¸ªå‚é€‰èŠ‚ç‚¹ç­‰å¾…ä¸€ä¸ªéšæœºæ—¶é—´è¿›è¡Œä¸‹ä¸€è½®é€‰ä¸¾ï¼Œç›´åˆ°é€‰å‡ºé¢†å¤´å“¨å…µ</strong>ã€‚</li></ol></li></ol><ul><li><p>ä»»ä½•ä¸€ä¸ªæƒ³è¦ æ‰§è¡Œ ä¸»ä»åˆ‡æ¢æ“ä½œçš„ å“¨å…µï¼Œè¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š</p></li><li><ul><li>ç¬¬ä¸€ï¼Œæ‹¿åˆ°åŠæ•°ä»¥ä¸Šçš„èµæˆç¥¨ï¼›</li><li>ç¬¬äºŒï¼Œæ‹¿åˆ°çš„ç¥¨æ•°åŒæ—¶è¿˜éœ€è¦å¤§äºç­‰äºå“¨å…µé…ç½®æ–‡ä»¶ä¸­çš„ quorum å€¼ã€‚</li></ul></li></ul><p>ä»¥3ä¸ªå“¨å…µä¸ºä¾‹ï¼Œå‡è®¾æ­¤æ—¶çš„ quorum è®¾ç½®ä¸º2ï¼Œé‚£ä¹ˆï¼Œä»»ä½•ä¸€ä¸ªæƒ³æˆä¸º Leader çš„å“¨å…µåªè¦æ‹¿åˆ° 2å¼ èµæˆç¥¨ï¼Œå°±å¯ä»¥äº†ã€‚</p><p>æ›´è¿›ä¸€æ­¥ç†è§£</p><p>è¿™é‡Œå¾ˆå¤šäººä¼šææ·· åˆ¤å®šå®¢è§‚ä¸‹çº¿ å’Œ æ˜¯å¦èƒ½å¤Ÿä¸»ä»åˆ‡æ¢ï¼ˆç”¨åˆ°é€‰ä¸¾æœºåˆ¶ï¼‰ ä¸¤ä¸ªæ¦‚å¿µï¼Œæˆ‘ä»¬å†çœ‹ä¸€ä¸ªä¾‹å­ã€‚</p><p>Redis 1ä¸»4ä»ï¼Œ5ä¸ªå“¨å…µï¼Œå“¨å…µé…ç½®quorumä¸º2ï¼Œå¦‚æœ3ä¸ªå“¨å…µæ•…éšœï¼Œå½“ä¸»åº“å®•æœºæ—¶ï¼Œå“¨å…µèƒ½å¦åˆ¤æ–­ä¸»åº“â€œå®¢è§‚ä¸‹çº¿â€ï¼Ÿèƒ½å¦è‡ªåŠ¨åˆ‡æ¢</p><p>ç»è¿‡å®é™…æµ‹è¯•ï¼š</p><p>1ã€å“¨å…µé›†ç¾¤å¯ä»¥åˆ¤å®šä¸»åº“â€œä¸»è§‚ä¸‹çº¿â€ã€‚ç”±äºquorum&#x3D;2ï¼Œæ‰€ä»¥å½“ä¸€ä¸ªå“¨å…µåˆ¤æ–­ä¸»åº“â€œä¸»è§‚ä¸‹çº¿â€åï¼Œè¯¢é—®å¦å¤–ä¸€ä¸ªå“¨å…µåä¹Ÿä¼šå¾—åˆ°åŒæ ·çš„ç»“æœï¼Œ2ä¸ªå“¨å…µéƒ½åˆ¤å®šâ€œä¸»è§‚ä¸‹çº¿â€ï¼Œè¾¾åˆ°äº†quorumçš„å€¼ï¼Œå› æ­¤ï¼Œ<strong>å“¨å…µé›†ç¾¤å¯ä»¥åˆ¤å®šä¸»åº“ä¸ºâ€œå®¢è§‚ä¸‹çº¿â€</strong>ã€‚</p><p>2ã€<strong>ä½†å“¨å…µä¸èƒ½å®Œæˆä¸»ä»åˆ‡æ¢</strong>ã€‚å“¨å…µæ ‡è®°ä¸»åº“â€œå®¢è§‚ä¸‹çº¿åâ€ï¼Œåœ¨é€‰ä¸¾â€œå“¨å…µé¢†å¯¼è€…â€æ—¶ï¼Œä¸€ä¸ªå“¨å…µå¿…é¡»æ‹¿åˆ°è¶…è¿‡å¤šæ•°çš„é€‰ç¥¨(5&#x2F;2+1&#x3D;3ç¥¨)ã€‚ä½†ç›®å‰åªæœ‰2ä¸ªå“¨å…µæ´»ç€ï¼Œæ— è®ºæ€ä¹ˆæŠ•ç¥¨ï¼Œä¸€ä¸ªå“¨å…µæœ€å¤šåªèƒ½æ‹¿åˆ°2ç¥¨ï¼Œæ°¸è¿œæ— æ³•è¾¾åˆ°N&#x2F;2+1é€‰ç¥¨çš„ç»“æœã€‚</p><h4 id="5-8-5-æ–°ä¸»åº“çš„é€‰å‡ºã€æ•…éšœè½¬ç§»"><a href="#5-8-5-æ–°ä¸»åº“çš„é€‰å‡ºã€æ•…éšœè½¬ç§»" class="headerlink" title="5.8.5 æ–°ä¸»åº“çš„é€‰å‡ºã€æ•…éšœè½¬ç§»"></a>5.8.5 æ–°ä¸»åº“çš„é€‰å‡ºã€æ•…éšœè½¬ç§»</h4><p>ä¸»åº“æ—¢ç„¶åˆ¤å®šå®¢è§‚ä¸‹çº¿äº†ï¼Œå¹¶ä¸”é€‰ä¸¾å‡ºäº†é¢†å¤´å“¨å…µï¼Œé‚£ä¹ˆå¦‚ä½•ä»å‰©ä½™çš„ slaveèŠ‚ç‚¹ï¼ˆä»åº“ï¼‰ä¸­é€‰æ‹©ä¸€ä¸ªæ–°çš„ä¸»åº“å‘¢ï¼Ÿ</p><ul><li>è¿‡æ»¤æ‰ä¸å¥åº·çš„ï¼ˆä¸‹çº¿æˆ–æ–­çº¿ï¼‰ï¼Œæ²¡æœ‰å›å¤è¿‡å“¨å…µ ping å“åº”çš„ä»èŠ‚ç‚¹</li><li>é€‰æ‹© salve-priorityä»èŠ‚ç‚¹ä¼˜å…ˆçº§æœ€é«˜çš„ï¼ˆredis.confï¼‰</li><li>é€‰æ‹©å¤åˆ¶åç§»é‡æœ€å¤§ï¼ˆå³å¤åˆ¶ä¸»èŠ‚ç‚¹æœ€å®Œæ•´çš„ä»èŠ‚ç‚¹ï¼‰</li></ul><p>æ–°çš„ä¸»åº“é€‰æ‹©å‡ºæ¥äº†ï¼Œå°±å¯ä»¥å¼€å§‹è¿›è¡Œæ•…éšœçš„è½¬ç§»äº†</p><p>å‡è®¾æ ¹æ®æˆ‘ä»¬ä¸€å¼€å§‹çš„å›¾ï¼šï¼ˆæˆ‘ä»¬å‡è®¾ï¼šåˆ¤æ–­ä¸»åº“å®¢è§‚ä¸‹çº¿äº†ï¼ŒåŒæ—¶é€‰å‡ºsentinel 3æ˜¯å“¨å…µleaderï¼‰</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779138232-d32bebb3-1e76-46dc-86d6-36e088a21802-20250605100820125.png" alt="img"></p><p><strong>æ•…éšœè½¬ç§»æµç¨‹å¦‚ä¸‹</strong>ï¼š</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/35838370/1682779138529-f55bef09-55ec-4955-9c4d-5154ed2a03a3.png" alt="img"></p><p>å°†slave-1è„±ç¦»åŸä»èŠ‚ç‚¹ï¼ˆPS: 5.0 ä¸­åº”è¯¥æ˜¯replicaof no one)ï¼Œå‡çº§ä¸»èŠ‚ç‚¹ï¼Œ</p><p>å°†ä»èŠ‚ç‚¹slave-2æŒ‡å‘æ–°çš„ä¸»èŠ‚ç‚¹</p><p>é€šçŸ¥å®¢æˆ·ç«¯ä¸»èŠ‚ç‚¹å·²æ›´æ¢</p><p>å°†åŸä¸»èŠ‚ç‚¹ï¼ˆoldMasterï¼‰å˜æˆä»èŠ‚ç‚¹ï¼ŒæŒ‡å‘æ–°çš„ä¸»èŠ‚ç‚¹</p><h3 id="5-9-Redisé›†ç¾¤æ¨¡å¼-Redis-Clusterï¼ˆé«˜å¯ç”¨é›†ç¾¤ï¼‰"><a href="#5-9-Redisé›†ç¾¤æ¨¡å¼-Redis-Clusterï¼ˆé«˜å¯ç”¨é›†ç¾¤ï¼‰" class="headerlink" title="5.9 Redisé›†ç¾¤æ¨¡å¼-Redis Clusterï¼ˆé«˜å¯ç”¨é›†ç¾¤ï¼‰"></a>5.9 Redisé›†ç¾¤æ¨¡å¼-Redis Clusterï¼ˆé«˜å¯ç”¨é›†ç¾¤ï¼‰</h3><p>å‰é¢ä¸¤èŠ‚ï¼Œä¸»ä»å¤åˆ¶å’Œå“¨å…µæœºåˆ¶ä¿éšœäº†é«˜å¯ç”¨ï¼Œå°±è¯»å†™åˆ†ç¦»è€Œè¨€è™½ç„¶ slave èŠ‚ç‚¹æ‰©å±•äº†ä¸»ä»çš„è¯»å¹¶å‘èƒ½åŠ›ï¼Œä½†æ˜¯å†™èƒ½åŠ›å’Œå­˜å‚¨èƒ½åŠ›æ˜¯æ²¡æœ‰å¾—åˆ°æ‰©å±•ã€‚å¦‚æœé¢å¯¹æµ·é‡æ•°æ®å†™å…¥ï¼Œå°±å¿…é¡»æ„å»º masterï¼ˆä¸»èŠ‚ç‚¹åˆ†ç‰‡ï¼‰ä¹‹é—´çš„é›†ç¾¤ï¼ŒåŒæ—¶å¿…ç„¶éœ€è¦å¸æ”¶é«˜å¯ç”¨ï¼ˆä¸»ä»å¤åˆ¶å’Œå“¨å…µæœºåˆ¶ï¼‰èƒ½åŠ›ï¼Œå³æ¯ä¸ª master åˆ†ç‰‡èŠ‚ç‚¹è¿˜éœ€è¦ç”± slave èŠ‚ç‚¹ã€‚è¿™æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å…¸å‹çš„çºµå‘æ‰©å±•ï¼ˆé›†ç¾¤çš„åˆ†ç‰‡æŠ€æœ¯ï¼‰</p><p>Redis Clusteræ˜¯ä¸€ç§æœåŠ¡å™¨ShardingæŠ€æœ¯(åˆ†ç‰‡å’Œè·¯ç”±éƒ½æ˜¯åœ¨æœåŠ¡ç«¯å®ç°)ï¼Œé‡‡ç”¨å¤šä¸»å¤šä»ï¼Œæ¯ä¸€ä¸ªåˆ†åŒºéƒ½æ˜¯ç”±ä¸€ä¸ªRedisä¸»æœºå’Œå¤šä¸ªä»æœºç»„æˆï¼Œç‰‡åŒºå’Œç‰‡åŒºä¹‹é—´æ˜¯ç›¸äº’å¹³è¡Œçš„ã€‚Redis Clusteré›†ç¾¤é‡‡ç”¨äº†P2Pçš„æ¨¡å¼ï¼Œå®Œå…¨å»ä¸­å¿ƒåŒ–ã€‚</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779161866-f0c18226-fd15-433e-9084-a07940689300-20250605100812167.jpeg" alt="img"></p><p>å¦‚ä¸Šå›¾ï¼Œå®˜æ–¹æ¨èï¼Œé›†ç¾¤éƒ¨ç½²è‡³å°‘è¦ 3 å°ä»¥ä¸Šçš„masterèŠ‚ç‚¹ï¼Œå¥½ä½¿ç”¨ 3 ä¸» 3 ä»å…­ä¸ªèŠ‚ç‚¹çš„æ¨¡å¼ã€‚Redis Clusteré›†ç¾¤å…·æœ‰å¦‚ä¸‹å‡ ä¸ªç‰¹ç‚¹ï¼š</p><ul><li>é›†ç¾¤å®Œå…¨å»ä¸­å¿ƒåŒ–ï¼Œé‡‡ç”¨å¤šä¸»å¤šä»ï¼›æ‰€æœ‰çš„redisèŠ‚ç‚¹å½¼æ­¤äº’è”(PING-PONGæœºåˆ¶)ï¼Œå†…éƒ¨ä½¿ç”¨äºŒè¿›åˆ¶åè®®ä¼˜åŒ–ä¼ è¾“é€Ÿåº¦å’Œå¸¦å®½ã€‚</li><li>å®¢æˆ·ç«¯ä¸ Redis èŠ‚ç‚¹ç›´è¿ï¼Œä¸éœ€è¦ä¸­é—´ä»£ç†å±‚ã€‚å®¢æˆ·ç«¯ä¸éœ€è¦è¿æ¥é›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹ï¼Œè¿æ¥é›†ç¾¤ä¸­ä»»ä½•ä¸€ä¸ªå¯ç”¨èŠ‚ç‚¹å³å¯ã€‚</li><li>æ¯ä¸€ä¸ªåˆ†åŒºéƒ½æ˜¯ç”±ä¸€ä¸ªRedisä¸»æœºå’Œå¤šä¸ªä»æœºç»„æˆï¼Œåˆ†ç‰‡å’Œåˆ†ç‰‡ä¹‹é—´æ˜¯ç›¸äº’å¹³è¡Œçš„ã€‚</li><li>æ¯ä¸€ä¸ªmasterèŠ‚ç‚¹è´Ÿè´£ç»´æŠ¤ä¸€éƒ¨åˆ†æ§½ï¼Œä»¥åŠæ§½æ‰€æ˜ å°„çš„é”®å€¼æ•°æ®ï¼›é›†ç¾¤ä¸­æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰å…¨é‡çš„æ§½ä¿¡æ¯ï¼Œé€šè¿‡æ§½æ¯ä¸ªnodeéƒ½çŸ¥é“å…·ä½“æ•°æ®å­˜å‚¨åˆ°å“ªä¸ªnodeä¸Šã€‚</li></ul><h4 id="5-9-1-å“ˆå¸Œæ§½"><a href="#5-9-1-å“ˆå¸Œæ§½" class="headerlink" title="5.9.1 å“ˆå¸Œæ§½"></a>5.9.1 å“ˆå¸Œæ§½</h4><p>Redis-cluster æ²¡æœ‰ä½¿ç”¨ä¸€è‡´æ€§ hashï¼Œè€Œæ˜¯å¼•å…¥äº† å“ˆå¸Œæ§½çš„æ¦‚å¿µã€‚ Redis-cluster ä¸­æœ‰ 16384ï¼ˆ2çš„14æ¬¡æ–¹ï¼‰ä¸ªå“ˆå¸Œæ§½ï¼Œæ¯ä¸ª key é€šè¿‡ CRC16æ ¡éªŒåå¯¹ 16383å–æ¨¡ æ¥å†³å®šæ”¾ç½®åœ¨å“ªä¸ªæ§½ã€‚Cluster ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£ä¸€éƒ¨åˆ†æ§½ï¼ˆhash slotï¼‰ã€ä¸€è‡´æ€§hashåœ¨ç®—æ³•ç« èŠ‚è¯´ã€‘</p><p>æ¯”å¦‚é›†ç¾¤ä¸­å­˜åœ¨ä¸‰ä¸ªèŠ‚ç‚¹ï¼Œåˆ™å¯èƒ½å­˜åœ¨ä¸‹é¢ç±»ä¼¼åˆ†é…ï¼š</p><ul><li>èŠ‚ç‚¹ A åŒ…å«0åˆ°5500å· å“ˆå¸Œæ§½</li><li>èŠ‚ç‚¹ B åŒ…å« 5501åˆ°11000å· å“ˆå¸Œæ§½</li><li>èŠ‚ç‚¹ C åŒ…å« 11001åˆ°16384 å“ˆå¸Œæ§½</li></ul><p>å“ˆå¸Œæ§½&#x3D;CRC16(key) % 16384ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥ å“ˆå¸Œæ§½&#x3D;CRC16(key)ï¼Ÿè¿™æ ·å°±å¯ä»¥æœ‰ 2^16ä¸ªå€¼ã€‚</p><p>è¿™æ˜¯å› ä¸ºredisèŠ‚ç‚¹å‘é€å¿ƒè·³åŒ…æ—¶ï¼Œéœ€è¦å°†æ‰€æœ‰çš„æ§½æ”¾åˆ°è¿™ä¸ªå¿ƒè·³åŒ…ã€‚å¦‚æœslots&#x3D;2^16ï¼Œéœ€å ç”¨ç©ºé—´ &#x3D; 2^16 &#x2F; 8 &#x2F; 1024 &#x3D; 8KBã€‚è€Œ slots&#x3D;16384 åªå ç”¨ 2KBã€‚å¹¶ä¸”ä¸€èˆ¬æƒ…å†µä¸‹ Redis Cluster é›†ç¾¤ä¸»èŠ‚ç‚¹æ•°é‡åŸºæœ¬ä¸å¯èƒ½è¶…è¿‡1000ä¸ªï¼Œè¶…è¿‡1000ä¸ªä¸€èˆ¬ä¼šå¯¼è‡´ç½‘ç»œå µå¡ã€‚ã€‚å¦‚æœslotsæ›´å°‘ï¼Œè™½ç„¶èƒ½è¿›ä¸€æ­¥é™ä½å¿ƒè·³åŒ…å¤§å°ï¼Œä½†æ˜¯ ä¼šæ›´å®¹æ˜“å‡ºç°ç¢°æ’æ¦‚ç‡ï¼ˆå‘½ä¸­å¤±æ•ˆï¼‰ã€‚æ‰€ä»¥ slots &#x3D; 16384 æ¯”è¾ƒåˆç†</p><h4 id="5-9-2-Key-Hash-Tags"><a href="#5-9-2-Key-Hash-Tags" class="headerlink" title="5.9.2 Key Hash Tags"></a>5.9.2 Key Hash Tags</h4><p>å› ä¸º key åˆ†å¸ƒåœ¨ä¸åŒèŠ‚ç‚¹ï¼Œæ‰€ä»¥ Multi-Key æ“ä½œå°±ä¼šå—é™ã€‚å®é™…åœºæ™¯æ¯”å¦‚ï¼š</p><ul><li>SUNIONã€msetã€mgetï¼Œè¿™ç±»å‘½ä»¤ä¼šæ“ä½œå¤šä¸ªkey</li><li>äº‹åŠ¡ï¼Œåœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ä¼šæ“ä½œå¤šä¸ªkey</li><li>LUAè„šæœ¬ï¼Œåœ¨LUAè„šæœ¬ä¸­ä¹Ÿä¼šæ“ä½œå¤šä¸ªkey</li></ul><p>Hash Tags æä¾›äº†ä¸€ç§é€”å¾„ï¼Œç”¨æ¥å°†å¤šä¸ªï¼ˆkeyï¼‰åˆ†é…åˆ°ç›¸åŒçš„ hash slot ä¸­ã€‚è¿™æ—¶ Redis Clusterä¸­å®ç° multi-key æ“ä½œçš„åŸºç¡€ã€‚</p><ul><li>keyåŒ…å«ä¸€ä¸ª{å­—ç¬¦</li><li>å¹¶ä¸” å¦‚æœåœ¨è¿™ä¸ª{çš„å³é¢æœ‰ä¸€ä¸ª}å­—ç¬¦</li><li>å¹¶ä¸” å¦‚æœåœ¨{å’Œ}ä¹‹é—´å­˜åœ¨è‡³å°‘ä¸€ä¸ªå­—ç¬¦</li></ul><p>ä¾‹å¦‚ï¼š</p><ul><li>{user1000}.followingå’Œ{user1000}.followersè¿™ä¸¤ä¸ªkeyä¼šè¢«hashåˆ°ç›¸åŒçš„hash slotä¸­ï¼Œå› ä¸ºåªæœ‰user1000ä¼šè¢«ç”¨æ¥è®¡ç®—hash slotå€¼ã€‚</li><li>foo{}{bar}è¿™ä¸ªkeyä¸ä¼šå¯ç”¨hash tagå› ä¸ºç¬¬ä¸€ä¸ª{å’Œ}ä¹‹é—´æ²¡æœ‰å­—ç¬¦ã€‚</li><li>foozapè¿™ä¸ªkeyä¸­å…¨éƒ¨å†…å®¹ä¼šè¢«ç”¨æ¥è®¡ç®—hash slot</li><li>foo{bar}{zap}è¿™ä¸ªkeyä¸­çš„barä¼šè¢«ç”¨æ¥è®¡ç®—è®¡ç®—hash slotï¼Œè€Œzapä¸ä¼š</li></ul><h4 id="5-9-3-è¯·æ±‚é‡å®šå‘"><a href="#5-9-3-è¯·æ±‚é‡å®šå‘" class="headerlink" title="5.9.3 è¯·æ±‚é‡å®šå‘"></a>5.9.3 è¯·æ±‚é‡å®šå‘</h4><p>Redis cluster é‡‡ç”¨å»ä¸­å¿ƒåŒ–çš„æ¶æ„ï¼Œé›†ç¾¤çš„ä¸»èŠ‚ç‚¹å„è‡ªè´Ÿè´£ä¸€éƒ¨åˆ†æ§½ï¼Œå®¢æˆ·ç«¯å¦‚ä½•ç¡®å®š key åˆ°åº•ä¼šæ˜ å°„åˆ° å“ªä¸ªèŠ‚ç‚¹ä¸Šå‘¢ï¼Ÿè¿™å°±æ¶‰åŠåˆ°è¯·æ±‚é‡å®šå‘</p><p>åœ¨ Cluster æ¨¡å¼ä¸‹ï¼ŒèŠ‚ç‚¹å¯¹è¯·æ±‚çš„å¤„ç†è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol><li>æ£€æŸ¥å½“å‰ key æ˜¯å¦å­˜åœ¨äº å½“å‰ node</li></ol><ul><li><ul><li>é€šè¿‡keyæœ‰æ•ˆéƒ¨åˆ†ä½¿ç”¨ CRC16å‡½æ•°è®¡ç®—æ•£åˆ—å€¼ï¼Œå†å¯¹16384 å–ä½™ï¼Œè®¡ç®—å‡º slot çš„ç¼–å·ã€‚</li><li>Redisè®¡ç®—å¾—åˆ°é”®å¯¹åº”çš„æ§½åï¼Œéœ€è¦æŸ¥æ‰¾æ§½æ‰€å¯¹åº”çš„èŠ‚ç‚¹ã€‚é›†ç¾¤å†…é€šè¿‡æ¶ˆæ¯äº¤æ¢æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šçŸ¥é“æ‰€æœ‰èŠ‚ç‚¹çš„æ§½ä¿¡æ¯ã€‚ä»è€Œå¾—åˆ°è´Ÿè´£è¯¥æ§½çš„ èŠ‚ç‚¹æŒ‡é’ˆã€‚</li></ul></li></ul><ol><li>è‹¥ slot ä¸æ˜¯ç”±è‡ªèº«è´Ÿè´£ï¼Œåˆ™è¿”å› MOVED é‡å®šå‘ã€‚</li><li>è‹¥ slot ç”±è‡ªèº«è´Ÿè´£ï¼Œä¸” key åœ¨ slot ä¸­ï¼Œåˆ™è¿”å›è¯¥ key å¯¹åº”ç»“æœã€‚</li><li>è‹¥ key ä¸å­˜åœ¨æ­¤ slotä¸­ï¼Œæ£€æŸ¥è¯¥ slot æ˜¯å¦æ­£åœ¨è¿å‡ºï¼ˆMIGRATINGï¼‰ï¼Ÿ</li><li>slot æ­£åœ¨è¿å‡ºï¼Œè¿”å› ASKé”™è¯¯é‡å®šå‘å®¢æˆ·ç«¯åˆ° è¿ç§»çš„ç›®çš„æœåŠ¡å™¨ä¸Š</li><li>è‹¥ slot æœªè¿å‡ºï¼Œæ£€æŸ¥ slot æ˜¯å¦åœ¨å¯¼å…¥ä¸­ ï¼Ÿ</li><li>è‹¥ slot å¯¼å…¥ä¸­ä¸”ç”± ASKING æ ‡è®°ï¼Œåˆ™ç›´æ¥æ“ä½œ</li><li>å¦åˆ™è¿”å› MOVED é‡å®šå‘</li></ol><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779145349-c2ddfcdb-cc9b-4948-a6f2-00b3b740388c-20250605100802757.png" alt="img"></p><p>è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½æ¶‰åŠåˆ°ä¸¤ä¸ªé‡å®šå‘ï¼Œåˆ†åˆ«æ—¶ MOVEDé‡å®šå‘ã€ASKé‡å®šå‘</p><h5 id="MOVED-é‡å®šå‘"><a href="#MOVED-é‡å®šå‘" class="headerlink" title="MOVED é‡å®šå‘"></a>MOVED é‡å®šå‘</h5><p>é€šè¿‡è®¡ç®— key å’Œ æœ¬åœ° slot ç¼“å­˜ï¼Œå¾—åˆ°è´Ÿè´£ slot çš„èŠ‚ç‚¹ã€‚ä¸€èˆ¬å°±å»è¯·æ±‚äº†ï¼Œä½†æ˜¯å¯èƒ½æœ‰ä¸¤ç§æƒ…å†µï¼š</p><ul><li>æ§½å‘½ä¸­ï¼šç›´æ¥è¿”å›ç»“æœ</li><li>æ§½ä¸å‘½ä¸­ï¼šå³å½“å‰é”®å‘½ä»¤æ‰€è¯·æ±‚çš„é”® ä¸åœ¨å½“å‰è¯·æ±‚çš„èŠ‚ç‚¹ä¸­ï¼Œåˆ™å½“å‰èŠ‚ç‚¹ä¼šå‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ª MOVED é‡å®šå‘ã€‚å®¢æˆ·ç«¯æ ¹æ® MOVEDé‡å®šå‘æ‰€åŒ…å«çš„å†…å®¹æ‰¾åˆ°ç›®æ ‡èŠ‚ç‚¹ï¼Œå†ä¸€æ¬¡å‘é€å‘½ä»¤ã€‚redis-cliä¼šå¸®ä½ è‡ªåŠ¨é‡å®šå‘ï¼ˆå¦‚æœæ²¡æœ‰é›†ç¾¤æ–¹å¼å¯åŠ¨ï¼Œå³æ²¡åŠ å‚æ•° -cï¼Œredis-cliä¸ä¼šè‡ªåŠ¨é‡å®šå‘ï¼‰</li></ul><p>ç”±äºæœ¬åœ°ä¼šç¼“å­˜æ˜ å°„çš„å­˜åœ¨ï¼Œæ‰€ä»¥ç»å¤§éƒ¨åˆ†æ—¶å€™éƒ½ä¸ä¼šè§¦å‘ MOVEDï¼Œè€ŒMOVEDæ˜¯ç”¨æ¥ååŠ©å®¢æˆ·ç«¯æ›´æ–° slot-node æ˜ å°„ã€‚</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779141290-b93974ae-08a7-4639-88d8-fec2f75f06ed-20250605100753660.png" alt="img"></p><h5 id="ASK-é‡å®šå‘"><a href="#ASK-é‡å®šå‘" class="headerlink" title="ASK é‡å®šå‘"></a>ASK é‡å®šå‘</h5><p>é›†ç¾¤ä¼¸ç¼©æ—¶ï¼Œé›†ç¾¤ä¼¸ç¼©ä¼šå¯¼è‡´æ§½è¿ç§»ã€‚æ§½è¿ç§»è¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ªæ§½å†…çš„key ä¼šåˆ†ä¸ºå¤šä¸ªæ‰¹æ¬¡ï¼Œä¾æ¬¡è¿ç§»ã€‚æ‰€ä»¥å­˜åœ¨ï¼Œä¸€éƒ¨åˆ†æ•°æ®åœ¨æºèŠ‚ç‚¹ï¼Œä¸€èˆ¬éƒ¨åˆ†æ•°æ®åœ¨è¿ç§»çš„ç›®æ ‡èŠ‚ç‚¹ã€‚ASKé‡å®šå‘ç”±æ­¤è¯ç”Ÿ</p><p>å‡ºç°ä¸Šè¿°æƒ…å†µï¼Œå®¢æˆ·ç«¯çš„å‘½ä»¤æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>å®¢æˆ·ç«¯æ ¹æ®æœ¬åœ° slot ç¼“å­˜å‘é€å‘½ä»¤åˆ°æºèŠ‚ç‚¹ï¼Œå¦‚æœå­˜åœ¨ é”®å¯¹è±¡ åˆ™ç›´æ¥æ‰§è¡Œå¹¶è¿”å›ç»“æœç»™å®¢æˆ·ç«¯ã€‚</li><li>å¦‚æœé”®å¯¹è±¡ä¸å­˜åœ¨ï¼Œåˆ™å¯èƒ½å­˜åœ¨äºç›®æ ‡èŠ‚ç‚¹ã€‚è¿™æ—¶æºèŠ‚ç‚¹ä¼šå›å¤ ASK é‡å®šå‘å¼‚å¸¸ã€‚æ ¼å¼å¦‚ä¸‹ï¼šï¼ˆerrorï¼‰ASK{slot}{targetIP}ï¼š{targetPort}</li><li>å®¢æˆ·ç«¯ä» ASK é‡å®šå‘å¼‚å¸¸ä¸­ æå–ç›®æ ‡èŠ‚ç‚¹ä¿¡æ¯ï¼Œå‘é€ askingå‘½ä»¤åˆ°ç›®æ ‡èŠ‚ç‚¹æ‰“å¼€å®¢æˆ·ç«¯è¿æ¥æ ‡è¯†ï¼Œå†æ‰§è¡Œé”®å‘½ä»¤ã€‚å¦‚æœå­˜åœ¨åˆ™æ‰§ï¼Œä¸å­˜åœ¨åˆ™è¿”å›ä¸å­˜åœ¨ä¿¡æ¯ã€‚</li></ol><h5 id="ä¸¤è€…çš„åŒºåˆ«"><a href="#ä¸¤è€…çš„åŒºåˆ«" class="headerlink" title="ä¸¤è€…çš„åŒºåˆ«"></a>ä¸¤è€…çš„åŒºåˆ«</h5><p>ASKä¸MOVEDè™½ç„¶éƒ½æ˜¯å¯¹å®¢æˆ·ç«¯çš„é‡å®šå‘æ§åˆ¶ï¼Œä½†æ˜¯æœ‰ç€æœ¬è´¨åŒºåˆ«ã€‚ASK é‡å®šå‘è¯´æ˜é›†ç¾¤æ­£åœ¨è¿›è¡Œslotæ•°æ®è¿ç§»ï¼Œå®¢æˆ·ç«¯æ— æ³•çŸ¥é“ä»€ä¹ˆæ—¶å€™è¿ç§»å®Œæˆï¼Œå› æ­¤åªèƒ½æ˜¯<strong>ä¸´æ—¶æ€§çš„é‡å®šå‘</strong>ï¼Œå®¢æˆ·ç«¯<strong>ä¸ä¼šæ›´æ–°slotsç¼“å­˜</strong>ã€‚ä½†æ˜¯MOVEDé‡å®šå‘è¯´æ˜é”®å¯¹åº”çš„æ§½å·²ç»æ˜ç¡®æŒ‡å®šåˆ°æ–°çš„èŠ‚ç‚¹ï¼Œå› æ­¤<strong>éœ€è¦æ›´æ–°slotsç¼“å­˜</strong>ã€‚</p><h4 id="5-9-4-æ•…éšœè½¬ç§»"><a href="#5-9-4-æ•…éšœè½¬ç§»" class="headerlink" title="5.9.4 æ•…éšœè½¬ç§»"></a>5.9.4 æ•…éšœè½¬ç§»</h4><p>Redisé›†ç¾¤è‡ªèº«å®ç°äº†é«˜å¯ç”¨ã€‚é«˜å¯ç”¨é¦–å…ˆéœ€è¦è§£å†³é›†ç¾¤éƒ¨åˆ†å¤±è´¥çš„åœºæ™¯ï¼šå½“é›†ç¾¤å†…å°‘é‡èŠ‚ç‚¹å‡ºç°æ•…éšœæ—¶é€šè¿‡è‡ªåŠ¨æ•…éšœè½¬ç§»ä¿è¯é›†ç¾¤å¯ä»¥æ­£å¸¸å¯¹å¤–æä¾›æœåŠ¡ã€‚</p><p>Redisé›†ç¾¤å†…èŠ‚ç‚¹é€šè¿‡ping&#x2F;pongæ¶ˆæ¯å®ç°èŠ‚ç‚¹é€šä¿¡ï¼Œæ¶ˆæ¯ä¸ä½†å¯ä»¥ä¼ æ’­èŠ‚ç‚¹æ§½ä¿¡æ¯ï¼Œè¿˜å¯ä»¥ä¼ æ’­å…¶ä»–çŠ¶æ€å¦‚ï¼šä¸»ä»çŠ¶æ€ã€èŠ‚ç‚¹æ•…éšœç­‰ã€‚å› æ­¤æ•…éšœå‘ç°ä¹Ÿæ˜¯é€šè¿‡æ¶ˆæ¯ä¼ æ’­æœºåˆ¶å®ç°çš„ï¼Œä¸»è¦ç¯èŠ‚åŒ…æ‹¬ï¼šä¸»è§‚ä¸‹çº¿ï¼ˆpfailï¼‰å’Œå®¢è§‚ä¸‹çº¿ï¼ˆfailï¼‰ã€‚</p><p>ä¸»è§‚ä¸‹çº¿æµç¨‹ï¼š</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779141957-c4410066-51a8-40ed-9ae8-f17118aaa5fd-20250605100742339.png" alt="img"></p><p>å½“æŸä¸ªèŠ‚ç‚¹åˆ¤æ–­å¦ä¸€ä¸ªèŠ‚ç‚¹ä¸»è§‚ä¸‹çº¿åï¼Œç›¸åº”çš„èŠ‚ç‚¹çŠ¶æ€ä¼šè·Ÿéšæ¶ˆæ¯åœ¨é›†ç¾¤å†…ä¼ æ’­ã€‚ping&#x2F;pongæ¶ˆæ¯çš„æ¶ˆæ¯ä½“ä¼šæºå¸¦é›†ç¾¤1&#x2F;10çš„å…¶ä»–èŠ‚ç‚¹çŠ¶æ€æ•°æ®ï¼Œå½“æ¥å—èŠ‚ç‚¹å‘ç°æ¶ˆæ¯ä½“ä¸­å«æœ‰ä¸»è§‚ä¸‹çº¿çš„èŠ‚ç‚¹çŠ¶æ€æ—¶ï¼Œä¼šåœ¨æœ¬åœ°æ‰¾åˆ°æ•…éšœèŠ‚ç‚¹çš„ClusterNodeç»“æ„ï¼Œä¿å­˜åˆ°<strong>ä¸‹çº¿æŠ¥å‘Šé“¾è¡¨</strong>ä¸­ã€‚</p><p>é€šè¿‡Gossipæ¶ˆæ¯ä¼ æ’­ï¼Œé›†ç¾¤å†…èŠ‚ç‚¹ä¸æ–­æ”¶é›†åˆ°æ•…éšœèŠ‚ç‚¹çš„ä¸‹çº¿æŠ¥å‘Šã€‚å½“<strong>åŠæ•°ä»¥ä¸Š</strong>æŒæœ‰æ§½çš„ä¸»èŠ‚ç‚¹éƒ½æ ‡è®°æŸä¸ªèŠ‚ç‚¹æ˜¯ä¸»è§‚ä¸‹çº¿æ—¶ï¼Œè§¦å‘å®¢è§‚ä¸‹çº¿æµç¨‹ã€‚</p><p><strong>æ•…éšœæ¢å¤</strong></p><p>æ•…éšœèŠ‚ç‚¹å˜ä¸ºå®¢è§‚ä¸‹çº¿åï¼Œå¦‚æœä¸‹çº¿èŠ‚ç‚¹æ˜¯æŒæœ‰æ§½çš„ä¸»èŠ‚ç‚¹åˆ™éœ€è¦åœ¨å®ƒçš„<strong>ä»èŠ‚ç‚¹</strong>ä¸­é€‰å‡ºä¸€ä¸ªæ›¿æ¢å®ƒï¼Œä»è€Œä¿è¯é›†ç¾¤çš„é«˜å¯ç”¨ã€‚ä¸‹çº¿ä¸»èŠ‚ç‚¹çš„æ‰€æœ‰ä»èŠ‚ç‚¹æ‰¿æ‹…æ•…éšœæ¢å¤çš„ä¹‰åŠ¡ï¼Œå½“ä»èŠ‚ç‚¹é€šè¿‡å†…éƒ¨å®šæ—¶ä»»åŠ¡å‘ç°è‡ªèº«å¤åˆ¶çš„ä¸»èŠ‚ç‚¹è¿›å…¥å®¢è§‚ä¸‹çº¿æ—¶ï¼Œå°†ä¼šè§¦å‘æ•…éšœæ¢å¤æµç¨‹ï¼š</p><ul><li>ä»èŠ‚ç‚¹ä¸ä¸»èŠ‚ç‚¹æ–­çº¿æ—¶é—´è¶…è¿‡cluster-node-time*cluster-slave-validity-factorï¼Œåˆ™å½“å‰ä»èŠ‚ç‚¹ä¸å…·å¤‡æ•…éšœè½¬ç§»èµ„æ ¼ã€‚å‚æ•°cluster-slave-validity-factorç”¨äºä»èŠ‚ç‚¹çš„æœ‰æ•ˆå› å­ï¼Œé»˜è®¤ä¸º10ã€‚</li><li>å½“ä»èŠ‚ç‚¹ç¬¦åˆæ•…éšœè½¬ç§»èµ„æ ¼åï¼Œæ›´æ–°è§¦å‘æ•…éšœé€‰ä¸¾çš„æ—¶é—´ï¼Œåªæœ‰åˆ°è¾¾è¯¥æ—¶é—´åæ‰èƒ½æ‰§è¡Œåç»­æµç¨‹ã€‚è¿™é‡Œä¹‹æ‰€ä»¥é‡‡ç”¨<strong>å»¶è¿Ÿè§¦å‘æœºåˆ¶</strong>ï¼Œä¸»è¦æ˜¯é€šè¿‡å¯¹å¤šä¸ªä»èŠ‚ç‚¹ä½¿ç”¨ä¸åŒçš„å»¶è¿Ÿé€‰ä¸¾æ—¶é—´æ¥æ”¯æŒä¼˜å…ˆçº§é—®é¢˜ã€‚å¤åˆ¶åç§»é‡è¶Šå¤§è¯´æ˜ä»èŠ‚ç‚¹å»¶è¿Ÿè¶Šä½ï¼Œé‚£ä¹ˆå®ƒåº”è¯¥å…·æœ‰æ›´é«˜çš„ä¼˜å…ˆçº§æ¥æ›¿æ¢æ•…éšœä¸»èŠ‚ç‚¹ã€‚</li></ul><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779142661-ccaf9622-687f-4fd7-bb0f-9b12dd307cfe-20250605100735532.png" alt="img"></p><ul><li>å‘èµ·é€‰ä¸¾ã€‚Redisé›†ç¾¤æ²¡æœ‰ç›´æ¥ä½¿ç”¨ä»èŠ‚ç‚¹è¿›è¡Œé¢†å¯¼è€…é€‰ä¸¾ï¼Œä¸»è¦å› ä¸ºä»èŠ‚ç‚¹æ•°å¿…é¡»å¤§äºç­‰äº3ä¸ªæ‰èƒ½ä¿è¯å‡‘å¤ŸN&#x2F;2+1ä¸ªèŠ‚ç‚¹ï¼Œå°†å¯¼è‡´ä»èŠ‚ç‚¹èµ„æºæµªè´¹ã€‚ä½¿ç”¨<strong>é›†ç¾¤å†…æ‰€æœ‰æŒæœ‰æ§½çš„ä¸»èŠ‚ç‚¹è¿›è¡Œé¢†å¯¼è€…é€‰ä¸¾</strong>ï¼Œå³ä½¿åªæœ‰ä¸€ä¸ªä»èŠ‚ç‚¹ä¹Ÿå¯ä»¥å®Œæˆé€‰ä¸¾è¿‡ç¨‹ã€‚å½“ä»èŠ‚ç‚¹æ”¶é›†åˆ°N&#x2F;2+1ä¸ªæŒæœ‰æ§½çš„ä¸»èŠ‚ç‚¹æŠ•ç¥¨æ—¶ï¼Œä»èŠ‚ç‚¹å¯ä»¥æ‰§è¡Œæ›¿æ¢ä¸»èŠ‚ç‚¹æ“ä½œã€‚</li></ul><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779143549-fe48adcb-3d12-4d75-9ec8-5b30473ab45e-20250605100730766.png" alt="img"></p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779143588-93b3d1eb-7667-4589-afc0-cb041b6046c3-20250605100725335.png" alt="img"></p><p><strong>é¢„ä¼°æ•…éšœè½¬ç§»æ—¶é—´</strong></p><p>failover-time(æ¯«ç§’) â‰¤ cluster-node-timeout + cluster-node-timeout &#x2F; 2 + 1000</p><ul><li>ä¸»è§‚ä¸‹çº¿è¯†åˆ«æ—¶é—´ï¼šcluster-node-timeout</li><li>ä¸»è§‚ä¸‹çº¿çŠ¶æ€æ¶ˆæ¯ä¼ æ’­æ—¶é—´&lt;&#x3D;cluster-node-timeout&#x2F;2ã€‚æ¶ˆæ¯é€šä¿¡æœºåˆ¶å¯¹è¶…è¿‡cluster-node-timeout&#x2F;2æœªé€šä¿¡èŠ‚ç‚¹ä¼šå‘èµ·pingæ¶ˆæ¯ï¼Œæ¶ˆæ¯ä½“åœ¨é€‰æ‹©åŒ…å«å“ªäº›èŠ‚ç‚¹æ—¶ä¼šä¼˜å…ˆé€‰å–ä¸‹çº¿çŠ¶æ€èŠ‚ç‚¹ï¼Œæ‰€ä»¥é€šå¸¸è¿™æ®µæ—¶é—´å†…èƒ½å¤Ÿæ”¶é›†åˆ°åŠæ•°ä»¥ä¸Šä¸»èŠ‚ç‚¹çš„pfailæŠ¥å‘Šä»è€Œå®Œæˆæ•…éšœå‘ç°ã€‚</li><li>ä»èŠ‚ç‚¹è½¬ç§»æ—¶é—´&lt;&#x3D;1000æ¯«ç§’ã€‚ç”±äºå­˜åœ¨å»¶è¿Ÿå‘èµ·é€‰ä¸¾æœºåˆ¶ï¼Œåç§»é‡æœ€å¤§çš„ä»èŠ‚ç‚¹ä¼š<strong>æœ€å¤šå»¶è¿Ÿ<strong><strong>1</strong></strong>ç§’å‘èµ·é€‰ä¸¾</strong>ã€‚é€šå¸¸ç¬¬ä¸€æ¬¡é€‰ä¸¾å°±ä¼šæˆåŠŸã€‚</li></ul><p>æ•…éšœè½¬ç§»æ—¶é—´è·Ÿ cluster-node-timeout å‚æ•°æ¯æ¯ç›¸å…³ï¼Œé»˜è®¤15ç§’ã€‚é…ç½®æ—¶å¯ä»¥æ ¹æ®ä¸šåŠ¡å®¹å¿åº¦åšå‡ºé€‚å½“è°ƒæ•´ï¼Œä½†ä¸æ˜¯è¶Šå°è¶Šå¥½ã€‚</p><h4 id="5-9-5-è„‘è£‚é—®é¢˜"><a href="#5-9-5-è„‘è£‚é—®é¢˜" class="headerlink" title="5.9.5 è„‘è£‚é—®é¢˜"></a>5.9.5 è„‘è£‚é—®é¢˜</h4><p>ä»€ä¹ˆæ˜¯è„‘è£‚ï¼Ÿ</p><p>åœ¨ Redis ä¸»ä»æ¶æ„ä¸­ï¼Œéƒ¨ç½²æ–¹å¼ä¸€èˆ¬æ˜¯ã€Œä¸€ä¸»å¤šä»ã€ï¼Œä¸»èŠ‚ç‚¹æä¾›å†™æ“ä½œï¼Œä»èŠ‚ç‚¹æä¾›è¯»æ“ä½œã€‚ å¦‚æœä¸»èŠ‚ç‚¹çš„ç½‘ç»œçªç„¶å‘ç”Ÿäº†é—®é¢˜ï¼Œå®ƒä¸æ‰€æœ‰çš„ä»èŠ‚ç‚¹éƒ½å¤±è”äº†ï¼Œä½†æ˜¯æ­¤æ—¶çš„ä¸»èŠ‚ç‚¹å’Œå®¢æˆ·ç«¯çš„ç½‘ç»œæ˜¯æ­£å¸¸çš„ï¼Œè¿™ä¸ªå®¢æˆ·ç«¯å¹¶ä¸çŸ¥é“ Redis å†…éƒ¨å·²ç»å‡ºç°äº†é—®é¢˜ï¼Œè¿˜åœ¨ç…§æ ·çš„å‘è¿™ä¸ªå¤±è”çš„ä¸»èŠ‚ç‚¹å†™æ•°æ®ï¼ˆè¿‡ç¨‹Aï¼‰ï¼Œæ­¤æ—¶è¿™äº›æ•°æ®è¢«æ—§ä¸»èŠ‚ç‚¹ç¼“å­˜åˆ°äº†ç¼“å†²åŒºé‡Œï¼Œå› ä¸ºä¸»ä»èŠ‚ç‚¹ä¹‹é—´çš„ç½‘ç»œé—®é¢˜ï¼Œè¿™äº›æ•°æ®éƒ½æ˜¯æ— æ³•åŒæ­¥ç»™ä»èŠ‚ç‚¹çš„ã€‚</p><p>è¿™æ—¶ï¼Œå“¨å…µä¹Ÿå‘ç°ä¸»èŠ‚ç‚¹å¤±è”äº†ï¼Œå®ƒå°±è®¤ä¸ºä¸»èŠ‚ç‚¹æŒ‚äº†ï¼ˆä½†å®é™…ä¸Šä¸»èŠ‚ç‚¹æ­£å¸¸è¿è¡Œï¼Œåªæ˜¯ç½‘ç»œå‡ºé—®é¢˜äº†ï¼‰ï¼Œäºæ˜¯å“¨å…µå°±ä¼šåœ¨ã€Œä»èŠ‚ç‚¹ã€ä¸­é€‰ä¸¾å‡ºä¸€ä¸ª leader ä½œä¸ºä¸»èŠ‚ç‚¹ï¼Œè¿™æ—¶é›†ç¾¤å°±æœ‰ä¸¤ä¸ªä¸»èŠ‚ç‚¹äº† â€”â€” <strong>è„‘è£‚å‡ºç°äº†</strong>ã€‚</p><p>è„‘è£‚å¯èƒ½ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ï¼Ÿ</p><p>ç„¶åï¼Œç½‘ç»œçªç„¶å¥½äº†ï¼Œå“¨å…µå› ä¸ºä¹‹å‰å·²ç»é€‰ä¸¾å‡ºä¸€ä¸ªæ–°ä¸»èŠ‚ç‚¹äº†ï¼Œå®ƒå°±ä¼šæŠŠæ—§ä¸»èŠ‚ç‚¹é™çº§ä¸ºä»èŠ‚ç‚¹ï¼ˆAï¼‰ï¼Œç„¶åä»èŠ‚ç‚¹ï¼ˆAï¼‰ä¼šå‘æ–°ä¸»èŠ‚ç‚¹è¯·æ±‚æ•°æ®åŒæ­¥ï¼Œ<strong>å› ä¸ºç¬¬ä¸€æ¬¡åŒæ­¥æ˜¯å…¨é‡åŒæ­¥çš„æ–¹å¼ï¼Œæ­¤æ—¶çš„ä»èŠ‚ç‚¹ï¼ˆAï¼‰ä¼šæ¸…ç©ºæ‰è‡ªå·±æœ¬åœ°çš„æ•°æ®ï¼Œç„¶åå†åšå…¨é‡åŒæ­¥ã€‚æ‰€ä»¥ï¼Œä¹‹å‰å®¢æˆ·ç«¯åœ¨è¿‡ç¨‹ A å†™å…¥çš„æ•°æ®å°±ä¼šä¸¢å¤±äº†ï¼Œä¹Ÿå°±æ˜¯é›†ç¾¤äº§ç”Ÿè„‘è£‚æ•°æ®ä¸¢å¤±çš„é—®é¢˜</strong>ã€‚</p><p>æ€»ç»“ä¸€å¥è¯å°±æ˜¯ï¼šç”±äºç½‘ç»œé—®é¢˜ï¼Œé›†ç¾¤èŠ‚ç‚¹ä¹‹é—´å¤±å»è”ç³»ã€‚ä¸»ä»æ•°æ®ä¸åŒæ­¥ï¼›é‡æ–°å¹³è¡¡é€‰ä¸¾ï¼Œäº§ç”Ÿä¸¤ä¸ªä¸»æœåŠ¡ã€‚ç­‰ç½‘ç»œæ¢å¤ï¼Œæ—§ä¸»èŠ‚ç‚¹ä¼šé™çº§ä¸ºä»èŠ‚ç‚¹ï¼Œå†ä¸æ–°ä¸»èŠ‚ç‚¹è¿›è¡ŒåŒæ­¥å¤åˆ¶çš„æ—¶å€™ï¼Œç”±äºä¼šä»èŠ‚ç‚¹ä¼šæ¸…ç©ºè‡ªå·±çš„ç¼“å†²åŒºï¼Œæ‰€ä»¥å¯¼è‡´ä¹‹å‰å®¢æˆ·ç«¯å†™å…¥çš„æ•°æ®ä¸¢å¤±äº†ã€‚</p><p>è§£å†³æ–¹æ¡ˆ</p><p>å½“ä¸»èŠ‚ç‚¹å‘ç°ä»èŠ‚ç‚¹ä¸‹çº¿æˆ–è€…é€šä¿¡è¶…æ—¶çš„æ€»æ•°é‡å°äºé˜ˆå€¼æ—¶ï¼Œé‚£ä¹ˆç¦æ­¢ä¸»èŠ‚ç‚¹è¿›è¡Œå†™æ•°æ®ï¼Œç›´æ¥æŠŠé”™è¯¯è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p><p>åœ¨ Redis çš„é…ç½®æ–‡ä»¶ä¸­æœ‰ä¸¤ä¸ªå‚æ•°æˆ‘ä»¬å¯ä»¥è®¾ç½®ï¼š</p><ul><li>min-slaves-to-write xï¼Œä¸»èŠ‚ç‚¹å¿…é¡»è¦æœ‰è‡³å°‘ x ä¸ªä»èŠ‚ç‚¹è¿æ¥ï¼Œå¦‚æœå°äºè¿™ä¸ªæ•°ï¼Œä¸»èŠ‚ç‚¹ä¼šç¦æ­¢å†™æ•°æ®ã€‚</li><li>min-slaves-max-lag xï¼Œä¸»ä»æ•°æ®å¤åˆ¶å’ŒåŒæ­¥çš„å»¶è¿Ÿä¸èƒ½è¶…è¿‡ x ç§’ï¼Œå¦‚æœè¶…è¿‡ï¼Œä¸»èŠ‚ç‚¹ä¼šç¦æ­¢å†™æ•°æ®ã€‚</li></ul><p>æˆ‘ä»¬å¯ä»¥æŠŠ min-slaves-to-write å’Œ min-slaves-max-lag è¿™ä¸¤ä¸ªé…ç½®é¡¹æ­é…èµ·æ¥ä½¿ç”¨ï¼Œåˆ†åˆ«ç»™å®ƒä»¬è®¾ç½®ä¸€å®šçš„é˜ˆå€¼ï¼Œå‡è®¾ä¸º N å’Œ Tã€‚</p><p>è¿™ä¸¤ä¸ªé…ç½®é¡¹ç»„åˆåçš„è¦æ±‚æ˜¯ï¼Œä¸»åº“è¿æ¥çš„ä»åº“ä¸­è‡³å°‘æœ‰ N ä¸ªä»åº“ï¼Œå’Œä¸»åº“è¿›è¡Œæ•°æ®å¤åˆ¶æ—¶çš„ ACK æ¶ˆæ¯å»¶è¿Ÿä¸èƒ½è¶…è¿‡ T ç§’ï¼Œå¦åˆ™ï¼Œä¸»åº“å°±ä¸ä¼šå†æ¥æ”¶å®¢æˆ·ç«¯çš„å†™è¯·æ±‚äº†ã€‚</p><p>å³ä½¿åŸä¸»åº“æ˜¯å‡æ•…éšœï¼Œå®ƒåœ¨å‡æ•…éšœæœŸé—´ä¹Ÿæ— æ³•å“åº”å“¨å…µå¿ƒè·³ï¼Œä¹Ÿä¸èƒ½å’Œä»åº“è¿›è¡ŒåŒæ­¥ï¼Œè‡ªç„¶ä¹Ÿå°±æ— æ³•å’Œä»åº“è¿›è¡Œ ACK ç¡®è®¤äº†ã€‚è¿™æ ·ä¸€æ¥ï¼Œmin-slaves-to-write å’Œ min-slaves-max-lag çš„ç»„åˆè¦æ±‚å°±æ— æ³•å¾—åˆ°æ»¡è¶³ï¼Œ<strong>åŸä¸»åº“å°±ä¼šè¢«é™åˆ¶æ¥æ”¶å®¢æˆ·ç«¯å†™è¯·æ±‚ï¼Œå®¢æˆ·ç«¯ä¹Ÿå°±ä¸èƒ½åœ¨åŸä¸»åº“ä¸­å†™å…¥æ–°æ•°æ®äº†</strong>ã€‚</p><p><strong>ç­‰åˆ°æ–°ä¸»åº“ä¸Šçº¿æ—¶ï¼Œå°±åªæœ‰æ–°ä¸»åº“èƒ½æ¥æ”¶å’Œå¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼Œæ­¤æ—¶ï¼Œæ–°å†™çš„æ•°æ®ä¼šè¢«ç›´æ¥å†™åˆ°æ–°ä¸»åº“ä¸­ã€‚è€ŒåŸä¸»åº“ä¼šè¢«å“¨å…µé™ä¸ºä»åº“ï¼Œå³ä½¿å®ƒçš„æ•°æ®è¢«æ¸…ç©ºäº†ï¼Œä¹Ÿä¸ä¼šæœ‰æ–°æ•°æ®ä¸¢å¤±ã€‚</strong></p><p>å†æ¥ä¸¾ä¸ªä¾‹å­</p><p>å‡è®¾æˆ‘ä»¬å°† min-slaves-to-write è®¾ç½®ä¸º 1ï¼ŒæŠŠ min-slaves-max-lag è®¾ç½®ä¸º 12sï¼ŒæŠŠå“¨å…µçš„ down-after-milliseconds è®¾ç½®ä¸º 10sï¼Œä¸»åº“å› ä¸ºæŸäº›åŸå› å¡ä½äº† 15sï¼Œå¯¼è‡´å“¨å…µåˆ¤æ–­ä¸»åº“å®¢è§‚ä¸‹çº¿ï¼Œå¼€å§‹è¿›è¡Œä¸»ä»åˆ‡æ¢ã€‚</p><p>åŒæ—¶ï¼Œå› ä¸ºåŸä¸»åº“å¡ä½äº† 15sï¼Œæ²¡æœ‰ä¸€ä¸ªä»åº“èƒ½å’ŒåŸä¸»åº“åœ¨ 12s å†…è¿›è¡Œæ•°æ®å¤åˆ¶ï¼ŒåŸä¸»åº“ä¹Ÿæ— æ³•æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚äº†ã€‚</p><p>è¿™æ ·ä¸€æ¥ï¼Œä¸»ä»åˆ‡æ¢å®Œæˆåï¼Œä¹Ÿåªæœ‰æ–°ä¸»åº“èƒ½æ¥æ”¶è¯·æ±‚ï¼Œä¸ä¼šå‘ç”Ÿè„‘è£‚ï¼Œä¹Ÿå°±ä¸ä¼šå‘ç”Ÿæ•°æ®ä¸¢å¤±çš„é—®é¢˜äº†ã€‚</p><h4 id="5-9-6-çŠ¶æ€æ£€æµ‹åŠç»´æŠ¤"><a href="#5-9-6-çŠ¶æ€æ£€æµ‹åŠç»´æŠ¤" class="headerlink" title="5.9.6 çŠ¶æ€æ£€æµ‹åŠç»´æŠ¤"></a>5.9.6 çŠ¶æ€æ£€æµ‹åŠç»´æŠ¤</h4><p>Redis Cluster ä¸­èŠ‚ç‚¹çŠ¶æ€å¦‚ä½•ç»´æŠ¤å‘¢ï¼Ÿè¿™äº›å°±æ¶‰åŠ æœ‰å“ªäº›çŠ¶æ€ã€åº•å±‚åè®®GossipåŠå…·ä½“çš„é€šè®¯æœºåˆ¶</p><p>Cluster ä¸­ æ¯ä¸ªèŠ‚ç‚¹éƒ½ç»´æŠ¤ä¸€ä»½åœ¨è‡ªå·±çœ‹æ¥å½“å‰æ•´ä¸ªé›†ç¾¤çš„çŠ¶æ€ï¼Œä¸»è¦åŒ…æ‹¬ï¼š</p><ul><li>å½“å‰é›†ç¾¤çš„çŠ¶æ€</li><li>é›†ç¾¤ä¸­å„èŠ‚ç‚¹æ‰€è´Ÿè´£çš„ slots ä¿¡æ¯åŠå…¶ migrate çŠ¶æ€</li><li>é›†ç¾¤ä¸­å„èŠ‚ç‚¹çš„ master-slave çŠ¶æ€</li><li>é›†ç¾¤ä¸­å„èŠ‚ç‚¹çš„å­˜æ´»çŠ¶æ€åŠä¸å¯è¾¾æŠ•ç¥¨</li></ul><p>å½“é›†ç¾¤çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼Œå¦‚ï¼šå¦‚æ–°èŠ‚ç‚¹åŠ å…¥ã€slotè¿ç§»ã€èŠ‚ç‚¹å®•æœºã€slaveæå‡ä¸ºæ–°Masterï¼Œæˆ‘ä»¬å¸Œæœ›è¿™äº›å˜åŒ–å°½å¿«çš„è¢«å‘ç°ï¼Œä¼ æ’­åˆ°æ•´ä¸ªé›†ç¾¤çš„æ‰€æœ‰èŠ‚ç‚¹å¹¶è¾¾æˆä¸€è‡´ã€‚èŠ‚ç‚¹ä¹‹é—´ç›¸äº’çš„<strong>å¿ƒè·³</strong>ï¼ˆPINGï¼ŒPONGï¼ŒMEETï¼‰åŠå…¶æºå¸¦çš„æ•°æ®æ˜¯é›†ç¾¤çŠ¶æ€ä¼ æ’­æœ€ä¸»è¦çš„é€”å¾„ã€‚</p><h5 id="Gossipåè®®"><a href="#Gossipåè®®" class="headerlink" title="Gossipåè®®"></a>Gossipåè®®</h5><p>Redis Cluster é€šè®¯åº•å±‚æ˜¯ Gossip åè®®ï¼Œæ‰€ä»¥éœ€è¦å¯¹ Gossip åè®®æœ‰ä¸€å®šäº†è§£</p><p>gossip åè®®ï¼ˆgossip protocolï¼‰åˆç§° epidemic åè®®ï¼ˆepidemic protocolï¼‰ï¼Œæ˜¯åŸºäºæµè¡Œç—…ä¼ æ’­æ–¹å¼çš„èŠ‚ç‚¹æˆ–è€…è¿›ç¨‹ä¹‹é—´ä¿¡æ¯äº¤æ¢çš„åè®®ã€‚ åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­è¢«å¹¿æ³›ä½¿ç”¨ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ gossip åè®®æ¥ç¡®ä¿ç½‘ç»œä¸­æ‰€æœ‰èŠ‚ç‚¹çš„æ•°æ®ä¸€æ ·ã€‚</p><p>Gossipåè®®å·²ç»æ˜¯P2Pç½‘ç»œä¸­æ¯”è¾ƒæˆç†Ÿçš„åè®®äº†ã€‚Gossipåè®®çš„æœ€å¤§çš„å¥½å¤„æ˜¯ï¼Œ<strong>å³ä½¿é›†ç¾¤èŠ‚ç‚¹çš„æ•°é‡å¢åŠ ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„è´Ÿè½½ä¹Ÿä¸ä¼šå¢åŠ å¾ˆå¤šï¼Œå‡ ä¹æ˜¯æ’å®šçš„ã€‚è¿™å°±å…è®¸Consulç®¡ç†çš„é›†ç¾¤è§„æ¨¡èƒ½æ¨ªå‘æ‰©å±•åˆ°æ•°åƒä¸ªèŠ‚ç‚¹</strong>ã€‚</p><p>Gossipç®—æ³•åˆè¢«ç§°ä¸ºåç†µï¼ˆAnti-Entropyï¼‰ï¼Œç†µæ˜¯ç‰©ç†å­¦ä¸Šçš„ä¸€ä¸ªæ¦‚å¿µï¼Œä»£è¡¨æ‚ä¹±æ— ç« ï¼Œè€Œåç†µå°±æ˜¯åœ¨æ‚ä¹±æ— ç« ä¸­å¯»æ±‚ä¸€è‡´ï¼Œè¿™å……åˆ†è¯´æ˜äº†Gossipçš„ç‰¹ç‚¹ï¼šåœ¨ä¸€ä¸ªæœ‰ç•Œç½‘ç»œä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½éšæœºåœ°ä¸å…¶ä»–èŠ‚ç‚¹é€šä¿¡ï¼Œç»è¿‡ä¸€ç•ªæ‚ä¹±æ— ç« çš„é€šä¿¡ï¼Œæœ€ç»ˆæ‰€æœ‰èŠ‚ç‚¹çš„çŠ¶æ€éƒ½ä¼šè¾¾æˆä¸€è‡´ã€‚æ¯ä¸ªèŠ‚ç‚¹å¯èƒ½çŸ¥é“æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹ï¼Œä¹Ÿå¯èƒ½ä»…çŸ¥é“å‡ ä¸ªé‚»å±…èŠ‚ç‚¹ï¼Œåªè¦è¿™äº›èŠ‚å¯ä»¥é€šè¿‡ç½‘ç»œè¿é€šï¼Œæœ€ç»ˆä»–ä»¬çš„çŠ¶æ€éƒ½æ˜¯ä¸€è‡´çš„ï¼Œå½“ç„¶è¿™ä¹Ÿæ˜¯ç–«æƒ…ä¼ æ’­çš„ç‰¹ç‚¹ã€‚<a href="https://www.backendcloud.cn/2017/11/12/raft-gossip/">https://www.backendcloud.cn/2017/11/12/raft-gossip/</a></p><p>ä¸Šé¢çš„æè¿°éƒ½æ¯”è¾ƒå­¦æœ¯ï¼Œå…¶å®Gossipåè®®å¯¹äºæˆ‘ä»¬åƒç“œç¾¤ä¼—æ¥è¯´ä¸€ç‚¹ä¹Ÿä¸é™Œç”Ÿï¼ŒGossipåè®®ä¹Ÿæˆä¸ºæµè¨€åè®®ï¼Œè¯´ç™½äº†å°±æ˜¯å…«å¦åè®®ï¼Œè¿™ç§ä¼ æ’­è§„æ¨¡å’Œä¼ æ’­é€Ÿåº¦éƒ½æ˜¯éå¸¸å¿«çš„ï¼Œä½ å¯ä»¥ä½“ä¼šä¸€ä¸‹ã€‚æ‰€ä»¥è®¡ç®—æœºä¸­çš„å¾ˆå¤šç®—æ³•éƒ½æ˜¯æºè‡ªç”Ÿæ´»ï¼Œè€Œåˆé«˜äºç”Ÿæ´»çš„</p><h5 id="Gossipåè®®çš„ä½¿ç”¨"><a href="#Gossipåè®®çš„ä½¿ç”¨" class="headerlink" title="Gossipåè®®çš„ä½¿ç”¨"></a>Gossipåè®®çš„ä½¿ç”¨</h5><p>Redis é›†ç¾¤æ˜¯å»ä¸­å¿ƒåŒ–çš„ï¼Œå½¼æ­¤ä¹‹é—´çŠ¶æ€åŒæ­¥è€ƒ gossip åè®®é€šè®¯ï¼Œé›†ç¾¤çš„æ¶ˆæ¯æœ‰ä»¥ä¸‹å‡ ç§ç±»å‹ï¼š</p><ul><li>Meet é€šè¿‡ cluster meet ip portå‘½ä»¤ï¼Œå·²æœ‰é›†ç¾¤çš„èŠ‚ç‚¹ä¼šå‘æ–°çš„èŠ‚ç‚¹å‘é€é‚€è¯·ï¼ŒåŠ å…¥ç°æœ‰é›†ç¾¤ã€‚</li><li>Ping èŠ‚ç‚¹æ¯ç§’ä¼šå‘é›†ç¾¤ä¸­å…¶ä»–èŠ‚ç‚¹å‘é€ ping æ¶ˆæ¯ï¼Œæ¶ˆæ¯ä¸­å¸¦æœ‰è‡ªå·±å·²çŸ¥çš„ä¸¤ä¸ªèŠ‚ç‚¹çš„åœ°å€ã€æ§½ã€çŠ¶æ€ä¿¡æ¯ã€æœ€åä¸€æ¬¡é€šä¿¡æ—¶é—´ç­‰</li><li>Pong èŠ‚ç‚¹æ”¶åˆ° ping æ¶ˆæ¯åä¼šå›å¤ pong æ¶ˆæ¯ï¼Œæ¶ˆæ¯ä¸­åŒæ ·å¸¦æœ‰è‡ªå·±å·²çŸ¥çš„ä¸¤ä¸ªèŠ‚ç‚¹ä¿¡æ¯</li><li>Fail èŠ‚ç‚¹ ping ä¸é€šæŸèŠ‚ç‚¹åï¼Œä¼šå‘é›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹å¹¿æ’­è¯¥èŠ‚ç‚¹æŒ‚æ‰çš„æ¶ˆæ¯ã€‚å…¶ä»–èŠ‚ç‚¹æ”¶åˆ°æ¶ˆæ¯åæ ‡è®°å·²ä¸‹çº¿ã€‚</li></ul><h5 id="åŸºäºGossip-åè®®çš„æ•…éšœæ£€æµ‹"><a href="#åŸºäºGossip-åè®®çš„æ•…éšœæ£€æµ‹" class="headerlink" title="åŸºäºGossip åè®®çš„æ•…éšœæ£€æµ‹"></a>åŸºäºGossip åè®®çš„æ•…éšœæ£€æµ‹</h5><p>é›†ç¾¤ä¸­æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šå®šæœŸåœ°å‘é›†ç¾¤ä¸­å…¶ä»–èŠ‚ç‚¹å‘é€ PING æ¶ˆæ¯ï¼Œä»¥æ­¤äº¤æ¢å„ä¸ªèŠ‚ç‚¹çŠ¶æ€ä¿¡æ¯ï¼Œæ£€æµ‹å„ä¸ªèŠ‚ç‚¹çŠ¶æ€ï¼š<strong>åœ¨çº¿çŠ¶æ€ã€ç–‘ä¼¼ä¸‹çº¿çŠ¶æ€ã€PFAILã€å·²ä¸‹çº¿çŠ¶æ€FAIL</strong></p><p><strong>è‡ªå·±ä¿å­˜ä¿¡æ¯</strong>ï¼šå½“ä¸»èŠ‚ç‚¹Aé€šè¿‡æ¶ˆæ¯å¾—çŸ¥ä¸»èŠ‚ç‚¹Bè®¤ä¸ºä¸»èŠ‚ç‚¹Dè¿›å…¥äº†ç–‘ä¼¼ä¸‹çº¿(PFAIL)çŠ¶æ€æ—¶,ä¸»èŠ‚ç‚¹Aä¼šåœ¨è‡ªå·±çš„clusterState.nodeså­—å…¸ä¸­æ‰¾åˆ°ä¸»èŠ‚ç‚¹Dæ‰€å¯¹åº”çš„clusterNodeç»“æ„ï¼Œå¹¶å°†ä¸»èŠ‚ç‚¹Bçš„ä¸‹çº¿æŠ¥å‘Šæ·»åŠ åˆ°clusterNodeç»“æ„çš„fail_reportsé“¾è¡¨ä¸­ï¼Œå¹¶åç»­å…³äºç»“ç‚¹Dç–‘ä¼¼ä¸‹çº¿çš„çŠ¶æ€é€šè¿‡Gossipåè®®é€šçŸ¥å…¶ä»–èŠ‚ç‚¹ã€‚</p><p><strong>ä¸€èµ·è£å®š</strong>ï¼šå¦‚æœé›†ç¾¤é‡Œé¢ï¼ŒåŠæ•°ä»¥ä¸Šçš„ä¸»èŠ‚ç‚¹éƒ½å°†ä¸»èŠ‚ç‚¹DæŠ¥å‘Šä¸ºç–‘ä¼¼ä¸‹çº¿ï¼Œé‚£ä¹ˆä¸»èŠ‚ç‚¹Då°†è¢«æ ‡è®°ä¸ºå·²ä¸‹çº¿(FAIL)çŠ¶æ€ï¼Œå°†ä¸»èŠ‚ç‚¹Dæ ‡è®°ä¸ºå·²ä¸‹çº¿çš„èŠ‚ç‚¹ä¼šå‘é›†ç¾¤å¹¿æ’­ä¸»èŠ‚ç‚¹Dçš„FAILæ¶ˆæ¯ï¼Œæ‰€æœ‰æ”¶åˆ°FAILæ¶ˆæ¯çš„èŠ‚ç‚¹éƒ½ä¼šç«‹å³æ›´æ–°nodesé‡Œé¢ä¸»èŠ‚ç‚¹DçŠ¶æ€æ ‡è®°ä¸ºå·²ä¸‹çº¿ã€‚</p><p><strong>æœ€ç»ˆè£å®š</strong>ï¼šå°† node æ ‡è®°ä¸º FAIL éœ€è¦æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶ï¼š</p><ul><li>æœ‰åŠæ•°ä»¥ä¸Šçš„ä¸»èŠ‚ç‚¹å°† node æ ‡è®°ä¸º PFAIL çŠ¶æ€ã€‚</li><li>å½“å‰èŠ‚ç‚¹ä¹Ÿå°† node æ ‡è®°ä¸º PFAIL çŠ¶æ€ã€‚</li></ul><h4 id="5-9-7-é€šè®¯çŠ¶æ€å’Œç»´æŠ¤"><a href="#5-9-7-é€šè®¯çŠ¶æ€å’Œç»´æŠ¤" class="headerlink" title="5.9.7 é€šè®¯çŠ¶æ€å’Œç»´æŠ¤"></a>5.9.7 é€šè®¯çŠ¶æ€å’Œç»´æŠ¤</h4><p>æˆ‘ä»¬ç†è§£äº†Gossipåè®®åŸºç¡€åï¼Œå°±å¯ä»¥è¿›ä¸€æ­¥ç†è§£RedisèŠ‚ç‚¹ä¹‹é—´ç›¸äº’çš„é€šè®¯<strong>å¿ƒè·³</strong>ï¼ˆPINGï¼ŒPONGï¼ŒMEETï¼‰å®ç°å’Œç»´æŠ¤äº†</p><ol><li>ä»€ä¹ˆæ—¶å€™è¿›è¡Œå¿ƒè·³ï¼ŸRedis èŠ‚ç‚¹ä¼šè®°å½•å…¶å‘æ¯ä¸ªèŠ‚ç‚¹ä¸Šæ¬¡å‘å‡º ping å’Œæ”¶åˆ° pong çš„æ—¶é—´ï¼Œå¿ƒè·³å‘é€æ—¶æœºä¸è¿™ä¸¤ä¸ªå€¼æœ‰å…³ã€‚é€šè¿‡ä¸‹é¢çš„æ–¹å¼æ—¢èƒ½ä¿è¯åŠæ—¶æ›´æ–°é›†ç¾¤çŠ¶æ€ï¼Œåˆä¸è‡³äºä½¿å¿ƒè·³æ•°è¿‡å¤šï¼š</li></ol><ul><li><ul><li>æ¯æ¬¡Cronå‘æ‰€æœ‰æœªå»ºç«‹é“¾æ¥çš„èŠ‚ç‚¹å‘é€pingæˆ–meet</li><li>æ¯1ç§’ä»æ‰€æœ‰å·²çŸ¥èŠ‚ç‚¹ä¸­éšæœºé€‰å–5ä¸ªï¼Œå‘å…¶ä¸­ä¸Šæ¬¡æ”¶åˆ°pongæœ€ä¹…è¿œçš„ä¸€ä¸ªå‘é€ping</li><li>æ¯æ¬¡Cronå‘æ”¶åˆ°pongè¶…è¿‡timeout&#x2F;2çš„èŠ‚ç‚¹å‘é€ping</li><li>æ”¶åˆ°pingæˆ–meetï¼Œç«‹å³å›å¤pong</li></ul></li></ul><ol><li>å‘é€é‚£äº›å¿ƒè·³æ•°æ®ï¼Ÿ</li></ol><ul><li><ul><li>Headerï¼Œå‘é€è€…è‡ªå·±çš„ä¿¡æ¯ï¼šæ‰€è´Ÿè´£çš„ slots çš„ä¿¡æ¯ï¼›ä¸»ä»ä¿¡æ¯ï¼›ip port ä¿¡æ¯ï¼›çŠ¶æ€ä¿¡æ¯</li><li>Gossipï¼Œå‘é€è€…æ‰€äº†è§£çš„éƒ¨åˆ†å…¶ä»–èŠ‚ç‚¹çš„ä¿¡æ¯ï¼šping_sentã€pong_receivedï¼›ip portä¿¡æ¯ï¼›çŠ¶æ€ä¿¡æ¯ï¼ˆæ¯”å¦‚å‘é€è€…è®¤ä¸ºè¯¥èŠ‚ç‚¹å·²ç»ä¸å¯åˆ°è¾¾ï¼Œä¼šåœ¨çŠ¶æ€ä¿¡æ¯ä¸­æ ‡è®°å…¶ä¸º PFAILæˆ–FAILï¼‰</li></ul></li></ul><ol><li>å¦‚ä½•å¤„ç†å¿ƒè·³</li></ol><ul><li><ul><li>æ–°èŠ‚ç‚¹åŠ å…¥</li></ul></li></ul><ol><li><ol><li><ol><li>å‘é€meetåŒ…åŠ å…¥é›†ç¾¤</li><li>ä»pongåŒ…ä¸­çš„ gossip å¾—åˆ°æœªçŸ¥çš„å…¶ä»–èŠ‚ç‚¹</li><li>å¾ªç¯ä¸Šè¿°è¿‡ç¨‹ï¼Œç›´åˆ°æœ€ç»ˆåŠ å…¥é›†ç¾¤</li></ol></li></ol></li></ol><ul><li><ul><li>Slots ä¿¡æ¯</li></ul></li></ul><ol><li><ol><li><ol><li>åˆ¤æ–­å‘é€è€…å£°æ˜çš„ slots ä¿¡æ¯ï¼Œè·Ÿæœ¬åœ°è®°å½•çš„æ˜¯å¦ä¸åŒ</li><li>å¦‚æœä¸åŒï¼Œä¸”å‘é€è€… epochè¾ƒå¤§ï¼Œæ›´æ–°æœ¬åœ°è®°å½•</li><li>å¦‚æœä¸åŒï¼Œä¸”å‘é€è€… epochè¾ƒå°ï¼Œå‘é€ Update ä¿¡æ¯é€šçŸ¥å‘é€è€…</li></ol></li></ol></li></ol><ul><li><ul><li>Master slaveä¿¡æ¯å‘ç°å‘é€è€…çš„masterã€slaveä¿¡æ¯å˜åŒ–ï¼Œæ›´æ–°æœ¬åœ°çŠ¶æ€</li><li>èŠ‚ç‚¹Failæ¢æµ‹ï¼ˆæ•…éšœå‘ç°ï¼‰Gossipçš„å­˜åœ¨ä½¿å¾—é›†ç¾¤çŠ¶æ€çš„æ”¹å˜å¯ä»¥æ›´å¿«çš„è¾¾åˆ°æ•´ä¸ªé›†ç¾¤ã€‚æ¯ä¸ªå¿ƒè·³åŒ…ä¸­ä¼šåŒ…å«å¤šä¸ªGossipåŒ…ï¼Œé‚£ä¹ˆå¤šå°‘ä¸ªæ‰æ˜¯åˆé€‚çš„å‘¢ï¼Œredisçš„é€‰æ‹©æ˜¯N&#x2F;10ï¼Œå…¶ä¸­Næ˜¯èŠ‚ç‚¹æ•°ï¼Œè¿™æ ·å¯ä»¥ä¿è¯åœ¨PFAILæŠ•ç¥¨çš„è¿‡æœŸæ—¶é—´å†…ï¼ŒèŠ‚ç‚¹å¯ä»¥æ”¶åˆ°80%æœºå™¨å…³äºå¤±è´¥èŠ‚ç‚¹çš„gossipï¼Œä»è€Œä½¿å…¶é¡ºåˆ©è¿›å…¥FAILçŠ¶æ€ã€‚</li></ul></li></ul><ol><li><ol><li><ol><li>è¶…è¿‡è¶…æ—¶æ—¶é—´ä»ç„¶æ²¡æœ‰æ”¶åˆ° pong åŒ…çš„èŠ‚ç‚¹ä¼šè¢«å½“å‰èŠ‚ç‚¹æ ‡è®°ä¸º PFAIL</li><li>PFAIL æ ‡è®°ä¼šéšç€ gossip ä¼ æ’­</li><li>æ¯æ¬¡æ”¶åˆ°å¿ƒè·³åŒ…ä¼šæ£€æµ‹å…¶ä¸­å¯¹å…¶ä»–èŠ‚ç‚¹çš„ PFAIL æ ‡è®°ï¼Œå½“åšå¯¹è¯¥èŠ‚ç‚¹çš„FAILçš„æŠ•ç¥¨ç»´æŠ¤åœ¨æœ¬æœº</li><li>å¯¹æŸä¸ªèŠ‚ç‚¹çš„ PFAILæ ‡è®°è¾¾åˆ°å¤§å¤šæ•°æ—¶ï¼Œå°†å…¶å˜ä¸º FAIL æ ‡è®°å¹¶å¹¿æ’­ FAILæ¶ˆæ¯</li></ol></li></ol></li><li><p>åªèƒ½é€šè¿‡ gossip + å¿ƒè·³ ä¼ é€’ä¿¡æ¯ï¼Ÿå½“éœ€è¦å‘å¸ƒä¸€äº›éå¸¸é‡è¦éœ€è¦ç«‹å³å‘é€çš„ä¿¡æ¯æ—¶ï¼Œä¸Šè¿° å¿ƒè·³+Gossipçš„æ–¹å¼å°±æ˜¾å¾—æ‰è¥Ÿè§è‚˜äº†ã€‚è¿™æ—¶å°±éœ€è¦å‘æ‰€æœ‰é›†ç¾¤å†…æœºå™¨å¹¿æ’­ä¿¡æ¯ï¼Œä½¿ç”¨å¹¿æ’­å‘çš„åœºæ™¯ï¼š</p></li></ol><ul><li><ul><li>èŠ‚ç‚¹çš„ Fail ä¿¡æ¯ï¼šå½“å‘ç°æŸä¸€ä¸ªèŠ‚ç‚¹ä¸å¯è¾¾æ—¶ï¼Œæ¢æµ‹èŠ‚ç‚¹ä¼šå°†å…¶æ ‡è®°ä¸º PFAILçŠ¶æ€ï¼Œå¹¶é€šè¿‡å¿ƒè·³ä¼ æ’­å‡ºå»ã€‚å½“æŸä¸€ä¸ªèŠ‚ç‚¹å‘ç°è¿™ä¸ªèŠ‚ç‚¹çš„ PFAIL è¶…è¿‡åŠæ•°æ—¶ä¿®æ”¹å…¶ä¸º FAIL å¹¶å‘èµ·å¹¿æ’­ã€‚</li><li>Failover Request ä¿¡æ¯ï¼šslave å°è¯•å‘èµ· FailOveræ—¶ å¹¿æ’­å…¶è¦æ±‚æŠ•ç¥¨çš„ä¿¡æ¯</li><li>æ–° Master ä¿¡æ¯ï¼šFailOveræˆåŠŸçš„èŠ‚ç‚¹å‘æ•´ä¸ªé›†ç¾¤å¹¿æ’­è‡ªå·±çš„ä¿¡æ¯</li></ul></li></ul><h4 id="5-9-8-æ‰©å®¹ã€ç¼©å®¹"><a href="#5-9-8-æ‰©å®¹ã€ç¼©å®¹" class="headerlink" title="5.9.8 æ‰©å®¹ã€ç¼©å®¹"></a>5.9.8 æ‰©å®¹ã€ç¼©å®¹</h4><p>å½“é›†ç¾¤å‡ºç°å®¹é‡é™åˆ¶æˆ–è€…å…¶ä»–ä¸€äº›åŸå› éœ€è¦æ‰©å®¹æ—¶ï¼Œredis clusteræä¾›äº†æ¯”è¾ƒä¼˜é›…çš„é›†ç¾¤æ‰©å®¹æ–¹æ¡ˆã€‚</p><ol><li>é¦–å…ˆå°†æ–°èŠ‚ç‚¹åŠ å…¥åˆ°é›†ç¾¤ä¸­ï¼Œå¯ä»¥é€šè¿‡åœ¨é›†ç¾¤ä¸­ä»»ä½•ä¸€ä¸ªå®¢æˆ·ç«¯æ‰§è¡Œcluster meet æ–°èŠ‚ç‚¹ip:ç«¯å£ï¼Œæˆ–è€…é€šè¿‡redis-trib add nodeæ·»åŠ ï¼Œæ–°æ·»åŠ çš„èŠ‚ç‚¹é»˜è®¤åœ¨é›†ç¾¤ä¸­éƒ½æ˜¯ä¸»èŠ‚ç‚¹ã€‚</li><li>è¿ç§»æ•°æ® è¿ç§»æ•°æ®çš„å¤§è‡´æµç¨‹æ˜¯ï¼Œé¦–å…ˆéœ€è¦ç¡®å®šå“ªäº›æ§½éœ€è¦è¢«è¿ç§»åˆ°ç›®æ ‡èŠ‚ç‚¹ï¼Œç„¶åè·å–æ§½ä¸­keyï¼Œå°†æ§½ä¸­çš„keyå…¨éƒ¨è¿ç§»åˆ°ç›®æ ‡èŠ‚ç‚¹ï¼Œç„¶åå‘é›†ç¾¤æ‰€æœ‰ä¸»èŠ‚ç‚¹å¹¿æ’­æ§½ï¼ˆæ•°æ®ï¼‰å…¨éƒ¨è¿ç§»åˆ°äº†ç›®æ ‡èŠ‚ç‚¹ã€‚ç›´æ¥é€šè¿‡redis-tribå·¥å…·åšæ•°æ®è¿ç§»å¾ˆæ–¹ä¾¿ã€‚ ç°åœ¨å‡è®¾å°†èŠ‚ç‚¹Açš„æ§½10è¿ç§»åˆ°BèŠ‚ç‚¹ï¼Œè¿‡ç¨‹å¦‚ä¸‹ï¼š</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">B:cluster setslot 10 importing A.nodeId</span><br><span class="line">A:cluster setslot 10 migrating B.nodeId</span><br></pre></td></tr></table></figure><p>å¾ªç¯è·å–æ§½ä¸­keyï¼Œå°†keyè¿ç§»åˆ°BèŠ‚ç‚¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A:cluster getkeysinslot 10 100</span><br><span class="line">A:migrate B.ip B.port &quot;&quot; 0 5000 keys key1[ key2....]</span><br></pre></td></tr></table></figure><p>å‘é›†ç¾¤å¹¿æ’­æ§½å·²ç»è¿ç§»åˆ°BèŠ‚ç‚¹</p><p>cluster setslot 10 node B.nodeId</p><p>ç¼©å®¹çš„å¤§è‡´è¿‡ç¨‹ä¸æ‰©å®¹ä¸€è‡´ï¼Œéœ€è¦åˆ¤æ–­ä¸‹çº¿çš„èŠ‚ç‚¹æ˜¯å¦æ˜¯ä¸»èŠ‚ç‚¹ï¼Œä»¥åŠä¸»èŠ‚ç‚¹ä¸Šæ˜¯å¦æœ‰æ§½ï¼Œè‹¥ä¸»èŠ‚ç‚¹ä¸Šæœ‰æ§½ï¼Œéœ€è¦å°†æ§½è¿ç§»åˆ°é›†ç¾¤ä¸­å…¶ä»–ä¸»èŠ‚ç‚¹ï¼Œæ§½è¿ç§»å®Œæˆä¹‹åï¼Œéœ€è¦å‘å…¶ä»–èŠ‚ç‚¹å¹¿æ’­è¯¥èŠ‚ç‚¹å‡†å¤‡ä¸‹çº¿ï¼ˆcluster forget nodeIdï¼‰ã€‚æœ€åéœ€è¦å°†è¯¥ä¸‹çº¿ä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹æŒ‡å‘å…¶ä»–ä¸»èŠ‚ç‚¹ï¼Œå½“ç„¶æœ€å¥½æ˜¯å…ˆå°†ä»èŠ‚ç‚¹ä¸‹çº¿</p><h4 id="5-9-9-Write-Safety-åˆ†æ"><a href="#5-9-9-Write-Safety-åˆ†æ" class="headerlink" title="5.9.9 Write Safety åˆ†æ"></a>5.9.9 Write Safety åˆ†æ</h4><p><a href="https://segmentfault.com/a/1190000039226390">https://segmentfault.com/a/1190000039226390</a></p><p>Redis Cluster æ˜¯ Redis çš„åˆ†å¸ƒå¼å®ç°ï¼Œå°±å¦‚åŒå®˜æ–¹æ–‡æ¡£é‡Œå¼ºè°ƒçš„ï¼Œå…¶è®¾è®¡ä¼˜å…ˆè€ƒè™‘çš„æ˜¯ é«˜æ€§èƒ½å’Œçº¿æ€§æ‰©å±•èƒ½åŠ›ï¼Œå°½é‡ä¿è¯ write safetyã€‚è¿™é‡Œæ‰€è¯´çš„ write ä¸¢å¤±æ˜¯æŒ‡ï¼Œå›å¤ å®¢æˆ·ç«¯å“åº”åï¼Œåç»­è¯·æ±‚ä¸­å‡ºç°æœªåšå˜æ›´æˆ–è€…ä¸¢å¤±çš„æƒ…å†µã€‚å¯¼è‡´è¯¥é—®é¢˜ï¼Œä¸»è¦åœ¨ ä¸»ä»åˆ‡æ¢ã€å®ä¾‹é‡å¯ã€è„‘è£‚ä¸‰ç§æƒ…å†µä¸‹ã€‚</p><ul><li><p>ä¸»ä»åˆ‡æ¢</p></li><li><ul><li>è¢«åŠ¨ failoveræƒ…æ™¯ï¼šmaster c ä¸ºä¸»èŠ‚ç‚¹ï¼Œè´Ÿè´£ slot 1-100ï¼Œå…¶å¯¹åº”çš„ä»èŠ‚ç‚¹æ˜¯ slave cã€‚å½“master cæŒ‚æ‰åï¼Œslave c åœ¨ æœ€å¤š2å€ cluster_node_timeout çš„æ—¶é—´ å†…æŠŠ master c æ ‡è®°æˆ FALL,è¿›è€Œè§¦å‘ failover é€»è¾‘ã€‚åœ¨ slave c æˆåŠŸåˆ‡æ¢ä¸º masterå‰ï¼Œslot 1-100 ä»ç„¶ç”± master c è´Ÿè´£ï¼Œè®¿é—®ä¹Ÿä¼šæŠ¥é”™ã€‚å½“ slave c åˆ‡æ¢ä¸º master åï¼Œgossip å¹¿æ’­è·¯ç”±å˜æ›´ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œclient è®¿é—® slave cï¼Œä»ç„¶å¯ä»¥å¾—åˆ°æ­£å¸¸å›åº”ï¼Œè€Œè®¿é—®å…¶ä»–æŒæœ‰è€è·¯ç”±çš„ nodeï¼Œè¯·æ±‚ä¼šè¢« moved åˆ°æŒ‚æ‰çš„ master cï¼Œè®¿é—®æŠ¥é”™ã€‚é—®é¢˜ï¼šå¦‚æœå†™åˆ° master ä¸Šçš„æ•°æ®è¿˜æ²¡æ¥å¾—åŠåŒæ­¥åˆ° slave å°±æŒ‚æ‰äº†ï¼Œé‚£ä¹ˆè¿™éƒ¨åˆ†æ•°æ®å°±ä¼šä¸¢å¤±ï¼ˆé‡å¯åä¸å­˜åœ¨ mergeæ“ä½œï¼‰ã€‚å³å†™å…¥çš„æ•°æ®ä¸¢å¤±ã€‚master å›å¤ client ack äº åŒæ­¥ slave å‡ ä¹åŒæ—¶è¿›è¡Œçš„ï¼Œè¿™ç§æƒ…å†µå¾ˆå°‘å‘ç”Ÿï¼ˆæ—¶é—´çª—å£å°ï¼‰ï¼Œä½†æ˜¯è¿™å­˜åœ¨è¿™ä¸ªé£é™©</li><li>ä¸»åŠ¨ failoverä¸»åŠ¨ failover é€šè¿‡ sysadmin åœ¨ slave node ä¸Šæ‰§è¡Œ CLUSTER FAILOVER [FORCE|TAKEOVER] å‘½ä»¤è§¦å‘ã€‚å®Œæ•´çš„ manual failover å¯ä»¥æ¦‚æ‹¬ä¸ºä»¥ä¸‹æ­¥éª¤ï¼šè¯¥å‘½ä»¤çš„ä¸‰ä¸ªé€‰é¡¹åˆ†åˆ«ç”±ä¸åŒçš„è¡Œä¸ºï¼š</li></ul></li></ul><ol><li><ol><li><ol><li>slave å‘èµ·è¯·æ±‚ï¼Œgossip æ¶ˆæ¯æºå¸¦ <strong>CLUSTERMSG_TYPE_MFSTART</strong> æ ‡è¯†ã€‚</li><li>master é˜»å¡ clientï¼Œåœæœæ—¶é—´ä¸º 2 å€ <strong>CLUSTER_MF_TIMEOUT</strong>ï¼Œç›®å‰ç‰ˆæœ¬ä¸º 10sã€‚</li><li>slave è¿½èµ¶ä¸»ä»å¤åˆ¶ offset æ•°æ®ã€‚</li><li>slave å¼€å§‹å‘èµ·é€‰ä¸¾ï¼Œå¹¶æœ€ç»ˆå½“é€‰ã€‚</li><li>slave åˆ‡æ¢è‡ªèº« roleï¼Œæ¥ç®¡ slotsï¼Œå¹¶å¹¿æ’­æ–°çš„è·¯ç”±ä¿¡æ¯ã€‚</li><li>å…¶ä»–èŠ‚ç‚¹æ›´æ”¹è·¯ç”±ï¼Œcluster è·¯ç”±æ‰“å¹³ã€‚</li></ol></li></ol></li></ol><ul><li><ul><li><ul><li>é»˜è®¤é€‰é¡¹ï¼šæ‰§è¡Œå®Œæ•´çš„ mf æµç¨‹ï¼Œmaster ç”±åœæœè¡Œä¸ºï¼Œå› æ­¤ä¸å­˜åœ¨writeä¸¢å¤±é—®é¢˜ã€‚</li><li>FORCEé€‰é¡¹ï¼šä»ç¬¬å››æ­¥å¼€å§‹æ‰§è¡Œã€‚åœ¨ slave c ç»Ÿè®¡é€‰ç¥¨é˜¶æ®µï¼Œmaster c ä»ç„¶å¯ä»¥æ­£å¸¸æ¥æ”¶ç”¨æˆ·è¯·æ±‚ï¼Œä¸”ä¸»ä»å¼‚æ­¥å¤åˆ¶ï¼Œè¿™äº›éƒ½å¯èƒ½å¯¼è‡´ write ä¸¢å¤±ã€‚mf å°†åœ¨æœªæ¥çš„æŸä¸ªæ—¶é—´ç‚¹å¼€å§‹æ‰§è¡Œï¼Œtimeout æ—¶é—´ä¸º <strong>CLUSTER_MF_TIMEOUT</strong>ï¼ˆç°ç‰ˆæœ¬ä¸º 5sï¼‰ï¼Œæ¯æ¬¡ clusterCron éƒ½ä¼šæ£€æŸ¥ã€‚</li><li>TAKEOVERé€‰é¡¹ï¼šä»ç¬¬äº”æ­¥å¼€å§‹æ‰§è¡Œã€‚slave ç›´æ¥å¢åŠ è‡ªå·±çš„ configEpochï¼ˆæ— éœ€å…¶ä»–nodeåŒæ„ï¼‰ï¼Œæ¥ç®¡ slotsã€‚ä» slave cåˆ‡æ¢ä¸º master åˆ° åŸ master c æ›´æ–°è·¯ç”± è¿™æ®µæœŸé—´ï¼Œå‘é€åˆ° åŸmaster ä»çš„è¯·æ±‚ï¼Œéƒ½å¯èƒ½å­˜åœ¨ write ä¸¢å¤±çš„å¯èƒ½ã€‚ä¸€èˆ¬åœ¨ä¸€ä¸ª ping çš„æ—¶é—´å†…å®Œæˆï¼Œæ—¶é—´çª—å£å¾ˆå°ã€‚master c å’Œ slave c ä»¥å¤–èŠ‚ç‚¹æ›´æ–°è·¯ç”±æ»ååªä¼šå¸¦æ¥å¤šä¸€æ¬¡çš„ moved é”™è¯¯ï¼Œä¸ä¼šå¯¼è‡´ write ä¸¢å¤±ã€‚</li></ul></li></ul></li><li><p>master é‡å¯clusterState ç»“æ„ä½“ä¸­æœ‰ä¸€ä¸ª <strong>state</strong> æˆå‘˜å˜é‡ï¼Œè¡¨ç¤º cluster çš„å…¨å±€çŠ¶æ€ï¼Œæ§åˆ¶ç€å½“å‰ cluster æ˜¯å¦å¯ä»¥æä¾›æœåŠ¡ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç§å–å€¼ï¼š</p></li><li><ul><li>cluster çŠ¶æ€åˆå§‹åŒ–</li></ul></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#define CLUSTER_OK 0 /* Everything looks ok */</span><br><span class="line"> #define CLUSTER_FAIL 1 /* The cluster can&#x27;t work */</span><br></pre></td></tr></table></figure><p>server é‡å¯åï¼Œstate è¢«åˆå§‹åŒ–ä¸º <strong>CLUSTER_FAIL</strong>ï¼Œæ­¤çŠ¶æ€ä¸‹çš„ cluster æ˜¯æ‹’ç»è®¿é—®çš„ã€‚è¿™å¯¹ä¿è¯ write safety æ˜¯éå¸¸å¿…è¦çš„ï¼å¯ä»¥æƒ³è±¡ï¼Œå¦‚æœ master A æŒ‚æ‰åï¼Œå¯¹åº”çš„ slave Aâ€™ é€šè¿‡é€‰ä¸¾æˆåŠŸå½“é€‰ä¸ºæ–° masterã€‚æ­¤æ—¶ï¼ŒA é‡å¯ï¼Œä¸”æ°å¥½æœ‰ä¸€äº› client çœ‹åˆ°çš„è·¯ç”±æ²¡æœ‰æ›´æ–°ï¼Œå®ƒä»¬ä»ç„¶ä¼šå¾€ A ä¸Šå†™æ•°æ®ï¼Œå¦‚æœæ¥å—è¿™äº› writeï¼Œå°±ä¼šä¸¢æ•°æ®ï¼Aâ€™ æ‰æ˜¯è¿™ä¸ª sharding å¤§å®¶å…¬è®¤çš„ masterã€‚æ‰€ä»¥ï¼ŒAâ€™ é‡å¯åéœ€è¦å…ˆç¦ç”¨æœåŠ¡ï¼Œç›´åˆ°è·¯ç”±å˜æ›´å®Œæˆã€‚æ‰€ä»¥å¦‚æœ <strong>CLUSTER_WRITABLE_DELAY</strong> å†…ï¼Œæœªèƒ½æ›´æ–°è·¯ç”±ï¼Œå¯èƒ½å°±å¯¼è‡´ write ä¸¢å¤±ã€‚</p><ul><li><ul><li>cluster çŠ¶æ€å˜æ›´ä»€ä¹ˆæ—¶å€™ cluster æ‰ä¼šå‡ºç° <strong>CLUSTER_FAIL</strong> -&gt; <strong>CLUSTER_OK</strong> çš„çŠ¶æ€å˜æ›´å‘¢ã€‚ä» clusterCron å®šæ—¶ä»»åŠ¡ä¸­ï¼Œå¯ä»¥çŸ¥é“ clusterCronçŠ¶æ€å˜æ›´è¦å»¶è¿Ÿ <strong>CLUSTER_WRITABLE_DELAY</strong> æ¯«ç§’ï¼Œå½“å‰ç‰ˆæœ¬æ˜¯2sã€‚è®¿é—®å»¶è¿Ÿå°±æ˜¯ä¸ºç­‰å¾… è·¯ç”±å˜æ›´ï¼Œé‚£ä¹ˆä»€ä¹ˆæ—¶å€™è§¦å‘è·¯ç”±å˜æ›´å‘¢ï¼Ÿä¸€ä¸ªæ–° server åˆšå¯åŠ¨ï¼Œå®ƒä¸å…¶ä»– node è¿›è¡Œ gossip é€šä¿¡çš„ link éƒ½æ˜¯ nullï¼Œåœ¨ clusterCron é‡Œæ£€æŸ¥å‡ºæ¥åä¼šä¾æ¬¡è¿æ¥ï¼Œå¹¶å‘é€ pingã€‚ä½œä¸ºä¸€ä¸ªè·¯ç”±è¿‡æœŸçš„è€èŠ‚ç‚¹ï¼Œæ”¶åˆ°å…¶ä»–èŠ‚ç‚¹å‘æ¥çš„ update æ¶ˆæ¯ï¼Œæ›´æ”¹è‡ªèº«è·¯ç”±ã€‚<strong>CLUSTER_WRITABLE_DELAY</strong> æ¯«ç§’åï¼ŒA èŠ‚ç‚¹æ¢å¤è®¿é—®ï¼Œæˆ‘ä»¬è®¤ä¸º CLUSTER_WRITABLE_DELAY çš„æ—¶é—´çª—å£è¶³å¤Ÿæ›´æ–°è·¯ç”±ã€‚</li></ul></li><li><p>ç½‘ç»œåˆ†åŒº</p></li><li><ul><li>ç½‘ç»œåˆ†åŒºå‘ç”Ÿç”±äºç½‘ç»œçš„ä¸å¯é ï¼Œç½‘ç»œåˆ†åŒºæ—¶ä¸€ä¸ªå¿…é¡»è¦è€ƒè™‘çš„é—®é¢˜ã€‚å½“ç½‘ç»œåˆ†åŒºå‘ç”Ÿåï¼Œcluster è¢«å‰²è£‚æˆ majority å’Œ minority ä¸¤éƒ¨åˆ†ï¼Œè¿™é‡Œä»¥åˆ†åŒºä¸­çš„ master èŠ‚ç‚¹æ¥åŒºåˆ†ã€‚</li></ul></li></ul><ol><li><ol><li><ol><li>å¯¹äº minority éƒ¨åˆ†ï¼Œslave ä¼šå‘èµ·é€‰ä¸¾ï¼Œä½†æ˜¯ä¸èƒ½æ”¶åˆ°å¤§å¤šæ•° master çš„é€‰ç¥¨ï¼Œä¹Ÿå°±æ— æ³•å®Œæˆæ­£å¸¸çš„ failover æµç¨‹ã€‚åŒæ—¶åœ¨ clusterCron é‡Œçš„å¤§éƒ¨åˆ†èŠ‚ç‚¹ä¼šè¢«æ ‡è®°ä¸º <strong>CLUSTER_NODE_PFAIL</strong> çŠ¶æ€ï¼Œè¿›è€Œè§¦å‘é›†ç¾¤çŠ¶æ€æ›´æ–°ã€‚åœ¨ minority ä¸­ï¼Œcluster çŠ¶æ€åœ¨ä¸€æ®µæ—¶é—´åï¼Œä¼šè¢«æ›´æ”¹ä¸º <strong>CLUSTER_FAIL</strong>ã€‚ä½†ï¼Œå¯¹äºä¸€ä¸ªåˆ’åˆ†åˆ° minority çš„ master èŠ‚ç‚¹ï¼Œåœ¨çŠ¶æ€æ›´æ”¹å‰æ˜¯ä¸€ç›´å¯ä»¥è®¿é—®çš„ï¼Œè¿™å°±æœ‰ä¸€ä¸ªæ—¶é—´çª—å£ï¼Œä¼šå¯¼è‡´ write ä¸¢å¤±ã€‚åœ¨ clusterCron å‡½æ•°ä¸­å¯ä»¥è®¡ç®—å‡ºè¿™ä¸ªæ—¶é—´çª—å£å¤§å°ï¼šä» partition æ—¶é—´å¼€å§‹ç®—èµ·ï¼Œ<strong>cluster_node_timeout</strong> æ—¶é—´åæ‰ä¼šæœ‰ node æ ‡è®°ä¸º PFAILï¼ŒåŠ ä¸Š gossip æ¶ˆæ¯ä¼ æ’­ä¼šåå‘äºæºå¸¦ PFAIL çš„èŠ‚ç‚¹ï¼ŒmasterèŠ‚ç‚¹ ä¸å¿…ç­‰åˆ° <strong>cluster_node_timeout&#x2F;2</strong> æŠŠ cluster nodes ping éï¼Œå°±å¯ä»¥æŠŠ cluster æ ‡è®°ä¸º <strong>CLUSTER_FAIL</strong>å¯ä»¥æ¨ç®—å‡ºï¼Œæ—¶é—´çª—å£å¤§çº¦ä¸º <strong>cluster_node_timeout</strong>ã€‚å¦å¤–ï¼Œä¼šè®°å½•ä¸‹ç¦ç”¨æœåŠ¡çš„æ—¶é—´ï¼Œå³ among_minority_time</li><li>å¯¹äº majority éƒ¨åˆ†ï¼Œslave ä¼šå‘èµ·é€‰ä¸¾ï¼Œåˆ‡æ¢ä¸ºæ–°çš„masterå¹¶æä¾›æœåŠ¡ã€‚å¦‚æœpartition æ—¶é—´å°äº cluster_node_timeout,ä»¥è‡³äºæ²¡æœ‰ PFAIL æ ‡è¯†å‡ºç°ï¼Œå°±ä¸ä¼šæœ‰ write ä¸¢å¤±ã€‚</li></ol></li></ol></li></ol><ul><li><ul><li>ç½‘ç»œåˆ†åŒºæ¢å¤å½“ç½‘ç»œåˆ†åŒºæ¢å¤åï¼Œminority ä¸­ è€çš„master é‡æ–°åŠ è¿› clusterï¼Œmaster è¦æƒ³æä¾›æœåŠ¡ï¼Œå°±å¿…é¡»å…ˆå°† cluster çŠ¶æ€ä» <strong>CLUSTER_FAIL</strong> ä¿®æ”¹ä¸º <strong>CLUSTER_OK</strong>ï¼Œé‚£ä¹ˆï¼Œåº”è¯¥ä»€ä¹ˆæ—¶å€™æ”¹å‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“ è€masterä¸­åº”è¯¥æ˜¯æ—§è·¯ç”±ï¼Œæ­¤æ—¶å®ƒåº”è¯¥å˜æ›´ä¸º slaveï¼Œæ‰€ä»¥ï¼Œè¿˜æ˜¯éœ€è¦ç­‰å¾…ä¸€æ®µæ—¶é—´åšè·¯ç”±å˜æ›´ï¼Œå¦åˆ™æœ‰å¯èƒ½å‡ºç° write ä¸¢å¤±çš„é—®é¢˜ã€‚ä» clusterUpdateState å‡½æ•°çš„é€»è¾‘é‡Œï¼Œå¯ä»¥çœ‹å‡ºæ—¶é—´çª—å£ä¸º <strong>cluster_node_timeout</strong></li></ul></li></ul><p>æ€»ç»“ï¼š</p><p>failover å¯èƒ½å› ä¸ºé€‰ä¸¾å’Œä¸»ä»å¼‚æ­¥å¤åˆ¶æ•°æ®åå·®å¸¦æ¥ write ä¸¢å¤±ã€‚master é‡å¯é€šè¿‡ <strong>CLUSTER_WRITABLE_DELAY</strong> å»¶è¿Ÿï¼Œç­‰ cluster çŠ¶æ€å˜æ›´ä¸º <strong>CLUSTER_OK</strong>ï¼Œå¯ä»¥é‡æ–°è®¿é—®ï¼Œä¸å­˜åœ¨ write ä¸¢å¤±ã€‚partition ä¸­çš„ minority éƒ¨åˆ†ï¼Œåœ¨ cluster çŠ¶æ€å˜æ›´ä¸º <strong>CLUSTER_FAIL</strong> ä¹‹å‰ï¼Œå¯èƒ½å­˜åœ¨ write ä¸¢å¤±ã€‚partition æ¢å¤åï¼Œé€šè¿‡ rejoin_delay å»¶è¿Ÿï¼Œç­‰ cluster çŠ¶æ€å˜æ›´ä¸º <strong>CLUSTER_OK</strong>ï¼Œå¯ä»¥é‡æ–°è®¿é—®ï¼Œä¸å­˜åœ¨ write ä¸¢å¤±ã€‚</p><h4 id="5-9-10-availability-åˆ†æ"><a href="#5-9-10-availability-åˆ†æ" class="headerlink" title="5.9.10 availability åˆ†æ"></a>5.9.10 availability åˆ†æ</h4><p><a href="https://segmentfault.com/a/1190000039234661?utm_source=sf-similar-article">https://segmentfault.com/a/1190000039234661?utm_source=sf-similar-article</a></p><p>ä¸»è¦åœ¨ä¸‰ç§æƒ…å†µä¸‹ï¼Œå‡ºç°ä¸å¯ç”¨ï¼š</p><ul><li>ç½‘ç»œæ•…éšœRedis Cluster åœ¨å‘ç”Ÿ ç½‘ç»œåˆ†åŒºåï¼Œminority éƒ¨åˆ†æ˜¯ä¸å¯ç”¨çš„ã€‚å‡è®¾ majority éƒ¨åˆ†æœ‰ è¿‡åŠæ•° master å’Œ æ‰€æœ‰ä¸åœ¨majorityçš„masterå…¶ä¸‹çš„ä¸€ä¸ªslaveã€‚é‚£ä¹ˆï¼Œç»è¿‡ NODE_TIMEOUT æ—¶é—´åŠ é¢å¤–å‡ ç§’é’Ÿï¼ˆç»™slaveè¿›è¡Œfailoverï¼‰ï¼Œcluster æ¢å¤å¯ç”¨çŠ¶æ€ã€‚</li><li>sharding ç¼ºå¤±æ•…éšœé»˜è®¤æƒ…å†µä¸‹ï¼Œå½“æ£€æµ‹åˆ°æœ‰ slot æ²¡æœ‰ç»‘å®šï¼ŒRedis Cluster å°±ä¼šåœæ­¢æ¥å—è¯·æ±‚ã€‚åœ¨è¿™ç§é…ç½®ä¸‹ï¼ˆä¸‰ä¸»ä¸‰ä»ï¼‰ï¼Œå¦‚æœ cluster éƒ¨åˆ†èŠ‚ç‚¹æŒ‚æ‰ï¼ˆä¸€ä¸ªä¸»èŠ‚ç‚¹å’Œå…¶å¯¹åº”çš„ä»èŠ‚ç‚¹éƒ½æŒ‚äº†ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªèŒƒå›´å†…çš„ slot ä¸å†æœ‰èŠ‚ç‚¹è´Ÿè´£ï¼Œæœ€ç»ˆæ•´ä¸ª cluster ä¼šå˜çš„ä¸èƒ½æä¾›æœåŠ¡ã€‚<strong>æœ‰æ—¶å€™ï¼ŒæœåŠ¡éƒ¨åˆ†å¯ç”¨æ¯”æ•´ä¸ªä¸å¯ç”¨æ›´æœ‰æ„ä¹‰</strong>ï¼Œå› æ­¤ï¼Œå³ä½¿ä¸€éƒ¨åˆ† sharding å¯ç”¨ï¼Œä¹Ÿè¦è®© cluster æä¾›æœåŠ¡ã€‚redis å°†è¿™ç§é€‰æ‹©æƒäº¤åˆ°äº†ç”¨æˆ·æ‰‹ä¸­ï¼Œconf é‡Œæä¾› <strong>cluster-require-full-coverage</strong> å‚æ•°ã€‚å¦‚æœè¯¥å‚æ•°ä¸ºfalseï¼Œé‚£ä¹ˆæœ‰ slot æœªç»‘å®šæˆ–è€… shardingç¡®å®ï¼Œserver ä¹Ÿæ˜¯å¯ä»¥æ¥å—è¯·æ±‚çš„ã€‚</li><li>å½“é›†ç¾¤èŠ‚ç‚¹å®•æœºï¼Œå‡ºç°é›†ç¾¤MasterèŠ‚ç‚¹ä¸ªæ•°å°äº3ä¸ªçš„æ—¶å€™ï¼Œæˆ–è€…é›†ç¾¤å¯ç”¨èŠ‚ç‚¹ä¸ªæ•°ä¸ºå¶æ•°çš„æ—¶å€™ï¼ŒåŸºäº failover è¿™ç§é€‰ä¸¾æœºåˆ¶çš„è‡ªåŠ¨ä¸»ä»åˆ‡æ¢è¿‡ç¨‹å¯èƒ½ä¼šä¸èƒ½æ­£å¸¸å·¥ä½œã€‚æ ‡è®° failã€ä»¥åŠé€‰ä¸¾æ–°masterçš„è¿‡ç¨‹ï¼Œéƒ½å¯èƒ½å¼‚å¸¸ã€‚</li></ul><h5 id="replicas-migration-åŠŸèƒ½"><a href="#replicas-migration-åŠŸèƒ½" class="headerlink" title="replicas migration åŠŸèƒ½"></a>replicas migration åŠŸèƒ½</h5><p>ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä¸€ä¸ªåŒ…å«Nä¸ª master çš„é›†ç¾¤ï¼Œæ¯ä¸ªMaster æœ‰å”¯ä¸€ slaveã€‚å•ä¸ª node å‡ºç°æ•…éšœï¼Œclusterå¿…å®šä»ç„¶å¯ç”¨ï¼›ç¬¬äºŒä¸ª node å†å‡ºç°å†å‡ºç°æ•…éšœã€‚å¦‚æœç¬¬äºŒä¸ªèŠ‚ç‚¹æ­£å¥½æ˜¯ä¸Šé¢å·²ç»æ•…éšœçš„masterèŠ‚ç‚¹çš„slaveï¼Œåˆ™æ­¤æ—¶é›†ç¾¤ä¸å¯ç”¨ã€‚å¦‚æœç¬¬äºŒä¸ªèŠ‚ç‚¹æ˜¯å…¶ä»–èŠ‚ç‚¹ï¼Œåˆ™é›†ç¾¤ä»ç„¶å¯ç”¨ã€‚æ‰€ä»¥é›†ç¾¤ä¸å¯ç”¨çš„æ¦‚ç‡æ˜¯ 1&#x2F;(N*2-1) </p><p>Redis Cluster ä¸ºäº†æé«˜å¯ç”¨æ€§ï¼Œè¿™ä¸ªæ˜¯ç”¨äºåœ¨æ¯æ¬¡æ•…éšœä¹‹åï¼Œé‡æ–°å¸ƒå±€é›†ç¾¤çš„slaveï¼Œç»™æ²¡æœ‰slaveçš„masteré…å¤‡ä¸Šslaveï¼Œä»¥æ­¤æ¥æ›´å¥½åº”å¯¹ä¸‹æ¬¡æ•…éšœã€‚</p><p>å…·ä½“å®ç°ï¼š</p><p>è¿™ç§è´Ÿè´£ éƒ¨åˆ†slotä½†æ˜¯æ²¡æœ‰å¥åº·slaveçš„ masterï¼Œå°±ç§°ä¸º orphaned masterã€‚å½“slaveæ£€æµ‹åˆ°è‡ªå·±çš„ master æ‹¥æœ‰ä¸å°‘äº2ä¸ªå¥åº·slaveï¼Œä¸” cluster ä¸­æ°å¥½æœ‰ orphan master æ—¶ï¼Œè§¦å‘ clusterHandleSlaveMigration å‡½æ•°é€»è¾‘ï¼Œå°è¯•è¿›è¡Œ slave æ¼‚ç§»ï¼Œslaveæ­¥éª¤æœ‰å¦‚ä¸‹å››æ­¥</p><ol><li>CLUSTER_FAIL é›†ç¾¤æ¼‚ç§» if (server.cluster-&gt;state !&#x3D; CLUSTER_OK) return;é CLUSTER_OK é›†ç¾¤æœ¬æ¥æ—§æ— æ³•æ­£å¸¸æ¥æ”¶è¯·æ±‚ï¼Œæ‰€ä»¥ä¹Ÿä¸éœ€è¦æ¼‚ç§»ã€‚</li><li>æ£€æŸ¥ cluster-migration-barrier å‚æ•°<strong>redis conf æä¾›äº†cluster-migration-barrier å‚æ•°</strong>ï¼Œç”¨æ¥å†³å®š slave æ•°é‡è¾¾åˆ°å¤šå°‘ä¸ªæ‰ä¼šæŠŠå†—ä½™ slave æ¼‚ç§»å‡ºå»ã€‚åªæœ‰ master å¥åº· slave çš„ä¸ªæ•°è¶…è¿‡ cluster-migration-barrier é…ç½®çš„æ•°é‡æ—¶ï¼Œæ‰ä¼šæ¼‚ç§»ã€‚</li><li>é€‰å‡ºè¦æ¼‚ç§»çš„ slaveï¼Œä»¥åŠæ¼‚ç§»ç»™è°ã€‚é€‰æ‹© node name æœ€å°çš„slaveï¼Œæ¼‚ç§»ç»™éå†åˆ°çš„ç¬¬ä¸€ä¸ª orphaned master</li><li>æ‰§è¡Œæ¼‚ç§»åœ¨ failover æœŸé—´ï¼Œmaster æœ‰ä¸€æ®µæ—¶é—´æ˜¯æ²¡æœ‰ slaveï¼Œä¸ºäº†é˜²æ­¢è¯¯æ¼‚ï¼Œæ¼‚ç§»å¿…é¡»æœ‰ä¸€å®šçš„å»¶è¿Ÿã€‚æ—¶é—´ä¸º CLUSTER_SLAVE_MIGRATION _DELAY ç°ç‰ˆæœ¬ä¸º 5sã€‚</li></ol><h2 id="å…­ã€Redisson"><a href="#å…­ã€Redisson" class="headerlink" title="å…­ã€Redisson"></a>å…­ã€Redisson</h2><h3 id="6-1-åˆ†å¸ƒå¼é”"><a href="#6-1-åˆ†å¸ƒå¼é”" class="headerlink" title="6.1 åˆ†å¸ƒå¼é”"></a>6.1 åˆ†å¸ƒå¼é”</h3><p>åˆ†å¸ƒå¼é”ï¼Œæ˜¯æ§åˆ¶åˆ†å¸ƒå¼ç³»ç»Ÿä¸åŒè¿›ç¨‹å…±åŒè®¿é—®å…±äº«èµ„æºçš„ä¸€ç§é”çš„å®ç°ã€‚ç§’æ€ä¸‹å•ã€æŠ¢çº¢åŒ…ç­‰ç­‰ä¸šåŠ¡åœºæ™¯ï¼Œéƒ½éœ€è¦ç”¨åˆ°åˆ†å¸ƒå¼é”ã€‚</p><h4 id="6-1-1-å¸¸è§redis-åˆ†å¸ƒå¼é”"><a href="#6-1-1-å¸¸è§redis-åˆ†å¸ƒå¼é”" class="headerlink" title="6.1.1 å¸¸è§redis åˆ†å¸ƒå¼é”"></a>6.1.1 å¸¸è§redis åˆ†å¸ƒå¼é”</h4><p>ä¸€èˆ¬Redisåˆ†å¸ƒå¼é”æœ‰å¦‚ä¸‹å‡ ç§å®ç°æ–¹æ¡ˆï¼š</p><ul><li>å‘½ä»¤ setnx + expire åˆ†å¼€å†™</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">if(jedis.setnx(key,lock_value) == 1)&#123; // åŠ é”</span><br><span class="line">    expire(key,100);  // è®¾ç½®è¿‡æœŸæ—¶é—´</span><br><span class="line">    try&#123;</span><br><span class="line">        do something // ä¸šåŠ¡å¤„ç†</span><br><span class="line">    &#125;catch()&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;finally&#123; </span><br><span class="line">      jedis.del(key); // é‡Šæ”¾é”</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæ‰§è¡Œå®Œ setnx åŠ é”ï¼Œæ­£è¦æ‰§è¡Œ expire è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œè¿›è¡Œcrashæˆ–è€…é‡å¯ç»´æŠ¤ï¼Œé‚£ä¹ˆè¿™ä¸ªé”å°±ä¸€ç›´è¢«é”ä½äº†ï¼Œåˆ«çš„çº¿ç¨‹æ°¸è¿œè·å–ä¸åˆ°é”äº†ï¼Œæ‰€ä»¥åˆ†å¸ƒå¼ä¸èƒ½è¿™ç§å®ç°ã€‚</p><ul><li>setnx + value å€¼è¿‡æœŸæ—¶é—´ä¸ºäº†è§£å†³æ–¹æ¡ˆä¸€ï¼Œå‘ç”Ÿå¼‚å¸¸é”å¾—ä¸åˆ°é‡Šæ”¾çš„åœºæ™¯ã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">long expires = System.currentTimeMillis() + expireTime; // ç³»ç»Ÿæ—¶é—´ + è®¾ç½®çš„è¿‡æœŸæ—¶é—´</span><br><span class="line">if(jedis.setnx(key,expires) == 1)&#123;</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br><span class="line">// å¦‚æœå½“å‰é”ä¸å­˜åœ¨ï¼Œè¿”å›åŠ é”æˆåŠŸ</span><br><span class="line">if (jedis.setnx(key_resource_id, String.vaue(expires)) == 1) &#123;</span><br><span class="line">        return true;</span><br><span class="line">&#125; </span><br><span class="line">// å¦‚æœé”å·²ç»å­˜åœ¨ï¼Œè·å–é”çš„è¿‡æœŸæ—¶é—´</span><br><span class="line">String currentValueStr = jedis.get(key_resource_id);</span><br><span class="line"></span><br><span class="line">// å¦‚æœè·å–åˆ°çš„è¿‡æœŸæ—¶é—´ï¼Œå°äºç³»ç»Ÿå½“å‰æ—¶é—´ï¼Œè¡¨ç¤ºå·²ç»è¿‡æœŸ</span><br><span class="line">if (currentValueStr != null &amp;&amp; Long.parseLong(currentValueStr) &lt; System.currentTimeMillis()) &#123;</span><br><span class="line"></span><br><span class="line">         // é”å·²è¿‡æœŸï¼Œè·å–ä¸Šä¸€ä¸ªé”çš„è¿‡æœŸæ—¶é—´ï¼Œå¹¶è®¾ç½®ç°åœ¨é”çš„è¿‡æœŸæ—¶é—´</span><br><span class="line">        String oldValueStr = jedis.getSet(key_resource_id, expiresStr);</span><br><span class="line"></span><br><span class="line">        if (oldValueStr != null &amp;&amp; oldValueStr.equals(currentValueStr)) &#123;</span><br><span class="line">             // è€ƒè™‘å¤šçº¿ç¨‹å¹¶å‘çš„æƒ…å†µï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„è®¾ç½®å€¼å’Œå½“å‰å€¼ç›¸åŒï¼Œå®ƒæ‰å¯ä»¥åŠ é”</span><br><span class="line">             return true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    //å…¶ä»–æƒ…å†µï¼Œå‡è¿”å›åŠ é”å¤±è´¥</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸€æ–¹æ¡ˆå·§å¦™ç§»é™¤äº† expire å•ç‹¬è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ“ä½œï¼ŒæŠŠè¿‡æœŸæ—¶é—´æ”¾åˆ°äº† setnx çš„ value å€¼ä¸­ã€‚è§£å†³äº† å‘ç”Ÿå¼‚å¸¸é”å¾—ä¸åˆ°é‡Šæ”¾çš„é—®é¢˜ã€‚ä½†æ˜¯æ­¤æ–¹æ¡ˆä¹Ÿæœ‰è‡ªå·±çš„ç¼ºç‚¹ï¼š</p><ul><li><ul><li>è¿‡æœŸæ—¶é—´æ˜¯å®¢æˆ·ç«¯è‡ªå·±ç”Ÿæˆçš„ï¼ˆSystem.currentTimeMillis()æ˜¯å½“å‰ç³»ç»Ÿçš„æ—¶é—´ï¼‰ï¼Œå¿…é¡»è¦æ±‚åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯çš„æ—¶é—´å¿…é¡»åŒæ­¥ã€‚</li><li>å¦‚æœé”è¿‡æœŸçš„æ—¶å€™ï¼Œå¹¶å‘å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶è¯·æ±‚è¿‡æ¥ï¼Œéƒ½æ‰§è¡Œjedis.getSet()ï¼Œæœ€ç»ˆåªèƒ½æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯åŠ é”æˆåŠŸï¼Œä½†æ˜¯è¯¥å®¢æˆ·ç«¯é”çš„è¿‡æœŸæ—¶é—´ï¼Œå¯èƒ½è¢«åˆ«çš„å®¢æˆ·ç«¯è¦†ç›–</li><li>è¯¥é”æ²¡æœ‰ä¿å­˜æŒæœ‰è€…çš„å”¯ä¸€æ ‡è¯†ï¼Œå¯èƒ½è¢«åˆ«çš„å®¢æˆ·ç«¯é‡Šæ”¾&#x2F;è§£é”ã€‚</li></ul></li><li><p>set çš„æ‰©å±•å‘½ä»¤ï¼ˆset ex px nxï¼‰Redis çš„ set æ‰©å±•å‚æ•°ï¼ˆSET key value[EX seconds][PX milliseconds][NX|XX]ï¼‰æ˜¯åŸå­æ€§çš„ã€‚EX secondsï¼šè®¾å®škeyçš„è¿‡æœŸæ—¶é—´ï¼Œæ—¶é—´å•ä½æ˜¯ç§’ã€‚PX millisecondsï¼šè®¾å®škeyçš„è¿‡æœŸæ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’NXï¼šè¡¨ç¤ºkeyä¸å­˜åœ¨çš„æ—¶å€™ï¼Œæ‰èƒ½setæˆåŠŸï¼Œä¹Ÿå³ä¿è¯åªæœ‰ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯è¯·æ±‚æ‰èƒ½è·å–é”ï¼Œè€Œå…¶ä»–å®¢æˆ·ç«¯è¯·æ±‚åªèƒ½ç­‰èµ·é‡Šæ”¾é”ï¼Œæ‰èƒ½è·å–ã€‚XXï¼šä»…å½“keyå­˜åœ¨æ—¶è®¾ç½®å€¼</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ifï¼ˆjedis.set(key_resource_id, lock_value, &quot;NX&quot;, &quot;EX&quot;, 100s) == 1ï¼‰&#123; //åŠ é”</span><br><span class="line">    try &#123;</span><br><span class="line">        do something  //ä¸šåŠ¡å¤„ç†</span><br><span class="line">    &#125;catch()&#123;</span><br><span class="line">ã€€ã€€&#125;</span><br><span class="line">ã€€ã€€finally &#123;</span><br><span class="line">       jedis.del(key_resource_id); //é‡Šæ”¾é”</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯å‘¢ï¼Œè¿™ä¸ªæ–¹æ¡ˆè¿˜æ˜¯å¯èƒ½å­˜åœ¨é—®é¢˜ï¼šé—®é¢˜ä¸€ï¼š<strong>é”è¿‡æœŸé‡Šæ”¾äº†ï¼Œä¸šåŠ¡è¿˜æ²¡æ‰§è¡Œå®Œ</strong>ã€‚å‡è®¾çº¿ç¨‹aè·å–é”æˆåŠŸï¼Œä¸€ç›´åœ¨æ‰§è¡Œä¸´ç•ŒåŒºçš„ä»£ç ã€‚ä½†æ˜¯100sè¿‡å»åï¼Œå®ƒè¿˜æ²¡æ‰§è¡Œå®Œã€‚ä½†æ˜¯ï¼Œè¿™æ—¶å€™é”å·²ç»è¿‡æœŸäº†ï¼Œæ­¤æ—¶çº¿ç¨‹båˆè¯·æ±‚è¿‡æ¥ã€‚æ˜¾ç„¶çº¿ç¨‹bå°±å¯ä»¥è·å¾—é”æˆåŠŸï¼Œä¹Ÿå¼€å§‹æ‰§è¡Œä¸´ç•ŒåŒºçš„ä»£ç ã€‚é‚£ä¹ˆé—®é¢˜å°±æ¥äº†ï¼Œä¸´ç•ŒåŒºçš„ä¸šåŠ¡ä»£ç éƒ½ä¸æ˜¯ä¸¥æ ¼ä¸²è¡Œæ‰§è¡Œçš„å•¦ã€‚é—®é¢˜äºŒï¼š<strong>é”è¢«åˆ«çš„çº¿ç¨‹è¯¯åˆ </strong>ã€‚å‡è®¾çº¿ç¨‹aæ‰§è¡Œå®Œåï¼Œå»é‡Šæ”¾é”ã€‚ä½†æ˜¯å®ƒä¸çŸ¥é“å½“å‰çš„é”å¯èƒ½æ˜¯çº¿ç¨‹bæŒæœ‰çš„ï¼ˆçº¿ç¨‹aå»é‡Šæ”¾é”æ—¶ï¼Œæœ‰å¯èƒ½è¿‡æœŸæ—¶é—´å·²ç»åˆ°äº†ï¼Œæ­¤æ—¶çº¿ç¨‹bè¿›æ¥å æœ‰äº†é”ï¼‰ã€‚é‚£çº¿ç¨‹aå°±æŠŠçº¿ç¨‹bçš„é”é‡Šæ”¾æ‰äº†ï¼Œä½†æ˜¯çº¿ç¨‹bä¸´ç•ŒåŒºä¸šåŠ¡ä»£ç å¯èƒ½éƒ½è¿˜æ²¡æ‰§è¡Œå®Œå‘¢ã€‚</p><ul><li>set ex px nx + æ ¡éªŒå”¯ä¸€éšæœºå€¼ å†åˆ é™¤æ—¢ç„¶é”å¯èƒ½è¢«åˆ«çš„çº¿ç¨‹è¯¯åˆ ï¼Œé‚£æˆ‘ä»¬ç»™valueå€¼è®¾ç½®ä¸€ä¸ªæ ‡è®°å½“å‰çº¿ç¨‹å”¯ä¸€çš„éšæœºæ•°ï¼Œåœ¨åˆ é™¤çš„æ—¶å€™ï¼Œæ ¡éªŒä¸€ä¸‹ï¼Œä¸å°±OKäº†å˜›ã€‚ä¼ªä»£ç å¦‚ä¸‹ï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ifï¼ˆjedis.set(key_resource_id, uni_request_id, &quot;NX&quot;, &quot;EX&quot;, 100s) == 1ï¼‰&#123; //åŠ é”</span><br><span class="line">    try &#123;</span><br><span class="line">        do something  //ä¸šåŠ¡å¤„ç†</span><br><span class="line">    &#125;catch()&#123;</span><br><span class="line">ã€€ã€€&#125;</span><br><span class="line">ã€€ã€€finally &#123;</span><br><span class="line">       //åˆ¤æ–­æ˜¯ä¸æ˜¯å½“å‰çº¿ç¨‹åŠ çš„é”,æ˜¯æ‰é‡Šæ”¾</span><br><span class="line">       if (uni_request_id.equals(jedis.get(key_resource_id))) &#123;</span><br><span class="line">        jedis.del(lockKey); //é‡Šæ”¾é”</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œï¼Œ<strong>åˆ¤æ–­æ˜¯ä¸æ˜¯å½“å‰çº¿ç¨‹åŠ çš„é”</strong>å’Œ<strong>é‡Šæ”¾é”</strong>ä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œã€‚å¦‚æœè°ƒç”¨jedis.del()é‡Šæ”¾é”çš„æ—¶å€™ï¼Œå¯èƒ½è¿™æŠŠé”å·²ç»ä¸å±äºå½“å‰å®¢æˆ·ç«¯ï¼Œä¼šè§£é™¤ä»–äººåŠ çš„é”ã€‚å› ä¸º finally éƒ¨åˆ†æ‰§è¡Œæ—¶ä¸èƒ½ä¿è¯åŸå­æ€§ï¼Œä¸€èˆ¬ä¹Ÿæ˜¯ç”¨ luaè„šæœ¬ä»£æ›¿ã€‚</p><h4 id="6-1-2-Redisson-çš„è§£å†³æ–¹æ¡ˆ"><a href="#6-1-2-Redisson-çš„è§£å†³æ–¹æ¡ˆ" class="headerlink" title="6.1.2 Redisson çš„è§£å†³æ–¹æ¡ˆ"></a>6.1.2 Redisson çš„è§£å†³æ–¹æ¡ˆ</h4><p><strong>1. å•æœºæ–¹æ¡ˆ</strong></p><p>å…¶å®ä¸Šé¢çš„æ–¹æ¡ˆè¿˜æ˜¯ä¼šå­˜åœ¨ é”è¿‡æœŸé‡Šæ”¾ï¼Œä¸šåŠ¡æ²¡æœ‰æ‰§è¡Œå®Œçš„é—®é¢˜ã€‚æ‰€ä»¥å…¶å®æˆ‘ä»¬å¯ä»¥å¼€å¯ä¸€ä¸ªå®šæ—¶å®ˆæŠ¤çº¿ç¨‹ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´æ£€æŸ¥é”æ˜¯å¦è¿˜å­˜åœ¨ï¼Œå­˜åœ¨åˆ™å¯¹é”è¿‡æœŸæ—¶é—´å»¶é•¿ï¼Œé˜²æ­¢é”è¿‡æœŸæå‰é‡Šæ”¾ã€‚</p><p>åªè¦çº¿ç¨‹1åŠ é”æˆåŠŸï¼Œå°±ä¼šå¯åŠ¨ä¸€ä¸ª watch dogï¼Œå®ƒæ˜¯ä¸€ä¸ªåå°çº¿ç¨‹ï¼Œä¼šæ¯éš”10ç§’æ£€æŸ¥ä¸€ä¸‹é”ã€‚å¦‚æœçº¿ç¨‹1è¿˜æŒæœ‰é”ï¼Œé‚£ä¹ˆå°±ä¼šä¸æ–­çš„å»¶é•¿é”keyçš„è¿‡æœŸæ—¶é—´ã€‚å› æ­¤ Redission è§£å†³äº† ä¸šåŠ¡è¿˜æ²¡æ‰§è¡Œå®Œ é”å°±è¿‡æœŸé‡Šæ”¾çš„ é—®é¢˜ã€‚</p><p><strong>2. åŸºäºæ•…éšœè½¬ç§»çš„RedLockç®—æ³•</strong></p><p>ä¸Šé¢çš„æ‰€æœ‰çš„æ–¹æ¡ˆéƒ½æ˜¯åŸºäºå•æœºç‰ˆçš„ï¼Œç„¶è€Œå®é™…ä¸Šç”Ÿäº§ç¯å¢ƒrediséƒ½æ˜¯é›†ç¾¤éƒ¨ç½²ã€‚</p><p>ç›´æ¥åœ¨ redis ä¸»ä»é›†ç¾¤ä¸­ä½¿ç”¨ä¸Šé¢çš„æ–¹æ¡ˆï¼Œä¼šæœ‰å¦‚ä¸‹é—®é¢˜ï¼š</p><p>å®¢æˆ·ç«¯åœ¨ Redis çš„ master èŠ‚ç‚¹ä¸Šæ‹¿åˆ°äº† é”ï¼Œä½†æ˜¯è¿™ä¸ªé”è¿˜æ²¡æœ‰åŒæ­¥åˆ° slave èŠ‚ç‚¹ä¸Šï¼ŒmasterèŠ‚ç‚¹å°±å‘ç”Ÿäº†æ•…éšœã€‚ç„¶åè¿›è¡Œäº†æ•…éšœè½¬ç§»ï¼ŒslaveèŠ‚ç‚¹å‡çº§ä¸º masterèŠ‚ç‚¹ã€‚å› æ­¤ å®¢æˆ·ç«¯ åŠ çš„é”ä¸¢å¤±äº†ã€‚</p><p>å› æ­¤Redisä½œè€…antirezåŸºäºåˆ†å¸ƒå¼ç¯å¢ƒä¸‹æå‡ºäº†ä¸€ç§æ›´é«˜çº§çš„åˆ†å¸ƒå¼é”çš„å®ç°æ–¹å¼ï¼š<strong>Redlock</strong>ã€‚</p><p><strong>Redlockæ¶æ„å›¾</strong></p><p>åº”ç”¨å‰æï¼šåœ¨Redisçš„åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬å‡è®¾æœ‰Nä¸ªRedis masterã€‚è¿™äº›èŠ‚ç‚¹<strong>å®Œå…¨äº’ç›¸ç‹¬ç«‹ï¼Œä¸å­˜åœ¨ä¸»ä»å¤åˆ¶æˆ–è€…å…¶ä»–é›†ç¾¤åè°ƒæœºåˆ¶</strong>ã€‚æˆ‘ä»¬ç¡®ä¿å°†åœ¨Nä¸ªå®ä¾‹ä¸Šä½¿ç”¨ä¸åœ¨Rediså•å®ä¾‹ä¸‹ç›¸åŒæ–¹æ³•è·å–å’Œé‡Šæ”¾é”ã€‚ç°åœ¨æˆ‘ä»¬å‡è®¾æœ‰5ä¸ªRedis masterèŠ‚ç‚¹ï¼ŒåŒæ—¶æˆ‘ä»¬éœ€è¦åœ¨5å°æœåŠ¡å™¨ä¸Šé¢è¿è¡Œè¿™äº›Rediså®ä¾‹ï¼Œè¿™æ ·ä¿è¯ä»–ä»¬ä¸ä¼šåŒæ—¶éƒ½å®•æ‰ã€‚</p><p>å®ç°æ­¥éª¤ï¼š</p><ol><li>è·å–å½“å‰çš„æ—¶é—´æˆ³</li><li>ä¾æ¬¡å°è¯•å‘5ä¸ªå®ä¾‹ï¼Œä½¿ç”¨ç›¸åŒçš„ key å’Œ å…·æœ‰å”¯ä¸€æ€§çš„valueï¼ˆä¾‹å¦‚UUIDï¼‰è·å–é”ã€‚å®¢æˆ·ç«¯è¯·æ±‚å„å®ä¾‹è·å–é”æ—¶ï¼Œåº”æœ‰è®¾ç½®å“åº”è¶…æ—¶æ—¶é—´ã€‚å¹¶ä¸”è¿™ä¸ªå“åº”è¶…æ—¶æ—¶é—´å°½é‡è¿œå°äºé”çš„å¤±æ•ˆæ—¶é—´ã€‚å¦‚æ­¤è®¾è®¡çš„åŸå› ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬ä¸èƒ½åœ¨å·²ç»æŒ‚æ‰çš„masterä¸ŠèŠ±è´¹å¤ªå¤šæ—¶é—´ã€‚å¦‚æœèŠ±è´¹å¤ªå¤šæ—¶é—´ï¼Œä¼šé€ æˆè¿˜æ²¡å‘å…¨éƒ¨masterè¯·æ±‚å®Œï¼Œé”çš„å¤±æ•ˆæ—¶é—´å°±å·²ç»åˆ°äº†ã€‚å› æ­¤ å¦‚æœæœåŠ¡å™¨ç«¯æ²¡æœ‰åœ¨è§„å®šæ—¶é—´å†…å“åº”ï¼Œå®¢æˆ·ç«¯åº”è¯¥å°½å¿«å°è¯•å»å¦å¤–ä¸€ä¸ªRediså®ä¾‹è¯·æ±‚è·å–é”ã€‚</li><li>å®¢æˆ·ç«¯ä½¿ç”¨å½“å‰æ—¶é—´å‡å»å¼€å§‹è·å–é”çš„æ—¶é—´ï¼ˆæ­¥éª¤1è®°å½•çš„æ—¶é—´ï¼‰ï¼Œå°±å¯ä»¥å¾—åˆ° è·å–é” æ‰€ç”¨çš„æ—¶é—´ã€‚<strong>å½“ä¸”ä»…å½“ä»å¤§å¤šæ•°ï¼ˆN&#x2F;2+1ï¼Œè¿™é‡Œæ˜¯3ä¸ªèŠ‚ç‚¹ï¼‰çš„RedisèŠ‚ç‚¹éƒ½å–åˆ°é”ï¼Œå¹¶ä¸”æ•´ä¸ªè¿‡ç¨‹ä½¿ç”¨çš„æ—¶é—´å°äºé”å¤±æ•ˆæ—¶é—´æ—¶ï¼Œé”æ‰ç®—è·å–æˆåŠŸ</strong>ã€‚</li><li>å¦‚æœå–åˆ°äº†é”ï¼Œkeyçš„çœŸæ­£æœ‰æ•ˆæ—¶é—´ç­‰äºæœ‰æ•ˆæ—¶é—´å‡å»è·å–é”æ‰€ä½¿ç”¨çš„æ—¶é—´ï¼ˆæ­¥éª¤3è®¡ç®—çš„ç»“æœï¼‰ã€‚</li><li>å¦‚æœå› ä¸ºæŸäº›åŸå› ï¼Œè·å–é”å¤±è´¥ï¼ˆæ²¡æœ‰åœ¨è‡³å°‘N&#x2F;2+1ä¸ªRediså®ä¾‹å–åˆ°é”æˆ–è€…å–é”æ—¶é—´å·²ç»è¶…è¿‡äº†æœ‰æ•ˆæ—¶é—´ï¼‰ï¼Œå®¢æˆ·ç«¯åº”è¯¥åœ¨<strong>æ‰€æœ‰çš„Rediså®ä¾‹ä¸Šè¿›è¡Œè§£é”</strong>ï¼ˆå³ä¾¿æŸäº›Rediså®ä¾‹æ ¹æœ¬å°±æ²¡æœ‰åŠ é”æˆåŠŸï¼Œé˜²æ­¢æŸäº›èŠ‚ç‚¹è·å–åˆ°é”ä½†æ˜¯å®¢æˆ·ç«¯æ²¡æœ‰å¾—åˆ°å“åº”è€Œå¯¼è‡´æ¥ä¸‹æ¥çš„ä¸€æ®µæ—¶é—´ä¸èƒ½è¢«é‡æ–°è·å–é”ï¼‰ã€‚</li></ol><h2 id="ä¸ƒã€Redisåº”ç”¨é—®é¢˜"><a href="#ä¸ƒã€Redisåº”ç”¨é—®é¢˜" class="headerlink" title="ä¸ƒã€Redisåº”ç”¨é—®é¢˜"></a>ä¸ƒã€Redisåº”ç”¨é—®é¢˜</h2><h3 id="7-1-Redisä¸MySQLåŒå†™ä¸€è‡´æ€§å¦‚ä½•ä¿è¯ï¼Ÿ"><a href="#7-1-Redisä¸MySQLåŒå†™ä¸€è‡´æ€§å¦‚ä½•ä¿è¯ï¼Ÿ" class="headerlink" title="7.1 Redisä¸MySQLåŒå†™ä¸€è‡´æ€§å¦‚ä½•ä¿è¯ï¼Ÿ"></a>7.1 Redisä¸MySQLåŒå†™ä¸€è‡´æ€§å¦‚ä½•ä¿è¯ï¼Ÿ</h3><p>ä¸€æ—¦å‡ºç°æ•°æ®æ›´æ–°ï¼Œredisä¸æ•°æ®åº“ä¹‹é—´çš„æ•°æ®ä¸€è‡´æ€§é—®é¢˜å°±ä¼šå‡ºç°ã€‚</p><p>ä¸€è‡´æ€§å°±æ˜¯æ•°æ®ä¿æŒä¸€è‡´ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¯ä»¥ç†è§£ä¸ºå¤šä¸ªèŠ‚ç‚¹ä¸­æ•°æ®çš„å€¼æ˜¯ä¸€è‡´çš„ã€‚</p><ul><li><strong>å¼ºä¸€è‡´æ€§</strong>ï¼šè¿™ç§ä¸€è‡´æ€§çº§åˆ«æ˜¯æœ€ç¬¦åˆç”¨æˆ·ç›´è§‰çš„ï¼Œå®ƒè¦æ±‚ç³»ç»Ÿå†™å…¥ä»€ä¹ˆï¼Œè¯»å‡ºæ¥çš„ä¹Ÿä¼šæ˜¯ä»€ä¹ˆï¼Œç”¨æˆ·ä½“éªŒå¥½ï¼Œä½†å®ç°èµ·æ¥å¾€å¾€å¯¹ç³»ç»Ÿçš„æ€§èƒ½å½±å“å¤§</li><li><strong>å¼±ä¸€è‡´æ€§</strong>ï¼šè¿™ç§ä¸€è‡´æ€§çº§åˆ«çº¦æŸäº†ç³»ç»Ÿåœ¨å†™å…¥æˆåŠŸåï¼Œä¸æ‰¿è¯ºç«‹å³å¯ä»¥è¯»åˆ°å†™å…¥çš„å€¼ï¼Œä¹Ÿä¸æ‰¿è¯ºå¤šä¹…ä¹‹åæ•°æ®èƒ½å¤Ÿè¾¾åˆ°ä¸€è‡´ï¼Œä½†ä¼šå°½å¯èƒ½åœ°ä¿è¯åˆ°æŸä¸ªæ—¶é—´çº§åˆ«ï¼ˆæ¯”å¦‚ç§’çº§åˆ«ï¼‰åï¼Œæ•°æ®èƒ½å¤Ÿè¾¾åˆ°ä¸€è‡´çŠ¶æ€</li><li><strong>æœ€ç»ˆä¸€è‡´æ€§</strong>ï¼šæœ€ç»ˆä¸€è‡´æ€§æ˜¯å¼±ä¸€è‡´æ€§çš„ä¸€ä¸ªç‰¹ä¾‹ï¼Œç³»ç»Ÿä¼šä¿è¯åœ¨ä¸€å®šæ—¶é—´å†…ï¼Œèƒ½å¤Ÿè¾¾åˆ°ä¸€ä¸ªæ•°æ®ä¸€è‡´çš„çŠ¶æ€ã€‚è¿™é‡Œä¹‹æ‰€ä»¥å°†æœ€ç»ˆä¸€è‡´æ€§å•ç‹¬æå‡ºæ¥ï¼Œæ˜¯å› ä¸ºå®ƒæ˜¯å¼±ä¸€è‡´æ€§ä¸­éå¸¸æ¨å´‡çš„ä¸€ç§ä¸€è‡´æ€§æ¨¡å‹ï¼Œä¹Ÿæ˜¯ä¸šç•Œåœ¨å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ•°æ®ä¸€è‡´æ€§ä¸Šæ¯”è¾ƒæ¨å´‡çš„æ¨¡å‹</li></ul><p><strong>æ˜¯é€‰æ‹©æ›´æ–°ç¼“å­˜è¿˜æ˜¯åˆ é™¤ç¼“å­˜ï¼Ÿ</strong></p><p>å¦‚æœ çº¿ç¨‹Aå…ˆæ›´æ–°æ•°æ®åº“ï¼Œä¹‹åçº¿ç¨‹Bä¹Ÿå‘æ•°æ®åº“ä¸­æ›´æ–°åŒä¸€å€¼ï¼Œä½†æ˜¯Bè¯·æ±‚å¿«ï¼Œå…ˆå†™å…¥äº†ç¼“å­˜ï¼ŒAåå†™å…¥äº†ç¼“å­˜ã€‚é‚£ä¹ˆå®é™…ä¸Š ç¼“å­˜ä¸­è¿˜æ˜¯æ—§å€¼ï¼Œè€Œæ•°æ®åº“ä¸­æ˜¯Bæ›´æ”¹åçš„æ–°å€¼ã€‚å¯¼è‡´æ•°æ®æœ€ç»ˆä¸ä¸€è‡´ã€‚</p><p>ä½†æ˜¯ä½ é€‰æ‹©çš„æ˜¯åˆ é™¤ç¼“å­˜ã€‚é‚£ä¹ˆåœ¨æœ€åä¸€æ¬¡åˆ é™¤ç¼“å­˜åï¼Œè¯·æ±‚å†æ¥æ—¶ä¼šæŸ¥è¯¢æ•°æ®åº“æœ€æ–°æ•°æ®ã€‚é‚£ä¹ˆå°±é¿å…äº†è¿™ä¸ªé—®é¢˜ã€‚æ‰€ä»¥ æˆ‘ä»¬é€‰æ‹© åˆ é™¤ç¼“å­˜ã€‚</p><p>ä¸ç®¡æ˜¯å…ˆåˆ é™¤ç¼“å­˜å†æ›´æ–°æ•°æ®åº“ï¼Œè¿˜æ˜¯å…ˆæ›´æ–°æ•°æ®åº“å†åˆ é™¤ç¼“å­˜ï¼Œéƒ½æœ‰å¯èƒ½å­˜åœ¨æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚</p><ol><li><strong>å…ˆåˆ é™¤ç¼“å­˜å†æ›´æ–°æ•°æ®åº“</strong>ï¼šåœ¨åˆ é™¤ç¼“å­˜åï¼Œæ›´æ–°æ•°æ®åº“å‰ã€‚å°±å¯èƒ½ä¼šæœ‰ä¸ªè¯·æ±‚è·å–ç¼“å­˜ï¼Œæ­¤æ—¶ç¼“å­˜æ²¡æœ‰ï¼Œå®ƒå°±å»æŸ¥æ•°æ®åº“äº†ï¼Œå°±å¾—åˆ°äº†è„æ•°æ®ã€‚å¹¶å°†è„æ•°æ®å¡å…¥äº†ç¼“å­˜ä¸­ã€‚è¿™å°±å¯¼è‡´äº† ç¼“å­˜ä¸æ•°æ®åº“ æœ€ç»ˆä¸ä¸€è‡´ã€‚</li><li><strong>å…ˆæ›´æ–°æ•°æ®åº“å†åˆ é™¤ç¼“å­˜</strong>ï¼šåœ¨åˆ é™¤ç¼“å­˜ä¹‹å‰ï¼Œå»è¯»åˆ°çš„éƒ½æ˜¯ è„æ•°æ®ã€‚åœ¨å¹¶å‘å†™ä¸é«˜ã€redisåˆ é™¤å¤±è´¥æ¦‚ç‡ä¸å¤§æ—¶ï¼Œå¯ä»¥ä¸€å®šç¨‹åº¦å®ç° æœ€ç»ˆä¸€è‡´æ€§ã€‚ä½†æ˜¯åœ¨å¹¶å‘å†™è¾ƒé«˜ï¼Œå°±ä¼šå‡ºç°ä¸‹é¢çš„æƒ…å†µï¼š</li></ol><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682815161357-87e6efce-ca8a-4ce3-a1d2-592d9d2c7a6c-20250605100709115.png" alt="img"></p><p>æ­¤æ—¶ å†æœ‰çº¿ç¨‹è¿›æ¥è¯»å–ç¼“å­˜ï¼Œå°±ä¼šè¯»å–åˆ°å°±æ˜¯a&#x3D;2ï¼Œä½†æ˜¯å®é™… æ•°æ®åº“ä¸­ a&#x3D;3ã€‚è¿™å°±å¯¼è‡´äº†æ•°æ®æœ€ç»ˆä¸ä¸€è‡´ã€‚</p><p>æ­¤æ–¹æ¡ˆå¯ä»¥è€ƒè™‘åœ¨å†™å¹¶å‘æä½çš„æƒ…å†µä¸‹ä½¿ç”¨ã€‚</p><p>ä½†æ˜¯ç»¼åˆæ¥çœ‹ï¼Œä¸Šé¢ä¸¤ä¸ªæ–¹æ¡ˆå³ä½¿åœ¨ä¸è€ƒè™‘ åˆ é™¤key å¯èƒ½å¤±è´¥çš„æƒ…å†µï¼Œä¹Ÿä¸èƒ½ä¿è¯ ç¼“å­˜å’Œæ•°æ®åº“ æ•°æ®æœ€ç»ˆä¸€è‡´ã€‚</p><p><strong>3.å»¶è¿ŸåŒåˆ ï¼š</strong> </p><p>å»¶è¿ŸåŒåˆ å†ä¸Šé¢æ–¹æ¡ˆ1 çš„åŸºç¡€ä¸Šï¼Œå¢åŠ äº†ä¸€æ­¥ å»¶è¿Ÿä¸€å®šæ—¶é—´å å†åˆ é™¤ç¼“å­˜ã€‚ä»è€Œé¿å…æ–¹æ¡ˆ1ï¼Œé€ æˆçš„è„æ•°æ®å­˜åœ¨ç¼“å­˜ä¸­ã€‚è¾¾åˆ°ä¸‹é¢å·¦å›¾åˆ°æ•ˆæœ</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1684856079904-9a8380f7-4d84-40fc-88aa-a1efe58412d1-20250605100653159.png" alt="img"></p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1684856140846-5f64616b-c627-4b51-90e2-7cf9943c770d-20250605100659576.png" alt="img"></p><p>è¿™æ ·å°±å¯ä»¥å®ç° æ•°æ®æœ€ç»ˆä¸€è‡´æ€§ã€‚ä½†æ˜¯æˆ‘ä»¬ä¹Ÿå¯ä»¥æ¸…æ¥šçš„å‘ç°ï¼Œå¦‚æœå»¶è¿Ÿæ—¶é—´ä¸å¤Ÿï¼Œå¾ˆæœ‰å¯èƒ½ä¼šå‡ºç° Thread-2 çš„å†™å…¥ç¼“å­˜æ“ä½œ åœ¨Thread-1ç¬¬äºŒæ¬¡åˆ é™¤ç¼“å­˜ ä¹‹åå‘ç”Ÿã€‚é‚£ä¹ˆæ­¤æ—¶ï¼Œæ•°æ®åˆä¼šå‡ºç°ä¸ä¸€è‡´çš„æƒ…å†µã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬åº”å½“è®¾ç½®ä¸€ä¸ªåˆç†çš„ å»¶è¿Ÿæ—¶é—´ï¼Œä½†æ˜¯å³ä½¿åˆç†ï¼Œä¹Ÿä¸èƒ½è¯´ ä¸€å®šèƒ½ä¿è¯åœ¨ä»»ä½•æƒ…å†µä¸‹ Thread-2 å†™å…¥æ“ä½œéƒ½åœ¨ Thread-1 ç¬¬äºŒæ¬¡åˆ ç¼“å­˜ ä¹‹åã€‚</p><p><strong>4.å¼‚æ­¥æ›´æ–°ç¼“å­˜ï¼ˆåŸºäºCDCçš„åŒæ­¥æœºåˆ¶ï¼‰</strong></p><p>é€šè¿‡CDCï¼ˆæ•°æ®å˜æ›´è·Ÿè¸ªï¼‰å°†ç¼“å­˜ä¸æ•°æ®åº“çš„ä¸€è‡´æ€§åŒæ­¥ä»ä¸šåŠ¡ä¸­ç‹¬ç«‹å‡ºæ¥ç»Ÿä¸€å¤„ç†ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚</p><p>æ•´ä½“æ€è·¯ï¼š</p><ol><li>æ›´æ–°ã€å†™ æ•°æ®åº“åï¼Œä¼šäº§ç”Ÿæ•°æ®å˜æ›´è®°å½•ã€‚ï¼ˆMySQLä¸­æœ‰binlogæ—¥å¿—ï¼ŒSQLServerä¸­æœ‰CDCå˜æ›´è¡¨ï¼‰</li><li>é€šè¿‡æ•°æ®å˜æ›´è®°å½•æ¥æ›´æ–° Redisä¸­æ•°æ®</li></ol><p>è¿™é‡Œå¯ä»¥ä½¿ç”¨ï¼š1. FlinkCDC æ¥å®ç° å¯¹æ•°æ®åº“å˜æ›´æ•°æ®çš„è¿½è¸ªã€å¤„ç†ï¼›2. æ•°æ®å˜æ›´è®°å½• å­˜å…¥ æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¶ˆè´¹è€…æœ‰åºå®ç° Redis æ›´æ–°ã€‚</p><p>ä¸Šé¢çš„æ‰€æœ‰æ–¹æ¡ˆä¸­ï¼Œéƒ½æ²¡æœ‰è€ƒè™‘ åˆ é™¤ç¼“å­˜å¤±è´¥ çš„å¯èƒ½ï¼Œå¦‚æœè€ƒè™‘åˆ é™¤ç¼“å­˜å¤±è´¥ï¼Œå¯èƒ½æ‰€æœ‰æ–¹æ¡ˆéƒ½ä¿è¯ä¸äº† æ•°æ®æœ€ç»ˆä¸€è‡´æ€§ã€‚æ‰€ä»¥åœ¨ åˆ é™¤ç¼“å­˜ è¿™ä¸€æ“ä½œï¼Œå¯ä»¥è€ƒè™‘ å¤±è´¥é‡è¯• æˆ–è€… å°†éœ€è¦åˆ é™¤çš„keyå­˜å…¥æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œä¾æ¬¡ä¿è¯ åˆ é™¤ç¼“å­˜çš„æˆåŠŸã€‚</p><p>ä»æ•´ä¸ªå¤§å±€æ¥çœ‹ï¼Œæˆ‘ä»¬ä¼šå‘ç° å¦‚æœç¼“å­˜ä¸è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œæ˜¯æ¯”è¾ƒå®¹æ˜“é€ æˆ redisä¸æ•°æ®åº“ æœ€ç»ˆä¸€è‡´æ€§éš¾ä»¥ä¿è¯çš„ã€‚æœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯ è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œè¿™æ ·å³ä½¿è„æ•°æ®åœ¨ç¼“å­˜ä¸­ï¼Œä¹Ÿä¸ä¼šå­˜åœ¨å¾ˆä¹…ã€‚</p><p>ä¸ªäººçœ‹æ³•ï¼šå°å›¢é˜Ÿæˆ–è€…å°é¡¹ç›®å¯ä»¥è€ƒè™‘ ä½¿ç”¨æ–¹æ¡ˆ2+è®¾ç½®keyè¿‡æœŸæ—¶é—´ï¼Œè¾ƒå¤§é¡¹ç›®å¯ä»¥è€ƒè™‘ ä½¿ç”¨æ–¹æ¡ˆ4</p><h4 id=""><a href="#" class="headerlink" title=""></a></h4><h3 id="7-2-Redis-çš„å¤§keyå¦‚ä½•å¤„ç†ï¼Ÿ"><a href="#7-2-Redis-çš„å¤§keyå¦‚ä½•å¤„ç†ï¼Ÿ" class="headerlink" title="7.2 Redis çš„å¤§keyå¦‚ä½•å¤„ç†ï¼Ÿ"></a>7.2 Redis çš„å¤§keyå¦‚ä½•å¤„ç†ï¼Ÿ</h3><p>ä»€ä¹ˆæ˜¯ Redis å¤§key ï¼Ÿ</p><p>å¤§ key å¹¶ä¸æ˜¯æŒ‡ key çš„å€¼å¾ˆå¤§ï¼Œè€Œæ˜¯ key å¯¹åº”çš„ value å¾ˆå¤§ã€‚</p><p>ä¸€èˆ¬è€Œè¨€ï¼Œä¸‹é¢è¿™ä¸¤ç§æƒ…å†µè¢«ç§°ä¸ºå¤§ keyï¼š</p><ul><li>String ç±»å‹çš„å€¼å¤§äº 10 KBï¼›</li><li>Hashã€Listã€Setã€ZSet ç±»å‹çš„å…ƒç´ çš„ä¸ªæ•°è¶…è¿‡ 5000ä¸ªï¼›</li></ul><p>å¤§keyä¼šé€ æˆä»€ä¹ˆé—®é¢˜ï¼Ÿ</p><p>å¤§ key ä¼šå¸¦æ¥ä»¥ä¸‹å››ç§å½±å“ï¼š</p><ul><li><strong>å®¢æˆ·ç«¯è¶…æ—¶é˜»å¡ã€‚</strong>ç”±äº Redis æ‰§è¡Œå‘½ä»¤æ˜¯å•çº¿ç¨‹å¤„ç†ï¼Œç„¶ååœ¨æ“ä½œå¤§ key æ—¶ä¼šæ¯”è¾ƒè€—æ—¶ï¼Œé‚£ä¹ˆå°±ä¼šé˜»å¡ Redisï¼Œä»å®¢æˆ·ç«¯è¿™ä¸€è§†è§’çœ‹ï¼Œå°±æ˜¯å¾ˆä¹…å¾ˆä¹…éƒ½æ²¡æœ‰å“åº”ã€‚</li><li><strong>å¼•å‘ç½‘ç»œé˜»å¡ã€‚</strong>æ¯æ¬¡è·å–å¤§ key äº§ç”Ÿçš„ç½‘ç»œæµé‡è¾ƒå¤§ï¼Œå¦‚æœä¸€ä¸ª key çš„å¤§å°æ˜¯ 1 MBï¼Œæ¯ç§’è®¿é—®é‡ä¸º 1000ï¼Œé‚£ä¹ˆæ¯ç§’ä¼šäº§ç”Ÿ 1000MB çš„æµé‡ï¼Œè¿™å¯¹äºæ™®é€šåƒå…†ç½‘å¡çš„æœåŠ¡å™¨æ¥è¯´æ˜¯ç¾éš¾æ€§çš„ã€‚</li><li><strong>é˜»å¡å·¥ä½œçº¿ç¨‹ã€‚</strong>å¦‚æœä½¿ç”¨ del åˆ é™¤å¤§ key æ—¶ï¼Œä¼šé˜»å¡å·¥ä½œçº¿ç¨‹ï¼Œè¿™æ ·å°±æ²¡åŠæ³•å¤„ç†åç»­çš„å‘½ä»¤ã€‚</li><li><strong>å†…å­˜åˆ†å¸ƒä¸å‡ã€‚</strong>é›†ç¾¤æ¨¡å‹åœ¨ slot åˆ†ç‰‡å‡åŒ€æƒ…å†µä¸‹ï¼Œä¼šå‡ºç°æ•°æ®å’ŒæŸ¥è¯¢å€¾æ–œæƒ…å†µï¼Œéƒ¨åˆ†æœ‰å¤§ key çš„ Redis èŠ‚ç‚¹å ç”¨å†…å­˜å¤šï¼ŒQPS ä¹Ÿä¼šæ¯”è¾ƒå¤§ã€‚</li></ul><p>å¦‚ä½•æ‰¾åˆ°å¤§keyï¼Ÿ</p><ol><li>redis-cli â€“bigkeys æŸ¥æ‰¾å¤§key</li></ol><p>å¯ä»¥é€šè¿‡ redis-cli â€“bigkeys å‘½ä»¤æŸ¥æ‰¾å¤§ keyï¼š</p><p>ä½¿ç”¨çš„æ—¶å€™æ³¨æ„äº‹é¡¹ï¼š</p><ul><li><ul><li>æœ€å¥½é€‰æ‹©åœ¨ä»èŠ‚ç‚¹ä¸Šæ‰§è¡Œè¯¥å‘½ä»¤ã€‚å› ä¸ºä¸»èŠ‚ç‚¹ä¸Šæ‰§è¡Œæ—¶ï¼Œä¼šé˜»å¡ä¸»èŠ‚ç‚¹ï¼›</li><li>å¦‚æœæ²¡æœ‰ä»èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå¯ä»¥é€‰æ‹©åœ¨ Redis å®ä¾‹ä¸šåŠ¡å‹åŠ›çš„ä½å³°é˜¶æ®µè¿›è¡Œæ‰«ææŸ¥è¯¢ï¼Œä»¥å…å½±å“åˆ°å®ä¾‹çš„æ­£å¸¸è¿è¡Œï¼›æˆ–è€…å¯ä»¥ä½¿ç”¨ -i å‚æ•°æ§åˆ¶æ‰«æé—´éš”ï¼Œé¿å…é•¿æ—¶é—´æ‰«æé™ä½ Redis å®ä¾‹çš„æ€§èƒ½ã€‚</li></ul></li></ul><p>è¯¥æ–¹å¼çš„ä¸è¶³ä¹‹å¤„ï¼š</p><ul><li><ul><li>è¿™ä¸ªæ–¹æ³•åªèƒ½è¿”å›æ¯ç§ç±»å‹ä¸­æœ€å¤§çš„é‚£ä¸ª bigkeyï¼Œæ— æ³•å¾—åˆ°å¤§å°æ’åœ¨å‰ N ä½çš„ bigkeyï¼›</li><li>å¯¹äºé›†åˆç±»å‹æ¥è¯´ï¼Œè¿™ä¸ªæ–¹æ³•åªç»Ÿè®¡é›†åˆå…ƒç´ ä¸ªæ•°çš„å¤šå°‘ï¼Œè€Œä¸æ˜¯å®é™…å ç”¨çš„å†…å­˜é‡ã€‚ä½†æ˜¯ï¼Œä¸€ä¸ªé›†åˆä¸­çš„å…ƒç´ ä¸ªæ•°å¤šï¼Œå¹¶ä¸ä¸€å®šå ç”¨çš„å†…å­˜å°±å¤šã€‚å› ä¸ºï¼Œæœ‰å¯èƒ½æ¯ä¸ªå…ƒç´ å ç”¨çš„å†…å­˜å¾ˆå°ï¼Œè¿™æ ·çš„è¯ï¼Œå³ä½¿å…ƒç´ ä¸ªæ•°æœ‰å¾ˆå¤šï¼Œæ€»å†…å­˜å¼€é”€ä¹Ÿä¸å¤§ï¼›</li></ul></li></ul><ol><li>ä½¿ç”¨ SCAN å‘½ä»¤æŸ¥æ‰¾å¤§ key</li></ol><p>ä½¿ç”¨ SCAN å‘½ä»¤å¯¹æ•°æ®åº“æ‰«æï¼Œç„¶åç”¨ TYPE å‘½ä»¤è·å–è¿”å›çš„æ¯ä¸€ä¸ª key çš„ç±»å‹ã€‚</p><p>å¯¹äº String ç±»å‹ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ STRLEN å‘½ä»¤è·å–å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯å ç”¨çš„å†…å­˜ç©ºé—´å­—èŠ‚æ•°ã€‚</p><p>å¯¹äºé›†åˆç±»å‹æ¥è¯´ï¼Œæœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥è·å¾—å®ƒå ç”¨çš„å†…å­˜å¤§å°ï¼š</p><ul><li><ul><li>å¦‚æœèƒ½å¤Ÿé¢„å…ˆä»ä¸šåŠ¡å±‚çŸ¥é“é›†åˆå…ƒç´ çš„å¹³å‡å¤§å°ï¼Œé‚£ä¹ˆï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤è·å–é›†åˆå…ƒç´ çš„ä¸ªæ•°ï¼Œç„¶åä¹˜ä»¥é›†åˆå…ƒç´ çš„å¹³å‡å¤§å°ï¼Œè¿™æ ·å°±èƒ½è·å¾—é›†åˆå ç”¨çš„å†…å­˜å¤§å°äº†ã€‚List ç±»å‹ï¼šLLEN å‘½ä»¤ï¼›Hash ç±»å‹ï¼šHLEN å‘½ä»¤ï¼›Set ç±»å‹ï¼šSCARD å‘½ä»¤ï¼›Sorted Set ç±»å‹ï¼šZCARD å‘½ä»¤ï¼›</li><li>å¦‚æœä¸èƒ½æå‰çŸ¥é“å†™å…¥é›†åˆçš„å…ƒç´ å¤§å°ï¼Œå¯ä»¥ä½¿ç”¨ MEMORY USAGE å‘½ä»¤ï¼ˆéœ€è¦ Redis 4.0 åŠä»¥ä¸Šç‰ˆæœ¬ï¼‰ï¼ŒæŸ¥è¯¢ä¸€ä¸ªé”®å€¼å¯¹å ç”¨çš„å†…å­˜ç©ºé—´ã€‚</li></ul></li></ul><ol><li>ä½¿ç”¨ RdbTools å·¥å…·æŸ¥æ‰¾å¤§ key</li></ol><p>ä½¿ç”¨ RdbTools ç¬¬ä¸‰æ–¹å¼€æºå·¥å…·ï¼Œå¯ä»¥ç”¨æ¥è§£æ Redis å¿«ç…§ï¼ˆRDBï¼‰æ–‡ä»¶ï¼Œæ‰¾åˆ°å…¶ä¸­çš„å¤§ keyã€‚</p><p>æ¯”å¦‚ï¼Œä¸‹é¢è¿™æ¡å‘½ä»¤ï¼Œå°†å¤§äº 10 kb çš„  key  è¾“å‡ºåˆ°ä¸€ä¸ªè¡¨æ ¼æ–‡ä»¶ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rdb dump.rdb -c memory --bytes 10240 -f redis.csv</span><br></pre></td></tr></table></figure><p>å¦‚ä½•ä¼˜åŒ–å¤§keyï¼Ÿ</p><ul><li>å¯¹å¤§keyè¿›è¡Œæ‹†åˆ†å’Œå‹ç¼©</li></ul><p>ä¾‹å¦‚å°†å«æœ‰æ•°ä¸‡æˆå‘˜çš„ä¸€ä¸ªHASH Keyæ‹†åˆ†ä¸ºå¤šä¸ªHASH Keyï¼Œ<strong>ä½¿ç”¨multiGetæ–¹æ³•è·å¾—å€¼ï¼Œ</strong>å¹¶ç¡®ä¿æ¯ä¸ªKeyçš„æˆå‘˜æ•°é‡åœ¨åˆç†èŒƒå›´ã€‚<strong>è¿™æ ·çš„æ‹†åˆ†ä¸»è¦æ˜¯ä¸ºäº†å‡å°‘å•å°æ“ä½œçš„å‹åŠ›ï¼Œè€Œæ˜¯å°†å‹åŠ›å¹³æ‘Šåˆ°é›†ç¾¤å„ä¸ªå®ä¾‹ä¸­ï¼Œé™ä½å•å°æœºå™¨çš„IOæ“ä½œã€‚</strong></p><ul><li>å¯¹å¤§keyå¯ä»¥è¿›è¡Œæ¸…ç†</li></ul><p>å°†ä¸é€‚ç”¨Redisèƒ½åŠ›çš„æ•°æ®å­˜è‡³å…¶å®ƒå­˜å‚¨ï¼Œå¹¶åœ¨Redisä¸­åˆ é™¤æ­¤ç±»æ•°æ®ã€‚</p><ul><li>åœ¨Redisé›†ç¾¤æ¶æ„ä¸­å¯¹çƒ­Keyè¿›è¡Œå¤åˆ¶</li></ul><p>åœ¨Redisé›†ç¾¤æ¶æ„ä¸­ï¼Œç”±äºçƒ­Keyçš„è¿ç§»ç²’åº¦é—®é¢˜ï¼Œæ— æ³•å°†è¯·æ±‚åˆ†æ•£è‡³å…¶ä»–æ•°æ®åˆ†ç‰‡ï¼Œå¯¼è‡´å•ä¸ªæ•°æ®åˆ†ç‰‡çš„å‹åŠ›æ— æ³•ä¸‹é™ã€‚æ­¤æ—¶ï¼Œå¯ä»¥å°†å¯¹åº”çƒ­Keyè¿›è¡Œå¤åˆ¶å¹¶è¿ç§»è‡³å…¶ä»–æ•°æ®åˆ†ç‰‡ï¼Œä¾‹å¦‚å°†çƒ­Key fooå¤åˆ¶å‡º3ä¸ªå†…å®¹å®Œå…¨ä¸€æ ·çš„Keyå¹¶åä¸ºfoo2ã€foo3ã€foo4ï¼Œå°†è¿™ä¸‰ä¸ªKeyè¿ç§»åˆ°å…¶ä»–æ•°æ®åˆ†ç‰‡æ¥è§£å†³å•ä¸ªæ•°æ®åˆ†ç‰‡çš„çƒ­Keyå‹åŠ›ã€‚</p><ul><li>ä½¿ç”¨è¯»å†™åˆ†ç¦»æ¶æ„</li></ul><p>å¦‚æœçƒ­Keyçš„äº§ç”Ÿæ¥è‡ªäºè¯»è¯·æ±‚ï¼Œæ‚¨å¯ä»¥å°†å®ä¾‹æ”¹é€ æˆè¯»å†™åˆ†ç¦»æ¶æ„æ¥é™ä½æ¯ä¸ªæ•°æ®åˆ†ç‰‡çš„è¯»è¯·æ±‚å‹åŠ›ï¼Œç”šè‡³å¯ä»¥ä¸æ–­åœ°å¢åŠ ä»èŠ‚ç‚¹ã€‚ä½†æ˜¯è¯»å†™åˆ†ç¦»æ¶æ„åœ¨å¢åŠ ä¸šåŠ¡ä»£ç å¤æ‚åº¦çš„åŒæ—¶ï¼Œä¹Ÿä¼šå¢åŠ Redisé›†ç¾¤æ¶æ„å¤æ‚åº¦ã€‚</p><h3 id="7-3-å¦‚ä½•é€‰æ‹©æŒä¹…åŒ–ç­–ç•¥ï¼Ÿ"><a href="#7-3-å¦‚ä½•é€‰æ‹©æŒä¹…åŒ–ç­–ç•¥ï¼Ÿ" class="headerlink" title="7.3 å¦‚ä½•é€‰æ‹©æŒä¹…åŒ–ç­–ç•¥ï¼Ÿ"></a>7.3 å¦‚ä½•é€‰æ‹©æŒä¹…åŒ–ç­–ç•¥ï¼Ÿ</h3><p>RDB ä¼˜ç‚¹æ˜¯æ•°æ®æ¢å¤é€Ÿåº¦å¿«ï¼Œä½†æ˜¯å¿«ç…§çš„é¢‘ç‡ä¸å¥½æŠŠæ¡ã€‚é¢‘ç‡å¤ªä½ï¼Œä¸¢å¤±çš„æ•°æ®å°±ä¼šæ¯”è¾ƒå¤šï¼Œé¢‘ç‡å¤ªé«˜ï¼Œå°±ä¼šå½±å“æ€§èƒ½ã€‚</p><p>AOF ä¼˜ç‚¹æ˜¯ä¸¢å¤±æ•°æ®å°‘ï¼Œä½†æ˜¯æ•°æ®æ¢å¤ä¸å¿«ã€‚</p><p>ä¸ºäº†é›†æˆäº†ä¸¤è€…çš„ä¼˜ç‚¹ï¼Œ Redis 4.0 æå‡ºäº†<strong>æ··åˆä½¿ç”¨ AOF æ—¥å¿—å’Œå†…å­˜å¿«ç…§</strong>ï¼Œä¹Ÿå«æ··åˆæŒä¹…åŒ–ï¼Œæ—¢ä¿è¯äº† Redis é‡å¯é€Ÿåº¦ï¼Œåˆé™ä½æ•°æ®ä¸¢å¤±é£é™©ã€‚</p><p>æ··åˆæŒä¹…åŒ–å·¥ä½œåœ¨ <strong>AOF æ—¥å¿—é‡å†™è¿‡ç¨‹</strong>ï¼Œå½“å¼€å¯äº†æ··åˆæŒä¹…åŒ–æ—¶ï¼Œåœ¨ AOF é‡å†™æ—¥å¿—æ—¶ï¼Œfork å‡ºæ¥çš„é‡å†™å­è¿›ç¨‹ä¼šå…ˆå°†ä¸ä¸»çº¿ç¨‹å…±äº«çš„å†…å­˜æ•°æ®ä»¥ RDB æ–¹å¼å†™å…¥åˆ° AOF æ–‡ä»¶ï¼Œç„¶åä¸»çº¿ç¨‹å¤„ç†çš„æ“ä½œå‘½ä»¤ä¼šè¢«è®°å½•åœ¨é‡å†™ç¼“å†²åŒºé‡Œï¼Œé‡å†™ç¼“å†²åŒºé‡Œçš„å¢é‡å‘½ä»¤ä¼šä»¥ AOF æ–¹å¼å†™å…¥åˆ° AOF æ–‡ä»¶ï¼Œå†™å…¥å®Œæˆåé€šçŸ¥ä¸»è¿›ç¨‹å°†æ–°çš„å«æœ‰ RDB æ ¼å¼å’Œ AOF æ ¼å¼çš„ AOF æ–‡ä»¶æ›¿æ¢æ—§çš„çš„ AOF æ–‡ä»¶ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨äº†æ··åˆæŒä¹…åŒ–ï¼ŒAOF æ–‡ä»¶çš„<strong>å‰åŠéƒ¨åˆ†æ˜¯ RDB æ ¼å¼çš„å…¨é‡æ•°æ®ï¼ŒååŠéƒ¨åˆ†æ˜¯ AOF æ ¼å¼çš„å¢é‡æ•°æ®ã€‚</strong></p><p>è¿™æ ·çš„å¥½å¤„åœ¨äºï¼Œé‡å¯ Redis åŠ è½½æ•°æ®çš„æ—¶å€™ï¼Œç”±äºå‰åŠéƒ¨åˆ†æ˜¯ RDB å†…å®¹ï¼Œè¿™æ ·<strong>åŠ è½½çš„æ—¶å€™é€Ÿåº¦ä¼šå¾ˆå¿«</strong>ã€‚</p><p>åŠ è½½å®Œ RDB çš„å†…å®¹åï¼Œæ‰ä¼šåŠ è½½ååŠéƒ¨åˆ†çš„ AOF å†…å®¹ï¼Œè¿™é‡Œçš„å†…å®¹æ˜¯ Redis åå°å­è¿›ç¨‹é‡å†™ AOF æœŸé—´ï¼Œä¸»çº¿ç¨‹å¤„ç†çš„æ“ä½œå‘½ä»¤ï¼Œå¯ä»¥ä½¿å¾—<strong>æ•°æ®æ›´å°‘çš„ä¸¢å¤±ã€‚</strong></p><p><strong>æ··åˆæŒä¹…åŒ–ä¼˜ç‚¹ï¼š</strong></p><ul><li>æ··åˆæŒä¹…åŒ–ç»“åˆäº† RDB å’Œ AOF æŒä¹…åŒ–çš„ä¼˜ç‚¹ï¼Œå¼€å¤´ä¸º RDB çš„æ ¼å¼ï¼Œä½¿å¾— Redis å¯ä»¥æ›´å¿«çš„å¯åŠ¨ï¼ŒåŒæ—¶ç»“åˆ AOF çš„ä¼˜ç‚¹ï¼Œæœ‰å‡ä½äº†å¤§é‡æ•°æ®ä¸¢å¤±çš„é£é™©ã€‚</li></ul><p><strong>æ··åˆæŒä¹…åŒ–ç¼ºç‚¹ï¼š</strong></p><ul><li>AOF æ–‡ä»¶ä¸­æ·»åŠ äº† RDB æ ¼å¼çš„å†…å®¹ï¼Œä½¿å¾— AOF æ–‡ä»¶çš„å¯è¯»æ€§å˜å¾—å¾ˆå·®ï¼›</li><li>å…¼å®¹æ€§å·®ï¼Œå¦‚æœå¼€å¯æ··åˆæŒä¹…åŒ–ï¼Œé‚£ä¹ˆæ­¤æ··åˆæŒä¹…åŒ– AOF æ–‡ä»¶ï¼Œå°±ä¸èƒ½ç”¨åœ¨ Redis 4.0 ä¹‹å‰ç‰ˆæœ¬äº†ã€‚</li></ul><h2 id="å…«ã€Redis-æ¶‰åŠçš„ç®—æ³•"><a href="#å…«ã€Redis-æ¶‰åŠçš„ç®—æ³•" class="headerlink" title="å…«ã€Redis æ¶‰åŠçš„ç®—æ³•"></a>å…«ã€Redis æ¶‰åŠçš„ç®—æ³•</h2><h3 id="1-ä¸€è‡´æ€§Hash"><a href="#1-ä¸€è‡´æ€§Hash" class="headerlink" title="1.ä¸€è‡´æ€§Hash"></a>1.ä¸€è‡´æ€§Hash</h3><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779145889-e62ed280-3191-42c2-904d-1c8c373415eb-20250605100643333.png" alt="img"></p><h4 id="1-1-é—®é¢˜çš„ç”±æ¥"><a href="#1-1-é—®é¢˜çš„ç”±æ¥" class="headerlink" title="1.1 é—®é¢˜çš„ç”±æ¥"></a>1.1 é—®é¢˜çš„ç”±æ¥</h4><p>å¤§å¤šæ•°åº”ç”¨ï¼ŒèƒŒåè‚¯å®šä¸åªæœ‰ä¸€å°æœåŠ¡å™¨æä¾›æœåŠ¡ã€‚å› ä¸ºé«˜å¯ç”¨æˆ–å¹¶å‘é‡çš„éœ€è¦ï¼Œéƒ½ä¼šä½¿ç”¨å¤šå°æœåŠ¡å™¨ç»„æˆé›†ç¾¤å¯¹å¤–æä¾›æœåŠ¡ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œè¿™ä¹ˆå¤šæœåŠ¡å™¨ï¼Œè¦å¦‚ä½•åˆ†é…å®¢æˆ·ç«¯è¯·æ±‚å‘¢ï¼Ÿå…¶å®è¿™ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ è´Ÿè½½å‡è¡¡é—®é¢˜äº†ã€‚è§£å†³è´Ÿè½½å‡è¡¡é—®é¢˜çš„ç®—æ³•å¾ˆå¤šï¼Œä¸åŒçš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œé€‚ç”¨äºä¸åŒçš„åº”ç”¨åœºæ™¯å’Œéœ€æ±‚ã€‚ä¸€èˆ¬ï¼Œæœ€ç®€å•çš„æ–¹å¼ï¼Œå°±æ˜¯å¼•å…¥ä¸€ä¸ªä¸­é—´çš„è´Ÿè½½å‡è¡¡å±‚ï¼Œè®©å®ƒå°†å¤–ç•Œçš„è¯·æ±‚ â€œè½®æµâ€ è½¬å‘ç»™å†…éƒ¨çš„é›†ç¾¤ã€‚æ¯”å¦‚é›†ç¾¤æœ‰ä¸‰ä¸ªèŠ‚ç‚¹ï¼Œå¹¶æ”¶åˆ°äº†3ä¸ªè¯·æ±‚ï¼Œé‚£ä¹ˆæ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šå¤„ç†ä¸€ä¸ªè¯·æ±‚ã€‚</p><p>è€ƒè™‘åˆ°æ¯ä¸ªèŠ‚ç‚¹çš„ç¡¬ä»¶é…ç½®æœ‰åŒºåˆ«ï¼Œä¸€èˆ¬å¼•ç”¨æƒé‡å€¼ã€‚æŒ‰ä¸åŒèŠ‚ç‚¹çš„æƒé‡å€¼ï¼Œæ¥åˆ†é…è¯·æ±‚ï¼Œè®©å¤„ç†èƒ½åŠ›æ›´æŠ¢çš„èŠ‚ç‚¹ï¼Œåˆ†æ‹…æ›´å¤šè¯·æ±‚ã€‚</p><p>ä½†æ˜¯è¿™ç§åŠ æƒè½®è¯¢ä½¿ç”¨åœºæ™¯æ˜¯å»ºç«‹å‰æâ€”â€”æ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨çš„æ•°æ®éƒ½æ˜¯ç›¸åŒçš„ã€‚è¿™æ ·ï¼Œè®¿é—®ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥è·å–ç›¸åŒçš„ç»“æœã€‚ä½†æ˜¯ï¼Œè¿™å°±æ— æ³•åº”å¯¹ åˆ†å¸ƒå¼ç³»ç»Ÿã€‚å› ä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œæ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨çš„æ•°æ®æ˜¯ä¸åŒçš„ã€‚</p><p>æ¯”å¦‚ï¼šåˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿï¼Œä¸€èˆ¬ä¸ºäº†æé«˜ç³»ç»Ÿçš„å®¹é‡ï¼Œå°±ä¼šæŠŠæ•°æ®æ°´å¹³åˆ‡åˆ†åˆ°ä¸åŒçš„èŠ‚ç‚¹æ¥å­˜å‚¨ã€‚æ¯”å¦‚ Redisï¼ŒæŸä¸ªkeyåº”è¯¥åˆ°å“ªä¸ªæˆ–è€…é‚£äº›èŠ‚ç‚¹ä¸Šè·çš„ï¼Œåº”è¯¥æ˜¯ç¡®å®šçš„ã€‚è€Œä¸æ˜¯ä»»æ„è®¿é—®ä¸€ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥è·å– key å¯¹åº”çš„ valueã€‚</p><h4 id="1-2-ç›´æ¥ä½¿ç”¨å“ˆå¸Œç®—æ³•ï¼Ÿ"><a href="#1-2-ç›´æ¥ä½¿ç”¨å“ˆå¸Œç®—æ³•ï¼Ÿ" class="headerlink" title="1.2 ç›´æ¥ä½¿ç”¨å“ˆå¸Œç®—æ³•ï¼Ÿ"></a>1.2 ç›´æ¥ä½¿ç”¨å“ˆå¸Œç®—æ³•ï¼Ÿ</h4><p>å¾ˆå®¹æ˜“å°±ä¼šæƒ³åˆ° hashç®—æ³•ï¼Œå…¶å¯ä»¥é€šè¿‡ä¸€ä¸ª key è¿›è¡Œ å“ˆå¸Œè®¡ç®—ï¼Œæ¯æ¬¡éƒ½å¯ä»¥å¾—åˆ°ç›¸åŒçš„å€¼ã€‚è¿™æ ·å°±å¯ä»¥å°†æŸä¸ª key ç¡®å®šåˆ°ä¸€ä¸ªèŠ‚ç‚¹äº†ï¼Œå¯ä»¥æ»¡è¶³åˆ†å¸ƒå¼ç³»ç»Ÿçš„è´Ÿè½½å‡è¡¡éœ€æ±‚ã€‚</p><p>å“ˆå¸Œç®—æ³•æœ€ç®€å•çš„åšæ³•å°±æ˜¯è¿›è¡Œå–æ¨¡è¿ç®—ï¼Œæ¯”å¦‚åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æœ‰ 3 ä¸ªèŠ‚ç‚¹ï¼ŒåŸºäº hash(key) % 3 å…¬å¼å¯¹æ•°æ®è¿›è¡Œäº†æ˜ å°„ã€‚å¦‚æœå®¢æˆ·ç«¯è¦è·å–æŒ‡å®š key çš„æ•°æ®ï¼Œé€šè¿‡ä¸Šé¢çš„å…¬å¼å®šä½èŠ‚ç‚¹ã€‚</p><p>ä½†æ˜¯è¿™æœ‰ä¸€ä¸ªå¾ˆè‡´å‘½çš„é—®é¢˜ï¼šå¦‚æœèŠ‚ç‚¹æ•°æ®å‘ç”Ÿäº†å˜åŒ–ï¼Œä¹Ÿå°±æ˜¯åœ¨å¯¹ç³»ç»Ÿåšæ‰©å®¹æˆ–è€…ç¼©å®¹æ—¶ï¼Œå¯èƒ½é€ æˆå¤§éƒ¨åˆ†æ˜ å°„å…³ç³»æ”¹å˜ã€‚å¹¶ä¸”å¿…é¡»è¿ç§»æ”¹å˜äº†æ˜ å°„å…³ç³»çš„æ•°æ®ï¼Œå¦åˆ™ä¼šæŸ¥è¯¢ä¸åˆ°æ•°æ®çš„é—®é¢˜ã€‚å‡è®¾æ€»æ•°æ®æ¡æ•°ä¸º Mï¼Œå“ˆå¸Œç®—æ³•åœ¨é¢å¯¹èŠ‚ç‚¹æ•°é‡å˜åŒ–æ—¶ï¼Œæœ€åæƒ…å†µä¸‹æ‰€æœ‰æ•°æ®éƒ½éœ€è¦è¿ç§»ï¼Œæ‰€ä»¥å®ƒçš„æ•°æ®è¿ç§»è§„æ¨¡æ—¶ Oï¼ˆMï¼‰ï¼Œè¿™æ ·æ•°æ®è¿ç§»æˆæœ¬å¤ªé«˜ã€‚</p><h4 id="1-3-ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•æœ‰ä»€ä¹ˆé—®é¢˜"><a href="#1-3-ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•æœ‰ä»€ä¹ˆé—®é¢˜" class="headerlink" title="1.3 ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•æœ‰ä»€ä¹ˆé—®é¢˜?"></a>1.3 ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•æœ‰ä»€ä¹ˆé—®é¢˜?</h4><p>ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•å°±å¾ˆå¥½åœ°è§£å†³äº†åˆ†å¸ƒå¼ç³»ç»Ÿåœ¨æ‰©å®¹æˆ–è€…ç¼©å®¹æ—¶ï¼Œå‘ç”Ÿè¿‡å¤šçš„æ•°æ®è¿ç§»çš„é—®é¢˜ã€‚ä¸€è‡´å“ˆå¸Œç®—æ³•ä¹Ÿç”¨äº†å–æ¨¡è¿ç®—ï¼Œä½†äºå“ˆå¸Œç®—æ³•ä¸åŒçš„æ˜¯ï¼Œå“ˆå¸Œç®—æ³•æ˜¯å¯¹èŠ‚ç‚¹æ•°é‡è¿›è¡Œå–æ¨¡ï¼Œè€Œä¸€è‡´å“ˆå¸Œç®—æ³•æ˜¯å¯¹ 2^32 è¿›è¡Œå–æ¨¡è¿ç®—&#x3D;</p><p>ä»¬å¯ä»¥æŠŠä¸€è‡´å“ˆå¸Œç®—æ³•æ˜¯å¯¹ 2^32 è¿›è¡Œå–æ¨¡è¿ç®—çš„ç»“æœå€¼ç»„ç»‡æˆä¸€ä¸ªåœ†ç¯ã€‚è¿™ä¸ªåœ†æƒ³å¯ä»¥æƒ³è±¡æˆç”± 2^32 ä¸ªç‚¹ç»„æˆçš„åœ†ï¼Œè¿™ä¸ªåœ†ç¯è¢«ç§°ä¸º<strong>å“ˆå¸Œç¯</strong>ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779145911-113a608a-7f26-4b41-8eff-464c49c5cdb4-20250605100626223.png" alt="img"></p><p>ä¸€è‡´æ€§å“ˆå¸Œè¦è¿›è¡Œä¸¤æ­¥å“ˆå¸Œï¼š</p><ul><li>ç¬¬ä¸€æ­¥ï¼šå¯¹å­˜å‚¨èŠ‚ç‚¹è¿›è¡Œå“ˆå¸Œè®¡ç®—ï¼Œä¹Ÿå°±æ˜¯å¯¹å­˜å‚¨èŠ‚ç‚¹åšå“ˆå¸Œæ˜ å°„ï¼Œæ¯”å¦‚æ ¹æ®èŠ‚ç‚¹çš„ IP åœ°å€è¿›è¡Œå“ˆå¸Œï¼›</li><li>ç¬¬äºŒæ­¥ï¼šå½“å¯¹æ•°æ®è¿›è¡Œå­˜å‚¨æˆ–è®¿é—®æ—¶ï¼Œå¯¹æ•°æ®è¿›è¡Œå“ˆå¸Œæ˜ å°„ï¼›</li></ul><p>æ‰€ä»¥ï¼Œ<strong>ä¸€è‡´æ€§å“ˆå¸Œæ˜¯æŒ‡å°†ã€Œå­˜å‚¨èŠ‚ç‚¹ã€å’Œã€Œæ•°æ®ã€éƒ½æ˜ å°„åˆ°ä¸€ä¸ªé¦–å°¾ç›¸è¿çš„å“ˆå¸Œç¯ä¸Š</strong>ã€‚</p><p>é—®é¢˜æ¥äº†ï¼Œå¯¹ã€Œæ•°æ®ã€è¿›è¡Œå“ˆå¸Œæ˜ å°„å¾—åˆ°ä¸€ä¸ªç»“æœè¦æ€ä¹ˆæ‰¾åˆ°å­˜å‚¨è¯¥æ•°æ®çš„èŠ‚ç‚¹å‘¢ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯ï¼Œæ˜ å°„çš„ç»“æœå€¼å¾€<strong>é¡ºæ—¶é’ˆçš„æ–¹å‘çš„æ‰¾åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹</strong>ï¼Œå°±æ˜¯å­˜å‚¨è¯¥æ•°æ®çš„èŠ‚ç‚¹ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œæœ‰ 3 ä¸ªèŠ‚ç‚¹ç»è¿‡å“ˆå¸Œè®¡ç®—ï¼Œæ˜ å°„åˆ°äº†å¦‚ä¸‹å›¾çš„ä½ç½®ï¼š</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/35838370/1682779146288-40a6a0f2-c9c1-402e-b0b0-d5e849e93c80.png" alt="img"></p><p>æ¥ç€ï¼Œå¯¹è¦æŸ¥è¯¢çš„ key-01 è¿›è¡Œå“ˆå¸Œè®¡ç®—ï¼Œç¡®å®šæ­¤ key-01 æ˜ å°„åœ¨å“ˆå¸Œç¯çš„ä½ç½®ï¼Œç„¶åä»è¿™ä¸ªä½ç½®å¾€é¡ºæ—¶é’ˆçš„æ–¹å‘æ‰¾åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå°±æ˜¯å­˜å‚¨è¯¥ key-01 æ•°æ®çš„èŠ‚ç‚¹ã€‚</p><p>æ¯”å¦‚ï¼Œä¸‹å›¾ä¸­çš„ key-01 æ˜ å°„çš„ä½ç½®ï¼Œå¾€é¡ºæ—¶é’ˆçš„æ–¹å‘æ‰¾åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å°±æ˜¯èŠ‚ç‚¹ Aã€‚</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779148088-70cf5d37-5c2c-4798-9017-0b922282dfde-20250605100619239.png" alt="img"></p><p>æ‰€ä»¥ï¼Œå½“éœ€è¦å¯¹æŒ‡å®š key çš„å€¼è¿›è¡Œè¯»å†™çš„æ—¶å€™ï¼Œè¦é€šè¿‡ä¸‹é¢ 2 æ­¥è¿›è¡Œå¯»å€ï¼š</p><ul><li>é¦–å…ˆï¼Œå¯¹ key è¿›è¡Œå“ˆå¸Œè®¡ç®—ï¼Œç¡®å®šæ­¤ key åœ¨ç¯ä¸Šçš„ä½ç½®ï¼›</li><li>ç„¶åï¼Œä»è¿™ä¸ªä½ç½®æ²¿ç€é¡ºæ—¶é’ˆæ–¹å‘èµ°ï¼Œé‡åˆ°çš„ç¬¬ä¸€èŠ‚ç‚¹å°±æ˜¯å­˜å‚¨ key çš„èŠ‚ç‚¹ã€‚</li></ul><p>çŸ¥é“äº†ä¸€è‡´å“ˆå¸Œå¯»å€çš„æ–¹å¼ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ï¼Œå¦‚æœå¢åŠ ä¸€ä¸ªèŠ‚ç‚¹æˆ–è€…å‡å°‘ä¸€ä¸ªèŠ‚ç‚¹ä¼šå‘ç”Ÿå¤§é‡çš„æ•°æ®è¿ç§»å—ï¼Ÿ</p><p>å‡è®¾èŠ‚ç‚¹æ•°é‡ä» 3 å¢åŠ åˆ°äº† 4ï¼Œæ–°çš„èŠ‚ç‚¹ D ç»è¿‡å“ˆå¸Œè®¡ç®—åæ˜ å°„åˆ°äº†ä¸‹å›¾ä¸­çš„ä½ç½®ï¼š</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779148190-0c1b592b-c7fe-48c2-b1a3-809ba82d18c4-20250605100611637.png" alt="img"></p><p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œkey-01ã€key-03 éƒ½ä¸å—å½±å“ï¼Œåªæœ‰ key-02 éœ€è¦è¢«è¿ç§»èŠ‚ç‚¹ Dã€‚</p><p>å‡è®¾èŠ‚ç‚¹æ•°é‡ä» 3 å‡å°‘åˆ°äº† 2ï¼Œæ¯”å¦‚å°†èŠ‚ç‚¹ A ç§»é™¤ï¼š</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779149035-52942a34-67f3-4b3c-b460-711a9a5e35f8-20250605100604477.png" alt="img"></p><p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œkey-02 å’Œ key-03 ä¸ä¼šå—åˆ°å½±å“ï¼Œåªæœ‰ key-01 éœ€è¦è¢«è¿ç§»èŠ‚ç‚¹ Bã€‚</p><p>å› æ­¤ï¼Œ<strong>åœ¨ä¸€è‡´å“ˆå¸Œç®—æ³•ä¸­ï¼Œå¦‚æœå¢åŠ æˆ–è€…ç§»é™¤ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä»…å½±å“è¯¥èŠ‚ç‚¹åœ¨å“ˆå¸Œç¯ä¸Šé¡ºæ—¶é’ˆç›¸é‚»çš„åç»§èŠ‚ç‚¹ï¼Œå…¶å®ƒæ•°æ®ä¹Ÿä¸ä¼šå—åˆ°å½±å“</strong>ã€‚</p><p>ä¸Šé¢è¿™äº›å›¾ä¸­ 3 ä¸ªèŠ‚ç‚¹æ˜ å°„åœ¨å“ˆå¸Œç¯è¿˜æ˜¯æ¯”è¾ƒåˆ†æ•£çš„ï¼Œæ‰€ä»¥çœ‹èµ·æ¥è¯·æ±‚éƒ½ä¼šã€Œå‡è¡¡ã€åˆ°æ¯ä¸ªèŠ‚ç‚¹ã€‚</p><p>ä½†æ˜¯<strong>ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•å¹¶ä¸ä¿è¯èŠ‚ç‚¹èƒ½å¤Ÿåœ¨å“ˆå¸Œç¯ä¸Šåˆ†å¸ƒå‡åŒ€</strong>ï¼Œè¿™æ ·å°±ä¼šå¸¦æ¥ä¸€ä¸ªé—®é¢˜ï¼Œä¼šæœ‰å¤§é‡çš„è¯·æ±‚é›†ä¸­åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚</p><p>æ¯”å¦‚ï¼Œä¸‹å›¾ä¸­ 3 ä¸ªèŠ‚ç‚¹çš„æ˜ å°„ä½ç½®éƒ½åœ¨å“ˆå¸Œç¯çš„å³åŠè¾¹ï¼š</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779150974-f47dbce4-1f4a-4de3-a89c-46fe115a7c6e-20250605100557936.png" alt="img"></p><p>è¿™æ—¶å€™æœ‰ä¸€åŠä»¥ä¸Šçš„æ•°æ®çš„å¯»å€éƒ½ä¼šæ‰¾èŠ‚ç‚¹ Aï¼Œä¹Ÿå°±æ˜¯è®¿é—®è¯·æ±‚ä¸»è¦é›†ä¸­çš„èŠ‚ç‚¹ A ä¸Šï¼Œè¿™è‚¯å®šä¸è¡Œçš„å‘€ï¼Œè¯´å¥½çš„è´Ÿè½½å‡è¡¡å‘¢ï¼Œè¿™ç§æƒ…å†µä¸€ç‚¹éƒ½ä¸å‡è¡¡ã€‚</p><p>å¦å¤–ï¼Œåœ¨è¿™ç§èŠ‚ç‚¹åˆ†å¸ƒä¸å‡åŒ€çš„æƒ…å†µä¸‹ï¼Œè¿›è¡Œå®¹ç¾ä¸æ‰©å®¹æ—¶ï¼Œå“ˆå¸Œç¯ä¸Šçš„ç›¸é‚»èŠ‚ç‚¹å®¹æ˜“å—åˆ°è¿‡å¤§å½±å“ï¼Œå®¹æ˜“å‘ç”Ÿé›ªå´©å¼çš„è¿é”ååº”ã€‚</p><p>æ¯”å¦‚ï¼Œä¸Šå›¾ä¸­å¦‚æœèŠ‚ç‚¹ A è¢«ç§»é™¤äº†ï¼Œå½“èŠ‚ç‚¹ A å®•æœºåï¼Œæ ¹æ®ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•çš„è§„åˆ™ï¼Œå…¶ä¸Šæ•°æ®åº”è¯¥å…¨éƒ¨è¿ç§»åˆ°ç›¸é‚»çš„èŠ‚ç‚¹ B ä¸Šï¼Œè¿™æ ·ï¼ŒèŠ‚ç‚¹ B çš„æ•°æ®é‡ã€è®¿é—®é‡éƒ½ä¼šè¿…é€Ÿå¢åŠ å¾ˆå¤šå€ï¼Œä¸€æ—¦æ–°å¢çš„å‹åŠ›è¶…è¿‡äº†èŠ‚ç‚¹ B çš„å¤„ç†èƒ½åŠ›ä¸Šé™ï¼Œå°±ä¼šå¯¼è‡´èŠ‚ç‚¹ B å´©æºƒï¼Œè¿›è€Œå½¢æˆé›ªå´©å¼çš„è¿é”ååº”ã€‚</p><p>æ‰€ä»¥ï¼Œ<strong>ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•è™½ç„¶å‡å°‘äº†æ•°æ®è¿ç§»é‡ï¼Œä½†æ˜¯å­˜åœ¨èŠ‚ç‚¹åˆ†å¸ƒä¸å‡åŒ€çš„é—®é¢˜</strong>ã€‚</p><h4 id="1-3-é€šè¿‡è™šæ‹ŸèŠ‚ç‚¹æé«˜å‡è¡¡åº¦"><a href="#1-3-é€šè¿‡è™šæ‹ŸèŠ‚ç‚¹æé«˜å‡è¡¡åº¦" class="headerlink" title="1.3 é€šè¿‡è™šæ‹ŸèŠ‚ç‚¹æé«˜å‡è¡¡åº¦"></a>1.3 é€šè¿‡è™šæ‹ŸèŠ‚ç‚¹æé«˜å‡è¡¡åº¦</h4><p>è¦æƒ³è§£å†³èŠ‚ç‚¹èƒ½åœ¨ å“ˆå¸Œç¯ä¸Š åˆ†é…ä¸å‡åŒ€çš„é—®é¢˜ï¼Œå°±æ˜¯è¦æœ‰å¤§é‡çš„èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹è¶Šå¤šï¼Œå“ˆå¸Œç¯ä¸Šçš„èŠ‚ç‚¹åˆ†å¸ƒå°±è¶Šå‡åŒ€ã€‚ä½†é—®é¢˜æ˜¯ï¼Œå®é™…ä¸Šæˆ‘ä»¬æ²¡æœ‰é‚£ä¹ˆå¤šèŠ‚ç‚¹ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±åŠ å…¥è™šæ‹ŸèŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯å¯¹ä¸€ä¸ªçœŸå®èŠ‚ç‚¹åšå¤šä¸ªå‰¯æœ¬ã€‚</p><p>å…·ä½“åšæ³•æ˜¯ï¼Œä¸å†å°†çœŸå®èŠ‚ç‚¹æ˜ å°„åˆ°å“ˆå¸Œç¯ä¸Šï¼Œè€Œæ˜¯å°†è™šæ‹ŸèŠ‚ç‚¹æ˜ å°„åˆ°å“ˆå¸Œç¯ä¸Šï¼Œå¹¶å°†è™šæ‹ŸèŠ‚ç‚¹æ˜ å°„åˆ°å®é™…èŠ‚ç‚¹ã€‚æ‰€ä»¥è¿™é‡Œæœ‰ ä¸¤å±‚ æ˜ å°„å…³ç³»ã€‚</p><p>æ¯”å¦‚å¯¹æ¯ä¸ªèŠ‚ç‚¹åˆ†åˆ«è®¾ç½® 3 ä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼š</p><ul><li>å¯¹èŠ‚ç‚¹ A åŠ ä¸Šç¼–å·æ¥ä½œä¸ºè™šæ‹ŸèŠ‚ç‚¹ï¼šA-01ã€A-02ã€A-03</li><li>å¯¹èŠ‚ç‚¹ B åŠ ä¸Šç¼–å·æ¥ä½œä¸ºè™šæ‹ŸèŠ‚ç‚¹ï¼šB-01ã€B-02ã€B-03</li><li>å¯¹èŠ‚ç‚¹ C åŠ ä¸Šç¼–å·æ¥ä½œä¸ºè™šæ‹ŸèŠ‚ç‚¹ï¼šC-01ã€C-02ã€C-03</li></ul><p>å¼•å…¥è™šæ‹ŸèŠ‚ç‚¹åï¼ŒåŸæœ¬å“ˆå¸Œç¯ä¸Šåªæœ‰ 3 ä¸ªèŠ‚ç‚¹çš„æƒ…å†µï¼Œå°±ä¼šå˜æˆæœ‰ 9 ä¸ªè™šæ‹ŸèŠ‚ç‚¹æ˜ å°„åˆ°å“ˆå¸Œç¯ä¸Šï¼Œå“ˆå¸Œç¯ä¸Šçš„èŠ‚ç‚¹æ•°é‡å¤šäº† 3 å€ã€‚</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779151776-aaf4acdf-2263-4845-8949-6bcf82659d50-20250605100548993.png" alt="img"></p><p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œ<strong>èŠ‚ç‚¹æ•°é‡å¤šäº†åï¼ŒèŠ‚ç‚¹åœ¨å“ˆå¸Œç¯ä¸Šçš„åˆ†å¸ƒå°±ç›¸å¯¹å‡åŒ€äº†</strong>ã€‚è¿™æ—¶å€™ï¼Œå¦‚æœæœ‰è®¿é—®è¯·æ±‚å¯»å€åˆ°ã€ŒA-01ã€è¿™ä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼Œæ¥ç€å†é€šè¿‡ã€ŒA-01ã€è™šæ‹ŸèŠ‚ç‚¹æ‰¾åˆ°çœŸå®èŠ‚ç‚¹ Aï¼Œè¿™æ ·è¯·æ±‚å°±èƒ½è®¿é—®åˆ°çœŸå®èŠ‚ç‚¹ A äº†ã€‚</p><p>ä¸Šé¢ä¸ºäº†æ–¹ä¾¿ä½ ç†è§£ï¼Œæ¯ä¸ªçœŸå®èŠ‚ç‚¹ä»…åŒ…å« 3 ä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼Œè¿™æ ·èƒ½èµ·åˆ°çš„å‡è¡¡æ•ˆæœå…¶å®å¾ˆæœ‰é™ã€‚è€Œåœ¨å®é™…çš„å·¥ç¨‹ä¸­ï¼Œè™šæ‹ŸèŠ‚ç‚¹çš„æ•°é‡ä¼šå¤§å¾ˆå¤šï¼Œæ¯”å¦‚ Nginx çš„ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ï¼Œæ¯ä¸ªæƒé‡ä¸º 1 çš„çœŸå®èŠ‚ç‚¹å°±å«æœ‰160 ä¸ªè™šæ‹ŸèŠ‚ç‚¹ã€‚</p><p>å¦å¤–ï¼Œè™šæ‹ŸèŠ‚ç‚¹é™¤äº†ä¼šæé«˜èŠ‚ç‚¹çš„å‡è¡¡åº¦ï¼Œè¿˜ä¼šæé«˜ç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚<strong>å½“èŠ‚ç‚¹å˜åŒ–æ—¶ï¼Œä¼šæœ‰ä¸åŒçš„èŠ‚ç‚¹å…±åŒåˆ†æ‹…ç³»ç»Ÿçš„å˜åŒ–ï¼Œå› æ­¤ç¨³å®šæ€§æ›´é«˜</strong>ã€‚æ¯”å¦‚ï¼Œå½“æŸä¸ªèŠ‚ç‚¹è¢«ç§»é™¤æ—¶ï¼Œå¯¹åº” è¯¥èŠ‚ç‚¹çš„å¤šä¸ªè™šæ‹ŸèŠ‚ç‚¹å‡ä¼šç§»é™¤ï¼Œè€Œè¿™äº›è™šæ‹ŸèŠ‚ç‚¹æŒ‰é¡ºæ—¶é’ˆæ–¹å‘çš„ä¸‹ä¸€ä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼Œå¯èƒ½ä¼šå¯¹åº”ä¸åŒçš„çœŸå®èŠ‚ç‚¹ï¼Œå³è¿™äº›ä¸åŒçš„çœŸå®èŠ‚ç‚¹å…±åŒåˆ†æ‹…äº† èŠ‚ç‚¹è¢«ç§»é™¤ å¯¼è‡´çš„å‹åŠ›ã€‚</p><p>è€Œä¸”æœ‰è™šæ‹ŸèŠ‚ç‚¹çš„æ¦‚å¿µä¹Ÿæ–¹ä¾¿äº†ï¼Œå¯¹ä¸åŒèŠ‚ç‚¹è¿›è¡Œæƒé‡åŒºåˆ†ã€‚ç¡¬ä»¶é…ç½®æ›´å¥½çš„èŠ‚ç‚¹ï¼Œå¢åŠ æ›´å¤šè™šæ‹ŸèŠ‚ç‚¹ã€‚</p><h4 id="1-4-æ€»ç»“"><a href="#1-4-æ€»ç»“" class="headerlink" title="1.4 æ€»ç»“"></a>1.4 æ€»ç»“</h4><p>è½®è®­è¿™ç±»çš„ç­–ç•¥åªèƒ½é€‚ç”¨ä¸æ¯ä¸ªèŠ‚ç‚¹çš„æ•°æ®éƒ½æ˜¯ç›¸åŒçš„åœºæ™¯ï¼Œè®¿é—®ä»»æ„èŠ‚ç‚¹éƒ½èƒ½è¯·æ±‚åˆ°æ•°æ®ã€‚ä½†æ˜¯ä¸é€‚ç”¨åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå› ä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿæ„å‘³ç€æ•°æ®æ°´å¹³åˆ‡åˆ†åˆ°äº†ä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œè®¿é—®æ•°æ®çš„æ—¶å€™ï¼Œä¸€å®šè¦å¯»å€å­˜å‚¨è¯¥æ•°æ®çš„èŠ‚ç‚¹ã€‚</p><p>å“ˆå¸Œç®—æ³•è™½ç„¶èƒ½å»ºç«‹æ•°æ®å’ŒèŠ‚ç‚¹çš„æ˜ å°„å…³ç³»ï¼Œä½†æ˜¯æ¯æ¬¡åœ¨èŠ‚ç‚¹æ•°é‡å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œæœ€åæƒ…å†µä¸‹æ‰€æœ‰æ•°æ®éƒ½éœ€è¦è¿ç§»ï¼Œè¿™æ ·å¤ªéº»çƒ¦äº†ï¼Œæ‰€ä»¥ä¸é€‚ç”¨èŠ‚ç‚¹æ•°é‡å˜åŒ–çš„åœºæ™¯ã€‚</p><p>ä¸ºäº†å‡å°‘è¿ç§»çš„æ•°æ®é‡ï¼Œå°±å‡ºç°äº†ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ã€‚</p><p>ä¸€è‡´æ€§å“ˆå¸Œæ˜¯æŒ‡å°†ã€Œå­˜å‚¨èŠ‚ç‚¹ã€å’Œã€Œæ•°æ®ã€éƒ½æ˜ å°„åˆ°ä¸€ä¸ªé¦–å°¾ç›¸è¿çš„å“ˆå¸Œç¯ä¸Šï¼Œå¦‚æœå¢åŠ æˆ–è€…ç§»é™¤ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä»…å½±å“è¯¥èŠ‚ç‚¹åœ¨å“ˆå¸Œç¯ä¸Šé¡ºæ—¶é’ˆç›¸é‚»çš„åç»§èŠ‚ç‚¹ï¼Œå…¶å®ƒæ•°æ®ä¹Ÿä¸ä¼šå—åˆ°å½±å“ã€‚</p><p>ä½†æ˜¯ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ä¸èƒ½å¤Ÿå‡åŒ€çš„åˆ†å¸ƒèŠ‚ç‚¹ï¼Œä¼šå‡ºç°å¤§é‡è¯·æ±‚éƒ½é›†ä¸­åœ¨ä¸€ä¸ªèŠ‚ç‚¹çš„æƒ…å†µï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹è¿›è¡Œå®¹ç¾ä¸æ‰©å®¹æ—¶ï¼Œå®¹æ˜“å‡ºç°é›ªå´©çš„è¿é”ååº”ã€‚</p><p>ä¸ºäº†è§£å†³ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ä¸èƒ½å¤Ÿå‡åŒ€çš„åˆ†å¸ƒèŠ‚ç‚¹çš„é—®é¢˜ï¼Œå°±éœ€è¦å¼•å…¥è™šæ‹ŸèŠ‚ç‚¹ï¼Œå¯¹ä¸€ä¸ªçœŸå®èŠ‚ç‚¹åšå¤šä¸ªå‰¯æœ¬ã€‚ä¸å†å°†çœŸå®èŠ‚ç‚¹æ˜ å°„åˆ°å“ˆå¸Œç¯ä¸Šï¼Œè€Œæ˜¯å°†è™šæ‹ŸèŠ‚ç‚¹æ˜ å°„åˆ°å“ˆå¸Œç¯ä¸Šï¼Œå¹¶å°†è™šæ‹ŸèŠ‚ç‚¹æ˜ å°„åˆ°å®é™…èŠ‚ç‚¹ï¼Œæ‰€ä»¥è¿™é‡Œæœ‰ã€Œä¸¤å±‚ã€æ˜ å°„å…³ç³»ã€‚</p><p>å¼•å…¥è™šæ‹ŸèŠ‚ç‚¹åï¼Œå¯ä»¥ä¼šæé«˜èŠ‚ç‚¹çš„å‡è¡¡åº¦ï¼Œè¿˜ä¼šæé«˜ç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚æ‰€ä»¥ï¼Œå¸¦è™šæ‹ŸèŠ‚ç‚¹çš„ä¸€è‡´æ€§å“ˆå¸Œæ–¹æ³•ä¸ä»…é€‚åˆç¡¬ä»¶é…ç½®ä¸åŒçš„èŠ‚ç‚¹çš„åœºæ™¯ï¼Œè€Œä¸”é€‚åˆèŠ‚ç‚¹è§„æ¨¡ä¼šå‘ç”Ÿå˜åŒ–çš„åœºæ™¯ã€‚</p><hr><p>æ‘˜å½•æ–‡ç« ï¼š</p><p>Redis è®¾è®¡ä¸å®ç°ï¼ˆç¬¬ä¸€ç‰ˆï¼‰ï¼š<a href="https://redisbook.readthedocs.io/en/latest/index.html">https://redisbook.readthedocs.io/en/latest/index.html</a></p><p><a href="https://juejin.cn/post/6964531365643550751">ç¾å›¢äºŒé¢ï¼šRedisä¸MySQLåŒå†™ä¸€è‡´æ€§å¦‚ä½•ä¿è¯ï¼Ÿ</a></p>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>MySQL ç´¢å¼•å¤±æ•ˆåœºæ™¯</title>
      <link href="/2025/06/07/MySQL%20%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88%E5%9C%BA%E6%99%AF/"/>
      <url>/2025/06/07/MySQL%20%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88%E5%9C%BA%E6%99%AF/</url>
      
        <content type="html"><![CDATA[<h1 id="MySQL-ç´¢å¼•å¤±æ•ˆåœºæ™¯"><a href="#MySQL-ç´¢å¼•å¤±æ•ˆåœºæ™¯" class="headerlink" title="MySQL ç´¢å¼•å¤±æ•ˆåœºæ™¯"></a>MySQL ç´¢å¼•å¤±æ•ˆåœºæ™¯</h1><ol><li>ç´¢å¼•åˆ—å‚ä¸è®¡ç®—æˆ–è¿›è¡Œå‡½æ•°æ“ä½œ</li><li>ä½¿ç”¨ORï¼Œå¹¶ä¸”ORçš„ä¸¤è¾¹å­˜åœ¨&lt; æˆ–è€… &gt; çš„æ—¶å€™</li><li>ä½¿ç”¨likeæ“ä½œï¼Œä½†æ˜¯ä¸æ»¡è¶³å·¦åŒ¹é…ï¼Œä¾‹å¦‚ï¼šâ€%javaâ€</li><li>éšå¼ç±»å‹è½¬æ¢ï¼Œæ¯”å¦‚ä¸€ä¸ªstringç±»å‹åˆ—ï¼Œä½¿ç”¨æ•°å­—æ¥æŸ¥è¯¢ã€‚è¿™ç§æƒ…å†µæœ‰ä¸€ä¸ªç‰¹åˆ—ï¼Œå¦‚æœå­—æ®µç±»å‹ä¸ºintç±»å‹ï¼Œè€ŒæŸ¥è¯¢æ¡ä»¶æ·»åŠ äº†å•å¼•å·æˆ–è€…åŒå¼•å·ï¼Œåˆ™Mysqlä¼šå‚æ•°è½¬åŒ–ä¸ºintç±»å‹ï¼Œè¿™ç§æƒ…å†µä¹Ÿå¯ä»¥èµ°ç´¢å¼•ã€‚</li><li>ä¸ç­‰äºæ¯”è¾ƒã€‚è¿™ç§æƒ…å†µä¹Ÿæ˜¯æœ‰å¯èƒ½ä¼šèµ°ç´¢å¼•çš„ï¼Œæ¯”å¦‚ç”¨idè¿›è¡Œ!&#x3D;ï¼Œæ˜¯å¯èƒ½èµ°ç´¢å¼•çš„ã€‚</li><li>ä½¿ç”¨is not nullæ—¶ä¸èµ°ç´¢å¼•ï¼Œä½¿ç”¨ is null èµ°ç´¢å¼•</li><li>order byã€‚å¦‚æœorder byçš„æ—¶å€™æ•°æ®é‡å¾ˆå°ï¼Œæ•°æ®åº“å¯èƒ½ç›´æ¥åœ¨å†…å­˜ä¸­è¿›è¡Œæ’åºã€‚</li><li>inã€‚ä¸€èˆ¬åœ¨inä¸­çš„å€¼æ¯”è¾ƒå°‘çš„æ—¶å€™å¯èƒ½ä¼šèµ°ç´¢å¼•ä¼˜åŒ–ï¼Œä½†å¦‚æœé€‰é¡¹æ¯”è¾ƒå¤šï¼Œå¯èƒ½ä¸èµ°ç´¢å¼•ã€‚</li><li>è”åˆç´¢å¼•å¤±æ•ˆã€‚æ¯”å¦‚è”åˆç´¢å¼•ï¼ˆaï¼Œbï¼Œcï¼‰ï¼Œè¿›è¡ŒæŸ¥è¯¢æ—¶æ²¡æœ‰æ»¡è¶³æœ€å·¦åŒ¹é…ï¼ˆæŸ¥bï¼ŒæŸ¥cï¼ŒæŸ¥b cï¼‰</li><li>å­˜å‚¨å¼•æ“ä¸èƒ½ä½¿ç”¨ç´¢å¼•èŒƒå›´æ¡ä»¶å³è¾¹çš„åˆ—</li><li>ä¸¤åˆ—åšæ¯”è¾ƒã€‚å¦‚æœä¸¤ä¸ªåˆ—æ•°æ®éƒ½æœ‰ç´¢å¼•ï¼Œä½†æ˜¯åœ¨æŸ¥è¯¢æ¡ä»¶ä¸­å¯¹ä¸¤åˆ—æ•°æ®è¿›è¡Œäº†å¯¹æ¯”æ“ä½œï¼Œåˆ™ä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆã€‚</li><li>æŸ¥è¯¢æ¡ä»¶æ˜¯ç”¨no inæ—¶ï¼Œå¦‚æœæ˜¯ä¸»é”®åˆ™èµ°ç´¢å¼•ã€‚å¦‚æœæ˜¯æ™®é€šç´¢å¼•ï¼Œåˆ™å¤±æ•ˆ</li><li>not exists ä¸èµ°ç´¢å¼•ï¼Œexists å¯èƒ½èµ°ç´¢å¼•</li></ol><hr><h3 id="1-ç´¢å¼•åˆ—å‚ä¸è®¡ç®—æˆ–å‡½æ•°æ“ä½œ"><a href="#1-ç´¢å¼•åˆ—å‚ä¸è®¡ç®—æˆ–å‡½æ•°æ“ä½œ" class="headerlink" title="1. ç´¢å¼•åˆ—å‚ä¸è®¡ç®—æˆ–å‡½æ•°æ“ä½œ"></a><strong>1. ç´¢å¼•åˆ—å‚ä¸è®¡ç®—æˆ–å‡½æ•°æ“ä½œ</strong></h3><ul><li><strong>æ­£å¸¸åˆ¤æ–­</strong>ï¼šç´¢å¼•åˆ—ç›´æ¥ä½¿ç”¨åŸå§‹å€¼ã€‚</li><li><strong>å¤±æ•ˆåŸå› </strong>ï¼šç´¢å¼•å­˜å‚¨çš„æ˜¯åˆ—åŸå§‹å€¼ï¼Œè®¡ç®—æˆ–å‡½æ•°æ“ä½œåç”Ÿæˆçš„å€¼æ— æ³•åŒ¹é…ç´¢å¼•ç»“æ„ã€‚</li><li><strong>å…·ä½“åŸç†</strong>ï¼šB+ æ ‘ç´¢å¼•åŸºäºåŸå§‹å€¼æ„å»ºï¼Œè®¡ç®—æˆ–å‡½æ•°ä¼šç ´åå€¼ä¸ç´¢å¼•çš„æ˜ å°„å…³ç³»ï¼Œå¯¼è‡´æ— æ³•é€šè¿‡ç´¢å¼•æ ‘å¿«é€Ÿå®šä½ã€‚</li><li><strong>ç¤ºä¾‹ SQL</strong>ï¼š</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å¤±æ•ˆ</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> <span class="keyword">YEAR</span>(create_time) <span class="operator">=</span> <span class="number">2023</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> a <span class="operator">+</span> <span class="number">10</span> <span class="operator">=</span> <span class="number">20</span>;</span><br><span class="line"><span class="comment">-- æ­£å¸¸</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> create_time <span class="keyword">BETWEEN</span> <span class="string">&#x27;2023-01-01&#x27;</span> <span class="keyword">AND</span> <span class="string">&#x27;2023-12-31&#x27;</span>;</span><br></pre></td></tr></table></figure><hr><h3 id="2-ä½¿ç”¨-OR-ä¸”ä¸¤è¾¹å­˜åœ¨èŒƒå›´æŸ¥è¯¢"><a href="#2-ä½¿ç”¨-OR-ä¸”ä¸¤è¾¹å­˜åœ¨èŒƒå›´æŸ¥è¯¢" class="headerlink" title="2. ä½¿ç”¨ OR ä¸”ä¸¤è¾¹å­˜åœ¨èŒƒå›´æŸ¥è¯¢"></a><strong>2. ä½¿ç”¨</strong> <code>OR</code> <strong>ä¸”ä¸¤è¾¹å­˜åœ¨èŒƒå›´æŸ¥è¯¢</strong></h3><ul><li><strong>æ­£å¸¸åˆ¤æ–­</strong>ï¼š<code>OR</code> ä¸¤ä¾§å‡æœ‰ç´¢å¼•ä¸”é€»è¾‘ç®€å•ã€‚</li><li><strong>å¤±æ•ˆåŸå› </strong>ï¼š<code>OR</code> è¦æ±‚åŒæ—¶æ»¡è¶³å¤šä¸ªæ¡ä»¶ï¼Œè‹¥ä»»æ„ä¸€ä¾§æ— ç´¢å¼•æˆ–æ¶‰åŠèŒƒå›´æŸ¥è¯¢ï¼Œä¼˜åŒ–å™¨å¯èƒ½æ”¾å¼ƒç´¢å¼•ã€‚</li><li><strong>å…·ä½“åŸç†</strong>ï¼šMySQL å¯¹ <code>OR</code> çš„ä¼˜åŒ–èƒ½åŠ›æœ‰é™ï¼Œè‹¥æ— æ³•åˆå¹¶ç´¢å¼•èŒƒå›´ï¼Œåˆ™é€‰æ‹©å…¨è¡¨æ‰«æã€‚</li><li><strong>ç¤ºä¾‹ SQL</strong>ï¼š</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å¤±æ•ˆï¼ˆå‡è®¾ d åˆ—æ— ç´¢å¼•ï¼‰</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> a <span class="operator">&gt;</span> <span class="number">10</span> <span class="keyword">OR</span> d <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line"><span class="comment">-- ä¼˜åŒ–æ–¹æ³•</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> a <span class="operator">&gt;</span> <span class="number">10</span> </span><br><span class="line"><span class="keyword">UNION</span> </span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> d <span class="operator">=</span> <span class="number">5</span>;</span><br></pre></td></tr></table></figure><hr><h3 id="3-LIKE-ä¸æ»¡è¶³å·¦åŒ¹é…"><a href="#3-LIKE-ä¸æ»¡è¶³å·¦åŒ¹é…" class="headerlink" title="3. LIKE ä¸æ»¡è¶³å·¦åŒ¹é…"></a><strong>3.</strong> <code>LIKE</code> <strong>ä¸æ»¡è¶³å·¦åŒ¹é…</strong></h3><ul><li><strong>æ­£å¸¸åˆ¤æ–­</strong>ï¼š<code>LIKE</code> ä½¿ç”¨å‰ç¼€åŒ¹é…ï¼ˆå¦‚ <code>&#39;abc%&#39;</code>ï¼‰ã€‚</li><li><strong>å¤±æ•ˆåŸå› </strong>ï¼šä»¥é€šé…ç¬¦å¼€å¤´ï¼ˆ<code>%</code> æˆ– <code>_</code>ï¼‰ç ´åç´¢å¼•å‰ç¼€æœ‰åºæ€§ã€‚</li><li><strong>å…·ä½“åŸç†</strong>ï¼šB+ æ ‘ç´¢å¼•æŒ‰å‰ç¼€æ’åºï¼Œæ— æ³•åå‘æˆ–ä¸­é—´æ¨¡ç³ŠåŒ¹é…ã€‚</li><li><strong>ç¤ºä¾‹ SQL</strong>ï¼š</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å¤±æ•ˆ</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> name <span class="keyword">LIKE</span> <span class="string">&#x27;%java&#x27;</span>;</span><br><span class="line"><span class="comment">-- æ­£å¸¸</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> name <span class="keyword">LIKE</span> <span class="string">&#x27;java%&#x27;</span>;</span><br></pre></td></tr></table></figure><hr><h3 id="4-éšå¼ç±»å‹è½¬æ¢"><a href="#4-éšå¼ç±»å‹è½¬æ¢" class="headerlink" title="4. éšå¼ç±»å‹è½¬æ¢"></a><strong>4. éšå¼ç±»å‹è½¬æ¢</strong></h3><ul><li><strong>æ­£å¸¸åˆ¤æ–­</strong>ï¼šæŸ¥è¯¢å€¼ä¸åˆ—ç±»å‹ä¸¥æ ¼ä¸€è‡´ã€‚</li><li><strong>å¤±æ•ˆåŸå› </strong>ï¼šç±»å‹ä¸åŒ¹é…å¯¼è‡´ MySQL éšå¼è½¬æ¢ï¼Œç ´åç´¢å¼•åŒ¹é…ã€‚</li><li><strong>å…·ä½“åŸç†</strong>ï¼šç´¢å¼•å­˜å‚¨çš„æ˜¯åˆ—å®šä¹‰çš„ç±»å‹ï¼Œéšå¼è½¬æ¢ç›¸å½“äºå¯¹åˆ—ä½¿ç”¨å‡½æ•°ï¼ˆå¦‚ <code>CAST</code>ï¼‰ã€‚</li><li><strong>ç¤ºä¾‹ SQL</strong>ï¼š</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å¤±æ•ˆï¼ˆå‡è®¾ a æ˜¯ VARCHARï¼‰</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> a <span class="operator">=</span> <span class="number">123</span>;  <span class="comment">-- MySQL æ‰§è¡Œ CAST(a AS INT)</span></span><br><span class="line"><span class="comment">-- æ­£å¸¸ï¼ˆç‰¹ä¾‹ï¼šå­—æ®µä¸º INTï¼ŒæŸ¥è¯¢å€¼å¸¦å¼•å·ï¼‰</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="string">&#x27;123&#x27;</span>;  <span class="comment">-- id æ˜¯ INT ç±»å‹</span></span><br></pre></td></tr></table></figure><hr><h3 id="5-ä¸ç­‰äºæ¯”è¾ƒï¼ˆ-æˆ–-ï¼‰"><a href="#5-ä¸ç­‰äºæ¯”è¾ƒï¼ˆ-æˆ–-ï¼‰" class="headerlink" title="5. ä¸ç­‰äºæ¯”è¾ƒï¼ˆ!= æˆ– &lt;&gt;ï¼‰"></a><strong>5. ä¸ç­‰äºæ¯”è¾ƒï¼ˆ</strong><code>!=</code> <strong>æˆ–</strong> <code>&lt;&gt;</code><strong>ï¼‰</strong></h3><ul><li><strong>æ­£å¸¸åˆ¤æ–­</strong>ï¼šä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•å¯èƒ½èµ°ç´¢å¼•ã€‚</li><li><strong>å¤±æ•ˆåŸå› </strong>ï¼šéä¸»é”®çš„ä¸ç­‰äºæ“ä½œéœ€æ‰«æå¤§éƒ¨åˆ†æ•°æ®ï¼Œä¼˜åŒ–å™¨è®¤ä¸ºå…¨è¡¨æ›´å¿«ã€‚</li><li><strong>å…·ä½“åŸç†</strong>ï¼šç´¢å¼•é€‚åˆå®šä½å°‘é‡æ•°æ®ï¼Œä¸ç­‰äºæ“ä½œéœ€éå†ç´¢å¼•æ ‘å¤§éƒ¨åˆ†èŠ‚ç‚¹ã€‚</li><li><strong>ç¤ºä¾‹ SQL</strong>ï¼š</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å¤±æ•ˆï¼ˆæ™®é€šç´¢å¼•ï¼‰</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> a <span class="operator">!=</span> <span class="number">5</span>;</span><br><span class="line"><span class="comment">-- æ­£å¸¸ï¼ˆä¸»é”®æˆ–è¦†ç›–ç´¢å¼•ï¼‰</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> id <span class="operator">!=</span> <span class="number">5</span>;  <span class="comment">-- id æ˜¯ä¸»é”®</span></span><br></pre></td></tr></table></figure><hr><h3 id="6-IS-NOT-NULL-ä¸-IS-NULL"><a href="#6-IS-NOT-NULL-ä¸-IS-NULL" class="headerlink" title="6. IS NOT NULL ä¸ IS NULL"></a><strong>6.</strong> <code>IS NOT NULL</code> <strong>ä¸</strong> <code>IS NULL</code></h3><ul><li><strong>æ­£å¸¸åˆ¤æ–­</strong>ï¼š<code>IS NULL</code> å¯èµ°ç´¢å¼•ï¼Œ<code>IS NOT NULL</code> å¯èƒ½å¤±æ•ˆã€‚</li><li><strong>å¤±æ•ˆåŸå› </strong>ï¼š<code>IS NOT NULL</code> éœ€éå†æ‰€æœ‰éç©ºå€¼ï¼Œæˆæœ¬é«˜ã€‚</li><li><strong>å…·ä½“åŸç†</strong>ï¼šç´¢å¼•ä¸­ <code>NULL</code> å€¼é›†ä¸­å­˜å‚¨ï¼ˆInnoDBï¼‰ï¼Œ<code>IS NULL</code> å¯å¿«é€Ÿå®šä½ï¼Œè€Œ <code>IS NOT NULL</code> éœ€æ‰«æå…¨ç´¢å¼•ã€‚</li><li><strong>ç¤ºä¾‹ SQL</strong>ï¼š</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å¤±æ•ˆ</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> a <span class="keyword">IS</span> <span class="keyword">NOT NULL</span>;</span><br><span class="line"><span class="comment">-- æ­£å¸¸</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> a <span class="keyword">IS</span> <span class="keyword">NULL</span>;</span><br></pre></td></tr></table></figure><hr><h3 id="7-ORDER-BY-æ’åº"><a href="#7-ORDER-BY-æ’åº" class="headerlink" title="7. ORDER BY æ’åº"></a><strong>7.</strong> <code>ORDER BY</code> <strong>æ’åº</strong></h3><ul><li><strong>æ­£å¸¸åˆ¤æ–­</strong>ï¼šæ’åºå­—æ®µæœ‰ç´¢å¼•ä¸”é¡ºåºä¸€è‡´ã€‚</li><li><strong>å¤±æ•ˆåŸå› </strong>ï¼šå°æ•°æ®é‡ç›´æ¥åœ¨å†…å­˜æ’åºï¼›æ’åºå­—æ®µæ— ç´¢å¼•æˆ–é¡ºåºä¸åŒ¹é…ã€‚</li><li><strong>å…·ä½“åŸç†</strong>ï¼šç´¢å¼•æœ¬èº«æœ‰åºï¼Œè‹¥ <code>ORDER BY</code> å­—æ®µä¸ç´¢å¼•é¡ºåºä¸€è‡´ï¼Œå¯é¿å… <code>filesort</code> æ“ä½œã€‚</li><li><strong>ç¤ºä¾‹ SQL</strong>ï¼š</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å¤±æ•ˆï¼ˆæ— ç´¢å¼•ï¼‰</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> a;</span><br><span class="line"><span class="comment">-- æ­£å¸¸ï¼ˆç´¢å¼•æ”¯æŒæ’åºï¼‰</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> a, b;  <span class="comment">-- ç´¢å¼• (a, b)</span></span><br></pre></td></tr></table></figure><hr><h3 id="8-IN-æ¡ä»¶"><a href="#8-IN-æ¡ä»¶" class="headerlink" title="8. IN æ¡ä»¶"></a><strong>8.</strong> <code>IN</code> <strong>æ¡ä»¶</strong></h3><ul><li><strong>æ­£å¸¸åˆ¤æ–­</strong>ï¼š<code>IN</code> åˆ—è¡¨è¾ƒçŸ­ä¸”é€‰æ‹©æ€§é«˜ã€‚</li><li><strong>å¤±æ•ˆåŸå› </strong>ï¼šé•¿åˆ—è¡¨å¯¼è‡´ä¼˜åŒ–å™¨è®¤ä¸ºå…¨è¡¨æ‰«ææ›´å¿«ã€‚</li><li><strong>å…·ä½“åŸç†</strong>ï¼š<code>IN</code> æœ¬è´¨æ˜¯å¤šä¸ª <code>OR</code>ï¼Œåˆ—è¡¨è¿‡é•¿æ—¶ç´¢å¼•æ£€ç´¢æˆæœ¬è¶…è¿‡å…¨è¡¨æ‰«æã€‚</li><li><strong>ç¤ºä¾‹ SQL</strong>ï¼š</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å¤±æ•ˆï¼ˆåˆ—è¡¨è¿‡é•¿ï¼‰</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> a <span class="keyword">IN</span> (<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,...,<span class="number">1000</span>);</span><br><span class="line"><span class="comment">-- æ­£å¸¸ï¼ˆä¸»é”®æˆ–çŸ­åˆ—è¡¨ï¼‰</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> id <span class="keyword">IN</span> (<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>);</span><br></pre></td></tr></table></figure><hr><h3 id="9-è”åˆç´¢å¼•æœªéµå¾ªæœ€å·¦å‰ç¼€"><a href="#9-è”åˆç´¢å¼•æœªéµå¾ªæœ€å·¦å‰ç¼€" class="headerlink" title="9. è”åˆç´¢å¼•æœªéµå¾ªæœ€å·¦å‰ç¼€"></a><strong>9. è”åˆç´¢å¼•æœªéµå¾ªæœ€å·¦å‰ç¼€</strong></h3><ul><li><strong>æ­£å¸¸åˆ¤æ–­</strong>ï¼šæŸ¥è¯¢æ¡ä»¶åŒ…å«æœ€å·¦åˆ—ä¸”é¡ºåºåˆç†ã€‚</li><li><strong>å¤±æ•ˆåŸå› </strong>ï¼šæœªåŒ…å«æœ€å·¦åˆ—ï¼Œæˆ–ä¸­é—´åˆ—è¢«èŒƒå›´æŸ¥è¯¢ä¸­æ–­ã€‚</li><li><strong>å…·ä½“åŸç†</strong>ï¼šè”åˆç´¢å¼•æŒ‰ <code>(a, b, c)</code> é¡ºåºæ„å»º B+ æ ‘ï¼Œç¼ºå°‘ä¸­é—´åˆ—å¯¼è‡´åç»­åˆ—æ— åºã€‚</li><li><strong>ç¤ºä¾‹ SQL</strong>ï¼š</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å¤±æ•ˆï¼ˆç¼ºå°‘ aï¼‰</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> b<span class="operator">=</span><span class="number">2</span> <span class="keyword">AND</span> c<span class="operator">=</span><span class="number">3</span>;</span><br><span class="line"><span class="comment">-- éƒ¨åˆ†å¤±æ•ˆï¼ˆc æ— æ³•ç›´æ¥åˆ©ç”¨ç´¢å¼•ï¼‰</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> a<span class="operator">=</span><span class="number">1</span> <span class="keyword">AND</span> c<span class="operator">=</span><span class="number">3</span>;</span><br></pre></td></tr></table></figure><hr><h3 id="10-èŒƒå›´æŸ¥è¯¢é˜»æ–­åç»­åˆ—"><a href="#10-èŒƒå›´æŸ¥è¯¢é˜»æ–­åç»­åˆ—" class="headerlink" title="10. èŒƒå›´æŸ¥è¯¢é˜»æ–­åç»­åˆ—"></a><strong>10. èŒƒå›´æŸ¥è¯¢é˜»æ–­åç»­åˆ—</strong></h3><ul><li><strong>æ­£å¸¸åˆ¤æ–­</strong>ï¼šèŒƒå›´æŸ¥è¯¢åˆ—åœ¨è”åˆç´¢å¼•æœ«å°¾ã€‚</li><li><strong>å¤±æ•ˆåŸå› </strong>ï¼šèŒƒå›´æŸ¥è¯¢ï¼ˆå¦‚ <code>&gt;</code>ã€<code>BETWEEN</code>ï¼‰åï¼Œåç»­åˆ—æ— æ³•ä½¿ç”¨ç´¢å¼•ã€‚</li><li><strong>å…·ä½“åŸç†</strong>ï¼šèŒƒå›´æŸ¥è¯¢å¯¼è‡´ç´¢å¼•åç»­åˆ—æ— åºï¼Œæ— æ³•é€šè¿‡ B+ æ ‘å¿«é€Ÿå®šä½ã€‚</li><li><strong>ç¤ºä¾‹ SQL</strong>ï¼š</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ä»… a å’Œ b èµ°ç´¢å¼•ï¼Œc å¤±æ•ˆ</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> a<span class="operator">=</span><span class="number">1</span> <span class="keyword">AND</span> b<span class="operator">&gt;</span><span class="number">10</span> <span class="keyword">AND</span> c<span class="operator">=</span><span class="number">2</span>;</span><br></pre></td></tr></table></figure><hr><h3 id="11-ä¸¤åˆ—æ¯”è¾ƒæ“ä½œ"><a href="#11-ä¸¤åˆ—æ¯”è¾ƒæ“ä½œ" class="headerlink" title="11. ä¸¤åˆ—æ¯”è¾ƒæ“ä½œ"></a><strong>11. ä¸¤åˆ—æ¯”è¾ƒæ“ä½œ</strong></h3><ul><li><strong>æ­£å¸¸åˆ¤æ–­</strong>ï¼šå•åˆ—æ¡ä»¶ä½¿ç”¨ç´¢å¼•ã€‚</li><li><strong>å¤±æ•ˆåŸå› </strong>ï¼šç´¢å¼•ä¸æ”¯æŒåˆ—é—´æ¯”è¾ƒã€‚</li><li><strong>å…·ä½“åŸç†</strong>ï¼šç´¢å¼•å­˜å‚¨åˆ—å€¼ä¸è¡Œä½ç½®çš„æ˜ å°„ï¼Œæ— æ³•ç›´æ¥æ¯”è¾ƒä¸¤åˆ—å€¼ã€‚</li><li><strong>ç¤ºä¾‹ SQL</strong>ï¼š</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å¤±æ•ˆ</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> a <span class="operator">=</span> b;</span><br></pre></td></tr></table></figure><hr><h3 id="12-NOT-IN-æ¡ä»¶"><a href="#12-NOT-IN-æ¡ä»¶" class="headerlink" title="12. NOT IN æ¡ä»¶"></a><strong>12.</strong> <code>NOT IN</code> <strong>æ¡ä»¶</strong></h3><ul><li><strong>æ­£å¸¸åˆ¤æ–­</strong>ï¼šä¸»é”® <code>NOT IN</code> å¯èƒ½èµ°ç´¢å¼•ã€‚</li><li><strong>å¤±æ•ˆåŸå› </strong>ï¼šæ™®é€šç´¢å¼•éœ€å›è¡¨éªŒè¯ï¼Œä¼˜åŒ–å™¨è®¤ä¸ºå…¨è¡¨æ‰«ææ›´å¿«ã€‚</li><li><strong>å…·ä½“åŸç†</strong>ï¼šä¸»é”®ç´¢å¼•åŒ…å«å®Œæ•´æ•°æ®ï¼Œæ™®é€šç´¢å¼•éœ€å›è¡¨æ£€æŸ¥æ˜¯å¦æ»¡è¶³ <code>NOT IN</code>ã€‚</li><li><strong>ç¤ºä¾‹ SQL</strong>ï¼š</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å¤±æ•ˆï¼ˆæ™®é€šç´¢å¼•ï¼‰</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> a <span class="keyword">NOT</span> <span class="keyword">IN</span> (<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line"><span class="comment">-- æ­£å¸¸ï¼ˆä¸»é”®ï¼‰</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> id <span class="keyword">NOT</span> <span class="keyword">IN</span> (<span class="number">1</span>,<span class="number">2</span>);</span><br></pre></td></tr></table></figure><hr><h3 id="13-NOT-EXISTS-å­æŸ¥è¯¢"><a href="#13-NOT-EXISTS-å­æŸ¥è¯¢" class="headerlink" title="13. NOT EXISTS å­æŸ¥è¯¢"></a><strong>13.</strong> <code>NOT EXISTS</code> <strong>å­æŸ¥è¯¢</strong></h3><ul><li><strong>æ­£å¸¸åˆ¤æ–­</strong>ï¼š<code>EXISTS</code> å¯èƒ½èµ°ç´¢å¼•ï¼Œ<code>NOT EXISTS</code> é€šå¸¸å¤±æ•ˆã€‚</li><li><strong>å¤±æ•ˆåŸå› </strong>ï¼š<code>NOT EXISTS</code> éœ€é€è¡ŒéªŒè¯å­æŸ¥è¯¢ï¼Œæ— æ³•åˆ©ç”¨ç´¢å¼•ã€‚</li><li><strong>å…·ä½“åŸç†</strong>ï¼šå­æŸ¥è¯¢éœ€å…¨è¡¨æ‰«ææˆ–å…¨ç´¢å¼•æ‰«æï¼Œæˆæœ¬è¾ƒé«˜ã€‚</li><li><strong>ç¤ºä¾‹ SQL</strong>ï¼š</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å¤±æ•ˆ</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> t1 </span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> (<span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">FROM</span> <span class="keyword">table</span> t2 <span class="keyword">WHERE</span> t1.id <span class="operator">=</span> t2.id);</span><br></pre></td></tr></table></figure><hr>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Redis åº•å±‚æ•°æ®ç»“æ„</title>
      <link href="/2025/06/07/Redis%20%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
      <url>/2025/06/07/Redis%20%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/</url>
      
        <content type="html"><![CDATA[<h1 id="Redis-åº•å±‚æ•°æ®ç»“æ„"><a href="#Redis-åº•å±‚æ•°æ®ç»“æ„" class="headerlink" title="Redis åº•å±‚æ•°æ®ç»“æ„"></a>Redis åº•å±‚æ•°æ®ç»“æ„</h1><p>åŸæ–‡æ‹·è´ï¼š<a href="https://pdai.tech/md/db/nosql-redis/db-redis-x-redis-ds.html">https://pdai.tech/md/db/nosql-redis/db-redis-x-redis-ds.html</a></p><h2 id="1-åº•å±‚æ•°æ®ç»“æ„å¼•å…¥"><a href="#1-åº•å±‚æ•°æ®ç»“æ„å¼•å…¥" class="headerlink" title="1. åº•å±‚æ•°æ®ç»“æ„å¼•å…¥"></a>1. åº•å±‚æ•°æ®ç»“æ„å¼•å…¥</h2><p>åœ¨å¯¹å¯¹è±¡æœºåˆ¶ï¼ˆredisObjectï¼‰æœ‰äº†åˆæ­¥è®¤è¯†ä¹‹åï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥ç»§ç»­ç†è§£å¦‚ä¸‹çš„åº•å±‚æ•°æ®ç»“æ„éƒ¨åˆ†ï¼š</p><ul><li>ç®€å•åŠ¨æ€å­—ç¬¦ä¸² - sds</li><li>å‹ç¼©åˆ—è¡¨ - ZipList</li><li>å¿«è¡¨ - QuickList</li><li>å­—å…¸&#x2F;å“ˆå¸Œè¡¨ - Dict</li><li>æ•´æ•°é›† - IntSet</li><li>è·³è¡¨ - ZSkipList</li></ul><h2 id=""><a href="#" class="headerlink" title=""></a><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1683186163371-8b104d7d-6d48-48be-b36f-00239b94f2c6-20250605104506666.png" alt="img"></h2><h2 id="2-ç®€å•åŠ¨æ€å­—ç¬¦ä¸²-sds"><a href="#2-ç®€å•åŠ¨æ€å­—ç¬¦ä¸²-sds" class="headerlink" title="2. ç®€å•åŠ¨æ€å­—ç¬¦ä¸² - sds"></a>2. ç®€å•åŠ¨æ€å­—ç¬¦ä¸² - sds</h2><p>Redis æ˜¯ç”¨ C è¯­è¨€å†™çš„ï¼Œä½†æ˜¯å¯¹äºRedisçš„å­—ç¬¦ä¸²ï¼Œå´ä¸æ˜¯ C è¯­è¨€ä¸­çš„å­—ç¬¦ä¸²ï¼ˆå³ä»¥ç©ºå­—ç¬¦â€™\0â€™ç»“å°¾çš„å­—ç¬¦æ•°ç»„ï¼‰ï¼Œå®ƒæ˜¯è‡ªå·±æ„å»ºäº†ä¸€ç§åä¸º <strong>ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆsimple dynamic string,SDS</strong>ï¼‰çš„æŠ½è±¡ç±»å‹ï¼Œå¹¶å°† SDS ä½œä¸º Redisçš„é»˜è®¤å­—ç¬¦ä¸²è¡¨ç¤ºã€‚</p><h3 id="2-1-SDS-å®šä¹‰"><a href="#2-1-SDS-å®šä¹‰" class="headerlink" title="2.1. SDS å®šä¹‰"></a>2.1. SDS å®šä¹‰</h3><p>è¿™æ˜¯ä¸€ç§ç”¨äºå­˜å‚¨äºŒè¿›åˆ¶æ•°æ®çš„ä¸€ç§ç»“æ„, å…·æœ‰åŠ¨æ€æ‰©å®¹çš„ç‰¹ç‚¹. å…¶å®ç°ä½äºsrc&#x2F;sds.hä¸src&#x2F;sds.cä¸­ã€‚</p><ul><li><strong>SDSçš„æ€»ä½“æ¦‚è§ˆ</strong>å¦‚ä¸‹å›¾:</li></ul><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1683186200481-7f03df1c-74c9-40d7-98bb-dcd47b24fef0.png" alt="img"></p><p>å…¶ä¸­sdshdræ˜¯å¤´éƒ¨, bufæ˜¯çœŸå®å­˜å‚¨ç”¨æˆ·æ•°æ®çš„åœ°æ–¹. å¦å¤–æ³¨æ„, ä»å‘½åä¸Šèƒ½çœ‹å‡ºæ¥, è¿™ä¸ªæ•°æ®ç»“æ„é™¤äº†èƒ½å­˜å‚¨äºŒè¿›åˆ¶æ•°æ®, æ˜¾ç„¶æ˜¯ç”¨äºè®¾è®¡ä½œä¸ºå­—ç¬¦ä¸²ä½¿ç”¨çš„, æ‰€ä»¥åœ¨bufä¸­, ç”¨æˆ·æ•°æ®åæ€»è·Ÿç€ä¸€ä¸ª\0. å³å›¾ä¸­ â€œæ•°æ®â€ + â€œ\0â€ æ˜¯ä¸ºæ‰€è°“çš„bufã€‚</p><ul><li>å¦‚ä¸‹æ˜¯<strong>6.0æºç ä¸­sdsç›¸å…³çš„ç»“æ„</strong>ï¼š</li></ul><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1683186307934-1a2abbea-4cc0-4975-bbce-43e33ab4cfe6-20250605104457766.png" alt="img"></p><p>é€šè¿‡ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒSDSæœ‰äº”ç§ä¸åŒçš„å¤´éƒ¨. å…¶ä¸­sdshdr5å®é™…å¹¶æœªä½¿ç”¨åˆ°. æ‰€ä»¥å®é™…ä¸Šæœ‰å››ç§ä¸åŒçš„å¤´éƒ¨, åˆ†åˆ«å¦‚ä¸‹:</p><p>å…¶ä¸­ï¼š</p><ul><li><ul><li>len ä¿å­˜äº†SDSä¿å­˜å­—ç¬¦ä¸²çš„é•¿åº¦</li><li>buf[] æ•°ç»„ç”¨æ¥ä¿å­˜å­—ç¬¦ä¸²çš„æ¯ä¸ªå…ƒç´ </li><li>allocåˆ†åˆ«ä»¥uint8, uint16, uint32, uint64è¡¨ç¤ºæ•´ä¸ªSDS, é™¤è¿‡å¤´éƒ¨ä¸æœ«å°¾çš„\0, å‰©ä½™çš„å­—èŠ‚æ•°.</li><li>flags å§‹ç»ˆä¸ºä¸€å­—èŠ‚, ä»¥ä½ä¸‰ä½æ ‡ç¤ºç€å¤´éƒ¨çš„ç±»å‹, é«˜5ä½æœªä½¿ç”¨.</li></ul></li></ul><h3 id="2-2-ä¸ºä»€ä¹ˆä½¿ç”¨SDS"><a href="#2-2-ä¸ºä»€ä¹ˆä½¿ç”¨SDS" class="headerlink" title="2.2. ä¸ºä»€ä¹ˆä½¿ç”¨SDS"></a>2.2. ä¸ºä»€ä¹ˆä½¿ç”¨SDS</h3><p><strong>ä¸ºä»€ä¹ˆä¸ä½¿ç”¨Cè¯­è¨€å­—ç¬¦ä¸²å®ç°ï¼Œè€Œæ˜¯ä½¿ç”¨ SDSå‘¢</strong>ï¼Ÿè¿™æ ·å®ç°æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ</p><ul><li><strong>å¸¸æ•°å¤æ‚åº¦è·å–å­—ç¬¦ä¸²é•¿åº¦</strong></li></ul><p>ç”±äº len å±æ€§çš„å­˜åœ¨ï¼Œæˆ‘ä»¬è·å– SDS å­—ç¬¦ä¸²çš„é•¿åº¦åªéœ€è¦è¯»å– len å±æ€§ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1)ã€‚è€Œå¯¹äº C è¯­è¨€ï¼Œè·å–å­—ç¬¦ä¸²çš„é•¿åº¦é€šå¸¸æ˜¯ç»è¿‡éå†è®¡æ•°æ¥å®ç°çš„ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(n)ã€‚é€šè¿‡ strlen key å‘½ä»¤å¯ä»¥è·å– key çš„å­—ç¬¦ä¸²é•¿åº¦ã€‚</p><ul><li><strong>æœç»ç¼“å†²åŒºæº¢å‡º</strong></li></ul><p>æˆ‘ä»¬çŸ¥é“åœ¨ C è¯­è¨€ä¸­ä½¿ç”¨ strcat å‡½æ•°æ¥è¿›è¡Œä¸¤ä¸ªå­—ç¬¦ä¸²çš„æ‹¼æ¥ï¼Œä¸€æ—¦æ²¡æœ‰åˆ†é…è¶³å¤Ÿé•¿åº¦çš„å†…å­˜ç©ºé—´ï¼Œå°±ä¼šé€ æˆç¼“å†²åŒºæº¢å‡ºã€‚è€Œå¯¹äº SDS æ•°æ®ç±»å‹ï¼Œåœ¨è¿›è¡Œå­—ç¬¦ä¿®æ”¹çš„æ—¶å€™ï¼Œ<strong>ä¼šé¦–å…ˆæ ¹æ®è®°å½•çš„ len å±æ€§æ£€æŸ¥å†…å­˜ç©ºé—´æ˜¯å¦æ»¡è¶³éœ€æ±‚</strong>ï¼Œå¦‚æœä¸æ»¡è¶³ï¼Œä¼šè¿›è¡Œç›¸åº”çš„ç©ºé—´æ‰©å±•ï¼Œç„¶ååœ¨è¿›è¡Œä¿®æ”¹æ“ä½œï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°ç¼“å†²åŒºæº¢å‡ºã€‚</p><ul><li><strong>å‡å°‘ä¿®æ”¹å­—ç¬¦ä¸²çš„å†…å­˜é‡æ–°åˆ†é…æ¬¡æ•°</strong></li></ul><p>Cè¯­è¨€ç”±äºä¸è®°å½•å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œæ‰€ä»¥å¦‚æœè¦ä¿®æ”¹å­—ç¬¦ä¸²ï¼Œå¿…é¡»è¦é‡æ–°åˆ†é…å†…å­˜ï¼ˆå…ˆé‡Šæ”¾å†ç”³è¯·ï¼‰ï¼Œå› ä¸ºå¦‚æœæ²¡æœ‰é‡æ–°åˆ†é…ï¼Œå­—ç¬¦ä¸²é•¿åº¦å¢å¤§æ—¶ä¼šé€ æˆå†…å­˜ç¼“å†²åŒºæº¢å‡ºï¼Œå­—ç¬¦ä¸²é•¿åº¦å‡å°æ—¶ä¼šé€ æˆå†…å­˜æ³„éœ²ã€‚</p><p>è€Œå¯¹äºSDSï¼Œç”±äºlenå±æ€§å’Œallocå±æ€§çš„å­˜åœ¨ï¼Œå¯¹äºä¿®æ”¹å­—ç¬¦ä¸²SDSå®ç°äº†<strong>ç©ºé—´é¢„åˆ†é…</strong>å’Œ<strong>æƒ°æ€§ç©ºé—´é‡Šæ”¾</strong>ä¸¤ç§ç­–ç•¥ï¼š</p><p>1ã€ç©ºé—´é¢„åˆ†é…ï¼šå¯¹å­—ç¬¦ä¸²è¿›è¡Œç©ºé—´æ‰©å±•çš„æ—¶å€™ï¼Œæ‰©å±•çš„å†…å­˜æ¯”å®é™…éœ€è¦çš„å¤šï¼Œè¿™æ ·å¯ä»¥å‡å°‘è¿ç»­æ‰§è¡Œå­—ç¬¦ä¸²å¢é•¿æ“ä½œæ‰€éœ€çš„å†…å­˜é‡åˆ†é…æ¬¡æ•°ã€‚</p><p>2ã€æƒ°æ€§ç©ºé—´é‡Šæ”¾ï¼šå¯¹å­—ç¬¦ä¸²è¿›è¡Œç¼©çŸ­æ“ä½œæ—¶ï¼Œç¨‹åºä¸ç«‹å³ä½¿ç”¨å†…å­˜é‡æ–°åˆ†é…æ¥å›æ”¶ç¼©çŸ­åå¤šä½™çš„å­—èŠ‚ï¼Œè€Œæ˜¯ä½¿ç”¨ alloc å±æ€§å°†è¿™äº›å­—èŠ‚çš„æ•°é‡è®°å½•ä¸‹æ¥ï¼Œç­‰å¾…åç»­ä½¿ç”¨ã€‚ï¼ˆå½“ç„¶SDSä¹Ÿæä¾›äº†ç›¸åº”çš„APIï¼Œå½“æˆ‘ä»¬æœ‰éœ€è¦æ—¶ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨é‡Šæ”¾è¿™äº›æœªä½¿ç”¨çš„ç©ºé—´ã€‚ï¼‰</p><ul><li><strong>äºŒè¿›åˆ¶å®‰å…¨</strong></li></ul><p>å› ä¸ºCå­—ç¬¦ä¸²ä»¥ç©ºå­—ç¬¦ä½œä¸ºå­—ç¬¦ä¸²ç»“æŸçš„æ ‡è¯†ï¼Œè€Œå¯¹äºä¸€äº›äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆå¦‚å›¾ç‰‡ç­‰ï¼‰ï¼Œå†…å®¹å¯èƒ½åŒ…æ‹¬ç©ºå­—ç¬¦ä¸²ï¼Œå› æ­¤Cå­—ç¬¦ä¸²æ— æ³•æ­£ç¡®å­˜å–ï¼›è€Œæ‰€æœ‰ SDS çš„API éƒ½æ˜¯ä»¥å¤„ç†äºŒè¿›åˆ¶çš„æ–¹å¼æ¥å¤„ç† buf é‡Œé¢çš„å…ƒç´ ï¼Œå¹¶ä¸” SDS ä¸æ˜¯ä»¥ç©ºå­—ç¬¦ä¸²æ¥åˆ¤æ–­æ˜¯å¦ç»“æŸï¼Œè€Œæ˜¯ä»¥ len å±æ€§è¡¨ç¤ºçš„é•¿åº¦æ¥åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ç»“æŸã€‚</p><ul><li><strong>å…¼å®¹éƒ¨åˆ† C å­—ç¬¦ä¸²å‡½æ•°</strong></li></ul><p>è™½ç„¶ SDS æ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„ï¼Œä½†æ˜¯ä¸€æ ·éµä»æ¯ä¸ªå­—ç¬¦ä¸²éƒ½æ˜¯ä»¥ç©ºå­—ç¬¦ä¸²ç»“å°¾çš„æƒ¯ä¾‹ï¼Œè¿™æ ·å¯ä»¥é‡ç”¨ C è¯­è¨€åº“&lt;string.h&gt; ä¸­çš„ä¸€éƒ¨åˆ†å‡½æ•°ã€‚</p><h3 id="2-3-ç©ºé—´é¢„åˆ†é…è¡¥è¿›ä¸€æ­¥ç†è§£"><a href="#2-3-ç©ºé—´é¢„åˆ†é…è¡¥è¿›ä¸€æ­¥ç†è§£" class="headerlink" title="2.3. ç©ºé—´é¢„åˆ†é…è¡¥è¿›ä¸€æ­¥ç†è§£"></a>2.3. ç©ºé—´é¢„åˆ†é…è¡¥è¿›ä¸€æ­¥ç†è§£</h3><p>å½“æ‰§è¡Œè¿½åŠ æ“ä½œæ—¶ï¼Œæ¯”å¦‚ç°åœ¨ç»™key&#x3D;â€˜Hello Worldâ€™çš„å­—ç¬¦ä¸²åè¿½åŠ â€˜ again!â€™åˆ™è¿™æ—¶çš„len&#x3D;18ï¼Œfreeç”±0å˜æˆäº†18ï¼Œæ­¤æ—¶çš„buf&#x3D;â€™Hello World again!\0â€¦â€¦â€¦â€¦â€¦â€¦..â€™(.è¡¨ç¤ºç©ºæ ¼)ï¼Œä¹Ÿå°±æ˜¯bufçš„å†…å­˜ç©ºé—´æ˜¯18+18+1&#x3D;37ä¸ªå­—èŠ‚ï¼Œå…¶ä¸­â€˜\0â€™å 1ä¸ªå­—èŠ‚redisç»™å­—ç¬¦ä¸²å¤šåˆ†é…äº†18ä¸ªå­—èŠ‚çš„é¢„åˆ†é…ç©ºé—´ï¼Œæ‰€ä»¥ä¸‹æ¬¡è¿˜æœ‰appendè¿½åŠ çš„æ—¶å€™ï¼Œå¦‚æœé¢„åˆ†é…ç©ºé—´è¶³å¤Ÿï¼Œå°±æ— é¡»åœ¨è¿›è¡Œç©ºé—´åˆ†é…äº†ã€‚åœ¨å½“å‰ç‰ˆæœ¬ä¸­ï¼Œå½“æ–°å­—ç¬¦ä¸²çš„é•¿åº¦å°äº1Mæ—¶ï¼Œredisä¼šåˆ†é…ä»–ä»¬æ‰€éœ€å¤§å°ä¸€å€çš„ç©ºé—´ï¼Œå½“å¤§äº1Mçš„æ—¶å€™ï¼Œå°±ä¸ºä»–ä»¬é¢å¤–å¤šåˆ†é…1Mçš„ç©ºé—´ã€‚</p><p>æ€è€ƒï¼š<strong>è¿™ç§åˆ†é…ç­–ç•¥ä¼šæµªè´¹å†…å­˜èµ„æºå—</strong>ï¼Ÿ</p><p>ç­”ï¼šæ‰§è¡Œè¿‡APPEND å‘½ä»¤çš„å­—ç¬¦ä¸²ä¼šå¸¦æœ‰é¢å¤–çš„é¢„åˆ†é…ç©ºé—´ï¼Œè¿™äº›é¢„åˆ†é…ç©ºé—´ä¸ä¼šè¢«é‡Šæ”¾ï¼Œé™¤éè¯¥å­—ç¬¦ä¸²æ‰€å¯¹åº”çš„é”®è¢«åˆ é™¤ï¼Œæˆ–è€…ç­‰åˆ°å…³é—­Redis ä¹‹åï¼Œå†æ¬¡å¯åŠ¨æ—¶é‡æ–°è½½å…¥çš„å­—ç¬¦ä¸²å¯¹è±¡å°†ä¸ä¼šæœ‰é¢„åˆ†é…ç©ºé—´ã€‚å› ä¸ºæ‰§è¡ŒAPPEND å‘½ä»¤çš„å­—ç¬¦ä¸²é”®æ•°é‡é€šå¸¸å¹¶ä¸å¤šï¼Œå ç”¨å†…å­˜çš„ä½“ç§¯é€šå¸¸ä¹Ÿä¸å¤§ï¼Œæ‰€ä»¥è¿™ä¸€èˆ¬å¹¶ä¸ç®—ä»€ä¹ˆé—®é¢˜ã€‚å¦ä¸€æ–¹é¢ï¼Œå¦‚æœæ‰§è¡ŒAPPEND æ“ä½œçš„é”®å¾ˆå¤šï¼Œè€Œå­—ç¬¦ä¸²çš„ä½“ç§¯åˆå¾ˆå¤§çš„è¯ï¼Œé‚£å¯èƒ½å°±éœ€è¦ä¿®æ”¹Redis æœåŠ¡å™¨ï¼Œè®©å®ƒå®šæ—¶é‡Šæ”¾ä¸€äº›å­—ç¬¦ä¸²é”®çš„é¢„åˆ†é…ç©ºé—´ï¼Œä»è€Œæ›´æœ‰æ•ˆåœ°ä½¿ç”¨å†…å­˜ã€‚</p><h3 id="2-4-å°ç»“"><a href="#2-4-å°ç»“" class="headerlink" title="2.4. å°ç»“"></a>2.4. å°ç»“</h3><p>redisçš„å­—ç¬¦ä¸²è¡¨ç¤ºä¸ºsdsï¼Œè€Œä¸æ˜¯Cå­—ç¬¦ä¸²ï¼ˆä»¥\0ç»“å°¾çš„char*ï¼‰ï¼Œ å®ƒæ˜¯Redis åº•å±‚æ‰€ä½¿ç”¨çš„å­—ç¬¦ä¸²è¡¨ç¤ºï¼Œå®ƒè¢«ç”¨åœ¨å‡ ä¹æ‰€æœ‰çš„Redis æ¨¡å—ä¸­ã€‚å¯ä»¥çœ‹å¦‚ä¸‹å¯¹æ¯”ï¼š</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1683186398426-e49e97b8-1a09-4af9-b24e-69d9427e0a86-20250605104730696.png" alt="img"></p><p>ä¸€èˆ¬æ¥è¯´ï¼ŒSDS é™¤äº†ä¿å­˜æ•°æ®åº“ä¸­çš„å­—ç¬¦ä¸²å€¼ä»¥å¤–ï¼ŒSDS è¿˜å¯ä»¥ä½œä¸ºç¼“å†²åŒºï¼ˆbufferï¼‰ï¼šåŒ…æ‹¬ AOF æ¨¡å—ä¸­çš„AOFç¼“å†²åŒºä»¥åŠå®¢æˆ·ç«¯çŠ¶æ€ä¸­çš„è¾“å…¥ç¼“å†²åŒºã€‚</p><h2 id="3-å‹ç¼©åˆ—è¡¨-ZipList"><a href="#3-å‹ç¼©åˆ—è¡¨-ZipList" class="headerlink" title="3. å‹ç¼©åˆ—è¡¨ - ZipList"></a>3. å‹ç¼©åˆ—è¡¨ - ZipList</h2><p>ziplistæ˜¯ä¸ºäº†æé«˜å­˜å‚¨æ•ˆç‡è€Œè®¾è®¡çš„ä¸€ç§ç‰¹æ®Šç¼–ç çš„åŒå‘é“¾è¡¨ã€‚å®ƒå¯ä»¥å­˜å‚¨å­—ç¬¦ä¸²æˆ–è€…æ•´æ•°ï¼Œå­˜å‚¨æ•´æ•°æ—¶æ˜¯é‡‡ç”¨æ•´æ•°çš„äºŒè¿›åˆ¶è€Œä¸æ˜¯å­—ç¬¦ä¸²å½¢å¼å­˜å‚¨ã€‚å®ƒèƒ½åœ¨O(1)çš„æ—¶é—´å¤æ‚åº¦ä¸‹å®Œæˆlistä¸¤ç«¯çš„pushå’Œpopæ“ä½œã€‚ä½†æ˜¯å› ä¸ºæ¯æ¬¡æ“ä½œéƒ½éœ€è¦é‡æ–°åˆ†é…ziplistçš„å†…å­˜ï¼Œæ‰€ä»¥å®é™…å¤æ‚åº¦å’Œziplistçš„å†…å­˜ä½¿ç”¨é‡ç›¸å…³ã€‚</p><h3 id="3-1-ziplistç»“æ„"><a href="#3-1-ziplistç»“æ„" class="headerlink" title="3.1. ziplistç»“æ„"></a>3.1. ziplistç»“æ„</h3><p>å…ˆçœ‹ä¸‹6.0ä¸­å¯¹åº”çš„æºç å’Œä»‹ç»</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1683186463010-998f824b-0c42-4671-975c-e4ecd0303661.png" alt="img"></p><p>æ•´ä¸ªzipliståœ¨å†…å­˜ä¸­çš„å­˜å‚¨æ ¼å¼å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1683186477713-f4b4e9f1-70c0-41aa-af35-d8cdd8872970-20250605104738622.png" alt="img"></p><ul><li>zlbyteså­—æ®µçš„ç±»å‹æ˜¯uint32_t, è¿™ä¸ªå­—æ®µä¸­å­˜å‚¨çš„æ˜¯æ•´ä¸ªziplistæ‰€å ç”¨çš„å†…å­˜çš„å­—èŠ‚æ•°</li><li>zltailå­—æ®µçš„ç±»å‹æ˜¯uint32_t, å®ƒæŒ‡çš„æ˜¯ziplistä¸­æœ€åä¸€ä¸ªentryçš„åç§»é‡. ç”¨äºå¿«é€Ÿå®šä½æœ€åä¸€ä¸ªentry, ä»¥å¿«é€Ÿå®Œæˆpopç­‰æ“ä½œ</li><li>zllenå­—æ®µçš„ç±»å‹æ˜¯uint16_t, å®ƒæŒ‡çš„æ˜¯æ•´ä¸ªziplitä¸­entryçš„æ•°é‡. è¿™ä¸ªå€¼åªå 2bytesï¼ˆ16ä½ï¼‰: å¦‚æœziplistä¸­entryçš„æ•°ç›®å°äº65535(2çš„16æ¬¡æ–¹), é‚£ä¹ˆè¯¥å­—æ®µä¸­å­˜å‚¨çš„å°±æ˜¯å®é™…entryçš„å€¼. è‹¥ç­‰äºæˆ–è¶…è¿‡65535, é‚£ä¹ˆè¯¥å­—æ®µçš„å€¼å›ºå®šä¸º65535, ä½†å®é™…æ•°é‡éœ€è¦ä¸€ä¸ªä¸ªentryçš„å»éå†æ‰€æœ‰entryæ‰èƒ½å¾—åˆ°.</li><li>zlendæ˜¯ä¸€ä¸ªç»ˆæ­¢å­—èŠ‚, å…¶å€¼ä¸ºå…¨F, å³0xff. ziplistä¿è¯ä»»ä½•æƒ…å†µä¸‹, ä¸€ä¸ªentryçš„é¦–å­—èŠ‚éƒ½ä¸ä¼šæ˜¯255</li></ul><h3 id="3-2-Entryç»“æ„"><a href="#3-2-Entryç»“æ„" class="headerlink" title="3.2. Entryç»“æ„"></a>3.2. Entryç»“æ„</h3><p>é‚£ä¹ˆentryæ˜¯ä»€ä¹ˆç»“æ„å‘¢ï¼Ÿ</p><p><strong>å…ˆçœ‹ä¸‹æºç ä¸­ç›¸å…³ä»‹ç»</strong></p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1683186554347-d3b74eed-8e4b-42fd-9f2d-0cc62bd39af1-20250605104447715.png" alt="img"></p><p><strong>ç¬¬ä¸€ç§æƒ…å†µ</strong>ï¼šä¸€èˆ¬ç»“æ„ <prevlen> <encoding> <entry-data></p><p>prevlenï¼šå‰ä¸€ä¸ªentryçš„å¤§å°ï¼Œç¼–ç æ–¹å¼è§ä¸‹æ–‡ï¼›</p><p>encodingï¼šä¸åŒçš„æƒ…å†µä¸‹å€¼ä¸åŒï¼Œç”¨äºè¡¨ç¤ºå½“å‰entryçš„ç±»å‹å’Œé•¿åº¦ï¼›</p><p>entry-dataï¼šçœŸæ˜¯ç”¨äºå­˜å‚¨entryè¡¨ç¤ºçš„æ•°æ®ï¼›</p><p><strong>ç¬¬äºŒç§æƒ…å†µ</strong>ï¼šåœ¨entryä¸­å­˜å‚¨çš„æ˜¯intç±»å‹æ—¶ï¼Œencodingå’Œentry-dataä¼šåˆå¹¶åœ¨encodingä¸­è¡¨ç¤ºï¼Œæ­¤æ—¶æ²¡æœ‰entry-dataå­—æ®µï¼›</p><p>redisä¸­ï¼Œåœ¨å­˜å‚¨æ•°æ®æ—¶ï¼Œä¼šå…ˆå°è¯•å°†stringè½¬æ¢æˆintå­˜å‚¨ï¼ŒèŠ‚çœç©ºé—´ï¼›</p><p>æ­¤æ—¶entryç»“æ„ï¼š<prevlen> <encoding></p><ul><li><strong>prevlenç¼–ç </strong></li></ul><p>å½“å‰ä¸€ä¸ªå…ƒç´ é•¿åº¦å°äº254ï¼ˆ255ç”¨äºzlendï¼‰çš„æ—¶å€™ï¼Œprevlené•¿åº¦ä¸º1ä¸ªå­—èŠ‚ï¼Œå€¼å³ä¸ºå‰ä¸€ä¸ªentryçš„é•¿åº¦ï¼Œå¦‚æœé•¿åº¦å¤§äºç­‰äº254çš„æ—¶å€™ï¼Œprevlenç”¨5ä¸ªå­—èŠ‚è¡¨ç¤ºï¼Œç¬¬ä¸€å­—èŠ‚è®¾ç½®ä¸º254ï¼Œåé¢4ä¸ªå­—èŠ‚å­˜å‚¨ä¸€ä¸ªå°ç«¯çš„æ— ç¬¦å·æ•´å‹ï¼Œè¡¨ç¤ºå‰ä¸€ä¸ªentryçš„é•¿åº¦ï¼›</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;prevlen from 0 to 253&gt; &lt;encoding&gt; &lt;entry&gt;      //é•¿åº¦å°äº254ç»“æ„ 0xFE &lt;4 bytes unsigned little endian prevlen&gt; &lt;encoding&gt; &lt;entry&gt;   //é•¿åº¦å¤§äºç­‰äº254</span><br></pre></td></tr></table></figure><ul><li><strong>encodingç¼–ç </strong></li></ul><p>encodingçš„é•¿åº¦å’Œå€¼æ ¹æ®ä¿å­˜çš„æ˜¯intè¿˜æ˜¯stringï¼Œè¿˜æœ‰æ•°æ®çš„é•¿åº¦è€Œå®šï¼›</p><p>å‰ä¸¤ä½ç”¨æ¥è¡¨ç¤ºç±»å‹ï¼Œå½“ä¸ºâ€œ11â€æ—¶ï¼Œè¡¨ç¤ºentryå­˜å‚¨çš„æ˜¯intç±»å‹ï¼Œå…¶å®ƒè¡¨ç¤ºå­˜å‚¨çš„æ˜¯stringï¼›</p><p><strong>å­˜å‚¨stringæ—¶</strong>ï¼š</p><p>|00pppppp| ï¼šæ­¤æ—¶encodingé•¿åº¦ä¸º1ä¸ªå­—èŠ‚ï¼Œè¯¥å­—èŠ‚çš„åå…­ä½è¡¨ç¤ºentryä¸­å­˜å‚¨çš„stringé•¿åº¦ï¼Œå› ä¸ºæ˜¯6ä½ï¼Œæ‰€ä»¥entryä¸­å­˜å‚¨çš„stringé•¿åº¦ä¸èƒ½è¶…è¿‡63ï¼›</p><p>|01pppppp|qqqqqqqq| æ­¤æ—¶encodingé•¿åº¦ä¸ºä¸¤ä¸ªå­—èŠ‚ï¼›æ­¤æ—¶encodingçš„å14ä½ç”¨æ¥å­˜å‚¨stringé•¿åº¦ï¼Œé•¿åº¦ä¸èƒ½è¶…è¿‡16383ï¼›</p><p>|10000000|qqqqqqqq|rrrrrrrr|ssssssss|ttttttt| æ­¤æ—¶encodingé•¿åº¦ä¸º5ä¸ªå­—èŠ‚ï¼Œåé¢çš„4ä¸ªå­—èŠ‚ç”¨æ¥è¡¨ç¤ºencodingä¸­å­˜å‚¨çš„å­—ç¬¦ä¸²é•¿åº¦ï¼Œé•¿åº¦ä¸èƒ½è¶…è¿‡2^32 - 1;</p><p><strong>å­˜å‚¨intæ—¶</strong>ï¼š</p><p>|11000000| encodingä¸º3ä¸ªå­—èŠ‚ï¼Œå2ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªint16ï¼›</p><p>|11010000| encodingä¸º5ä¸ªå­—èŠ‚ï¼Œå4ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªint32;</p><p>|11100000| encoding ä¸º9ä¸ªå­—èŠ‚ï¼Œå8å­—èŠ‚è¡¨ç¤ºä¸€ä¸ªint64;</p><p>|11110000| encodingä¸º4ä¸ªå­—èŠ‚ï¼Œå3ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªæœ‰ç¬¦å·æ•´å‹ï¼›</p><p>|11111110| encodingä¸º2å­—èŠ‚ï¼Œå1ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªæœ‰ç¬¦å·æ•´å‹ï¼›</p><p>|1111xxxx| encodingé•¿åº¦å°±åªæœ‰1ä¸ªå­—èŠ‚ï¼Œxxxxè¡¨ç¤ºä¸€ä¸ª0 - 12çš„æ•´æ•°å€¼ï¼›</p><p>|11111111| è¿˜è®°å¾—zlendä¹ˆï¼Ÿ</p><ul><li><strong>æºç ä¸­æ•°æ®ç»“æ„æ”¯æ’‘</strong></li></ul><p>ä½ å¯ä»¥çœ‹åˆ°ä¸ºäº†æ“ä½œä¸Šçš„ç®€æ˜“å®é™…è¿˜å¢åŠ äº†å‡ ä¸ªå±æ€§</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/* We use this function to receive information about a ziplist entry. * Note that this is not how the data is actually encoded, is just what we * get filled by a function in order to operate more easily. */ typedef struct zlentry &#123;    unsigned int prevrawlensize; /* Bytes used to encode the previous entry len*/    unsigned int prevrawlen;     /* Previous entry len. */    unsigned int lensize;        /* Bytes used to encode this entry type/len.                                    For example strings have a 1, 2 or 5 bytes                                    header. Integers always use a single byte.*/    unsigned int len;            /* Bytes used to represent the actual entry.                                    For strings this is just the string length                                    while for integers it is 1, 2, 3, 4, 8 or                                    0 (for 4 bit immediate) depending on the                                    number range. */    unsigned int headersize;     /* prevrawlensize + lensize. */    unsigned char encoding;      /* Set to ZIP_STR_* or ZIP_INT_* depending on                                    the entry encoding. However for 4 bits                                    immediate integers this can assume a range                                    of values and must be range-checked. */    unsigned char *p;            /* Pointer to the very start of the entry, that                                    is, this points to prev-entry-len field. */ &#125; zlentry;</span><br></pre></td></tr></table></figure><ul><li><ul><li>prevrawlensizeè¡¨ç¤º previous_entry_lengthå­—æ®µçš„é•¿åº¦</li><li>prevrawlenè¡¨ç¤º previous_entry_lengthå­—æ®µå­˜å‚¨çš„å†…å®¹</li><li>lensizeè¡¨ç¤º encodingå­—æ®µçš„é•¿åº¦</li><li>lenè¡¨ç¤ºæ•°æ®å†…å®¹é•¿åº¦</li><li>headersize è¡¨ç¤ºå½“å‰å…ƒç´ çš„é¦–éƒ¨é•¿åº¦ï¼Œå³previous_entry_lengthå­—æ®µé•¿åº¦ä¸encodingå­—æ®µé•¿åº¦ä¹‹å’Œ</li><li>encodingè¡¨ç¤ºæ•°æ®ç±»å‹</li><li>pè¡¨ç¤ºå½“å‰å…ƒç´ é¦–åœ°å€</li></ul></li></ul><h3 id="3-3-ä¸ºä»€ä¹ˆZipListç‰¹åˆ«çœå†…å­˜"><a href="#3-3-ä¸ºä»€ä¹ˆZipListç‰¹åˆ«çœå†…å­˜" class="headerlink" title="3.3. ä¸ºä»€ä¹ˆZipListç‰¹åˆ«çœå†…å­˜"></a>3.3. ä¸ºä»€ä¹ˆZipListç‰¹åˆ«çœå†…å­˜</h3><p>æ‰€ä»¥åªæœ‰ç†è§£ä¸Šé¢çš„Entryç»“æ„ï¼Œæˆ‘ä»¬æ‰ä¼šçœŸæ­£ç†è§£ZipListä¸ºä»€ä¹ˆæ˜¯ç‰¹åˆ«èŠ‚çœå†…å­˜çš„æ•°æ®ç»“æ„ã€‚</p><ul><li>ziplistèŠ‚çœå†…å­˜æ˜¯ç›¸å¯¹äºæ™®é€šçš„listæ¥è¯´çš„ï¼Œå¦‚æœæ˜¯æ™®é€šçš„æ•°ç»„ï¼Œé‚£ä¹ˆå®ƒæ¯ä¸ªå…ƒç´ å ç”¨çš„å†…å­˜æ˜¯ä¸€æ ·çš„ä¸”å–å†³äºæœ€å¤§çš„é‚£ä¸ªå…ƒç´ ï¼ˆå¾ˆæ˜æ˜¾å®ƒæ˜¯éœ€è¦é¢„ç•™ç©ºé—´çš„ï¼‰ï¼›</li><li>æ‰€ä»¥zipliståœ¨è®¾è®¡æ—¶å°±å¾ˆå®¹æ˜“æƒ³åˆ°è¦å°½é‡è®©æ¯ä¸ªå…ƒç´ æŒ‰ç…§å®é™…çš„å†…å®¹å¤§å°å­˜å‚¨ï¼Œ<strong>æ‰€ä»¥å¢åŠ encodingå­—æ®µ</strong>ï¼Œé’ˆå¯¹ä¸åŒçš„encodingæ¥ç»†åŒ–å­˜å‚¨å¤§å°ï¼›</li><li>è¿™æ—¶å€™è¿˜éœ€è¦è§£å†³çš„ä¸€ä¸ªé—®é¢˜æ˜¯éå†å…ƒç´ æ—¶å¦‚ä½•å®šä½ä¸‹ä¸€ä¸ªå…ƒç´ å‘¢ï¼Ÿåœ¨æ™®é€šæ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ å®šé•¿ï¼Œæ‰€ä»¥ä¸éœ€è¦è€ƒè™‘è¿™ä¸ªé—®é¢˜ï¼›ä½†æ˜¯ziplistä¸­æ¯ä¸ªdataå æ®çš„å†…å­˜ä¸ä¸€æ ·ï¼Œæ‰€ä»¥ä¸ºäº†è§£å†³éå†ï¼Œéœ€è¦å¢åŠ è®°å½•ä¸Šä¸€ä¸ªå…ƒç´ çš„lengthï¼Œ<strong>æ‰€ä»¥å¢åŠ äº†prelenå­—æ®µ</strong>ã€‚</li></ul><p><strong>ä¸ºä»€ä¹ˆæˆ‘ä»¬å»ç ”ç©¶ziplistç‰¹åˆ«èŠ‚çœå†…å­˜çš„æ•°æ®ç»“æ„</strong>ï¼Ÿ åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¤§é‡å­˜å‚¨å­—ç¬¦ä¸²çš„ä¼˜åŒ–æ˜¯éœ€è¦ä½ å¯¹åº•å±‚çš„æ•°æ®ç»“æ„æœ‰ä¸€å®šçš„ç†è§£çš„ï¼Œè€Œzipliståœ¨åœºæ™¯ä¼˜åŒ–çš„æ—¶å€™ä¹Ÿè¢«è€ƒè™‘é‡‡ç”¨çš„é¦–é€‰ã€‚</p><h3 id="3-4-ziplistçš„ç¼ºç‚¹"><a href="#3-4-ziplistçš„ç¼ºç‚¹" class="headerlink" title="3.4. ziplistçš„ç¼ºç‚¹"></a>3.4. ziplistçš„ç¼ºç‚¹</h3><p>æœ€åæˆ‘ä»¬å†çœ‹çœ‹å®ƒçš„ä¸€äº›ç¼ºç‚¹ï¼š</p><ul><li>ziplistä¹Ÿä¸é¢„ç•™å†…å­˜ç©ºé—´, å¹¶ä¸”åœ¨ç§»é™¤ç»“ç‚¹å, ä¹Ÿæ˜¯ç«‹å³ç¼©å®¹, è¿™ä»£è¡¨æ¯æ¬¡å†™æ“ä½œéƒ½ä¼šè¿›è¡Œå†…å­˜åˆ†é…æ“ä½œ.</li><li>ç»“ç‚¹å¦‚æœæ‰©å®¹, å¯¼è‡´ç»“ç‚¹å ç”¨çš„å†…å­˜å¢é•¿, å¹¶ä¸”è¶…è¿‡254å­—èŠ‚çš„è¯, å¯èƒ½ä¼šå¯¼è‡´é“¾å¼ååº”: å…¶åä¸€ä¸ªç»“ç‚¹çš„entry.prevlenéœ€è¦ä»ä¸€å­—èŠ‚æ‰©å®¹è‡³äº”å­—èŠ‚. <strong>æœ€åæƒ…å†µä¸‹, ç¬¬ä¸€ä¸ªç»“ç‚¹çš„æ‰©å®¹, ä¼šå¯¼è‡´æ•´ä¸ªziplistè¡¨ä¸­çš„åç»­æ‰€æœ‰ç»“ç‚¹çš„entry.prevlenå­—æ®µæ‰©å®¹</strong>. è™½ç„¶è¿™ä¸ªå†…å­˜é‡åˆ†é…çš„æ“ä½œä¾ç„¶åªä¼šå‘ç”Ÿä¸€æ¬¡, ä½†ä»£ç ä¸­çš„æ—¶é—´å¤æ‚åº¦æ˜¯o(N)çº§åˆ«, å› ä¸ºé“¾å¼æ‰©å®¹åªèƒ½ä¸€æ­¥ä¸€æ­¥çš„è®¡ç®—. ä½†è¿™ç§æƒ…å†µçš„æ¦‚ç‡ååˆ†çš„å°, ä¸€èˆ¬æƒ…å†µä¸‹é“¾å¼æ‰©å®¹èƒ½è¿é”åæ˜ äº”å…­æ¬¡å°±å¾ˆä¸å¹¸äº†. ä¹‹æ‰€ä»¥è¯´è¿™æ˜¯ä¸€ä¸ªè›‹ç–¼é—®é¢˜, æ˜¯å› ä¸º, è¿™æ ·çš„ååœºæ™¯ä¸‹, å…¶å®æ—¶é—´å¤æ‚åº¦å¹¶ä¸é«˜: ä¾æ¬¡è®¡ç®—æ¯ä¸ªentryæ–°çš„ç©ºé—´å ç”¨, ä¹Ÿå°±æ˜¯o(N), æ€»ä½“å ç”¨è®¡ç®—å‡ºæ¥å, åªæ‰§è¡Œä¸€æ¬¡å†…å­˜é‡åˆ†é…, ä¸å¯¹åº”çš„memmoveæ“ä½œ, å°±å¯ä»¥äº†.</li></ul><h2 id="4-å¿«è¡¨-QuickList"><a href="#4-å¿«è¡¨-QuickList" class="headerlink" title="4. å¿«è¡¨ - QuickList"></a>4. å¿«è¡¨ - QuickList</h2><p>quicklistè¿™ä¸ªç»“æ„æ˜¯Redisåœ¨3.2ç‰ˆæœ¬åæ–°åŠ çš„, ä¹‹å‰çš„ç‰ˆæœ¬æ˜¯list(å³linkedlist)ï¼Œ ç”¨äºStringæ•°æ®ç±»å‹ä¸­ã€‚</p><p>å®ƒæ˜¯ä¸€ç§ä»¥ziplistä¸ºç»“ç‚¹çš„åŒç«¯é“¾è¡¨ç»“æ„. å®è§‚ä¸Š, quicklistæ˜¯ä¸€ä¸ªé“¾è¡¨, å¾®è§‚ä¸Š, é“¾è¡¨ä¸­çš„æ¯ä¸ªç»“ç‚¹éƒ½æ˜¯ä¸€ä¸ªziplistã€‚</p><h3 id="4-1-quicklistç»“æ„"><a href="#4-1-quicklistç»“æ„" class="headerlink" title="4.1. quicklistç»“æ„"></a>4.1. quicklistç»“æ„</h3><ul><li>å¦‚ä¸‹æ˜¯<strong>6.0æºç ä¸­quicklistç›¸å…³çš„ç»“æ„</strong>ï¼š</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Node, quicklist, and Iterator are the only data structures used currently. */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* quicklistNode is a 32 byte struct describing a ziplist for a quicklist.</span></span><br><span class="line"><span class="comment"> * We use bit fields keep the quicklistNode at 32 bytes.</span></span><br><span class="line"><span class="comment"> * count: 16 bits, max 65536 (max zl bytes is 65k, so max count actually &lt; 32k).</span></span><br><span class="line"><span class="comment"> * encoding: 2 bits, RAW=1, LZF=2.</span></span><br><span class="line"><span class="comment"> * container: 2 bits, NONE=1, ZIPLIST=2.</span></span><br><span class="line"><span class="comment"> * recompress: 1 bit, bool, true if node is temporarry decompressed for usage.</span></span><br><span class="line"><span class="comment"> * attempted_compress: 1 bit, boolean, used for verifying during testing.</span></span><br><span class="line"><span class="comment"> * extra: 10 bits, free for future use; pads out the remainder of 32 bits */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">quicklistNode</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">quicklistNode</span> *<span class="title">prev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">quicklistNode</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *zl;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> sz;             <span class="comment">/* ziplist size in bytes */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> count : <span class="number">16</span>;     <span class="comment">/* count of items in ziplist */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> encoding : <span class="number">2</span>;   <span class="comment">/* RAW==1 or LZF==2 */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> container : <span class="number">2</span>;  <span class="comment">/* NONE==1 or ZIPLIST==2 */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> recompress : <span class="number">1</span>; <span class="comment">/* was this node previous compressed? */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> attempted_compress : <span class="number">1</span>; <span class="comment">/* node can&#x27;t compress; too small */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> extra : <span class="number">10</span>; <span class="comment">/* more bits to steal for future usage */</span></span><br><span class="line">&#125; quicklistNode;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* quicklistLZF is a 4+N byte struct holding &#x27;sz&#x27; followed by &#x27;compressed&#x27;.</span></span><br><span class="line"><span class="comment"> * &#x27;sz&#x27; is byte length of &#x27;compressed&#x27; field.</span></span><br><span class="line"><span class="comment"> * &#x27;compressed&#x27; is LZF data with total (compressed) length &#x27;sz&#x27;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">NOTE:</span> uncompressed length is stored in quicklistNode-&gt;sz.</span></span><br><span class="line"><span class="comment"> * When quicklistNode-&gt;zl is compressed, node-&gt;zl points to a quicklistLZF */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">quicklistLZF</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> sz; <span class="comment">/* LZF size in bytes*/</span></span><br><span class="line">    <span class="type">char</span> compressed[];</span><br><span class="line">&#125; quicklistLZF;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Bookmarks are padded with realloc at the end of of the quicklist struct.</span></span><br><span class="line"><span class="comment"> * They should only be used for very big lists if thousands of nodes were the</span></span><br><span class="line"><span class="comment"> * excess memory usage is negligible, and there&#x27;s a real need to iterate on them</span></span><br><span class="line"><span class="comment"> * in portions.</span></span><br><span class="line"><span class="comment"> * When not used, they don&#x27;t add any memory overhead, but when used and then</span></span><br><span class="line"><span class="comment"> * deleted, some overhead remains (to avoid resonance).</span></span><br><span class="line"><span class="comment"> * The number of bookmarks used should be kept to minimum since it also adds</span></span><br><span class="line"><span class="comment"> * overhead on node deletion (searching for a bookmark to update). */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">quicklistBookmark</span> &#123;</span></span><br><span class="line">    quicklistNode *node;</span><br><span class="line">    <span class="type">char</span> *name;</span><br><span class="line">&#125; quicklistBookmark;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* quicklist is a 40 byte struct (on 64-bit systems) describing a quicklist.</span></span><br><span class="line"><span class="comment"> * &#x27;count&#x27; is the number of total entries.</span></span><br><span class="line"><span class="comment"> * &#x27;len&#x27; is the number of quicklist nodes.</span></span><br><span class="line"><span class="comment"> * &#x27;compress&#x27; is: -1 if compression disabled, otherwise it&#x27;s the number</span></span><br><span class="line"><span class="comment"> *                of quicklistNodes to leave uncompressed at ends of quicklist.</span></span><br><span class="line"><span class="comment"> * &#x27;fill&#x27; is the user-requested (or default) fill factor.</span></span><br><span class="line"><span class="comment"> * &#x27;bookmakrs are an optional feature that is used by realloc this struct,</span></span><br><span class="line"><span class="comment"> *      so that they don&#x27;t consume memory when not used. */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">quicklist</span> &#123;</span></span><br><span class="line">    quicklistNode *head;</span><br><span class="line">    quicklistNode *tail;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> count;        <span class="comment">/* total count of all entries in all ziplists */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> len;          <span class="comment">/* number of quicklistNodes */</span></span><br><span class="line">    <span class="type">int</span> fill : QL_FILL_BITS;              <span class="comment">/* fill factor for individual nodes */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> compress : QL_COMP_BITS; <span class="comment">/* depth of end nodes not to compress;0=off */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> bookmark_count: QL_BM_BITS;</span><br><span class="line">    quicklistBookmark bookmarks[];</span><br><span class="line">&#125; quicklist;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">quicklistIter</span> &#123;</span></span><br><span class="line">    <span class="type">const</span> quicklist *quicklist;</span><br><span class="line">    quicklistNode *current;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *zi;</span><br><span class="line">    <span class="type">long</span> offset; <span class="comment">/* offset in current ziplist */</span></span><br><span class="line">    <span class="type">int</span> direction;</span><br><span class="line">&#125; quicklistIter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">quicklistEntry</span> &#123;</span></span><br><span class="line">    <span class="type">const</span> quicklist *quicklist;</span><br><span class="line">    quicklistNode *node;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *zi;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *value;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> longval;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> sz;</span><br><span class="line">    <span class="type">int</span> offset;</span><br><span class="line">&#125; quicklistEntry;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå®šä¹‰äº†6ä¸ªç»“æ„ä½“:</p><ul><li>quicklistNode, å®è§‚ä¸Š, quicklistæ˜¯ä¸€ä¸ªé“¾è¡¨, è¿™ä¸ªç»“æ„æè¿°çš„å°±æ˜¯é“¾è¡¨ä¸­çš„ç»“ç‚¹. å®ƒé€šè¿‡zlå­—æ®µæŒæœ‰åº•å±‚çš„ziplist. ç®€å•æ¥è®², å®ƒæè¿°äº†ä¸€ä¸ªziplistå®ä¾‹</li><li>quicklistLZF, ziplistæ˜¯ä¸€æ®µè¿ç»­çš„å†…å­˜, ç”¨LZ4ç®—æ³•å‹ç¼©å, å°±å¯ä»¥åŒ…è£…æˆä¸€ä¸ªquicklistLZFç»“æ„. æ˜¯å¦å‹ç¼©quicklistä¸­çš„æ¯ä¸ªziplistå®ä¾‹æ˜¯ä¸€ä¸ªå¯é…ç½®é¡¹. è‹¥è¿™ä¸ªé…ç½®é¡¹æ˜¯å¼€å¯çš„, é‚£ä¹ˆquicklistNode.zlå­—æ®µæŒ‡å‘çš„å°±ä¸æ˜¯ä¸€ä¸ªziplistå®ä¾‹, è€Œæ˜¯ä¸€ä¸ªå‹ç¼©åçš„quicklistLZFå®ä¾‹</li><li>quicklistBookmark, åœ¨quicklistå°¾éƒ¨å¢åŠ çš„ä¸€ä¸ªä¹¦ç­¾ï¼Œå®ƒåªæœ‰åœ¨å¤§é‡èŠ‚ç‚¹çš„å¤šä½™å†…å­˜ä½¿ç”¨é‡å¯ä»¥å¿½ç•¥ä¸è®¡çš„æƒ…å†µä¸”ç¡®å®éœ€è¦åˆ†æ‰¹è¿­ä»£å®ƒä»¬ï¼Œæ‰ä¼šè¢«ä½¿ç”¨ã€‚å½“ä¸ä½¿ç”¨å®ƒä»¬æ—¶ï¼Œå®ƒä»¬ä¸ä¼šå¢åŠ ä»»ä½•å†…å­˜å¼€é”€ã€‚</li><li>quicklist. è¿™å°±æ˜¯ä¸€ä¸ªåŒé“¾è¡¨çš„å®šä¹‰. head, tailåˆ†åˆ«æŒ‡å‘å¤´å°¾æŒ‡é’ˆ. lenä»£è¡¨é“¾è¡¨ä¸­çš„ç»“ç‚¹. countæŒ‡çš„æ˜¯æ•´ä¸ªquicklistä¸­çš„æ‰€æœ‰ziplistä¸­çš„entryçš„æ•°ç›®. fillå­—æ®µå½±å“ç€æ¯ä¸ªé“¾è¡¨ç»“ç‚¹ä¸­ziplistçš„æœ€å¤§å ç”¨ç©ºé—´, compresså½±å“ç€æ˜¯å¦è¦å¯¹æ¯ä¸ªziplistä»¥LZ4ç®—æ³•è¿›è¡Œè¿›ä¸€æ­¥å‹ç¼©ä»¥æ›´èŠ‚çœå†…å­˜ç©ºé—´.</li><li>quicklistIteræ˜¯ä¸€ä¸ªè¿­ä»£å™¨</li><li>quicklistEntryæ˜¯å¯¹ziplistä¸­çš„entryæ¦‚å¿µçš„å°è£…. quicklistä½œä¸ºä¸€ä¸ªå°è£…è‰¯å¥½çš„æ•°æ®ç»“æ„, ä¸å¸Œæœ›ä½¿ç”¨è€…æ„ŸçŸ¥åˆ°å…¶å†…éƒ¨çš„å®ç°, æ‰€ä»¥éœ€è¦æŠŠziplist.entryçš„æ¦‚å¿µé‡æ–°åŒ…è£…ä¸€ä¸‹.</li></ul><h3 id="4-2-quicklistå†…å­˜å¸ƒå±€å›¾"><a href="#4-2-quicklistå†…å­˜å¸ƒå±€å›¾" class="headerlink" title="4.2. quicklistå†…å­˜å¸ƒå±€å›¾"></a>4.2. quicklistå†…å­˜å¸ƒå±€å›¾</h3><p>quicklistçš„å†…å­˜å¸ƒå±€å›¾å¦‚ä¸‹æ‰€ç¤º:</p><h3 id="4-3-quicklistæ›´å¤šé¢å¤–ä¿¡æ¯"><a href="#4-3-quicklistæ›´å¤šé¢å¤–ä¿¡æ¯" class="headerlink" title="4.3. quicklistæ›´å¤šé¢å¤–ä¿¡æ¯"></a>4.3. quicklistæ›´å¤šé¢å¤–ä¿¡æ¯</h3><p>ä¸‹é¢æ˜¯æœ‰å…³quicklistçš„æ›´å¤šé¢å¤–ä¿¡æ¯:</p><ul><li>quicklist.fillçš„å€¼å½±å“ç€æ¯ä¸ªé“¾è¡¨ç»“ç‚¹ä¸­, ziplistçš„é•¿åº¦.</li></ul><ol><li><ol><li>å½“æ•°å€¼ä¸ºè´Ÿæ•°æ—¶, ä»£è¡¨ä»¥å­—èŠ‚æ•°é™åˆ¶å•ä¸ªziplistçš„æœ€å¤§é•¿åº¦. å…·ä½“ä¸º:</li><li>-1 ä¸è¶…è¿‡4kb</li><li>-2 ä¸è¶…è¿‡ 8kb</li><li>-3 ä¸è¶…è¿‡ 16kb</li><li>-4 ä¸è¶…è¿‡ 32kb</li><li>-5 ä¸è¶…è¿‡ 64kb</li><li>å½“æ•°å€¼ä¸ºæ­£æ•°æ—¶, ä»£è¡¨ä»¥entryæ•°ç›®é™åˆ¶å•ä¸ªziplistçš„é•¿åº¦. å€¼å³ä¸ºæ•°ç›®. ç”±äºè¯¥å­—æ®µä»…å 16ä½, æ‰€ä»¥ä»¥entryæ•°ç›®é™åˆ¶ziplistçš„å®¹é‡æ—¶, æœ€å¤§å€¼ä¸º2^15ä¸ª</li></ol></li></ol><ul><li>quicklist.compressçš„å€¼å½±å“ç€quicklistNode.zlå­—æ®µæŒ‡å‘çš„æ˜¯åŸç”Ÿçš„ziplist, è¿˜æ˜¯ç»è¿‡å‹ç¼©åŒ…è£…åçš„quicklistLZF</li></ul><ol><li><ol><li>0 è¡¨ç¤ºä¸å‹ç¼©, zlå­—æ®µç›´æ¥æŒ‡å‘ziplist</li><li>1 è¡¨ç¤ºquicklistçš„é“¾è¡¨å¤´å°¾ç»“ç‚¹ä¸å‹ç¼©, å…¶ä½™ç»“ç‚¹çš„zlå­—æ®µæŒ‡å‘çš„æ˜¯ç»è¿‡å‹ç¼©åçš„quicklistLZF</li><li>2 è¡¨ç¤ºquicklistçš„é“¾è¡¨å¤´ä¸¤ä¸ª, ä¸æœ«ä¸¤ä¸ªç»“ç‚¹ä¸å‹ç¼©, å…¶ä½™ç»“ç‚¹çš„zlå­—æ®µæŒ‡å‘çš„æ˜¯ç»è¿‡å‹ç¼©åçš„quicklistLZF</li><li>ä»¥æ­¤ç±»æ¨, æœ€å¤§å€¼ä¸º2^16</li></ol></li></ol><ul><li>quicklistNode.encodingå­—æ®µ, ä»¥æŒ‡ç¤ºæœ¬é“¾è¡¨ç»“ç‚¹æ‰€æŒæœ‰çš„ziplistæ˜¯å¦ç»è¿‡äº†å‹ç¼©. 1ä»£è¡¨æœªå‹ç¼©, æŒæœ‰çš„æ˜¯åŸç”Ÿçš„ziplist, 2ä»£è¡¨å‹ç¼©è¿‡</li><li>quicklistNode.containerå­—æ®µæŒ‡ç¤ºçš„æ˜¯æ¯ä¸ªé“¾è¡¨ç»“ç‚¹æ‰€æŒæœ‰çš„æ•°æ®ç±»å‹æ˜¯ä»€ä¹ˆ. é»˜è®¤çš„å®ç°æ˜¯ziplist, å¯¹åº”çš„è¯¥å­—æ®µçš„å€¼æ˜¯2, ç›®å‰Redisæ²¡æœ‰æä¾›å…¶å®ƒå®ç°. æ‰€ä»¥å®é™…ä¸Š, è¯¥å­—æ®µçš„å€¼æ’ä¸º2</li><li>quicklistNode.recompresså­—æ®µæŒ‡ç¤ºçš„æ˜¯å½“å‰ç»“ç‚¹æ‰€æŒæœ‰çš„ziplistæ˜¯å¦ç»è¿‡äº†è§£å‹. å¦‚æœè¯¥å­—æ®µä¸º1å³ä»£è¡¨ä¹‹å‰è¢«è§£å‹è¿‡, ä¸”éœ€è¦åœ¨ä¸‹ä¸€æ¬¡æ“ä½œæ—¶é‡æ–°å‹ç¼©.</li></ul><p>quicklistçš„å…·ä½“å®ç°ä»£ç ç¯‡å¹…å¾ˆé•¿, è¿™é‡Œå°±ä¸è´´ä»£ç ç‰‡æ–­äº†, ä»å†…å­˜å¸ƒå±€ä¸Šä¹Ÿèƒ½çœ‹å‡ºæ¥, ç”±äºæ¯ä¸ªç»“ç‚¹æŒæœ‰çš„ziplistæ˜¯æœ‰ä¸Šé™é•¿åº¦çš„, æ‰€ä»¥åœ¨ä¸æ“ä½œæ—¶è¦è€ƒè™‘çš„åˆ†æ”¯æƒ…å†µæ¯”è¾ƒå¤šã€‚</p><p>quicklistæœ‰è‡ªå·±çš„ä¼˜ç‚¹, ä¹Ÿæœ‰ç¼ºç‚¹, å¯¹äºä½¿ç”¨è€…æ¥è¯´, å…¶ä½¿ç”¨ä½“éªŒç±»ä¼¼äºçº¿æ€§æ•°æ®ç»“æ„, listä½œä¸ºæœ€ä¼ ç»Ÿçš„åŒé“¾è¡¨, ç»“ç‚¹é€šè¿‡æŒ‡é’ˆæŒæœ‰æ•°æ®, æŒ‡é’ˆå­—æ®µä¼šè€—è´¹å¤§é‡å†…å­˜. ziplistè§£å†³äº†è€—è´¹å†…å­˜è¿™ä¸ªé—®é¢˜. ä½†å¼•å…¥äº†æ–°çš„é—®é¢˜: æ¯æ¬¡å†™æ“ä½œæ•´ä¸ªziplistçš„å†…å­˜éƒ½éœ€è¦é‡åˆ†é…. quickliståœ¨ä¸¤è€…ä¹‹é—´åšäº†ä¸€ä¸ªå¹³è¡¡. å¹¶ä¸”ä½¿ç”¨è€…å¯ä»¥é€šè¿‡è‡ªå®šä¹‰quicklist.fill, æ ¹æ®å®é™…ä¸šåŠ¡æƒ…å†µ, ç»éªŒä¸»ä¹‰è°ƒå‚.</p><h2 id="5-å­—å…¸-å“ˆå¸Œè¡¨-Dict"><a href="#5-å­—å…¸-å“ˆå¸Œè¡¨-Dict" class="headerlink" title="5. å­—å…¸&#x2F;å“ˆå¸Œè¡¨ - Dict"></a>5. å­—å…¸&#x2F;å“ˆå¸Œè¡¨ - Dict</h2><p>æœ¬è´¨ä¸Šå°±æ˜¯å“ˆå¸Œè¡¨, è¿™ä¸ªåœ¨å¾ˆå¤šè¯­è¨€ä¸­éƒ½æœ‰ï¼Œå¯¹äºå¼€å‘äººå‘˜äººå‘˜æ¥è¯´æ¯”è¾ƒç†Ÿæ‚‰ï¼Œè¿™é‡Œå°±ç®€å•ä»‹ç»ä¸‹ã€‚</p><h3 id="5-1-æ•°æ®ç»“æ„"><a href="#5-1-æ•°æ®ç»“æ„" class="headerlink" title="5.1. æ•°æ®ç»“æ„"></a>5.1. æ•°æ®ç»“æ„</h3><p><strong>å“ˆå¸Œè¡¨ç»“æ„å®šä¹‰</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictht</span>&#123;</span></span><br><span class="line">    <span class="comment">//å“ˆå¸Œè¡¨æ•°ç»„</span></span><br><span class="line">    dictEntry **table;</span><br><span class="line">    <span class="comment">//å“ˆå¸Œè¡¨å¤§å°</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> size;</span><br><span class="line">    <span class="comment">//å“ˆå¸Œè¡¨å¤§å°æ©ç ï¼Œç”¨äºè®¡ç®—ç´¢å¼•å€¼</span></span><br><span class="line">    <span class="comment">//æ€»æ˜¯ç­‰äº size-1</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> sizemask;</span><br><span class="line">    <span class="comment">//è¯¥å“ˆå¸Œè¡¨å·²æœ‰èŠ‚ç‚¹çš„æ•°é‡</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> used;</span><br><span class="line"> </span><br><span class="line">&#125;dictht</span><br></pre></td></tr></table></figure><p>å“ˆå¸Œè¡¨æ˜¯ç”±æ•°ç»„ table ç»„æˆï¼Œtable ä¸­æ¯ä¸ªå…ƒç´ éƒ½æ˜¯æŒ‡å‘ dict.h&#x2F;dictEntry ç»“æ„ï¼ŒdictEntry ç»“æ„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span>&#123;</span></span><br><span class="line">     <span class="comment">//é”®</span></span><br><span class="line">     <span class="type">void</span> *key;</span><br><span class="line">     <span class="comment">//å€¼</span></span><br><span class="line">     <span class="class"><span class="keyword">union</span>&#123;</span></span><br><span class="line">          <span class="type">void</span> *val;</span><br><span class="line">          uint64_tu64;</span><br><span class="line">          int64_ts64;</span><br><span class="line">     &#125;v;</span><br><span class="line"> </span><br><span class="line">     <span class="comment">//æŒ‡å‘ä¸‹ä¸€ä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹ï¼Œå½¢æˆé“¾è¡¨</span></span><br><span class="line">     <span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125;dictEntry</span><br></pre></td></tr></table></figure><p>key ç”¨æ¥ä¿å­˜é”®ï¼Œval å±æ€§ç”¨æ¥ä¿å­˜å€¼ï¼Œå€¼å¯ä»¥æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œä¹Ÿå¯ä»¥æ˜¯uint64_tæ•´æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯int64_tæ•´æ•°ã€‚</p><p>æ³¨æ„è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªæŒ‡å‘ä¸‹ä¸€ä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œæˆ‘ä»¬çŸ¥é“å“ˆå¸Œè¡¨æœ€å¤§çš„é—®é¢˜æ˜¯å­˜åœ¨å“ˆå¸Œå†²çªï¼Œå¦‚ä½•è§£å†³å“ˆå¸Œå†²çªï¼Œæœ‰å¼€æ”¾åœ°å€æ³•å’Œé“¾åœ°å€æ³•ã€‚è¿™é‡Œé‡‡ç”¨çš„ä¾¿æ˜¯é“¾åœ°å€æ³•ï¼Œé€šè¿‡nextè¿™ä¸ªæŒ‡é’ˆå¯ä»¥å°†å¤šä¸ªå“ˆå¸Œå€¼ç›¸åŒçš„é”®å€¼å¯¹è¿æ¥åœ¨ä¸€èµ·ï¼Œç”¨æ¥<strong>è§£å†³å“ˆå¸Œå†²çª</strong>ã€‚</p><h3 id="5-2-ä¸€äº›è¦ç‚¹"><a href="#5-2-ä¸€äº›è¦ç‚¹" class="headerlink" title="5.2. ä¸€äº›è¦ç‚¹"></a>5.2. ä¸€äº›è¦ç‚¹</h3><ul><li><strong>å“ˆå¸Œç®—æ³•</strong>ï¼šRedisè®¡ç®—å“ˆå¸Œå€¼å’Œç´¢å¼•å€¼æ–¹æ³•å¦‚ä¸‹ï¼š</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1ã€ä½¿ç”¨å­—å…¸è®¾ç½®çš„å“ˆå¸Œå‡½æ•°ï¼Œè®¡ç®—é”® key çš„å“ˆå¸Œå€¼</span></span><br><span class="line"><span class="built_in">hash</span> = dict-&gt;<span class="built_in">type</span>-&gt;hashFunction(key);</span><br><span class="line"></span><br><span class="line"><span class="comment">#2ã€ä½¿ç”¨å“ˆå¸Œè¡¨çš„sizemaskå±æ€§å’Œç¬¬ä¸€æ­¥å¾—åˆ°çš„å“ˆå¸Œå€¼ï¼Œè®¡ç®—ç´¢å¼•å€¼</span></span><br><span class="line">index = <span class="built_in">hash</span> &amp; dict-&gt;ht[x].sizemask;</span><br></pre></td></tr></table></figure><ul><li><strong>è§£å†³å“ˆå¸Œå†²çª</strong>ï¼šè¿™ä¸ªé—®é¢˜ä¸Šé¢æˆ‘ä»¬ä»‹ç»äº†ï¼Œæ–¹æ³•æ˜¯é“¾åœ°å€æ³•ã€‚é€šè¿‡å­—å…¸é‡Œé¢çš„ *next æŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€ä¸ªå…·æœ‰ç›¸åŒç´¢å¼•å€¼çš„å“ˆå¸Œè¡¨èŠ‚ç‚¹ã€‚</li><li><strong>æ‰©å®¹å’Œæ”¶ç¼©</strong>ï¼šå½“å“ˆå¸Œè¡¨ä¿å­˜çš„é”®å€¼å¯¹å¤ªå¤šæˆ–è€…å¤ªå°‘æ—¶ï¼Œå°±è¦é€šè¿‡ rerehash(é‡æ–°æ•£åˆ—ï¼‰æ¥å¯¹å“ˆå¸Œè¡¨è¿›è¡Œç›¸åº”çš„æ‰©å±•æˆ–è€…æ”¶ç¼©ã€‚å…·ä½“æ­¥éª¤ï¼š</li></ul><p>1ã€å¦‚æœæ‰§è¡Œæ‰©å±•æ“ä½œï¼Œä¼šåŸºäºåŸå“ˆå¸Œè¡¨åˆ›å»ºä¸€ä¸ªå¤§å°ç­‰äº ht[0].used*2n çš„å“ˆå¸Œè¡¨ï¼ˆä¹Ÿå°±æ˜¯æ¯æ¬¡æ‰©å±•éƒ½æ˜¯æ ¹æ®åŸå“ˆå¸Œè¡¨å·²ä½¿ç”¨çš„ç©ºé—´æ‰©å¤§ä¸€å€åˆ›å»ºå¦ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼‰ã€‚ç›¸åå¦‚æœæ‰§è¡Œçš„æ˜¯æ”¶ç¼©æ“ä½œï¼Œæ¯æ¬¡æ”¶ç¼©æ˜¯æ ¹æ®å·²ä½¿ç”¨ç©ºé—´ç¼©å°ä¸€å€åˆ›å»ºä¸€ä¸ªæ–°çš„å“ˆå¸Œè¡¨ã€‚</p><p>2ã€é‡æ–°åˆ©ç”¨ä¸Šé¢çš„å“ˆå¸Œç®—æ³•ï¼Œè®¡ç®—ç´¢å¼•å€¼ï¼Œç„¶åå°†é”®å€¼å¯¹æ”¾åˆ°æ–°çš„å“ˆå¸Œè¡¨ä½ç½®ä¸Šã€‚</p><p>3ã€æ‰€æœ‰é”®å€¼å¯¹éƒ½è¿å¾™å®Œæ¯•åï¼Œé‡Šæ”¾åŸå“ˆå¸Œè¡¨çš„å†…å­˜ç©ºé—´ã€‚</p><ul><li><strong>è§¦å‘æ‰©å®¹çš„æ¡ä»¶</strong>ï¼š</li></ul><p>1ã€æœåŠ¡å™¨ç›®å‰æ²¡æœ‰æ‰§è¡Œ BGSAVE å‘½ä»¤æˆ–è€… BGREWRITEAOF å‘½ä»¤ï¼Œå¹¶ä¸”è´Ÿè½½å› å­å¤§äºç­‰äº1ã€‚</p><p>2ã€æœåŠ¡å™¨ç›®å‰æ­£åœ¨æ‰§è¡Œ BGSAVE å‘½ä»¤æˆ–è€… BGREWRITEAOF å‘½ä»¤ï¼Œå¹¶ä¸”è´Ÿè½½å› å­å¤§äºç­‰äº5ã€‚</p><p>psï¼šè´Ÿè½½å› å­ &#x3D; å“ˆå¸Œè¡¨å·²ä¿å­˜èŠ‚ç‚¹æ•°é‡ &#x2F; å“ˆå¸Œè¡¨å¤§å°ã€‚</p><ul><li><strong>æ¸è¿‘å¼ rehash</strong></li></ul><p>ä»€ä¹ˆå«æ¸è¿›å¼ rehashï¼Ÿä¹Ÿå°±æ˜¯è¯´æ‰©å®¹å’Œæ”¶ç¼©æ“ä½œä¸æ˜¯ä¸€æ¬¡æ€§ã€é›†ä¸­å¼å®Œæˆçš„ï¼Œè€Œæ˜¯åˆ†å¤šæ¬¡ã€æ¸è¿›å¼å®Œæˆçš„ã€‚å¦‚æœä¿å­˜åœ¨Redisä¸­çš„é”®å€¼å¯¹åªæœ‰å‡ ä¸ªå‡ åä¸ªï¼Œé‚£ä¹ˆ rehash æ“ä½œå¯ä»¥ç¬é—´å®Œæˆï¼Œä½†æ˜¯å¦‚æœé”®å€¼å¯¹æœ‰å‡ ç™¾ä¸‡ï¼Œå‡ åƒä¸‡ç”šè‡³å‡ äº¿ï¼Œé‚£ä¹ˆè¦ä¸€æ¬¡æ€§çš„è¿›è¡Œ rehashï¼ŒåŠ¿å¿…ä¼šé€ æˆRedisä¸€æ®µæ—¶é—´å†…ä¸èƒ½è¿›è¡Œåˆ«çš„æ“ä½œã€‚æ‰€ä»¥Redisé‡‡ç”¨æ¸è¿›å¼ rehash,è¿™æ ·åœ¨è¿›è¡Œæ¸è¿›å¼rehashæœŸé—´ï¼Œå­—å…¸çš„åˆ é™¤æŸ¥æ‰¾æ›´æ–°ç­‰æ“ä½œå¯èƒ½ä¼šåœ¨ä¸¤ä¸ªå“ˆå¸Œè¡¨ä¸Šè¿›è¡Œï¼Œç¬¬ä¸€ä¸ªå“ˆå¸Œè¡¨æ²¡æœ‰æ‰¾åˆ°ï¼Œå°±ä¼šå»ç¬¬äºŒä¸ªå“ˆå¸Œè¡¨ä¸Šè¿›è¡ŒæŸ¥æ‰¾ã€‚ä½†æ˜¯è¿›è¡Œ å¢åŠ æ“ä½œï¼Œä¸€å®šæ˜¯åœ¨æ–°çš„å“ˆå¸Œè¡¨ä¸Šè¿›è¡Œçš„ã€‚</p><h2 id="6-æ•´æ•°é›†-IntSet"><a href="#6-æ•´æ•°é›†-IntSet" class="headerlink" title="6. æ•´æ•°é›† - IntSet"></a>6. æ•´æ•°é›† - IntSet</h2><p>æ•´æ•°é›†åˆï¼ˆintsetï¼‰æ˜¯é›†åˆç±»å‹çš„åº•å±‚å®ç°ä¹‹ä¸€ï¼Œå½“ä¸€ä¸ªé›†åˆåªåŒ…å«æ•´æ•°å€¼å…ƒç´ ï¼Œå¹¶ä¸”è¿™ä¸ªé›†åˆçš„å…ƒç´ æ•°é‡ä¸å¤šæ—¶ï¼ŒRedis å°±ä¼šä½¿ç”¨æ•´æ•°é›†åˆä½œä¸ºé›†åˆé”®çš„åº•å±‚å®ç°ã€‚</p><h3 id="6-1-intsetç»“æ„"><a href="#6-1-intsetç»“æ„" class="headerlink" title="6.1. intsetç»“æ„"></a>6.1. intsetç»“æ„</h3><p>é¦–å…ˆçœ‹æºç ç»“æ„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">intset</span> &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> encoding;</span><br><span class="line">    <span class="type">uint32_t</span> length;</span><br><span class="line">    <span class="type">int8_t</span> contents[];</span><br><span class="line">&#125; intset;</span><br></pre></td></tr></table></figure><p>encoding è¡¨ç¤ºç¼–ç æ–¹å¼ï¼Œçš„å–å€¼æœ‰ä¸‰ä¸ªï¼šINTSET_ENC_INT16, INTSET_ENC_INT32, INTSET_ENC_INT64</p><p>length ä»£è¡¨å…¶ä¸­å­˜å‚¨çš„æ•´æ•°çš„ä¸ªæ•°</p><p>contents æŒ‡å‘å®é™…å­˜å‚¨æ•°å€¼çš„è¿ç»­å†…å­˜åŒºåŸŸ, å°±æ˜¯ä¸€ä¸ªæ•°ç»„ï¼›æ•´æ•°é›†åˆçš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ contents æ•°ç»„çš„ä¸€ä¸ªæ•°ç»„é¡¹ï¼ˆitemï¼‰ï¼Œå„ä¸ªé¡¹åœ¨æ•°ç»„ä¸­æŒ‰å€¼å¾—å¤§å°<strong>ä»å°åˆ°å¤§æœ‰åºæ’åº</strong>ï¼Œä¸”æ•°ç»„ä¸­ä¸åŒ…å«ä»»ä½•é‡å¤é¡¹ã€‚ï¼ˆè™½ç„¶ intset ç»“æ„å°† contents å±æ€§å£°æ˜ä¸º int8_t ç±»å‹çš„æ•°ç»„ï¼Œä½†å®é™…ä¸Š contents æ•°ç»„å¹¶ä¸ä¿å­˜ä»»ä½• int8_t ç±»å‹çš„å€¼ï¼Œcontents æ•°ç»„çš„çœŸæ­£ç±»å‹å–å†³äº encoding å±æ€§çš„å€¼ï¼‰</p><h3 id="6-2-å†…å­˜å¸ƒå±€å›¾"><a href="#6-2-å†…å­˜å¸ƒå±€å›¾" class="headerlink" title="6.2. å†…å­˜å¸ƒå±€å›¾"></a>6.2. å†…å­˜å¸ƒå±€å›¾</h3><p>å…¶å†…å­˜å¸ƒå±€å¦‚ä¸‹å›¾æ‰€ç¤º</p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œcontentæ•°ç»„é‡Œé¢æ¯ä¸ªå…ƒç´ çš„æ•°æ®ç±»å‹æ˜¯ç”±encodingæ¥å†³å®šçš„ï¼Œé‚£ä¹ˆå¦‚æœåŸæ¥çš„æ•°æ®ç±»å‹æ˜¯int16, å½“æˆ‘ä»¬å†æ’å…¥ä¸€ä¸ªint32ç±»å‹çš„æ•°æ®æ—¶æ€ä¹ˆåŠå‘¢ï¼Ÿè¿™å°±æ˜¯ä¸‹é¢è¦è¯´çš„intsetçš„å‡çº§ã€‚</p><h3 id="6-3-æ•´æ•°é›†åˆçš„å‡çº§"><a href="#6-3-æ•´æ•°é›†åˆçš„å‡çº§" class="headerlink" title="6.3. æ•´æ•°é›†åˆçš„å‡çº§"></a>6.3. æ•´æ•°é›†åˆçš„å‡çº§</h3><p>å½“åœ¨ä¸€ä¸ªint16ç±»å‹çš„æ•´æ•°é›†åˆä¸­æ’å…¥ä¸€ä¸ªint32ç±»å‹çš„å€¼ï¼Œæ•´ä¸ªé›†åˆçš„æ‰€æœ‰å…ƒç´ éƒ½ä¼šè½¬æ¢æˆ32ç±»å‹ã€‚ æ•´ä¸ªè¿‡ç¨‹æœ‰ä¸‰æ­¥ï¼š</p><ul><li>æ ¹æ®æ–°å…ƒç´ çš„ç±»å‹ï¼ˆæ¯”å¦‚int32ï¼‰ï¼Œæ‰©å±•æ•´æ•°é›†åˆåº•å±‚æ•°ç»„çš„ç©ºé—´å¤§å°ï¼Œå¹¶ä¸ºæ–°å…ƒç´ åˆ†é…ç©ºé—´ã€‚</li><li>å°†åº•å±‚æ•°ç»„ç°æœ‰çš„æ‰€æœ‰å…ƒç´ éƒ½è½¬æ¢æˆä¸æ–°å…ƒç´ ç›¸åŒçš„ç±»å‹ï¼Œ å¹¶å°†ç±»å‹è½¬æ¢åçš„å…ƒç´ æ”¾ç½®åˆ°æ­£ç¡®çš„ä½ä¸Šï¼Œ è€Œä¸”åœ¨æ”¾ç½®å…ƒç´ çš„è¿‡ç¨‹ä¸­ï¼Œ éœ€è¦ç»§ç»­ç»´æŒåº•å±‚æ•°ç»„çš„æœ‰åºæ€§è´¨ä¸å˜ã€‚</li><li>æœ€åæ”¹å˜encodingçš„å€¼ï¼Œlength+1ã€‚</li></ul><p><strong>é‚£ä¹ˆå¦‚æœæˆ‘ä»¬åˆ é™¤æ‰åˆšåŠ å…¥çš„int32ç±»å‹æ—¶ï¼Œä¼šä¸ä¼šåšä¸€ä¸ªé™çº§æ“ä½œå‘¢</strong>ï¼Ÿ</p><p>ä¸ä¼šã€‚ä¸»è¦è¿˜æ˜¯å‡å°‘å¼€é”€çš„æƒè¡¡ã€‚</p><h2 id="7-è·³è¡¨-ZSkipList"><a href="#7-è·³è¡¨-ZSkipList" class="headerlink" title="7. è·³è¡¨ - ZSkipList"></a>7. è·³è¡¨ - ZSkipList</h2><p><a href="https://zhuanlan.zhihu.com/p/576984787">redis zskiplistè·³è¡¨ï¼Œæ€§èƒ½å ªæ¯”çº¢é»‘æ ‘ï¼Ÿï¼ˆæ·±åº¦åˆ†æï¼‰</a></p><p>è·³è·ƒè¡¨ç»“æ„åœ¨ Redis ä¸­çš„è¿ç”¨åœºæ™¯åªæœ‰ä¸€ä¸ªï¼Œé‚£å°±æ˜¯ä½œä¸ºæœ‰åºåˆ—è¡¨ (Zset) çš„ä½¿ç”¨ã€‚è·³è·ƒè¡¨çš„æ€§èƒ½å¯ä»¥ä¿è¯åœ¨æŸ¥æ‰¾ï¼Œåˆ é™¤ï¼Œæ·»åŠ ç­‰æ“ä½œçš„æ—¶å€™åœ¨å¯¹æ•°æœŸæœ›æ—¶é—´å†…å®Œæˆï¼Œè¿™ä¸ªæ€§èƒ½æ˜¯å¯ä»¥å’Œå¹³è¡¡æ ‘æ¥ç›¸æ¯”è¾ƒçš„ï¼Œè€Œä¸”åœ¨å®ç°æ–¹é¢æ¯”å¹³è¡¡æ ‘è¦ä¼˜é›…ï¼Œè¿™å°±æ˜¯è·³è·ƒè¡¨çš„é•¿å¤„ã€‚è·³è·ƒè¡¨çš„ç¼ºç‚¹å°±æ˜¯éœ€è¦çš„å­˜å‚¨ç©ºé—´æ¯”è¾ƒå¤§ï¼Œå±äºåˆ©ç”¨ç©ºé—´æ¥æ¢å–æ—¶é—´çš„æ•°æ®ç»“æ„ã€‚</p><h3 id="7-1-ä»€ä¹ˆæ˜¯è·³è·ƒè¡¨"><a href="#7-1-ä»€ä¹ˆæ˜¯è·³è·ƒè¡¨" class="headerlink" title="7.1. ä»€ä¹ˆæ˜¯è·³è·ƒè¡¨"></a>7.1. ä»€ä¹ˆæ˜¯è·³è·ƒè¡¨</h3><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1683188767947-029a8488-19ac-4266-b882-ac1f83760bf7-20250605104436000.png" alt="img"></p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1683188755238-44e4cadc-ee00-4cb5-80c8-0b8dc991022f.webp" alt="img"></p><p>è·³è·ƒè¡¨è¦è§£å†³ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿå¦‚æœä½ ä¸€ä¸Šæ¥å°±å»çœ‹å®ƒçš„å®ç°ï¼Œä½ å¾ˆéš¾ç†è§£è®¾è®¡çš„æœ¬è´¨ï¼Œæ‰€ä»¥å…ˆè¦çœ‹å®ƒçš„è®¾è®¡è¦è§£å†³ä»€ä¹ˆé—®é¢˜ã€‚</p><p>å¯¹äºäºä¸€ä¸ªå•é“¾è¡¨æ¥è®²ï¼Œå³ä¾¿é“¾è¡¨ä¸­å­˜å‚¨çš„æ•°æ®æ˜¯æœ‰åºçš„ï¼Œå¦‚æœæˆ‘ä»¬è¦æƒ³åœ¨å…¶ä¸­æŸ¥æ‰¾æŸä¸ªæ•°æ®ï¼Œä¹Ÿåªèƒ½ä»å¤´åˆ°å°¾éå†é“¾è¡¨ã€‚è¿™æ ·æŸ¥æ‰¾æ•ˆç‡å°±ä¼šå¾ˆä½ï¼Œæ—¶é—´å¤æ‚åº¦ä¼šå¾ˆé«˜ï¼Œæ˜¯ O(n)ã€‚æ¯”å¦‚æŸ¥æ‰¾12ï¼Œéœ€è¦7æ¬¡æŸ¥æ‰¾</p><p>å¦‚æœæˆ‘ä»¬å¢åŠ å¦‚ä¸‹ä¸¤çº§ç´¢å¼•ï¼Œé‚£ä¹ˆå®ƒæœç´¢æ¬¡æ•°å°±å˜æˆäº†3æ¬¡</p><h3 id="7-2-Redisè·³è·ƒè¡¨çš„è®¾è®¡"><a href="#7-2-Redisè·³è·ƒè¡¨çš„è®¾è®¡" class="headerlink" title="7.2. Redisè·³è·ƒè¡¨çš„è®¾è®¡"></a>7.2. Redisè·³è·ƒè¡¨çš„è®¾è®¡</h3><p>redisè·³è·ƒè¡¨å¹¶æ²¡æœ‰åœ¨å•ç‹¬çš„ç±»ï¼ˆæ¯”å¦‚skplist.c)ä¸­å®šä¹‰ï¼Œè€Œæ˜¯å…¶å®šä¹‰åœ¨server.hä¸­, å¦‚ä¸‹:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ZSETs use a specialized version of Skiplists */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> &#123;</span></span><br><span class="line">    sds ele;</span><br><span class="line">    <span class="type">double</span> score;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">backward</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistLevel</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">forward</span>;</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> span;</span><br><span class="line">    &#125; level[];</span><br><span class="line">&#125; zskiplistNode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zskiplist</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">header</span>, *<span class="title">tail</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> length;</span><br><span class="line">    <span class="type">int</span> level;</span><br><span class="line">&#125; zskiplist;</span><br></pre></td></tr></table></figure><p>å…¶å†…å­˜å¸ƒå±€å¦‚ä¸‹å›¾:</p><p><strong>zskiplistçš„æ ¸å¿ƒè®¾è®¡è¦ç‚¹</strong></p><ul><li><p><strong>å¤´èŠ‚ç‚¹</strong>ä¸æŒæœ‰ä»»ä½•æ•°æ®, ä¸”å…¶level[]çš„é•¿åº¦ä¸º32</p></li><li><p><strong>æ¯ä¸ªç»“ç‚¹</strong></p></li><li><ul><li>eleå­—æ®µï¼ŒæŒæœ‰æ•°æ®ï¼Œæ˜¯sdsç±»å‹</li><li>scoreå­—æ®µ, å…¶æ ‡ç¤ºç€ç»“ç‚¹çš„å¾—åˆ†, ç»“ç‚¹ä¹‹é—´å‡­å€Ÿå¾—åˆ†æ¥åˆ¤æ–­å…ˆåé¡ºåº, è·³è·ƒè¡¨ä¸­çš„ç»“ç‚¹æŒ‰ç»“ç‚¹çš„å¾—åˆ†å‡åºæ’åˆ—.</li><li>backwardæŒ‡é’ˆ, è¿™æ˜¯åŸç‰ˆè·³è·ƒè¡¨ä¸­æ‰€æ²¡æœ‰çš„. è¯¥æŒ‡é’ˆæŒ‡å‘ç»“ç‚¹çš„å‰ä¸€ä¸ªç´§é‚»ç»“ç‚¹.</li><li>levelå­—æ®µ, ç”¨ä»¥è®°å½•æ‰€æœ‰ç»“ç‚¹(é™¤è¿‡å¤´èŠ‚ç‚¹å¤–)ï¼›æ¯ä¸ªç»“ç‚¹ä¸­æœ€å¤šæŒæœ‰32ä¸ªzskiplistLevelç»“æ„. å®é™…æ•°é‡åœ¨ç»“ç‚¹åˆ›å»ºæ—¶, æŒ‰å¹‚æ¬¡å®šå¾‹éšæœºç”Ÿæˆ(ä¸è¶…è¿‡32). æ¯ä¸ªzskiplistLevelä¸­æœ‰ä¸¤ä¸ªå­—æ®µ</li></ul></li><li><ul><li><ul><li>forwardå­—æ®µæŒ‡å‘æ¯”è‡ªå·±å¾—åˆ†é«˜çš„æŸä¸ªç»“ç‚¹(ä¸ä¸€å®šæ˜¯ç´§é‚»çš„), å¹¶ä¸”, è‹¥å½“å‰zskiplistLevelå®ä¾‹åœ¨level[]ä¸­çš„ç´¢å¼•ä¸ºX, åˆ™å…¶forwardå­—æ®µæŒ‡å‘çš„ç»“ç‚¹, å…¶level[]å­—æ®µçš„å®¹é‡è‡³å°‘æ˜¯X+1. è¿™ä¹Ÿæ˜¯ä¸Šå›¾ä¸­, ä¸ºä»€ä¹ˆforwardæŒ‡é’ˆæ€»æ˜¯ç”»çš„æ°´å¹³çš„åŸå› .</li><li>spanå­—æ®µä»£è¡¨forwardå­—æ®µæŒ‡å‘çš„ç»“ç‚¹, è·ç¦»å½“å‰ç»“ç‚¹çš„è·ç¦». ç´§é‚»çš„ä¸¤ä¸ªç»“ç‚¹ä¹‹é—´çš„è·ç¦»å®šä¹‰ä¸º1.</li></ul></li></ul></li></ul><h3 id="7-3-ä¸ºä»€ä¹ˆä¸ç”¨å¹³è¡¡æ ‘æˆ–è€…å“ˆå¸Œè¡¨"><a href="#7-3-ä¸ºä»€ä¹ˆä¸ç”¨å¹³è¡¡æ ‘æˆ–è€…å“ˆå¸Œè¡¨" class="headerlink" title="7.3. ä¸ºä»€ä¹ˆä¸ç”¨å¹³è¡¡æ ‘æˆ–è€…å“ˆå¸Œè¡¨"></a>7.3. ä¸ºä»€ä¹ˆä¸ç”¨å¹³è¡¡æ ‘æˆ–è€…å“ˆå¸Œè¡¨</h3><ul><li><strong>ä¸ºä»€ä¹ˆä¸æ˜¯å¹³è¡¡æ ‘ï¼Œå…ˆçœ‹ä¸‹ä½œè€…çš„å›ç­”</strong></li></ul><p>There are a few reasons:</p><p>They are not very memory intensive. Itâ€™s up to you basically. Changing parameters about the probability of a node to have a given number of levels will make then less memory intensive than btrees.</p><p>A sorted set is often target of many ZRANGE or ZREVRANGE operations, that is, traversing the skip list as a linked list. With this operation the cache locality of skip lists is at least as good as with other kind of balanced trees.</p><p>They are simpler to implement, debug, and so forth. For instance thanks to the skip list simplicity I received a patch (already in Redis master) with augmented skip lists implementing ZRANK in O(log(N)). It required little changes to the code.</p><p>About the Append Only durability &amp; speed, I donâ€™t think it is a good idea to optimize Redis at cost of more code and more complexity for a use case that IMHO should be rare for the Redis target (fsync() at every command). Almost no one is using this feature even with ACID SQL databases, as the performance hint is big anyway.</p><p>About threads: our experience shows that Redis is mostly I&#x2F;O bound. Iâ€™m using threads to serve things from Virtual Memory. The long term solution to exploit all the cores, assuming your link is so fast that you can saturate a single core, is running multiple instances of Redis (no locks, almost fully scalable linearly with number of cores), and using the â€œRedis Clusterâ€ solution that I plan to develop in the future.</p><p>ç®€è€Œè¨€ä¹‹å°±æ˜¯å®ç°ç®€å•ä¸”è¾¾åˆ°äº†ç±»ä¼¼æ•ˆæœã€‚</p><ul><li><strong>skiplistä¸å¹³è¡¡æ ‘ã€å“ˆå¸Œè¡¨çš„æ¯”è¾ƒ</strong></li></ul><p>skiplistå’Œå„ç§å¹³è¡¡æ ‘ï¼ˆå¦‚AVLã€çº¢é»‘æ ‘ç­‰ï¼‰çš„å…ƒç´ æ˜¯æœ‰åºæ’åˆ—çš„ï¼Œè€Œå“ˆå¸Œè¡¨ä¸æ˜¯æœ‰åºçš„ã€‚å› æ­¤ï¼Œåœ¨å“ˆå¸Œè¡¨ä¸Šåªèƒ½åšå•ä¸ªkeyçš„æŸ¥æ‰¾ï¼Œä¸é€‚å®œåšèŒƒå›´æŸ¥æ‰¾ã€‚æ‰€è°“èŒƒå›´æŸ¥æ‰¾ï¼ŒæŒ‡çš„æ˜¯æŸ¥æ‰¾é‚£äº›å¤§å°åœ¨æŒ‡å®šçš„ä¸¤ä¸ªå€¼ä¹‹é—´çš„æ‰€æœ‰èŠ‚ç‚¹ã€‚</p><p>åœ¨åšèŒƒå›´æŸ¥æ‰¾çš„æ—¶å€™ï¼Œå¹³è¡¡æ ‘æ¯”skiplistæ“ä½œè¦å¤æ‚ã€‚åœ¨å¹³è¡¡æ ‘ä¸Šï¼Œæˆ‘ä»¬æ‰¾åˆ°æŒ‡å®šèŒƒå›´çš„å°å€¼ä¹‹åï¼Œè¿˜éœ€è¦ä»¥ä¸­åºéå†çš„é¡ºåºç»§ç»­å¯»æ‰¾å…¶å®ƒä¸è¶…è¿‡å¤§å€¼çš„èŠ‚ç‚¹ã€‚å¦‚æœä¸å¯¹å¹³è¡¡æ ‘è¿›è¡Œä¸€å®šçš„æ”¹é€ ï¼Œè¿™é‡Œçš„ä¸­åºéå†å¹¶ä¸å®¹æ˜“å®ç°ã€‚è€Œåœ¨skiplistä¸Šè¿›è¡ŒèŒƒå›´æŸ¥æ‰¾å°±éå¸¸ç®€å•ï¼Œåªéœ€è¦åœ¨æ‰¾åˆ°å°å€¼ä¹‹åï¼Œå¯¹ç¬¬1å±‚é“¾è¡¨è¿›è¡Œè‹¥å¹²æ­¥çš„éå†å°±å¯ä»¥å®ç°ã€‚</p><p>å¹³è¡¡æ ‘çš„æ’å…¥å’Œåˆ é™¤æ“ä½œå¯èƒ½å¼•å‘å­æ ‘çš„è°ƒæ•´ï¼Œé€»è¾‘å¤æ‚ï¼Œè€Œskiplistçš„æ’å…¥å’Œåˆ é™¤åªéœ€è¦ä¿®æ”¹ç›¸é‚»èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œæ“ä½œç®€å•åˆå¿«é€Ÿã€‚</p><p>ä»å†…å­˜å ç”¨ä¸Šæ¥è¯´ï¼Œskiplistæ¯”å¹³è¡¡æ ‘æ›´çµæ´»ä¸€äº›ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå¹³è¡¡æ ‘æ¯ä¸ªèŠ‚ç‚¹åŒ…å«2ä¸ªæŒ‡é’ˆï¼ˆåˆ†åˆ«æŒ‡å‘å·¦å³å­æ ‘ï¼‰ï¼Œè€Œskiplistæ¯ä¸ªèŠ‚ç‚¹åŒ…å«çš„æŒ‡é’ˆæ•°ç›®å¹³å‡ä¸º1&#x2F;(1-p)ï¼Œå…·ä½“å–å†³äºå‚æ•°pçš„å¤§å°ã€‚å¦‚æœåƒRedisé‡Œçš„å®ç°ä¸€æ ·ï¼Œå–p&#x3D;1&#x2F;4ï¼Œé‚£ä¹ˆå¹³å‡æ¯ä¸ªèŠ‚ç‚¹åŒ…å«1.33ä¸ªæŒ‡é’ˆï¼Œæ¯”å¹³è¡¡æ ‘æ›´æœ‰ä¼˜åŠ¿ã€‚</p><p>æŸ¥æ‰¾å•ä¸ªkeyï¼Œskiplistå’Œå¹³è¡¡æ ‘çš„æ—¶é—´å¤æ‚åº¦éƒ½ä¸ºO(log n)ï¼Œå¤§ä½“ç›¸å½“ï¼›è€Œå“ˆå¸Œè¡¨åœ¨ä¿æŒè¾ƒä½çš„å“ˆå¸Œå€¼å†²çªæ¦‚ç‡çš„å‰æä¸‹ï¼ŒæŸ¥æ‰¾æ—¶é—´å¤æ‚åº¦æ¥è¿‘O(1)ï¼Œæ€§èƒ½æ›´é«˜ä¸€äº›ã€‚æ‰€ä»¥æˆ‘ä»¬å¹³å¸¸ä½¿ç”¨çš„å„ç§Mapæˆ–dictionaryç»“æ„ï¼Œå¤§éƒ½æ˜¯åŸºäºå“ˆå¸Œè¡¨å®ç°çš„ã€‚</p><p>ä»ç®—æ³•å®ç°éš¾åº¦ä¸Šæ¥æ¯”è¾ƒï¼Œskiplistæ¯”å¹³è¡¡æ ‘è¦ç®€å•å¾—å¤šã€‚</p><h2 id="8-å‚è€ƒæ–‡ç« "><a href="#8-å‚è€ƒæ–‡ç« " class="headerlink" title="8. å‚è€ƒæ–‡ç« "></a>8. å‚è€ƒæ–‡ç« </h2><ul><li>Redis 6.0æºç </li><li><a href="https://www.cnblogs.com/neooelric/p/9621736.html">https://www.cnblogs.com/neooelric/p/9621736.html</a></li></ul><p>è¿˜å‚è€ƒäº†</p><p><a href="https://www.cnblogs.com/hunternet/p/11248192.html">https://www.cnblogs.com/hunternet/p/11248192.html</a></p><p><a href="https://www.jianshu.com/p/8ac45fd01548">https://www.jianshu.com/p/8ac45fd01548</a></p>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>æŒ‡ä»¤é‡æ’ çœŸçš„æœ‰ç‚¹é˜´</title>
      <link href="/2025/06/07/%E6%8C%87%E4%BB%A4%E9%87%8D%E6%8E%92%20%E7%9C%9F%E7%9A%84%E6%9C%89%E7%82%B9%E9%98%B4/"/>
      <url>/2025/06/07/%E6%8C%87%E4%BB%A4%E9%87%8D%E6%8E%92%20%E7%9C%9F%E7%9A%84%E6%9C%89%E7%82%B9%E9%98%B4/</url>
      
        <content type="html"><![CDATA[<h1 id="æŒ‡ä»¤é‡æ’-çœŸçš„æœ‰ç‚¹é˜´"><a href="#æŒ‡ä»¤é‡æ’-çœŸçš„æœ‰ç‚¹é˜´" class="headerlink" title="æŒ‡ä»¤é‡æ’ çœŸçš„æœ‰ç‚¹é˜´"></a>æŒ‡ä»¤é‡æ’ çœŸçš„æœ‰ç‚¹é˜´</h1><p>åœ¨ Java ä¸­ï¼Œ<strong>æŒ‡ä»¤é‡æ’ï¼ˆInstruction Reorderingï¼‰</strong> æ˜¯ç¼–è¯‘å™¨ã€å¤„ç†å™¨æˆ–å†…å­˜ç³»ç»Ÿä¸ºäº†æé«˜æ‰§è¡Œæ•ˆç‡è€Œå¯¹æŒ‡ä»¤é¡ºåºè¿›è¡Œçš„ä¼˜åŒ–ã€‚è¿™ç§ä¼˜åŒ–åœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹æ˜¯é€æ˜çš„ï¼ˆéµå¾ª <code>as-if-serial</code> è¯­ä¹‰ï¼‰ï¼Œä½†åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­å¯èƒ½å¯¼è‡´ <strong>å¯è§æ€§</strong> å’Œ <strong>æœ‰åºæ€§</strong> é—®é¢˜ã€‚ä»¥ä¸‹æ˜¯ Java ä¸­å¯èƒ½è¢«æŒ‡ä»¤é‡æ’çš„å…¸å‹æ“ä½œå’Œåœºæ™¯ï¼Œä»¥åŠå¯¹åº”çš„è§£å†³æ–¹æ¡ˆï¼š</p><p>â€”â€”s</p><h3 id="ä¸€ã€å¯èƒ½è¢«æŒ‡ä»¤é‡æ’çš„æ“ä½œåŠåœºæ™¯"><a href="#ä¸€ã€å¯èƒ½è¢«æŒ‡ä»¤é‡æ’çš„æ“ä½œåŠåœºæ™¯" class="headerlink" title="ä¸€ã€å¯èƒ½è¢«æŒ‡ä»¤é‡æ’çš„æ“ä½œåŠåœºæ™¯"></a><strong>ä¸€ã€å¯èƒ½è¢«æŒ‡ä»¤é‡æ’çš„æ“ä½œåŠåœºæ™¯</strong></h3><h4 id="1-æ™®é€šå˜é‡èµ‹å€¼ï¼ˆé-volatileï¼‰"><a href="#1-æ™®é€šå˜é‡èµ‹å€¼ï¼ˆé-volatileï¼‰" class="headerlink" title="1. æ™®é€šå˜é‡èµ‹å€¼ï¼ˆé volatileï¼‰"></a><strong>1. æ™®é€šå˜é‡èµ‹å€¼ï¼ˆé</strong> <code>volatile</code><strong>ï¼‰</strong></h4><ul><li><strong>åœºæ™¯</strong>ï¼š<br>å¤šä¸ªçº¿ç¨‹å¯¹åŒä¸€é <code>volatile</code> å˜é‡è¿›è¡Œè¯»å†™ã€‚</li><li><strong>ç¤ºä¾‹</strong>ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// çº¿ç¨‹1</span></span><br><span class="line">a = <span class="number">1</span>;          <span class="comment">// å¯èƒ½è¢«é‡æ’åˆ° flag èµ‹å€¼ä¹‹å</span></span><br><span class="line">flag = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// çº¿ç¨‹2</span></span><br><span class="line"><span class="keyword">if</span> (flag) &#123;</span><br><span class="line">    System.out.println(a); <span class="comment">// å¯èƒ½è¾“å‡º 0ï¼ˆæœªè§‚å¯Ÿåˆ° a=1ï¼‰</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>é—®é¢˜</strong>ï¼š<br>çº¿ç¨‹1çš„ <code>a = 1</code> å’Œ <code>flag = true</code> å¯èƒ½è¢«é‡æ’ï¼Œå¯¼è‡´çº¿ç¨‹2çœ‹åˆ° <code>flag</code> ä¸º <code>true</code> æ—¶ï¼Œ<code>a</code> ä»ä¸º 0ã€‚</li></ul><h4 id="2-å¯¹è±¡åˆå§‹åŒ–ï¼ˆéå®‰å…¨å‘å¸ƒï¼‰"><a href="#2-å¯¹è±¡åˆå§‹åŒ–ï¼ˆéå®‰å…¨å‘å¸ƒï¼‰" class="headerlink" title="2. å¯¹è±¡åˆå§‹åŒ–ï¼ˆéå®‰å…¨å‘å¸ƒï¼‰"></a><strong>2. å¯¹è±¡åˆå§‹åŒ–ï¼ˆéå®‰å…¨å‘å¸ƒï¼‰</strong></h4><ul><li><strong>åœºæ™¯</strong>ï¼š<br>å¯¹è±¡çš„æ„é€ è¿‡ç¨‹ä¸­ï¼Œæœªæ­£ç¡®åŒæ­¥å¯¼è‡´éƒ¨åˆ†åˆå§‹åŒ–å¯¹è±¡è¢«å…¶ä»–çº¿ç¨‹è®¿é—®ï¼ˆå¦‚åŒé‡æ£€æŸ¥é”å®šé—®é¢˜ï¼‰ã€‚</li><li><strong>ç¤ºä¾‹</strong>ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton instance;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton</span><span class="params">()</span> &#123;</span><br><span class="line">        value = <span class="number">42</span>; <span class="comment">// åˆå§‹åŒ–æ“ä½œå¯èƒ½è¢«é‡æ’åˆ°å¯¹è±¡å¼•ç”¨èµ‹å€¼ä¹‹å</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;                     <span class="comment">// ç¬¬ä¸€æ¬¡æ£€æŸ¥</span></span><br><span class="line">            <span class="keyword">synchronized</span> (Singleton.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;             <span class="comment">// ç¬¬äºŒæ¬¡æ£€æŸ¥</span></span><br><span class="line">                    instance = <span class="keyword">new</span> <span class="title class_">Singleton</span>();     <span class="comment">// å¯èƒ½é‡æ’ï¼šå…ˆåˆ†é…å†…å­˜ï¼Œååˆå§‹åŒ–å¯¹è±¡</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>é—®é¢˜</strong>ï¼š<br>å…¶ä»–çº¿ç¨‹å¯èƒ½è·å–åˆ° <code>instance</code> å¯¹è±¡ï¼Œä½†å…¶ <code>value</code> å­—æ®µå°šæœªåˆå§‹åŒ–ï¼ˆå€¼ä¸ºé»˜è®¤å€¼ 0ï¼‰ã€‚</li></ul><h4 id="3-æ„é€ å‡½æ•°ä¸­çš„-this-é€¸å‡º"><a href="#3-æ„é€ å‡½æ•°ä¸­çš„-this-é€¸å‡º" class="headerlink" title="3. æ„é€ å‡½æ•°ä¸­çš„ this é€¸å‡º"></a><strong>3. æ„é€ å‡½æ•°ä¸­çš„</strong> <code>this</code> <strong>é€¸å‡º</strong></h4><ul><li><strong>åœºæ™¯</strong>ï¼š<br>åœ¨æ„é€ å‡½æ•°ä¸­å°† <code>this</code> æš´éœ²ç»™å…¶ä»–çº¿ç¨‹ï¼ˆå¦‚æ³¨å†Œç›‘å¬å™¨ã€å¯åŠ¨çº¿ç¨‹ï¼‰ã€‚</li><li><strong>ç¤ºä¾‹</strong>ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">EventListener</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">EventListener</span><span class="params">(EventSource source)</span> &#123;</span><br><span class="line">        source.registerListener(() -&gt; System.out.println(id)); <span class="comment">// this é€¸å‡º</span></span><br><span class="line">        id = <span class="number">42</span>; <span class="comment">// å¯èƒ½è¢«é‡æ’åˆ°æ³¨å†Œç›‘å¬å™¨ä¹‹å</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>é—®é¢˜</strong>ï¼š<br><code>id</code> çš„èµ‹å€¼å¯èƒ½è¢«é‡æ’åˆ°ç›‘å¬å™¨æ³¨å†Œä¹‹åï¼Œå¯¼è‡´ç›‘å¬å™¨å›è°ƒæ—¶ <code>id</code> æœªè¢«æ­£ç¡®åˆå§‹åŒ–ã€‚</li></ul><h4 id="4-å¤åˆæ“ä½œï¼ˆéåŸå­æ€§æ“ä½œï¼‰"><a href="#4-å¤åˆæ“ä½œï¼ˆéåŸå­æ€§æ“ä½œï¼‰" class="headerlink" title="4. å¤åˆæ“ä½œï¼ˆéåŸå­æ€§æ“ä½œï¼‰"></a><strong>4. å¤åˆæ“ä½œï¼ˆéåŸå­æ€§æ“ä½œï¼‰</strong></h4><ul><li><strong>åœºæ™¯</strong>ï¼š<br>å¤šä¸ªå˜é‡çš„è¯»å†™æ“ä½œç»„åˆåœ¨ä¸€èµ·ï¼Œå› é‡æ’å¯¼è‡´é€»è¾‘é”™è¯¯ã€‚</li><li><strong>ç¤ºä¾‹</strong>ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// çº¿ç¨‹1</span></span><br><span class="line">x = <span class="number">1</span>;</span><br><span class="line">y = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// çº¿ç¨‹2</span></span><br><span class="line"><span class="keyword">if</span> (y == <span class="number">2</span>) &#123;</span><br><span class="line">    System.out.println(x); <span class="comment">// å¯èƒ½è¾“å‡º 0ï¼ˆx=1 æœªè¢«æ‰§è¡Œæˆ–ä¸å¯è§ï¼‰</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>é—®é¢˜</strong>ï¼š<br>çº¿ç¨‹1çš„ <code>x = 1</code> å’Œ <code>y = 2</code> å¯èƒ½è¢«é‡æ’ï¼Œå¯¼è‡´çº¿ç¨‹2çœ‹åˆ° <code>y=2</code> ä½† <code>x=0</code>ã€‚</li></ul><h4 id="5-æ•°ç»„å…ƒç´ çš„å†™å…¥"><a href="#5-æ•°ç»„å…ƒç´ çš„å†™å…¥" class="headerlink" title="5. æ•°ç»„å…ƒç´ çš„å†™å…¥"></a><strong>5. æ•°ç»„å…ƒç´ çš„å†™å…¥</strong></h4><ul><li><strong>åœºæ™¯</strong>ï¼š<br>å¤šçº¿ç¨‹è®¿é—®æ•°ç»„å…ƒç´ æ—¶ï¼Œå…ƒç´ çš„å€¼å’Œæ•°ç»„é•¿åº¦å¯èƒ½å› é‡æ’å¯¼è‡´ä¸ä¸€è‡´ã€‚</li><li><strong>ç¤ºä¾‹</strong>ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span>[] array = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">10</span>];</span><br><span class="line"><span class="type">boolean</span> <span class="variable">initialized</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// çº¿ç¨‹1</span></span><br><span class="line">array[<span class="number">0</span>] = <span class="number">42</span>;         <span class="comment">// å¯èƒ½è¢«é‡æ’åˆ° initialized=true ä¹‹å</span></span><br><span class="line">initialized = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// çº¿ç¨‹2</span></span><br><span class="line"><span class="keyword">if</span> (initialized) &#123;</span><br><span class="line">    System.out.println(array[<span class="number">0</span>]); <span class="comment">// å¯èƒ½è¾“å‡º 0ï¼ˆé»˜è®¤å€¼ï¼‰</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="äºŒã€ä¸ä¼šè¢«æŒ‡ä»¤é‡æ’çš„æ“ä½œ"><a href="#äºŒã€ä¸ä¼šè¢«æŒ‡ä»¤é‡æ’çš„æ“ä½œ" class="headerlink" title="äºŒã€ä¸ä¼šè¢«æŒ‡ä»¤é‡æ’çš„æ“ä½œ"></a><strong>äºŒã€ä¸ä¼šè¢«æŒ‡ä»¤é‡æ’çš„æ“ä½œ</strong></h3><h4 id="1-volatile-å˜é‡çš„è¯»å†™"><a href="#1-volatile-å˜é‡çš„è¯»å†™" class="headerlink" title="1. volatile å˜é‡çš„è¯»å†™"></a><strong>1.</strong> <code>volatile</code> <strong>å˜é‡çš„è¯»å†™</strong></h4><ul><li><p><strong>JMM ä¿è¯</strong>ï¼š<br><code>volatile</code> å˜é‡çš„è¯»å†™ä¼šæ’å…¥å†…å­˜å±éšœï¼Œç¦æ­¢é‡æ’ï¼š  </p></li><li><ul><li><strong>å†™å±éšœ</strong>ï¼šç¡®ä¿ <code>volatile</code> å†™ä¹‹å‰çš„æ“ä½œä¸ä¼šè¢«é‡æ’åˆ°å†™ä¹‹åã€‚  </li><li><strong>è¯»å±éšœ</strong>ï¼šç¡®ä¿ <code>volatile</code> è¯»ä¹‹åçš„æ“ä½œä¸ä¼šè¢«é‡æ’åˆ°è¯»ä¹‹å‰ã€‚</li></ul></li></ul><h4 id="2-synchronized-å—å†…çš„æ“ä½œ"><a href="#2-synchronized-å—å†…çš„æ“ä½œ" class="headerlink" title="2. synchronized å—å†…çš„æ“ä½œ"></a><strong>2.</strong> <code>synchronized</code> <strong>å—å†…çš„æ“ä½œ</strong></h4><ul><li><strong>é”æœºåˆ¶</strong>ï¼š<br>é”çš„è·å–å’Œé‡Šæ”¾ä¼šæ’å…¥å†…å­˜å±éšœï¼Œç¡®ä¿ä¸´ç•ŒåŒºå†…çš„æ“ä½œä¸ä¼šè¢«é‡æ’åˆ°é”å¤–ã€‚</li></ul><h4 id="3-final-å­—æ®µçš„åˆå§‹åŒ–"><a href="#3-final-å­—æ®µçš„åˆå§‹åŒ–" class="headerlink" title="3. final å­—æ®µçš„åˆå§‹åŒ–"></a><strong>3.</strong> <code>final</code> <strong>å­—æ®µçš„åˆå§‹åŒ–</strong></h4><ul><li><strong>JMM ä¿è¯</strong>ï¼š<br>åœ¨æ„é€ å‡½æ•°ä¸­æ­£ç¡®åˆå§‹åŒ–çš„ <code>final</code> å­—æ®µï¼Œå…¶èµ‹å€¼å¯¹å…¶ä»–çº¿ç¨‹å¯è§ï¼ˆç¦æ­¢é‡æ’åˆå§‹åŒ–æ“ä½œï¼‰ã€‚</li></ul><hr><h3 id="ä¸‰ã€è§£å†³æ–¹æ¡ˆ"><a href="#ä¸‰ã€è§£å†³æ–¹æ¡ˆ" class="headerlink" title="ä¸‰ã€è§£å†³æ–¹æ¡ˆ"></a><strong>ä¸‰ã€è§£å†³æ–¹æ¡ˆ</strong></h3><h4 id="1-ä½¿ç”¨-volatile-å…³é”®å­—"><a href="#1-ä½¿ç”¨-volatile-å…³é”®å­—" class="headerlink" title="1. ä½¿ç”¨ volatile å…³é”®å­—"></a><strong>1. ä½¿ç”¨</strong> <code>volatile</code> <strong>å…³é”®å­—</strong></h4><ul><li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šå•å˜é‡çŠ¶æ€æ ‡å¿—ã€ä¸€æ¬¡æ€§å‘å¸ƒå¯¹è±¡ã€‚</li><li><strong>ç¤ºä¾‹</strong>ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br></pre></td></tr></table></figure><h4 id="2-æ­£ç¡®åŒæ­¥ï¼ˆé”æœºåˆ¶ï¼‰"><a href="#2-æ­£ç¡®åŒæ­¥ï¼ˆé”æœºåˆ¶ï¼‰" class="headerlink" title="2. æ­£ç¡®åŒæ­¥ï¼ˆé”æœºåˆ¶ï¼‰"></a><strong>2. æ­£ç¡®åŒæ­¥ï¼ˆé”æœºåˆ¶ï¼‰</strong></h4><ul><li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šå¤åˆæ“ä½œæˆ–éœ€è¦å¼ºä¸€è‡´æ€§çš„å…±äº«èµ„æºã€‚</li><li><strong>ç¤ºä¾‹</strong>ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">    a = <span class="number">1</span>;</span><br><span class="line">    flag = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-å®‰å…¨å‘å¸ƒä¸å¯å˜å¯¹è±¡"><a href="#3-å®‰å…¨å‘å¸ƒä¸å¯å˜å¯¹è±¡" class="headerlink" title="3. å®‰å…¨å‘å¸ƒä¸å¯å˜å¯¹è±¡"></a><strong>3. å®‰å…¨å‘å¸ƒä¸å¯å˜å¯¹è±¡</strong></h4><ul><li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šå¯¹è±¡æ„é€ å®Œæˆåä¸å¯å˜ã€‚</li><li><strong>ç¤ºä¾‹</strong>ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ImmutableObject</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ImmutableObject</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = value; <span class="comment">// final å­—æ®µçš„èµ‹å€¼å¯¹å…¶ä»–çº¿ç¨‹å¯è§</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-ä½¿ç”¨çº¿ç¨‹å®‰å…¨å®¹å™¨"><a href="#4-ä½¿ç”¨çº¿ç¨‹å®‰å…¨å®¹å™¨" class="headerlink" title="4. ä½¿ç”¨çº¿ç¨‹å®‰å…¨å®¹å™¨"></a><strong>4. ä½¿ç”¨çº¿ç¨‹å®‰å…¨å®¹å™¨</strong></h4><ul><li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šæ•°ç»„æˆ–é›†åˆçš„å¤šçº¿ç¨‹è®¿é—®ã€‚</li><li><strong>ç¤ºä¾‹</strong>ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CopyOnWriteArrayList&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">CopyOnWriteArrayList</span>&lt;&gt;();</span><br></pre></td></tr></table></figure><hr><h3 id="å››ã€æ€»ç»“"><a href="#å››ã€æ€»ç»“" class="headerlink" title="å››ã€æ€»ç»“"></a><strong>å››ã€æ€»ç»“</strong></h3><table><thead><tr><th><strong>æ“ä½œ&#x2F;åœºæ™¯</strong></th><th><strong>å¯èƒ½è¢«é‡æ’</strong></th><th><strong>è§£å†³æ–¹æ¡ˆ</strong></th></tr></thead><tbody><tr><td>æ™®é€šå˜é‡èµ‹å€¼</td><td>âœ”ï¸</td><td><code>volatile</code> æˆ–åŒæ­¥æœºåˆ¶</td></tr><tr><td>éå®‰å…¨å‘å¸ƒçš„å¯¹è±¡åˆå§‹åŒ–</td><td>âœ”ï¸</td><td><code>volatile</code> + å®‰å…¨æ„é€ </td></tr><tr><td>æ„é€ å‡½æ•°ä¸­çš„ <code>this</code> é€¸å‡º</td><td>âœ”ï¸</td><td>é¿å… <code>this</code> é€¸å‡ºï¼Œç”¨ <code>final</code></td></tr><tr><td>å¤åˆæ“ä½œï¼ˆéåŸå­æ€§ï¼‰</td><td>âœ”ï¸</td><td>é”æˆ–åŸå­ç±»ï¼ˆå¦‚ <code>AtomicInteger</code>ï¼‰</td></tr><tr><td><code>volatile</code> å˜é‡è¯»å†™</td><td>âœ–ï¸</td><td>æ— éœ€é¢å¤–å¤„ç†</td></tr><tr><td><code>synchronized</code> å—å†…æ“ä½œ</td><td>âœ–ï¸</td><td>æ— éœ€é¢å¤–å¤„ç†</td></tr><tr><td><code>final</code> å­—æ®µåˆå§‹åŒ–</td><td>âœ–ï¸</td><td>æ­£ç¡®åˆå§‹åŒ– <code>final</code> å­—æ®µ</td></tr></tbody></table><p><strong>æ ¸å¿ƒåŸåˆ™</strong>ï¼š<br>åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œ<strong>å…±äº«å˜é‡çš„è®¿é—®å¿…é¡»é€šè¿‡åŒæ­¥æœºåˆ¶ï¼ˆ</strong><code>volatile</code><strong>ã€é”ã€åŸå­ç±»ç­‰ï¼‰ä¿è¯å¯è§æ€§å’Œæœ‰åºæ€§</strong>ï¼Œé¿å…æŒ‡ä»¤é‡æ’å¯¼è‡´é€»è¾‘é”™è¯¯ã€‚è€Œåœ¨å•çº¿ç¨‹æˆ–çº¿ç¨‹å°é—­åœºæ™¯ä¸‹ï¼Œæ— éœ€å…³æ³¨æŒ‡ä»¤é‡æ’ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>JVMæ–°ç”Ÿä»£åªæœ‰ä¸€ä¸ªEden+S0 å¯ä»¥å—</title>
      <link href="/2025/06/07/%E6%96%B0%E7%94%9F%E4%BB%A3%E5%8F%AA%E6%9C%89%E4%B8%80%E4%B8%AAEden+S0%20%E5%8F%AF%E4%BB%A5%E5%90%97/"/>
      <url>/2025/06/07/%E6%96%B0%E7%94%9F%E4%BB%A3%E5%8F%AA%E6%9C%89%E4%B8%80%E4%B8%AAEden+S0%20%E5%8F%AF%E4%BB%A5%E5%90%97/</url>
      
        <content type="html"><![CDATA[<h1 id="JVMæ–°ç”Ÿä»£åªæœ‰ä¸€ä¸ªEden-S0-å¯ä»¥å—"><a href="#JVMæ–°ç”Ÿä»£åªæœ‰ä¸€ä¸ªEden-S0-å¯ä»¥å—" class="headerlink" title="JVMæ–°ç”Ÿä»£åªæœ‰ä¸€ä¸ªEden+S0 å¯ä»¥å—"></a>JVMæ–°ç”Ÿä»£åªæœ‰ä¸€ä¸ªEden+S0 å¯ä»¥å—</h1><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1742279689877-fe42aa96-5291-48a1-9804-ae55a6877eab.png" alt="img"></p><p>å…ˆç›´æ¥è¯´ç­”æ¡ˆï¼š<strong>ç†è®ºä¸Šå¯ä»¥ï¼Œä¹Ÿèƒ½å®ç°æ ‡è®°-å¤åˆ¶ç®—æ³•ã€‚ä½†å·¥ç¨‹ä¸Šä¸å¯ä»¥ï¼Œå› ä¸ºä¼šå¤§å¤§æµªè´¹ç©ºé—´ã€‚</strong></p><p>æ ‡è®°-å¤åˆ¶ç®—æ³•ä¸‹ï¼Œæ–°ç”Ÿä»£ä¸‰ä¸ªåŒºåŸŸæ˜¯æ€ä¹ˆä½¿ç”¨çš„ï¼š</p><ol><li>åˆå§‹æ—¶ï¼ŒEdenã€S0ã€S1 éƒ½æ˜¯ç©º</li><li>å¯¹è±¡éƒ½åˆ†é…åœ¨ EdenåŒºï¼Œå¦‚æœEdenåŒºå¿«æ»¡äº†å°±è§¦å‘åƒåœ¾å›æ”¶ï¼ŒæŠŠ EdenåŒºä¸­çš„å­˜æ´»å¯¹è±¡è½¬ç§»åˆ°ä¸€ä¸ªå—ç©ºçš„survivoråŒºï¼ˆS0ï¼‰ï¼Œç„¶å EdenåŒºæ¸…ç©ºã€‚ï¼ˆä¸€æ¬¡youngGCç»“æŸï¼‰</li><li>å†æ¬¡åˆ†é…æ–°å¯¹è±¡åˆ° Edenï¼Œå†æ¬¡è§¦å‘åƒåœ¾å›æ”¶ï¼ˆæ­¤æ—¶ä¸å…‰æ ‡è®° Edenï¼Œè¿˜éœ€è¦æ ‡è®°S0äº†ï¼‰ï¼Œç„¶åå°†è¿™ä¸¤ä¸ªåŒºåŸŸå­˜æ´»çš„è½¬ç§»åˆ° å¦ä¸€å—ç©ºçš„survivoråŒºï¼ˆS1ï¼‰ï¼Œæ¸…ç†S0ã€EdenåŒºï¼ˆä¸€æ¬¡youngGCç»“æŸï¼‰</li><li>å†æ¬¡åˆ†é…æ–°å¯¹è±¡åˆ° Edenï¼Œå†æ¬¡è§¦å‘åƒåœ¾å›æ”¶ï¼ˆæ­¤æ—¶ä¸å…‰æ ‡è®° Edenï¼Œè¿˜éœ€è¦æ ‡è®°S1äº†ï¼‰ï¼Œç„¶åå°†è¿™ä¸¤ä¸ªåŒºåŸŸå­˜æ´»çš„è½¬ç§»åˆ° å¦ä¸€å—ç©ºçš„survivoråŒºï¼ˆS0ï¼‰</li></ol><p>å› æ­¤é‡‡ç”¨ Eden+S0+S1ï¼ˆ8ï¼š1ï¼š1ï¼‰ï¼Œå¯ä»¥ä¿è¯JVMæ­£å¸¸è¿è¡Œæ—¶ï¼Œæ–°ç”Ÿä»£çš„ç©ºé—´æœ‰9æˆå¯ä»¥å­˜æ”¾å¯¹è±¡ï¼Œ1æˆæ˜¯ç©ºç€çš„ã€‚</p><p>å¦‚æœè¯´åªæœ‰ä¸¤ä¸ªåŒºåŸŸï¼Œæ¯”å¦‚ EdenåŒºå’ŒS0ã€‚é‚£ä¹ˆç”±äºæ ‡è®°å¤åˆ¶ç®—æ³•çš„é™åˆ¶ï¼ˆå¿…é¡»ç”±ä¸€å—åŒºåŸŸæ˜¯ç©ºçš„ï¼‰ã€‚æ¯æ¬¡åªæœ‰ä¸€ä¸ªåŒºåŸŸæ˜¯å­˜æ”¾youngGCæ´»ä¸‹æ¥çš„å¯¹è±¡ï¼Œä¸€ä¸ªåŒºåŸŸæ˜¯ç©ºçš„ã€‚</p><p>å› ä¸ºè¦è½®æµå­˜æ”¾å¯¹è±¡ï¼Œé‚£ä¹ˆæ¯”ä¾‹åº”è¯¥å°±æ˜¯1ï¼š1ã€‚é‚£ä¹ˆåœ¨æ­£å¸¸è¿è¡Œæ—¶ï¼Œ<strong>JVMæ–°ç”Ÿä»£ä¸­åªæœ‰ä¸€åŠçš„å†…å­˜å¯ä»¥åˆ†é…å¯¹è±¡ï¼Œå¦ä¸€åŠå¾—ç©ºç€</strong>ã€‚</p><p>å¦‚æœè¯´ä¸æƒ³è¦æœ‰åŒºåŸŸæ˜¯ç©ºç€çš„ï¼Œé‚£ä¹ˆå°±éœ€è¦ä½¿ç”¨ æ ‡è®°-æ¸…é™¤ç®—æ³•æˆ–è€…æ ‡è®°-æ•´ç†ç®—æ³•ï¼Œå°±ä¼šå­˜åœ¨ç¢ç‰‡å’Œæ•ˆç‡é—®é¢˜ã€‚è€Œè¿™ä¸ æ–°ç”Ÿä»£çš„è®¾è®¡åˆè¡·ç›¸è¿èƒŒï¼ˆæ–°ç”Ÿä»£ä¼šæ¯”è¾ƒé«˜é¢‘è¿›è¡Œåƒåœ¾å›æ”¶ï¼‰</p>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Sparké›†ç¾¤æ¶æ„ä¸ç»„ä»¶è¯¦è§£ï¼šä»Driveråˆ°Executorçš„æ·±åº¦è§£æ</title>
      <link href="/2025/01/15/Spark%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84%E4%B8%8E%E7%BB%84%E4%BB%B6%E8%AF%A6%E8%A7%A3/"/>
      <url>/2025/01/15/Spark%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84%E4%B8%8E%E7%BB%84%E4%BB%B6%E8%AF%A6%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<h1 id="Sparké›†ç¾¤æ¶æ„ä¸ç»„ä»¶è¯¦è§£ï¼šä»Driveråˆ°Executorçš„è§£æ"><a href="#Sparké›†ç¾¤æ¶æ„ä¸ç»„ä»¶è¯¦è§£ï¼šä»Driveråˆ°Executorçš„è§£æ" class="headerlink" title="Sparké›†ç¾¤æ¶æ„ä¸ç»„ä»¶è¯¦è§£ï¼šä»Driveråˆ°Executorçš„è§£æ"></a>Sparké›†ç¾¤æ¶æ„ä¸ç»„ä»¶è¯¦è§£ï¼šä»Driveråˆ°Executorçš„è§£æ</h1><h2 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h2><p>åœ¨åˆ†å¸ƒå¼è®¡ç®—çš„ä¸–ç•Œé‡Œï¼ŒSparkä»¥å…¶ä¼˜é›…çš„æ¶æ„è®¾è®¡å’Œå¼ºå¤§çš„è®¡ç®—èƒ½åŠ›è„±é¢–è€Œå‡ºã€‚å½“æˆ‘ä»¬è°ˆè®ºSparké›†ç¾¤æ—¶ï¼Œå®é™…ä¸Šæ˜¯åœ¨è®¨è®ºä¸€ä¸ªç”±å¤šä¸ªç»„ä»¶ååŒå·¥ä½œçš„å¤æ‚ç³»ç»Ÿã€‚è¿™äº›ç»„ä»¶å„å¸å…¶èŒï¼Œå´åˆç´§å¯†é…åˆï¼Œå…±åŒå®Œæˆå¤§è§„æ¨¡æ•°æ®å¤„ç†ä»»åŠ¡ã€‚</p><p>æœ¬æ–‡å°†æ·±å…¥å‰–æSparké›†ç¾¤çš„æ¶æ„è®¾è®¡ï¼Œä»Driverç¨‹åºçš„å¯åŠ¨åˆ°Executorçš„æ‰§è¡Œï¼Œä»èµ„æºè°ƒåº¦åˆ°ä»»åŠ¡åˆ†é…ï¼Œæˆ‘ä»¬å°†é€ä¸€æ­å¼€è¿™äº›ç»„ä»¶çš„ç¥ç§˜é¢çº±ã€‚è¿™ä¸æ˜¯ä¸€ç¯‡å®˜æ–¹æ–‡æ¡£çš„ç¿»è¯‘ï¼Œè€Œæ˜¯åŸºäºå®é™…å¼€å‘ç»éªŒçš„æ·±åº¦æŠ€æœ¯è§£æã€‚</p><h2 id="Sparké›†ç¾¤æ¶æ„æ¦‚è§ˆ"><a href="#Sparké›†ç¾¤æ¶æ„æ¦‚è§ˆ" class="headerlink" title="Sparké›†ç¾¤æ¶æ„æ¦‚è§ˆ"></a>Sparké›†ç¾¤æ¶æ„æ¦‚è§ˆ</h2><h3 id="æ•´ä½“æ¶æ„è®¾è®¡"><a href="#æ•´ä½“æ¶æ„è®¾è®¡" class="headerlink" title="æ•´ä½“æ¶æ„è®¾è®¡"></a>æ•´ä½“æ¶æ„è®¾è®¡</h3><p>Sparké›†ç¾¤é‡‡ç”¨äº†ç»å…¸çš„Master-Slaveæ¶æ„ï¼Œä½†è¿™ç§æ¶æ„åœ¨Sparkä¸­æœ‰ç€ç‹¬ç‰¹çš„å®ç°æ–¹å¼ã€‚æ•´ä¸ªé›†ç¾¤ç”±ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒç»„ä»¶æ„æˆï¼š</p><pre class="mermaid">graph TB    subgraph "Driver Program"        D[Driver]        D --> D1[SparkContext]        D --> D2[DAG Scheduler]        D --> D3[Task Scheduler]    end        subgraph "Cluster Manager"        CM[Cluster Manager]        CM --> CM1[Standalone]        CM --> CM2[YARN]        CM --> CM3[Kubernetes]    end        subgraph "Worker Nodes"        W1[Worker Node 1]        W2[Worker Node 2]        W3[Worker Node N]                W1 --> E1[Executor 1]        W1 --> E2[Executor 2]        W2 --> E3[Executor 3]        W2 --> E4[Executor 4]        W3 --> E5[Executor N]    end        D --> CM    CM --> W1    CM --> W2    CM --> W3</pre><p>è¿™ä¸ªæ¶æ„çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š<strong>å°†è®¡ç®—é€»è¾‘ä¸èµ„æºç®¡ç†åˆ†ç¦»</strong>ã€‚Driverè´Ÿè´£åº”ç”¨é€»è¾‘å’Œä»»åŠ¡è°ƒåº¦ï¼ŒCluster Managerè´Ÿè´£èµ„æºåˆ†é…ï¼ŒExecutorè´Ÿè´£å®é™…çš„è®¡ç®—æ‰§è¡Œã€‚è¿™ç§è®¾è®¡ä½¿å¾—Sparkèƒ½å¤Ÿçµæ´»åœ°è¿è¡Œåœ¨ä¸åŒçš„é›†ç¾¤ç¯å¢ƒä¸­ã€‚</p><h2 id="Driverï¼šåº”ç”¨çš„å¤§è„‘"><a href="#Driverï¼šåº”ç”¨çš„å¤§è„‘" class="headerlink" title="Driverï¼šåº”ç”¨çš„å¤§è„‘"></a>Driverï¼šåº”ç”¨çš„å¤§è„‘</h2><h3 id="Driverçš„æ ¸å¿ƒèŒè´£"><a href="#Driverçš„æ ¸å¿ƒèŒè´£" class="headerlink" title="Driverçš„æ ¸å¿ƒèŒè´£"></a>Driverçš„æ ¸å¿ƒèŒè´£</h3><p>Driveræ˜¯Sparkåº”ç”¨çš„å…¥å£ç‚¹ï¼Œå®ƒä¸ä»…ä»…æ˜¯ä¸€ä¸ªç®€å•çš„å¯åŠ¨å™¨ï¼Œè€Œæ˜¯æ•´ä¸ªåº”ç”¨çš„æ§åˆ¶ä¸­å¿ƒã€‚å½“æˆ‘ä»¬è¿è¡Œä¸€ä¸ªSparkåº”ç”¨æ—¶ï¼Œå®é™…ä¸Šæ˜¯åœ¨å¯åŠ¨ä¸€ä¸ªDriverè¿›ç¨‹ã€‚</p><p>Driverçš„ä¸»è¦èŒè´£åŒ…æ‹¬ï¼š</p><ol><li><strong>åº”ç”¨é€»è¾‘æ‰§è¡Œ</strong>ï¼šè¿è¡Œç”¨æˆ·ç¼–å†™çš„Sparkä»£ç </li><li><strong>ä»»åŠ¡è§„åˆ’</strong>ï¼šå°†ç”¨æˆ·ä»£ç è½¬æ¢ä¸ºDAGï¼ˆæœ‰å‘æ— ç¯å›¾ï¼‰</li><li><strong>èµ„æºç”³è¯·</strong>ï¼šå‘é›†ç¾¤ç®¡ç†å™¨ç”³è¯·è®¡ç®—èµ„æº</li><li><strong>ä»»åŠ¡è°ƒåº¦</strong>ï¼šå°†ä»»åŠ¡åˆ†é…ç»™Executoræ‰§è¡Œ</li><li><strong>çŠ¶æ€ç›‘æ§</strong>ï¼šç›‘æ§æ•´ä¸ªåº”ç”¨çš„æ‰§è¡ŒçŠ¶æ€</li></ol><h3 id="SparkContextï¼šDriverçš„æ ¸å¿ƒç»„ä»¶"><a href="#SparkContextï¼šDriverçš„æ ¸å¿ƒç»„ä»¶" class="headerlink" title="SparkContextï¼šDriverçš„æ ¸å¿ƒç»„ä»¶"></a>SparkContextï¼šDriverçš„æ ¸å¿ƒç»„ä»¶</h3><p>SparkContextæ˜¯Driverä¸­æœ€é‡è¦çš„ç»„ä»¶ï¼Œå®ƒæ˜¯ä¸Sparké›†ç¾¤äº¤äº’çš„ä¸»è¦æ¥å£ã€‚å½“æˆ‘ä»¬åˆ›å»ºSparkContextæ—¶ï¼Œå®é™…ä¸Šæ˜¯åœ¨å»ºç«‹ä¸é›†ç¾¤çš„è¿æ¥ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">SparkConf</span>()</span><br><span class="line">  .setAppName(<span class="string">&quot;MySparkApp&quot;</span>)</span><br><span class="line">  .setMaster(<span class="string">&quot;spark://master:7077&quot;</span>)</span><br><span class="line"><span class="keyword">val</span> sc = <span class="keyword">new</span> <span class="type">SparkContext</span>(conf)</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç èƒŒåå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿè®©æˆ‘ä»¬æ·±å…¥çœ‹çœ‹ï¼š</p><ol><li><strong>é…ç½®éªŒè¯</strong>ï¼šæ£€æŸ¥é…ç½®å‚æ•°çš„æœ‰æ•ˆæ€§</li><li><strong>é›†ç¾¤è¿æ¥</strong>ï¼šå»ºç«‹ä¸é›†ç¾¤ç®¡ç†å™¨çš„è¿æ¥</li><li><strong>èµ„æºç”³è¯·</strong>ï¼šå‘é›†ç¾¤ç”³è¯·Executorèµ„æº</li><li><strong>ç»„ä»¶åˆå§‹åŒ–</strong>ï¼šåˆå§‹åŒ–è°ƒåº¦å™¨ã€å­˜å‚¨ç®¡ç†å™¨ç­‰ç»„ä»¶</li></ol><h3 id="DAG-Schedulerï¼šä»»åŠ¡è§„åˆ’å¸ˆ"><a href="#DAG-Schedulerï¼šä»»åŠ¡è§„åˆ’å¸ˆ" class="headerlink" title="DAG Schedulerï¼šä»»åŠ¡è§„åˆ’å¸ˆ"></a>DAG Schedulerï¼šä»»åŠ¡è§„åˆ’å¸ˆ</h3><p>DAG Scheduleræ˜¯Driverä¸­çš„å¦ä¸€ä¸ªå…³é”®ç»„ä»¶ï¼Œå®ƒè´Ÿè´£å°†ç”¨æˆ·çš„æ“ä½œè½¬æ¢ä¸ºå¯æ‰§è¡Œçš„ä»»åŠ¡ã€‚å½“æˆ‘ä»¬è°ƒç”¨RDDçš„è½¬æ¢æ“ä½œæ—¶ï¼ŒDAG Schedulerä¼šæ„å»ºä¸€ä¸ªDAGå›¾ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> data = sc.textFile(<span class="string">&quot;hdfs://path/to/data&quot;</span>)</span><br><span class="line"><span class="keyword">val</span> words = data.flatMap(_.split(<span class="string">&quot; &quot;</span>))</span><br><span class="line"><span class="keyword">val</span> wordCounts = words.map((_, <span class="number">1</span>)).reduceByKey(_ + _)</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç ä¼šè¢«DAG Schedulerè½¬æ¢ä¸ºå¦‚ä¸‹çš„DAGï¼š</p><pre class="mermaid">graph LR    A[textFile] --> B[flatMap]    B --> C[map]    C --> D[reduceByKey]    D --> E[Result]</pre><p>DAG Schedulerçš„å·¥ä½œæµç¨‹ï¼š</p><ol><li><strong>é˜¶æ®µåˆ’åˆ†</strong>ï¼šæ ¹æ®Shuffleæ“ä½œå°†DAGåˆ’åˆ†ä¸ºå¤šä¸ªStage</li><li><strong>ä»»åŠ¡ç”Ÿæˆ</strong>ï¼šä¸ºæ¯ä¸ªStageç”Ÿæˆå…·ä½“çš„Task</li><li><strong>ä¾èµ–ç®¡ç†</strong>ï¼šç®¡ç†Stageä¹‹é—´çš„ä¾èµ–å…³ç³»</li><li><strong>å®¹é”™å¤„ç†</strong>ï¼šå¤„ç†å¤±è´¥çš„ä»»åŠ¡å’ŒStage</li></ol><h3 id="Stageï¼šæ‰§è¡Œè®¡åˆ’çš„æ ¸å¿ƒå•å…ƒ"><a href="#Stageï¼šæ‰§è¡Œè®¡åˆ’çš„æ ¸å¿ƒå•å…ƒ" class="headerlink" title="Stageï¼šæ‰§è¡Œè®¡åˆ’çš„æ ¸å¿ƒå•å…ƒ"></a>Stageï¼šæ‰§è¡Œè®¡åˆ’çš„æ ¸å¿ƒå•å…ƒ</h3><p>Stageæ˜¯Sparkæ‰§è¡Œæ¨¡å‹ä¸­çš„æ ¸å¿ƒæ¦‚å¿µï¼Œå®ƒæ˜¯DAGè¢«åˆ’åˆ†ä¸ºå¯å¹¶è¡Œæ‰§è¡Œçš„ä»»åŠ¡å•å…ƒã€‚ç†è§£Stageå¯¹äºæ€§èƒ½ä¼˜åŒ–å’Œé—®é¢˜æ’æŸ¥è‡³å…³é‡è¦ã€‚</p><h4 id="Stageçš„åˆ’åˆ†åŸç†"><a href="#Stageçš„åˆ’åˆ†åŸç†" class="headerlink" title="Stageçš„åˆ’åˆ†åŸç†"></a>Stageçš„åˆ’åˆ†åŸç†</h4><p>Stageçš„åˆ’åˆ†åŸºäºä¸€ä¸ªå…³é”®æ¦‚å¿µï¼š<strong>Shuffleæ“ä½œ</strong>ã€‚æ¯å½“é‡åˆ°Shuffleæ“ä½œæ—¶ï¼ŒSparkå°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„Stageã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> data = sc.textFile(<span class="string">&quot;hdfs://path/to/data&quot;</span>)</span><br><span class="line"><span class="keyword">val</span> words = data.flatMap(_.split(<span class="string">&quot; &quot;</span>))           <span class="comment">// Stage 0</span></span><br><span class="line"><span class="keyword">val</span> wordCounts = words.map((_, <span class="number">1</span>))               <span class="comment">// Stage 0</span></span><br><span class="line"><span class="keyword">val</span> result = wordCounts.reduceByKey(_ + _)       <span class="comment">// Stage 1 (Shuffle)</span></span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼š</p><ul><li><code>flatMap</code>å’Œ<code>map</code>æ“ä½œåœ¨åŒä¸€ä¸ªStageä¸­ï¼Œå› ä¸ºå®ƒä»¬ä¹‹é—´æ²¡æœ‰Shuffle</li><li><code>reduceByKey</code>ä¼šè§¦å‘Shuffleï¼Œå› æ­¤åˆ›å»ºäº†æ–°çš„Stage</li></ul><h4 id="Stageçš„ç±»å‹"><a href="#Stageçš„ç±»å‹" class="headerlink" title="Stageçš„ç±»å‹"></a>Stageçš„ç±»å‹</h4><p><strong>1. ShuffleMapStage</strong></p><ul><li>åŒ…å«Shuffleæ“ä½œçš„ä»»åŠ¡</li><li>éœ€è¦å°†æ•°æ®å†™å…¥ç£ç›˜ï¼Œä¾›ä¸‹æ¸¸Stageè¯»å–</li><li>ä¾‹å¦‚ï¼š<code>reduceByKey</code>ã€<code>groupByKey</code>ã€<code>sortByKey</code>ç­‰</li></ul><p><strong>2. ResultStage</strong></p><ul><li>æœ€ç»ˆçš„è®¡ç®—ç»“æœ</li><li>é€šå¸¸åŒ…å«<code>collect</code>ã€<code>count</code>ç­‰è¡ŒåŠ¨æ“ä½œ</li><li>ä¸éœ€è¦ä¸ºä¸‹æ¸¸Stageæä¾›æ•°æ®</li></ul><h4 id="Stageçš„ä¾èµ–å…³ç³»"><a href="#Stageçš„ä¾èµ–å…³ç³»" class="headerlink" title="Stageçš„ä¾èµ–å…³ç³»"></a>Stageçš„ä¾èµ–å…³ç³»</h4><p>Stageä¹‹é—´çš„ä¾èµ–å…³ç³»å†³å®šäº†æ‰§è¡Œé¡ºåºï¼š</p><p><strong>1. çª„ä¾èµ–ï¼ˆNarrow Dependencyï¼‰</strong></p><ul><li>çˆ¶RDDçš„æ¯ä¸ªåˆ†åŒºæœ€å¤šè¢«ä¸€ä¸ªå­RDDåˆ†åŒºä½¿ç”¨</li><li>ä¸éœ€è¦Shuffleï¼Œå¯ä»¥åœ¨åŒä¸€ä¸ªStageä¸­æ‰§è¡Œ</li><li>ä¾‹å¦‚ï¼š<code>map</code>ã€<code>filter</code>ã€<code>flatMap</code></li></ul><p><strong>2. å®½ä¾èµ–ï¼ˆWide Dependencyï¼‰</strong></p><ul><li>çˆ¶RDDçš„æ¯ä¸ªåˆ†åŒºå¯èƒ½è¢«å¤šä¸ªå­RDDåˆ†åŒºä½¿ç”¨</li><li>éœ€è¦Shuffleï¼Œä¼šåˆ›å»ºæ–°çš„Stage</li><li>ä¾‹å¦‚ï¼š<code>reduceByKey</code>ã€<code>groupByKey</code>ã€<code>join</code></li></ul><pre class="mermaid">graph LR    subgraph "Stage 0"        A[RDD A] --> B[map]        B --> C[RDD B]    end        subgraph "Stage 1"        C --> D[reduceByKey]        D --> E[RDD C]    end        C -.->|Shuffle| D</pre><h4 id="Stageçš„æ‰§è¡Œæµç¨‹"><a href="#Stageçš„æ‰§è¡Œæµç¨‹" class="headerlink" title="Stageçš„æ‰§è¡Œæµç¨‹"></a>Stageçš„æ‰§è¡Œæµç¨‹</h4><pre class="mermaid">graph TD    A[DAGæ„å»º] --> B[Stageåˆ’åˆ†]    B --> C[Taskç”Ÿæˆ]    C --> D[Stageæäº¤]    D --> E[Taskæ‰§è¡Œ]    E --> F[ç»“æœæ”¶é›†]    F --> G{è¿˜æœ‰Stage?}    G -->|æ˜¯| D    G -->|å¦| H[åº”ç”¨å®Œæˆ]</pre><p><strong>è¯¦ç»†æ‰§è¡Œè¿‡ç¨‹ï¼š</strong></p><ol><li><strong>DAGæ„å»º</strong>ï¼šæ ¹æ®RDDçš„è½¬æ¢æ“ä½œæ„å»ºæœ‰å‘æ— ç¯å›¾</li><li><strong>Stageåˆ’åˆ†</strong>ï¼šæ ¹æ®Shuffleæ“ä½œå°†DAGåˆ’åˆ†ä¸ºå¤šä¸ªStage</li><li><strong>Taskç”Ÿæˆ</strong>ï¼šä¸ºæ¯ä¸ªStageç”Ÿæˆå…·ä½“çš„Task</li><li><strong>Stageæäº¤</strong>ï¼šæŒ‰é¡ºåºæäº¤Stageåˆ°é›†ç¾¤æ‰§è¡Œ</li><li><strong>Taskæ‰§è¡Œ</strong>ï¼šExecutorå¹¶è¡Œæ‰§è¡ŒStageä¸­çš„Task</li><li><strong>ç»“æœæ”¶é›†</strong>ï¼šæ”¶é›†Taskçš„æ‰§è¡Œç»“æœ</li><li><strong>Stageä¾èµ–</strong>ï¼šç­‰å¾…å½“å‰Stageå®Œæˆåï¼Œæ‰§è¡Œä¸‹ä¸€ä¸ªStage</li></ol><h4 id="Stageçš„å¹¶è¡Œåº¦ä¸ä¼˜åŒ–"><a href="#Stageçš„å¹¶è¡Œåº¦ä¸ä¼˜åŒ–" class="headerlink" title="Stageçš„å¹¶è¡Œåº¦ä¸ä¼˜åŒ–"></a>Stageçš„å¹¶è¡Œåº¦ä¸ä¼˜åŒ–</h4><p><strong>å¹¶è¡Œåº¦å†³å®šå› ç´ ï¼š</strong></p><ul><li><strong>åˆ†åŒºæ•°</strong>ï¼šRDDçš„åˆ†åŒºæ•°å†³å®šäº†Taskçš„æ•°é‡</li><li><strong>èµ„æºå¯ç”¨æ€§</strong>ï¼šé›†ç¾¤ä¸­å¯ç”¨çš„Executoræ•°é‡</li><li><strong>æ•°æ®æœ¬åœ°æ€§</strong>ï¼šæ•°æ®åˆ†å¸ƒåœ¨ä¸åŒèŠ‚ç‚¹ä¸Š</li></ul><p><strong>å¹¶è¡Œåº¦ä¼˜åŒ–ç¤ºä¾‹ï¼š</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¾ç½®RDDçš„åˆ†åŒºæ•°</span></span><br><span class="line"><span class="keyword">val</span> rdd = sc.textFile(<span class="string">&quot;data.txt&quot;</span>).repartition(<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®é»˜è®¤å¹¶è¡Œåº¦</span></span><br><span class="line"><span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">SparkConf</span>()</span><br><span class="line">  .set(<span class="string">&quot;spark.default.parallelism&quot;</span>, <span class="string">&quot;100&quot;</span>)</span><br></pre></td></tr></table></figure><p><strong>Stageä¼˜åŒ–ç­–ç•¥ï¼š</strong></p><ol><li><p><strong>å‡å°‘Stageæ•°é‡</strong>ï¼šé¿å…ä¸å¿…è¦çš„Shuffleæ“ä½œ</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼˜åŒ–å‰ï¼šä¼šäº§ç”Ÿé¢å¤–çš„Stage</span></span><br><span class="line"><span class="keyword">val</span> mapped = data.map((_, <span class="number">1</span>))</span><br><span class="line"><span class="keyword">val</span> result = mapped.reduceByKey(_ + _)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¼˜åŒ–åï¼šå‡å°‘Stageæ•°é‡</span></span><br><span class="line"><span class="keyword">val</span> result = data.map((_, <span class="number">1</span>)).reduceByKey(_ + _)</span><br></pre></td></tr></table></figure></li><li><p><strong>ä¼˜åŒ–Stageå†…éƒ¨æ“ä½œ</strong>ï¼šä½¿ç”¨æ›´é«˜æ•ˆçš„ç®—å­</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨mapPartitionså‡å°‘å‡½æ•°è°ƒç”¨å¼€é”€</span></span><br><span class="line"><span class="keyword">val</span> result = data.mapPartitions(iter =&gt; &#123;</span><br><span class="line">  <span class="comment">// æ‰¹é‡å¤„ç†é€»è¾‘</span></span><br><span class="line">  iter.map(process)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li></ol><h4 id="Stageçš„å®¹é”™æœºåˆ¶"><a href="#Stageçš„å®¹é”™æœºåˆ¶" class="headerlink" title="Stageçš„å®¹é”™æœºåˆ¶"></a>Stageçš„å®¹é”™æœºåˆ¶</h4><p><strong>1. ä»»åŠ¡é‡è¯•</strong></p><ul><li>å•ä¸ªTaskå¤±è´¥æ—¶ï¼Œåªé‡è¯•å¤±è´¥çš„Task</li><li>ä¸ä¼šå½±å“æ•´ä¸ªStageçš„å…¶ä»–Task</li></ul><p><strong>2. Stageé‡è¯•</strong></p><ul><li>å¦‚æœStageä¸­å¤±è´¥çš„Taskè¿‡å¤šï¼Œä¼šé‡è¯•æ•´ä¸ªStage</li><li>é€šè¿‡<code>spark.stage.maxAttempts</code>é…ç½®é‡è¯•æ¬¡æ•°</li></ul><p><strong>3. æ•°æ®æŒä¹…åŒ–</strong></p><ul><li>Shuffleæ•°æ®ä¼šæŒä¹…åŒ–åˆ°ç£ç›˜</li><li>æ”¯æŒä»å¤±è´¥ç‚¹æ¢å¤ï¼Œæ— éœ€é‡æ–°è®¡ç®—</li></ul><h4 id="Stageç›‘æ§ä¸è°ƒè¯•"><a href="#Stageç›‘æ§ä¸è°ƒè¯•" class="headerlink" title="Stageç›‘æ§ä¸è°ƒè¯•"></a>Stageç›‘æ§ä¸è°ƒè¯•</h4><p><strong>1. Spark UIæŸ¥çœ‹</strong></p><ul><li>åœ¨Spark UIä¸­å¯ä»¥æŸ¥çœ‹Stageçš„æ‰§è¡Œæƒ…å†µ</li><li>åŒ…æ‹¬æ‰§è¡Œæ—¶é—´ã€Taskæ•°é‡ã€å¤±è´¥æƒ…å†µç­‰</li></ul><p><strong>2. æ—¥å¿—åˆ†æ</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯ç”¨è¯¦ç»†æ—¥å¿—</span></span><br><span class="line">spark.conf.set(<span class="string">&quot;spark.eventLog.enabled&quot;</span>, <span class="string">&quot;true&quot;</span>)</span><br><span class="line">spark.conf.set(<span class="string">&quot;spark.eventLog.dir&quot;</span>, <span class="string">&quot;/tmp/spark-events&quot;</span>)</span><br></pre></td></tr></table></figure><p><strong>3. æ€§èƒ½åˆ†æ</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æŸ¥çœ‹Stageçš„æ‰§è¡Œè®¡åˆ’</span></span><br><span class="line"><span class="keyword">val</span> plan = df.queryExecution.executedPlan</span><br><span class="line">println(plan)</span><br></pre></td></tr></table></figure><h3 id="Task-Schedulerï¼šä»»åŠ¡è°ƒåº¦å™¨"><a href="#Task-Schedulerï¼šä»»åŠ¡è°ƒåº¦å™¨" class="headerlink" title="Task Schedulerï¼šä»»åŠ¡è°ƒåº¦å™¨"></a>Task Schedulerï¼šä»»åŠ¡è°ƒåº¦å™¨</h3><p>Task Schedulerè´Ÿè´£å°†DAG Schedulerç”Ÿæˆçš„ä»»åŠ¡åˆ†é…ç»™Executoræ‰§è¡Œã€‚å®ƒéœ€è¦è€ƒè™‘æ•°æ®æœ¬åœ°æ€§ã€èµ„æºå¯ç”¨æ€§ã€è´Ÿè½½å‡è¡¡ç­‰å¤šä¸ªå› ç´ ã€‚</p><p>Task Schedulerçš„è°ƒåº¦ç­–ç•¥ï¼š</p><ol><li><strong>æ•°æ®æœ¬åœ°æ€§ä¼˜å…ˆ</strong>ï¼šä¼˜å…ˆå°†ä»»åŠ¡åˆ†é…ç»™æ•°æ®æ‰€åœ¨çš„èŠ‚ç‚¹</li><li><strong>èµ„æºåŒ¹é…</strong>ï¼šç¡®ä¿Executoræœ‰è¶³å¤Ÿçš„èµ„æºæ‰§è¡Œä»»åŠ¡</li><li><strong>è´Ÿè½½å‡è¡¡</strong>ï¼šé¿å…æŸäº›èŠ‚ç‚¹è¿‡è½½</li><li><strong>å®¹é”™æœºåˆ¶</strong>ï¼šå¤„ç†Executorå¤±è´¥çš„æƒ…å†µ</li></ol><h2 id="Executorï¼šè®¡ç®—çš„æ‰§è¡Œè€…"><a href="#Executorï¼šè®¡ç®—çš„æ‰§è¡Œè€…" class="headerlink" title="Executorï¼šè®¡ç®—çš„æ‰§è¡Œè€…"></a>Executorï¼šè®¡ç®—çš„æ‰§è¡Œè€…</h2><h3 id="Executorçš„ç”Ÿå‘½å‘¨æœŸ"><a href="#Executorçš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="Executorçš„ç”Ÿå‘½å‘¨æœŸ"></a>Executorçš„ç”Ÿå‘½å‘¨æœŸ</h3><p>Executoræ˜¯å®é™…æ‰§è¡Œè®¡ç®—ä»»åŠ¡çš„ç»„ä»¶ï¼Œå®ƒåœ¨WorkerèŠ‚ç‚¹ä¸Šè¿è¡Œã€‚ä¸€ä¸ªWorkerèŠ‚ç‚¹å¯ä»¥è¿è¡Œå¤šä¸ªExecutorï¼Œæ¯ä¸ªExecutorè¿è¡Œåœ¨ç‹¬ç«‹çš„JVMè¿›ç¨‹ä¸­ã€‚</p><p>Executorçš„ç”Ÿå‘½å‘¨æœŸï¼š</p><pre class="mermaid">graph LR    A[å¯åŠ¨] --> B[æ³¨å†Œ]    B --> C[æ¥æ”¶ä»»åŠ¡]    C --> D[æ‰§è¡Œä»»åŠ¡]    D --> E[è¿”å›ç»“æœ]    E --> F[ç­‰å¾…æ–°ä»»åŠ¡]    F --> C    F --> G[å…³é—­]</pre><h3 id="Executorçš„å†…éƒ¨ç»“æ„"><a href="#Executorçš„å†…éƒ¨ç»“æ„" class="headerlink" title="Executorçš„å†…éƒ¨ç»“æ„"></a>Executorçš„å†…éƒ¨ç»“æ„</h3><p>æ¯ä¸ªExecutorå†…éƒ¨åŒ…å«å¤šä¸ªç»„ä»¶ï¼š</p><ol><li><strong>Task Runner</strong>ï¼šå®é™…æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹</li><li><strong>Block Manager</strong>ï¼šç®¡ç†å†…å­˜å’Œç£ç›˜ä¸Šçš„æ•°æ®å—</li><li><strong>Shuffle Manager</strong>ï¼šå¤„ç†Shuffleæ“ä½œ</li><li><strong>Memory Manager</strong>ï¼šç®¡ç†å†…å­˜åˆ†é…å’Œå›æ”¶</li></ol><h3 id="å†…å­˜ç®¡ç†æœºåˆ¶"><a href="#å†…å­˜ç®¡ç†æœºåˆ¶" class="headerlink" title="å†…å­˜ç®¡ç†æœºåˆ¶"></a>å†…å­˜ç®¡ç†æœºåˆ¶</h3><p>Executorçš„å†…å­˜ç®¡ç†æ˜¯Sparkæ€§èƒ½ä¼˜åŒ–çš„å…³é”®ã€‚Sparkå°†Executorçš„å†…å­˜åˆ†ä¸ºå‡ ä¸ªåŒºåŸŸï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Executor Memory Layout:</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚  Reserved Memory (300MB)           â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚  User Memory (25% of heap)         â”‚</span><br><span class="line">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span><br><span class="line">â”‚  Spark Memory (75% of heap)        â”‚</span><br><span class="line">â”‚  â”œâ”€ Storage Memory (50% of Spark)  â”‚</span><br><span class="line">â”‚  â””â”€ Execution Memory (50% of Spark)â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><ul><li><strong>Reserved Memory</strong>ï¼šç³»ç»Ÿä¿ç•™å†…å­˜ï¼Œç”¨äºSparkå†…éƒ¨æ•°æ®ç»“æ„</li><li><strong>User Memory</strong>ï¼šç”¨æˆ·ä»£ç å’Œæ•°æ®ç»“æ„ä½¿ç”¨çš„å†…å­˜</li><li><strong>Storage Memory</strong>ï¼šç”¨äºç¼“å­˜RDDå’Œå¹¿æ’­å˜é‡</li><li><strong>Execution Memory</strong>ï¼šç”¨äºShuffleã€Joinç­‰æ“ä½œçš„ä¸´æ—¶æ•°æ®</li></ul><h3 id="ä»»åŠ¡æ‰§è¡Œæµç¨‹"><a href="#ä»»åŠ¡æ‰§è¡Œæµç¨‹" class="headerlink" title="ä»»åŠ¡æ‰§è¡Œæµç¨‹"></a>ä»»åŠ¡æ‰§è¡Œæµç¨‹</h3><p>å½“Executoræ¥æ”¶åˆ°ä»»åŠ¡æ—¶ï¼Œæ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š</p><ol><li><strong>ä»»åŠ¡ååºåˆ—åŒ–</strong>ï¼šå°†ä»»åŠ¡ä»ç½‘ç»œä¼ è¾“çš„å­—èŠ‚æµååºåˆ—åŒ–ä¸ºå¯¹è±¡</li><li><strong>ä¾èµ–ä¸‹è½½</strong>ï¼šä¸‹è½½ä»»åŠ¡æ‰€éœ€çš„ä¾èµ–JARåŒ…å’Œæ–‡ä»¶</li><li><strong>ä»»åŠ¡æ‰§è¡Œ</strong>ï¼šåœ¨Task Runnerçº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡</li><li><strong>ç»“æœè¿”å›</strong>ï¼šå°†æ‰§è¡Œç»“æœè¿”å›ç»™Driver</li><li><strong>èµ„æºæ¸…ç†</strong>ï¼šæ¸…ç†ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸´æ—¶æ•°æ®</li></ol><h2 id="Workerï¼šèµ„æºçš„æä¾›è€…"><a href="#Workerï¼šèµ„æºçš„æä¾›è€…" class="headerlink" title="Workerï¼šèµ„æºçš„æä¾›è€…"></a>Workerï¼šèµ„æºçš„æä¾›è€…</h2><h3 id="Workerçš„è§’è‰²å®šä½"><a href="#Workerçš„è§’è‰²å®šä½" class="headerlink" title="Workerçš„è§’è‰²å®šä½"></a>Workerçš„è§’è‰²å®šä½</h3><p>Workeræ˜¯é›†ç¾¤ä¸­çš„è®¡ç®—èŠ‚ç‚¹ï¼Œå®ƒè´Ÿè´£ï¼š</p><ol><li><strong>èµ„æºç®¡ç†</strong>ï¼šç®¡ç†èŠ‚ç‚¹çš„CPUã€å†…å­˜ç­‰è®¡ç®—èµ„æº</li><li><strong>Executorç®¡ç†</strong>ï¼šå¯åŠ¨ã€ç›‘æ§ã€åœæ­¢Executorè¿›ç¨‹</li><li><strong>å¿ƒè·³æŠ¥å‘Š</strong>ï¼šå®šæœŸå‘MasteræŠ¥å‘ŠèŠ‚ç‚¹çŠ¶æ€</li><li><strong>æ•…éšœå¤„ç†</strong>ï¼šå¤„ç†Executorå’ŒèŠ‚ç‚¹çº§åˆ«çš„æ•…éšœ</li></ol><h3 id="Workerçš„èµ„æºåˆ†é…ç­–ç•¥"><a href="#Workerçš„èµ„æºåˆ†é…ç­–ç•¥" class="headerlink" title="Workerçš„èµ„æºåˆ†é…ç­–ç•¥"></a>Workerçš„èµ„æºåˆ†é…ç­–ç•¥</h3><p>Workeréœ€è¦åˆç†åˆ†é…èµ„æºç»™ä¸åŒçš„Executorã€‚èµ„æºåˆ†é…è€ƒè™‘çš„å› ç´ ï¼š</p><ol><li><strong>å¯ç”¨èµ„æº</strong>ï¼šèŠ‚ç‚¹çš„CPUæ ¸å¿ƒæ•°å’Œå¯ç”¨å†…å­˜</li><li><strong>åº”ç”¨éœ€æ±‚</strong>ï¼šä¸åŒåº”ç”¨å¯¹èµ„æºçš„éœ€æ±‚</li><li><strong>èµ„æºéš”ç¦»</strong>ï¼šç¡®ä¿ä¸åŒåº”ç”¨ä¹‹é—´çš„èµ„æºéš”ç¦»</li><li><strong>åŠ¨æ€è°ƒæ•´</strong>ï¼šæ ¹æ®è´Ÿè½½æƒ…å†µåŠ¨æ€è°ƒæ•´èµ„æºåˆ†é…</li></ol><h3 id="Workerçš„å®¹é”™æœºåˆ¶"><a href="#Workerçš„å®¹é”™æœºåˆ¶" class="headerlink" title="Workerçš„å®¹é”™æœºåˆ¶"></a>Workerçš„å®¹é”™æœºåˆ¶</h3><p>WorkerèŠ‚ç‚¹å¯èƒ½å› ä¸ºç¡¬ä»¶æ•…éšœã€ç½‘ç»œé—®é¢˜ç­‰åŸå› å¤±æ•ˆã€‚Sparkæä¾›äº†å¤šå±‚å®¹é”™æœºåˆ¶ï¼š</p><ol><li><strong>å¿ƒè·³æ£€æµ‹</strong>ï¼šå®šæœŸæ£€æµ‹WorkerèŠ‚ç‚¹çŠ¶æ€</li><li><strong>ä»»åŠ¡é‡è¯•</strong>ï¼šå¤±è´¥çš„ä»»åŠ¡å¯ä»¥åœ¨å…¶ä»–èŠ‚ç‚¹é‡è¯•</li><li><strong>æ•°æ®å¤‡ä»½</strong>ï¼šé‡è¦æ•°æ®åœ¨å¤šä¸ªèŠ‚ç‚¹å¤‡ä»½</li><li><strong>å¿«é€Ÿæ¢å¤</strong>ï¼šä»æ•…éšœä¸­å¿«é€Ÿæ¢å¤æœåŠ¡</li></ol><h2 id="é›†ç¾¤ç®¡ç†å™¨ï¼šèµ„æºçš„åè°ƒè€…"><a href="#é›†ç¾¤ç®¡ç†å™¨ï¼šèµ„æºçš„åè°ƒè€…" class="headerlink" title="é›†ç¾¤ç®¡ç†å™¨ï¼šèµ„æºçš„åè°ƒè€…"></a>é›†ç¾¤ç®¡ç†å™¨ï¼šèµ„æºçš„åè°ƒè€…</h2><h3 id="ä¸‰ç§é›†ç¾¤ç®¡ç†å™¨å¯¹æ¯”"><a href="#ä¸‰ç§é›†ç¾¤ç®¡ç†å™¨å¯¹æ¯”" class="headerlink" title="ä¸‰ç§é›†ç¾¤ç®¡ç†å™¨å¯¹æ¯”"></a>ä¸‰ç§é›†ç¾¤ç®¡ç†å™¨å¯¹æ¯”</h3><p>Sparkæ”¯æŒä¸‰ç§ä¸»è¦çš„é›†ç¾¤ç®¡ç†å™¨ï¼Œæ¯ç§éƒ½æœ‰å…¶ç‰¹ç‚¹å’Œé€‚ç”¨åœºæ™¯ï¼š</p><h4 id="1-Standaloneæ¨¡å¼"><a href="#1-Standaloneæ¨¡å¼" class="headerlink" title="1. Standaloneæ¨¡å¼"></a>1. Standaloneæ¨¡å¼</h4><p>Standaloneæ˜¯Sparkè‡ªå¸¦çš„é›†ç¾¤ç®¡ç†å™¨ï¼Œé€‚åˆä¸­å°è§„æ¨¡é›†ç¾¤ã€‚</p><p><strong>ä¼˜åŠ¿ï¼š</strong></p><ul><li>éƒ¨ç½²ç®€å•ï¼Œæ— éœ€é¢å¤–ç»„ä»¶</li><li>èµ„æºåˆ©ç”¨ç‡é«˜</li><li>é€‚åˆå­¦ä¹ å’Œæµ‹è¯•ç¯å¢ƒ</li></ul><p><strong>åŠ£åŠ¿ï¼š</strong></p><ul><li>åŠŸèƒ½ç›¸å¯¹ç®€å•</li><li>ç¼ºä¹é«˜çº§è°ƒåº¦ç‰¹æ€§</li><li>ä¸é€‚åˆå¤§è§„æ¨¡ç”Ÿäº§ç¯å¢ƒ</li></ul><p><strong>æ¶æ„ç‰¹ç‚¹ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Standalone Architecture:</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚   Master        â”‚    â”‚   Worker        â”‚</span><br><span class="line">â”‚                 â”‚    â”‚                 â”‚</span><br><span class="line">â”‚ - èµ„æºè°ƒåº¦      â”‚    â”‚ - å¯åŠ¨Executor  â”‚</span><br><span class="line">â”‚ - åº”ç”¨ç®¡ç†      â”‚    â”‚ - èµ„æºç›‘æ§      â”‚</span><br><span class="line">â”‚ - æ•…éšœå¤„ç†      â”‚    â”‚ - å¿ƒè·³æŠ¥å‘Š      â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><h4 id="2-YARNæ¨¡å¼"><a href="#2-YARNæ¨¡å¼" class="headerlink" title="2. YARNæ¨¡å¼"></a>2. YARNæ¨¡å¼</h4><p>YARNæ˜¯Hadoopç”Ÿæ€ç³»ç»Ÿçš„èµ„æºç®¡ç†å™¨ï¼Œé€‚åˆå¤§è§„æ¨¡ç”Ÿäº§ç¯å¢ƒã€‚</p><p><strong>ä¼˜åŠ¿ï¼š</strong></p><ul><li>æˆç†Ÿçš„èµ„æºç®¡ç†</li><li>ä¸Hadoopç”Ÿæ€æ·±åº¦é›†æˆ</li><li>æ”¯æŒå¤šç§Ÿæˆ·å’Œèµ„æºéš”ç¦»</li><li>é€‚åˆå¤§è§„æ¨¡é›†ç¾¤</li></ul><p><strong>åŠ£åŠ¿ï¼š</strong></p><ul><li>éƒ¨ç½²å¤æ‚åº¦è¾ƒé«˜</li><li>éœ€è¦Hadoopç¯å¢ƒ</li><li>èµ„æºè°ƒåº¦å»¶è¿Ÿç›¸å¯¹è¾ƒé«˜</li></ul><p><strong>æ¶æ„ç‰¹ç‚¹ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">YARN Architecture:</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚   Resource      â”‚    â”‚   NodeManager   â”‚</span><br><span class="line">â”‚   Manager       â”‚    â”‚                 â”‚</span><br><span class="line">â”‚                 â”‚    â”‚ - å®¹å™¨ç®¡ç†      â”‚</span><br><span class="line">â”‚ - å…¨å±€èµ„æºè°ƒåº¦  â”‚    â”‚ - èµ„æºç›‘æ§      â”‚</span><br><span class="line">â”‚ - åº”ç”¨ç”Ÿå‘½å‘¨æœŸ  â”‚    â”‚ - ä»»åŠ¡æ‰§è¡Œ      â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">        â”‚                       â”‚</span><br><span class="line">        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">                YARN</span><br></pre></td></tr></table></figure><h4 id="3-Kubernetesæ¨¡å¼"><a href="#3-Kubernetesæ¨¡å¼" class="headerlink" title="3. Kubernetesæ¨¡å¼"></a>3. Kubernetesæ¨¡å¼</h4><p>Kubernetesæ˜¯äº‘åŸç”Ÿçš„å®¹å™¨ç¼–æ’å¹³å°ï¼Œé€‚åˆäº‘ç¯å¢ƒéƒ¨ç½²ã€‚</p><p><strong>ä¼˜åŠ¿ï¼š</strong></p><ul><li>äº‘åŸç”Ÿæ¶æ„</li><li>å¼¹æ€§ä¼¸ç¼©èƒ½åŠ›å¼º</li><li>å®¹å™¨åŒ–éƒ¨ç½²</li><li>ä¸°å¯Œçš„ç”Ÿæ€ç³»ç»Ÿ</li></ul><p><strong>åŠ£åŠ¿ï¼š</strong></p><ul><li>å­¦ä¹ æ›²çº¿é™¡å³­</li><li>éœ€è¦Kubernetesç¯å¢ƒ</li><li>èµ„æºè°ƒåº¦å¼€é”€è¾ƒå¤§</li></ul><p><strong>æ¶æ„ç‰¹ç‚¹ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Kubernetes Architecture:</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚   K8s API       â”‚    â”‚   Kubelet       â”‚</span><br><span class="line">â”‚   Server        â”‚    â”‚                 â”‚</span><br><span class="line">â”‚                 â”‚    â”‚ - Podç®¡ç†       â”‚</span><br><span class="line">â”‚ - èµ„æºè°ƒåº¦      â”‚    â”‚ - å®¹å™¨ç”Ÿå‘½å‘¨æœŸ  â”‚</span><br><span class="line">â”‚ - æœåŠ¡å‘ç°      â”‚    â”‚ - èµ„æºç›‘æ§      â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">        â”‚                       â”‚</span><br><span class="line">        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">            Kubernetes</span><br></pre></td></tr></table></figure><h3 id="é›†ç¾¤ç®¡ç†å™¨çš„é€‰æ‹©ç­–ç•¥"><a href="#é›†ç¾¤ç®¡ç†å™¨çš„é€‰æ‹©ç­–ç•¥" class="headerlink" title="é›†ç¾¤ç®¡ç†å™¨çš„é€‰æ‹©ç­–ç•¥"></a>é›†ç¾¤ç®¡ç†å™¨çš„é€‰æ‹©ç­–ç•¥</h3><p>é€‰æ‹©åˆé€‚çš„é›†ç¾¤ç®¡ç†å™¨éœ€è¦è€ƒè™‘ä»¥ä¸‹å› ç´ ï¼š</p><ol><li><strong>é›†ç¾¤è§„æ¨¡</strong>ï¼šå°è§„æ¨¡é€‰æ‹©Standaloneï¼Œå¤§è§„æ¨¡é€‰æ‹©YARNæˆ–Kubernetes</li><li><strong>ç°æœ‰åŸºç¡€è®¾æ–½</strong>ï¼šå¦‚æœå·²æœ‰Hadoopç¯å¢ƒï¼Œé€‰æ‹©YARNï¼›å¦‚æœä½¿ç”¨äº‘æœåŠ¡ï¼Œé€‰æ‹©Kubernetes</li><li><strong>è¿ç»´èƒ½åŠ›</strong>ï¼šå›¢é˜Ÿçš„æŠ€æœ¯æ ˆå’Œè¿ç»´ç»éªŒ</li><li><strong>æˆæœ¬è€ƒè™‘</strong>ï¼šä¸åŒæ–¹æ¡ˆçš„éƒ¨ç½²å’Œç»´æŠ¤æˆæœ¬</li></ol><h2 id="èµ„æºè°ƒåº¦ä¸ä»»åŠ¡åˆ†é…æœºåˆ¶"><a href="#èµ„æºè°ƒåº¦ä¸ä»»åŠ¡åˆ†é…æœºåˆ¶" class="headerlink" title="èµ„æºè°ƒåº¦ä¸ä»»åŠ¡åˆ†é…æœºåˆ¶"></a>èµ„æºè°ƒåº¦ä¸ä»»åŠ¡åˆ†é…æœºåˆ¶</h2><h3 id="èµ„æºè°ƒåº¦æµç¨‹"><a href="#èµ„æºè°ƒåº¦æµç¨‹" class="headerlink" title="èµ„æºè°ƒåº¦æµç¨‹"></a>èµ„æºè°ƒåº¦æµç¨‹</h3><p>Sparkçš„èµ„æºè°ƒåº¦æ˜¯ä¸€ä¸ªå¤æ‚çš„è¿‡ç¨‹ï¼Œæ¶‰åŠå¤šä¸ªç»„ä»¶ä¹‹é—´çš„åä½œï¼š</p><pre class="mermaid">sequenceDiagram    participant D as Driver    participant CM as Cluster Manager    participant W as Worker    participant E as Executor        D->>CM: ç”³è¯·èµ„æº    CM->>W: åˆ†é…èµ„æº    W->>E: å¯åŠ¨Executor    E->>D: æ³¨å†ŒExecutor    D->>E: åˆ†é…ä»»åŠ¡    E->>D: è¿”å›ç»“æœ</pre><h3 id="ä»»åŠ¡åˆ†é…ç­–ç•¥"><a href="#ä»»åŠ¡åˆ†é…ç­–ç•¥" class="headerlink" title="ä»»åŠ¡åˆ†é…ç­–ç•¥"></a>ä»»åŠ¡åˆ†é…ç­–ç•¥</h3><p>Sparkçš„ä»»åŠ¡åˆ†é…éµå¾ªä»¥ä¸‹ç­–ç•¥ï¼š</p><ol><li><strong>æ•°æ®æœ¬åœ°æ€§ä¼˜å…ˆ</strong>ï¼šä¼˜å…ˆå°†ä»»åŠ¡åˆ†é…ç»™æ•°æ®æ‰€åœ¨çš„èŠ‚ç‚¹</li><li><strong>èµ„æºåŒ¹é…</strong>ï¼šç¡®ä¿Executoræœ‰è¶³å¤Ÿçš„èµ„æºæ‰§è¡Œä»»åŠ¡</li><li><strong>è´Ÿè½½å‡è¡¡</strong>ï¼šé¿å…æŸäº›èŠ‚ç‚¹è¿‡è½½</li><li><strong>å®¹é”™è€ƒè™‘</strong>ï¼šè€ƒè™‘èŠ‚ç‚¹å’ŒExecutorçš„å¯é æ€§</li></ol><h3 id="èµ„æºè°ƒåº¦ä¼˜åŒ–"><a href="#èµ„æºè°ƒåº¦ä¼˜åŒ–" class="headerlink" title="èµ„æºè°ƒåº¦ä¼˜åŒ–"></a>èµ„æºè°ƒåº¦ä¼˜åŒ–</h3><p>ä¸ºäº†æé«˜èµ„æºåˆ©ç”¨ç‡ï¼ŒSparkæä¾›äº†å¤šç§ä¼˜åŒ–ç­–ç•¥ï¼š</p><ol><li><strong>åŠ¨æ€èµ„æºåˆ†é…</strong>ï¼šæ ¹æ®è´Ÿè½½åŠ¨æ€è°ƒæ•´èµ„æºåˆ†é…</li><li><strong>èµ„æºé¢„ç•™</strong>ï¼šä¸ºé‡è¦åº”ç”¨é¢„ç•™èµ„æº</li><li><strong>èµ„æºéš”ç¦»</strong>ï¼šä¸åŒåº”ç”¨ä¹‹é—´çš„èµ„æºéš”ç¦»</li><li><strong>èµ„æºç›‘æ§</strong>ï¼šå®æ—¶ç›‘æ§èµ„æºä½¿ç”¨æƒ…å†µ</li></ol><h2 id="é›†ç¾¤éƒ¨ç½²ä¸é…ç½®æœ€ä½³å®è·µ"><a href="#é›†ç¾¤éƒ¨ç½²ä¸é…ç½®æœ€ä½³å®è·µ" class="headerlink" title="é›†ç¾¤éƒ¨ç½²ä¸é…ç½®æœ€ä½³å®è·µ"></a>é›†ç¾¤éƒ¨ç½²ä¸é…ç½®æœ€ä½³å®è·µ</h2><h3 id="ç¡¬ä»¶é…ç½®å»ºè®®"><a href="#ç¡¬ä»¶é…ç½®å»ºè®®" class="headerlink" title="ç¡¬ä»¶é…ç½®å»ºè®®"></a>ç¡¬ä»¶é…ç½®å»ºè®®</h3><h4 id="CPUé…ç½®"><a href="#CPUé…ç½®" class="headerlink" title="CPUé…ç½®"></a>CPUé…ç½®</h4><ul><li><strong>Driver</strong>ï¼š2-4ä¸ªCPUæ ¸å¿ƒ</li><li><strong>Executor</strong>ï¼š4-8ä¸ªCPUæ ¸å¿ƒ</li><li><strong>Worker</strong>ï¼š16-32ä¸ªCPUæ ¸å¿ƒ</li></ul><h4 id="å†…å­˜é…ç½®"><a href="#å†…å­˜é…ç½®" class="headerlink" title="å†…å­˜é…ç½®"></a>å†…å­˜é…ç½®</h4><ul><li><strong>Driver</strong>ï¼š4-8GBå†…å­˜</li><li><strong>Executor</strong>ï¼š8-32GBå†…å­˜</li><li><strong>Worker</strong>ï¼š64-256GBå†…å­˜</li></ul><h4 id="å­˜å‚¨é…ç½®"><a href="#å­˜å‚¨é…ç½®" class="headerlink" title="å­˜å‚¨é…ç½®"></a>å­˜å‚¨é…ç½®</h4><ul><li><strong>æœ¬åœ°å­˜å‚¨</strong>ï¼šSSDä¼˜å…ˆï¼Œç”¨äºShuffleå’Œç¼“å­˜</li><li><strong>ç½‘ç»œå­˜å‚¨</strong>ï¼šç”¨äºæŒä¹…åŒ–æ•°æ®</li><li><strong>å­˜å‚¨å®¹é‡</strong>ï¼šæ ¹æ®æ•°æ®é‡ç¡®å®š</li></ul><h3 id="ç½‘ç»œé…ç½®"><a href="#ç½‘ç»œé…ç½®" class="headerlink" title="ç½‘ç»œé…ç½®"></a>ç½‘ç»œé…ç½®</h3><h4 id="ç½‘ç»œå¸¦å®½"><a href="#ç½‘ç»œå¸¦å®½" class="headerlink" title="ç½‘ç»œå¸¦å®½"></a>ç½‘ç»œå¸¦å®½</h4><ul><li><strong>èŠ‚ç‚¹é—´é€šä¿¡</strong>ï¼š10Gbpsæˆ–æ›´é«˜</li><li><strong>ç½‘ç»œå»¶è¿Ÿ</strong>ï¼šå°½é‡é™ä½èŠ‚ç‚¹é—´å»¶è¿Ÿ</li><li><strong>ç½‘ç»œæ‹“æ‰‘</strong>ï¼šé¿å…ç½‘ç»œç“¶é¢ˆ</li></ul><h4 id="ç½‘ç»œä¼˜åŒ–"><a href="#ç½‘ç»œä¼˜åŒ–" class="headerlink" title="ç½‘ç»œä¼˜åŒ–"></a>ç½‘ç»œä¼˜åŒ–</h4><ul><li><strong>TCPè°ƒä¼˜</strong>ï¼šä¼˜åŒ–TCPå‚æ•°</li><li><strong>ç½‘ç»œéš”ç¦»</strong>ï¼šä¸åŒåº”ç”¨é—´çš„ç½‘ç»œéš”ç¦»</li><li><strong>ç½‘ç»œç›‘æ§</strong>ï¼šç›‘æ§ç½‘ç»œæ€§èƒ½</li></ul><h3 id="é…ç½®å‚æ•°è°ƒä¼˜"><a href="#é…ç½®å‚æ•°è°ƒä¼˜" class="headerlink" title="é…ç½®å‚æ•°è°ƒä¼˜"></a>é…ç½®å‚æ•°è°ƒä¼˜</h3><h4 id="æ ¸å¿ƒé…ç½®å‚æ•°"><a href="#æ ¸å¿ƒé…ç½®å‚æ•°" class="headerlink" title="æ ¸å¿ƒé…ç½®å‚æ•°"></a>æ ¸å¿ƒé…ç½®å‚æ•°</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åº”ç”¨é…ç½®</span></span><br><span class="line"><span class="attr">spark.app.name</span>=<span class="string">MySparkApp</span></span><br><span class="line"><span class="attr">spark.master</span>=<span class="string">spark://master:7077</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># èµ„æºé…ç½®</span></span><br><span class="line"><span class="attr">spark.executor.memory</span>=<span class="string">8g</span></span><br><span class="line"><span class="attr">spark.executor.cores</span>=<span class="string">4</span></span><br><span class="line"><span class="attr">spark.executor.instances</span>=<span class="string">10</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># æ€§èƒ½è°ƒä¼˜</span></span><br><span class="line"><span class="attr">spark.serializer</span>=<span class="string">org.apache.spark.serializer.KryoSerializer</span></span><br><span class="line"><span class="attr">spark.sql.adaptive.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">spark.sql.adaptive.coalescePartitions.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># å®¹é”™é…ç½®</span></span><br><span class="line"><span class="attr">spark.task.maxFailures</span>=<span class="string">4</span></span><br><span class="line"><span class="attr">spark.stage.maxAttempts</span>=<span class="string">4</span></span><br></pre></td></tr></table></figure><h4 id="é…ç½®è°ƒä¼˜åŸåˆ™"><a href="#é…ç½®è°ƒä¼˜åŸåˆ™" class="headerlink" title="é…ç½®è°ƒä¼˜åŸåˆ™"></a>é…ç½®è°ƒä¼˜åŸåˆ™</h4><ol><li><strong>èµ„æºåˆç†åˆ†é…</strong>ï¼šæ ¹æ®åº”ç”¨éœ€æ±‚åˆç†åˆ†é…èµ„æº</li><li><strong>å‚æ•°å¹³è¡¡</strong>ï¼šåœ¨æ€§èƒ½å’Œç¨³å®šæ€§ä¹‹é—´æ‰¾åˆ°å¹³è¡¡</li><li><strong>ç›‘æ§éªŒè¯</strong>ï¼šé€šè¿‡ç›‘æ§éªŒè¯é…ç½®æ•ˆæœ</li><li><strong>æ¸è¿›è°ƒä¼˜</strong>ï¼šé€æ­¥è°ƒæ•´å‚æ•°ï¼Œè§‚å¯Ÿæ•ˆæœ</li></ol><h3 id="ç›‘æ§ä¸è¿ç»´"><a href="#ç›‘æ§ä¸è¿ç»´" class="headerlink" title="ç›‘æ§ä¸è¿ç»´"></a>ç›‘æ§ä¸è¿ç»´</h3><h4 id="ç›‘æ§æŒ‡æ ‡"><a href="#ç›‘æ§æŒ‡æ ‡" class="headerlink" title="ç›‘æ§æŒ‡æ ‡"></a>ç›‘æ§æŒ‡æ ‡</h4><ol><li><strong>åº”ç”¨çº§åˆ«</strong>ï¼šä»»åŠ¡æ‰§è¡Œæ—¶é—´ã€æˆåŠŸç‡ã€èµ„æºä½¿ç”¨ç‡</li><li><strong>é›†ç¾¤çº§åˆ«</strong>ï¼šèŠ‚ç‚¹çŠ¶æ€ã€èµ„æºåˆ©ç”¨ç‡ã€ç½‘ç»œæ€§èƒ½</li><li><strong>ä¸šåŠ¡çº§åˆ«</strong>ï¼šæ•°æ®å¤„ç†é‡ã€å¤„ç†å»¶è¿Ÿã€æ•°æ®è´¨é‡</li></ol><h4 id="è¿ç»´å·¥å…·"><a href="#è¿ç»´å·¥å…·" class="headerlink" title="è¿ç»´å·¥å…·"></a>è¿ç»´å·¥å…·</h4><ol><li><strong>Spark UI</strong>ï¼šå†…ç½®çš„Webç•Œé¢ï¼ŒæŸ¥çœ‹åº”ç”¨çŠ¶æ€</li><li><strong>Ganglia&#x2F;Nagios</strong>ï¼šç³»ç»Ÿçº§ç›‘æ§</li><li><strong>Prometheus + Grafana</strong>ï¼šç°ä»£åŒ–çš„ç›‘æ§æ–¹æ¡ˆ</li><li><strong>ELK Stack</strong>ï¼šæ—¥å¿—æ”¶é›†å’Œåˆ†æ</li></ol><h2 id="å®é™…æ¡ˆä¾‹åˆ†æ"><a href="#å®é™…æ¡ˆä¾‹åˆ†æ" class="headerlink" title="å®é™…æ¡ˆä¾‹åˆ†æ"></a>å®é™…æ¡ˆä¾‹åˆ†æ</h2><h3 id="æ¡ˆä¾‹ä¸€ï¼šç”µå•†æ•°æ®åˆ†æå¹³å°"><a href="#æ¡ˆä¾‹ä¸€ï¼šç”µå•†æ•°æ®åˆ†æå¹³å°" class="headerlink" title="æ¡ˆä¾‹ä¸€ï¼šç”µå•†æ•°æ®åˆ†æå¹³å°"></a>æ¡ˆä¾‹ä¸€ï¼šç”µå•†æ•°æ®åˆ†æå¹³å°</h3><p><strong>åœºæ™¯æè¿°</strong>ï¼šä¸€ä¸ªç”µå•†å¹³å°éœ€è¦åˆ†æç”¨æˆ·è¡Œä¸ºæ•°æ®ï¼Œå¤„ç†TBçº§åˆ«çš„æ•°æ®ã€‚</p><p><strong>æ¶æ„è®¾è®¡</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ç”µå•†æ•°æ®åˆ†ææ¶æ„:</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚   Webåº”ç”¨       â”‚    â”‚   Sparké›†ç¾¤     â”‚</span><br><span class="line">â”‚                 â”‚    â”‚                 â”‚</span><br><span class="line">â”‚ - ç”¨æˆ·è¡Œä¸ºæ”¶é›†  â”‚â”€â”€â”€â–¶â”‚ - å®æ—¶å¤„ç†      â”‚</span><br><span class="line">â”‚ - æ•°æ®é¢„å¤„ç†    â”‚    â”‚ - æ‰¹é‡åˆ†æ      â”‚</span><br><span class="line">â”‚ - ç»“æœå±•ç¤º      â”‚â—€â”€â”€â”€â”‚ - æœºå™¨å­¦ä¹       â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><p><strong>é…ç½®ä¼˜åŒ–</strong>ï¼š</p><ul><li>ä½¿ç”¨YARNä½œä¸ºé›†ç¾¤ç®¡ç†å™¨</li><li>é…ç½®åŠ¨æ€èµ„æºåˆ†é…</li><li>ä¼˜åŒ–Shuffleå‚æ•°</li><li>ä½¿ç”¨Kryoåºåˆ—åŒ–</li></ul><h3 id="æ¡ˆä¾‹äºŒï¼šå®æ—¶æ¨èç³»ç»Ÿ"><a href="#æ¡ˆä¾‹äºŒï¼šå®æ—¶æ¨èç³»ç»Ÿ" class="headerlink" title="æ¡ˆä¾‹äºŒï¼šå®æ—¶æ¨èç³»ç»Ÿ"></a>æ¡ˆä¾‹äºŒï¼šå®æ—¶æ¨èç³»ç»Ÿ</h3><p><strong>åœºæ™¯æè¿°</strong>ï¼šéœ€è¦å®æ—¶å¤„ç†ç”¨æˆ·è¡Œä¸ºï¼Œç”Ÿæˆä¸ªæ€§åŒ–æ¨èã€‚</p><p><strong>æ¶æ„è®¾è®¡</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">å®æ—¶æ¨èç³»ç»Ÿæ¶æ„:</span><br><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚   Kafka         â”‚    â”‚   Spark         â”‚</span><br><span class="line">â”‚                 â”‚    â”‚   Streaming     â”‚</span><br><span class="line">â”‚ - ç”¨æˆ·è¡Œä¸ºæµ    â”‚â”€â”€â”€â–¶â”‚ - å®æ—¶å¤„ç†      â”‚</span><br><span class="line">â”‚ - äº‹ä»¶æ”¶é›†      â”‚    â”‚ - çŠ¶æ€ç®¡ç†      â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">        â”‚                       â”‚</span><br><span class="line">        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">                Redis</span><br><span class="line">                - æ¨èç»“æœç¼“å­˜</span><br></pre></td></tr></table></figure><p><strong>æŠ€æœ¯è¦ç‚¹</strong>ï¼š</p><ul><li>ä½¿ç”¨Structured Streaming</li><li>é…ç½®çŠ¶æ€å­˜å‚¨</li><li>ä¼˜åŒ–çª—å£æ“ä½œ</li><li>å®ç°å®¹é”™æœºåˆ¶</li></ul><h3 id="æ¡ˆä¾‹ä¸‰ï¼šå¤æ‚æ•°æ®å¤„ç†ä¸­çš„Stageåˆ†æ"><a href="#æ¡ˆä¾‹ä¸‰ï¼šå¤æ‚æ•°æ®å¤„ç†ä¸­çš„Stageåˆ†æ" class="headerlink" title="æ¡ˆä¾‹ä¸‰ï¼šå¤æ‚æ•°æ®å¤„ç†ä¸­çš„Stageåˆ†æ"></a>æ¡ˆä¾‹ä¸‰ï¼šå¤æ‚æ•°æ®å¤„ç†ä¸­çš„Stageåˆ†æ</h3><p><strong>åœºæ™¯æè¿°</strong>ï¼šåˆ†æä¸€ä¸ªåŒ…å«å¤šä¸ªShuffleæ“ä½œçš„å¤æ‚æ•°æ®å¤„ç†æµç¨‹ï¼Œå±•ç¤ºStageçš„åˆ’åˆ†å’Œæ‰§è¡Œã€‚</p><p><strong>æ•°æ®å¤„ç†æµç¨‹</strong>ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> logs = sc.textFile(<span class="string">&quot;logs&quot;</span>)</span><br><span class="line">  .filter(_.contains(<span class="string">&quot;ERROR&quot;</span>))                    <span class="comment">// Stage 0</span></span><br><span class="line">  .map(parseLog)                                  <span class="comment">// Stage 0</span></span><br><span class="line">  .map(log =&gt; (log.service, log))                <span class="comment">// Stage 0</span></span><br><span class="line">  .groupByKey()                                   <span class="comment">// Stage 1 (Shuffle)</span></span><br><span class="line">  .mapValues(_.toList)                           <span class="comment">// Stage 1</span></span><br><span class="line">  .map &#123; <span class="keyword">case</span> (service, logs) =&gt;                 <span class="comment">// Stage 1</span></span><br><span class="line">    (service, logs.size, logs.map(_.timestamp).max)</span><br><span class="line">  &#125;</span><br><span class="line">  .sortBy(_._2, <span class="literal">false</span>)                           <span class="comment">// Stage 2 (Shuffle)</span></span><br><span class="line">  .take(<span class="number">10</span>)                                      <span class="comment">// Stage 3 (Result)</span></span><br></pre></td></tr></table></figure><p><strong>Stageåˆ’åˆ†åˆ†æ</strong>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Stage 0: æ•°æ®è¯»å–ä¸é¢„å¤„ç†</span><br><span class="line">â”œâ”€â”€ textFile: è¯»å–æ—¥å¿—æ–‡ä»¶</span><br><span class="line">â”œâ”€â”€ filter: è¿‡æ»¤é”™è¯¯æ—¥å¿—</span><br><span class="line">â”œâ”€â”€ map(parseLog): è§£ææ—¥å¿—æ ¼å¼</span><br><span class="line">â””â”€â”€ map: è½¬æ¢ä¸º(service, log)æ ¼å¼</span><br><span class="line"></span><br><span class="line">Stage 1: åˆ†ç»„èšåˆ</span><br><span class="line">â”œâ”€â”€ groupByKey: æŒ‰æœåŠ¡åˆ†ç»„ (Shuffle)</span><br><span class="line">â”œâ”€â”€ mapValues: è½¬æ¢ä¸ºåˆ—è¡¨æ ¼å¼</span><br><span class="line">â””â”€â”€ map: è®¡ç®—ç»Ÿè®¡ä¿¡æ¯</span><br><span class="line"></span><br><span class="line">Stage 2: æ’åº</span><br><span class="line">â””â”€â”€ sortBy: æŒ‰é”™è¯¯æ•°é‡æ’åº (Shuffle)</span><br><span class="line"></span><br><span class="line">Stage 3: ç»“æœæ”¶é›†</span><br><span class="line">â””â”€â”€ take: è·å–å‰10ä¸ªç»“æœ</span><br></pre></td></tr></table></figure><p><strong>æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</strong>ï¼š</p><ol><li><strong>å‡å°‘Shuffle</strong>ï¼šä½¿ç”¨<code>reduceByKey</code>æ›¿ä»£<code>groupByKey</code></li><li><strong>ä¼˜åŒ–åˆ†åŒº</strong>ï¼šæ ¹æ®æ•°æ®åˆ†å¸ƒè°ƒæ•´åˆ†åŒºæ•°</li><li><strong>ç¼“å­˜ä¸­é—´ç»“æœ</strong>ï¼šå¯¹é¢‘ç¹ä½¿ç”¨çš„RDDè¿›è¡Œç¼“å­˜</li><li><strong>æ•°æ®æœ¬åœ°æ€§</strong>ï¼šç¡®ä¿æ•°æ®åœ¨åˆé€‚çš„èŠ‚ç‚¹ä¸Šå¤„ç†</li></ol><h2 id="å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ"><a href="#å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ" class="headerlink" title="å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ"></a>å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ</h2><h3 id="é—®é¢˜ä¸€ï¼šExecutorå†…å­˜ä¸è¶³"><a href="#é—®é¢˜ä¸€ï¼šExecutorå†…å­˜ä¸è¶³" class="headerlink" title="é—®é¢˜ä¸€ï¼šExecutorå†…å­˜ä¸è¶³"></a>é—®é¢˜ä¸€ï¼šExecutorå†…å­˜ä¸è¶³</h3><p><strong>ç—‡çŠ¶</strong>ï¼šé¢‘ç¹å‡ºç°OutOfMemoryErrorï¼Œä»»åŠ¡å¤±è´¥ç‡é«˜ã€‚</p><p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p><ol><li>å¢åŠ Executorå†…å­˜é…ç½®</li><li>ä¼˜åŒ–æ•°æ®ç»“æ„ï¼Œå‡å°‘å†…å­˜ä½¿ç”¨</li><li>è°ƒæ•´ç¼“å­˜ç­–ç•¥</li><li>ä½¿ç”¨å¹¿æ’­å˜é‡å‡å°‘æ•°æ®ä¼ è¾“</li></ol><h3 id="é—®é¢˜äºŒï¼šæ•°æ®å€¾æ–œ"><a href="#é—®é¢˜äºŒï¼šæ•°æ®å€¾æ–œ" class="headerlink" title="é—®é¢˜äºŒï¼šæ•°æ®å€¾æ–œ"></a>é—®é¢˜äºŒï¼šæ•°æ®å€¾æ–œ</h3><p><strong>ç—‡çŠ¶</strong>ï¼šæŸäº›ä»»åŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œæ•´ä½“æ€§èƒ½ä¸‹é™ã€‚</p><p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p><ol><li>ä½¿ç”¨è‡ªå®šä¹‰åˆ†åŒºå™¨</li><li>å¯¹å€¾æ–œæ•°æ®è¿›è¡Œé¢„å¤„ç†</li><li>ä½¿ç”¨ä¸¤é˜¶æ®µèšåˆ</li><li>è°ƒæ•´å¹¶è¡Œåº¦</li></ol><h3 id="é—®é¢˜ä¸‰ï¼šç½‘ç»œä¼ è¾“ç“¶é¢ˆ"><a href="#é—®é¢˜ä¸‰ï¼šç½‘ç»œä¼ è¾“ç“¶é¢ˆ" class="headerlink" title="é—®é¢˜ä¸‰ï¼šç½‘ç»œä¼ è¾“ç“¶é¢ˆ"></a>é—®é¢˜ä¸‰ï¼šç½‘ç»œä¼ è¾“ç“¶é¢ˆ</h3><p><strong>ç—‡çŠ¶</strong>ï¼šShuffleé˜¶æ®µè€—æ—¶è¿‡é•¿ï¼Œç½‘ç»œåˆ©ç”¨ç‡ä½ã€‚</p><p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p><ol><li>ä¼˜åŒ–ç½‘ç»œé…ç½®</li><li>ä½¿ç”¨æ•°æ®æœ¬åœ°æ€§</li><li>è°ƒæ•´Shuffleå‚æ•°</li><li>ä½¿ç”¨å‹ç¼©å‡å°‘ä¼ è¾“é‡</li></ol><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>Sparké›†ç¾¤æ¶æ„çš„è®¾è®¡ä½“ç°äº†åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡çš„ç²¾é«“ï¼š<strong>èŒè´£åˆ†ç¦»ã€æ¾è€¦åˆã€é«˜å¯ç”¨</strong>ã€‚æ¯ä¸ªç»„ä»¶éƒ½æœ‰æ˜ç¡®çš„èŒè´£ï¼Œé€šè¿‡æ ‡å‡†åŒ–çš„æ¥å£è¿›è¡Œåä½œï¼Œè¿™ç§è®¾è®¡ä½¿å¾—Sparkèƒ½å¤Ÿçµæ´»åœ°é€‚åº”ä¸åŒçš„éƒ¨ç½²ç¯å¢ƒã€‚</p><p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œç†è§£è¿™äº›ç»„ä»¶çš„èŒè´£å’Œåä½œæœºåˆ¶ï¼Œå¯¹äºæ€§èƒ½è°ƒä¼˜å’Œé—®é¢˜æ’æŸ¥è‡³å…³é‡è¦ã€‚é€šè¿‡åˆç†çš„é…ç½®å’Œä¼˜åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥å……åˆ†å‘æŒ¥Sparké›†ç¾¤çš„è®¡ç®—èƒ½åŠ›ï¼Œå¤„ç†å¤§è§„æ¨¡æ•°æ®ï¼Œæ”¯æ’‘å¤æ‚çš„ä¸šåŠ¡éœ€æ±‚ã€‚</p><p>è®°ä½ï¼ŒæŠ€æœ¯æ¶æ„ä¸æ˜¯ä¸€æˆä¸å˜çš„ï¼Œéšç€ä¸šåŠ¡éœ€æ±‚çš„å˜åŒ–å’ŒæŠ€æœ¯çš„å‘å±•ï¼Œæˆ‘ä»¬éœ€è¦ä¸æ–­åœ°è°ƒæ•´å’Œä¼˜åŒ–ã€‚åªæœ‰æ·±å…¥ç†è§£åŸç†ï¼Œæ‰èƒ½åœ¨å˜åŒ–ä¸­ä¿æŒç«äº‰åŠ›ã€‚</p><hr><p><em>æœ¬æ–‡æ˜¯SparkæŠ€æœ¯ä¸“æ çš„ä¸€éƒ¨åˆ†ï¼Œåç»­å°†ç»§ç»­æ·±å…¥æ¢è®¨Sparkçš„å…¶ä»–æ ¸å¿ƒç‰¹æ€§ã€‚å¦‚æœä½ å¯¹æŸä¸ªç‰¹å®šæ–¹é¢æ„Ÿå…´è¶£ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºè®¨è®ºã€‚</em> </p>]]></content>
      
      
      <categories>
          
          <category> å¤§æ•°æ® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spark </tag>
            
            <tag> å¤§æ•°æ® </tag>
            
            <tag> åˆ†å¸ƒå¼è®¡ç®— </tag>
            
            <tag> é›†ç¾¤æ¶æ„ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è¶…ç»æ’å›¾ç½‘ç«™æ¨è</title>
      <link href="/2024/12/23/%E8%B6%85%E7%BB%9D%E6%8F%92%E5%9B%BE%E7%BD%91%E7%AB%99%E6%8E%A8%E8%8D%90/"/>
      <url>/2024/12/23/%E8%B6%85%E7%BB%9D%E6%8F%92%E5%9B%BE%E7%BD%91%E7%AB%99%E6%8E%A8%E8%8D%90/</url>
      
        <content type="html"><![CDATA[<p>ç›¸ä¿¡å¾ˆå¤šå°ä¼™ä¼´ï¼Œéƒ½è®¤è¯†åˆ°ä¸€ä¸ªå¥½çš„æ’å›¾ï¼Œå¯¹ç½‘ç«™&#x2F;app æˆ–è€…åšå®¢æ–‡ç« çš„é‡è¦æ€§äº†ã€‚æˆ‘å¸¸å¸¸ä¹Ÿéœ€è¦ä¸€äº›é«˜è´¨é‡æœ‰åˆ›æ„çš„æ’å›¾ï¼Œæ¥è£…é¥°ç½‘ç«™æˆ–appï¼Œè®©æ•´ä½“çœ‹èµ·æ¥éå¸¸å¾—åŠ²ã€‚è¿™é‡Œæ¨èå‡ ä¸ªæˆ‘è‡ªå·±ç”¨çš„</p><ul><li><p>pinterest</p><p>ç½‘ç«™åœ°å€ï¼š<a href="https://www.pinterest.com/%EF%BC%8C%E5%85%8D%E8%B4%B9%E6%B3%A8%E5%86%8C%E5%92%8C%E4%B8%8B%E8%BD%BD%E5%8E%9F%E5%9B%BE">https://www.pinterest.com/ï¼Œå…è´¹æ³¨å†Œå’Œä¸‹è½½åŸå›¾</a></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> å‰ç«¯ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>macå®‰è£… picgo æŠ¥é”™ æ–‡ä»¶æŸå</title>
      <link href="/2024/12/22/mac%E5%AE%89%E8%A3%85%20picgo%20%E6%8A%A5%E9%94%99%20%E6%96%87%E4%BB%B6%E6%8D%9F%E5%9D%8F/"/>
      <url>/2024/12/22/mac%E5%AE%89%E8%A3%85%20picgo%20%E6%8A%A5%E9%94%99%20%E6%96%87%E4%BB%B6%E6%8D%9F%E5%9D%8F/</url>
      
        <content type="html"><![CDATA[<h1 id="macå®‰è£…-picgo-æŠ¥é”™-æ–‡ä»¶æŸå"><a href="#macå®‰è£…-picgo-æŠ¥é”™-æ–‡ä»¶æŸå" class="headerlink" title="macå®‰è£… picgo æŠ¥é”™ æ–‡ä»¶æŸå"></a>macå®‰è£… picgo æŠ¥é”™ æ–‡ä»¶æŸå</h1><p>picgoä¸‹è½½åœ°å€ï¼š<a href="https://github.com/molunerfinn/picgo/releases">https://github.com/molunerfinn/picgo/releases</a></p><p>macå®‰è£…æŠ¥é”™ä¸æ˜¯å› ä¸º picgoç‰ˆæœ¬é—®é¢˜ã€‚è€Œæ˜¯macçš„åŸå› ï¼š<br>è‹¹æœè‡ªmacOS Sierra 10.12ç‰ˆæœ¬èµ·ï¼Œå»é™¤äº†å…è®¸â€œä»»ä½•æ¥æºâ€çš„é€‰é¡¹ï¼ˆå‚è€ƒè‹¹æœå®˜æ–¹æ–‡æ¡£å…³äºç³»ç»Ÿå®‰å…¨æ€§ä¸éšç§è®¾ç½®éƒ¨åˆ†ï¼Œå…·ä½“é“¾æ¥ï¼šè‹¹æœå®˜æ–¹æ–‡æ¡£ç›¸å…³é¡µé¢ ï¼‰ã€‚è¿™ä¸€ç³»ç»Ÿå®‰å…¨ç­–ç•¥å˜åŒ–ï¼Œä½¿å¾—åƒPicGoè¿™æ ·çš„ç¬¬ä¸‰æ–¹æœªè®¤è¯è½¯ä»¶å—åˆ°é™åˆ¶ï¼Œå³ä¾¿è½¯ä»¶æœ¬èº«æœªæŸåï¼Œä¹Ÿå¯èƒ½å› æ¥æºæœªè¢«ç³»ç»Ÿè®¤å¯è€Œæ— æ³•æ­£å¸¸æ‰“å¼€</p><p>è§£å†³åŠæ³•ï¼š</p><ol><li>ç»™æ–‡ä»¶èµ‹äºˆå®‰å…¨æ€§è®¾ç½®ï¼š<br>é¦–å…ˆï¼Œåœ¨â€œè®¿è¾¾â€ï¼ˆFinderï¼‰ä¸­è¿›å…¥â€œåº”ç”¨ç¨‹åºâ€ç›®å½•ï¼Œå°†PicGoè½¯ä»¶å›¾æ ‡æ‹–è‡³ç»ˆç«¯çª—å£ï¼Œè·å–å…¶å®Œæ•´è·¯å¾„ã€‚ç„¶åï¼Œåœ¨ç»ˆç«¯æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼ˆè¿™é‡Œè½¯ä»¶è·¯å¾„ä¸º&#x2F;Applications&#x2F;PicGo.appï¼‰ï¼š<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo xattr -r -d com.apple.quarantine /Applications/PicGo.app</span><br></pre></td></tr></table></figure></li></ol>]]></content>
      
      
      <categories>
          
          <category> ç¯å¢ƒé—®é¢˜ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>è®¡ç®—æœºç½‘ç»œæ ¸å¿ƒæ¦‚å¿µä¸²çƒ§</title>
      <link href="/2024/07/26/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E4%B8%B2%E7%83%A7/"/>
      <url>/2024/07/26/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E4%B8%B2%E7%83%A7/</url>
      
        <content type="html"><![CDATA[<h1 id="è®¡ç®—æœºç½‘ç»œæ ¸å¿ƒæ¦‚å¿µä¸²çƒ§"><a href="#è®¡ç®—æœºç½‘ç»œæ ¸å¿ƒæ¦‚å¿µä¸²çƒ§" class="headerlink" title="è®¡ç®—æœºç½‘ç»œæ ¸å¿ƒæ¦‚å¿µä¸²çƒ§"></a>è®¡ç®—æœºç½‘ç»œæ ¸å¿ƒæ¦‚å¿µä¸²çƒ§</h1><p>åœ¨å­¦ä¹ è½¯è€ƒçš„æ—¶å€™ï¼Œå‘ç°å¯¹äºè®¡ç®—æœºç½‘ç»œæœ‰äº›æ¦‚å¿µéƒ½æœ‰ç‚¹é—å¿˜äº†ã€‚æ‰€ä»¥è¿™é‡Œç‰¹æ„å°†ä¸€äº›æ ¸å¿ƒæ¦‚å¿µé€šè¿‡ä¸€ä¸ªç¤ºä¾‹ä¸²è”èµ·æ¥ï¼Œæ–¹ä¾¿ç†è§£å’Œè®°å¿†ã€‚</p><p>æˆ‘ä»¥â€œè®¾å¤‡è®¿é—®æŸä¸ªåŸŸåï¼ˆå¦‚<code>www.baidu.com</code>ï¼‰â€ çš„å…¨è¿‡ç¨‹ä¸ºä¾‹å­ï¼Œæ²¿ç€ â€œ<strong>ç»ˆç«¯èº«ä»½é…ç½®â†’DNS è§£æï¼ˆåŸŸåè½¬ IPï¼‰â†’å±€åŸŸç½‘å†…è½¬å‘â†’è·¨ç½‘åˆ°å…¬ç½‘â†’å…¬ç½‘è·¯ç”±ä¼ è¾“â†’ç›®æ ‡æœåŠ¡å™¨å“åº”</strong>â€ çš„å®Œæ•´é“¾è·¯æ‹†è§£ï¼ŒåŒæ—¶ä¸²è” DHCPã€DNSã€IPã€MACã€ARPã€è·¯ç”±å™¨è½¬å‘ç­‰æ ¸å¿ƒæ¦‚å¿µã€‚</p><h2 id="1-ä¸»è¦ç¤ºä¾‹"><a href="#1-ä¸»è¦ç¤ºä¾‹" class="headerlink" title="1.ä¸»è¦ç¤ºä¾‹"></a>1.ä¸»è¦ç¤ºä¾‹</h2><p>ä¸‹é¢ä»¥ â€œå®¶ç”¨ç”µè„‘é€šè¿‡ Wi-Fi è®¿é—®<code>www.baidu.com</code>â€ ä¸ºä¾‹</p><h3 id="å‰ç½®ï¼šç”µè„‘é€šè¿‡-DHCP-è·å–å±€åŸŸç½‘èº«ä»½ï¼ˆä¸Šç½‘åŸºç¡€ï¼‰"><a href="#å‰ç½®ï¼šç”µè„‘é€šè¿‡-DHCP-è·å–å±€åŸŸç½‘èº«ä»½ï¼ˆä¸Šç½‘åŸºç¡€ï¼‰" class="headerlink" title="å‰ç½®ï¼šç”µè„‘é€šè¿‡ DHCP è·å–å±€åŸŸç½‘èº«ä»½ï¼ˆä¸Šç½‘åŸºç¡€ï¼‰"></a>å‰ç½®ï¼šç”µè„‘é€šè¿‡ DHCP è·å–å±€åŸŸç½‘èº«ä»½ï¼ˆä¸Šç½‘åŸºç¡€ï¼‰</h3><p>ç”µè„‘åˆšè¿æ¥å®¶åº­ Wi-Fi æ—¶ï¼Œæ—  IP åœ°å€ï¼Œéœ€é€šè¿‡<strong>DHCPï¼ˆåŠ¨æ€ä¸»æœºé…ç½®åè®®ï¼‰</strong> ä»è·¯ç”±å™¨è·å– â€œå±€åŸŸç½‘é€šä¿¡èµ„æ ¼â€ï¼š</p><ol><li>ç”µè„‘å‘å±€åŸŸç½‘å¹¿æ’­ â€œDHCP å‘ç°æŠ¥æ–‡â€ï¼ˆç›®æ ‡ MACï¼šFF:FF:FF:FF:FF:FFï¼Œç›®æ ‡ IPï¼š255.255.255.255ï¼‰ï¼Œè¯¢é—® â€œè°èƒ½åˆ†é… IPï¼Ÿâ€ï¼›</li><li>å®¶åº­è·¯ç”±å™¨ï¼ˆé»˜è®¤å¼€å¯ DHCP æœåŠ¡ï¼‰æ”¶åˆ°è¯·æ±‚åï¼Œå•æ’­å›å¤ â€œDHCP æä¾›æŠ¥æ–‡â€ï¼ŒåŒ…å«æ ¸å¿ƒé…ç½®ï¼š<ul><li>å±€åŸŸç½‘ IPï¼š192.168.1.100ï¼ˆç”µè„‘çš„ â€œå±€åŸŸç½‘èº«ä»½è¯â€ï¼‰ï¼›</li><li>å­ç½‘æ©ç ï¼š255.255.255.0ï¼ˆåˆ¤æ–­ç›®æ ‡ IP æ˜¯å¦åœ¨åŒä¸€å±€åŸŸç½‘ï¼‰ï¼›</li><li>ç½‘å…³ IPï¼š192.168.1.1ï¼ˆå®¶åº­è·¯ç”±å™¨ LAN å£ IPï¼Œå±€åŸŸç½‘é€šå¾€å…¬ç½‘çš„ â€œå¤§é—¨â€ï¼‰ï¼›</li><li>DNS æœåŠ¡å™¨ IPï¼š202.97.224.68ï¼ˆè¿è¥å•†æä¾›çš„ DNSï¼Œç”¨äºè§£æåŸŸåï¼‰ï¼›</li></ul></li><li>ç”µè„‘ç¡®è®¤é…ç½®åï¼Œè·¯ç”±å™¨å‘é€ â€œDHCP ç¡®è®¤æŠ¥æ–‡â€ï¼Œç”µè„‘ç½‘ç»œé…ç½®ç”Ÿæ•ˆ â€”â€” æ­¤æ—¶å…·å¤‡ â€œå‘èµ·ç½‘ç»œè¯·æ±‚çš„åŸºç¡€â€ã€‚</li></ol><h3 id="æ­¥éª¤-1ï¼šç”µè„‘å‘èµ·-DNS-è¯·æ±‚ï¼ˆåŸŸåâ†’IP-çš„-â€œç¿»è¯‘â€ï¼‰"><a href="#æ­¥éª¤-1ï¼šç”µè„‘å‘èµ·-DNS-è¯·æ±‚ï¼ˆåŸŸåâ†’IP-çš„-â€œç¿»è¯‘â€ï¼‰" class="headerlink" title="æ­¥éª¤ 1ï¼šç”µè„‘å‘èµ· DNS è¯·æ±‚ï¼ˆåŸŸåâ†’IP çš„ â€œç¿»è¯‘â€ï¼‰"></a>æ­¥éª¤ 1ï¼šç”µè„‘å‘èµ· DNS è¯·æ±‚ï¼ˆåŸŸåâ†’IP çš„ â€œç¿»è¯‘â€ï¼‰</h3><p>åœ¨æµè§ˆå™¨è¾“å…¥<a href="https://www.baidu.com/">www.baidu.com</a>åï¼Œç”µè„‘éœ€å…ˆé€šè¿‡<strong>DNS åè®®</strong>å°†åŸŸåè½¬ä¸ºå…¬ç½‘ IPï¼š</p><ol><li><p>ç”µè„‘åˆ¤æ–­ DNS æœåŠ¡å™¨ä½ç½®ï¼šDNS æœåŠ¡å™¨ IPï¼ˆ202.97.224.68ï¼‰ä¸è‡ªèº«å±€åŸŸç½‘ IPï¼ˆ192.168.1.100ï¼‰ä¸åœ¨åŒä¸€ç½‘æ®µï¼ˆå­ç½‘æ©ç  255.255.255.0ï¼Œå‰è€…å±äº 202.97.224.0 æ®µï¼Œåè€…å±äº 192.168.1.0 æ®µï¼‰ï¼Œå› æ­¤éœ€é€šè¿‡<strong>ç½‘å…³ï¼ˆ192.168.1.1ï¼‰</strong> è½¬å‘ DNS è¯·æ±‚åˆ°å…¬ç½‘ï¼›</p></li><li><p>å°è£… DNS è¯·æ±‚åŒ…ï¼šç”µè„‘æ„é€  UDP åè®®çš„ DNS æŸ¥è¯¢åŒ…ï¼ˆç«¯å£ 53ï¼‰ï¼Œå†…å®¹ä¸º â€œæŸ¥è¯¢</p><p><a href="http://www.baidu.com/">www.baidu.com</a></p><p>çš„ A è®°å½•ï¼ˆIP åœ°å€ï¼‰â€ï¼ŒåŒ…çš„ä¸¤å±‚åœ°å€ç»“æ„å¦‚ä¸‹ï¼š</p><ul><li><strong>IP å±‚</strong>ï¼šæº IP&#x3D;192.168.1.100ï¼ˆç”µè„‘ï¼‰ï¼Œç›®æ ‡ IP&#x3D;202.97.224.68ï¼ˆDNS æœåŠ¡å™¨ï¼‰ï¼›</li><li><strong>ä»¥å¤ªç½‘å¸§å±‚</strong>ï¼šæº MAC&#x3D;00:1A:2B:3C:4D:5Eï¼ˆç”µè„‘ç½‘å¡ MACï¼‰ï¼Œç›®æ ‡ MAC&#x3D;ï¼Ÿï¼ˆéœ€é€šè¿‡ ARP è·å–ç½‘å…³ MACï¼‰ã€‚</li></ul></li></ol><h3 id="æ­¥éª¤-2ï¼šé€šè¿‡-ARP-è·å–ç½‘å…³-MACï¼ˆå±€åŸŸç½‘å†…-â€œæ‰¾ä¸‹ä¸€è·³â€ï¼‰"><a href="#æ­¥éª¤-2ï¼šé€šè¿‡-ARP-è·å–ç½‘å…³-MACï¼ˆå±€åŸŸç½‘å†…-â€œæ‰¾ä¸‹ä¸€è·³â€ï¼‰" class="headerlink" title="æ­¥éª¤ 2ï¼šé€šè¿‡ ARP è·å–ç½‘å…³ MACï¼ˆå±€åŸŸç½‘å†… â€œæ‰¾ä¸‹ä¸€è·³â€ï¼‰"></a>æ­¥éª¤ 2ï¼šé€šè¿‡ ARP è·å–ç½‘å…³ MACï¼ˆå±€åŸŸç½‘å†… â€œæ‰¾ä¸‹ä¸€è·³â€ï¼‰</h3><p>å±€åŸŸç½‘å†…æ•°æ®ä¼ è¾“ä¾èµ–<strong>MAC åœ°å€</strong>ï¼ˆä»¥å¤ªç½‘å¸§å¿…é¡»æŒ‡å®šç›®æ ‡ MAC æ‰èƒ½è½¬å‘ï¼‰ï¼Œç”µè„‘éœ€é€šè¿‡<strong>ARP åè®®</strong>è·å–ç½‘å…³ï¼ˆ192.168.1.1ï¼‰çš„ MACï¼š</p><ol><li>ç”µè„‘æŸ¥è¯¢æœ¬åœ° â€œARP ç¼“å­˜è¡¨â€ï¼Œå‘ç°æ—  192.168.1.1 å¯¹åº”çš„ MACï¼Œäºæ˜¯å‘å±€åŸŸç½‘å¹¿æ’­ â€œARP è¯·æ±‚å¸§â€ï¼ˆç›®æ ‡ MACï¼šFF:FF:FF:FF:FF:FFï¼‰ï¼Œå†…å®¹ä¸º â€œè°æ˜¯ 192.168.1.1ï¼Ÿè¯·å›å¤ä½ çš„ MAC åœ°å€ï¼â€ï¼›</li><li>å®¶åº­è·¯ç”±å™¨ï¼ˆç½‘å…³ï¼‰æ”¶åˆ°å¹¿æ’­åï¼Œè¯†åˆ«åˆ°è¯·æ±‚ IP æ˜¯è‡ªèº« LAN å£ IPï¼Œäºæ˜¯å•æ’­å›å¤ â€œARP å“åº”å¸§â€ï¼Œå†…å®¹ä¸º â€œæˆ‘æ˜¯ 192.168.1.1ï¼Œæˆ‘çš„ MAC æ˜¯ 00:AA:BB:CC:DD:EEï¼ˆè·¯ç”±å™¨ LAN å£ MACï¼‰â€ï¼›</li><li>ç”µè„‘å°† â€œ192.168.1.1â†’00:AA:BB:CC:DD:EEâ€ å­˜å…¥ ARP ç¼“å­˜è¡¨ï¼ˆæœ‰æ•ˆæœŸ 15 åˆ†é’Ÿï¼‰ï¼Œåç»­ç»™ç½‘å…³å‘æ•°æ®æ— éœ€é‡å¤è¯·æ±‚ã€‚</li></ol><h3 id="æ­¥éª¤-3ï¼šå±€åŸŸç½‘è½¬å‘-DNS-è¯·æ±‚åˆ°å®¶åº­è·¯ç”±å™¨ï¼ˆç½‘å…³ï¼‰"><a href="#æ­¥éª¤-3ï¼šå±€åŸŸç½‘è½¬å‘-DNS-è¯·æ±‚åˆ°å®¶åº­è·¯ç”±å™¨ï¼ˆç½‘å…³ï¼‰" class="headerlink" title="æ­¥éª¤ 3ï¼šå±€åŸŸç½‘è½¬å‘ DNS è¯·æ±‚åˆ°å®¶åº­è·¯ç”±å™¨ï¼ˆç½‘å…³ï¼‰"></a>æ­¥éª¤ 3ï¼šå±€åŸŸç½‘è½¬å‘ DNS è¯·æ±‚åˆ°å®¶åº­è·¯ç”±å™¨ï¼ˆç½‘å…³ï¼‰</h3><p>ç”µè„‘è¡¥å…¨ä»¥å¤ªç½‘å¸§çš„ç›®æ ‡ MAC åï¼Œå°† DNS è¯·æ±‚åŒ…é€šè¿‡ Wi-Fi å‘é€ç»™å®¶åº­è·¯ç”±å™¨ï¼š</p><ol><li>ç”µè„‘æ— çº¿ç½‘å¡å‘é€å¸§ï¼šæº MAC &#x3D; ç”µè„‘ MACï¼Œç›®æ ‡ MAC &#x3D; ç½‘å…³ LAN å£ MACï¼Œå¸§å†…å°è£… DNS æŸ¥è¯¢çš„ IP æ•°æ®åŒ…ï¼›</li><li>å®¶åº­è·¯ç”±å™¨æ¥æ”¶å¹¶è§£åŒ…ï¼šè·¯ç”±å™¨ LAN å£æ”¶åˆ°å¸§åï¼Œæ£€æŸ¥ç›®æ ‡ MAC æ˜¯è‡ªèº« LAN å£ MACï¼Œäºæ˜¯è§£åŒ…å–å‡º IP æ•°æ®åŒ…ï¼ˆç›®æ ‡ IP&#x3D;202.97.224.68ï¼‰ï¼›</li><li>ç½‘å…³åˆ¤æ–­è½¬å‘æ–¹å‘ï¼šè·¯ç”±å™¨æŸ¥çœ‹ IP æ•°æ®åŒ…çš„ç›®æ ‡ IPï¼Œç¡®è®¤ä¸åœ¨å±€åŸŸç½‘ï¼ˆ192.168.1.0 æ®µï¼‰ï¼Œå› æ­¤éœ€é€šè¿‡<strong>WAN å£è½¬å‘åˆ°å…¬ç½‘</strong>ï¼Œå¹¶è§¦å‘ NAT è½¬æ¢ã€‚</li></ol><h3 id="æ­¥éª¤-4ï¼šå®¶åº­è·¯ç”±å™¨é€šè¿‡-NAT-è½¬æ¢ï¼Œå°†è¯·æ±‚å‘å¾€å…¬ç½‘æ¥å…¥è·¯ç”±å™¨"><a href="#æ­¥éª¤-4ï¼šå®¶åº­è·¯ç”±å™¨é€šè¿‡-NAT-è½¬æ¢ï¼Œå°†è¯·æ±‚å‘å¾€å…¬ç½‘æ¥å…¥è·¯ç”±å™¨" class="headerlink" title="æ­¥éª¤ 4ï¼šå®¶åº­è·¯ç”±å™¨é€šè¿‡ NAT è½¬æ¢ï¼Œå°†è¯·æ±‚å‘å¾€å…¬ç½‘æ¥å…¥è·¯ç”±å™¨"></a>æ­¥éª¤ 4ï¼šå®¶åº­è·¯ç”±å™¨é€šè¿‡ NAT è½¬æ¢ï¼Œå°†è¯·æ±‚å‘å¾€å…¬ç½‘æ¥å…¥è·¯ç”±å™¨</h3><p>å®¶ç”¨ç½‘ç»œé€šå¸¸åªæœ‰ 1 ä¸ª<strong>å…¬ç½‘ IP</strong>ï¼ˆç”±è¿è¥å•†åˆ†é…ï¼Œå¦‚ 120.204.197.5ï¼‰ï¼Œéœ€é€šè¿‡<strong>NATï¼ˆç½‘ç»œåœ°å€è½¬æ¢ï¼‰</strong> å°† â€œå±€åŸŸç½‘ IPâ€ è½¬ä¸º â€œå…¬ç½‘ IPâ€ï¼Œæ‰èƒ½åœ¨å…¬ç½‘ä¼ è¾“ï¼š</p><ol><li>NAT åœ°å€è½¬æ¢ï¼šè·¯ç”±å™¨ä¿®æ”¹ IP æ•°æ®åŒ…çš„ â€œæº IPâ€â€”â€” ä» 192.168.1.100ï¼ˆå±€åŸŸç½‘ IPï¼Œå…¬ç½‘ä¸å¯è§ï¼‰æ”¹ä¸º 120.204.197.5ï¼ˆè·¯ç”±å™¨ WAN å£å…¬ç½‘ IPï¼‰ï¼›åŒæ—¶åœ¨ â€œNAT æ˜ å°„è¡¨â€ ä¸­è®°å½•ï¼šâ€œ192.168.1.100:54321ï¼ˆç”µè„‘éšæœºç«¯å£ï¼‰â†’120.204.197.5:67890ï¼ˆè·¯ç”±å™¨ WAN å£ç«¯å£ï¼‰â€ï¼Œç”¨äºåç»­æ¥æ”¶ DNS åº”ç­”æ—¶ â€œæ‰¾åˆ°å¯¹åº”çš„ç”µè„‘â€ï¼›</li><li>è·å–å…¬ç½‘ä¸‹ä¸€è·³ MACï¼šè·¯ç”±å™¨ WAN å£éœ€å°†æ•°æ®åŒ…å‘ç»™ â€œè¿è¥å•†çš„å…¬ç½‘æ¥å…¥è·¯ç”±å™¨â€ï¼ˆå¦‚å°åŒºå®½å¸¦çš„æ¥å…¥è·¯ç”±å™¨ï¼ŒIPï¼š10.100.0.1ï¼‰ï¼Œå› æ­¤é€šè¿‡ WAN å£çš„ ARP è¯·æ±‚ï¼ˆä»…åœ¨ â€œè·¯ç”±å™¨ WAN å£ä¸è¿è¥å•†æ¥å…¥è·¯ç”±å™¨æ„æˆçš„å°å±€åŸŸç½‘â€ å†…å¹¿æ’­ï¼‰è·å–å…¶ MACï¼ˆå¦‚ 00:CC:DD:EE:FF:AAï¼‰ï¼›</li><li>å‘é€åˆ°å…¬ç½‘ï¼šè·¯ç”±å™¨ WAN å£å°è£…ä»¥å¤ªç½‘å¸§ï¼ˆæº MAC &#x3D; è·¯ç”±å™¨ WAN å£ MACï¼Œç›®æ ‡ MAC &#x3D; è¿è¥å•†æ¥å…¥è·¯ç”±å™¨ MACï¼‰ï¼Œå°† DNS è¯·æ±‚åŒ…é€šè¿‡å…‰çº¤ &#x2F; ç½‘çº¿å‘é€åˆ°<strong>å…¬ç½‘æ¥å…¥å±‚è·¯ç”±å™¨</strong>ï¼ˆè¿è¥å•†å°åŒºæ¥å…¥è·¯ç”±å™¨ï¼‰ã€‚</li></ol><h3 id="æ­¥éª¤-5ï¼šå…¬ç½‘æ¥å…¥å±‚è·¯ç”±å™¨è½¬å‘-DNS-è¯·æ±‚åˆ°æ±‡èšå±‚è·¯ç”±å™¨"><a href="#æ­¥éª¤-5ï¼šå…¬ç½‘æ¥å…¥å±‚è·¯ç”±å™¨è½¬å‘-DNS-è¯·æ±‚åˆ°æ±‡èšå±‚è·¯ç”±å™¨" class="headerlink" title="æ­¥éª¤ 5ï¼šå…¬ç½‘æ¥å…¥å±‚è·¯ç”±å™¨è½¬å‘ DNS è¯·æ±‚åˆ°æ±‡èšå±‚è·¯ç”±å™¨"></a>æ­¥éª¤ 5ï¼šå…¬ç½‘æ¥å…¥å±‚è·¯ç”±å™¨è½¬å‘ DNS è¯·æ±‚åˆ°æ±‡èšå±‚è·¯ç”±å™¨</h3><p>å…¬ç½‘ç¬¬ä¸€å±‚è½¬å‘ï¼š<strong>æ¥å…¥å±‚è·¯ç”±å™¨</strong>ï¼ˆè¦†ç›–å°åŒº &#x2F; ä¼ä¸šï¼ŒåŠŸèƒ½æ˜¯ â€œæ±‡æ€»ç”¨æˆ·ç»ˆç«¯æµé‡ï¼Œè½¬å‘åˆ°æ±‡èšå±‚â€ï¼‰ï¼š</p><ol><li>æ¥å…¥å±‚è·¯ç”±å™¨ï¼ˆIPï¼š10.100.0.1ï¼‰æ”¶åˆ° DNS è¯·æ±‚åŒ…åï¼Œè§£åŒ…æŸ¥çœ‹ç›®æ ‡ IP&#x3D;202.97.224.68ï¼ˆDNS æœåŠ¡å™¨ï¼‰ï¼›</li><li>æŸ¥è¯¢è‡ªèº« â€œè·¯ç”±è¡¨â€ï¼šè·¯ç”±è¡¨ä¸­è®°å½• â€œ202.97.224.0&#x2F;24 ç½‘æ®µï¼ˆDNS æœåŠ¡å™¨æ‰€åœ¨ç½‘æ®µï¼‰çš„ä¸‹ä¸€è·³æ˜¯å¸‚æ±‡èšå±‚è·¯ç”±å™¨ï¼ŒIPï¼š10.200.0.1â€ï¼›</li><li>è½¬å‘åˆ°æ±‡èšå±‚ï¼šæ¥å…¥å±‚è·¯ç”±å™¨é€šè¿‡å¹¿åŸŸç½‘é“¾è·¯ï¼ˆå¦‚åŸåŸŸç½‘å…‰çº¤ï¼‰å°†æ•°æ®åŒ…å‘ç»™<strong>å¸‚æ±‡èšå±‚è·¯ç”±å™¨</strong>ï¼ˆIPï¼š10.200.0.1ï¼‰â€”â€” æ³¨æ„ï¼šå…¬ç½‘è·¯ç”±å™¨é—´é€šä¿¡ç”¨ â€œå¹¿åŸŸç½‘æŠ€æœ¯ï¼ˆå¦‚ MPLSï¼‰â€ï¼Œæ—  MAC åœ°å€ï¼Œç›´æ¥é€šè¿‡ â€œä¸‹ä¸€è·³ IPâ€ è½¬å‘ï¼Œæ— éœ€ ARPã€‚</li></ol><h3 id="æ­¥éª¤-6ï¼šå…¬ç½‘æ±‡èšå±‚è·¯ç”±å™¨è½¬å‘-DNS-è¯·æ±‚åˆ°æ ¸å¿ƒå±‚è·¯ç”±å™¨"><a href="#æ­¥éª¤-6ï¼šå…¬ç½‘æ±‡èšå±‚è·¯ç”±å™¨è½¬å‘-DNS-è¯·æ±‚åˆ°æ ¸å¿ƒå±‚è·¯ç”±å™¨" class="headerlink" title="æ­¥éª¤ 6ï¼šå…¬ç½‘æ±‡èšå±‚è·¯ç”±å™¨è½¬å‘ DNS è¯·æ±‚åˆ°æ ¸å¿ƒå±‚è·¯ç”±å™¨"></a>æ­¥éª¤ 6ï¼šå…¬ç½‘æ±‡èšå±‚è·¯ç”±å™¨è½¬å‘ DNS è¯·æ±‚åˆ°æ ¸å¿ƒå±‚è·¯ç”±å™¨</h3><p>å…¬ç½‘ç¬¬äºŒå±‚è½¬å‘ï¼š<strong>æ±‡èšå±‚è·¯ç”±å™¨</strong>ï¼ˆè¦†ç›–åŸå¸‚æŸåŒºåŸŸ &#x2F; åŒºå¿ï¼ŒåŠŸèƒ½æ˜¯ â€œæ±‡æ€»æ¥å…¥å±‚æµé‡ï¼Œè½¬å‘åˆ°æ ¸å¿ƒå±‚â€ï¼‰ï¼š</p><ol><li>å¸‚æ±‡èšå±‚è·¯ç”±å™¨ï¼ˆIPï¼š10.200.0.1ï¼‰æ”¶åˆ°æ•°æ®åŒ…åï¼ŒæŸ¥çœ‹ç›®æ ‡ IP&#x3D;202.97.224.68ï¼›</li><li>æŸ¥è¯¢è·¯ç”±è¡¨ï¼šè®°å½• â€œ202.97.224.0&#x2F;24 ç½‘æ®µçš„ä¸‹ä¸€è·³æ˜¯çœæ ¸å¿ƒå±‚è·¯ç”±å™¨ï¼ŒIPï¼š10.300.0.1â€ï¼›</li><li>è½¬å‘åˆ°æ ¸å¿ƒå±‚ï¼šé€šè¿‡çœçº§éª¨å¹²å…‰çº¤é“¾è·¯ï¼Œå°†æ•°æ®åŒ…å‘ç»™<strong>çœæ ¸å¿ƒå±‚è·¯ç”±å™¨</strong>ï¼ˆIPï¼š10.300.0.1ï¼‰â€”â€” æ ¸å¿ƒå±‚è·¯ç”±å™¨æ˜¯ â€œè·¨åŒºåŸŸè½¬å‘çš„å…³é”®â€ï¼Œæ‰¿æ‹…å¤§é‡æ•°æ®æµé‡ã€‚</li></ol><h3 id="æ­¥éª¤-7ï¼šå…¬ç½‘æ ¸å¿ƒå±‚è·¯ç”±å™¨è½¬å‘-DNS-è¯·æ±‚åˆ°-DNS-æœåŠ¡å™¨æ‰€åœ¨ç½‘ç»œ"><a href="#æ­¥éª¤-7ï¼šå…¬ç½‘æ ¸å¿ƒå±‚è·¯ç”±å™¨è½¬å‘-DNS-è¯·æ±‚åˆ°-DNS-æœåŠ¡å™¨æ‰€åœ¨ç½‘ç»œ" class="headerlink" title="æ­¥éª¤ 7ï¼šå…¬ç½‘æ ¸å¿ƒå±‚è·¯ç”±å™¨è½¬å‘ DNS è¯·æ±‚åˆ° DNS æœåŠ¡å™¨æ‰€åœ¨ç½‘ç»œ"></a>æ­¥éª¤ 7ï¼šå…¬ç½‘æ ¸å¿ƒå±‚è·¯ç”±å™¨è½¬å‘ DNS è¯·æ±‚åˆ° DNS æœåŠ¡å™¨æ‰€åœ¨ç½‘ç»œ</h3><p>å…¬ç½‘ç¬¬ä¸‰å±‚è½¬å‘ï¼š<strong>æ ¸å¿ƒå±‚è·¯ç”±å™¨</strong>ï¼ˆè¦†ç›–å…¨çœ &#x2F; è·¨å¸‚ï¼ŒåŠŸèƒ½æ˜¯ â€œè·¨åŒºåŸŸéª¨å¹²æµé‡è½¬å‘â€ï¼‰ï¼š</p><ol><li>çœæ ¸å¿ƒå±‚è·¯ç”±å™¨ï¼ˆIPï¼š10.300.0.1ï¼‰æ”¶åˆ°æ•°æ®åŒ…åï¼ŒæŸ¥çœ‹ç›®æ ‡ IP&#x3D;202.97.224.68ï¼ˆè¿è¥å•† DNS æœåŠ¡å™¨ï¼Œä½äºæœ¬çœæ ¸å¿ƒæœºæˆ¿ï¼‰ï¼›</li><li>æŸ¥è¯¢è·¯ç”±è¡¨ï¼šè®°å½• â€œ202.97.224.0&#x2F;24 ç½‘æ®µçš„ä¸‹ä¸€è·³æ˜¯ DNS æœåŠ¡å™¨çš„æ¥å…¥è·¯ç”±å™¨ï¼ŒIPï¼š202.97.224.1â€ï¼›</li><li>è½¬å‘åˆ° DNS æ¥å…¥è·¯ç”±å™¨ï¼šé€šè¿‡æœºæˆ¿å†…éƒ¨é“¾è·¯ï¼Œå°†æ•°æ®åŒ…å‘ç»™<strong>DNS æœåŠ¡å™¨çš„æ¥å…¥è·¯ç”±å™¨</strong>ï¼ˆIPï¼š202.97.224.1ï¼‰ã€‚</li></ol><h3 id="æ­¥éª¤-8ï¼šDNS-æœåŠ¡å™¨è¿”å›è§£æç»“æœï¼ˆåŸŸåâ†’IPï¼‰"><a href="#æ­¥éª¤-8ï¼šDNS-æœåŠ¡å™¨è¿”å›è§£æç»“æœï¼ˆåŸŸåâ†’IPï¼‰" class="headerlink" title="æ­¥éª¤ 8ï¼šDNS æœåŠ¡å™¨è¿”å›è§£æç»“æœï¼ˆåŸŸåâ†’IPï¼‰"></a>æ­¥éª¤ 8ï¼šDNS æœåŠ¡å™¨è¿”å›è§£æç»“æœï¼ˆåŸŸåâ†’IPï¼‰</h3><p>DNS æœåŠ¡å™¨ï¼ˆIPï¼š202.97.224.68ï¼‰å¤„ç†è¯·æ±‚å¹¶è¿”å›ç»“æœï¼ŒæŒ‰åŸè·¯å¾„åå‘è½¬å‘ï¼š</p><ol><li>DNS æœåŠ¡å™¨æ¥æ”¶è¯·æ±‚ï¼šUDP 53 ç«¯å£æ”¶åˆ°æŸ¥è¯¢åŒ…ï¼Œè§£æå‡º â€œæŸ¥è¯¢<a href="https://www.baidu.com/">www.baidu.com</a>çš„ IPâ€ï¼Œåœ¨æœ¬åœ°ç¼“å­˜ä¸­æ‰¾åˆ°å¯¹åº”çš„ A è®°å½•ï¼ˆ<a href="https://www.baidu.com/">www.baidu.com</a>â†’180.101.49.12ï¼‰ï¼›</li><li>å°è£… DNS åº”ç­”åŒ…ï¼šIP å±‚æº IP&#x3D;202.97.224.68ï¼Œç›®æ ‡ IP&#x3D;120.204.197.5ï¼ˆå®¶åº­è·¯ç”±å™¨å…¬ç½‘ IPï¼‰ï¼›</li><li>åå‘è½¬å‘åˆ°å®¶åº­è·¯ç”±å™¨ï¼šåº”ç­”åŒ…æŒ‰ â€œDNS æ¥å…¥è·¯ç”±å™¨â†’çœæ ¸å¿ƒå±‚è·¯ç”±å™¨â†’å¸‚æ±‡èšå±‚è·¯ç”±å™¨â†’æ¥å…¥å±‚è·¯ç”±å™¨â€ çš„è·¯å¾„åå‘ä¼ è¾“ï¼Œæœ€ç»ˆåˆ°è¾¾å®¶åº­è·¯ç”±å™¨ WAN å£ï¼›</li><li>NAT åå‘æ˜ å°„ï¼šå®¶åº­è·¯ç”±å™¨æŸ¥è¯¢ â€œNAT æ˜ å°„è¡¨â€ï¼Œå‘ç°ç›®æ ‡ IP&#x3D;120.204.197.5 å¯¹åº”çš„å±€åŸŸç½‘ IP æ˜¯ 192.168.1.100ï¼Œäºæ˜¯å°† IP å±‚ç›®æ ‡ IP æ”¹ä¸º 192.168.1.100ï¼›</li><li>è½¬å‘åˆ°ç”µè„‘ï¼šè·¯ç”±å™¨ LAN å£é€šè¿‡ ARP ç¼“å­˜è·å–ç”µè„‘ MACï¼Œå‘é€åº”ç­”åŒ… â€”â€” ç”µè„‘æœ€ç»ˆæ‹¿åˆ° â€œ<a href="https://www.baidu.com/">www.baidu.com</a>çš„ IP æ˜¯ 180.101.49.12â€ã€‚</li></ol><h3 id="æ­¥éª¤-9ï¼šç”µè„‘å‘èµ·-HTTPS-è¯·æ±‚ï¼ˆè®¿é—®ç™¾åº¦æœåŠ¡å™¨ï¼‰"><a href="#æ­¥éª¤-9ï¼šç”µè„‘å‘èµ·-HTTPS-è¯·æ±‚ï¼ˆè®¿é—®ç™¾åº¦æœåŠ¡å™¨ï¼‰" class="headerlink" title="æ­¥éª¤ 9ï¼šç”µè„‘å‘èµ· HTTPS è¯·æ±‚ï¼ˆè®¿é—®ç™¾åº¦æœåŠ¡å™¨ï¼‰"></a>æ­¥éª¤ 9ï¼šç”µè„‘å‘èµ· HTTPS è¯·æ±‚ï¼ˆè®¿é—®ç™¾åº¦æœåŠ¡å™¨ï¼‰</h3><p>ç”µè„‘æ‹¿åˆ°ç›®æ ‡ IP åï¼Œé€šè¿‡<strong>HTTPS åè®®ï¼ˆç«¯å£ 443ï¼‰</strong> å‘ç™¾åº¦æœåŠ¡å™¨ï¼ˆ180.101.49.12ï¼‰å‘é€è®¿é—®è¯·æ±‚ï¼Œæµç¨‹ä¸ DNS è¯·æ±‚ç±»ä¼¼ï¼Œä½†ç›®æ ‡æ˜¯å…¬ç½‘æœåŠ¡å™¨ï¼š</p><ol><li>å°è£… HTTPS è¯·æ±‚åŒ…ï¼šIP å±‚æº IP&#x3D;192.168.1.100ï¼Œç›®æ ‡ IP&#x3D;180.101.49.12ï¼›ä»¥å¤ªç½‘å¸§ç›®æ ‡ MAC &#x3D; ç½‘å…³ LAN å£ MACï¼ˆARP ç¼“å­˜å·²å­˜åœ¨ï¼‰ï¼›</li><li>å®¶åº­è·¯ç”±å™¨ NAT è½¬æ¢ï¼šå°†æº IP æ”¹ä¸º 120.204.197.5ï¼Œè®°å½• NAT æ˜ å°„ï¼ˆ192.168.1.100:43210â†’120.204.197.5:56789ï¼‰ï¼Œé€šè¿‡ WAN å£å‘é€åˆ°å…¬ç½‘æ¥å…¥å±‚è·¯ç”±å™¨ã€‚</li></ol><h3 id="æ­¥éª¤-10ï¼šå…¬ç½‘è·¯ç”±å™¨é€è·³è½¬å‘-HTTPS-è¯·æ±‚åˆ°ç™¾åº¦æœåŠ¡å™¨"><a href="#æ­¥éª¤-10ï¼šå…¬ç½‘è·¯ç”±å™¨é€è·³è½¬å‘-HTTPS-è¯·æ±‚åˆ°ç™¾åº¦æœåŠ¡å™¨" class="headerlink" title="æ­¥éª¤ 10ï¼šå…¬ç½‘è·¯ç”±å™¨é€è·³è½¬å‘ HTTPS è¯·æ±‚åˆ°ç™¾åº¦æœåŠ¡å™¨"></a>æ­¥éª¤ 10ï¼šå…¬ç½‘è·¯ç”±å™¨é€è·³è½¬å‘ HTTPS è¯·æ±‚åˆ°ç™¾åº¦æœåŠ¡å™¨</h3><p>HTTPS è¯·æ±‚åœ¨å…¬ç½‘ä¸­é€šè¿‡ â€œæ¥å…¥å±‚â†’æ±‡èšå±‚â†’æ ¸å¿ƒå±‚â†’ç™¾åº¦ IDC æ¥å…¥å±‚â€ çš„è·¯å¾„è½¬å‘ï¼š</p><ol><li>æ¥å…¥å±‚è·¯ç”±å™¨â†’æ±‡èšå±‚è·¯ç”±å™¨â†’æ ¸å¿ƒå±‚è·¯ç”±å™¨ï¼šä¸ DNS è¯·æ±‚è½¬å‘é€»è¾‘ä¸€è‡´ï¼Œé€šè¿‡è·¯ç”±è¡¨æ‰¾åˆ°ä¸‹ä¸€è·³ï¼Œé€è·³è½¬å‘ï¼›</li><li>çœæ ¸å¿ƒå±‚è·¯ç”±å™¨â†’ç™¾åº¦ IDC æ¥å…¥è·¯ç”±å™¨ï¼šæ ¸å¿ƒå±‚è·¯ç”±å™¨æŸ¥è¯¢è·¯ç”±è¡¨ï¼Œå‘ç° â€œ180.101.49.0&#x2F;24 ç½‘æ®µï¼ˆç™¾åº¦æœåŠ¡å™¨æ‰€åœ¨ç½‘æ®µï¼‰çš„ä¸‹ä¸€è·³æ˜¯ç™¾åº¦ IDC çš„æ¥å…¥è·¯ç”±å™¨ï¼ŒIPï¼š203.0.113.1â€ï¼›</li><li>ç™¾åº¦ IDC æ¥å…¥è·¯ç”±å™¨è½¬å‘ï¼šç™¾åº¦ IDCï¼ˆäº’è”ç½‘æ•°æ®ä¸­å¿ƒï¼‰çš„æ¥å…¥è·¯ç”±å™¨æ”¶åˆ°è¯·æ±‚åï¼Œæ ¹æ® â€œè´Ÿè½½å‡è¡¡ç­–ç•¥â€ï¼Œå°†è¯·æ±‚è½¬å‘åˆ°å…·ä½“çš„ç™¾åº¦æœåŠ¡å™¨èŠ‚ç‚¹ï¼ˆå¦‚ 180.101.49.12ï¼‰ã€‚</li></ol><h3 id="æ­¥éª¤-11ï¼šç™¾åº¦æœåŠ¡å™¨å¤„ç†è¯·æ±‚å¹¶è¿”å›å“åº”"><a href="#æ­¥éª¤-11ï¼šç™¾åº¦æœåŠ¡å™¨å¤„ç†è¯·æ±‚å¹¶è¿”å›å“åº”" class="headerlink" title="æ­¥éª¤ 11ï¼šç™¾åº¦æœåŠ¡å™¨å¤„ç†è¯·æ±‚å¹¶è¿”å›å“åº”"></a>æ­¥éª¤ 11ï¼šç™¾åº¦æœåŠ¡å™¨å¤„ç†è¯·æ±‚å¹¶è¿”å›å“åº”</h3><p>ç™¾åº¦æœåŠ¡å™¨æ”¶åˆ° HTTPS è¯·æ±‚åï¼Œå¤„ç†å¹¶è¿”å›é¦–é¡µæ•°æ®ï¼š</p><ol><li>æ¥æ”¶è¯·æ±‚ï¼šç™¾åº¦æœåŠ¡å™¨çš„ HTTPS 443 ç«¯å£æ”¶åˆ°è¯·æ±‚åŒ…ï¼Œè§£æå‡º â€œå®¢æˆ·ç«¯è¦è®¿é—® <a href="https://www.baidu.com/">www.baidu.com</a> é¦–é¡µâ€ï¼›</li><li>å¤„ç†è¯·æ±‚ï¼šæœåŠ¡å™¨è°ƒç”¨åç«¯æœåŠ¡ï¼Œç”Ÿæˆé¦–é¡µçš„ HTMLã€CSSã€JSã€å›¾ç‰‡ç­‰èµ„æºï¼Œå°è£…æˆ HTTPS å“åº”åŒ…ï¼ˆIP å±‚æº IP&#x3D;180.101.49.12ï¼Œç›®æ ‡ IP&#x3D;120.204.197.5ï¼‰ï¼›</li><li>è¿”å›å“åº”ï¼šå“åº”åŒ…æŒ‰ â€œç™¾åº¦ IDC æ¥å…¥è·¯ç”±å™¨â†’çœæ ¸å¿ƒå±‚è·¯ç”±å™¨â†’å¸‚æ±‡èšå±‚è·¯ç”±å™¨â†’æ¥å…¥å±‚è·¯ç”±å™¨â†’å®¶åº­è·¯ç”±å™¨â€ çš„è·¯å¾„åå‘è½¬å‘ã€‚</li></ol><h3 id="æ­¥éª¤-12ï¼šç”µè„‘æ¥æ”¶å“åº”ï¼Œæµè§ˆå™¨æ¸²æŸ“é¡µé¢"><a href="#æ­¥éª¤-12ï¼šç”µè„‘æ¥æ”¶å“åº”ï¼Œæµè§ˆå™¨æ¸²æŸ“é¡µé¢" class="headerlink" title="æ­¥éª¤ 12ï¼šç”µè„‘æ¥æ”¶å“åº”ï¼Œæµè§ˆå™¨æ¸²æŸ“é¡µé¢"></a>æ­¥éª¤ 12ï¼šç”µè„‘æ¥æ”¶å“åº”ï¼Œæµè§ˆå™¨æ¸²æŸ“é¡µé¢</h3><ol><li>å®¶åº­è·¯ç”±å™¨è½¬å‘å“åº”ï¼šè·¯ç”±å™¨ WAN å£æ”¶åˆ°å“åº”åŒ…åï¼Œé€šè¿‡ NAT æ˜ å°„è¡¨æ‰¾åˆ°å¯¹åº”çš„ç”µè„‘ï¼ˆ192.168.1.100ï¼‰ï¼Œä¿®æ”¹ IP å±‚ç›®æ ‡ IPï¼Œé€šè¿‡ LAN å£å‘é€åˆ°ç”µè„‘ï¼›</li><li>ç”µè„‘è§£åŒ…å¤„ç†ï¼šç”µè„‘ç½‘å¡æ¥æ”¶å¸§ï¼Œè§£åŒ…å–å‡º HTTPS å“åº”æ•°æ®ï¼Œäº¤ç»™æµè§ˆå™¨ï¼›</li><li>æµè§ˆå™¨æ¸²æŸ“ï¼šæµè§ˆå™¨è§£æ HTMLã€CSSã€JSï¼ŒåŠ è½½å›¾ç‰‡ç­‰èµ„æºï¼Œæœ€ç»ˆåœ¨å±å¹•ä¸Šæ˜¾ç¤ºç™¾åº¦é¦–é¡µ â€”â€” æ•´ä¸ªè®¿é—®æµç¨‹å®Œæˆã€‚</li></ol><h2 id="2-ç–‘é—®ä¸è§£ç­”"><a href="#2-ç–‘é—®ä¸è§£ç­”" class="headerlink" title="2. ç–‘é—®ä¸è§£ç­”"></a>2. ç–‘é—®ä¸è§£ç­”</h2><h3 id="2-1-è‹¥å®¶åº­è·¯ç”±å™¨æœ‰å…¬ç½‘IPï¼Œä¸ºä½•ä»éœ€é€šè¿‡ARPè·å–å°åŒºæ¥å…¥è·¯ç”±å™¨ï¼Ÿï¼ˆARPä»…ç”¨äºå±€åŸŸç½‘å†…çš„çŸ›ç›¾ç‚¹è§£æï¼‰"><a href="#2-1-è‹¥å®¶åº­è·¯ç”±å™¨æœ‰å…¬ç½‘IPï¼Œä¸ºä½•ä»éœ€é€šè¿‡ARPè·å–å°åŒºæ¥å…¥è·¯ç”±å™¨ï¼Ÿï¼ˆARPä»…ç”¨äºå±€åŸŸç½‘å†…çš„çŸ›ç›¾ç‚¹è§£æï¼‰" class="headerlink" title="2.1 è‹¥å®¶åº­è·¯ç”±å™¨æœ‰å…¬ç½‘IPï¼Œä¸ºä½•ä»éœ€é€šè¿‡ARPè·å–å°åŒºæ¥å…¥è·¯ç”±å™¨ï¼Ÿï¼ˆARPä»…ç”¨äºå±€åŸŸç½‘å†…çš„çŸ›ç›¾ç‚¹è§£æï¼‰"></a>2.1 è‹¥å®¶åº­è·¯ç”±å™¨æœ‰å…¬ç½‘IPï¼Œä¸ºä½•ä»éœ€é€šè¿‡ARPè·å–å°åŒºæ¥å…¥è·¯ç”±å™¨ï¼Ÿï¼ˆARPä»…ç”¨äºå±€åŸŸç½‘å†…çš„çŸ›ç›¾ç‚¹è§£æï¼‰</h3><p>è¦è§£ç­”æ­¤é—®é¢˜ï¼Œéœ€å…ˆæ˜ç¡®ä¸¤ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š<strong>å®¶åº­è·¯ç”±å™¨çš„åŒé‡è§’è‰²</strong>ä¸<strong>ARPâ€œå±€åŸŸç½‘è¾¹ç•Œâ€çš„å®é™…å®šä¹‰</strong>ã€‚å®¶åº­è·¯ç”±å™¨æ—¢æ˜¯â€œå®¶åº­å±€åŸŸç½‘çš„ç½‘å…³â€ï¼Œä¹Ÿæ˜¯â€œè¿è¥å•†å°å±€åŸŸç½‘çš„ç»ˆç«¯â€ï¼›è€ŒARPè¯·æ±‚çš„â€œå±€åŸŸç½‘å†…â€ï¼Œç‰¹æŒ‡å®¶åº­è·¯ç”±å™¨WANå£ä¸å°åŒºæ¥å…¥è·¯ç”±å™¨å…±åŒæ‰€åœ¨çš„â€œè¿è¥å•†å°å±€åŸŸç½‘â€ï¼Œå¹¶éç”¨æˆ·é€šå¸¸ç†è§£çš„â€œå®¶åº­å±€åŸŸç½‘â€ã€‚</p><h3 id="2-1-1-æ ¸å¿ƒå‰æï¼šå®¶åº­è·¯ç”±å™¨çš„åŒæ¥å£ä¸åŒå±€åŸŸç½‘å±æ€§"><a href="#2-1-1-æ ¸å¿ƒå‰æï¼šå®¶åº­è·¯ç”±å™¨çš„åŒæ¥å£ä¸åŒå±€åŸŸç½‘å±æ€§" class="headerlink" title="2.1.1 æ ¸å¿ƒå‰æï¼šå®¶åº­è·¯ç”±å™¨çš„åŒæ¥å£ä¸åŒå±€åŸŸç½‘å±æ€§"></a>2.1.1 æ ¸å¿ƒå‰æï¼šå®¶åº­è·¯ç”±å™¨çš„åŒæ¥å£ä¸åŒå±€åŸŸç½‘å±æ€§</h3><p>å®¶ç”¨è·¯ç”±å™¨å¹¶éå•ä¸€åŠŸèƒ½è®¾å¤‡ï¼Œè€Œæ˜¯è¿æ¥â€œä¸¤ä¸ªç‹¬ç«‹å±€åŸŸç½‘â€çš„æ¡¥æ¢ï¼Œå…¶ä¸¤ä¸ªå…³é”®æ¥å£å¯¹åº”ä¸åŒç½‘ç»œå±æ€§ï¼Œå…·ä½“å·®å¼‚å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p><table><thead><tr><th>æ¥å£ç±»å‹</th><th>è¿æ¥çš„ç½‘ç»œ</th><th>ç½‘ç»œå±æ€§</th><th>IPåœ°å€æ¥æº:</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td><strong>LANå£</strong>ï¼ˆæœ‰çº¿&#x2F;Wi-Fiï¼‰</td><td>å®¶åº­å±€åŸŸç½‘</td><td>ç§ç½‘ï¼ˆå¦‚192.168.1.0&#x2F;24ï¼‰</td><td>è·¯ç”±å™¨è‡ªèº«åˆ†é…ï¼ˆDHCPæœåŠ¡å™¨ï¼‰</td><td>è¿æ¥å®¶ä¸­ç”µè„‘ã€æ‰‹æœºã€ç”µè§†ç­‰ç»ˆç«¯ï¼Œä½œä¸ºå®¶åº­å±€åŸŸç½‘çš„â€œç½‘å…³â€</td></tr><tr><td><strong>WANå£</strong>ï¼ˆç½‘çº¿&#x2F;å…‰çº¤ï¼‰</td><td>è¿è¥å•†å°å±€åŸŸç½‘</td><td>ç§ç½‘æˆ–å…¬ç½‘ï¼ˆå–å†³äºè¿è¥å•†ï¼‰</td><td>è¿è¥å•†é€šè¿‡DHCPåˆ†é…</td><td>è¿æ¥å°åŒºæ¥å…¥è·¯ç”±å™¨ï¼Œä½œä¸ºè¿è¥å•†å°å±€åŸŸç½‘çš„â€œç»ˆç«¯è®¾å¤‡â€ï¼ˆç±»ä¼¼å®¶åº­ç”µè„‘åœ¨å®¶åº­å±€åŸŸç½‘ä¸­çš„è§’è‰²ï¼‰</td></tr></tbody></table><p>ç®€è¨€ä¹‹ï¼Œå®¶åº­è·¯ç”±å™¨çš„â€œåŒé‡èº«ä»½â€è¡¨ç°ä¸ºï¼š</p><ul><li>å¯¹å®¶åº­ç»ˆç«¯ï¼ˆç”µè„‘ã€æ‰‹æœºç­‰ï¼‰ï¼šæ˜¯â€œå®¶åº­å±€åŸŸç½‘çš„ç½‘å…³â€ï¼›</li><li>å¯¹å°åŒºæ¥å…¥è·¯ç”±å™¨ï¼šæ˜¯â€œè¿è¥å•†å°å±€åŸŸç½‘å†…çš„æ™®é€šç»ˆç«¯â€ã€‚</li></ul><h3 id="2-1-2-å…³é”®é—®é¢˜ï¼šä¸ºä½•æœ‰å…¬ç½‘IPä»éœ€ä¾èµ–è¿è¥å•†æ¥å…¥å±€åŸŸç½‘ï¼Ÿ"><a href="#2-1-2-å…³é”®é—®é¢˜ï¼šä¸ºä½•æœ‰å…¬ç½‘IPä»éœ€ä¾èµ–è¿è¥å•†æ¥å…¥å±€åŸŸç½‘ï¼Ÿ" class="headerlink" title="2.1.2 å…³é”®é—®é¢˜ï¼šä¸ºä½•æœ‰å…¬ç½‘IPä»éœ€ä¾èµ–è¿è¥å•†æ¥å…¥å±€åŸŸç½‘ï¼Ÿ"></a>2.1.2 å…³é”®é—®é¢˜ï¼šä¸ºä½•æœ‰å…¬ç½‘IPä»éœ€ä¾èµ–è¿è¥å•†æ¥å…¥å±€åŸŸç½‘ï¼Ÿ</h3><p>å³ä½¿å®¶åº­è·¯ç”±å™¨è·å–äº†å…¬ç½‘IPï¼Œä¹Ÿæ— æ³•è·³è¿‡è¿è¥å•†æ¥å…¥å±€åŸŸç½‘ç›´æ¥è¿æ¥å…¬ç½‘ï¼Œæ ¸å¿ƒåŸå› æ˜¯è¿è¥å•†æ¥å…¥å±€åŸŸç½‘è§£å†³äº†4ä¸ªå®¶åº­è·¯ç”±å™¨è‡ªèº«æ— æ³•å®ç°çš„æ ¸å¿ƒéœ€æ±‚ï¼š</p><h4 id="1-æ¥å…¥è®¤è¯ï¼šç¡®ä¿ä»…åˆæ³•ä»˜è´¹ç”¨æˆ·å¯ä½¿ç”¨å…¬ç½‘"><a href="#1-æ¥å…¥è®¤è¯ï¼šç¡®ä¿ä»…åˆæ³•ä»˜è´¹ç”¨æˆ·å¯ä½¿ç”¨å…¬ç½‘" class="headerlink" title="1. æ¥å…¥è®¤è¯ï¼šç¡®ä¿ä»…åˆæ³•ä»˜è´¹ç”¨æˆ·å¯ä½¿ç”¨å…¬ç½‘"></a>1. æ¥å…¥è®¤è¯ï¼šç¡®ä¿ä»…åˆæ³•ä»˜è´¹ç”¨æˆ·å¯ä½¿ç”¨å…¬ç½‘</h4><p>è¿è¥å•†éœ€é€šè¿‡è®¤è¯éªŒè¯ç”¨æˆ·åˆæ³•æ€§ï¼Œè¯¥è¿‡ç¨‹å¿…é¡»åœ¨â€œè¿è¥å•†æ¥å…¥å±€åŸŸç½‘â€å†…å®Œæˆï¼Œå…·ä½“æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>å®¶åº­è·¯ç”±å™¨å¯åŠ¨æ—¶ï¼Œå‘å°åŒºæ¥å…¥è·¯ç”±å™¨å‘é€â€œPPPoEæ‹¨å·è¯·æ±‚â€ï¼ˆæˆ–DHCPè®¤è¯è¯·æ±‚ï¼‰ï¼Œæºå¸¦ç”¨æˆ·å®½å¸¦è´¦å·ä¸å¯†ç ï¼›</li><li>å°åŒºæ¥å…¥è·¯ç”±å™¨å°†è®¤è¯ä¿¡æ¯è½¬å‘è‡³è¿è¥å•†â€œè®¤è¯æœåŠ¡å™¨ï¼ˆAAAæœåŠ¡å™¨ï¼‰â€ï¼ŒéªŒè¯é€šè¿‡åï¼Œä¸ºå®¶åº­è·¯ç”±å™¨åˆ†é…å…¬ç½‘IPï¼ˆæˆ–ç¡®è®¤å·²åˆ†é…å…¬ç½‘IPæœ‰æ•ˆï¼‰ï¼›</li><li>è‹¥æ— æ­¤è®¤è¯ï¼Œä»»ä½•äººå¯éšæ„è¿æ¥å…¬ç½‘ï¼Œè¿è¥å•†æ— æ³•å®ç°æ”¶è´¹ä¸ç®¡ç†ã€‚</li></ul><h4 id="2-æµé‡æ±‡èšï¼šé™ä½å…¬ç½‘éª¨å¹²ç½‘è¿æ¥æˆæœ¬"><a href="#2-æµé‡æ±‡èšï¼šé™ä½å…¬ç½‘éª¨å¹²ç½‘è¿æ¥æˆæœ¬" class="headerlink" title="2. æµé‡æ±‡èšï¼šé™ä½å…¬ç½‘éª¨å¹²ç½‘è¿æ¥æˆæœ¬"></a>2. æµé‡æ±‡èšï¼šé™ä½å…¬ç½‘éª¨å¹²ç½‘è¿æ¥æˆæœ¬</h4><p>å…¬ç½‘éª¨å¹²ç½‘ç«¯å£èµ„æºæ˜‚è´µï¼ˆå¦‚100Gbpsç«¯å£æˆæœ¬è¾¾å‡ åä¸‡å…ƒï¼‰ï¼Œè‹¥æ¯ä¸ªå®¶åº­è·¯ç”±å™¨ç›´æ¥å¯¹æ¥éª¨å¹²ç½‘ï¼Œä¼šå¯¼è‡´ä¸¤å¤§é—®é¢˜ï¼š</p><ul><li>èµ„æºæµªè´¹ï¼šå®¶åº­å®½å¸¦é€šå¸¸ä¸º100Mbps~1000Mbpsï¼Œç›´æ¥è¿æ¥100Gbpséª¨å¹²ç«¯å£ï¼Œç›¸å½“äºâ€œå¤§æ°´ç®¡æ¥å°æ°´é¾™å¤´â€ï¼Œ99%å¸¦å®½è¢«é—²ç½®ï¼›</li><li>ç®¡ç†æ··ä¹±ï¼šå…¨å›½æ•°äº¿å®¶åº­è‹¥å‡ç›´æ¥è¿éª¨å¹²ç½‘ï¼Œéœ€æ•°äº¿ä¸ªéª¨å¹²ç«¯å£ï¼Œå…¬ç½‘æ— æ³•æ‰¿è½½ã€‚</li></ul><p>è¿è¥å•†æ¥å…¥å±€åŸŸç½‘é€šè¿‡â€œåˆ†å±‚æ±‡èšâ€è§£å†³è¯¥é—®é¢˜ï¼š</p><ul><li>å°åŒºæ¥å…¥è·¯ç”±å™¨ï¼šæ±‡èšæœ¬å°åŒºæ‰€æœ‰å®¶åº­æµé‡ï¼ˆå¦‚100æˆ·Ã—100Mbps&#x3D;10Gbpsï¼‰ï¼Œé€šè¿‡10Gbpsç«¯å£è¿æ¥å¸‚æ±‡èšå±‚è·¯ç”±å™¨ï¼›</li><li>å¸‚æ±‡èšå±‚è·¯ç”±å™¨ï¼šæ±‡èšå¤šä¸ªå°åŒºæµé‡ï¼ˆå¦‚10ä¸ªå°åŒºÃ—10Gbps&#x3D;100Gbpsï¼‰ï¼Œé€šè¿‡100Gbpsç«¯å£è¿æ¥çœæ ¸å¿ƒéª¨å¹²ç½‘ã€‚</li></ul><h4 id="3-å®‰å…¨ç®¡æ§ï¼šæ‹¦æˆªæ¶æ„æµé‡ï¼Œä¿æŠ¤å…¬ç½‘ä¸å®¶åº­ç½‘ç»œ"><a href="#3-å®‰å…¨ç®¡æ§ï¼šæ‹¦æˆªæ¶æ„æµé‡ï¼Œä¿æŠ¤å…¬ç½‘ä¸å®¶åº­ç½‘ç»œ" class="headerlink" title="3. å®‰å…¨ç®¡æ§ï¼šæ‹¦æˆªæ¶æ„æµé‡ï¼Œä¿æŠ¤å…¬ç½‘ä¸å®¶åº­ç½‘ç»œ"></a>3. å®‰å…¨ç®¡æ§ï¼šæ‹¦æˆªæ¶æ„æµé‡ï¼Œä¿æŠ¤å…¬ç½‘ä¸å®¶åº­ç½‘ç»œ</h4><p>å…¬ç½‘å­˜åœ¨å¤§é‡æ¶æ„æµé‡ï¼ˆå¦‚DDoSæ”»å‡»ã€ç—…æ¯’åŒ…ï¼‰ï¼Œè‹¥å®¶åº­è·¯ç”±å™¨ç›´æ¥è¿å…¬ç½‘ï¼Œä¼šé¢ä¸´åŒé‡é£é™©ï¼š</p><ul><li>å®¶åº­ç½‘ç»œè¢«æ”»å‡»ï¼šæ¶æ„æµé‡ç›´æ¥å†²å‡»å®¶åº­è·¯ç”±å™¨ï¼Œå¯èƒ½çªç ´é˜²ç«å¢™å…¥ä¾µå†…ç½‘ï¼›</li><li>å®¶åº­ç½‘ç»œæˆä¸ºâ€œæ”»å‡»æºâ€ï¼šè‹¥å®¶åº­è®¾å¤‡è¢«é»‘å®¢æ§åˆ¶ï¼ˆå¦‚æ²¦ä¸ºâ€œè‚‰é¸¡â€ï¼‰ï¼Œä¼šå‘å¤–å‘é€æ”»å‡»æµé‡ï¼Œå½±å“å…¬ç½‘ç¨³å®šã€‚</li></ul><p>è¿è¥å•†æ¥å…¥å±€åŸŸç½‘çš„â€œå®‰å…¨é˜²æŠ¤â€ä½œç”¨ï¼Œä½“ç°åœ¨å®¶åº­è·¯ç”±å™¨ä¸å…¬ç½‘éª¨å¹²ç½‘ä¹‹é—´çš„â€œé˜²ç«å¢™â€ï¼š</p><ul><li>å°åŒºæ¥å…¥è·¯ç”±å™¨ä¸è¿è¥å•†â€œè¾¹ç•Œé˜²ç«å¢™â€è¿‡æ»¤æµé‡ï¼šæ‹¦æˆªå·²çŸ¥æ¶æ„IPæ•°æ®åŒ…ã€é™åˆ¶å•å®¶åº­æœ€å¤§è¿æ¥æ•°ã€æ£€æµ‹å¼‚å¸¸æµé‡ï¼ˆå¦‚çªå‘DDoSåŒ…ï¼‰ï¼›</li><li>è‹¥å‘ç°å®¶åº­è·¯ç”±å™¨å‘é€æ¶æ„æµé‡ï¼Œè¿è¥å•†å¯é€šè¿‡æ¥å…¥å±€åŸŸç½‘ä¸´æ—¶å°ç¦è¯¥å…¬ç½‘IPï¼Œé¿å…å½±å“å…¶ä»–ç”¨æˆ·ã€‚</li></ul><h4 id="4-ç½‘ç»œä¼˜åŒ–ï¼šæå‡è®¿é—®é€Ÿåº¦ä¸ç¨³å®šæ€§"><a href="#4-ç½‘ç»œä¼˜åŒ–ï¼šæå‡è®¿é—®é€Ÿåº¦ä¸ç¨³å®šæ€§" class="headerlink" title="4. ç½‘ç»œä¼˜åŒ–ï¼šæå‡è®¿é—®é€Ÿåº¦ä¸ç¨³å®šæ€§"></a>4. ç½‘ç»œä¼˜åŒ–ï¼šæå‡è®¿é—®é€Ÿåº¦ä¸ç¨³å®šæ€§</h4><p>å®¶åº­è·¯ç”±å™¨èƒ½åŠ›æœ‰é™ï¼Œæ— æ³•å®æ—¶æ„ŸçŸ¥å…¬ç½‘é“¾è·¯çŠ¶æ€ï¼Œè¿è¥å•†æ¥å…¥å±€åŸŸç½‘é€šè¿‡ä¸¤å¤§æ–¹å¼ä¼˜åŒ–ç½‘ç»œï¼š</p><ul><li>DNSç¼“å­˜åŠ é€Ÿï¼šå°åŒºæ¥å…¥è·¯ç”±å™¨ç¼“å­˜çƒ­é—¨åŸŸåï¼ˆå¦‚ç™¾åº¦ã€å¾®ä¿¡ï¼‰çš„DNSè§£æç»“æœï¼Œå®¶åº­è·¯ç”±å™¨æŸ¥è¯¢æ—¶æ— éœ€ç»•åˆ°çœæ ¸å¿ƒDNSæœåŠ¡å™¨ï¼Œé€Ÿåº¦æ›´å¿«ï¼›</li><li>å°±è¿‘èµ„æºåˆ†é…ï¼šè®¿é—®è§†é¢‘ç½‘ç«™æ—¶ï¼Œæ¥å…¥è·¯ç”±å™¨å°†æµé‡è½¬å‘è‡³â€œå°±è¿‘çš„è§†é¢‘CDNèŠ‚ç‚¹â€ï¼Œè€Œéç›´æ¥è¿æ¥ç½‘ç«™æ€»éƒ¨æœåŠ¡å™¨ï¼Œé™ä½å»¶è¿Ÿã€æå‡ç”»è´¨ã€‚</li></ul><h3 id="2-1-3-å»¶ä¼¸ç–‘é—®ï¼šæ‹¥æœ‰å…¬ç½‘IPçš„å®é™…æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#2-1-3-å»¶ä¼¸ç–‘é—®ï¼šæ‹¥æœ‰å…¬ç½‘IPçš„å®é™…æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="2.1.3 å»¶ä¼¸ç–‘é—®ï¼šæ‹¥æœ‰å…¬ç½‘IPçš„å®é™…æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿ"></a>2.1.3 å»¶ä¼¸ç–‘é—®ï¼šæ‹¥æœ‰å…¬ç½‘IPçš„å®é™…æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>å…¬ç½‘IPçš„æ ¸å¿ƒæ„ä¹‰åœ¨äºï¼š<strong>è®¾å¤‡æ˜¯å¦å¯è¢«å…¬ç½‘ä¸»åŠ¨å®šä½å¹¶è®¿é—®</strong>ã€‚ä»¥ä¸‹é€šè¿‡å…·ä½“åœºæ™¯è¯´æ˜å…¶ä½œç”¨ï¼ˆä»¥â€œåŒ—äº¬ç”¨æˆ·å…¬ç½‘IPè®¿é—®NASâ€ä¸ºä¾‹ï¼‰ï¼š</p><h4 id="åœºæ™¯è®¾å®š"><a href="#åœºæ™¯è®¾å®š" class="headerlink" title="åœºæ™¯è®¾å®š"></a>åœºæ™¯è®¾å®š</h4><ul><li>æœ‹å‹ï¼ˆä¸Šæµ·ï¼‰ï¼šå®¶åº­å±€åŸŸç½‘IPæ®µ192.168.2.0&#x2F;24ï¼Œç”µè„‘IP 192.168.2.100ï¼Œè·¯ç”±å™¨WANå£å…¬ç½‘IP 203.95.12.8ï¼›</li><li>ä½ ï¼ˆåŒ—äº¬ï¼‰ï¼šå®¶åº­å…¬ç½‘IP 120.204.197.5ï¼ŒNASå†…ç½‘IP 192.168.1.200ï¼ˆå·²é…ç½®ç«¯å£æ˜ å°„ï¼š120.204.197.5:8080â†’192.168.1.200:8080ï¼‰ã€‚</li></ul><h4 id="å…¬ç½‘è®¿é—®NASçš„å®Œæ•´æµç¨‹ï¼ˆ6æ­¥ï¼‰"><a href="#å…¬ç½‘è®¿é—®NASçš„å®Œæ•´æµç¨‹ï¼ˆ6æ­¥ï¼‰" class="headerlink" title="å…¬ç½‘è®¿é—®NASçš„å®Œæ•´æµç¨‹ï¼ˆ6æ­¥ï¼‰"></a>å…¬ç½‘è®¿é—®NASçš„å®Œæ•´æµç¨‹ï¼ˆ6æ­¥ï¼‰</h4><h5 id="æ­¥éª¤1ï¼šæœ‹å‹ä¾§å±€åŸŸç½‘å†…å‘èµ·è¯·æ±‚ï¼ˆç»ˆç«¯â†’å®¶åº­è·¯ç”±å™¨ï¼‰"><a href="#æ­¥éª¤1ï¼šæœ‹å‹ä¾§å±€åŸŸç½‘å†…å‘èµ·è¯·æ±‚ï¼ˆç»ˆç«¯â†’å®¶åº­è·¯ç”±å™¨ï¼‰" class="headerlink" title="æ­¥éª¤1ï¼šæœ‹å‹ä¾§å±€åŸŸç½‘å†…å‘èµ·è¯·æ±‚ï¼ˆç»ˆç«¯â†’å®¶åº­è·¯ç”±å™¨ï¼‰"></a>æ­¥éª¤1ï¼šæœ‹å‹ä¾§å±€åŸŸç½‘å†…å‘èµ·è¯·æ±‚ï¼ˆç»ˆç«¯â†’å®¶åº­è·¯ç”±å™¨ï¼‰</h5><ol><li><strong>åˆ¤æ–­è½¬å‘æ–¹å‘</strong>ï¼šæœ‹å‹ç”µè„‘æ£€æŸ¥ç›®æ ‡IP 120.204.197.5ï¼Œå‘ç°ä¸åœ¨è‡ªèº«å±€åŸŸç½‘ï¼ˆ192.168.2.0&#x2F;24ï¼‰ï¼Œéœ€é€šè¿‡ç½‘å…³ï¼ˆæœ‹å‹å®¶è·¯ç”±å™¨IP 192.168.2.1ï¼‰è½¬å‘è‡³å…¬ç½‘ï¼›</li><li><strong>è·å–ç½‘å…³MAC</strong>ï¼šæœ‹å‹ç”µè„‘æŸ¥è¯¢æœ¬åœ°ARPç¼“å­˜ï¼Œæ‰¾åˆ°æœ‹å‹å®¶è·¯ç”±å™¨LANå£MACï¼ˆå¦‚00:EE:FF:AA:BB:CCï¼‰ï¼Œå°è£…ä»¥å¤ªç½‘å¸§ï¼ˆæºMACï¼šæœ‹å‹ç”µè„‘MACï¼›ç›®æ ‡MACï¼šè·¯ç”±å™¨LANå£MACï¼‰ï¼Œå¸§å†…åŒ…å«IPæ•°æ®åŒ…ï¼ˆæºIP 192.168.2.100ï¼Œç›®æ ‡IP 120.204.197.5ï¼Œç«¯å£8080ï¼‰ï¼›</li><li><strong>å‘é€è‡³è·¯ç”±å™¨</strong>ï¼šé€šè¿‡Wi-Fi&#x2F;ç½‘çº¿å°†å¸§å‘é€åˆ°æœ‹å‹å®¶è·¯ç”±å™¨ï¼Œè·¯ç”±å™¨LANå£è§£åŒ…åæå–IPæ•°æ®åŒ…ã€‚</li></ol><h5 id="æ­¥éª¤2ï¼šæœ‹å‹ä¾§è¿è¥å•†è½¬å‘ï¼ˆå®¶åº­è·¯ç”±å™¨â†’ä¸Šæµ·éª¨å¹²ç½‘ï¼‰"><a href="#æ­¥éª¤2ï¼šæœ‹å‹ä¾§è¿è¥å•†è½¬å‘ï¼ˆå®¶åº­è·¯ç”±å™¨â†’ä¸Šæµ·éª¨å¹²ç½‘ï¼‰" class="headerlink" title="æ­¥éª¤2ï¼šæœ‹å‹ä¾§è¿è¥å•†è½¬å‘ï¼ˆå®¶åº­è·¯ç”±å™¨â†’ä¸Šæµ·éª¨å¹²ç½‘ï¼‰"></a>æ­¥éª¤2ï¼šæœ‹å‹ä¾§è¿è¥å•†è½¬å‘ï¼ˆå®¶åº­è·¯ç”±å™¨â†’ä¸Šæµ·éª¨å¹²ç½‘ï¼‰</h5><ol><li><strong>NATåœ°å€è½¬æ¢</strong>ï¼šæœ‹å‹å®¶è·¯ç”±å™¨å°†IPæ•°æ®åŒ…çš„æºIPä»192.168.2.100æ”¹ä¸ºè‡ªèº«WANå£å…¬ç½‘IP 203.95.12.8ï¼ŒåŒæ—¶åœ¨NATæ˜ å°„è¡¨è®°å½•â€œ192.168.2.100:éšæœºç«¯å£â†’203.95.12.8:éšæœºç«¯å£â€ï¼ˆç”¨äºæ¥æ”¶åç»­å“åº”ï¼‰ï¼›</li><li><strong>è½¬å‘è‡³ä¸Šæµ·å°åŒºæ¥å…¥å±‚è·¯ç”±å™¨</strong>ï¼šæœ‹å‹å®¶è·¯ç”±å™¨é€šè¿‡WANå£ï¼Œå‘ä¸Šæµ·å°åŒºæ¥å…¥å±‚è·¯ç”±å™¨ï¼ˆIP 10.150.0.1ï¼‰å‘é€è¯·æ±‚åŒ…â€”â€”å…ˆé€šè¿‡ARPè·å–æ¥å…¥å±‚è·¯ç”±å™¨MACï¼ˆäºŒè€…åŒå±ä¸Šæµ·è¿è¥å•†æ¥å…¥å±€åŸŸç½‘ï¼‰ï¼Œå°è£…å¸§åå‘é€ï¼›</li><li><strong>æ¥å…¥å±‚â†’æ±‡èšå±‚è½¬å‘</strong>ï¼šä¸Šæµ·å°åŒºæ¥å…¥å±‚è·¯ç”±å™¨ï¼ˆ10.150.0.1ï¼‰æ±‡æ€»å°åŒºæµé‡ï¼ŒæŸ¥è¯¢è·¯ç”±è¡¨å‘ç°ç›®æ ‡IPå±åŒ—äº¬è¿è¥å•†ç½‘æ®µï¼Œè½¬å‘è‡³ä¸Šæµ·å¸‚åŒºæ±‡èšå±‚è·¯ç”±å™¨ï¼ˆ10.250.0.1ï¼‰ï¼›</li><li><strong>æ±‡èšå±‚â†’æ ¸å¿ƒå±‚è½¬å‘</strong>ï¼šä¸Šæµ·æ±‡èšå±‚è·¯ç”±å™¨ï¼ˆ10.250.0.1ï¼‰æ±‡æ€»å¤šä¸ªå°åŒºæµé‡ï¼Œè½¬å‘è‡³ä¸Šæµ·æ ¸å¿ƒå±‚è·¯ç”±å™¨ï¼ˆ202.97.0.1ï¼‰ï¼Œå®Œæˆâ€œæœ‹å‹ä¾§åˆ°å…¬ç½‘éª¨å¹²ç½‘çš„æ¥å…¥â€ã€‚</li></ol><h5 id="æ­¥éª¤3ï¼šè·¨åŒºåŸŸå…¬ç½‘éª¨å¹²ç½‘è½¬å‘ï¼ˆä¸Šæµ·â†’åŒ—äº¬ï¼‰"><a href="#æ­¥éª¤3ï¼šè·¨åŒºåŸŸå…¬ç½‘éª¨å¹²ç½‘è½¬å‘ï¼ˆä¸Šæµ·â†’åŒ—äº¬ï¼‰" class="headerlink" title="æ­¥éª¤3ï¼šè·¨åŒºåŸŸå…¬ç½‘éª¨å¹²ç½‘è½¬å‘ï¼ˆä¸Šæµ·â†’åŒ—äº¬ï¼‰"></a>æ­¥éª¤3ï¼šè·¨åŒºåŸŸå…¬ç½‘éª¨å¹²ç½‘è½¬å‘ï¼ˆä¸Šæµ·â†’åŒ—äº¬ï¼‰</h5><ol><li><strong>ä¸Šæµ·æ ¸å¿ƒå±‚â†’å›½å®¶çº§éª¨å¹²è·¯ç”±å™¨</strong>ï¼šä¸Šæµ·æ ¸å¿ƒå±‚è·¯ç”±å™¨ï¼ˆ202.97.0.1ï¼‰å°†è¯·æ±‚åŒ…è½¬å‘è‡³å›½å®¶çº§éª¨å¹²ç½‘è·¯ç”±å™¨ï¼ˆå¦‚å¤©æ´¥èŠ‚ç‚¹ï¼ŒIP 10.50.0.1ï¼‰â€”â€”éª¨å¹²ç½‘è·¯ç”±å™¨ä»…è®°å½•IPæ®µèšåˆè·¯ç”±ï¼Œä¸è®°å½•å•ä¸ªIPï¼›</li><li><strong>éª¨å¹²ç½‘â†’åŒ—äº¬æ ¸å¿ƒå±‚è·¯ç”±å™¨</strong>ï¼šå›½å®¶çº§éª¨å¹²è·¯ç”±å™¨ï¼ˆ10.50.0.1ï¼‰æŸ¥è¯¢è·¯ç”±è¡¨ï¼Œå‘ç°120.204.197.0&#x2F;24æ®µå½’å±åŒ—äº¬è¿è¥å•†ï¼Œé€šè¿‡è·¨åŒºåŸŸå…‰çº¤é“¾è·¯è½¬å‘è‡³åŒ—äº¬æ ¸å¿ƒå±‚è·¯ç”±å™¨ï¼ˆ202.96.0.1ï¼‰ã€‚</li></ol><h5 id="æ­¥éª¤4ï¼šä½ ä¾§è¿è¥å•†è½¬å‘ï¼ˆåŒ—äº¬éª¨å¹²ç½‘â†’ä½ å®¶è·¯ç”±å™¨ï¼‰"><a href="#æ­¥éª¤4ï¼šä½ ä¾§è¿è¥å•†è½¬å‘ï¼ˆåŒ—äº¬éª¨å¹²ç½‘â†’ä½ å®¶è·¯ç”±å™¨ï¼‰" class="headerlink" title="æ­¥éª¤4ï¼šä½ ä¾§è¿è¥å•†è½¬å‘ï¼ˆåŒ—äº¬éª¨å¹²ç½‘â†’ä½ å®¶è·¯ç”±å™¨ï¼‰"></a>æ­¥éª¤4ï¼šä½ ä¾§è¿è¥å•†è½¬å‘ï¼ˆåŒ—äº¬éª¨å¹²ç½‘â†’ä½ å®¶è·¯ç”±å™¨ï¼‰</h5><ol><li><strong>åŒ—äº¬æ ¸å¿ƒå±‚â†’æ±‡èšå±‚è½¬å‘</strong>ï¼šåŒ—äº¬æ ¸å¿ƒå±‚è·¯ç”±å™¨ï¼ˆ202.96.0.1ï¼‰å°†è¯·æ±‚åŒ…è½¬å‘è‡³ä½ æ‰€åœ¨åŒºåŸŸçš„åŒ—äº¬æ±‡èšå±‚è·¯ç”±å™¨ï¼ˆ10.200.0.1ï¼‰â€”â€”æ ¸å¿ƒå±‚è´Ÿè´£è·¨åŒºåŸŸæµé‡ï¼Œæœ¬åœ°æµé‡ç”±æ±‡èšå±‚åˆ†å‘ï¼›</li><li><strong>æ±‡èšå±‚â†’å°åŒºæ¥å…¥å±‚è½¬å‘</strong>ï¼šåŒ—äº¬æ±‡èšå±‚è·¯ç”±å™¨ï¼ˆ10.200.0.1ï¼‰æŸ¥è¯¢è·¯ç”±è¡¨ï¼Œå‘ç°120.204.197.0&#x2F;24æ®µå¯¹åº”ä½ å®¶å°åŒºæ¥å…¥å±‚è·¯ç”±å™¨ï¼Œè½¬å‘è‡³ä½ å®¶å°åŒºæ¥å…¥å±‚è·¯ç”±å™¨ï¼ˆ10.100.0.1ï¼‰ï¼›</li><li><strong>å°åŒºæ¥å…¥å±‚â†’ä½ å®¶è·¯ç”±å™¨</strong>ï¼šä½ å®¶å°åŒºæ¥å…¥å±‚è·¯ç”±å™¨ï¼ˆ10.100.0.1ï¼‰æŸ¥è¯¢ARPç¼“å­˜ç»´æŠ¤çš„â€œIP-MACå…³è”è¡¨â€ï¼Œå‘ç°120.204.197.5å¯¹åº”ä½ å®¶è·¯ç”±å™¨WANå£MACï¼ˆå¦‚00:AA:BB:CC:DD:EEï¼‰ï¼Œå°†è¯·æ±‚åŒ…è½¬å‘è‡³ä½ å®¶è·¯ç”±å™¨WANå£ã€‚</li></ol><h5 id="æ­¥éª¤5ï¼šä½ ä¾§å±€åŸŸç½‘å†…è½¬å‘ï¼ˆä½ å®¶è·¯ç”±å™¨â†’NASï¼‰"><a href="#æ­¥éª¤5ï¼šä½ ä¾§å±€åŸŸç½‘å†…è½¬å‘ï¼ˆä½ å®¶è·¯ç”±å™¨â†’NASï¼‰" class="headerlink" title="æ­¥éª¤5ï¼šä½ ä¾§å±€åŸŸç½‘å†…è½¬å‘ï¼ˆä½ å®¶è·¯ç”±å™¨â†’NASï¼‰"></a>æ­¥éª¤5ï¼šä½ ä¾§å±€åŸŸç½‘å†…è½¬å‘ï¼ˆä½ å®¶è·¯ç”±å™¨â†’NASï¼‰</h5><ol><li><strong>NATæ˜ å°„åŒ¹é…</strong>ï¼šä½ å®¶è·¯ç”±å™¨æ¥æ”¶è¯·æ±‚åŒ…åï¼Œæå–â€œç›®æ ‡IP 120.204.197.5+ç«¯å£8080â€ï¼ŒæŸ¥è¯¢NATæ˜ å°„è¡¨ï¼ŒåŒ¹é…åˆ°æå‰é…ç½®çš„â€œ120.204.197.5:8080â†’192.168.1.200:8080â€ï¼›</li><li><strong>è½¬å‘è‡³NAS</strong>ï¼šä¿®æ”¹IPæ•°æ®åŒ…çš„ç›®æ ‡IPä¸ºNASå†…ç½‘IP 192.168.1.200ï¼Œé€šè¿‡ARPè·å–NASçš„MACï¼ˆå¦‚00:FF:AA:BB:CC:DDï¼‰ï¼Œå°è£…ä»¥å¤ªç½‘å¸§åé€šè¿‡LANå£å‘é€åˆ°NASã€‚</li></ol><h5 id="æ­¥éª¤6ï¼šNASå“åº”å¹¶æŒ‰åŸè·¯å¾„è¿”å›"><a href="#æ­¥éª¤6ï¼šNASå“åº”å¹¶æŒ‰åŸè·¯å¾„è¿”å›" class="headerlink" title="æ­¥éª¤6ï¼šNASå“åº”å¹¶æŒ‰åŸè·¯å¾„è¿”å›"></a>æ­¥éª¤6ï¼šNASå“åº”å¹¶æŒ‰åŸè·¯å¾„è¿”å›</h5><ol><li><strong>NASç”Ÿæˆå“åº”åŒ…</strong>ï¼šNASå¤„ç†è¯·æ±‚åï¼Œè¿”å›é¦–é¡µæ•°æ®ï¼Œå°è£…å“åº”åŒ…ï¼ˆæºIP 192.168.1.200ï¼Œç›®æ ‡IP 192.168.2.100ï¼Œç«¯å£8080ï¼‰ï¼›</li><li><strong>ä½ ä¾§å±€åŸŸç½‘â†’åŒ—äº¬è¿è¥å•†</strong>ï¼šå“åº”åŒ…ç»ä½ å®¶è·¯ç”±å™¨ï¼ˆNATè½¬æ¢ï¼šæºIPæ”¹ä¸º120.204.197.5ï¼‰â†’å°åŒºæ¥å…¥å±‚â†’åŒ—äº¬æ±‡èšå±‚â†’åŒ—äº¬æ ¸å¿ƒå±‚ï¼Œè¿›å…¥å…¬ç½‘éª¨å¹²ç½‘ï¼›</li><li><strong>éª¨å¹²ç½‘â†’ä¸Šæµ·è¿è¥å•†</strong>ï¼šå“åº”åŒ…ç»å›½å®¶çº§éª¨å¹²ç½‘â†’ä¸Šæµ·æ ¸å¿ƒå±‚â†’ä¸Šæµ·æ±‡èšå±‚â†’ä¸Šæµ·å°åŒºæ¥å…¥å±‚ï¼Œåˆ°è¾¾æœ‹å‹å®¶è·¯ç”±å™¨ï¼›</li><li><strong>æœ‹å‹ä¾§è¿è¥å•†â†’å±€åŸŸç½‘</strong>ï¼šæœ‹å‹å®¶è·¯ç”±å™¨é€šè¿‡NATæ˜ å°„è¡¨æ‰¾åˆ°â€œ203.95.12.8:éšæœºç«¯å£å¯¹åº”192.168.2.100:éšæœºç«¯å£â€ï¼Œä¿®æ”¹ç›®æ ‡IPåè½¬å‘åˆ°æœ‹å‹ç”µè„‘ï¼›</li><li><strong>æœ‹å‹ç”µè„‘æ¸²æŸ“é¡µé¢</strong>ï¼šæœ‹å‹ç”µè„‘æ¥æ”¶å“åº”åŒ…ï¼Œæµè§ˆå™¨è§£ææ•°æ®å¹¶æ˜¾ç¤ºNASé¦–é¡µï¼Œæ•´ä¸ªè®¿é—®æµç¨‹å®Œæˆã€‚</li></ol><h2 id="3-æ ¸å¿ƒæ¦‚å¿µä¸²è”æ€»ç»“"><a href="#3-æ ¸å¿ƒæ¦‚å¿µä¸²è”æ€»ç»“" class="headerlink" title="3.æ ¸å¿ƒæ¦‚å¿µä¸²è”æ€»ç»“"></a>3.æ ¸å¿ƒæ¦‚å¿µä¸²è”æ€»ç»“</h2><ol><li><strong>DHCP</strong>ï¼šç»™ç”µè„‘åˆ†é… â€œå±€åŸŸç½‘èº«ä»½â€ï¼ˆIP &#x2F; ç½‘å…³ &#x2F; DNSï¼‰ï¼Œæ˜¯ä¸Šç½‘çš„åŸºç¡€ï¼›</li><li><strong>DNS</strong>ï¼šå°†åŸŸåï¼ˆ<a href="https://www.baidu.com/">www.baidu.com</a>ï¼‰è½¬ä¸ºå…¬ç½‘ IPï¼ˆ180.101.49.12ï¼‰ï¼Œè§£å†³ â€œå…¬ç½‘å®šä½ç›®æ ‡â€ çš„é—®é¢˜ï¼›</li><li><strong>ARP</strong>ï¼šä»…åœ¨å±€åŸŸç½‘å†…ç”Ÿæ•ˆï¼Œè·å–ç½‘å…³ &#x2F; è®¾å¤‡çš„ MAC åœ°å€ï¼Œè§£å†³ â€œå±€åŸŸç½‘å†…è½¬å‘ç›®æ ‡â€ çš„é—®é¢˜ï¼›</li><li><strong>NAT</strong>ï¼šå°†å±€åŸŸç½‘ IP è½¬ä¸ºå…¬ç½‘ IPï¼Œè§£å†³ â€œå®¶ç”¨ç½‘ç»œå…¬ç½‘ IP ä¸è¶³â€ çš„é—®é¢˜ï¼›</li><li><strong>å…¬ç½‘è·¯ç”±å™¨å±‚çº§</strong>ï¼šé€šè¿‡ â€œæ¥å…¥å±‚â†’æ±‡èšå±‚â†’æ ¸å¿ƒå±‚â€ é€è·³è½¬å‘ï¼Œä¾èµ– â€œè·¯ç”±è¡¨â€ ç¡®å®šä¸‹ä¸€è·³ï¼Œä¸ä½¿ç”¨ ARPï¼Œæ ¸å¿ƒæ˜¯ â€œIP è·¯ç”±â€ï¼›</li><li><strong>IP ä¸ MAC çš„åˆ†å·¥</strong>ï¼šIP è´Ÿè´£ â€œè·¨ç½‘å®šä½ç›®æ ‡ï¼ˆå…¬ç½‘ + å±€åŸŸç½‘ï¼‰â€ï¼ŒMAC ä»…è´Ÿè´£ â€œå±€åŸŸç½‘å†…å®šä½è®¾å¤‡â€ï¼ŒäºŒè€…é…åˆå®ç°å…¨ç¨‹é€šä¿¡ã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> è®¡ç®—æœºç½‘ç»œ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DNS </tag>
            
            <tag> NAT </tag>
            
            <tag> DHCP </tag>
            
            <tag> ARP </tag>
            
            <tag> è®¡ç®—æœºç½‘ç»œ </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
