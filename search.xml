<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Linuxå†…æ ¸çš„netfilterè¯¦è§£</title>
      <link href="/2025/06/12/Linux%E5%86%85%E6%A0%B8%E7%9A%84netfilter%E8%AF%A6%E8%A7%A31/"/>
      <url>/2025/06/12/Linux%E5%86%85%E6%A0%B8%E7%9A%84netfilter%E8%AF%A6%E8%A7%A31/</url>
      
        <content type="html"><![CDATA[<h1 id="Linuxå†…æ ¸çš„netfilterè¯¦è§£"><a href="#Linuxå†…æ ¸çš„netfilterè¯¦è§£" class="headerlink" title="Linuxå†…æ ¸çš„netfilterè¯¦è§£"></a>Linuxå†…æ ¸çš„netfilterè¯¦è§£</h1><p>Linuxå†…æ ¸çš„netfilteræ˜¯ä¸€ä¸ªå¼ºå¤§çš„ç½‘ç»œæ•°æ®åŒ…è¿‡æ»¤å’Œå¤„ç†æ¡†æ¶ï¼Œå®ƒæ˜¯Linuxå†…æ ¸ç½‘ç»œæ ˆçš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ã€‚</p><h2 id="ğŸ”-ä»€ä¹ˆæ˜¯netfilter"><a href="#ğŸ”-ä»€ä¹ˆæ˜¯netfilter" class="headerlink" title="ğŸ” ä»€ä¹ˆæ˜¯netfilter"></a>ğŸ” ä»€ä¹ˆæ˜¯netfilter</h2><p><strong>netfilter</strong>æ˜¯Linuxå†…æ ¸ä¸­çš„ä¸€ä¸ªæ¡†æ¶ï¼Œå®ƒæä¾›äº†ä¸€ç³»åˆ—çš„é’©å­ï¼ˆhooksï¼‰æ¥å…è®¸å†…æ ¸æ¨¡å—åœ¨ç½‘ç»œæ ˆçš„ä¸åŒä½ç½®æ³¨å†Œå›è°ƒå‡½æ•°ï¼Œä»è€Œå®ç°å¯¹ç½‘ç»œæ•°æ®åŒ…çš„æ‹¦æˆªã€ä¿®æ”¹ã€è¿‡æ»¤å’Œå¤„ç†ã€‚</p><h2 id="ğŸ—ï¸-netfilteræ¶æ„"><a href="#ğŸ—ï¸-netfilteræ¶æ„" class="headerlink" title="ğŸ—ï¸ netfilteræ¶æ„"></a>ğŸ—ï¸ netfilteræ¶æ„</h2><h3 id="æ ¸å¿ƒç»„ä»¶"><a href="#æ ¸å¿ƒç»„ä»¶" class="headerlink" title="æ ¸å¿ƒç»„ä»¶"></a>æ ¸å¿ƒç»„ä»¶</h3><ul><li><strong>é’©å­ç‚¹ï¼ˆHook Pointsï¼‰</strong>: åœ¨ç½‘ç»œæ ˆçš„å…³é”®ä½ç½®è®¾ç½®çš„æ‹¦æˆªç‚¹</li><li><strong>é’©å­å‡½æ•°ï¼ˆHook Functionsï¼‰</strong>: æ³¨å†Œåœ¨é’©å­ç‚¹ä¸Šçš„å¤„ç†å‡½æ•°</li><li><strong>ä¼˜å…ˆçº§ç³»ç»Ÿ</strong>: å†³å®šå¤šä¸ªé’©å­å‡½æ•°çš„æ‰§è¡Œé¡ºåº</li><li><strong>è¿”å›å€¼æœºåˆ¶</strong>: æ§åˆ¶æ•°æ®åŒ…çš„åç»­å¤„ç†æµç¨‹</li></ul><h3 id="äº”ä¸ªä¸»è¦é’©å­ç‚¹"><a href="#äº”ä¸ªä¸»è¦é’©å­ç‚¹" class="headerlink" title="äº”ä¸ªä¸»è¦é’©å­ç‚¹"></a>äº”ä¸ªä¸»è¦é’©å­ç‚¹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. NF_INET_PRE_ROUTING    # è·¯ç”±å†³ç­–å‰</span><br><span class="line">2. NF_INET_LOCAL_IN       # æœ¬åœ°è¾“å…¥</span><br><span class="line">3. NF_INET_FORWARD        # è½¬å‘</span><br><span class="line">4. NF_INET_LOCAL_OUT      # æœ¬åœ°è¾“å‡º</span><br><span class="line">5. NF_INET_POST_ROUTING   # è·¯ç”±å†³ç­–å</span><br></pre></td></tr></table></figure><h2 id="ğŸ“Š-æ•°æ®åŒ…å¤„ç†æµç¨‹"><a href="#ğŸ“Š-æ•°æ®åŒ…å¤„ç†æµç¨‹" class="headerlink" title="ğŸ“Š æ•°æ®åŒ…å¤„ç†æµç¨‹"></a>ğŸ“Š æ•°æ®åŒ…å¤„ç†æµç¨‹</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">flowchart TD</span><br><span class="line">    A[ç½‘ç»œæ¥å£æ¥æ”¶æ•°æ®åŒ…] --&gt; B[NF_INET_PRE_ROUTING]</span><br><span class="line">    B --&gt; C&#123;è·¯ç”±å†³ç­–&#125;</span><br><span class="line">    C --&gt;|æœ¬åœ°| D[NF_INET_LOCAL_IN]</span><br><span class="line">    C --&gt;|è½¬å‘| E[NF_INET_FORWARD]</span><br><span class="line">    D --&gt; F[æœ¬åœ°è¿›ç¨‹]</span><br><span class="line">    F --&gt; G[NF_INET_LOCAL_OUT]</span><br><span class="line">    E --&gt; H[NF_INET_POST_ROUTING]</span><br><span class="line">    G --&gt; H</span><br><span class="line">    H --&gt; I[ç½‘ç»œæ¥å£å‘é€æ•°æ®åŒ…]</span><br><span class="line">    </span><br><span class="line">    style B fill:#ff9999</span><br><span class="line">    style D fill:#ff9999</span><br><span class="line">    style E fill:#ff9999</span><br><span class="line">    style G fill:#ff9999</span><br><span class="line">    style H fill:#ff9999</span><br></pre></td></tr></table></figure><h2 id="ğŸŒ-Linuxç½‘ç»œæ•°æ®åŒ…å®Œæ•´æµç¨‹"><a href="#ğŸŒ-Linuxç½‘ç»œæ•°æ®åŒ…å®Œæ•´æµç¨‹" class="headerlink" title="ğŸŒ Linuxç½‘ç»œæ•°æ®åŒ…å®Œæ•´æµç¨‹"></a>ğŸŒ Linuxç½‘ç»œæ•°æ®åŒ…å®Œæ•´æµç¨‹</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[ç½‘å¡ç¡¬ä»¶] --&gt; B[ç½‘å¡é©±åŠ¨]</span><br><span class="line">    B --&gt; C[å†…æ ¸ç½‘ç»œæ ˆ]</span><br><span class="line">    C --&gt; D[netfilteré’©å­ç‚¹]</span><br><span class="line">    D --&gt; E[åè®®æ ˆå¤„ç†]</span><br><span class="line">    E --&gt; F[Socketå±‚]</span><br><span class="line">    F --&gt; G[åº”ç”¨ç¨‹åº]</span><br><span class="line">    </span><br><span class="line">    style D fill:#ff9999</span><br><span class="line">    style C fill:#99ccff</span><br></pre></td></tr></table></figure><h2 id="ğŸ“-netfilterçš„ç²¾ç¡®ä½ç½®"><a href="#ğŸ“-netfilterçš„ç²¾ç¡®ä½ç½®" class="headerlink" title="ğŸ“ netfilterçš„ç²¾ç¡®ä½ç½®"></a>ğŸ“ netfilterçš„ç²¾ç¡®ä½ç½®</h2><p>netfilter<strong>ä¸æ˜¯</strong>ä¸€ä¸ªç‹¬ç«‹çš„ç½‘ç»œå±‚ï¼Œè€Œæ˜¯<strong>åµŒå…¥åœ¨å†…æ ¸ç½‘ç»œåè®®æ ˆä¸­çš„é’©å­ç³»ç»Ÿ</strong>ã€‚</p><h3 id="è¯¦ç»†çš„æ•°æ®åŒ…å¤„ç†æµç¨‹"><a href="#è¯¦ç»†çš„æ•°æ®åŒ…å¤„ç†æµç¨‹" class="headerlink" title="è¯¦ç»†çš„æ•°æ®åŒ…å¤„ç†æµç¨‹"></a>è¯¦ç»†çš„æ•°æ®åŒ…å¤„ç†æµç¨‹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">flowchart TD</span><br><span class="line">    Start([å¼€å§‹]) --&gt; A[ç½‘å¡æ¥æ”¶æ•°æ®åŒ…]</span><br><span class="line">    A --&gt; B[ç½‘å¡é©±åŠ¨å¤„ç†]</span><br><span class="line">    B --&gt; C[è¿›å…¥å†…æ ¸ç½‘ç»œæ ˆ]</span><br><span class="line">    C --&gt; D[PRE_ROUTINGé’©å­]</span><br><span class="line">    D --&gt; E&#123;è·¯ç”±å†³ç­–&#125;</span><br><span class="line">    </span><br><span class="line">    E --&gt;|æœ¬æœºæ•°æ®åŒ…| F[LOCAL_INé’©å­]</span><br><span class="line">    F --&gt; G[ä¼ é€’ç»™åº”ç”¨ç¨‹åº]</span><br><span class="line">    G --&gt; End1([ç»“æŸ])</span><br><span class="line">    </span><br><span class="line">    E --&gt;|éœ€è¦è½¬å‘| H[FORWARDé’©å­]</span><br><span class="line">    H --&gt; I[POST_ROUTINGé’©å­]</span><br><span class="line">    I --&gt; J[ä»ç½‘å¡å‘å‡º]</span><br><span class="line">    J --&gt; End2([ç»“æŸ])</span><br><span class="line">    </span><br><span class="line">    K[åº”ç”¨ç¨‹åº] --&gt; L[LOCAL_OUTé’©å­]</span><br><span class="line">    L --&gt; M[POST_ROUTINGé’©å­]</span><br><span class="line">    M --&gt; N[ä»ç½‘å¡å‘å‡º]</span><br><span class="line">    N --&gt; End3([ç»“æŸ])</span><br><span class="line">    </span><br><span class="line">    style D fill:#ffcccc</span><br><span class="line">    style F fill:#ffcccc</span><br><span class="line">    style H fill:#ffcccc</span><br><span class="line">    style L fill:#ffcccc</span><br><span class="line">    style I fill:#ffcccc</span><br><span class="line">    style M fill:#ffcccc</span><br></pre></td></tr></table></figure><h2 id="ğŸ—ï¸-åœ¨ç½‘ç»œåè®®æ ˆä¸­çš„å…·ä½“ä½ç½®"><a href="#ğŸ—ï¸-åœ¨ç½‘ç»œåè®®æ ˆä¸­çš„å…·ä½“ä½ç½®" class="headerlink" title="ğŸ—ï¸ åœ¨ç½‘ç»œåè®®æ ˆä¸­çš„å…·ä½“ä½ç½®"></a>ğŸ—ï¸ åœ¨ç½‘ç»œåè®®æ ˆä¸­çš„å…·ä½“ä½ç½®</h2><h3 id="å®Œæ•´çš„ç½‘ç»œå±‚æ¬¡ç»“æ„"><a href="#å®Œæ•´çš„ç½‘ç»œå±‚æ¬¡ç»“æ„" class="headerlink" title="å®Œæ•´çš„ç½‘ç»œå±‚æ¬¡ç»“æ„"></a>å®Œæ•´çš„ç½‘ç»œå±‚æ¬¡ç»“æ„</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[åº”ç”¨ç¨‹åº&lt;br/&gt;HTTP, SSHç­‰] --&gt; B[Socket API]</span><br><span class="line">    B --&gt; C[ä¼ è¾“å±‚&lt;br/&gt;TCP/UDP]</span><br><span class="line">    C --&gt; D[ç½‘ç»œå±‚ IP + netfilteré’©å­]</span><br><span class="line">    D --&gt; E[æ•°æ®é“¾è·¯å±‚&lt;br/&gt;Ethernet]</span><br><span class="line">    E --&gt; F[ç‰©ç†å±‚&lt;br/&gt;ç½‘å¡é©±åŠ¨]</span><br><span class="line">    </span><br><span class="line">    style D fill:#ffcccc</span><br><span class="line">    </span><br><span class="line">    G[netfilteråœ¨è¿™é‡Œ!] -.-&gt; D</span><br><span class="line">    style G fill:#yellow</span><br></pre></td></tr></table></figure><h2 id="ğŸ¯-å®é™…ä¾‹å­ï¼šæ•°æ®åŒ…çš„æ—…ç¨‹"><a href="#ğŸ¯-å®é™…ä¾‹å­ï¼šæ•°æ®åŒ…çš„æ—…ç¨‹" class="headerlink" title="ğŸ¯ å®é™…ä¾‹å­ï¼šæ•°æ®åŒ…çš„æ—…ç¨‹"></a>ğŸ¯ å®é™…ä¾‹å­ï¼šæ•°æ®åŒ…çš„æ—…ç¨‹</h2><h3 id="åœºæ™¯ï¼šå¤–éƒ¨HTTPè¯·æ±‚è®¿é—®æœ¬æœº80ç«¯å£"><a href="#åœºæ™¯ï¼šå¤–éƒ¨HTTPè¯·æ±‚è®¿é—®æœ¬æœº80ç«¯å£" class="headerlink" title="åœºæ™¯ï¼šå¤–éƒ¨HTTPè¯·æ±‚è®¿é—®æœ¬æœº80ç«¯å£"></a>åœºæ™¯ï¼šå¤–éƒ¨HTTPè¯·æ±‚è®¿é—®æœ¬æœº80ç«¯å£</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">flowchart TD</span><br><span class="line">    A[ç½‘å¡æ¥æ”¶åˆ°TCPåŒ…&lt;br/&gt;ç›®æ ‡ç«¯å£80] --&gt; B[ç½‘å¡é©±åŠ¨å°†åŒ…ä¼ é€’ç»™å†…æ ¸]</span><br><span class="line">    B --&gt; C[IPå±‚å¼€å§‹å¤„ç†]</span><br><span class="line">    C --&gt; D[PRE_ROUTINGé’©å­]</span><br><span class="line">    D --&gt; E[è·¯ç”±å†³ç­–:è¿™æ˜¯å‘ç»™æœ¬æœºçš„åŒ…]</span><br><span class="line">    E --&gt; F[LOCAL_INé’©å­]</span><br><span class="line">    F --&gt; G[ä¼ é€’ç»™TCPå±‚]</span><br><span class="line">    G --&gt; H[ä¼ é€’ç»™ç›‘å¬80ç«¯å£çš„åº”ç”¨ç¨‹åº&lt;br/&gt;å¦‚Apache]</span><br><span class="line">    </span><br><span class="line">    D -.-&gt; D1[iptables DNATè§„åˆ™æ£€æŸ¥&lt;br/&gt;è¿æ¥è·Ÿè¸ªè®°å½•&lt;br/&gt;å¯èƒ½çš„ç«¯å£è½¬å‘]</span><br><span class="line">    F -.-&gt; F1[iptables INPUTé“¾è§„åˆ™æ£€æŸ¥&lt;br/&gt;é˜²ç«å¢™è¿‡æ»¤&lt;br/&gt;ACCEPTç»§ç»­,DROPä¸¢å¼ƒ]</span><br><span class="line">    </span><br><span class="line">    style D fill:#ffcccc</span><br><span class="line">    style F fill:#ffcccc</span><br><span class="line">    style D1 fill:#ffffcc</span><br><span class="line">    style F1 fill:#ffffcc</span><br></pre></td></tr></table></figure><h3 id="åœºæ™¯ï¼šæœ¬æœºä½œä¸ºè·¯ç”±å™¨è½¬å‘æ•°æ®åŒ…"><a href="#åœºæ™¯ï¼šæœ¬æœºä½œä¸ºè·¯ç”±å™¨è½¬å‘æ•°æ®åŒ…" class="headerlink" title="åœºæ™¯ï¼šæœ¬æœºä½œä¸ºè·¯ç”±å™¨è½¬å‘æ•°æ®åŒ…"></a>åœºæ™¯ï¼šæœ¬æœºä½œä¸ºè·¯ç”±å™¨è½¬å‘æ•°æ®åŒ…</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">flowchart TD</span><br><span class="line">    A[ç½‘å¡Aæ¥æ”¶åˆ°æ•°æ®åŒ…] --&gt; B[PRE_ROUTINGé’©å­]</span><br><span class="line">    B --&gt; C[è·¯ç”±å†³ç­–:éœ€è¦ä»ç½‘å¡Bè½¬å‘å‡ºå»]</span><br><span class="line">    C --&gt; D[FORWARDé’©å­]</span><br><span class="line">    D --&gt; E[POST_ROUTINGé’©å­]</span><br><span class="line">    E --&gt; F[ä»ç½‘å¡Bå‘å‡º]</span><br><span class="line">    </span><br><span class="line">    B -.-&gt; B1[NAT PREROUTINGè§„åˆ™]</span><br><span class="line">    D -.-&gt; D1[iptables FORWARDé“¾æ£€æŸ¥&lt;br/&gt;è½¬å‘ç­–ç•¥éªŒè¯]</span><br><span class="line">    E -.-&gt; E1[NAT POSTROUTINGè§„åˆ™&lt;br/&gt;MASQUERADEå¤„ç†]</span><br><span class="line">    </span><br><span class="line">    style B fill:#ffcccc</span><br><span class="line">    style D fill:#ffcccc</span><br><span class="line">    style E fill:#ffcccc</span><br><span class="line">    style B1 fill:#ffffcc</span><br><span class="line">    style D1 fill:#ffffcc</span><br><span class="line">    style E1 fill:#ffffcc</span><br></pre></td></tr></table></figure><h2 id="ğŸ› ï¸-ä¸»è¦åŠŸèƒ½"><a href="#ğŸ› ï¸-ä¸»è¦åŠŸèƒ½" class="headerlink" title="ğŸ› ï¸ ä¸»è¦åŠŸèƒ½"></a>ğŸ› ï¸ ä¸»è¦åŠŸèƒ½</h2><h3 id="netfilteråŠŸèƒ½æ¶æ„"><a href="#netfilteråŠŸèƒ½æ¶æ„" class="headerlink" title="netfilteråŠŸèƒ½æ¶æ„"></a>netfilteråŠŸèƒ½æ¶æ„</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mindmap</span><br><span class="line">  root((netfilter))</span><br><span class="line">    æ•°æ®åŒ…è¿‡æ»¤</span><br><span class="line">      æº/ç›®æ ‡IPè¿‡æ»¤</span><br><span class="line">      ç«¯å£å·è¿‡æ»¤</span><br><span class="line">      åè®®ç±»å‹è¿‡æ»¤</span><br><span class="line">      çŠ¶æ€è·Ÿè¸ªè¿‡æ»¤</span><br><span class="line">    ç½‘ç»œåœ°å€è½¬æ¢</span><br><span class="line">      SNATæºåœ°å€è½¬æ¢</span><br><span class="line">      DNATç›®æ ‡åœ°å€è½¬æ¢</span><br><span class="line">      MASQUERADEåœ°å€ä¼ªè£…</span><br><span class="line">      ç«¯å£æ˜ å°„</span><br><span class="line">    æ•°æ®åŒ…ä¿®æ”¹</span><br><span class="line">      IPå¤´éƒ¨ä¿®æ”¹</span><br><span class="line">      ä¼ è¾“å±‚å¤´éƒ¨ä¿®æ”¹</span><br><span class="line">      æ•°æ®åŒ…æ ‡è®°</span><br><span class="line">      QoSæ ‡è®°</span><br><span class="line">    è¿æ¥è·Ÿè¸ª</span><br><span class="line">      TCPè¿æ¥çŠ¶æ€</span><br><span class="line">      UDPä¼ªè¿æ¥</span><br><span class="line">      ç›¸å…³è¿æ¥å¤„ç†</span><br></pre></td></tr></table></figure><h2 id="ğŸ”§-åŸºäºnetfilterçš„å·¥å…·"><a href="#ğŸ”§-åŸºäºnetfilterçš„å·¥å…·" class="headerlink" title="ğŸ”§ åŸºäºnetfilterçš„å·¥å…·"></a>ğŸ”§ åŸºäºnetfilterçš„å·¥å…·</h2><h3 id="å·¥å…·ç”Ÿæ€ç³»ç»Ÿ"><a href="#å·¥å…·ç”Ÿæ€ç³»ç»Ÿ" class="headerlink" title="å·¥å…·ç”Ÿæ€ç³»ç»Ÿ"></a>å·¥å…·ç”Ÿæ€ç³»ç»Ÿ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[netfilterå†…æ ¸æ¡†æ¶] --&gt; B[iptables]</span><br><span class="line">    A --&gt; C[nftables]</span><br><span class="line">    A --&gt; D[conntrack]</span><br><span class="line">    A --&gt; E[ebtables]</span><br><span class="line">    A --&gt; F[arptables]</span><br><span class="line">    </span><br><span class="line">    B --&gt; B1[é˜²ç«å¢™è§„åˆ™]</span><br><span class="line">    B --&gt; B2[NATé…ç½®]</span><br><span class="line">    B --&gt; B3[ç«¯å£è½¬å‘]</span><br><span class="line">    </span><br><span class="line">    C --&gt; C1[æ–°ä¸€ä»£é˜²ç«å¢™]</span><br><span class="line">    C --&gt; C2[ç»Ÿä¸€è§„åˆ™è¯­æ³•]</span><br><span class="line">    C --&gt; C3[æ›´å¥½çš„æ€§èƒ½]</span><br><span class="line">    </span><br><span class="line">    D --&gt; D1[è¿æ¥è·Ÿè¸ª]</span><br><span class="line">    D --&gt; D2[çŠ¶æ€ç›‘æ§]</span><br><span class="line">    D --&gt; D3[è¿æ¥ç®¡ç†]</span><br><span class="line">    </span><br><span class="line">    style A fill:#ff9999</span><br><span class="line">    style B fill:#99ccff</span><br><span class="line">    style C fill:#99ccff</span><br><span class="line">    style D fill:#99ccff</span><br><span class="line">    style E fill:#99ccff</span><br><span class="line">    style F fill:#99ccff</span><br></pre></td></tr></table></figure><h2 id="ğŸ’»-ç¼–ç¨‹æ¥å£"><a href="#ğŸ’»-ç¼–ç¨‹æ¥å£" class="headerlink" title="ğŸ’» ç¼–ç¨‹æ¥å£"></a>ğŸ’» ç¼–ç¨‹æ¥å£</h2><h3 id="å†…æ ¸æ¨¡å—å¼€å‘"><a href="#å†…æ ¸æ¨¡å—å¼€å‘" class="headerlink" title="å†…æ ¸æ¨¡å—å¼€å‘"></a>å†…æ ¸æ¨¡å—å¼€å‘</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/netfilter.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/netfilter_ipv4.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">hook_func</span><span class="params">(<span class="type">void</span> *priv,</span></span><br><span class="line"><span class="params">                              <span class="keyword">struct</span> sk_buff *skb,</span></span><br><span class="line"><span class="params">                              <span class="type">const</span> <span class="keyword">struct</span> nf_hook_state *state)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// å¤„ç†æ•°æ®åŒ…</span></span><br><span class="line">    <span class="keyword">return</span> NF_ACCEPT;  <span class="comment">// æˆ– NF_DROP, NF_STOLEN, NF_QUEUE, NF_REPEAT</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">nf_hook_ops</span> <span class="title">netfilter_ops</span> =</span> &#123;</span><br><span class="line">    .hook = hook_func,</span><br><span class="line">    .hooknum = NF_INET_PRE_ROUTING,</span><br><span class="line">    .pf = PF_INET,</span><br><span class="line">    .priority = NF_IP_PRI_FIRST,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="ç”¨æˆ·ç©ºé—´æ¥å£"><a href="#ç”¨æˆ·ç©ºé—´æ¥å£" class="headerlink" title="ç”¨æˆ·ç©ºé—´æ¥å£"></a>ç”¨æˆ·ç©ºé—´æ¥å£</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// libnetfilter_queue ç¤ºä¾‹</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;libnetfilter_queue/libnetfilter_queue.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cb</span><span class="params">(<span class="keyword">struct</span> nfq_q_handle *qh, <span class="keyword">struct</span> nfgenmsg *nfmsg,</span></span><br><span class="line"><span class="params">              <span class="keyword">struct</span> nfq_data *nfa, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// å¤„ç†é˜Ÿåˆ—ä¸­çš„æ•°æ®åŒ…</span></span><br><span class="line">    <span class="keyword">return</span> nfq_set_verdict(qh, id, NF_ACCEPT, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ğŸ¯-åº”ç”¨åœºæ™¯"><a href="#ğŸ¯-åº”ç”¨åœºæ™¯" class="headerlink" title="ğŸ¯ åº”ç”¨åœºæ™¯"></a>ğŸ¯ åº”ç”¨åœºæ™¯</h2><h3 id="åº”ç”¨åœºæ™¯åˆ†ç±»"><a href="#åº”ç”¨åœºæ™¯åˆ†ç±»" class="headerlink" title="åº”ç”¨åœºæ™¯åˆ†ç±»"></a>åº”ç”¨åœºæ™¯åˆ†ç±»</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    A[netfilteråº”ç”¨åœºæ™¯] --&gt; B[ç½‘ç»œå®‰å…¨]</span><br><span class="line">    A --&gt; C[ç½‘ç»œç®¡ç†]</span><br><span class="line">    A --&gt; D[æ€§èƒ½ä¼˜åŒ–]</span><br><span class="line">    A --&gt; E[ç›‘æ§å®¡è®¡]</span><br><span class="line">    </span><br><span class="line">    B --&gt; B1[é˜²ç«å¢™]</span><br><span class="line">    B --&gt; B2[å…¥ä¾µé˜²æŠ¤]</span><br><span class="line">    B --&gt; B3[è®¿é—®æ§åˆ¶]</span><br><span class="line">    </span><br><span class="line">    C --&gt; C1[è´Ÿè½½å‡è¡¡]</span><br><span class="line">    C --&gt; C2[NATç½‘å…³]</span><br><span class="line">    C --&gt; C3[è·¯ç”±ç­–ç•¥]</span><br><span class="line">    </span><br><span class="line">    D --&gt; D1[æµé‡æ•´å½¢]</span><br><span class="line">    D --&gt; D2[å¸¦å®½æ§åˆ¶]</span><br><span class="line">    D --&gt; D3[QoSç®¡ç†]</span><br><span class="line">    </span><br><span class="line">    E --&gt; E1[æµé‡åˆ†æ]</span><br><span class="line">    E --&gt; E2[è¿æ¥ç›‘æ§]</span><br><span class="line">    E --&gt; E3[å®‰å…¨å®¡è®¡]</span><br><span class="line">    </span><br><span class="line">    style A fill:#ff9999</span><br><span class="line">    style B fill:#99ccff</span><br><span class="line">    style C fill:#99ccff</span><br><span class="line">    style D fill:#99ccff</span><br><span class="line">    style E fill:#99ccff</span><br></pre></td></tr></table></figure><h2 id="âš¡-æ€§èƒ½ç‰¹ç‚¹"><a href="#âš¡-æ€§èƒ½ç‰¹ç‚¹" class="headerlink" title="âš¡ æ€§èƒ½ç‰¹ç‚¹"></a>âš¡ æ€§èƒ½ç‰¹ç‚¹</h2><h3 id="æ€§èƒ½ä¼˜åŠ¿ä¸æ³¨æ„äº‹é¡¹"><a href="#æ€§èƒ½ä¼˜åŠ¿ä¸æ³¨æ„äº‹é¡¹" class="headerlink" title="æ€§èƒ½ä¼˜åŠ¿ä¸æ³¨æ„äº‹é¡¹"></a>æ€§èƒ½ä¼˜åŠ¿ä¸æ³¨æ„äº‹é¡¹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[netfilteræ€§èƒ½ç‰¹ç‚¹] --&gt; B[ä¼˜åŠ¿]</span><br><span class="line">    A --&gt; C[æ³¨æ„äº‹é¡¹]</span><br><span class="line">    </span><br><span class="line">    B --&gt; B1[å†…æ ¸çº§å¤„ç†&lt;br/&gt;é«˜æ€§èƒ½ï¼Œä½å»¶è¿Ÿ]</span><br><span class="line">    B --&gt; B2[é›¶æ‹·è´&lt;br/&gt;é¿å…ä¸å¿…è¦çš„æ•°æ®å¤åˆ¶]</span><br><span class="line">    B --&gt; B3[æ¨¡å—åŒ–è®¾è®¡&lt;br/&gt;çµæ´»çš„åŠŸèƒ½ç»„åˆ]</span><br><span class="line">    B --&gt; B4[çŠ¶æ€è·Ÿè¸ª&lt;br/&gt;æ™ºèƒ½çš„è¿æ¥ç®¡ç†]</span><br><span class="line">    </span><br><span class="line">    C --&gt; C1[CPUå¼€é”€&lt;br/&gt;å¤æ‚è§„åˆ™ä¼šå½±å“æ€§èƒ½]</span><br><span class="line">    C --&gt; C2[å†…å­˜ä½¿ç”¨&lt;br/&gt;è¿æ¥è·Ÿè¸ªè¡¨å ç”¨å†…å­˜]</span><br><span class="line">    C --&gt; C3[è§„åˆ™ä¼˜åŒ–&lt;br/&gt;éœ€è¦åˆç†è®¾è®¡è§„åˆ™é¡ºåº]</span><br><span class="line">    </span><br><span class="line">    style B fill:#ccffcc</span><br><span class="line">    style C fill:#ffcccc</span><br></pre></td></tr></table></figure><h2 id="ğŸ”„-ä¸å…¶ä»–ç»„ä»¶çš„å…³ç³»"><a href="#ğŸ”„-ä¸å…¶ä»–ç»„ä»¶çš„å…³ç³»" class="headerlink" title="ğŸ”„ ä¸å…¶ä»–ç»„ä»¶çš„å…³ç³»"></a>ğŸ”„ ä¸å…¶ä»–ç»„ä»¶çš„å…³ç³»</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[åº”ç”¨å±‚å·¥å…·] --&gt; B[ç”¨æˆ·ç©ºé—´åº“]</span><br><span class="line">    B --&gt; C[ç³»ç»Ÿè°ƒç”¨æ¥å£]</span><br><span class="line">    C --&gt; D[netfilteræ¡†æ¶]</span><br><span class="line">    D --&gt; E[ç½‘ç»œåè®®æ ˆ]</span><br><span class="line">    E --&gt; F[ç½‘ç»œè®¾å¤‡é©±åŠ¨]</span><br><span class="line">    </span><br><span class="line">    A1[iptables] --&gt; A</span><br><span class="line">    A2[nftables] --&gt; A</span><br><span class="line">    </span><br><span class="line">    B1[libnetfilter_*] --&gt; B</span><br><span class="line">    </span><br><span class="line">    C1[netlink socket] --&gt; C</span><br><span class="line">    C2[sysfsæ¥å£] --&gt; C</span><br><span class="line">    </span><br><span class="line">    D1[é’©å­ç®¡ç†] --&gt; D</span><br><span class="line">    D2[è§„åˆ™åŒ¹é…] --&gt; D</span><br><span class="line">    D3[è¿æ¥è·Ÿè¸ª] --&gt; D</span><br><span class="line">    </span><br><span class="line">    E1[TCP/IP] --&gt; E</span><br><span class="line">    E2[è·¯ç”±å­ç³»ç»Ÿ] --&gt; E</span><br><span class="line">    </span><br><span class="line">    F1[ä»¥å¤ªç½‘é©±åŠ¨] --&gt; F</span><br><span class="line">    F2[æ— çº¿ç½‘å¡é©±åŠ¨] --&gt; F</span><br><span class="line">    </span><br><span class="line">    style D fill:#ff9999</span><br><span class="line">    style E fill:#99ccff</span><br></pre></td></tr></table></figure><h2 id="ğŸ”-netfilteré’©å­è¯¦ç»†æµç¨‹"><a href="#ğŸ”-netfilteré’©å­è¯¦ç»†æµç¨‹" class="headerlink" title="ğŸ” netfilteré’©å­è¯¦ç»†æµç¨‹"></a>ğŸ” netfilteré’©å­è¯¦ç»†æµç¨‹</h2><h3 id="é’©å­æ‰§è¡Œæœºåˆ¶"><a href="#é’©å­æ‰§è¡Œæœºåˆ¶" class="headerlink" title="é’©å­æ‰§è¡Œæœºåˆ¶"></a>é’©å­æ‰§è¡Œæœºåˆ¶</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">    participant App as åº”ç”¨ç¨‹åº</span><br><span class="line">    participant Kernel as å†…æ ¸ç½‘ç»œæ ˆ</span><br><span class="line">    participant Hook as netfilteré’©å­</span><br><span class="line">    participant Rule as è§„åˆ™å¼•æ“</span><br><span class="line">    participant Target as ç›®æ ‡åŠ¨ä½œ</span><br><span class="line">    </span><br><span class="line">    Note over Kernel: æ•°æ®åŒ…åˆ°è¾¾é’©å­ç‚¹</span><br><span class="line">    Kernel-&gt;&gt;Hook: è°ƒç”¨é’©å­å‡½æ•°</span><br><span class="line">    Hook-&gt;&gt;Rule: éå†è§„åˆ™é“¾</span><br><span class="line">    </span><br><span class="line">    alt è§„åˆ™åŒ¹é…</span><br><span class="line">        Rule-&gt;&gt;Target: æ‰§è¡Œç›®æ ‡åŠ¨ä½œ</span><br><span class="line">        Target--&gt;&gt;Hook: è¿”å›å¤„ç†ç»“æœ</span><br><span class="line">    else æ— åŒ¹é…è§„åˆ™</span><br><span class="line">        Rule--&gt;&gt;Hook: è¿”å›é»˜è®¤ç­–ç•¥</span><br><span class="line">    end</span><br><span class="line">    </span><br><span class="line">    alt NF_ACCEPT</span><br><span class="line">        Hook--&gt;&gt;Kernel: ç»§ç»­å¤„ç†</span><br><span class="line">        Kernel-&gt;&gt;App: ä¼ é€’ç»™åº”ç”¨</span><br><span class="line">    else NF_DROP</span><br><span class="line">        Hook--&gt;&gt;Kernel: ä¸¢å¼ƒæ•°æ®åŒ…</span><br><span class="line">    else NF_QUEUE</span><br><span class="line">        Hook--&gt;&gt;App: ä¼ é€’ç»™ç”¨æˆ·ç©ºé—´</span><br><span class="line">    end</span><br></pre></td></tr></table></figure><h2 id="ğŸ’¡-å…³é”®ç†è§£ç‚¹"><a href="#ğŸ’¡-å…³é”®ç†è§£ç‚¹" class="headerlink" title="ğŸ’¡ å…³é”®ç†è§£ç‚¹"></a>ğŸ’¡ å…³é”®ç†è§£ç‚¹</h2><h3 id="netfilteræ ¸å¿ƒæ¦‚å¿µ"><a href="#netfilteræ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="netfilteræ ¸å¿ƒæ¦‚å¿µ"></a>netfilteræ ¸å¿ƒæ¦‚å¿µ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mindmap</span><br><span class="line">  root((netfilteræ ¸å¿ƒæ¦‚å¿µ))</span><br><span class="line">    é’©å­ç³»ç»Ÿ</span><br><span class="line">      åµŒå…¥åœ¨IPå±‚ä¸­</span><br><span class="line">      ä¸æ˜¯ç‹¬ç«‹ç½‘ç»œå±‚</span><br><span class="line">      æ¯ä¸ªåŒ…éƒ½ç»è¿‡é’©å­ç‚¹</span><br><span class="line">      æ”¯æŒå¤šæ¨¡å—æ³¨å†Œ</span><br><span class="line">    è¿”å›å€¼æœºåˆ¶</span><br><span class="line">      NF_ACCEPTç»§ç»­å¤„ç†</span><br><span class="line">      NF_DROPä¸¢å¼ƒæ•°æ®åŒ…</span><br><span class="line">      NF_STOLENé’©å­æ¥ç®¡</span><br><span class="line">      NF_QUEUEç”¨æˆ·ç©ºé—´å¤„ç†</span><br><span class="line">      NF_REPEATé‡æ–°å¤„ç†</span><br><span class="line">    ä¼˜å…ˆçº§ç³»ç»Ÿ</span><br><span class="line">      å†³å®šæ‰§è¡Œé¡ºåº</span><br><span class="line">      æ”¯æŒå¤šä¸ªé’©å­å‡½æ•°</span><br><span class="line">      çµæ´»çš„æ¨¡å—ç»„åˆ</span><br><span class="line">    è®¾è®¡å“²å­¦</span><br><span class="line">      æœºåˆ¶ä¸ç­–ç•¥åˆ†ç¦»</span><br><span class="line">      å†…æ ¸æä¾›æœºåˆ¶</span><br><span class="line">      ç”¨æˆ·ç©ºé—´å®ç°ç­–ç•¥</span><br></pre></td></tr></table></figure><h2 id="ğŸ¯-æ€»ç»“"><a href="#ğŸ¯-æ€»ç»“" class="headerlink" title="ğŸ¯ æ€»ç»“"></a>ğŸ¯ æ€»ç»“</h2><p>netfilteræ˜¯Linuxç½‘ç»œå®‰å…¨å’Œç½‘ç»œç®¡ç†çš„åŸºç¡€è®¾æ–½ï¼Œä¸ºæ„å»ºé˜²ç«å¢™ã€NATã€è´Ÿè½½å‡è¡¡ç­‰ç½‘ç»œåŠŸèƒ½æä¾›äº†å¼ºå¤§è€Œçµæ´»çš„åº•å±‚æ”¯æŒã€‚å®ƒçš„è®¾è®¡å“²å­¦æ˜¯â€æœºåˆ¶ä¸ç­–ç•¥åˆ†ç¦»â€ï¼Œå†…æ ¸æä¾›æœºåˆ¶ï¼Œç”¨æˆ·ç©ºé—´å·¥å…·å®ç°ç­–ç•¥ã€‚</p><h3 id="netfilterçš„æœ¬è´¨"><a href="#netfilterçš„æœ¬è´¨" class="headerlink" title="netfilterçš„æœ¬è´¨"></a>netfilterçš„æœ¬è´¨</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    A[æ•°æ®åŒ…] --&gt; B[æ£€æŸ¥ç«™1&lt;br/&gt;PRE_ROUTING]</span><br><span class="line">    B --&gt; C[æ£€æŸ¥ç«™2&lt;br/&gt;LOCAL_IN/FORWARD]</span><br><span class="line">    C --&gt; D[æ£€æŸ¥ç«™3&lt;br/&gt;LOCAL_OUT]</span><br><span class="line">    D --&gt; E[æ£€æŸ¥ç«™4&lt;br/&gt;POST_ROUTING]</span><br><span class="line">    E --&gt; F[æ•°æ®åŒ…ç»§ç»­ä¼ è¾“]</span><br><span class="line">    </span><br><span class="line">    style B fill:#ffcccc</span><br><span class="line">    style C fill:#ffcccc</span><br><span class="line">    style D fill:#ffcccc</span><br><span class="line">    style E fill:#ffcccc</span><br><span class="line">    </span><br><span class="line">    G[netfilter = å†…æ ¸ç½‘ç»œæ ˆä¸­çš„æ£€æŸ¥ç«™ç³»ç»Ÿ] -.-&gt; B</span><br><span class="line">    G -.-&gt; C</span><br><span class="line">    G -.-&gt; D</span><br><span class="line">    G -.-&gt; E</span><br><span class="line">    </span><br><span class="line">    style G fill:#yellow</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œnetfilterå°±åƒæ˜¯åœ¨å†…æ ¸ç½‘ç»œæ ˆçš„å…³é”®ä½ç½®è®¾ç½®çš„â€æ£€æŸ¥ç«™â€ï¼Œæ¯ä¸ªæ•°æ®åŒ…éƒ½å¿…é¡»é€šè¿‡è¿™äº›æ£€æŸ¥ç«™ï¼Œåœ¨é‚£é‡Œå¯ä»¥è¢«æ£€æŸ¥ã€ä¿®æ”¹æˆ–ä¸¢å¼ƒã€‚</p>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>JDK çº¿ç¨‹æ± é‡ŒçœŸçš„åŒºåˆ† æ ¸å¿ƒçº¿ç¨‹ä¸éæ ¸å¿ƒçº¿ç¨‹å—ï¼Ÿ</title>
      <link href="/2025/06/07/JDK%20%E7%BA%BF%E7%A8%8B%E6%B1%A0%E9%87%8C%E7%9C%9F%E7%9A%84%E5%8C%BA%E5%88%86%20%E6%A0%B8%E5%BF%83%E7%BA%BF%E7%A8%8B%E4%B8%8E%E9%9D%9E%E6%A0%B8%E5%BF%83%E7%BA%BF%E7%A8%8B%E5%90%97%EF%BC%9F/"/>
      <url>/2025/06/07/JDK%20%E7%BA%BF%E7%A8%8B%E6%B1%A0%E9%87%8C%E7%9C%9F%E7%9A%84%E5%8C%BA%E5%88%86%20%E6%A0%B8%E5%BF%83%E7%BA%BF%E7%A8%8B%E4%B8%8E%E9%9D%9E%E6%A0%B8%E5%BF%83%E7%BA%BF%E7%A8%8B%E5%90%97%EF%BC%9F/</url>
      
        <content type="html"><![CDATA[<h1 id="JDK-çº¿ç¨‹æ± é‡ŒçœŸçš„åŒºåˆ†-æ ¸å¿ƒçº¿ç¨‹ä¸éæ ¸å¿ƒçº¿ç¨‹å—ï¼Ÿ"><a href="#JDK-çº¿ç¨‹æ± é‡ŒçœŸçš„åŒºåˆ†-æ ¸å¿ƒçº¿ç¨‹ä¸éæ ¸å¿ƒçº¿ç¨‹å—ï¼Ÿ" class="headerlink" title="JDK çº¿ç¨‹æ± é‡ŒçœŸçš„åŒºåˆ† æ ¸å¿ƒçº¿ç¨‹ä¸éæ ¸å¿ƒçº¿ç¨‹å—ï¼Ÿ"></a>JDK çº¿ç¨‹æ± é‡ŒçœŸçš„åŒºåˆ† æ ¸å¿ƒçº¿ç¨‹ä¸éæ ¸å¿ƒçº¿ç¨‹å—ï¼Ÿ</h1><p>ä¸å°‘æ ¡æ‹›å°ä¼™ä¼´å¯¹äºçº¿ç¨‹æ± çš„äº†è§£ï¼Œå¤§æ¦‚å°±æ˜¯å¦‚ä¸‹å›¾ï¼š</p><ul><li>å½“æ ¸å¿ƒçº¿ç¨‹æ•°æœªæ»¡ï¼Œåˆ™æ–°å»ºæ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œä»»åŠ¡</li><li>å½“æ ¸å¿ƒçº¿ç¨‹æ•°æ»¡äº†ï¼Œé˜Ÿåˆ—æœªæ»¡ï¼Œåˆ™å°†ä»»åŠ¡æ”¾åœ¨ç­‰å¾…é˜Ÿåˆ—é‡Œï¼Œç­‰å¾…æ ¸å¿ƒçº¿ç¨‹å»æ‰§è¡Œ</li><li>å½“æ ¸å¿ƒçº¿ç¨‹æ•°æ»¡äº†ï¼ˆä½†æœªè¾¾æœ€å¤§çº¿ç¨‹æ•°ï¼‰ï¼Œé˜Ÿåˆ—ä¹Ÿæ»¡äº†ï¼Œæ–°å»ºéæ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œä»»åŠ¡</li><li>å¦‚æœå·²ç»è¾¾åˆ°æœ€å¤§çº¿ç¨‹æ•°ï¼Œä¸”é˜Ÿåˆ—ä¹Ÿæ»¡äº†ï¼Œåˆ™æ‰§è¡Œé¥±å’Œç­–ç•¥ã€‚</li></ul><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1741656129655-700e91f7-bbd8-44f0-8c1b-c8475cd0471f.png" alt="img"></p><p>ä½†æ˜¯è¿™æ ·çš„äº†è§£ï¼Œå¯èƒ½æ˜¯ä¸å¤Ÿçš„ã€‚å› ä¸ºè¿™åªæ˜¯ä¸€ä¸ªåŸºç¡€çš„æµç¨‹ï¼Œç¨å¾®é—®ç»†ä¸€ç‚¹ã€æ·±ä¸€ç‚¹å°±ä¸å¤Ÿç”¨äº†ã€‚æ¯”å¦‚ï¼Œæˆ‘å¯èƒ½ä¼šé—®ä¸‹é¢è¿™äº›é—®é¢˜ï¼š</p><ul><li>éƒ½æ˜¯çŸ¥é“æ ¸å¿ƒçº¿ç¨‹é»˜è®¤æ˜¯ä¸é”€æ¯çš„ï¼Œé‚£ä¹ˆæ ¸å¿ƒçº¿ç¨‹åœ¨é˜Ÿåˆ—ä¸­æ²¡æœ‰ä»»åŠ¡æ—¶<strong>ï¼Œ</strong>å®ƒæ˜¯ä»€ä¹ˆçŠ¶æ€ï¼ˆçº¿ç¨‹çŠ¶æ€ï¼‰ï¼Œå¯¹äºæ“ä½œç³»ç»Ÿæ¥è¯´ä¼šä¸ä¼šåˆ†é…æ—¶é—´ç‰‡ç»™å®ƒï¼Ÿ</li><li>æˆ‘ä»¬ä¸€èˆ¬è‡ªå·±æ–°åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œå¯èƒ½ä½¿ç”¨ new Threadï¼Œç„¶å æ‰§è¡Œä¸€ä¸‹ start æ–¹æ³•ï¼Œç„¶åè¿™ä¸ªçº¿ç¨‹ æ‰§è¡Œå®Œrunæ–¹æ³•å†…ä»£ç ï¼Œå°±é”€æ¯äº†ã€‚çº¿ç¨‹æ±  ThreadPoolExecutor ä¸­æ˜¯å¦‚ä½•å®ç° çº¿ç¨‹å¤ç”¨çš„ï¼Ÿ</li><li>çº¿ç¨‹æ± ä¸­ åŒºåˆ† æ ¸å¿ƒçº¿ç¨‹ä¸éçº¿ç¨‹çº¿ç¨‹å—ï¼Ÿä»–ä»¬æ•°æ®ç»“æ„ä¸Šä»¥åŠè¡Œä¸ºä¸Šæœ‰ä»€ä¹ˆä¸åŒã€‚</li><li>éæ ¸å¿ƒçº¿ç¨‹æ˜¯ä¸æ˜¯åªæ‰§è¡Œ æ–°æäº¤çš„ä»»åŠ¡ï¼Œä¸æ¶ˆè´¹ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚</li></ul><p>è¿™é‡Œæˆ‘è¯¦ç»†è¯´è¯´é—®é¢˜3ï¼šçº¿ç¨‹æ± ä¸­ åŒºåˆ† æ ¸å¿ƒçº¿ç¨‹ä¸éçº¿ç¨‹çº¿ç¨‹å—ï¼Ÿ</p><p>å®é™…ä¸Šä»æºä»£ç ä¸Šçœ‹ï¼Œæ— è®ºæ˜¯ æ•°æ®ç»“æ„è¿˜æ˜¯è¡Œä¸ºä¸Šï¼Œå…¶æ ¹æ®æ²¡æœ‰å­—æ®µæ ‡è®°è¿™ä¸ª çº¿ç¨‹æ˜¯æ ¸å¿ƒçº¿ç¨‹è¿˜æ˜¯éæ ¸å¿ƒçº¿ç¨‹ã€‚çº¿ç¨‹è¢«åŒ…è£…åœ¨ä¸€ä¸ª Workå¯¹è±¡ä¸­ã€‚è¿™ä¸ª Workå¯¹è±¡ä¸­ åŒ…å«ä¸€ä¸ª Threadå¯¹è±¡å’Œ ä¸€ä¸ªRunnableå¯¹è±¡ä»¥åŠä¸€äº›å…¶ä»–å˜é‡ã€‚<strong>ä½†æ˜¯å¹¶æ²¡æœ‰å˜é‡å»åŒºåˆ†è¿™ä¸ª workå¯¹è±¡æ˜¯ æ‰€è°“æ ¸å¿ƒï¼Œè¿˜æ˜¯éæ ¸å¿ƒ<strong><strong>ã€‚</strong></strong>æ‰€ä»¥è¯´æ•°æ®ç»“æ„ä¸Šæ˜¯ä¸€è‡´çš„ã€‚</strong></p><p>æºç ä¸­å”¯ä¸€ å¸¦æœ‰æ˜¯å¦æ ¸å¿ƒçš„å˜é‡ å°±æ˜¯ ä¸‹é¢è¿™ä¸ª coreã€‚ä½†æ˜¯å®ƒçš„ä½œç”¨ï¼Œç”¨äºæ£€æŸ¥ çº¿ç¨‹æ•°æ˜¯å¦è¶…å‡ºé™åˆ¶ã€‚</p><p>å› ä¸ºçº¿ç¨‹æ± æœ‰ä¸¤ä¸ªæ‰©å®¹Workçš„æ—¶æœºï¼šä¸€ä¸ªæ˜¯åˆå§‹æ—¶æ ¸å¿ƒçº¿ç¨‹çš„æ‰©å®¹ï¼Œä¸€ä¸ªæ˜¯éæ ¸å¿ƒçº¿ç¨‹çš„æ‰©å®¹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">addWorker</span><span class="params">(Runnable firstTask, <span class="type">boolean</span> core)</span></span><br></pre></td></tr></table></figure><p>å½“æ ¸å¿ƒçº¿ç¨‹æ‰©å®¹æ—¶ï¼Œç”¨çš„æ˜¯ corePoolSizeï¼›éæ ¸å¿ƒçº¿ç¨‹æ‰©å®¹æ—¶ï¼Œç”¨çš„æ˜¯maximumPoolSizeã€‚</p><p>ä½†æ˜¯åœ¨Workè¿è¡Œåï¼Œå…¶å†…éƒ¨ä»é˜Ÿåˆ—ä¸­å–ä»»åŠ¡æˆ–è€…é”€æ¯æ—¶ï¼Œå¹¶ä¸çŸ¥é“è‡ªå·±å½“åˆæ·»åŠ çš„æ—¶å€™æ˜¯ å½“ä½œæ ¸å¿ƒçº¿ç¨‹æ¥æ‰©å®¹çš„è¿˜æ˜¯éæ ¸å¿ƒçº¿ç¨‹æ‰©å®¹çš„ã€‚</p><p>æˆ‘ä»¬å¯ä»¥çœ‹æºç ä¸­ï¼Œfinal void runWorker(Worker w) ä¸­ï¼š</p><p>æœ‰ä¸€ä¸ªforå¾ªç¯ã€‚å¦‚æœtaskä¸ºç©ºï¼Œå¹¶ä¸”ä»é˜Ÿåˆ—ä¸­å–ä¸åˆ°ä»»åŠ¡ï¼Œåˆ™ç»“æŸforå¾ªç¯ï¼Œè¿›å…¥åˆ° è´Ÿè´£æ¸…ç† Workerå’Œç®¡ç†çº¿ç¨‹çŠ¶æ€çš„processWorkerExitæ–¹æ³•é‡Œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">runWorker</span><span class="params">(Worker w)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">wt</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">Runnable</span> <span class="variable">task</span> <span class="operator">=</span> w.firstTask;</span><br><span class="line">    w.firstTask = <span class="literal">null</span>;</span><br><span class="line">    w.unlock(); <span class="comment">// allow interrupts</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">completedAbruptly</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (task != <span class="literal">null</span> || (task = getTask()) != <span class="literal">null</span>) &#123;</span><br><span class="line">            w.lock();</span><br><span class="line">            <span class="comment">// If pool is stopping, ensure thread is interrupted;</span></span><br><span class="line">            <span class="comment">// if not, ensure thread is not interrupted.  This</span></span><br><span class="line">            <span class="comment">// requires a recheck in second case to deal with</span></span><br><span class="line">            <span class="comment">// shutdownNow race while clearing interrupt</span></span><br><span class="line">            <span class="keyword">if</span> ((runStateAtLeast(ctl.get(), STOP) ||</span><br><span class="line">                 (Thread.interrupted() &amp;&amp;</span><br><span class="line">                  runStateAtLeast(ctl.get(), STOP))) &amp;&amp;</span><br><span class="line">                !wt.isInterrupted())</span><br><span class="line">                wt.interrupt();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                beforeExecute(wt, task);</span><br><span class="line">                <span class="type">Throwable</span> <span class="variable">thrown</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    task.run();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RuntimeException x) &#123;</span><br><span class="line">                    thrown = x; <span class="keyword">throw</span> x;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Error x) &#123;</span><br><span class="line">                    thrown = x; <span class="keyword">throw</span> x;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable x) &#123;</span><br><span class="line">                    thrown = x; <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(x);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    afterExecute(task, thrown);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                task = <span class="literal">null</span>;</span><br><span class="line">                w.completedTasks++;</span><br><span class="line">                w.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        completedAbruptly = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        processWorkerExit(w, completedAbruptly);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç®€å•çš„è¯´ï¼šæ¯ä¸ªWorkå¯¹è±¡ å®ƒæ˜¯ä¸çŸ¥é“è‡ªå·±çš„èº«ä»½çš„ï¼Œæ— è®ºæ˜¯ä»–è·å–é˜Ÿåˆ—ä¸­ä»»åŠ¡ï¼Œè¿˜æ˜¯é”€æ¯çš„åˆ¤æ–­æ¡ä»¶ã€‚éƒ½ä¸ä¾èµ–äºå®ƒåˆ›å»ºæ˜¯å½“ä½œæ ¸å¿ƒçº¿ç¨‹åˆ›å»ºçš„ï¼Œè¿˜æ˜¯éæ ¸å¿ƒçº¿ç¨‹ã€‚<strong>æ‰€ä»¥è¯´ä»–ä»¬çš„è¡Œä¸ºæ˜¯æ²¡æœ‰åŒºåˆ«çš„ã€‚</strong></p><p>åˆ¤æ–­ä¸€ä¸ªworkæ˜¯å¦ä¼šå› ä¸ºè¶…æ—¶é”€æ¯ï¼Œåªçœ‹ <strong>allowCoreThreadTimeOut</strong>ï¼ˆæ˜¯å¦å…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶é”€æ¯ï¼‰ å’Œ <strong>wc &gt; corePoolSize</strong> ï¼ˆå½“å‰çº¿ç¨‹æ˜¯å¦è¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æ•°ï¼‰ã€‚åªè¦ä¸¤ä¸ªæ»¡è¶³å…¶ä¸€ï¼Œå°±å¯èƒ½å› ä¸ºè¶…æ—¶é”€æ¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="variable">timed</span> <span class="operator">=</span> allowCoreThreadTimeOut || wc &gt; corePoolSize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut))</span><br><span class="line">    &amp;&amp; (wc &gt; <span class="number">1</span> || workQueue.isEmpty())) &#123;</span><br><span class="line">    <span class="keyword">if</span> (compareAndDecrementWorkerCount(c))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>MySQL ç´¢å¼•å¤±æ•ˆåœºæ™¯</title>
      <link href="/2025/06/07/MySQL%20%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88%E5%9C%BA%E6%99%AF/"/>
      <url>/2025/06/07/MySQL%20%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88%E5%9C%BA%E6%99%AF/</url>
      
        <content type="html"><![CDATA[<h1 id="MySQL-ç´¢å¼•å¤±æ•ˆåœºæ™¯"><a href="#MySQL-ç´¢å¼•å¤±æ•ˆåœºæ™¯" class="headerlink" title="MySQL ç´¢å¼•å¤±æ•ˆåœºæ™¯"></a>MySQL ç´¢å¼•å¤±æ•ˆåœºæ™¯</h1><ol><li>ç´¢å¼•åˆ—å‚ä¸è®¡ç®—æˆ–è¿›è¡Œå‡½æ•°æ“ä½œ</li><li>ä½¿ç”¨ORï¼Œå¹¶ä¸”ORçš„ä¸¤è¾¹å­˜åœ¨&lt; æˆ–è€… &gt; çš„æ—¶å€™</li><li>ä½¿ç”¨likeæ“ä½œï¼Œä½†æ˜¯ä¸æ»¡è¶³å·¦åŒ¹é…ï¼Œä¾‹å¦‚ï¼šâ€%javaâ€</li><li>éšå¼ç±»å‹è½¬æ¢ï¼Œæ¯”å¦‚ä¸€ä¸ªstringç±»å‹åˆ—ï¼Œä½¿ç”¨æ•°å­—æ¥æŸ¥è¯¢ã€‚è¿™ç§æƒ…å†µæœ‰ä¸€ä¸ªç‰¹åˆ—ï¼Œå¦‚æœå­—æ®µç±»å‹ä¸ºintç±»å‹ï¼Œè€ŒæŸ¥è¯¢æ¡ä»¶æ·»åŠ äº†å•å¼•å·æˆ–è€…åŒå¼•å·ï¼Œåˆ™Mysqlä¼šå‚æ•°è½¬åŒ–ä¸ºintç±»å‹ï¼Œè¿™ç§æƒ…å†µä¹Ÿå¯ä»¥èµ°ç´¢å¼•ã€‚</li><li>ä¸ç­‰äºæ¯”è¾ƒã€‚è¿™ç§æƒ…å†µä¹Ÿæ˜¯æœ‰å¯èƒ½ä¼šèµ°ç´¢å¼•çš„ï¼Œæ¯”å¦‚ç”¨idè¿›è¡Œ!&#x3D;ï¼Œæ˜¯å¯èƒ½èµ°ç´¢å¼•çš„ã€‚</li><li>ä½¿ç”¨is not nullæ—¶ä¸èµ°ç´¢å¼•ï¼Œä½¿ç”¨ is null èµ°ç´¢å¼•</li><li>order byã€‚å¦‚æœorder byçš„æ—¶å€™æ•°æ®é‡å¾ˆå°ï¼Œæ•°æ®åº“å¯èƒ½ç›´æ¥åœ¨å†…å­˜ä¸­è¿›è¡Œæ’åºã€‚</li><li>inã€‚ä¸€èˆ¬åœ¨inä¸­çš„å€¼æ¯”è¾ƒå°‘çš„æ—¶å€™å¯èƒ½ä¼šèµ°ç´¢å¼•ä¼˜åŒ–ï¼Œä½†å¦‚æœé€‰é¡¹æ¯”è¾ƒå¤šï¼Œå¯èƒ½ä¸èµ°ç´¢å¼•ã€‚</li><li>è”åˆç´¢å¼•å¤±æ•ˆã€‚æ¯”å¦‚è”åˆç´¢å¼•ï¼ˆaï¼Œbï¼Œcï¼‰ï¼Œè¿›è¡ŒæŸ¥è¯¢æ—¶æ²¡æœ‰æ»¡è¶³æœ€å·¦åŒ¹é…ï¼ˆæŸ¥bï¼ŒæŸ¥cï¼ŒæŸ¥b cï¼‰</li><li>å­˜å‚¨å¼•æ“ä¸èƒ½ä½¿ç”¨ç´¢å¼•èŒƒå›´æ¡ä»¶å³è¾¹çš„åˆ—</li><li>ä¸¤åˆ—åšæ¯”è¾ƒã€‚å¦‚æœä¸¤ä¸ªåˆ—æ•°æ®éƒ½æœ‰ç´¢å¼•ï¼Œä½†æ˜¯åœ¨æŸ¥è¯¢æ¡ä»¶ä¸­å¯¹ä¸¤åˆ—æ•°æ®è¿›è¡Œäº†å¯¹æ¯”æ“ä½œï¼Œåˆ™ä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆã€‚</li><li>æŸ¥è¯¢æ¡ä»¶æ˜¯ç”¨no inæ—¶ï¼Œå¦‚æœæ˜¯ä¸»é”®åˆ™èµ°ç´¢å¼•ã€‚å¦‚æœæ˜¯æ™®é€šç´¢å¼•ï¼Œåˆ™å¤±æ•ˆ</li><li>not exists ä¸èµ°ç´¢å¼•ï¼Œexists å¯èƒ½èµ°ç´¢å¼•</li></ol><hr><h3 id="1-ç´¢å¼•åˆ—å‚ä¸è®¡ç®—æˆ–å‡½æ•°æ“ä½œ"><a href="#1-ç´¢å¼•åˆ—å‚ä¸è®¡ç®—æˆ–å‡½æ•°æ“ä½œ" class="headerlink" title="1. ç´¢å¼•åˆ—å‚ä¸è®¡ç®—æˆ–å‡½æ•°æ“ä½œ"></a><strong>1. ç´¢å¼•åˆ—å‚ä¸è®¡ç®—æˆ–å‡½æ•°æ“ä½œ</strong></h3><ul><li><strong>æ­£å¸¸åˆ¤æ–­</strong>ï¼šç´¢å¼•åˆ—ç›´æ¥ä½¿ç”¨åŸå§‹å€¼ã€‚</li><li><strong>å¤±æ•ˆåŸå› </strong>ï¼šç´¢å¼•å­˜å‚¨çš„æ˜¯åˆ—åŸå§‹å€¼ï¼Œè®¡ç®—æˆ–å‡½æ•°æ“ä½œåç”Ÿæˆçš„å€¼æ— æ³•åŒ¹é…ç´¢å¼•ç»“æ„ã€‚</li><li><strong>å…·ä½“åŸç†</strong>ï¼šB+ æ ‘ç´¢å¼•åŸºäºåŸå§‹å€¼æ„å»ºï¼Œè®¡ç®—æˆ–å‡½æ•°ä¼šç ´åå€¼ä¸ç´¢å¼•çš„æ˜ å°„å…³ç³»ï¼Œå¯¼è‡´æ— æ³•é€šè¿‡ç´¢å¼•æ ‘å¿«é€Ÿå®šä½ã€‚</li><li><strong>ç¤ºä¾‹ SQL</strong>ï¼š</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å¤±æ•ˆ</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> <span class="keyword">YEAR</span>(create_time) <span class="operator">=</span> <span class="number">2023</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> a <span class="operator">+</span> <span class="number">10</span> <span class="operator">=</span> <span class="number">20</span>;</span><br><span class="line"><span class="comment">-- æ­£å¸¸</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> create_time <span class="keyword">BETWEEN</span> <span class="string">&#x27;2023-01-01&#x27;</span> <span class="keyword">AND</span> <span class="string">&#x27;2023-12-31&#x27;</span>;</span><br></pre></td></tr></table></figure><hr><h3 id="2-ä½¿ç”¨-OR-ä¸”ä¸¤è¾¹å­˜åœ¨èŒƒå›´æŸ¥è¯¢"><a href="#2-ä½¿ç”¨-OR-ä¸”ä¸¤è¾¹å­˜åœ¨èŒƒå›´æŸ¥è¯¢" class="headerlink" title="2. ä½¿ç”¨ OR ä¸”ä¸¤è¾¹å­˜åœ¨èŒƒå›´æŸ¥è¯¢"></a><strong>2. ä½¿ç”¨</strong> <code>OR</code> <strong>ä¸”ä¸¤è¾¹å­˜åœ¨èŒƒå›´æŸ¥è¯¢</strong></h3><ul><li><strong>æ­£å¸¸åˆ¤æ–­</strong>ï¼š<code>OR</code> ä¸¤ä¾§å‡æœ‰ç´¢å¼•ä¸”é€»è¾‘ç®€å•ã€‚</li><li><strong>å¤±æ•ˆåŸå› </strong>ï¼š<code>OR</code> è¦æ±‚åŒæ—¶æ»¡è¶³å¤šä¸ªæ¡ä»¶ï¼Œè‹¥ä»»æ„ä¸€ä¾§æ— ç´¢å¼•æˆ–æ¶‰åŠèŒƒå›´æŸ¥è¯¢ï¼Œä¼˜åŒ–å™¨å¯èƒ½æ”¾å¼ƒç´¢å¼•ã€‚</li><li><strong>å…·ä½“åŸç†</strong>ï¼šMySQL å¯¹ <code>OR</code> çš„ä¼˜åŒ–èƒ½åŠ›æœ‰é™ï¼Œè‹¥æ— æ³•åˆå¹¶ç´¢å¼•èŒƒå›´ï¼Œåˆ™é€‰æ‹©å…¨è¡¨æ‰«æã€‚</li><li><strong>ç¤ºä¾‹ SQL</strong>ï¼š</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å¤±æ•ˆï¼ˆå‡è®¾ d åˆ—æ— ç´¢å¼•ï¼‰</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> a <span class="operator">&gt;</span> <span class="number">10</span> <span class="keyword">OR</span> d <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line"><span class="comment">-- ä¼˜åŒ–æ–¹æ³•</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> a <span class="operator">&gt;</span> <span class="number">10</span> </span><br><span class="line"><span class="keyword">UNION</span> </span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> d <span class="operator">=</span> <span class="number">5</span>;</span><br></pre></td></tr></table></figure><hr><h3 id="3-LIKE-ä¸æ»¡è¶³å·¦åŒ¹é…"><a href="#3-LIKE-ä¸æ»¡è¶³å·¦åŒ¹é…" class="headerlink" title="3. LIKE ä¸æ»¡è¶³å·¦åŒ¹é…"></a><strong>3.</strong> <code>LIKE</code> <strong>ä¸æ»¡è¶³å·¦åŒ¹é…</strong></h3><ul><li><strong>æ­£å¸¸åˆ¤æ–­</strong>ï¼š<code>LIKE</code> ä½¿ç”¨å‰ç¼€åŒ¹é…ï¼ˆå¦‚ <code>&#39;abc%&#39;</code>ï¼‰ã€‚</li><li><strong>å¤±æ•ˆåŸå› </strong>ï¼šä»¥é€šé…ç¬¦å¼€å¤´ï¼ˆ<code>%</code> æˆ– <code>_</code>ï¼‰ç ´åç´¢å¼•å‰ç¼€æœ‰åºæ€§ã€‚</li><li><strong>å…·ä½“åŸç†</strong>ï¼šB+ æ ‘ç´¢å¼•æŒ‰å‰ç¼€æ’åºï¼Œæ— æ³•åå‘æˆ–ä¸­é—´æ¨¡ç³ŠåŒ¹é…ã€‚</li><li><strong>ç¤ºä¾‹ SQL</strong>ï¼š</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å¤±æ•ˆ</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> name <span class="keyword">LIKE</span> <span class="string">&#x27;%java&#x27;</span>;</span><br><span class="line"><span class="comment">-- æ­£å¸¸</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> name <span class="keyword">LIKE</span> <span class="string">&#x27;java%&#x27;</span>;</span><br></pre></td></tr></table></figure><hr><h3 id="4-éšå¼ç±»å‹è½¬æ¢"><a href="#4-éšå¼ç±»å‹è½¬æ¢" class="headerlink" title="4. éšå¼ç±»å‹è½¬æ¢"></a><strong>4. éšå¼ç±»å‹è½¬æ¢</strong></h3><ul><li><strong>æ­£å¸¸åˆ¤æ–­</strong>ï¼šæŸ¥è¯¢å€¼ä¸åˆ—ç±»å‹ä¸¥æ ¼ä¸€è‡´ã€‚</li><li><strong>å¤±æ•ˆåŸå› </strong>ï¼šç±»å‹ä¸åŒ¹é…å¯¼è‡´ MySQL éšå¼è½¬æ¢ï¼Œç ´åç´¢å¼•åŒ¹é…ã€‚</li><li><strong>å…·ä½“åŸç†</strong>ï¼šç´¢å¼•å­˜å‚¨çš„æ˜¯åˆ—å®šä¹‰çš„ç±»å‹ï¼Œéšå¼è½¬æ¢ç›¸å½“äºå¯¹åˆ—ä½¿ç”¨å‡½æ•°ï¼ˆå¦‚ <code>CAST</code>ï¼‰ã€‚</li><li><strong>ç¤ºä¾‹ SQL</strong>ï¼š</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å¤±æ•ˆï¼ˆå‡è®¾ a æ˜¯ VARCHARï¼‰</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> a <span class="operator">=</span> <span class="number">123</span>;  <span class="comment">-- MySQL æ‰§è¡Œ CAST(a AS INT)</span></span><br><span class="line"><span class="comment">-- æ­£å¸¸ï¼ˆç‰¹ä¾‹ï¼šå­—æ®µä¸º INTï¼ŒæŸ¥è¯¢å€¼å¸¦å¼•å·ï¼‰</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="string">&#x27;123&#x27;</span>;  <span class="comment">-- id æ˜¯ INT ç±»å‹</span></span><br></pre></td></tr></table></figure><hr><h3 id="5-ä¸ç­‰äºæ¯”è¾ƒï¼ˆ-æˆ–-ï¼‰"><a href="#5-ä¸ç­‰äºæ¯”è¾ƒï¼ˆ-æˆ–-ï¼‰" class="headerlink" title="5. ä¸ç­‰äºæ¯”è¾ƒï¼ˆ!= æˆ– &lt;&gt;ï¼‰"></a><strong>5. ä¸ç­‰äºæ¯”è¾ƒï¼ˆ</strong><code>!=</code> <strong>æˆ–</strong> <code>&lt;&gt;</code><strong>ï¼‰</strong></h3><ul><li><strong>æ­£å¸¸åˆ¤æ–­</strong>ï¼šä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•å¯èƒ½èµ°ç´¢å¼•ã€‚</li><li><strong>å¤±æ•ˆåŸå› </strong>ï¼šéä¸»é”®çš„ä¸ç­‰äºæ“ä½œéœ€æ‰«æå¤§éƒ¨åˆ†æ•°æ®ï¼Œä¼˜åŒ–å™¨è®¤ä¸ºå…¨è¡¨æ›´å¿«ã€‚</li><li><strong>å…·ä½“åŸç†</strong>ï¼šç´¢å¼•é€‚åˆå®šä½å°‘é‡æ•°æ®ï¼Œä¸ç­‰äºæ“ä½œéœ€éå†ç´¢å¼•æ ‘å¤§éƒ¨åˆ†èŠ‚ç‚¹ã€‚</li><li><strong>ç¤ºä¾‹ SQL</strong>ï¼š</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å¤±æ•ˆï¼ˆæ™®é€šç´¢å¼•ï¼‰</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> a <span class="operator">!=</span> <span class="number">5</span>;</span><br><span class="line"><span class="comment">-- æ­£å¸¸ï¼ˆä¸»é”®æˆ–è¦†ç›–ç´¢å¼•ï¼‰</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> id <span class="operator">!=</span> <span class="number">5</span>;  <span class="comment">-- id æ˜¯ä¸»é”®</span></span><br></pre></td></tr></table></figure><hr><h3 id="6-IS-NOT-NULL-ä¸-IS-NULL"><a href="#6-IS-NOT-NULL-ä¸-IS-NULL" class="headerlink" title="6. IS NOT NULL ä¸ IS NULL"></a><strong>6.</strong> <code>IS NOT NULL</code> <strong>ä¸</strong> <code>IS NULL</code></h3><ul><li><strong>æ­£å¸¸åˆ¤æ–­</strong>ï¼š<code>IS NULL</code> å¯èµ°ç´¢å¼•ï¼Œ<code>IS NOT NULL</code> å¯èƒ½å¤±æ•ˆã€‚</li><li><strong>å¤±æ•ˆåŸå› </strong>ï¼š<code>IS NOT NULL</code> éœ€éå†æ‰€æœ‰éç©ºå€¼ï¼Œæˆæœ¬é«˜ã€‚</li><li><strong>å…·ä½“åŸç†</strong>ï¼šç´¢å¼•ä¸­ <code>NULL</code> å€¼é›†ä¸­å­˜å‚¨ï¼ˆInnoDBï¼‰ï¼Œ<code>IS NULL</code> å¯å¿«é€Ÿå®šä½ï¼Œè€Œ <code>IS NOT NULL</code> éœ€æ‰«æå…¨ç´¢å¼•ã€‚</li><li><strong>ç¤ºä¾‹ SQL</strong>ï¼š</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å¤±æ•ˆ</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> a <span class="keyword">IS</span> <span class="keyword">NOT NULL</span>;</span><br><span class="line"><span class="comment">-- æ­£å¸¸</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> a <span class="keyword">IS</span> <span class="keyword">NULL</span>;</span><br></pre></td></tr></table></figure><hr><h3 id="7-ORDER-BY-æ’åº"><a href="#7-ORDER-BY-æ’åº" class="headerlink" title="7. ORDER BY æ’åº"></a><strong>7.</strong> <code>ORDER BY</code> <strong>æ’åº</strong></h3><ul><li><strong>æ­£å¸¸åˆ¤æ–­</strong>ï¼šæ’åºå­—æ®µæœ‰ç´¢å¼•ä¸”é¡ºåºä¸€è‡´ã€‚</li><li><strong>å¤±æ•ˆåŸå› </strong>ï¼šå°æ•°æ®é‡ç›´æ¥åœ¨å†…å­˜æ’åºï¼›æ’åºå­—æ®µæ— ç´¢å¼•æˆ–é¡ºåºä¸åŒ¹é…ã€‚</li><li><strong>å…·ä½“åŸç†</strong>ï¼šç´¢å¼•æœ¬èº«æœ‰åºï¼Œè‹¥ <code>ORDER BY</code> å­—æ®µä¸ç´¢å¼•é¡ºåºä¸€è‡´ï¼Œå¯é¿å… <code>filesort</code> æ“ä½œã€‚</li><li><strong>ç¤ºä¾‹ SQL</strong>ï¼š</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å¤±æ•ˆï¼ˆæ— ç´¢å¼•ï¼‰</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> a;</span><br><span class="line"><span class="comment">-- æ­£å¸¸ï¼ˆç´¢å¼•æ”¯æŒæ’åºï¼‰</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> a, b;  <span class="comment">-- ç´¢å¼• (a, b)</span></span><br></pre></td></tr></table></figure><hr><h3 id="8-IN-æ¡ä»¶"><a href="#8-IN-æ¡ä»¶" class="headerlink" title="8. IN æ¡ä»¶"></a><strong>8.</strong> <code>IN</code> <strong>æ¡ä»¶</strong></h3><ul><li><strong>æ­£å¸¸åˆ¤æ–­</strong>ï¼š<code>IN</code> åˆ—è¡¨è¾ƒçŸ­ä¸”é€‰æ‹©æ€§é«˜ã€‚</li><li><strong>å¤±æ•ˆåŸå› </strong>ï¼šé•¿åˆ—è¡¨å¯¼è‡´ä¼˜åŒ–å™¨è®¤ä¸ºå…¨è¡¨æ‰«ææ›´å¿«ã€‚</li><li><strong>å…·ä½“åŸç†</strong>ï¼š<code>IN</code> æœ¬è´¨æ˜¯å¤šä¸ª <code>OR</code>ï¼Œåˆ—è¡¨è¿‡é•¿æ—¶ç´¢å¼•æ£€ç´¢æˆæœ¬è¶…è¿‡å…¨è¡¨æ‰«æã€‚</li><li><strong>ç¤ºä¾‹ SQL</strong>ï¼š</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å¤±æ•ˆï¼ˆåˆ—è¡¨è¿‡é•¿ï¼‰</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> a <span class="keyword">IN</span> (<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,...,<span class="number">1000</span>);</span><br><span class="line"><span class="comment">-- æ­£å¸¸ï¼ˆä¸»é”®æˆ–çŸ­åˆ—è¡¨ï¼‰</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> id <span class="keyword">IN</span> (<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>);</span><br></pre></td></tr></table></figure><hr><h3 id="9-è”åˆç´¢å¼•æœªéµå¾ªæœ€å·¦å‰ç¼€"><a href="#9-è”åˆç´¢å¼•æœªéµå¾ªæœ€å·¦å‰ç¼€" class="headerlink" title="9. è”åˆç´¢å¼•æœªéµå¾ªæœ€å·¦å‰ç¼€"></a><strong>9. è”åˆç´¢å¼•æœªéµå¾ªæœ€å·¦å‰ç¼€</strong></h3><ul><li><strong>æ­£å¸¸åˆ¤æ–­</strong>ï¼šæŸ¥è¯¢æ¡ä»¶åŒ…å«æœ€å·¦åˆ—ä¸”é¡ºåºåˆç†ã€‚</li><li><strong>å¤±æ•ˆåŸå› </strong>ï¼šæœªåŒ…å«æœ€å·¦åˆ—ï¼Œæˆ–ä¸­é—´åˆ—è¢«èŒƒå›´æŸ¥è¯¢ä¸­æ–­ã€‚</li><li><strong>å…·ä½“åŸç†</strong>ï¼šè”åˆç´¢å¼•æŒ‰ <code>(a, b, c)</code> é¡ºåºæ„å»º B+ æ ‘ï¼Œç¼ºå°‘ä¸­é—´åˆ—å¯¼è‡´åç»­åˆ—æ— åºã€‚</li><li><strong>ç¤ºä¾‹ SQL</strong>ï¼š</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å¤±æ•ˆï¼ˆç¼ºå°‘ aï¼‰</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> b<span class="operator">=</span><span class="number">2</span> <span class="keyword">AND</span> c<span class="operator">=</span><span class="number">3</span>;</span><br><span class="line"><span class="comment">-- éƒ¨åˆ†å¤±æ•ˆï¼ˆc æ— æ³•ç›´æ¥åˆ©ç”¨ç´¢å¼•ï¼‰</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> a<span class="operator">=</span><span class="number">1</span> <span class="keyword">AND</span> c<span class="operator">=</span><span class="number">3</span>;</span><br></pre></td></tr></table></figure><hr><h3 id="10-èŒƒå›´æŸ¥è¯¢é˜»æ–­åç»­åˆ—"><a href="#10-èŒƒå›´æŸ¥è¯¢é˜»æ–­åç»­åˆ—" class="headerlink" title="10. èŒƒå›´æŸ¥è¯¢é˜»æ–­åç»­åˆ—"></a><strong>10. èŒƒå›´æŸ¥è¯¢é˜»æ–­åç»­åˆ—</strong></h3><ul><li><strong>æ­£å¸¸åˆ¤æ–­</strong>ï¼šèŒƒå›´æŸ¥è¯¢åˆ—åœ¨è”åˆç´¢å¼•æœ«å°¾ã€‚</li><li><strong>å¤±æ•ˆåŸå› </strong>ï¼šèŒƒå›´æŸ¥è¯¢ï¼ˆå¦‚ <code>&gt;</code>ã€<code>BETWEEN</code>ï¼‰åï¼Œåç»­åˆ—æ— æ³•ä½¿ç”¨ç´¢å¼•ã€‚</li><li><strong>å…·ä½“åŸç†</strong>ï¼šèŒƒå›´æŸ¥è¯¢å¯¼è‡´ç´¢å¼•åç»­åˆ—æ— åºï¼Œæ— æ³•é€šè¿‡ B+ æ ‘å¿«é€Ÿå®šä½ã€‚</li><li><strong>ç¤ºä¾‹ SQL</strong>ï¼š</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ä»… a å’Œ b èµ°ç´¢å¼•ï¼Œc å¤±æ•ˆ</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> a<span class="operator">=</span><span class="number">1</span> <span class="keyword">AND</span> b<span class="operator">&gt;</span><span class="number">10</span> <span class="keyword">AND</span> c<span class="operator">=</span><span class="number">2</span>;</span><br></pre></td></tr></table></figure><hr><h3 id="11-ä¸¤åˆ—æ¯”è¾ƒæ“ä½œ"><a href="#11-ä¸¤åˆ—æ¯”è¾ƒæ“ä½œ" class="headerlink" title="11. ä¸¤åˆ—æ¯”è¾ƒæ“ä½œ"></a><strong>11. ä¸¤åˆ—æ¯”è¾ƒæ“ä½œ</strong></h3><ul><li><strong>æ­£å¸¸åˆ¤æ–­</strong>ï¼šå•åˆ—æ¡ä»¶ä½¿ç”¨ç´¢å¼•ã€‚</li><li><strong>å¤±æ•ˆåŸå› </strong>ï¼šç´¢å¼•ä¸æ”¯æŒåˆ—é—´æ¯”è¾ƒã€‚</li><li><strong>å…·ä½“åŸç†</strong>ï¼šç´¢å¼•å­˜å‚¨åˆ—å€¼ä¸è¡Œä½ç½®çš„æ˜ å°„ï¼Œæ— æ³•ç›´æ¥æ¯”è¾ƒä¸¤åˆ—å€¼ã€‚</li><li><strong>ç¤ºä¾‹ SQL</strong>ï¼š</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å¤±æ•ˆ</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> a <span class="operator">=</span> b;</span><br></pre></td></tr></table></figure><hr><h3 id="12-NOT-IN-æ¡ä»¶"><a href="#12-NOT-IN-æ¡ä»¶" class="headerlink" title="12. NOT IN æ¡ä»¶"></a><strong>12.</strong> <code>NOT IN</code> <strong>æ¡ä»¶</strong></h3><ul><li><strong>æ­£å¸¸åˆ¤æ–­</strong>ï¼šä¸»é”® <code>NOT IN</code> å¯èƒ½èµ°ç´¢å¼•ã€‚</li><li><strong>å¤±æ•ˆåŸå› </strong>ï¼šæ™®é€šç´¢å¼•éœ€å›è¡¨éªŒè¯ï¼Œä¼˜åŒ–å™¨è®¤ä¸ºå…¨è¡¨æ‰«ææ›´å¿«ã€‚</li><li><strong>å…·ä½“åŸç†</strong>ï¼šä¸»é”®ç´¢å¼•åŒ…å«å®Œæ•´æ•°æ®ï¼Œæ™®é€šç´¢å¼•éœ€å›è¡¨æ£€æŸ¥æ˜¯å¦æ»¡è¶³ <code>NOT IN</code>ã€‚</li><li><strong>ç¤ºä¾‹ SQL</strong>ï¼š</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å¤±æ•ˆï¼ˆæ™®é€šç´¢å¼•ï¼‰</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> a <span class="keyword">NOT</span> <span class="keyword">IN</span> (<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line"><span class="comment">-- æ­£å¸¸ï¼ˆä¸»é”®ï¼‰</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> id <span class="keyword">NOT</span> <span class="keyword">IN</span> (<span class="number">1</span>,<span class="number">2</span>);</span><br></pre></td></tr></table></figure><hr><h3 id="13-NOT-EXISTS-å­æŸ¥è¯¢"><a href="#13-NOT-EXISTS-å­æŸ¥è¯¢" class="headerlink" title="13. NOT EXISTS å­æŸ¥è¯¢"></a><strong>13.</strong> <code>NOT EXISTS</code> <strong>å­æŸ¥è¯¢</strong></h3><ul><li><strong>æ­£å¸¸åˆ¤æ–­</strong>ï¼š<code>EXISTS</code> å¯èƒ½èµ°ç´¢å¼•ï¼Œ<code>NOT EXISTS</code> é€šå¸¸å¤±æ•ˆã€‚</li><li><strong>å¤±æ•ˆåŸå› </strong>ï¼š<code>NOT EXISTS</code> éœ€é€è¡ŒéªŒè¯å­æŸ¥è¯¢ï¼Œæ— æ³•åˆ©ç”¨ç´¢å¼•ã€‚</li><li><strong>å…·ä½“åŸç†</strong>ï¼šå­æŸ¥è¯¢éœ€å…¨è¡¨æ‰«ææˆ–å…¨ç´¢å¼•æ‰«æï¼Œæˆæœ¬è¾ƒé«˜ã€‚</li><li><strong>ç¤ºä¾‹ SQL</strong>ï¼š</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- å¤±æ•ˆ</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> t1 </span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> (<span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">FROM</span> <span class="keyword">table</span> t2 <span class="keyword">WHERE</span> t1.id <span class="operator">=</span> t2.id);</span><br></pre></td></tr></table></figure><hr>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Redis åº•å±‚æ•°æ®ç»“æ„</title>
      <link href="/2025/06/07/Redis%20%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
      <url>/2025/06/07/Redis%20%E5%BA%95%E5%B1%82%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/</url>
      
        <content type="html"><![CDATA[<h1 id="Redis-åº•å±‚æ•°æ®ç»“æ„"><a href="#Redis-åº•å±‚æ•°æ®ç»“æ„" class="headerlink" title="Redis åº•å±‚æ•°æ®ç»“æ„"></a>Redis åº•å±‚æ•°æ®ç»“æ„</h1><p>åŸæ–‡æ‹·è´ï¼š<a href="https://pdai.tech/md/db/nosql-redis/db-redis-x-redis-ds.html">https://pdai.tech/md/db/nosql-redis/db-redis-x-redis-ds.html</a></p><h2 id="1-åº•å±‚æ•°æ®ç»“æ„å¼•å…¥"><a href="#1-åº•å±‚æ•°æ®ç»“æ„å¼•å…¥" class="headerlink" title="1. åº•å±‚æ•°æ®ç»“æ„å¼•å…¥"></a>1. åº•å±‚æ•°æ®ç»“æ„å¼•å…¥</h2><p>åœ¨å¯¹å¯¹è±¡æœºåˆ¶ï¼ˆredisObjectï¼‰æœ‰äº†åˆæ­¥è®¤è¯†ä¹‹åï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥ç»§ç»­ç†è§£å¦‚ä¸‹çš„åº•å±‚æ•°æ®ç»“æ„éƒ¨åˆ†ï¼š</p><ul><li>ç®€å•åŠ¨æ€å­—ç¬¦ä¸² - sds</li><li>å‹ç¼©åˆ—è¡¨ - ZipList</li><li>å¿«è¡¨ - QuickList</li><li>å­—å…¸&#x2F;å“ˆå¸Œè¡¨ - Dict</li><li>æ•´æ•°é›† - IntSet</li><li>è·³è¡¨ - ZSkipList</li></ul><h2 id=""><a href="#" class="headerlink" title=""></a><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1683186163371-8b104d7d-6d48-48be-b36f-00239b94f2c6-20250605104506666.png" alt="img"></h2><h2 id="2-ç®€å•åŠ¨æ€å­—ç¬¦ä¸²-sds"><a href="#2-ç®€å•åŠ¨æ€å­—ç¬¦ä¸²-sds" class="headerlink" title="2. ç®€å•åŠ¨æ€å­—ç¬¦ä¸² - sds"></a>2. ç®€å•åŠ¨æ€å­—ç¬¦ä¸² - sds</h2><p>Redis æ˜¯ç”¨ C è¯­è¨€å†™çš„ï¼Œä½†æ˜¯å¯¹äºRedisçš„å­—ç¬¦ä¸²ï¼Œå´ä¸æ˜¯ C è¯­è¨€ä¸­çš„å­—ç¬¦ä¸²ï¼ˆå³ä»¥ç©ºå­—ç¬¦â€™\0â€™ç»“å°¾çš„å­—ç¬¦æ•°ç»„ï¼‰ï¼Œå®ƒæ˜¯è‡ªå·±æ„å»ºäº†ä¸€ç§åä¸º <strong>ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆsimple dynamic string,SDS</strong>ï¼‰çš„æŠ½è±¡ç±»å‹ï¼Œå¹¶å°† SDS ä½œä¸º Redisçš„é»˜è®¤å­—ç¬¦ä¸²è¡¨ç¤ºã€‚</p><h3 id="2-1-SDS-å®šä¹‰"><a href="#2-1-SDS-å®šä¹‰" class="headerlink" title="2.1. SDS å®šä¹‰"></a>2.1. SDS å®šä¹‰</h3><p>è¿™æ˜¯ä¸€ç§ç”¨äºå­˜å‚¨äºŒè¿›åˆ¶æ•°æ®çš„ä¸€ç§ç»“æ„, å…·æœ‰åŠ¨æ€æ‰©å®¹çš„ç‰¹ç‚¹. å…¶å®ç°ä½äºsrc&#x2F;sds.hä¸src&#x2F;sds.cä¸­ã€‚</p><ul><li><strong>SDSçš„æ€»ä½“æ¦‚è§ˆ</strong>å¦‚ä¸‹å›¾:</li></ul><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1683186200481-7f03df1c-74c9-40d7-98bb-dcd47b24fef0.png" alt="img"></p><p>å…¶ä¸­sdshdræ˜¯å¤´éƒ¨, bufæ˜¯çœŸå®å­˜å‚¨ç”¨æˆ·æ•°æ®çš„åœ°æ–¹. å¦å¤–æ³¨æ„, ä»å‘½åä¸Šèƒ½çœ‹å‡ºæ¥, è¿™ä¸ªæ•°æ®ç»“æ„é™¤äº†èƒ½å­˜å‚¨äºŒè¿›åˆ¶æ•°æ®, æ˜¾ç„¶æ˜¯ç”¨äºè®¾è®¡ä½œä¸ºå­—ç¬¦ä¸²ä½¿ç”¨çš„, æ‰€ä»¥åœ¨bufä¸­, ç”¨æˆ·æ•°æ®åæ€»è·Ÿç€ä¸€ä¸ª\0. å³å›¾ä¸­ â€œæ•°æ®â€ + â€œ\0â€ æ˜¯ä¸ºæ‰€è°“çš„bufã€‚</p><ul><li>å¦‚ä¸‹æ˜¯<strong>6.0æºç ä¸­sdsç›¸å…³çš„ç»“æ„</strong>ï¼š</li></ul><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1683186307934-1a2abbea-4cc0-4975-bbce-43e33ab4cfe6-20250605104457766.png" alt="img"></p><p>é€šè¿‡ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒSDSæœ‰äº”ç§ä¸åŒçš„å¤´éƒ¨. å…¶ä¸­sdshdr5å®é™…å¹¶æœªä½¿ç”¨åˆ°. æ‰€ä»¥å®é™…ä¸Šæœ‰å››ç§ä¸åŒçš„å¤´éƒ¨, åˆ†åˆ«å¦‚ä¸‹:</p><p>å…¶ä¸­ï¼š</p><ul><li><ul><li>len ä¿å­˜äº†SDSä¿å­˜å­—ç¬¦ä¸²çš„é•¿åº¦</li><li>buf[] æ•°ç»„ç”¨æ¥ä¿å­˜å­—ç¬¦ä¸²çš„æ¯ä¸ªå…ƒç´ </li><li>allocåˆ†åˆ«ä»¥uint8, uint16, uint32, uint64è¡¨ç¤ºæ•´ä¸ªSDS, é™¤è¿‡å¤´éƒ¨ä¸æœ«å°¾çš„\0, å‰©ä½™çš„å­—èŠ‚æ•°.</li><li>flags å§‹ç»ˆä¸ºä¸€å­—èŠ‚, ä»¥ä½ä¸‰ä½æ ‡ç¤ºç€å¤´éƒ¨çš„ç±»å‹, é«˜5ä½æœªä½¿ç”¨.</li></ul></li></ul><h3 id="2-2-ä¸ºä»€ä¹ˆä½¿ç”¨SDS"><a href="#2-2-ä¸ºä»€ä¹ˆä½¿ç”¨SDS" class="headerlink" title="2.2. ä¸ºä»€ä¹ˆä½¿ç”¨SDS"></a>2.2. ä¸ºä»€ä¹ˆä½¿ç”¨SDS</h3><p><strong>ä¸ºä»€ä¹ˆä¸ä½¿ç”¨Cè¯­è¨€å­—ç¬¦ä¸²å®ç°ï¼Œè€Œæ˜¯ä½¿ç”¨ SDSå‘¢</strong>ï¼Ÿè¿™æ ·å®ç°æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ</p><ul><li><strong>å¸¸æ•°å¤æ‚åº¦è·å–å­—ç¬¦ä¸²é•¿åº¦</strong></li></ul><p>ç”±äº len å±æ€§çš„å­˜åœ¨ï¼Œæˆ‘ä»¬è·å– SDS å­—ç¬¦ä¸²çš„é•¿åº¦åªéœ€è¦è¯»å– len å±æ€§ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1)ã€‚è€Œå¯¹äº C è¯­è¨€ï¼Œè·å–å­—ç¬¦ä¸²çš„é•¿åº¦é€šå¸¸æ˜¯ç»è¿‡éå†è®¡æ•°æ¥å®ç°çš„ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(n)ã€‚é€šè¿‡ strlen key å‘½ä»¤å¯ä»¥è·å– key çš„å­—ç¬¦ä¸²é•¿åº¦ã€‚</p><ul><li><strong>æœç»ç¼“å†²åŒºæº¢å‡º</strong></li></ul><p>æˆ‘ä»¬çŸ¥é“åœ¨ C è¯­è¨€ä¸­ä½¿ç”¨ strcat å‡½æ•°æ¥è¿›è¡Œä¸¤ä¸ªå­—ç¬¦ä¸²çš„æ‹¼æ¥ï¼Œä¸€æ—¦æ²¡æœ‰åˆ†é…è¶³å¤Ÿé•¿åº¦çš„å†…å­˜ç©ºé—´ï¼Œå°±ä¼šé€ æˆç¼“å†²åŒºæº¢å‡ºã€‚è€Œå¯¹äº SDS æ•°æ®ç±»å‹ï¼Œåœ¨è¿›è¡Œå­—ç¬¦ä¿®æ”¹çš„æ—¶å€™ï¼Œ<strong>ä¼šé¦–å…ˆæ ¹æ®è®°å½•çš„ len å±æ€§æ£€æŸ¥å†…å­˜ç©ºé—´æ˜¯å¦æ»¡è¶³éœ€æ±‚</strong>ï¼Œå¦‚æœä¸æ»¡è¶³ï¼Œä¼šè¿›è¡Œç›¸åº”çš„ç©ºé—´æ‰©å±•ï¼Œç„¶ååœ¨è¿›è¡Œä¿®æ”¹æ“ä½œï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°ç¼“å†²åŒºæº¢å‡ºã€‚</p><ul><li><strong>å‡å°‘ä¿®æ”¹å­—ç¬¦ä¸²çš„å†…å­˜é‡æ–°åˆ†é…æ¬¡æ•°</strong></li></ul><p>Cè¯­è¨€ç”±äºä¸è®°å½•å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œæ‰€ä»¥å¦‚æœè¦ä¿®æ”¹å­—ç¬¦ä¸²ï¼Œå¿…é¡»è¦é‡æ–°åˆ†é…å†…å­˜ï¼ˆå…ˆé‡Šæ”¾å†ç”³è¯·ï¼‰ï¼Œå› ä¸ºå¦‚æœæ²¡æœ‰é‡æ–°åˆ†é…ï¼Œå­—ç¬¦ä¸²é•¿åº¦å¢å¤§æ—¶ä¼šé€ æˆå†…å­˜ç¼“å†²åŒºæº¢å‡ºï¼Œå­—ç¬¦ä¸²é•¿åº¦å‡å°æ—¶ä¼šé€ æˆå†…å­˜æ³„éœ²ã€‚</p><p>è€Œå¯¹äºSDSï¼Œç”±äºlenå±æ€§å’Œallocå±æ€§çš„å­˜åœ¨ï¼Œå¯¹äºä¿®æ”¹å­—ç¬¦ä¸²SDSå®ç°äº†<strong>ç©ºé—´é¢„åˆ†é…</strong>å’Œ<strong>æƒ°æ€§ç©ºé—´é‡Šæ”¾</strong>ä¸¤ç§ç­–ç•¥ï¼š</p><p>1ã€ç©ºé—´é¢„åˆ†é…ï¼šå¯¹å­—ç¬¦ä¸²è¿›è¡Œç©ºé—´æ‰©å±•çš„æ—¶å€™ï¼Œæ‰©å±•çš„å†…å­˜æ¯”å®é™…éœ€è¦çš„å¤šï¼Œè¿™æ ·å¯ä»¥å‡å°‘è¿ç»­æ‰§è¡Œå­—ç¬¦ä¸²å¢é•¿æ“ä½œæ‰€éœ€çš„å†…å­˜é‡åˆ†é…æ¬¡æ•°ã€‚</p><p>2ã€æƒ°æ€§ç©ºé—´é‡Šæ”¾ï¼šå¯¹å­—ç¬¦ä¸²è¿›è¡Œç¼©çŸ­æ“ä½œæ—¶ï¼Œç¨‹åºä¸ç«‹å³ä½¿ç”¨å†…å­˜é‡æ–°åˆ†é…æ¥å›æ”¶ç¼©çŸ­åå¤šä½™çš„å­—èŠ‚ï¼Œè€Œæ˜¯ä½¿ç”¨ alloc å±æ€§å°†è¿™äº›å­—èŠ‚çš„æ•°é‡è®°å½•ä¸‹æ¥ï¼Œç­‰å¾…åç»­ä½¿ç”¨ã€‚ï¼ˆå½“ç„¶SDSä¹Ÿæä¾›äº†ç›¸åº”çš„APIï¼Œå½“æˆ‘ä»¬æœ‰éœ€è¦æ—¶ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨é‡Šæ”¾è¿™äº›æœªä½¿ç”¨çš„ç©ºé—´ã€‚ï¼‰</p><ul><li><strong>äºŒè¿›åˆ¶å®‰å…¨</strong></li></ul><p>å› ä¸ºCå­—ç¬¦ä¸²ä»¥ç©ºå­—ç¬¦ä½œä¸ºå­—ç¬¦ä¸²ç»“æŸçš„æ ‡è¯†ï¼Œè€Œå¯¹äºä¸€äº›äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆå¦‚å›¾ç‰‡ç­‰ï¼‰ï¼Œå†…å®¹å¯èƒ½åŒ…æ‹¬ç©ºå­—ç¬¦ä¸²ï¼Œå› æ­¤Cå­—ç¬¦ä¸²æ— æ³•æ­£ç¡®å­˜å–ï¼›è€Œæ‰€æœ‰ SDS çš„API éƒ½æ˜¯ä»¥å¤„ç†äºŒè¿›åˆ¶çš„æ–¹å¼æ¥å¤„ç† buf é‡Œé¢çš„å…ƒç´ ï¼Œå¹¶ä¸” SDS ä¸æ˜¯ä»¥ç©ºå­—ç¬¦ä¸²æ¥åˆ¤æ–­æ˜¯å¦ç»“æŸï¼Œè€Œæ˜¯ä»¥ len å±æ€§è¡¨ç¤ºçš„é•¿åº¦æ¥åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ç»“æŸã€‚</p><ul><li><strong>å…¼å®¹éƒ¨åˆ† C å­—ç¬¦ä¸²å‡½æ•°</strong></li></ul><p>è™½ç„¶ SDS æ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„ï¼Œä½†æ˜¯ä¸€æ ·éµä»æ¯ä¸ªå­—ç¬¦ä¸²éƒ½æ˜¯ä»¥ç©ºå­—ç¬¦ä¸²ç»“å°¾çš„æƒ¯ä¾‹ï¼Œè¿™æ ·å¯ä»¥é‡ç”¨ C è¯­è¨€åº“&lt;string.h&gt; ä¸­çš„ä¸€éƒ¨åˆ†å‡½æ•°ã€‚</p><h3 id="2-3-ç©ºé—´é¢„åˆ†é…è¡¥è¿›ä¸€æ­¥ç†è§£"><a href="#2-3-ç©ºé—´é¢„åˆ†é…è¡¥è¿›ä¸€æ­¥ç†è§£" class="headerlink" title="2.3. ç©ºé—´é¢„åˆ†é…è¡¥è¿›ä¸€æ­¥ç†è§£"></a>2.3. ç©ºé—´é¢„åˆ†é…è¡¥è¿›ä¸€æ­¥ç†è§£</h3><p>å½“æ‰§è¡Œè¿½åŠ æ“ä½œæ—¶ï¼Œæ¯”å¦‚ç°åœ¨ç»™key&#x3D;â€˜Hello Worldâ€™çš„å­—ç¬¦ä¸²åè¿½åŠ â€˜ again!â€™åˆ™è¿™æ—¶çš„len&#x3D;18ï¼Œfreeç”±0å˜æˆäº†18ï¼Œæ­¤æ—¶çš„buf&#x3D;â€™Hello World again!\0â€¦â€¦â€¦â€¦â€¦â€¦..â€™(.è¡¨ç¤ºç©ºæ ¼)ï¼Œä¹Ÿå°±æ˜¯bufçš„å†…å­˜ç©ºé—´æ˜¯18+18+1&#x3D;37ä¸ªå­—èŠ‚ï¼Œå…¶ä¸­â€˜\0â€™å 1ä¸ªå­—èŠ‚redisç»™å­—ç¬¦ä¸²å¤šåˆ†é…äº†18ä¸ªå­—èŠ‚çš„é¢„åˆ†é…ç©ºé—´ï¼Œæ‰€ä»¥ä¸‹æ¬¡è¿˜æœ‰appendè¿½åŠ çš„æ—¶å€™ï¼Œå¦‚æœé¢„åˆ†é…ç©ºé—´è¶³å¤Ÿï¼Œå°±æ— é¡»åœ¨è¿›è¡Œç©ºé—´åˆ†é…äº†ã€‚åœ¨å½“å‰ç‰ˆæœ¬ä¸­ï¼Œå½“æ–°å­—ç¬¦ä¸²çš„é•¿åº¦å°äº1Mæ—¶ï¼Œredisä¼šåˆ†é…ä»–ä»¬æ‰€éœ€å¤§å°ä¸€å€çš„ç©ºé—´ï¼Œå½“å¤§äº1Mçš„æ—¶å€™ï¼Œå°±ä¸ºä»–ä»¬é¢å¤–å¤šåˆ†é…1Mçš„ç©ºé—´ã€‚</p><p>æ€è€ƒï¼š<strong>è¿™ç§åˆ†é…ç­–ç•¥ä¼šæµªè´¹å†…å­˜èµ„æºå—</strong>ï¼Ÿ</p><p>ç­”ï¼šæ‰§è¡Œè¿‡APPEND å‘½ä»¤çš„å­—ç¬¦ä¸²ä¼šå¸¦æœ‰é¢å¤–çš„é¢„åˆ†é…ç©ºé—´ï¼Œè¿™äº›é¢„åˆ†é…ç©ºé—´ä¸ä¼šè¢«é‡Šæ”¾ï¼Œé™¤éè¯¥å­—ç¬¦ä¸²æ‰€å¯¹åº”çš„é”®è¢«åˆ é™¤ï¼Œæˆ–è€…ç­‰åˆ°å…³é—­Redis ä¹‹åï¼Œå†æ¬¡å¯åŠ¨æ—¶é‡æ–°è½½å…¥çš„å­—ç¬¦ä¸²å¯¹è±¡å°†ä¸ä¼šæœ‰é¢„åˆ†é…ç©ºé—´ã€‚å› ä¸ºæ‰§è¡ŒAPPEND å‘½ä»¤çš„å­—ç¬¦ä¸²é”®æ•°é‡é€šå¸¸å¹¶ä¸å¤šï¼Œå ç”¨å†…å­˜çš„ä½“ç§¯é€šå¸¸ä¹Ÿä¸å¤§ï¼Œæ‰€ä»¥è¿™ä¸€èˆ¬å¹¶ä¸ç®—ä»€ä¹ˆé—®é¢˜ã€‚å¦ä¸€æ–¹é¢ï¼Œå¦‚æœæ‰§è¡ŒAPPEND æ“ä½œçš„é”®å¾ˆå¤šï¼Œè€Œå­—ç¬¦ä¸²çš„ä½“ç§¯åˆå¾ˆå¤§çš„è¯ï¼Œé‚£å¯èƒ½å°±éœ€è¦ä¿®æ”¹Redis æœåŠ¡å™¨ï¼Œè®©å®ƒå®šæ—¶é‡Šæ”¾ä¸€äº›å­—ç¬¦ä¸²é”®çš„é¢„åˆ†é…ç©ºé—´ï¼Œä»è€Œæ›´æœ‰æ•ˆåœ°ä½¿ç”¨å†…å­˜ã€‚</p><h3 id="2-4-å°ç»“"><a href="#2-4-å°ç»“" class="headerlink" title="2.4. å°ç»“"></a>2.4. å°ç»“</h3><p>redisçš„å­—ç¬¦ä¸²è¡¨ç¤ºä¸ºsdsï¼Œè€Œä¸æ˜¯Cå­—ç¬¦ä¸²ï¼ˆä»¥\0ç»“å°¾çš„char*ï¼‰ï¼Œ å®ƒæ˜¯Redis åº•å±‚æ‰€ä½¿ç”¨çš„å­—ç¬¦ä¸²è¡¨ç¤ºï¼Œå®ƒè¢«ç”¨åœ¨å‡ ä¹æ‰€æœ‰çš„Redis æ¨¡å—ä¸­ã€‚å¯ä»¥çœ‹å¦‚ä¸‹å¯¹æ¯”ï¼š</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1683186398426-e49e97b8-1a09-4af9-b24e-69d9427e0a86-20250605104730696.png" alt="img"></p><p>ä¸€èˆ¬æ¥è¯´ï¼ŒSDS é™¤äº†ä¿å­˜æ•°æ®åº“ä¸­çš„å­—ç¬¦ä¸²å€¼ä»¥å¤–ï¼ŒSDS è¿˜å¯ä»¥ä½œä¸ºç¼“å†²åŒºï¼ˆbufferï¼‰ï¼šåŒ…æ‹¬ AOF æ¨¡å—ä¸­çš„AOFç¼“å†²åŒºä»¥åŠå®¢æˆ·ç«¯çŠ¶æ€ä¸­çš„è¾“å…¥ç¼“å†²åŒºã€‚</p><h2 id="3-å‹ç¼©åˆ—è¡¨-ZipList"><a href="#3-å‹ç¼©åˆ—è¡¨-ZipList" class="headerlink" title="3. å‹ç¼©åˆ—è¡¨ - ZipList"></a>3. å‹ç¼©åˆ—è¡¨ - ZipList</h2><p>ziplistæ˜¯ä¸ºäº†æé«˜å­˜å‚¨æ•ˆç‡è€Œè®¾è®¡çš„ä¸€ç§ç‰¹æ®Šç¼–ç çš„åŒå‘é“¾è¡¨ã€‚å®ƒå¯ä»¥å­˜å‚¨å­—ç¬¦ä¸²æˆ–è€…æ•´æ•°ï¼Œå­˜å‚¨æ•´æ•°æ—¶æ˜¯é‡‡ç”¨æ•´æ•°çš„äºŒè¿›åˆ¶è€Œä¸æ˜¯å­—ç¬¦ä¸²å½¢å¼å­˜å‚¨ã€‚å®ƒèƒ½åœ¨O(1)çš„æ—¶é—´å¤æ‚åº¦ä¸‹å®Œæˆlistä¸¤ç«¯çš„pushå’Œpopæ“ä½œã€‚ä½†æ˜¯å› ä¸ºæ¯æ¬¡æ“ä½œéƒ½éœ€è¦é‡æ–°åˆ†é…ziplistçš„å†…å­˜ï¼Œæ‰€ä»¥å®é™…å¤æ‚åº¦å’Œziplistçš„å†…å­˜ä½¿ç”¨é‡ç›¸å…³ã€‚</p><h3 id="3-1-ziplistç»“æ„"><a href="#3-1-ziplistç»“æ„" class="headerlink" title="3.1. ziplistç»“æ„"></a>3.1. ziplistç»“æ„</h3><p>å…ˆçœ‹ä¸‹6.0ä¸­å¯¹åº”çš„æºç å’Œä»‹ç»</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1683186463010-998f824b-0c42-4671-975c-e4ecd0303661.png" alt="img"></p><p>æ•´ä¸ªzipliståœ¨å†…å­˜ä¸­çš„å­˜å‚¨æ ¼å¼å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1683186477713-f4b4e9f1-70c0-41aa-af35-d8cdd8872970-20250605104738622.png" alt="img"></p><ul><li>zlbyteså­—æ®µçš„ç±»å‹æ˜¯uint32_t, è¿™ä¸ªå­—æ®µä¸­å­˜å‚¨çš„æ˜¯æ•´ä¸ªziplistæ‰€å ç”¨çš„å†…å­˜çš„å­—èŠ‚æ•°</li><li>zltailå­—æ®µçš„ç±»å‹æ˜¯uint32_t, å®ƒæŒ‡çš„æ˜¯ziplistä¸­æœ€åä¸€ä¸ªentryçš„åç§»é‡. ç”¨äºå¿«é€Ÿå®šä½æœ€åä¸€ä¸ªentry, ä»¥å¿«é€Ÿå®Œæˆpopç­‰æ“ä½œ</li><li>zllenå­—æ®µçš„ç±»å‹æ˜¯uint16_t, å®ƒæŒ‡çš„æ˜¯æ•´ä¸ªziplitä¸­entryçš„æ•°é‡. è¿™ä¸ªå€¼åªå 2bytesï¼ˆ16ä½ï¼‰: å¦‚æœziplistä¸­entryçš„æ•°ç›®å°äº65535(2çš„16æ¬¡æ–¹), é‚£ä¹ˆè¯¥å­—æ®µä¸­å­˜å‚¨çš„å°±æ˜¯å®é™…entryçš„å€¼. è‹¥ç­‰äºæˆ–è¶…è¿‡65535, é‚£ä¹ˆè¯¥å­—æ®µçš„å€¼å›ºå®šä¸º65535, ä½†å®é™…æ•°é‡éœ€è¦ä¸€ä¸ªä¸ªentryçš„å»éå†æ‰€æœ‰entryæ‰èƒ½å¾—åˆ°.</li><li>zlendæ˜¯ä¸€ä¸ªç»ˆæ­¢å­—èŠ‚, å…¶å€¼ä¸ºå…¨F, å³0xff. ziplistä¿è¯ä»»ä½•æƒ…å†µä¸‹, ä¸€ä¸ªentryçš„é¦–å­—èŠ‚éƒ½ä¸ä¼šæ˜¯255</li></ul><h3 id="3-2-Entryç»“æ„"><a href="#3-2-Entryç»“æ„" class="headerlink" title="3.2. Entryç»“æ„"></a>3.2. Entryç»“æ„</h3><p>é‚£ä¹ˆentryæ˜¯ä»€ä¹ˆç»“æ„å‘¢ï¼Ÿ</p><p><strong>å…ˆçœ‹ä¸‹æºç ä¸­ç›¸å…³ä»‹ç»</strong></p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1683186554347-d3b74eed-8e4b-42fd-9f2d-0cc62bd39af1-20250605104447715.png" alt="img"></p><p><strong>ç¬¬ä¸€ç§æƒ…å†µ</strong>ï¼šä¸€èˆ¬ç»“æ„ <prevlen> <encoding> <entry-data></p><p>prevlenï¼šå‰ä¸€ä¸ªentryçš„å¤§å°ï¼Œç¼–ç æ–¹å¼è§ä¸‹æ–‡ï¼›</p><p>encodingï¼šä¸åŒçš„æƒ…å†µä¸‹å€¼ä¸åŒï¼Œç”¨äºè¡¨ç¤ºå½“å‰entryçš„ç±»å‹å’Œé•¿åº¦ï¼›</p><p>entry-dataï¼šçœŸæ˜¯ç”¨äºå­˜å‚¨entryè¡¨ç¤ºçš„æ•°æ®ï¼›</p><p><strong>ç¬¬äºŒç§æƒ…å†µ</strong>ï¼šåœ¨entryä¸­å­˜å‚¨çš„æ˜¯intç±»å‹æ—¶ï¼Œencodingå’Œentry-dataä¼šåˆå¹¶åœ¨encodingä¸­è¡¨ç¤ºï¼Œæ­¤æ—¶æ²¡æœ‰entry-dataå­—æ®µï¼›</p><p>redisä¸­ï¼Œåœ¨å­˜å‚¨æ•°æ®æ—¶ï¼Œä¼šå…ˆå°è¯•å°†stringè½¬æ¢æˆintå­˜å‚¨ï¼ŒèŠ‚çœç©ºé—´ï¼›</p><p>æ­¤æ—¶entryç»“æ„ï¼š<prevlen> <encoding></p><ul><li><strong>prevlenç¼–ç </strong></li></ul><p>å½“å‰ä¸€ä¸ªå…ƒç´ é•¿åº¦å°äº254ï¼ˆ255ç”¨äºzlendï¼‰çš„æ—¶å€™ï¼Œprevlené•¿åº¦ä¸º1ä¸ªå­—èŠ‚ï¼Œå€¼å³ä¸ºå‰ä¸€ä¸ªentryçš„é•¿åº¦ï¼Œå¦‚æœé•¿åº¦å¤§äºç­‰äº254çš„æ—¶å€™ï¼Œprevlenç”¨5ä¸ªå­—èŠ‚è¡¨ç¤ºï¼Œç¬¬ä¸€å­—èŠ‚è®¾ç½®ä¸º254ï¼Œåé¢4ä¸ªå­—èŠ‚å­˜å‚¨ä¸€ä¸ªå°ç«¯çš„æ— ç¬¦å·æ•´å‹ï¼Œè¡¨ç¤ºå‰ä¸€ä¸ªentryçš„é•¿åº¦ï¼›</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;prevlen from 0 to 253&gt; &lt;encoding&gt; &lt;entry&gt;      //é•¿åº¦å°äº254ç»“æ„ 0xFE &lt;4 bytes unsigned little endian prevlen&gt; &lt;encoding&gt; &lt;entry&gt;   //é•¿åº¦å¤§äºç­‰äº254</span><br></pre></td></tr></table></figure><ul><li><strong>encodingç¼–ç </strong></li></ul><p>encodingçš„é•¿åº¦å’Œå€¼æ ¹æ®ä¿å­˜çš„æ˜¯intè¿˜æ˜¯stringï¼Œè¿˜æœ‰æ•°æ®çš„é•¿åº¦è€Œå®šï¼›</p><p>å‰ä¸¤ä½ç”¨æ¥è¡¨ç¤ºç±»å‹ï¼Œå½“ä¸ºâ€œ11â€æ—¶ï¼Œè¡¨ç¤ºentryå­˜å‚¨çš„æ˜¯intç±»å‹ï¼Œå…¶å®ƒè¡¨ç¤ºå­˜å‚¨çš„æ˜¯stringï¼›</p><p><strong>å­˜å‚¨stringæ—¶</strong>ï¼š</p><p>|00pppppp| ï¼šæ­¤æ—¶encodingé•¿åº¦ä¸º1ä¸ªå­—èŠ‚ï¼Œè¯¥å­—èŠ‚çš„åå…­ä½è¡¨ç¤ºentryä¸­å­˜å‚¨çš„stringé•¿åº¦ï¼Œå› ä¸ºæ˜¯6ä½ï¼Œæ‰€ä»¥entryä¸­å­˜å‚¨çš„stringé•¿åº¦ä¸èƒ½è¶…è¿‡63ï¼›</p><p>|01pppppp|qqqqqqqq| æ­¤æ—¶encodingé•¿åº¦ä¸ºä¸¤ä¸ªå­—èŠ‚ï¼›æ­¤æ—¶encodingçš„å14ä½ç”¨æ¥å­˜å‚¨stringé•¿åº¦ï¼Œé•¿åº¦ä¸èƒ½è¶…è¿‡16383ï¼›</p><p>|10000000|qqqqqqqq|rrrrrrrr|ssssssss|ttttttt| æ­¤æ—¶encodingé•¿åº¦ä¸º5ä¸ªå­—èŠ‚ï¼Œåé¢çš„4ä¸ªå­—èŠ‚ç”¨æ¥è¡¨ç¤ºencodingä¸­å­˜å‚¨çš„å­—ç¬¦ä¸²é•¿åº¦ï¼Œé•¿åº¦ä¸èƒ½è¶…è¿‡2^32 - 1;</p><p><strong>å­˜å‚¨intæ—¶</strong>ï¼š</p><p>|11000000| encodingä¸º3ä¸ªå­—èŠ‚ï¼Œå2ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªint16ï¼›</p><p>|11010000| encodingä¸º5ä¸ªå­—èŠ‚ï¼Œå4ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªint32;</p><p>|11100000| encoding ä¸º9ä¸ªå­—èŠ‚ï¼Œå8å­—èŠ‚è¡¨ç¤ºä¸€ä¸ªint64;</p><p>|11110000| encodingä¸º4ä¸ªå­—èŠ‚ï¼Œå3ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªæœ‰ç¬¦å·æ•´å‹ï¼›</p><p>|11111110| encodingä¸º2å­—èŠ‚ï¼Œå1ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªæœ‰ç¬¦å·æ•´å‹ï¼›</p><p>|1111xxxx| encodingé•¿åº¦å°±åªæœ‰1ä¸ªå­—èŠ‚ï¼Œxxxxè¡¨ç¤ºä¸€ä¸ª0 - 12çš„æ•´æ•°å€¼ï¼›</p><p>|11111111| è¿˜è®°å¾—zlendä¹ˆï¼Ÿ</p><ul><li><strong>æºç ä¸­æ•°æ®ç»“æ„æ”¯æ’‘</strong></li></ul><p>ä½ å¯ä»¥çœ‹åˆ°ä¸ºäº†æ“ä½œä¸Šçš„ç®€æ˜“å®é™…è¿˜å¢åŠ äº†å‡ ä¸ªå±æ€§</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/* We use this function to receive information about a ziplist entry. * Note that this is not how the data is actually encoded, is just what we * get filled by a function in order to operate more easily. */ typedef struct zlentry &#123;    unsigned int prevrawlensize; /* Bytes used to encode the previous entry len*/    unsigned int prevrawlen;     /* Previous entry len. */    unsigned int lensize;        /* Bytes used to encode this entry type/len.                                    For example strings have a 1, 2 or 5 bytes                                    header. Integers always use a single byte.*/    unsigned int len;            /* Bytes used to represent the actual entry.                                    For strings this is just the string length                                    while for integers it is 1, 2, 3, 4, 8 or                                    0 (for 4 bit immediate) depending on the                                    number range. */    unsigned int headersize;     /* prevrawlensize + lensize. */    unsigned char encoding;      /* Set to ZIP_STR_* or ZIP_INT_* depending on                                    the entry encoding. However for 4 bits                                    immediate integers this can assume a range                                    of values and must be range-checked. */    unsigned char *p;            /* Pointer to the very start of the entry, that                                    is, this points to prev-entry-len field. */ &#125; zlentry;</span><br></pre></td></tr></table></figure><ul><li><ul><li>prevrawlensizeè¡¨ç¤º previous_entry_lengthå­—æ®µçš„é•¿åº¦</li><li>prevrawlenè¡¨ç¤º previous_entry_lengthå­—æ®µå­˜å‚¨çš„å†…å®¹</li><li>lensizeè¡¨ç¤º encodingå­—æ®µçš„é•¿åº¦</li><li>lenè¡¨ç¤ºæ•°æ®å†…å®¹é•¿åº¦</li><li>headersize è¡¨ç¤ºå½“å‰å…ƒç´ çš„é¦–éƒ¨é•¿åº¦ï¼Œå³previous_entry_lengthå­—æ®µé•¿åº¦ä¸encodingå­—æ®µé•¿åº¦ä¹‹å’Œ</li><li>encodingè¡¨ç¤ºæ•°æ®ç±»å‹</li><li>pè¡¨ç¤ºå½“å‰å…ƒç´ é¦–åœ°å€</li></ul></li></ul><h3 id="3-3-ä¸ºä»€ä¹ˆZipListç‰¹åˆ«çœå†…å­˜"><a href="#3-3-ä¸ºä»€ä¹ˆZipListç‰¹åˆ«çœå†…å­˜" class="headerlink" title="3.3. ä¸ºä»€ä¹ˆZipListç‰¹åˆ«çœå†…å­˜"></a>3.3. ä¸ºä»€ä¹ˆZipListç‰¹åˆ«çœå†…å­˜</h3><p>æ‰€ä»¥åªæœ‰ç†è§£ä¸Šé¢çš„Entryç»“æ„ï¼Œæˆ‘ä»¬æ‰ä¼šçœŸæ­£ç†è§£ZipListä¸ºä»€ä¹ˆæ˜¯ç‰¹åˆ«èŠ‚çœå†…å­˜çš„æ•°æ®ç»“æ„ã€‚</p><ul><li>ziplistèŠ‚çœå†…å­˜æ˜¯ç›¸å¯¹äºæ™®é€šçš„listæ¥è¯´çš„ï¼Œå¦‚æœæ˜¯æ™®é€šçš„æ•°ç»„ï¼Œé‚£ä¹ˆå®ƒæ¯ä¸ªå…ƒç´ å ç”¨çš„å†…å­˜æ˜¯ä¸€æ ·çš„ä¸”å–å†³äºæœ€å¤§çš„é‚£ä¸ªå…ƒç´ ï¼ˆå¾ˆæ˜æ˜¾å®ƒæ˜¯éœ€è¦é¢„ç•™ç©ºé—´çš„ï¼‰ï¼›</li><li>æ‰€ä»¥zipliståœ¨è®¾è®¡æ—¶å°±å¾ˆå®¹æ˜“æƒ³åˆ°è¦å°½é‡è®©æ¯ä¸ªå…ƒç´ æŒ‰ç…§å®é™…çš„å†…å®¹å¤§å°å­˜å‚¨ï¼Œ<strong>æ‰€ä»¥å¢åŠ encodingå­—æ®µ</strong>ï¼Œé’ˆå¯¹ä¸åŒçš„encodingæ¥ç»†åŒ–å­˜å‚¨å¤§å°ï¼›</li><li>è¿™æ—¶å€™è¿˜éœ€è¦è§£å†³çš„ä¸€ä¸ªé—®é¢˜æ˜¯éå†å…ƒç´ æ—¶å¦‚ä½•å®šä½ä¸‹ä¸€ä¸ªå…ƒç´ å‘¢ï¼Ÿåœ¨æ™®é€šæ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ å®šé•¿ï¼Œæ‰€ä»¥ä¸éœ€è¦è€ƒè™‘è¿™ä¸ªé—®é¢˜ï¼›ä½†æ˜¯ziplistä¸­æ¯ä¸ªdataå æ®çš„å†…å­˜ä¸ä¸€æ ·ï¼Œæ‰€ä»¥ä¸ºäº†è§£å†³éå†ï¼Œéœ€è¦å¢åŠ è®°å½•ä¸Šä¸€ä¸ªå…ƒç´ çš„lengthï¼Œ<strong>æ‰€ä»¥å¢åŠ äº†prelenå­—æ®µ</strong>ã€‚</li></ul><p><strong>ä¸ºä»€ä¹ˆæˆ‘ä»¬å»ç ”ç©¶ziplistç‰¹åˆ«èŠ‚çœå†…å­˜çš„æ•°æ®ç»“æ„</strong>ï¼Ÿ åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¤§é‡å­˜å‚¨å­—ç¬¦ä¸²çš„ä¼˜åŒ–æ˜¯éœ€è¦ä½ å¯¹åº•å±‚çš„æ•°æ®ç»“æ„æœ‰ä¸€å®šçš„ç†è§£çš„ï¼Œè€Œzipliståœ¨åœºæ™¯ä¼˜åŒ–çš„æ—¶å€™ä¹Ÿè¢«è€ƒè™‘é‡‡ç”¨çš„é¦–é€‰ã€‚</p><h3 id="3-4-ziplistçš„ç¼ºç‚¹"><a href="#3-4-ziplistçš„ç¼ºç‚¹" class="headerlink" title="3.4. ziplistçš„ç¼ºç‚¹"></a>3.4. ziplistçš„ç¼ºç‚¹</h3><p>æœ€åæˆ‘ä»¬å†çœ‹çœ‹å®ƒçš„ä¸€äº›ç¼ºç‚¹ï¼š</p><ul><li>ziplistä¹Ÿä¸é¢„ç•™å†…å­˜ç©ºé—´, å¹¶ä¸”åœ¨ç§»é™¤ç»“ç‚¹å, ä¹Ÿæ˜¯ç«‹å³ç¼©å®¹, è¿™ä»£è¡¨æ¯æ¬¡å†™æ“ä½œéƒ½ä¼šè¿›è¡Œå†…å­˜åˆ†é…æ“ä½œ.</li><li>ç»“ç‚¹å¦‚æœæ‰©å®¹, å¯¼è‡´ç»“ç‚¹å ç”¨çš„å†…å­˜å¢é•¿, å¹¶ä¸”è¶…è¿‡254å­—èŠ‚çš„è¯, å¯èƒ½ä¼šå¯¼è‡´é“¾å¼ååº”: å…¶åä¸€ä¸ªç»“ç‚¹çš„entry.prevlenéœ€è¦ä»ä¸€å­—èŠ‚æ‰©å®¹è‡³äº”å­—èŠ‚. <strong>æœ€åæƒ…å†µä¸‹, ç¬¬ä¸€ä¸ªç»“ç‚¹çš„æ‰©å®¹, ä¼šå¯¼è‡´æ•´ä¸ªziplistè¡¨ä¸­çš„åç»­æ‰€æœ‰ç»“ç‚¹çš„entry.prevlenå­—æ®µæ‰©å®¹</strong>. è™½ç„¶è¿™ä¸ªå†…å­˜é‡åˆ†é…çš„æ“ä½œä¾ç„¶åªä¼šå‘ç”Ÿä¸€æ¬¡, ä½†ä»£ç ä¸­çš„æ—¶é—´å¤æ‚åº¦æ˜¯o(N)çº§åˆ«, å› ä¸ºé“¾å¼æ‰©å®¹åªèƒ½ä¸€æ­¥ä¸€æ­¥çš„è®¡ç®—. ä½†è¿™ç§æƒ…å†µçš„æ¦‚ç‡ååˆ†çš„å°, ä¸€èˆ¬æƒ…å†µä¸‹é“¾å¼æ‰©å®¹èƒ½è¿é”åæ˜ äº”å…­æ¬¡å°±å¾ˆä¸å¹¸äº†. ä¹‹æ‰€ä»¥è¯´è¿™æ˜¯ä¸€ä¸ªè›‹ç–¼é—®é¢˜, æ˜¯å› ä¸º, è¿™æ ·çš„ååœºæ™¯ä¸‹, å…¶å®æ—¶é—´å¤æ‚åº¦å¹¶ä¸é«˜: ä¾æ¬¡è®¡ç®—æ¯ä¸ªentryæ–°çš„ç©ºé—´å ç”¨, ä¹Ÿå°±æ˜¯o(N), æ€»ä½“å ç”¨è®¡ç®—å‡ºæ¥å, åªæ‰§è¡Œä¸€æ¬¡å†…å­˜é‡åˆ†é…, ä¸å¯¹åº”çš„memmoveæ“ä½œ, å°±å¯ä»¥äº†.</li></ul><h2 id="4-å¿«è¡¨-QuickList"><a href="#4-å¿«è¡¨-QuickList" class="headerlink" title="4. å¿«è¡¨ - QuickList"></a>4. å¿«è¡¨ - QuickList</h2><p>quicklistè¿™ä¸ªç»“æ„æ˜¯Redisåœ¨3.2ç‰ˆæœ¬åæ–°åŠ çš„, ä¹‹å‰çš„ç‰ˆæœ¬æ˜¯list(å³linkedlist)ï¼Œ ç”¨äºStringæ•°æ®ç±»å‹ä¸­ã€‚</p><p>å®ƒæ˜¯ä¸€ç§ä»¥ziplistä¸ºç»“ç‚¹çš„åŒç«¯é“¾è¡¨ç»“æ„. å®è§‚ä¸Š, quicklistæ˜¯ä¸€ä¸ªé“¾è¡¨, å¾®è§‚ä¸Š, é“¾è¡¨ä¸­çš„æ¯ä¸ªç»“ç‚¹éƒ½æ˜¯ä¸€ä¸ªziplistã€‚</p><h3 id="4-1-quicklistç»“æ„"><a href="#4-1-quicklistç»“æ„" class="headerlink" title="4.1. quicklistç»“æ„"></a>4.1. quicklistç»“æ„</h3><ul><li>å¦‚ä¸‹æ˜¯<strong>6.0æºç ä¸­quicklistç›¸å…³çš„ç»“æ„</strong>ï¼š</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Node, quicklist, and Iterator are the only data structures used currently. */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* quicklistNode is a 32 byte struct describing a ziplist for a quicklist.</span></span><br><span class="line"><span class="comment"> * We use bit fields keep the quicklistNode at 32 bytes.</span></span><br><span class="line"><span class="comment"> * count: 16 bits, max 65536 (max zl bytes is 65k, so max count actually &lt; 32k).</span></span><br><span class="line"><span class="comment"> * encoding: 2 bits, RAW=1, LZF=2.</span></span><br><span class="line"><span class="comment"> * container: 2 bits, NONE=1, ZIPLIST=2.</span></span><br><span class="line"><span class="comment"> * recompress: 1 bit, bool, true if node is temporarry decompressed for usage.</span></span><br><span class="line"><span class="comment"> * attempted_compress: 1 bit, boolean, used for verifying during testing.</span></span><br><span class="line"><span class="comment"> * extra: 10 bits, free for future use; pads out the remainder of 32 bits */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">quicklistNode</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">quicklistNode</span> *<span class="title">prev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">quicklistNode</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *zl;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> sz;             <span class="comment">/* ziplist size in bytes */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> count : <span class="number">16</span>;     <span class="comment">/* count of items in ziplist */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> encoding : <span class="number">2</span>;   <span class="comment">/* RAW==1 or LZF==2 */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> container : <span class="number">2</span>;  <span class="comment">/* NONE==1 or ZIPLIST==2 */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> recompress : <span class="number">1</span>; <span class="comment">/* was this node previous compressed? */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> attempted_compress : <span class="number">1</span>; <span class="comment">/* node can&#x27;t compress; too small */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> extra : <span class="number">10</span>; <span class="comment">/* more bits to steal for future usage */</span></span><br><span class="line">&#125; quicklistNode;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* quicklistLZF is a 4+N byte struct holding &#x27;sz&#x27; followed by &#x27;compressed&#x27;.</span></span><br><span class="line"><span class="comment"> * &#x27;sz&#x27; is byte length of &#x27;compressed&#x27; field.</span></span><br><span class="line"><span class="comment"> * &#x27;compressed&#x27; is LZF data with total (compressed) length &#x27;sz&#x27;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">NOTE:</span> uncompressed length is stored in quicklistNode-&gt;sz.</span></span><br><span class="line"><span class="comment"> * When quicklistNode-&gt;zl is compressed, node-&gt;zl points to a quicklistLZF */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">quicklistLZF</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> sz; <span class="comment">/* LZF size in bytes*/</span></span><br><span class="line">    <span class="type">char</span> compressed[];</span><br><span class="line">&#125; quicklistLZF;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Bookmarks are padded with realloc at the end of of the quicklist struct.</span></span><br><span class="line"><span class="comment"> * They should only be used for very big lists if thousands of nodes were the</span></span><br><span class="line"><span class="comment"> * excess memory usage is negligible, and there&#x27;s a real need to iterate on them</span></span><br><span class="line"><span class="comment"> * in portions.</span></span><br><span class="line"><span class="comment"> * When not used, they don&#x27;t add any memory overhead, but when used and then</span></span><br><span class="line"><span class="comment"> * deleted, some overhead remains (to avoid resonance).</span></span><br><span class="line"><span class="comment"> * The number of bookmarks used should be kept to minimum since it also adds</span></span><br><span class="line"><span class="comment"> * overhead on node deletion (searching for a bookmark to update). */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">quicklistBookmark</span> &#123;</span></span><br><span class="line">    quicklistNode *node;</span><br><span class="line">    <span class="type">char</span> *name;</span><br><span class="line">&#125; quicklistBookmark;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* quicklist is a 40 byte struct (on 64-bit systems) describing a quicklist.</span></span><br><span class="line"><span class="comment"> * &#x27;count&#x27; is the number of total entries.</span></span><br><span class="line"><span class="comment"> * &#x27;len&#x27; is the number of quicklist nodes.</span></span><br><span class="line"><span class="comment"> * &#x27;compress&#x27; is: -1 if compression disabled, otherwise it&#x27;s the number</span></span><br><span class="line"><span class="comment"> *                of quicklistNodes to leave uncompressed at ends of quicklist.</span></span><br><span class="line"><span class="comment"> * &#x27;fill&#x27; is the user-requested (or default) fill factor.</span></span><br><span class="line"><span class="comment"> * &#x27;bookmakrs are an optional feature that is used by realloc this struct,</span></span><br><span class="line"><span class="comment"> *      so that they don&#x27;t consume memory when not used. */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">quicklist</span> &#123;</span></span><br><span class="line">    quicklistNode *head;</span><br><span class="line">    quicklistNode *tail;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> count;        <span class="comment">/* total count of all entries in all ziplists */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> len;          <span class="comment">/* number of quicklistNodes */</span></span><br><span class="line">    <span class="type">int</span> fill : QL_FILL_BITS;              <span class="comment">/* fill factor for individual nodes */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> compress : QL_COMP_BITS; <span class="comment">/* depth of end nodes not to compress;0=off */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> bookmark_count: QL_BM_BITS;</span><br><span class="line">    quicklistBookmark bookmarks[];</span><br><span class="line">&#125; quicklist;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">quicklistIter</span> &#123;</span></span><br><span class="line">    <span class="type">const</span> quicklist *quicklist;</span><br><span class="line">    quicklistNode *current;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *zi;</span><br><span class="line">    <span class="type">long</span> offset; <span class="comment">/* offset in current ziplist */</span></span><br><span class="line">    <span class="type">int</span> direction;</span><br><span class="line">&#125; quicklistIter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">quicklistEntry</span> &#123;</span></span><br><span class="line">    <span class="type">const</span> quicklist *quicklist;</span><br><span class="line">    quicklistNode *node;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *zi;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *value;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> longval;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> sz;</span><br><span class="line">    <span class="type">int</span> offset;</span><br><span class="line">&#125; quicklistEntry;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå®šä¹‰äº†6ä¸ªç»“æ„ä½“:</p><ul><li>quicklistNode, å®è§‚ä¸Š, quicklistæ˜¯ä¸€ä¸ªé“¾è¡¨, è¿™ä¸ªç»“æ„æè¿°çš„å°±æ˜¯é“¾è¡¨ä¸­çš„ç»“ç‚¹. å®ƒé€šè¿‡zlå­—æ®µæŒæœ‰åº•å±‚çš„ziplist. ç®€å•æ¥è®², å®ƒæè¿°äº†ä¸€ä¸ªziplistå®ä¾‹</li><li>quicklistLZF, ziplistæ˜¯ä¸€æ®µè¿ç»­çš„å†…å­˜, ç”¨LZ4ç®—æ³•å‹ç¼©å, å°±å¯ä»¥åŒ…è£…æˆä¸€ä¸ªquicklistLZFç»“æ„. æ˜¯å¦å‹ç¼©quicklistä¸­çš„æ¯ä¸ªziplistå®ä¾‹æ˜¯ä¸€ä¸ªå¯é…ç½®é¡¹. è‹¥è¿™ä¸ªé…ç½®é¡¹æ˜¯å¼€å¯çš„, é‚£ä¹ˆquicklistNode.zlå­—æ®µæŒ‡å‘çš„å°±ä¸æ˜¯ä¸€ä¸ªziplistå®ä¾‹, è€Œæ˜¯ä¸€ä¸ªå‹ç¼©åçš„quicklistLZFå®ä¾‹</li><li>quicklistBookmark, åœ¨quicklistå°¾éƒ¨å¢åŠ çš„ä¸€ä¸ªä¹¦ç­¾ï¼Œå®ƒåªæœ‰åœ¨å¤§é‡èŠ‚ç‚¹çš„å¤šä½™å†…å­˜ä½¿ç”¨é‡å¯ä»¥å¿½ç•¥ä¸è®¡çš„æƒ…å†µä¸”ç¡®å®éœ€è¦åˆ†æ‰¹è¿­ä»£å®ƒä»¬ï¼Œæ‰ä¼šè¢«ä½¿ç”¨ã€‚å½“ä¸ä½¿ç”¨å®ƒä»¬æ—¶ï¼Œå®ƒä»¬ä¸ä¼šå¢åŠ ä»»ä½•å†…å­˜å¼€é”€ã€‚</li><li>quicklist. è¿™å°±æ˜¯ä¸€ä¸ªåŒé“¾è¡¨çš„å®šä¹‰. head, tailåˆ†åˆ«æŒ‡å‘å¤´å°¾æŒ‡é’ˆ. lenä»£è¡¨é“¾è¡¨ä¸­çš„ç»“ç‚¹. countæŒ‡çš„æ˜¯æ•´ä¸ªquicklistä¸­çš„æ‰€æœ‰ziplistä¸­çš„entryçš„æ•°ç›®. fillå­—æ®µå½±å“ç€æ¯ä¸ªé“¾è¡¨ç»“ç‚¹ä¸­ziplistçš„æœ€å¤§å ç”¨ç©ºé—´, compresså½±å“ç€æ˜¯å¦è¦å¯¹æ¯ä¸ªziplistä»¥LZ4ç®—æ³•è¿›è¡Œè¿›ä¸€æ­¥å‹ç¼©ä»¥æ›´èŠ‚çœå†…å­˜ç©ºé—´.</li><li>quicklistIteræ˜¯ä¸€ä¸ªè¿­ä»£å™¨</li><li>quicklistEntryæ˜¯å¯¹ziplistä¸­çš„entryæ¦‚å¿µçš„å°è£…. quicklistä½œä¸ºä¸€ä¸ªå°è£…è‰¯å¥½çš„æ•°æ®ç»“æ„, ä¸å¸Œæœ›ä½¿ç”¨è€…æ„ŸçŸ¥åˆ°å…¶å†…éƒ¨çš„å®ç°, æ‰€ä»¥éœ€è¦æŠŠziplist.entryçš„æ¦‚å¿µé‡æ–°åŒ…è£…ä¸€ä¸‹.</li></ul><h3 id="4-2-quicklistå†…å­˜å¸ƒå±€å›¾"><a href="#4-2-quicklistå†…å­˜å¸ƒå±€å›¾" class="headerlink" title="4.2. quicklistå†…å­˜å¸ƒå±€å›¾"></a>4.2. quicklistå†…å­˜å¸ƒå±€å›¾</h3><p>quicklistçš„å†…å­˜å¸ƒå±€å›¾å¦‚ä¸‹æ‰€ç¤º:</p><h3 id="4-3-quicklistæ›´å¤šé¢å¤–ä¿¡æ¯"><a href="#4-3-quicklistæ›´å¤šé¢å¤–ä¿¡æ¯" class="headerlink" title="4.3. quicklistæ›´å¤šé¢å¤–ä¿¡æ¯"></a>4.3. quicklistæ›´å¤šé¢å¤–ä¿¡æ¯</h3><p>ä¸‹é¢æ˜¯æœ‰å…³quicklistçš„æ›´å¤šé¢å¤–ä¿¡æ¯:</p><ul><li>quicklist.fillçš„å€¼å½±å“ç€æ¯ä¸ªé“¾è¡¨ç»“ç‚¹ä¸­, ziplistçš„é•¿åº¦.</li></ul><ol><li><ol><li>å½“æ•°å€¼ä¸ºè´Ÿæ•°æ—¶, ä»£è¡¨ä»¥å­—èŠ‚æ•°é™åˆ¶å•ä¸ªziplistçš„æœ€å¤§é•¿åº¦. å…·ä½“ä¸º:</li><li>-1 ä¸è¶…è¿‡4kb</li><li>-2 ä¸è¶…è¿‡ 8kb</li><li>-3 ä¸è¶…è¿‡ 16kb</li><li>-4 ä¸è¶…è¿‡ 32kb</li><li>-5 ä¸è¶…è¿‡ 64kb</li><li>å½“æ•°å€¼ä¸ºæ­£æ•°æ—¶, ä»£è¡¨ä»¥entryæ•°ç›®é™åˆ¶å•ä¸ªziplistçš„é•¿åº¦. å€¼å³ä¸ºæ•°ç›®. ç”±äºè¯¥å­—æ®µä»…å 16ä½, æ‰€ä»¥ä»¥entryæ•°ç›®é™åˆ¶ziplistçš„å®¹é‡æ—¶, æœ€å¤§å€¼ä¸º2^15ä¸ª</li></ol></li></ol><ul><li>quicklist.compressçš„å€¼å½±å“ç€quicklistNode.zlå­—æ®µæŒ‡å‘çš„æ˜¯åŸç”Ÿçš„ziplist, è¿˜æ˜¯ç»è¿‡å‹ç¼©åŒ…è£…åçš„quicklistLZF</li></ul><ol><li><ol><li>0 è¡¨ç¤ºä¸å‹ç¼©, zlå­—æ®µç›´æ¥æŒ‡å‘ziplist</li><li>1 è¡¨ç¤ºquicklistçš„é“¾è¡¨å¤´å°¾ç»“ç‚¹ä¸å‹ç¼©, å…¶ä½™ç»“ç‚¹çš„zlå­—æ®µæŒ‡å‘çš„æ˜¯ç»è¿‡å‹ç¼©åçš„quicklistLZF</li><li>2 è¡¨ç¤ºquicklistçš„é“¾è¡¨å¤´ä¸¤ä¸ª, ä¸æœ«ä¸¤ä¸ªç»“ç‚¹ä¸å‹ç¼©, å…¶ä½™ç»“ç‚¹çš„zlå­—æ®µæŒ‡å‘çš„æ˜¯ç»è¿‡å‹ç¼©åçš„quicklistLZF</li><li>ä»¥æ­¤ç±»æ¨, æœ€å¤§å€¼ä¸º2^16</li></ol></li></ol><ul><li>quicklistNode.encodingå­—æ®µ, ä»¥æŒ‡ç¤ºæœ¬é“¾è¡¨ç»“ç‚¹æ‰€æŒæœ‰çš„ziplistæ˜¯å¦ç»è¿‡äº†å‹ç¼©. 1ä»£è¡¨æœªå‹ç¼©, æŒæœ‰çš„æ˜¯åŸç”Ÿçš„ziplist, 2ä»£è¡¨å‹ç¼©è¿‡</li><li>quicklistNode.containerå­—æ®µæŒ‡ç¤ºçš„æ˜¯æ¯ä¸ªé“¾è¡¨ç»“ç‚¹æ‰€æŒæœ‰çš„æ•°æ®ç±»å‹æ˜¯ä»€ä¹ˆ. é»˜è®¤çš„å®ç°æ˜¯ziplist, å¯¹åº”çš„è¯¥å­—æ®µçš„å€¼æ˜¯2, ç›®å‰Redisæ²¡æœ‰æä¾›å…¶å®ƒå®ç°. æ‰€ä»¥å®é™…ä¸Š, è¯¥å­—æ®µçš„å€¼æ’ä¸º2</li><li>quicklistNode.recompresså­—æ®µæŒ‡ç¤ºçš„æ˜¯å½“å‰ç»“ç‚¹æ‰€æŒæœ‰çš„ziplistæ˜¯å¦ç»è¿‡äº†è§£å‹. å¦‚æœè¯¥å­—æ®µä¸º1å³ä»£è¡¨ä¹‹å‰è¢«è§£å‹è¿‡, ä¸”éœ€è¦åœ¨ä¸‹ä¸€æ¬¡æ“ä½œæ—¶é‡æ–°å‹ç¼©.</li></ul><p>quicklistçš„å…·ä½“å®ç°ä»£ç ç¯‡å¹…å¾ˆé•¿, è¿™é‡Œå°±ä¸è´´ä»£ç ç‰‡æ–­äº†, ä»å†…å­˜å¸ƒå±€ä¸Šä¹Ÿèƒ½çœ‹å‡ºæ¥, ç”±äºæ¯ä¸ªç»“ç‚¹æŒæœ‰çš„ziplistæ˜¯æœ‰ä¸Šé™é•¿åº¦çš„, æ‰€ä»¥åœ¨ä¸æ“ä½œæ—¶è¦è€ƒè™‘çš„åˆ†æ”¯æƒ…å†µæ¯”è¾ƒå¤šã€‚</p><p>quicklistæœ‰è‡ªå·±çš„ä¼˜ç‚¹, ä¹Ÿæœ‰ç¼ºç‚¹, å¯¹äºä½¿ç”¨è€…æ¥è¯´, å…¶ä½¿ç”¨ä½“éªŒç±»ä¼¼äºçº¿æ€§æ•°æ®ç»“æ„, listä½œä¸ºæœ€ä¼ ç»Ÿçš„åŒé“¾è¡¨, ç»“ç‚¹é€šè¿‡æŒ‡é’ˆæŒæœ‰æ•°æ®, æŒ‡é’ˆå­—æ®µä¼šè€—è´¹å¤§é‡å†…å­˜. ziplistè§£å†³äº†è€—è´¹å†…å­˜è¿™ä¸ªé—®é¢˜. ä½†å¼•å…¥äº†æ–°çš„é—®é¢˜: æ¯æ¬¡å†™æ“ä½œæ•´ä¸ªziplistçš„å†…å­˜éƒ½éœ€è¦é‡åˆ†é…. quickliståœ¨ä¸¤è€…ä¹‹é—´åšäº†ä¸€ä¸ªå¹³è¡¡. å¹¶ä¸”ä½¿ç”¨è€…å¯ä»¥é€šè¿‡è‡ªå®šä¹‰quicklist.fill, æ ¹æ®å®é™…ä¸šåŠ¡æƒ…å†µ, ç»éªŒä¸»ä¹‰è°ƒå‚.</p><h2 id="5-å­—å…¸-å“ˆå¸Œè¡¨-Dict"><a href="#5-å­—å…¸-å“ˆå¸Œè¡¨-Dict" class="headerlink" title="5. å­—å…¸&#x2F;å“ˆå¸Œè¡¨ - Dict"></a>5. å­—å…¸&#x2F;å“ˆå¸Œè¡¨ - Dict</h2><p>æœ¬è´¨ä¸Šå°±æ˜¯å“ˆå¸Œè¡¨, è¿™ä¸ªåœ¨å¾ˆå¤šè¯­è¨€ä¸­éƒ½æœ‰ï¼Œå¯¹äºå¼€å‘äººå‘˜äººå‘˜æ¥è¯´æ¯”è¾ƒç†Ÿæ‚‰ï¼Œè¿™é‡Œå°±ç®€å•ä»‹ç»ä¸‹ã€‚</p><h3 id="5-1-æ•°æ®ç»“æ„"><a href="#5-1-æ•°æ®ç»“æ„" class="headerlink" title="5.1. æ•°æ®ç»“æ„"></a>5.1. æ•°æ®ç»“æ„</h3><p><strong>å“ˆå¸Œè¡¨ç»“æ„å®šä¹‰</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictht</span>&#123;</span></span><br><span class="line">    <span class="comment">//å“ˆå¸Œè¡¨æ•°ç»„</span></span><br><span class="line">    dictEntry **table;</span><br><span class="line">    <span class="comment">//å“ˆå¸Œè¡¨å¤§å°</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> size;</span><br><span class="line">    <span class="comment">//å“ˆå¸Œè¡¨å¤§å°æ©ç ï¼Œç”¨äºè®¡ç®—ç´¢å¼•å€¼</span></span><br><span class="line">    <span class="comment">//æ€»æ˜¯ç­‰äº size-1</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> sizemask;</span><br><span class="line">    <span class="comment">//è¯¥å“ˆå¸Œè¡¨å·²æœ‰èŠ‚ç‚¹çš„æ•°é‡</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> used;</span><br><span class="line"> </span><br><span class="line">&#125;dictht</span><br></pre></td></tr></table></figure><p>å“ˆå¸Œè¡¨æ˜¯ç”±æ•°ç»„ table ç»„æˆï¼Œtable ä¸­æ¯ä¸ªå…ƒç´ éƒ½æ˜¯æŒ‡å‘ dict.h&#x2F;dictEntry ç»“æ„ï¼ŒdictEntry ç»“æ„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span>&#123;</span></span><br><span class="line">     <span class="comment">//é”®</span></span><br><span class="line">     <span class="type">void</span> *key;</span><br><span class="line">     <span class="comment">//å€¼</span></span><br><span class="line">     <span class="class"><span class="keyword">union</span>&#123;</span></span><br><span class="line">          <span class="type">void</span> *val;</span><br><span class="line">          uint64_tu64;</span><br><span class="line">          int64_ts64;</span><br><span class="line">     &#125;v;</span><br><span class="line"> </span><br><span class="line">     <span class="comment">//æŒ‡å‘ä¸‹ä¸€ä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹ï¼Œå½¢æˆé“¾è¡¨</span></span><br><span class="line">     <span class="class"><span class="keyword">struct</span> <span class="title">dictEntry</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125;dictEntry</span><br></pre></td></tr></table></figure><p>key ç”¨æ¥ä¿å­˜é”®ï¼Œval å±æ€§ç”¨æ¥ä¿å­˜å€¼ï¼Œå€¼å¯ä»¥æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œä¹Ÿå¯ä»¥æ˜¯uint64_tæ•´æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯int64_tæ•´æ•°ã€‚</p><p>æ³¨æ„è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªæŒ‡å‘ä¸‹ä¸€ä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œæˆ‘ä»¬çŸ¥é“å“ˆå¸Œè¡¨æœ€å¤§çš„é—®é¢˜æ˜¯å­˜åœ¨å“ˆå¸Œå†²çªï¼Œå¦‚ä½•è§£å†³å“ˆå¸Œå†²çªï¼Œæœ‰å¼€æ”¾åœ°å€æ³•å’Œé“¾åœ°å€æ³•ã€‚è¿™é‡Œé‡‡ç”¨çš„ä¾¿æ˜¯é“¾åœ°å€æ³•ï¼Œé€šè¿‡nextè¿™ä¸ªæŒ‡é’ˆå¯ä»¥å°†å¤šä¸ªå“ˆå¸Œå€¼ç›¸åŒçš„é”®å€¼å¯¹è¿æ¥åœ¨ä¸€èµ·ï¼Œç”¨æ¥<strong>è§£å†³å“ˆå¸Œå†²çª</strong>ã€‚</p><h3 id="5-2-ä¸€äº›è¦ç‚¹"><a href="#5-2-ä¸€äº›è¦ç‚¹" class="headerlink" title="5.2. ä¸€äº›è¦ç‚¹"></a>5.2. ä¸€äº›è¦ç‚¹</h3><ul><li><strong>å“ˆå¸Œç®—æ³•</strong>ï¼šRedisè®¡ç®—å“ˆå¸Œå€¼å’Œç´¢å¼•å€¼æ–¹æ³•å¦‚ä¸‹ï¼š</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1ã€ä½¿ç”¨å­—å…¸è®¾ç½®çš„å“ˆå¸Œå‡½æ•°ï¼Œè®¡ç®—é”® key çš„å“ˆå¸Œå€¼</span></span><br><span class="line"><span class="built_in">hash</span> = dict-&gt;<span class="built_in">type</span>-&gt;hashFunction(key);</span><br><span class="line"></span><br><span class="line"><span class="comment">#2ã€ä½¿ç”¨å“ˆå¸Œè¡¨çš„sizemaskå±æ€§å’Œç¬¬ä¸€æ­¥å¾—åˆ°çš„å“ˆå¸Œå€¼ï¼Œè®¡ç®—ç´¢å¼•å€¼</span></span><br><span class="line">index = <span class="built_in">hash</span> &amp; dict-&gt;ht[x].sizemask;</span><br></pre></td></tr></table></figure><ul><li><strong>è§£å†³å“ˆå¸Œå†²çª</strong>ï¼šè¿™ä¸ªé—®é¢˜ä¸Šé¢æˆ‘ä»¬ä»‹ç»äº†ï¼Œæ–¹æ³•æ˜¯é“¾åœ°å€æ³•ã€‚é€šè¿‡å­—å…¸é‡Œé¢çš„ *next æŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€ä¸ªå…·æœ‰ç›¸åŒç´¢å¼•å€¼çš„å“ˆå¸Œè¡¨èŠ‚ç‚¹ã€‚</li><li><strong>æ‰©å®¹å’Œæ”¶ç¼©</strong>ï¼šå½“å“ˆå¸Œè¡¨ä¿å­˜çš„é”®å€¼å¯¹å¤ªå¤šæˆ–è€…å¤ªå°‘æ—¶ï¼Œå°±è¦é€šè¿‡ rerehash(é‡æ–°æ•£åˆ—ï¼‰æ¥å¯¹å“ˆå¸Œè¡¨è¿›è¡Œç›¸åº”çš„æ‰©å±•æˆ–è€…æ”¶ç¼©ã€‚å…·ä½“æ­¥éª¤ï¼š</li></ul><p>1ã€å¦‚æœæ‰§è¡Œæ‰©å±•æ“ä½œï¼Œä¼šåŸºäºåŸå“ˆå¸Œè¡¨åˆ›å»ºä¸€ä¸ªå¤§å°ç­‰äº ht[0].used*2n çš„å“ˆå¸Œè¡¨ï¼ˆä¹Ÿå°±æ˜¯æ¯æ¬¡æ‰©å±•éƒ½æ˜¯æ ¹æ®åŸå“ˆå¸Œè¡¨å·²ä½¿ç”¨çš„ç©ºé—´æ‰©å¤§ä¸€å€åˆ›å»ºå¦ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼‰ã€‚ç›¸åå¦‚æœæ‰§è¡Œçš„æ˜¯æ”¶ç¼©æ“ä½œï¼Œæ¯æ¬¡æ”¶ç¼©æ˜¯æ ¹æ®å·²ä½¿ç”¨ç©ºé—´ç¼©å°ä¸€å€åˆ›å»ºä¸€ä¸ªæ–°çš„å“ˆå¸Œè¡¨ã€‚</p><p>2ã€é‡æ–°åˆ©ç”¨ä¸Šé¢çš„å“ˆå¸Œç®—æ³•ï¼Œè®¡ç®—ç´¢å¼•å€¼ï¼Œç„¶åå°†é”®å€¼å¯¹æ”¾åˆ°æ–°çš„å“ˆå¸Œè¡¨ä½ç½®ä¸Šã€‚</p><p>3ã€æ‰€æœ‰é”®å€¼å¯¹éƒ½è¿å¾™å®Œæ¯•åï¼Œé‡Šæ”¾åŸå“ˆå¸Œè¡¨çš„å†…å­˜ç©ºé—´ã€‚</p><ul><li><strong>è§¦å‘æ‰©å®¹çš„æ¡ä»¶</strong>ï¼š</li></ul><p>1ã€æœåŠ¡å™¨ç›®å‰æ²¡æœ‰æ‰§è¡Œ BGSAVE å‘½ä»¤æˆ–è€… BGREWRITEAOF å‘½ä»¤ï¼Œå¹¶ä¸”è´Ÿè½½å› å­å¤§äºç­‰äº1ã€‚</p><p>2ã€æœåŠ¡å™¨ç›®å‰æ­£åœ¨æ‰§è¡Œ BGSAVE å‘½ä»¤æˆ–è€… BGREWRITEAOF å‘½ä»¤ï¼Œå¹¶ä¸”è´Ÿè½½å› å­å¤§äºç­‰äº5ã€‚</p><p>psï¼šè´Ÿè½½å› å­ &#x3D; å“ˆå¸Œè¡¨å·²ä¿å­˜èŠ‚ç‚¹æ•°é‡ &#x2F; å“ˆå¸Œè¡¨å¤§å°ã€‚</p><ul><li><strong>æ¸è¿‘å¼ rehash</strong></li></ul><p>ä»€ä¹ˆå«æ¸è¿›å¼ rehashï¼Ÿä¹Ÿå°±æ˜¯è¯´æ‰©å®¹å’Œæ”¶ç¼©æ“ä½œä¸æ˜¯ä¸€æ¬¡æ€§ã€é›†ä¸­å¼å®Œæˆçš„ï¼Œè€Œæ˜¯åˆ†å¤šæ¬¡ã€æ¸è¿›å¼å®Œæˆçš„ã€‚å¦‚æœä¿å­˜åœ¨Redisä¸­çš„é”®å€¼å¯¹åªæœ‰å‡ ä¸ªå‡ åä¸ªï¼Œé‚£ä¹ˆ rehash æ“ä½œå¯ä»¥ç¬é—´å®Œæˆï¼Œä½†æ˜¯å¦‚æœé”®å€¼å¯¹æœ‰å‡ ç™¾ä¸‡ï¼Œå‡ åƒä¸‡ç”šè‡³å‡ äº¿ï¼Œé‚£ä¹ˆè¦ä¸€æ¬¡æ€§çš„è¿›è¡Œ rehashï¼ŒåŠ¿å¿…ä¼šé€ æˆRedisä¸€æ®µæ—¶é—´å†…ä¸èƒ½è¿›è¡Œåˆ«çš„æ“ä½œã€‚æ‰€ä»¥Redisé‡‡ç”¨æ¸è¿›å¼ rehash,è¿™æ ·åœ¨è¿›è¡Œæ¸è¿›å¼rehashæœŸé—´ï¼Œå­—å…¸çš„åˆ é™¤æŸ¥æ‰¾æ›´æ–°ç­‰æ“ä½œå¯èƒ½ä¼šåœ¨ä¸¤ä¸ªå“ˆå¸Œè¡¨ä¸Šè¿›è¡Œï¼Œç¬¬ä¸€ä¸ªå“ˆå¸Œè¡¨æ²¡æœ‰æ‰¾åˆ°ï¼Œå°±ä¼šå»ç¬¬äºŒä¸ªå“ˆå¸Œè¡¨ä¸Šè¿›è¡ŒæŸ¥æ‰¾ã€‚ä½†æ˜¯è¿›è¡Œ å¢åŠ æ“ä½œï¼Œä¸€å®šæ˜¯åœ¨æ–°çš„å“ˆå¸Œè¡¨ä¸Šè¿›è¡Œçš„ã€‚</p><h2 id="6-æ•´æ•°é›†-IntSet"><a href="#6-æ•´æ•°é›†-IntSet" class="headerlink" title="6. æ•´æ•°é›† - IntSet"></a>6. æ•´æ•°é›† - IntSet</h2><p>æ•´æ•°é›†åˆï¼ˆintsetï¼‰æ˜¯é›†åˆç±»å‹çš„åº•å±‚å®ç°ä¹‹ä¸€ï¼Œå½“ä¸€ä¸ªé›†åˆåªåŒ…å«æ•´æ•°å€¼å…ƒç´ ï¼Œå¹¶ä¸”è¿™ä¸ªé›†åˆçš„å…ƒç´ æ•°é‡ä¸å¤šæ—¶ï¼ŒRedis å°±ä¼šä½¿ç”¨æ•´æ•°é›†åˆä½œä¸ºé›†åˆé”®çš„åº•å±‚å®ç°ã€‚</p><h3 id="6-1-intsetç»“æ„"><a href="#6-1-intsetç»“æ„" class="headerlink" title="6.1. intsetç»“æ„"></a>6.1. intsetç»“æ„</h3><p>é¦–å…ˆçœ‹æºç ç»“æ„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">intset</span> &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> encoding;</span><br><span class="line">    <span class="type">uint32_t</span> length;</span><br><span class="line">    <span class="type">int8_t</span> contents[];</span><br><span class="line">&#125; intset;</span><br></pre></td></tr></table></figure><p>encoding è¡¨ç¤ºç¼–ç æ–¹å¼ï¼Œçš„å–å€¼æœ‰ä¸‰ä¸ªï¼šINTSET_ENC_INT16, INTSET_ENC_INT32, INTSET_ENC_INT64</p><p>length ä»£è¡¨å…¶ä¸­å­˜å‚¨çš„æ•´æ•°çš„ä¸ªæ•°</p><p>contents æŒ‡å‘å®é™…å­˜å‚¨æ•°å€¼çš„è¿ç»­å†…å­˜åŒºåŸŸ, å°±æ˜¯ä¸€ä¸ªæ•°ç»„ï¼›æ•´æ•°é›†åˆçš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ contents æ•°ç»„çš„ä¸€ä¸ªæ•°ç»„é¡¹ï¼ˆitemï¼‰ï¼Œå„ä¸ªé¡¹åœ¨æ•°ç»„ä¸­æŒ‰å€¼å¾—å¤§å°<strong>ä»å°åˆ°å¤§æœ‰åºæ’åº</strong>ï¼Œä¸”æ•°ç»„ä¸­ä¸åŒ…å«ä»»ä½•é‡å¤é¡¹ã€‚ï¼ˆè™½ç„¶ intset ç»“æ„å°† contents å±æ€§å£°æ˜ä¸º int8_t ç±»å‹çš„æ•°ç»„ï¼Œä½†å®é™…ä¸Š contents æ•°ç»„å¹¶ä¸ä¿å­˜ä»»ä½• int8_t ç±»å‹çš„å€¼ï¼Œcontents æ•°ç»„çš„çœŸæ­£ç±»å‹å–å†³äº encoding å±æ€§çš„å€¼ï¼‰</p><h3 id="6-2-å†…å­˜å¸ƒå±€å›¾"><a href="#6-2-å†…å­˜å¸ƒå±€å›¾" class="headerlink" title="6.2. å†…å­˜å¸ƒå±€å›¾"></a>6.2. å†…å­˜å¸ƒå±€å›¾</h3><p>å…¶å†…å­˜å¸ƒå±€å¦‚ä¸‹å›¾æ‰€ç¤º</p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œcontentæ•°ç»„é‡Œé¢æ¯ä¸ªå…ƒç´ çš„æ•°æ®ç±»å‹æ˜¯ç”±encodingæ¥å†³å®šçš„ï¼Œé‚£ä¹ˆå¦‚æœåŸæ¥çš„æ•°æ®ç±»å‹æ˜¯int16, å½“æˆ‘ä»¬å†æ’å…¥ä¸€ä¸ªint32ç±»å‹çš„æ•°æ®æ—¶æ€ä¹ˆåŠå‘¢ï¼Ÿè¿™å°±æ˜¯ä¸‹é¢è¦è¯´çš„intsetçš„å‡çº§ã€‚</p><h3 id="6-3-æ•´æ•°é›†åˆçš„å‡çº§"><a href="#6-3-æ•´æ•°é›†åˆçš„å‡çº§" class="headerlink" title="6.3. æ•´æ•°é›†åˆçš„å‡çº§"></a>6.3. æ•´æ•°é›†åˆçš„å‡çº§</h3><p>å½“åœ¨ä¸€ä¸ªint16ç±»å‹çš„æ•´æ•°é›†åˆä¸­æ’å…¥ä¸€ä¸ªint32ç±»å‹çš„å€¼ï¼Œæ•´ä¸ªé›†åˆçš„æ‰€æœ‰å…ƒç´ éƒ½ä¼šè½¬æ¢æˆ32ç±»å‹ã€‚ æ•´ä¸ªè¿‡ç¨‹æœ‰ä¸‰æ­¥ï¼š</p><ul><li>æ ¹æ®æ–°å…ƒç´ çš„ç±»å‹ï¼ˆæ¯”å¦‚int32ï¼‰ï¼Œæ‰©å±•æ•´æ•°é›†åˆåº•å±‚æ•°ç»„çš„ç©ºé—´å¤§å°ï¼Œå¹¶ä¸ºæ–°å…ƒç´ åˆ†é…ç©ºé—´ã€‚</li><li>å°†åº•å±‚æ•°ç»„ç°æœ‰çš„æ‰€æœ‰å…ƒç´ éƒ½è½¬æ¢æˆä¸æ–°å…ƒç´ ç›¸åŒçš„ç±»å‹ï¼Œ å¹¶å°†ç±»å‹è½¬æ¢åçš„å…ƒç´ æ”¾ç½®åˆ°æ­£ç¡®çš„ä½ä¸Šï¼Œ è€Œä¸”åœ¨æ”¾ç½®å…ƒç´ çš„è¿‡ç¨‹ä¸­ï¼Œ éœ€è¦ç»§ç»­ç»´æŒåº•å±‚æ•°ç»„çš„æœ‰åºæ€§è´¨ä¸å˜ã€‚</li><li>æœ€åæ”¹å˜encodingçš„å€¼ï¼Œlength+1ã€‚</li></ul><p><strong>é‚£ä¹ˆå¦‚æœæˆ‘ä»¬åˆ é™¤æ‰åˆšåŠ å…¥çš„int32ç±»å‹æ—¶ï¼Œä¼šä¸ä¼šåšä¸€ä¸ªé™çº§æ“ä½œå‘¢</strong>ï¼Ÿ</p><p>ä¸ä¼šã€‚ä¸»è¦è¿˜æ˜¯å‡å°‘å¼€é”€çš„æƒè¡¡ã€‚</p><h2 id="7-è·³è¡¨-ZSkipList"><a href="#7-è·³è¡¨-ZSkipList" class="headerlink" title="7. è·³è¡¨ - ZSkipList"></a>7. è·³è¡¨ - ZSkipList</h2><p><a href="https://zhuanlan.zhihu.com/p/576984787">redis zskiplistè·³è¡¨ï¼Œæ€§èƒ½å ªæ¯”çº¢é»‘æ ‘ï¼Ÿï¼ˆæ·±åº¦åˆ†æï¼‰</a></p><p>è·³è·ƒè¡¨ç»“æ„åœ¨ Redis ä¸­çš„è¿ç”¨åœºæ™¯åªæœ‰ä¸€ä¸ªï¼Œé‚£å°±æ˜¯ä½œä¸ºæœ‰åºåˆ—è¡¨ (Zset) çš„ä½¿ç”¨ã€‚è·³è·ƒè¡¨çš„æ€§èƒ½å¯ä»¥ä¿è¯åœ¨æŸ¥æ‰¾ï¼Œåˆ é™¤ï¼Œæ·»åŠ ç­‰æ“ä½œçš„æ—¶å€™åœ¨å¯¹æ•°æœŸæœ›æ—¶é—´å†…å®Œæˆï¼Œè¿™ä¸ªæ€§èƒ½æ˜¯å¯ä»¥å’Œå¹³è¡¡æ ‘æ¥ç›¸æ¯”è¾ƒçš„ï¼Œè€Œä¸”åœ¨å®ç°æ–¹é¢æ¯”å¹³è¡¡æ ‘è¦ä¼˜é›…ï¼Œè¿™å°±æ˜¯è·³è·ƒè¡¨çš„é•¿å¤„ã€‚è·³è·ƒè¡¨çš„ç¼ºç‚¹å°±æ˜¯éœ€è¦çš„å­˜å‚¨ç©ºé—´æ¯”è¾ƒå¤§ï¼Œå±äºåˆ©ç”¨ç©ºé—´æ¥æ¢å–æ—¶é—´çš„æ•°æ®ç»“æ„ã€‚</p><h3 id="7-1-ä»€ä¹ˆæ˜¯è·³è·ƒè¡¨"><a href="#7-1-ä»€ä¹ˆæ˜¯è·³è·ƒè¡¨" class="headerlink" title="7.1. ä»€ä¹ˆæ˜¯è·³è·ƒè¡¨"></a>7.1. ä»€ä¹ˆæ˜¯è·³è·ƒè¡¨</h3><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1683188767947-029a8488-19ac-4266-b882-ac1f83760bf7-20250605104436000.png" alt="img"></p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1683188755238-44e4cadc-ee00-4cb5-80c8-0b8dc991022f.webp" alt="img"></p><p>è·³è·ƒè¡¨è¦è§£å†³ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿå¦‚æœä½ ä¸€ä¸Šæ¥å°±å»çœ‹å®ƒçš„å®ç°ï¼Œä½ å¾ˆéš¾ç†è§£è®¾è®¡çš„æœ¬è´¨ï¼Œæ‰€ä»¥å…ˆè¦çœ‹å®ƒçš„è®¾è®¡è¦è§£å†³ä»€ä¹ˆé—®é¢˜ã€‚</p><p>å¯¹äºäºä¸€ä¸ªå•é“¾è¡¨æ¥è®²ï¼Œå³ä¾¿é“¾è¡¨ä¸­å­˜å‚¨çš„æ•°æ®æ˜¯æœ‰åºçš„ï¼Œå¦‚æœæˆ‘ä»¬è¦æƒ³åœ¨å…¶ä¸­æŸ¥æ‰¾æŸä¸ªæ•°æ®ï¼Œä¹Ÿåªèƒ½ä»å¤´åˆ°å°¾éå†é“¾è¡¨ã€‚è¿™æ ·æŸ¥æ‰¾æ•ˆç‡å°±ä¼šå¾ˆä½ï¼Œæ—¶é—´å¤æ‚åº¦ä¼šå¾ˆé«˜ï¼Œæ˜¯ O(n)ã€‚æ¯”å¦‚æŸ¥æ‰¾12ï¼Œéœ€è¦7æ¬¡æŸ¥æ‰¾</p><p>å¦‚æœæˆ‘ä»¬å¢åŠ å¦‚ä¸‹ä¸¤çº§ç´¢å¼•ï¼Œé‚£ä¹ˆå®ƒæœç´¢æ¬¡æ•°å°±å˜æˆäº†3æ¬¡</p><h3 id="7-2-Redisè·³è·ƒè¡¨çš„è®¾è®¡"><a href="#7-2-Redisè·³è·ƒè¡¨çš„è®¾è®¡" class="headerlink" title="7.2. Redisè·³è·ƒè¡¨çš„è®¾è®¡"></a>7.2. Redisè·³è·ƒè¡¨çš„è®¾è®¡</h3><p>redisè·³è·ƒè¡¨å¹¶æ²¡æœ‰åœ¨å•ç‹¬çš„ç±»ï¼ˆæ¯”å¦‚skplist.c)ä¸­å®šä¹‰ï¼Œè€Œæ˜¯å…¶å®šä¹‰åœ¨server.hä¸­, å¦‚ä¸‹:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ZSETs use a specialized version of Skiplists */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> &#123;</span></span><br><span class="line">    sds ele;</span><br><span class="line">    <span class="type">double</span> score;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">backward</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistLevel</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">forward</span>;</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> span;</span><br><span class="line">    &#125; level[];</span><br><span class="line">&#125; zskiplistNode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zskiplist</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">header</span>, *<span class="title">tail</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> length;</span><br><span class="line">    <span class="type">int</span> level;</span><br><span class="line">&#125; zskiplist;</span><br></pre></td></tr></table></figure><p>å…¶å†…å­˜å¸ƒå±€å¦‚ä¸‹å›¾:</p><p><strong>zskiplistçš„æ ¸å¿ƒè®¾è®¡è¦ç‚¹</strong></p><ul><li><p><strong>å¤´èŠ‚ç‚¹</strong>ä¸æŒæœ‰ä»»ä½•æ•°æ®, ä¸”å…¶level[]çš„é•¿åº¦ä¸º32</p></li><li><p><strong>æ¯ä¸ªç»“ç‚¹</strong></p></li><li><ul><li>eleå­—æ®µï¼ŒæŒæœ‰æ•°æ®ï¼Œæ˜¯sdsç±»å‹</li><li>scoreå­—æ®µ, å…¶æ ‡ç¤ºç€ç»“ç‚¹çš„å¾—åˆ†, ç»“ç‚¹ä¹‹é—´å‡­å€Ÿå¾—åˆ†æ¥åˆ¤æ–­å…ˆåé¡ºåº, è·³è·ƒè¡¨ä¸­çš„ç»“ç‚¹æŒ‰ç»“ç‚¹çš„å¾—åˆ†å‡åºæ’åˆ—.</li><li>backwardæŒ‡é’ˆ, è¿™æ˜¯åŸç‰ˆè·³è·ƒè¡¨ä¸­æ‰€æ²¡æœ‰çš„. è¯¥æŒ‡é’ˆæŒ‡å‘ç»“ç‚¹çš„å‰ä¸€ä¸ªç´§é‚»ç»“ç‚¹.</li><li>levelå­—æ®µ, ç”¨ä»¥è®°å½•æ‰€æœ‰ç»“ç‚¹(é™¤è¿‡å¤´èŠ‚ç‚¹å¤–)ï¼›æ¯ä¸ªç»“ç‚¹ä¸­æœ€å¤šæŒæœ‰32ä¸ªzskiplistLevelç»“æ„. å®é™…æ•°é‡åœ¨ç»“ç‚¹åˆ›å»ºæ—¶, æŒ‰å¹‚æ¬¡å®šå¾‹éšæœºç”Ÿæˆ(ä¸è¶…è¿‡32). æ¯ä¸ªzskiplistLevelä¸­æœ‰ä¸¤ä¸ªå­—æ®µ</li></ul></li><li><ul><li><ul><li>forwardå­—æ®µæŒ‡å‘æ¯”è‡ªå·±å¾—åˆ†é«˜çš„æŸä¸ªç»“ç‚¹(ä¸ä¸€å®šæ˜¯ç´§é‚»çš„), å¹¶ä¸”, è‹¥å½“å‰zskiplistLevelå®ä¾‹åœ¨level[]ä¸­çš„ç´¢å¼•ä¸ºX, åˆ™å…¶forwardå­—æ®µæŒ‡å‘çš„ç»“ç‚¹, å…¶level[]å­—æ®µçš„å®¹é‡è‡³å°‘æ˜¯X+1. è¿™ä¹Ÿæ˜¯ä¸Šå›¾ä¸­, ä¸ºä»€ä¹ˆforwardæŒ‡é’ˆæ€»æ˜¯ç”»çš„æ°´å¹³çš„åŸå› .</li><li>spanå­—æ®µä»£è¡¨forwardå­—æ®µæŒ‡å‘çš„ç»“ç‚¹, è·ç¦»å½“å‰ç»“ç‚¹çš„è·ç¦». ç´§é‚»çš„ä¸¤ä¸ªç»“ç‚¹ä¹‹é—´çš„è·ç¦»å®šä¹‰ä¸º1.</li></ul></li></ul></li></ul><h3 id="7-3-ä¸ºä»€ä¹ˆä¸ç”¨å¹³è¡¡æ ‘æˆ–è€…å“ˆå¸Œè¡¨"><a href="#7-3-ä¸ºä»€ä¹ˆä¸ç”¨å¹³è¡¡æ ‘æˆ–è€…å“ˆå¸Œè¡¨" class="headerlink" title="7.3. ä¸ºä»€ä¹ˆä¸ç”¨å¹³è¡¡æ ‘æˆ–è€…å“ˆå¸Œè¡¨"></a>7.3. ä¸ºä»€ä¹ˆä¸ç”¨å¹³è¡¡æ ‘æˆ–è€…å“ˆå¸Œè¡¨</h3><ul><li><strong>ä¸ºä»€ä¹ˆä¸æ˜¯å¹³è¡¡æ ‘ï¼Œå…ˆçœ‹ä¸‹ä½œè€…çš„å›ç­”</strong></li></ul><p>There are a few reasons:</p><p>They are not very memory intensive. Itâ€™s up to you basically. Changing parameters about the probability of a node to have a given number of levels will make then less memory intensive than btrees.</p><p>A sorted set is often target of many ZRANGE or ZREVRANGE operations, that is, traversing the skip list as a linked list. With this operation the cache locality of skip lists is at least as good as with other kind of balanced trees.</p><p>They are simpler to implement, debug, and so forth. For instance thanks to the skip list simplicity I received a patch (already in Redis master) with augmented skip lists implementing ZRANK in O(log(N)). It required little changes to the code.</p><p>About the Append Only durability &amp; speed, I donâ€™t think it is a good idea to optimize Redis at cost of more code and more complexity for a use case that IMHO should be rare for the Redis target (fsync() at every command). Almost no one is using this feature even with ACID SQL databases, as the performance hint is big anyway.</p><p>About threads: our experience shows that Redis is mostly I&#x2F;O bound. Iâ€™m using threads to serve things from Virtual Memory. The long term solution to exploit all the cores, assuming your link is so fast that you can saturate a single core, is running multiple instances of Redis (no locks, almost fully scalable linearly with number of cores), and using the â€œRedis Clusterâ€ solution that I plan to develop in the future.</p><p>ç®€è€Œè¨€ä¹‹å°±æ˜¯å®ç°ç®€å•ä¸”è¾¾åˆ°äº†ç±»ä¼¼æ•ˆæœã€‚</p><ul><li><strong>skiplistä¸å¹³è¡¡æ ‘ã€å“ˆå¸Œè¡¨çš„æ¯”è¾ƒ</strong></li></ul><p>skiplistå’Œå„ç§å¹³è¡¡æ ‘ï¼ˆå¦‚AVLã€çº¢é»‘æ ‘ç­‰ï¼‰çš„å…ƒç´ æ˜¯æœ‰åºæ’åˆ—çš„ï¼Œè€Œå“ˆå¸Œè¡¨ä¸æ˜¯æœ‰åºçš„ã€‚å› æ­¤ï¼Œåœ¨å“ˆå¸Œè¡¨ä¸Šåªèƒ½åšå•ä¸ªkeyçš„æŸ¥æ‰¾ï¼Œä¸é€‚å®œåšèŒƒå›´æŸ¥æ‰¾ã€‚æ‰€è°“èŒƒå›´æŸ¥æ‰¾ï¼ŒæŒ‡çš„æ˜¯æŸ¥æ‰¾é‚£äº›å¤§å°åœ¨æŒ‡å®šçš„ä¸¤ä¸ªå€¼ä¹‹é—´çš„æ‰€æœ‰èŠ‚ç‚¹ã€‚</p><p>åœ¨åšèŒƒå›´æŸ¥æ‰¾çš„æ—¶å€™ï¼Œå¹³è¡¡æ ‘æ¯”skiplistæ“ä½œè¦å¤æ‚ã€‚åœ¨å¹³è¡¡æ ‘ä¸Šï¼Œæˆ‘ä»¬æ‰¾åˆ°æŒ‡å®šèŒƒå›´çš„å°å€¼ä¹‹åï¼Œè¿˜éœ€è¦ä»¥ä¸­åºéå†çš„é¡ºåºç»§ç»­å¯»æ‰¾å…¶å®ƒä¸è¶…è¿‡å¤§å€¼çš„èŠ‚ç‚¹ã€‚å¦‚æœä¸å¯¹å¹³è¡¡æ ‘è¿›è¡Œä¸€å®šçš„æ”¹é€ ï¼Œè¿™é‡Œçš„ä¸­åºéå†å¹¶ä¸å®¹æ˜“å®ç°ã€‚è€Œåœ¨skiplistä¸Šè¿›è¡ŒèŒƒå›´æŸ¥æ‰¾å°±éå¸¸ç®€å•ï¼Œåªéœ€è¦åœ¨æ‰¾åˆ°å°å€¼ä¹‹åï¼Œå¯¹ç¬¬1å±‚é“¾è¡¨è¿›è¡Œè‹¥å¹²æ­¥çš„éå†å°±å¯ä»¥å®ç°ã€‚</p><p>å¹³è¡¡æ ‘çš„æ’å…¥å’Œåˆ é™¤æ“ä½œå¯èƒ½å¼•å‘å­æ ‘çš„è°ƒæ•´ï¼Œé€»è¾‘å¤æ‚ï¼Œè€Œskiplistçš„æ’å…¥å’Œåˆ é™¤åªéœ€è¦ä¿®æ”¹ç›¸é‚»èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œæ“ä½œç®€å•åˆå¿«é€Ÿã€‚</p><p>ä»å†…å­˜å ç”¨ä¸Šæ¥è¯´ï¼Œskiplistæ¯”å¹³è¡¡æ ‘æ›´çµæ´»ä¸€äº›ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå¹³è¡¡æ ‘æ¯ä¸ªèŠ‚ç‚¹åŒ…å«2ä¸ªæŒ‡é’ˆï¼ˆåˆ†åˆ«æŒ‡å‘å·¦å³å­æ ‘ï¼‰ï¼Œè€Œskiplistæ¯ä¸ªèŠ‚ç‚¹åŒ…å«çš„æŒ‡é’ˆæ•°ç›®å¹³å‡ä¸º1&#x2F;(1-p)ï¼Œå…·ä½“å–å†³äºå‚æ•°pçš„å¤§å°ã€‚å¦‚æœåƒRedisé‡Œçš„å®ç°ä¸€æ ·ï¼Œå–p&#x3D;1&#x2F;4ï¼Œé‚£ä¹ˆå¹³å‡æ¯ä¸ªèŠ‚ç‚¹åŒ…å«1.33ä¸ªæŒ‡é’ˆï¼Œæ¯”å¹³è¡¡æ ‘æ›´æœ‰ä¼˜åŠ¿ã€‚</p><p>æŸ¥æ‰¾å•ä¸ªkeyï¼Œskiplistå’Œå¹³è¡¡æ ‘çš„æ—¶é—´å¤æ‚åº¦éƒ½ä¸ºO(log n)ï¼Œå¤§ä½“ç›¸å½“ï¼›è€Œå“ˆå¸Œè¡¨åœ¨ä¿æŒè¾ƒä½çš„å“ˆå¸Œå€¼å†²çªæ¦‚ç‡çš„å‰æä¸‹ï¼ŒæŸ¥æ‰¾æ—¶é—´å¤æ‚åº¦æ¥è¿‘O(1)ï¼Œæ€§èƒ½æ›´é«˜ä¸€äº›ã€‚æ‰€ä»¥æˆ‘ä»¬å¹³å¸¸ä½¿ç”¨çš„å„ç§Mapæˆ–dictionaryç»“æ„ï¼Œå¤§éƒ½æ˜¯åŸºäºå“ˆå¸Œè¡¨å®ç°çš„ã€‚</p><p>ä»ç®—æ³•å®ç°éš¾åº¦ä¸Šæ¥æ¯”è¾ƒï¼Œskiplistæ¯”å¹³è¡¡æ ‘è¦ç®€å•å¾—å¤šã€‚</p><h2 id="8-å‚è€ƒæ–‡ç« "><a href="#8-å‚è€ƒæ–‡ç« " class="headerlink" title="8. å‚è€ƒæ–‡ç« "></a>8. å‚è€ƒæ–‡ç« </h2><ul><li>Redis 6.0æºç </li><li><a href="https://www.cnblogs.com/neooelric/p/9621736.html">https://www.cnblogs.com/neooelric/p/9621736.html</a></li></ul><p>è¿˜å‚è€ƒäº†</p><p><a href="https://www.cnblogs.com/hunternet/p/11248192.html">https://www.cnblogs.com/hunternet/p/11248192.html</a></p><p><a href="https://www.jianshu.com/p/8ac45fd01548">https://www.jianshu.com/p/8ac45fd01548</a></p>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>æŒ‡ä»¤é‡æ’ çœŸçš„æœ‰ç‚¹é˜´</title>
      <link href="/2025/06/07/%E6%8C%87%E4%BB%A4%E9%87%8D%E6%8E%92%20%E7%9C%9F%E7%9A%84%E6%9C%89%E7%82%B9%E9%98%B4/"/>
      <url>/2025/06/07/%E6%8C%87%E4%BB%A4%E9%87%8D%E6%8E%92%20%E7%9C%9F%E7%9A%84%E6%9C%89%E7%82%B9%E9%98%B4/</url>
      
        <content type="html"><![CDATA[<h1 id="æŒ‡ä»¤é‡æ’-çœŸçš„æœ‰ç‚¹é˜´"><a href="#æŒ‡ä»¤é‡æ’-çœŸçš„æœ‰ç‚¹é˜´" class="headerlink" title="æŒ‡ä»¤é‡æ’ çœŸçš„æœ‰ç‚¹é˜´"></a>æŒ‡ä»¤é‡æ’ çœŸçš„æœ‰ç‚¹é˜´</h1><p>åœ¨ Java ä¸­ï¼Œ<strong>æŒ‡ä»¤é‡æ’ï¼ˆInstruction Reorderingï¼‰</strong> æ˜¯ç¼–è¯‘å™¨ã€å¤„ç†å™¨æˆ–å†…å­˜ç³»ç»Ÿä¸ºäº†æé«˜æ‰§è¡Œæ•ˆç‡è€Œå¯¹æŒ‡ä»¤é¡ºåºè¿›è¡Œçš„ä¼˜åŒ–ã€‚è¿™ç§ä¼˜åŒ–åœ¨å•çº¿ç¨‹ç¯å¢ƒä¸‹æ˜¯é€æ˜çš„ï¼ˆéµå¾ª <code>as-if-serial</code> è¯­ä¹‰ï¼‰ï¼Œä½†åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­å¯èƒ½å¯¼è‡´ <strong>å¯è§æ€§</strong> å’Œ <strong>æœ‰åºæ€§</strong> é—®é¢˜ã€‚ä»¥ä¸‹æ˜¯ Java ä¸­å¯èƒ½è¢«æŒ‡ä»¤é‡æ’çš„å…¸å‹æ“ä½œå’Œåœºæ™¯ï¼Œä»¥åŠå¯¹åº”çš„è§£å†³æ–¹æ¡ˆï¼š</p><p>â€”â€”s</p><h3 id="ä¸€ã€å¯èƒ½è¢«æŒ‡ä»¤é‡æ’çš„æ“ä½œåŠåœºæ™¯"><a href="#ä¸€ã€å¯èƒ½è¢«æŒ‡ä»¤é‡æ’çš„æ“ä½œåŠåœºæ™¯" class="headerlink" title="ä¸€ã€å¯èƒ½è¢«æŒ‡ä»¤é‡æ’çš„æ“ä½œåŠåœºæ™¯"></a><strong>ä¸€ã€å¯èƒ½è¢«æŒ‡ä»¤é‡æ’çš„æ“ä½œåŠåœºæ™¯</strong></h3><h4 id="1-æ™®é€šå˜é‡èµ‹å€¼ï¼ˆé-volatileï¼‰"><a href="#1-æ™®é€šå˜é‡èµ‹å€¼ï¼ˆé-volatileï¼‰" class="headerlink" title="1. æ™®é€šå˜é‡èµ‹å€¼ï¼ˆé volatileï¼‰"></a><strong>1. æ™®é€šå˜é‡èµ‹å€¼ï¼ˆé</strong> <code>volatile</code><strong>ï¼‰</strong></h4><ul><li><strong>åœºæ™¯</strong>ï¼š<br>å¤šä¸ªçº¿ç¨‹å¯¹åŒä¸€é <code>volatile</code> å˜é‡è¿›è¡Œè¯»å†™ã€‚</li><li><strong>ç¤ºä¾‹</strong>ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// çº¿ç¨‹1</span></span><br><span class="line">a = <span class="number">1</span>;          <span class="comment">// å¯èƒ½è¢«é‡æ’åˆ° flag èµ‹å€¼ä¹‹å</span></span><br><span class="line">flag = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// çº¿ç¨‹2</span></span><br><span class="line"><span class="keyword">if</span> (flag) &#123;</span><br><span class="line">    System.out.println(a); <span class="comment">// å¯èƒ½è¾“å‡º 0ï¼ˆæœªè§‚å¯Ÿåˆ° a=1ï¼‰</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>é—®é¢˜</strong>ï¼š<br>çº¿ç¨‹1çš„ <code>a = 1</code> å’Œ <code>flag = true</code> å¯èƒ½è¢«é‡æ’ï¼Œå¯¼è‡´çº¿ç¨‹2çœ‹åˆ° <code>flag</code> ä¸º <code>true</code> æ—¶ï¼Œ<code>a</code> ä»ä¸º 0ã€‚</li></ul><h4 id="2-å¯¹è±¡åˆå§‹åŒ–ï¼ˆéå®‰å…¨å‘å¸ƒï¼‰"><a href="#2-å¯¹è±¡åˆå§‹åŒ–ï¼ˆéå®‰å…¨å‘å¸ƒï¼‰" class="headerlink" title="2. å¯¹è±¡åˆå§‹åŒ–ï¼ˆéå®‰å…¨å‘å¸ƒï¼‰"></a><strong>2. å¯¹è±¡åˆå§‹åŒ–ï¼ˆéå®‰å…¨å‘å¸ƒï¼‰</strong></h4><ul><li><strong>åœºæ™¯</strong>ï¼š<br>å¯¹è±¡çš„æ„é€ è¿‡ç¨‹ä¸­ï¼Œæœªæ­£ç¡®åŒæ­¥å¯¼è‡´éƒ¨åˆ†åˆå§‹åŒ–å¯¹è±¡è¢«å…¶ä»–çº¿ç¨‹è®¿é—®ï¼ˆå¦‚åŒé‡æ£€æŸ¥é”å®šé—®é¢˜ï¼‰ã€‚</li><li><strong>ç¤ºä¾‹</strong>ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton instance;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton</span><span class="params">()</span> &#123;</span><br><span class="line">        value = <span class="number">42</span>; <span class="comment">// åˆå§‹åŒ–æ“ä½œå¯èƒ½è¢«é‡æ’åˆ°å¯¹è±¡å¼•ç”¨èµ‹å€¼ä¹‹å</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;                     <span class="comment">// ç¬¬ä¸€æ¬¡æ£€æŸ¥</span></span><br><span class="line">            <span class="keyword">synchronized</span> (Singleton.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;             <span class="comment">// ç¬¬äºŒæ¬¡æ£€æŸ¥</span></span><br><span class="line">                    instance = <span class="keyword">new</span> <span class="title class_">Singleton</span>();     <span class="comment">// å¯èƒ½é‡æ’ï¼šå…ˆåˆ†é…å†…å­˜ï¼Œååˆå§‹åŒ–å¯¹è±¡</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>é—®é¢˜</strong>ï¼š<br>å…¶ä»–çº¿ç¨‹å¯èƒ½è·å–åˆ° <code>instance</code> å¯¹è±¡ï¼Œä½†å…¶ <code>value</code> å­—æ®µå°šæœªåˆå§‹åŒ–ï¼ˆå€¼ä¸ºé»˜è®¤å€¼ 0ï¼‰ã€‚</li></ul><h4 id="3-æ„é€ å‡½æ•°ä¸­çš„-this-é€¸å‡º"><a href="#3-æ„é€ å‡½æ•°ä¸­çš„-this-é€¸å‡º" class="headerlink" title="3. æ„é€ å‡½æ•°ä¸­çš„ this é€¸å‡º"></a><strong>3. æ„é€ å‡½æ•°ä¸­çš„</strong> <code>this</code> <strong>é€¸å‡º</strong></h4><ul><li><strong>åœºæ™¯</strong>ï¼š<br>åœ¨æ„é€ å‡½æ•°ä¸­å°† <code>this</code> æš´éœ²ç»™å…¶ä»–çº¿ç¨‹ï¼ˆå¦‚æ³¨å†Œç›‘å¬å™¨ã€å¯åŠ¨çº¿ç¨‹ï¼‰ã€‚</li><li><strong>ç¤ºä¾‹</strong>ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">EventListener</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">EventListener</span><span class="params">(EventSource source)</span> &#123;</span><br><span class="line">        source.registerListener(() -&gt; System.out.println(id)); <span class="comment">// this é€¸å‡º</span></span><br><span class="line">        id = <span class="number">42</span>; <span class="comment">// å¯èƒ½è¢«é‡æ’åˆ°æ³¨å†Œç›‘å¬å™¨ä¹‹å</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>é—®é¢˜</strong>ï¼š<br><code>id</code> çš„èµ‹å€¼å¯èƒ½è¢«é‡æ’åˆ°ç›‘å¬å™¨æ³¨å†Œä¹‹åï¼Œå¯¼è‡´ç›‘å¬å™¨å›è°ƒæ—¶ <code>id</code> æœªè¢«æ­£ç¡®åˆå§‹åŒ–ã€‚</li></ul><h4 id="4-å¤åˆæ“ä½œï¼ˆéåŸå­æ€§æ“ä½œï¼‰"><a href="#4-å¤åˆæ“ä½œï¼ˆéåŸå­æ€§æ“ä½œï¼‰" class="headerlink" title="4. å¤åˆæ“ä½œï¼ˆéåŸå­æ€§æ“ä½œï¼‰"></a><strong>4. å¤åˆæ“ä½œï¼ˆéåŸå­æ€§æ“ä½œï¼‰</strong></h4><ul><li><strong>åœºæ™¯</strong>ï¼š<br>å¤šä¸ªå˜é‡çš„è¯»å†™æ“ä½œç»„åˆåœ¨ä¸€èµ·ï¼Œå› é‡æ’å¯¼è‡´é€»è¾‘é”™è¯¯ã€‚</li><li><strong>ç¤ºä¾‹</strong>ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// çº¿ç¨‹1</span></span><br><span class="line">x = <span class="number">1</span>;</span><br><span class="line">y = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// çº¿ç¨‹2</span></span><br><span class="line"><span class="keyword">if</span> (y == <span class="number">2</span>) &#123;</span><br><span class="line">    System.out.println(x); <span class="comment">// å¯èƒ½è¾“å‡º 0ï¼ˆx=1 æœªè¢«æ‰§è¡Œæˆ–ä¸å¯è§ï¼‰</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>é—®é¢˜</strong>ï¼š<br>çº¿ç¨‹1çš„ <code>x = 1</code> å’Œ <code>y = 2</code> å¯èƒ½è¢«é‡æ’ï¼Œå¯¼è‡´çº¿ç¨‹2çœ‹åˆ° <code>y=2</code> ä½† <code>x=0</code>ã€‚</li></ul><h4 id="5-æ•°ç»„å…ƒç´ çš„å†™å…¥"><a href="#5-æ•°ç»„å…ƒç´ çš„å†™å…¥" class="headerlink" title="5. æ•°ç»„å…ƒç´ çš„å†™å…¥"></a><strong>5. æ•°ç»„å…ƒç´ çš„å†™å…¥</strong></h4><ul><li><strong>åœºæ™¯</strong>ï¼š<br>å¤šçº¿ç¨‹è®¿é—®æ•°ç»„å…ƒç´ æ—¶ï¼Œå…ƒç´ çš„å€¼å’Œæ•°ç»„é•¿åº¦å¯èƒ½å› é‡æ’å¯¼è‡´ä¸ä¸€è‡´ã€‚</li><li><strong>ç¤ºä¾‹</strong>ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span>[] array = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">10</span>];</span><br><span class="line"><span class="type">boolean</span> <span class="variable">initialized</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// çº¿ç¨‹1</span></span><br><span class="line">array[<span class="number">0</span>] = <span class="number">42</span>;         <span class="comment">// å¯èƒ½è¢«é‡æ’åˆ° initialized=true ä¹‹å</span></span><br><span class="line">initialized = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// çº¿ç¨‹2</span></span><br><span class="line"><span class="keyword">if</span> (initialized) &#123;</span><br><span class="line">    System.out.println(array[<span class="number">0</span>]); <span class="comment">// å¯èƒ½è¾“å‡º 0ï¼ˆé»˜è®¤å€¼ï¼‰</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="äºŒã€ä¸ä¼šè¢«æŒ‡ä»¤é‡æ’çš„æ“ä½œ"><a href="#äºŒã€ä¸ä¼šè¢«æŒ‡ä»¤é‡æ’çš„æ“ä½œ" class="headerlink" title="äºŒã€ä¸ä¼šè¢«æŒ‡ä»¤é‡æ’çš„æ“ä½œ"></a><strong>äºŒã€ä¸ä¼šè¢«æŒ‡ä»¤é‡æ’çš„æ“ä½œ</strong></h3><h4 id="1-volatile-å˜é‡çš„è¯»å†™"><a href="#1-volatile-å˜é‡çš„è¯»å†™" class="headerlink" title="1. volatile å˜é‡çš„è¯»å†™"></a><strong>1.</strong> <code>volatile</code> <strong>å˜é‡çš„è¯»å†™</strong></h4><ul><li><p><strong>JMM ä¿è¯</strong>ï¼š<br><code>volatile</code> å˜é‡çš„è¯»å†™ä¼šæ’å…¥å†…å­˜å±éšœï¼Œç¦æ­¢é‡æ’ï¼š  </p></li><li><ul><li><strong>å†™å±éšœ</strong>ï¼šç¡®ä¿ <code>volatile</code> å†™ä¹‹å‰çš„æ“ä½œä¸ä¼šè¢«é‡æ’åˆ°å†™ä¹‹åã€‚  </li><li><strong>è¯»å±éšœ</strong>ï¼šç¡®ä¿ <code>volatile</code> è¯»ä¹‹åçš„æ“ä½œä¸ä¼šè¢«é‡æ’åˆ°è¯»ä¹‹å‰ã€‚</li></ul></li></ul><h4 id="2-synchronized-å—å†…çš„æ“ä½œ"><a href="#2-synchronized-å—å†…çš„æ“ä½œ" class="headerlink" title="2. synchronized å—å†…çš„æ“ä½œ"></a><strong>2.</strong> <code>synchronized</code> <strong>å—å†…çš„æ“ä½œ</strong></h4><ul><li><strong>é”æœºåˆ¶</strong>ï¼š<br>é”çš„è·å–å’Œé‡Šæ”¾ä¼šæ’å…¥å†…å­˜å±éšœï¼Œç¡®ä¿ä¸´ç•ŒåŒºå†…çš„æ“ä½œä¸ä¼šè¢«é‡æ’åˆ°é”å¤–ã€‚</li></ul><h4 id="3-final-å­—æ®µçš„åˆå§‹åŒ–"><a href="#3-final-å­—æ®µçš„åˆå§‹åŒ–" class="headerlink" title="3. final å­—æ®µçš„åˆå§‹åŒ–"></a><strong>3.</strong> <code>final</code> <strong>å­—æ®µçš„åˆå§‹åŒ–</strong></h4><ul><li><strong>JMM ä¿è¯</strong>ï¼š<br>åœ¨æ„é€ å‡½æ•°ä¸­æ­£ç¡®åˆå§‹åŒ–çš„ <code>final</code> å­—æ®µï¼Œå…¶èµ‹å€¼å¯¹å…¶ä»–çº¿ç¨‹å¯è§ï¼ˆç¦æ­¢é‡æ’åˆå§‹åŒ–æ“ä½œï¼‰ã€‚</li></ul><hr><h3 id="ä¸‰ã€è§£å†³æ–¹æ¡ˆ"><a href="#ä¸‰ã€è§£å†³æ–¹æ¡ˆ" class="headerlink" title="ä¸‰ã€è§£å†³æ–¹æ¡ˆ"></a><strong>ä¸‰ã€è§£å†³æ–¹æ¡ˆ</strong></h3><h4 id="1-ä½¿ç”¨-volatile-å…³é”®å­—"><a href="#1-ä½¿ç”¨-volatile-å…³é”®å­—" class="headerlink" title="1. ä½¿ç”¨ volatile å…³é”®å­—"></a><strong>1. ä½¿ç”¨</strong> <code>volatile</code> <strong>å…³é”®å­—</strong></h4><ul><li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šå•å˜é‡çŠ¶æ€æ ‡å¿—ã€ä¸€æ¬¡æ€§å‘å¸ƒå¯¹è±¡ã€‚</li><li><strong>ç¤ºä¾‹</strong>ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br></pre></td></tr></table></figure><h4 id="2-æ­£ç¡®åŒæ­¥ï¼ˆé”æœºåˆ¶ï¼‰"><a href="#2-æ­£ç¡®åŒæ­¥ï¼ˆé”æœºåˆ¶ï¼‰" class="headerlink" title="2. æ­£ç¡®åŒæ­¥ï¼ˆé”æœºåˆ¶ï¼‰"></a><strong>2. æ­£ç¡®åŒæ­¥ï¼ˆé”æœºåˆ¶ï¼‰</strong></h4><ul><li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šå¤åˆæ“ä½œæˆ–éœ€è¦å¼ºä¸€è‡´æ€§çš„å…±äº«èµ„æºã€‚</li><li><strong>ç¤ºä¾‹</strong>ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">    a = <span class="number">1</span>;</span><br><span class="line">    flag = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-å®‰å…¨å‘å¸ƒä¸å¯å˜å¯¹è±¡"><a href="#3-å®‰å…¨å‘å¸ƒä¸å¯å˜å¯¹è±¡" class="headerlink" title="3. å®‰å…¨å‘å¸ƒä¸å¯å˜å¯¹è±¡"></a><strong>3. å®‰å…¨å‘å¸ƒä¸å¯å˜å¯¹è±¡</strong></h4><ul><li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šå¯¹è±¡æ„é€ å®Œæˆåä¸å¯å˜ã€‚</li><li><strong>ç¤ºä¾‹</strong>ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ImmutableObject</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ImmutableObject</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = value; <span class="comment">// final å­—æ®µçš„èµ‹å€¼å¯¹å…¶ä»–çº¿ç¨‹å¯è§</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-ä½¿ç”¨çº¿ç¨‹å®‰å…¨å®¹å™¨"><a href="#4-ä½¿ç”¨çº¿ç¨‹å®‰å…¨å®¹å™¨" class="headerlink" title="4. ä½¿ç”¨çº¿ç¨‹å®‰å…¨å®¹å™¨"></a><strong>4. ä½¿ç”¨çº¿ç¨‹å®‰å…¨å®¹å™¨</strong></h4><ul><li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šæ•°ç»„æˆ–é›†åˆçš„å¤šçº¿ç¨‹è®¿é—®ã€‚</li><li><strong>ç¤ºä¾‹</strong>ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CopyOnWriteArrayList&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">CopyOnWriteArrayList</span>&lt;&gt;();</span><br></pre></td></tr></table></figure><hr><h3 id="å››ã€æ€»ç»“"><a href="#å››ã€æ€»ç»“" class="headerlink" title="å››ã€æ€»ç»“"></a><strong>å››ã€æ€»ç»“</strong></h3><table><thead><tr><th><strong>æ“ä½œ&#x2F;åœºæ™¯</strong></th><th><strong>å¯èƒ½è¢«é‡æ’</strong></th><th><strong>è§£å†³æ–¹æ¡ˆ</strong></th></tr></thead><tbody><tr><td>æ™®é€šå˜é‡èµ‹å€¼</td><td>âœ”ï¸</td><td><code>volatile</code> æˆ–åŒæ­¥æœºåˆ¶</td></tr><tr><td>éå®‰å…¨å‘å¸ƒçš„å¯¹è±¡åˆå§‹åŒ–</td><td>âœ”ï¸</td><td><code>volatile</code> + å®‰å…¨æ„é€ </td></tr><tr><td>æ„é€ å‡½æ•°ä¸­çš„ <code>this</code> é€¸å‡º</td><td>âœ”ï¸</td><td>é¿å… <code>this</code> é€¸å‡ºï¼Œç”¨ <code>final</code></td></tr><tr><td>å¤åˆæ“ä½œï¼ˆéåŸå­æ€§ï¼‰</td><td>âœ”ï¸</td><td>é”æˆ–åŸå­ç±»ï¼ˆå¦‚ <code>AtomicInteger</code>ï¼‰</td></tr><tr><td><code>volatile</code> å˜é‡è¯»å†™</td><td>âœ–ï¸</td><td>æ— éœ€é¢å¤–å¤„ç†</td></tr><tr><td><code>synchronized</code> å—å†…æ“ä½œ</td><td>âœ–ï¸</td><td>æ— éœ€é¢å¤–å¤„ç†</td></tr><tr><td><code>final</code> å­—æ®µåˆå§‹åŒ–</td><td>âœ–ï¸</td><td>æ­£ç¡®åˆå§‹åŒ– <code>final</code> å­—æ®µ</td></tr></tbody></table><p><strong>æ ¸å¿ƒåŸåˆ™</strong>ï¼š<br>åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œ<strong>å…±äº«å˜é‡çš„è®¿é—®å¿…é¡»é€šè¿‡åŒæ­¥æœºåˆ¶ï¼ˆ</strong><code>volatile</code><strong>ã€é”ã€åŸå­ç±»ç­‰ï¼‰ä¿è¯å¯è§æ€§å’Œæœ‰åºæ€§</strong>ï¼Œé¿å…æŒ‡ä»¤é‡æ’å¯¼è‡´é€»è¾‘é”™è¯¯ã€‚è€Œåœ¨å•çº¿ç¨‹æˆ–çº¿ç¨‹å°é—­åœºæ™¯ä¸‹ï¼Œæ— éœ€å…³æ³¨æŒ‡ä»¤é‡æ’ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Rediså­¦ä¹ ç¬”è®°</title>
      <link href="/2025/06/07/Redis%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
      <url>/2025/06/07/Redis%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<h1 id="Rediså­¦ä¹ ç¬”è®°"><a href="#Rediså­¦ä¹ ç¬”è®°" class="headerlink" title="Rediså­¦ä¹ ç¬”è®°"></a>Rediså­¦ä¹ ç¬”è®°</h1><p> Redisè¯ç”Ÿäº2009å¹´ï¼Œä½œä¸ºä¸€ä¸ªåŸºäºå†…å­˜çš„é”®å€¼å‹NoSQLæ•°æ®åº“ã€‚å…¶æœ‰å¦‚ä¸‹ç‰¹ç‚¹</p><ul><li>é”®å€¼ï¼ˆkey-valueï¼‰å‹ï¼Œvalueæ”¯æŒå¤šç§ä¸åŒæ•°æ®ç»“æ„ï¼Œ</li><li>å•çº¿ç¨‹ï¼Œæ¯ä¸ªå‘½ä»¤å…·æœ‰åŸå­æ€§ã€‚ä¸å­˜åœ¨å¾ˆå¤šå¹¶å‘å¸¦æ¥çš„é—®é¢˜ã€‚ä½†æ˜¯æ­¤å•çº¿ç¨‹åªæ˜¯æŒ‡ä»£å‘½ä»¤æ˜¯ä½†çº¿ç¨‹æ‰§è¡Œçš„ï¼Œå…¶ä»–æ¨¡å—è¿˜æœ‰å„è‡ªçš„çº¿ç¨‹ã€‚6.0ç‰ˆæœ¬ä¸­å¼•å…¥äº†å¤šçº¿ç¨‹ï¼Œä½†æŒ‡ä»£çš„æ˜¯ IOå¤šçº¿ç¨‹ï¼Œå¦‚ï¼šç½‘ç»œæ•°æ®çš„è¯»å†™å’Œåè®®è§£ææ—¶å¤šçº¿ç¨‹ã€‚</li><li>ä½å»¶è¿Ÿã€é€Ÿåº¦å¿«ï¼ˆåŸºäºå†…å­˜ã€IOå¤šè·¯å¤ç”¨ã€è‰¯å¥½çš„ç¼–ç ï¼‰</li><li>æ”¯æŒæ•°æ®æŒä¹…åŒ–</li><li>æ”¯æŒä¸»ä»é›†ç¾¤ã€åˆ†ç‰‡é›†ç¾¤</li><li>æ”¯æŒå¤šè¯­è¨€å®¢æˆ·ç«¯</li></ul><h2 id="ä¸€ã€Redis-çš„å®‰è£…"><a href="#ä¸€ã€Redis-çš„å®‰è£…" class="headerlink" title="ä¸€ã€Redis çš„å®‰è£…"></a>ä¸€ã€Redis çš„å®‰è£…</h2><h3 id="1-1-Redis-å®‰è£…ï¼ˆwindowï¼‰"><a href="#1-1-Redis-å®‰è£…ï¼ˆwindowï¼‰" class="headerlink" title="1.1 Redis å®‰è£…ï¼ˆwindowï¼‰"></a>1.1 Redis å®‰è£…ï¼ˆwindowï¼‰</h3><p>ä¸‹æ–¹æä¾› Redis å„ä¸ªç‰ˆæœ¬çš„ä¸‹è½½é¡µé¢ï¼Œæˆ‘è¿™é‡Œä¸‹è½½çš„æ˜¯ 3.2.100 ç‰ˆæœ¬ã€‚</p><p><a href="https://github.com/microsoftarchive/redis/releases">https://github.com/microsoftarchive/redis/releases</a></p><p>å°†ä¸‹è½½åŒ… è§£å‹åˆ°æœ¬åœ°ç›®å½•ï¼Œç„¶ååœ¨ redisç›®å½•ä¸‹è¿›è¡Œ cmd ï¼Œè¾“å…¥ä¸åŒçš„å‘½ä»¤è¿›è¡Œä¸åŒçš„å®‰è£…æ–¹å¼ï¼š</p><ul><li><p>ä¸´æ—¶æœåŠ¡å®‰è£…å¦‚æœä½ ä»…ä»…æ˜¯ç”¨ä½œå­¦ä¹ ä½¿ç”¨ï¼Œå¯ä»¥é€‰æ‹©æ­¤å®‰è£…æ–¹å¼ã€‚åœ¨ redisç›®å½•ä¸‹ ä½¿ç”¨cmd æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼šredis-server.exe  redis.windows.confè¯¥å‘½ä»¤ä¼šåˆ›å»º Redis ä¸´æ—¶æœåŠ¡ï¼Œç”Ÿæˆçš„ä¿¡æ¯è¡¨æ˜äº† redis åœ¨æœ¬æœºçš„ 6379 ç«¯å£æä¾›æœåŠ¡ã€‚è¯¥ç§æ–¹å¼ï¼Œä¸èƒ½å…³é—­æ­¤ cmd çª—å£ï¼Œå¦‚æœå…³é—­åˆ™ä¼šåœæ­¢ Redis æœåŠ¡ã€‚<img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779113128-ac60fad7-e10e-436c-af9d-67273d4e024e.png" alt="img">ä¿æŒ Redis æœåŠ¡çª—å£å¼€å¯çŠ¶æ€ï¼ŒåŒå‡» redisç›®å½•ä¸‹çš„ redis-cli.exe å³å¯ä½¿ç”¨ å‘½ä»¤è¡Œæ“æ§ redis ã€‚æ¯”å¦‚è¿™é‡Œ ä½¿ç”¨ set å‘½ä»¤ï¼Œå­˜å‚¨äº†ä¸€ä¸ªé”®å€¼å¯¹ uidï¼š1ï¼Œç„¶åé€šè¿‡ get å°†é”® uid å¯¹åº”çš„å€¼å–å‡ºã€‚<img src="https://cdn.nlark.com/yuque/0/2023/png/35838370/1682779113107-4136bd49-5e0e-45b0-b024-f5ac7d019f96.png" alt="img"></p></li><li><p>é»˜è®¤æœåŠ¡å®‰è£…è¿™ç§æ–¹å¼ä¸ç”¨åƒä¸´æ—¶å®‰è£…æ–¹å¼ä¸€æ ·ï¼Œæ¯æ¬¡å»æ‰“å¼€ redis ä¸´æ—¶æœåŠ¡ï¼Œè€Œä¸”åƒæ­£å¸¸æœåŠ¡ä¸€æ ·å¼€æœºè‡ªå¯ã€‚è¿›å…¥ Redis ç›®å½•ä¸‹ï¼Œé€šè¿‡cmdè¾“å…¥redis-server.exe â€“service-install redis.windows.conf â€“loglevel verbose<img src="https://cdn.nlark.com/yuque/0/2023/png/35838370/1682779113047-a2d84234-558c-4ca4-ae91-0564d9534dca.png" alt="img">é€šè¿‡å‘½ä»¤è¡Œå¯ä»¥å‘ç°ï¼Œæˆ‘ä»¬å·²ç»å°†redisä½œä¸ºæœåŠ¡å®‰è£…å¥½äº†ã€‚ä½†æ˜¯ä½ å¯èƒ½ä¸èƒ½åœ¨windowçš„æœåŠ¡åˆ—è¡¨ä¸­æ‰¾åˆ°ï¼ŒredisæœåŠ¡å¿…é¡»é€šè¿‡å‘½ä»¤è¡Œå¯åŠ¨ã€æš‚åœå’Œå¸è½½</p></li><li><ul><li>å¯åŠ¨æœåŠ¡ï¼šredis-server.exe â€“service-start</li><li>æš‚åœæœåŠ¡redis-server.exe â€“service-stop</li><li>å¸è½½æœåŠ¡redis-server.exe â€“service-uninstall</li></ul></li><li><p>è‡ªå®šä¹‰æœåŠ¡å®‰è£…è‡ªå®šä¹‰æœåŠ¡å®‰è£…ï¼Œå°±æ˜¯å°†æœåŠ¡é‡å‘½åã€‚è¿›å…¥ Redis å®‰è£…åŒ…ä¸‹ï¼Œè¾“å…¥redis-server.exe â€“service-install redis.windows.conf â€“Service-name RedisServer1 â€“loglevel verboseè¿™é‡Œèµ·çš„åå­—æ˜¯ RedisServer1 ã€‚ä¸é»˜è®¤å®‰è£…ä¸€æ ·ï¼Œä¸åŒçš„æ˜¯åœ¨å¯åŠ¨ã€æš‚åœã€å¸è½½æœåŠ¡æ—¶ éœ€è¦åŠ ä¸Šè‡ªå®šä¹‰çš„ Redis æœåŠ¡åredis-server.exe â€“service-start â€“Service-name RedisServer1redis-server.exe â€“service-stop â€“Service-name RedisServer1redis-server.exe â€“service-uninstall â€“Service-name RedisServer1</p></li><li><p>ä¸»ä»æœåŠ¡å®‰è£…å³åƒä¸€èˆ¬çš„æ•°æ®åº“çš„ä¸»ä»åº“ä¸€æ ·ï¼Œredisä¹Ÿå¯ä»¥é…ç½®ä¸»ä»åº“ã€‚é…ç½®çš„æ–¹æ³•å¾ˆç®€å•ï¼Œå°±æ˜¯é€šè¿‡<strong>è‡ªå®šä¹‰æœåŠ¡å™¨å®‰è£…</strong>æ–¹å¼å®‰è£…ä¸¤ä¸ªæœåŠ¡ã€‚<img src="https://cdn.nlark.com/yuque/0/2023/png/35838370/1682779111633-3351c423-c9db-4128-a4d6-3561b5e963a8.png" alt="img">ä¿®æ”¹ä¸¤ä¸ªæœåŠ¡é‡Œ redis.windows.conf æ–‡ä»¶ï¼šä¸»æœåŠ¡å™¨ï¼ˆRedisServer1ï¼‰ï¼šä¿æŒå…¶ port 6379ä»æœåŠ¡å™¨ï¼ˆRedisServer2ï¼‰ï¼šä¿®æ”¹</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">port 6380</span><br><span class="line"> slaveof 127.0.0.1 6379</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹é…ç½®æ–‡ä»¶åï¼Œä¾æ¬¡å¯åŠ¨æœåŠ¡ã€‚ç„¶åå¯ä»¥åœ¨ åŒå‡»ä¸»æœåŠ¡æ–‡ä»¶å¤¹ä¸‹çš„ redis-cliï¼Œå»æ‰§è¡Œä¸€ä¸ªæ·»åŠ é”®å€¼æ“ä½œã€‚åŒå‡»æ‰§è¡Œ ä»æœåŠ¡å™¨æ–‡ä»¶å¤¹ä¸‹çš„ redis-cliï¼Œå»å–å‡ºé”®name å¯¹åº”çš„å€¼ï¼Œä½ å°±å‘ç°å¯ä»¥å–åˆ°ã€‚åœ¨ Window ä¸Š ç›´æ¥åˆ é™¤æœåŠ¡çš„æ–¹æ³•ï¼šä½¿ç”¨ç®¡ç†å‘˜æƒé™ æ‰“å¼€ cmd ï¼Œç„¶åè¾“å…¥sc delete æœåŠ¡å</p><h3 id="1-2-Redis-å®‰è£…ï¼ˆdockerï¼‰"><a href="#1-2-Redis-å®‰è£…ï¼ˆdockerï¼‰" class="headerlink" title="1.2 Redis å®‰è£…ï¼ˆdockerï¼‰"></a>1.2 Redis å®‰è£…ï¼ˆdockerï¼‰</h3><ul><li>ä¸‹æ‹‰æœ€æ–°çš„ redis é•œåƒï¼Œå¹¶æ£€æŸ¥æ˜¯å¦ä¸‹æ‹‰æˆåŠŸ</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull redis:latest</span><br><span class="line">docker images</span><br></pre></td></tr></table></figure><ul><li>è¿è¡Œå®¹å™¨ï¼Œå¹¶æ˜ å°„åˆ°å®¿ä¸»æœºç«¯å£docker run -it -d â€“name redis-test -p 6379:6379 redis</li><li>æŸ¥çœ‹æ˜¯å¦è¿è¡ŒæˆåŠŸï¼ˆæŸ¥çœ‹å®¹å™¨è¿è¡Œä¿¡æ¯ï¼‰docker ps</li><li>é€šè¿‡ redis-cli è¿æ¥ä½¿ç”¨ redis æœåŠ¡</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it redis-test /bin/bash</span><br><span class="line">redis-cli</span><br></pre></td></tr></table></figure><h3 id="1-3-Redis-é…ç½®"><a href="#1-3-Redis-é…ç½®" class="headerlink" title="1.3 Redis é…ç½®"></a>1.3 Redis é…ç½®</h3><p>redis.config å¸¸è§é…ç½®ï¼š</p><ul><li>bind 0.0.0.0 ç›‘å¬çš„åœ°å€é»˜è®¤æ˜¯127.0.0.1ï¼Œè¿™ä½¿å¾—åªèƒ½æœ¬åœ°è®¿é—®ã€‚å¦‚æœä¿®æ”¹æˆ 0.0.0.0 åˆ™å¯ä»¥åœ¨ä»»æ„ IP åœ°å€è®¿é—®ã€‚</li><li>daemonize yeså®ˆæŠ¤è¿›ç¨‹ï¼Œä¿®æ”¹ä¸º yes ä¹‹åï¼Œå³å¯åå°è¿è¡Œ</li><li>requirepass 111111å¯†ç ï¼Œè®¾ç½®åè®¿é—® Redis å¿…é¡»è¾“å…¥å¯†ç </li><li>port 6379ç›‘å¬çš„ç«¯å£ï¼Œé»˜è®¤å°±æ˜¯ 6379</li><li>dir .å·¥ä½œç›®å½•ï¼Œé»˜è®¤æ˜¯å½“å‰ç›®å½•ï¼Œä¹Ÿå°±æ˜¯è¿è¡Œ redis-server æ—¶çš„å‘½ä»¤ï¼Œæ—¥å¿—ã€æŒä¹…åŒ–ç­‰æ–‡ä»¶éƒ½ä¼šä¿å­˜åœ¨è¿™ä¸ªç›®å½•</li><li>databases 1æ•°æ®åº“æ•°é‡ï¼Œè®¾ç½®ä¸º1ï¼Œä»£è¡¨åªä½¿ç”¨1ä¸ªåº“ï¼Œé»˜è®¤æœ‰16ä¸ªåº“ï¼Œç¼–å· 0-15</li><li>maxmemory 512mbè®¾ç½® redis èƒ½å¤Ÿä½¿ç”¨çš„æœ€å¤§å†…å­˜</li><li>logfile â€œredis.logâ€æ—¥å¿—æ–‡ä»¶ï¼Œé»˜è®¤ä¸ºç©ºï¼Œä¸è®°å½•æ—¥å¿—ï¼Œå¯ä»¥æŒ‡å®šæ—¥å¿—æ–‡ä»¶åã€‚</li></ul><p>å¯åŠ¨æ—¶ï¼ŒæŒ‡å®šé…ç½®æ–‡ä»¶ </p><p>redis-server redis.conf</p><h2 id="äºŒã€Redis-çš„åŸºç¡€ç¯‡"><a href="#äºŒã€Redis-çš„åŸºç¡€ç¯‡" class="headerlink" title="äºŒã€Redis çš„åŸºç¡€ç¯‡"></a>äºŒã€Redis çš„åŸºç¡€ç¯‡</h2><h4 id="2-1-äº”ç§åŸºæœ¬æ•°æ®ç»“æ„"><a href="#2-1-äº”ç§åŸºæœ¬æ•°æ®ç»“æ„" class="headerlink" title="2.1 äº”ç§åŸºæœ¬æ•°æ®ç»“æ„"></a>2.1 äº”ç§åŸºæœ¬æ•°æ®ç»“æ„</h4><p>Redis å…±æœ‰ 5 ç§åŸºæœ¬æ•°æ®ç»“æ„ï¼šStringï¼ˆå­—ç¬¦ä¸²ï¼‰ã€Listï¼ˆåˆ—è¡¨ï¼‰ã€Setï¼ˆé›†åˆï¼‰ã€Hashï¼ˆæ•£åˆ—ï¼‰ã€Zsetï¼ˆæœ‰åºé›†åˆï¼‰ã€‚</p><p>è¿™ 5 ç§æ•°æ®ç»“æ„æ˜¯ç›´æ¥æä¾›ç»™ç”¨æˆ·ä½¿ç”¨çš„ï¼Œæ˜¯æ•°æ®çš„ä¿å­˜å½¢å¼ï¼Œå…¶åº•å±‚å®ç°ä¸»è¦ä¾èµ–è¿™ 8 ç§æ•°æ®ç»“æ„ï¼šç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰ã€LinkedListï¼ˆåŒå‘é“¾è¡¨ï¼‰ã€Hash Tableï¼ˆå“ˆå¸Œè¡¨ï¼‰ã€SkipListï¼ˆè·³è·ƒè¡¨ï¼‰ã€Intsetï¼ˆæ•´æ•°é›†åˆï¼‰ã€ZipListï¼ˆå‹ç¼©åˆ—è¡¨ï¼‰ã€QuickListï¼ˆå¿«é€Ÿåˆ—è¡¨ï¼‰ã€‚</p><p>Redis åŸºæœ¬æ•°æ®ç»“æ„çš„åº•å±‚æ•°æ®ç»“æ„å®ç°å¦‚ä¸‹ï¼š</p><table><thead><tr><th>String</th><th>List</th><th>Hash</th><th>Set</th><th>Zset</th></tr></thead><tbody><tr><td>SDS</td><td>LinkedList&#x2F;ZipList&#x2F;QuickList</td><td>Hash Tableã€ZipList</td><td>ZipListã€Intset</td><td>ZipListã€SkipList</td></tr></tbody></table><p>Redis 3.2 ä¹‹å‰ï¼ŒList åº•å±‚å®ç°æ˜¯ LinkedList æˆ–è€… ZipListã€‚ Redis 3.2 ä¹‹åï¼Œå¼•å…¥äº† LinkedList å’Œ ZipList çš„ç»“åˆ QuickListï¼ŒList çš„åº•å±‚å®ç°å˜ä¸º QuickListã€‚</p><p>ä½ å¯ä»¥åœ¨ Redis å®˜ç½‘ä¸Šæ‰¾åˆ° Redis æ•°æ®ç»“æ„éå¸¸è¯¦ç»†çš„ä»‹ç»ï¼š</p><ul><li><a href="https://redis.com/redis-enterprise/data-structures/">Redis Data Structuresopen in new window</a></li><li><a href="https://redis.io/docs/manual/data-types/data-types-tutorial/">Redis Data types tutorialopen in new window</a></li></ul><p>æœªæ¥éšç€ Redis æ–°ç‰ˆæœ¬çš„å‘å¸ƒï¼Œå¯èƒ½ä¼šæœ‰æ–°çš„æ•°æ®ç»“æ„å‡ºç°ï¼Œé€šè¿‡æŸ¥é˜… Redis å®˜ç½‘å¯¹åº”çš„ä»‹ç»ï¼Œä½ æ€»èƒ½è·å–åˆ°æœ€é è°±çš„ä¿¡æ¯ã€‚</p><h5 id="2-1-1-String"><a href="#2-1-1-String" class="headerlink" title="2.1.1 String"></a>2.1.1 String</h5><p>String æ˜¯ Redis ä¸­æœ€ç®€å•åŒæ—¶ä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„ä¸€ä¸ªæ•°æ®ç»“æ„ã€‚</p><p>String æ˜¯ä¸€ç§äºŒè¿›åˆ¶å®‰å…¨çš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥ç”¨æ¥å­˜å‚¨ä»»ä½•ç±»å‹çš„æ•°æ®æ¯”å¦‚å­—ç¬¦ä¸²ã€æ•´æ•°ã€æµ®ç‚¹æ•°ã€å›¾ç‰‡ï¼ˆå›¾ç‰‡çš„ base64 ç¼–ç æˆ–è€…è§£ç æˆ–è€…å›¾ç‰‡çš„è·¯å¾„ï¼‰ã€åºåˆ—åŒ–åçš„å¯¹è±¡ã€‚</p><p> è™½ç„¶ Redis æ˜¯ç”¨ C è¯­è¨€å†™çš„ï¼Œä½†æ˜¯ Redis å¹¶æ²¡æœ‰ä½¿ç”¨ C çš„å­—ç¬¦ä¸²è¡¨ç¤ºï¼Œè€Œæ˜¯è‡ªå·±æ„å»ºäº†ä¸€ç§ <strong>ç®€å•åŠ¨æ€å­—ç¬¦ä¸²</strong>ï¼ˆSimple Dynamic Stringï¼Œ<strong>SDS</strong>ï¼‰ã€‚ç›¸æ¯”äº C çš„åŸç”Ÿå­—ç¬¦ä¸²ï¼ŒRedis çš„ SDS ä¸å…‰å¯ä»¥ä¿å­˜æ–‡æœ¬æ•°æ®è¿˜å¯ä»¥ä¿å­˜äºŒè¿›åˆ¶æ•°æ®ï¼Œå¹¶ä¸”è·å–å­—ç¬¦ä¸²é•¿åº¦å¤æ‚åº¦ä¸º O(1)ï¼ˆC å­—ç¬¦ä¸²ä¸º O(N)ï¼‰,é™¤æ­¤ä¹‹å¤–ï¼ŒRedis çš„ SDS API æ˜¯å®‰å…¨çš„ï¼Œä¸ä¼šé€ æˆç¼“å†²åŒºæº¢å‡ºã€‚</p><h5 id="2-1-2-List"><a href="#2-1-2-List" class="headerlink" title="2.1.2 List"></a>2.1.2 List</h5><p> è®¸å¤šé«˜çº§ç¼–ç¨‹è¯­è¨€éƒ½å†…ç½®äº†é“¾è¡¨çš„å®ç°æ¯”å¦‚ Java ä¸­çš„ LinkedListï¼Œä½†æ˜¯ C è¯­è¨€å¹¶æ²¡æœ‰å®ç°é“¾è¡¨ï¼Œæ‰€ä»¥ Redis å®ç°äº†è‡ªå·±çš„é“¾è¡¨æ•°æ®ç»“æ„ã€‚Redis çš„ List çš„å®ç°ä¸ºä¸€ä¸ª <strong>åŒå‘é“¾è¡¨</strong>ï¼Œå³å¯ä»¥æ”¯æŒåå‘æŸ¥æ‰¾å’Œéå†ï¼Œæ›´æ–¹ä¾¿æ“ä½œï¼Œä¸è¿‡å¸¦æ¥äº†éƒ¨åˆ†é¢å¤–çš„å†…å­˜å¼€é”€ã€‚</p><h5 id="2-1-3-Hash"><a href="#2-1-3-Hash" class="headerlink" title="2.1.3 Hash"></a>2.1.3 Hash</h5><p>Redis ä¸­çš„ Hash æ˜¯ä¸€ä¸ª String ç±»å‹çš„ field-valueï¼ˆé”®å€¼å¯¹ï¼‰ çš„æ˜ å°„è¡¨ï¼Œç‰¹åˆ«é€‚åˆç”¨äºå­˜å‚¨å¯¹è±¡ï¼Œåç»­æ“ä½œçš„æ—¶å€™ï¼Œä½ å¯ä»¥ç›´æ¥ä¿®æ”¹è¿™ä¸ªå¯¹è±¡ä¸­çš„æŸäº›å­—æ®µçš„å€¼ã€‚</p><p>Hash ç±»ä¼¼äº JDK1.8 å‰çš„ HashMapï¼Œå†…éƒ¨å®ç°ä¹Ÿå·®ä¸å¤š(æ•°ç»„ + é“¾è¡¨)ã€‚ä¸è¿‡ï¼ŒRedis çš„ Hash åšäº†æ›´å¤šä¼˜åŒ–ã€‚</p><h5 id="2-1-4-Set"><a href="#2-1-4-Set" class="headerlink" title="2.1.4 Set"></a>2.1.4 Set</h5><p>Redis ä¸­çš„ Set ç±»å‹æ˜¯ä¸€ç§æ— åºé›†åˆï¼Œé›†åˆä¸­çš„å…ƒç´ æ²¡æœ‰å…ˆåé¡ºåºä½†éƒ½å”¯ä¸€ï¼Œæœ‰ç‚¹ç±»ä¼¼äº Java ä¸­çš„ HashSet ã€‚å½“ä½ éœ€è¦å­˜å‚¨ä¸€ä¸ªåˆ—è¡¨æ•°æ®ï¼Œåˆä¸å¸Œæœ›å‡ºç°é‡å¤æ•°æ®æ—¶ï¼ŒSet æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ï¼Œå¹¶ä¸” Set æä¾›äº†åˆ¤æ–­æŸä¸ªå…ƒç´ æ˜¯å¦åœ¨ä¸€ä¸ª Set é›†åˆå†…çš„é‡è¦æ¥å£ï¼Œè¿™ä¸ªä¹Ÿæ˜¯ List æ‰€ä¸èƒ½æä¾›çš„ã€‚</p><p>ä½ å¯ä»¥åŸºäº Set è½»æ˜“å®ç°äº¤é›†ã€å¹¶é›†ã€å·®é›†çš„æ“ä½œï¼Œæ¯”å¦‚ä½ å¯ä»¥å°†ä¸€ä¸ªç”¨æˆ·æ‰€æœ‰çš„å…³æ³¨äººå­˜åœ¨ä¸€ä¸ªé›†åˆä¸­ï¼Œå°†å…¶æ‰€æœ‰ç²‰ä¸å­˜åœ¨ä¸€ä¸ªé›†åˆã€‚è¿™æ ·çš„è¯ï¼ŒSet å¯ä»¥éå¸¸æ–¹ä¾¿çš„å®ç°å¦‚å…±åŒå…³æ³¨ã€å…±åŒç²‰ä¸ã€å…±åŒå–œå¥½ç­‰åŠŸèƒ½ã€‚è¿™ä¸ªè¿‡ç¨‹ä¹Ÿå°±æ˜¯æ±‚äº¤é›†çš„è¿‡ç¨‹ã€‚</p><h4 id="2-1-5-SortSet"><a href="#2-1-5-SortSet" class="headerlink" title="2.1.5 SortSet"></a>2.1.5 SortSet</h4><p>Sorted Set ç±»ä¼¼äº Setï¼Œä½†å’Œ Set ç›¸æ¯”ï¼ŒSorted Set å¢åŠ äº†ä¸€ä¸ªæƒé‡å‚æ•° scoreï¼Œä½¿å¾—é›†åˆä¸­çš„å…ƒç´ èƒ½å¤ŸæŒ‰ score è¿›è¡Œæœ‰åºæ’åˆ—ï¼Œè¿˜å¯ä»¥é€šè¿‡ score çš„èŒƒå›´æ¥è·å–å…ƒç´ çš„åˆ—è¡¨ã€‚æœ‰ç‚¹åƒæ˜¯ Java ä¸­ HashMap å’Œ TreeSet çš„ç»“åˆä½“ã€‚</p><h4 id="2-2-ä¸‰ç§ç‰¹æ®Šæ•°æ®ç»“æ„"><a href="#2-2-ä¸‰ç§ç‰¹æ®Šæ•°æ®ç»“æ„" class="headerlink" title="2.2 ä¸‰ç§ç‰¹æ®Šæ•°æ®ç»“æ„"></a>2.2 ä¸‰ç§ç‰¹æ®Šæ•°æ®ç»“æ„</h4><h4 id="2-3-Rediså‘½ä»¤"><a href="#2-3-Rediså‘½ä»¤" class="headerlink" title="2.3 Rediså‘½ä»¤"></a>2.3 Rediså‘½ä»¤</h4><h5 id="2-1-1-é€šç”¨å‘½ä»¤"><a href="#2-1-1-é€šç”¨å‘½ä»¤" class="headerlink" title="2.1.1 é€šç”¨å‘½ä»¤"></a>2.1.1 é€šç”¨å‘½ä»¤</h5><p>Redisé€šç”¨æŒ‡ä»¤æ˜¯ä¸åˆ†æ•°æ®ç±»å‹çš„ï¼Œéƒ½å¯ä»¥ä½¿ç”¨çš„æŒ‡ä»¤ï¼Œå¸¸è§çš„æœ‰ï¼š</p><ul><li>KEYSï¼šæŸ¥çœ‹ç¬¦åˆæ¨¡æ¿çš„æ‰€æœ‰ keyï¼Œä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒè®¾å¤‡ä¸Šä½¿ç”¨</li><li>DELï¼šåˆ é™¤ä¸€ä¸ªæŒ‡å®šçš„ key</li><li>EXISTSï¼šåˆ¤æ–­ key æ˜¯å¦å­˜åœ¨</li><li>EXPIREï¼šç»™ä¸€ä¸ª key è®¾ç½®æœ‰æ•ˆæœŸï¼Œæœ‰æ•ˆæœŸåˆ°æœŸæ—¶è¯¥ key è‡ªåŠ¨åˆ é™¤ã€‚å¯ é€šè¿‡ TTL KeyNameï¼ŒæŸ¥çœ‹ key çš„å‰©ä½™æœ‰æ•ˆæœŸ</li></ul><p>é€šè¿‡ help [command] å¯ä»¥æŸ¥çœ‹ä¸€ä¸ªå‘½ä»¤çš„å…·ä½“ç”¨æ³•ã€</p><p>ä½¿ç”¨ redis.cli.exe æ‰“å¼€ redisçš„å‘½ä»¤è¡Œï¼Œå®æ“ï¼š</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/35838370/1682779112046-b5cf96d3-7890-4471-a0ce-0c02c4c4d789.png" alt="img"></p><h5 id="2-1-2-Stringç±»å‹"><a href="#2-1-2-Stringç±»å‹" class="headerlink" title="2.1.2 Stringç±»å‹"></a>2.1.2 Stringç±»å‹</h5><p>String ç±»å‹ï¼Œä¹Ÿå°±æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œæ˜¯ Redis ä¸­æœ€ç®€å•çš„å­˜å‚¨ç±»å‹ã€‚å…¶ value æ˜¯å­—ç¬¦ä¸²ï¼Œä¸è¿‡æ ¹æ®å­—ç¬¦ä¸²çš„æ ¼å¼ä¸åŒï¼Œåˆå¯ä»¥åˆ†ä¸º3ç±»:</p><ul><li>Stringï¼šæ™®é€šå­—ç¬¦ä¸²</li><li>intï¼šæ•´æ•°ç±»å‹ï¼Œå¯ä»¥åšè‡ªå¢ã€è‡ªå‡æ“ä½œ</li><li>floatï¼šæµ®ç‚¹ç±»å‹ï¼Œå¯ä»¥åšè‡ªå¢ã€è‡ªå‡æ“ä½œï¼Œä½†æ˜¯å¿…é¡»æŒ‡å®š å¢å‡çš„ å€¼ã€‚</li></ul><p>ä¸ç®¡ä½•ç§æ ¼å¼ï¼Œåº•å±‚éƒ½æ˜¯å­—èŠ‚æ•°ç»„å½¢å¼å­˜å‚¨ï¼Œåªä¸è¿‡æ˜¯ç¼–ç æ–¹å¼ä¸åŒã€‚</p><p>Redisçš„å­—ç¬¦ä¸²æ˜¯åŠ¨æ€å­—ç¬¦ä¸²ï¼Œæ˜¯å¯ä»¥ä¿®æ”¹çš„å­—ç¬¦ä¸²ï¼Œå†…éƒ¨ç»“æ„å®ç°ç±»ä¼¼äºJavaçš„ArrayListï¼Œé¢„åˆ†é…å†—ä½™ç©ºé—´çš„æ–¹å¼æ¥å‡å°‘å†…å­˜çš„é¢‘ç¹åˆ†é…ã€‚å­—ç¬¦ä¸²é•¿åº¦å°äº1Mï¼Œæ‰©å®¹éƒ½æ˜¯åŠ å€ç°æœ‰ç©ºé—´ï¼Œå¦‚æœé•¿åº¦å¤§äº1Mï¼Œæ¯æ¬¡æ‰©å®¹å¢åŠ 1Mã€‚å­—ç¬¦ä¸²ç±»å‹çš„æœ€å¤§ç©ºé—´ä¸èƒ½è¶…è¿‡ 512M</p><p>Stringçš„å¸¸è§å‘½ä»¤æœ‰ï¼š</p><ul><li>SETï¼šæ·»åŠ æˆ–è€…ä¿®æ”¹ å·²ç»å­˜åœ¨çš„ä¸€ä¸ª String ç±»å‹çš„é”®å€¼å¯¹</li><li>GETï¼šæ ¹æ® key è·å– String ç±»å‹çš„ value</li><li>MSETï¼šæ‰¹é‡æ·»åŠ å¤šä¸ª String ç±»å‹çš„é”®å€¼å¯¹</li><li>MGETï¼šæ ¹æ®å¤šä¸ª key è·å–å¤šä¸ª String ç±»å‹çš„ value</li><li>INCRï¼šè®©ä¸€ä¸ªæ•´å‹çš„ key è‡ªå¢ 1 </li><li>INCRBYï¼šè®©ä¸€ä¸ªæ•´å‹çš„ key è‡ªå¢å¹¶æŒ‡å®šæ­¥é•¿ï¼Œä¾‹å¦‚ï¼šINCRBY num 2ï¼Œå³å¯è®© key &#x3D; num çš„å€¼ï¼Œè‡ªå¢2</li><li>SETNXï¼šæ·»åŠ ä¸€ä¸ª String ç±»å‹çš„é”®å€¼å¯¹ï¼Œå‰ææ˜¯ è¿™ä¸ª key ä¸å­˜åœ¨ï¼Œå¦åˆ™ä¸æ‰§è¡Œ</li><li>SETEXï¼šæ·»åŠ ä¸€ä¸ªString ç±»å‹çš„é”®å€¼å¯¹ï¼Œå¹¶æŒ‡å®šæœ‰æ•ˆæœŸ</li></ul><h5 id="2-1-3-Keyçš„å±‚çº§æ ¼å¼"><a href="#2-1-3-Keyçš„å±‚çº§æ ¼å¼" class="headerlink" title="2.1.3 Keyçš„å±‚çº§æ ¼å¼"></a>2.1.3 Keyçš„å±‚çº§æ ¼å¼</h5><p>Redisæ²¡æœ‰ç±»ä¼¼ MySQL ä¸­çš„ Table çš„æ¦‚å¿µï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•åŒºåˆ†ä¸åŒç±»å‹çš„ key å‘¢ï¼Ÿä¸€èˆ¬é‡‡ç”¨å°† key åç§°è¿›è¡Œ åˆ†å±‚è®¾è®¡ã€‚ä¾‹å¦‚ï¼šå­¦ç”Ÿçš„keyï¼Œkey ä»¥ studen_ å¼€å¤´ã€‚</p><p>Redis çš„ key å…è®¸æœ‰å¤šä¸ªå•è¯ç»„æˆå±‚çº§ç»“æ„ï¼Œå¤šä¸ªå•è¯ä¹‹é—´ç”¨ â€œ:â€ éš”å¼€ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š</p><p>é¡¹ç›®å:ä¸šåŠ¡å:ç±»å‹:id</p><p>å½“ç„¶è¿™ç§æ ¼å¼æ˜¯å¯ä»¥è‡ªå·±å®šä¹‰çš„ï¼Œæœ‰äº›å…¬å¸æ˜¯ä½¿ç”¨ â€__â€œçº¿é—´éš”ã€‚</p><p>å¦‚æœå­˜å‚¨å¯¹è±¡æ˜¯ Javaå¯¹è±¡ï¼Œåˆ™å¯å°†å¯¹è±¡è½¬åŒ–ä¸º JSON å­—ç¬¦ä¸²å½“ä½œvalueå­˜å‚¨ä¸‹æ¥ã€‚</p><h5 id="2-1-4-Hashç±»å‹"><a href="#2-1-4-Hashç±»å‹" class="headerlink" title="2.1.4 Hashç±»å‹"></a>2.1.4 Hashç±»å‹</h5><p>Hashç±»å‹ï¼Œä¹Ÿå«æ•£åˆ—ï¼Œå…¶ä¸­valueæ˜¯ä¸€ä¸ªæ— åºå­—å…¸ï¼Œç±»å‹äº Java ä¸­çš„ HashMap ç»“æ„</p><p>String ç»“æ„æ˜¯å°†å¯¹è±¡åºåˆ—åŒ–ä¸º JSON å­—ç¬¦ä¸²å å­˜å‚¨ï¼Œå½“éœ€è¦ä¿®æ”¹å¯¹è±¡æŸä¸ªå­—æ®µæ—¶ å¾ˆä¸æ–¹ä¾¿ã€‚Hash ç»“æ„å¯ä»¥å°†å¯¹è±¡ä¸­çš„æ¯ä¸ªå­—æ®µç‹¬ç«‹å­˜å‚¨ï¼Œå¯ä»¥é’ˆå¯¹ å•ä¸ªå­—æ®µ CRUD</p><p>Hashç±»å‹å¸¸è§å‘½ä»¤æœ‰ï¼š</p><ul><li>HSET key field valueï¼šæ·»åŠ æˆ–è€…ä¿®æ”¹ hashç±»å‹ keyçš„field çš„å€¼</li><li>HGET key fieldï¼šè·å–ä¸€ä¸ª hash ç±»å‹ keyçš„fieldçš„å€¼</li><li>HMSETï¼šæ‰¹é‡æ·»åŠ  å¤šä¸ª hashç±»å‹ keyçš„field çš„å€¼HMSET student_1 name liming sex ç”·   &#x2F;&#x2F;ä¸ºkey&#x3D;student_1 çš„å­—æ®µ æ·»åŠ å±æ€§ nameã€sex å€¼åˆ†åˆ«ä¸º limingã€ç”·</li><li>HGETALLï¼šè·å–ä¸€ä¸ª hash ç±»å‹çš„keyä¸­æ‰€æœ‰çš„ fieldå’Œvalue</li><li>HKEYSï¼šè·å–ä¸€ä¸ª hash ç±»å‹çš„keyä¸­æ‰€æœ‰çš„ field</li><li>HVALSï¼šè·å–ä¸€ä¸ªhash ç±»å‹çš„keyä¸­æ‰€æœ‰çš„ value</li><li>HINCRBYï¼šè®©ä¸€ä¸ªhashç±»å‹ key çš„å­—æ®µå€¼è‡ªå¢ï¼Œå¹¶æŒ‡å®šæ­¥é•¿</li><li>HSETNXï¼šæ·»åŠ ä¸€ä¸ª hash ç±»å‹çš„ key çš„ fieldå€¼ï¼Œå‰ææ—¶ è¿™ä¸ª field ä¸å­˜åœ¨ï¼Œå¦åˆ™ä¸æ‰§è¡Œ</li></ul><p>åº•å±‚åŸç†ï¼š</p><p>Javaçš„HashMapåœ¨å­—å…¸å¾ˆå¤§æ—¶ï¼Œrehashæ˜¯ä¸ªè€—æ—¶æ“ä½œï¼Œéœ€è¦ä¸€æ¬¡æ€§å…¨éƒ¨rehashã€‚Redisä¸ºäº†é«˜æ€§èƒ½ï¼Œä¸èƒ½å µå¡æœåŠ¡ï¼Œå°±é‡‡ç”¨äº†æ¸è¿›å¼rehashç­–ç•¥</p><p>æ¸è¿›å¼rehashï¼šåœ¨rehashçš„åŒæ—¶ï¼Œä¿ç•™æ–°æ—§ä¸¤ä¸ªhashç»“æ„ï¼ŒæŸ¥è¯¢æ—¶ä¼šåŒæ—¶æŸ¥è¯¢ä¸¤ä¸ªhashç»“æ„ï¼Œç„¶åå†åç»­çš„å®šæ—¶ä»»åŠ¡ä¸­ä»¥åŠhashçš„å­æŒ‡ä»¤ä¸­ï¼Œå¾ªåºæ¸è¿›åœ°å°†æ—§hashçš„å†…å®¹ä¸€ç‚¹ç‚¹è¿ç§»åˆ°æ–°çš„hashç»“æ„ä¸­ã€‚</p><h5 id="2-1-4-Listç±»å‹"><a href="#2-1-4-Listç±»å‹" class="headerlink" title="2.1.4 Listç±»å‹"></a>2.1.4 Listç±»å‹</h5><p>Redisä¸­çš„ List ç±»å‹ä¸ Java ä¸­çš„LinkedList ç±»ä¼¼ï¼Œå¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ç»“æ„ã€‚æ—¢å¯ä»¥æ”¯æŒæ­£å‘æ£€ç´¢ï¼Œä¹Ÿæ”¯æŒåå‘æ£€ç´¢ã€‚ç‰¹ç‚¹ä¹Ÿå’ŒLinkedListç±»ä¼¼ï¼š</p><ul><li>æœ‰åº</li><li>å…ƒç´ å¯ä»¥é‡å¤</li><li>æ’å…¥å’Œåˆ é™¤å¿«</li><li>æŸ¥è¯¢é€Ÿåº¦ä¸€èˆ¬</li></ul><p>Listçš„å¸¸è§å‘½ä»¤ï¼š</p><ul><li>LPUSH key element ï¼šåƒåˆ—è¡¨å·¦ä¾§æ’å…¥ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ </li><li>LPOP key ï¼šç§»é™¤å¹¶è¿”å›åˆ—è¡¨å·¦ä¾§çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œæ²¡æœ‰åˆ™è¿”å›nil</li><li>RPUSH key elementï¼šå‘åˆ—è¡¨å³ä¾§æ’å…¥ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ </li><li>RPOP keyï¼šç§»é™¤å¹¶è¿”å›åˆ—è¡¨å³ä¾§ç¬¬ä¸€ä¸ªå…ƒç´ </li><li>LRANGE key start endï¼šè¿”å›ä¸€æ®µè§’æ ‡èŒƒå›´å†…çš„æ‰€æœ‰å…ƒç´ </li><li>BLPOPå’ŒBRPOPï¼šä¸LPOPã€RPOPç±»ä¼¼ï¼Œåªä¸è¿‡åœ¨æ²¡æœ‰å…ƒç´ æ—¶ç­‰å¾…æŒ‡å®šæ—¶é—´ï¼Œè€Œä¸æ˜¯ç›´æ¥è¿”å›nil</li><li>lindex key indexï¼šlindex ç›¸å½“äº Java é“¾è¡¨çš„ get(index) æ–¹æ³•ï¼Œå®ƒéœ€è¦å¯¹é“¾è¡¨è¿›è¡Œéå†ã€‚å…¶æ€§èƒ½éšç€å‚æ•°indexå¢å¤§è€Œå˜å·®ã€‚</li><li>ltrim key startIndex endIndexï¼šä½¿ç”¨startIndex ã€endIndexå®šä¹‰äº†ä¸€ä¸ªåŒºé—´ï¼Œä¿ç•™ç€åŒºé—´å†…çš„å€¼ï¼ŒåŒºé—´å¤–ç»Ÿç»Ÿå»é™¤ã€‚è¿™æ ·å¯ä»¥å®ç°ä¸€ä¸ªå®šé•¿çš„é“¾è¡¨ã€‚indexå¯ä»¥ä¸ºè´Ÿæ•°ï¼Œ-1è¡¨ç¤ºå€’æ•°ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œ-2è¡¨ç¤ºå€’æ•°ç¬¬äºŒä¸ªå…ƒç´ ã€‚</li></ul><p>åº”ç”¨åœºæ™¯ï¼šå¸¸ç”¨æ¥åšå¼‚æ­¥é˜Ÿåˆ—ä½¿ç”¨ã€‚å°†éœ€è¦å»¶åå¤„ç†çš„ä»»åŠ¡ç»“æ„ä½“åºåˆ—åŒ–æˆå­—ç¬¦ä¸²å¡è¿›Redisçš„åˆ—è¡¨ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ä»è¿™ä¸ªåˆ—è¡¨ä¸­è½®è¯¢æ•°æ®è¿›è¡Œå¤„ç†ã€‚é€šè¿‡æ§åˆ¶ï¼Œå³è¾¹è¿›å·¦è¾¹å‡ºï¼Œå¯ä»¥å®ç°é˜Ÿåˆ—ã€‚é€šè¿‡æ§åˆ¶ï¼Œå³è¾¹è¿›å³è¾¹å‡ºï¼Œå¯ä»¥å®ç°æ ˆã€‚</p><p>åŸç†ï¼šRedisåˆ—è¡¨åº•å±‚å­˜å‚¨ä¸æ˜¯ä¸€ä¸ªç®€å•çš„ linkedlistï¼Œè€Œæ˜¯æˆä¸ºå¿«é€Ÿåˆ—è¡¨quicklistçš„ä¸€ä¸ªç»“æ„ã€‚é¦–å…ˆåœ¨åˆ—è¡¨å…ƒç´ è¾ƒå°‘çš„æƒ…å†µä¸‹ä¼šä½¿ç”¨ä¸€å—è¿ç»­çš„å†…å­˜å­˜å‚¨ï¼Œè¿™ä¸ªç»“æ„æ˜¯å‹ç¼©åˆ—è¡¨ziplistã€‚å®ƒå°†æ‰€æœ‰çš„å…ƒç´ ç´§ç´§æŒ¨åœ¨ä¸€èµ·å­˜å‚¨ï¼Œåˆ†é…çš„æ˜¯ä¸€å—è¿ç»­çš„å†…å­˜ã€‚å½“æ•°æ®é‡æ¯”è¾ƒå¤šæ—¶ï¼Œæ‰ä¼šæ”¹æˆ quicklistã€‚å› ä¸ºæ™®é€šçš„é“¾è¡¨éœ€è¦çš„é™„ä»¶æŒ‡é’ˆç©ºé—´å¤ªå¤§ï¼Œä¼šæ¯”è¾ƒæµªè´¹ç©ºé—´ï¼Œè€Œä¸”åŠ é‡å†…å­˜çš„ç¢ç‰‡åŒ–ã€‚æ‰€ä»¥Rediså°† å¤šä¸ª ziplistä½¿ç”¨åŒå‘æŒ‡é’ˆä¸²èµ·æ¥ä½¿ç”¨ã€‚è¿™æ ·æ—¢æ»¡è¶³äº†å¿«é€Ÿçš„æ’å…¥åˆ é™¤æ€§èƒ½ï¼Œæœ‰ä¸ä¼šå‡ºç°å¤ªå¤§çš„ç©ºé—´å†—ä½™ã€‚</p><h5 id="2-1-5-Setç±»å‹"><a href="#2-1-5-Setç±»å‹" class="headerlink" title="2.1.5 Setç±»å‹"></a>2.1.5 Setç±»å‹</h5><p>Redisçš„Setç»“æ„ä¸ Java ä¸­çš„HashSetç±»ä¼¼ï¼Œå¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ª value ä¸º null çš„ HashMapã€‚å› ä¸ºä¹Ÿæ˜¯ä¸€ä¸ª hash è¡¨ï¼Œå› æ­¤å…·å¤‡ä¸ HashSetç±»ä¼¼çš„ç‰¹å¾</p><ul><li>æ— åº</li><li>å…ƒç´ ä¸å¯é‡å¤</li><li>æŸ¥æ‰¾å¿«</li><li>æ”¯æŒäº¤é›†ã€å¹¶é›†ã€å·®é›†ç­‰åŠŸèƒ½</li></ul><p>Setå¸¸è§å‘½ä»¤ï¼š</p><ul><li>SADD key memberï¼šå‘setä¸­æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ </li><li>SREM key memberï¼šç§»é™¤setä¸­æŒ‡å®šçš„å…ƒç´ </li><li>SCARD keyï¼šè¿”å›setä¸­å…ƒç´ çš„ä¸ªæ•°</li><li>SISMEMBER key memberï¼šåˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨äº set ä¸­</li><li>SMEMBERSï¼šè·å– set ä¸­çš„æ‰€æœ‰å…ƒç´ </li><li>SINTER key1 key2 ï¼šæ±‚ key1 ä¸ key2 çš„äº¤é›†</li><li>SDIFF key1 key2ï¼šæ±‚ key1 ä¸ key2 çš„å·®é›† </li><li>SUNION key1 key2 ï¼šæ±‚ key1 ä¸ key2 çš„å¹¶é›†</li></ul><h5 id="2-1-6-SortedSetç±»å‹"><a href="#2-1-6-SortedSetç±»å‹" class="headerlink" title="2.1.6 SortedSetç±»å‹"></a>2.1.6 SortedSetç±»å‹</h5><p>Redis çš„ SortedSet æ˜¯ä¸€ä¸ªå¯æ’åºçš„ set é›†åˆï¼Œä¸ Java ä¸­çš„ TreeSet æœ‰äº›ç±»ä¼¼ï¼Œä½†åº•å±‚æ•°æ®ç»“æ„å´å·®åˆ«å¾ˆå¤§ã€‚SortedSet ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½å¸¦æœ‰ä¸€ä¸ª score å±æ€§ï¼Œå¯ä»¥åŸºäº score å±æ€§å¯¹ å…ƒç´ æ’åºï¼Œåº•å±‚çš„å®ç°æ˜¯ä¸€ä¸ªè·³è¡¨ï¼ˆSkipListï¼‰åŠ hashè¡¨ã€‚</p><p>SortedSetå…·å¤‡ä¸‹åˆ—ç‰¹æ€§ï¼š</p><ul><li>å¯æ’åº</li><li>å…ƒç´ ä¸é‡å¤</li><li>æŸ¥è¯¢é€Ÿåº¦å¿«</li></ul><p>å› ä¸º SortedSet çš„å¯æ’åºç‰¹æ€§ï¼Œç»å¸¸è¢«ç”¨æ¥å®ç°æ’è¡Œæ¦œè¿™æ ·çš„åŠŸèƒ½ã€‚</p><p>SortedSetçš„å¸¸è§å‘½ä»¤æœ‰ï¼š</p><ul><li>ZADD key score memberï¼šæ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ åˆ° SortedSetï¼Œå¦‚æœå·²ç»å­˜åœ¨åˆ™æ›´æ–°å…¶ score å€¼</li><li>ZREM key memberï¼šåˆ é™¤ SortedSetä¸­çš„ä¸€ä¸ªæŒ‡å®šå…ƒç´ </li><li>ZSCORE key memberï¼šè·å– SortedSet ä¸­çš„æŒ‡å®šå…ƒç´ çš„ score å€¼</li><li>ZRANK key memberï¼šè·å– SortedSet ä¸­çš„æŒ‡å®šå…ƒç´ çš„æ’å</li><li>ZCAED keyï¼šè·å– SortedSet ä¸­çš„å…ƒç´ ä¸ªæ•°</li><li>ZCOUNT key min maxï¼šç»Ÿè®¡ score å€¼åœ¨ç»™å®šèŒƒå›´å†…çš„æ‰€æœ‰å…ƒç´ çš„ä¸ªæ•°</li><li>ZINCRBY key increment memberï¼šè®© SortedSetä¸­çš„æŒ‡å®šå…ƒç´ è‡ªå¢ï¼Œæ­¥é•¿ä¸ºæŒ‡å®šçš„incrementå€¼</li><li>ZRANGE key min maxï¼šæŒ‰ç…§ score æ’åºåï¼Œè·å–æŒ‡å®š score èŒƒå›´å†…çš„å…ƒç´ </li><li>ZRANGEBYSCORE key min maxï¼šæŒ‰ç…§ score æ’åºåï¼Œè·å–æŒ‡å®š score èŒƒå›´å†…çš„å…ƒç´ </li><li>ZDIFFã€ZINTERã€ZUNIONï¼šæ±‚å·®é›†ã€äº¤é›†ã€å¹¶é›†</li></ul><p>æ³¨æ„ï¼šæ‰€æœ‰çš„æ’åé»˜è®¤éƒ½æ˜¯ å‡åºï¼Œå¦‚æœè¦é™åºåˆ™åœ¨å‘½ä»¤çš„Zåé¢æ·»åŠ REVå³å¯</p><h4 id="2-2-Rediså®¢æˆ·ç«¯"><a href="#2-2-Rediså®¢æˆ·ç«¯" class="headerlink" title="2.2 Rediså®¢æˆ·ç«¯"></a>2.2 Rediså®¢æˆ·ç«¯</h4><p>Redisçš„å®¢æˆ·ç«¯ä¸»è¦æœ‰</p><ul><li>Jedisï¼šä»¥Rediså‘½ä»¤ä½œä¸ºæ–¹æ³•åç§°ï¼Œå­¦ä¹ æˆæœ¬ä½ï¼Œç®€å•å®ç”¨ã€‚ä½†æ˜¯Jediså®ä¾‹æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œå¤šçº¿ç¨‹æƒ…å†µä¸‹éœ€è¦åŸºäºè¿æ¥æ± å®ç”¨</li><li>Lettuceï¼šåŸºäºNettyå®ç°çš„ï¼Œæ”¯æŒåŒæ­¥ã€å¼‚æ­¥å’Œå“åº”å¼ç¼–ç¨‹æ–¹å¼ï¼Œå¹¶ä¸”æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚æ”¯æŒRedisçš„å“¨å…µæ¨¡å¼ã€é›†ç¾¤æ¨¡å¼å’Œç®¡é“æ¨¡å¼ã€‚</li><li>Redissonï¼šæ˜¯ä¸€ä¸ªåŸºäºRediså®ç°çš„åˆ†å¸ƒå¼ã€å¯ä¼¸ç¼©çš„ Java æ•°æ®ç»“æ„é›†åˆã€‚åŒ…å«äº†è¯¸å¦‚ Mapã€Queueã€Lockã€Semaphoreã€AtomicLongç­‰å¼ºå¤§åŠŸèƒ½ã€‚</li></ul><p>è€Œ SpringData Redis é›†æˆäº† Jedisã€Lettuce</p><h5 id="2-2-1-Jedis-å®¢æˆ·ç«¯"><a href="#2-2-1-Jedis-å®¢æˆ·ç«¯" class="headerlink" title="2.2.1 Jedis å®¢æˆ·ç«¯"></a>2.2.1 Jedis å®¢æˆ·ç«¯</h5><p><a href="https://github.com/kongxiaoran/redisDemo">https://github.com/kongxiaoran/redisDemo</a></p><p>å¯ä»¥ä¸‹æ‹‰è¯¥é¡¹ç›®çš„ Jedis åˆ†æ”¯ï¼Œè¯¥åˆ†æ”¯å·²ç» å®ç°äº† springboot æ•´åˆ jedis ã€‚å¯ä»¥ä¸‹æ‹‰çœ‹çœ‹</p><p>Jedisæœ¬èº«æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œå¹¶ä¸”é¢‘ç¹çš„åˆ›å»ºå’Œé”€æ¯è¿æ¥ä¼šæœ‰æ€§èƒ½æŸè€—ï¼Œå› æ­¤æˆ‘ä»¬æ¨èå¤§å®¶ä½¿ç”¨ Jedis è¿æ¥æ± ä»£æ›¿ Jedis çš„ç›´è¿æ–¹å¼ã€‚</p><h5 id="2-2-2-SpringDataRedis"><a href="#2-2-2-SpringDataRedis" class="headerlink" title="2.2.2 SpringDataRedis"></a>2.2.2 SpringDataRedis</h5><p>SpringData æ˜¯ Spring ä¸­æ•°æ®æ“ä½œçš„æ¨¡å—ï¼ŒåŒ…å«å¯¹å„ç§æ•°æ®åº“çš„é›†æˆï¼Œå…¶ä¸­å¯¹ Redis çš„é›†æˆæ¨¡å—å°±å«åš SpringDataRedisï¼Œå®˜ç½‘åœ°å€ï¼š</p><ul><li>æä¾›äº†å¯¹ä¸åŒ Redis å®¢æˆ·ç«¯çš„æ•´åˆï¼ˆLettuceã€Jedisï¼‰</li><li>æä¾›äº† RedisTemplate ç»Ÿä¸€ API æ¥æ“ä½œ</li><li>æ”¯æŒ Redis çš„å‘å¸ƒè®¢é˜…æ¨¡å‹</li><li>æ”¯æŒ Redis å“¨å…µå’Œ Redis é›†ç¾¤</li><li>æ”¯æŒåŸºäº Lettuce çš„å“åº”å¼ç¼–ç¨‹</li><li>æ”¯æŒåŸºäº JDKã€JSONã€å­—ç¬¦ä¸²ã€Springå¯¹è±¡çš„æ•°æ®åºåˆ—åŒ–åŠååºåˆ—åŒ–</li><li>æ”¯æŒåŸºäº Redistributionçš„ JDK Collectionå®ç°</li></ul><h4 id="2-3-SpringDataRedis-å®¢æˆ·ç«¯ä½¿ç”¨"><a href="#2-3-SpringDataRedis-å®¢æˆ·ç«¯ä½¿ç”¨" class="headerlink" title="2.3 SpringDataRedis å®¢æˆ·ç«¯ä½¿ç”¨"></a>2.3 SpringDataRedis å®¢æˆ·ç«¯ä½¿ç”¨</h4><p>SpringDataRedis æä¾›äº† RedisTemplate å·¥å…·ç±»ï¼Œå…¶ä¸­å°è£…äº†å„ç§å¯¹ Redis çš„æ“ä½œã€‚å¹¶ä¸”å°†ä¸åŒæ•°æ®ç±»å‹çš„æ“ä½œAPI å°è£…åˆ°äº†ä¸åŒç±»å‹ä¸­ï¼š</p><table><thead><tr><th><strong>API</strong></th><th><strong>è¿”å›å€¼ç±»å‹</strong></th><th><strong>è¯´æ˜</strong></th></tr></thead><tbody><tr><td>redisTemplate.opsForValue()</td><td>ValueOperations</td><td>æ“ä½œ String ç±»å‹æ•°æ®</td></tr><tr><td>redisTemplate.opsForHash()</td><td>HashOperations</td><td>æ“ä½œ Hash ç±»å‹æ•°æ®</td></tr><tr><td>redisTemplate.opsForList()</td><td>ListIOperations</td><td>æ“ä½œ List ç±»å‹æ•°æ®</td></tr><tr><td>redisTemplate.opsForSet()</td><td>SetOperations</td><td>æ“ä½œ Set ç±»å‹æ•°æ®</td></tr><tr><td>redisTemplate.opsForZSet()</td><td>ZSetOperations</td><td>æ“ä½œ SortedSet ç±»å‹æ•°æ®</td></tr><tr><td>redisTemplate</td><td></td><td>é€šç”¨å‘½ä»¤</td></tr></tbody></table><p><a href="https://github.com/kongxiaoran/redisDemo">https://github.com/kongxiaoran/redisDemo</a></p><p>è¯¥é¡¹ç›®çš„ master åˆ†æ”¯ï¼Œä½¿ç”¨ SpringBoot æ•´åˆäº† SpringDataRedisï¼Œå¯ä»¥è‡ªè¡Œä¸‹æ‹‰è¿è¡Œã€‚</p><h5 id="2-3-1-SpringDataRedis-çš„é»˜è®¤åºåˆ—åŒ–"><a href="#2-3-1-SpringDataRedis-çš„é»˜è®¤åºåˆ—åŒ–" class="headerlink" title="2.3.1 SpringDataRedis çš„é»˜è®¤åºåˆ—åŒ–"></a>2.3.1 SpringDataRedis çš„é»˜è®¤åºåˆ—åŒ–</h5><p>RedisTemplate å¯ä»¥æ¥æ”¶ä»»æ„ Object ä½œä¸ºå€¼ å†™å…¥ Redisï¼Œåªä¸è¿‡å†™å…¥ å‰ä¼šæŠŠ Object åºåˆ—åŒ–ä¸ºå­—èŠ‚å½¢å¼ï¼Œé»˜è®¤æ˜¯é‡‡ç”¨ JDK åºåˆ—åŒ–ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redisTemplate.opsForValue().set(&quot;springboot&quot;,&quot;ä½ å¥½å‘€ï¼Œspringboot&quot;);   </span><br><span class="line">String springboot = (String) redisTemplate.opsForValue().get(&quot;springboot&quot;);</span><br><span class="line">System.out.println(springboot);</span><br></pre></td></tr></table></figure><p>å¾—åˆ°çš„ç»“æœæ˜¯è¿™æ ·çš„ï¼š</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/35838370/1682779112780-bf2ddbf3-24a4-47aa-b14d-5ba839abecdd.png" alt="img"></p><p>ç¼ºç‚¹å¾ˆæ˜æ˜¾ï¼š</p><ul><li>å¯è¯»æ€§å·®</li><li>å†…å­˜å ç”¨è¾ƒå¤§</li></ul><p>è¿™æ˜¯å› ä¸ºä»€ä¹ˆå‘¢ï¼ŸæŸ¥çœ‹ RedisTemplate ç±»ï¼Œå¯ä»¥çŸ¥é“ å½“æ²¡æœ‰ç‰¹åˆ«é…ç½® keyã€valueã€hashKey çš„ åºåˆ—åŒ–ç­–ç•¥æ—¶ï¼Œ</p><p>RedisTemplate ä¼šé€‰æ‹©ä½¿ç”¨ JDKåºåˆ—åŒ–å™¨ï¼ˆJdkSerializationRedisSerializer)ï¼Œè€Œæ­¤åºåˆ—åŒ–å™¨æ˜¯ä¸æ˜¯é€‚åˆå­—ç¬¦ä¸²çš„åºåˆ—åŒ–çš„ã€‚æ‰€ä»¥å¦‚æœä½ çš„ key é€šå¸¸æ˜¯ç”¨ å­—ç¬¦ä¸²æ ¼å¼ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘ åœ¨åºåˆ—åŒ–keyæ—¶ï¼Œé‡‡ç”¨å…¶ä»–åºåˆ—åŒ–å™¨ã€‚æ¯”å¦‚ï¼šString</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/35838370/1682779116223-bc409176-9ef0-4441-87c3-073ae4c8bc51.png" alt="img"></p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779116227-ff9eae7b-6954-4282-91dc-cd89ac3f5cd8.png" alt="img"></p><h5 id="2-3-2-SpringDataRedis-æä¾›çš„åºåˆ—åŒ–å™¨"><a href="#2-3-2-SpringDataRedis-æä¾›çš„åºåˆ—åŒ–å™¨" class="headerlink" title="2.3.2 SpringDataRedis æä¾›çš„åºåˆ—åŒ–å™¨"></a>2.3.2 SpringDataRedis æä¾›çš„åºåˆ—åŒ–å™¨</h5><p>æŸ¥çœ‹ RedisSerializer çš„å®ç°ï¼Œå¯ä»¥çœ‹åˆ°æœ‰ 7 ç§åºåˆ—åŒ–å™¨ï¼š</p><ul><li><p>ByteArrayRedisSerializerï¼šå­—èŠ‚æ•°ç»„åºåˆ—åŒ–</p></li><li><p>GenericJackson2JsonRedisSerializerï¼šåŒ FastJsonRedisSerializer ç±»ä¼¼ï¼Œè€Œ FastJsonRedisSerializer æ˜¯ç”±é˜¿é‡Œå·´å·´FastJsonåŒ…æä¾›ã€‚å…·æœ‰ï¼š1. é€Ÿåº¦å¿« 2. å…¼å®¹æ€§å¼º 3. å ç”¨å†…å­˜å°</p></li><li><ul><li>åº•å±‚ä½¿ç”¨Jacksonè¿›è¡Œåºåˆ—åŒ–å¹¶å­˜å…¥Redisã€‚å¯¹äºæ™®é€šç±»å‹(å¦‚æ•°å€¼ç±»å‹ï¼Œå­—ç¬¦</li><li>å­˜å…¥å¯¹è±¡æ—¶ç”±äºæ²¡æœ‰å­˜å…¥ç±»ä¿¡æ¯ï¼Œåˆ™æ— æ³•ååºåˆ—åŒ–ã€‚</li></ul></li><li><p>GenericToStringSerializerï¼šåŒStringRedisSerializerä¸€æ ·ï¼Œä½†å®ƒå¯ä»¥å°†ä»»ä½•å¯¹è±¡æ³›åŒ–ä¸ºå­—ç¬¦ä¸²å¹¶åºåˆ—åŒ–ã€‚æ³¨æ„äº‹é¡¹ï¼šGenericToStringSerializeréœ€è¦è°ƒç”¨è€…ç»™ä¼ ä¸€ä¸ªå¯¹è±¡åˆ°å­—ç¬¦ä¸²äº’è½¬çš„Converterï¼Œä½¿ç”¨èµ·æ¥å…¶æ¯”è¾ƒéº»çƒ¦ï¼Œæ‰€ä»¥ä¸å¤ªæ¨èä½¿ç”¨ã€‚</p></li><li><p>Jackson2JsonRedisSerializerï¼šå°†å¯¹è±¡åºåˆ—åŒ–ä¸ºjsonå­—ç¬¦ä¸²</p></li><li><ul><li>Â·ä¼˜ç‚¹ï¼šé€Ÿåº¦å¿«ã€åºåˆ—åŒ–åçš„å­—ç¬¦ä¸²çŸ­å°ç²¾æ‚ã€ä¸éœ€è¦å®ç° Serializable</li><li>ç¼ºç‚¹ï¼šå¿…é¡»è¦æä¾›è¦åºåˆ—åŒ–å¯¹è±¡çš„ç±»å‹ä¿¡æ¯ï¼ˆ.classå¯¹è±¡ï¼‰</li></ul></li><li><p>JdkSerializationRedisSerializerï¼šä½¿ç”¨Javaè‡ªå¸¦çš„åºåˆ—åŒ–æœºåˆ¶å°†å¯¹è±¡åºåˆ—åŒ–ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ã€‚</p></li><li><ul><li>ä¼˜ç‚¹åœ¨äºï¼šé€šç”¨æ€§å¼ºã€ååºåˆ—åŒ–æ—¶ä¸éœ€è¦æä¾›ç±»å‹ä¿¡æ¯ã€‚ã€</li><li>ç¼ºç‚¹åœ¨äºï¼šåºåˆ—åŒ–é€Ÿåº¦æ…¢ã€åºåˆ—åŒ–å†…å­˜å ç”¨å¤§ã€åºåˆ—åŒ–å¯¹è±¡å¿…é¡»å®ç° Serializable æ¥å£ã€å¯è¯»æ€§å·®</li></ul></li><li><p>OxmSerializerï¼šå°†å¯¹è±¡åºåˆ—åŒ–ä¸ºxmlå­—ç¬¦ä¸²ã€‚ä»¥ xml æ ¼å¼å­˜å‚¨ï¼ˆä½†è¿˜æ˜¯Stringç±»å‹ï¼‰ï¼Œè§£æèµ·æ¥æ¯”è¾ƒå¤æ‚ï¼Œä¸”å ç”¨ç©ºé—´å¤§</p></li><li><p>StringRedisSerializerï¼šStringRedisTemplateé»˜è®¤çš„åºåˆ—åŒ–å™¨ã€‚</p></li><li><ul><li>ä¼˜ç‚¹ï¼šå¯è¯»æ€§å¼ºã€ä¸éœ€è¦è½¬æ¢</li><li>ç¼ºç‚¹ï¼šåªèƒ½å¯¹å­—ç¬¦ä¸²åºåˆ—åŒ–ï¼Œä¸èƒ½å¯¹ å¯¹è±¡ åºåˆ—åŒ–</li></ul></li></ul><h5 id="2-3-3-è‡ªå®šä¹‰åºåˆ—åŒ–å™¨"><a href="#2-3-3-è‡ªå®šä¹‰åºåˆ—åŒ–å™¨" class="headerlink" title="2.3.3 è‡ªå®šä¹‰åºåˆ—åŒ–å™¨"></a>2.3.3 è‡ªå®šä¹‰åºåˆ—åŒ–å™¨</h5><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é’ˆå¯¹è‡ªå·±çš„éœ€è¦ï¼Œè‡ªå®šä¹‰ RedisTemplateï¼Œæ¥å®ç°å¯¹ä¸åŒ keyã€value ä½¿ç”¨ä¸åŒçš„åºåˆ—åŒ–å™¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">public RedisTemplate&lt;String,Object&gt; redisTemplate(RedisConnectionFactory redisConnectionFactory)</span><br><span class="line">    throws UnknownHostException&#123;</span><br><span class="line"></span><br><span class="line">    // åˆ›å»º Template</span><br><span class="line">    RedisTemplate&lt;String,Object&gt; redisTemplate = new RedisTemplate&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    // è®¾ç½®è¿æ¥å·¥å‚</span><br><span class="line">    redisTemplate.setConnectionFactory(redisConnectionFactory);</span><br><span class="line"></span><br><span class="line">    // è®¾ç½®åºåˆ—åŒ–å·¥å…·</span><br><span class="line">    GenericJackson2JsonRedisSerializer jackson2JsonRedisSerializer =</span><br><span class="line">    new GenericJackson2JsonRedisSerializer();</span><br><span class="line"></span><br><span class="line">    // key å’Œ hashKey é‡‡ç”¨ Stringåºåˆ—åŒ–</span><br><span class="line">    redisTemplate.setKeySerializer(RedisSerializer.string());</span><br><span class="line">    redisTemplate.setHashKeySerializer(RedisSerializer.string());</span><br><span class="line"></span><br><span class="line">    // value å’Œ hashValue é‡‡ç”¨ JOSNåºåˆ—åŒ–</span><br><span class="line">    redisTemplate.setValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line">    redisTemplate.setHashValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line"></span><br><span class="line">    return redisTemplate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-3-4-ä½¿ç”¨è‡ªå®šä¹‰åºåˆ—åŒ–å™¨å­˜å‚¨å¯¹è±¡"><a href="#2-3-4-ä½¿ç”¨è‡ªå®šä¹‰åºåˆ—åŒ–å™¨å­˜å‚¨å¯¹è±¡" class="headerlink" title="2.3.4 ä½¿ç”¨è‡ªå®šä¹‰åºåˆ—åŒ–å™¨å­˜å‚¨å¯¹è±¡"></a>2.3.4 ä½¿ç”¨è‡ªå®šä¹‰åºåˆ—åŒ–å™¨å­˜å‚¨å¯¹è±¡</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void testEmployee()&#123;</span><br><span class="line">    Employee employee = new Employee(3,&quot;ç¾½&quot;,&quot;28235x02x7&quot;,1,1);</span><br><span class="line">    // å†™å…¥æ•°æ®</span><br><span class="line">    redisTemplate.opsForValue().set(&quot;user_3&quot;,employee);</span><br><span class="line"></span><br><span class="line">    // è·å–æ•°æ®</span><br><span class="line">    Employee getEmployee = (Employee) redisTemplate.opsForValue().get(&quot;user_3&quot;);</span><br><span class="line">    System.out.println(getEmployee.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2023/png/35838370/1682779116323-2e3c4c31-c032-4f95-985f-2c0da0eb6c51.png" alt="img"></p><p>ç”±å›¾å¯ä»¥çŸ¥é“ï¼Œè¯¥åºåˆ—åŒ–å™¨åœ¨åºåˆ—åŒ–å¯¹è±¡ï¼Œä¹Ÿä¼šå°† å¯¹è±¡çš„å­—èŠ‚ç åç§°å†™å…¥ã€‚è¿™æ ·åœ¨æˆ‘ä»¬ååºåˆ—åŒ–æ—¶çŸ¥é“å¯¹è±¡çš„ç±»å‹ï¼Œä»è€Œååºåˆ—åŒ–æˆå¯¹åº”å¯¹è±¡ã€‚</p><h5 id="2-3-5-ä½¿ç”¨StringRedisTemplateå­˜å‚¨JSONå¯¹è±¡"><a href="#2-3-5-ä½¿ç”¨StringRedisTemplateå­˜å‚¨JSONå¯¹è±¡" class="headerlink" title="2.3.5 ä½¿ç”¨StringRedisTemplateå­˜å‚¨JSONå¯¹è±¡"></a>2.3.5 ä½¿ç”¨StringRedisTemplateå­˜å‚¨JSONå¯¹è±¡</h5><p>ä½†æ˜¯è¿™ä¸€ä¸ªå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼ŒJSONåºåˆ—åŒ–å™¨å°†ç±»çš„classç±»å‹å†™å…¥äº† JSONç»“æœä¸­ï¼Œå­˜å…¥äº† Redis ï¼Œä¼šå¸¦æ¥é¢å¤–çš„å†…å­˜å¼€é”€ã€‚ä¸ºäº†èŠ‚çœå†…å­˜ç©ºé—´ï¼Œæˆ‘ä»¬å¹¶ä¸ä¼šä½¿ç”¨ JSON åºåˆ—åŒ–å™¨æ¥å¤„ç† valueï¼Œè€Œæ˜¯ç»Ÿä¸€ä½¿ç”¨ String åºåˆ—åŒ–å™¨ï¼Œè¦æ±‚åªèƒ½å­˜å‚¨ String ç±»å‹çš„ key å’Œ valueã€‚å½“éœ€è¦å­˜å‚¨ Java å¯¹è±¡æ—¶ï¼Œ<strong>æ‰‹åŠ¨å®Œæˆå¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–</strong>ã€‚</p><p>æ‰€ä»¥è¿˜æ˜¯å»ºè®®æ‰‹åŠ¨å®Œæˆå¯¹è±¡çš„åºåˆ—åŒ–ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void testEmployeeStringRedisTemplate()&#123;</span><br><span class="line">    Employee employee = new Employee(3,&quot;ç¾½&quot;,&quot;2823x302x7&quot;,1,1);</span><br><span class="line">    // å†™å…¥æ•°æ® ï¼ˆè¿™é‡Œä½¿ç”¨çš„æ—¶ fastJson2è¿›è¡Œåºåˆ—åŒ–ï¼‰</span><br><span class="line">    stringRedisTemplate.opsForValue().set(&quot;user_4&quot;, JSON.toJSONString(employee));</span><br><span class="line">    // è·å–æ•°æ®</span><br><span class="line">    Employee getEmployee = JSON.parseObject(stringRedisTemplate.opsForValue().get(&quot;user_4&quot;), Employee.class);</span><br><span class="line">    System.out.println(getEmployee.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="2-3-6-RedisTemplate-æ“ä½œ-Hash-ç±»å‹"><a href="#2-3-6-RedisTemplate-æ“ä½œ-Hash-ç±»å‹" class="headerlink" title="2.3.6 RedisTemplate æ“ä½œ Hash ç±»å‹"></a>2.3.6 RedisTemplate æ“ä½œ Hash ç±»å‹</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void testHash()&#123;</span><br><span class="line">    stringRedisTemplate.opsForHash().put(&quot;xiucheng&quot;,&quot;user1&quot;,&quot;å‡Œéœ„&quot;);</span><br><span class="line">    stringRedisTemplate.opsForHash().put(&quot;xiucheng&quot;,&quot;user2&quot;,&quot;ç¾½&quot;);</span><br><span class="line"></span><br><span class="line">    Map&lt;Object, Object&gt; xiucheng = stringRedisTemplate.opsForHash().entries(&quot;xiucheng&quot;);</span><br><span class="line">    System.out.println(xiucheng.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä¸‰ã€Redis-å®æˆ˜"><a href="#ä¸‰ã€Redis-å®æˆ˜" class="headerlink" title="ä¸‰ã€Redis å®æˆ˜"></a>ä¸‰ã€Redis å®æˆ˜</h2><h3 id="3-1-Redisä¸MySQLåŒå†™ä¸€è‡´æ€§å¦‚ä½•ä¿è¯ï¼Ÿ"><a href="#3-1-Redisä¸MySQLåŒå†™ä¸€è‡´æ€§å¦‚ä½•ä¿è¯ï¼Ÿ" class="headerlink" title="3.1 Redisä¸MySQLåŒå†™ä¸€è‡´æ€§å¦‚ä½•ä¿è¯ï¼Ÿ"></a>3.1 Redisä¸MySQLåŒå†™ä¸€è‡´æ€§å¦‚ä½•ä¿è¯ï¼Ÿ</h3><h4 id="3-1-1-ä¸€è‡´æ€§"><a href="#3-1-1-ä¸€è‡´æ€§" class="headerlink" title="3.1.1 ä¸€è‡´æ€§"></a>3.1.1 ä¸€è‡´æ€§</h4><p>ä¸€è‡´æ€§å°±æ˜¯æ•°æ®ä¿æŒä¸€è‡´ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¯ä»¥ç†è§£ä¸ºå¤šä¸ªèŠ‚ç‚¹ä¸­æ•°æ®çš„å€¼æ˜¯ä¸€è‡´çš„ã€‚</p><ul><li><strong>å¼ºä¸€è‡´æ€§</strong>ï¼šè¿™ç§ä¸€è‡´æ€§çº§åˆ«æ˜¯æœ€ç¬¦åˆç”¨æˆ·ç›´è§‰çš„ï¼Œå®ƒè¦æ±‚ç³»ç»Ÿå†™å…¥ä»€ä¹ˆï¼Œè¯»å‡ºæ¥çš„ä¹Ÿä¼šæ˜¯ä»€ä¹ˆï¼Œç”¨æˆ·ä½“éªŒå¥½ï¼Œä½†å®ç°èµ·æ¥å¾€å¾€å¯¹ç³»ç»Ÿçš„æ€§èƒ½å½±å“å¤§</li><li><strong>å¼±ä¸€è‡´æ€§</strong>ï¼šè¿™ç§ä¸€è‡´æ€§çº§åˆ«çº¦æŸäº†ç³»ç»Ÿåœ¨å†™å…¥æˆåŠŸåï¼Œä¸æ‰¿è¯ºç«‹å³å¯ä»¥è¯»åˆ°å†™å…¥çš„å€¼ï¼Œä¹Ÿä¸æ‰¿è¯ºå¤šä¹…ä¹‹åæ•°æ®èƒ½å¤Ÿè¾¾åˆ°ä¸€è‡´ï¼Œä½†ä¼šå°½å¯èƒ½åœ°ä¿è¯åˆ°æŸä¸ªæ—¶é—´çº§åˆ«ï¼ˆæ¯”å¦‚ç§’çº§åˆ«ï¼‰åï¼Œæ•°æ®èƒ½å¤Ÿè¾¾åˆ°ä¸€è‡´çŠ¶æ€</li><li><strong>æœ€ç»ˆä¸€è‡´æ€§</strong>ï¼šæœ€ç»ˆä¸€è‡´æ€§æ˜¯å¼±ä¸€è‡´æ€§çš„ä¸€ä¸ªç‰¹ä¾‹ï¼Œç³»ç»Ÿä¼šä¿è¯åœ¨ä¸€å®šæ—¶é—´å†…ï¼Œèƒ½å¤Ÿè¾¾åˆ°ä¸€ä¸ªæ•°æ®ä¸€è‡´çš„çŠ¶æ€ã€‚è¿™é‡Œä¹‹æ‰€ä»¥å°†æœ€ç»ˆä¸€è‡´æ€§å•ç‹¬æå‡ºæ¥ï¼Œæ˜¯å› ä¸ºå®ƒæ˜¯å¼±ä¸€è‡´æ€§ä¸­éå¸¸æ¨å´‡çš„ä¸€ç§ä¸€è‡´æ€§æ¨¡å‹ï¼Œä¹Ÿæ˜¯ä¸šç•Œåœ¨å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ•°æ®ä¸€è‡´æ€§ä¸Šæ¯”è¾ƒæ¨å´‡çš„æ¨¡å‹</li></ul><h4 id="3-1-2-ä¸‰ç§ç»å…¸çš„ç¼“å­˜æ¨¡å¼"><a href="#3-1-2-ä¸‰ç§ç»å…¸çš„ç¼“å­˜æ¨¡å¼" class="headerlink" title="3.1.2 ä¸‰ç§ç»å…¸çš„ç¼“å­˜æ¨¡å¼"></a>3.1.2 ä¸‰ç§ç»å…¸çš„ç¼“å­˜æ¨¡å¼</h4><p>ç¼“å­˜å¯ä»¥æå‡æ€§èƒ½ã€ç¼“è§£æ•°æ®åº“å‹åŠ›ï¼Œä½†æ˜¯ä½¿ç”¨ç¼“å­˜ä¹Ÿä¼šå¯¼è‡´æ•°æ®<strong>ä¸ä¸€è‡´æ€§</strong>çš„é—®é¢˜ã€‚ä¸€èˆ¬æˆ‘ä»¬æ˜¯å¦‚ä½•ä½¿ç”¨ç¼“å­˜å‘¢ï¼Ÿæœ‰ä¸‰ç§ç»å…¸çš„ç¼“å­˜æ¨¡å¼ï¼š</p><ul><li><strong>Cache-Aside Pattern</strong>Cache-Aside Patternï¼Œå³<strong>æ—è·¯ç¼“å­˜æ¨¡å¼</strong>ï¼Œå®ƒçš„æå‡ºæ˜¯ä¸ºäº†å°½å¯èƒ½åœ°è§£å†³ç¼“å­˜ä¸æ•°æ®åº“çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚è¯»ï¼šå†™ï¼šæ›´æ–°çš„æ—¶å€™ï¼Œå…ˆ<strong>æ›´æ–°æ•°æ®åº“ï¼Œç„¶åå†åˆ é™¤ç¼“å­˜</strong>ã€‚</li></ul><ol><li><ol><li>è¯»çš„æ—¶å€™ï¼Œå…ˆè¯»ç¼“å­˜ï¼Œç¼“å­˜å‘½ä¸­çš„è¯ï¼Œç›´æ¥è¿”å›æ•°æ®</li><li>ç¼“å­˜æ²¡æœ‰å‘½ä¸­çš„è¯ï¼Œå°±å»è¯»æ•°æ®åº“ï¼Œä»æ•°æ®åº“å–å‡ºæ•°æ®ï¼Œæ”¾å…¥ç¼“å­˜åï¼ŒåŒæ—¶è¿”å›å“åº”ã€‚</li></ol></li></ol><ul><li><strong>Read-Through&#x2F;Write through</strong>Read&#x2F;Write Throughæ¨¡å¼ä¸­ï¼ŒæœåŠ¡ç«¯æŠŠç¼“å­˜ä½œä¸ºä¸»è¦æ•°æ®å­˜å‚¨ã€‚åº”ç”¨ç¨‹åºè·Ÿæ•°æ®åº“ç¼“å­˜äº¤äº’ï¼Œéƒ½æ˜¯é€šè¿‡<strong>æŠ½è±¡ç¼“å­˜å±‚</strong>å®Œæˆçš„ã€‚è¯»ï¼š<img src="https://cdn.nlark.com/yuque/0/2023/webp/35838370/1682779116373-baeadbf7-a12c-4bb1-9fae-bff4afb23d3b.webp" alt="img">è¿™ä¸ªç®€è¦æµç¨‹æ˜¯ä¸æ˜¯è·Ÿ<strong>Cache-Aside</strong>å¾ˆåƒå‘¢ï¼Ÿå…¶å®<strong>Read-Through</strong>å°±æ˜¯å¤šäº†ä¸€å±‚<strong>Cache-Provider</strong>ã€‚å†™ï¼šå½“å‘ç”Ÿå†™è¯·æ±‚æ—¶ï¼Œä¹Ÿæ˜¯ç”±<strong>ç¼“å­˜æŠ½è±¡å±‚</strong>å®Œæˆæ•°æ®æºå’Œç¼“å­˜æ•°æ®çš„æ›´æ–°ï¼šå…ˆæ›´æ–°æ•°æ®æºï¼Œå†æ›´æ–°ç¼“å­˜ã€‚</li></ul><ol><li><ol><li>ä»ç¼“å­˜è¯»å–æ•°æ®ï¼Œè¯»åˆ°ç›´æ¥è¿”å›</li><li>å¦‚æœè¯»å–ä¸åˆ°çš„è¯ï¼Œä»æ•°æ®åº“åŠ è½½ï¼Œå†™å…¥ç¼“å­˜åï¼Œå†è¿”å›å“åº”ã€‚</li></ol></li></ol><ul><li><strong>Write behind****Write behind</strong>è·Ÿ<strong>Read-Through&#x2F;Write-Through</strong>æœ‰ç›¸ä¼¼çš„åœ°æ–¹ï¼Œéƒ½æ˜¯ç”±Cache Provideræ¥è´Ÿè´£ç¼“å­˜å’Œæ•°æ®åº“çš„è¯»å†™ã€‚å®ƒä¸¤åˆæœ‰ä¸ªå¾ˆå¤§çš„ä¸åŒï¼š<strong>Read&#x2F;Write Through</strong>æ˜¯åŒæ­¥æ›´æ–°ç¼“å­˜å’Œæ•°æ®çš„ï¼Œ<strong>Write Behind</strong>åˆ™æ˜¯åªæ›´æ–°ç¼“å­˜ï¼Œä¸ç›´æ¥æ›´æ–°æ•°æ®åº“ï¼Œé€šè¿‡<strong>æ‰¹é‡å¼‚æ­¥</strong>çš„æ–¹å¼æ¥æ›´æ–°æ•°æ®åº“ã€‚è¿™ç§æ–¹å¼ä¸‹ï¼Œç¼“å­˜å’Œæ•°æ®åº“çš„ä¸€è‡´æ€§ä¸å¼ºï¼Œ<strong>å¯¹ä¸€è‡´æ€§è¦æ±‚é«˜çš„ç³»ç»Ÿè¦è°¨æ…ä½¿ç”¨</strong>ã€‚ä½†æ˜¯å®ƒé€‚åˆé¢‘ç¹å†™çš„åœºæ™¯ï¼ŒMySQLçš„<strong>InnoDB Buffer Poolæœºåˆ¶</strong>å°±ä½¿ç”¨åˆ°è¿™ç§æ¨¡å¼ã€‚</li></ul><h4 id="3-1-3-æ“ä½œç¼“å­˜çš„æ—¶å€™ï¼Œåˆ é™¤ç¼“å­˜å‘¢ï¼Œè¿˜æ˜¯æ›´æ–°ç¼“å­˜ï¼Ÿ"><a href="#3-1-3-æ“ä½œç¼“å­˜çš„æ—¶å€™ï¼Œåˆ é™¤ç¼“å­˜å‘¢ï¼Œè¿˜æ˜¯æ›´æ–°ç¼“å­˜ï¼Ÿ" class="headerlink" title="3.1.3 æ“ä½œç¼“å­˜çš„æ—¶å€™ï¼Œåˆ é™¤ç¼“å­˜å‘¢ï¼Œè¿˜æ˜¯æ›´æ–°ç¼“å­˜ï¼Ÿ"></a>3.1.3 æ“ä½œç¼“å­˜çš„æ—¶å€™ï¼Œåˆ é™¤ç¼“å­˜å‘¢ï¼Œè¿˜æ˜¯æ›´æ–°ç¼“å­˜ï¼Ÿ</h4><p>ä¸€èˆ¬ä¸šåŠ¡åœºæ™¯ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„å°±æ˜¯<strong>Cache-Aside</strong>æ¨¡å¼ã€‚ æœ‰äº›å°ä¼™ä¼´å¯èƒ½ä¼šé—®ï¼Œ <strong>Cache-Aside</strong>åœ¨å†™å…¥è¯·æ±‚çš„æ—¶å€™ï¼Œä¸ºä»€ä¹ˆæ˜¯<strong>åˆ é™¤ç¼“å­˜è€Œä¸æ˜¯æ›´æ–°ç¼“å­˜</strong>å‘¢ï¼Ÿæˆ‘ä»¬åœ¨æ“ä½œç¼“å­˜çš„æ—¶å€™ï¼Œåˆ°åº•åº”è¯¥åˆ é™¤ç¼“å­˜è¿˜æ˜¯æ›´æ–°ç¼“å­˜å‘¢ï¼Ÿæˆ‘ä»¬å…ˆæ¥çœ‹ä¸ªä¾‹å­ï¼š</p><p><img src="https://cdn.nlark.com/yuque/0/2023/webp/35838370/1682779116395-a6501b26-db7f-4d05-87f6-60706161333e.webp" alt="img"></p><ol><li>çº¿ç¨‹Aå…ˆå‘èµ·ä¸€ä¸ªå†™æ“ä½œï¼Œç¬¬ä¸€æ­¥å…ˆæ›´æ–°æ•°æ®åº“</li><li>çº¿ç¨‹Bå†å‘èµ·ä¸€ä¸ªå†™æ“ä½œï¼Œç¬¬äºŒæ­¥æ›´æ–°äº†æ•°æ®åº“</li><li>ç”±äºç½‘ç»œç­‰åŸå› ï¼Œçº¿ç¨‹Bå…ˆæ›´æ–°äº†ç¼“å­˜</li><li>çº¿ç¨‹Aåæ›´æ–°ç¼“å­˜ã€‚</li></ol><p>è¿™æ—¶å€™ï¼Œç¼“å­˜ä¿å­˜çš„æ˜¯Açš„æ•°æ®ï¼ˆè€æ•°æ®ï¼‰ï¼Œæ•°æ®åº“ä¿å­˜çš„æ˜¯Bçš„æ•°æ®ï¼ˆæ–°æ•°æ®ï¼‰ï¼Œæ•°æ®<strong>ä¸ä¸€è‡´</strong>äº†ï¼Œè„æ•°æ®å‡ºç°å•¦ã€‚å¦‚æœæ˜¯<strong>åˆ é™¤ç¼“å­˜å–ä»£æ›´æ–°ç¼“å­˜</strong>åˆ™ä¸ä¼šå‡ºç°è¿™ä¸ªè„æ•°æ®é—®é¢˜ã€‚</p><p><strong>æ›´æ–°ç¼“å­˜ç›¸å¯¹äºåˆ é™¤ç¼“å­˜</strong>ï¼Œè¿˜æœ‰ä¸¤ç‚¹åŠ£åŠ¿ï¼š</p><ul><li>å¦‚æœä½ å†™å…¥çš„ç¼“å­˜å€¼ï¼Œæ˜¯ç»è¿‡å¤æ‚è®¡ç®—æ‰å¾—åˆ°çš„è¯ã€‚æ›´æ–°ç¼“å­˜é¢‘ç‡é«˜çš„è¯ï¼Œå°±æµªè´¹æ€§èƒ½å•¦ã€‚</li><li>åœ¨å†™æ•°æ®åº“åœºæ™¯å¤šï¼Œè¯»æ•°æ®åœºæ™¯å°‘çš„æƒ…å†µä¸‹ï¼Œæ•°æ®å¾ˆå¤šæ—¶å€™è¿˜æ²¡è¢«è¯»å–åˆ°ï¼Œåˆè¢«æ›´æ–°äº†ï¼Œè¿™ä¹Ÿæµªè´¹äº†æ€§èƒ½å‘¢(å®é™…ä¸Šï¼Œå†™å¤šçš„åœºæ™¯ï¼Œç”¨ç¼“å­˜ä¹Ÿä¸æ˜¯å¾ˆåˆ’ç®—äº†)</li></ul><h4 id="3-1-3-åŒå†™çš„æƒ…å†µä¸‹ï¼Œå…ˆæ“ä½œæ•°æ®åº“è¿˜æ˜¯å…ˆæ“ä½œç¼“å­˜ï¼Ÿ"><a href="#3-1-3-åŒå†™çš„æƒ…å†µä¸‹ï¼Œå…ˆæ“ä½œæ•°æ®åº“è¿˜æ˜¯å…ˆæ“ä½œç¼“å­˜ï¼Ÿ" class="headerlink" title="3.1.3 åŒå†™çš„æƒ…å†µä¸‹ï¼Œå…ˆæ“ä½œæ•°æ®åº“è¿˜æ˜¯å…ˆæ“ä½œç¼“å­˜ï¼Ÿ"></a>3.1.3 åŒå†™çš„æƒ…å†µä¸‹ï¼Œå…ˆæ“ä½œæ•°æ®åº“è¿˜æ˜¯å…ˆæ“ä½œç¼“å­˜ï¼Ÿ</h4><p>Cache-Asideç¼“å­˜æ¨¡å¼ä¸­ï¼Œæœ‰äº›å°ä¼™ä¼´è¿˜æ˜¯æœ‰ç–‘é—®ï¼Œåœ¨å†™å…¥è¯·æ±‚çš„æ—¶å€™ï¼Œä¸ºä»€ä¹ˆæ˜¯<strong>å…ˆæ“ä½œæ•°æ®åº“å‘¢</strong>ï¼Ÿä¸ºä»€ä¹ˆ<strong>ä¸å…ˆæ“ä½œç¼“å­˜</strong>å‘¢ï¼Ÿ</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779117654-0e13d67f-a1bb-47ad-93a2-85dc01b9fa12.webp" alt="img"></p><ol><li>çº¿ç¨‹Aå‘èµ·ä¸€ä¸ªå†™æ“ä½œï¼Œç¬¬ä¸€æ­¥del cache</li><li>æ­¤æ—¶çº¿ç¨‹Bå‘èµ·ä¸€ä¸ªè¯»æ“ä½œï¼Œcache miss</li><li>çº¿ç¨‹Bç»§ç»­è¯»DBï¼Œè¯»å‡ºæ¥ä¸€ä¸ªè€æ•°æ®</li><li>ç„¶åçº¿ç¨‹BæŠŠè€æ•°æ®è®¾ç½®å…¥cache</li><li>çº¿ç¨‹Aå†™å…¥DBæœ€æ–°çš„æ•°æ®</li></ol><p>é…±ç´«å°±æœ‰é—®é¢˜å•¦ï¼Œ<strong>ç¼“å­˜å’Œæ•°æ®åº“çš„æ•°æ®ä¸ä¸€è‡´äº†ã€‚ç¼“å­˜ä¿å­˜çš„æ˜¯è€æ•°æ®ï¼Œæ•°æ®åº“ä¿å­˜çš„æ˜¯æ–°æ•°æ®</strong>ã€‚å› æ­¤ï¼ŒCache-Aside ç¼“å­˜æ¨¡å¼ï¼Œé€‰æ‹©äº†å…ˆæ“ä½œæ•°æ®åº“è€Œä¸æ˜¯å…ˆæ“ä½œç¼“å­˜ã€‚</p><h4 id="3-1-4-ç¼“å­˜å»¶æ—¶åŒåˆ "><a href="#3-1-4-ç¼“å­˜å»¶æ—¶åŒåˆ " class="headerlink" title="3.1.4 ç¼“å­˜å»¶æ—¶åŒåˆ "></a>3.1.4 ç¼“å­˜å»¶æ—¶åŒåˆ </h4><p>æœ‰äº›å°ä¼™ä¼´å¯èƒ½ä¼šè¯´ï¼Œä¸ä¸€å®šè¦å…ˆæ“ä½œæ•°æ®åº“å‘€ï¼Œé‡‡ç”¨<strong>ç¼“å­˜å»¶æ—¶åŒåˆ </strong>ç­–ç•¥å°±å¥½å•¦ï¼Ÿä»€ä¹ˆæ˜¯å»¶æ—¶åŒåˆ å‘¢ï¼Ÿ</p><ol><li>å…ˆåˆ é™¤ç¼“å­˜</li><li>å†æ›´æ–°æ•°æ®åº“</li><li>ä¼‘çœ ä¸€ä¼šï¼ˆæ¯”å¦‚1ç§’ï¼‰ï¼Œå†æ¬¡åˆ é™¤ç¼“å­˜ã€‚</li></ol><p>è¿™ä¸ªä¼‘çœ ä¸€ä¼šï¼Œä¸€èˆ¬å¤šä¹…å‘¢ï¼Ÿéƒ½æ˜¯1ç§’ï¼Ÿ</p><p>è¿™ä¸ªä¼‘çœ æ—¶é—´ &#x3D; è¯»ä¸šåŠ¡é€»è¾‘æ•°æ®çš„è€—æ—¶ + å‡ ç™¾æ¯«ç§’ã€‚ ä¸ºäº†ç¡®ä¿è¯»è¯·æ±‚ç»“æŸï¼Œå†™è¯·æ±‚å¯ä»¥åˆ é™¤è¯»è¯·æ±‚å¯èƒ½å¸¦æ¥çš„ç¼“å­˜è„æ•°æ®ã€‚</p><h4 id="3-1-5-åˆ é™¤ç¼“å­˜é‡è¯•æœºåˆ¶"><a href="#3-1-5-åˆ é™¤ç¼“å­˜é‡è¯•æœºåˆ¶" class="headerlink" title="3.1.5 åˆ é™¤ç¼“å­˜é‡è¯•æœºåˆ¶"></a>3.1.5 åˆ é™¤ç¼“å­˜é‡è¯•æœºåˆ¶</h4><p>ä¸ç®¡æ˜¯<strong>å»¶æ—¶åŒåˆ </strong>è¿˜æ˜¯<strong>Cache-Asideçš„å…ˆæ“ä½œæ•°æ®åº“å†åˆ é™¤ç¼“å­˜</strong>ï¼Œå¦‚æœç¬¬äºŒæ­¥çš„åˆ é™¤ç¼“å­˜å¤±è´¥å‘¢ï¼Œåˆ é™¤å¤±è´¥ä¼šå¯¼è‡´è„æ•°æ®å“¦~</p><p><img src="https://cdn.nlark.com/yuque/0/2023/webp/35838370/1682779117889-0a62c399-8c30-4227-9a71-ef940b73fba0.webp" alt="img"></p><p>åˆ é™¤ç¼“å­˜é‡è¯•æœºåˆ¶ï¼Œä¼šé€ æˆå¾ˆå¤šä¸šåŠ¡ä»£ç å…¥ä¾µã€‚å…¶å®ä¹Ÿå¯ä»¥é€šè¿‡ æ•°æ®åº“çš„CDC æ¥å¼‚æ­¥æ·˜æ±° Keyã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€äº›é‡è¯•æœºåˆ¶ï¼Œç¡®ä¿ redis key è¢«åˆ é™¤äº†</p><h5 id="é˜Ÿåˆ—-é‡è¯•æœºåˆ¶"><a href="#é˜Ÿåˆ—-é‡è¯•æœºåˆ¶" class="headerlink" title="é˜Ÿåˆ—+é‡è¯•æœºåˆ¶"></a>é˜Ÿåˆ—+é‡è¯•æœºåˆ¶</h5><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779118664-a9c22f28-ced6-4e2d-a840-99031155209e.png" alt="img"></p><p>æµç¨‹å¦‚ä¸‹æ‰€ç¤º</p><ul><li>æ›´æ–°æ•°æ®åº“æ•°æ®</li><li>ç¼“å­˜å› ä¸ºç§ç§é—®é¢˜åˆ é™¤å¤±è´¥</li><li>å°†éœ€è¦åˆ é™¤çš„keyå‘é€è‡³æ¶ˆæ¯é˜Ÿåˆ—</li><li>è‡ªå·±æ¶ˆè´¹æ¶ˆæ¯ï¼Œè·å¾—éœ€è¦åˆ é™¤çš„key</li><li>ç»§ç»­é‡è¯•åˆ é™¤æ“ä½œï¼Œç›´åˆ°æˆåŠŸ</li></ul><p>ç„¶è€Œï¼Œè¯¥æ–¹æ¡ˆæœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œå¯¹ä¸šåŠ¡çº¿ä»£ç é€ æˆå¤§é‡çš„ä¾µå…¥ã€‚äºæ˜¯æœ‰äº†æ–¹æ¡ˆäºŒï¼Œåœ¨æ–¹æ¡ˆäºŒä¸­ï¼Œå¯åŠ¨ä¸€ä¸ªè®¢é˜…ç¨‹åºå»è®¢é˜…æ•°æ®åº“çš„binlogï¼Œè·å¾—éœ€è¦æ“ä½œçš„æ•°æ®ã€‚åœ¨åº”ç”¨ç¨‹åºä¸­ï¼Œå¦èµ·ä¸€æ®µç¨‹åºï¼Œè·å¾—è¿™ä¸ªè®¢é˜…ç¨‹åºä¼ æ¥çš„ä¿¡æ¯ï¼Œè¿›è¡Œåˆ é™¤ç¼“å­˜æ“ä½œã€‚</p><h5 id="åŸºäºè®¢é˜…binlogçš„åŒæ­¥æœºåˆ¶"><a href="#åŸºäºè®¢é˜…binlogçš„åŒæ­¥æœºåˆ¶" class="headerlink" title="åŸºäºè®¢é˜…binlogçš„åŒæ­¥æœºåˆ¶"></a>åŸºäºè®¢é˜…binlogçš„åŒæ­¥æœºåˆ¶</h5><p><img src="https://cdn.nlark.com/yuque/0/2023/png/35838370/1682779118663-d1ce53ca-9fdb-4552-89cc-0f3b181677a5.png" alt="img"><strong>æŠ€æœ¯æ•´ä½“æ€è·¯</strong>ï¼š</p><p>MySQL binlogå¢é‡è®¢é˜…æ¶ˆè´¹+æ¶ˆæ¯é˜Ÿåˆ—+å¢é‡æ•°æ®æ›´æ–°åˆ°redis</p><p>1ï¼‰è¯»Redisï¼šçƒ­æ•°æ®åŸºæœ¬éƒ½åœ¨Redis</p><p>2ï¼‰å†™MySQL: å¢åˆ æ”¹éƒ½æ˜¯æ“ä½œMySQL</p><p>3ï¼‰æ›´æ–°Redisæ•°æ®ï¼šMySQçš„æ•°æ®æ“ä½œbinlogï¼Œæ¥æ›´æ–°åˆ°Redis</p><p><strong>Redisæ›´æ–°</strong></p><p>1ï¼‰<strong>æ•°æ®æ“ä½œ</strong>ä¸»è¦åˆ†ä¸ºä¸¤å¤§å—ï¼š</p><ul><li>ä¸€ä¸ªæ˜¯å…¨é‡(å°†å…¨éƒ¨æ•°æ®ä¸€æ¬¡å†™å…¥åˆ°redis)</li><li>ä¸€ä¸ªæ˜¯å¢é‡ï¼ˆå®æ—¶æ›´æ–°ï¼‰</li></ul><p>è¿™é‡Œè¯´çš„æ˜¯å¢é‡,æŒ‡çš„æ˜¯mysqlçš„updateã€insertã€delateå˜æ›´æ•°æ®ã€‚</p><p>2ï¼‰<strong>è¯»å–binlogååˆ†æ ï¼Œåˆ©ç”¨æ¶ˆæ¯é˜Ÿåˆ—,æ¨é€æ›´æ–°å„å°çš„redisç¼“å­˜æ•°æ®</strong>ã€‚</p><p>è¿™æ ·ä¸€æ—¦MySQLä¸­äº§ç”Ÿäº†æ–°çš„å†™å…¥ã€æ›´æ–°ã€åˆ é™¤ç­‰æ“ä½œï¼Œå°±å¯ä»¥æŠŠbinlogç›¸å…³çš„æ¶ˆæ¯æ¨é€è‡³Redisï¼ŒRediså†æ ¹æ®binlogä¸­çš„è®°å½•ï¼Œå¯¹Redisè¿›è¡Œæ›´æ–°ã€‚</p><p>å…¶å®è¿™ç§æœºåˆ¶ï¼Œå¾ˆç±»ä¼¼MySQLçš„ä¸»ä»å¤‡ä»½æœºåˆ¶ï¼Œå› ä¸ºMySQLçš„ä¸»å¤‡ä¹Ÿæ˜¯é€šè¿‡binlogæ¥å®ç°çš„æ•°æ®ä¸€è‡´æ€§ã€‚</p><p>è¿™é‡Œå¯ä»¥ç»“åˆä½¿ç”¨canal(é˜¿é‡Œçš„ä¸€æ¬¾å¼€æºæ¡†æ¶)ï¼Œé€šè¿‡è¯¥æ¡†æ¶å¯ä»¥å¯¹MySQLçš„binlogè¿›è¡Œè®¢é˜…ï¼Œè€Œcanalæ­£æ˜¯æ¨¡ä»¿äº†mysqlçš„slaveæ•°æ®åº“çš„å¤‡ä»½è¯·æ±‚ï¼Œä½¿å¾—Redisçš„æ•°æ®æ›´æ–°è¾¾åˆ°äº†ç›¸åŒçš„æ•ˆæœã€‚</p><p>å½“ç„¶ï¼Œè¿™é‡Œçš„æ¶ˆæ¯æ¨é€å·¥å…·ä½ ä¹Ÿå¯ä»¥é‡‡ç”¨åˆ«çš„ç¬¬ä¸‰æ–¹ï¼škafkaã€rabbitMQç­‰æ¥å®ç°æ¨é€æ›´æ–°Redisã€‚</p><h3 id="3-2-ç¼“å­˜é›ªå´©ã€ç©¿é€ã€å‡»ç©¿ã€æ±¡æŸ“"><a href="#3-2-ç¼“å­˜é›ªå´©ã€ç©¿é€ã€å‡»ç©¿ã€æ±¡æŸ“" class="headerlink" title="3.2 ç¼“å­˜é›ªå´©ã€ç©¿é€ã€å‡»ç©¿ã€æ±¡æŸ“"></a>3.2 ç¼“å­˜é›ªå´©ã€ç©¿é€ã€å‡»ç©¿ã€æ±¡æŸ“</h3><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1683633583708-42a49740-34d1-42e6-a6e8-8489be91fc87.png" alt="img"></p><h4 id="3-2-1-ç¼“å­˜é›ªå´©"><a href="#3-2-1-ç¼“å­˜é›ªå´©" class="headerlink" title="3.2.1 ç¼“å­˜é›ªå´©"></a>3.2.1 ç¼“å­˜é›ªå´©</h4><p>å¯¹äºç³»ç»Ÿ Aï¼Œå‡è®¾æ¯å¤©é«˜å³°æœŸæ¯ç§’ 5000 ä¸ªè¯·æ±‚ï¼Œæœ¬æ¥ç¼“å­˜åœ¨é«˜å³°æœŸå¯ä»¥æ‰›ä½æ¯ç§’ 4000 ä¸ªè¯·æ±‚ï¼Œä½†æ˜¯ç¼“å­˜æœºå™¨æ„å¤–å‘ç”Ÿäº†å…¨ç›˜å®•æœºã€‚ç¼“å­˜æŒ‚äº†ï¼Œæ­¤æ—¶ 1 ç§’ 5000 ä¸ªè¯·æ±‚å…¨éƒ¨è½æ•°æ®åº“ï¼Œæ•°æ®åº“å¿…ç„¶æ‰›ä¸ä½ï¼Œå®ƒä¼šæŠ¥ä¸€ä¸‹è­¦ï¼Œç„¶åå°±æŒ‚äº†ã€‚æ­¤æ—¶ï¼Œå¦‚æœæ²¡æœ‰é‡‡ç”¨ä»€ä¹ˆç‰¹åˆ«çš„æ–¹æ¡ˆæ¥å¤„ç†è¿™ä¸ªæ•…éšœï¼ŒDBA å¾ˆç€æ€¥ï¼Œé‡å¯æ•°æ®åº“ï¼Œä½†æ˜¯æ•°æ®åº“ç«‹é©¬åˆè¢«æ–°çš„æµé‡ç»™æ‰“æ­»äº†ã€‚æˆ–è€…ç¼“å­˜ä¸­ æ•°æ®å¤§æ‰¹é‡åˆ°è¿‡æœŸæ—¶é—´ï¼Œå¤§æ‰¹é‡æ•°æ®åŒæ—¶æŸ¥è¯¢æ•°æ®åº“ï¼Œå¼•èµ·æ•°æ®åº“å‹åŠ›è¿‡å¤§ç”šè‡³å®•æœºã€‚</p><p>è¿™å°±æ˜¯ç¼“å­˜é›ªå´©ã€‚</p><p><a href="https://github.com/doocs/advanced-java/blob/main/docs/high-concurrency/images/redis-caching-avalanche.png"><img src="https://github.com/doocs/advanced-java/raw/main/docs/high-concurrency/images/redis-caching-avalanche.png" alt="img"></a></p><p>å¤§çº¦åœ¨ 3 å¹´å‰ï¼Œå›½å†…æ¯”è¾ƒçŸ¥åçš„ä¸€ä¸ªäº’è”ç½‘å…¬å¸ï¼Œæ›¾å› ä¸ºç¼“å­˜äº‹æ•…ï¼Œå¯¼è‡´é›ªå´©ï¼Œåå°ç³»ç»Ÿå…¨éƒ¨å´©æºƒï¼Œäº‹æ•…ä»å½“å¤©ä¸‹åˆæŒç»­åˆ°æ™šä¸Šå‡Œæ™¨ 3~4 ç‚¹ï¼Œå…¬å¸æŸå¤±äº†å‡ åƒä¸‡ã€‚</p><p>ç¼“å­˜é›ªå´©çš„äº‹å‰äº‹ä¸­äº‹åçš„è§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼š</p><ul><li>äº‹å‰ï¼šRedis é«˜å¯ç”¨ï¼Œä¸»ä»+å“¨å…µï¼ŒRedis clusterï¼Œé¿å…å…¨ç›˜å´©æºƒã€‚</li><li>äº‹ä¸­ï¼šæœ¬åœ° ehcache ç¼“å­˜ + hystrix é™æµ&amp;é™çº§ï¼Œé¿å… MySQL è¢«æ‰“æ­»ã€‚</li><li>äº‹åï¼šRedis æŒä¹…åŒ–ï¼Œä¸€æ—¦é‡å¯ï¼Œè‡ªåŠ¨ä»ç£ç›˜ä¸ŠåŠ è½½æ•°æ®ï¼Œå¿«é€Ÿæ¢å¤ç¼“å­˜æ•°æ®ã€‚</li></ul><p>é™¤æ­¤ä¹‹å¤–å®é™…ä½¿ç”¨æ—¶ï¼š</p><ul><li>ç¼“å­˜æ•°æ®çš„è¿‡æœŸæ—¶é—´è®¾ç½®éšæœºï¼Œé˜²æ­¢åŒä¸€æ—¶é—´å¤§é‡æ•°æ®è¿‡æœŸç°è±¡å‘ç”Ÿã€‚</li><li>å¦‚æœç¼“å­˜æ•°æ®åº“æ˜¯åˆ†å¸ƒå¼éƒ¨ç½²ï¼Œå°†çƒ­ç‚¹æ•°æ®å‡åŒ€åˆ†å¸ƒåœ¨ä¸åŒçš„ç¼“å­˜æ•°æ®åº“ä¸­ã€‚</li><li>çƒ­ç‚¹æ•°æ®çš„è¿‡æœŸæ—¶é—´å°½é‡è®¾ç½®é•¿</li></ul><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/redis-caching-avalanche-solution.png" alt="img"></p><p>ç”¨æˆ·å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œç³»ç»Ÿ A æ”¶åˆ°è¯·æ±‚åï¼Œå…ˆæŸ¥æœ¬åœ° ehcache ç¼“å­˜ï¼Œå¦‚æœæ²¡æŸ¥åˆ°å†æŸ¥ Redisã€‚å¦‚æœ ehcache å’Œ Redis éƒ½æ²¡æœ‰ï¼Œå†æŸ¥æ•°æ®åº“ï¼Œå°†æ•°æ®åº“ä¸­çš„ç»“æœï¼Œå†™å…¥ ehcache å’Œ Redis ä¸­ã€‚</p><p>é™æµç»„ä»¶ï¼Œå¯ä»¥è®¾ç½®æ¯ç§’çš„è¯·æ±‚ï¼Œæœ‰å¤šå°‘èƒ½é€šè¿‡ç»„ä»¶ï¼Œå‰©ä½™çš„æœªé€šè¿‡çš„è¯·æ±‚ï¼Œæ€ä¹ˆåŠï¼Ÿ<strong>èµ°é™çº§</strong>ï¼å¯ä»¥è¿”å›ä¸€äº›é»˜è®¤çš„å€¼ï¼Œæˆ–è€…å‹æƒ…æç¤ºï¼Œæˆ–è€…ç©ºå€¼ã€‚</p><p>å¥½å¤„ï¼š</p><ul><li>æ•°æ®åº“ç»å¯¹ä¸ä¼šæ­»ï¼Œé™æµç»„ä»¶ç¡®ä¿äº†æ¯ç§’åªæœ‰å¤šå°‘ä¸ªè¯·æ±‚èƒ½é€šè¿‡ã€‚</li><li>åªè¦æ•°æ®åº“ä¸æ­»ï¼Œå°±æ˜¯è¯´ï¼Œå¯¹ç”¨æˆ·æ¥è¯´ï¼Œ2&#x2F;5 çš„è¯·æ±‚éƒ½æ˜¯å¯ä»¥è¢«å¤„ç†çš„ã€‚</li><li>åªè¦æœ‰ 2&#x2F;5 çš„è¯·æ±‚å¯ä»¥è¢«å¤„ç†ï¼Œå°±æ„å‘³ç€ä½ çš„ç³»ç»Ÿæ²¡æ­»ï¼Œå¯¹ç”¨æˆ·æ¥è¯´ï¼Œå¯èƒ½å°±æ˜¯ç‚¹å‡»å‡ æ¬¡åˆ·ä¸å‡ºæ¥é¡µé¢ï¼Œä½†æ˜¯å¤šç‚¹å‡ æ¬¡ï¼Œå°±å¯ä»¥åˆ·å‡ºæ¥äº†ã€‚</li></ul><h4 id="3-2-2-ç¼“å­˜ç©¿é€"><a href="#3-2-2-ç¼“å­˜ç©¿é€" class="headerlink" title="3.2.2 ç¼“å­˜ç©¿é€"></a>3.2.2 ç¼“å­˜ç©¿é€</h4><p>å¯¹äºç³»ç»Ÿ Aï¼Œå‡è®¾ä¸€ç§’ 5000 ä¸ªè¯·æ±‚ï¼Œç»“æœå…¶ä¸­ 4000 ä¸ªè¯·æ±‚æ˜¯é»‘å®¢å‘å‡ºçš„æ¶æ„æ”»å‡»ã€‚</p><p>é»‘å®¢å‘å‡ºçš„é‚£ 4000 ä¸ªæ”»å‡»ï¼Œç¼“å­˜ä¸­æŸ¥ä¸åˆ°ï¼Œæ¯æ¬¡ä½ å»æ•°æ®åº“é‡ŒæŸ¥ï¼Œä¹ŸæŸ¥ä¸åˆ°ã€‚</p><p>ä¸¾ä¸ªæ —å­ã€‚æ•°æ®åº“ id æ˜¯ä» 1 å¼€å§‹çš„ï¼Œç»“æœé»‘å®¢å‘è¿‡æ¥çš„è¯·æ±‚ id å…¨éƒ¨éƒ½æ˜¯è´Ÿæ•°ã€‚è¿™æ ·çš„è¯ï¼Œç¼“å­˜ä¸­ä¸ä¼šæœ‰ï¼Œè¯·æ±‚æ¯æ¬¡éƒ½â€œ<strong>è§†ç¼“å­˜äºæ— ç‰©</strong>â€ï¼Œç›´æ¥æŸ¥è¯¢æ•°æ®åº“ã€‚è¿™ç§æ¶æ„æ”»å‡»åœºæ™¯çš„ç¼“å­˜ç©¿é€å°±ä¼šç›´æ¥æŠŠæ•°æ®åº“ç»™æ‰“æ­»ã€‚</p><p><a href="https://github.com/doocs/advanced-java/blob/main/docs/high-concurrency/images/redis-caching-penetration.png"><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/redis-caching-penetration.png" alt="img"></a></p><p>è§£å†³æ–¹æ¡ˆï¼š</p><ul><li>è®¾ç½®ç©ºå€¼è§£å†³æ–¹å¼å¾ˆç®€å•ï¼Œæ¯æ¬¡ç³»ç»Ÿ A ä»æ•°æ®åº“ä¸­åªè¦æ²¡æŸ¥åˆ°ï¼Œå°±å†™ä¸€ä¸ªç©ºå€¼åˆ°ç¼“å­˜é‡Œå»ï¼Œæ¯”å¦‚ set -999 UNKNOWN ã€‚ç„¶åè®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œè¿™æ ·çš„è¯ï¼Œä¸‹æ¬¡æœ‰ç›¸åŒçš„ key æ¥è®¿é—®çš„æ—¶å€™ï¼Œåœ¨ç¼“å­˜å¤±æ•ˆä¹‹å‰ï¼Œéƒ½å¯ä»¥ç›´æ¥ä»ç¼“å­˜ä¸­å–æ•°æ®ã€‚</li></ul><p><a href="https://github.com/doocs/advanced-java/blob/main/docs/high-concurrency/images/redis-caching-avoid-penetration.png"><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/redis-caching-avoid-penetration.png" alt="img"></a></p><ul><li><p>å¸ƒéš†è¿‡æ»¤å™¨ã€‚å½“ç„¶ï¼Œå¦‚æœé»‘å®¢å¦‚æœæ¯æ¬¡ä½¿ç”¨ä¸åŒçš„è´Ÿæ•° id æ¥æ”»å‡»ï¼Œå†™ç©ºå€¼çš„æ–¹æ³•å¯èƒ½å°±ä¸å¥æ•ˆäº†ã€‚æ›´ä¸ºç»å¸¸çš„åšæ³•æ˜¯åœ¨ç¼“å­˜ä¹‹å‰å¢åŠ å¸ƒéš†è¿‡æ»¤å™¨ï¼Œå°†æ•°æ®åº“ä¸­æ‰€æœ‰å¯èƒ½çš„æ•°æ®å“ˆå¸Œæ˜ å°„åˆ°å¸ƒéš†è¿‡æ»¤å™¨ä¸­ã€‚ç„¶åå¯¹æ¯ä¸ªè¯·æ±‚è¿›è¡Œå¦‚ä¸‹åˆ¤æ–­ï¼šä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨èƒ½å¤Ÿå¯¹è®¿é—®çš„è¯·æ±‚èµ·åˆ°äº†ä¸€å®šçš„åˆç­›ä½œç”¨ï¼Œé¿å…äº†å› æ•°æ®ä¸å­˜åœ¨å¼•èµ·çš„æŸ¥è¯¢å‹åŠ›ã€‚</p></li><li><ul><li>è¯·æ±‚æ•°æ®çš„ key ä¸å­˜åœ¨äºå¸ƒéš†è¿‡æ»¤å™¨ä¸­ï¼Œå¯ä»¥ç¡®å®šæ•°æ®å°±ä¸€å®šä¸ä¼šå­˜åœ¨äºæ•°æ®åº“ä¸­ï¼Œç³»ç»Ÿå¯ä»¥ç«‹å³è¿”å›ä¸å­˜åœ¨ã€‚</li><li>è¯·æ±‚æ•°æ®çš„ key å­˜åœ¨äºå¸ƒéš†è¿‡æ»¤å™¨ä¸­ï¼Œåˆ™ç»§ç»­å†å‘ç¼“å­˜ä¸­æŸ¥è¯¢ã€‚</li></ul></li><li><p>Keyæ ¡éªŒå¯¹æ‰€æœ‰å¯èƒ½æŸ¥è¯¢çš„å‚æ•°ä»¥hashå½¢å¼å­˜å‚¨ï¼Œåœ¨æ§åˆ¶å±‚å…ˆè¿›è¡Œæ ¡éªŒï¼Œä¸ç¬¦åˆåˆ™ä¸¢å¼ƒã€‚</p></li></ul><h4 id="3-2-3-ç¼“å­˜å‡»ç©¿"><a href="#3-2-3-ç¼“å­˜å‡»ç©¿" class="headerlink" title="3.2.3 ç¼“å­˜å‡»ç©¿"></a>3.2.3 ç¼“å­˜å‡»ç©¿</h4><p>ç¼“å­˜å‡»ç©¿ï¼Œå°±æ˜¯è¯´æŸä¸ª key éå¸¸çƒ­ç‚¹ï¼Œè®¿é—®éå¸¸é¢‘ç¹ï¼Œå¤„äºé›†ä¸­å¼é«˜å¹¶å‘è®¿é—®çš„æƒ…å†µï¼Œå½“è¿™ä¸ª key åœ¨å¤±æ•ˆçš„ç¬é—´ï¼Œå¤§é‡çš„è¯·æ±‚å°±å‡»ç©¿äº†ç¼“å­˜ï¼Œç›´æ¥è¯·æ±‚æ•°æ®åº“ï¼Œå°±åƒæ˜¯åœ¨ä¸€é“å±éšœä¸Šå‡¿å¼€äº†ä¸€ä¸ªæ´ã€‚</p><p>ä¸åŒåœºæ™¯ä¸‹çš„è§£å†³æ–¹å¼å¯å¦‚ä¸‹ï¼š</p><ul><li>è‹¥ç¼“å­˜çš„æ•°æ®æ˜¯åŸºæœ¬ä¸ä¼šå‘ç”Ÿæ›´æ–°çš„ï¼Œåˆ™å¯å°è¯•å°†è¯¥çƒ­ç‚¹æ•°æ®è®¾ç½®ä¸ºæ°¸ä¸è¿‡æœŸã€‚</li><li>è‹¥ç¼“å­˜çš„æ•°æ®æ›´æ–°ä¸é¢‘ç¹ï¼Œä¸”ç¼“å­˜åˆ·æ–°çš„æ•´ä¸ªæµç¨‹è€—æ—¶è¾ƒå°‘çš„æƒ…å†µä¸‹ï¼Œåˆ™å¯ä»¥é‡‡ç”¨åŸºäº Redisã€zookeeper ç­‰åˆ†å¸ƒå¼ä¸­é—´ä»¶çš„åˆ†å¸ƒå¼äº’æ–¥é”ï¼Œæˆ–è€…æœ¬åœ°äº’æ–¥é”ä»¥ä¿è¯ä»…å°‘é‡çš„è¯·æ±‚èƒ½è¯·æ±‚æ•°æ®åº“å¹¶é‡æ–°æ„å»ºç¼“å­˜ï¼Œå…¶ä½™çº¿ç¨‹åˆ™åœ¨é”é‡Šæ”¾åèƒ½è®¿é—®åˆ°æ–°ç¼“å­˜ã€‚åœ¨ç¼“å­˜å¤±æ•ˆåï¼Œé€šè¿‡åŠ é”æˆ–è€…é˜Ÿåˆ—æ¥æ§åˆ¶è¯»æ•°æ®åº“å†™ç¼“å­˜çš„çº¿ç¨‹æ•°é‡ã€‚æ¯”å¦‚å¯¹æŸä¸ªkeyåªå…è®¸ä¸€ä¸ªçº¿ç¨‹æŸ¥è¯¢æ•°æ®å’Œå†™ç¼“å­˜ï¼Œå…¶ä»–çº¿ç¨‹ç­‰å¾…ã€‚</li><li>è‹¥ç¼“å­˜çš„æ•°æ®æ›´æ–°é¢‘ç¹æˆ–è€…åœ¨ç¼“å­˜åˆ·æ–°çš„æµç¨‹è€—æ—¶è¾ƒé•¿çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥åˆ©ç”¨å®šæ—¶çº¿ç¨‹åœ¨ç¼“å­˜è¿‡æœŸå‰ä¸»åŠ¨åœ°é‡æ–°æ„å»ºç¼“å­˜æˆ–è€…å»¶åç¼“å­˜çš„è¿‡æœŸæ—¶é—´ï¼Œä»¥ä¿è¯æ‰€æœ‰çš„è¯·æ±‚èƒ½ä¸€ç›´è®¿é—®åˆ°å¯¹åº”çš„ç¼“å­˜ã€‚</li></ul><h4 id="3-2-4-ç¼“å­˜æ±¡æŸ“"><a href="#3-2-4-ç¼“å­˜æ±¡æŸ“" class="headerlink" title="3.2.4 ç¼“å­˜æ±¡æŸ“"></a>3.2.4 ç¼“å­˜æ±¡æŸ“</h4><p>ç¼“å­˜æ±¡æŸ“é—®é¢˜è¯´çš„æ˜¯ç¼“å­˜ä¸­ä¸€äº›åªä¼šè¢«è®¿é—®ä¸€æ¬¡æˆ–è€…å‡ æ¬¡çš„çš„æ•°æ®ï¼Œè¢«è®¿é—®å®Œåï¼Œå†ä¹Ÿä¸ä¼šè¢«è®¿é—®åˆ°ï¼Œä½†è¿™éƒ¨åˆ†æ•°æ®ä¾ç„¶ç•™å­˜åœ¨ç¼“å­˜ä¸­ï¼Œæ¶ˆè€—ç¼“å­˜ç©ºé—´ã€‚</p><p>ç¼“å­˜æ±¡æŸ“ä¼šéšç€æ•°æ®çš„æŒç»­å¢åŠ è€Œé€æ¸æ˜¾éœ²ï¼Œéšç€æœåŠ¡çš„ä¸æ–­è¿è¡Œï¼Œç¼“å­˜ä¸­ä¼šå­˜åœ¨å¤§é‡çš„æ°¸è¿œä¸ä¼šå†æ¬¡è¢«è®¿é—®çš„æ•°æ®ã€‚ç¼“å­˜ç©ºé—´æ˜¯æœ‰é™çš„ï¼Œå¦‚æœç¼“å­˜ç©ºé—´æ»¡äº†ï¼Œå†å¾€ç¼“å­˜é‡Œå†™æ•°æ®æ—¶å°±ä¼šæœ‰é¢å¤–å¼€é”€ï¼Œå½±å“Redisæ€§èƒ½ã€‚è¿™éƒ¨åˆ†é¢å¤–å¼€é”€ä¸»è¦æ˜¯æŒ‡å†™çš„æ—¶å€™åˆ¤æ–­æ·˜æ±°ç­–ç•¥ï¼Œæ ¹æ®æ·˜æ±°ç­–ç•¥å»é€‰æ‹©è¦æ·˜æ±°çš„æ•°æ®ï¼Œç„¶åè¿›è¡Œåˆ é™¤æ“ä½œã€‚</p><h5 id="ç¼“å­˜æ·˜æ±°ç­–ç•¥"><a href="#ç¼“å­˜æ·˜æ±°ç­–ç•¥" class="headerlink" title="ç¼“å­˜æ·˜æ±°ç­–ç•¥"></a>ç¼“å­˜æ·˜æ±°ç­–ç•¥</h5><p>Rediså…±æ”¯æŒå…«ç§æ·˜æ±°ç­–ç•¥ï¼Œåˆ†åˆ«æ˜¯noevictionã€volatile-randomã€volatile-ttlã€volatile-lruã€volatile-lfuã€allkeys-lruã€allkeys-random å’Œ allkeys-lfu ç­–ç•¥ã€‚</p><p><strong>æ€ä¹ˆç†è§£å‘¢</strong>ï¼Ÿä¸»è¦çœ‹åˆ†ä¸‰ç±»çœ‹ï¼š</p><ul><li><p>ä¸æ·˜æ±° </p></li><li><ul><li>noeviction ï¼ˆv4.0åé»˜è®¤çš„ï¼‰</li></ul></li><li><p>å¯¹è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„æ•°æ®ä¸­è¿›è¡Œæ·˜æ±° </p></li><li><ul><li>éšæœºï¼švolatile-random</li><li>ttlï¼švolatile-ttl</li><li>lruï¼švolatile-lru</li><li>lfuï¼švolatile-lfu</li></ul></li><li><p>å…¨éƒ¨æ•°æ®è¿›è¡Œæ·˜æ±° </p></li><li><ul><li>éšæœºï¼šallkeys-random</li><li>lruï¼šallkeys-lru</li><li>lfuï¼šallkeys-lfu</li></ul></li></ul><ol><li>noevictionè¯¥ç­–ç•¥æ˜¯Redisçš„é»˜è®¤ç­–ç•¥ã€‚åœ¨è¿™ç§ç­–ç•¥ä¸‹ï¼Œä¸€æ—¦ç¼“å­˜è¢«å†™æ»¡äº†ï¼Œå†æœ‰å†™è¯·æ±‚æ¥æ—¶ï¼ŒRedis ä¸å†æä¾›æœåŠ¡ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›é”™è¯¯ã€‚è¿™ç§ç­–ç•¥ä¸ä¼šæ·˜æ±°æ•°æ®ï¼Œæ‰€ä»¥æ— æ³•è§£å†³ç¼“å­˜æ±¡æŸ“é—®é¢˜ã€‚ä¸€èˆ¬ç”Ÿäº§ç¯å¢ƒä¸å»ºè®®ä½¿ç”¨ã€‚å…¶ä»–ä¸ƒç§è§„åˆ™éƒ½ä¼šæ ¹æ®è‡ªå·±ç›¸åº”çš„è§„åˆ™æ¥é€‰æ‹©æ•°æ®è¿›è¡Œåˆ é™¤æ“ä½œã€‚</li><li>volatile-randomã€‚è¿™ä¸ªç®—æ³•æ¯”è¾ƒç®€å•ï¼Œåœ¨è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®å€¼å¯¹ä¸­ï¼Œè¿›è¡Œéšæœºåˆ é™¤ã€‚å› ä¸ºæ˜¯éšæœºåˆ é™¤ï¼Œæ— æ³•æŠŠä¸å†è®¿é—®çš„æ•°æ®ç­›é€‰å‡ºæ¥ï¼Œæ‰€ä»¥å¯èƒ½ä¾ç„¶ä¼šå­˜åœ¨ç¼“å­˜æ±¡æŸ“ç°è±¡ï¼Œæ— æ³•è§£å†³ç¼“å­˜æ±¡æŸ“é—®é¢˜ã€‚</li><li>volatile-ttlã€‚è¿™ç§ç®—æ³•åˆ¤æ–­æ·˜æ±°æ•°æ®æ—¶å‚è€ƒçš„æŒ‡æ ‡æ¯”éšæœºåˆ é™¤æ—¶å¤šè¿›è¡Œä¸€æ­¥è¿‡æœŸæ—¶é—´çš„æ’åºã€‚Redisåœ¨ç­›é€‰éœ€åˆ é™¤çš„æ•°æ®æ—¶ï¼Œè¶Šæ—©è¿‡æœŸçš„æ•°æ®è¶Šä¼˜å…ˆè¢«é€‰æ‹©ã€‚</li><li>volatile-lruã€‚LRUç®—æ³•ï¼šLRU ç®—æ³•çš„å…¨ç§°æ˜¯ Least Recently Usedï¼ŒæŒ‰ç…§æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„åŸåˆ™æ¥ç­›é€‰æ•°æ®ã€‚è¿™ç§æ¨¡å¼ä¸‹ä¼šä½¿ç”¨ LRU ç®—æ³•ç­›é€‰è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®å€¼å¯¹ã€‚Redisä¼˜åŒ–çš„ <strong>LRUç®—æ³•å®ç°</strong>ï¼šRedisä¼šè®°å½•æ¯ä¸ªæ•°æ®çš„æœ€è¿‘ä¸€æ¬¡è¢«è®¿é—®çš„æ—¶é—´æˆ³ã€‚åœ¨Redisåœ¨å†³å®šæ·˜æ±°çš„æ•°æ®æ—¶ï¼Œç¬¬ä¸€æ¬¡ä¼šéšæœºé€‰å‡º N ä¸ªæ•°æ®ï¼ŒæŠŠå®ƒä»¬ä½œä¸ºä¸€ä¸ªå€™é€‰é›†åˆã€‚æ¥ä¸‹æ¥ï¼ŒRedis ä¼šæ¯”è¾ƒè¿™ N ä¸ªæ•°æ®çš„ lru å­—æ®µï¼ŒæŠŠ lru å­—æ®µå€¼æœ€å°çš„æ•°æ®ä»ç¼“å­˜ä¸­æ·˜æ±°å‡ºå»ã€‚é€šè¿‡éšæœºè¯»å–å¾…åˆ é™¤é›†åˆï¼Œå¯ä»¥è®©Redisä¸ç”¨ç»´æŠ¤ä¸€ä¸ªå·¨å¤§çš„é“¾è¡¨ï¼Œä¹Ÿä¸ç”¨æ“ä½œé“¾è¡¨ï¼Œè¿›è€Œæå‡æ€§èƒ½ã€‚Redis é€‰å‡ºçš„æ•°æ®ä¸ªæ•° Nï¼Œé€šè¿‡ é…ç½®å‚æ•° maxmemory-samples è¿›è¡Œé…ç½®ã€‚ä¸ªæ•°Nè¶Šå¤§ï¼Œåˆ™å€™é€‰é›†åˆè¶Šå¤§ï¼Œé€‰æ‹©åˆ°çš„æœ€ä¹…æœªè¢«ä½¿ç”¨çš„å°±æ›´å‡†ç¡®ï¼ŒNè¶Šå°ï¼Œé€‰æ‹©åˆ°æœ€ä¹…æœªè¢«ä½¿ç”¨çš„æ•°æ®çš„æ¦‚ç‡ä¹Ÿä¼šéšä¹‹å‡å°ã€‚</li><li>volatile-lfuã€‚ä¼šä½¿ç”¨ LFU ç®—æ³•é€‰æ‹©è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®å€¼å¯¹ã€‚<strong>LFU ç®—æ³•</strong>ï¼šLFU ç¼“å­˜ç­–ç•¥æ˜¯åœ¨ LRU ç­–ç•¥åŸºç¡€ä¸Šï¼Œä¸ºæ¯ä¸ªæ•°æ®å¢åŠ äº†ä¸€ä¸ªè®¡æ•°å™¨ï¼Œæ¥ç»Ÿè®¡è¿™ä¸ªæ•°æ®çš„è®¿é—®æ¬¡æ•°ã€‚å½“ä½¿ç”¨ LFU ç­–ç•¥ç­›é€‰æ·˜æ±°æ•°æ®æ—¶ï¼Œé¦–å…ˆä¼šæ ¹æ®æ•°æ®çš„è®¿é—®æ¬¡æ•°è¿›è¡Œç­›é€‰ï¼ŒæŠŠè®¿é—®æ¬¡æ•°æœ€ä½çš„æ•°æ®æ·˜æ±°å‡ºç¼“å­˜ã€‚å¦‚æœä¸¤ä¸ªæ•°æ®çš„è®¿é—®æ¬¡æ•°ç›¸åŒï¼ŒLFU ç­–ç•¥å†æ¯”è¾ƒè¿™ä¸¤ä¸ªæ•°æ®çš„è®¿é—®æ—¶æ•ˆæ€§ï¼ŒæŠŠè·ç¦»ä¸Šä¸€æ¬¡è®¿é—®æ—¶é—´æ›´ä¹…çš„æ•°æ®æ·˜æ±°å‡ºç¼“å­˜ã€‚ Redisçš„LFUç®—æ³•å®ç°:å½“ LFU ç­–ç•¥ç­›é€‰æ•°æ®æ—¶ï¼ŒRedis ä¼šåœ¨å€™é€‰é›†åˆä¸­ï¼Œæ ¹æ®æ•°æ® lru å­—æ®µçš„å 8bit é€‰æ‹©è®¿é—®æ¬¡æ•°æœ€å°‘çš„æ•°æ®è¿›è¡Œæ·˜æ±°ã€‚å½“è®¿é—®æ¬¡æ•°ç›¸åŒæ—¶ï¼Œå†æ ¹æ® lru å­—æ®µçš„å‰ 16bit å€¼å¤§å°ï¼Œé€‰æ‹©è®¿é—®æ—¶é—´æœ€ä¹…è¿œçš„æ•°æ®è¿›è¡Œæ·˜æ±°ã€‚Redis åªä½¿ç”¨äº† 8bit è®°å½•æ•°æ®çš„è®¿é—®æ¬¡æ•°ï¼Œè€Œ 8bit è®°å½•çš„æœ€å¤§å€¼æ˜¯ 255ï¼Œè¿™æ ·åœ¨è®¿é—®å¿«é€Ÿçš„æƒ…å†µä¸‹ï¼Œå¦‚æœæ¯æ¬¡è¢«è®¿é—®å°±å°†è®¿é—®æ¬¡æ•°åŠ ä¸€ï¼Œå¾ˆå¿«æŸæ¡æ•°æ®å°±è¾¾åˆ°æœ€å¤§å€¼255ï¼Œå¯èƒ½å¾ˆå¤šæ•°æ®éƒ½æ˜¯255ï¼Œé‚£ä¹ˆé€€åŒ–æˆLRUç®—æ³•äº†ã€‚æ‰€ä»¥Redisä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ç°äº†ä¸€ä¸ªæ›´ä¼˜çš„è®¡æ•°è§„åˆ™ï¼Œå¹¶å¯ä»¥é€šè¿‡é…ç½®é¡¹ï¼Œæ¥æ§åˆ¶è®¡æ•°å™¨å¢åŠ çš„é€Ÿåº¦ã€‚<strong>å‚æ•°</strong> ï¼šlfu-log-factor ï¼Œç”¨è®¡æ•°å™¨å½“å‰çš„å€¼ä¹˜ä»¥é…ç½®é¡¹ lfu_log_factor å†åŠ  1ï¼Œå†å–å…¶å€’æ•°ï¼Œå¾—åˆ°ä¸€ä¸ª p å€¼ï¼›ç„¶åï¼ŒæŠŠè¿™ä¸ª p å€¼å’Œä¸€ä¸ªå–å€¼èŒƒå›´åœ¨ï¼ˆ0ï¼Œ1ï¼‰é—´çš„éšæœºæ•° r å€¼æ¯”å¤§å°ï¼Œåªæœ‰ p å€¼å¤§äº r å€¼æ—¶ï¼Œè®¡æ•°å™¨æ‰åŠ  1ã€‚lfu-decay-timeï¼Œ æ§åˆ¶è®¿é—®æ¬¡æ•°è¡°å‡ã€‚LFU ç­–ç•¥ä¼šè®¡ç®—å½“å‰æ—¶é—´å’Œæ•°æ®æœ€è¿‘ä¸€æ¬¡è®¿é—®æ—¶é—´çš„å·®å€¼ï¼Œå¹¶æŠŠè¿™ä¸ªå·®å€¼æ¢ç®—æˆä»¥åˆ†é’Ÿä¸ºå•ä½ã€‚ç„¶åï¼ŒLFU ç­–ç•¥å†æŠŠè¿™ä¸ªå·®å€¼é™¤ä»¥ lfu_decay_time å€¼ï¼Œæ‰€å¾—çš„ç»“æœå°±æ˜¯æ•°æ® counter è¦è¡°å‡çš„å€¼ã€‚lfu-log-factorè®¾ç½®è¶Šå¤§ï¼Œé€’å¢æ¦‚ç‡è¶Šä½ï¼Œlfu-decay-timeè®¾ç½®è¶Šå¤§ï¼Œè¡°å‡é€Ÿåº¦ä¼šè¶Šæ…¢ã€‚æˆ‘ä»¬åœ¨åº”ç”¨ LFU ç­–ç•¥æ—¶ï¼Œä¸€èˆ¬å¯ä»¥å°† lfu_log_factor å–å€¼ä¸º 10ã€‚ å¦‚æœä¸šåŠ¡åº”ç”¨ä¸­æœ‰çŸ­æ—¶é«˜é¢‘è®¿é—®çš„æ•°æ®çš„è¯ï¼Œå»ºè®®æŠŠ lfu_decay_time å€¼è®¾ç½®ä¸º 1ã€‚å¯ä»¥å¿«é€Ÿè¡°å‡è®¿é—®æ¬¡æ•°ã€‚volatile-lfu ç­–ç•¥æ˜¯ Redis 4.0 åæ–°å¢ã€‚</li><li><strong>allkeys-lru</strong>ä½¿ç”¨ LRU ç®—æ³•åœ¨æ‰€æœ‰æ•°æ®ä¸­è¿›è¡Œç­›é€‰ã€‚å…·ä½“LFUç®—æ³•è·Ÿä¸Šè¿° volatile-lru ä¸­ä»‹ç»çš„ä¸€è‡´ï¼Œåªæ˜¯ç­›é€‰çš„æ•°æ®èŒƒå›´æ˜¯å…¨éƒ¨ç¼“å­˜ï¼Œè¿™é‡Œå°±ä¸åœ¨é‡å¤ã€‚</li><li>allkeys-randomä»æ‰€æœ‰é”®å€¼å¯¹ä¸­éšæœºé€‰æ‹©å¹¶åˆ é™¤æ•°æ®ã€‚volatile-random è·Ÿ allkeys-randomç®—æ³•ä¸€æ ·ï¼Œéšæœºåˆ é™¤å°±æ— æ³•è§£å†³ç¼“å­˜æ±¡æŸ“é—®é¢˜ã€‚</li><li>allkeys-lfuä½¿ç”¨ LFU ç®—æ³•åœ¨æ‰€æœ‰æ•°æ®ä¸­è¿›è¡Œç­›é€‰ã€‚å…·ä½“LFUç®—æ³•è·Ÿä¸Šè¿° volatile-lfu ä¸­ä»‹ç»çš„ä¸€è‡´ï¼Œåªæ˜¯ç­›é€‰çš„æ•°æ®èŒƒå›´æ˜¯å…¨éƒ¨ç¼“å­˜ï¼Œè¿™é‡Œå°±ä¸åœ¨é‡å¤ã€‚</li></ol><p>allkeys-lfu ç­–ç•¥æ˜¯ Redis 4.0 åæ–°å¢ã€‚</p><h3 id="3-3-I-Oå¤šè·¯å¤ç”¨"><a href="#3-3-I-Oå¤šè·¯å¤ç”¨" class="headerlink" title="3.3 I&#x2F;Oå¤šè·¯å¤ç”¨"></a>3.3 I&#x2F;Oå¤šè·¯å¤ç”¨</h3><h4 id="3-3-1-æœ‰å“ªå‡ ç§I-Oæ¨¡å‹"><a href="#3-3-1-æœ‰å“ªå‡ ç§I-Oæ¨¡å‹" class="headerlink" title="3.3.1 æœ‰å“ªå‡ ç§I&#x2F;Oæ¨¡å‹"></a>3.3.1 æœ‰å“ªå‡ ç§I&#x2F;Oæ¨¡å‹</h4><p>ä¸ºä»€ä¹ˆ Redis ä¸­è¦ä½¿ç”¨ I&#x2F;O å¤šè·¯å¤ç”¨è¿™ç§æŠ€æœ¯å‘¢ï¼Ÿ</p><p>é¦–å…ˆï¼ŒRedis æ˜¯è·‘åœ¨å•çº¿ç¨‹ä¸­çš„ï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯æŒ‰ç…§é¡ºåºçº¿æ€§æ‰§è¡Œçš„ï¼Œä½†æ˜¯ç”±äºè¯»å†™æ“ä½œç­‰å¾…ç”¨æˆ·è¾“å…¥æˆ–è¾“å‡ºéƒ½æ˜¯é˜»å¡çš„ï¼Œæ‰€ä»¥ I&#x2F;O æ“ä½œåœ¨ä¸€èˆ¬æƒ…å†µä¸‹å¾€å¾€ä¸èƒ½ç›´æ¥è¿”å›ï¼Œè¿™ä¼šå¯¼è‡´æŸä¸€æ–‡ä»¶çš„ I&#x2F;O é˜»å¡å¯¼è‡´æ•´ä¸ªè¿›ç¨‹æ— æ³•å¯¹å…¶å®ƒå®¢æˆ·æä¾›æœåŠ¡ï¼Œè€Œ <strong>I&#x2F;O å¤šè·¯å¤ç”¨</strong>å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜è€Œå‡ºç°çš„ã€‚</p><ul><li><strong>Blocking I&#x2F;Oã€‚</strong>å…ˆæ¥çœ‹ä¸€ä¸‹ä¼ ç»Ÿçš„é˜»å¡ I&#x2F;O æ¨¡å‹åˆ°åº•æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼šå½“ä½¿ç”¨ read æˆ–è€… write å¯¹æŸä¸€ä¸ª**æ–‡ä»¶æè¿°ç¬¦ï¼ˆFile Descriptor ä»¥ä¸‹ç®€ç§° FD)**è¿›è¡Œè¯»å†™æ—¶ï¼Œå¦‚æœå½“å‰ FD ä¸å¯è¯»æˆ–ä¸å¯å†™ï¼Œæ•´ä¸ª Redis æœåŠ¡å°±ä¸ä¼šå¯¹å…¶å®ƒçš„æ“ä½œä½œå‡ºå“åº”ï¼Œå¯¼è‡´æ•´ä¸ªæœåŠ¡ä¸å¯ç”¨ã€‚è¿™ä¹Ÿå°±æ˜¯ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨ç¼–ç¨‹ä¸­ä½¿ç”¨æœ€å¤šçš„é˜»å¡æ¨¡å‹ã€‚ä½†æ˜¯ç”±äºå®ƒä¼šå½±å“å…¶ä»– FD å¯¹åº”çš„æœåŠ¡ï¼Œæ‰€ä»¥éœ€è¦å¤„ç†å¤šä¸ªå®¢æˆ·ç«¯ä»»åŠ¡çš„æ—¶å€™ï¼Œå¾€å¾€éƒ½ä¸ä¼šä½¿ç”¨é˜»å¡æ¨¡å‹ã€‚</li><li><strong>I&#x2F;Oå¤šè·¯å¤ç”¨ã€‚</strong>é˜»å¡å¼çš„ I&#x2F;O æ¨¡å‹å¹¶ä¸èƒ½æ»¡è¶³è¿™é‡Œçš„éœ€æ±‚ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æ•ˆç‡æ›´é«˜çš„ I&#x2F;O æ¨¡å‹æ¥æ”¯æ’‘ Redis çš„å¤šä¸ªå®¢æˆ·ï¼ˆredis-cliï¼‰ï¼Œè¿™é‡Œæ¶‰åŠçš„å°±æ˜¯ I&#x2F;O å¤šè·¯å¤ç”¨æ¨¡å‹äº†ã€‚åœ¨ I&#x2F;O å¤šè·¯å¤ç”¨æ¨¡å‹ä¸­ï¼Œæœ€é‡è¦çš„å‡½æ•°è°ƒç”¨å°±æ˜¯ selectï¼Œè¯¥æ–¹æ³•çš„èƒ½å¤ŸåŒæ—¶ç›‘æ§å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦çš„å¯è¯»å¯å†™æƒ…å†µï¼Œå½“å…¶ä¸­çš„æŸäº›æ–‡ä»¶æè¿°ç¬¦å¯è¯»æˆ–è€…å¯å†™æ—¶ï¼Œselect æ–¹æ³•å°±ä¼šè¿”å›å¯è¯»ä»¥åŠå¯å†™çš„æ–‡ä»¶æè¿°ç¬¦ä¸ªæ•°ã€‚ä¸æ­¤åŒæ—¶ä¹Ÿæœ‰å…¶å®ƒçš„ I&#x2F;O å¤šè·¯å¤ç”¨å‡½æ•° epoll&#x2F;kqueue&#x2F;evportï¼Œå®ƒä»¬ç›¸æ¯” select æ€§èƒ½æ›´ä¼˜ç§€ï¼ŒåŒæ—¶ä¹Ÿèƒ½æ”¯æ’‘æ›´å¤šçš„æœåŠ¡ã€‚</li></ul><h4 id="3-3-2-Reactorè®¾è®¡æ¨¡å¼"><a href="#3-3-2-Reactorè®¾è®¡æ¨¡å¼" class="headerlink" title="3.3.2 Reactorè®¾è®¡æ¨¡å¼"></a>3.3.2 Reactorè®¾è®¡æ¨¡å¼</h4><p>Redis æœåŠ¡é‡‡ç”¨ Reactor çš„æ–¹å¼æ¥å®ç°æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼ˆæ¯ä¸€ä¸ªç½‘ç»œè¿æ¥å…¶å®éƒ½å¯¹åº”ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼‰</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/35838370/1682779118964-d5b2cf6f-b475-4166-bbc7-fcdb1c5a8759.png" alt="img"></p><p>æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ä½¿ç”¨ I&#x2F;O å¤šè·¯å¤ç”¨æ¨¡å—åŒæ—¶ç›‘å¬å¤šä¸ª FDï¼Œå½“ acceptã€readã€write å’Œ close æ–‡ä»¶äº‹ä»¶äº§ç”Ÿæ—¶ï¼Œæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨å°±ä¼šå›è°ƒ FD ç»‘å®šçš„äº‹ä»¶å¤„ç†å™¨ã€‚</p><p>è™½ç„¶æ•´ä¸ªæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨æ˜¯åœ¨å•çº¿ç¨‹ä¸Šè¿è¡Œçš„ï¼Œä½†æ˜¯é€šè¿‡ I&#x2F;O å¤šè·¯å¤ç”¨æ¨¡å—çš„å¼•å…¥ï¼Œå®ç°äº†åŒæ—¶å¯¹å¤šä¸ª FD è¯»å†™çš„ç›‘æ§ï¼Œæé«˜äº†ç½‘ç»œé€šä¿¡æ¨¡å‹çš„æ€§èƒ½ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥ä¿è¯æ•´ä¸ª Redis æœåŠ¡å®ç°çš„ç®€å•ã€‚</p><h4 id="3-3-3-I-Oå¤šè·¯å¤ç”¨æ¨¡å—"><a href="#3-3-3-I-Oå¤šè·¯å¤ç”¨æ¨¡å—" class="headerlink" title="3.3.3 I&#x2F;Oå¤šè·¯å¤ç”¨æ¨¡å—"></a>3.3.3 I&#x2F;Oå¤šè·¯å¤ç”¨æ¨¡å—</h4><p>I&#x2F;O å¤šè·¯å¤ç”¨æ¨¡å—å°è£…äº†åº•å±‚çš„ selectã€epollã€avport ä»¥åŠ kqueue è¿™äº› I&#x2F;O å¤šè·¯å¤ç”¨å‡½æ•°ï¼Œä¸ºä¸Šå±‚æä¾›äº†ç›¸åŒçš„æ¥å£ã€‚</p><p>å› ä¸º Redis éœ€è¦åœ¨å¤šä¸ªå¹³å°ä¸Šè¿è¡Œï¼ŒåŒæ—¶ä¸ºäº†æœ€å¤§åŒ–æ‰§è¡Œçš„æ•ˆç‡ä¸æ€§èƒ½ï¼Œæ‰€ä»¥ä¼šæ ¹æ®ç¼–è¯‘å¹³å°çš„ä¸åŒé€‰æ‹©ä¸åŒçš„ I&#x2F;O å¤šè·¯å¤ç”¨å‡½æ•°ä½œä¸ºå­æ¨¡å—ï¼Œæä¾›ç»™ä¸Šå±‚ç»Ÿä¸€çš„æ¥å£ï¼›åœ¨ Redis ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡å®å®šä¹‰çš„ä½¿ç”¨ï¼Œåˆç†çš„é€‰æ‹©ä¸åŒçš„å­æ¨¡å—ã€‚</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779120227-db19f80f-4483-408b-8c31-bf41394af344.jpeg" alt="img"></p><p>Redis ä¼šä¼˜å…ˆé€‰æ‹©æ—¶é—´å¤æ‚åº¦ä¸º O(1) çš„ I&#x2F;O å¤šè·¯å¤ç”¨å‡½æ•°ä½œä¸ºåº•å±‚å®ç°ï¼ŒåŒ…æ‹¬ Solaries 10 ä¸­çš„ evportã€Linux ä¸­çš„ epoll å’Œ macOS&#x2F;FreeBSD ä¸­çš„ kqueueï¼Œä¸Šè¿°çš„è¿™äº›å‡½æ•°éƒ½ä½¿ç”¨äº†å†…æ ¸å†…éƒ¨çš„ç»“æ„ï¼Œå¹¶ä¸”èƒ½å¤ŸæœåŠ¡å‡ åä¸‡çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</p><p>ä½†æ˜¯å¦‚æœå½“å‰ç¼–è¯‘ç¯å¢ƒæ²¡æœ‰ä¸Šè¿°å‡½æ•°ï¼Œå°±ä¼šé€‰æ‹© select ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆï¼Œç”±äºå…¶åœ¨ä½¿ç”¨æ—¶ä¼šæ‰«æå…¨éƒ¨ç›‘å¬çš„æè¿°ç¬¦ï¼Œæ‰€ä»¥å…¶æ—¶é—´å¤æ‚åº¦è¾ƒå·® O(n)O(n)ï¼Œå¹¶ä¸”åªèƒ½åŒæ—¶æœåŠ¡ 1024 ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œæ‰€ä»¥ä¸€èˆ¬å¹¶ä¸ä¼šä»¥ select ä½œä¸ºç¬¬ä¸€æ–¹æ¡ˆä½¿ç”¨ã€‚</p><h3 id="3-4-è„‘è£‚é—®é¢˜"><a href="#3-4-è„‘è£‚é—®é¢˜" class="headerlink" title="3.4 è„‘è£‚é—®é¢˜"></a>3.4 è„‘è£‚é—®é¢˜</h3><p>å¦‚æœåœ¨ Redis ä¸­ï¼Œå½¢å¼ä¸Šå°±æ˜¯æœ‰äº†ä¸¤ä¸ª masterï¼Œè®°ä½äº†ä¸¤ä¸ª master æ‰æ˜¯è„‘è£‚çš„å‰æ</p><h4 id="3-4-1-å“¨å…µæ¨¡å¼ä¸‹çš„è„‘è£‚"><a href="#3-4-1-å“¨å…µæ¨¡å¼ä¸‹çš„è„‘è£‚" class="headerlink" title="3.4.1 å“¨å…µæ¨¡å¼ä¸‹çš„è„‘è£‚"></a>3.4.1 å“¨å…µæ¨¡å¼ä¸‹çš„è„‘è£‚</h4><p>1ä¸ª master ä¸ 3ä¸ª slaveç»„æˆçš„å“¨å…µæ¨¡å¼ï¼ˆå“¨å…µç‹¬ç«‹éƒ¨ç½²äºå…¶ä»–èŠ‚ç‚¹ï¼‰ã€‚ä¸¤ä¸ªå®¢æˆ·ç«¯ server1ã€server2 éƒ½è¿æ¥ä¸Šäº† masterã€‚ä½†æ˜¯å¦‚æœ master ä¸ slave åŠå“¨å…µä¹‹é—´ ç½‘ç»œå‘ç”Ÿäº†æ•…éšœï¼Œä½†æ˜¯å“¨å…µä¸slaveä¹‹é—´é€šè®¯æ­£å¸¸ï¼Œè¿™æ—¶3ä¸ªslaveå…¶ä¸­1ä¸ªç»è¿‡å“¨å…µæŠ•ç¥¨åï¼Œæå‡ä¸ºæ–°masterã€‚å¦‚æœæ°å¥½æ­¤æ—¶ server1 ä»ç„¶è¿æ¥çš„æ˜¯æ—§çš„masterï¼Œè€Œserver2è¿æ¥åˆ°äº†æ–°çš„masterã€‚</p><p>æ•°æ®å°±ä¸ä¸€è‡´äº†ï¼ŒåŸºäº setNX æŒ‡ä»¤çš„åˆ†å¸ƒå¼é”ï¼Œå¯èƒ½ä¼šæ‹¿åˆ°ç›¸åŒçš„é”ï¼›åŸºäº incr ç”Ÿæˆçš„å…¨å±€å”¯ä¸€ idï¼Œä¹Ÿå¯èƒ½å‡ºç°é‡å¤ã€‚</p><h4 id="3-4-2-cluster-æ¨¡å¼ä¸‹çš„è„‘è£‚"><a href="#3-4-2-cluster-æ¨¡å¼ä¸‹çš„è„‘è£‚" class="headerlink" title="3.4.2 cluster æ¨¡å¼ä¸‹çš„è„‘è£‚"></a>3.4.2 cluster æ¨¡å¼ä¸‹çš„è„‘è£‚</h4><p><img src="https://cdn.nlark.com/yuque/0/2023/png/35838370/1682779121684-93b3e741-7f57-49e9-b067-ea538dd0980b.png" alt="img"></p><p>cluster æ¨¡å¼ä¸‹ï¼Œè¿™ç§æƒ…å†µè¦æ›´å¤æ‚ï¼Œä¾‹å¦‚é›†ç¾¤ä¸­æœ‰ 6 ç»„åˆ†ç‰‡ï¼Œæ¯ç»™åˆ†ç‰‡èŠ‚ç‚¹éƒ½æœ‰ 1 ä¸» 1 ä»ï¼Œå¦‚æœå‡ºç°ç½‘ç»œåˆ†åŒºæ—¶ï¼Œå„ç§èŠ‚ç‚¹ä¹‹é—´çš„åˆ†åŒºç»„åˆéƒ½æœ‰å¯èƒ½ã€‚</p><h5 id="æ‰‹åŠ¨è§£å†³é—®é¢˜"><a href="#æ‰‹åŠ¨è§£å†³é—®é¢˜" class="headerlink" title="æ‰‹åŠ¨è§£å†³é—®é¢˜"></a>æ‰‹åŠ¨è§£å†³é—®é¢˜</h5><p>åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œå¦‚æœ master æŒ‚äº†ï¼Œé‚£ä¹ˆå†™å…¥å°±ä¼šå¤±è´¥ï¼Œå¦‚æœæ˜¯æ‰‹åŠ¨è§£å†³ï¼Œé‚£ä¹ˆäººä¸ºä¼šæ£€æµ‹ master ä»¥åŠ slave çš„ç½‘ç»œçŠ¶å†µï¼Œç„¶åè§†æƒ…å†µï¼Œå¦‚æœæ˜¯ master æŒ‚äº†ï¼Œé‡å¯ masterï¼Œå¦‚æœæ˜¯ master ä¸ slave ä¹‹é—´çš„è¿æ¥æ–­äº†ï¼Œå¯ä»¥è°ƒè¯•ç½‘ç»œï¼Œè¿™æ ·è™½ç„¶éº»çƒ¦ï¼Œä½†æ˜¯æ˜¯å¯ä»¥ä¿è¯åªæœ‰ä¸€ä¸ª master çš„ï¼Œæ‰€ä»¥åªè¦è®¤çœŸè´Ÿè´£ï¼Œä¸ä¼šå‡ºç°è„‘è£‚ã€‚</p><h5 id="è‡ªåŠ¨è§£å†³é—®é¢˜"><a href="#è‡ªåŠ¨è§£å†³é—®é¢˜" class="headerlink" title="è‡ªåŠ¨è§£å†³é—®é¢˜"></a>è‡ªåŠ¨è§£å†³é—®é¢˜</h5><p>Redis ä¸­æœ‰ä¸€ä¸ªå“¨å…µæœºåˆ¶ï¼Œå“¨å…µæœºåˆ¶çš„ä½œç”¨å°±æ˜¯é€šè¿‡ redis å“¨å…µæ¥æ£€æµ‹ redis æœåŠ¡çš„çŠ¶æ€ï¼Œå¦‚æœä¸€æ—¦å‘ç° master æŒ‚äº†ï¼Œå°±åœ¨ slave ä¸­é€‰ä¸¾æ–°çš„ master èŠ‚ç‚¹ä»¥å®ç°æ•…éšœè‡ªåŠ¨è½¬ç§»ã€‚</p><h5 id="å¦‚ä½•é¿å…è„‘è£‚"><a href="#å¦‚ä½•é¿å…è„‘è£‚" class="headerlink" title="å¦‚ä½•é¿å…è„‘è£‚"></a>å¦‚ä½•é¿å…è„‘è£‚</h5><p>åˆç†è®¾ç½® min-slaves-to-writeã€min-slaves-max-lagä¸¤ä¸ªå‚æ•°</p><ul><li>ç¬¬ä¸€ä¸ªå‚æ•°æ ‡è¯†è¿æ¥åˆ° master çš„æœ€å°‘ slave æ•°é‡</li><li>ç¬¬äºŒä¸ªå‚æ•°æ ‡è¯† slaveè¿æ¥åˆ° master çš„æœ€å¤§å»¶è¿Ÿæ—¶é—´</li></ul><p>é—®é¢˜ï¼Œå°±å‡ºç°åœ¨è¿™ä¸ªè‡ªåŠ¨æ•…éšœè½¬ç§»ä¸Šï¼Œå¦‚æœæ˜¯å“¨å…µå’Œ slave åŒæ—¶ä¸ master æ–­äº†è”ç³»ï¼Œå³å“¨å…µå¯ä»¥ç›‘æµ‹åˆ° slaveï¼Œä½†æ˜¯ç›‘æµ‹ä¸åˆ° masterï¼Œè€Œ master è™½ç„¶è¿æ¥ä¸ä¸Š slave å’Œå“¨å…µï¼Œä½†æ˜¯è¿˜æ˜¯åœ¨æ­£å¸¸è¿è¡Œï¼Œè¿™æ ·å¦‚æœå“¨å…µå› ä¸ºç›‘æµ‹ä¸åˆ° masterï¼Œè®¤ä¸ºå®ƒæŒ‚äº†ï¼Œä¼šåœ¨ slave ä¸­é€‰ä¸¾æ–°çš„ masterï¼Œè€Œæœ‰ä¸€éƒ¨åˆ†åº”ç”¨ä»ç„¶ä¸æ—§çš„ master äº¤äº’ã€‚å½“æ—§çš„ master ä¸æ–°çš„ master é‡æ–°å»ºç«‹è¿æ¥ï¼Œæ—§çš„ master ä¼šåŒæ­¥æ–°çš„ master ä¸­çš„æ•°æ®ï¼Œè€Œæ—§çš„ master ä¸­çš„æ•°æ®å°±ä¼šä¸¢å¤±ã€‚æ‰€ä»¥æˆ‘è®¤ä¸º redis è„‘è£‚å°±æ˜¯è‡ªåŠ¨æ•…éšœè½¬ç§»é€ æˆçš„ã€‚</p><h3 id="3-4-æ­å»ºå“¨å…µé›†ç¾¤"><a href="#3-4-æ­å»ºå“¨å…µé›†ç¾¤" class="headerlink" title="3.4 æ­å»ºå“¨å…µé›†ç¾¤"></a>3.4 æ­å»ºå“¨å…µé›†ç¾¤</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-9-centos ~]# docker run -it -d --name redis3 -p 6378:6378 redis</span><br><span class="line">1d3ab7315ac93a217136fe0fb0837104ca4e5500b0671d2acb989f92ecd8e38b</span><br><span class="line">[root@VM-4-9-centos ~]#  docker inspect -f &#x27;&#123;&#123;.Name&#125;&#125; - &#123;&#123;.NetworkSettings.IPAddress &#125;&#125;&#x27; $(docker ps -aq)</span><br><span class="line">/redis3 - 172.17.0.6</span><br><span class="line">/redis2 - 172.17.0.5</span><br><span class="line">/redis1 - 172.17.0.4</span><br><span class="line">[root@VM-4-9-centos ~]# docker exec -it redis3 /bin/bash</span><br><span class="line">root@1d3ab7315ac9:/data# redis-cli</span><br><span class="line">127.0.0.1:6379&gt; replicaof 172.17.0.4 6379</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line">&quot;kongxr&quot;</span><br><span class="line"># https://segmentfault.com/a/1190000040755506</span><br><span class="line">#1.æ–°å»ºä¸€ä¸ªæ–‡ä»¶ï¼š docker-compose.yml å†…å®¹å¦‚ä¸‹ï¼š</span><br><span class="line">version: &#x27;3.7&#x27;</span><br><span class="line">services:</span><br><span class="line">  sentinel1:</span><br><span class="line">    image: redis</span><br><span class="line">    container_name: redis-sentinel-1</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - 26379:26379</span><br><span class="line">    command: redis-sentinel /usr/local/etc/redis/sentinel.conf</span><br><span class="line">    volumes:</span><br><span class="line">      - ./sentinel1.conf:/usr/local/etc/redis/sentinel.conf</span><br><span class="line">  sentinel2:</span><br><span class="line">    image: redis</span><br><span class="line">    container_name: redis-sentinel-2</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">    - 26380:26379</span><br><span class="line">    command: redis-sentinel /usr/local/etc/redis/sentinel.conf</span><br><span class="line">    volumes:</span><br><span class="line">      - ./sentinel2.conf:/usr/local/etc/redis/sentinel.conf</span><br><span class="line">  sentinel3:</span><br><span class="line">    image: redis</span><br><span class="line">    container_name: redis-sentinel-3</span><br><span class="line">    ports:</span><br><span class="line">      - 26381:26379</span><br><span class="line">    command: redis-sentinel /usr/local/etc/redis/sentinel.conf</span><br><span class="line">    volumes:</span><br><span class="line">      - ./sentinel3.conf:/usr/local/etc/redis/sentinel.conf</span><br><span class="line">      </span><br><span class="line">#2.åˆ†åˆ«æ–°å»ºä¸‰ä¸ªæ–‡ä»¶ï¼š sentinel1.confã€sentinel2.confã€sentinel1.conf å†…å®¹éƒ½å¦‚ä¸‹ï¼š</span><br><span class="line"># è‡ªå®šä¹‰é›†ç¾¤åï¼Œå…¶ä¸­172.17.0.4 ä¸º redis-master çš„ ipï¼Œ6380 ä¸º redis-master çš„ç«¯å£ï¼Œ2 ä¸ºæœ€å°æŠ•ç¥¨æ•°ï¼ˆå› ä¸ºæœ‰ 3 å° Sentinel æ‰€ä»¥å¯ä»¥è®¾ç½®æˆ 2ï¼‰</span><br><span class="line"></span><br><span class="line">port 26379</span><br><span class="line">dir /tmp</span><br><span class="line">sentinel monitor mymaster 172.17.0.4 6380 2</span><br><span class="line">sentinel down-after-milliseconds mymaster 30000</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line">sentinel auth-pass mymaster redispwd</span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br><span class="line">sentinel deny-scripts-reconfig yes</span><br><span class="line"></span><br><span class="line">#3.å››ä¸ªæ–‡ä»¶éƒ½æ”¾åœ¨åŒä¹‰ç›®å½•ä¸‹ï¼Œå¹¶ä½¿ç”¨å‘½ä»¤</span><br><span class="line">[root@VM-4-9-centos redis-sentinel]# docker-compose up -d</span><br><span class="line">Creating network &quot;redis-sentinel_default&quot; with the default driver</span><br><span class="line">Creating redis-sentinel-1 ... done</span><br><span class="line">Creating redis-sentinel-3 ... done</span><br><span class="line">Creating redis-sentinel-2 ... done</span><br><span class="line"></span><br><span class="line">#4.æµ‹è¯•ï¼šè¿›å…¥redis1 å‘ç°ï¼Œå½“å‰redisä¸ºä¸»èŠ‚ç‚¹ã€‚ç„¶åå°†è¯¥rediså…³é—­ã€‚</span><br><span class="line">[root@VM-4-9-centos redis-sentinel]#  docker exec -it redis1 /bin/bash</span><br><span class="line">root@f21ca2cacfea:/data# redis-cli</span><br><span class="line">127.0.0.1:6379&gt; info replication</span><br><span class="line"># Replication</span><br><span class="line">role:master</span><br><span class="line">[root@VM-4-9-centos redis-sentinel]# docker stop redis1</span><br><span class="line">redis1</span><br></pre></td></tr></table></figure><h2 id="å››ã€Redisåº”ç”¨"><a href="#å››ã€Redisåº”ç”¨" class="headerlink" title="å››ã€Redisåº”ç”¨"></a>å››ã€Redisåº”ç”¨</h2><h3 id="4-1-åˆ†å¸ƒå¼é”"><a href="#4-1-åˆ†å¸ƒå¼é”" class="headerlink" title="4.1 åˆ†å¸ƒå¼é”"></a>4.1 åˆ†å¸ƒå¼é”</h3><p>åˆ†å¸ƒå¼é”æœ¬è´¨ä¸Šè¦å®ç°çš„ç›®æ ‡å°±æ˜¯åœ¨ Redis é‡Œé¢å ä¸€ä¸ªèŒ…å‘ï¼Œå½“åˆ«çš„è¿›ç¨‹ä¹Ÿè¦è¿›æ¥å æ—¶ï¼Œå‘ç°å·²ç»æœ‰äººè¹²åœ¨é‚£é‡Œäº†ï¼Œå°±åªå¥½æ”¾å¼ƒæˆ–è€…ç¨åå†è¯•ã€‚</p><p>å å‘ä¸€èˆ¬æ˜¯ä½¿ç”¨ setnx æŒ‡ä»¤ï¼Œåªå…è®¸è¢«ä¸€ä¸ªå®¢æˆ·ç«¯å å‘ã€‚å…ˆæ¥å…ˆå ï¼Œç”¨å®Œäº†ï¼Œå†è°ƒç”¨ del æŒ‡ä»¤é‡Šæ”¾èŒ…å‘ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; setnx lock01 true</span><br><span class="line">OK</span><br><span class="line">... do something critical ...</span><br><span class="line">&gt;del lock01</span><br><span class="line">(integer)1</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯å¦‚æœ é€»è¾‘æ‰§è¡Œåˆ°ä¸­é—´ å‡ºç°å¼‚å¸¸äº†ï¼Œå¯èƒ½ä¼šå¯¼è‡´ del æŒ‡ä»¤æ²¡æœ‰è¢«è°ƒç”¨ï¼Œè¿™æ ·å°±ä¼šé™·å…¥æ­»é”ï¼Œé”æ°¸è¿œå¾—ä¸å¾—é‡Šæ”¾ã€‚äºæ˜¯æˆ‘ä»¬åœ¨æ‹¿åˆ°é”ä¹‹åï¼Œå†ç»™é”åŠ ä¸Šä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œæ¯”å¦‚5sï¼Œè¿™æ ·å³ä½¿ä¸­é—´å‡ºç°å¼‚å¸¸ä¹Ÿå¯ä»¥ä¿è¯5sä¹‹åé”ä¼šè‡ªåŠ¨é‡Šæ”¾ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; setnx lock01 true</span><br><span class="line">OK</span><br><span class="line">&gt;expire lock01 5</span><br><span class="line">... do something critical</span><br><span class="line">&gt;del lock01</span><br><span class="line">(integer)1</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ä»¥ä¸Šé€»è¾‘è¿˜æ˜¯æœ‰é—®é¢˜ï¼Œå› ä¸ºå¦‚æœåœ¨ setnx å’Œ expire ä¹‹é—´æœåŠ¡å™¨è¿›ç¨‹çªç„¶æŒ‚æ‰äº†ï¼Œå°±ä¼šå¯¼è‡´ expire å¾—ä¸åˆ°æ‰§è¡Œï¼Œä¹Ÿä¼šé€ æˆæ­»é”ã€‚</p><p>è¿™ç§é—®é¢˜çš„æ ¹æºåœ¨äº setnex å’Œ expire æ˜¯ä¸¤æ¡æŒ‡ä»¤è€Œä¸æ˜¯åŸå­æŒ‡ä»¤ã€‚å¦‚æœè¿™ä¸¤æ¡æŒ‡ä»¤å¯ä»¥ä¸€èµ·æ‰§è¡Œå°±ä¸ä¼šå‡ºç°é—®é¢˜ã€‚è¿™é‡Œä¹Ÿä¸å¯ä»¥ä½¿ç”¨Redisäº‹åŠ¡æ¥è§£å†³ã€‚å› ä¸º expire æ˜¯ä¾èµ–äº setnx çš„æ‰§è¡Œç»“æœçš„ï¼Œå¦‚æœ setnx æ²¡æŠ¢åˆ°é”ï¼Œexpire æ˜¯ä¸åº”è¯¥æ‰§è¡Œçš„ã€‚äº‹åŠ¡é‡Œæ²¡æœ‰ if-else åˆ†æ”¯é€»è¾‘ï¼Œäº‹åŠ¡çš„ç‰¹ç‚¹æ˜¯ä¸€å£æ°”æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œè¦ä¹ˆä¸€ä¸ªéƒ½ä¸æ‰§è¡Œã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒRediså¼€æºç¤¾åŒºæ¶Œç°å‡ºå¾ˆå¤§åˆ†å¸ƒå¼é”çš„libraryï¼Œä¸“é—¨ç”¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå…¶å®ç°æ–¹å¼æä¸ºå¤æ‚ã€‚å¦‚æœéœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼é”ï¼Œä¸èƒ½ä»…ä»…ä½¿ç”¨ Jedis æˆ–è€… redis-py å°±è¡Œäº†ï¼Œè¿˜å¾—å¼•å…¥åˆ†å¸ƒå¼é”çš„ libraryã€‚ä¸ºäº†æ²»ç†è¿™ä¸ªä¹±è±¡ï¼ŒRedis2.8ç‰ˆæœ¬ä¸­ åŠ å…¥äº† set æŒ‡ä»¤çš„æ‰©å±•å‚æ•°ï¼Œæ˜¯çš„ setnx å’Œ expire å¯ä»¥ä¸€èµ·æ‰§è¡Œï¼Œå½»åº•è§£å†³äº†åˆ†å¸ƒå¼é”çš„ä¹±è±¡ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; set lock01 true ex 5 nx</span><br><span class="line">OK</span><br><span class="line">&gt; del lock01</span><br></pre></td></tr></table></figure><p>Redis çš„åˆ†å¸ƒå¼é”ä¸èƒ½è§£å†³è¶…æ—¶é—®é¢˜ï¼Œå¦‚æœåœ¨åŠ é”å’Œé‡Šæ”¾ä¹‹é—´çš„é€»è¾‘æ‰§è¡Œçš„å¤ªé•¿ï¼Œä»¥è‡³äºè¶…å‡ºäº†é”çš„è¶…æ—¶é™åˆ¶ï¼Œå°±ä¼šå‡ºç°é—®é¢˜ã€‚å› ä¸ºè¿™æ—¶å€™é”è¿‡æœŸäº†ï¼Œç¬¬äºŒä¸ªçº¿ç¨‹é‡æ–°æŒæœ‰äº†è¿™æŠŠé”ï¼Œä½†æ˜¯ç´§æ¥ç€ç¬¬ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œäº†ä¸šåŠ¡é€»è¾‘ï¼Œå°±æŠŠé”ç»™é‡Šæ”¾äº†ï¼Œç¬¬ä¸‰ä¸ªçº¿ç¨‹å°±ä¼šåœ¨ç¬¬äºŒä¸ªçº¿ç¨‹æ‰§è¡Œå®Œä¹‹å‰å°±æ‹¿åˆ°äº†é”ã€‚</p><p>ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼ŒRedis åˆ†å¸ƒå¼é”ä¸è¦ç”¨äºè¾ƒé•¿æ—¶é—´çš„ä»»åŠ¡ã€‚å¦‚æœçœŸçš„å¶å°”å‡ºç°äº†ï¼Œæ•°æ®å‡ºç°å°æ³¢é”™ä¹±å¯èƒ½éœ€è¦äººå·¥ä»‹å…¥è§£å†³</p><p>æœ‰ä¸€ä¸ªæ›´å®‰å…¨çš„æ–¹æ¡ˆæ˜¯ä¸º set æŒ‡ä»¤çš„ value å‚æ•°è®¾ç½®ä¸º ä¸€ä¸ªéšæœºæ•°ï¼Œé‡Šæ”¾é”æ—¶å…ˆåŒ¹é…éšæœºæ•°æ˜¯å¦ä¸€è‡´ï¼Œç„¶åå†åˆ é™¤ keyã€‚ä½†æ˜¯åŒ¹é… value å’Œåˆ é™¤ key ä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼ŒRedisä¹Ÿæ²¡æœ‰æä¾›ç±»ä¼¼äº delifequals è¿™æ ·çš„æŒ‡ä»¤ï¼Œè¿™å°±éœ€è¦ä½¿ç”¨ Lua è„šæœ¬æ¥å¤„ç†äº†ï¼Œå› ä¸º Lua è„šæœ¬å¯ä»¥ä¿è¯è¿ç»­å¤šä¸ªæŒ‡ä»¤çš„åŸå­æ€§æ‰§è¡Œã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># delifequals</span><br><span class="line">if redis.call(&quot;get&quot;,KEYS[1])==ARGV[1] then return redis.call(&quot;del&quot;,KEYS[1]) else return 0 end</span><br></pre></td></tr></table></figure><p>å¯é‡å…¥æ€§</p><p>å¯é‡å…¥æ€§å°±æ˜¯æŒ‡ çº¿ç¨‹åœ¨æŒæœ‰é”çš„æƒ…å†µä¸‹å†æ¬¡è¯·æ±‚åŠ é”ï¼Œå¦‚æœä¸€ä¸ªé”æ”¯æŒåŒä¸€ä¸ªçº¿ç¨‹çš„å¤šæ¬¡åŠ é”ï¼Œé‚£ä¹ˆè¿™ä¸ªé”å°±æ˜¯å¯é‡å…¥çš„ã€‚Redisåˆ†å¸ƒå¼é”å¦‚æœéœ€è¦æ”¯æŒå¯é‡å…¥ï¼Œéœ€è¦å¯¹å®¢æˆ·ç«¯çš„ set æ–¹æ³•è¿›è¡ŒåŒ…è£…ï¼Œä½¿ç”¨çº¿ç¨‹çš„ Threadlocal å˜é‡å­˜å‚¨å½“å‰æŒæœ‰é”çš„è®¡æ•°ã€‚</p><h3 id="4-2-å»¶æ—¶é˜Ÿåˆ—"><a href="#4-2-å»¶æ—¶é˜Ÿåˆ—" class="headerlink" title="4.2 å»¶æ—¶é˜Ÿåˆ—"></a>4.2 å»¶æ—¶é˜Ÿåˆ—</h3><p>å¹³æ—¶ä¹ æƒ¯ä½¿ç”¨ RabbitMQå’ŒKafkaä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ï¼Œæ¥ç»™åº”ç”¨ç¨‹åºä¹‹é—´å¢åŠ å¼‚æ­¥æ¶ˆæ¯ä¼ é€’åŠŸèƒ½ã€‚è¿™ä¸ªä¸¤ä¸ªä¸­é—´ä»¶éƒ½æ˜¯ä¸“ä¸šçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ï¼Œå…¶èƒ½åŠ›å¾ˆå¼ºï¼Œä½†æ˜¯ä½¿ç”¨èµ·æ¥ä¹Ÿè¾ƒä¸ºç¹çã€‚Redisçš„æ¶ˆæ¯é˜Ÿåˆ—å®ç°å¾ˆç®€å•ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯ä¸“ä¸šçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ƒæ²¡æœ‰éå¸¸å¤šçš„é«˜çº§ç‰¹æ€§ï¼Œæ²¡æœ‰ackä¿è¯ï¼Œå¦‚æœå¯¹æ¶ˆæ¯çš„å¯é æ€§æœ‰ç€æè‡´çš„è¿½æ±‚ï¼Œé‚£ä¹ˆå®ƒå°±ä¸é€‚åˆä½¿ç”¨ã€‚</p><h4 id="4-2-1-å¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—"><a href="#4-2-1-å¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="4.2.1 å¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—"></a>4.2.1 å¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—</h4><p>Redis çš„ listï¼ˆåˆ—è¡¨ï¼‰æ•°æ®ç»“æ„ å¸¸ç”¨æ¥ä½œä¸ºå¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—ä½¿ç”¨ï¼Œä½¿ç”¨ rpush&#x2F;lpush æ“ä½œå…¥é˜Ÿåˆ—ï¼Œä½¿ç”¨ lpop å’Œ rpop æ¥å‡ºé˜Ÿåˆ—ã€‚</p><p>å®¢æˆ·ç«¯æ˜¯é€šè¿‡é˜Ÿåˆ—çš„ pop æ“ä½œæ¥è·å–æ¶ˆæ¯ï¼Œç„¶åè¿›è¡Œå¤„ç†ã€‚å¤„ç†å®Œäº†å†æ¥ç€è·å–æ¶ˆæ¯ï¼Œå†è¿›è¡Œå¤„ç†ï¼Œå¦‚æ­¤å¾€å¤ã€‚</p><p>å¦‚æœé˜Ÿåˆ—ç©ºäº†ï¼Œå®¢æˆ·ç«¯å°±ä¼šé™·å…¥ pop çš„æ­»å¾ªç¯ï¼Œä¸åœåœ° popã€‚è¿™å°±æ˜¯æµªè´¹ç”Ÿå‘½çš„ç©ºå¾ªç¯ã€‚ç©ºè½®è¯¢ä¸ä½†æ‹‰é«˜äº†å®¢æˆ·ç«¯çš„CPUï¼Œredisçš„QPSä¹Ÿä¼šè¢«æ‹‰é«˜ï¼Œå¦‚æœè¿™æ ·ç©ºè½®è¯¢çš„å®¢æˆ·ç«¯æœ‰å‡ åæ¥ä¸ªï¼ŒRedis çš„æ…¢æŸ¥è¯¢å¯èƒ½ä¼šæ˜¾è‘—å¢å¤šã€‚</p><p>é€šå¸¸ä½¿ç”¨ sleep æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè®©çº¿ç¨‹ä¼‘çœ ä¸€ä¼šã€‚ä½†æ˜¯è¿™æ ·ä¼šé€ æˆæ¶ˆè´¹è€…çš„å»¶è¿Ÿã€‚å¯ä»¥æœ‰æ›´å¥½çš„è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ blpopã€brpopï¼Œå‰ç¼€å­—ç¬¦bä»£è¡¨çš„å°±æ˜¯ blockingï¼Œå³å µå¡è¯»ã€‚å µå¡è¯»åœ¨é˜Ÿåˆ—æ²¡æœ‰æ•°æ®çš„æ—¶å€™ï¼Œä¼šç«‹å³è¿›è¡Œä¼‘çœ çŠ¶æ€ï¼Œä¸€æ—¦æ•°æ®åˆ°æ¥ï¼Œåˆ™ç«‹åˆ»é†’è¿‡æ¥ã€‚æ¶ˆæ¯çš„å»¶è¿Ÿå‡ ä¹ä¸º0ã€‚è¿™ä¸ªæ–¹æ¡ˆæœ‰ä¸ªå¼Šç«¯ï¼Œå°±æ˜¯æ³¨æ„ç©ºè¿æ¥é—®é¢˜ã€‚å› ä¸ºçº¿ç¨‹ä¸€ç›´å µå¡åœ¨é‚£ï¼ŒRedisçš„å®¢æˆ·ç«¯è¿æ¥å°±æˆäº†é—²ç½®è¿æ¥ï¼Œé—²ç½®è¿‡ä¹…ï¼ŒæœåŠ¡å™¨ä¸€èˆ¬å°±ä¼šä¸»åŠ¨æ–­å¼€è¿æ¥ï¼Œå‡å°‘é—²ç½®èµ„æºçš„å ç”¨ã€‚è¿™æ—¶ blpopã€brpop ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚æ‰€ä»¥åœ¨ ç¼–å†™å®¢æˆ·ç«¯æ¶ˆè´¹è€…æ—¶ï¼Œæ³¨æ„æ•è·å¼‚å¸¸å’Œé‡è¯•ã€‚</p><h4 id="4-2-2-å»¶è¿Ÿé˜Ÿåˆ—çš„å®ç°"><a href="#4-2-2-å»¶è¿Ÿé˜Ÿåˆ—çš„å®ç°" class="headerlink" title="4.2.2 å»¶è¿Ÿé˜Ÿåˆ—çš„å®ç°"></a>4.2.2 å»¶è¿Ÿé˜Ÿåˆ—çš„å®ç°</h4><p>ä¸Šä¸€èŠ‚æåŠçš„ åˆ†å¸ƒå¼é”ã€‚å½“å®¢æˆ·ç«¯åœ¨å¤„ç†è¯·æ±‚æ—¶ åŠ é”æ²¡åŠ æˆåŠŸ æ€ä¹ˆåŠã€‚ä¸€èˆ¬æ˜¯æœ‰ 3ç§ ç­–ç•¥æ¥å¤„ç†åŠ é”å¤±è´¥ï¼š</p><ul><li>ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œé€šçŸ¥ç”¨æˆ·ç¨åé‡è¯•ã€‚</li><li>sleepï¼Œä¸€ä¼šå†é‡è¯•ã€‚è¿™ç§æ–¹å¼ï¼Œä¼šå µå¡å½“å‰çš„æ¶ˆæ¯å¤„ç†çº¿ç¨‹ï¼Œå¯¼è‡´é˜Ÿåˆ—çš„åç»­æ¶ˆæ¯å¤„ç†å‡ºç°å»¶è¿Ÿã€‚å¦‚æœç¢°æ’å‡ºç°è¾ƒå¤šæˆ–è€…é˜Ÿåˆ—é‡Œçš„æ¶ˆæ¯è¾ƒå¤šï¼Œsleep å¯èƒ½å¹¶ä¸åˆé€‚ã€‚å› ä¸ºä¸ªåˆ« æ­»é”çš„key å¯¼è‡´åŠ é”ä¸æˆåŠŸï¼Œçº¿ç¨‹ä¼šå½»åº•å µæ­»ï¼Œå¯¼è‡´åç»­æ¶ˆæ¯æ°¸è¿œå¾—ä¸åˆ°åŠæ—¶å¤„ç†ã€‚</li><li>å°†è¯·æ±‚è½¬ç§»åˆ°å»¶è¿Ÿé˜Ÿåˆ—ï¼Œè¿‡ä¼šå†è¯•ã€‚è¿™ç§æ–¹å¼è¾ƒå¥½ã€‚</li></ul><p>å»¶æ—¶é˜Ÿåˆ—å¯ä»¥é€šè¿‡ Redisçš„ zset(æœ‰åºåˆ—è¡¨)æ¥å®ç°ã€‚æˆ‘ä»¬å°†æ¶ˆæ¯åºåˆ—åŒ–æˆä¸€ä¸ªå­—ç¬¦ä¸²ä½œä¸º zset çš„ valueï¼Œè¿™ä¸ªæ¶ˆæ¯çš„åˆ°æœŸå¤„ç†æ—¶é—´ä½œä¸º scoreï¼Œç„¶åç”¨å¤šä¸ªçº¿ç¨‹è½®è¯¢ zset è·å–åˆ°æœŸçš„ä»»åŠ¡è¿›è¡Œå¤„ç†ï¼Œå¤šä¸ªçº¿ç¨‹æ˜¯ä¸ºäº†ä¿éšœå¯ç”¨æ€§ï¼Œä¸‡ä¸€æŒ‚äº†ä¸€ä¸ªçº¿ç¨‹è¿˜æœ‰å…¶ä»–çº¿ç¨‹å¯ä»¥ç»§ç»­å¤„ç†ã€‚å› ä¸ºæœ‰å¤šä¸ªçº¿ç¨‹ï¼Œæ‰€ä»¥éœ€è¦è€ƒè™‘å¹¶å‘äº‰æŠ¢ä»»åŠ¡ï¼Œç¡®ä¿ä»»åŠ¡ä¸èƒ½è¢«å¤šæ¬¡æ‰§è¡Œã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">def delay(msg):</span><br><span class="line">msg.id = str(uuid.uuid4())</span><br><span class="line">value = json.dumps(msg)</span><br><span class="line">retry_ts = time.time() + 5</span><br><span class="line">redis.zadd(&quot;delay-queue&quot;,retry_ts,value)</span><br><span class="line">def loop():</span><br><span class="line">while True:</span><br><span class="line">values = redis.zrangebyscore(&quot;delay-queue&quot;,0,time.time(),start=0,num=1)</span><br><span class="line">if not values:</span><br><span class="line">time.sleep(1)#å»¶è¿Ÿé˜Ÿåˆ—æ˜¯ç©ºå½“ï¼Œä¼‘æ¯1s</span><br><span class="line">continue</span><br><span class="line">value = value[0]</span><br><span class="line">success = redis.zrem(&quot;delay-queue&quot;,value)</span><br><span class="line">if success:</span><br><span class="line">msg = json.loads(value)</span><br><span class="line">handle_msg(msg)</span><br></pre></td></tr></table></figure><p>Redis çš„ zrem æ–¹æ³•æ˜¯å¤šçº¿ç¨‹å¤šè¿›ç¨‹æŠ¢ä»»åŠ¡çš„å…³é”®ï¼Œå®ƒçš„è¿”å›å€¼å†³å®šäº†å½“å‰å®ä¾‹æœ‰æ²¡æœ‰æŠ¢åˆ°ä»»åŠ¡ï¼Œå› ä¸ºloopæ–¹æ³•å¯èƒ½è¢«å¤šä¸ªçº¿ç¨‹ã€å¤šä¸ªè¿›ç¨‹è°ƒç”¨ï¼ŒåŒä¸€ä»»åŠ¡å¯èƒ½ä¼šè¢«å¤šä¸ªè¿›ç¨‹çº¿ç¨‹æŠ¢åˆ°ï¼Œé€šè¿‡ zrem æ¥å†³å®šå”¯ä¸€çš„å±ä¸»ã€‚åŒæ—¶æ³¨æ„å¯¹ handle_msg è¿›è¡Œå¼‚å¸¸æ•è·ã€‚</p><p>ä¸Šè¿°æ–¹æ¡ˆè¿˜æ˜¯å­˜åœ¨æ˜æ˜¾ç¼ºç‚¹ï¼š1.åŸå­æ€§é—®é¢˜ï¼šå…ˆæŸ¥è¯¢å†åˆ é™¤ è¿™ä¸¤ä¸ªæ“ä½œä¸æ˜¯åŸå­çš„ï¼Œæ˜æ˜¾ä¼šå‡ºç°å¹¶å‘é—®é¢˜ï¼Œè™½ç„¶æˆ‘è¿™é‡Œåˆ¤æ–­äº† zrem çš„æ•°é‡ï¼Œä½†æ˜¯å¯èƒ½ä¼šå‡ºç°éƒ¨åˆ† key è¢«å…¶ä»–æœºå™¨ç»™æ¶ˆè´¹çš„æƒ…å†µï¼›2.æ€§èƒ½é—®é¢˜ï¼šzrangebyscoreè¿˜å¥½ï¼Œä½†æ˜¯å¦‚æœåœ¨æ—¶é—´é—´éš”å†…äº§ç”Ÿäº†å¤§é‡æ¶ˆæ¯ï¼Œå¦‚æœåŒæ—¶å¤„ç†ï¼Œzrem çš„æ€§èƒ½ä¼šæ€¥å‰§ä¸‹é™ã€‚</p><p>æ€§èƒ½é—®é¢˜è§£å†³ï¼š</p><ul><li>å¤šçº¿ç¨‹å¹¶å‘æ¶ˆè´¹</li><li>å°†å®šæ—¶ä»»åŠ¡çš„å¯åŠ¨å»¶è¿Ÿæ—¶é—´æˆ–è€…æ¯æ¬¡å¾ªç¯çš„æ—¶é—´éšæœºï¼Œè®©æ¯å°æœºå™¨å¤„ç†æ¶ˆæ¯ç‚¹æœ‰ä¸€å®šé—´éš”ï¼Œè¿™æ ·å•æ¬¡æ—¶é—´é—´éš”å†…è¦å¤„ç†çš„æ¶ˆæ¯çš„æ•°æ®ä¼šå¤§å¤§å‡å°‘ã€‚</li><li>zrangebyscore å‘½ä»¤è®¾ç½® limitï¼Œé™åˆ¶å•æ¬¡å¤„ç†æ¶ˆæ¯çš„æ•°æ®</li></ul><p>åŸå­æ€§é—®é¢˜è§£å†³ï¼š</p><p>ä½¿ç”¨Luaè„šæœ¬ è§£å†³zrangebyscore å’Œ zrem ä¸æ˜¯åŸå­åŒ–æ“ä½œçš„é—®é¢˜ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">local key = KEYS[1]</span><br><span class="line">local min = ARGV[1]</span><br><span class="line">local max = ARGV[2]</span><br><span class="line">local result = redis.call(&#x27;zrangebyscore&#x27;,key,min,max,&#x27;LIMIT&#x27;,0,10)</span><br><span class="line">if next(result) ~= nil and #result &gt; 0 then</span><br><span class="line">local re = redis.call(&#x27;zrem&#x27;,key,unpack(reslut));</span><br><span class="line">if(re &gt; 0) then</span><br><span class="line">return result;</span><br><span class="line">end</span><br><span class="line">else</span><br><span class="line">return &#123;&#125;</span><br><span class="line">end</span><br></pre></td></tr></table></figure><h3 id="4-3-ä½å›¾"><a href="#4-3-ä½å›¾" class="headerlink" title="4.3 ä½å›¾"></a>4.3 ä½å›¾</h3><p>åœ¨å¹³æ—¶å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä¼šæœ‰ä¸€äº›boolå‹æ•°æ®éœ€è¦å­˜å–ï¼Œæ¯”å¦‚ç”¨æˆ·ä¸€å¹´çš„ç­¾åˆ°è®°å½•ï¼Œç­¾äº†æ˜¯1ï¼Œæ²¡ç­¾æ˜¯0ï¼Œè¦è®°å½•365å¤©ã€‚å¦‚æœä½¿ç”¨æ™®é€šçš„ key&#x2F;valueï¼Œæ¯ä¸ªç”¨æˆ·è¦è®°å½• 365ä¸ªï¼Œå½“ç”¨æˆ·ä¸Šäº¿æ—¶ï¼Œéœ€è¦çš„å­˜å‚¨ç©ºé—´æ˜¯æƒŠäººçš„ã€‚</p><p>ä½å›¾ä¸æ˜¯ç‰¹æ®Šçš„æ•°æ®ç»“æ„ï¼Œå®ƒçš„å†…å®¹å…¶å®å°±æ˜¯æ™®é€šçš„å­—ç¬¦ä¸²ï¼Œä¹Ÿå°±æ˜¯ byte æ•°ç»„ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ™®é€šçš„ get&#x2F;set ç›´æ¥è·å–å’Œè®¾ç½®æ•´ä¸ªä½å›¾çš„å†…å®¹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ ä½å›¾æ“ä½œ getbit&#x2F;setbit ç­‰ å°†byteæ•°ç»„çœ‹æˆ ä½æ•°ç»„ æ¥å¤„ç†ã€‚</p><p>Redis çš„ä½æ•°ç»„æ˜¯è‡ªåŠ¨æ‰©å±•ï¼Œå¦‚æœè®¾ç½®äº†æŸä¸ªåç§»ä½ç½®è¶…è¿‡äº†ç°æœ‰çš„å†…å®¹èŒƒå›´ï¼Œå°±ä¼šè‡ªåŠ¨å°†ä½æ•°ç»„è¿›è¡Œé›¶æ‰©å……ã€‚</p><h4 id="4-3-1-åŸºæœ¬ä½¿ç”¨"><a href="#4-3-1-åŸºæœ¬ä½¿ç”¨" class="headerlink" title="4.3.1 åŸºæœ¬ä½¿ç”¨"></a>4.3.1 åŸºæœ¬ä½¿ç”¨</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&gt; setbit bitArray01 1 1</span><br><span class="line">(integer)0</span><br><span class="line">&gt; setbit bitArray01 2 1</span><br><span class="line">(integer)0</span><br><span class="line">&gt; setbit bitArray01 4 1</span><br><span class="line">(integer)0</span><br><span class="line">&gt; setbit bitArray01 9 1</span><br><span class="line">(integer)0</span><br><span class="line">&gt; setbit bitArray01 10 1</span><br><span class="line">(integer)0</span><br><span class="line">&gt; setbit bitArray01 13 1</span><br><span class="line">(integer)0</span><br><span class="line">&gt; setbit bitArray01 15 1</span><br><span class="line">(integer)0</span><br><span class="line">&gt; get bitArray01</span><br><span class="line">&quot;he&quot;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä¾‹å­ï¼Œå¯ä»¥ç†è§£ä¸º é›¶å­˜æ•´å–ï¼ŒåŒæ ·ä¹Ÿå¯ä»¥ é›¶å­˜é›¶å–ï¼Œæ•´å­˜æ•´å–ã€‚é›¶å­˜ï¼šå°±æ˜¯ä½¿ç”¨ setbit å¯¹ä½å€¼ è¿›è¡Œé€ä¸ªè®¾ç½®ã€‚æ•´å­˜ï¼šå°±æ˜¯ä½¿ç”¨å­—ç¬¦ä¸²ä¸€æ¬¡æ€§å¡«å……æ‰€æœ‰ä½æ•°ç»„ï¼Œè¦†ç›–æ‰æ—§å€¼ã€‚</p><h4 id="4-3-2-ç»Ÿè®¡å’ŒæŸ¥æ‰¾"><a href="#4-3-2-ç»Ÿè®¡å’ŒæŸ¥æ‰¾" class="headerlink" title="4.3.2 ç»Ÿè®¡å’ŒæŸ¥æ‰¾"></a>4.3.2 ç»Ÿè®¡å’ŒæŸ¥æ‰¾</h4><p>Redis æä¾›äº†ä½å›¾ç»Ÿè®¡æŒ‡ä»¤ bitcount å’Œä½å›¾æŸ¥æ‰¾æŒ‡ä»¤ bitposï¼Œbitcount ç”¨æ¥ç»Ÿè®¡æŒ‡å®šä½ç½®èŒƒå›´å†… 1 çš„ä¸ªæ•°ï¼Œbitops ç”¨æ¥æŸ¥æ‰¾æŒ‡å®šèŒƒå›´å†…å‡ºç°çš„ç¬¬ä¸€ä¸ª 0æˆ–1ã€‚</p><p>é—æ†¾çš„æ˜¯ï¼Œstart å’Œ end å‚æ•°æ˜¯ å­—èŠ‚ç´¢å¼•ï¼Œä¹Ÿå°±æ˜¯è¯´æŒ‡å®šçš„ä½èŒƒå›´å¿…é¡»æ˜¯ 8çš„å€æ•°ï¼Œè€Œä¸èƒ½ä»»æ„æŒ‡å®šã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">set w hello# æ•´å­˜</span><br><span class="line">bitcount w 0 0 # ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸­1çš„ä½æ•°</span><br><span class="line">bitcount w 0 1 # å‰ä¸¤ä¸ªå­—ç¬¦ä¸­1çš„ä½æ•°</span><br><span class="line">bitops w 0 # ç¬¬ä¸€ä¸ªé›¶ä½</span><br><span class="line">bitops w 1 0 1 2 # ç¬¬äºŒåˆ°ç¬¬ä¸‰å­—ç¬¦ä¸­ ç¬¬ä¸€ä¸ªå‡ºç°1çš„ä½ç½®</span><br></pre></td></tr></table></figure><h4 id="4-3-3-é­”æœ¯æŒ‡ä»¤-bitfield"><a href="#4-3-3-é­”æœ¯æŒ‡ä»¤-bitfield" class="headerlink" title="4.3.3 é­”æœ¯æŒ‡ä»¤ bitfield"></a>4.3.3 é­”æœ¯æŒ‡ä»¤ bitfield</h4><p>ä¹‹å‰æˆ‘ä»¬è®¾ç½®æˆ–è€…è·å– æŒ‡å®šä½çš„å€¼ éƒ½æ˜¯å•ä¸ªä½çš„ï¼Œå¦‚æœè¦ä¸€æ¬¡æ“ä½œå¤šä¸ªä½ï¼Œå°±å¿…é¡»è¦ä½¿ç”¨ç®¡é“æ¥å¤„ç†ã€‚Redis3.2ä¹‹åï¼Œæ–°å¢å‘½ä»¤ bitfield å¯ä»¥ä½¿ç”¨ã€‚å…¶ä¸‹æœ‰ä¸‰ä¸ªå­æŒ‡ä»¤åˆ†åˆ«æ˜¯ get&#x2F;set&#x2F;incrbyï¼Œå®ƒä»¬éƒ½å¯ä»¥å¯¹æŒ‡å®šä½ç‰‡æ®µè¿›è¡Œè¯»å†™ï¼Œä½†æ˜¯æœ€å¤šåªèƒ½å¤„ç†64ä¸ªè¿ç»­çš„ä½ï¼Œå¦‚æœè¶…è¿‡64ä½ï¼Œå°±å¾—ä½¿ç”¨å¤šä¸ªå­æŒ‡ä»¤ï¼Œbitfield å¯ä»¥ä¸€æ¬¡æ‰§è¡Œå¤šä¸ªå­æŒ‡ä»¤ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">set w hello</span><br><span class="line">bitfield w get u4 0 # ä»ç¬¬ä¸€ä½å¼€å§‹å–4ä¸ªä½ï¼Œå–å‡ºç»“æœä¸ºæ— ç¬¦å·æ•°ï¼ˆuï¼‰</span><br><span class="line">bitfield w get i3 2 # ä»ç¬¬ä¸‰ä½å¼€å§‹å–3ä¸ªä½ï¼Œå–å‡ºç»“æœä¸ºæœ‰ç¬¦å·æ•°ï¼ˆiï¼‰</span><br><span class="line">bitfield w get u4 0 get i3 2 # å¯ä»¥ä¸€æ¬¡æ‰§è¡Œå¤šä¸ªå­æŒ‡ä»¤</span><br><span class="line">bitfield w et u8 8 97 #ä»ç¬¬8ä¸ªä½å¼€å§‹ï¼Œå°†æ¥ä¸‹æ¥çš„8ä¸ªä½ ç”¨æ— ç¬¦å·æ•°97 æ›¿æ¢</span><br></pre></td></tr></table></figure><p>æ‰€è°“æœ‰ç¬¦å·æ•°æ˜¯æŒ‡ å–å‡ºæ¥çš„ä½æ•°ç»„ä¸­ç¬¬ä¸€ä¸ªä½æ˜¯å½“ä½œç¬¦å·ä½ï¼Œå‰©ä¸‹çš„æ‰æ˜¯å€¼ã€‚å¦‚æœç¬¬ä¸€ä½æ˜¯1ï¼Œé‚£å°±æ˜¯è´Ÿæ•°ã€‚æ— ç¬¦å·æ•°è¡¨ç¤ºéè´Ÿæ•°ï¼Œæ²¡æœ‰ç¬¦å·ä½ï¼Œè·å–åˆ°ä½æ•°ç»„å…¨éƒ¨éƒ½æ˜¯å€¼ã€‚æœ‰ç¬¦å·æ•° æœ€å¤šå¯ä»¥è·å–64ä½ï¼Œæ— ç¬¦å·æ•° åªèƒ½è·å–63ä½ã€‚</p><p>ç¬¬ä¸‰ä¸ªæŒ‡ä»¤ incrbyï¼Œå®ƒç”¨æ¥å¯¹æŒ‡å®šèŒƒå›´çš„ä½è¿›è¡Œè‡ªå¢æ“ä½œã€‚æ—¢ç„¶æåˆ°äº†è‡ªå¢ï¼Œå°±æœ‰å¯èƒ½å‡ºç°æº¢å‡ºã€‚å¦‚æœå¢åŠ äº†æ­£æ•°ï¼Œä¼šå‡ºç°ä¸Šæº¢ã€‚å¦‚æœå¢åŠ è´Ÿæ•°ï¼Œä¼šå‡ºç°ä¸‹æº¢å‡ºã€‚å¦‚æœå‡ºç°æº¢å‡ºï¼Œå°±å°†æº¢å‡ºçš„ç¬¦å·ä½ä¸¢æ‰ã€‚å¦‚æœæ˜¯8ä½æ— ç¬¦å·æ•°255ï¼ŒåŠ 1å°±å˜æˆ 0ã€‚</p><h3 id="4-4-HyperLogLog"><a href="#4-4-HyperLogLog" class="headerlink" title="4.4 HyperLogLog"></a>4.4 HyperLogLog</h3><p>HyperLogLogæä¾›çš„æ˜¯ä¸€ä¸ªä¸ç²¾ç¡®ä½†æ˜¯èŠ‚çœç©ºé—´çš„å»é‡è®¡æ•°æ–¹æ¡ˆï¼šå¦‚æœé¡µé¢è®¿é—®é‡éå¸¸å¤§ï¼Œæ¯”å¦‚ä¸€ä¸ªçˆ†æ¬¾é¡µé¢å‡ åƒä¸‡çš„ UVï¼Œå°±éœ€è¦ä¸€ä¸ªå¾ˆå¤§çš„ Seté›†åˆ æ¥ç»Ÿè®¡ï¼Œè¿™å°±éå¸¸æµªè´¹ç©ºé—´ã€‚å¦‚æœè¿™æ ·çš„é¡µé¢å¾ˆå¤šï¼Œé‚£æ‰€éœ€è¦çš„å­˜å‚¨ç©ºé—´æ˜¯æƒŠäººçš„ã€‚å¦‚æœå¯¹ç»Ÿè®¡ç²¾ç¡®åº¦ä¸éœ€è¦å¤ªç²¾ç¡®ï¼Œå°±å¯ä»¥ä½¿ç”¨HyperLogLogï¼Œå®ƒçš„æ ‡å‡†è¯¯å·®æ˜¯0.81%ã€‚</p><h4 id="4-4-1-ä½¿ç”¨æ–¹æ³•"><a href="#4-4-1-ä½¿ç”¨æ–¹æ³•" class="headerlink" title="4.4.1 ä½¿ç”¨æ–¹æ³•"></a>4.4.1 ä½¿ç”¨æ–¹æ³•</h4><p>HyperLogLog æä¾›äº†ä¸¤ä¸ªæŒ‡ä»¤ pfadd å’Œ pfcountï¼Œä¸€ä¸ªæ˜¯å¢åŠ è®¡æ•°ï¼Œä¸€ä¸ªæ˜¯è·å–è®¡æ•°ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; pfadd w user1</span><br><span class="line">(integer)1</span><br><span class="line">&gt; pcount w</span><br><span class="line">(integer)1</span><br></pre></td></tr></table></figure><p>é™¤äº†ä¸Šé¢ä¸¤ä¸ªæŒ‡ä»¤ï¼Œè¿˜æœ‰ä¸€ä¸ª pfmergeï¼Œç”¨äºå°†å¤šä¸ª pf è®¡æ•°å€¼ç´¯è®¡åœ¨ä¸€èµ·å½¢æˆä¸€ä¸ªæ–°çš„ pf å€¼ã€‚</p><h4 id="4-4-2-æ•°å­¦åŸç†"><a href="#4-4-2-æ•°å­¦åŸç†" class="headerlink" title="4.4.2 æ•°å­¦åŸç†"></a>4.4.2 æ•°å­¦åŸç†</h4><p><strong>æå¤§ä¼¼ç„¶ä¼°è®¡çš„ç›´è§‚ç†è§£</strong></p><p>å…¶ä½¿ç”¨çš„æ•°å­¦åŸç†æ˜¯ç»Ÿè®¡å­¦ä¸­çš„æå¤§ä¼¼ç„¶ä¼°è®¡ã€‚æ¥ä¸‹å»æˆ‘å°†ç”¨å¤šä¸ªåœºæ™¯é€æ­¥æ·±å…¥è§£æã€‚<br><strong>åœºæ™¯1ï¼š</strong>ç°åœ¨æœ‰2ä¸ªä¸é€æ˜çš„å£è¢‹ï¼Œå…¶ä¸­éƒ½è£…æœ‰100ä¸ªçƒï¼ŒAå£è¢‹ä¸­æ˜¯99ä¸ªç™½çƒ1ä¸ªé»‘çƒï¼ŒBå£è¢‹ä¸­æ˜¯99ä¸ªé»‘çƒ1ä¸ªç™½çƒã€‚å½“æˆ‘ä»¬éšæœºæŒ‘é€‰ä¸€ä¸ªå£è¢‹ï¼Œç„¶åä»ä¸­æ‹¿å‡ºä¸€ä¸ªçƒã€‚å¦‚æœæ‹¿å‡ºçš„çƒæ˜¯ç™½è‰²çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è¯´â€œå¤§æ¦‚ç‡â€æˆ‘ä»¬å–å‡ºçš„æ˜¯Aå£è¢‹ã€‚è¿™ç§ç›´è§‰çš„æ¨æµ‹å…¶å®å°±åŒ…å«äº†â€œæå¤§ä¼¼ç„¶ä¼°è®¡â€çš„æ€æƒ³ã€‚</p><p><strong>åœºæ™¯2ï¼š</strong>æˆ‘ä»¬åªä¿ç•™Aå£è¢‹ï¼Œå…¶ä¸­99ä¸ªç™½çƒï¼Œ1ä¸ªé»‘çƒã€‚å¾ˆå®¹æ˜“æˆ‘ä»¬å°±å¯ä»¥å¾—å‡ºç»“è®ºï¼Œä»ä¸­å–å‡ºä»»æ„ä¸€ä¸ªçƒï¼Œæ˜¯ç™½çƒçš„æ¦‚ç‡ä¸º99%ï¼Œæ˜¯é»‘çƒçš„æ¦‚ç‡ä¸º1%ã€‚è¿™æ˜¯ä¸€ç§<strong>æ­£å‘çš„æ¨æµ‹</strong>ï¼š<br><em>æˆ‘ä»¬çŸ¥é“äº†</em>**<em>æ¡ä»¶ï¼ˆ99ä¸ªç™½çƒï¼Œ1ä¸ªé»‘çƒï¼‰*<em><strong>ï¼Œä»è€Œæ¨æµ‹å‡º</strong></em></em>ç»“æœï¼ˆå–å‡ºä»»æ„ä¸€ä¸ªçƒï¼Œæ˜¯ç™½çƒçš„æ¦‚ç‡ä¸º99%ï¼‰***ã€‚<br>ä½†è¿™åªæ˜¯ç†è®ºä¸Šçš„æ¨æµ‹ï¼Œå¦‚æœå®é™…å–çƒ100æ¬¡ï¼Œæ¯æ¬¡éƒ½æ”¾å›ï¼Œé‚£ä¹ˆå–å‡ºé»‘çƒçš„æ¬¡æ•°å¹¶ä¸ä¸€å®šæ˜¯1æ¬¡ï¼Œå¯èƒ½æ˜¯0æ¬¡ï¼Œä¹Ÿå¯èƒ½è¶…è¿‡1æ¬¡ã€‚æˆ‘ä»¬å–çƒçš„æ¬¡æ•°è¶Šå¤šï¼Œå®é™…æƒ…å†µå°†è¶Šç¬¦åˆç†è®ºæƒ…å†µã€‚</p><p><strong>åœºæ™¯3ï¼š</strong>è¿˜æ˜¯Aå£è¢‹ï¼Œåªä¸è¿‡æ­¤æ—¶å…¶ä¸­ç™½çƒå’Œé»‘çƒçš„æ•°é‡æˆ‘ä»¬å¹¶ä¸çŸ¥æ™“ã€‚äºæ˜¯æˆ‘ä»¬å¼€å§‹ä»ä¸­æ‹¿çƒï¼Œæ¯æ‹¿å‡ºä¸€ä¸ªçƒéƒ½è®°å½•ä¸‹ç»“æœï¼Œå¹¶å°†å…¶æ”¾å›ã€‚å¦‚æœæˆ‘ä»¬å–çƒ100æ¬¡ï¼Œå…¶ä¸­99æ¬¡æ˜¯ç™½çƒï¼Œ1æ¬¡æ˜¯é»‘çƒï¼Œæˆ‘ä»¬å¯ä»¥è¯´Aå£è¢‹ä¸­å¯èƒ½æ˜¯99ä¸ªç™½çƒï¼Œä½†å¹¶ä¸èƒ½éå¸¸è‚¯å®šã€‚å½“æˆ‘ä»¬å–çƒ10000æ¬¡çš„æ—¶å€™ï¼Œå…¶ä¸­9900æ¬¡æ˜¯ç™½çƒï¼Œ100æ¬¡æ˜¯é»‘çƒï¼Œæ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥å¤§æ¦‚ç‡ç¡®å®šAå£è¢‹ä¸­æ˜¯99ä¸ªç™½çƒï¼Œè€Œè¿™ç§ç¡®å®šç¨‹åº¦éšç€æˆ‘ä»¬å®é™…å–çƒæ¬¡æ•°çš„å¢åŠ ä¹Ÿå°†ä¸æ–­å¢åŠ ã€‚è¿™å°±æ˜¯ä¸€ç§<strong>åå‘çš„æ¨æµ‹</strong>ï¼š<br><em>æˆ‘ä»¬è§‚å¯Ÿäº†</em>**<em>ç»“æœï¼ˆå–10000æ¬¡çƒï¼Œ9900æ¬¡æ˜¯ç™½çƒï¼Œ100æ¬¡æ˜¯é»‘çƒï¼‰*<em><strong>ï¼Œå¯ä»¥æ¨æµ‹å‡º</strong></em></em>æ¡ä»¶ï¼ˆAå£è¢‹ä¸­æ”¾äº†99ä¸ªç™½çƒï¼Œ1ä¸ªé»‘çƒï¼‰***ã€‚<br>å½“ç„¶è¿™ç§æ¨æµ‹çš„ç»“æœå¹¶éæ˜¯å‡†ç¡®çš„ï¼Œè€Œæ˜¯ä¸€ç§å¤§æ¦‚ç‡çš„ä¼°è®¡ã€‚<br>æ— è®ºæ˜¯æ­£å‘æ¨æµ‹æˆ–æ˜¯åå‘æ¨æµ‹ï¼Œåªæœ‰å½“å®é™…æ‰§è¡Œæ“ä½œçš„æ¬¡æ•°è¶³å¤Ÿå¤šçš„æ—¶å€™ï¼Œæ‰èƒ½ä½¿å¾—å®é™…æƒ…å†µæ›´æ¥è¿‘ç†è®ºæ¨æµ‹ã€‚è¿™å°±éå¸¸ç¬¦åˆhyperloglogçš„ç‰¹ç‚¹ï¼Œåªæœ‰å½“æ•°æ®é‡è¶³å¤Ÿå¤§çš„æ—¶å€™ï¼Œè¯¯å·®æ‰ä¼šè¶³å¤Ÿå°ã€‚</p><p>å› æ­¤æå¤§ä¼¼ç„¶ä¼°è®¡çš„æœ¬è´¨å°±æ˜¯ï¼šå½“èƒ½è§‚å¯Ÿçš„ç»“æœæ•°é‡è¶³å¤Ÿå¤šæ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¤§æ¦‚ç‡ç¡®å®šäº§ç”Ÿç›¸åº”ç»“æœæ‰€éœ€è¦çš„æ¡ä»¶çš„çŠ¶æ€ã€‚è¿™ç§é€šè¿‡å¤§é‡ç»“æœåå‘ä¼°è®¡æ¡ä»¶çš„æ•°å­¦æ–¹æ³•å°±æ˜¯æå¤§ä¼¼ç„¶ä¼°è®¡ã€‚</p><p><strong>ä¼¯åŠªåˆ©å®éªŒä¸æå¤§ä¼¼ç„¶ä¼°è®¡</strong></p><p>äº†è§£æå¤§ä¼¼ç„¶ä¼°è®¡ä¹‹åï¼Œæˆ‘ä»¬å°±éœ€è¦å¼•å…¥ç¬¬äºŒä¸ªæ•°å­¦æ¦‚å¿µï¼Œä¼¯åŠªåˆ©å®éªŒã€‚<br>ä¸è¦è¢«è¿™ä¸ªåå­—å”¬ä½ï¼Œä¼¯åŠªåˆ©å®éªŒå…¶å®å°±æ˜¯æ‰”ç¡¬å¸ï¼Œæ¥ä¸‹å»æˆ‘ä»¬å°±æ¥äº†è§£ä¸‹è¿™æšç¡¬å¸è¦æ€ä¹ˆæ‰”ã€‚ä¸‹æ–‡æ‰€è¯´çš„ç¡¬å¸éƒ½æ˜¯æœ€æ™®é€šçš„ç¡¬å¸ï¼Œåªæœ‰æ­£åä¸¤é¢ï¼Œä¸”æ¯ä¸€é¢æœä¸Šçš„æ¦‚ç‡éƒ½æ˜¯50%ã€‚<br><strong>åœºæ™¯1ï¼š</strong>æˆ‘ä»¬éšæœºæ‰”ä¸€æ¬¡ç¡¬å¸ï¼Œé‚£ä¹ˆå¾—åˆ°æ­£é¢æˆ–åé¢çš„å¯èƒ½æ€§æ˜¯ç›¸åŒçš„ã€‚å¦‚æœæˆ‘ä»¬æ‰”10000æ¬¡ç¡¬å¸ï¼Œé‚£ä¹ˆå¯ä»¥ä¼°è®¡åˆ°å¤§æ¦‚ç‡æ˜¯æ¥è¿‘5000æ¬¡æ­£é¢ï¼Œ5000æ¬¡åé¢ã€‚è¿™æ˜¯æœ€ç®€å•çš„æ­£å‘æ¨æµ‹ã€‚</p><p><strong>åœºæ™¯2ï¼š</strong>å¦‚æœæˆ‘ä»¬æ‰”2æ¬¡ç¡¬å¸ï¼Œæ˜¯å¦å¯èƒ½2æ¬¡éƒ½æ˜¯æ­£é¢ï¼Ÿå½“ç„¶æœ‰å¯èƒ½ï¼Œå¹¶ä¸”æ¦‚ç‡ä¸º1&#x2F;4ã€‚å¦‚æœæˆ‘ä»¬æ‰”10æ¬¡ç¡¬å¸å‘¢ï¼Œæ˜¯å¦å¯èƒ½10æ¬¡éƒ½æ˜¯æ­£é¢ï¼Ÿè™½ç„¶æ¦‚ç‡å¾ˆå°ï¼Œä½†ä¾ç„¶æ˜¯æœ‰å¯èƒ½çš„ï¼Œæ¦‚ç‡ä¸º1&#x2F;1024ã€‚åŒæ ·çš„ï¼Œæ— è®ºæ˜¯100æ¬¡ã€1000æ¬¡ï¼Œå³ä½¿æ¦‚ç‡å¾ˆå°ï¼Œä¹Ÿä¾ç„¶å­˜åœ¨å…¨éƒ¨éƒ½æ˜¯æ­£é¢æœä¸Šçš„æƒ…å†µï¼Œå‡å¦‚æ‰”äº†næ¬¡ï¼Œé‚£ä¹ˆnæ¬¡éƒ½æ˜¯æ­£é¢çš„æ¦‚ç‡ä¸º12ğ‘›12ï¿½ã€‚è¿™ä¹Ÿæ˜¯æ­£å‘çš„æ¨æµ‹ï¼Œåªä¸è¿‡å¢åŠ äº†å…¨éƒ½æ˜¯æ­£é¢æœä¸Šçš„é™å®šã€‚</p><p><strong>åœºæ™¯3ï¼š</strong>ç°åœ¨æˆ‘ä»¬æŒ‰ä¸‹é¢è¿™ç§è§„åˆ™æ‰”ç¡¬å¸ï¼šä¸æ–­æ‰”ç¡¬å¸ï¼Œå¦‚æœæ˜¯æ­£é¢æœä¸Šï¼Œé‚£ä¹ˆå°±ç»§ç»­æ‰”ï¼Œç›´åˆ°å‡ºç°åé¢æœä¸Šï¼Œæ­¤æ—¶è®°å½•ä¸‹æ‰”ç¡¬å¸çš„æ€»æ¬¡æ•°ã€‚ä¾‹å¦‚æˆ‘ä»¬æŠ›äº†5æ¬¡ç¡¬å¸ï¼Œå‰4æ¬¡éƒ½æ˜¯æ­£é¢æœä¸Šï¼Œç¬¬5æ¬¡æ˜¯åé¢æœä¸Šï¼Œæˆ‘ä»¬å°±è®°å½•ä¸‹æ¬¡æ•°5ã€‚é€šè¿‡åœºæ™¯2ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“è¿™ç§æƒ…å†µå‘ç”Ÿçš„æ¦‚ç‡ä¸º1&#x2F;32ã€‚æŒ‰æˆ‘ä»¬çš„ç›´è§‰å¯ä»¥æ¨æµ‹ï¼Œå¦‚æœä¸€ä¸ªç»“æœå‘ç”Ÿçš„æ¦‚ç‡æ˜¯1&#x2F;32ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¤§ä½“ä¸Šå°±éœ€è¦åš32æ¬¡åŒæ ·çš„äº‹æƒ…æ‰èƒ½å¾—åˆ°è¿™ä¸ªç»“æœï¼ˆå½“ç„¶ä»æ›´ä¸¥è°¨çš„æ•°å­¦è§’åº¦ï¼Œå¹¶ä¸èƒ½è¿™ä¹ˆè¯´ï¼Œä½†æœ¬æ–‡ä¸æƒ³æ¶‰åŠä¸“ä¸šçš„æ•°å­¦æè¿°ï¼Œæ‰€ä»¥å§‘ä¸”è¿™ä¹ˆç†è§£ï¼Œå…¶å®ä¹ŸæŒºç¬¦åˆä¸€èˆ¬å¸¸è¯†åˆ¤æ–­çš„ï¼‰ã€‚<br>é‚£ä¹ˆå‡å¦‚å¼ ä¸‰åšäº†è‹¥å¹²æ¬¡è¿™ç§å®éªŒï¼Œæˆ‘è§‚å¯Ÿç»“æœï¼Œå‘ç°è®°å½•ä¸‹çš„æ€»æ¬¡æ•°çš„<strong>æœ€å¤§å€¼</strong>æ˜¯5ï¼Œé‚£å°±è¯´æ˜åœ¨è¿™è‹¥å¹²æ¬¡å®éªŒä¸­ï¼Œè‡³å°‘å‘ç”Ÿäº†ä¸€æ¬¡4æ¬¡æ­£é¢æœä¸Šï¼Œç¬¬5æ¬¡åé¢æœä¸Šçš„æƒ…å†µï¼Œè€Œè¿™ç§æƒ…å†µå‘ç”Ÿçš„æ¦‚ç‡æ˜¯1&#x2F;32ï¼Œäºæ˜¯æˆ‘æ¨æµ‹ï¼Œå¼ ä¸‰å¤§æ¦‚ç‡æ€»å…±åšäº†32æ¬¡å®éªŒã€‚è¿™å°±æ˜¯ä¸€ç§åå‘æ¨æµ‹ï¼š<br><em>å³æ ¹æ®</em><strong><em>ç»“æœï¼ˆå‘ç”Ÿäº†ä¸€æ¬¡1&#x2F;32æ¦‚ç‡æ‰ä¼šå‡ºç°çš„ç»“æœï¼‰*<em><strong>ï¼Œæ¨æµ‹</strong></em></em>æ¡ä»¶ï¼ˆå¤§æ¦‚ç‡åšäº†32æ¬¡å®éªŒï¼‰*<strong>ã€‚<br>æ›´é€šä¿—æ¥è¯´ï¼Œå¦‚æœä¸€ä¸ªç»“æœå‡ºç°çš„æ¦‚ç‡å¾ˆå°ï¼Œä½†å´å®é™…å‘ç”Ÿäº†äº†ï¼Œå°±å¯ä»¥æ¨æµ‹è¿™ä»¶äº‹æƒ…è¢«é‡å¤æ‰§è¡Œäº†å¾ˆå¤šæ¬¡ã€‚ç»“æœå‡ºç°çš„æ¦‚ç‡è¶Šå°ï¼Œäº‹æƒ…è¢«é‡å¤æ‰§è¡Œçš„æ¬¡æ•°å°±åº”å½“è¶Šå¤šã€‚å°±åƒç”Ÿæ´»ä¸­ä¸­å½©ç¥¨çš„æ¦‚ç‡å¾ˆä½ï¼Œæ™®é€šäººå¦‚æœæƒ³ä¸­é‚£å¯ä¸å°±å¾—ä¹°å¾ˆå¤šæ¬¡å˜›ï¼Œä¸­å¥–æ¦‚ç‡è¶Šä½ï¼Œä¸€èˆ¬éœ€è¦è´­ä¹°å½©ç¥¨çš„æ¬¡æ•°å°±è¶Šå¤šã€‚ç›¸åº”çš„å¦‚æœä¸€ä¸ªäººä¸­å¥–äº†ï¼Œæˆ‘ä»¬å¯ä»¥è¯´è¿™ä¸ªäºº</strong>å¤§æ¦‚ç‡</strong>ä¸Šè´­ä¹°äº†éå¸¸å¤šæ¬¡å½©ç¥¨ã€‚è¿™å°±æ˜¯ä¼¯åŠªåˆ©å®éªŒä¸æå¤§ä¼¼ç„¶ä¼°è®¡ç»“åˆçš„é€šä¿—ç†è§£ã€‚</p><p><strong>å¦å¤–ç‰¹åˆ«æ³¨æ„çš„ï¼Œæˆ‘ä»¬æ¨æµ‹æ¡ä»¶æ—¶ï¼Œéœ€è¦è§‚å¯Ÿçš„æ€»æ¬¡æ•°çš„æœ€å¤§å€¼ï¼Œå› ä¸ºæœ€å¤§å€¼ä»£è¡¨äº†æœ€å°æ¦‚ç‡ï¼Œè€Œæœ€å°æ¦‚ç‡æ‰æ˜¯æ¨æµ‹æ¡ä»¶çš„ä¾æ®ã€‚ä¸‹æ–‡redisåŒç†ã€‚</strong></p><h4 id="4-4-3-rediså®ç°"><a href="#4-4-3-rediså®ç°" class="headerlink" title="4.4.3 rediså®ç°"></a>4.4.3 rediså®ç°</h4><p>rediså®ç°æœ¬è´¨ä¹Ÿæ˜¯åˆ©ç”¨äº†â€œæ‰”ç¡¬å¸â€äº§ç”Ÿçš„â€œæå¤§ä¼¼ç„¶ä¼°è®¡â€åŸç†ï¼Œå› æ­¤æ¥ä¸‹å»æˆ‘ä»¬å°±è¯¦ç»†çœ‹çœ‹redisæ˜¯æ€ä¹ˆæ‰”ç¡¬å¸çš„ã€‚<br>åœ¨ä¼¯åŠªåˆ©è¯•éªŒçš„åœºæ™¯3ä¸­ï¼Œæˆ‘ä»¬åšçš„å®éªŒæœ‰3ä¸ªç‰¹ç‚¹ï¼š<br>1.ç¡¬å¸åªæœ‰æ­£åä¸¤é¢ã€‚<br>2.ç¡¬å¸æ­£åé¢å‡ºç°çš„æ¦‚ç‡ç›¸åŒã€‚<br>2.å•æ¬¡å®éªŒéœ€è¦æŠ•æ·å¤šæ¬¡ç¡¬å¸ã€‚</p><p>è€Œè®¡ç®—æœºä¸­çš„hashç®—æ³•æ­£å¥½å¯ä»¥æ»¡è¶³è¿™3ä¸ªæ¡ä»¶ï¼š<br>1.hashç»“æœçš„æ¯ä¸€ä¸ªbitåªæœ‰0å’Œ1ï¼Œä»£è¡¨ç¡¬å¸çš„æ­£åä¸¤é¢ã€‚<br>2.å¦‚æœhashç®—æ³•è¶³å¤Ÿå¥½ï¼Œå¾—åˆ°çš„ç»“æœå°±è¶³å¤Ÿéšæœºï¼Œå¯ä»¥è¿‘ä¼¼è®¤ä¸ºæ¯ä¸€ä¸ªbitçš„0å’Œ1äº§ç”Ÿçš„æ¦‚ç‡æ˜¯ç›¸åŒçš„ã€‚<br>3.hashçš„ç»“æœå¦‚æœæ˜¯64ä¸ªbitï¼Œæ­£å¥½ä»£è¡¨æŠ•æ·äº†64æ¬¡ç¡¬å¸ã€‚</p><p>å› æ­¤æ‰§è¡Œä¸€æ¬¡hashï¼Œå°±ç›¸å½“äºå®Œæ•´åœ°è¿›è¡Œäº†ä¸€æ¬¡åœºæ™¯3ä¸­çš„æŠ•å¸å®éªŒã€‚æŒ‰ç…§çº¦å®šï¼Œå®éªŒå®Œæˆåï¼Œæˆ‘ä»¬éœ€è¦è®°å½•ç¡¬å¸æŠ•æ·çš„ç»“æœã€‚<br>å‡å®šç°åœ¨æœ‰2ä¸ªç”¨æˆ·idï¼›user1ã€user2<br>å…ˆå¯¹user1è¿›è¡Œhashï¼Œå‡å®šå¾—åˆ°å¦‚ä¸‹8ä¸ªbitçš„ç»“æœï¼š<br>10100100<br>æ­¤æ—¶ä»å³åˆ°å·¦ï¼Œæˆ‘ä»¬çº¦å®š0è¡¨ç¤ºåé¢ï¼Œ1è¡¨ç¤ºæ­£é¢ï¼Œäºæ˜¯åœ¨è¿™æ¬¡å®éªŒä¸­ï¼Œç¬¬ä¸€ä¸ªä¸º1çš„bitå‡ºç°åœ¨ç¬¬ä¸‰ä½ï¼Œç›¸å½“äºå…ˆæŠ•å‡ºäº†2æ¬¡åé¢ï¼Œç„¶åæŠ•å‡º1æ¬¡æ­£é¢ï¼Œäºæ˜¯æˆ‘ä»¬è®°å½•ä¸‹è¿™æ¬¡å®éªŒçš„æŠ•æ·æ¬¡æ•°ä¸º3ã€‚å› ä¸ºçº¦å®šåªè¦æŠ•å‡ºæ­£é¢ï¼Œå½“æ¬¡å®éªŒå°±ç»“æŸï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ª1å·¦è¾¹çš„æ‰€æœ‰bitå°±ä¸å†è€ƒè™‘äº†ã€‚<br>å†å¯¹user2è¿›è¡Œhashï¼Œå‡å®šå¾—åˆ°ï¼š<br>01101000<br>ç¬¬ä¸€ä¸ªä¸º1çš„bitå‡ºç°åœ¨ç¬¬4ä½ï¼Œäºæ˜¯è®°å½•ä¸‹4ã€‚<br>å¯¹äº<strong>æ¯ä¸ªç”¨æˆ·çš„è®¿é—®è¯·æ±‚ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥å¯¹ç”¨æˆ·çš„idè¿›è¡Œhash</strong>ï¼ˆç›¸å½“äºåœºæ™¯3ä¸­è¿›è¡Œä¸€æ¬¡å®éªŒï¼‰ï¼Œå¹¶è®°å½•ä¸‹ç¬¬ä¸€ä¸ªä¸º1çš„bitå‡ºç°çš„ä½æ•°ï¼ˆç›¸å½“äºåœºæ™¯3ä¸­è®°å½•ä¸‹ç¡¬å¸çš„æŠ•æ·æ¬¡æ•°ï¼‰ï¼Œé‚£ä¹ˆ<strong>é€šè¿‡è®°å½•åˆ°çš„ä½æ•°çš„æœ€å¤§å€¼ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¤§æ¦‚ä¼°è®¡å‡ºä¸€å…±è¿›è¡Œäº†å¤šå°‘æ¬¡å®éªŒ</strong>ï¼ˆç›¸å½“äºåœºæ™¯3ä¸­çš„åå‘æ¨æµ‹ï¼‰ï¼Œä¹Ÿå°±æ˜¯æœ‰å¤šå°‘ä¸ªä¸åŒçš„ç”¨æˆ·å‘ç”Ÿäº†è®¿é—®ã€‚<br>ä¾‹å¦‚æŸä¸ªé¡µé¢æœ‰è‹¥å¹²ä¸ªç”¨æˆ·è¿›è¡Œäº†è®¿é—®ï¼Œæˆ‘ä»¬è§‚å¯Ÿè®°å½•ä¸‹çš„æ•°æ®ï¼Œå‘ç°è®°å½•ä¸‹çš„æœ€å¤§å€¼æ˜¯10ï¼Œå°±æ„å‘³ç€hashçš„ç»“æœè‡³å°‘å‡ºç°äº†ä¸€æ¬¡å³è¾¹9ä¸ªbitéƒ½ä¸º0çš„æƒ…å†µã€‚è€Œè¿™ç§æƒ…å†µå‘ç”Ÿçš„æ¦‚ç‡ä¸º1&#x2F;1024ï¼Œäºæ˜¯æˆ‘ä»¬å¯ä»¥æ¨æµ‹å¤§æ¦‚æœ‰1024ä¸ªç”¨æˆ·è®¿é—®è¿‡è¯¥é¡µé¢ï¼Œæ‰æœ‰å¯èƒ½å‡ºç°ä¸€æ¬¡è¿™ç§ç»“æœã€‚</p><p>æ‰€ä»¥å…¶å®å¯ä»¥è¿™æ ·ç†è§£ï¼š</p><p>æ¯ä¸ªç”¨æˆ·IDçš„ hashç»“æœç›¸å½“äºæ­¤ç”¨æˆ·çš„æŠ•å¸ç»“æœï¼Œæˆ‘ä»¬çœ‹ä¸‹ hashå€¼ä»å³å‘å·¦ç¬¬ä¸€æ¬¡å‡ºç°1çš„ä½ç½®ã€‚å¦‚æœæ¯”ä¹‹å‰ç”¨æˆ·hashè®°å½•å‡ºç°1çš„ä½ç½®æ›´é å·¦ï¼Œåˆ™è®°å½•ã€‚è¿™æ ·å¦‚æœæœ€åè®°å½•çš„æœ€å¤§å€¼æ˜¯10ï¼Œåˆ™å¯ä»¥æ¨æµ‹1024ä¸ªç”¨æˆ·è®¿é—®è¿‡ã€‚</p><p>åˆå› ä¸ºåŒä¸€ç”¨æˆ·ID hashç»“æœæ˜¯å”¯ä¸€çš„ï¼Œæ‰€ä»¥åŒä¸€ä¸ªç”¨æˆ·IDå³ä½¿å¤šæ¬¡å®éªŒï¼Œä¹Ÿä¸ä¼šå½±å“ç²¾å‡†æ€§ã€‚å½“ç”¨æˆ·è¶Šå¤šï¼Œåˆ™æˆ‘ä»¬é€šè¿‡æ¦‚ç‡æ¨æµ‹çš„ç”¨æˆ·æ•°é‡ è¶Šæ¥è¿‘å®é™…æƒ…å†µã€‚</p><h3 id="4-5-å¸ƒéš†è¿‡æ»¤å™¨"><a href="#4-5-å¸ƒéš†è¿‡æ»¤å™¨" class="headerlink" title="4.5 å¸ƒéš†è¿‡æ»¤å™¨"></a>4.5 å¸ƒéš†è¿‡æ»¤å™¨</h3><p>HyperLogLog å¯ä»¥ç”¨æ¥è¿›è¡Œä¼°å€¼ï¼Œå®ƒéå¸¸æœ‰ä»·å€¼ï¼Œå¯ä»¥è§£å†³å¾ˆå¤šç²¾ç¡®åº¦è¦æ±‚ä¸é«˜çš„ç»Ÿè®¡éœ€æ±‚ã€‚ä½†æ˜¯å¦‚æœæˆ‘ä»¬æƒ³è¦çŸ¥é“æŸä¸€ä¸ªå€¼æ˜¯ä¸æ˜¯å·²ç»ä¸åœ¨ HyperLogLog ç»“æ„é‡Œé¢äº†ï¼Œå®ƒå°±æ— èƒ½ä¸ºåŠ›çš„ã€‚</p><p>ç°å®ä¸­ï¼Œæ¯”å¦‚æ¨èç³»ç»Ÿï¼šç”¨æˆ·çš„è§†é¢‘æ¨èç³»ç»Ÿï¼Œæ¯æ¬¡æ¨è éœ€è¦æŸ¥çœ‹ç”¨æˆ·æ˜¯å¦è§‚çœ‹è¿‡æ­¤è§†é¢‘ã€‚é—®é¢˜æ˜¯ï¼Œå½“ç”¨æˆ·é‡å¾ˆå¤§ï¼Œæ¯ä¸ªç”¨æˆ·è§‚çœ‹è¿‡çš„è§†é¢‘æ€»æ•°åˆå¾ˆå¤§çš„æƒ…å†µä¸‹ï¼Œå»é‡å·¥ä½œåœ¨åœ¨æ€§èƒ½ä¸Šè€ƒéªŒå¾ˆå¤§ã€‚å¦‚æœæ•°æ®å­˜å‚¨åœ¨ å…³ç³»æ•°æ®åº“ä¸­ï¼Œå»é‡å°±éœ€è¦é¢‘ç¹åœ°å¯¹æ•°æ®åº“è¿›è¡Œ exists æŸ¥è¯¢ã€‚</p><p>å¦‚æœä½¿ç”¨ç¼“å­˜ï¼Œä½†æ˜¯è¿™ä¹ˆå¤šå†å²è®°å½•å…¨éƒ¨ç¼“å­˜èµ·æ¥ï¼Œå°±å¾—æµªè´¹å¾ˆå¤šå­˜å‚¨ç©ºé—´ã€‚å¸ƒéš†è¿‡æ»¤å™¨å¯ä»¥è§£å†³æ­¤é—®é¢˜ï¼Œå®ƒå¯ä»¥èµ·åˆ°å»é‡çš„åŒæ—¶ï¼Œåœ¨ç©ºé—´ä¸Šè¿˜èƒ½èŠ‚çœ90%ä»¥ä¸Šï¼Œåªæ˜¯ç¨å¾®é‚£ä¹ˆä¸ç²¾ç¡®ã€‚</p><p>å½“å¸ƒéš†è¿‡æ»¤å™¨è¯´ æŸä¸ªå€¼å­˜åœ¨æ—¶ï¼Œè¿™ä¸ªå€¼å¯èƒ½ä¸å­˜åœ¨ï¼›å½“å®ƒè¯´è¿™ä¸ªå€¼ä¸å­˜åœ¨æ—¶ï¼Œé‚£å°±è‚¯å®šä¸å­˜åœ¨ã€‚</p><p>é‚£ä¹ˆå¯ä»¥ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ åˆ¤æ–­ éœ€è¦æ¨èçš„æ—¶å€™ï¼Œæ˜¯å¦åœ¨ç”¨æˆ·è§‚çœ‹å†å²è®°å½•é›†åˆä¸­ã€‚å¦‚æœä¸åœ¨ï¼Œåˆ™æ¨èã€‚å¦‚æœåˆ¤æ–­åœ¨å†å²è®°å½•ä¸­ï¼Œå®é™…å¯èƒ½åœ¨ ä¹Ÿå¯èƒ½ä¸åœ¨ï¼Œå› ä¸ºä¼šæœ‰æ¦‚ç‡è¯¯åˆ¤ã€‚æ‰€ä»¥ å¯ä»¥ä¿è¯æ¨èçš„å†…å®¹è‚¯å®šæ˜¯ç”¨æˆ·æ²¡çœ‹è¿‡çš„ï¼Œä½†å¯èƒ½ ä¹Ÿä¼šæŠŠæå°‘é‡ç”¨æˆ·æ²¡æœ‰çœ‹è¿‡çš„å†…å®¹ è¯¯åˆ¤æˆç”¨æˆ·çœ‹è¿‡ï¼Œè€Œè¿‡æ»¤æ‰ã€‚</p><h4 id="4-5-1-åŸºæœ¬ä½¿ç”¨"><a href="#4-5-1-åŸºæœ¬ä½¿ç”¨" class="headerlink" title="4.5.1 åŸºæœ¬ä½¿ç”¨"></a>4.5.1 åŸºæœ¬ä½¿ç”¨</h4><p>Rediså®˜æ–¹æä¾›çš„å¸ƒéš†è¿‡æ»¤å™¨åˆ°äº†Redis4.0æä¾›äº†æ’ä»¶åŠŸèƒ½ä¹‹åæ­£å¼ç™»åœºã€‚å¯ä»¥é€šè¿‡dockerç›´æ¥ä½“éªŒ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; docker pull redislabs/rebloom</span><br><span class="line">&gt; docker run -p 6379:6379 redislabs/rebloom</span><br><span class="line">&gt; redis-cli</span><br></pre></td></tr></table></figure><p>å¸ƒéš†è¿‡æ»¤å™¨åŸºæœ¬æŒ‡ä»¤ï¼š</p><ul><li>bf.add [collection] [element]ï¼šæ·»åŠ  å…ƒç´ element è¿›å…¥ è¿‡æ»¤å™¨collection</li><li>bf.exists [collection] [element]ï¼šæŸ¥è¯¢ å…ƒç´ element æ˜¯å¦å­˜åœ¨ï¼Œè¿”å›1è¡¨ç¤ºå­˜åœ¨ï¼Œ0è¡¨ç¤ºä¸å­˜åœ¨</li><li>bf.madd [collection] [element01] [element02]ï¼šä¸€æ¬¡ æ·»åŠ å¤šä¸ª å…ƒç´ è¿›å…¥ è¿‡æ»¤å™¨</li><li>bf.mexistsï¼šä¸€æ¬¡ æŸ¥è¯¢å¤šä¸ªå…ƒç´  æ˜¯å¦åœ¨è¿‡æ»¤å™¨</li></ul><p>ä¸Šé¢æŒ‡ä»¤ä½¿ç”¨çš„å¸ƒéš†è¿‡æ»¤å™¨åªæ˜¯é»˜è®¤å‚æ•°çš„å¸ƒéš†è¿‡æ»¤å™¨ï¼Œå®ƒåœ¨å¤–é¢ç¬¬ä¸€æ¬¡addçš„æ—¶å€™è¢«è‡ªåŠ¨åˆ›å»ºã€‚Redisè¿˜æä¾›äº†è‡ªå®šä¹‰å‚æ•°çš„å¸ƒéš†è¿‡æ»¤å™¨ï¼Œéœ€è¦æˆ‘ä»¬åœ¨ add ä¹‹å‰ï¼Œä½¿ç”¨ bf.reserve æŒ‡ä»¤æ˜¾å¼åˆ›å»ºã€‚å¦‚æœå¯¹åº”çš„keyå·²ç»å­˜åœ¨äº†ï¼Œbf.reserve ä¼šæŠ¥é”™ã€‚bf.reserve æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ keyï¼Œerror_rate å’Œ initial_sizeã€‚é”™è¯¯ç‡è¶Šä½ï¼Œéœ€è¦çš„ç©ºé—´è¶Šå¤§ã€‚initial_size å‚æ•°è¡¨ç¤ºé¢„è®¡æ”¾å…¥çš„å…ƒç´ æ•°é‡ï¼Œå½“å®é™…æ•°é‡è¶…è¿‡è¿™ä¸ªå€¼ï¼Œè¯¯åˆ¤ç‡ä¼šä¸Šå‡ã€‚æ‰€ä»¥ä¸€èˆ¬ initial_size éœ€è¦è®¾ç½®ä¸€ä¸ªè¾ƒå¤§çš„æ•°å€¼ï¼Œé¿å…è¶…è¿‡ï¼Œå¯¼è‡´è¯¯åˆ¤ç‡å‡é«˜ã€‚å¦‚æœä¸ä½¿ç”¨ bf.reserveï¼Œé»˜è®¤çš„ error_rate æ˜¯ 0.01,é»˜è®¤çš„ initial_size æ˜¯ 100ã€‚</p><p>æ³¨æ„ï¼šå¦‚æœ initial_size ä¼°è®¡çš„è¿‡å¤§ï¼Œä¹Ÿä¼šæµªè´¹å­˜å‚¨ç©ºé—´ï¼Œä¼°è®¡çš„è¿‡å°ï¼Œå°±ä¼šå½±å“å‡†ç¡®ç‡ã€‚</p><h4 id="4-5-2-åŸç†"><a href="#4-5-2-åŸç†" class="headerlink" title="4.5.2 åŸç†"></a>4.5.2 åŸç†</h4><p>æ¯ä¸ªå¸ƒéš†è¿‡æ»¤å™¨åœ¨Redisçš„æ•°æ®ç»“æ„é‡Œé¢å°±æ˜¯ ä¸€ä¸ªå¤§å‹çš„ä½æ•°ç»„å’Œå‡ ä¸ªä¸ä¸€æ ·çš„æ— åhashå‡½æ•°ã€‚æ‰€ä»¥æ— åå°±æ˜¯èƒ½å¤ŸæŠŠå…ƒç´ çš„ hashå€¼ ç®—çš„æ¯”è¾ƒå‡åŒ€ã€‚</p><p>å‘è¿‡æ»¤å™¨ä¸­æ·»åŠ keyæ—¶ï¼Œä¼šä½¿ç”¨å¤šä¸ª hash å‡½æ•°å¯¹ key è¿›è¡Œ hashç®—å¾—ä¸€ä¸ªæ•´æ•°ç´¢å¼•å€¼ï¼Œç„¶åå¯¹ä½æ•°ç»„é•¿åº¦è¿›è¡Œå–æ¨¡è¿ç®—ï¼Œå¾—åˆ°ä¸€ä¸ªä½ç½®ã€‚æ¯ä¸ª hash å‡½æ•°éƒ½ä¼šç®—å¾—ä¸€ä¸ªä¸åŒçš„ä½ç½®ã€‚å†æŠŠä½æ•°ç»„çš„è¿™å‡ ä¸ªä½ç½®éƒ½ç½®ä¸º1ï¼Œå°±å®Œæˆäº† add æ“ä½œã€‚</p><p>å‘å¸ƒéš†è¿‡æ»¤å™¨è¯¢é—® key æ˜¯å¦å­˜åœ¨æ—¶ï¼Œè·Ÿ add ä¸€æ ·ï¼Œä¹Ÿä¼šæŠŠ hash å‡½æ•°çš„å‡ ä¸ªä½ç½®éƒ½è®¡ç®—å‡ºæ¥ï¼Œçœ‹çœ‹ ä½æ•°ç»„ä¸­ è¿™å‡ ä¸ªä½ç½®æ˜¯å¦éƒ½ ä¸º1ï¼Œåªè¦æœ‰ä¸€ä¸ªä¸º 0ï¼Œé‚£ä¹ˆè¯´æ˜å¸ƒéš†è¿‡æ»¤å™¨ä¸­ è¿™ä¸ªkeyä¸å­˜åœ¨ã€‚å¦‚æœéƒ½æ˜¯1ï¼Œè¿™å¹¶ä¸èƒ½è¯´æ˜è¿™ä¸ªkeyå°±ä¸€å®šå­˜åœ¨ï¼Œåªæ˜¯ææœ‰å¯èƒ½å­˜åœ¨ã€‚å› ä¸ºè¿™äº›ä½è¢«ç½®æˆ1ï¼Œå¯èƒ½æ˜¯å› ä¸ºæ·»åŠ å…¶ä»– key æ—¶å¯¼è‡´çš„ã€‚</p><p>å¦‚æœè¿™ä¸ª ä½æ•°ç»„æ¯”è¾ƒç¨€ç–ï¼Œè¿™ä¸ªè¯¯åˆ¤çš„æ¦‚ç‡å°±å¾ˆå°ï¼Œå¦‚æœè¿™ä¸ªæ•°ç»„æ¯”è¾ƒæ‹¥æŒ¤ï¼Œè¯¯åˆ¤çš„æ¦‚ç‡å°±ä¼šå˜å¤§ã€‚ä½¿ç”¨æ—¶å¦‚æœå®é™…å…ƒç´ å¼€å§‹è¶…è¿‡åˆå§‹åŒ–å¤§å°ï¼Œåº”è¯¥å¯¹å¸ƒéš†è¿‡æ»¤å™¨è¿›è¡Œé‡å»ºï¼Œé‡æ–°åˆ†é…ä¸€ä¸ªsizeæ›´å¤§çš„è¿‡æ»¤å™¨ï¼Œå†å°†æ‰€æœ‰å†å²å…ƒç´ æ‰¹é‡ add è¿›å»ã€‚</p><h4 id="4-5-3-ç©ºé—´å ç”¨ä¼°è®¡"><a href="#4-5-3-ç©ºé—´å ç”¨ä¼°è®¡" class="headerlink" title="4.5.3 ç©ºé—´å ç”¨ä¼°è®¡"></a>4.5.3 ç©ºé—´å ç”¨ä¼°è®¡</h4><p>å¸ƒéš†è¿‡æ»¤å™¨æœ‰ä¸¤ä¸ªå‚æ•°ï¼šç¬¬ä¸€ä¸ªæ˜¯é¢„è®¡å…ƒç´ çš„æ•°é‡nï¼Œç¬¬äºŒä¸ªæ˜¯é”™è¯¯ç‡ fã€‚å…¬å¼æ ¹æ®è¿™ä¸¤ä¸ªè¾“å…¥ å¾—åˆ°ä¸¤ä¸ªè¾“å‡ºï¼Œç¬¬ä¸€ä¸ªè¾“å‡ºæ˜¯ ä½æ•°ç»„çš„é•¿åº¦iï¼Œä¹Ÿå°±æ˜¯éœ€è¦çš„å­˜å‚¨ç©ºé—´å¤§å°ï¼ˆbitï¼‰ï¼Œç¬¬äºŒä¸ªè¾“å‡ºæ˜¯ hash å‡½æ•°çš„æœ€ä½³æ•°é‡ kã€‚hashå‡½æ•°çš„æ•°é‡ä¹Ÿä¼šç›´æ¥å½±å“åˆ°é”™è¯¯ç‡ï¼Œæœ€ä½³çš„æ•°æ®ä¼šæœ‰æœ€ä½çš„é”™è¯¯ç‡ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">k = 0.7 * (i/n)  # çº¦ç­‰äº</span><br><span class="line">f = 0.6185^(i/n)# ^è¡¨ç¤ºæ¬¡æ–¹è®¡ç®—</span><br></pre></td></tr></table></figure><p>ä»å…¬å¼å¯ä»¥çœ‹å‡ºï¼š</p><ul><li>ä½æ•°ç»„ ç›¸å¯¹è¶Šé•¿(i&#x2F;n)ï¼Œé”™è¯¯ç‡ f è¶Šä½</li><li>ä½æ•°ç»„ ç›¸å¯¹è¶Šé•¿(i&#x2F;n)ï¼Œhashå‡½æ•°éœ€è¦çš„æœ€ä½³æ•°é‡ä¹Ÿè¶Šå¤šï¼Œå½±å“è®¡ç®—æ•ˆç‡</li><li>å½“ä¸€ä¸ªå…ƒç´ å¹³å‡éœ€è¦ 1ä¸ªå­—èŠ‚(8 bit)çš„æŒ‡çº¹ç©ºé—´(i&#x2F;n&#x3D;8)ï¼Œé”™è¯¯ç‡å¤§çº¦2%</li><li>é”™è¯¯ç‡ä¸º10%ï¼Œä¸€ä¸ªå…ƒç´ éœ€è¦çš„å¹³å‡æŒ‡çº¹ç©ºé—´ä¸º 4.792ä¸ªbit</li><li>é”™è¯¯ç‡ä¸º0.1%ï¼Œä¸€ä¸ªå…ƒç´ éœ€è¦çš„å¹³å‡æŒ‡çº¹ç©ºé—´ä¸º 14.377ä¸ªbit</li></ul><p>ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼Œä¸€ä¸ªå…ƒç´ éœ€è¦å æ®15bitï¼Œé‚£ç›¸å¯¹seté›†åˆçš„ç©ºé—´ä¼˜åŠ¿æ˜¯ä¸æ˜¯å°±æ²¡æœ‰é‚£ä¹ˆæ˜æ˜¾äº†ï¼Ÿsetä¸­ä¼šå­˜å‚¨æ¯ä¸ªå…ƒç´ çš„å†…å®¹ï¼Œè€Œå¸ƒéš†è¿‡æ»¤å™¨ä»…ä»…å­˜å‚¨å…ƒç´ çš„æŒ‡çº¹ã€‚å…ƒç´ çš„å†…å®¹å¤§å°å°±æ˜¯å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œå®ƒä¸€èˆ¬æœ‰å¤šä¸ªå­—èŠ‚ç”šè‡³å‡ åä¸ªå­—èŠ‚ï¼Œæ¯ä¸ªå…ƒç´ æœ¬èº«è¿˜éœ€è¦ä¸€ä¸ªæŒ‡é’ˆè¢«seté›†åˆæ¥å¼•ç”¨ã€‚</p><h3 id="4-6-ç®€å•é™æµ"><a href="#4-6-ç®€å•é™æµ" class="headerlink" title="4.6 ç®€å•é™æµ"></a>4.6 ç®€å•é™æµ</h3><p>åœ¨Redisä¸­ï¼Œå¯ä»¥ä½¿ç”¨ ZSet æ•°æ®ç»“æ„ å®ç°è¯¥åŠŸèƒ½ã€‚å¯ä»¥æŠŠ zset ä¸­çš„ score å€¼è®¾ç½®ä¸º æ—¶é—´æˆ³ ï¼Œè¿™æ ·å°±å¯ä»¥åœˆå‡ºä¸€ä¸ªæ—¶é—´æ®µå†…çš„æ‰€æœ‰æ•°æ®ã€‚å³ åªè¦ æ—¶é—´çª—å£å†…çš„æ•°æ®ï¼Œæ—¶é—´çª—å£å¤–çš„æ•°æ®éƒ½å¯ä»¥ç æ‰ã€‚é‚£ä¹ˆ zset çš„value å¡«ä»€ä¹ˆå€¼å‘¢ï¼Œä¹Ÿå¯ä»¥å¡«æ—¶é—´æˆ³ï¼Œåªéœ€ä¿è¯å…¶å”¯ä¸€æ€§å°±è¡Œã€‚</p><p>è¿™æ ·å°±å¯ä»¥ ç”¨ ZSet è®°å½•ç”¨æˆ·çš„è¡Œä¸ºå†å²ï¼Œæ¯ä¸ªè¡Œä¸ºéƒ½ä¼šä½œä¸ºä¸€ä¸ª zset ä¸­çš„ä¸€ä¸ª key ä¿å­˜ä¸‹æ¥ã€‚åŒä¸€ä¸ªç”¨æˆ·åŒä¸€ç§è¡Œä¸º ä¼šä½¿ç”¨ä¸€ä¸ª zset è®°å½•ã€‚ä¸ºäº†èŠ‚çœå†…å­˜ï¼Œæˆ‘ä»¬åªéœ€è¦ä¿ç•™æ—¶é—´çª—å£å†…çš„è¡Œä¸ºè®°å½•ï¼ŒåŒæ—¶å¦‚æœç”¨æˆ·æ˜¯å†·ç”¨æˆ·ï¼Œæ»‘åŠ¨æ—¶é—´çª—å£å†…çš„è¡Œä¸ºæ˜¯ç©ºè®°å½•ï¼Œé‚£ä¹ˆè¿™ä¸ª zset å°±å¯ä»¥ä»å†…å­˜ä¸­ç§»é™¤ï¼Œä¸å†å ç”¨ç©ºé—´ã€‚</p><p>é€šè¿‡ç»Ÿè®¡æ»‘åŠ¨çª—å£å†…çš„è¡Œä¸ºæ•°é‡ä¸é˜ˆå€¼ max_count è¿›è¡Œæ¯”è¾ƒå°±å¯ä»¥å¾—å‡ºå½“å‰çš„è¡Œä¸ºæ˜¯å¦å…è®¸ã€‚</p><p>æ•´ä½“æ€è·¯ï¼šæ¯ä¸€ä¸ªè¡Œä¸ºåˆ°æ¥æ—¶ï¼Œéƒ½ç»´æŠ¤ä¸€æ¬¡æ—¶é—´çª—å£ã€‚å°†æ—¶é—´çª—å£å¤–çš„è®°å½•å…¨éƒ¨æ¸…ç†æ‰ï¼Œåªä¿ç•™çª—å£å†…çš„è®°å½•ã€‚zseté›†åˆä¸­ åªæœ‰ score å€¼éå¸¸é‡è¦ï¼Œvalueæ²¡æœ‰ç‰¹åˆ«çš„æ„ä¹‰ã€‚</p><p>ç¼ºç‚¹ï¼šè¦è®°å½•æ—¶é—´çª—å£å†…æ‰€æœ‰çš„è¡Œä¸ºè®°å½•ã€‚å¦‚æœè¿™ä¸ªé‡å¾ˆå¤§ï¼Œæ¯”å¦‚é™å®š 60s å†…æ“ä½œä¸å¾—è¶…è¿‡ 100w æ¬¡ï¼Œé‚£ä¹ˆè¿™å°±ä¸é€‚åˆè¿™æ ·åšé™æµäº†ï¼Œå› ä¸ºä¼šæ¶ˆè€—å¤§é‡çš„å­˜å‚¨ç©ºé—´ã€‚</p><h3 id="4-7-æ¼æ–—é™æµ"><a href="#4-7-æ¼æ–—é™æµ" class="headerlink" title="4.7 æ¼æ–—é™æµ"></a>4.7 æ¼æ–—é™æµ</h3><p>Redis4.0 æä¾›äº†ä¸€ä¸ªé™æµ Redis æ¨¡å—ï¼Œå®ƒå« redis-cellã€‚è¯¥æ¨¡å—ä¹Ÿä½¿ç”¨äº†æ¼æ–—ç®—æ³•ï¼Œå¹¶æä¾›äº†åŸå­çš„é™æµæŒ‡ä»¤ã€‚</p><p>è¯¥æ¨¡å—åªæœ‰1æ¡æŒ‡ä»¤ cl.throttle ï¼Œå®ƒçš„å‚æ•°å’Œè¿”å›å€¼éƒ½ç•¥æ˜¾å¤æ‚ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt; cl.throttle key 15 30 60 1</span><br><span class="line"># keyæ˜¯é”®å </span><br><span class="line"># ç¬¬äºŒä¸ªå‚æ•°æ˜¯ æ¼æ–—å®¹é‡</span><br><span class="line"># ç¬¬ä¸‰ä¸ªå‚æ•°ã€ç¬¬å››ä¸ªå‚æ•° è¡¨ç¤º 60så†… æœ€å¤š 30æ¬¡ï¼ˆå¯ä»¥å½“ä½œæ¼æ–—çš„æµé€Ÿï¼‰</span><br><span class="line"># ç¬¬äº”ä¸ªå‚æ•°ä¸º å¯é€‰å‚æ•°,é»˜è®¤ä¸º1.</span><br><span class="line"> </span><br><span class="line">æŒ‡ä»¤ä¼šè¿”å›äº”ä¸ªå‚æ•°ï¼Œåˆ†åˆ«è¡¨ç¤ºï¼š</span><br><span class="line"># 0è¡¨ç¤ºå…è®¸ï¼Œ1è¡¨ç¤ºæ‹’æ¥</span><br><span class="line"># æ¼æ–—å®¹é‡</span><br><span class="line"># æ¼æ–—å‰©ä½™ç©ºé—´</span><br><span class="line"># å¦‚æœæ‹’æ¥äº†ï¼Œéœ€è¦å¤šé•¿æ—¶é—´ä¹‹åå†è¯•ï¼ˆå¤šä¹…åæ¼æ–—æœ‰ç©ºé—´ï¼Œå•ä½ç§’ï¼‰</span><br><span class="line"># å¤šé•¿æ—¶é—´åï¼Œæ¼æ–—å®Œå…¨ç©ºå‡ºæ¥ï¼ˆå•ä½ç§’ï¼‰</span><br></pre></td></tr></table></figure><p>åœ¨æ‰§è¡Œé™æµæŒ‡ä»¤æ—¶ï¼Œå¦‚æœè¢«æ‹’ç»äº†ï¼Œå°±éœ€è¦ä¸¢å¼ƒæˆ–é‡è¯•ï¼Œcl.throttle æŒ‡ä»¤è€ƒè™‘çš„éå¸¸å‘¨åˆ°ï¼Œè¿é‡è¯•æ—¶é—´ç»™æˆ‘ä»¬äº†ï¼Œç›´æ¥å–è¿”å›ç»“æœæ•°ç»„çš„ç¬¬å››ä¸ªå€¼è¿›è¡Œ sleep å³å¯ï¼Œå¦‚æœä¸æƒ³å µå¡çº¿ç¨‹ï¼Œä¹Ÿå¯ä»¥å¼‚æ­¥å®šæ—¶ä»»åŠ¡æ¥é‡è¯•ã€‚</p><h3 id="4-8-è¿‘æ°´æ¥¼å°-GeoHash"><a href="#4-8-è¿‘æ°´æ¥¼å°-GeoHash" class="headerlink" title="4.8 è¿‘æ°´æ¥¼å°-GeoHash"></a>4.8 è¿‘æ°´æ¥¼å°-GeoHash</h3><p>Redisåœ¨ 3.2 ç‰ˆæœ¬ä»¥åå¢åŠ äº† GEO æ¨¡å—ï¼Œæ„å‘³ç€æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Redis æ¥å®ç° å¾®ä¿¡[é™„è¿‘çš„äºº]ã€ç¾å›¢[é™„ä»¶çš„é¤é¦†]è¿™æ ·çš„åŠŸèƒ½äº†ã€‚</p><h4 id="4-8-1-ç”¨æ•°æ®åº“æ¥ç®—é™„è¿‘çš„äºº"><a href="#4-8-1-ç”¨æ•°æ®åº“æ¥ç®—é™„è¿‘çš„äºº" class="headerlink" title="4.8.1 ç”¨æ•°æ®åº“æ¥ç®—é™„è¿‘çš„äºº"></a>4.8.1 ç”¨æ•°æ®åº“æ¥ç®—é™„è¿‘çš„äºº</h4><p>åœ°å›¾å…ƒç´ çš„ä½ç½®æ•°æ®ä½¿ç”¨äºŒç»´çš„ç»çº¬åº¦è¡¨ç¤ºï¼Œç»åº¦èŒƒå›´ (-180,180]ï¼Œçº¬åº¦èŒƒå›´ (-90,90],çº¬åº¦æ­£è´Ÿä»¥èµ¤é“ä¸ºç•Œï¼ŒåŒ—æ­£å—è´Ÿï¼Œç»åº¦æ­£è´Ÿä»¥æœ¬åˆå­åˆçº¿ä¸ºç•Œï¼Œä¸œæ­£è¥¿è´Ÿã€‚</p><p>å½“ä¸¤ä¸ªè·ç¦»ä¸æ˜¯å¾ˆè¿œæ—¶ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨å‹¾è‚¡å®šç†å°±èƒ½ç®—å¾—å…ƒç´ ä¹‹é—´çš„è·ç¦»ã€‚å¹³æ—¶ä½¿ç”¨çš„ [é™„è¿‘çš„äºº] çš„åŠŸèƒ½ï¼Œå…ƒç´ è·ç¦»éƒ½ä¸æ˜¯å¾ˆå¤§ï¼Œå‹¾è‚¡å®šç†ç®—è·ç¦»è¶³ä»¥ã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç»çº¬åº¦åæ ‡çš„å¯†åº¦ä¸ä¸€æ ·ï¼ˆç»åº¦æ€»å…±360åº¦ï¼Œçº¬åº¦æ€»å…±180åº¦ï¼‰ï¼Œå‹¾è‚¡å®šç†è®¡ç®—å¹³æ–¹å·®æ—¶ä¹‹åå†æ±‚å’Œæ—¶ï¼Œéœ€è¦æŒ‰ä¸€å®šçš„ç³»æ•°æ¯”åŠ æƒæ±‚å’Œã€‚</p><p>å¦‚æœä½¿ç”¨å…³ç³»å‹æ•°æ®åº“ï¼ŒåŸºæœ¬é‡‡ç”¨ï¼ˆå…ƒç´ ID,ç»åº¦,çº¬åº¦ï¼‰å­˜å‚¨ã€‚é‚£æ­¤æ—¶å°±å¾ˆéš¾é€šè¿‡éå†æ¥è®¡ç®—æ‰€æœ‰çš„å…ƒç´ å’Œç›®æ ‡å…ƒç´ çš„è·ç¦»ç„¶åå†è¿›è¡Œæ’åºï¼Œè¿™ä¸ªè®¡ç®—é‡å¤ªå¤§äº†ï¼Œæ€§èƒ½æŒ‡æ ‡è‚¯å®šæ— æ³•æ»¡è¶³ã€‚ä¸€èˆ¬çš„æ–¹æ³•éƒ½æ˜¯é€šè¿‡çŸ©å½¢åŒºåŸŸæ¥é™å®šå…ƒç´ çš„æ•°é‡ï¼Œç„¶åå¯¹åŒºåŸŸå†…çš„å…ƒç´ è¿›è¡Œ å…¨é‡è·ç¦» è®¡ç®—å†æ’åºã€‚</p><p>ä¸ºäº†æ»¡è¶³é«˜æ€§èƒ½çš„çŸ©å½¢åŒºåŸŸç®—æ³•ï¼Œæ•°æ®è¡¨éœ€è¦åœ¨ç»çº¬åº¦åæ ‡ä¸ŠåŠ ä¸ŠåŒå‘å¤åˆç´¢å¼•ï¼ˆx,yï¼‰ï¼Œè¿™æ ·å¯ä»¥æœ€å¤§ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ã€‚ä½†æ˜¯æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½æ¯•ç«Ÿæœ‰é™ï¼Œå¦‚æœ é™„è¿‘çš„äºº æŸ¥è¯¢è¯·æ±‚éå¸¸å¤šï¼Œåœ¨é«˜å¹¶å‘åœºåˆï¼Œè¿™å¯èƒ½å¹¶ä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ–¹æ¡ˆã€‚</p><h4 id="4-8-2-GeoHashç®—æ³•"><a href="#4-8-2-GeoHashç®—æ³•" class="headerlink" title="4.8.2 GeoHashç®—æ³•"></a>4.8.2 GeoHashç®—æ³•</h4><p>ä¸šç•Œæ¯”è¾ƒé€šç”¨çš„åœ°ç†è·ç¦»æ’åºç®—æ³•æ˜¯ GeoHash ç®—æ³•ï¼ŒRedis ä¹Ÿä½¿ç”¨ GeoHash ç®—æ³•ã€‚GeoHash ç®—æ³•å°†äºŒç»´çš„ç»çº¬åº¦æ•°æ®æ˜ å°„åˆ°ä¸€ç»´çš„æ•´æ•°ï¼Œè¿™æ ·æ‰€æœ‰çš„å…ƒç´ éƒ½å°†æŒ‚è½½åˆ°ä¸€æ¡çº¿ä¸Šï¼Œè·ç¦»é è¿‘çš„äºŒç»´åæ ‡æ˜ å°„åˆ°ä¸€ç»´åçš„ç‚¹ä¹‹é—´è·ç¦»ä¹Ÿä¼šå¾ˆè¿‘ã€‚å½“æˆ‘ä»¬æƒ³è¦è®¡ç®— [é™„è¿‘çš„äººæ—¶]ï¼Œé¦–å…ˆå°†ç›®æ ‡çš„ä½ç½® æ˜ å°„åˆ°è¿™æ¡çº¿ä¸Šï¼Œç„¶ååœ¨è¿™ä¸ªä¸€ç»´çš„çº¿ä¸Šè·å–é™„è¿‘çš„ç‚¹å°±è¡Œäº†ã€‚</p><p>é‚£è¿™ä¸ªæ˜ å°„ç®—æ³•å…·ä½“æ˜¯æ€ä¹ˆè®¡ç®—çš„ï¼Ÿå®ƒå°†æ•´ä¸ªåœ°çƒçœ‹æˆä¸€ä¸ªäºŒç»´å¹³é¢ï¼Œç„¶ååˆ’åˆ†æˆäº†ä¸€ç³»åˆ—æ­£æ–¹å½¢çš„æ–¹æ ¼ï¼Œå°±å¥½æ¯”å›´æ£‹æ£‹ç›˜ã€‚æ‰€æœ‰çš„åœ°å›¾å…ƒç´ åæ ‡éƒ½å°†æ”¾ç½®äºå”¯ä¸€çš„æ–¹æ ¼ä¸­ã€‚æ–¹æ ¼è¶Šå°ï¼Œåæ ‡è¶Šç²¾ç¡®ã€‚ç„¶åå¯¹è¿™äº›æ–¹æ ¼è¿›è¡Œæ•´æ•°ç¼–ç ï¼Œè¶Šæ˜¯é è¿‘çš„æ–¹æ ¼ç¼–ç è¶Šæ˜¯æ¥è¿‘ã€‚é‚£å¦‚ä½•ç¼–ç å‘¢ï¼Ÿä¸€ä¸ªæœ€ç®€å•çš„æ–¹æ¡ˆå°±æ˜¯åˆ‡è›‹ç³•æ³•ã€‚è®¾æƒ³ä¸€ä¸ªæ­£æ–¹å½¢çš„è›‹ç³•æ‘†åœ¨ä½ é¢å‰ï¼ŒäºŒåˆ€ä¸‹å»å‡åˆ†åˆ†æˆå››ä¸ªå°æ­£æ–¹å½¢ï¼Œè¿™å››ä¸ªå°æ­£æ–¹å½¢å¯ä»¥åˆ†åˆ«æ ‡è®°ä¸º00ï¼Œ01ï¼Œ10ï¼Œ11å››ä¸ªäºŒè¿›åˆ¶æ•´æ•°ã€‚ç„¶åå¯¹æ¯ä¸ªå°æ­£æ–¹å½¢ç»§ç»­ç”¨äºŒåˆ†åˆ€æ³•åˆ‡å‰²ä¸€ä¸‹ï¼Œè¿™æ—¶æ¯ä¸ªå°å°æ­£æ–¹å½¢ä½¿ç”¨4bitçš„äºŒè¿›åˆ¶æ•´æ•°äºˆä»¥è¡¨ç¤ºã€‚ç„¶åç»§ç»­åˆ‡ä¸‹å»ï¼Œæ­£æ–¹å½¢å°±ä¼šè¶Šæ¥è¶Šå°ï¼ŒäºŒè¿›åˆ¶æ•´æ•°ä¹Ÿä¼šè¶Šæ¥è¶Šé•¿ï¼Œç²¾ç¡®åº¦å°±ä¼šè¶Šæ¥è¶Šé«˜ã€‚</p><p>ä¸Šé¢ä½¿ç”¨çš„æ˜¯äºŒåˆ€æ³•ï¼Œè¿›è¡Œç¼–ç ã€‚å®é™…ä¸Šè¿˜æœ‰å…¶ä»–å¾ˆå¤šæ–¹æ³•è¿›è¡Œç¼–ç ã€‚</p><p>ç¼–ç ä¹‹åï¼Œæ¯ä¸ªåœ°å›¾å…ƒç´ çš„åæ ‡éƒ½å°†å˜æˆä¸€ä¸ªæ•´æ•°ï¼Œé€šè¿‡è¿™ä¸ªæ•´æ•°å¯ä»¥è¿˜åŸå‡ºå…ƒç´ çš„åæ ‡ï¼Œæ•´æ•°è¶Šé•¿ï¼Œè¿˜åŸå‡ºæ¥çš„åæ ‡å€¼çš„æŸå¤±ç¨‹åº¦å°±è¶Šå°ã€‚GeoHashç®—æ³•ä¼šç»§ç»­å¯¹è¿™ä¸ªæ•´æ•°åšä¸€æ¬¡ base32 ç¼–ç ï¼ˆ0-9,a-zå»æ‰a,i,l,oå››ä¸ªå­—æ¯ï¼‰å˜æˆä¸€ä¸ªå­—ç¬¦ä¸²ã€‚åœ¨Redisé‡Œé¢ï¼Œç»çº¬åº¦ä½¿ç”¨52ä½çš„æ•´æ•°è¿›è¡Œç¼–ç ï¼Œæ”¾è¿›äº†zseté‡Œé¢ï¼Œzsetçš„ value å…ƒç´ çš„keyï¼Œscore æ˜¯ GeoHash çš„52ä½çš„æ•´æ•°å€¼ã€‚zset çš„ score è™½ç„¶æ˜¯æµ®ç‚¹æ•°ï¼Œä½†æ˜¯å¯¹äº 52ä½çš„æ•´æ•°å€¼ï¼Œå®ƒå¯ä»¥æ— æŸå­˜å‚¨ã€‚</p><p>åœ¨ä½¿ç”¨ Redis è¿›è¡Œ Geo æŸ¥è¯¢æ—¶ï¼Œæˆ‘ä»¬è¦æ—¶åˆ»æƒ³åˆ°å®ƒçš„å†…éƒ¨ç»“æ„å®é™…ä¸Šåªæ˜¯ä¸€ä¸ª zset(skiplist)ã€‚é€šè¿‡ zset çš„ score æ’åºå°±è¦å¯ä»¥å¾—åˆ°åæ ‡é™„è¿‘çš„å…¶ä»–å…ƒç´ ï¼ˆå®é™…æƒ…å†µè¦å¤æ‚ä¸€ç‚¹ï¼‰ï¼Œé€šè¿‡å°† score è¿˜åŸæˆåæ ‡å€¼å°±å¯ä»¥å¾—åˆ°å…ƒç´ çš„åŸå§‹åæ ‡ã€‚</p><h4 id="4-8-3-åŸºæœ¬ä½¿ç”¨"><a href="#4-8-3-åŸºæœ¬ä½¿ç”¨" class="headerlink" title="4.8.3 åŸºæœ¬ä½¿ç”¨"></a>4.8.3 åŸºæœ¬ä½¿ç”¨</h4><p>Redis æä¾›çš„ Geo æŒ‡ä»¤åªæœ‰ 6 ä¸ªã€‚</p><ul><li>å¢åŠ geoadd æŒ‡ä»¤æºå¸¦ é›†åˆåç§°ä»¥åŠå¤šä¸ªç»çº¬åº¦åç§°ä¸‰å…ƒç»„ã€‚è¿™é‡Œä¹Ÿå¯ä»¥ä¸€æ¬¡æ€§ æ·»åŠ å¤šä¸ªå…ƒç»„ã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># å®é™…ä½¿ç”¨</span><br><span class="line">127.0.0.1:6379&gt; geoadd company 116.48105 39.996794 x</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; geoadd company 116.48105 39.996794 xr</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; geoadd company 116.48110 39.996894 xrt</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; geoadd company 116.48410 39.996294 xrty 112.14517 38.12541 xrtu</span><br><span class="line">(integer) 2</span><br></pre></td></tr></table></figure><p>Redis æ²¡æœ‰æä¾› geo åˆ é™¤æŒ‡ä»¤ï¼Œä½†æ˜¯å› ä¸º geo çš„åº•å±‚å®ç°æ˜¯ zsetï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨ zrem key member å‘½ä»¤å®ç°å¯¹ åœ°ç†ä½ç½®ä¿¡æ¯çš„åˆ é™¤ã€‚</p><ul><li>æŸ¥çœ‹è·ç¦»geodist å¯ä»¥ç”¨æ¥è®¡ç®—ä¸¤ä¸ªå…ƒç´ ä¹‹é—´çš„è·ç¦»ï¼Œæºå¸¦ é›†åˆåç§°ã€2ä¸ªåç§°å’Œè·ç¦»å•ä½</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geodist company xr xrt km</span><br><span class="line">&quot;0.0120&quot;</span><br></pre></td></tr></table></figure><ul><li>è·å–å…ƒç´ ä½ç½®geopos æŒ‡ä»¤å¯ä»¥è·å–é›†åˆä¸­ä»»æ„å…ƒç´ çš„ç»çº¬åº¦åæ ‡ï¼Œå¯ä»¥ä¸€æ¬¡è·å–å¤šä¸ªã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geopos company xr</span><br><span class="line">1) 1) &quot;116.48104995489120483&quot;</span><br><span class="line">   2) &quot;39.99679348858259686&quot;</span><br><span class="line">127.0.0.1:6379&gt; geopos company xr xrt</span><br><span class="line">1) 1) &quot;116.48104995489120483&quot;</span><br><span class="line">   2) &quot;39.99679348858259686&quot;</span><br><span class="line">2) 1) &quot;116.4810982346534729&quot;</span><br><span class="line">   2) &quot;39.99689487742897143&quot;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬è§‚å¯Ÿåˆ°è·å–çš„ç»çº¬åº¦åæ ‡å’Œ geoadd è¿›å»çš„åæ ‡æœ‰è½»å¾®çš„è¯¯å·®ï¼ŒåŸå› æ˜¯ geohash å¯¹äºŒç»´åæ ‡è¿›è¡Œçš„ä¸€ç»´æ˜ å°„æ˜¯æœ‰æŸçš„ï¼Œé€šè¿‡æ˜ å°„å†è¿˜åŸå›æ¥çš„å€¼ä¼šå‡ºç°è¾ƒå°çš„å·®åˆ«ã€‚</p><ul><li>è·å–å…ƒç´ çš„ Hash å€¼geohash å¯ä»¥è·å–å…ƒç´ çš„ç»çº¬åº¦ç¼–ç å­—ç¬¦ä¸²ï¼Œä¸Šé¢è¯´è¿‡å®ƒæ˜¯ base32 ç¼–ç ã€‚ä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªç¼–ç å€¼å» <a href="http://geohash.org/$%7Bhash%7D">http://geohash.org/${hash}</a> ä¸­ç›´æ¥å®šä½ï¼Œå®ƒæ˜¯ geohash çš„æ ‡å‡†ç¼–ç å€¼ã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geohash company xr</span><br><span class="line">1) &quot;wx4gd94yjn0&quot;</span><br></pre></td></tr></table></figure><ul><li>é™„è¿‘çš„georadiusbymember æŒ‡ä»¤æ˜¯æœ€ä¸ºå…³é”®çš„æŒ‡ä»¤ï¼Œå®ƒå¯ä»¥ç”¨æ¥æŸ¥è¯¢æŒ‡å®šå…ƒç´ é™„è¿‘çš„å…¶ä»–å…ƒç´ ï¼Œå®ƒçš„å‚æ•°éå¸¸å¤æ‚ã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># èŒƒå›´20å…¬é‡Œä»¥å†…æœ€å¤š3ä¸ªå…ƒç´ æŒ‰è·ç¦»æ­£æ’ï¼Œå®ƒä¸ä¼šæ’é™¤è‡ªèº«</span><br><span class="line">127.0.0.1:6379&gt; georadiusbymember company xr 20 km count 3 asc</span><br><span class="line">1) &quot;finchina&quot;</span><br><span class="line">2) &quot;xr&quot;</span><br><span class="line">3) &quot;xrt&quot;</span><br><span class="line"># ä¸‰ä¸ªå¯é€‰å‚æ•° withcoord withdist withhash ç”¨æ¥æºå¸¦é™„åŠ å‚æ•°</span><br><span class="line">127.0.0.1:6379&gt; georadiusbymember company xr 20 km withcoord withdist withhash count 3 asc</span><br><span class="line">1) 1) &quot;finchina&quot;</span><br><span class="line">   2) &quot;0.0000&quot;</span><br><span class="line">   3) (integer) 4069887154388167</span><br><span class="line">   4) 1) &quot;116.48104995489120483&quot;</span><br><span class="line">      2) &quot;39.99679348858259686&quot;</span><br><span class="line">2) 1) &quot;xr&quot;</span><br><span class="line">   2) &quot;0.0000&quot;</span><br><span class="line">   3) (integer) 4069887154388167</span><br><span class="line">   4) 1) &quot;116.48104995489120483&quot;</span><br><span class="line">      2) &quot;39.99679348858259686&quot;</span><br><span class="line">3) 1) &quot;xrt&quot;</span><br><span class="line">   2) &quot;0.0120&quot;</span><br><span class="line">   3) (integer) 4069887154432781</span><br><span class="line">   4) 1) &quot;116.4810982346534729&quot;</span><br><span class="line">      2) &quot;39.99689487742897143&quot;</span><br></pre></td></tr></table></figure><ul><li>æŸ¥è¯¢æŒ‡å®šåæ ‡é™„è¿‘çš„å…ƒç´ é™¤äº† georadiusbymember æŒ‡ä»¤æ ¹æ®å…ƒç´ æŸ¥è¯¢é™„è¿‘çš„å…ƒç´ ï¼ŒRedisè¿˜æä¾›äº†æ ¹æ®åæ ‡å€¼æ¥æŸ¥è¯¢é™„è¿‘çš„å…ƒç´  georadiusï¼Œè¿™ä¸ªæŒ‡ä»¤æ›´åŠ æœ‰ç”¨ï¼Œå®ƒå¯ä»¥æ ¹æ®ç”¨æˆ·çš„å®šä½æ¥è®¡ç®—ã€‚å®ƒçš„å‚æ•°å’Œ georadiusbymember åŸºæœ¬ä¸€è‡´ï¼Œé™¤äº†å°†ç›®æ ‡å…ƒç´ æ”¹æˆç»çº¬åº¦åæ ‡å€¼</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; georadius company 116.18119895 39.9977934 100 km withdist count 2 desc</span><br><span class="line">1) 1) &quot;xrty&quot;</span><br><span class="line">   2) &quot;25.8103&quot;</span><br><span class="line">2) 1) &quot;xrt&quot;</span><br><span class="line">   2) &quot;25.5539&quot;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸€ä¸ªåœ°å›¾åº”ç”¨ä¸­ï¼Œè½¦çš„æ•°æ®ã€é¤é¦†çš„æ•°æ®ã€äººçš„æ•°æ® å¯èƒ½ä¼šæœ‰ç™¾ä¸‡åƒä¸‡æ¡ï¼Œå¦‚æœä½¿ç”¨ Redis çš„ geo æ•°æ®ç»“æ„ï¼Œå®ƒä»¬å°†å…¨éƒ¨æ”¾åœ¨ä¸€ä¸ª zset é›†åˆä¸­ã€‚åœ¨ Redis çš„é›†ç¾¤ç¯å¢ƒä¸­ï¼Œé›†åˆå¯èƒ½ä»ä¸€ä¸ªèŠ‚ç‚¹è¿ç§»åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœå•ä¸ªkeyçš„æ•°æ®è¿‡å¤§ï¼Œä¼šå¯¹é›†ç¾¤çš„è¿ç§»å·¥ä½œé€ æˆè¾ƒå¤§å½±å“ï¼Œåœ¨é›†ç¾¤ç¯å¢ƒä¸­çš„å•ä¸ªkeyå¯¹åº”çš„æ•°æ®é‡ä¸å®œè¶…è¿‡ 1Mï¼Œå¦åˆ™ä¼šå¯¼è‡´é›†ç¾¤è¿ç§»å‡ºç°å¡é¡¿ç°è±¡ï¼Œå½±å“çº¿ä¸ŠæœåŠ¡çš„æ­£å¸¸è¿è¡Œã€‚</p><p>æ‰€ä»¥ï¼Œè¿™é‡Œå»ºè®® geo çš„æ•°æ®ä½¿ç”¨å•ç‹¬çš„ Redis å®ä¾‹éƒ¨ç½²ï¼Œä¸ä½¿ç”¨é›†ç¾¤ç¯å¢ƒã€‚</p><p>å¦‚æœæ•°æ®é‡è¿‡äº¿ç”šè‡³æ›´å¤§ï¼Œå°±éœ€è¦å¯¹ geo æ•°æ®è¿›è¡Œæ‹†åˆ†ã€‚åœ¨äººå£ç‰¹å¤§çš„åŸå¸‚ï¼Œç”šè‡³å¯ä»¥æŒ‰åŒºåˆ’åˆ†ï¼Œè¿™æ ·å°±å¯ä»¥æ˜¾è‘—é™ä½å•ä¸ª zset é›†åˆçš„å¤§å°ã€‚</p><h3 id="4-9-å¤§æµ·æé’ˆ-scan"><a href="#4-9-å¤§æµ·æé’ˆ-scan" class="headerlink" title="4.9 å¤§æµ·æé’ˆ scan"></a>4.9 å¤§æµ·æé’ˆ scan</h3><p>æœ‰æ—¶å€™éœ€è¦ä» Redis å®ä¾‹æˆåƒä¸Šä¸‡çš„ key ä¸­æ‰¾å‡ºç‰¹å®šå‰ç¼€çš„ key åˆ—è¡¨æ¥æ‰‹åŠ¨å¤„ç†æ•°æ®ï¼Œå¯èƒ½æ˜¯ä¿®æ”¹å®ƒçš„å€¼ï¼Œä¹Ÿå¯èƒ½æ˜¯åˆ é™¤keyã€‚è¿™é‡Œå°±æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚ä½•ä»æµ·é‡ key ä¸­æ‰¾åˆ°æ»¡è¶³ç‰¹å®šå‰ç¼€çš„ key åˆ—è¡¨ï¼Ÿ</p><p>Redis æä¾›äº†ä¸€ä¸ªç®€å•æš´åŠ›çš„æŒ‡ä»¤ keys ç”¨æ¥åˆ—å‡ºæ‰€æœ‰æ»¡è¶³ ç‰¹å®šæ­£åˆ™å­—ç¬¦ä¸²è§„åˆ™çš„ keyã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set code1 a</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; mset code2 2 code3 3 code4 4 code5 5</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; keys code*</span><br><span class="line">1) &quot;code5&quot;</span><br><span class="line">2) &quot;code4&quot;</span><br><span class="line">3) &quot;code1&quot;</span><br><span class="line">4) &quot;code3&quot;</span><br><span class="line">5) &quot;code2&quot;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæŒ‡ä»¤éå¸¸ç®€å•ï¼Œæä¾›ä¸€ä¸ªç®€å•çš„æ­£åˆ™å­—ç¬¦ä¸²å³å¯ï¼Œä½†æ˜¯æœ‰å¾ˆæ˜æ˜¾çš„ä¸¤ä¸ªç¼ºç‚¹ã€‚ </p><p>1.æ²¡æœ‰ offsetã€limitå‚æ•°ï¼Œä¸€æ¬¡æ€§åå‡ºæ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„ keyï¼Œä¸‡ä¸€å®ä¾‹ä¸­æœ‰å‡ ç™¾ä¸‡ä¸ª key æ»¡è¶³æ¡ä»¶ï¼Œåˆ™æ‰“å°å­—ç¬¦ä¸²å¤ªå¤šã€‚</p><p>2.keys ç®—æ³•æ˜¯ éå†ç®—æ³•ï¼Œå¤æ‚åº¦æ˜¯ O(n)ï¼Œå¦‚æœå®ä¾‹ä¸­æœ‰ä¸Šåƒä¸‡çº§ä»¥ä¸Šçš„ keyï¼Œè¿™ä¸ªæŒ‡ä»¤å°±ä¼šå¯¼è‡´ redis æœåŠ¡å¡é¡¿ï¼Œæ‰€æœ‰è¯»å†™ redis çš„å…¶ä»–æŒ‡ä»¤éƒ½ä¼šè¢«å»¶åç”šè‡³è¶…æ—¶ï¼Œå› ä¸ºredisæ˜¯å•çº¿ç¨‹ç¨‹åºï¼Œé¡ºåºæ‰§è¡Œæ‰€æœ‰æŒ‡ä»¤ï¼Œå…¶ä»–æŒ‡ä»¤å¿…é¡»ç­‰åˆ°å½“å‰ keys æŒ‡ä»¤æ‰§è¡Œå®Œæˆåæ‰å¯ä»¥ç»§ç»­ã€‚</p><p>Redisä¸ºè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œåœ¨2.8ç‰ˆæœ¬åŠ å…¥äº† scan ã€‚scan ç›¸æ¯” keyså…·å¤‡ä»¥ä¸‹ä¼˜ç‚¹ï¼š</p><ul><li>å¤æ‚åº¦è™½ç„¶ä¹Ÿæ˜¯0(n)ï¼Œä½†æ˜¯å®ƒæ˜¯é€šè¿‡æ¸¸æ ‡åˆ†å¸ƒè¿›è¡Œçš„ï¼Œä¸ä¼šå µå¡çº¿ç¨‹ã€‚</li><li>æä¾› limit å‚æ•°ï¼Œå¯ä»¥æ§åˆ¶æ¯æ¬¡è¿”å›ç»“æœçš„æœ€å¤§æ¡æ•°ï¼Œlimit åªæ˜¯è¦ç»™ hintï¼Œè¿”å›çš„å‚æ•°å¯å¤šå¯å°‘ã€‚</li><li>åŒ keys ä¸€æ ·æä¾› æ¨¡å¼åŒ¹é…åŠŸèƒ½ã€‚</li><li>æœåŠ¡å™¨ä¸éœ€è¦ä¸ºæ¸¸æ ‡ä¿å­˜çŠ¶æ€ï¼Œæ¸¸æ ‡çš„å”¯ä¸€çŠ¶æ€å°±æ˜¯ scan è¿”å›ç»™å®¢æˆ·ç«¯çš„æ¸¸æ ‡æ•´æ•°ã€‚</li><li>éå†çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæœ‰æ•°æ®ä¿®æ”¹ï¼Œæ”¹åŠ¨åçš„æ•°æ®èƒ½ä¸èƒ½è¢«éå†åˆ°æ˜¯ä¸ç¡®å®šçš„ã€‚</li><li>å•æ¬¡è¿”å›çš„ç»“æœæ˜¯ç©ºçš„å¹¶ä¸æ„å‘³ç€éå†ç»“æŸï¼Œè€Œè¦çœ‹è¿”å›çš„æ¸¸æ ‡å€¼æ˜¯å¦ä¸ºé›¶ã€‚</li></ul><h4 id="4-9-1-scan-åŸºç¡€ä½¿ç”¨"><a href="#4-9-1-scan-åŸºç¡€ä½¿ç”¨" class="headerlink" title="4.9.1 scan åŸºç¡€ä½¿ç”¨"></a>4.9.1 scan åŸºç¡€ä½¿ç”¨</h4><p>å¾€redisæ’å…¥äº†10æ¡æ•°æ®ï¼Œcode1åˆ°code10ã€‚</p><p>scan æä¾›äº†ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯ cursor æ•´æ•°å€¼ï¼Œç¬¬äºŒä¸ªæ˜¯ key çš„æ­£åˆ™æ¨¡å¼ï¼Œç¬¬ä¸‰ä¸ªæ˜¯ éå†çš„ limit hintã€‚ç¬¬ä¸€æ¬¡éå†æ—¶ï¼Œcursorå€¼ä¸º0ï¼Œç„¶åå°†è¿”å›ç»“æœä¸­ç¬¬ä¸€ä¸ªæ•´æ•°å€¼ä½œä¸ºä¸‹ä¸€æ¬¡éå†çš„ cursorã€‚ä¸€ç›´éå†åˆ°è¿”å›çš„ cursor å€¼ä¸º 0æ—¶ç»“æŸã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; scan 0 match code* count 4</span><br><span class="line">1) &quot;6&quot;</span><br><span class="line">2) 1) &quot;code8&quot;</span><br><span class="line">   2) &quot;code1&quot;</span><br><span class="line">   3) &quot;code4&quot;</span><br><span class="line">   </span><br><span class="line">127.0.0.1:6379&gt; scan 6 match code* count 4</span><br><span class="line">1) &quot;9&quot;</span><br><span class="line">2) 1) &quot;code2&quot;</span><br><span class="line">   2) &quot;code6&quot;</span><br><span class="line">   3) &quot;code9&quot;</span><br><span class="line">   4) &quot;codex&quot;</span><br><span class="line">   </span><br><span class="line">127.0.0.1:6379&gt; scan 9 match code* count 4</span><br><span class="line">1) &quot;7&quot;</span><br><span class="line">2) 1) &quot;code5&quot;</span><br><span class="line">   2) &quot;code3&quot;</span><br><span class="line">   3) &quot;code10&quot;</span><br><span class="line">   4) &quot;code7&quot;</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; scan 7 match code* count 4</span><br><span class="line">1) &quot;0&quot;</span><br><span class="line">2) 1) &quot;code11&quot;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢å®é™…æµ‹è¯•ä¸­å¯ä»¥çŸ¥é“ï¼Œæ¸¸æ ‡ä¸æ˜¯æ¯æ¬¡é€’å¢ï¼Œå¹¶ä¸”æ‰€å¡«çš„ limit hint ä¸æ˜¯æŒ‡ä»£è¿”å›çš„ç»“æœæ•°é‡ï¼Œè€Œæ˜¯å•æ¬¡éå†çš„å­—å…¸æ§½ä½æ•°é‡(çº¦ç­‰äº)ã€‚å¯èƒ½ å•æ¬¡çš„ è¿”å›ç»“æœä¸ºç©ºï¼Œä½†æ˜¯è¿™å¹¶ä¸æ„å‘³ç€ éå†å·²ç»ç»“æŸã€‚åªæœ‰å½“è¿”å›çš„æ¸¸æ ‡å€¼ä¸º 0 ï¼Œæ‰ç®—æ•´ä¸ªéå†ç»“æŸã€‚</p><h4 id="4-9-2-å­—å…¸çš„ç»“æ„"><a href="#4-9-2-å­—å…¸çš„ç»“æ„" class="headerlink" title="4.9.2 å­—å…¸çš„ç»“æ„"></a>4.9.2 å­—å…¸çš„ç»“æ„</h4><p>åœ¨ Redis ä¸­æ‰€æœ‰çš„ key éƒ½å­˜å‚¨åœ¨ä¸€ä¸ªå¾ˆå¤§çš„å­—å…¸ä¸­ï¼Œæ•´ä¸ªå­—å…¸çš„ç»“æ„å’Œ Javaä¸­çš„ HashMap ä¸€æ ·ï¼Œæ˜¯ä¸€ç»´æ•°ç»„+äºŒç»´é“¾è¡¨ç»“æ„ã€‚ç¬¬ä¸€ç»´æ•°ç»„çš„å¤§å°æ€»æ˜¯ 2^n ï¼ˆn&gt;&#x3D;0)ï¼Œæ‰©å®¹ä¸€æ¬¡æ•°ç»„å¤§å°ç©ºé—´åŠ å€ï¼Œä¹Ÿå°±æ˜¯ n++</p><p>scan æŒ‡ä»¤è¿”å›çš„æ¸¸æ ‡å°±æ˜¯ç¬¬ä¸€ä¸ªç»´æ•°ç»„çš„ä½ç½®ç´¢å¼•ï¼Œæˆ‘ä»¬å°†æ•´ä¸ªä½ç½®ç´¢å¼•ç§°ä½œæ§½ã€‚å¦‚æœä¸è€ƒè™‘å­—å…¸çš„æ‰©å®¹ç¼©å®¹ï¼Œç›´æ¥æŒ‰æ•°ç»„ä¸‹æ ‡æŒ¨ä¸ªéå†å°±è¡Œäº†ã€‚limit å‚æ•°å°±è¡¨ç¤ºéœ€è¦éå†çš„æ§½ä½æ•°ï¼Œä¹‹æ‰€ä»¥è¿”å›çš„ç»“æœå¯èƒ½å¤šå¯èƒ½å°‘ï¼Œæ˜¯å› ä¸ºä¸æ˜¯æ‰€æœ‰çš„æ§½ä½éƒ½ä¼šæŒ‚æ¥ é“¾è¡¨ï¼Œæœ‰äº›æ§½ä½å¯èƒ½æ˜¯ç©ºçš„ï¼Œè¿˜æœ‰äº›æ§½ä½ä¸ŠæŒ‚æ¥çš„é“¾è¡¨ä¸Šçš„å…ƒç´ å¯èƒ½ä¼šæœ‰å¤šä¸ªã€‚æ¯æ¬¡éå†éƒ½ä¼šå°† limit æ•°é‡çš„æ§½ä½ä¸ŠæŒ‚æ¥çš„æ‰€æœ‰é“¾è¡¨å…ƒç´ è¿›è¡Œæ¨¡å¼åŒ¹é…è¿‡æ»¤åï¼Œä¸€æ¬¡æ€§è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p><h4 id="4-9-3-scan-éå†é¡ºåº"><a href="#4-9-3-scan-éå†é¡ºåº" class="headerlink" title="4.9.3 scan éå†é¡ºåº"></a>4.9.3 scan éå†é¡ºåº</h4><p><img src="https://cdn.nlark.com/yuque/0/2023/png/35838370/1684724453802-b8a3e03e-5bad-4829-9d57-ec6e6b10696d.png" alt="img"></p><p>scançš„éå†é¡ºåºéå¸¸ç‰¹åˆ«ã€‚å®ƒä¸æ˜¯ä»ç¬¬ä¸€ç»´æ•°ç»„çš„ç¬¬0ä½ä¸€ç›´éå†åˆ°æœ«å°¾ï¼Œè€Œæ˜¯é‡‡ç”¨äº†é«˜ä½è¿›ä½åŠ æ³•æ¥éå†ã€‚ä¹‹æ‰€ä»¥ä½¿ç”¨è¿™æ ·ç‰¹æ®Šçš„æ–¹å¼è¿›è¡Œéå†ã€‚æ˜¯è€ƒè™‘åˆ°å­—å…¸çš„æ‰©å®¹å’Œç¼©å®¹æ—¶é¿å…æ§½ä½å’Œéå†é‡å¤å’Œé—æ¼ï¼ˆåé¢æœ‰å…·ä½“åˆ†æï¼‰ã€‚é«˜ä½è¿›ä½æ³•ä»å·¦è¾¹åŠ ï¼Œè¿›ä½å¾€å³è¾¹ç§»åŠ¨ï¼ŒåŒæ™®é€šåŠ æ³•æ­£å¥½ç›¸åã€‚ä½†æ˜¯å®ƒä»¬éƒ½ä¼šéå†æ‰€æœ‰çš„æ§½ä½å¹¶ä¸”æ²¡æœ‰é‡å¤ã€‚</p><h4 id="4-9-4-å­—å…¸æ‰©å®¹"><a href="#4-9-4-å­—å…¸æ‰©å®¹" class="headerlink" title="4.9.4 å­—å…¸æ‰©å®¹"></a>4.9.4 å­—å…¸æ‰©å®¹</h4><p>Java ä¸­çš„ HashMap æœ‰æ‰©å®¹çš„æ¦‚å¿µï¼Œå½“ loadFactor è¾¾åˆ°é˜ˆå€¼æ—¶ï¼Œéœ€è¦é‡æ–°åˆ†é…ä¸€ä¸ªæ–°çš„ 2 å€å¤§å°çš„æ•°ç»„ï¼Œç„¶åå°†æ‰€æœ‰çš„å…ƒç´ å…¨éƒ¨ rehash æŒ‚åˆ°æ–°çš„æ•°ç»„ä¸‹é¢ã€‚rehash å°±æ˜¯å°†å…ƒç´ çš„ hashå€¼å¯¹æ•°ç»„é•¿åº¦è¿›è¡Œå–æ¨¡è¿ç®—ï¼Œå› ä¸ºé•¿åº¦å˜äº†ï¼Œæ‰€ä»¥æ¯ä¸ªå…ƒç´ æŒ‚æ¥çš„æ§½ä½å¯èƒ½ä¹Ÿå‘ç”Ÿäº†å˜åŒ–ã€‚æœ‰å› ä¸ºæ•°ç»„çš„é•¿åº¦æ˜¯ 2^n æ¬¡æ–¹ï¼Œæ‰€ä»¥å–æ¨¡è¿ç®—ç­‰ä»·äº ä½ä¸ æ“ä½œã€‚</p><p>a%8 &#x3D; a&amp;(8-1) &#x3D; a&amp;7</p><p>a%16 &#x3D; a&amp;(16-1) &#x3D; a&amp;15</p><p>a%32 &#x3D; a&amp;(32-1) &#x3D; a&amp;31</p><p>è¿™é‡Œçš„ 7ã€15ã€31 åˆç§°ä¹‹ä¸ºå­—å…¸çš„ maskå€¼ï¼Œmaskçš„ä½œç”¨å°±æ˜¯ä¿ç•™ hash å€¼çš„ä½ä½ï¼Œé«˜ä½éƒ½è¢«è®¾ç½®ä¸º 0ã€‚</p><p>çœ‹çœ‹ rehash å‰åå…ƒç´ æ§½ä½çš„å˜åŒ–</p><p>å‡è®¾å½“å‰çš„å­—æ®µçš„æ•°ç»„é•¿åº¦ç”± 8 ä½æ‰©å®¹åˆ° 16ä½ï¼Œé‚£ä¹ˆ 3å·æ§½ä½ 011 å°†ä¼šè¢« rehash åˆ°3å·æ§½ä½å’Œ11å·æ§½ä½ï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥æ§½ä½é“¾è¡¨ä¸­å¤§çº¦æœ‰ä¸€åŠçš„å…ƒç´ è¿˜æ˜¯3å·æ§½ä½ï¼Œå…¶å®ƒçš„å…ƒç´ ä¼šæ”¾åˆ°11å·æ§½ä½ï¼Œ11è¿™ä¸ªæ•°å­—çš„äºŒè¿›åˆ¶æ˜¯ 1011ï¼Œå°±æ˜¯å¯¹ 3 çš„äºŒè¿›åˆ¶ 011 å¢åŠ äº†ä¸€ä¸ªé«˜ä½1ã€‚</p><p>æŠ½è±¡ä¸€ç‚¹è¯´ï¼Œå‡è®¾å¼€å§‹æ§½ä½çš„äºŒè¿›åˆ¶æ˜¯ xxxï¼Œé‚£ä¹ˆè¯¥æ§½ä½ä¸­çš„å…ƒç´ å°†è¢« rehash åˆ° 0xxx å’Œ 1xxx å³ xxx+8ä¸­ã€‚å¦‚æœå­—å…¸é•¿åº¦ç”±16ä½æ‰©å®¹åˆ°32ä½ï¼Œé‚£ä¹ˆå¯¹äºäºŒè¿›åˆ¶æ§½ä½ xxxx ä¸­çš„å…ƒç´ å°†è¢« rehash åˆ° 0xxxx å’Œ 1xxxxä¸­ã€‚</p><p><strong>å¯¹æ¯”æ‰©å®¹å‰åçš„éå†é¡ºåºï¼š</strong></p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/35838370/1684724547827-d86608c6-5109-46c3-8cc2-843deba5e1f6.png" alt="img"></p><p>è§‚å¯Ÿè¿™å¼ å›¾ç‰‡ï¼Œæˆ‘ä»¬å‘ç°é‡‡ç”¨é«˜ä½è¿›ä½åŠ æ³•çš„éå†é¡ºåºï¼Œrehash åçš„æ§½ä½ åœ¨éå†é¡ºåºä¸Šæ˜¯ç›¸é‚»çš„ã€‚</p><p>å‡è®¾å½“å‰å³å°†éå† 110è¿™ä¸ªä½ç½®ï¼Œé‚£ä¹ˆæ‰©å®¹åï¼Œå½“å‰æ§½ä½ä¸Šæ‰€æœ‰çš„å…ƒç´ å¯¹åº”çš„æ–°æ§½ä½æ˜¯ 0110 å’Œ 1110ï¼Œä¹Ÿå°±æ˜¯åœ¨æ§½ä½çš„äºŒè¿›åˆ¶æ•°å¢åŠ ä¸€ä¸ªé«˜ä½0æˆ–1.è¿™æ—¶æˆ‘ä»¬å¯ä»¥iç›´æ¥ä» 0110 è¿™ä¸ªæ§½ä½å¼€å§‹å¾€åç»§ç»­éå†ï¼Œ0110 æ§½ä½ä¹‹å‰çš„æ‰€æœ‰æ§½ä½éƒ½æ˜¯å·²ç»éå†è¿‡çš„ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…æ‰©å®¹åå¯¹å·²ç»éå†è¿‡çš„æ§½ä½è¿›è¡Œé‡å¤éå†ã€‚</p><p>å†è€ƒè™‘ç¼©å®¹ï¼Œå‡è®¾å½“å‰å³å°†éå† 110 è¿™ä¸ªä½ç½®ï¼Œé‚£ä¹ˆç¼©å®¹åï¼Œå½“å‰æ§½ä½æ‰€æœ‰çš„å…ƒç´ å¯¹åº”çš„æ–°æ§½ä½æ˜¯ 10ï¼Œä¹Ÿå°±æ˜¯å»æ‰æ§½ä½äºŒè¿›åˆ¶æœ€é«˜ä½ã€‚è¿™æ—¶æˆ‘ä»¬å¯ä»¥ç›´æ¥ä»10è¿™ä¸ªæ§½ä½ç»§ç»­å¾€åéå†ï¼Œ10æ§½ä½ä¹‹å‰çš„æ‰€æœ‰æ§½ä½éƒ½æ˜¯éå†è¿‡çš„ï¼Œè¿™æ ·å¯ä»¥é¿å…ç¼©å®¹çš„é‡å¤éå†ã€‚ä¸é¡¾ç¼©å®¹è¿˜æ˜¯ä¸å¤ªä¸€æ ·ï¼Œå®ƒä¼šå¯¹å›¾ä¸­ 010 è¿™ä¸ªæ§½ä½ä¸Šçš„å…ƒç´ è¿›è¡Œé‡å¤éå†ï¼Œå› ä¸ºç¼©å®¹å 10 æ§½ä½çš„å…ƒç´ æ˜¯ 010 å’Œ 110ä¸ŠæŒ‚æ¥çš„å…ƒç´ çš„èåˆã€‚</p><h4 id="4-9-5-scan-è€ƒè™‘-æ¸è¿›å¼-rehash"><a href="#4-9-5-scan-è€ƒè™‘-æ¸è¿›å¼-rehash" class="headerlink" title="4.9.5 scan è€ƒè™‘ æ¸è¿›å¼ rehash"></a>4.9.5 scan è€ƒè™‘ æ¸è¿›å¼ rehash</h4><p>Javaçš„ HashMap åœ¨æ‰©å®¹æ—¶ä¼šä¸€æ¬¡æ€§å°†æ—§æ•°ç»„ä¸‹æŒ‚æ¥çš„å…ƒç´ å…¨éƒ¨è½¬ç§»åˆ°æ–°çš„æ•°ç»„ä¸‹é¢ã€‚å¦‚æœ Map ä¸­å…ƒç´ ç‰¹åˆ«å¤šï¼Œçº¿ç¨‹å°±ä¼šå‡ºç°å¡é¡¿ç°è±¡ã€‚Redisä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ƒé‡‡ç”¨æ¸è¿›å¼ rehashã€‚</p><p>å®ƒåŒæ—¶ä¿ç•™æ—§æ•°ç»„å’Œæ–°æ•°ç»„ï¼Œç„¶ååœ¨å®šæ—¶ä»»åŠ¡ä¸­ä»¥åŠåç»­å¯¹ hash çš„æŒ‡ä»¤æ“ä½œä¸­æ¸æ¸å°†æ—§çš„æ•°ç»„ä¸­æŒ‚æ¥çš„å…ƒç´ è¿ç§»åˆ°æ–°æ•°ç»„ä¸Šã€‚è¿™æ„å‘³ç€è¦æ“ä½œå¤„äº rehash ä¸­çš„å­—å…¸ï¼Œéœ€è¦åŒæ—¶è®¿é—®æ–°æ—§ä¸¤ä¸ªæ•°ç»„ç»“æ„ã€‚å¦‚æœåœ¨æ—§æ•°ç»„ä¸‹é¢æ‰¾ä¸åˆ°å…ƒç´ ï¼Œè¿˜éœ€è¦å»æ–°æ•°ç»„ä¸‹é¢å¯»æ‰¾ã€‚</p><p>scan ä¹Ÿéœ€è¦è€ƒè™‘è¿™ä¸ªé—®é¢˜ï¼Œå¯¹äº rehashä¸­çš„å­—å…¸ï¼Œå®ƒéœ€è¦åŒæ—¶æ‰«ææ–°æ—§æ§½ä½ï¼Œç„¶åå°†ç»“æœèåˆåè¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p><h4 id="4-9-6-æ›´å¤š-scan-æŒ‡ä»¤"><a href="#4-9-6-æ›´å¤š-scan-æŒ‡ä»¤" class="headerlink" title="4.9.6 æ›´å¤š scan æŒ‡ä»¤"></a>4.9.6 æ›´å¤š scan æŒ‡ä»¤</h4><p>scanæŒ‡ä»¤æ˜¯ä¸€ç³»åˆ—æŒ‡ä»¤ï¼Œå¤„ç†å¯ä»¥éå†æ‰€æœ‰çš„ keyä»¥å¤–ï¼Œè¿˜å¯ä»¥å¯¹æŒ‡å®šçš„å®¹å™¨é›†åˆè¿›è¡Œéå†ã€‚æ¯”å¦‚ zscan éå† zset é›†åˆå…ƒç´ ï¼Œhscan éå† hash å­—å…¸çš„å…ƒç´ ã€‚</p><h4 id="4-9-7-å¤§Keyçš„æ‰«æ"><a href="#4-9-7-å¤§Keyçš„æ‰«æ" class="headerlink" title="4.9.7 å¤§Keyçš„æ‰«æ"></a>4.9.7 å¤§Keyçš„æ‰«æ</h4><p>å› ä¸ºä¸šåŠ¡äººå‘˜çš„ä½¿ç”¨ä¸å½“ï¼Œåœ¨ Redis å®ä¾‹ä¸­ä¼šå½¢æˆå¾ˆå¤§çš„å¯¹è±¡ï¼Œæ¯”å¦‚ä¸€ä¸ªå¾ˆå¤§çš„ hashï¼Œä¸€ä¸ªå¾ˆå¤§çš„ zsetã€‚è¿™æ ·çš„å¯¹è±¡å¯¹Redisçš„é›†ç¾¤æ•°æ®è¿ç§»å¸¦æ¥äº†å¾ˆå¤§é—®é¢˜ï¼Œå› ä¸ºåœ¨é›†ç¾¤ç¯å¢ƒä¸‹ï¼Œå¦‚æœæŸä¸€ä¸ªkeyå¤ªå¤§ï¼Œä¼šå¯¼è‡´æ•°æ®è¿ç§»å¡é¡¿ã€‚å¦å¤–åœ¨å†…å­˜åˆ†é…ä¸Šï¼Œå¦‚æœä¸€ä¸ªkeyå¤ªå¤§ï¼Œé‚£ä¹ˆå½“å®ƒéœ€è¦æ‰©å®¹æ—¶ï¼Œä¼šä¸€æ¬¡æ€§ç”³è¯·æ›´å¤§çš„ä¸€å—å†…å­˜ï¼Œè¿™ä¹Ÿä¼šå¯¼è‡´å¡é¡¿ã€‚å¦‚æœè¿™ä¸ªå¤§keyè¢«åˆ é™¤ï¼Œå†…å­˜ä¼šä¸€æ¬¡æ€§å›æ”¶ï¼Œå¡é¡¿ç°è±¡å†ä¸€æ¬¡äº§ç”Ÿã€‚</p><p>æ‰€ä»¥åœ¨å¼€å‘ä¸­è¯·é¿å…å¤§keyçš„äº§ç”Ÿã€‚å¦‚ä½•å®šä½åˆ° å¤§keyå‘¢ï¼Ÿå¯ä»¥ä½¿ç”¨ scan å‘½ä»¤ï¼Œå¯¹äºæ‰«æå‡ºæ¥çš„æ¯ä¸€ä¸ªkeyï¼Œä½¿ç”¨ type æŒ‡ä»¤è·å–ç±»å‹ï¼Œç„¶åä½¿ç”¨ç›¸åº”çš„æ•°æ®ç»“æ„çš„ size æˆ–è€… len æ–¹æ³•æ¥å¾—åˆ° å®ƒçš„å¤§å°ï¼Œå¯¹äºæ¯ä¸€ç§ç±»å‹ï¼Œä¿ç•™å¤§å°çš„å‰ Nåä½œä¸ºæ‰«æç»“æœå±•ç¤ºå‡ºæ¥ã€‚</p><p>Redis å®˜æ–¹å·²ç»æä¾›äº† å®ç°ä¸Šé¢åŠŸèƒ½çš„ æŒ‡ä»¤ï¼šredis-cli -h 127.0.0.1 -p 6379 â€“bigkeys ã€‚å¦‚æœæ‹…å¿ƒè¿™ä¸ªæŒ‡ä»¤ä¼šå¤§å¹…æŠ¬å‡ Redis çš„ opsï¼Œè¿˜å¯ä»¥å¢åŠ ä¸€ä¸ªä¼‘çœ å‚æ•°ã€‚redis-cli -h 127.0.0.1 -p 6379 â€“bigkeys -i 0.1ï¼Œè¿™ä¸ªæŒ‡ä»¤æ¯éš”100æ¡ scan æŒ‡ä»¤å°±ä¼šä¼‘çœ  0.1sï¼Œops å°±ä¸ä¼šå‰§çƒˆæŠ¬å‡ï¼Œä½†æ˜¯æ‰«æçš„æ—¶é—´ä¼šå˜é•¿ã€‚</p><h2 id="äº”ã€Redis-åŸç†"><a href="#äº”ã€Redis-åŸç†" class="headerlink" title="äº”ã€Redis åŸç†"></a>äº”ã€Redis åŸç†</h2><h3 id="5-1-çº¿ç¨‹-IO-æ¨¡å‹"><a href="#5-1-çº¿ç¨‹-IO-æ¨¡å‹" class="headerlink" title="5.1 çº¿ç¨‹ IO æ¨¡å‹"></a>5.1 çº¿ç¨‹ IO æ¨¡å‹</h3><p>è®°ä½é«˜å¹¶å‘çš„ Redis ä¸­é—´ä»¶æ˜¯ å•çº¿ç¨‹çš„ï¼Œé™¤æ­¤ä¹‹å¤–ï¼ŒNode.jsã€Nginx ä¹Ÿæ˜¯å•çº¿ç¨‹ï¼Œä½†æ˜¯å®ƒä»¬éƒ½æ˜¯æœåŠ¡å™¨é«˜æ€§èƒ½çš„å…¸èŒƒã€‚</p><p>è¯¦ç»†å¯ä»¥çœ‹ 3.3</p><h3 id="5-2-é€šä¿¡åè®®"><a href="#5-2-é€šä¿¡åè®®" class="headerlink" title="5.2 é€šä¿¡åè®®"></a>5.2 é€šä¿¡åè®®</h3><p>Redis çš„ä½œè€…è®¤ä¸º æ•°æ®åº“ç³»ç»Ÿçš„ç“¶é¢ˆä¸€èˆ¬ä¸åœ¨äºç½‘ç»œæµé‡ï¼Œè€Œæ˜¯æ•°æ®åº“è‡ªèº«å†…éƒ¨é€»è¾‘å¤„ç†ä¸Šã€‚æ‰€ä»¥å³ä½¿ redis ä½¿ç”¨äº†æµªè´¹æµé‡çš„æ–‡æœ¬åè®®ï¼Œä¾ç„¶å¯ä»¥å–å¾—æé«˜çš„è®¿é—®æ€§èƒ½ã€‚</p><h4 id="5-2-1-RESP-ï¼ˆRedis-Serialization-Protocolï¼‰"><a href="#5-2-1-RESP-ï¼ˆRedis-Serialization-Protocolï¼‰" class="headerlink" title="5.2.1 RESP ï¼ˆRedis Serialization Protocolï¼‰"></a>5.2.1 RESP ï¼ˆRedis Serialization Protocolï¼‰</h4><p>RESP æ˜¯ Redis åºåˆ—åŒ–åè®®çš„ç®€å†™ã€‚å®ƒæ˜¯ä¸€ç§ç›´è§‚çš„æ–‡æœ¬åè®®ï¼Œä¼˜åŠ¿åœ¨äºå®ç°å¼‚å¸¸ç®€å•ï¼Œè§£ææ€§èƒ½æå¥½ã€‚Redis åè®®å°†ä¼ è¾“çš„ç»“æ„æ•°æ® åˆ†ä¸º5ç§å•å…ƒç±»å‹ï¼Œå•å…ƒç»“æŸæ—¶ç»Ÿä¸€åŠ ä¸Šå›è½¦æ¢è¡Œç¬¦å·\r\nã€‚</p><ul><li>å•è¡Œå­—ç¬¦ä¸² ä»¥ + ç¬¦å·å¼€å¤´ã€‚</li><li>å¤šè¡Œå­—ç¬¦ä¸² ä»¥ $ ç¬¦å·å¼€å¤´ï¼Œåè·Ÿå­—ç¬¦ä¸²é•¿åº¦</li><li>æ•´æ•°å€¼ ä»¥ : ç¬¦å·å¼€å¤´ï¼Œåè·Ÿæ•´æ•°çš„å­—ç¬¦ä¸²å½¢å¼</li><li>é”™è¯¯ä¿¡æ¯ ä»¥ - ç¬¦å·å¼€å¤´</li><li>æ•°ç»„ ä»¥ * å·å¼€å¤´ï¼Œåè·Ÿæ•°ç»„é•¿åº¦</li></ul><h4 id="5-2-2-å°ç»“"><a href="#5-2-2-å°ç»“" class="headerlink" title="5.2.2 å°ç»“"></a>5.2.2 å°ç»“</h4><p>Redis åè®®é‡Œæœ‰å¤§é‡å†—ä½™çš„å›è½¦æ¢è¡Œç¬¦ï¼Œä½†æ˜¯è¿™ä¸ªå¹¶ä¸å½±å“å®ƒæˆä¸ºäº’è”ç½‘æŠ€æœ¯é¢†åŸŸéå¸¸å—æ¬¢è¿çš„ä¸€ä¸ªæ–‡æœ¬åè®®ã€‚æœ‰å¾ˆå¤šå¼€æºé¡¹ç›®ä½¿ç”¨ RESP ä½œä¸ºå®ƒçš„é€šè®¯åè®®ã€‚åœ¨æŠ€æœ¯é¢†åŸŸæ€§èƒ½å¹¶ä¸æ€»æ˜¯ä¸€åˆ‡ï¼Œè¿˜æœ‰ç®€å•æ€§ã€æ˜“ç†è§£æ€§å’Œæ˜“å®ç°æ€§ï¼Œè¿™äº›éƒ½éœ€è¦è¿›è¡Œé€‚å½“æƒè¡¡ã€‚</p><h3 id="5-3-æŒä¹…åŒ–"><a href="#5-3-æŒä¹…åŒ–" class="headerlink" title="5.3 æŒä¹…åŒ–"></a>5.3 æŒä¹…åŒ–</h3><p>Redis çš„æ•°æ®å…¨éƒ¨åœ¨å†…å­˜ä¸­ï¼Œå¦‚æœçªç„¶å®•æœºï¼Œæ•°æ®å°±ä¼šå…¨éƒ¨ä¸¢å¤±ï¼Œå› æ­¤å¿…é¡»æœ‰ä¸€ç§æœºåˆ¶æ¥ä¿è¯ Redis çš„æ•°æ®ä¸ä¼šå› ä¸ºæ•…éšœè€Œä¸¢å¤±ï¼Œè¿™ç§æœºåˆ¶å°±æ˜¯ Redis çš„æŒä¹…åŒ–æœºåˆ¶ã€‚</p><p>Redis æŒä¹…åŒ–æœºåˆ¶æœ‰ä¸¤ç§ï¼Œç¬¬ä¸€ç§æ˜¯å¿«ç…§ï¼Œç¬¬äºŒç§æ˜¯AOFæ—¥å¿—ã€‚</p><ul><li>RDB å°†æ•°æ®åº“çš„å¿«ç…§ï¼ˆsnapshotï¼‰ä»¥äºŒè¿›åˆ¶çš„æ–¹å¼ä¿å­˜åˆ°ç£ç›˜ä¸­ã€‚</li><li>AOF åˆ™ä»¥åè®®æ–‡æœ¬çš„æ–¹å¼ï¼Œå°†æ‰€æœ‰å¯¹æ•°æ®åº“è¿›è¡Œè¿‡å†™å…¥çš„å‘½ä»¤ï¼ˆåŠå…¶å‚æ•°ï¼‰è®°å½•åˆ° AOF æ–‡ä»¶ï¼Œä»¥æ­¤è¾¾åˆ°è®°å½•æ•°æ®åº“çŠ¶æ€çš„ç›®çš„ã€‚</li></ul><p>AOF æ—¥å¿—åœ¨é•¿æœŸçš„è¿è¡Œè¿‡ç¨‹ä¸­ä¼šå˜çš„æ— æ¯”åºå¤§ï¼Œæ•°æ®åº“é‡å¯æ—¶éœ€è¦åŠ è½½ AOF æ—¥å¿—è¿›è¡ŒæŒ‡ä»¤é‡æ”¾ï¼Œè¿™ä¸ªæ—¶é—´å°±ä¼šæ— æ¯”æ¼«é•¿ã€‚æ‰€ä»¥éœ€è¦å®šæœŸè¿›è¡ŒAOFé‡å†™ï¼Œç»™AOFæ—¥å¿—è¿›è¡Œç˜¦èº«ã€‚</p><h4 id="5-3-1-å¿«ç…§"><a href="#5-3-1-å¿«ç…§" class="headerlink" title="5.3.1 å¿«ç…§"></a>5.3.1 å¿«ç…§</h4><p>æˆ‘ä»¬éƒ½çŸ¥é“ Redis æ˜¯å•çº¿ç¨‹ç¨‹åºï¼Œè¿™ä¸ªçº¿ç¨‹è¦åŒæ—¶è´Ÿè´£å¤šä¸ªå®¢æˆ·ç«¯å¥—æ¥å­—çš„å¹¶å‘è¯»å†™æ“ä½œå’Œå†…å­˜æ•°æ®ç»“æ„çš„é€»è¾‘è¯»å†™ã€‚åœ¨æœåŠ¡çº¿ä¸Šè¯·æ±‚çš„åŒæ—¶ï¼ŒRedis å¦‚æœè¿˜éœ€è¦è¿›è¡Œå†…å­˜å¿«ç…§ï¼ˆéœ€è¦ä½¿ç”¨ æ–‡ä»¶IOæ“ä½œï¼‰ï¼Œé‚£å°±å¾ˆéš¾ä¿æŒä¸å µå¡ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒæŒä¹…åŒ–çš„åŒæ—¶ï¼Œå†…å­˜æ•°æ®ç»“æ„è¿˜åœ¨æ”¹å˜ã€‚è¿™å¦‚ä½•åº”å¯¹ï¼Ÿ</p><p>Redis ä½¿ç”¨æ“ä½œç³»ç»Ÿçš„å¤šè¿›ç¨‹ COW (copy on write) æœºåˆ¶æ¥å®ç°å¿«ç…§æŒä¹…åŒ–ã€‚</p><p>Redis åœ¨æŒä¹…åŒ–æ—¶ä¼šè°ƒç”¨ glibc çš„å‡½æ•° fork äº§ç”Ÿä¸€ä¸ªå­è¿›ç¨‹ï¼Œå¿«ç…§æŒä¹…åŒ–å®Œå…¨äº¤ç»™å­è¿›ç¨‹æ¥å¤„ç†ï¼Œçˆ¶è¿›ç¨‹ç»§ç»­å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ã€‚å­è¿›ç¨‹åˆšåˆšäº§ç”Ÿæ—¶ï¼Œå®ƒå’Œçˆ¶è¿›ç¨‹å…±äº«å†…å­˜é‡Œé¢çš„ä»£ç æ®µå’Œæ•°æ®æ®µã€‚ï¼ˆè¿™æ˜¯Linuxä¸ºèŠ‚çº¦å†…å­˜èµ„æºï¼Œæ‰€ä»¥è®©å…¶å…±äº«èµ·æ¥ï¼Œåœ¨å­è¿›ç¨‹åˆ›å»ºæ—¶ï¼Œå†…å­˜å¢é•¿å‡ ä¹æ²¡æœ‰æ˜æ˜¾å˜åŒ–ï¼‰</p><p>å­è¿›ç¨‹åšæ•°æ®æŒä¹…åŒ–ï¼Œå®ƒä¸ä¼šä¿®æ”¹ç°æœ‰çš„å†…å­˜æ•°æ®ç»“æ„ï¼Œå®ƒåªæ˜¯å¯¹æ•°æ®ç»“æ„è¿›è¡Œéå†è¯»å–ï¼Œç„¶ååºåˆ—åŒ–å†™å…¥åˆ°ç£ç›˜ã€‚ä½†æ˜¯çˆ¶è¿›ç¨‹ä¸ä¸€æ ·ï¼Œå®ƒå¿…é¡»æŒç»­æ¥å—å®¢æˆ·ç«¯è¯·æ±‚ï¼Œç„¶åå¯¹å†…å­˜æ•°æ®ç»“æ„è¿›è¡Œä¸é—´æ–­ä¿®æ”¹ã€‚</p><p>è¿™æ—¶å€™å°±ä¼šä½¿ç”¨æ“ä½œç³»ç»Ÿçš„ COW æœºåˆ¶æ¥è¿›è¡Œæ•°æ®æ®µé¡µé¢çš„åˆ†ç¦»ã€‚æ•°æ®æ®µé¡µé¢æ˜¯ç”±å¾ˆå¤šæ“ä½œç³»ç»Ÿçš„é¡µé¢ç»„åˆè€Œæˆï¼Œå½“çˆ¶è¿›ç¨‹å¯¹å…¶ä¸­ä¸€ä¸ªé¡µé¢çš„æ•°æ®è¿›è¡Œä¿®æ”¹æ—¶ï¼Œä¼šå°†è¢«å…±äº«çš„é¡µé¢å¤åˆ¶ä¸€ä»½åˆ†ç¦»å‡ºæ¥ï¼Œç„¶åå¯¹è¿™ä¸ªå¤åˆ¶çš„é¡µé¢è¿›è¡Œä¿®æ”¹ã€‚è¿™æ—¶å­è¿›ç¨‹ç›¸åº”çš„é¡µé¢æ˜¯æ²¡æœ‰å˜åŒ–çš„ï¼Œè¿˜æ˜¯è¿›ç¨‹äº§ç”Ÿæ—¶é‚£ä¸€ç¬é—´çš„æ•°æ®ã€‚</p><p>éšç€çˆ¶è¿›ç¨‹ä¿®æ”¹æ“ä½œçš„æŒç»­è¿›è¡Œï¼Œè¶Šæ¥è¶Šå¤šçš„å…±äº«é¡µé¢è¢«åˆ†ç¦»å‡ºæ¥ï¼Œå†…å­˜å°±ä¼šæŒç»­å¢é•¿ã€‚ä½†æ˜¯ä¹Ÿä¸ä¼šè¶…è¿‡åŸæœ‰æ•°æ®å†…å­˜çš„2å€å¤§å°ã€‚å¦ä¸€ä¸ªRediså®ä¾‹é‡Œå†·æ•°æ®å çš„æ¯”ä¾‹å¾€å¾€æ˜¯æ¯”è¾ƒé«˜çš„ï¼Œæ‰€ä»¥å¾ˆå°‘ä¼šå‡ºç°æ‰€æœ‰çš„é¡µé¢éƒ½ä¼šè¢«åˆ†ç¦»ï¼Œè¢«åˆ†ç¦»çš„å¾€å¾€åªæœ‰å…¶ä¸­ä¸€éƒ¨åˆ†é¡µé¢ã€‚æ¯ä¸ªé¡µé¢çš„å¤§å°åªæœ‰ 4kï¼Œä¸€ä¸ª Redis å®ä¾‹é‡Œé¢ä¸€èˆ¬éƒ½ä¼šæœ‰æˆåƒä¸Šä¸‡çš„é¡µé¢ã€‚</p><p>å­è¿›ç¨‹å› ä¸ºæ•°æ®æ²¡æœ‰å˜åŒ–ï¼Œå®ƒèƒ½çœ‹åˆ°çš„å†…å­˜é‡Œçš„æ•°æ®åœ¨è¿›ç¨‹äº§ç”Ÿçš„é‚£ä¸€ç¬é—´å°±å‡å›ºäº†ï¼Œå†ä¹Ÿä¸ä¼šæ”¹å˜ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ Redis çš„æŒä¹…åŒ–å« å¿«ç…§çš„åŸå› ã€‚</p><h4 id="5-3-2-AOFçš„å†™å…¥"><a href="#5-3-2-AOFçš„å†™å…¥" class="headerlink" title="5.3.2 AOFçš„å†™å…¥"></a>5.3.2 AOFçš„å†™å…¥</h4><p>Redis å°†æ‰€æœ‰å¯¹æ•°æ®åº“è¿›è¡Œè¿‡å†™å…¥çš„å‘½ä»¤ï¼ˆåŠå…¶å‚æ•°ï¼‰è®°å½•åˆ° AOF æ–‡ä»¶ï¼Œ ä»¥æ­¤è¾¾åˆ°è®°å½•æ•°æ®åº“çŠ¶æ€çš„ç›®çš„ï¼Œ ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œ æˆ‘ä»¬ç§°å‘¼è¿™ç§è®°å½•è¿‡ç¨‹ä¸ºåŒæ­¥ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œ å¦‚æœæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; RPUSH list 1 2 3 4</span><br><span class="line">(integer) 4</span><br><span class="line"></span><br><span class="line">redis&gt; LRANGE list 0 -1</span><br><span class="line">1) &quot;1&quot;</span><br><span class="line">2) &quot;2&quot;</span><br><span class="line">3) &quot;3&quot;</span><br><span class="line">4) &quot;4&quot;</span><br><span class="line"></span><br><span class="line">redis&gt; KEYS *</span><br><span class="line">1) &quot;list&quot;</span><br><span class="line"></span><br><span class="line">redis&gt; RPOP list</span><br><span class="line">&quot;4&quot;</span><br><span class="line"></span><br><span class="line">redis&gt; LPOP list</span><br><span class="line">&quot;1&quot;</span><br><span class="line"></span><br><span class="line">redis&gt; LPUSH list 1</span><br><span class="line">(integer) 3</span><br><span class="line"></span><br><span class="line">redis&gt; LRANGE list 0 -1</span><br><span class="line">1) &quot;1&quot;</span><br><span class="line">2) &quot;2&quot;</span><br><span class="line">3) &quot;3&quot;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå…¶ä¸­å››æ¡å¯¹æ•°æ®åº“æœ‰ä¿®æ”¹çš„å†™å…¥å‘½ä»¤å°±ä¼šè¢«åŒæ­¥åˆ° AOF æ–‡ä»¶ä¸­</p><p>é™¤äº† SELECT å‘½ä»¤æ˜¯ AOF ç¨‹åºè‡ªå·±åŠ ä¸Šå»çš„ä¹‹å¤–ï¼Œ å…¶ä»–å‘½ä»¤éƒ½æ˜¯ä¹‹å‰æˆ‘ä»¬åœ¨ç»ˆç«¯é‡Œæ‰§è¡Œçš„å‘½ä»¤ã€‚</p><p>åŒæ­¥å‘½ä»¤åˆ° AOF æ–‡ä»¶çš„æ•´ä¸ªè¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š</p><ol><li>å‘½ä»¤ä¼ æ’­ï¼šRedis å°†æ‰§è¡Œå®Œçš„å‘½ä»¤ã€å‘½ä»¤çš„å‚æ•°ã€å‘½ä»¤çš„å‚æ•°ä¸ªæ•°ç­‰ä¿¡æ¯å‘é€åˆ° AOF ç¨‹åºä¸­ã€‚</li><li>ç¼“å­˜è¿½åŠ ï¼šAOF ç¨‹åºæ ¹æ®æ¥æ”¶åˆ°çš„å‘½ä»¤æ•°æ®ï¼Œå°†å‘½ä»¤è½¬æ¢ä¸ºç½‘ç»œé€šè®¯åè®®çš„æ ¼å¼ï¼Œç„¶åå°†åè®®å†…å®¹è¿½åŠ åˆ°æœåŠ¡å™¨çš„ AOF ç¼“å­˜ä¸­ã€‚</li><li>æ–‡ä»¶å†™å…¥å’Œä¿å­˜ï¼šAOF ç¼“å­˜ä¸­çš„å†…å®¹è¢«å†™å…¥åˆ° AOF æ–‡ä»¶æœ«å°¾ï¼Œå¦‚æœè®¾å®šçš„ AOF ä¿å­˜æ¡ä»¶è¢«æ»¡è¶³çš„è¯ï¼Œ fsync å‡½æ•°æˆ–è€… fdatasync å‡½æ•°ä¼šè¢«è°ƒç”¨ï¼Œå°†å†™å…¥çš„å†…å®¹çœŸæ­£åœ°ä¿å­˜åˆ°ç£ç›˜ä¸­ã€‚</li></ol><p>ä»¥ä¸‹å‡ ä¸ªå°èŠ‚å°†è¯¦ç»†åœ°ä»‹ç»è¿™ä¸‰ä¸ªæ­¥éª¤ã€‚</p><h5 id="å‘½ä»¤ä¼ æ’­"><a href="#å‘½ä»¤ä¼ æ’­" class="headerlink" title="å‘½ä»¤ä¼ æ’­"></a>å‘½ä»¤ä¼ æ’­</h5><p>å½“ä¸€ä¸ª Redis å®¢æˆ·ç«¯éœ€è¦æ‰§è¡Œå‘½ä»¤æ—¶ï¼Œ å®ƒé€šè¿‡ç½‘ç»œè¿æ¥ï¼Œ å°†åè®®æ–‡æœ¬å‘é€ç»™ Redis æœåŠ¡å™¨ã€‚æ¯”å¦‚è¯´ï¼Œ è¦æ‰§è¡Œå‘½ä»¤ SET KEY VALUE ï¼Œ å®¢æˆ·ç«¯å°†å‘æœåŠ¡å™¨å‘é€æ–‡æœ¬ â€œ*3\r\n$3\r\nSET\r\n$3\r\nKEY\r\n$5\r\nVALUE\r\nâ€ ã€‚</p><p>æœåŠ¡å™¨åœ¨æ¥åˆ°å®¢æˆ·ç«¯çš„è¯·æ±‚ä¹‹åï¼Œ å®ƒä¼šæ ¹æ®åè®®æ–‡æœ¬çš„å†…å®¹ï¼Œ é€‰æ‹©é€‚å½“çš„å‘½ä»¤å‡½æ•°ï¼Œ å¹¶å°†å„ä¸ªå‚æ•°ä»å­—ç¬¦ä¸²æ–‡æœ¬è½¬æ¢ä¸º Redis å­—ç¬¦ä¸²å¯¹è±¡ï¼ˆStringObjectï¼‰ã€‚</p><p>æ¯”å¦‚è¯´ï¼Œ é’ˆå¯¹ä¸Šé¢çš„ <a href="http://redis.readthedocs.org/en/latest/string/set.html#set">SET</a> å‘½ä»¤ä¾‹å­ï¼Œ Redis å°†å®¢æˆ·ç«¯çš„å‘½ä»¤æŒ‡é’ˆæŒ‡å‘å®ç° <a href="http://redis.readthedocs.org/en/latest/string/set.html#set">SET</a> å‘½ä»¤çš„ setCommand å‡½æ•°ï¼Œ å¹¶åˆ›å»ºä¸‰ä¸ª Redis å­—ç¬¦ä¸²å¯¹è±¡ï¼Œ åˆ†åˆ«ä¿å­˜ SET ã€ KEY å’Œ VALUE ä¸‰ä¸ªå‚æ•°ï¼ˆå‘½ä»¤ä¹Ÿç®—ä½œå‚æ•°ï¼‰ã€‚</p><p>æ¯å½“å‘½ä»¤å‡½æ•°æˆåŠŸæ‰§è¡Œä¹‹åï¼Œ å‘½ä»¤å‚æ•°éƒ½ä¼šè¢«ä¼ æ’­åˆ° AOF ç¨‹åºï¼Œ ä»¥åŠ REPLICATION ç¨‹åºï¼ˆæœ¬èŠ‚ä¸è®¨è®ºè¿™ä¸ªï¼Œåˆ—åœ¨è¿™é‡Œåªæ˜¯ä¸ºäº†å®Œæ•´æ€§çš„è€ƒè™‘ï¼‰ã€‚</p><h5 id="ç¼“å­˜è¿½åŠ "><a href="#ç¼“å­˜è¿½åŠ " class="headerlink" title="ç¼“å­˜è¿½åŠ "></a>ç¼“å­˜è¿½åŠ </h5><p>å½“å‘½ä»¤è¢«ä¼ æ’­åˆ° AOF ç¨‹åºä¹‹åï¼Œ ç¨‹åºä¼šæ ¹æ®å‘½ä»¤ä»¥åŠå‘½ä»¤çš„å‚æ•°ï¼Œ å°†å‘½ä»¤ä»å­—ç¬¦ä¸²å¯¹è±¡è½¬æ¢å›åŸæ¥çš„åè®®æ–‡æœ¬ã€‚</p><p>æ¯”å¦‚è¯´ï¼Œ å¦‚æœ AOF ç¨‹åºæ¥å—åˆ°çš„ä¸‰ä¸ªå‚æ•°åˆ†åˆ«ä¿å­˜ç€ SET ã€ KEY å’Œ VALUE ä¸‰ä¸ªå­—ç¬¦ä¸²ï¼Œ é‚£ä¹ˆå®ƒå°†ç”Ÿæˆåè®®æ–‡æœ¬ â€œ*3\r\n$3\r\nSET\r\n$3\r\nKEY\r\n$5\r\nVALUE\r\nâ€ ã€‚</p><p>åè®®æ–‡æœ¬ç”Ÿæˆä¹‹åï¼Œ å®ƒä¼šè¢«è¿½åŠ åˆ° redis.h&#x2F;redisServer ç»“æ„çš„ aof_buf æœ«å°¾ã€‚</p><p>redisServer ç»“æ„ç»´æŒç€ Redis æœåŠ¡å™¨çš„çŠ¶æ€ï¼Œ aof_buf åŸŸåˆ™ä¿å­˜ç€æ‰€æœ‰ç­‰å¾…å†™å…¥åˆ° AOF æ–‡ä»¶çš„åè®®æ–‡æœ¬ï¼š</p><h5 id="æ–‡ä»¶å†™å…¥å’Œä¿å­˜"><a href="#æ–‡ä»¶å†™å…¥å’Œä¿å­˜" class="headerlink" title="æ–‡ä»¶å†™å…¥å’Œä¿å­˜"></a>æ–‡ä»¶å†™å…¥å’Œä¿å­˜</h5><p>æ¯å½“æœåŠ¡å™¨å¸¸è§„ä»»åŠ¡å‡½æ•°è¢«æ‰§è¡Œã€ æˆ–è€…äº‹ä»¶å¤„ç†å™¨è¢«æ‰§è¡Œæ—¶ï¼Œ aof.c&#x2F;flushAppendOnlyFile å‡½æ•°éƒ½ä¼šè¢«è°ƒç”¨ï¼Œ è¿™ä¸ªå‡½æ•°æ‰§è¡Œä»¥ä¸‹ä¸¤ä¸ªå·¥ä½œï¼š</p><p>WRITEï¼šæ ¹æ®æ¡ä»¶ï¼Œå°† aof_buf ä¸­çš„ç¼“å­˜å†™å…¥åˆ° AOF æ–‡ä»¶ã€‚</p><p>SAVEï¼šæ ¹æ®æ¡ä»¶ï¼Œè°ƒç”¨ fsync æˆ– fdatasync å‡½æ•°ï¼Œå°† AOF æ–‡ä»¶ä¿å­˜åˆ°ç£ç›˜ä¸­ã€‚</p><p>ä¸¤ä¸ªæ­¥éª¤éƒ½éœ€è¦æ ¹æ®ä¸€å®šçš„æ¡ä»¶æ¥æ‰§è¡Œï¼Œ è€Œè¿™äº›æ¡ä»¶ç”± AOF æ‰€ä½¿ç”¨çš„ä¿å­˜æ¨¡å¼æ¥å†³å®šï¼Œ ä»¥ä¸‹å°èŠ‚å°±æ¥ä»‹ç» AOF æ‰€ä½¿ç”¨çš„ä¸‰ç§ä¿å­˜æ¨¡å¼ï¼Œ ä»¥åŠåœ¨è¿™äº›æ¨¡å¼ä¸‹ï¼Œ æ­¥éª¤ WRITE å’Œ SAVE çš„è°ƒç”¨æ¡ä»¶ã€‚</p><h5 id="AOF-ä¿å­˜æ¨¡å¼"><a href="#AOF-ä¿å­˜æ¨¡å¼" class="headerlink" title="AOF ä¿å­˜æ¨¡å¼"></a>AOF ä¿å­˜æ¨¡å¼</h5><p>Redis ç›®å‰æ”¯æŒä¸‰ç§ AOF ä¿å­˜æ¨¡å¼ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ï¼š</p><ul><li><p>AOF_FSYNC_NO ï¼šä¸ä¿å­˜åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œ æ¯æ¬¡è°ƒç”¨ flushAppendOnlyFile å‡½æ•°ï¼Œ WRITE éƒ½ä¼šè¢«æ‰§è¡Œï¼Œ ä½† SAVE ä¼šè¢«ç•¥è¿‡ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œ SAVE åªä¼šåœ¨ä»¥ä¸‹ä»»æ„ä¸€ç§æƒ…å†µä¸­è¢«æ‰§è¡Œï¼šè¿™ä¸‰ç§æƒ…å†µä¸‹çš„ SAVE æ“ä½œéƒ½ä¼šå¼•èµ· Redis ä¸»è¿›ç¨‹é˜»å¡ã€‚</p></li><li><ul><li>Redis è¢«å…³é—­</li><li>AOF åŠŸèƒ½è¢«å…³é—­</li><li>ç³»ç»Ÿçš„å†™ç¼“å­˜è¢«åˆ·æ–°ï¼ˆå¯èƒ½æ˜¯ç¼“å­˜å·²ç»è¢«å†™æ»¡ï¼Œæˆ–è€…å®šæœŸä¿å­˜æ“ä½œè¢«æ‰§è¡Œï¼‰</li></ul></li><li><p>AOF_FSYNC_EVERYSEC ï¼šæ¯ä¸€ç§’é’Ÿä¿å­˜ä¸€æ¬¡ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸­ï¼Œ SAVE åŸåˆ™ä¸Šæ¯éš”ä¸€ç§’é’Ÿå°±ä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œ å› ä¸º SAVE æ“ä½œæ˜¯ç”±åå°å­çº¿ç¨‹è°ƒç”¨çš„ï¼Œ æ‰€ä»¥å®ƒä¸ä¼šå¼•èµ·æœåŠ¡å™¨ä¸»è¿›ç¨‹é˜»å¡ã€‚æ³¨æ„ï¼Œ åœ¨ä¸Šä¸€å¥çš„è¯´æ˜é‡Œé¢ä½¿ç”¨äº†è¯è¯­â€œåŸåˆ™ä¸Šâ€ï¼Œ åœ¨å®é™…è¿è¡Œä¸­ï¼Œ ç¨‹åºåœ¨è¿™ç§æ¨¡å¼ä¸‹å¯¹ fsync æˆ– fdatasync çš„è°ƒç”¨å¹¶ä¸æ˜¯æ¯ç§’ä¸€æ¬¡ï¼Œ å®ƒå’Œè°ƒç”¨ flushAppendOnlyFile å‡½æ•°æ—¶ Redis æ‰€å¤„çš„çŠ¶æ€æœ‰å…³ã€‚æ¯å½“ flushAppendOnlyFile å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œ å¯èƒ½ä¼šå‡ºç°ä»¥ä¸‹å››ç§æƒ…å†µï¼šæ ¹æ®ä»¥ä¸Šè¯´æ˜å¯ä»¥çŸ¥é“ï¼Œ åœ¨â€œæ¯ä¸€ç§’é’Ÿä¿å­˜ä¸€æ¬¡â€æ¨¡å¼ä¸‹ï¼Œ å¦‚æœåœ¨æƒ…å†µ 1 ä¸­å‘ç”Ÿæ•…éšœåœæœºï¼Œ é‚£ä¹ˆç”¨æˆ·æœ€å¤šæŸå¤±å°äº 2 ç§’å†…æ‰€äº§ç”Ÿçš„æ‰€æœ‰æ•°æ®ã€‚å¦‚æœåœ¨æƒ…å†µ 2 ä¸­å‘ç”Ÿæ•…éšœåœæœºï¼Œ é‚£ä¹ˆç”¨æˆ·æŸå¤±çš„æ•°æ®æ˜¯å¯ä»¥è¶…è¿‡ 2 ç§’çš„ã€‚Redis å®˜ç½‘ä¸Šæ‰€è¯´çš„ï¼Œ AOF åœ¨â€œæ¯ä¸€ç§’é’Ÿä¿å­˜ä¸€æ¬¡â€æ—¶å‘ç”Ÿæ•…éšœï¼Œ åªä¸¢å¤± 1 ç§’é’Ÿæ•°æ®çš„è¯´æ³•ï¼Œ å®é™…ä¸Šå¹¶ä¸å‡†ç¡®ã€‚</p></li><li><ul><li>å­çº¿ç¨‹æ­£åœ¨æ‰§è¡Œ SAVE ï¼Œå¹¶ä¸”ï¼š</li></ul></li></ul><ol><li><ol><li><ol><li>è¿™ä¸ª SAVE çš„æ‰§è¡Œæ—¶é—´æœªè¶…è¿‡ 2 ç§’ï¼Œé‚£ä¹ˆç¨‹åºç›´æ¥è¿”å›ï¼Œå¹¶ä¸æ‰§è¡Œ WRITE æˆ–æ–°çš„ SAVE ã€‚</li><li>è¿™ä¸ª SAVE å·²ç»æ‰§è¡Œè¶…è¿‡ 2 ç§’ï¼Œé‚£ä¹ˆç¨‹åºæ‰§è¡Œ WRITE ï¼Œä½†ä¸æ‰§è¡Œæ–°çš„ SAVE ã€‚æ³¨æ„ï¼Œå› ä¸ºè¿™æ—¶ WRITE çš„å†™å…¥å¿…é¡»ç­‰å¾…å­çº¿ç¨‹å…ˆå®Œæˆï¼ˆæ—§çš„ï¼‰ SAVE ï¼Œå› æ­¤è¿™é‡Œ WRITE ä¼šæ¯”å¹³æ—¶é˜»å¡æ›´é•¿æ—¶é—´ã€‚</li></ol></li></ol></li></ol><ul><li><ul><li>å­çº¿ç¨‹æ²¡æœ‰åœ¨æ‰§è¡Œ SAVE ï¼Œå¹¶ä¸”ï¼š</li></ul></li></ul><ol><li><ol><li><ol><li>ä¸Šæ¬¡æˆåŠŸæ‰§è¡Œ SAVE è·ä»Šä¸è¶…è¿‡ 1 ç§’ï¼Œé‚£ä¹ˆç¨‹åºæ‰§è¡Œ WRITE ï¼Œä½†ä¸æ‰§è¡Œ SAVE ã€‚</li><li>ä¸Šæ¬¡æˆåŠŸæ‰§è¡Œ SAVE è·ä»Šå·²ç»è¶…è¿‡ 1 ç§’ï¼Œé‚£ä¹ˆç¨‹åºæ‰§è¡Œ WRITE å’Œ SAVE ã€‚</li></ol></li></ol></li></ol><ul><li>AOF_FSYNC_ALWAYS ï¼šæ¯æ‰§è¡Œä¸€ä¸ªå‘½ä»¤ä¿å­˜ä¸€æ¬¡ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œæ¯æ¬¡æ‰§è¡Œå®Œä¸€ä¸ªå‘½ä»¤ä¹‹åï¼Œ WRITE å’Œ SAVE éƒ½ä¼šè¢«æ‰§è¡Œã€‚å¦å¤–ï¼Œå› ä¸º SAVE æ˜¯ç”± Redis ä¸»è¿›ç¨‹æ‰§è¡Œçš„ï¼Œæ‰€ä»¥åœ¨ SAVE æ‰§è¡ŒæœŸé—´ï¼Œä¸»è¿›ç¨‹ä¼šè¢«é˜»å¡ï¼Œä¸èƒ½æ¥å—å‘½ä»¤è¯·æ±‚ã€‚</li></ul><p>æ€»ç»“ï¼š</p><table><thead><tr><th><strong>æ¨¡å¼</strong></th><th><strong>WRITE æ˜¯å¦é˜»å¡ï¼Ÿ</strong></th><th><strong>SAVE æ˜¯å¦é˜»å¡ï¼Ÿ</strong></th><th><strong>åœæœºæ—¶ä¸¢å¤±çš„æ•°æ®é‡</strong></th></tr></thead><tbody><tr><td>AOF_FSYNC_NO</td><td>é˜»å¡</td><td>é˜»å¡</td><td>æ“ä½œç³»ç»Ÿæœ€åä¸€æ¬¡å¯¹ AOF æ–‡ä»¶è§¦å‘ SAVE æ“ä½œä¹‹åçš„æ•°æ®ã€‚</td></tr><tr><td>AOF_FSYNC_EVERYSEC</td><td>é˜»å¡</td><td>ä¸é˜»å¡</td><td>ä¸€èˆ¬æƒ…å†µä¸‹ä¸è¶…è¿‡ 2 ç§’é’Ÿçš„æ•°æ®ã€‚</td></tr><tr><td>AOF_FSYNC_ALWAYS</td><td>é˜»å¡</td><td>é˜»å¡</td><td>æœ€å¤šåªä¸¢å¤±ä¸€ä¸ªå‘½ä»¤çš„æ•°æ®ã€‚</td></tr></tbody></table><h4 id="5-3-3-AOF-æ–‡ä»¶çš„è¯»å–å’Œæ•°æ®è¿˜åŸ"><a href="#5-3-3-AOF-æ–‡ä»¶çš„è¯»å–å’Œæ•°æ®è¿˜åŸ" class="headerlink" title="5.3.3 AOF æ–‡ä»¶çš„è¯»å–å’Œæ•°æ®è¿˜åŸ"></a>5.3.3 AOF æ–‡ä»¶çš„è¯»å–å’Œæ•°æ®è¿˜åŸ</h4><p>AOF æ–‡ä»¶ä¿å­˜äº† Redis çš„æ•°æ®åº“çŠ¶æ€ï¼Œ è€Œæ–‡ä»¶é‡Œé¢åŒ…å«çš„éƒ½æ˜¯ç¬¦åˆ Redis é€šè®¯åè®®æ ¼å¼çš„å‘½ä»¤æ–‡æœ¬ã€‚</p><p>è¿™ä¹Ÿå°±æ˜¯è¯´ï¼Œ åªè¦æ ¹æ® AOF æ–‡ä»¶é‡Œçš„åè®®ï¼Œ é‡æ–°æ‰§è¡Œä¸€éé‡Œé¢æŒ‡ç¤ºçš„æ‰€æœ‰å‘½ä»¤ï¼Œ å°±å¯ä»¥è¿˜åŸ Redis çš„æ•°æ®åº“çŠ¶æ€äº†ã€‚</p><p>Redis è¯»å– AOF æ–‡ä»¶å¹¶è¿˜åŸæ•°æ®åº“çš„è¯¦ç»†æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>åˆ›å»ºä¸€ä¸ªä¸å¸¦ç½‘ç»œè¿æ¥çš„ä¼ªå®¢æˆ·ç«¯ï¼ˆfake clientï¼‰ã€‚</li><li>è¯»å– AOF æ‰€ä¿å­˜çš„æ–‡æœ¬ï¼Œå¹¶æ ¹æ®å†…å®¹è¿˜åŸå‡ºå‘½ä»¤ã€å‘½ä»¤çš„å‚æ•°ä»¥åŠå‘½ä»¤çš„ä¸ªæ•°ã€‚</li><li>æ ¹æ®å‘½ä»¤ã€å‘½ä»¤çš„å‚æ•°å’Œå‘½ä»¤çš„ä¸ªæ•°ï¼Œä½¿ç”¨ä¼ªå®¢æˆ·ç«¯æ‰§è¡Œè¯¥å‘½ä»¤ã€‚</li><li>æ‰§è¡Œ 2 å’Œ 3 ï¼Œç›´åˆ° AOF æ–‡ä»¶ä¸­çš„æ‰€æœ‰å‘½ä»¤æ‰§è¡Œå®Œæ¯•ã€‚</li></ol><p>å®Œæˆç¬¬ 4 æ­¥ä¹‹åï¼Œ AOF æ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®åº“å°±ä¼šè¢«å®Œæ•´åœ°è¿˜åŸå‡ºæ¥ã€‚</p><p>æ³¨æ„ï¼Œ å› ä¸º Redis çš„å‘½ä»¤åªèƒ½åœ¨å®¢æˆ·ç«¯çš„ä¸Šä¸‹æ–‡ä¸­è¢«æ‰§è¡Œï¼Œ è€Œ AOF è¿˜åŸæ—¶æ‰€ä½¿ç”¨çš„å‘½ä»¤æ¥è‡ªäº AOF æ–‡ä»¶ï¼Œ è€Œä¸æ˜¯ç½‘ç»œï¼Œ æ‰€ä»¥ç¨‹åºä½¿ç”¨äº†ä¸€ä¸ªæ²¡æœ‰ç½‘ç»œè¿æ¥çš„ä¼ªå®¢æˆ·ç«¯æ¥æ‰§è¡Œå‘½ä»¤ã€‚ ä¼ªå®¢æˆ·ç«¯æ‰§è¡Œå‘½ä»¤çš„æ•ˆæœï¼Œ å’Œå¸¦ç½‘ç»œè¿æ¥çš„å®¢æˆ·ç«¯æ‰§è¡Œå‘½ä»¤çš„æ•ˆæœï¼Œ å®Œå…¨ä¸€æ ·ã€‚</p><h4 id="5-3-4-AOF-é‡å†™"><a href="#5-3-4-AOF-é‡å†™" class="headerlink" title="5.3.4 AOF é‡å†™"></a>5.3.4 AOF é‡å†™</h4><p>AOF æ–‡ä»¶é€šè¿‡åŒæ­¥ Redis æœåŠ¡å™¨æ‰€æ‰§è¡Œçš„å‘½ä»¤ï¼Œ ä»è€Œå®ç°äº†æ•°æ®åº“çŠ¶æ€çš„è®°å½•ï¼Œ ä½†æ˜¯ï¼Œ è¿™ç§åŒæ­¥æ–¹å¼ä¼šé€ æˆä¸€ä¸ªé—®é¢˜ï¼š éšç€è¿è¡Œæ—¶é—´çš„æµé€ï¼Œ AOF æ–‡ä»¶ä¼šå˜å¾—è¶Šæ¥è¶Šå¤§ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œ å¦‚æœæœåŠ¡å™¨æ‰§è¡Œäº†ä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">RPUSH list 1 2 3 4      // [1, 2, 3, 4]</span><br><span class="line"></span><br><span class="line">RPOP list               // [1, 2, 3]</span><br><span class="line"></span><br><span class="line">LPOP list               // [2, 3]</span><br><span class="line"></span><br><span class="line">LPUSH list 1            // [1, 2, 3]</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå…‰æ˜¯è®°å½• list é”®çš„çŠ¶æ€ï¼Œ AOF æ–‡ä»¶å°±éœ€è¦ä¿å­˜å››æ¡å‘½ä»¤ã€‚è€Œå®è´¨ä¸Šï¼Œæˆ‘ä»¬å…¶å®åªè¦ä¿å­˜ list æœ€æ–°çŠ¶æ€çš„å†…å­˜æ•°æ®ï¼Œå°±å¯ä»¥ã€‚</p><p>å¦ä¸€æ–¹é¢ï¼Œ æœ‰äº›è¢«é¢‘ç¹æ“ä½œçš„é”®ï¼Œ å¯¹å®ƒä»¬æ‰€è°ƒç”¨çš„å‘½ä»¤å¯èƒ½æœ‰æˆç™¾ä¸Šåƒã€ç”šè‡³ä¸Šä¸‡æ¡ï¼Œ å¦‚æœè¿™æ ·è¢«é¢‘ç¹æ“ä½œçš„é”®æœ‰å¾ˆå¤šçš„è¯ï¼Œ AOF æ–‡ä»¶çš„ä½“ç§¯å°±ä¼šæ€¥é€Ÿè†¨èƒ€ï¼Œ å¯¹ Redis ã€ç”šè‡³æ•´ä¸ªç³»ç»Ÿçš„é€ æˆå½±å“ã€‚</p><p>ä¸ºäº†è§£å†³ä»¥ä¸Šçš„é—®é¢˜ï¼Œ Redis éœ€è¦å¯¹ AOF æ–‡ä»¶è¿›è¡Œé‡å†™ï¼ˆrewriteï¼‰ï¼š åˆ›å»ºä¸€ä¸ªæ–°çš„ AOF æ–‡ä»¶æ¥ä»£æ›¿åŸæœ‰çš„ AOF æ–‡ä»¶ï¼Œ æ–° AOF æ–‡ä»¶å’ŒåŸæœ‰ AOF æ–‡ä»¶ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€å®Œå…¨ä¸€æ ·ï¼Œ ä½†æ–° AOF æ–‡ä»¶çš„ä½“ç§¯å°äºç­‰äºåŸæœ‰ AOF æ–‡ä»¶çš„ä½“ç§¯ã€‚</p><h5 id="AOF-é‡å†™çš„å®ç°"><a href="#AOF-é‡å†™çš„å®ç°" class="headerlink" title="AOF é‡å†™çš„å®ç°"></a>AOF é‡å†™çš„å®ç°</h5><p>æ‰€è°“çš„â€œé‡å†™â€å…¶å®æ˜¯ä¸€ä¸ªæœ‰æ­§ä¹‰çš„è¯è¯­ï¼Œ å®é™…ä¸Šï¼Œ AOF é‡å†™å¹¶ä¸éœ€è¦å¯¹åŸæœ‰çš„ AOF æ–‡ä»¶è¿›è¡Œä»»ä½•å†™å…¥å’Œè¯»å–ï¼Œ å®ƒé’ˆå¯¹çš„æ˜¯æ•°æ®åº“ä¸­é”®çš„å½“å‰å€¼ã€‚</p><p>å¦‚åŒä¸Šé¢å¯¹ list è¿›è¡Œçš„å››ä¸ªæ“ä½œåï¼Œé‚£ä¹ˆå½“å‰ åˆ—è¡¨é”®åœ¨ Redisé‡Œçš„å€¼å°±ä¸º [1,2,3]ã€‚å¦‚æœæˆ‘ä»¬è¦ä¿å­˜è¿™ä¸ªåˆ—è¡¨çš„å½“å‰çŠ¶æ€ï¼Œ å¹¶ä¸”å°½é‡å‡å°‘æ‰€ä½¿ç”¨çš„å‘½ä»¤æ•°ï¼Œ é‚£ä¹ˆæœ€ç®€å•çš„æ–¹å¼ä¸æ˜¯å» AOF æ–‡ä»¶ä¸Šåˆ†æå‰é¢æ‰§è¡Œçš„å››æ¡å‘½ä»¤ï¼Œ è€Œæ˜¯ç›´æ¥è¯»å– list é”®åœ¨æ•°æ®åº“çš„å½“å‰å€¼ï¼Œ ç„¶åç”¨ä¸€æ¡ RPUSH 1 2 3 å‘½ä»¤æ¥ä»£æ›¿å‰é¢çš„å››æ¡å‘½ä»¤ã€‚</p><p>é™¤äº†åˆ—è¡¨å’Œé›†åˆä¹‹å¤–ï¼Œ å­—ç¬¦ä¸²ã€æœ‰åºé›†ã€å“ˆå¸Œè¡¨ç­‰é”®ä¹Ÿå¯ä»¥ç”¨ç±»ä¼¼çš„æ–¹æ³•æ¥ä¿å­˜çŠ¶æ€ï¼Œ å¹¶ä¸”ä¿å­˜è¿™äº›çŠ¶æ€æ‰€ä½¿ç”¨çš„å‘½ä»¤æ•°é‡ï¼Œ æ¯”èµ·ä¹‹å‰å»ºç«‹è¿™äº›é”®çš„çŠ¶æ€æ‰€ä½¿ç”¨å‘½ä»¤çš„æ•°é‡è¦å¤§å¤§å‡å°‘ã€‚</p><h5 id="AOF-åå°é‡å†™"><a href="#AOF-åå°é‡å†™" class="headerlink" title="AOF åå°é‡å†™"></a>AOF åå°é‡å†™</h5><p>ä¸Šä¸€èŠ‚å±•ç¤ºçš„ AOF é‡å†™ç¨‹åºå¯ä»¥å¾ˆå¥½åœ°å®Œæˆåˆ›å»ºä¸€ä¸ªæ–° AOF æ–‡ä»¶çš„ä»»åŠ¡ï¼Œ ä½†æ˜¯ï¼Œ åœ¨æ‰§è¡Œè¿™ä¸ªç¨‹åºçš„æ—¶å€™ï¼Œ è°ƒç”¨è€…çº¿ç¨‹ä¼šè¢«é˜»å¡ã€‚</p><p>å¾ˆæ˜æ˜¾ï¼Œ ä½œä¸ºä¸€ç§è¾…ä½æ€§çš„ç»´æŠ¤æ‰‹æ®µï¼Œ Redis ä¸å¸Œæœ› AOF é‡å†™é€ æˆæœåŠ¡å™¨æ— æ³•å¤„ç†è¯·æ±‚ï¼Œ æ‰€ä»¥ Redis å†³å®šå°† AOF é‡å†™ç¨‹åºæ”¾åˆ°ï¼ˆåå°ï¼‰å­è¿›ç¨‹é‡Œæ‰§è¡Œï¼Œ è¿™æ ·å¤„ç†çš„æœ€å¤§å¥½å¤„æ˜¯ï¼š</p><ol><li>å­è¿›ç¨‹è¿›è¡Œ AOF é‡å†™æœŸé—´ï¼Œä¸»è¿›ç¨‹å¯ä»¥ç»§ç»­å¤„ç†å‘½ä»¤è¯·æ±‚ã€‚</li><li>å­è¿›ç¨‹å¸¦æœ‰ä¸»è¿›ç¨‹çš„æ•°æ®å‰¯æœ¬ï¼Œä½¿ç”¨å­è¿›ç¨‹è€Œä¸æ˜¯çº¿ç¨‹ï¼Œå¯ä»¥åœ¨é¿å…é”çš„æƒ…å†µä¸‹ï¼Œä¿è¯æ•°æ®çš„å®‰å…¨æ€§ã€‚</li></ol><p>ä¸è¿‡ï¼Œ ä½¿ç”¨å­è¿›ç¨‹ä¹Ÿæœ‰ä¸€ä¸ªé—®é¢˜éœ€è¦è§£å†³ï¼š å› ä¸ºå­è¿›ç¨‹åœ¨è¿›è¡Œ AOF é‡å†™æœŸé—´ï¼Œ ä¸»è¿›ç¨‹è¿˜éœ€è¦ç»§ç»­å¤„ç†å‘½ä»¤ï¼Œ è€Œæ–°çš„å‘½ä»¤å¯èƒ½å¯¹ç°æœ‰çš„æ•°æ®è¿›è¡Œä¿®æ”¹ï¼Œ è¿™ä¼šè®©å½“å‰æ•°æ®åº“çš„æ•°æ®å’Œé‡å†™åçš„ AOF æ–‡ä»¶ä¸­çš„æ•°æ®ä¸ä¸€è‡´ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ Redis å¢åŠ äº†ä¸€ä¸ª AOF é‡å†™ç¼“å­˜ï¼Œ è¿™ä¸ªç¼“å­˜åœ¨ fork å‡ºå­è¿›ç¨‹ä¹‹åå¼€å§‹å¯ç”¨ï¼Œ Redis ä¸»è¿›ç¨‹åœ¨æ¥åˆ°æ–°çš„å†™å‘½ä»¤ä¹‹åï¼Œ é™¤äº†ä¼šå°†è¿™ä¸ªå†™å‘½ä»¤çš„åè®®å†…å®¹è¿½åŠ åˆ°ç°æœ‰çš„ AOF æ–‡ä»¶ä¹‹å¤–ï¼Œ è¿˜ä¼šè¿½åŠ åˆ°è¿™ä¸ªç¼“å­˜ä¸­ã€‚</p><p>æ¢è¨€ä¹‹ï¼Œ å½“å­è¿›ç¨‹åœ¨æ‰§è¡Œ AOF é‡å†™æ—¶ï¼Œ ä¸»è¿›ç¨‹éœ€è¦æ‰§è¡Œä»¥ä¸‹ä¸‰ä¸ªå·¥ä½œï¼š</p><ol><li>å¤„ç†å‘½ä»¤è¯·æ±‚ã€‚</li><li>å°†å†™å‘½ä»¤è¿½åŠ åˆ°ç°æœ‰çš„ AOF æ–‡ä»¶ä¸­ã€‚</li><li>å°†å†™å‘½ä»¤è¿½åŠ åˆ° AOF é‡å†™ç¼“å­˜ä¸­ã€‚</li></ol><p>è¿™æ ·ä¸€æ¥å¯ä»¥ä¿è¯ï¼š</p><ol><li>ç°æœ‰çš„ AOF åŠŸèƒ½ä¼šç»§ç»­æ‰§è¡Œï¼Œå³ä½¿åœ¨ AOF é‡å†™æœŸé—´å‘ç”Ÿåœæœºï¼Œä¹Ÿä¸ä¼šæœ‰ä»»ä½•æ•°æ®ä¸¢å¤±ã€‚</li><li>æ‰€æœ‰å¯¹æ•°æ®åº“è¿›è¡Œä¿®æ”¹çš„å‘½ä»¤éƒ½ä¼šè¢«è®°å½•åˆ° AOF é‡å†™ç¼“å­˜ä¸­ã€‚</li></ol><p>å½“å­è¿›ç¨‹å®Œæˆ AOF é‡å†™ä¹‹åï¼Œ å®ƒä¼šå‘çˆ¶è¿›ç¨‹å‘é€ä¸€ä¸ªå®Œæˆä¿¡å·ï¼Œ çˆ¶è¿›ç¨‹åœ¨æ¥åˆ°å®Œæˆä¿¡å·ä¹‹åï¼Œ ä¼šè°ƒç”¨ä¸€ä¸ªä¿¡å·å¤„ç†å‡½æ•°ï¼Œ å¹¶å®Œæˆä»¥ä¸‹å·¥ä½œï¼š</p><ol><li>å°† AOF é‡å†™ç¼“å­˜ä¸­çš„å†…å®¹å…¨éƒ¨å†™å…¥åˆ°æ–° AOF æ–‡ä»¶ä¸­ã€‚</li><li>å¯¹æ–°çš„ AOF æ–‡ä»¶è¿›è¡Œæ”¹åï¼Œè¦†ç›–åŸæœ‰çš„ AOF æ–‡ä»¶ã€‚</li></ol><p>å½“æ­¥éª¤ 1 æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œ ç°æœ‰ AOF æ–‡ä»¶ã€æ–° AOF æ–‡ä»¶å’Œæ•°æ®åº“ä¸‰è€…çš„çŠ¶æ€å°±å®Œå…¨ä¸€è‡´äº†ã€‚</p><p>å½“æ­¥éª¤ 2 æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œ ç¨‹åºå°±å®Œæˆäº†æ–°æ—§ä¸¤ä¸ª AOF æ–‡ä»¶çš„äº¤æ›¿ã€‚</p><p>è¿™ä¸ªä¿¡å·å¤„ç†å‡½æ•°æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œ ä¸»è¿›ç¨‹å°±å¯ä»¥ç»§ç»­åƒå¾€å¸¸ä¸€æ ·æ¥å—å‘½ä»¤è¯·æ±‚äº†ã€‚ åœ¨æ•´ä¸ª AOF åå°é‡å†™è¿‡ç¨‹ä¸­ï¼Œ åªæœ‰æœ€åçš„å†™å…¥ç¼“å­˜å’Œæ”¹åæ“ä½œä¼šé€ æˆä¸»è¿›ç¨‹é˜»å¡ï¼Œ åœ¨å…¶ä»–æ—¶å€™ï¼Œ AOF åå°é‡å†™éƒ½ä¸ä¼šå¯¹ä¸»è¿›ç¨‹é€ æˆé˜»å¡ï¼Œ è¿™å°† AOF é‡å†™å¯¹æ€§èƒ½é€ æˆçš„å½±å“é™åˆ°äº†æœ€ä½ã€‚</p><h4 id="5-3-5-æ··åˆæŒä¹…åŒ–"><a href="#5-3-5-æ··åˆæŒä¹…åŒ–" class="headerlink" title="5.3.5 æ··åˆæŒä¹…åŒ–"></a>5.3.5 æ··åˆæŒä¹…åŒ–</h4><p>ä¸ºäº†é›†æˆäº†ä¸¤è€…çš„ä¼˜ç‚¹ï¼Œ Redis 4.0 æå‡ºäº†æ··åˆä½¿ç”¨ AOF æ—¥å¿—å’Œå†…å­˜å¿«ç…§ï¼Œä¹Ÿå«æ··åˆæŒä¹…åŒ–ï¼Œæ—¢ä¿è¯äº† Redis é‡å¯é€Ÿåº¦ï¼Œåˆé™ä½æ•°æ®ä¸¢å¤±é£é™©ã€‚</p><p>æ··åˆæŒä¹…åŒ–å·¥ä½œåœ¨ AOF æ—¥å¿—é‡å†™è¿‡ç¨‹ï¼Œå½“å¼€å¯äº†æ··åˆæŒä¹…åŒ–æ—¶ï¼Œåœ¨ AOF é‡å†™æ—¥å¿—æ—¶ï¼Œfork å‡ºæ¥çš„é‡å†™å­è¿›ç¨‹ä¼šå…ˆå°†ä¸ä¸»çº¿ç¨‹å…±äº«çš„å†…å­˜æ•°æ®ä»¥ RDB æ–¹å¼å†™å…¥åˆ° AOF æ–‡ä»¶ï¼Œç„¶åä¸»çº¿ç¨‹å¤„ç†çš„æ“ä½œå‘½ä»¤ä¼šè¢«è®°å½•åœ¨é‡å†™ç¼“å†²åŒºé‡Œï¼Œé‡å†™ç¼“å†²åŒºé‡Œçš„å¢é‡å‘½ä»¤ä¼šä»¥ AOF æ–¹å¼å†™å…¥åˆ° AOF æ–‡ä»¶ï¼Œå†™å…¥å®Œæˆåé€šçŸ¥ä¸»è¿›ç¨‹å°†æ–°çš„å«æœ‰ RDB æ ¼å¼å’Œ AOF æ ¼å¼çš„ AOF æ–‡ä»¶æ›¿æ¢æ—§çš„çš„ AOF æ–‡ä»¶ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨äº†æ··åˆæŒä¹…åŒ–ï¼ŒAOF æ–‡ä»¶çš„å‰åŠéƒ¨åˆ†æ˜¯ RDB æ ¼å¼çš„å…¨é‡æ•°æ®ï¼ŒååŠéƒ¨åˆ†æ˜¯ AOF æ ¼å¼çš„å¢é‡æ•°æ®ã€‚</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1684770620104-4c8fc4d7-0964-4354-9ccf-ec35e2064483.jpeg" alt="img"></p><p>è¿™æ ·çš„å¥½å¤„åœ¨äºï¼Œé‡å¯ Redis åŠ è½½æ•°æ®çš„æ—¶å€™ï¼Œç”±äºå‰åŠéƒ¨åˆ†æ˜¯ RDB å†…å®¹ï¼Œè¿™æ ·åŠ è½½çš„æ—¶å€™é€Ÿåº¦ä¼šå¾ˆå¿«ã€‚</p><p>åŠ è½½å®Œ RDB çš„å†…å®¹åï¼Œæ‰ä¼šåŠ è½½ååŠéƒ¨åˆ†çš„ AOF å†…å®¹ï¼Œè¿™é‡Œçš„å†…å®¹æ˜¯ Redis åå°å­è¿›ç¨‹é‡å†™ AOF æœŸé—´ï¼Œä¸»çº¿ç¨‹å¤„ç†çš„æ“ä½œå‘½ä»¤ï¼Œå¯ä»¥ä½¿å¾—æ•°æ®æ›´å°‘çš„ä¸¢å¤±ã€‚</p><p>æ··åˆæŒä¹…åŒ–ä¼˜ç‚¹ï¼š</p><p>æ··åˆæŒä¹…åŒ–ç»“åˆäº† RDB å’Œ AOF æŒä¹…åŒ–çš„ä¼˜ç‚¹ï¼Œå¼€å¤´ä¸º RDB çš„æ ¼å¼ï¼Œä½¿å¾— Redis å¯ä»¥æ›´å¿«çš„å¯åŠ¨ï¼ŒåŒæ—¶ç»“åˆ AOF çš„ä¼˜ç‚¹ï¼Œæœ‰å‡ä½äº†å¤§é‡æ•°æ®ä¸¢å¤±çš„é£é™©ã€‚</p><p>æ··åˆæŒä¹…åŒ–ç¼ºç‚¹ï¼š</p><p>AOF æ–‡ä»¶ä¸­æ·»åŠ äº† RDB æ ¼å¼çš„å†…å®¹ï¼Œä½¿å¾— AOF æ–‡ä»¶çš„å¯è¯»æ€§å˜å¾—å¾ˆå·®ï¼›</p><p>å…¼å®¹æ€§å·®ï¼Œå¦‚æœå¼€å¯æ··åˆæŒä¹…åŒ–ï¼Œé‚£ä¹ˆæ­¤æ··åˆæŒä¹…åŒ– AOF æ–‡ä»¶ï¼Œå°±ä¸èƒ½ç”¨åœ¨ Redis 4.0 ä¹‹å‰ç‰ˆæœ¬äº†ã€‚</p><h3 id="5-4-ç®¡é“"><a href="#5-4-ç®¡é“" class="headerlink" title="5.4 ç®¡é“"></a>5.4 ç®¡é“</h3><p>Redis ç®¡é“å¹¶ä¸æ˜¯ Redis æœåŠ¡å™¨ç›´æ¥æä¾›çš„æŠ€æœ¯ï¼Œè¿™ä¸ªæŠ€æœ¯å®é™…æ˜¯ç”±å®¢æˆ·ç«¯æä¾›çš„ï¼Œè·ŸæœåŠ¡å™¨æ²¡æœ‰æœ¬è´¨å…³ç³»ã€‚</p><p><strong>Redis çš„æ¶ˆæ¯äº¤äº’ï¼š</strong></p><p>å½“æˆ‘ä»¬ä½¿ç”¨å®¢æˆ·ç«¯å¯¹ Redis è¿›è¡Œä¸€æ¬¡æ“ä½œæ—¶ã€‚å®¢æˆ·ç«¯å°†è¯·æ±‚ä¼ é€ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨å¤„ç†å®Œæˆåï¼Œå†å°†å“åº”å›å¤ç»™å®¢æˆ·ç«¯ã€è¿™å°±éœ€è¦èŠ±è´¹ä¸€ä¸ªç½‘ç»œæ•°æ®åŒ…æ¥å›çš„æ—¶é—´ã€‚</p><p>å¦‚æœè¿ç»­æ‰§è¡Œå¤šæ¡æŒ‡ä»¤ï¼Œé‚£å°±ä¼šèŠ±è´¹å¤šä¸ªç½‘ç»œæ•°æ®åŒ…æ¥å›çš„æ—¶é—´ã€‚ä»å®¢æˆ·ç«¯å±‚é¢ä¸Šæ¥çœ‹ï¼Œå®¢æˆ·ç«¯æ—¶ç»å†äº† å‘é€è¯·æ±‚1-æ¥å—å“åº”1-å‘é€è¯·æ±‚2-æ¥å—å“åº”2â€” è¿™æ ·ã€‚é‚£ä¹ˆæˆ‘ä»¬å®é™…ä¸Šå¯ä»¥è°ƒæ•´ä¸€ä¸‹ï¼Œå¤šä¸ªæŒ‡ä»¤è¯·æ±‚çš„è¯·æ±‚å“åº”é¡ºåºã€‚å³ å‘é€è¯·æ±‚1-å‘é€è¯·æ±‚2-æ¥å—è¯·æ±‚1-æ¥å—è¯·æ±‚2ã€‚è¿™è¿™æ ·ä¸¤ä¸ªè¿ç»­çš„å‘é€è¯·æ±‚æ“ä½œå’Œä¸¤ä¸ªè¿ç»­çš„ç­‰å¾…è¯·æ±‚å“åº”æ“ä½œ æ€»å…±åªä¼šèŠ±è´¹ä¸€æ¬¡ç½‘ç»œæ¥å›ã€‚</p><p>è¿™ä¾¿æ˜¯ç®¡é“æ“ä½œçš„æœ¬è´¨ï¼ŒæœåŠ¡å™¨æ ¹æœ¬æ²¡æœ‰åŒºåˆ«å¯¹å¾…ï¼Œè¿˜æ˜¯æ”¶åˆ°ä¸€æ¡æ¶ˆæ¯ï¼Œæ‰§è¡Œä¸€æ¡æ¶ˆæ¯ï¼Œå›å¤ä¸€æ¡æ¶ˆæ¯çš„æ­£å¸¸æµç¨‹ã€‚å®¢æˆ·ç«¯é€šè¿‡å¯¹ç®¡é“ä¸­æŒ‡ä»¤åˆ—è¡¨æ”¹å˜æ“ä½œé¡ºåºå°±å¯ä»¥å¤§å¹…èŠ‚çœ IO æ—¶é—´ã€‚ç®¡é“ä¸­çš„æŒ‡ä»¤è¶Šå¤šï¼Œæ•ˆæœè¶Šå¥½ã€‚</p><h5 id="ç®¡é“å‹åŠ›æµ‹è¯•"><a href="#ç®¡é“å‹åŠ›æµ‹è¯•" class="headerlink" title="ç®¡é“å‹åŠ›æµ‹è¯•"></a>ç®¡é“å‹åŠ›æµ‹è¯•</h5><p>Redis è‡ªå¸¦äº†ä¸€ä¸ªå‹åŠ›æµ‹è¯•å·¥å…· redis-benchmarkï¼Œä½¿ç”¨è¿™ä¸ªå·¥å…·å°±å¯ä»¥è¿›è¡Œç®¡é“æµ‹è¯•ã€‚é¦–å…ˆæˆ‘ä»¬å¯¹ä¸€ä¸ªæ™®é€šçš„ set æŒ‡ä»¤è¿›è¡Œå‹æµ‹ï¼ŒQPSå¤§çº¦ 2.5w&#x2F;sã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@b7ba9713c11c:/data# redis-benchmark -t set -q</span><br><span class="line">SET: 24319.07 requests per second, p50=0.959 msec</span><br></pre></td></tr></table></figure><p>åŠ å…¥ç®¡é“é€‰é¡¹ -P å‚æ•°ï¼Œå®ƒè¡¨ç¤ºå•ä¸ªç®¡é“å†…å¹¶è¡Œçš„è¯·æ±‚æ•°é‡ï¼Œçœ‹ä¸‹é¢ P&#x3D;2æ—¶ï¼ŒQPSå°±å¯ä»¥è¾¾åˆ° 5w&#x2F;s</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@b7ba9713c11c:/data# redis-benchmark -t set -q -P 2</span><br><span class="line">SET: 50200.80 requests per second, p50=0.943 msec   </span><br><span class="line">root@b7ba9713c11c:/data# redis-benchmark -t set -q -P 40</span><br><span class="line">SET: 175131.36 requests per second, p50=10.391 msec </span><br><span class="line">root@b7ba9713c11c:/data# redis-benchmark -t set -q -P 100</span><br><span class="line">SET: 182149.36 requests per second, p50=26.671 msec</span><br></pre></td></tr></table></figure><p>å‘ç°åˆ°åé¢æé«˜ P å‚æ•°ï¼Œå·²ç»æ— æ³•æé«˜ QPSäº†ï¼Œè¿™ä¸€èˆ¬éƒ½æ˜¯å› ä¸º CPU å¤„ç†èƒ½åŠ›å·²ç»è¾¾åˆ°äº†ç“¶é¢ˆã€‚</p><h5 id="ç®¡é“æœ¬è´¨"><a href="#ç®¡é“æœ¬è´¨" class="headerlink" title="ç®¡é“æœ¬è´¨"></a>ç®¡é“æœ¬è´¨</h5><p>ä¸‹é¢å°±ä»‹ç»ä¸€ä¸‹ä¸€ä¸ªè¯·æ±‚çš„äº¤äº’æµç¨‹ï¼š</p><ol><li>å®¢æˆ·ç«¯è¿›è¡Œè°ƒç”¨ write å°†æ¶ˆæ¯å†™åˆ° æ“ä½œç³»ç»Ÿå†…æ ¸ ä¸ºå¥—æ¥å­—åˆ†é…çš„ å‘é€ç¼“å†² sendbuffer</li><li>å®¢æˆ·ç«¯æ“ä½œç³»ç»Ÿå†…æ ¸å°† å‘é€ç¼“å†²çš„å†…å®¹ å‘é€åˆ°ç½‘å¡ï¼Œç½‘å¡ç¡¬ä»¶å°†æ•°æ®é€šè¿‡ ç½‘é™…è·¯ç”± é€åˆ°æœåŠ¡å™¨ç½‘å¡ã€‚</li><li>æœåŠ¡å™¨æ“ä½œç³»ç»Ÿå†…æ ¸å°† ç½‘å¡çš„æ•°æ® æ”¾åˆ°å†…æ ¸ä¸ºå¥—æ¥å­—åˆ†é…çš„æ¥å—ç¼“å†² recv bufferã€‚</li><li>æœåŠ¡å™¨è¿›ç¨‹è°ƒç”¨ read ä»æ¥å—ç¼“å†²åŒºä¸­ å–å‡ºæ¶ˆæ¯è¿›è¡Œå¤„ç†ã€‚</li><li>æœåŠ¡å™¨è¿›ç¨‹è°ƒç”¨ write å°†å“åº”æ¶ˆæ¯å†™åˆ° å†…æ ¸ä¸ºå¥—æ¥å­—åˆ†é…çš„å‘é€ç¼“å†² send bufferã€‚</li><li>æœåŠ¡å™¨æ“ä½œç³»ç»Ÿå†…æ ¸ å°†å‘é€ç¼“å†²çš„å†…å®¹ å‘é€åˆ°ç½‘å¡ï¼Œç½‘å¡ç¡¬ä»¶å°†æ•°æ®é€šè¿‡ ç½‘é™…è·¯ç”± å‘é€åˆ°å®¢æˆ·ç«¯çš„ç½‘å¡ã€‚</li><li>å®¢æˆ·ç«¯æ“ä½œç³»ç»Ÿå†…æ ¸ å°†ç½‘å¡çš„æ•°æ® æ”¾åˆ°å†…æ ¸ä¸ºå¥—æ¥å­—åˆ†é…çš„ æ¥å—ç¼“å†² recv buffer</li><li>å®¢æˆ·ç«¯è¿›ç¨‹è°ƒç”¨ read ä»æ¥æ”¶ç¼“å†²åŒºä¸­ å–å‡ºæ¶ˆæ¯ è¿”å›ç»™ä¸Šå±‚ä¸šåŠ¡é€»è¾‘ è¿›è¡Œå¤„ç†ã€‚</li></ol><p>æˆ‘ä»¬ä¸€å¼€å§‹å¯èƒ½ä»¥ä¸º write æ“ä½œè¦ç­‰åˆ°å¯¹æ–¹æ”¶åˆ°æ¶ˆæ¯æ‰è¿”å›ï¼Œä½†å®é™…ä¸Šä¸æ˜¯è¿™æ ·çš„ã€‚write æ“ä½œåªè´Ÿè´£ å°†æ•°æ®å†™åˆ°æœ¬åœ°æ“ä½œç³»ç»Ÿå†…æ ¸çš„ å‘é€ç¼“å†²åŒºç„¶åå°±è¿”å›äº†ã€‚å‰©ä¸‹çš„äº‹ äº¤ç»™æ“ä½œç³»ç»Ÿå†…æ ¸å¼‚æ­¥ å°†æ•°æ®é€åˆ°ç›®æ ‡æœºå™¨ã€‚ä½†æ˜¯å¦‚æœå‘é€ç¼“å†²åŒºæ»¡äº†ï¼Œé‚£ä¹ˆå°±éœ€è¦ç­‰å¾… ç¼“å†²åŒº ç©ºå‡ºï¼Œè¿™ä¸ªå°±æ˜¯ å†™æ“ä½œ IO æ“ä½œçš„çœŸæ­£è€—æ—¶ã€‚</p><p>åŒç†ï¼Œread æ“ä½œå¹¶ä¸æ˜¯ä»ç›®æ ‡æœºå™¨æ‹‰å–æ•°æ®ã€‚read æ“ä½œåªè´Ÿè´£å°† æ•°æ®ä»æœ¬åœ°æ“ä½œç³»ç»Ÿå†…æ ¸çš„ æ¥æ”¶ç¼“å†²åŒº å–å‡ºæ¥å°±äº†äº‹ã€‚ä½†æ˜¯å¦‚æœ ç¼“å†²åŒºæ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆå°±éœ€è¦ç­‰å¾…æ•°æ®åˆ°æ¥ï¼Œè¿™ä¸ªå°±æ˜¯ è¯»æ“ä½œ IO æ“ä½œçš„çœŸæ­£è€—æ—¶ã€‚</p><p>æ‰€ä»¥å¯¹äº å®¢æˆ·ç«¯çš„ redis.get(key) è¿™æ ·çš„å‘½ä»¤æ¥è¯´ï¼Œwrite æ“ä½œå‡ ä¹æ²¡æœ‰è€—æ—¶ï¼Œç›´æ¥å†™åˆ° å‘é€ç¼“å†²åŒºå°±è¿”å›ï¼Œè€Œ read æ“ä½œæ¯”è¾ƒè€—æ—¶äº†ï¼Œå› ä¸ºå®ƒè¦ç­‰å¾…æ¶ˆæ¯ç»è¿‡ç½‘ç»œè·¯ç”±åˆ°ç›®æ ‡æœºå™¨å¤„ç†åçš„å“åº”æ¶ˆæ¯ï¼Œå†å‘é€åˆ°å½“å‰å†…æ ¸è¯»ç¼“å†² æ‰å¯ä»¥è¿”å›ã€‚è¿™æ‰æ˜¯ä¸€ä¸ªç½‘ç»œæ¥å›çš„çœŸæ­£å¼€é”€ã€‚</p><p>è€Œå¯¹äºç®¡é“æ¥è¯´ï¼Œè¿ç»­çš„ write æ“ä½œæ ¹æœ¬å°±æ²¡æœ‰è€—æ—¶ï¼Œä¹‹åç¬¬ä¸€ä¸ª read æ“ä½œä¼šç­‰å¾… ä¸€ä¸ªç½‘ç»œçš„æ¥å›å¼€é”€ï¼Œç„¶åå“åº”ä¿¡æ¯åˆ°è¾¾ å®¢æˆ·ç«¯ç³»ç»Ÿå†…æ ¸çš„è¯»ç¼“å†²äº†ã€‚å› ä¸º write æ˜¯è¿ç»­å‘é€ï¼Œä¸”å‡ ä¹æ²¡æœ‰è€—æ—¶ï¼Œæ‰€ä»¥å½“ ç¬¬ä¸€ä¸ªreadä¹‹åï¼Œåç»­æ‰€æœ‰readåŸºæœ¬ä¹ŸåŒæ—¶éšä¹‹åˆ°è¾¾ è¯»ç¼“å†²ã€‚</p><h3 id="5-5-äº‹åŠ¡"><a href="#5-5-äº‹åŠ¡" class="headerlink" title="5.5 äº‹åŠ¡"></a>5.5 äº‹åŠ¡</h3><p>Redis é€šè¿‡ MULTIã€DISCARD ã€EXEC å’Œ WATCH å››ä¸ªå‘½ä»¤æ¥å®ç°äº‹åŠ¡åŠŸèƒ½ã€‚äº‹åŠ¡æä¾›äº†ä¸€ç§ â€œå°†å¤šä¸ªå‘½ä»¤æ‰“åŒ…ï¼Œç„¶åä¸€æ¬¡æ€§ã€æŒ‰é¡ºåºåœ°æ‰§è¡Œâ€çš„æœºåˆ¶ï¼Œå¹¶ä¸”äº‹åŠ¡åœ¨æ‰§è¡Œçš„æœŸé—´ä¸ä¼šä¸»åŠ¨ä¸­æ–­â€”â€”æœåŠ¡å™¨åœ¨æ‰§è¡Œå®Œäº‹åŠ¡ä¸­çš„æ‰€æœ‰å‘½ä»¤ä¹‹åï¼Œæ‰ä¼šç»§ç»­å¤„ç†å…¶ä»–å®¢æˆ·ç«¯çš„å‘½ä»¤ã€‚</p><p>ä¾‹å­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; MULTI</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379(TX)&gt; set name &quot;kxr&quot;</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; get name</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; sadd name-list &quot;kxr&quot; &quot;jyl&quot;</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; smembers name-list</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; exec</span><br><span class="line">1) OK</span><br><span class="line">2) &quot;kxr&quot;</span><br><span class="line">3) (integer) 2</span><br><span class="line">4) 1) &quot;jyl&quot;</span><br><span class="line">   2) &quot;kxr&quot;</span><br></pre></td></tr></table></figure><h4 id="5-5-1-äº‹åŠ¡æµç¨‹"><a href="#5-5-1-äº‹åŠ¡æµç¨‹" class="headerlink" title="5.5.1 äº‹åŠ¡æµç¨‹"></a>5.5.1 äº‹åŠ¡æµç¨‹</h4><p>ä¸€ä¸ªäº‹åŠ¡ä»å¼€å§‹åˆ°æ‰§è¡Œä¼šç»å†ä¸‰ä¸ªé˜¶æ®µï¼š</p><ol><li>å¼€å§‹äº‹åŠ¡</li><li>å‘½ä»¤å…¥é˜Ÿ</li><li>æ‰§è¡Œäº‹åŠ¡</li></ol><h5 id="å¼€å§‹äº‹åŠ¡"><a href="#å¼€å§‹äº‹åŠ¡" class="headerlink" title="å¼€å§‹äº‹åŠ¡"></a>å¼€å§‹äº‹åŠ¡</h5><p>MULTI å‘½ä»¤çš„æ‰§è¡Œ æ ‡è®°ç€äº‹åŠ¡çš„å¼€å§‹ã€‚è¿™ä¸ªå‘½ä»¤å”¯ä¸€åšçš„å°±æ˜¯ï¼Œå°†å®¢æˆ·ç«¯çš„ REDIS_MULTI é€‰é¡¹æ‰“å¼€ï¼Œè®©å®¢æˆ·ç«¯ä»éäº‹åŠ¡çŠ¶æ€åˆ‡æ¢åˆ°äº‹åŠ¡çŠ¶æ€ã€‚</p><h5 id="å‘½ä»¤å…¥é˜Ÿ"><a href="#å‘½ä»¤å…¥é˜Ÿ" class="headerlink" title="å‘½ä»¤å…¥é˜Ÿ"></a>å‘½ä»¤å…¥é˜Ÿ</h5><p>å½“å®¢æˆ·ç«¯å¤„äºéäº‹åŠ¡çŠ¶æ€ä¸‹æ—¶ï¼Œæ‰€æœ‰å‘é€ç»™æœåŠ¡ç«¯çš„å‘½ä»¤éƒ½ä¼šç«‹å³è¢«æœåŠ¡å™¨æ‰§è¡Œã€‚ä½†æ˜¯ï¼Œå½“å®¢æˆ·ç«¯è¿›å…¥äº‹åŠ¡çŠ¶æ€ä¹‹åï¼ŒæœåŠ¡å™¨åœ¨æ”¶åˆ°æ¥è‡ªå®¢æˆ·ç«¯çš„å‘½ä»¤æ—¶ï¼Œä¸ä¼šç«‹å³æ‰§è¡Œå‘½ä»¤ï¼Œè€Œæ˜¯å°†è¿™äº›å‘½ä»¤å…¨éƒ¨æ”¾è¿›ä¸€ä¸ªäº‹åŠ¡é˜Ÿåˆ—é‡Œï¼Œç„¶åè¿”å› QUEUEDï¼Œè¡¨ç¤ºå‘½ä»¤å·²å…¥é˜Ÿã€‚</p><p>äº‹åŠ¡é˜Ÿåˆ—æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªæ•°ç»„é¡¹æ˜¯éƒ½åŒ…å«ä¸‰ä¸ªå±æ€§ï¼š</p><ol><li>è¦æ‰§è¡Œçš„å‘½ä»¤ï¼ˆcmdï¼‰</li><li>å‘½ä»¤çš„å‚æ•°ï¼ˆargvï¼‰</li><li>å‚æ•°çš„ä¸ªæ•°ï¼ˆargcï¼‰</li></ol><h5 id="æ‰§è¡Œäº‹åŠ¡"><a href="#æ‰§è¡Œäº‹åŠ¡" class="headerlink" title="æ‰§è¡Œäº‹åŠ¡"></a>æ‰§è¡Œäº‹åŠ¡</h5><p>å‰é¢è¯´åˆ°ï¼Œå½“å®¢æˆ·ç«¯è¿›å…¥äº‹åŠ¡çŠ¶æ€ä¹‹åï¼Œå®¢æˆ·å‘é€çš„å‘½ä»¤å°±ä¼šè¢«æ”¾è¿›äº‹åŠ¡é˜Ÿåˆ—é‡Œã€‚</p><p>ä½†å…¶å®å¹¶ä¸æ˜¯æ‰€æœ‰çš„å‘½ä»¤éƒ½ä¼šè¢«æ”¾è¿›äº‹åŠ¡é˜Ÿåˆ—ï¼Œå…¶ä¸­çš„ä¾‹å¤–å°±æ˜¯ EXECã€DISCARDã€MULTI å’Œ WATCH è¿™å››ä¸ªå‘½ä»¤ â€”â€” å½“è¿™å››ä¸ªå‘½ä»¤ä»å®¢æˆ·ç«¯å‘é€åˆ°æœåŠ¡å™¨æ—¶ï¼Œå®ƒä»¬ä¼šåƒå®¢æˆ·ç«¯å¤„äºéäº‹åŠ¡çŠ¶æ€ä¸€æ ·ï¼Œç›´æ¥è¢«æœåŠ¡å™¨æ‰§è¡Œã€‚</p><p>å¦‚æœå®¢æˆ·ç«¯æ­£å¤„äºäº‹åŠ¡çŠ¶æ€ï¼Œé‚£ä¹ˆå½“ EXEC å‘½ä»¤æ‰§è¡Œæ—¶ï¼ŒæœåŠ¡å™¨æ ¹æ®å®¢æˆ·ç«¯æ‰€ä¿å­˜çš„äº‹åŠ¡é˜Ÿåˆ—ï¼Œä»¥å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„æ–¹å¼æ‰§è¡Œäº‹åŠ¡é˜Ÿåˆ—ä¸­çš„å‘½ä»¤ï¼š æœ€å…ˆå…¥é˜Ÿçš„å‘½ä»¤æœ€å…ˆæ‰§è¡Œï¼Œè€Œæœ€åå…¥é˜Ÿçš„å‘½ä»¤æœ€åæ‰§è¡Œã€‚</p><p>å½“äº‹åŠ¡é˜Ÿåˆ—é‡Œçš„ æ‰€æœ‰å‘½ä»¤è¢«æ‰§è¡Œå®Œä¹‹åï¼ŒEXEC å‘½ä»¤ä¼šå°†å›å¤é˜Ÿåˆ—ä½œä¸ºè‡ªå·±çš„æ‰§è¡Œç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯ä»äº‹åŠ¡çŠ¶æ€è¿”å›åˆ°éäº‹åŠ¡çŠ¶æ€ï¼Œè‡³æ­¤ï¼Œäº‹åŠ¡æ‰§è¡Œå®Œæ¯•ã€‚</p><p>äº‹åŠ¡çš„æ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹çš„ä¼ªä»£ç è¡¨ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">def <span class="title function_">execute_transaction</span><span class="params">()</span>:</span><br><span class="line"></span><br><span class="line">    # åˆ›å»ºç©ºç™½çš„å›å¤é˜Ÿåˆ—</span><br><span class="line">    reply_queue = []</span><br><span class="line"></span><br><span class="line">    # å–å‡ºäº‹åŠ¡é˜Ÿåˆ—é‡Œçš„æ‰€æœ‰å‘½ä»¤ã€å‚æ•°å’Œå‚æ•°æ•°é‡</span><br><span class="line">    <span class="keyword">for</span> cmd, argv, argc in client.transaction_queue:</span><br><span class="line"></span><br><span class="line">        # æ‰§è¡Œå‘½ä»¤ï¼Œå¹¶å–å¾—å‘½ä»¤çš„è¿”å›å€¼</span><br><span class="line">        reply = execute_redis_command(cmd, argv, argc)</span><br><span class="line"></span><br><span class="line">    # å°†è¿”å›å€¼è¿½åŠ åˆ°å›å¤é˜Ÿåˆ—æœ«å°¾</span><br><span class="line">    reply_queue.append(reply)</span><br><span class="line"></span><br><span class="line">    # æ¸…é™¤å®¢æˆ·ç«¯çš„äº‹åŠ¡çŠ¶æ€</span><br><span class="line">    clear_transaction_state(client)</span><br><span class="line"></span><br><span class="line">    # æ¸…ç©ºäº‹åŠ¡é˜Ÿåˆ—</span><br><span class="line">    clear_transaction_queue(client)</span><br><span class="line"></span><br><span class="line">    # å°†äº‹åŠ¡çš„æ‰§è¡Œç»“æœè¿”å›ç»™å®¢æˆ·ç«¯</span><br><span class="line">    send_reply_to_client(client, reply_queue)</span><br></pre></td></tr></table></figure><p>ä¼˜åŒ–ï¼šä¸Šé¢çš„ Redis äº‹åŠ¡åœ¨å‘é€æ¯ä¸ªæŒ‡ä»¤åˆ°äº‹åŠ¡ç¼“å­˜é˜Ÿåˆ—æ—¶éƒ½è¦ç»è¿‡ä¸€æ¬¡ç½‘ç»œè¯»å†™ï¼Œå½“ä¸€ä¸ªäº‹åŠ¡å†…éƒ¨çš„æŒ‡ä»¤è¾ƒå¤šæ—¶ï¼Œéœ€è¦çš„ç½‘ç»œ IO æ—¶é—´ä¹Ÿä¼šçº¿æ€§å¢é•¿ã€‚æ‰€ä»¥é€šå¸¸ Redis å®¢æˆ·ç«¯åœ¨æ‰§è¡Œäº‹åŠ¡æ—¶éƒ½ä¼šç»“åˆ pipline ä¸€èµ·ä½¿ç”¨ï¼Œè¿™æ ·å¯ä»¥å°†å¤šæ¬¡ IO æ“ä½œå‹ç¼©ä¸ºå•æ¬¡ IO æ“ä½œã€‚</p><h4 id="5-5-2-äº‹åŠ¡é‡Œçš„å‘½ä»¤"><a href="#5-5-2-äº‹åŠ¡é‡Œçš„å‘½ä»¤" class="headerlink" title="5.5.2 äº‹åŠ¡é‡Œçš„å‘½ä»¤"></a>5.5.2 äº‹åŠ¡é‡Œçš„å‘½ä»¤</h4><p>æ— è®ºæ˜¯åœ¨äº‹åŠ¡çŠ¶æ€ä¸‹ï¼Œè¿˜æ˜¯éäº‹åŠ¡çŠ¶æ€ä¸‹ï¼ŒRedis å‘½ä»¤éƒ½æ˜¯ç”±åŒä¸€ä¸ªå‡½æ•°æ‰§è¡Œï¼Œæ‰€æœ‰å®ƒä»¬å…±äº«å¾ˆå¤šæœåŠ¡å™¨çš„ä¸€èˆ¬è®¾ç½®ï¼Œæ¯”å¦‚ AOF é…ç½®ã€RDB çš„é…ç½®ï¼Œä»¥åŠå†…å­˜é™åˆ¶ç­‰ç­‰ã€‚</p><p>äº‹åŠ¡ä¸­çš„å‘½ä»¤æ‰§è¡Œå’Œæ™®é€šå‘½ä»¤æ‰§è¡Œä¸»è¦æ˜¯ä¸¤å¤©åŒºåˆ«ï¼š</p><ol><li>éäº‹åŠ¡çŠ¶æ€ä¸‹çš„å‘½ä»¤ä»¥å•ä¸ªå‘½ä»¤æ‰§è¡Œä¸ºå•ä½ï¼Œå‰ä¸€ä¸ªå‘½ä»¤å’Œåä¸€ä¸ªå‘½ä»¤ä¸ä¸€å®šæ˜¯åŒä¸€ä¸ªå®¢æˆ·ç«¯ã€‚è€Œäº‹åŠ¡çŠ¶æ€åˆ™æ˜¯ä»¥ä¸€ä¸ªäº‹åŠ¡ä¸ºå•ä½ï¼Œæ‰§è¡Œäº‹åŠ¡é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å‘½ä»¤ï¼šé™¤éå½“å‰äº‹åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œå¦åˆ™æœåŠ¡å™¨ä¸ä¼šä¸­æ–­äº‹åŠ¡ï¼Œä¹Ÿä¸ä¼šæ‰§è¡Œå…¶ä»–å®¢æˆ·ç«¯çš„å‘½ä»¤ã€‚</li><li>åœ¨éäº‹åŠ¡çŠ¶æ€ä¸‹ï¼Œæ‰§è¡Œå‘½ä»¤æ‰€å¾—çš„ç»“æœä¼šç«‹å³è¢«è¿”å›ç»™å®¢æˆ·ç«¯ã€‚è€Œäº‹åŠ¡åˆ™å°†æ‰€æœ‰å‘½ä»¤æ‰€å¾—è¿”å›ç»“æœé›†åˆåˆ°å›å¤é˜Ÿåˆ—ï¼Œå†ä½œä¸º EXEC å‘½ä»¤çš„ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚</li></ol><h4 id="5-5-3-DISCARD-ã€-MULTI-å’Œ-WATCH-å‘½ä»¤"><a href="#5-5-3-DISCARD-ã€-MULTI-å’Œ-WATCH-å‘½ä»¤" class="headerlink" title="5.5.3 DISCARD ã€ MULTI å’Œ WATCH å‘½ä»¤"></a>5.5.3 DISCARD ã€ MULTI å’Œ WATCH å‘½ä»¤</h4><p>é™¤äº† EXEC ä¹‹å¤–ï¼ŒæœåŠ¡å™¨åœ¨å®¢æˆ·ç«¯å¤„äºäº‹åŠ¡çŠ¶æ€ä¸‹ï¼Œä¸åŠ å…¥åˆ°äº‹åŠ¡é˜Ÿåˆ—è€Œæ‰§è¡Œçš„å¦å¤–ä¸‰ä¸ªå‘½ä»¤æ˜¯ï¼šDISCARD ã€ MULTI å’Œ WATCH</p><ul><li>DISCARDï¼šå‘½ä»¤ç”¨äºå–æ¶ˆä¸€ä¸ªäº‹åŠ¡ï¼Œ å®ƒæ¸…ç©ºå®¢æˆ·ç«¯çš„æ•´ä¸ªäº‹åŠ¡é˜Ÿåˆ—ï¼Œ ç„¶åå°†å®¢æˆ·ç«¯ä»äº‹åŠ¡çŠ¶æ€è°ƒæ•´å›éäº‹åŠ¡çŠ¶æ€ï¼Œ æœ€åè¿”å›å­—ç¬¦ä¸² OK ç»™å®¢æˆ·ç«¯ï¼Œ è¯´æ˜äº‹åŠ¡å·²è¢«å–æ¶ˆã€‚</li><li>MULTIï¼šRedis çš„äº‹åŠ¡æ˜¯ä¸å¯åµŒå¥—çš„ï¼Œ å½“å®¢æˆ·ç«¯å·²ç»å¤„äºäº‹åŠ¡çŠ¶æ€ï¼Œ è€Œå®¢æˆ·ç«¯åˆå†å‘æœåŠ¡å™¨å‘é€ <a href="http://redis.readthedocs.org/en/latest/transaction/multi.html#multi">MULTI</a> æ—¶ï¼Œ æœåŠ¡å™¨åªæ˜¯ç®€å•åœ°å‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªé”™è¯¯ï¼Œ ç„¶åç»§ç»­ç­‰å¾…å…¶ä»–å‘½ä»¤çš„å…¥é˜Ÿã€‚ <a href="http://redis.readthedocs.org/en/latest/transaction/multi.html#multi">MULTI</a> å‘½ä»¤çš„å‘é€ä¸ä¼šé€ æˆæ•´ä¸ªäº‹åŠ¡å¤±è´¥ï¼Œ ä¹Ÿä¸ä¼šä¿®æ”¹äº‹åŠ¡é˜Ÿåˆ—ä¸­å·²æœ‰çš„æ•°æ®ã€‚</li><li>WATCHï¼šåªèƒ½åœ¨å®¢æˆ·ç«¯è¿›å…¥äº‹åŠ¡çŠ¶æ€ä¹‹å‰æ‰§è¡Œï¼Œ åœ¨äº‹åŠ¡çŠ¶æ€ä¸‹å‘é€ WATCH å‘½ä»¤ä¼šå¼•å‘ä¸€ä¸ªé”™è¯¯ï¼Œ ä½†å®ƒä¸ä¼šé€ æˆæ•´ä¸ªäº‹åŠ¡å¤±è´¥ï¼Œ ä¹Ÿä¸ä¼šä¿®æ”¹äº‹åŠ¡é˜Ÿåˆ—ä¸­å·²æœ‰çš„æ•°æ®ï¼ˆå’Œå‰é¢å¤„ç† MULTI çš„æƒ…å†µä¸€æ ·ï¼‰</li></ul><h4 id="5-5-4-å¸¦-WATCH-çš„äº‹åŠ¡"><a href="#5-5-4-å¸¦-WATCH-çš„äº‹åŠ¡" class="headerlink" title="5.5.4 å¸¦ WATCH çš„äº‹åŠ¡"></a>5.5.4 å¸¦ WATCH çš„äº‹åŠ¡</h4><p>WATCH å‘½ä»¤ç”¨äºåœ¨äº‹åŠ¡å¼€å§‹ä¹‹å‰ç›‘è§†ä»»æ„æ•°é‡çš„é”®ï¼š å½“è°ƒç”¨ EXEC å‘½ä»¤æ‰§è¡Œäº‹åŠ¡æ—¶ï¼Œ å¦‚æœä»»æ„ä¸€ä¸ªè¢«ç›‘è§†çš„é”®å·²ç»è¢«å…¶ä»–å®¢æˆ·ç«¯ä¿®æ”¹äº†ï¼Œ é‚£ä¹ˆæ•´ä¸ªäº‹åŠ¡ä¸å†æ‰§è¡Œï¼Œ ç›´æ¥è¿”å›å¤±è´¥ã€‚</p><p>ä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºäº†ä¸€ä¸ªæ‰§è¡Œå¤±è´¥çš„äº‹åŠ¡ä¾‹å­ï¼š</p><p>ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯æ‰§è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; watch name</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379(TX)&gt; set name t</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; exec</span><br><span class="line">(nil)</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒä¸ªå®¢æˆ·ç«¯æ‰§è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set name tt</span><br><span class="line">OK</span><br></pre></td></tr></table></figure><p>åœ¨ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯watch name ä¹‹åï¼Œäº‹åŠ¡æ‰§è¡Œä¹‹å‰ï¼Œåœ¨ç¬¬äºŒä¸ªå®¢æˆ·ç«¯ä¸­ ä¿®æ”¹ name çš„å€¼ã€‚è¿™æ ·å½“ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯çš„æ‰§è¡Œäº‹åŠ¡æ—¶ï¼ŒRedis ä¼šå‘ç° name æ•´ä¸ªè¢«ç›‘è§†çš„é”® å·²ç»è¢«ä¿®æ”¹ï¼Œå› æ­¤å®¢æˆ·ç«¯Açš„äº‹åŠ¡ä¸ä¼šè¢«æ‰§è¡Œï¼Œè€Œæ˜¯ç›´æ¥è¿”å›å¤±è´¥ã€‚</p><h5 id="WATCH-å‘½ä»¤çš„å®ç°"><a href="#WATCH-å‘½ä»¤çš„å®ç°" class="headerlink" title="WATCH å‘½ä»¤çš„å®ç°"></a>WATCH å‘½ä»¤çš„å®ç°</h5><p>åœ¨æ¯ä¸ªä»£è¡¨æ•°æ®çš„ redis.h&#x2F;redisDb ç»“æ„ç±»å‹ä¸­ï¼Œéƒ½ä¿å­˜äº†ä¸€ä¸ª watched_keys å­—å…¸ï¼Œå­—å…¸çš„é”®è¿™ä¸ªæ•°æ®åº“è¢«ç›‘è§†çš„é”®ï¼Œè€Œå­—å…¸çš„å€¼åˆ™æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œé“¾è¡¨ä¸­ä¿å­˜äº†æ‰€æœ‰ç›‘è§†è¿™ä¸ªé”®çš„å®¢æˆ·ç«¯ã€‚</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779123785-9effddfb-dddd-4212-917f-061e49039521.svg" alt="img"></p><p>å…¶ä¸­ï¼Œé”® key1 æ­£åœ¨è¢« client2ã€client5 å’Œ client1 ä¸‰ä¸ªå®¢æˆ·ç«¯ç›‘è§†ï¼Œå…¶ä»–ä¸€äº›é”®ä¹Ÿåˆ†åˆ«è¢«å…¶ä»–å®¢æˆ·ç«¯ç›‘è§†ç€ã€‚</p><p>WATCH å‘½ä»¤çš„ä½œç”¨ï¼Œå°±æ˜¯å°† å½“å‰å®¢æˆ·ç«¯å’Œè¦ç›‘è§†çš„é”®åœ¨ watched_keys ä¸­è¿›è¡Œå…³è”ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œ å¦‚æœå½“å‰å®¢æˆ·ç«¯ä¸º client10086 ï¼Œ é‚£ä¹ˆå½“å®¢æˆ·ç«¯æ‰§è¡Œ WATCH key1 key2 æ—¶ï¼Œ å‰é¢å±•ç¤ºçš„ watched_keys å°†è¢«ä¿®æ”¹æˆè¿™ä¸ªæ ·å­ï¼š</p><p><img src="https://cdn.nlark.com/yuque/0/2023/svg/35838370/1682779124149-f5a1f0b8-25ae-428c-8927-910b8c86e485.svg" alt="img"></p><p>é€šè¿‡ watched_keys å­—å…¸ï¼Œ å¦‚æœç¨‹åºæƒ³æ£€æŸ¥æŸä¸ªé”®æ˜¯å¦è¢«ç›‘è§†ï¼Œ é‚£ä¹ˆå®ƒåªè¦æ£€æŸ¥å­—å…¸ä¸­æ˜¯å¦å­˜åœ¨è¿™ä¸ªé”®å³å¯ï¼› å¦‚æœç¨‹åºè¦è·å–ç›‘è§†æŸä¸ªé”®çš„æ‰€æœ‰å®¢æˆ·ç«¯ï¼Œ é‚£ä¹ˆåªè¦å–å‡ºé”®çš„å€¼ï¼ˆä¸€ä¸ªé“¾è¡¨ï¼‰ï¼Œ ç„¶åå¯¹é“¾è¡¨è¿›è¡Œéå†å³å¯ã€‚</p><h5 id="WATCH-çš„è§¦å‘"><a href="#WATCH-çš„è§¦å‘" class="headerlink" title="WATCH çš„è§¦å‘"></a>WATCH çš„è§¦å‘</h5><p>åœ¨ä»»ä½•å¯¹æ•°æ®åº“é”®ç©ºé—´ï¼ˆkey spaceï¼‰è¿›è¡Œä¿®æ”¹çš„å‘½ä»¤æˆåŠŸæ‰§è¡Œä¹‹å ï¼ˆæ¯”å¦‚ FLUSHDB ã€SETã€DELã€LPUSHã€SADD ï¼Œè¯¸å¦‚æ­¤ç±»ï¼‰ï¼Œ multi.c&#x2F;touchWatchedKey å‡½æ•°éƒ½ä¼šè¢«è°ƒç”¨ â€”â€” å®ƒæ£€æŸ¥æ•°æ®åº“çš„ watched_keys å­—å…¸ï¼Œ çœ‹æ˜¯å¦æœ‰å®¢æˆ·ç«¯åœ¨ç›‘è§†å·²ç»è¢«å‘½ä»¤ä¿®æ”¹çš„é”®ï¼Œ å¦‚æœæœ‰çš„è¯ï¼Œ ç¨‹åºå°†æ‰€æœ‰ç›‘è§†è¿™ä¸ª&#x2F;è¿™äº›è¢«ä¿®æ”¹é”®çš„å®¢æˆ·ç«¯çš„ REDIS_DIRTY_CAS é€‰é¡¹æ‰“å¼€ï¼š</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779123291-8a135c71-3565-4c56-9dfe-533d255158e9.svg" alt="img"></p><p>å½“å®¢æˆ·ç«¯å‘é€ <a href="http://redis.readthedocs.org/en/latest/transaction/exec.html#exec">EXEC</a> å‘½ä»¤ã€è§¦å‘äº‹åŠ¡æ‰§è¡Œæ—¶ï¼Œ æœåŠ¡å™¨ä¼šå¯¹å®¢æˆ·ç«¯çš„çŠ¶æ€è¿›è¡Œæ£€æŸ¥ï¼š</p><ul><li>å¦‚æœå®¢æˆ·ç«¯çš„ REDIS_DIRTY_CAS é€‰é¡¹å·²ç»è¢«æ‰“å¼€ï¼Œé‚£ä¹ˆè¯´æ˜è¢«å®¢æˆ·ç«¯ç›‘è§†çš„é”®è‡³å°‘æœ‰ä¸€ä¸ªå·²ç»è¢«ä¿®æ”¹äº†ï¼Œäº‹åŠ¡çš„å®‰å…¨æ€§å·²ç»è¢«ç ´åã€‚æœåŠ¡å™¨ä¼šæ”¾å¼ƒæ‰§è¡Œè¿™ä¸ªäº‹åŠ¡ï¼Œç›´æ¥å‘å®¢æˆ·ç«¯è¿”å›ç©ºå›å¤ï¼Œè¡¨ç¤ºäº‹åŠ¡æ‰§è¡Œå¤±è´¥ã€‚</li><li>å¦‚æœ REDIS_DIRTY_CAS é€‰é¡¹æ²¡æœ‰è¢«æ‰“å¼€ï¼Œé‚£ä¹ˆè¯´æ˜æ‰€æœ‰ç›‘è§†é”®éƒ½å®‰å…¨ï¼ŒæœåŠ¡å™¨æ­£å¼æ‰§è¡Œäº‹åŠ¡ã€‚</li></ul><p>ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æ•°æ®åº“çš„ watched_keys å­—å…¸å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://cdn.nlark.com/yuque/0/2023/svg/35838370/1682779124835-ac785dae-6d6d-4247-bd7f-8209ea924ea4.svg" alt="img"></p><p>å¦‚æœæŸä¸ªå®¢æˆ·ç«¯å¯¹ key1 è¿›è¡Œäº†ä¿®æ”¹ï¼ˆæ¯”å¦‚æ‰§è¡Œ DEL key1 ï¼‰ï¼Œ é‚£ä¹ˆæ‰€æœ‰ç›‘è§† key1 çš„å®¢æˆ·ç«¯ï¼Œ åŒ…æ‹¬ client2 ã€ client5 å’Œ client1 çš„ REDIS_DIRTY_CAS é€‰é¡¹éƒ½ä¼šè¢«æ‰“å¼€ï¼Œ å½“å®¢æˆ·ç«¯ client2 ã€ client5 å’Œ client1 æ‰§è¡Œ <a href="http://redis.readthedocs.org/en/latest/transaction/exec.html#exec">EXEC</a> çš„æ—¶å€™ï¼Œ å®ƒä»¬çš„äº‹åŠ¡éƒ½ä¼šä»¥å¤±è´¥å‘Šç»ˆã€‚</p><p>æœ€åï¼Œå½“ä¸€ä¸ªå®¢æˆ·ç«¯ç»“æŸå®ƒçš„äº‹åŠ¡æ—¶ï¼Œæ— è®ºäº‹åŠ¡æ˜¯æˆåŠŸæ‰§è¡Œï¼Œè¿˜æ˜¯å¤±è´¥ï¼Œ watched_keys å­—å…¸ä¸­å’Œè¿™ä¸ªå®¢æˆ·ç«¯ç›¸å…³çš„èµ„æ–™éƒ½ä¼šè¢«æ¸…é™¤ã€‚</p><h4 id="5-5-6-äº‹åŠ¡çš„-ACID-æ€§è´¨"><a href="#5-5-6-äº‹åŠ¡çš„-ACID-æ€§è´¨" class="headerlink" title="5.5.6 äº‹åŠ¡çš„ ACID æ€§è´¨"></a>5.5.6 äº‹åŠ¡çš„ ACID æ€§è´¨</h4><p>ä¼ ç»Ÿæ•°æ®åº“ï¼Œå¸¸å¸¸ç”¨ ACID æ€§è´¨æ¥æ£€éªŒ äº‹åŠ¡æ˜¯å¦å®‰å…¨ã€‚Redis äº‹åŠ¡ä¿è¯äº† ä¸€è‡´æ€§ï¼ˆCï¼‰ã€éš”ç¦»æ€§ï¼ˆIï¼‰ï¼Œä½†å¹¶ä¸èƒ½ä¿è¯ åŸå­æ€§ï¼ˆAï¼‰å’Œ æŒä¹…æ€§ï¼ˆDï¼‰ã€‚</p><h5 id="åŸå­æ€§ï¼ˆAtomicityï¼‰"><a href="#åŸå­æ€§ï¼ˆAtomicityï¼‰" class="headerlink" title="åŸå­æ€§ï¼ˆAtomicityï¼‰"></a>åŸå­æ€§ï¼ˆAtomicityï¼‰</h5><p>å•ä¸ª Redis å‘½ä»¤æ‰§è¡Œè‚¯å®šæ˜¯ åŸå­æ€§çš„ï¼Œä½† Redis æ²¡æœ‰åœ¨äº‹åŠ¡ä¸Šå¢åŠ ä»»ä½•ç»´æŒåŸå­æ€§çš„æœºåˆ¶ï¼Œæ‰€æœ‰ Redis äº‹åŠ¡çš„æ‰§è¡Œå¹¶ä¸æ˜¯åŸå­æ€§çš„ã€‚</p><p>å¦‚æœä¸€ä¸ªäº‹åŠ¡é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å‘½ä»¤éƒ½è¢«æˆåŠŸåœ°æ‰§è¡Œï¼Œé‚£ä¹ˆç§°è¿™ä¸ªäº‹åŠ¡æ‰§è¡ŒæˆåŠŸã€‚å¦ä¸€æ–¹é¢ï¼Œå¦‚æœ Redis æœåŠ¡å™¨è¿›ç¨‹åœ¨æ‰§è¡Œäº‹åŠ¡çš„è¿‡ç¨‹ä¸­è¢«åœæ­¢ â€”â€” æ¯”å¦‚æ¥åˆ° KILL ä¿¡å·ã€å®¿ä¸»æœºå™¨åœæœºï¼Œç­‰ç­‰ï¼Œé‚£ä¹ˆäº‹åŠ¡æ‰§è¡Œå¤±è´¥ã€‚å½“äº‹åŠ¡å¤±è´¥æ—¶ï¼ŒRedis ä¹Ÿä¸ä¼šè¿›è¡Œä»»ä½•çš„é‡è¯•æˆ–è€…å›æ»šåŠ¨ä½œã€‚</p><p>ç®€å•æ€»ç»“ï¼š</p><ul><li>å‘½ä»¤å…¥é˜Ÿæ—¶å°±æŠ¥é”™ï¼Œä¼šæ”¾å¼ƒäº‹åŠ¡æ‰§è¡Œï¼Œä¿è¯åŸå­æ€§ã€‚</li><li>å‘½ä»¤å…¥é˜Ÿæ—¶æ²¡æŠ¥é”™ï¼Œå®é™…æ‰§è¡Œæ—¶æŠ¥é”™ï¼Œä¸ä¿è¯åŸå­æ€§ã€‚</li><li>EXEC å‘½ä»¤æ‰§è¡Œæ—¶å®ä¾‹æ•…éšœï¼Œå¦‚æœå¼€å¯ AOF æ—¥å¿—ï¼Œå¯ä»¥ä¿è¯åŸå­æ€§ã€‚</li></ul><p>å…¶ä¿è¯çš„æ˜¯éƒ¨åˆ†åŸå­æ€§ï¼Œ<strong>å¯ä»¥ä¿è¯å¤šä¸ªå‘½ä»¤è¦ä¹ˆå°±ä¸€èµ·æ‰§è¡Œï¼Œè¦ä¹ˆå°±ä¸€èµ·ä¸æ‰§è¡Œ</strong>ã€‚ä½†æ˜¯<strong>ä¸èƒ½ä¿è¯ å¤šä¸ªå‘½ä»¤è¦ä¹ˆä¸€èµ·æ‰§è¡ŒæˆåŠŸï¼Œè¦ä¹ˆéƒ½ä¸æ‰§è¡ŒæˆåŠŸ</strong>ã€‚å…¥é˜Ÿåï¼Œå¦‚æœæœ‰å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œå…¶ä¹‹å‰å‘½ä»¤æ‰§è¡Œæ“ä½œå¹¶ä¸ä¼šå›é€€ï¼Œå…¶ä¹‹åå‘½ä»¤ä¹Ÿç…§å¸¸æ‰§è¡Œã€‚</p><h5 id="ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰"><a href="#ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰" class="headerlink" title="ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰"></a>ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰</h5><p>ä¸€è‡´æ€§è¡¨ç¤ºï¼šäº‹åŠ¡æ‰§è¡Œç»“æŸåï¼Œæ•°æ®åº“çš„å®Œæ•´æ€§çº¦æŸæ²¡æœ‰è¢«ç ´åï¼Œäº‹åŠ¡æ‰§è¡Œçš„å‰åé¡ºåºéƒ½æ˜¯åˆæ³•æ•°æ®çŠ¶æ€ã€‚</p><ul><li>å®ä½“å®Œæ•´æ€§(å¦‚è¡Œçš„ä¸»é”®å­˜åœ¨ä¸”å”¯ä¸€);</li><li>åˆ—å®Œæ•´æ€§(å¦‚å­—æ®µçš„ç±»å‹ã€å¤§å°ã€é•¿åº¦è¦ç¬¦åˆè¦æ±‚)</li><li>å¤–é”®çº¦æŸ;</li><li>ç”¨æˆ·è‡ªå®šä¹‰å®Œæ•´æ€§(å¦‚è½¬è´¦å‰åï¼Œä¸¤ä¸ªè´¦æˆ·ä½™é¢çš„å’Œåº”è¯¥ä¸å˜)ã€‚</li></ul><p>Redis çš„ä¸€è‡´æ€§é—®é¢˜ å¯ä»¥åˆ†ä¸ºä¸‰éƒ¨åˆ†æ¥è®¨è®ºï¼šå…¥é˜Ÿé”™è¯¯ã€æ‰§è¡Œé”™è¯¯ã€Redis è¿›ç¨‹è¢«ç»ˆç»“ã€‚</p><ol><li>å…¥é˜Ÿé”™è¯¯ï¼šåœ¨å‘½ä»¤å…¥é˜Ÿçš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€äº†é”™è¯¯çš„å‘½ä»¤ï¼Œæ¯”å¦‚å‘½ä»¤çš„å‚æ•°æ•°é‡ä¸å¯¹ï¼Œç­‰ç­‰ï¼Œ é‚£ä¹ˆæœåŠ¡å™¨å°†å‘å®¢æˆ·ç«¯è¿”å›ä¸€ä¸ªå‡ºé”™ä¿¡æ¯ï¼Œ å¹¶ä¸”å°†å®¢æˆ·ç«¯çš„äº‹åŠ¡çŠ¶æ€è®¾ä¸º REDIS_DIRTY_EXEC ã€‚å½“å®¢æˆ·ç«¯æ‰§è¡Œ EXEC å‘½ä»¤æ—¶ï¼Œ Redis ä¼šæ‹’ç»æ‰§è¡ŒçŠ¶æ€ä¸º REDIS_DIRTY_EXEC çš„äº‹åŠ¡ï¼Œ å¹¶è¿”å›å¤±è´¥ä¿¡æ¯ã€‚å› æ­¤ï¼Œå¸¦æœ‰ä¸æ­£ç¡®å…¥é˜Ÿå‘½ä»¤çš„äº‹åŠ¡ä¸ä¼šè¢«æ‰§è¡Œï¼Œä¹Ÿä¸ä¼šå½±å“æ•°æ®åº“çš„ä¸€è‡´æ€§ã€‚</li><li>æ‰§è¡Œé”™è¯¯ï¼šå¦‚æœå‘½ä»¤åœ¨äº‹åŠ¡æ‰§è¡Œçš„è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œæ¯”å¦‚è¯´ï¼Œå¯¹ä¸€ä¸ªä¸åŒç±»å‹çš„ key æ‰§è¡Œäº†é”™è¯¯çš„æ“ä½œï¼Œ é‚£ä¹ˆ Redis åªä¼šå°†é”™è¯¯åŒ…å«åœ¨äº‹åŠ¡çš„ç»“æœä¸­ï¼Œ è¿™ä¸ä¼šå¼•èµ·äº‹åŠ¡ä¸­æ–­æˆ–æ•´ä¸ªå¤±è´¥ï¼Œä¸ä¼šå½±å“å·²æ‰§è¡Œäº‹åŠ¡å‘½ä»¤çš„ç»“æœï¼Œä¹Ÿä¸ä¼šå½±å“åé¢è¦æ‰§è¡Œçš„äº‹åŠ¡å‘½ä»¤ï¼Œ æ‰€ä»¥å®ƒå¯¹äº‹åŠ¡çš„ä¸€è‡´æ€§ä¹Ÿæ²¡æœ‰å½±å“ã€‚</li><li>Redis è¿›ç¨‹è¢«ç»ˆç»“å¦‚æœ Redis æœåŠ¡å™¨è¿›ç¨‹åœ¨æ‰§è¡Œäº‹åŠ¡çš„è¿‡ç¨‹ä¸­è¢«å…¶ä»–è¿›ç¨‹ç»ˆç»“ï¼Œæˆ–è€…è¢«ç®¡ç†å‘˜å¼ºåˆ¶æ€æ­»ï¼Œé‚£ä¹ˆæ ¹æ® Redis æ‰€ä½¿ç”¨çš„æŒä¹…åŒ–æ¨¡å—ï¼Œå¯èƒ½ç”±ä»¥ä¸‹æƒ…å†µå‡ºç°ï¼š</li></ol><ul><li><ul><li>å†…å­˜æ¨¡å—ï¼šå¦‚æœ Redis æ²¡æœ‰é‡‡å–ä»»ä½•æŒä¹…åŒ–æœºåˆ¶ï¼Œé‚£ä¹ˆé‡å¯åçš„æ•°æ®åº“æ€»æ˜¯ç©ºç™½çš„ï¼Œæ‰€ä»¥æ•°æ®æ€»æ˜¯ä¸€è‡´çš„ã€‚</li><li>RDB æ¨¡å—ï¼šåœ¨æ‰§è¡Œäº‹åŠ¡æ—¶ï¼ŒRedis ä¸ä¼šä¸­æ–­äº‹åŠ¡å»æ‰§è¡Œä¿å­˜ RDB çš„å·¥ä½œï¼Œåªæœ‰åœ¨äº‹åŠ¡æ‰§è¡Œä¹‹åï¼Œä¿å­˜ RDB çš„å·¥ä½œæ‰å¯èƒ½å¼€å§‹ã€‚æ‰€ä»¥å½“RDB æ¨¡å¼ä¸‹çš„ Redis æœåŠ¡å™¨è¿›ç¨‹åœ¨äº‹åŠ¡ä¸­é€”è¢«æ€æ­»æ—¶ï¼Œäº‹åŠ¡å†…æ‰§è¡Œçš„å‘½ä»¤ï¼Œä¸ç®¡æˆåŠŸäº†å¤šå°‘ï¼Œéƒ½ä¸ä¼šè¢«ä¿å­˜åˆ° RDB æ–‡ä»¶é‡Œã€‚æ¢å¤æ•°æ®åº“éœ€è¦ä½¿ç”¨ç°æœ‰çš„ RDB æ–‡ä»¶ï¼Œè€Œè¿™ä¸ª RDB æ–‡ä»¶çš„æ•°æ®ä¿å­˜çš„æ˜¯æœ€è¿‘ä¸€æ¬¡çš„æ•°æ®åº“å¿«ç…§ï¼ˆsnapshotï¼‰ï¼Œæ‰€ä»¥å®ƒçš„æ•°æ®å¯èƒ½ä¸æ˜¯æœ€æ–°çš„ï¼Œä½†åªè¦ RDB æ–‡ä»¶æœ¬èº«æ²¡æœ‰å› ä¸ºå…¶ä»–é—®é¢˜è€Œå‡ºé”™ï¼Œé‚£ä¹ˆè¿˜åŸåçš„æ•°æ®åº“å°±æ˜¯ä¸€è‡´çš„ã€‚</li><li>AOF æ¨¡å¼ï¼šå› ä¸ºä¿å­˜ AOF æ–‡ä»¶çš„å·¥ä½œåœ¨åå°çº¿ç¨‹è¿›è¡Œï¼Œæ‰€ä»¥å³ä½¿æ˜¯åœ¨äº‹åŠ¡æ‰§è¡Œçš„ä¸­é€”ï¼Œä¿å­˜ AOF æ–‡ä»¶çš„å·¥ä½œä¹Ÿå¯ä»¥ç»§ç»­è¿›è¡Œï¼Œå› æ­¤ï¼Œæ ¹æ®äº‹åŠ¡è¯­å¥æ˜¯å¦è¢«å†™å…¥å¹¶ä¿å­˜åˆ° AOF æ–‡ä»¶ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç§æƒ…å†µå‘é€ï¼š</li></ul></li><li><ul><li><ul><li>å¦‚æœäº‹åŠ¡è¯­å¥ æœªå†™å…¥åˆ° AOF æ–‡ä»¶ï¼Œæˆ– AOF æœªè¢« SYNC è°ƒç”¨ä¿å­˜åˆ°ç£ç›˜ï¼Œé‚£ä¹ˆå½“è¿›ç¨‹è¢«æ€æ­»ä¹‹åï¼ŒRedis å¯ä»¥æ ¹æ® æœ€è¿‘ä¸€æ¬¡æˆåŠŸä¿å­˜åˆ° ç£ç›˜çš„ AOF æ–‡ä»¶ æ¥è¿˜åŸæ•°æ®åº“ï¼Œåªè¦ AOF æ–‡ä»¶æœ¬èº«æ²¡æœ‰å› ä¸ºå…¶ä»–é—®é¢˜è€Œå‡ºé”™ï¼Œé‚£ä¹ˆè¿˜åŸåçš„æ•°æ®åº“æ€»æ˜¯ä¸€è‡´çš„ï¼Œä½†å…¶ä¸­çš„æ•°æ®ä¸ä¸€å®šæ˜¯æœ€æ–°çš„ã€‚</li><li>å¦‚æœäº‹åŠ¡çš„éƒ¨åˆ†è¯­å¥ è¢«å†™å…¥åˆ° AOF æ–‡ä»¶ä¸­ï¼Œå¹¶ä¸” AOF æ–‡ä»¶è¢«æˆåŠŸä¿å­˜ï¼Œé‚£ä¹ˆä¸å®Œæ•´çš„äº‹åŠ¡æ‰§è¡Œä¿¡æ¯å°±ä¼šé—ç•™åœ¨ AOF æ–‡ä»¶é‡Œï¼Œå½“é‡å¯ Redis æ—¶ï¼Œç¨‹åºä¼šæ£€æµ‹åˆ° AOF æ–‡ä»¶å¹¶ä¸å®Œæ•´ï¼ŒRedis ä¼šé€€å‡ºï¼Œå¹¶æŠ¥å‘Šé”™è¯¯ã€‚éœ€è¦ä½¿ç”¨ redis-check-aof å·¥å…·å°†éƒ¨åˆ†æˆåŠŸçš„äº‹åŠ¡å‘½ä»¤ç§»é™¤ä¹‹åï¼Œæ‰èƒ½å†æ¬¡å¯åŠ¨æœåŠ¡å™¨ã€‚è¿˜åŸä¹‹åçš„æ•°æ®æ€»æ˜¯ä¸€è‡´çš„ï¼Œè€Œä¸”æ•°æ®ä¹Ÿæ˜¯æœ€æ–°çš„ï¼ˆç›´åˆ°äº‹åŠ¡æ‰§è¡Œä¹‹å‰ä¸ºæ­¢ï¼‰ã€‚</li></ul></li></ul></li></ul><h5 id="éš”ç¦»æ€§ï¼ˆIsolationï¼‰"><a href="#éš”ç¦»æ€§ï¼ˆIsolationï¼‰" class="headerlink" title="éš”ç¦»æ€§ï¼ˆIsolationï¼‰"></a>éš”ç¦»æ€§ï¼ˆIsolationï¼‰</h5><p>Redis æ˜¯å•è¿›ç¨‹ç¨‹åºï¼Œå¹¶ä¸”å®ƒä¿è¯åœ¨æ‰§è¡Œäº‹åŠ¡æ—¶ï¼Œä¸ä¼šå¯¹äº‹åŠ¡è¿›è¡Œä¸­æ–­ï¼Œäº‹åŠ¡å¯ä»¥è¿è¡Œç›´åˆ°æ‰§è¡Œå®Œæ‰€æœ‰äº‹åŠ¡é˜Ÿåˆ—ä¸­çš„å‘½ä»¤ä¸ºæ­¢ã€‚å› æ­¤ï¼ŒRedis çš„äº‹åŠ¡æ˜¯æ€»æ˜¯å¸¦æœ‰éš”ç¦»æ€§çš„ã€‚</p><h5 id="æŒä¹…æ€§ï¼ˆDurabilityï¼‰"><a href="#æŒä¹…æ€§ï¼ˆDurabilityï¼‰" class="headerlink" title="æŒä¹…æ€§ï¼ˆDurabilityï¼‰"></a>æŒä¹…æ€§ï¼ˆDurabilityï¼‰</h5><p>å› ä¸ºäº‹åŠ¡ä¸è¿‡æ˜¯ç”¨é˜Ÿåˆ—åŒ…è£¹äº†ä¸€ç»„ Redis å‘½ä»¤ï¼Œå¹¶æ²¡æœ‰æä¾›ä»»ä½•é¢å¤–çš„æŒä¹…æ€§åŠŸèƒ½ï¼Œæ‰€ä»¥äº‹åŠ¡çš„æŒä¹…æ€§ç”± Redis æ‰€ä½¿ç”¨çš„æŒä¹…åŒ–æ¨¡å—å†³å®š</p><ul><li>å•çº¯çš„å†…å­˜æ¨¡å¼ä¸‹ï¼Œäº‹åŠ¡è‚¯å®šæ˜¯ä¸æŒä¹…çš„ã€‚</li><li>åœ¨ RDB æ¨¡å—ä¸‹ï¼ŒæœåŠ¡å™¨å¯èƒ½åœ¨äº‹åŠ¡æ‰§è¡Œä¹‹åã€RDB æ–‡ä»¶æ›´æ–°ä¹‹å‰çš„è¿™æ®µæ—¶é—´å¤±è´¥ï¼Œæ‰€ä»¥ RDB æ¨¡å¼ä¸‹çš„ Redis äº‹åŠ¡ä¹Ÿä¸æŒä¹…çš„ã€‚</li><li>åœ¨ AOF çš„ â€œæ€»æ˜¯SYNCâ€ æ¨¡å¼ä¸‹ï¼Œäº‹åŠ¡çš„æ¯æ¡å‘½ä»¤åœ¨æ‰§è¡ŒæˆåŠŸä¹‹åï¼Œéƒ½ä¼šç«‹å³è°ƒç”¨ fsync æˆ– fdatasync å°†äº‹åŠ¡æ•°æ®å†™å…¥åˆ° AOFæ–‡ä»¶ã€‚ä½†æ˜¯ï¼Œè¿™ç§ä¿å­˜æ˜¯ç”±åå°çº¿ç¨‹è¿›è¡Œçš„ï¼Œä¸»çº¿ç¨‹ä¸ä¼šå µå¡ç›´åˆ°ä¿å­˜æˆåŠŸã€‚æ‰€ä»¥å‘½ä»¤æ‰§è¡ŒæˆåŠŸåˆ°æ•°æ®ä¿å­˜åˆ°ç¡¬ç›˜ä¹‹é—´ï¼Œè¿˜æ˜¯æœ‰ä¸€æ®µéå¸¸å°çš„é—´éš”ï¼Œæ‰€ä»¥è¿™ç§æ¨¡å¼ä¸‹çš„äº‹åŠ¡ä¹Ÿæ˜¯ä¸æŒä¹…çš„ã€‚</li></ul><p>å…¶ä»– AOF æ¨¡å¼ä¹Ÿå’Œ â€œæ€»æ˜¯SYNCâ€ æ¨¡å¼ç±»ä¼¼ï¼Œæ‰€ä»¥å®ƒä»¬éƒ½æ˜¯ä¸æŒä¹…çš„ã€‚</p><h4 id="5-5-7-å°ç»“"><a href="#5-5-7-å°ç»“" class="headerlink" title="5.5.7 å°ç»“"></a>5.5.7 å°ç»“</h4><ul><li>äº‹åŠ¡æä¾›äº†ä¸€ç§å°†å¤šä¸ªå‘½ä»¤æ‰“åŒ…ï¼Œç„¶åä¸€æ¬¡æ€§ã€æœ‰åºåœ°æ‰§è¡Œçš„æœºåˆ¶ã€‚</li><li>äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸ä¼šè¢«ä¸­æ–­ï¼Œæ‰€æœ‰äº‹åŠ¡å‘½ä»¤æ‰§è¡Œå®Œä¹‹åï¼Œäº‹åŠ¡æ‰èƒ½ç»“æŸã€‚</li><li>å¤šä¸ªå‘½ä»¤ä¼šè¢«å…¥é˜Ÿåˆ°äº‹åŠ¡é˜Ÿåˆ—ä¸­ï¼Œç„¶åæŒ‰å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„é¡ºåºæ‰§è¡Œã€‚</li><li>å¸¦ WATCH å‘½ä»¤çš„äº‹åŠ¡ä¼šå°†å®¢æˆ·ç«¯å’Œè¢«ç›‘è§†çš„é”®åœ¨æ•°æ®åº“çš„ watched_keys å­—å…¸ä¸­è¿›è¡Œå…³è”ï¼Œå½“é”®è¢«ä¿®æ”¹æ—¶ï¼Œç¨‹åºä¼šå°†æ‰€æœ‰ç›‘è§†è¢«ä¿®æ”¹é”®çš„å®¢æˆ·ç«¯çš„ REDIS_DIRTY_CAS é€‰é¡¹æ‰“å¼€ã€‚</li><li>åªæœ‰åœ¨å®¢æˆ·ç«¯çš„ REDIS_DIRTY_CAS é€‰é¡¹æœªè¢«æ‰“å¼€æ—¶ï¼Œæ‰èƒ½æ‰§è¡Œäº‹åŠ¡ï¼Œå¦åˆ™äº‹åŠ¡ç›´æ¥è¿”å›å¤±è´¥ã€‚</li><li>Redis çš„äº‹åŠ¡ä¿è¯äº† ACID ä¸­çš„ä¸€è‡´æ€§ï¼ˆCï¼‰å’Œéš”ç¦»æ€§ï¼ˆIï¼‰ï¼Œä½†å¹¶ä¸ä¿è¯åŸå­æ€§ï¼ˆAï¼‰å’ŒæŒä¹…æ€§ï¼ˆDï¼‰ã€‚</li></ul><h3 id="5-6-è®¢é˜…ä¸å‘å¸ƒ"><a href="#5-6-è®¢é˜…ä¸å‘å¸ƒ" class="headerlink" title="5.6 è®¢é˜…ä¸å‘å¸ƒ"></a>5.6 è®¢é˜…ä¸å‘å¸ƒ</h3><p>Redis é€šè¿‡ PUBLISHã€SUBSCRIBEç­‰å‘½ä»¤å®ç°äº†è®¢é˜…ä¸å‘å¸ƒæ¨¡å¼ï¼Œ è¿™ä¸ªåŠŸèƒ½æä¾›ä¸¤ç§ä¿¡æ¯æœºåˆ¶ï¼Œ åˆ†åˆ«æ˜¯è®¢é˜…&#x2F;å‘å¸ƒåˆ°é¢‘é“å’Œè®¢é˜…&#x2F;å‘å¸ƒåˆ°æ¨¡å¼ï¼Œ ä¸‹æ–‡å…ˆè®¨è®ºè®¢é˜…&#x2F;å‘å¸ƒåˆ°é¢‘é“çš„å®ç°ï¼Œ å†è®¨è®ºè®¢é˜…&#x2F;å‘å¸ƒåˆ°æ¨¡å¼çš„å®ç°ã€‚</p><h4 id="5-6-1-é¢‘é“çš„è®¢é˜…ä¸ä¿¡æ¯å‘é€"><a href="#5-6-1-é¢‘é“çš„è®¢é˜…ä¸ä¿¡æ¯å‘é€" class="headerlink" title="5.6.1 é¢‘é“çš„è®¢é˜…ä¸ä¿¡æ¯å‘é€"></a>5.6.1 é¢‘é“çš„è®¢é˜…ä¸ä¿¡æ¯å‘é€</h4><p>Redis çš„ SUBSCRIBE å‘½ä»¤å¯ä»¥è®©å®¢æˆ·ç«¯è®¢é˜…ä»»æ„æ•°é‡çš„é¢‘é“ï¼Œæ¯å½“æœ‰æ–°æ¶ˆæ¯å‘é€åˆ°è¢«è®¢é˜…çš„é¢‘é“æ—¶ï¼Œä¿¡æ¯å°±ä¼šè¢«å‘é€ç»™æ‰€æœ‰è®¢é˜…æŒ‡å®šé¢‘é“çš„å®¢æˆ·ç«¯ã€‚</p><p><img src="https://cdn.nlark.com/yuque/0/2023/svg/35838370/1682779124262-ac7f1f60-b21b-44a8-810f-6f10ac13eab1.svg" alt="img"></p><p>å½“æœ‰æ–°æ¶ˆæ¯é€šè¿‡ <a href="http://redis.readthedocs.org/en/latest/pub_sub/publish.html#publish">PUBLISH</a> å‘½ä»¤å‘é€ç»™é¢‘é“ channel1 æ—¶ï¼Œ è¿™ä¸ªæ¶ˆæ¯å°±ä¼šè¢«å‘é€ç»™è®¢é˜…å®ƒçš„ä¸‰ä¸ªå®¢æˆ·ç«¯ï¼š</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779126625-3d2dbe1a-b372-47b6-9a25-e937747ce3fa.svg" alt="img"></p><h5 id="è®¢é˜…é¢‘é“"><a href="#è®¢é˜…é¢‘é“" class="headerlink" title="è®¢é˜…é¢‘é“"></a>è®¢é˜…é¢‘é“</h5><p>æ¯ä¸ª Redis æœåŠ¡å™¨è¿›ç¨‹éƒ½ç»´æŒç€ä¸€ä¸ªè¡¨ç¤ºæœåŠ¡å™¨çŠ¶æ€çš„ redis.h&#x2F;redisServer ç»“æ„ï¼Œç»“æ„çš„ pubsub_channels å±æ€§æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œè¿™ä¸ªå­—å…¸å°±ç”¨äºä¿å­˜è®¢é˜…é¢‘é“çš„ä¿¡æ¯ã€‚</p><p>å…¶ä¸­ï¼Œå­—å…¸çš„é”®ä¸ºæ­£åœ¨è¢«è®¢é˜…çš„é¢‘é“ï¼Œè€Œå­—å…¸çš„å€¼åˆ™æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œé“¾è¡¨ä¸­ä¿å­˜äº†æ‰€æœ‰è®¢é˜…è¿™ä¸ªé¢‘é“çš„å®¢æˆ·ç«¯ã€‚</p><p>æ¯”å¦‚è¯´ï¼Œåœ¨ä¸‹å›¾å±•ç¤ºçš„è¿™ä¸ª pubsub_channels ç¤ºä¾‹ä¸­ï¼Œ client2 ã€ client5 å’Œ client1 å°±è®¢é˜…äº† channel1 ï¼Œ è€Œå…¶ä»–é¢‘é“ä¹Ÿåˆ†åˆ«è¢«åˆ«çš„å®¢æˆ·ç«¯æ‰€è®¢é˜…ï¼š</p><p><img src="https://cdn.nlark.com/yuque/0/2023/svg/35838370/1682779126861-01cd5b87-621a-4c11-8997-fd32e7124cde.svg" alt="img"></p><p>å½“å®¢æˆ·ç«¯è°ƒç”¨ <a href="http://redis.readthedocs.org/en/latest/pub_sub/subscribe.html#subscribe">SUBSCRIBE</a> å‘½ä»¤æ—¶ï¼Œ ç¨‹åºå°±å°†å®¢æˆ·ç«¯å’Œè¦è®¢é˜…çš„é¢‘é“åœ¨ pubsub_channels å­—å…¸ä¸­å…³è”èµ·æ¥ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœå®¢æˆ·ç«¯ client10086 æ‰§è¡Œå‘½ä»¤ SUBSCRIBE channel1 channel2 channel3 ï¼Œé‚£ä¹ˆå‰é¢å±•ç¤ºçš„ pubsub_channels å°†å˜æˆä¸‹é¢è¿™ä¸ªæ ·å­ï¼š</p><p><img src="https://cdn.nlark.com/yuque/0/2023/svg/35838370/1682779127981-4b8e7194-f9c9-4e88-b812-b9f8594061e9.svg" alt="img"></p><p>é€šè¿‡ pubsub_channels å­—å…¸ï¼Œ ç¨‹åºåªè¦æ£€æŸ¥æŸä¸ªé¢‘é“æ˜¯å¦ä¸ºå­—å…¸çš„é”®ï¼Œ å°±å¯ä»¥çŸ¥é“è¯¥é¢‘é“æ˜¯å¦æ­£åœ¨è¢«å®¢æˆ·ç«¯è®¢é˜…ï¼› åªè¦å–å‡ºæŸä¸ªé”®çš„å€¼ï¼Œ å°±å¯ä»¥å¾—åˆ°æ‰€æœ‰è®¢é˜…è¯¥é¢‘é“çš„å®¢æˆ·ç«¯çš„ä¿¡æ¯ã€‚</p><h5 id="å‘é€ä¿¡æ¯åˆ°é¢‘é“"><a href="#å‘é€ä¿¡æ¯åˆ°é¢‘é“" class="headerlink" title="å‘é€ä¿¡æ¯åˆ°é¢‘é“"></a>å‘é€ä¿¡æ¯åˆ°é¢‘é“</h5><p>äº†è§£äº† pubsub_channels å­—å…¸çš„ç»“æ„ä¹‹åï¼Œ è§£é‡Š <a href="http://redis.readthedocs.org/en/latest/pub_sub/publish.html#publish">PUBLISH</a> å‘½ä»¤çš„å®ç°å°±éå¸¸ç®€å•äº†ï¼š å½“è°ƒç”¨ PUBLISH channel message å‘½ä»¤ï¼Œ ç¨‹åºé¦–å…ˆæ ¹æ® channel å®šä½åˆ°å­—å…¸çš„é”®ï¼Œ ç„¶åå°†ä¿¡æ¯å‘é€ç»™å­—å…¸å€¼é“¾è¡¨ä¸­çš„æ‰€æœ‰å®¢æˆ·ç«¯ã€‚</p><p>æ¯”å¦‚è¯´ï¼Œå¯¹äºä»¥ä¸‹è¿™ä¸ª pubsub_channels å®ä¾‹ï¼Œ å¦‚æœæŸä¸ªå®¢æˆ·ç«¯æ‰§è¡Œå‘½ä»¤ PUBLISH channel1 â€œhello motoâ€ ï¼Œé‚£ä¹ˆ client2 ã€ client5 å’Œ client1 ä¸‰ä¸ªå®¢æˆ·ç«¯éƒ½å°†æ¥æ”¶åˆ° â€œhello motoâ€ ä¿¡æ¯ï¼š</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779127370-c53aa587-36b5-4a1e-8777-e74917f5ece7.svg" alt="img"></p><h5 id="é€€è®¢é¢‘é“"><a href="#é€€è®¢é¢‘é“" class="headerlink" title="é€€è®¢é¢‘é“"></a>é€€è®¢é¢‘é“</h5><p>ä½¿ç”¨ UNSUBSCRIBE å‘½ä»¤å¯ä»¥é€€è®¢æŒ‡å®šçš„é¢‘é“ï¼Œ è¿™ä¸ªå‘½ä»¤æ‰§è¡Œçš„æ˜¯è®¢é˜…çš„åæ“ä½œï¼š å®ƒä» pubsub_channels å­—å…¸çš„ç»™å®šé¢‘é“ï¼ˆé”®ï¼‰ä¸­ï¼Œ åˆ é™¤å…³äºå½“å‰å®¢æˆ·ç«¯çš„ä¿¡æ¯ï¼Œ è¿™æ ·è¢«é€€è®¢é¢‘é“çš„ä¿¡æ¯å°±ä¸ä¼šå†å‘é€ç»™è¿™ä¸ªå®¢æˆ·ç«¯ã€‚</p><h4 id="5-6-2-æ¨¡å¼çš„è®¢é˜…ä¸ä¿¡æ¯å‘é€"><a href="#5-6-2-æ¨¡å¼çš„è®¢é˜…ä¸ä¿¡æ¯å‘é€" class="headerlink" title="5.6.2 æ¨¡å¼çš„è®¢é˜…ä¸ä¿¡æ¯å‘é€"></a>5.6.2 æ¨¡å¼çš„è®¢é˜…ä¸ä¿¡æ¯å‘é€</h4><p>å½“ä½¿ç”¨ PUBLISH å‘½ä»¤å‘é€ä¿¡æ¯åˆ°æŸä¸ªé¢‘é“æ—¶ï¼Œä¸ä»…æ‰€æœ‰è®¢é˜…è¯¥é¢‘é“çš„å®¢æˆ·ç«¯ä¼šæ”¶åˆ°ä¿¡æ¯ï¼Œå¦‚æœæœ‰ æŸä¸ª&#x2F;æŸäº› æ¨¡å¼å’Œ è¿™ä¸ªé¢‘é“åŒ¹é…çš„è¯ï¼Œé‚£ä¹ˆæ‰€æœ‰è®¢é˜… è¿™ä¸ª&#x2F;è¿™äº› é¢‘é“çš„å®¢æˆ·ç«¯ä¹ŸåŒæ ·ä¼šå—åˆ°ä¿¡æ¯ã€‚</p><p>ä¸‹å›¾å±•ç¤ºäº†ä¸€ä¸ªå¸¦æœ‰é¢‘é“å’Œæ¨¡å¼çš„ä¾‹å­ï¼Œ å…¶ä¸­ tweet.shop.* æ¨¡å¼åŒ¹é…äº† tweet.shop.kindle é¢‘é“å’Œ tweet.shop.ipad é¢‘é“ï¼Œ å¹¶ä¸”æœ‰ä¸åŒçš„å®¢æˆ·ç«¯åˆ†åˆ«è®¢é˜…å®ƒä»¬ä¸‰ä¸ªï¼š</p><p><img src="https://cdn.nlark.com/yuque/0/2023/svg/35838370/1682779128616-e784de68-42e6-4095-bcf0-60e9c43986ec.svg" alt="img"></p><p>å½“æœ‰ä¿¡æ¯å‘é€åˆ° tweet.shop.kindle é¢‘é“æ—¶ï¼Œ ä¿¡æ¯é™¤äº†å‘é€ç»™ clientX å’Œ clientY ä¹‹å¤–ï¼Œ è¿˜ä¼šå‘é€ç»™è®¢é˜… tweet.shop.* æ¨¡å¼çš„ client123 å’Œ client256 ï¼š</p><p><img src="https://cdn.nlark.com/yuque/0/2023/svg/35838370/1682779128540-cc69dd3a-5458-471e-aaeb-84a2e7a04712.svg" alt="img"></p><p>å¦ä¸€æ–¹é¢ï¼Œ å¦‚æœæ¥æ”¶åˆ°ä¿¡æ¯çš„æ˜¯é¢‘é“ tweet.shop.ipad ï¼Œ é‚£ä¹ˆ client123 å’Œ client256 åŒæ ·ä¼šæ”¶åˆ°ä¿¡æ¯ï¼š</p><p><img src="https://cdn.nlark.com/yuque/0/2023/svg/35838370/1682779131307-fa5396f0-9c11-438a-b6ed-492143caca5c.svg" alt="img"></p><h5 id="è®¢é˜…æ¨¡å¼"><a href="#è®¢é˜…æ¨¡å¼" class="headerlink" title="è®¢é˜…æ¨¡å¼"></a>è®¢é˜…æ¨¡å¼</h5><p>redisServer.pubsub_patterns å±æ€§æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œé“¾è¡¨ä¸­ä¿å­˜ç€æ‰€æœ‰å’Œæ¨¡å¼ç›¸å…³çš„ä¿¡æ¯ã€‚</p><p>é“¾è¡¨ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½åŒ…å«ä¸€ä¸ª redis.h&#x2F;pubsubPattern ç»“æ„ï¼š</p><p>client å±æ€§ä¿å­˜ç€è®¢é˜…æ¨¡å¼çš„å®¢æˆ·ç«¯ï¼Œè€Œ pattern å±æ€§åˆ™ä¿å­˜ç€è¢«è®¢é˜…çš„æ¨¡å¼ã€‚</p><p>æ¯å½“è°ƒç”¨ PSUBSCRIBE å‘½ä»¤è®¢é˜…ä¸€ä¸ªæ¨¡å¼æ—¶ï¼Œ ç¨‹åºå°±åˆ›å»ºä¸€ä¸ªåŒ…å«å®¢æˆ·ç«¯ä¿¡æ¯å’Œè¢«è®¢é˜…æ¨¡å¼çš„ pubsubPattern ç»“æ„ï¼Œ å¹¶å°†è¯¥ç»“æ„æ·»åŠ åˆ° redisServer.pubsub_patterns é“¾è¡¨ä¸­ã€‚</p><p>ä½œä¸ºä¾‹å­ï¼Œä¸‹å›¾å±•ç¤ºäº†ä¸€ä¸ªåŒ…å«ä¸¤ä¸ªæ¨¡å¼çš„ pubsub_patterns é“¾è¡¨ï¼Œ å…¶ä¸­ client123 å’Œ client256 éƒ½æ­£åœ¨è®¢é˜… tweet.shop.* æ¨¡å¼ï¼š</p><p><img src="https://cdn.nlark.com/yuque/0/2023/svg/35838370/1682779131253-176aab8f-481e-490a-8bdd-e31d5c0d0268.svg" alt="img"></p><p>å¦‚æœè¿™æ—¶å®¢æˆ·ç«¯ client10086 æ‰§è¡Œ PSUBSCRIBE broadcast.list.* ï¼Œ é‚£ä¹ˆ pubsub_patterns é“¾è¡¨å°†è¢«æ›´æ–°æˆè¿™æ ·ï¼š</p><p><img src="https://cdn.nlark.com/yuque/0/2023/svg/35838370/1682779133621-3a05dd6e-3664-4953-abb2-eca5a3de291e.svg" alt="img"></p><p>é€šè¿‡éå†æ•´ä¸ª pubsub_patterns é“¾è¡¨ï¼Œç¨‹åºå¯ä»¥æ£€æŸ¥æ‰€æœ‰æ­£åœ¨è¢«è®¢é˜…çš„æ¨¡å¼ï¼Œä»¥åŠè®¢é˜…è¿™äº›æ¨¡å¼çš„å®¢æˆ·ç«¯ã€‚</p><h5 id="å‘é€ä¿¡æ¯åˆ°æ¨¡å¼"><a href="#å‘é€ä¿¡æ¯åˆ°æ¨¡å¼" class="headerlink" title="å‘é€ä¿¡æ¯åˆ°æ¨¡å¼"></a>å‘é€ä¿¡æ¯åˆ°æ¨¡å¼</h5><p>å‘é€ä¿¡æ¯åˆ°æ¨¡å¼çš„å·¥ä½œä¹Ÿæ˜¯ç”± PUBLISH å‘½ä»¤è¿›è¡Œçš„ã€‚ PUBLISH é™¤äº†å°† message å‘é€åˆ°æ‰€æœ‰è®¢é˜… channel çš„å®¢æˆ·ç«¯ä¹‹å¤–ï¼Œå®ƒè¿˜ä¼šå°† channel å’Œ pubsub_pattern ä¸­çš„æ¨¡å¼è¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æœ channel å’ŒæŸä¸ªæ¨¡å¼åŒ¹é…çš„è¯ï¼Œé‚£ä¹ˆä¹Ÿå°† message å‘é€åˆ°è®¢é˜…é‚£ä¸ªæ¨¡å¼çš„å®¢æˆ·ç«¯ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœ Redis æœåŠ¡å™¨çš„ pubsub_patterns çŠ¶æ€å¦‚ä¸‹ï¼š</p><p><img src="https://cdn.nlark.com/yuque/0/2023/svg/35838370/1682779131145-01a1aea3-c788-4cfa-aae6-91390a521463.svg" alt="img"></p><p>é‚£ä¹ˆå½“æŸä¸ªå®¢æˆ·ç«¯å‘é€ä¿¡æ¯ â€œAmazon Kindle, $69.â€ åˆ° tweet.shop.kindle é¢‘é“æ—¶ï¼Œ é™¤äº†æ‰€æœ‰è®¢é˜…äº† tweet.shop.kindle é¢‘é“çš„å®¢æˆ·ç«¯ä¼šæ”¶åˆ°ä¿¡æ¯ä¹‹å¤–ï¼Œ å®¢æˆ·ç«¯ client123 å’Œ client256 ä¹ŸåŒæ ·ä¼šæ”¶åˆ°ä¿¡æ¯ï¼Œ å› ä¸ºè¿™ä¸¤ä¸ªå®¢æˆ·ç«¯è®¢é˜…çš„ tweet.shop.* æ¨¡å¼å’Œ tweet.shop.kindle é¢‘é“åŒ¹é…ã€‚</p><h5 id="é€€è®¢æ¨¡å¼"><a href="#é€€è®¢æ¨¡å¼" class="headerlink" title="é€€è®¢æ¨¡å¼"></a>é€€è®¢æ¨¡å¼</h5><p>ä½¿ç”¨ PUNSUBSCRIBE å‘½ä»¤å¯ä»¥é€€è®¢æŒ‡å®šçš„æ¨¡å¼ï¼Œ è¿™ä¸ªå‘½ä»¤æ‰§è¡Œçš„æ˜¯è®¢é˜…æ¨¡å¼çš„åæ“ä½œï¼š ç¨‹åºä¼šåˆ é™¤ redisServer.pubsub_patterns é“¾è¡¨ä¸­ï¼Œ æ‰€æœ‰å’Œè¢«é€€è®¢æ¨¡å¼ç›¸å…³è”çš„ pubsubPattern ç»“æ„ï¼Œ è¿™æ ·å®¢æˆ·ç«¯å°±ä¸ä¼šå†æ”¶åˆ°å’Œæ¨¡å¼ç›¸åŒ¹é…çš„é¢‘é“å‘æ¥çš„ä¿¡æ¯ã€‚</p><h4 id="5-6-3-å°ç»“"><a href="#5-6-3-å°ç»“" class="headerlink" title="5.6.3 å°ç»“"></a>5.6.3 å°ç»“</h4><p>è¦ç‚¹ï¼š</p><ul><li>è®¢é˜…ä¿¡æ¯ç”±æœåŠ¡å™¨è¿›ç¨‹ç»´æŒçš„ redisServer.pubsub_channels å­—å…¸ä¿å­˜ï¼Œå­—å…¸çš„é”®ä¸ºè¢«è®¢é˜…çš„é¢‘é“ï¼Œå­—å…¸çš„å€¼ä¸ºè®¢é˜…é¢‘é“çš„æ‰€æœ‰å®¢æˆ·ç«¯ã€‚</li><li>å½“æœ‰æ–°æ¶ˆæ¯å‘é€åˆ°é¢‘é“æ—¶ï¼Œç¨‹åºéå†é¢‘é“ï¼ˆé”®ï¼‰æ‰€å¯¹åº”çš„ï¼ˆå€¼ï¼‰æ‰€æœ‰å®¢æˆ·ç«¯ï¼Œç„¶åå°†æ¶ˆæ¯å‘é€åˆ°æ‰€æœ‰è®¢é˜…é¢‘é“çš„å®¢æˆ·ç«¯ä¸Šã€‚</li><li>è®¢é˜…æ¨¡å¼çš„ä¿¡æ¯ç”±æœåŠ¡å™¨è¿›ç¨‹ç»´æŒçš„ redisServer.pubsub_patterns é“¾è¡¨ä¿å­˜ï¼Œé“¾è¡¨çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¿å­˜ç€ä¸€ä¸ª pubsubPattern ç»“æ„ï¼Œç»“æ„ä¸­ä¿å­˜ç€è¢«è®¢é˜…çš„æ¨¡å¼ï¼Œä»¥åŠè®¢é˜…è¯¥æ¨¡å¼çš„å®¢æˆ·ç«¯ã€‚ç¨‹åºé€šè¿‡éå†é“¾è¡¨æ¥æŸ¥æ‰¾æŸä¸ªé¢‘é“æ˜¯å¦å’ŒæŸä¸ªæ¨¡å¼åŒ¹é…ã€‚</li><li>å½“æœ‰æ–°æ¶ˆæ¯å‘é€åˆ°é¢‘é“æ—¶ï¼Œé™¤äº†è®¢é˜…é¢‘é“çš„å®¢æˆ·ç«¯ä¼šæ”¶åˆ°æ¶ˆæ¯ä¹‹å¤–ï¼Œæ‰€æœ‰è®¢é˜…äº†åŒ¹é…é¢‘é“çš„æ¨¡å¼çš„å®¢æˆ·ç«¯ï¼Œä¹ŸåŒæ ·ä¼šæ”¶åˆ°æ¶ˆæ¯ã€‚</li><li>é€€è®¢é¢‘é“å’Œé€€è®¢æ¨¡å¼åˆ†åˆ«æ˜¯è®¢é˜…é¢‘é“å’Œè®¢é˜…æ¨¡å¼çš„åæ“ä½œã€‚</li></ul><p>ç¼ºç‚¹ï¼š</p><p>PubSub çš„ç”Ÿäº§è€…äº§åœ°è¿‡æ¥ä¸€ä¸ªæ¶ˆæ¯ï¼ŒRedis ä¼šç›´æ¥æ‰¾åˆ°ç›¸åº”çš„æ¶ˆè´¹è€…ä¼ é€’è¿‡å»ã€‚å¦‚æœä¸€ä¸ªæ¶ˆè´¹è€…ä¹Ÿæ²¡æœ‰ï¼Œé‚£ä¹ˆæ¶ˆæ¯ç›´æ¥ä¸¢å¼ƒã€‚å¦‚æœå¼€å§‹æœ‰ä¸‰ä¸ªæ¶ˆè´¹è€…ï¼Œä¸€ä¸ªæ¶ˆè´¹è€…çªç„¶æŒ‚æ‰äº†ï¼Œç”Ÿäº§è€…ä¼šç»§ç»­å‘é€æ¶ˆæ¯ï¼Œå¦å¤–ä¸¤ä¸ªæ¶ˆè´¹è€…å¯ä»¥æŒç»­å—åˆ°æ¶ˆæ¯ã€‚ä½†æ˜¯æŒ‚æ‰çš„æ¶ˆè´¹è€…é‡æ–°è¿ä¸Šçš„æ—¶å€™ï¼Œè¿™æ–­è¿æœŸé—´ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ï¼Œå¯¹äºè¿™ä¸ªæ¶ˆè´¹è€…æ¥è¯´å°±å½»åº•æ¶ˆå¤±äº†ã€‚</p><p>å¦‚æœ Redis åœæœºé‡å¯ï¼ŒPubSub çš„æ¶ˆæ¯æ˜¯ä¸ä¼šæŒä¹…åŒ–çš„ï¼Œæ¯•ç«Ÿ Redis å®•æœºå°±ç›¸å½“äºä¸€ä¸ªæ¶ˆè´¹è€…éƒ½æ²¡æœ‰ï¼Œæ‰€æœ‰çš„æ¶ˆæ¯ç›´æ¥ä¸¢å¼ƒã€‚</p><p>æ­£æ˜¯å› ä¸º PubSub æœ‰è¿™äº›ç¼ºç‚¹ï¼Œå®ƒå‡ ä¹æ‰¾ä¸åˆ°åˆé€‚çš„åº”ç”¨åœºæ™¯ã€‚æ‰€ä»¥ Redis çš„ä½œè€…å•ç‹¬å¼€å¯äº†ä¸€ä¸ªé¡¹ç›® Disque ä¸“é—¨åš å¤šæ’­æ¶ˆæ¯é˜Ÿåˆ—ã€‚</p><p>githubåœ°å€ï¼š<a href="https://github.com/antirez/disque-module%E3%80%82%E4%BD%86%E6%98%AF%E5%9C%A8">https://github.com/antirez/disque-moduleã€‚ä½†æ˜¯åœ¨</a> Redis5.0 æ–°å¢äº† Stream æ•°æ®ç»“æ„ï¼Œè¿™ä¸ªåŠŸèƒ½ç»™ Redis å¸¦æ¥äº†æŒä¹…åŒ–æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä»æ­¤ PubSub å¯ä»¥æ¶ˆå¤±äº†ï¼ŒDisqueue ä¼°è®¡ä¹Ÿä¸ä¼šå‘å‡ºå®ƒçš„æ­£å¼ç‰ˆäº†ã€‚</p><h3 id="5-7-Redisé›†ç¾¤æ¨¡å¼â€”ä¸»ä»å¤åˆ¶"><a href="#5-7-Redisé›†ç¾¤æ¨¡å¼â€”ä¸»ä»å¤åˆ¶" class="headerlink" title="5.7 Redisé›†ç¾¤æ¨¡å¼â€”ä¸»ä»å¤åˆ¶"></a>5.7 Redisé›†ç¾¤æ¨¡å¼â€”ä¸»ä»å¤åˆ¶</h3><p><a href="https://pdai.tech/md/db/nosql-redis/db-redis-x-copy.html">https://pdai.tech/md/db/nosql-redis/db-redis-x-copy.html</a></p><p>æˆ‘ä»¬çŸ¥é“è¦é¿å…å•ç‚¹æ•…éšœï¼Œå³ä¿è¯é«˜å¯ç”¨ï¼Œä¾¿éœ€è¦å†—ä½™ï¼ˆå‰¯æœ¬ï¼‰æ–¹å¼æä¾›é›†ç¾¤æœåŠ¡ã€‚è€Œ Redis æä¾›äº†ä¸»ä»åº“æ¨¡å¼ï¼Œä»¥ä¿è¯æ•°æ®å‰¯æœ¬çš„ä¸€è‡´ï¼Œä¸»ä»åº“ä¹‹é—´é‡‡ç”¨çš„æ˜¯è¯»å†™åˆ†ç¦» çš„æ–¹å¼ã€‚</p><h4 id="5-7-1-ä¸»ä»å¤åˆ¶æ¦‚è¿°"><a href="#5-7-1-ä¸»ä»å¤åˆ¶æ¦‚è¿°" class="headerlink" title="5.7.1 ä¸»ä»å¤åˆ¶æ¦‚è¿°"></a>5.7.1 ä¸»ä»å¤åˆ¶æ¦‚è¿°</h4><p>ä¸»ä»å¤åˆ¶ï¼Œæ˜¯æŒ‡å°†ä¸€å° Redis æœåŠ¡å™¨çš„æ•°æ®ï¼Œå¤åˆ¶åˆ°å…¶ä»–çš„ Redis æœåŠ¡å™¨ã€‚å‰è€…ç§°ä¸º ä¸»èŠ‚ç‚¹ï¼ˆmasterï¼‰ï¼Œåè€…ç§°ä¸º ä»èŠ‚ç‚¹ï¼ˆslaveï¼‰ã€‚æ•°æ®çš„å¤åˆ¶æ˜¯å•å‘çš„ï¼Œåªèƒ½ä» ä¸»èŠ‚ç‚¹ åˆ° ä»èŠ‚ç‚¹ã€‚</p><p><strong>ä¸»ä»å¤åˆ¶çš„ä½œç”¨</strong>ä¸»è¦åŒ…æ‹¬ï¼š</p><ul><li><strong>æ•°æ®å†—ä½™</strong>ï¼šä¸»ä»å¤åˆ¶å®ç°äº†æ•°æ®çš„çƒ­å¤‡ä»½ï¼Œæ˜¯æŒä¹…åŒ–ä¹‹å¤–çš„ä¸€ç§æ•°æ®å†—ä½™æ–¹å¼ã€‚</li><li><strong>æ•…éšœæ¢å¤</strong>ï¼šå½“ä¸»èŠ‚ç‚¹å‡ºç°é—®é¢˜æ—¶ï¼Œå¯ä»¥ç”±ä»èŠ‚ç‚¹æä¾›æœåŠ¡ï¼Œå®ç°å¿«é€Ÿçš„æ•…éšœæ¢å¤ï¼›å®é™…ä¸Šæ˜¯ä¸€ç§æœåŠ¡çš„å†—ä½™ã€‚</li><li><strong>è´Ÿè½½å‡è¡¡</strong>ï¼šåœ¨ä¸»ä»å¤åˆ¶çš„åŸºç¡€ä¸Šï¼Œé…åˆè¯»å†™åˆ†ç¦»ï¼Œå¯ä»¥ç”±ä¸»èŠ‚ç‚¹æä¾›å†™æœåŠ¡ï¼Œç”±ä»èŠ‚ç‚¹æä¾›è¯»æœåŠ¡ï¼ˆå³å†™Redisæ•°æ®æ—¶åº”ç”¨è¿æ¥ä¸»èŠ‚ç‚¹ï¼Œè¯»Redisæ•°æ®æ—¶åº”ç”¨è¿æ¥ä»èŠ‚ç‚¹ï¼‰ï¼Œåˆ†æ‹…æœåŠ¡å™¨è´Ÿè½½ï¼›å°¤å…¶æ˜¯åœ¨å†™å°‘è¯»å¤šçš„åœºæ™¯ä¸‹ï¼Œé€šè¿‡å¤šä¸ªä»èŠ‚ç‚¹åˆ†æ‹…è¯»è´Ÿè½½ï¼Œå¯ä»¥å¤§å¤§æé«˜RedisæœåŠ¡å™¨çš„å¹¶å‘é‡ã€‚</li><li><strong>é«˜å¯ç”¨åŸºçŸ³</strong>ï¼šé™¤äº†ä¸Šè¿°ä½œç”¨ä»¥å¤–ï¼Œä¸»ä»å¤åˆ¶è¿˜æ˜¯å“¨å…µå’Œé›†ç¾¤èƒ½å¤Ÿå®æ–½çš„åŸºç¡€ï¼Œå› æ­¤è¯´ä¸»ä»å¤åˆ¶æ˜¯Redisé«˜å¯ç”¨çš„åŸºç¡€ã€‚</li></ul><p>ä¸»ä»åº“ä¹‹é—´é‡‡ç”¨çš„æ˜¯<strong>è¯»å†™åˆ†ç¦»</strong>çš„æ–¹å¼ã€‚</p><ul><li>è¯»æ“ä½œï¼šä¸»åº“ã€ä»åº“éƒ½å¯ä»¥æ¥æ”¶ï¼›</li><li>å†™æ“ä½œï¼šé¦–å…ˆåˆ°ä¸»åº“æ‰§è¡Œï¼Œç„¶åï¼Œä¸»åº“å°†å†™æ“ä½œåŒæ­¥ç»™ä»åº“ã€‚</li></ul><p>åœ¨ 2.8 ç‰ˆæœ¬ä¹‹å‰ï¼Œåªæœ‰å…¨é‡å¤åˆ¶ï¼Œè€Œ2.8ç‰ˆæœ¬ä¹‹åæœ‰å…¨é‡å’Œå¢é‡å¤åˆ¶</p><ul><li>å…¨é‡ï¼ˆåŒæ­¥ï¼‰å¤åˆ¶ï¼šæ¯”å¦‚ç¬¬ä¸€æ¬¡åŒæ­¥æ—¶</li><li>å¢é‡ï¼ˆåŒæ­¥ï¼‰å¤åˆ¶ï¼šåªä¼šæŠŠä¸»ä»åº“ç½‘ç»œæ–­è¿æœŸé—´ä¸»åº“æ”¶åˆ°çš„å‘½ä»¤ï¼ŒåŒæ­¥ç»™ä»åº“ã€‚</li></ul><h4 id="5-7-2-å…¨é‡å¤åˆ¶"><a href="#5-7-2-å…¨é‡å¤åˆ¶" class="headerlink" title="5.7.2 å…¨é‡å¤åˆ¶"></a>5.7.2 å…¨é‡å¤åˆ¶</h4><p>å½“æˆ‘ä»¬å¯åŠ¨å¤šä¸ª Redis å®ä¾‹çš„æ—¶å€™ï¼Œå®ƒä»¬ç›¸äº’ä¹‹é—´å°±å¯ä»¥é€šè¿‡ replicaofï¼ˆRedis 5.0 ä¹‹å‰ä½¿ç”¨ slaveofï¼‰å‘½ä»¤å½¢æˆä¸»åº“å’Œä»åº“çš„å…³ç³»ï¼Œä¹‹åä¼šæŒ‰ç…§ä¸‰ä¸ªé˜¶æ®µå®Œæˆæ•°æ®çš„ç¬¬ä¸€æ¬¡åŒæ­¥</p><ul><li>å»ºç«‹ä¸»ä»å…³ç³»</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># è¿™é‡Œæˆ‘ä»¬åˆ›å»ºäº† ä¸¤ä¸ª redis å®ä¾‹</span><br><span class="line">[root@VM-4-9-centos ~]# docker run -it -d --name redis2 -p 6379:6379 redis</span><br><span class="line">9865ef807588457b05a4353a5c4a1699486343abab71d6682f98a6bc27497961</span><br><span class="line">[root@VM-4-9-centos ~]# docker run -it -d --name redis1 -p 6380:6379 redis</span><br><span class="line">f21ca2cacfea46f1b05baffffdafc9c46f76482cdea3d018ff7196469b75c6e9</span><br><span class="line"></span><br><span class="line"># æŸ¥çœ‹æ‰€æœ‰å®¹å™¨çš„ ipåœ°å€</span><br><span class="line">[root@VM-4-9-centos ~]# docker inspect -f &#x27;&#123;&#123;.Name&#125;&#125; - &#123;&#123;.NetworkSettings.IPAddress &#125;&#125;&#x27; $(docker ps -aq)</span><br><span class="line">/redis2 - 172.17.0.5</span><br><span class="line">/redis1 - 172.17.0.4</span><br><span class="line"></span><br><span class="line"># ä½¿ç”¨ redis1 å®¹å™¨çš„ rediså‘½ä»¤è¡Œï¼Œå­˜å…¥ key=name,value=kongxr</span><br><span class="line">[root@VM-4-9-centos ~]#  docker exec -it redis1 /bin/bash</span><br><span class="line">root@f21ca2cacfea:/data# redis-cli</span><br><span class="line">127.0.0.1:6379&gt; set name kongxr</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line"># ä½¿ç”¨ reids2å®¹å™¨å†…çš„ rediså‘½ä»¤è¡Œã€‚æŸ¥è¯¢key=nameï¼Œæœªè·å–åˆ°å€¼ã€‚</span><br><span class="line"># ç„¶åä½¿ç”¨åŒæ­¥å‘½ä»¤å°†redis2 ä½œä¸ºä»åº“ï¼Œå»ºç«‹ä¸»ä»å…³ç³»ï¼Œå¹¶åŒæ­¥æ•°æ®</span><br><span class="line">[root@VM-4-9-centos ~]# docker exec -it redis2 /bin/bash</span><br><span class="line">root@9865ef807588:/data# redis-cli</span><br><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line">(nil)</span><br><span class="line">127.0.0.1:6379&gt; replicaof 172.17.0.4 6379</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line">(nil)</span><br><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line">&quot;kongxr&quot;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„æµ‹è¯•ï¼Œå¯ä»¥çœ‹åˆ° åœ¨å»ºç«‹ä¸»ä»å…³ç³»åï¼Œä»åº“ä¼šæ…¢æ…¢ä»ä¸»åº“ä¸­åŒæ­¥å…¨é‡æ•°æ®ã€‚</p><ul><li><p>å…¨é‡å¤åˆ¶çš„ä¸‰ä¸ªé˜¶æ®µ</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779131543-769d79b6-8fbc-49bd-9f96-2cd53b6554a7-20250605100935711.jpeg" alt="img"></p></li></ul><ol><li><ol><li><strong>ç¬¬ä¸€é˜¶æ®µæ˜¯ä¸»ä»åº“é—´å»ºç«‹è¿æ¥ã€åå•†åŒæ­¥çš„è¿‡ç¨‹ï¼Œä¸»è¦æ˜¯ä¸ºäº†å…¨é‡å¤åˆ¶åšå‡†å¤‡ã€‚</strong>åœ¨è¿™ä¸€æ­¥ï¼Œä»åº“å’Œä¸»åº“å»ºç«‹è¿æ¥ï¼Œå¹¶å‘Šè¯‰ä¸»åº“å³å°†å¼€å§‹è¿›è¡ŒåŒæ­¥ï¼Œä¸»åº“ç¡®è®¤å›å¤åï¼Œä¸»ä»åº“é—´å°±å¯ä»¥å¼€å§‹åŒæ­¥äº†ã€‚å…·ä½“çš„æ¥è¯´ï¼Œä»åº“ç»™ä¸»åº“å‘é€ psync å‘½ä»¤ï¼Œè¡¨ç¤ºè¦è¿›è¡Œæ•°æ®åŒæ­¥ï¼Œä¸»åº“æ ¹æ®è¿™ä¸ªå‘½ä»¤çš„å‚æ•°æ¥å¯åŠ¨å¤åˆ¶ã€‚psync å‘½ä»¤åŒ…æ‹¬äº†ä¸»åº“çš„ runID å’Œ å¤åˆ¶è¿›åº¦ offset ä¸¤ä¸ªå‚æ•°ã€‚runIDï¼Œæ˜¯æ¯ä¸ª Redis å®ä¾‹å¯åŠ¨æ—¶éƒ½ä¼šè‡ªåŠ¨ç”Ÿæˆçš„ä¸€ä¸ªéšæœºIDï¼Œç”¨æ¥å”¯ä¸€æ ‡è®°è¿™ä¸ªå®ä¾‹ã€‚å½“ä»åº“å’Œä¸»åº“ç¬¬ä¸€æ¬¡å¤åˆ¶æ—¶ï¼Œå› ä¸ºä¸çŸ¥é“ä¸»åº“çš„ runIDï¼Œæ‰€ä»¥å°† runID è®¾ä¸º â€œ?â€ ã€‚offsetï¼Œæ­¤æ—¶è®¾ä¸º -1ï¼Œè¡¨ç¤ºç¬¬ä¸€æ¬¡å¤åˆ¶ã€‚ä¸»åº“æ”¶åˆ° psync å‘½ä»¤åï¼Œä¼šç”¨ FULLRESYNC å“åº”å‘½ä»¤å¸¦ä¸Š ä¸¤ä¸ªå‚æ•°ï¼šä¸»åº“ runID å’Œä¸»åº“ç›®å‰çš„å¤åˆ¶è¿›åº¦ offset ï¼Œè¿”å›ç»™ä»åº“ã€‚ä»åº“æ”¶åˆ°å“åº”åï¼Œä¼šè®°å½•ä¸‹è¿™ä¸¤ä¸ªå‚æ•°ã€‚è¿™é‡Œæœ‰ä¸ªåœ°æ–¹éœ€è¦æ³¨æ„ï¼ŒFULLRESYNC å“åº”è¡¨ç¤ºç¬¬ä¸€æ¬¡å¤åˆ¶é‡‡ç”¨çš„å…¨é‡å¤åˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸»åº“ä¼šæŠŠå½“å‰æ‰€æœ‰çš„æ•°æ®éƒ½å¤åˆ¶ç»™ä»åº“ã€‚</li><li><strong>ç¬¬äºŒä¸ªé˜¶æ®µï¼Œä¸»åº“å°†æ‰€æœ‰æ•°æ®åŒæ­¥ç»™ä»åº“ã€‚</strong>ä»åº“æ”¶åˆ°æ•°æ®åï¼Œåœ¨æœ¬åœ°å®Œæˆæ•°æ®åŠ è½½ã€‚è¿™ä¸ªè¿‡ç¨‹ä¾èµ–äºå†…å­˜å¿«ç…§ç”Ÿæˆ RDB æ–‡ä»¶ã€‚å…·ä½“æ¥è¯´ï¼Œä¸»åº“æ‰§è¡Œ bgsave å‘½ä»¤ï¼Œç”Ÿæˆ RDB æ–‡ä»¶ï¼Œæ¥ç€å°†æ–‡ä»¶å‘é€ç»™ä»åº“ã€‚ä»åº“æ¥æ”¶åˆ° RDB æ–‡ä»¶åï¼Œä¼šå…ˆæ¸…ç©ºå½“å‰æ•°æ®åº“ï¼Œç„¶ååŠ è½½ RDB æ–‡ä»¶ã€‚è¿™æ˜¯å› ä¸ºä»åº“åœ¨é€šè¿‡ replicaof å‘½ä»¤å¼€å§‹å’Œä¸»åº“åŒæ­¥å‰ï¼Œå¯èƒ½ä¿å­˜äº†å…¶ä»–æ•°æ®ã€‚ä¸ºäº†é¿å…ä¹‹å‰æ•°æ®çš„å½±å“ï¼Œä»åº“éœ€è¦å…ˆæŠŠå½“å‰æ•°æ®åº“æ¸…ç©ºã€‚åœ¨ä¸»åº“å°†æ•°æ®åŒæ­¥ç»™ä»åº“çš„è¿‡ç¨‹ä¸­ï¼Œä¸»åº“ä¸ä¼šè¢«å µå¡ï¼Œä»ç„¶å¯ä»¥æ­£å¸¸æ¥å—è¯·æ±‚ã€‚ä½†æ˜¯ï¼Œè¯·æ±‚ä¸­çš„å†™æ“ä½œå¹¶æ²¡æœ‰è®°å½•åˆ°åˆšåˆšç”Ÿæˆçš„ RDB æ–‡ä»¶ä¸­ã€‚ä¸ºäº†ä¿è¯ä¸»ä»åº“çš„æ•°æ®ä¸€è‡´æ€§ï¼Œä¸»åº“ä¼šåœ¨å†…å­˜ä¸­ç”¨ä¸“é—¨çš„ replication bufferï¼Œè®°å½• RDB æ–‡ä»¶ç”Ÿæˆåæ”¶åˆ°çš„æ‰€æœ‰å†™æ“ä½œã€‚</li><li><strong>ç¬¬ä¸‰ä¸ªé˜¶æ®µï¼Œä¸»åº“ä¼šæŠŠç¬¬äºŒé˜¶æ®µæ‰§è¡Œè¿‡ç¨‹ä¸­æ–°æ”¶åˆ°çš„å†™å‘½ä»¤ï¼Œå†å‘ç»™ä»åº“ã€‚</strong>å…·ä½“çš„æ“ä½œæ˜¯ï¼Œå½“ä¸»åº“å®Œæˆ RDB æ–‡ä»¶å‘é€åï¼Œå°±ä¼šæŠŠæ­¤æ—¶ replication buffer ä¸­çš„ä¿®æ”¹æ“ä½œå‘ç»™ä»åº“ï¼Œä»åº“å†é‡æ–°æ‰§è¡Œè¿™äº›æ“ä½œã€‚è¿™æ ·ä»¥æ¥ï¼Œä¸»ä»åº“å°±å®ç°åŒæ­¥äº†ã€‚</li></ol></li></ol><h4 id="5-7-3-å¢é‡å¤åˆ¶"><a href="#5-7-3-å¢é‡å¤åˆ¶" class="headerlink" title="5.7.3 å¢é‡å¤åˆ¶"></a>5.7.3 å¢é‡å¤åˆ¶</h4><p>åœ¨ Redis 2.8 ç‰ˆæœ¬å¼•å…¥äº†å¢é‡å¤åˆ¶</p><ul><li><p>ä¸ºä»€ä¹ˆä¼šè®¾è®¡å¢é‡å¤åˆ¶ï¼Ÿå¦‚æœä¸»ä»åº“åœ¨å‘½ä»¤ä¼ æ’­æ—¶å‡ºç°äº†ç½‘ç»œé—ªæ–­ï¼Œé‚£ä¹ˆä»åº“å°±ä¼šå’Œä¸»åº“é‡æ–°è¿›è¡Œä¸€æ¬¡å…¨é‡å¤åˆ¶ï¼Œå¼€é”€éå¸¸å¤§ã€‚ä» Redis 2.8å¼€å§‹ï¼Œç½‘ç»œæ–­äº†ä¹‹åï¼Œä¸»ä»åº“ä¼šé‡‡ç”¨å¢é‡å¤åˆ¶çš„æ–¹å¼ç»§ç»­åŒæ­¥ã€‚</p></li><li><p>å¢é‡å¤åˆ¶æµç¨‹</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779133615-180cf488-8310-45f7-9e35-8cea064b2119-20250605100916148.jpeg" alt="img"></p></li><li><p>å…ˆçœ‹ä¸¤ä¸ªæ¦‚å¿µï¼š replication buffer å’Œ repl_backlog_bufferrepl_backlog_bufferï¼šå®ƒæ˜¯ä¸ºäº†ä»åº“æ–­å¼€ä¹‹åï¼Œå¦‚ä½•æ‰¾åˆ°ä¸»ä»å·®å¼‚æ•°æ®è€Œè®¾è®¡çš„ç¯å½¢ç¼“å†²åŒºï¼Œä»è€Œé¿å…å…¨é‡å¤åˆ¶å¸¦æ¥çš„æ€§èƒ½å¼€é”€ã€‚å¦‚æœä»åº“æ–­å¼€æ—¶é—´å¤ªä¹…ï¼Œrepl_backlog_bufferç¯å½¢ç¼“å†²åŒºè¢«ä¸»åº“çš„å†™å‘½ä»¤è¦†ç›–äº†ï¼Œé‚£ä¹ˆä»åº“è¿ä¸Šä¸»åº“ååªèƒ½ä¹–ä¹–åœ°è¿›è¡Œä¸€æ¬¡å…¨é‡å¤åˆ¶ï¼Œæ‰€ä»¥<strong>repl_backlog_bufferé…ç½®å°½é‡å¤§ä¸€äº›ï¼Œå¯ä»¥é™ä½ä¸»ä»æ–­å¼€åå…¨é‡å¤åˆ¶çš„æ¦‚ç‡</strong>ã€‚è€Œåœ¨repl_backlog_bufferä¸­æ‰¾ä¸»ä»å·®å¼‚çš„æ•°æ®åï¼Œå¦‚ä½•å‘ç»™ä»åº“å‘¢ï¼Ÿè¿™å°±ç”¨åˆ°äº†replication bufferã€‚replication bufferï¼šRediså’Œå®¢æˆ·ç«¯é€šä¿¡ä¹Ÿå¥½ï¼Œå’Œä»åº“é€šä¿¡ä¹Ÿå¥½ï¼ŒRediséƒ½éœ€è¦ç»™åˆ†é…ä¸€ä¸ª å†…å­˜bufferè¿›è¡Œæ•°æ®äº¤äº’ï¼Œå®¢æˆ·ç«¯æ˜¯ä¸€ä¸ªclientï¼Œä»åº“ä¹Ÿæ˜¯ä¸€ä¸ªclientï¼Œæˆ‘ä»¬æ¯ä¸ªclientè¿ä¸ŠRedisåï¼ŒRediséƒ½ä¼šåˆ†é…ä¸€ä¸ªclient bufferï¼Œæ‰€æœ‰æ•°æ®äº¤äº’éƒ½æ˜¯é€šè¿‡è¿™ä¸ªbufferè¿›è¡Œçš„ï¼šRediså…ˆæŠŠæ•°æ®å†™åˆ°è¿™ä¸ªbufferä¸­ï¼Œç„¶åå†æŠŠbufferä¸­çš„æ•°æ®å‘åˆ°client socketä¸­å†é€šè¿‡ç½‘ç»œå‘é€å‡ºå»ï¼Œè¿™æ ·å°±å®Œæˆäº†æ•°æ®äº¤äº’ã€‚æ‰€ä»¥ä¸»ä»åœ¨å¢é‡åŒæ­¥æ—¶ï¼Œä»åº“ä½œä¸ºä¸€ä¸ªclientï¼Œä¹Ÿä¼šåˆ†é…ä¸€ä¸ªbufferï¼Œåªä¸è¿‡è¿™ä¸ªbufferä¸“é—¨ç”¨æ¥ä¼ æ’­ç”¨æˆ·çš„å†™å‘½ä»¤åˆ°ä»åº“ï¼Œä¿è¯ä¸»ä»æ•°æ®ä¸€è‡´ï¼Œæˆ‘ä»¬é€šå¸¸æŠŠå®ƒå«åšreplication bufferã€‚å¯¹äºè¿™ä¸ªé—®é¢˜æ¥è¯´ï¼Œæœ‰ä¸¤ä¸ªå…³é”®ç‚¹ï¼š</p></li><li><ul><li><strong>å¦‚æœåœ¨ç½‘ç»œæ–­å¼€æœŸé—´ï¼Œrepl_backlog_sizeç¯å½¢ç¼“å†²åŒºå†™æ»¡ä¹‹åï¼Œä»åº“æ˜¯ä¼šä¸¢å¤±æ‰é‚£éƒ¨åˆ†è¢«è¦†ç›–æ‰çš„æ•°æ®ï¼Œè¿˜æ˜¯ç›´æ¥è¿›è¡Œå…¨é‡å¤åˆ¶å‘¢</strong>ï¼Ÿ</li></ul></li></ul><ol><li><ol><li>ä¸€ä¸ªä»åº“å¦‚æœå’Œä¸»åº“æ–­è¿æ—¶é—´è¿‡é•¿ï¼Œé€ æˆå®ƒåœ¨ä¸»åº“repl_backlog_bufferçš„slave_repl_offsetä½ç½®ä¸Šçš„æ•°æ®å·²ç»è¢«è¦†ç›–æ‰äº†ï¼Œæ­¤æ—¶ä»åº“å’Œä¸»åº“é—´å°†è¿›è¡Œå…¨é‡å¤åˆ¶ã€‚</li><li>æ¯ä¸ªä»åº“ä¼šè®°å½•è‡ªå·±çš„slave_repl_offsetï¼Œæ¯ä¸ªä»åº“çš„å¤åˆ¶è¿›åº¦ä¹Ÿä¸ä¸€å®šç›¸åŒã€‚åœ¨å’Œä¸»åº“é‡è¿è¿›è¡Œæ¢å¤æ—¶ï¼Œä»åº“ä¼šé€šè¿‡psyncå‘½ä»¤æŠŠè‡ªå·±è®°å½•çš„slave_repl_offsetå‘ç»™ä¸»åº“ï¼Œä¸»åº“ä¼šæ ¹æ®ä»åº“å„è‡ªçš„å¤åˆ¶è¿›åº¦ï¼Œæ¥å†³å®šè¿™ä¸ªä»åº“å¯ä»¥è¿›è¡Œå¢é‡å¤åˆ¶ï¼Œè¿˜æ˜¯å…¨é‡å¤åˆ¶ã€‚</li></ol></li></ol><h4 id="5-7-4-æ›´å¤šç†è§£"><a href="#5-7-4-æ›´å¤šç†è§£" class="headerlink" title="5.7.4 æ›´å¤šç†è§£"></a>5.7.4 æ›´å¤šç†è§£</h4><h5 id="1-å½“ä¸»æœåŠ¡å™¨ä¸è¿›è¡ŒæŒä¹…åŒ–æ—¶-å¤åˆ¶çš„å®‰å…¨æ€§"><a href="#1-å½“ä¸»æœåŠ¡å™¨ä¸è¿›è¡ŒæŒä¹…åŒ–æ—¶-å¤åˆ¶çš„å®‰å…¨æ€§" class="headerlink" title="1.å½“ä¸»æœåŠ¡å™¨ä¸è¿›è¡ŒæŒä¹…åŒ–æ—¶ å¤åˆ¶çš„å®‰å…¨æ€§"></a>1.å½“ä¸»æœåŠ¡å™¨ä¸è¿›è¡ŒæŒä¹…åŒ–æ—¶ å¤åˆ¶çš„å®‰å…¨æ€§</h5><p>å¼ºçƒˆå»ºè®®ä¸»æœåŠ¡å™¨å¼€å¯æŒä¹…åŒ–ã€‚å¦‚æœçœŸçš„ä¸èƒ½å¼€å¯æŒä¹…åŒ–ï¼Œé‚£ä¹ˆä¸€å®šè¦ç¦æ­¢Rediså®ä¾‹è‡ªåŠ¨é‡å¯ã€‚</p><p>ä¸ºä»€ä¹ˆä¸æŒä¹…åŒ–çš„ä¸»æœåŠ¡å™¨è‡ªåŠ¨é‡å¯éå¸¸å±é™©å‘¢ï¼Ÿä¸ºäº†æ›´å¥½çš„ç†è§£è¿™ä¸ªé—®é¢˜ï¼Œçœ‹ä¸‹é¢è¿™ä¸ªå¤±è´¥çš„ä¾‹å­ï¼Œå…¶ä¸­ä¸»æœåŠ¡å™¨å’Œä»æœåŠ¡å™¨ä¸­æ•°æ®åº“éƒ½è¢«åˆ é™¤äº†ã€‚</p><ul><li>æˆ‘ä»¬è®¾ç½®èŠ‚ç‚¹Aä¸ºä¸»æœåŠ¡å™¨ï¼Œå…³é—­æŒä¹…åŒ–ï¼ŒèŠ‚ç‚¹Bå’ŒCä»èŠ‚ç‚¹Aå¤åˆ¶æ•°æ®ã€‚</li><li>è¿™æ—¶å‡ºç°äº†ä¸€ä¸ªå´©æºƒï¼Œä½†Rediså…·æœ‰è‡ªåŠ¨é‡å¯ç³»ç»Ÿï¼Œé‡å¯äº†è¿›ç¨‹ï¼Œå› ä¸ºå…³é—­äº†æŒä¹…åŒ–ï¼ŒèŠ‚ç‚¹é‡å¯ååªæœ‰ä¸€ä¸ªç©ºçš„æ•°æ®é›†ã€‚</li><li>èŠ‚ç‚¹Bå’ŒCä»èŠ‚ç‚¹Aè¿›è¡Œå¤åˆ¶ï¼Œç°åœ¨èŠ‚ç‚¹Aæ˜¯ç©ºçš„ï¼Œæ‰€ä»¥èŠ‚ç‚¹Bå’ŒCä¸Šçš„å¤åˆ¶æ•°æ®ä¹Ÿä¼šè¢«åˆ é™¤ã€‚</li><li>å½“åœ¨é«˜å¯ç”¨ç³»ç»Ÿä¸­ä½¿ç”¨Redis Sentinelï¼Œå…³é—­äº†ä¸»æœåŠ¡å™¨çš„æŒä¹…åŒ–ï¼Œå¹¶ä¸”å…è®¸è‡ªåŠ¨é‡å¯ï¼Œè¿™ç§æƒ…å†µæ˜¯å¾ˆå±é™©çš„ã€‚æ¯”å¦‚ä¸»æœåŠ¡å™¨å¯èƒ½åœ¨å¾ˆçŸ­çš„æ—¶é—´å°±å®Œæˆäº†é‡å¯ï¼Œä»¥è‡³äºSentineléƒ½æ— æ³•æ£€æµ‹åˆ°è¿™æ¬¡å¤±è´¥ï¼Œé‚£ä¹ˆä¸Šé¢è¯´çš„è¿™ç§å¤±è´¥çš„æƒ…å†µå°±å‘ç”Ÿäº†ã€‚</li></ul><p>å¦‚æœæ•°æ®æ¯”è¾ƒé‡è¦ï¼Œå¹¶ä¸”åœ¨ä½¿ç”¨ä¸»ä»å¤åˆ¶æ—¶å…³é—­äº†ä¸»æœåŠ¡å™¨æŒä¹…åŒ–åŠŸèƒ½çš„åœºæ™¯ä¸­ï¼Œéƒ½åº”è¯¥ç¦æ­¢å®ä¾‹è‡ªåŠ¨é‡å¯ã€‚</p><h5 id="2-ä¸ºä»€ä¹ˆä¸»ä»å…¨é‡å¤åˆ¶ä½¿ç”¨-RDB-è€Œä¸ä½¿ç”¨-AOFï¼Ÿ"><a href="#2-ä¸ºä»€ä¹ˆä¸»ä»å…¨é‡å¤åˆ¶ä½¿ç”¨-RDB-è€Œä¸ä½¿ç”¨-AOFï¼Ÿ" class="headerlink" title="2.ä¸ºä»€ä¹ˆä¸»ä»å…¨é‡å¤åˆ¶ä½¿ç”¨ RDB è€Œä¸ä½¿ç”¨ AOFï¼Ÿ"></a>2.ä¸ºä»€ä¹ˆä¸»ä»å…¨é‡å¤åˆ¶ä½¿ç”¨ RDB è€Œä¸ä½¿ç”¨ AOFï¼Ÿ</h5><ul><li>RDB æ–‡ä»¶å†…å®¹æ—¶ç»è¿‡å‹ç¼©çš„ äºŒè¿›åˆ¶æ•°æ®ï¼ˆä¸åŒæ•°æ®ç±»å‹æ•°æ®åšäº†é’ˆå¯¹æ€§ä¼˜åŒ–ï¼‰ï¼Œæ–‡ä»¶å¾ˆå°ã€‚è€Œ AOF æ–‡ä»¶è®°å½•çš„æ˜¯ æ¯ä¸€æ¬¡å†™æ“ä½œçš„å‘½ä»¤ï¼Œå†™æ“ä½œè¶Šå¤šæ–‡ä»¶ä¼šå˜å¾—å¾ˆå¤§ï¼Œå…¶ä¸­è¿˜åŒ…æ‹¬å¾ˆå¤šå¯¹åŒä¸€ä¸ª key çš„å¤šæ¬¡å†—ä½™æ“ä½œã€‚åœ¨ä¸»ä»å…¨é‡æ•°æ®åŒæ­¥æ—¶ï¼Œä¼ è¾“ RDB æ–‡ä»¶å¯ä»¥å°½é‡é™ä½å¯¹ä¸»åº“æœºå™¨ç½‘ç»œå¸¦å®½çš„æ¶ˆè€—ï¼Œä»åº“åœ¨åŠ è½½ RDB æ–‡ä»¶æ—¶ï¼Œä¸€æ˜¯æ–‡ä»¶å°ï¼Œè¯»å–æ•´ä¸ªæ–‡ä»¶çš„é€Ÿåº¦ä¼šå¾ˆå¿«ï¼ŒäºŒæ˜¯å› ä¸ºRDBæ–‡ä»¶å­˜å‚¨çš„éƒ½æ˜¯äºŒè¿›åˆ¶æ•°æ®ï¼Œä»åº“ç›´æ¥æŒ‰ç…§RDBåè®®è§£æè¿˜åŸæ•°æ®å³å¯ï¼Œé€Ÿåº¦ä¼šéå¸¸å¿«ï¼Œè€ŒAOFéœ€è¦ä¾æ¬¡é‡æ”¾æ¯ä¸ªå†™å‘½ä»¤ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šç»å†å†—é•¿çš„å¤„ç†é€»è¾‘ï¼Œæ¢å¤é€Ÿåº¦ç›¸æ¯” RDB ä¼šæ…¢å¾—å¤šï¼Œæ‰€ä»¥ä½¿ç”¨ RDB è¿›è¡Œä¸»ä»å…¨é‡å¤åˆ¶çš„æˆæœ¬æœ€ä½ã€‚</li><li>å‡è®¾è¦ä½¿ç”¨ AOF åšå…¨é‡å¤åˆ¶ï¼Œæ„å‘³ç€å¿…é¡»æ‰“å¼€ AOF åŠŸèƒ½ï¼Œæ‰“å¼€ AOF åŠŸèƒ½å°±è¦é€‰æ‹©æ–‡ä»¶çš„åˆ·ç›˜çš„ç­–ç•¥ï¼Œé€‰æ‹©ä¸å½“ä¼šä¸¥é‡å½±å“ Redis æ€§èƒ½ã€‚è€Œ RDB åªæœ‰åœ¨éœ€è¦å®šæ—¶å¤‡ä»½å’Œä¸»ä»å…¨é‡å¤åˆ¶æ•°æ®æ—¶ï¼Œæ‰ä¼šè§¦å‘ç”Ÿæˆä¸€æ¬¡å¿«ç…§ã€‚è€Œåœ¨å¾ˆå¤šå°±æ˜¯æ•°æ®ä¸æ•æ„Ÿçš„ä¸šåŠ¡åœºæ™¯ï¼Œå…¶å®æ—¶ä¸éœ€è¦å¼€å¯ AOF çš„ã€‚</li></ul><h5 id="3-ä¸ºä»€ä¹ˆæœ‰æ— ç£ç›˜å¤åˆ¶æ¨¡å¼ï¼Ÿ"><a href="#3-ä¸ºä»€ä¹ˆæœ‰æ— ç£ç›˜å¤åˆ¶æ¨¡å¼ï¼Ÿ" class="headerlink" title="3.ä¸ºä»€ä¹ˆæœ‰æ— ç£ç›˜å¤åˆ¶æ¨¡å¼ï¼Ÿ"></a>3.ä¸ºä»€ä¹ˆæœ‰æ— ç£ç›˜å¤åˆ¶æ¨¡å¼ï¼Ÿ</h5><p>Redis é»˜è®¤æ—¶ç£ç›˜å¤åˆ¶ï¼Œä½†æ˜¯å¦‚æœä½¿ç”¨æ¯”è¾ƒä½é€Ÿçš„ç£ç›˜ï¼Œè¿™ç§æ“ä½œä¼šç»™ä¸»æœåŠ¡å™¨å¸¦æ¥æ¯”è¾ƒå¤§çš„å‹åŠ›ã€‚Redisä»2.8.18ç‰ˆæœ¬å¼€å§‹å°è¯•æ”¯æŒæ— ç£ç›˜çš„å¤åˆ¶ã€‚ä½¿ç”¨è¿™ç§è®¾ç½®æ—¶ï¼Œå­è¿›ç¨‹ç›´æ¥å°†RDBé€šè¿‡ç½‘ç»œå‘é€ç»™ä»æœåŠ¡å™¨ï¼Œä¸ä½¿ç”¨ç£ç›˜ä½œä¸ºä¸­é—´å­˜å‚¨ã€‚</p><p><strong>æ— ç£ç›˜å¤åˆ¶æ¨¡å¼</strong>ï¼šmasteråˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹ç›´æ¥dump RDBåˆ°slaveçš„socketï¼Œä¸ç»è¿‡ä¸»è¿›ç¨‹ï¼Œä¸ç»è¿‡ç¡¬ç›˜ã€‚é€‚ç”¨äºdiskè¾ƒæ…¢ï¼Œå¹¶ä¸”ç½‘ç»œè¾ƒå¿«çš„æ—¶å€™ã€‚</p><p>ä½¿ç”¨repl-diskless-syncé…ç½®å‚æ•°æ¥å¯åŠ¨æ— ç£ç›˜å¤åˆ¶ã€‚</p><p>ä½¿ç”¨repl-diskless-sync-delay å‚æ•°æ¥é…ç½®ä¼ è¾“å¼€å§‹çš„å»¶è¿Ÿæ—¶é—´ï¼›masterç­‰å¾…ä¸€ä¸ªrepl-diskless-sync-delayçš„ç§’æ•°ï¼Œå¦‚æœæ²¡slaveæ¥çš„è¯ï¼Œå°±ç›´æ¥ä¼ ï¼Œåæ¥çš„å¾—æ’é˜Ÿç­‰äº†; å¦åˆ™å°±å¯ä»¥ä¸€èµ·ä¼ ã€‚</p><h5 id="4-ä¸ºä»€ä¹ˆè¿˜æœ‰-ä»åº“çš„ä»åº“çš„è®¾è®¡ï¼Ÿ"><a href="#4-ä¸ºä»€ä¹ˆè¿˜æœ‰-ä»åº“çš„ä»åº“çš„è®¾è®¡ï¼Ÿ" class="headerlink" title="4.ä¸ºä»€ä¹ˆè¿˜æœ‰ ä»åº“çš„ä»åº“çš„è®¾è®¡ï¼Ÿ"></a>4.ä¸ºä»€ä¹ˆè¿˜æœ‰ ä»åº“çš„ä»åº“çš„è®¾è®¡ï¼Ÿ</h5><p>é€šè¿‡åˆ†æä¸»ä»åº“é—´ç¬¬ä¸€æ¬¡æ•°æ®åŒæ­¥çš„è¿‡ç¨‹ï¼Œä½ å¯ä»¥çœ‹åˆ°ï¼Œä¸€æ¬¡å…¨é‡å¤åˆ¶ä¸­ï¼Œå¯¹äºä¸»åº“æ¥è¯´ï¼Œéœ€è¦å®Œæˆä¸¤ä¸ªè€—æ—¶çš„æ“ä½œï¼š<strong>ç”Ÿæˆ RDB æ–‡ä»¶å’Œä¼ è¾“ RDB æ–‡ä»¶</strong>ã€‚</p><p>å¦‚æœä»åº“æ•°é‡å¾ˆå¤šï¼Œè€Œä¸”éƒ½è¦å’Œä¸»åº“è¿›è¡Œå…¨é‡å¤åˆ¶çš„è¯ï¼Œå°±ä¼šå¯¼è‡´ä¸»åº“å¿™äº fork å­è¿›ç¨‹ç”Ÿæˆ RDB æ–‡ä»¶ï¼Œè¿›è¡Œæ•°æ®å…¨é‡å¤åˆ¶ã€‚fork è¿™ä¸ªæ“ä½œä¼šé˜»å¡ä¸»çº¿ç¨‹å¤„ç†æ­£å¸¸è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´ä¸»åº“å“åº”åº”ç”¨ç¨‹åºçš„è¯·æ±‚é€Ÿåº¦å˜æ…¢ã€‚æ­¤å¤–ï¼Œä¼ è¾“ RDB æ–‡ä»¶ä¹Ÿä¼šå ç”¨ä¸»åº“çš„ç½‘ç»œå¸¦å®½ï¼ŒåŒæ ·ä¼šç»™ä¸»åº“çš„èµ„æºä½¿ç”¨å¸¦æ¥å‹åŠ›ã€‚é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰å¥½çš„è§£å†³æ–¹æ³•å¯ä»¥åˆ†æ‹…ä¸»åº“å‹åŠ›å‘¢ï¼Ÿ</p><p>å…¶å®æ˜¯æœ‰çš„ï¼Œè¿™å°±æ˜¯â€œä¸» - ä» - ä»â€æ¨¡å¼ã€‚</p><p>åœ¨åˆšæ‰ä»‹ç»çš„ä¸»ä»åº“æ¨¡å¼ä¸­ï¼Œæ‰€æœ‰çš„ä»åº“éƒ½æ˜¯å’Œä¸»åº“è¿æ¥ï¼Œæ‰€æœ‰çš„å…¨é‡å¤åˆ¶ä¹Ÿéƒ½æ˜¯å’Œä¸»åº“è¿›è¡Œçš„ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡â€œä¸» - ä» - ä»â€æ¨¡å¼<strong>å°†ä¸»åº“ç”Ÿæˆ RDB å’Œä¼ è¾“ RDB çš„å‹åŠ›ï¼Œä»¥çº§è”çš„æ–¹å¼åˆ†æ•£åˆ°ä»åº“ä¸Š</strong>ã€‚</p><p>ç®€å•æ¥è¯´ï¼Œæˆ‘ä»¬åœ¨éƒ¨ç½²ä¸»ä»é›†ç¾¤çš„æ—¶å€™ï¼Œå¯ä»¥æ‰‹åŠ¨é€‰æ‹©ä¸€ä¸ªä»åº“ï¼ˆæ¯”å¦‚é€‰æ‹©å†…å­˜èµ„æºé…ç½®è¾ƒé«˜çš„ä»åº“ï¼‰ï¼Œç”¨äºçº§è”å…¶ä»–çš„ä»åº“ã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥å†é€‰æ‹©ä¸€äº›ä»åº“ï¼ˆä¾‹å¦‚ä¸‰åˆ†ä¹‹ä¸€çš„ä»åº“ï¼‰ï¼Œåœ¨è¿™äº›ä»åº“ä¸Šæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œè®©å®ƒä»¬å’Œåˆšæ‰æ‰€é€‰çš„ä»åº“ï¼Œå»ºç«‹èµ·ä¸»ä»å…³ç³»ã€‚</p><p>replicaof æ‰€é€‰ä»åº“çš„IP 6379</p><p>è¿™æ ·ä¸€æ¥ï¼Œè¿™äº›ä»åº“å°±ä¼šçŸ¥é“ï¼Œåœ¨è¿›è¡ŒåŒæ­¥æ—¶ï¼Œä¸ç”¨å†å’Œä¸»åº“è¿›è¡Œäº¤äº’äº†ï¼Œåªè¦å’Œçº§è”çš„ä»åº“è¿›è¡Œå†™æ“ä½œåŒæ­¥å°±è¡Œäº†ï¼Œè¿™å°±å¯ä»¥å‡è½»ä¸»åº“ä¸Šçš„å‹åŠ›ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779133018-6c82f9a9-6735-48d3-953f-9a4410adf454-20250605100846437.jpeg" alt="img"></p><p>çº§è”çš„â€œä¸»-ä»-ä»â€æ¨¡å¼å¥½äº†ï¼Œåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬äº†è§£äº†ä¸»ä»åº“é—´é€šè¿‡å…¨é‡å¤åˆ¶å®ç°æ•°æ®åŒæ­¥çš„è¿‡ç¨‹ï¼Œä»¥åŠé€šè¿‡â€œä¸» - ä» - ä»â€æ¨¡å¼åˆ†æ‹…ä¸»åº“å‹åŠ›çš„æ–¹å¼ã€‚é‚£ä¹ˆï¼Œä¸€æ—¦ä¸»ä»åº“å®Œæˆäº†å…¨é‡å¤åˆ¶ï¼Œå®ƒä»¬ä¹‹é—´å°±ä¼šä¸€ç›´ç»´æŠ¤ä¸€ä¸ªç½‘ç»œè¿æ¥ï¼Œä¸»åº“ä¼šé€šè¿‡è¿™ä¸ªè¿æ¥å°†åç»­é™†ç»­æ”¶åˆ°çš„å‘½ä»¤æ“ä½œå†åŒæ­¥ç»™ä»åº“ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¹Ÿç§°ä¸ºåŸºäºé•¿è¿æ¥çš„å‘½ä»¤ä¼ æ’­ï¼Œå¯ä»¥é¿å…é¢‘ç¹å»ºç«‹è¿æ¥çš„å¼€é”€ã€‚</p><h5 id="5-è¯»å†™åˆ†ç¦»åŠå…¶ä¸­çš„é—®é¢˜"><a href="#5-è¯»å†™åˆ†ç¦»åŠå…¶ä¸­çš„é—®é¢˜" class="headerlink" title="5.è¯»å†™åˆ†ç¦»åŠå…¶ä¸­çš„é—®é¢˜"></a>5.è¯»å†™åˆ†ç¦»åŠå…¶ä¸­çš„é—®é¢˜</h5><p>åœ¨ä¸»ä»å¤åˆ¶åŸºç¡€ä¸Šå®ç°çš„è¯»å†™åˆ†ç¦»ï¼Œå¯ä»¥å®ç° Redis çš„è¯»è´Ÿè½½å‡è¡¡ï¼šç”±ä¸»èŠ‚ç‚¹æä¾›å†™æœåŠ¡ï¼Œç”±ä¸€ä¸ªæˆ–è€…å¤šä¸ªä»èŠ‚ç‚¹æä¾›è¯»æœåŠ¡ï¼ˆå¤šä¸ªä»èŠ‚ç‚¹æ—¢å¯ä»¥æä¾›æ•°æ®å†—ä½™ç¨‹åº¦ï¼Œä¹Ÿå¯ä»¥æœ€å¤§åŒ–è¯»è´Ÿè½½èƒ½åŠ›ï¼‰ï¼›åœ¨è¯»è´Ÿè½½è¾ƒå¤§çš„åº”ç”¨åœºæ™¯ä¸‹ï¼Œå¯ä»¥å¤§å¤§æé«˜ Redis æœåŠ¡å™¨çš„å¹¶å‘é‡ã€‚ä¸‹é¢ä»‹ç»åœ¨ä½¿ç”¨ Redis è¯»å†™åˆ†ç¦»æ—¶ï¼Œéœ€è¦æ³¨æ„çš„é—®é¢˜ï¼š</p><ul><li><strong>å»¶è¿Ÿä¸ä¸ä¸€è‡´é—®é¢˜</strong></li></ul><p>å‰é¢å·²ç»è®²åˆ°ï¼Œç”±äºä¸»ä»å¤åˆ¶çš„å‘½ä»¤ä¼ æ’­æ˜¯å¼‚æ­¥çš„ï¼Œå»¶è¿Ÿä¸æ•°æ®çš„ä¸ä¸€è‡´ä¸å¯é¿å…ã€‚å¦‚æœåº”ç”¨å¯¹æ•°æ®ä¸ä¸€è‡´çš„æ¥å—ç¨‹åº¦ç¨‹åº¦è¾ƒä½ï¼Œå¯èƒ½çš„ä¼˜åŒ–æªæ–½åŒ…æ‹¬ï¼šä¼˜åŒ–ä¸»ä»èŠ‚ç‚¹ä¹‹é—´çš„ç½‘ç»œç¯å¢ƒï¼ˆå¦‚åœ¨åŒæœºæˆ¿éƒ¨ç½²ï¼‰ï¼›ç›‘æ§ä¸»ä»èŠ‚ç‚¹å»¶è¿Ÿï¼ˆé€šè¿‡offsetï¼‰åˆ¤æ–­ï¼Œå¦‚æœä»èŠ‚ç‚¹å»¶è¿Ÿè¿‡å¤§ï¼Œé€šçŸ¥åº”ç”¨ä¸å†é€šè¿‡è¯¥ä»èŠ‚ç‚¹è¯»å–æ•°æ®ï¼›ä½¿ç”¨é›†ç¾¤åŒæ—¶æ‰©å±•å†™è´Ÿè½½å’Œè¯»è´Ÿè½½ç­‰ã€‚</p><p>åœ¨å‘½ä»¤ä¼ æ’­é˜¶æ®µä»¥å¤–çš„å…¶ä»–æƒ…å†µä¸‹ï¼Œä»èŠ‚ç‚¹çš„æ•°æ®ä¸ä¸€è‡´å¯èƒ½æ›´åŠ ä¸¥é‡ï¼Œä¾‹å¦‚è¿æ¥åœ¨æ•°æ®åŒæ­¥é˜¶æ®µï¼Œæˆ–ä»èŠ‚ç‚¹å¤±å»ä¸ä¸»èŠ‚ç‚¹çš„è¿æ¥æ—¶ç­‰ã€‚ä»èŠ‚ç‚¹çš„slave-serve-stale-dataå‚æ•°ä¾¿ä¸æ­¤æœ‰å…³ï¼šå®ƒæ§åˆ¶è¿™ç§æƒ…å†µä¸‹ä»èŠ‚ç‚¹çš„è¡¨ç°ï¼›å¦‚æœä¸ºyesï¼ˆé»˜è®¤å€¼ï¼‰ï¼Œåˆ™ä»èŠ‚ç‚¹ä»èƒ½å¤Ÿå“åº”å®¢æˆ·ç«¯çš„å‘½ä»¤ï¼Œå¦‚æœä¸ºnoï¼Œåˆ™ä»èŠ‚ç‚¹åªèƒ½å“åº”infoã€slaveofç­‰å°‘æ•°å‘½ä»¤ã€‚è¯¥å‚æ•°çš„è®¾ç½®ä¸åº”ç”¨å¯¹æ•°æ®ä¸€è‡´æ€§çš„è¦æ±‚æœ‰å…³ï¼›å¦‚æœå¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚å¾ˆé«˜ï¼Œåˆ™åº”è®¾ç½®ä¸ºnoã€‚</p><ul><li><strong>æ•°æ®è¿‡æœŸé—®é¢˜</strong></li></ul><p>åœ¨å•æœºç‰ˆRedisä¸­ï¼Œå­˜åœ¨ä¸¤ç§åˆ é™¤ç­–ç•¥ï¼š</p><ul><li>æƒ°æ€§åˆ é™¤ï¼šæœåŠ¡å™¨ä¸ä¼šä¸»åŠ¨åˆ é™¤æ•°æ®ï¼Œåªæœ‰å½“å®¢æˆ·ç«¯æŸ¥è¯¢æŸä¸ªæ•°æ®æ—¶ï¼ŒæœåŠ¡å™¨åˆ¤æ–­è¯¥æ•°æ®æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸåˆ™åˆ é™¤ã€‚</li><li>å®šæœŸåˆ é™¤ï¼šæœåŠ¡å™¨æ‰§è¡Œå®šæ—¶ä»»åŠ¡åˆ é™¤è¿‡æœŸæ•°æ®ï¼Œä½†æ˜¯è€ƒè™‘åˆ°å†…å­˜å’ŒCPUçš„æŠ˜ä¸­ï¼ˆåˆ é™¤ä¼šé‡Šæ”¾å†…å­˜ï¼Œä½†æ˜¯é¢‘ç¹çš„åˆ é™¤æ“ä½œå¯¹CPUä¸å‹å¥½ï¼‰ï¼Œè¯¥åˆ é™¤çš„é¢‘ç‡å’Œæ‰§è¡Œæ—¶é—´éƒ½å—åˆ°äº†é™åˆ¶ã€‚</li></ul><p>åœ¨ä¸»ä»å¤åˆ¶åœºæ™¯ä¸‹ï¼Œä¸ºäº†ä¸»ä»èŠ‚ç‚¹çš„æ•°æ®ä¸€è‡´æ€§ï¼Œä»èŠ‚ç‚¹ä¸ä¼šä¸»åŠ¨åˆ é™¤æ•°æ®ï¼Œè€Œæ˜¯ç”±ä¸»èŠ‚ç‚¹æ§åˆ¶ä»èŠ‚ç‚¹ä¸­è¿‡æœŸæ•°æ®çš„åˆ é™¤ã€‚ç”±äºä¸»èŠ‚ç‚¹çš„æƒ°æ€§åˆ é™¤å’Œå®šæœŸåˆ é™¤ç­–ç•¥ï¼Œéƒ½ä¸èƒ½ä¿è¯ä¸»èŠ‚ç‚¹åŠæ—¶å¯¹è¿‡æœŸæ•°æ®æ‰§è¡Œåˆ é™¤æ“ä½œï¼Œå› æ­¤ï¼Œå½“å®¢æˆ·ç«¯é€šè¿‡Redisä»èŠ‚ç‚¹è¯»å–æ•°æ®æ—¶ï¼Œå¾ˆå®¹æ˜“è¯»å–åˆ°å·²ç»è¿‡æœŸçš„æ•°æ®ã€‚</p><p>Redis 3.2ä¸­ï¼Œä»èŠ‚ç‚¹åœ¨è¯»å–æ•°æ®æ—¶ï¼Œå¢åŠ äº†å¯¹æ•°æ®æ˜¯å¦è¿‡æœŸçš„åˆ¤æ–­ï¼šå¦‚æœè¯¥æ•°æ®å·²è¿‡æœŸï¼Œåˆ™ä¸è¿”å›ç»™å®¢æˆ·ç«¯ï¼›å°†Rediså‡çº§åˆ°3.2å¯ä»¥è§£å†³æ•°æ®è¿‡æœŸé—®é¢˜ã€‚</p><ul><li><strong>æ•…éšœåˆ‡æ¢é—®é¢˜</strong></li></ul><p>åœ¨æ²¡æœ‰ä½¿ç”¨å“¨å…µçš„è¯»å†™åˆ†ç¦»åœºæ™¯ä¸‹ï¼Œåº”ç”¨é’ˆå¯¹è¯»å’Œå†™åˆ†åˆ«è¿æ¥ä¸åŒçš„RedisèŠ‚ç‚¹ï¼›å½“ä¸»èŠ‚ç‚¹æˆ–ä»èŠ‚ç‚¹å‡ºç°é—®é¢˜è€Œå‘ç”Ÿæ›´æ”¹æ—¶ï¼Œéœ€è¦åŠæ—¶ä¿®æ”¹åº”ç”¨ç¨‹åºè¯»å†™Redisæ•°æ®çš„è¿æ¥ï¼›è¿æ¥çš„åˆ‡æ¢å¯ä»¥æ‰‹åŠ¨è¿›è¡Œï¼Œæˆ–è€…è‡ªå·±å†™ç›‘æ§ç¨‹åºè¿›è¡Œåˆ‡æ¢ï¼Œä½†å‰è€…å“åº”æ…¢ã€å®¹æ˜“å‡ºé”™ï¼Œåè€…å®ç°å¤æ‚ï¼Œæˆæœ¬éƒ½ä¸ç®—ä½ã€‚</p><ul><li><strong>æ€»ç»“</strong></li></ul><p>åœ¨ä½¿ç”¨è¯»å†™åˆ†ç¦»ä¹‹å‰ï¼Œå¯ä»¥è€ƒè™‘å…¶ä»–æ–¹æ³•å¢åŠ Redisçš„è¯»è´Ÿè½½èƒ½åŠ›ï¼šå¦‚å°½é‡ä¼˜åŒ–ä¸»èŠ‚ç‚¹ï¼ˆå‡å°‘æ…¢æŸ¥è¯¢ã€å‡å°‘æŒä¹…åŒ–ç­‰å…¶ä»–æƒ…å†µå¸¦æ¥çš„é˜»å¡ç­‰ï¼‰æé«˜è´Ÿè½½èƒ½åŠ›ï¼›ä½¿ç”¨Redisé›†ç¾¤åŒæ—¶æé«˜è¯»è´Ÿè½½èƒ½åŠ›å’Œå†™è´Ÿè½½èƒ½åŠ›ç­‰ã€‚å¦‚æœä½¿ç”¨è¯»å†™åˆ†ç¦»ï¼Œå¯ä»¥ä½¿ç”¨å“¨å…µï¼Œä½¿ä¸»ä»èŠ‚ç‚¹çš„æ•…éšœåˆ‡æ¢å°½å¯èƒ½è‡ªåŠ¨åŒ–ï¼Œå¹¶å‡å°‘å¯¹åº”ç”¨ç¨‹åºçš„ä¾µå…¥ã€‚</p><h3 id="5-8-Redisé›†ç¾¤æ¨¡å¼â€”-å“¨å…µæœºåˆ¶ï¼ˆRedis-Sentinelï¼‰"><a href="#5-8-Redisé›†ç¾¤æ¨¡å¼â€”-å“¨å…µæœºåˆ¶ï¼ˆRedis-Sentinelï¼‰" class="headerlink" title="5.8 Redisé›†ç¾¤æ¨¡å¼â€” å“¨å…µæœºåˆ¶ï¼ˆRedis Sentinelï¼‰"></a>5.8 Redisé›†ç¾¤æ¨¡å¼â€” å“¨å…µæœºåˆ¶ï¼ˆRedis Sentinelï¼‰</h3><p>åœ¨ä¸Šæ–‡ä¸»ä»å¤åˆ¶çš„åŸºç¡€ä¸Šï¼Œå¦‚æœèŠ‚ç‚¹å‡ºç°æ•…éšœè¯¥æ€ä¹ˆåŠï¼Ÿåœ¨ Redis é›†ç¾¤ä¸­ï¼Œå“¨å…µæœºåˆ¶æ˜¯å®ç°ä¸»ä»åº“è‡ªåŠ¨åˆ‡æ¢çš„å…³é”®æœºåˆ¶ï¼Œå®ƒæœ‰æ•ˆçš„è§£å†³äº†ä¸»ä»å¤åˆ¶æ¨¡å¼ä¸‹çš„æ•…éšœè½¬ç§»çš„é—®é¢˜ã€‚å…¶ä¸Redis2.8ç‰ˆæœ¬å¼€å§‹å¼•ç”¨ã€‚</p><p><a href="https://xie.infoq.cn/article/f6a8c0c5218394d56f4ae329b">https://xie.infoq.cn/article/f6a8c0c5218394d56f4ae329b</a></p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779133444-1385070f-a6ee-4915-83e1-ec451d704df0-20250605100839770.png" alt="img"></p><p><strong>å“¨å…µæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹ï¼Œä½œä¸ºè¿›ç¨‹ï¼Œå®ƒä¼šç‹¬ç«‹è¿è¡Œå…¶åŸç†æ˜¯å“¨å…µé€šè¿‡å‘é€å‘½ä»¤ï¼Œç­‰å¾…RedisæœåŠ¡å™¨å“åº”ï¼Œä»è€Œç›‘æ§è¿è¡Œçš„å¤šä¸ª Redis å®ä¾‹</strong></p><p>å“¨å…µå®ç°äº†ä»€ä¹ˆåŠŸèƒ½å‘¢ï¼Ÿä¸‹é¢æ˜¯ Redis å®˜æ–¹æ–‡æ¡£çš„æè¿°ï¼š</p><ul><li><strong>ç›‘æ§ï¼ˆMonitoringï¼‰</strong>ï¼šå“¨å…µä¼šä¸æ–­åœ°æ£€æŸ¥ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹æ˜¯å¦è¿ä½œæ­£å¸¸ã€‚</li><li><strong>è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼ˆAutomatic failoverï¼‰</strong>ï¼šå½“ä¸»èŠ‚ç‚¹ä¸èƒ½æ­£å¸¸å·¥ä½œæ—¶ï¼Œå“¨å…µä¼šå¼€å§‹è‡ªåŠ¨æ•…éšœè½¬ç§»æ“ä½œï¼Œå®ƒä¼šå°†å¤±æ•ˆä¸»èŠ‚ç‚¹çš„å…¶ä¸­ä¸€ä¸ªä»èŠ‚ç‚¹å‡çº§ä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ï¼Œå¹¶è®©å…¶ä»–ä»èŠ‚ç‚¹æ”¹ä¸ºå¤åˆ¶æ–°çš„ä¸»èŠ‚ç‚¹ã€‚</li><li><strong>é…ç½®æä¾›è€…ï¼ˆConfiguration providerï¼‰</strong>ï¼šå®¢æˆ·ç«¯åœ¨åˆå§‹åŒ–æ—¶ï¼Œé€šè¿‡è¿æ¥å“¨å…µæ¥è·å¾—å½“å‰RedisæœåŠ¡çš„ä¸»èŠ‚ç‚¹åœ°å€ã€‚</li><li><strong>é€šçŸ¥ï¼ˆNotificationï¼‰</strong>ï¼šå“¨å…µå¯ä»¥å°†æ•…éšœè½¬ç§»çš„ç»“æœå‘é€ç»™å®¢æˆ·ç«¯ã€‚</li></ul><p>å…¶ä¸­ï¼Œç›‘æ§å’Œè‡ªåŠ¨æ•…éšœè½¬ç§»åŠŸèƒ½ï¼Œä½¿å¾—å“¨å…µå¯ä»¥åŠæ—¶å‘ç°ä¸»èŠ‚ç‚¹æ•…éšœå¹¶å®Œæˆè½¬ç§»ï¼›è€Œé…ç½®æä¾›è€…å’Œé€šçŸ¥åŠŸèƒ½ï¼Œåˆ™éœ€è¦åœ¨ä¸å®¢æˆ·ç«¯çš„äº¤äº’ä¸­æ‰èƒ½ä½“ç°ã€‚</p><h4 id="5-8-1-å“¨å…µé›†ç¾¤çš„æ­å»º"><a href="#5-8-1-å“¨å…µé›†ç¾¤çš„æ­å»º" class="headerlink" title="5.8.1 å“¨å…µé›†ç¾¤çš„æ­å»º"></a>5.8.1 å“¨å…µé›†ç¾¤çš„æ­å»º</h4><p>ä¸Šå›¾ä¸­å“¨å…µé›†ç¾¤å¼å¦‚ä½•ç»„å»ºèµ·æ¥çš„ï¼Ÿå“¨å…µå®ä¾‹ä¹‹é—´ç›¸äº’å‘ç°ï¼Œè¦å½’åŠŸäº Redis æä¾›çš„ pub&#x2F;sub æœºåˆ¶ï¼Œå³ å‘å¸ƒ&#x2F;è®¢é˜…æœºåˆ¶</p><p>åœ¨ä¸»ä»é›†ç¾¤ä¸­ï¼Œä¸»åº“ä¸Šç”±ä¸€ä¸ªåä¸º <strong>sentinel</strong>:hello çš„é¢‘é“ï¼Œä¸åŒå“¨å…µå°±æ˜¯é€šè¿‡å®ƒæ¥ç›¸äº’å‘ç°ï¼Œå®ç°äº’ç›¸é€šä¿¡çš„ã€‚åœ¨ä¸‹å›¾ï¼Œå“¨å…µ1æŠŠè‡ªå·±çš„ IPï¼ˆ172.16.19.3ï¼‰å’Œç«¯å£ï¼ˆ26579ï¼‰å‘å¸ƒåˆ°__sentinel__:helloé¢‘é“ä¸Šï¼Œå“¨å…µ2å’Œ3è®¢é˜…äº†è¯¥é¢‘é“ã€‚é‚£ä¹ˆæ­¤æ—¶ï¼Œå“¨å…µ2å’Œ3å°±å¯ä»¥ä»è¿™ä¸ªé¢‘é“ç›´æ¥è·å–å“¨å…µ1çš„ IP åœ°å€å’Œç«¯å£å·ã€‚ç„¶åï¼Œå“¨å…µ2ã€3å¯ä»¥å’Œå“¨å…µ1å»ºç«‹ç½‘ç»œè¿æ¥ã€‚</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779137211-0ab99635-9d14-4bb2-a004-b883c255b4df-20250605100831797.jpeg" alt="img"></p><p>é€šè¿‡è¿™ä¸ªæ–¹å¼ï¼Œå“¨å…µ2ã€3ä¹Ÿå¯ä»¥å»ºç«‹ç½‘ç»œè¿æ¥ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå“¨å…µé›†ç¾¤å°±å½¢æˆäº†ã€‚å®ƒä»¬ç›¸äº’é—´å¯ä»¥é€šè¿‡ç½‘ç»œè¿æ¥è¿›è¡Œé€šä¿¡ï¼Œæ¯”å¦‚è¯´å¯¹ä¸»åº“æœ‰æ²¡æœ‰ä¸‹çº¿è¿™ä»¶äº‹å„¿è¿›è¡Œåˆ¤æ–­å’Œåå•†ã€‚</p><h4 id="5-8-2-å“¨å…µç›‘æ§-Redis-åº“"><a href="#5-8-2-å“¨å…µç›‘æ§-Redis-åº“" class="headerlink" title="5.8.2 å“¨å…µç›‘æ§ Redis åº“"></a>5.8.2 å“¨å…µç›‘æ§ Redis åº“</h4><p>å“¨å…µç›‘æ§ä»€ä¹ˆï¼Ÿå¹¶ä¸”å¦‚ä½•å®Œæˆç›‘æ§çš„ï¼Ÿ</p><p>è¿™æ˜¯ç”±å“¨å…µå‘ä¸»åº“å‘é€ INFOå‘½ä»¤å®Œæˆçš„ã€‚å¦‚ä¸‹å›¾ï¼Œå“¨å…µ2ç»™ä¸»åº“å‘é€ INFOå‘½ä»¤ï¼Œä¸»åº“æ¥å—åˆ°è¿™ä¸ªå‘½ä»¤åï¼Œå°±ä¼šæŠŠä»åº“åˆ—è¡¨è¿”å›ç»™å“¨å…µã€‚æ¥ç€ï¼Œå“¨å…µå°±å¯ä»¥æ ¹æ®ä»åº“åˆ—è¡¨ä¸­çš„è¿æ¥ä¿¡æ¯ï¼Œå’Œæ¯ä¸ªä»åº“å»ºç«‹è¿æ¥ï¼Œå¹¶åœ¨è¿™ä¸ªè¿æ¥ä¸ŠæŒç»­çš„å¯¹ä»åº“è¿›è¡Œç›‘æ§ã€‚å“¨å…µ1å’Œ3 å¯ä»¥é€šè¿‡ç›¸åŒçš„æ–¹æ³•å’Œä»åº“å»ºç«‹è¿æ¥ã€‚</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779137974-8096b7fe-4c89-4541-99ac-b892ab0c5489-20250605100826937.jpeg" alt="img"></p><p>å“¨å…µçš„å·¥ä½œå†…å®¹ï¼š</p><ul><li><strong>æ¯ä¸ª Sentinel ä»¥æ¯ç§’é’Ÿä¸€æ¬¡çš„é¢‘ç‡å‘å®ƒæ‰€çŸ¥çš„ Masterï¼ŒSlave ä»¥åŠå…¶ä»– Sentinel å®ä¾‹å‘é€ä¸€ä¸ª PING å‘½ä»¤</strong>ã€‚(<strong>å¿ƒè·³æœºåˆ¶</strong>)</li><li><strong>å¦‚æœä¸€ä¸ªå®ä¾‹ï¼ˆinstanceï¼‰è·ç¦»æœ€åä¸€æ¬¡æœ‰æ•ˆå›å¤ PING å‘½ä»¤çš„æ—¶é—´è¶…è¿‡ down-after-milliseconds é€‰é¡¹æ‰€æŒ‡å®šçš„å€¼ï¼Œ åˆ™è¿™ä¸ªå®ä¾‹ä¼šè¢« Sentinel æ ‡è®°ä¸ºä¸»è§‚ä¸‹çº¿</strong>ã€‚</li><li><strong>å¦‚æœä¸€ä¸ª Master è¢«æ ‡è®°ä¸ºä¸»è§‚ä¸‹çº¿ï¼Œåˆ™æ­£åœ¨ç›‘è§†è¿™ä¸ª Master çš„æ‰€æœ‰ Sentinel è¦ä»¥æ¯ç§’ä¸€æ¬¡çš„é¢‘ç‡ç¡®è®¤ Master çš„ç¡®è¿›å…¥äº†ä¸»è§‚ä¸‹çº¿çŠ¶æ€</strong>ã€‚ï¼ˆ<strong>ç¡®è®¤æŠ•ç¥¨ä¸‹çº¿</strong>ï¼‰</li><li><strong>å½“æœ‰è¶³å¤Ÿæ•°é‡çš„ Sentinelï¼ˆå¤§äºç­‰äºé…ç½®æ–‡ä»¶æŒ‡å®šçš„å€¼ï¼‰åœ¨æŒ‡å®šçš„æ—¶é—´èŒƒå›´å†…ç¡®è®¤ Master çš„ç¡®è¿›å…¥äº†ä¸»è§‚ä¸‹çº¿çŠ¶æ€ï¼Œ åˆ™ Master ä¼šè¢«æ ‡è®°ä¸ºå®¢è§‚ä¸‹çº¿</strong> ã€‚</li><li><strong>åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ æ¯ä¸ª Sentinel ä¼šä»¥æ¯ 10 ç§’ä¸€æ¬¡çš„é¢‘ç‡å‘å®ƒå·²çŸ¥çš„æ‰€æœ‰ Masterï¼ŒSlave å‘é€ INFO å‘½ä»¤</strong>ã€‚ï¼ˆåŒæ­¥æ•°æ®ï¼‰</li><li><strong>å½“ Master è¢« Sentinel æ ‡è®°ä¸ºå®¢è§‚ä¸‹çº¿æ—¶ï¼ŒSentinel å‘ä¸‹çº¿çš„ Master çš„æ‰€æœ‰ Slave å‘é€ INFO å‘½ä»¤çš„é¢‘ç‡ä¼šä» 10 ç§’ä¸€æ¬¡æ”¹ä¸ºæ¯ç§’ä¸€æ¬¡</strong>ã€‚</li><li><strong>è‹¥æ²¡æœ‰è¶³å¤Ÿæ•°é‡çš„ Sentinel åŒæ„ Master å·²ç»ä¸‹çº¿ï¼Œ Master çš„å®¢è§‚ä¸‹çº¿çŠ¶æ€å°±ä¼šè¢«ç§»é™¤</strong>ã€‚</li><li><strong>è‹¥ Master é‡æ–°å‘ Sentinel çš„ PING å‘½ä»¤è¿”å›æœ‰æ•ˆå›å¤ï¼Œ Master çš„ä¸»è§‚ä¸‹çº¿çŠ¶æ€å°±ä¼šè¢«ç§»é™¤</strong>ã€‚</li></ul><h4 id="5-8-3-ä¸»åº“ä¸‹çº¿çš„åˆ¤å®š"><a href="#5-8-3-ä¸»åº“ä¸‹çº¿çš„åˆ¤å®š" class="headerlink" title="5.8.3 ä¸»åº“ä¸‹çº¿çš„åˆ¤å®š"></a>5.8.3 ä¸»åº“ä¸‹çº¿çš„åˆ¤å®š</h4><p>å“¨å…µå¦‚ä½•åˆ¤æ–­ä¸»åº“å·²ç»ä¸‹çº¿äº†ï¼Ÿ</p><p>é¦–å…ˆè¦åŒºåˆ«ä¸¤ä¸ªæ¦‚å¿µï¼š</p><ul><li>ä¸»è§‚ä¸‹çº¿ï¼šä»»ä½•ä¸€ä¸ªå“¨å…µéƒ½æ˜¯å¯ä»¥ç›‘æ§æ¢æµ‹ï¼Œå¹¶ä½œå‡º Redis ä¸‹çº¿çš„åˆ¤æ–­</li><li>å®¢è§‚ä¸‹çº¿ï¼šæœ‰å“¨å…µé›†ç¾¤å…±åŒå†³å®š Redis èŠ‚ç‚¹æ˜¯å¦ä¸‹çº¿</li></ul><p>å½“æŸä¸ªå“¨å…µ åˆ¤æ–­ä¸»åº“ â€œä¸»è§‚ä¸‹çº¿â€åï¼Œå°±ä¼šç»™å…¶ä»–å“¨å…µå‘é€ is-master-down-by-addrå‘½ä»¤ã€‚æ¥ç€ï¼Œå…¶ä»–å“¨å…µä¼šæ ¹æ®è‡ªå·±å’Œä¸»åº“çš„è¿æ¥æƒ…å†µï¼Œåšå‡º Y æˆ– N çš„å“åº”ï¼ŒYç›¸å½“äºèµæˆç¥¨ï¼ŒNç›¸å½“äºåå¯¹ç¥¨ã€‚å¦‚æœèµæˆç¥¨æ•°æ˜¯å¤§äºç­‰äº å“¨å…µé…ç½®æ–‡ä»¶ä¸­çš„ quorum é…ç½®é¡¹ï¼ˆæ¯”å¦‚è¿™é‡Œå¦‚æœ quorum &#x3D; 2ï¼‰ï¼Œåˆ™å°±å¯ä»¥åˆ¤å®š ä¸»åº“å®¢è§‚ä¸‹çº¿äº†ã€‚</p><h4 id="5-8-4-å“¨å…µé›†ç¾¤çš„é€‰ä¸¾"><a href="#5-8-4-å“¨å…µé›†ç¾¤çš„é€‰ä¸¾" class="headerlink" title="5.8.4 å“¨å…µé›†ç¾¤çš„é€‰ä¸¾"></a>5.8.4 å“¨å…µé›†ç¾¤çš„é€‰ä¸¾</h4><p>åˆ¤æ–­å®Œä¸»åº“ä¸‹çº¿åï¼Œç”±å“ªä¸ªå“¨å…µèŠ‚ç‚¹æ¥æ‰§è¡Œä¸»ä»åˆ‡æ¢å‘¢ï¼Ÿè¿™é‡Œå°±éœ€è¦å“¨å…µé›†ç¾¤çš„é€‰ä¸¾æœºåˆ¶äº†</p><ul><li>ä¸ºä»€ä¹ˆå¿…ç„¶ä¼šå‡ºç° é€‰ä¸¾&#x2F;å…±è¯† æœºåˆ¶ï¼Ÿä¸ºäº†é¿å…å“¨å…µçš„å•ç‚¹æƒ…å†µå‘ç”Ÿï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªå“¨å…µçš„åˆ†å¸ƒå¼é›†ç¾¤ã€‚ä½œä¸ºåˆ†å¸ƒå¼é›†ç¾¤ï¼Œå¿…ç„¶æ¶‰åŠåˆ°å…±è¯†é—®é¢˜ï¼ˆå³é€‰ä¸¾é—®é¢˜ï¼‰</li><li>å“¨å…µçš„é€‰ä¸¾æœºåˆ¶æ˜¯ä»€ä¹ˆæ ·çš„?</li></ul><ol><li><ol><li><strong>å‘ç°ä¸»åº“å®¢è§‚ä¸‹çº¿çš„å“¨å…µèŠ‚ç‚¹ï¼ˆè¿™é‡Œç§°ä¸º Aï¼‰å‘æ¯ä¸ªå“¨å…µèŠ‚ç‚¹å‘é€å‘½ä»¤è¦æ±‚å¯¹æ–¹é€‰ä¸¾è‡ªå·±ä¸ºé¢†å¤´å“¨å…µï¼ˆleaderï¼‰</strong>ï¼›</li><li><strong>å¦‚æœç›®æ ‡å“¨å…µæ²¡æœ‰é€‰ä¸¾è¿‡å…¶ä»–äººï¼Œåˆ™åŒæ„å°† A é€‰ä¸¾ä¸ºé¢†å¤´å“¨å…µ</strong>ï¼›</li><li><strong>å¦‚æœ A å‘ç°æœ‰è¶…è¿‡åŠæ•°ä¸”è¶…è¿‡ quorum å‚æ•°å€¼çš„å“¨å…µèŠ‚ç‚¹åŒæ„é€‰è‡ªå·±æˆä¸ºé¢†å¤´å“¨å…µï¼Œåˆ™ A å“¨å…µæˆåŠŸé€‰ä¸¾ä¸ºé¢†å¤´å“¨å…µ</strong>ã€‚ã€<strong>sentinel é›†ç¾¤æ‰§è¡Œæ•…éšœè½¬ç§»æ—¶éœ€è¦é€‰ä¸¾ leaderï¼Œæ­¤æ—¶æ¶‰åŠåˆ° majorityï¼Œmajority ä»£è¡¨ sentinel é›†ç¾¤ä¸­å¤§éƒ¨åˆ† sentinel èŠ‚ç‚¹çš„ä¸ªæ•°ï¼Œåªæœ‰å¤§äºç­‰äº max(quorum, majority) ä¸ªèŠ‚ç‚¹ç»™æŸä¸ª sentinel èŠ‚ç‚¹æŠ•ç¥¨ï¼Œæ‰èƒ½ç¡®å®šè¯¥ sentinel èŠ‚ç‚¹ä¸º leaderï¼Œmajority çš„è®¡ç®—æ–¹å¼ä¸ºï¼šnum(sentinels) &#x2F; 2 + 1</strong>ã€‘</li><li><strong>å½“æœ‰å¤šä¸ªå“¨å…µèŠ‚ç‚¹åŒæ—¶å‚ä¸é¢†å¤´å“¨å…µé€‰ä¸¾æ—¶ï¼Œå‡ºç°æ²¡æœ‰ä»»ä½•èŠ‚ç‚¹å½“é€‰å¯èƒ½ï¼Œæ­¤æ—¶æ¯ä¸ªå‚é€‰èŠ‚ç‚¹ç­‰å¾…ä¸€ä¸ªéšæœºæ—¶é—´è¿›è¡Œä¸‹ä¸€è½®é€‰ä¸¾ï¼Œç›´åˆ°é€‰å‡ºé¢†å¤´å“¨å…µ</strong>ã€‚</li></ol></li></ol><ul><li><p>ä»»ä½•ä¸€ä¸ªæƒ³è¦ æ‰§è¡Œ ä¸»ä»åˆ‡æ¢æ“ä½œçš„ å“¨å…µï¼Œè¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š</p></li><li><ul><li>ç¬¬ä¸€ï¼Œæ‹¿åˆ°åŠæ•°ä»¥ä¸Šçš„èµæˆç¥¨ï¼›</li><li>ç¬¬äºŒï¼Œæ‹¿åˆ°çš„ç¥¨æ•°åŒæ—¶è¿˜éœ€è¦å¤§äºç­‰äºå“¨å…µé…ç½®æ–‡ä»¶ä¸­çš„ quorum å€¼ã€‚</li></ul></li></ul><p>ä»¥3ä¸ªå“¨å…µä¸ºä¾‹ï¼Œå‡è®¾æ­¤æ—¶çš„ quorum è®¾ç½®ä¸º2ï¼Œé‚£ä¹ˆï¼Œä»»ä½•ä¸€ä¸ªæƒ³æˆä¸º Leader çš„å“¨å…µåªè¦æ‹¿åˆ° 2å¼ èµæˆç¥¨ï¼Œå°±å¯ä»¥äº†ã€‚</p><p>æ›´è¿›ä¸€æ­¥ç†è§£</p><p>è¿™é‡Œå¾ˆå¤šäººä¼šææ·· åˆ¤å®šå®¢è§‚ä¸‹çº¿ å’Œ æ˜¯å¦èƒ½å¤Ÿä¸»ä»åˆ‡æ¢ï¼ˆç”¨åˆ°é€‰ä¸¾æœºåˆ¶ï¼‰ ä¸¤ä¸ªæ¦‚å¿µï¼Œæˆ‘ä»¬å†çœ‹ä¸€ä¸ªä¾‹å­ã€‚</p><p>Redis 1ä¸»4ä»ï¼Œ5ä¸ªå“¨å…µï¼Œå“¨å…µé…ç½®quorumä¸º2ï¼Œå¦‚æœ3ä¸ªå“¨å…µæ•…éšœï¼Œå½“ä¸»åº“å®•æœºæ—¶ï¼Œå“¨å…µèƒ½å¦åˆ¤æ–­ä¸»åº“â€œå®¢è§‚ä¸‹çº¿â€ï¼Ÿèƒ½å¦è‡ªåŠ¨åˆ‡æ¢</p><p>ç»è¿‡å®é™…æµ‹è¯•ï¼š</p><p>1ã€å“¨å…µé›†ç¾¤å¯ä»¥åˆ¤å®šä¸»åº“â€œä¸»è§‚ä¸‹çº¿â€ã€‚ç”±äºquorum&#x3D;2ï¼Œæ‰€ä»¥å½“ä¸€ä¸ªå“¨å…µåˆ¤æ–­ä¸»åº“â€œä¸»è§‚ä¸‹çº¿â€åï¼Œè¯¢é—®å¦å¤–ä¸€ä¸ªå“¨å…µåä¹Ÿä¼šå¾—åˆ°åŒæ ·çš„ç»“æœï¼Œ2ä¸ªå“¨å…µéƒ½åˆ¤å®šâ€œä¸»è§‚ä¸‹çº¿â€ï¼Œè¾¾åˆ°äº†quorumçš„å€¼ï¼Œå› æ­¤ï¼Œ<strong>å“¨å…µé›†ç¾¤å¯ä»¥åˆ¤å®šä¸»åº“ä¸ºâ€œå®¢è§‚ä¸‹çº¿â€</strong>ã€‚</p><p>2ã€<strong>ä½†å“¨å…µä¸èƒ½å®Œæˆä¸»ä»åˆ‡æ¢</strong>ã€‚å“¨å…µæ ‡è®°ä¸»åº“â€œå®¢è§‚ä¸‹çº¿åâ€ï¼Œåœ¨é€‰ä¸¾â€œå“¨å…µé¢†å¯¼è€…â€æ—¶ï¼Œä¸€ä¸ªå“¨å…µå¿…é¡»æ‹¿åˆ°è¶…è¿‡å¤šæ•°çš„é€‰ç¥¨(5&#x2F;2+1&#x3D;3ç¥¨)ã€‚ä½†ç›®å‰åªæœ‰2ä¸ªå“¨å…µæ´»ç€ï¼Œæ— è®ºæ€ä¹ˆæŠ•ç¥¨ï¼Œä¸€ä¸ªå“¨å…µæœ€å¤šåªèƒ½æ‹¿åˆ°2ç¥¨ï¼Œæ°¸è¿œæ— æ³•è¾¾åˆ°N&#x2F;2+1é€‰ç¥¨çš„ç»“æœã€‚</p><h4 id="5-8-5-æ–°ä¸»åº“çš„é€‰å‡ºã€æ•…éšœè½¬ç§»"><a href="#5-8-5-æ–°ä¸»åº“çš„é€‰å‡ºã€æ•…éšœè½¬ç§»" class="headerlink" title="5.8.5 æ–°ä¸»åº“çš„é€‰å‡ºã€æ•…éšœè½¬ç§»"></a>5.8.5 æ–°ä¸»åº“çš„é€‰å‡ºã€æ•…éšœè½¬ç§»</h4><p>ä¸»åº“æ—¢ç„¶åˆ¤å®šå®¢è§‚ä¸‹çº¿äº†ï¼Œå¹¶ä¸”é€‰ä¸¾å‡ºäº†é¢†å¤´å“¨å…µï¼Œé‚£ä¹ˆå¦‚ä½•ä»å‰©ä½™çš„ slaveèŠ‚ç‚¹ï¼ˆä»åº“ï¼‰ä¸­é€‰æ‹©ä¸€ä¸ªæ–°çš„ä¸»åº“å‘¢ï¼Ÿ</p><ul><li>è¿‡æ»¤æ‰ä¸å¥åº·çš„ï¼ˆä¸‹çº¿æˆ–æ–­çº¿ï¼‰ï¼Œæ²¡æœ‰å›å¤è¿‡å“¨å…µ ping å“åº”çš„ä»èŠ‚ç‚¹</li><li>é€‰æ‹© salve-priorityä»èŠ‚ç‚¹ä¼˜å…ˆçº§æœ€é«˜çš„ï¼ˆredis.confï¼‰</li><li>é€‰æ‹©å¤åˆ¶åç§»é‡æœ€å¤§ï¼ˆå³å¤åˆ¶ä¸»èŠ‚ç‚¹æœ€å®Œæ•´çš„ä»èŠ‚ç‚¹ï¼‰</li></ul><p>æ–°çš„ä¸»åº“é€‰æ‹©å‡ºæ¥äº†ï¼Œå°±å¯ä»¥å¼€å§‹è¿›è¡Œæ•…éšœçš„è½¬ç§»äº†</p><p>å‡è®¾æ ¹æ®æˆ‘ä»¬ä¸€å¼€å§‹çš„å›¾ï¼šï¼ˆæˆ‘ä»¬å‡è®¾ï¼šåˆ¤æ–­ä¸»åº“å®¢è§‚ä¸‹çº¿äº†ï¼ŒåŒæ—¶é€‰å‡ºsentinel 3æ˜¯å“¨å…µleaderï¼‰</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779138232-d32bebb3-1e76-46dc-86d6-36e088a21802-20250605100820125.png" alt="img"></p><p><strong>æ•…éšœè½¬ç§»æµç¨‹å¦‚ä¸‹</strong>ï¼š</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/35838370/1682779138529-f55bef09-55ec-4955-9c4d-5154ed2a03a3.png" alt="img"></p><p>å°†slave-1è„±ç¦»åŸä»èŠ‚ç‚¹ï¼ˆPS: 5.0 ä¸­åº”è¯¥æ˜¯replicaof no one)ï¼Œå‡çº§ä¸»èŠ‚ç‚¹ï¼Œ</p><p>å°†ä»èŠ‚ç‚¹slave-2æŒ‡å‘æ–°çš„ä¸»èŠ‚ç‚¹</p><p>é€šçŸ¥å®¢æˆ·ç«¯ä¸»èŠ‚ç‚¹å·²æ›´æ¢</p><p>å°†åŸä¸»èŠ‚ç‚¹ï¼ˆoldMasterï¼‰å˜æˆä»èŠ‚ç‚¹ï¼ŒæŒ‡å‘æ–°çš„ä¸»èŠ‚ç‚¹</p><h3 id="5-9-Redisé›†ç¾¤æ¨¡å¼-Redis-Clusterï¼ˆé«˜å¯ç”¨é›†ç¾¤ï¼‰"><a href="#5-9-Redisé›†ç¾¤æ¨¡å¼-Redis-Clusterï¼ˆé«˜å¯ç”¨é›†ç¾¤ï¼‰" class="headerlink" title="5.9 Redisé›†ç¾¤æ¨¡å¼-Redis Clusterï¼ˆé«˜å¯ç”¨é›†ç¾¤ï¼‰"></a>5.9 Redisé›†ç¾¤æ¨¡å¼-Redis Clusterï¼ˆé«˜å¯ç”¨é›†ç¾¤ï¼‰</h3><p>å‰é¢ä¸¤èŠ‚ï¼Œä¸»ä»å¤åˆ¶å’Œå“¨å…µæœºåˆ¶ä¿éšœäº†é«˜å¯ç”¨ï¼Œå°±è¯»å†™åˆ†ç¦»è€Œè¨€è™½ç„¶ slave èŠ‚ç‚¹æ‰©å±•äº†ä¸»ä»çš„è¯»å¹¶å‘èƒ½åŠ›ï¼Œä½†æ˜¯å†™èƒ½åŠ›å’Œå­˜å‚¨èƒ½åŠ›æ˜¯æ²¡æœ‰å¾—åˆ°æ‰©å±•ã€‚å¦‚æœé¢å¯¹æµ·é‡æ•°æ®å†™å…¥ï¼Œå°±å¿…é¡»æ„å»º masterï¼ˆä¸»èŠ‚ç‚¹åˆ†ç‰‡ï¼‰ä¹‹é—´çš„é›†ç¾¤ï¼ŒåŒæ—¶å¿…ç„¶éœ€è¦å¸æ”¶é«˜å¯ç”¨ï¼ˆä¸»ä»å¤åˆ¶å’Œå“¨å…µæœºåˆ¶ï¼‰èƒ½åŠ›ï¼Œå³æ¯ä¸ª master åˆ†ç‰‡èŠ‚ç‚¹è¿˜éœ€è¦ç”± slave èŠ‚ç‚¹ã€‚è¿™æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å…¸å‹çš„çºµå‘æ‰©å±•ï¼ˆé›†ç¾¤çš„åˆ†ç‰‡æŠ€æœ¯ï¼‰</p><p>Redis Clusteræ˜¯ä¸€ç§æœåŠ¡å™¨ShardingæŠ€æœ¯(åˆ†ç‰‡å’Œè·¯ç”±éƒ½æ˜¯åœ¨æœåŠ¡ç«¯å®ç°)ï¼Œé‡‡ç”¨å¤šä¸»å¤šä»ï¼Œæ¯ä¸€ä¸ªåˆ†åŒºéƒ½æ˜¯ç”±ä¸€ä¸ªRedisä¸»æœºå’Œå¤šä¸ªä»æœºç»„æˆï¼Œç‰‡åŒºå’Œç‰‡åŒºä¹‹é—´æ˜¯ç›¸äº’å¹³è¡Œçš„ã€‚Redis Clusteré›†ç¾¤é‡‡ç”¨äº†P2Pçš„æ¨¡å¼ï¼Œå®Œå…¨å»ä¸­å¿ƒåŒ–ã€‚</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779161866-f0c18226-fd15-433e-9084-a07940689300-20250605100812167.jpeg" alt="img"></p><p>å¦‚ä¸Šå›¾ï¼Œå®˜æ–¹æ¨èï¼Œé›†ç¾¤éƒ¨ç½²è‡³å°‘è¦ 3 å°ä»¥ä¸Šçš„masterèŠ‚ç‚¹ï¼Œå¥½ä½¿ç”¨ 3 ä¸» 3 ä»å…­ä¸ªèŠ‚ç‚¹çš„æ¨¡å¼ã€‚Redis Clusteré›†ç¾¤å…·æœ‰å¦‚ä¸‹å‡ ä¸ªç‰¹ç‚¹ï¼š</p><ul><li>é›†ç¾¤å®Œå…¨å»ä¸­å¿ƒåŒ–ï¼Œé‡‡ç”¨å¤šä¸»å¤šä»ï¼›æ‰€æœ‰çš„redisèŠ‚ç‚¹å½¼æ­¤äº’è”(PING-PONGæœºåˆ¶)ï¼Œå†…éƒ¨ä½¿ç”¨äºŒè¿›åˆ¶åè®®ä¼˜åŒ–ä¼ è¾“é€Ÿåº¦å’Œå¸¦å®½ã€‚</li><li>å®¢æˆ·ç«¯ä¸ Redis èŠ‚ç‚¹ç›´è¿ï¼Œä¸éœ€è¦ä¸­é—´ä»£ç†å±‚ã€‚å®¢æˆ·ç«¯ä¸éœ€è¦è¿æ¥é›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹ï¼Œè¿æ¥é›†ç¾¤ä¸­ä»»ä½•ä¸€ä¸ªå¯ç”¨èŠ‚ç‚¹å³å¯ã€‚</li><li>æ¯ä¸€ä¸ªåˆ†åŒºéƒ½æ˜¯ç”±ä¸€ä¸ªRedisä¸»æœºå’Œå¤šä¸ªä»æœºç»„æˆï¼Œåˆ†ç‰‡å’Œåˆ†ç‰‡ä¹‹é—´æ˜¯ç›¸äº’å¹³è¡Œçš„ã€‚</li><li>æ¯ä¸€ä¸ªmasterèŠ‚ç‚¹è´Ÿè´£ç»´æŠ¤ä¸€éƒ¨åˆ†æ§½ï¼Œä»¥åŠæ§½æ‰€æ˜ å°„çš„é”®å€¼æ•°æ®ï¼›é›†ç¾¤ä¸­æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰å…¨é‡çš„æ§½ä¿¡æ¯ï¼Œé€šè¿‡æ§½æ¯ä¸ªnodeéƒ½çŸ¥é“å…·ä½“æ•°æ®å­˜å‚¨åˆ°å“ªä¸ªnodeä¸Šã€‚</li></ul><h4 id="5-9-1-å“ˆå¸Œæ§½"><a href="#5-9-1-å“ˆå¸Œæ§½" class="headerlink" title="5.9.1 å“ˆå¸Œæ§½"></a>5.9.1 å“ˆå¸Œæ§½</h4><p>Redis-cluster æ²¡æœ‰ä½¿ç”¨ä¸€è‡´æ€§ hashï¼Œè€Œæ˜¯å¼•å…¥äº† å“ˆå¸Œæ§½çš„æ¦‚å¿µã€‚ Redis-cluster ä¸­æœ‰ 16384ï¼ˆ2çš„14æ¬¡æ–¹ï¼‰ä¸ªå“ˆå¸Œæ§½ï¼Œæ¯ä¸ª key é€šè¿‡ CRC16æ ¡éªŒåå¯¹ 16383å–æ¨¡ æ¥å†³å®šæ”¾ç½®åœ¨å“ªä¸ªæ§½ã€‚Cluster ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£ä¸€éƒ¨åˆ†æ§½ï¼ˆhash slotï¼‰ã€ä¸€è‡´æ€§hashåœ¨ç®—æ³•ç« èŠ‚è¯´ã€‘</p><p>æ¯”å¦‚é›†ç¾¤ä¸­å­˜åœ¨ä¸‰ä¸ªèŠ‚ç‚¹ï¼Œåˆ™å¯èƒ½å­˜åœ¨ä¸‹é¢ç±»ä¼¼åˆ†é…ï¼š</p><ul><li>èŠ‚ç‚¹ A åŒ…å«0åˆ°5500å· å“ˆå¸Œæ§½</li><li>èŠ‚ç‚¹ B åŒ…å« 5501åˆ°11000å· å“ˆå¸Œæ§½</li><li>èŠ‚ç‚¹ C åŒ…å« 11001åˆ°16384 å“ˆå¸Œæ§½</li></ul><p>å“ˆå¸Œæ§½&#x3D;CRC16(key) % 16384ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥ å“ˆå¸Œæ§½&#x3D;CRC16(key)ï¼Ÿè¿™æ ·å°±å¯ä»¥æœ‰ 2^16ä¸ªå€¼ã€‚</p><p>è¿™æ˜¯å› ä¸ºredisèŠ‚ç‚¹å‘é€å¿ƒè·³åŒ…æ—¶ï¼Œéœ€è¦å°†æ‰€æœ‰çš„æ§½æ”¾åˆ°è¿™ä¸ªå¿ƒè·³åŒ…ã€‚å¦‚æœslots&#x3D;2^16ï¼Œéœ€å ç”¨ç©ºé—´ &#x3D; 2^16 &#x2F; 8 &#x2F; 1024 &#x3D; 8KBã€‚è€Œ slots&#x3D;16384 åªå ç”¨ 2KBã€‚å¹¶ä¸”ä¸€èˆ¬æƒ…å†µä¸‹ Redis Cluster é›†ç¾¤ä¸»èŠ‚ç‚¹æ•°é‡åŸºæœ¬ä¸å¯èƒ½è¶…è¿‡1000ä¸ªï¼Œè¶…è¿‡1000ä¸ªä¸€èˆ¬ä¼šå¯¼è‡´ç½‘ç»œå µå¡ã€‚ã€‚å¦‚æœslotsæ›´å°‘ï¼Œè™½ç„¶èƒ½è¿›ä¸€æ­¥é™ä½å¿ƒè·³åŒ…å¤§å°ï¼Œä½†æ˜¯ ä¼šæ›´å®¹æ˜“å‡ºç°ç¢°æ’æ¦‚ç‡ï¼ˆå‘½ä¸­å¤±æ•ˆï¼‰ã€‚æ‰€ä»¥ slots &#x3D; 16384 æ¯”è¾ƒåˆç†</p><h4 id="5-9-2-Key-Hash-Tags"><a href="#5-9-2-Key-Hash-Tags" class="headerlink" title="5.9.2 Key Hash Tags"></a>5.9.2 Key Hash Tags</h4><p>å› ä¸º key åˆ†å¸ƒåœ¨ä¸åŒèŠ‚ç‚¹ï¼Œæ‰€ä»¥ Multi-Key æ“ä½œå°±ä¼šå—é™ã€‚å®é™…åœºæ™¯æ¯”å¦‚ï¼š</p><ul><li>SUNIONã€msetã€mgetï¼Œè¿™ç±»å‘½ä»¤ä¼šæ“ä½œå¤šä¸ªkey</li><li>äº‹åŠ¡ï¼Œåœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ä¼šæ“ä½œå¤šä¸ªkey</li><li>LUAè„šæœ¬ï¼Œåœ¨LUAè„šæœ¬ä¸­ä¹Ÿä¼šæ“ä½œå¤šä¸ªkey</li></ul><p>Hash Tags æä¾›äº†ä¸€ç§é€”å¾„ï¼Œç”¨æ¥å°†å¤šä¸ªï¼ˆkeyï¼‰åˆ†é…åˆ°ç›¸åŒçš„ hash slot ä¸­ã€‚è¿™æ—¶ Redis Clusterä¸­å®ç° multi-key æ“ä½œçš„åŸºç¡€ã€‚</p><ul><li>keyåŒ…å«ä¸€ä¸ª{å­—ç¬¦</li><li>å¹¶ä¸” å¦‚æœåœ¨è¿™ä¸ª{çš„å³é¢æœ‰ä¸€ä¸ª}å­—ç¬¦</li><li>å¹¶ä¸” å¦‚æœåœ¨{å’Œ}ä¹‹é—´å­˜åœ¨è‡³å°‘ä¸€ä¸ªå­—ç¬¦</li></ul><p>ä¾‹å¦‚ï¼š</p><ul><li>{user1000}.followingå’Œ{user1000}.followersè¿™ä¸¤ä¸ªkeyä¼šè¢«hashåˆ°ç›¸åŒçš„hash slotä¸­ï¼Œå› ä¸ºåªæœ‰user1000ä¼šè¢«ç”¨æ¥è®¡ç®—hash slotå€¼ã€‚</li><li>foo{}{bar}è¿™ä¸ªkeyä¸ä¼šå¯ç”¨hash tagå› ä¸ºç¬¬ä¸€ä¸ª{å’Œ}ä¹‹é—´æ²¡æœ‰å­—ç¬¦ã€‚</li><li>foozapè¿™ä¸ªkeyä¸­å…¨éƒ¨å†…å®¹ä¼šè¢«ç”¨æ¥è®¡ç®—hash slot</li><li>foo{bar}{zap}è¿™ä¸ªkeyä¸­çš„barä¼šè¢«ç”¨æ¥è®¡ç®—è®¡ç®—hash slotï¼Œè€Œzapä¸ä¼š</li></ul><h4 id="5-9-3-è¯·æ±‚é‡å®šå‘"><a href="#5-9-3-è¯·æ±‚é‡å®šå‘" class="headerlink" title="5.9.3 è¯·æ±‚é‡å®šå‘"></a>5.9.3 è¯·æ±‚é‡å®šå‘</h4><p>Redis cluster é‡‡ç”¨å»ä¸­å¿ƒåŒ–çš„æ¶æ„ï¼Œé›†ç¾¤çš„ä¸»èŠ‚ç‚¹å„è‡ªè´Ÿè´£ä¸€éƒ¨åˆ†æ§½ï¼Œå®¢æˆ·ç«¯å¦‚ä½•ç¡®å®š key åˆ°åº•ä¼šæ˜ å°„åˆ° å“ªä¸ªèŠ‚ç‚¹ä¸Šå‘¢ï¼Ÿè¿™å°±æ¶‰åŠåˆ°è¯·æ±‚é‡å®šå‘</p><p>åœ¨ Cluster æ¨¡å¼ä¸‹ï¼ŒèŠ‚ç‚¹å¯¹è¯·æ±‚çš„å¤„ç†è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol><li>æ£€æŸ¥å½“å‰ key æ˜¯å¦å­˜åœ¨äº å½“å‰ node</li></ol><ul><li><ul><li>é€šè¿‡keyæœ‰æ•ˆéƒ¨åˆ†ä½¿ç”¨ CRC16å‡½æ•°è®¡ç®—æ•£åˆ—å€¼ï¼Œå†å¯¹16384 å–ä½™ï¼Œè®¡ç®—å‡º slot çš„ç¼–å·ã€‚</li><li>Redisè®¡ç®—å¾—åˆ°é”®å¯¹åº”çš„æ§½åï¼Œéœ€è¦æŸ¥æ‰¾æ§½æ‰€å¯¹åº”çš„èŠ‚ç‚¹ã€‚é›†ç¾¤å†…é€šè¿‡æ¶ˆæ¯äº¤æ¢æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šçŸ¥é“æ‰€æœ‰èŠ‚ç‚¹çš„æ§½ä¿¡æ¯ã€‚ä»è€Œå¾—åˆ°è´Ÿè´£è¯¥æ§½çš„ èŠ‚ç‚¹æŒ‡é’ˆã€‚</li></ul></li></ul><ol><li>è‹¥ slot ä¸æ˜¯ç”±è‡ªèº«è´Ÿè´£ï¼Œåˆ™è¿”å› MOVED é‡å®šå‘ã€‚</li><li>è‹¥ slot ç”±è‡ªèº«è´Ÿè´£ï¼Œä¸” key åœ¨ slot ä¸­ï¼Œåˆ™è¿”å›è¯¥ key å¯¹åº”ç»“æœã€‚</li><li>è‹¥ key ä¸å­˜åœ¨æ­¤ slotä¸­ï¼Œæ£€æŸ¥è¯¥ slot æ˜¯å¦æ­£åœ¨è¿å‡ºï¼ˆMIGRATINGï¼‰ï¼Ÿ</li><li>slot æ­£åœ¨è¿å‡ºï¼Œè¿”å› ASKé”™è¯¯é‡å®šå‘å®¢æˆ·ç«¯åˆ° è¿ç§»çš„ç›®çš„æœåŠ¡å™¨ä¸Š</li><li>è‹¥ slot æœªè¿å‡ºï¼Œæ£€æŸ¥ slot æ˜¯å¦åœ¨å¯¼å…¥ä¸­ ï¼Ÿ</li><li>è‹¥ slot å¯¼å…¥ä¸­ä¸”ç”± ASKING æ ‡è®°ï¼Œåˆ™ç›´æ¥æ“ä½œ</li><li>å¦åˆ™è¿”å› MOVED é‡å®šå‘</li></ol><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779145349-c2ddfcdb-cc9b-4948-a6f2-00b3b740388c-20250605100802757.png" alt="img"></p><p>è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½æ¶‰åŠåˆ°ä¸¤ä¸ªé‡å®šå‘ï¼Œåˆ†åˆ«æ—¶ MOVEDé‡å®šå‘ã€ASKé‡å®šå‘</p><h5 id="MOVED-é‡å®šå‘"><a href="#MOVED-é‡å®šå‘" class="headerlink" title="MOVED é‡å®šå‘"></a>MOVED é‡å®šå‘</h5><p>é€šè¿‡è®¡ç®— key å’Œ æœ¬åœ° slot ç¼“å­˜ï¼Œå¾—åˆ°è´Ÿè´£ slot çš„èŠ‚ç‚¹ã€‚ä¸€èˆ¬å°±å»è¯·æ±‚äº†ï¼Œä½†æ˜¯å¯èƒ½æœ‰ä¸¤ç§æƒ…å†µï¼š</p><ul><li>æ§½å‘½ä¸­ï¼šç›´æ¥è¿”å›ç»“æœ</li><li>æ§½ä¸å‘½ä¸­ï¼šå³å½“å‰é”®å‘½ä»¤æ‰€è¯·æ±‚çš„é”® ä¸åœ¨å½“å‰è¯·æ±‚çš„èŠ‚ç‚¹ä¸­ï¼Œåˆ™å½“å‰èŠ‚ç‚¹ä¼šå‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ª MOVED é‡å®šå‘ã€‚å®¢æˆ·ç«¯æ ¹æ® MOVEDé‡å®šå‘æ‰€åŒ…å«çš„å†…å®¹æ‰¾åˆ°ç›®æ ‡èŠ‚ç‚¹ï¼Œå†ä¸€æ¬¡å‘é€å‘½ä»¤ã€‚redis-cliä¼šå¸®ä½ è‡ªåŠ¨é‡å®šå‘ï¼ˆå¦‚æœæ²¡æœ‰é›†ç¾¤æ–¹å¼å¯åŠ¨ï¼Œå³æ²¡åŠ å‚æ•° -cï¼Œredis-cliä¸ä¼šè‡ªåŠ¨é‡å®šå‘ï¼‰</li></ul><p>ç”±äºæœ¬åœ°ä¼šç¼“å­˜æ˜ å°„çš„å­˜åœ¨ï¼Œæ‰€ä»¥ç»å¤§éƒ¨åˆ†æ—¶å€™éƒ½ä¸ä¼šè§¦å‘ MOVEDï¼Œè€ŒMOVEDæ˜¯ç”¨æ¥ååŠ©å®¢æˆ·ç«¯æ›´æ–° slot-node æ˜ å°„ã€‚</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779141290-b93974ae-08a7-4639-88d8-fec2f75f06ed-20250605100753660.png" alt="img"></p><h5 id="ASK-é‡å®šå‘"><a href="#ASK-é‡å®šå‘" class="headerlink" title="ASK é‡å®šå‘"></a>ASK é‡å®šå‘</h5><p>é›†ç¾¤ä¼¸ç¼©æ—¶ï¼Œé›†ç¾¤ä¼¸ç¼©ä¼šå¯¼è‡´æ§½è¿ç§»ã€‚æ§½è¿ç§»è¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ªæ§½å†…çš„key ä¼šåˆ†ä¸ºå¤šä¸ªæ‰¹æ¬¡ï¼Œä¾æ¬¡è¿ç§»ã€‚æ‰€ä»¥å­˜åœ¨ï¼Œä¸€éƒ¨åˆ†æ•°æ®åœ¨æºèŠ‚ç‚¹ï¼Œä¸€èˆ¬éƒ¨åˆ†æ•°æ®åœ¨è¿ç§»çš„ç›®æ ‡èŠ‚ç‚¹ã€‚ASKé‡å®šå‘ç”±æ­¤è¯ç”Ÿ</p><p>å‡ºç°ä¸Šè¿°æƒ…å†µï¼Œå®¢æˆ·ç«¯çš„å‘½ä»¤æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>å®¢æˆ·ç«¯æ ¹æ®æœ¬åœ° slot ç¼“å­˜å‘é€å‘½ä»¤åˆ°æºèŠ‚ç‚¹ï¼Œå¦‚æœå­˜åœ¨ é”®å¯¹è±¡ åˆ™ç›´æ¥æ‰§è¡Œå¹¶è¿”å›ç»“æœç»™å®¢æˆ·ç«¯ã€‚</li><li>å¦‚æœé”®å¯¹è±¡ä¸å­˜åœ¨ï¼Œåˆ™å¯èƒ½å­˜åœ¨äºç›®æ ‡èŠ‚ç‚¹ã€‚è¿™æ—¶æºèŠ‚ç‚¹ä¼šå›å¤ ASK é‡å®šå‘å¼‚å¸¸ã€‚æ ¼å¼å¦‚ä¸‹ï¼šï¼ˆerrorï¼‰ASK{slot}{targetIP}ï¼š{targetPort}</li><li>å®¢æˆ·ç«¯ä» ASK é‡å®šå‘å¼‚å¸¸ä¸­ æå–ç›®æ ‡èŠ‚ç‚¹ä¿¡æ¯ï¼Œå‘é€ askingå‘½ä»¤åˆ°ç›®æ ‡èŠ‚ç‚¹æ‰“å¼€å®¢æˆ·ç«¯è¿æ¥æ ‡è¯†ï¼Œå†æ‰§è¡Œé”®å‘½ä»¤ã€‚å¦‚æœå­˜åœ¨åˆ™æ‰§ï¼Œä¸å­˜åœ¨åˆ™è¿”å›ä¸å­˜åœ¨ä¿¡æ¯ã€‚</li></ol><h5 id="ä¸¤è€…çš„åŒºåˆ«"><a href="#ä¸¤è€…çš„åŒºåˆ«" class="headerlink" title="ä¸¤è€…çš„åŒºåˆ«"></a>ä¸¤è€…çš„åŒºåˆ«</h5><p>ASKä¸MOVEDè™½ç„¶éƒ½æ˜¯å¯¹å®¢æˆ·ç«¯çš„é‡å®šå‘æ§åˆ¶ï¼Œä½†æ˜¯æœ‰ç€æœ¬è´¨åŒºåˆ«ã€‚ASK é‡å®šå‘è¯´æ˜é›†ç¾¤æ­£åœ¨è¿›è¡Œslotæ•°æ®è¿ç§»ï¼Œå®¢æˆ·ç«¯æ— æ³•çŸ¥é“ä»€ä¹ˆæ—¶å€™è¿ç§»å®Œæˆï¼Œå› æ­¤åªèƒ½æ˜¯<strong>ä¸´æ—¶æ€§çš„é‡å®šå‘</strong>ï¼Œå®¢æˆ·ç«¯<strong>ä¸ä¼šæ›´æ–°slotsç¼“å­˜</strong>ã€‚ä½†æ˜¯MOVEDé‡å®šå‘è¯´æ˜é”®å¯¹åº”çš„æ§½å·²ç»æ˜ç¡®æŒ‡å®šåˆ°æ–°çš„èŠ‚ç‚¹ï¼Œå› æ­¤<strong>éœ€è¦æ›´æ–°slotsç¼“å­˜</strong>ã€‚</p><h4 id="5-9-4-æ•…éšœè½¬ç§»"><a href="#5-9-4-æ•…éšœè½¬ç§»" class="headerlink" title="5.9.4 æ•…éšœè½¬ç§»"></a>5.9.4 æ•…éšœè½¬ç§»</h4><p>Redisé›†ç¾¤è‡ªèº«å®ç°äº†é«˜å¯ç”¨ã€‚é«˜å¯ç”¨é¦–å…ˆéœ€è¦è§£å†³é›†ç¾¤éƒ¨åˆ†å¤±è´¥çš„åœºæ™¯ï¼šå½“é›†ç¾¤å†…å°‘é‡èŠ‚ç‚¹å‡ºç°æ•…éšœæ—¶é€šè¿‡è‡ªåŠ¨æ•…éšœè½¬ç§»ä¿è¯é›†ç¾¤å¯ä»¥æ­£å¸¸å¯¹å¤–æä¾›æœåŠ¡ã€‚</p><p>Redisé›†ç¾¤å†…èŠ‚ç‚¹é€šè¿‡ping&#x2F;pongæ¶ˆæ¯å®ç°èŠ‚ç‚¹é€šä¿¡ï¼Œæ¶ˆæ¯ä¸ä½†å¯ä»¥ä¼ æ’­èŠ‚ç‚¹æ§½ä¿¡æ¯ï¼Œè¿˜å¯ä»¥ä¼ æ’­å…¶ä»–çŠ¶æ€å¦‚ï¼šä¸»ä»çŠ¶æ€ã€èŠ‚ç‚¹æ•…éšœç­‰ã€‚å› æ­¤æ•…éšœå‘ç°ä¹Ÿæ˜¯é€šè¿‡æ¶ˆæ¯ä¼ æ’­æœºåˆ¶å®ç°çš„ï¼Œä¸»è¦ç¯èŠ‚åŒ…æ‹¬ï¼šä¸»è§‚ä¸‹çº¿ï¼ˆpfailï¼‰å’Œå®¢è§‚ä¸‹çº¿ï¼ˆfailï¼‰ã€‚</p><p>ä¸»è§‚ä¸‹çº¿æµç¨‹ï¼š</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779141957-c4410066-51a8-40ed-9ae8-f17118aaa5fd-20250605100742339.png" alt="img"></p><p>å½“æŸä¸ªèŠ‚ç‚¹åˆ¤æ–­å¦ä¸€ä¸ªèŠ‚ç‚¹ä¸»è§‚ä¸‹çº¿åï¼Œç›¸åº”çš„èŠ‚ç‚¹çŠ¶æ€ä¼šè·Ÿéšæ¶ˆæ¯åœ¨é›†ç¾¤å†…ä¼ æ’­ã€‚ping&#x2F;pongæ¶ˆæ¯çš„æ¶ˆæ¯ä½“ä¼šæºå¸¦é›†ç¾¤1&#x2F;10çš„å…¶ä»–èŠ‚ç‚¹çŠ¶æ€æ•°æ®ï¼Œå½“æ¥å—èŠ‚ç‚¹å‘ç°æ¶ˆæ¯ä½“ä¸­å«æœ‰ä¸»è§‚ä¸‹çº¿çš„èŠ‚ç‚¹çŠ¶æ€æ—¶ï¼Œä¼šåœ¨æœ¬åœ°æ‰¾åˆ°æ•…éšœèŠ‚ç‚¹çš„ClusterNodeç»“æ„ï¼Œä¿å­˜åˆ°<strong>ä¸‹çº¿æŠ¥å‘Šé“¾è¡¨</strong>ä¸­ã€‚</p><p>é€šè¿‡Gossipæ¶ˆæ¯ä¼ æ’­ï¼Œé›†ç¾¤å†…èŠ‚ç‚¹ä¸æ–­æ”¶é›†åˆ°æ•…éšœèŠ‚ç‚¹çš„ä¸‹çº¿æŠ¥å‘Šã€‚å½“<strong>åŠæ•°ä»¥ä¸Š</strong>æŒæœ‰æ§½çš„ä¸»èŠ‚ç‚¹éƒ½æ ‡è®°æŸä¸ªèŠ‚ç‚¹æ˜¯ä¸»è§‚ä¸‹çº¿æ—¶ï¼Œè§¦å‘å®¢è§‚ä¸‹çº¿æµç¨‹ã€‚</p><p><strong>æ•…éšœæ¢å¤</strong></p><p>æ•…éšœèŠ‚ç‚¹å˜ä¸ºå®¢è§‚ä¸‹çº¿åï¼Œå¦‚æœä¸‹çº¿èŠ‚ç‚¹æ˜¯æŒæœ‰æ§½çš„ä¸»èŠ‚ç‚¹åˆ™éœ€è¦åœ¨å®ƒçš„<strong>ä»èŠ‚ç‚¹</strong>ä¸­é€‰å‡ºä¸€ä¸ªæ›¿æ¢å®ƒï¼Œä»è€Œä¿è¯é›†ç¾¤çš„é«˜å¯ç”¨ã€‚ä¸‹çº¿ä¸»èŠ‚ç‚¹çš„æ‰€æœ‰ä»èŠ‚ç‚¹æ‰¿æ‹…æ•…éšœæ¢å¤çš„ä¹‰åŠ¡ï¼Œå½“ä»èŠ‚ç‚¹é€šè¿‡å†…éƒ¨å®šæ—¶ä»»åŠ¡å‘ç°è‡ªèº«å¤åˆ¶çš„ä¸»èŠ‚ç‚¹è¿›å…¥å®¢è§‚ä¸‹çº¿æ—¶ï¼Œå°†ä¼šè§¦å‘æ•…éšœæ¢å¤æµç¨‹ï¼š</p><ul><li>ä»èŠ‚ç‚¹ä¸ä¸»èŠ‚ç‚¹æ–­çº¿æ—¶é—´è¶…è¿‡cluster-node-time*cluster-slave-validity-factorï¼Œåˆ™å½“å‰ä»èŠ‚ç‚¹ä¸å…·å¤‡æ•…éšœè½¬ç§»èµ„æ ¼ã€‚å‚æ•°cluster-slave-validity-factorç”¨äºä»èŠ‚ç‚¹çš„æœ‰æ•ˆå› å­ï¼Œé»˜è®¤ä¸º10ã€‚</li><li>å½“ä»èŠ‚ç‚¹ç¬¦åˆæ•…éšœè½¬ç§»èµ„æ ¼åï¼Œæ›´æ–°è§¦å‘æ•…éšœé€‰ä¸¾çš„æ—¶é—´ï¼Œåªæœ‰åˆ°è¾¾è¯¥æ—¶é—´åæ‰èƒ½æ‰§è¡Œåç»­æµç¨‹ã€‚è¿™é‡Œä¹‹æ‰€ä»¥é‡‡ç”¨<strong>å»¶è¿Ÿè§¦å‘æœºåˆ¶</strong>ï¼Œä¸»è¦æ˜¯é€šè¿‡å¯¹å¤šä¸ªä»èŠ‚ç‚¹ä½¿ç”¨ä¸åŒçš„å»¶è¿Ÿé€‰ä¸¾æ—¶é—´æ¥æ”¯æŒä¼˜å…ˆçº§é—®é¢˜ã€‚å¤åˆ¶åç§»é‡è¶Šå¤§è¯´æ˜ä»èŠ‚ç‚¹å»¶è¿Ÿè¶Šä½ï¼Œé‚£ä¹ˆå®ƒåº”è¯¥å…·æœ‰æ›´é«˜çš„ä¼˜å…ˆçº§æ¥æ›¿æ¢æ•…éšœä¸»èŠ‚ç‚¹ã€‚</li></ul><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779142661-ccaf9622-687f-4fd7-bb0f-9b12dd307cfe-20250605100735532.png" alt="img"></p><ul><li>å‘èµ·é€‰ä¸¾ã€‚Redisé›†ç¾¤æ²¡æœ‰ç›´æ¥ä½¿ç”¨ä»èŠ‚ç‚¹è¿›è¡Œé¢†å¯¼è€…é€‰ä¸¾ï¼Œä¸»è¦å› ä¸ºä»èŠ‚ç‚¹æ•°å¿…é¡»å¤§äºç­‰äº3ä¸ªæ‰èƒ½ä¿è¯å‡‘å¤ŸN&#x2F;2+1ä¸ªèŠ‚ç‚¹ï¼Œå°†å¯¼è‡´ä»èŠ‚ç‚¹èµ„æºæµªè´¹ã€‚ä½¿ç”¨<strong>é›†ç¾¤å†…æ‰€æœ‰æŒæœ‰æ§½çš„ä¸»èŠ‚ç‚¹è¿›è¡Œé¢†å¯¼è€…é€‰ä¸¾</strong>ï¼Œå³ä½¿åªæœ‰ä¸€ä¸ªä»èŠ‚ç‚¹ä¹Ÿå¯ä»¥å®Œæˆé€‰ä¸¾è¿‡ç¨‹ã€‚å½“ä»èŠ‚ç‚¹æ”¶é›†åˆ°N&#x2F;2+1ä¸ªæŒæœ‰æ§½çš„ä¸»èŠ‚ç‚¹æŠ•ç¥¨æ—¶ï¼Œä»èŠ‚ç‚¹å¯ä»¥æ‰§è¡Œæ›¿æ¢ä¸»èŠ‚ç‚¹æ“ä½œã€‚</li></ul><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779143549-fe48adcb-3d12-4d75-9ec8-5b30473ab45e-20250605100730766.png" alt="img"></p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779143588-93b3d1eb-7667-4589-afc0-cb041b6046c3-20250605100725335.png" alt="img"></p><p><strong>é¢„ä¼°æ•…éšœè½¬ç§»æ—¶é—´</strong></p><p>failover-time(æ¯«ç§’) â‰¤ cluster-node-timeout + cluster-node-timeout &#x2F; 2 + 1000</p><ul><li>ä¸»è§‚ä¸‹çº¿è¯†åˆ«æ—¶é—´ï¼šcluster-node-timeout</li><li>ä¸»è§‚ä¸‹çº¿çŠ¶æ€æ¶ˆæ¯ä¼ æ’­æ—¶é—´&lt;&#x3D;cluster-node-timeout&#x2F;2ã€‚æ¶ˆæ¯é€šä¿¡æœºåˆ¶å¯¹è¶…è¿‡cluster-node-timeout&#x2F;2æœªé€šä¿¡èŠ‚ç‚¹ä¼šå‘èµ·pingæ¶ˆæ¯ï¼Œæ¶ˆæ¯ä½“åœ¨é€‰æ‹©åŒ…å«å“ªäº›èŠ‚ç‚¹æ—¶ä¼šä¼˜å…ˆé€‰å–ä¸‹çº¿çŠ¶æ€èŠ‚ç‚¹ï¼Œæ‰€ä»¥é€šå¸¸è¿™æ®µæ—¶é—´å†…èƒ½å¤Ÿæ”¶é›†åˆ°åŠæ•°ä»¥ä¸Šä¸»èŠ‚ç‚¹çš„pfailæŠ¥å‘Šä»è€Œå®Œæˆæ•…éšœå‘ç°ã€‚</li><li>ä»èŠ‚ç‚¹è½¬ç§»æ—¶é—´&lt;&#x3D;1000æ¯«ç§’ã€‚ç”±äºå­˜åœ¨å»¶è¿Ÿå‘èµ·é€‰ä¸¾æœºåˆ¶ï¼Œåç§»é‡æœ€å¤§çš„ä»èŠ‚ç‚¹ä¼š<strong>æœ€å¤šå»¶è¿Ÿ<strong><strong>1</strong></strong>ç§’å‘èµ·é€‰ä¸¾</strong>ã€‚é€šå¸¸ç¬¬ä¸€æ¬¡é€‰ä¸¾å°±ä¼šæˆåŠŸã€‚</li></ul><p>æ•…éšœè½¬ç§»æ—¶é—´è·Ÿ cluster-node-timeout å‚æ•°æ¯æ¯ç›¸å…³ï¼Œé»˜è®¤15ç§’ã€‚é…ç½®æ—¶å¯ä»¥æ ¹æ®ä¸šåŠ¡å®¹å¿åº¦åšå‡ºé€‚å½“è°ƒæ•´ï¼Œä½†ä¸æ˜¯è¶Šå°è¶Šå¥½ã€‚</p><h4 id="5-9-5-è„‘è£‚é—®é¢˜"><a href="#5-9-5-è„‘è£‚é—®é¢˜" class="headerlink" title="5.9.5 è„‘è£‚é—®é¢˜"></a>5.9.5 è„‘è£‚é—®é¢˜</h4><p>ä»€ä¹ˆæ˜¯è„‘è£‚ï¼Ÿ</p><p>åœ¨ Redis ä¸»ä»æ¶æ„ä¸­ï¼Œéƒ¨ç½²æ–¹å¼ä¸€èˆ¬æ˜¯ã€Œä¸€ä¸»å¤šä»ã€ï¼Œä¸»èŠ‚ç‚¹æä¾›å†™æ“ä½œï¼Œä»èŠ‚ç‚¹æä¾›è¯»æ“ä½œã€‚ å¦‚æœä¸»èŠ‚ç‚¹çš„ç½‘ç»œçªç„¶å‘ç”Ÿäº†é—®é¢˜ï¼Œå®ƒä¸æ‰€æœ‰çš„ä»èŠ‚ç‚¹éƒ½å¤±è”äº†ï¼Œä½†æ˜¯æ­¤æ—¶çš„ä¸»èŠ‚ç‚¹å’Œå®¢æˆ·ç«¯çš„ç½‘ç»œæ˜¯æ­£å¸¸çš„ï¼Œè¿™ä¸ªå®¢æˆ·ç«¯å¹¶ä¸çŸ¥é“ Redis å†…éƒ¨å·²ç»å‡ºç°äº†é—®é¢˜ï¼Œè¿˜åœ¨ç…§æ ·çš„å‘è¿™ä¸ªå¤±è”çš„ä¸»èŠ‚ç‚¹å†™æ•°æ®ï¼ˆè¿‡ç¨‹Aï¼‰ï¼Œæ­¤æ—¶è¿™äº›æ•°æ®è¢«æ—§ä¸»èŠ‚ç‚¹ç¼“å­˜åˆ°äº†ç¼“å†²åŒºé‡Œï¼Œå› ä¸ºä¸»ä»èŠ‚ç‚¹ä¹‹é—´çš„ç½‘ç»œé—®é¢˜ï¼Œè¿™äº›æ•°æ®éƒ½æ˜¯æ— æ³•åŒæ­¥ç»™ä»èŠ‚ç‚¹çš„ã€‚</p><p>è¿™æ—¶ï¼Œå“¨å…µä¹Ÿå‘ç°ä¸»èŠ‚ç‚¹å¤±è”äº†ï¼Œå®ƒå°±è®¤ä¸ºä¸»èŠ‚ç‚¹æŒ‚äº†ï¼ˆä½†å®é™…ä¸Šä¸»èŠ‚ç‚¹æ­£å¸¸è¿è¡Œï¼Œåªæ˜¯ç½‘ç»œå‡ºé—®é¢˜äº†ï¼‰ï¼Œäºæ˜¯å“¨å…µå°±ä¼šåœ¨ã€Œä»èŠ‚ç‚¹ã€ä¸­é€‰ä¸¾å‡ºä¸€ä¸ª leader ä½œä¸ºä¸»èŠ‚ç‚¹ï¼Œè¿™æ—¶é›†ç¾¤å°±æœ‰ä¸¤ä¸ªä¸»èŠ‚ç‚¹äº† â€”â€” <strong>è„‘è£‚å‡ºç°äº†</strong>ã€‚</p><p>è„‘è£‚å¯èƒ½ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ï¼Ÿ</p><p>ç„¶åï¼Œç½‘ç»œçªç„¶å¥½äº†ï¼Œå“¨å…µå› ä¸ºä¹‹å‰å·²ç»é€‰ä¸¾å‡ºä¸€ä¸ªæ–°ä¸»èŠ‚ç‚¹äº†ï¼Œå®ƒå°±ä¼šæŠŠæ—§ä¸»èŠ‚ç‚¹é™çº§ä¸ºä»èŠ‚ç‚¹ï¼ˆAï¼‰ï¼Œç„¶åä»èŠ‚ç‚¹ï¼ˆAï¼‰ä¼šå‘æ–°ä¸»èŠ‚ç‚¹è¯·æ±‚æ•°æ®åŒæ­¥ï¼Œ<strong>å› ä¸ºç¬¬ä¸€æ¬¡åŒæ­¥æ˜¯å…¨é‡åŒæ­¥çš„æ–¹å¼ï¼Œæ­¤æ—¶çš„ä»èŠ‚ç‚¹ï¼ˆAï¼‰ä¼šæ¸…ç©ºæ‰è‡ªå·±æœ¬åœ°çš„æ•°æ®ï¼Œç„¶åå†åšå…¨é‡åŒæ­¥ã€‚æ‰€ä»¥ï¼Œä¹‹å‰å®¢æˆ·ç«¯åœ¨è¿‡ç¨‹ A å†™å…¥çš„æ•°æ®å°±ä¼šä¸¢å¤±äº†ï¼Œä¹Ÿå°±æ˜¯é›†ç¾¤äº§ç”Ÿè„‘è£‚æ•°æ®ä¸¢å¤±çš„é—®é¢˜</strong>ã€‚</p><p>æ€»ç»“ä¸€å¥è¯å°±æ˜¯ï¼šç”±äºç½‘ç»œé—®é¢˜ï¼Œé›†ç¾¤èŠ‚ç‚¹ä¹‹é—´å¤±å»è”ç³»ã€‚ä¸»ä»æ•°æ®ä¸åŒæ­¥ï¼›é‡æ–°å¹³è¡¡é€‰ä¸¾ï¼Œäº§ç”Ÿä¸¤ä¸ªä¸»æœåŠ¡ã€‚ç­‰ç½‘ç»œæ¢å¤ï¼Œæ—§ä¸»èŠ‚ç‚¹ä¼šé™çº§ä¸ºä»èŠ‚ç‚¹ï¼Œå†ä¸æ–°ä¸»èŠ‚ç‚¹è¿›è¡ŒåŒæ­¥å¤åˆ¶çš„æ—¶å€™ï¼Œç”±äºä¼šä»èŠ‚ç‚¹ä¼šæ¸…ç©ºè‡ªå·±çš„ç¼“å†²åŒºï¼Œæ‰€ä»¥å¯¼è‡´ä¹‹å‰å®¢æˆ·ç«¯å†™å…¥çš„æ•°æ®ä¸¢å¤±äº†ã€‚</p><p>è§£å†³æ–¹æ¡ˆ</p><p>å½“ä¸»èŠ‚ç‚¹å‘ç°ä»èŠ‚ç‚¹ä¸‹çº¿æˆ–è€…é€šä¿¡è¶…æ—¶çš„æ€»æ•°é‡å°äºé˜ˆå€¼æ—¶ï¼Œé‚£ä¹ˆç¦æ­¢ä¸»èŠ‚ç‚¹è¿›è¡Œå†™æ•°æ®ï¼Œç›´æ¥æŠŠé”™è¯¯è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p><p>åœ¨ Redis çš„é…ç½®æ–‡ä»¶ä¸­æœ‰ä¸¤ä¸ªå‚æ•°æˆ‘ä»¬å¯ä»¥è®¾ç½®ï¼š</p><ul><li>min-slaves-to-write xï¼Œä¸»èŠ‚ç‚¹å¿…é¡»è¦æœ‰è‡³å°‘ x ä¸ªä»èŠ‚ç‚¹è¿æ¥ï¼Œå¦‚æœå°äºè¿™ä¸ªæ•°ï¼Œä¸»èŠ‚ç‚¹ä¼šç¦æ­¢å†™æ•°æ®ã€‚</li><li>min-slaves-max-lag xï¼Œä¸»ä»æ•°æ®å¤åˆ¶å’ŒåŒæ­¥çš„å»¶è¿Ÿä¸èƒ½è¶…è¿‡ x ç§’ï¼Œå¦‚æœè¶…è¿‡ï¼Œä¸»èŠ‚ç‚¹ä¼šç¦æ­¢å†™æ•°æ®ã€‚</li></ul><p>æˆ‘ä»¬å¯ä»¥æŠŠ min-slaves-to-write å’Œ min-slaves-max-lag è¿™ä¸¤ä¸ªé…ç½®é¡¹æ­é…èµ·æ¥ä½¿ç”¨ï¼Œåˆ†åˆ«ç»™å®ƒä»¬è®¾ç½®ä¸€å®šçš„é˜ˆå€¼ï¼Œå‡è®¾ä¸º N å’Œ Tã€‚</p><p>è¿™ä¸¤ä¸ªé…ç½®é¡¹ç»„åˆåçš„è¦æ±‚æ˜¯ï¼Œä¸»åº“è¿æ¥çš„ä»åº“ä¸­è‡³å°‘æœ‰ N ä¸ªä»åº“ï¼Œå’Œä¸»åº“è¿›è¡Œæ•°æ®å¤åˆ¶æ—¶çš„ ACK æ¶ˆæ¯å»¶è¿Ÿä¸èƒ½è¶…è¿‡ T ç§’ï¼Œå¦åˆ™ï¼Œä¸»åº“å°±ä¸ä¼šå†æ¥æ”¶å®¢æˆ·ç«¯çš„å†™è¯·æ±‚äº†ã€‚</p><p>å³ä½¿åŸä¸»åº“æ˜¯å‡æ•…éšœï¼Œå®ƒåœ¨å‡æ•…éšœæœŸé—´ä¹Ÿæ— æ³•å“åº”å“¨å…µå¿ƒè·³ï¼Œä¹Ÿä¸èƒ½å’Œä»åº“è¿›è¡ŒåŒæ­¥ï¼Œè‡ªç„¶ä¹Ÿå°±æ— æ³•å’Œä»åº“è¿›è¡Œ ACK ç¡®è®¤äº†ã€‚è¿™æ ·ä¸€æ¥ï¼Œmin-slaves-to-write å’Œ min-slaves-max-lag çš„ç»„åˆè¦æ±‚å°±æ— æ³•å¾—åˆ°æ»¡è¶³ï¼Œ<strong>åŸä¸»åº“å°±ä¼šè¢«é™åˆ¶æ¥æ”¶å®¢æˆ·ç«¯å†™è¯·æ±‚ï¼Œå®¢æˆ·ç«¯ä¹Ÿå°±ä¸èƒ½åœ¨åŸä¸»åº“ä¸­å†™å…¥æ–°æ•°æ®äº†</strong>ã€‚</p><p><strong>ç­‰åˆ°æ–°ä¸»åº“ä¸Šçº¿æ—¶ï¼Œå°±åªæœ‰æ–°ä¸»åº“èƒ½æ¥æ”¶å’Œå¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼Œæ­¤æ—¶ï¼Œæ–°å†™çš„æ•°æ®ä¼šè¢«ç›´æ¥å†™åˆ°æ–°ä¸»åº“ä¸­ã€‚è€ŒåŸä¸»åº“ä¼šè¢«å“¨å…µé™ä¸ºä»åº“ï¼Œå³ä½¿å®ƒçš„æ•°æ®è¢«æ¸…ç©ºäº†ï¼Œä¹Ÿä¸ä¼šæœ‰æ–°æ•°æ®ä¸¢å¤±ã€‚</strong></p><p>å†æ¥ä¸¾ä¸ªä¾‹å­</p><p>å‡è®¾æˆ‘ä»¬å°† min-slaves-to-write è®¾ç½®ä¸º 1ï¼ŒæŠŠ min-slaves-max-lag è®¾ç½®ä¸º 12sï¼ŒæŠŠå“¨å…µçš„ down-after-milliseconds è®¾ç½®ä¸º 10sï¼Œä¸»åº“å› ä¸ºæŸäº›åŸå› å¡ä½äº† 15sï¼Œå¯¼è‡´å“¨å…µåˆ¤æ–­ä¸»åº“å®¢è§‚ä¸‹çº¿ï¼Œå¼€å§‹è¿›è¡Œä¸»ä»åˆ‡æ¢ã€‚</p><p>åŒæ—¶ï¼Œå› ä¸ºåŸä¸»åº“å¡ä½äº† 15sï¼Œæ²¡æœ‰ä¸€ä¸ªä»åº“èƒ½å’ŒåŸä¸»åº“åœ¨ 12s å†…è¿›è¡Œæ•°æ®å¤åˆ¶ï¼ŒåŸä¸»åº“ä¹Ÿæ— æ³•æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚äº†ã€‚</p><p>è¿™æ ·ä¸€æ¥ï¼Œä¸»ä»åˆ‡æ¢å®Œæˆåï¼Œä¹Ÿåªæœ‰æ–°ä¸»åº“èƒ½æ¥æ”¶è¯·æ±‚ï¼Œä¸ä¼šå‘ç”Ÿè„‘è£‚ï¼Œä¹Ÿå°±ä¸ä¼šå‘ç”Ÿæ•°æ®ä¸¢å¤±çš„é—®é¢˜äº†ã€‚</p><h4 id="5-9-6-çŠ¶æ€æ£€æµ‹åŠç»´æŠ¤"><a href="#5-9-6-çŠ¶æ€æ£€æµ‹åŠç»´æŠ¤" class="headerlink" title="5.9.6 çŠ¶æ€æ£€æµ‹åŠç»´æŠ¤"></a>5.9.6 çŠ¶æ€æ£€æµ‹åŠç»´æŠ¤</h4><p>Redis Cluster ä¸­èŠ‚ç‚¹çŠ¶æ€å¦‚ä½•ç»´æŠ¤å‘¢ï¼Ÿè¿™äº›å°±æ¶‰åŠ æœ‰å“ªäº›çŠ¶æ€ã€åº•å±‚åè®®GossipåŠå…·ä½“çš„é€šè®¯æœºåˆ¶</p><p>Cluster ä¸­ æ¯ä¸ªèŠ‚ç‚¹éƒ½ç»´æŠ¤ä¸€ä»½åœ¨è‡ªå·±çœ‹æ¥å½“å‰æ•´ä¸ªé›†ç¾¤çš„çŠ¶æ€ï¼Œä¸»è¦åŒ…æ‹¬ï¼š</p><ul><li>å½“å‰é›†ç¾¤çš„çŠ¶æ€</li><li>é›†ç¾¤ä¸­å„èŠ‚ç‚¹æ‰€è´Ÿè´£çš„ slots ä¿¡æ¯åŠå…¶ migrate çŠ¶æ€</li><li>é›†ç¾¤ä¸­å„èŠ‚ç‚¹çš„ master-slave çŠ¶æ€</li><li>é›†ç¾¤ä¸­å„èŠ‚ç‚¹çš„å­˜æ´»çŠ¶æ€åŠä¸å¯è¾¾æŠ•ç¥¨</li></ul><p>å½“é›†ç¾¤çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼Œå¦‚ï¼šå¦‚æ–°èŠ‚ç‚¹åŠ å…¥ã€slotè¿ç§»ã€èŠ‚ç‚¹å®•æœºã€slaveæå‡ä¸ºæ–°Masterï¼Œæˆ‘ä»¬å¸Œæœ›è¿™äº›å˜åŒ–å°½å¿«çš„è¢«å‘ç°ï¼Œä¼ æ’­åˆ°æ•´ä¸ªé›†ç¾¤çš„æ‰€æœ‰èŠ‚ç‚¹å¹¶è¾¾æˆä¸€è‡´ã€‚èŠ‚ç‚¹ä¹‹é—´ç›¸äº’çš„<strong>å¿ƒè·³</strong>ï¼ˆPINGï¼ŒPONGï¼ŒMEETï¼‰åŠå…¶æºå¸¦çš„æ•°æ®æ˜¯é›†ç¾¤çŠ¶æ€ä¼ æ’­æœ€ä¸»è¦çš„é€”å¾„ã€‚</p><h5 id="Gossipåè®®"><a href="#Gossipåè®®" class="headerlink" title="Gossipåè®®"></a>Gossipåè®®</h5><p>Redis Cluster é€šè®¯åº•å±‚æ˜¯ Gossip åè®®ï¼Œæ‰€ä»¥éœ€è¦å¯¹ Gossip åè®®æœ‰ä¸€å®šäº†è§£</p><p>gossip åè®®ï¼ˆgossip protocolï¼‰åˆç§° epidemic åè®®ï¼ˆepidemic protocolï¼‰ï¼Œæ˜¯åŸºäºæµè¡Œç—…ä¼ æ’­æ–¹å¼çš„èŠ‚ç‚¹æˆ–è€…è¿›ç¨‹ä¹‹é—´ä¿¡æ¯äº¤æ¢çš„åè®®ã€‚ åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­è¢«å¹¿æ³›ä½¿ç”¨ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ gossip åè®®æ¥ç¡®ä¿ç½‘ç»œä¸­æ‰€æœ‰èŠ‚ç‚¹çš„æ•°æ®ä¸€æ ·ã€‚</p><p>Gossipåè®®å·²ç»æ˜¯P2Pç½‘ç»œä¸­æ¯”è¾ƒæˆç†Ÿçš„åè®®äº†ã€‚Gossipåè®®çš„æœ€å¤§çš„å¥½å¤„æ˜¯ï¼Œ<strong>å³ä½¿é›†ç¾¤èŠ‚ç‚¹çš„æ•°é‡å¢åŠ ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„è´Ÿè½½ä¹Ÿä¸ä¼šå¢åŠ å¾ˆå¤šï¼Œå‡ ä¹æ˜¯æ’å®šçš„ã€‚è¿™å°±å…è®¸Consulç®¡ç†çš„é›†ç¾¤è§„æ¨¡èƒ½æ¨ªå‘æ‰©å±•åˆ°æ•°åƒä¸ªèŠ‚ç‚¹</strong>ã€‚</p><p>Gossipç®—æ³•åˆè¢«ç§°ä¸ºåç†µï¼ˆAnti-Entropyï¼‰ï¼Œç†µæ˜¯ç‰©ç†å­¦ä¸Šçš„ä¸€ä¸ªæ¦‚å¿µï¼Œä»£è¡¨æ‚ä¹±æ— ç« ï¼Œè€Œåç†µå°±æ˜¯åœ¨æ‚ä¹±æ— ç« ä¸­å¯»æ±‚ä¸€è‡´ï¼Œè¿™å……åˆ†è¯´æ˜äº†Gossipçš„ç‰¹ç‚¹ï¼šåœ¨ä¸€ä¸ªæœ‰ç•Œç½‘ç»œä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½éšæœºåœ°ä¸å…¶ä»–èŠ‚ç‚¹é€šä¿¡ï¼Œç»è¿‡ä¸€ç•ªæ‚ä¹±æ— ç« çš„é€šä¿¡ï¼Œæœ€ç»ˆæ‰€æœ‰èŠ‚ç‚¹çš„çŠ¶æ€éƒ½ä¼šè¾¾æˆä¸€è‡´ã€‚æ¯ä¸ªèŠ‚ç‚¹å¯èƒ½çŸ¥é“æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹ï¼Œä¹Ÿå¯èƒ½ä»…çŸ¥é“å‡ ä¸ªé‚»å±…èŠ‚ç‚¹ï¼Œåªè¦è¿™äº›èŠ‚å¯ä»¥é€šè¿‡ç½‘ç»œè¿é€šï¼Œæœ€ç»ˆä»–ä»¬çš„çŠ¶æ€éƒ½æ˜¯ä¸€è‡´çš„ï¼Œå½“ç„¶è¿™ä¹Ÿæ˜¯ç–«æƒ…ä¼ æ’­çš„ç‰¹ç‚¹ã€‚<a href="https://www.backendcloud.cn/2017/11/12/raft-gossip/">https://www.backendcloud.cn/2017/11/12/raft-gossip/</a></p><p>ä¸Šé¢çš„æè¿°éƒ½æ¯”è¾ƒå­¦æœ¯ï¼Œå…¶å®Gossipåè®®å¯¹äºæˆ‘ä»¬åƒç“œç¾¤ä¼—æ¥è¯´ä¸€ç‚¹ä¹Ÿä¸é™Œç”Ÿï¼ŒGossipåè®®ä¹Ÿæˆä¸ºæµè¨€åè®®ï¼Œè¯´ç™½äº†å°±æ˜¯å…«å¦åè®®ï¼Œè¿™ç§ä¼ æ’­è§„æ¨¡å’Œä¼ æ’­é€Ÿåº¦éƒ½æ˜¯éå¸¸å¿«çš„ï¼Œä½ å¯ä»¥ä½“ä¼šä¸€ä¸‹ã€‚æ‰€ä»¥è®¡ç®—æœºä¸­çš„å¾ˆå¤šç®—æ³•éƒ½æ˜¯æºè‡ªç”Ÿæ´»ï¼Œè€Œåˆé«˜äºç”Ÿæ´»çš„</p><h5 id="Gossipåè®®çš„ä½¿ç”¨"><a href="#Gossipåè®®çš„ä½¿ç”¨" class="headerlink" title="Gossipåè®®çš„ä½¿ç”¨"></a>Gossipåè®®çš„ä½¿ç”¨</h5><p>Redis é›†ç¾¤æ˜¯å»ä¸­å¿ƒåŒ–çš„ï¼Œå½¼æ­¤ä¹‹é—´çŠ¶æ€åŒæ­¥è€ƒ gossip åè®®é€šè®¯ï¼Œé›†ç¾¤çš„æ¶ˆæ¯æœ‰ä»¥ä¸‹å‡ ç§ç±»å‹ï¼š</p><ul><li>Meet é€šè¿‡ cluster meet ip portå‘½ä»¤ï¼Œå·²æœ‰é›†ç¾¤çš„èŠ‚ç‚¹ä¼šå‘æ–°çš„èŠ‚ç‚¹å‘é€é‚€è¯·ï¼ŒåŠ å…¥ç°æœ‰é›†ç¾¤ã€‚</li><li>Ping èŠ‚ç‚¹æ¯ç§’ä¼šå‘é›†ç¾¤ä¸­å…¶ä»–èŠ‚ç‚¹å‘é€ ping æ¶ˆæ¯ï¼Œæ¶ˆæ¯ä¸­å¸¦æœ‰è‡ªå·±å·²çŸ¥çš„ä¸¤ä¸ªèŠ‚ç‚¹çš„åœ°å€ã€æ§½ã€çŠ¶æ€ä¿¡æ¯ã€æœ€åä¸€æ¬¡é€šä¿¡æ—¶é—´ç­‰</li><li>Pong èŠ‚ç‚¹æ”¶åˆ° ping æ¶ˆæ¯åä¼šå›å¤ pong æ¶ˆæ¯ï¼Œæ¶ˆæ¯ä¸­åŒæ ·å¸¦æœ‰è‡ªå·±å·²çŸ¥çš„ä¸¤ä¸ªèŠ‚ç‚¹ä¿¡æ¯</li><li>Fail èŠ‚ç‚¹ ping ä¸é€šæŸèŠ‚ç‚¹åï¼Œä¼šå‘é›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹å¹¿æ’­è¯¥èŠ‚ç‚¹æŒ‚æ‰çš„æ¶ˆæ¯ã€‚å…¶ä»–èŠ‚ç‚¹æ”¶åˆ°æ¶ˆæ¯åæ ‡è®°å·²ä¸‹çº¿ã€‚</li></ul><h5 id="åŸºäºGossip-åè®®çš„æ•…éšœæ£€æµ‹"><a href="#åŸºäºGossip-åè®®çš„æ•…éšœæ£€æµ‹" class="headerlink" title="åŸºäºGossip åè®®çš„æ•…éšœæ£€æµ‹"></a>åŸºäºGossip åè®®çš„æ•…éšœæ£€æµ‹</h5><p>é›†ç¾¤ä¸­æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šå®šæœŸåœ°å‘é›†ç¾¤ä¸­å…¶ä»–èŠ‚ç‚¹å‘é€ PING æ¶ˆæ¯ï¼Œä»¥æ­¤äº¤æ¢å„ä¸ªèŠ‚ç‚¹çŠ¶æ€ä¿¡æ¯ï¼Œæ£€æµ‹å„ä¸ªèŠ‚ç‚¹çŠ¶æ€ï¼š<strong>åœ¨çº¿çŠ¶æ€ã€ç–‘ä¼¼ä¸‹çº¿çŠ¶æ€ã€PFAILã€å·²ä¸‹çº¿çŠ¶æ€FAIL</strong></p><p><strong>è‡ªå·±ä¿å­˜ä¿¡æ¯</strong>ï¼šå½“ä¸»èŠ‚ç‚¹Aé€šè¿‡æ¶ˆæ¯å¾—çŸ¥ä¸»èŠ‚ç‚¹Bè®¤ä¸ºä¸»èŠ‚ç‚¹Dè¿›å…¥äº†ç–‘ä¼¼ä¸‹çº¿(PFAIL)çŠ¶æ€æ—¶,ä¸»èŠ‚ç‚¹Aä¼šåœ¨è‡ªå·±çš„clusterState.nodeså­—å…¸ä¸­æ‰¾åˆ°ä¸»èŠ‚ç‚¹Dæ‰€å¯¹åº”çš„clusterNodeç»“æ„ï¼Œå¹¶å°†ä¸»èŠ‚ç‚¹Bçš„ä¸‹çº¿æŠ¥å‘Šæ·»åŠ åˆ°clusterNodeç»“æ„çš„fail_reportsé“¾è¡¨ä¸­ï¼Œå¹¶åç»­å…³äºç»“ç‚¹Dç–‘ä¼¼ä¸‹çº¿çš„çŠ¶æ€é€šè¿‡Gossipåè®®é€šçŸ¥å…¶ä»–èŠ‚ç‚¹ã€‚</p><p><strong>ä¸€èµ·è£å®š</strong>ï¼šå¦‚æœé›†ç¾¤é‡Œé¢ï¼ŒåŠæ•°ä»¥ä¸Šçš„ä¸»èŠ‚ç‚¹éƒ½å°†ä¸»èŠ‚ç‚¹DæŠ¥å‘Šä¸ºç–‘ä¼¼ä¸‹çº¿ï¼Œé‚£ä¹ˆä¸»èŠ‚ç‚¹Då°†è¢«æ ‡è®°ä¸ºå·²ä¸‹çº¿(FAIL)çŠ¶æ€ï¼Œå°†ä¸»èŠ‚ç‚¹Dæ ‡è®°ä¸ºå·²ä¸‹çº¿çš„èŠ‚ç‚¹ä¼šå‘é›†ç¾¤å¹¿æ’­ä¸»èŠ‚ç‚¹Dçš„FAILæ¶ˆæ¯ï¼Œæ‰€æœ‰æ”¶åˆ°FAILæ¶ˆæ¯çš„èŠ‚ç‚¹éƒ½ä¼šç«‹å³æ›´æ–°nodesé‡Œé¢ä¸»èŠ‚ç‚¹DçŠ¶æ€æ ‡è®°ä¸ºå·²ä¸‹çº¿ã€‚</p><p><strong>æœ€ç»ˆè£å®š</strong>ï¼šå°† node æ ‡è®°ä¸º FAIL éœ€è¦æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶ï¼š</p><ul><li>æœ‰åŠæ•°ä»¥ä¸Šçš„ä¸»èŠ‚ç‚¹å°† node æ ‡è®°ä¸º PFAIL çŠ¶æ€ã€‚</li><li>å½“å‰èŠ‚ç‚¹ä¹Ÿå°† node æ ‡è®°ä¸º PFAIL çŠ¶æ€ã€‚</li></ul><h4 id="5-9-7-é€šè®¯çŠ¶æ€å’Œç»´æŠ¤"><a href="#5-9-7-é€šè®¯çŠ¶æ€å’Œç»´æŠ¤" class="headerlink" title="5.9.7 é€šè®¯çŠ¶æ€å’Œç»´æŠ¤"></a>5.9.7 é€šè®¯çŠ¶æ€å’Œç»´æŠ¤</h4><p>æˆ‘ä»¬ç†è§£äº†Gossipåè®®åŸºç¡€åï¼Œå°±å¯ä»¥è¿›ä¸€æ­¥ç†è§£RedisèŠ‚ç‚¹ä¹‹é—´ç›¸äº’çš„é€šè®¯<strong>å¿ƒè·³</strong>ï¼ˆPINGï¼ŒPONGï¼ŒMEETï¼‰å®ç°å’Œç»´æŠ¤äº†</p><ol><li>ä»€ä¹ˆæ—¶å€™è¿›è¡Œå¿ƒè·³ï¼ŸRedis èŠ‚ç‚¹ä¼šè®°å½•å…¶å‘æ¯ä¸ªèŠ‚ç‚¹ä¸Šæ¬¡å‘å‡º ping å’Œæ”¶åˆ° pong çš„æ—¶é—´ï¼Œå¿ƒè·³å‘é€æ—¶æœºä¸è¿™ä¸¤ä¸ªå€¼æœ‰å…³ã€‚é€šè¿‡ä¸‹é¢çš„æ–¹å¼æ—¢èƒ½ä¿è¯åŠæ—¶æ›´æ–°é›†ç¾¤çŠ¶æ€ï¼Œåˆä¸è‡³äºä½¿å¿ƒè·³æ•°è¿‡å¤šï¼š</li></ol><ul><li><ul><li>æ¯æ¬¡Cronå‘æ‰€æœ‰æœªå»ºç«‹é“¾æ¥çš„èŠ‚ç‚¹å‘é€pingæˆ–meet</li><li>æ¯1ç§’ä»æ‰€æœ‰å·²çŸ¥èŠ‚ç‚¹ä¸­éšæœºé€‰å–5ä¸ªï¼Œå‘å…¶ä¸­ä¸Šæ¬¡æ”¶åˆ°pongæœ€ä¹…è¿œçš„ä¸€ä¸ªå‘é€ping</li><li>æ¯æ¬¡Cronå‘æ”¶åˆ°pongè¶…è¿‡timeout&#x2F;2çš„èŠ‚ç‚¹å‘é€ping</li><li>æ”¶åˆ°pingæˆ–meetï¼Œç«‹å³å›å¤pong</li></ul></li></ul><ol><li>å‘é€é‚£äº›å¿ƒè·³æ•°æ®ï¼Ÿ</li></ol><ul><li><ul><li>Headerï¼Œå‘é€è€…è‡ªå·±çš„ä¿¡æ¯ï¼šæ‰€è´Ÿè´£çš„ slots çš„ä¿¡æ¯ï¼›ä¸»ä»ä¿¡æ¯ï¼›ip port ä¿¡æ¯ï¼›çŠ¶æ€ä¿¡æ¯</li><li>Gossipï¼Œå‘é€è€…æ‰€äº†è§£çš„éƒ¨åˆ†å…¶ä»–èŠ‚ç‚¹çš„ä¿¡æ¯ï¼šping_sentã€pong_receivedï¼›ip portä¿¡æ¯ï¼›çŠ¶æ€ä¿¡æ¯ï¼ˆæ¯”å¦‚å‘é€è€…è®¤ä¸ºè¯¥èŠ‚ç‚¹å·²ç»ä¸å¯åˆ°è¾¾ï¼Œä¼šåœ¨çŠ¶æ€ä¿¡æ¯ä¸­æ ‡è®°å…¶ä¸º PFAILæˆ–FAILï¼‰</li></ul></li></ul><ol><li>å¦‚ä½•å¤„ç†å¿ƒè·³</li></ol><ul><li><ul><li>æ–°èŠ‚ç‚¹åŠ å…¥</li></ul></li></ul><ol><li><ol><li><ol><li>å‘é€meetåŒ…åŠ å…¥é›†ç¾¤</li><li>ä»pongåŒ…ä¸­çš„ gossip å¾—åˆ°æœªçŸ¥çš„å…¶ä»–èŠ‚ç‚¹</li><li>å¾ªç¯ä¸Šè¿°è¿‡ç¨‹ï¼Œç›´åˆ°æœ€ç»ˆåŠ å…¥é›†ç¾¤</li></ol></li></ol></li></ol><ul><li><ul><li>Slots ä¿¡æ¯</li></ul></li></ul><ol><li><ol><li><ol><li>åˆ¤æ–­å‘é€è€…å£°æ˜çš„ slots ä¿¡æ¯ï¼Œè·Ÿæœ¬åœ°è®°å½•çš„æ˜¯å¦ä¸åŒ</li><li>å¦‚æœä¸åŒï¼Œä¸”å‘é€è€… epochè¾ƒå¤§ï¼Œæ›´æ–°æœ¬åœ°è®°å½•</li><li>å¦‚æœä¸åŒï¼Œä¸”å‘é€è€… epochè¾ƒå°ï¼Œå‘é€ Update ä¿¡æ¯é€šçŸ¥å‘é€è€…</li></ol></li></ol></li></ol><ul><li><ul><li>Master slaveä¿¡æ¯å‘ç°å‘é€è€…çš„masterã€slaveä¿¡æ¯å˜åŒ–ï¼Œæ›´æ–°æœ¬åœ°çŠ¶æ€</li><li>èŠ‚ç‚¹Failæ¢æµ‹ï¼ˆæ•…éšœå‘ç°ï¼‰Gossipçš„å­˜åœ¨ä½¿å¾—é›†ç¾¤çŠ¶æ€çš„æ”¹å˜å¯ä»¥æ›´å¿«çš„è¾¾åˆ°æ•´ä¸ªé›†ç¾¤ã€‚æ¯ä¸ªå¿ƒè·³åŒ…ä¸­ä¼šåŒ…å«å¤šä¸ªGossipåŒ…ï¼Œé‚£ä¹ˆå¤šå°‘ä¸ªæ‰æ˜¯åˆé€‚çš„å‘¢ï¼Œredisçš„é€‰æ‹©æ˜¯N&#x2F;10ï¼Œå…¶ä¸­Næ˜¯èŠ‚ç‚¹æ•°ï¼Œè¿™æ ·å¯ä»¥ä¿è¯åœ¨PFAILæŠ•ç¥¨çš„è¿‡æœŸæ—¶é—´å†…ï¼ŒèŠ‚ç‚¹å¯ä»¥æ”¶åˆ°80%æœºå™¨å…³äºå¤±è´¥èŠ‚ç‚¹çš„gossipï¼Œä»è€Œä½¿å…¶é¡ºåˆ©è¿›å…¥FAILçŠ¶æ€ã€‚</li></ul></li></ul><ol><li><ol><li><ol><li>è¶…è¿‡è¶…æ—¶æ—¶é—´ä»ç„¶æ²¡æœ‰æ”¶åˆ° pong åŒ…çš„èŠ‚ç‚¹ä¼šè¢«å½“å‰èŠ‚ç‚¹æ ‡è®°ä¸º PFAIL</li><li>PFAIL æ ‡è®°ä¼šéšç€ gossip ä¼ æ’­</li><li>æ¯æ¬¡æ”¶åˆ°å¿ƒè·³åŒ…ä¼šæ£€æµ‹å…¶ä¸­å¯¹å…¶ä»–èŠ‚ç‚¹çš„ PFAIL æ ‡è®°ï¼Œå½“åšå¯¹è¯¥èŠ‚ç‚¹çš„FAILçš„æŠ•ç¥¨ç»´æŠ¤åœ¨æœ¬æœº</li><li>å¯¹æŸä¸ªèŠ‚ç‚¹çš„ PFAILæ ‡è®°è¾¾åˆ°å¤§å¤šæ•°æ—¶ï¼Œå°†å…¶å˜ä¸º FAIL æ ‡è®°å¹¶å¹¿æ’­ FAILæ¶ˆæ¯</li></ol></li></ol></li><li><p>åªèƒ½é€šè¿‡ gossip + å¿ƒè·³ ä¼ é€’ä¿¡æ¯ï¼Ÿå½“éœ€è¦å‘å¸ƒä¸€äº›éå¸¸é‡è¦éœ€è¦ç«‹å³å‘é€çš„ä¿¡æ¯æ—¶ï¼Œä¸Šè¿° å¿ƒè·³+Gossipçš„æ–¹å¼å°±æ˜¾å¾—æ‰è¥Ÿè§è‚˜äº†ã€‚è¿™æ—¶å°±éœ€è¦å‘æ‰€æœ‰é›†ç¾¤å†…æœºå™¨å¹¿æ’­ä¿¡æ¯ï¼Œä½¿ç”¨å¹¿æ’­å‘çš„åœºæ™¯ï¼š</p></li></ol><ul><li><ul><li>èŠ‚ç‚¹çš„ Fail ä¿¡æ¯ï¼šå½“å‘ç°æŸä¸€ä¸ªèŠ‚ç‚¹ä¸å¯è¾¾æ—¶ï¼Œæ¢æµ‹èŠ‚ç‚¹ä¼šå°†å…¶æ ‡è®°ä¸º PFAILçŠ¶æ€ï¼Œå¹¶é€šè¿‡å¿ƒè·³ä¼ æ’­å‡ºå»ã€‚å½“æŸä¸€ä¸ªèŠ‚ç‚¹å‘ç°è¿™ä¸ªèŠ‚ç‚¹çš„ PFAIL è¶…è¿‡åŠæ•°æ—¶ä¿®æ”¹å…¶ä¸º FAIL å¹¶å‘èµ·å¹¿æ’­ã€‚</li><li>Failover Request ä¿¡æ¯ï¼šslave å°è¯•å‘èµ· FailOveræ—¶ å¹¿æ’­å…¶è¦æ±‚æŠ•ç¥¨çš„ä¿¡æ¯</li><li>æ–° Master ä¿¡æ¯ï¼šFailOveræˆåŠŸçš„èŠ‚ç‚¹å‘æ•´ä¸ªé›†ç¾¤å¹¿æ’­è‡ªå·±çš„ä¿¡æ¯</li></ul></li></ul><h4 id="5-9-8-æ‰©å®¹ã€ç¼©å®¹"><a href="#5-9-8-æ‰©å®¹ã€ç¼©å®¹" class="headerlink" title="5.9.8 æ‰©å®¹ã€ç¼©å®¹"></a>5.9.8 æ‰©å®¹ã€ç¼©å®¹</h4><p>å½“é›†ç¾¤å‡ºç°å®¹é‡é™åˆ¶æˆ–è€…å…¶ä»–ä¸€äº›åŸå› éœ€è¦æ‰©å®¹æ—¶ï¼Œredis clusteræä¾›äº†æ¯”è¾ƒä¼˜é›…çš„é›†ç¾¤æ‰©å®¹æ–¹æ¡ˆã€‚</p><ol><li>é¦–å…ˆå°†æ–°èŠ‚ç‚¹åŠ å…¥åˆ°é›†ç¾¤ä¸­ï¼Œå¯ä»¥é€šè¿‡åœ¨é›†ç¾¤ä¸­ä»»ä½•ä¸€ä¸ªå®¢æˆ·ç«¯æ‰§è¡Œcluster meet æ–°èŠ‚ç‚¹ip:ç«¯å£ï¼Œæˆ–è€…é€šè¿‡redis-trib add nodeæ·»åŠ ï¼Œæ–°æ·»åŠ çš„èŠ‚ç‚¹é»˜è®¤åœ¨é›†ç¾¤ä¸­éƒ½æ˜¯ä¸»èŠ‚ç‚¹ã€‚</li><li>è¿ç§»æ•°æ® è¿ç§»æ•°æ®çš„å¤§è‡´æµç¨‹æ˜¯ï¼Œé¦–å…ˆéœ€è¦ç¡®å®šå“ªäº›æ§½éœ€è¦è¢«è¿ç§»åˆ°ç›®æ ‡èŠ‚ç‚¹ï¼Œç„¶åè·å–æ§½ä¸­keyï¼Œå°†æ§½ä¸­çš„keyå…¨éƒ¨è¿ç§»åˆ°ç›®æ ‡èŠ‚ç‚¹ï¼Œç„¶åå‘é›†ç¾¤æ‰€æœ‰ä¸»èŠ‚ç‚¹å¹¿æ’­æ§½ï¼ˆæ•°æ®ï¼‰å…¨éƒ¨è¿ç§»åˆ°äº†ç›®æ ‡èŠ‚ç‚¹ã€‚ç›´æ¥é€šè¿‡redis-tribå·¥å…·åšæ•°æ®è¿ç§»å¾ˆæ–¹ä¾¿ã€‚ ç°åœ¨å‡è®¾å°†èŠ‚ç‚¹Açš„æ§½10è¿ç§»åˆ°BèŠ‚ç‚¹ï¼Œè¿‡ç¨‹å¦‚ä¸‹ï¼š</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">B:cluster setslot 10 importing A.nodeId</span><br><span class="line">A:cluster setslot 10 migrating B.nodeId</span><br></pre></td></tr></table></figure><p>å¾ªç¯è·å–æ§½ä¸­keyï¼Œå°†keyè¿ç§»åˆ°BèŠ‚ç‚¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A:cluster getkeysinslot 10 100</span><br><span class="line">A:migrate B.ip B.port &quot;&quot; 0 5000 keys key1[ key2....]</span><br></pre></td></tr></table></figure><p>å‘é›†ç¾¤å¹¿æ’­æ§½å·²ç»è¿ç§»åˆ°BèŠ‚ç‚¹</p><p>cluster setslot 10 node B.nodeId</p><p>ç¼©å®¹çš„å¤§è‡´è¿‡ç¨‹ä¸æ‰©å®¹ä¸€è‡´ï¼Œéœ€è¦åˆ¤æ–­ä¸‹çº¿çš„èŠ‚ç‚¹æ˜¯å¦æ˜¯ä¸»èŠ‚ç‚¹ï¼Œä»¥åŠä¸»èŠ‚ç‚¹ä¸Šæ˜¯å¦æœ‰æ§½ï¼Œè‹¥ä¸»èŠ‚ç‚¹ä¸Šæœ‰æ§½ï¼Œéœ€è¦å°†æ§½è¿ç§»åˆ°é›†ç¾¤ä¸­å…¶ä»–ä¸»èŠ‚ç‚¹ï¼Œæ§½è¿ç§»å®Œæˆä¹‹åï¼Œéœ€è¦å‘å…¶ä»–èŠ‚ç‚¹å¹¿æ’­è¯¥èŠ‚ç‚¹å‡†å¤‡ä¸‹çº¿ï¼ˆcluster forget nodeIdï¼‰ã€‚æœ€åéœ€è¦å°†è¯¥ä¸‹çº¿ä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹æŒ‡å‘å…¶ä»–ä¸»èŠ‚ç‚¹ï¼Œå½“ç„¶æœ€å¥½æ˜¯å…ˆå°†ä»èŠ‚ç‚¹ä¸‹çº¿</p><h4 id="5-9-9-Write-Safety-åˆ†æ"><a href="#5-9-9-Write-Safety-åˆ†æ" class="headerlink" title="5.9.9 Write Safety åˆ†æ"></a>5.9.9 Write Safety åˆ†æ</h4><p><a href="https://segmentfault.com/a/1190000039226390">https://segmentfault.com/a/1190000039226390</a></p><p>Redis Cluster æ˜¯ Redis çš„åˆ†å¸ƒå¼å®ç°ï¼Œå°±å¦‚åŒå®˜æ–¹æ–‡æ¡£é‡Œå¼ºè°ƒçš„ï¼Œå…¶è®¾è®¡ä¼˜å…ˆè€ƒè™‘çš„æ˜¯ é«˜æ€§èƒ½å’Œçº¿æ€§æ‰©å±•èƒ½åŠ›ï¼Œå°½é‡ä¿è¯ write safetyã€‚è¿™é‡Œæ‰€è¯´çš„ write ä¸¢å¤±æ˜¯æŒ‡ï¼Œå›å¤ å®¢æˆ·ç«¯å“åº”åï¼Œåç»­è¯·æ±‚ä¸­å‡ºç°æœªåšå˜æ›´æˆ–è€…ä¸¢å¤±çš„æƒ…å†µã€‚å¯¼è‡´è¯¥é—®é¢˜ï¼Œä¸»è¦åœ¨ ä¸»ä»åˆ‡æ¢ã€å®ä¾‹é‡å¯ã€è„‘è£‚ä¸‰ç§æƒ…å†µä¸‹ã€‚</p><ul><li><p>ä¸»ä»åˆ‡æ¢</p></li><li><ul><li>è¢«åŠ¨ failoveræƒ…æ™¯ï¼šmaster c ä¸ºä¸»èŠ‚ç‚¹ï¼Œè´Ÿè´£ slot 1-100ï¼Œå…¶å¯¹åº”çš„ä»èŠ‚ç‚¹æ˜¯ slave cã€‚å½“master cæŒ‚æ‰åï¼Œslave c åœ¨ æœ€å¤š2å€ cluster_node_timeout çš„æ—¶é—´ å†…æŠŠ master c æ ‡è®°æˆ FALL,è¿›è€Œè§¦å‘ failover é€»è¾‘ã€‚åœ¨ slave c æˆåŠŸåˆ‡æ¢ä¸º masterå‰ï¼Œslot 1-100 ä»ç„¶ç”± master c è´Ÿè´£ï¼Œè®¿é—®ä¹Ÿä¼šæŠ¥é”™ã€‚å½“ slave c åˆ‡æ¢ä¸º master åï¼Œgossip å¹¿æ’­è·¯ç”±å˜æ›´ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œclient è®¿é—® slave cï¼Œä»ç„¶å¯ä»¥å¾—åˆ°æ­£å¸¸å›åº”ï¼Œè€Œè®¿é—®å…¶ä»–æŒæœ‰è€è·¯ç”±çš„ nodeï¼Œè¯·æ±‚ä¼šè¢« moved åˆ°æŒ‚æ‰çš„ master cï¼Œè®¿é—®æŠ¥é”™ã€‚é—®é¢˜ï¼šå¦‚æœå†™åˆ° master ä¸Šçš„æ•°æ®è¿˜æ²¡æ¥å¾—åŠåŒæ­¥åˆ° slave å°±æŒ‚æ‰äº†ï¼Œé‚£ä¹ˆè¿™éƒ¨åˆ†æ•°æ®å°±ä¼šä¸¢å¤±ï¼ˆé‡å¯åä¸å­˜åœ¨ mergeæ“ä½œï¼‰ã€‚å³å†™å…¥çš„æ•°æ®ä¸¢å¤±ã€‚master å›å¤ client ack äº åŒæ­¥ slave å‡ ä¹åŒæ—¶è¿›è¡Œçš„ï¼Œè¿™ç§æƒ…å†µå¾ˆå°‘å‘ç”Ÿï¼ˆæ—¶é—´çª—å£å°ï¼‰ï¼Œä½†æ˜¯è¿™å­˜åœ¨è¿™ä¸ªé£é™©</li><li>ä¸»åŠ¨ failoverä¸»åŠ¨ failover é€šè¿‡ sysadmin åœ¨ slave node ä¸Šæ‰§è¡Œ CLUSTER FAILOVER [FORCE|TAKEOVER] å‘½ä»¤è§¦å‘ã€‚å®Œæ•´çš„ manual failover å¯ä»¥æ¦‚æ‹¬ä¸ºä»¥ä¸‹æ­¥éª¤ï¼šè¯¥å‘½ä»¤çš„ä¸‰ä¸ªé€‰é¡¹åˆ†åˆ«ç”±ä¸åŒçš„è¡Œä¸ºï¼š</li></ul></li></ul><ol><li><ol><li><ol><li>slave å‘èµ·è¯·æ±‚ï¼Œgossip æ¶ˆæ¯æºå¸¦ <strong>CLUSTERMSG_TYPE_MFSTART</strong> æ ‡è¯†ã€‚</li><li>master é˜»å¡ clientï¼Œåœæœæ—¶é—´ä¸º 2 å€ <strong>CLUSTER_MF_TIMEOUT</strong>ï¼Œç›®å‰ç‰ˆæœ¬ä¸º 10sã€‚</li><li>slave è¿½èµ¶ä¸»ä»å¤åˆ¶ offset æ•°æ®ã€‚</li><li>slave å¼€å§‹å‘èµ·é€‰ä¸¾ï¼Œå¹¶æœ€ç»ˆå½“é€‰ã€‚</li><li>slave åˆ‡æ¢è‡ªèº« roleï¼Œæ¥ç®¡ slotsï¼Œå¹¶å¹¿æ’­æ–°çš„è·¯ç”±ä¿¡æ¯ã€‚</li><li>å…¶ä»–èŠ‚ç‚¹æ›´æ”¹è·¯ç”±ï¼Œcluster è·¯ç”±æ‰“å¹³ã€‚</li></ol></li></ol></li></ol><ul><li><ul><li><ul><li>é»˜è®¤é€‰é¡¹ï¼šæ‰§è¡Œå®Œæ•´çš„ mf æµç¨‹ï¼Œmaster ç”±åœæœè¡Œä¸ºï¼Œå› æ­¤ä¸å­˜åœ¨writeä¸¢å¤±é—®é¢˜ã€‚</li><li>FORCEé€‰é¡¹ï¼šä»ç¬¬å››æ­¥å¼€å§‹æ‰§è¡Œã€‚åœ¨ slave c ç»Ÿè®¡é€‰ç¥¨é˜¶æ®µï¼Œmaster c ä»ç„¶å¯ä»¥æ­£å¸¸æ¥æ”¶ç”¨æˆ·è¯·æ±‚ï¼Œä¸”ä¸»ä»å¼‚æ­¥å¤åˆ¶ï¼Œè¿™äº›éƒ½å¯èƒ½å¯¼è‡´ write ä¸¢å¤±ã€‚mf å°†åœ¨æœªæ¥çš„æŸä¸ªæ—¶é—´ç‚¹å¼€å§‹æ‰§è¡Œï¼Œtimeout æ—¶é—´ä¸º <strong>CLUSTER_MF_TIMEOUT</strong>ï¼ˆç°ç‰ˆæœ¬ä¸º 5sï¼‰ï¼Œæ¯æ¬¡ clusterCron éƒ½ä¼šæ£€æŸ¥ã€‚</li><li>TAKEOVERé€‰é¡¹ï¼šä»ç¬¬äº”æ­¥å¼€å§‹æ‰§è¡Œã€‚slave ç›´æ¥å¢åŠ è‡ªå·±çš„ configEpochï¼ˆæ— éœ€å…¶ä»–nodeåŒæ„ï¼‰ï¼Œæ¥ç®¡ slotsã€‚ä» slave cåˆ‡æ¢ä¸º master åˆ° åŸ master c æ›´æ–°è·¯ç”± è¿™æ®µæœŸé—´ï¼Œå‘é€åˆ° åŸmaster ä»çš„è¯·æ±‚ï¼Œéƒ½å¯èƒ½å­˜åœ¨ write ä¸¢å¤±çš„å¯èƒ½ã€‚ä¸€èˆ¬åœ¨ä¸€ä¸ª ping çš„æ—¶é—´å†…å®Œæˆï¼Œæ—¶é—´çª—å£å¾ˆå°ã€‚master c å’Œ slave c ä»¥å¤–èŠ‚ç‚¹æ›´æ–°è·¯ç”±æ»ååªä¼šå¸¦æ¥å¤šä¸€æ¬¡çš„ moved é”™è¯¯ï¼Œä¸ä¼šå¯¼è‡´ write ä¸¢å¤±ã€‚</li></ul></li></ul></li><li><p>master é‡å¯clusterState ç»“æ„ä½“ä¸­æœ‰ä¸€ä¸ª <strong>state</strong> æˆå‘˜å˜é‡ï¼Œè¡¨ç¤º cluster çš„å…¨å±€çŠ¶æ€ï¼Œæ§åˆ¶ç€å½“å‰ cluster æ˜¯å¦å¯ä»¥æä¾›æœåŠ¡ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç§å–å€¼ï¼š</p></li><li><ul><li>cluster çŠ¶æ€åˆå§‹åŒ–</li></ul></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#define CLUSTER_OK 0 /* Everything looks ok */</span><br><span class="line"> #define CLUSTER_FAIL 1 /* The cluster can&#x27;t work */</span><br></pre></td></tr></table></figure><p>server é‡å¯åï¼Œstate è¢«åˆå§‹åŒ–ä¸º <strong>CLUSTER_FAIL</strong>ï¼Œæ­¤çŠ¶æ€ä¸‹çš„ cluster æ˜¯æ‹’ç»è®¿é—®çš„ã€‚è¿™å¯¹ä¿è¯ write safety æ˜¯éå¸¸å¿…è¦çš„ï¼å¯ä»¥æƒ³è±¡ï¼Œå¦‚æœ master A æŒ‚æ‰åï¼Œå¯¹åº”çš„ slave Aâ€™ é€šè¿‡é€‰ä¸¾æˆåŠŸå½“é€‰ä¸ºæ–° masterã€‚æ­¤æ—¶ï¼ŒA é‡å¯ï¼Œä¸”æ°å¥½æœ‰ä¸€äº› client çœ‹åˆ°çš„è·¯ç”±æ²¡æœ‰æ›´æ–°ï¼Œå®ƒä»¬ä»ç„¶ä¼šå¾€ A ä¸Šå†™æ•°æ®ï¼Œå¦‚æœæ¥å—è¿™äº› writeï¼Œå°±ä¼šä¸¢æ•°æ®ï¼Aâ€™ æ‰æ˜¯è¿™ä¸ª sharding å¤§å®¶å…¬è®¤çš„ masterã€‚æ‰€ä»¥ï¼ŒAâ€™ é‡å¯åéœ€è¦å…ˆç¦ç”¨æœåŠ¡ï¼Œç›´åˆ°è·¯ç”±å˜æ›´å®Œæˆã€‚æ‰€ä»¥å¦‚æœ <strong>CLUSTER_WRITABLE_DELAY</strong> å†…ï¼Œæœªèƒ½æ›´æ–°è·¯ç”±ï¼Œå¯èƒ½å°±å¯¼è‡´ write ä¸¢å¤±ã€‚</p><ul><li><ul><li>cluster çŠ¶æ€å˜æ›´ä»€ä¹ˆæ—¶å€™ cluster æ‰ä¼šå‡ºç° <strong>CLUSTER_FAIL</strong> -&gt; <strong>CLUSTER_OK</strong> çš„çŠ¶æ€å˜æ›´å‘¢ã€‚ä» clusterCron å®šæ—¶ä»»åŠ¡ä¸­ï¼Œå¯ä»¥çŸ¥é“ clusterCronçŠ¶æ€å˜æ›´è¦å»¶è¿Ÿ <strong>CLUSTER_WRITABLE_DELAY</strong> æ¯«ç§’ï¼Œå½“å‰ç‰ˆæœ¬æ˜¯2sã€‚è®¿é—®å»¶è¿Ÿå°±æ˜¯ä¸ºç­‰å¾… è·¯ç”±å˜æ›´ï¼Œé‚£ä¹ˆä»€ä¹ˆæ—¶å€™è§¦å‘è·¯ç”±å˜æ›´å‘¢ï¼Ÿä¸€ä¸ªæ–° server åˆšå¯åŠ¨ï¼Œå®ƒä¸å…¶ä»– node è¿›è¡Œ gossip é€šä¿¡çš„ link éƒ½æ˜¯ nullï¼Œåœ¨ clusterCron é‡Œæ£€æŸ¥å‡ºæ¥åä¼šä¾æ¬¡è¿æ¥ï¼Œå¹¶å‘é€ pingã€‚ä½œä¸ºä¸€ä¸ªè·¯ç”±è¿‡æœŸçš„è€èŠ‚ç‚¹ï¼Œæ”¶åˆ°å…¶ä»–èŠ‚ç‚¹å‘æ¥çš„ update æ¶ˆæ¯ï¼Œæ›´æ”¹è‡ªèº«è·¯ç”±ã€‚<strong>CLUSTER_WRITABLE_DELAY</strong> æ¯«ç§’åï¼ŒA èŠ‚ç‚¹æ¢å¤è®¿é—®ï¼Œæˆ‘ä»¬è®¤ä¸º CLUSTER_WRITABLE_DELAY çš„æ—¶é—´çª—å£è¶³å¤Ÿæ›´æ–°è·¯ç”±ã€‚</li></ul></li><li><p>ç½‘ç»œåˆ†åŒº</p></li><li><ul><li>ç½‘ç»œåˆ†åŒºå‘ç”Ÿç”±äºç½‘ç»œçš„ä¸å¯é ï¼Œç½‘ç»œåˆ†åŒºæ—¶ä¸€ä¸ªå¿…é¡»è¦è€ƒè™‘çš„é—®é¢˜ã€‚å½“ç½‘ç»œåˆ†åŒºå‘ç”Ÿåï¼Œcluster è¢«å‰²è£‚æˆ majority å’Œ minority ä¸¤éƒ¨åˆ†ï¼Œè¿™é‡Œä»¥åˆ†åŒºä¸­çš„ master èŠ‚ç‚¹æ¥åŒºåˆ†ã€‚</li></ul></li></ul><ol><li><ol><li><ol><li>å¯¹äº minority éƒ¨åˆ†ï¼Œslave ä¼šå‘èµ·é€‰ä¸¾ï¼Œä½†æ˜¯ä¸èƒ½æ”¶åˆ°å¤§å¤šæ•° master çš„é€‰ç¥¨ï¼Œä¹Ÿå°±æ— æ³•å®Œæˆæ­£å¸¸çš„ failover æµç¨‹ã€‚åŒæ—¶åœ¨ clusterCron é‡Œçš„å¤§éƒ¨åˆ†èŠ‚ç‚¹ä¼šè¢«æ ‡è®°ä¸º <strong>CLUSTER_NODE_PFAIL</strong> çŠ¶æ€ï¼Œè¿›è€Œè§¦å‘é›†ç¾¤çŠ¶æ€æ›´æ–°ã€‚åœ¨ minority ä¸­ï¼Œcluster çŠ¶æ€åœ¨ä¸€æ®µæ—¶é—´åï¼Œä¼šè¢«æ›´æ”¹ä¸º <strong>CLUSTER_FAIL</strong>ã€‚ä½†ï¼Œå¯¹äºä¸€ä¸ªåˆ’åˆ†åˆ° minority çš„ master èŠ‚ç‚¹ï¼Œåœ¨çŠ¶æ€æ›´æ”¹å‰æ˜¯ä¸€ç›´å¯ä»¥è®¿é—®çš„ï¼Œè¿™å°±æœ‰ä¸€ä¸ªæ—¶é—´çª—å£ï¼Œä¼šå¯¼è‡´ write ä¸¢å¤±ã€‚åœ¨ clusterCron å‡½æ•°ä¸­å¯ä»¥è®¡ç®—å‡ºè¿™ä¸ªæ—¶é—´çª—å£å¤§å°ï¼šä» partition æ—¶é—´å¼€å§‹ç®—èµ·ï¼Œ<strong>cluster_node_timeout</strong> æ—¶é—´åæ‰ä¼šæœ‰ node æ ‡è®°ä¸º PFAILï¼ŒåŠ ä¸Š gossip æ¶ˆæ¯ä¼ æ’­ä¼šåå‘äºæºå¸¦ PFAIL çš„èŠ‚ç‚¹ï¼ŒmasterèŠ‚ç‚¹ ä¸å¿…ç­‰åˆ° <strong>cluster_node_timeout&#x2F;2</strong> æŠŠ cluster nodes ping éï¼Œå°±å¯ä»¥æŠŠ cluster æ ‡è®°ä¸º <strong>CLUSTER_FAIL</strong>å¯ä»¥æ¨ç®—å‡ºï¼Œæ—¶é—´çª—å£å¤§çº¦ä¸º <strong>cluster_node_timeout</strong>ã€‚å¦å¤–ï¼Œä¼šè®°å½•ä¸‹ç¦ç”¨æœåŠ¡çš„æ—¶é—´ï¼Œå³ among_minority_time</li><li>å¯¹äº majority éƒ¨åˆ†ï¼Œslave ä¼šå‘èµ·é€‰ä¸¾ï¼Œåˆ‡æ¢ä¸ºæ–°çš„masterå¹¶æä¾›æœåŠ¡ã€‚å¦‚æœpartition æ—¶é—´å°äº cluster_node_timeout,ä»¥è‡³äºæ²¡æœ‰ PFAIL æ ‡è¯†å‡ºç°ï¼Œå°±ä¸ä¼šæœ‰ write ä¸¢å¤±ã€‚</li></ol></li></ol></li></ol><ul><li><ul><li>ç½‘ç»œåˆ†åŒºæ¢å¤å½“ç½‘ç»œåˆ†åŒºæ¢å¤åï¼Œminority ä¸­ è€çš„master é‡æ–°åŠ è¿› clusterï¼Œmaster è¦æƒ³æä¾›æœåŠ¡ï¼Œå°±å¿…é¡»å…ˆå°† cluster çŠ¶æ€ä» <strong>CLUSTER_FAIL</strong> ä¿®æ”¹ä¸º <strong>CLUSTER_OK</strong>ï¼Œé‚£ä¹ˆï¼Œåº”è¯¥ä»€ä¹ˆæ—¶å€™æ”¹å‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“ è€masterä¸­åº”è¯¥æ˜¯æ—§è·¯ç”±ï¼Œæ­¤æ—¶å®ƒåº”è¯¥å˜æ›´ä¸º slaveï¼Œæ‰€ä»¥ï¼Œè¿˜æ˜¯éœ€è¦ç­‰å¾…ä¸€æ®µæ—¶é—´åšè·¯ç”±å˜æ›´ï¼Œå¦åˆ™æœ‰å¯èƒ½å‡ºç° write ä¸¢å¤±çš„é—®é¢˜ã€‚ä» clusterUpdateState å‡½æ•°çš„é€»è¾‘é‡Œï¼Œå¯ä»¥çœ‹å‡ºæ—¶é—´çª—å£ä¸º <strong>cluster_node_timeout</strong></li></ul></li></ul><p>æ€»ç»“ï¼š</p><p>failover å¯èƒ½å› ä¸ºé€‰ä¸¾å’Œä¸»ä»å¼‚æ­¥å¤åˆ¶æ•°æ®åå·®å¸¦æ¥ write ä¸¢å¤±ã€‚master é‡å¯é€šè¿‡ <strong>CLUSTER_WRITABLE_DELAY</strong> å»¶è¿Ÿï¼Œç­‰ cluster çŠ¶æ€å˜æ›´ä¸º <strong>CLUSTER_OK</strong>ï¼Œå¯ä»¥é‡æ–°è®¿é—®ï¼Œä¸å­˜åœ¨ write ä¸¢å¤±ã€‚partition ä¸­çš„ minority éƒ¨åˆ†ï¼Œåœ¨ cluster çŠ¶æ€å˜æ›´ä¸º <strong>CLUSTER_FAIL</strong> ä¹‹å‰ï¼Œå¯èƒ½å­˜åœ¨ write ä¸¢å¤±ã€‚partition æ¢å¤åï¼Œé€šè¿‡ rejoin_delay å»¶è¿Ÿï¼Œç­‰ cluster çŠ¶æ€å˜æ›´ä¸º <strong>CLUSTER_OK</strong>ï¼Œå¯ä»¥é‡æ–°è®¿é—®ï¼Œä¸å­˜åœ¨ write ä¸¢å¤±ã€‚</p><h4 id="5-9-10-availability-åˆ†æ"><a href="#5-9-10-availability-åˆ†æ" class="headerlink" title="5.9.10 availability åˆ†æ"></a>5.9.10 availability åˆ†æ</h4><p><a href="https://segmentfault.com/a/1190000039234661?utm_source=sf-similar-article">https://segmentfault.com/a/1190000039234661?utm_source=sf-similar-article</a></p><p>ä¸»è¦åœ¨ä¸‰ç§æƒ…å†µä¸‹ï¼Œå‡ºç°ä¸å¯ç”¨ï¼š</p><ul><li>ç½‘ç»œæ•…éšœRedis Cluster åœ¨å‘ç”Ÿ ç½‘ç»œåˆ†åŒºåï¼Œminority éƒ¨åˆ†æ˜¯ä¸å¯ç”¨çš„ã€‚å‡è®¾ majority éƒ¨åˆ†æœ‰ è¿‡åŠæ•° master å’Œ æ‰€æœ‰ä¸åœ¨majorityçš„masterå…¶ä¸‹çš„ä¸€ä¸ªslaveã€‚é‚£ä¹ˆï¼Œç»è¿‡ NODE_TIMEOUT æ—¶é—´åŠ é¢å¤–å‡ ç§’é’Ÿï¼ˆç»™slaveè¿›è¡Œfailoverï¼‰ï¼Œcluster æ¢å¤å¯ç”¨çŠ¶æ€ã€‚</li><li>sharding ç¼ºå¤±æ•…éšœé»˜è®¤æƒ…å†µä¸‹ï¼Œå½“æ£€æµ‹åˆ°æœ‰ slot æ²¡æœ‰ç»‘å®šï¼ŒRedis Cluster å°±ä¼šåœæ­¢æ¥å—è¯·æ±‚ã€‚åœ¨è¿™ç§é…ç½®ä¸‹ï¼ˆä¸‰ä¸»ä¸‰ä»ï¼‰ï¼Œå¦‚æœ cluster éƒ¨åˆ†èŠ‚ç‚¹æŒ‚æ‰ï¼ˆä¸€ä¸ªä¸»èŠ‚ç‚¹å’Œå…¶å¯¹åº”çš„ä»èŠ‚ç‚¹éƒ½æŒ‚äº†ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªèŒƒå›´å†…çš„ slot ä¸å†æœ‰èŠ‚ç‚¹è´Ÿè´£ï¼Œæœ€ç»ˆæ•´ä¸ª cluster ä¼šå˜çš„ä¸èƒ½æä¾›æœåŠ¡ã€‚<strong>æœ‰æ—¶å€™ï¼ŒæœåŠ¡éƒ¨åˆ†å¯ç”¨æ¯”æ•´ä¸ªä¸å¯ç”¨æ›´æœ‰æ„ä¹‰</strong>ï¼Œå› æ­¤ï¼Œå³ä½¿ä¸€éƒ¨åˆ† sharding å¯ç”¨ï¼Œä¹Ÿè¦è®© cluster æä¾›æœåŠ¡ã€‚redis å°†è¿™ç§é€‰æ‹©æƒäº¤åˆ°äº†ç”¨æˆ·æ‰‹ä¸­ï¼Œconf é‡Œæä¾› <strong>cluster-require-full-coverage</strong> å‚æ•°ã€‚å¦‚æœè¯¥å‚æ•°ä¸ºfalseï¼Œé‚£ä¹ˆæœ‰ slot æœªç»‘å®šæˆ–è€… shardingç¡®å®ï¼Œserver ä¹Ÿæ˜¯å¯ä»¥æ¥å—è¯·æ±‚çš„ã€‚</li><li>å½“é›†ç¾¤èŠ‚ç‚¹å®•æœºï¼Œå‡ºç°é›†ç¾¤MasterèŠ‚ç‚¹ä¸ªæ•°å°äº3ä¸ªçš„æ—¶å€™ï¼Œæˆ–è€…é›†ç¾¤å¯ç”¨èŠ‚ç‚¹ä¸ªæ•°ä¸ºå¶æ•°çš„æ—¶å€™ï¼ŒåŸºäº failover è¿™ç§é€‰ä¸¾æœºåˆ¶çš„è‡ªåŠ¨ä¸»ä»åˆ‡æ¢è¿‡ç¨‹å¯èƒ½ä¼šä¸èƒ½æ­£å¸¸å·¥ä½œã€‚æ ‡è®° failã€ä»¥åŠé€‰ä¸¾æ–°masterçš„è¿‡ç¨‹ï¼Œéƒ½å¯èƒ½å¼‚å¸¸ã€‚</li></ul><h5 id="replicas-migration-åŠŸèƒ½"><a href="#replicas-migration-åŠŸèƒ½" class="headerlink" title="replicas migration åŠŸèƒ½"></a>replicas migration åŠŸèƒ½</h5><p>ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä¸€ä¸ªåŒ…å«Nä¸ª master çš„é›†ç¾¤ï¼Œæ¯ä¸ªMaster æœ‰å”¯ä¸€ slaveã€‚å•ä¸ª node å‡ºç°æ•…éšœï¼Œclusterå¿…å®šä»ç„¶å¯ç”¨ï¼›ç¬¬äºŒä¸ª node å†å‡ºç°å†å‡ºç°æ•…éšœã€‚å¦‚æœç¬¬äºŒä¸ªèŠ‚ç‚¹æ­£å¥½æ˜¯ä¸Šé¢å·²ç»æ•…éšœçš„masterèŠ‚ç‚¹çš„slaveï¼Œåˆ™æ­¤æ—¶é›†ç¾¤ä¸å¯ç”¨ã€‚å¦‚æœç¬¬äºŒä¸ªèŠ‚ç‚¹æ˜¯å…¶ä»–èŠ‚ç‚¹ï¼Œåˆ™é›†ç¾¤ä»ç„¶å¯ç”¨ã€‚æ‰€ä»¥é›†ç¾¤ä¸å¯ç”¨çš„æ¦‚ç‡æ˜¯ 1&#x2F;(N*2-1) </p><p>Redis Cluster ä¸ºäº†æé«˜å¯ç”¨æ€§ï¼Œè¿™ä¸ªæ˜¯ç”¨äºåœ¨æ¯æ¬¡æ•…éšœä¹‹åï¼Œé‡æ–°å¸ƒå±€é›†ç¾¤çš„slaveï¼Œç»™æ²¡æœ‰slaveçš„masteré…å¤‡ä¸Šslaveï¼Œä»¥æ­¤æ¥æ›´å¥½åº”å¯¹ä¸‹æ¬¡æ•…éšœã€‚</p><p>å…·ä½“å®ç°ï¼š</p><p>è¿™ç§è´Ÿè´£ éƒ¨åˆ†slotä½†æ˜¯æ²¡æœ‰å¥åº·slaveçš„ masterï¼Œå°±ç§°ä¸º orphaned masterã€‚å½“slaveæ£€æµ‹åˆ°è‡ªå·±çš„ master æ‹¥æœ‰ä¸å°‘äº2ä¸ªå¥åº·slaveï¼Œä¸” cluster ä¸­æ°å¥½æœ‰ orphan master æ—¶ï¼Œè§¦å‘ clusterHandleSlaveMigration å‡½æ•°é€»è¾‘ï¼Œå°è¯•è¿›è¡Œ slave æ¼‚ç§»ï¼Œslaveæ­¥éª¤æœ‰å¦‚ä¸‹å››æ­¥</p><ol><li>CLUSTER_FAIL é›†ç¾¤æ¼‚ç§» if (server.cluster-&gt;state !&#x3D; CLUSTER_OK) return;é CLUSTER_OK é›†ç¾¤æœ¬æ¥æ—§æ— æ³•æ­£å¸¸æ¥æ”¶è¯·æ±‚ï¼Œæ‰€ä»¥ä¹Ÿä¸éœ€è¦æ¼‚ç§»ã€‚</li><li>æ£€æŸ¥ cluster-migration-barrier å‚æ•°<strong>redis conf æä¾›äº†cluster-migration-barrier å‚æ•°</strong>ï¼Œç”¨æ¥å†³å®š slave æ•°é‡è¾¾åˆ°å¤šå°‘ä¸ªæ‰ä¼šæŠŠå†—ä½™ slave æ¼‚ç§»å‡ºå»ã€‚åªæœ‰ master å¥åº· slave çš„ä¸ªæ•°è¶…è¿‡ cluster-migration-barrier é…ç½®çš„æ•°é‡æ—¶ï¼Œæ‰ä¼šæ¼‚ç§»ã€‚</li><li>é€‰å‡ºè¦æ¼‚ç§»çš„ slaveï¼Œä»¥åŠæ¼‚ç§»ç»™è°ã€‚é€‰æ‹© node name æœ€å°çš„slaveï¼Œæ¼‚ç§»ç»™éå†åˆ°çš„ç¬¬ä¸€ä¸ª orphaned master</li><li>æ‰§è¡Œæ¼‚ç§»åœ¨ failover æœŸé—´ï¼Œmaster æœ‰ä¸€æ®µæ—¶é—´æ˜¯æ²¡æœ‰ slaveï¼Œä¸ºäº†é˜²æ­¢è¯¯æ¼‚ï¼Œæ¼‚ç§»å¿…é¡»æœ‰ä¸€å®šçš„å»¶è¿Ÿã€‚æ—¶é—´ä¸º CLUSTER_SLAVE_MIGRATION _DELAY ç°ç‰ˆæœ¬ä¸º 5sã€‚</li></ol><h2 id="å…­ã€Redisson"><a href="#å…­ã€Redisson" class="headerlink" title="å…­ã€Redisson"></a>å…­ã€Redisson</h2><h3 id="6-1-åˆ†å¸ƒå¼é”"><a href="#6-1-åˆ†å¸ƒå¼é”" class="headerlink" title="6.1 åˆ†å¸ƒå¼é”"></a>6.1 åˆ†å¸ƒå¼é”</h3><p>åˆ†å¸ƒå¼é”ï¼Œæ˜¯æ§åˆ¶åˆ†å¸ƒå¼ç³»ç»Ÿä¸åŒè¿›ç¨‹å…±åŒè®¿é—®å…±äº«èµ„æºçš„ä¸€ç§é”çš„å®ç°ã€‚ç§’æ€ä¸‹å•ã€æŠ¢çº¢åŒ…ç­‰ç­‰ä¸šåŠ¡åœºæ™¯ï¼Œéƒ½éœ€è¦ç”¨åˆ°åˆ†å¸ƒå¼é”ã€‚</p><h4 id="6-1-1-å¸¸è§redis-åˆ†å¸ƒå¼é”"><a href="#6-1-1-å¸¸è§redis-åˆ†å¸ƒå¼é”" class="headerlink" title="6.1.1 å¸¸è§redis åˆ†å¸ƒå¼é”"></a>6.1.1 å¸¸è§redis åˆ†å¸ƒå¼é”</h4><p>ä¸€èˆ¬Redisåˆ†å¸ƒå¼é”æœ‰å¦‚ä¸‹å‡ ç§å®ç°æ–¹æ¡ˆï¼š</p><ul><li>å‘½ä»¤ setnx + expire åˆ†å¼€å†™</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">if(jedis.setnx(key,lock_value) == 1)&#123; // åŠ é”</span><br><span class="line">    expire(key,100);  // è®¾ç½®è¿‡æœŸæ—¶é—´</span><br><span class="line">    try&#123;</span><br><span class="line">        do something // ä¸šåŠ¡å¤„ç†</span><br><span class="line">    &#125;catch()&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;finally&#123; </span><br><span class="line">      jedis.del(key); // é‡Šæ”¾é”</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæ‰§è¡Œå®Œ setnx åŠ é”ï¼Œæ­£è¦æ‰§è¡Œ expire è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œè¿›è¡Œcrashæˆ–è€…é‡å¯ç»´æŠ¤ï¼Œé‚£ä¹ˆè¿™ä¸ªé”å°±ä¸€ç›´è¢«é”ä½äº†ï¼Œåˆ«çš„çº¿ç¨‹æ°¸è¿œè·å–ä¸åˆ°é”äº†ï¼Œæ‰€ä»¥åˆ†å¸ƒå¼ä¸èƒ½è¿™ç§å®ç°ã€‚</p><ul><li>setnx + value å€¼è¿‡æœŸæ—¶é—´ä¸ºäº†è§£å†³æ–¹æ¡ˆä¸€ï¼Œå‘ç”Ÿå¼‚å¸¸é”å¾—ä¸åˆ°é‡Šæ”¾çš„åœºæ™¯ã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">long expires = System.currentTimeMillis() + expireTime; // ç³»ç»Ÿæ—¶é—´ + è®¾ç½®çš„è¿‡æœŸæ—¶é—´</span><br><span class="line">if(jedis.setnx(key,expires) == 1)&#123;</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br><span class="line">// å¦‚æœå½“å‰é”ä¸å­˜åœ¨ï¼Œè¿”å›åŠ é”æˆåŠŸ</span><br><span class="line">if (jedis.setnx(key_resource_id, String.vaue(expires)) == 1) &#123;</span><br><span class="line">        return true;</span><br><span class="line">&#125; </span><br><span class="line">// å¦‚æœé”å·²ç»å­˜åœ¨ï¼Œè·å–é”çš„è¿‡æœŸæ—¶é—´</span><br><span class="line">String currentValueStr = jedis.get(key_resource_id);</span><br><span class="line"></span><br><span class="line">// å¦‚æœè·å–åˆ°çš„è¿‡æœŸæ—¶é—´ï¼Œå°äºç³»ç»Ÿå½“å‰æ—¶é—´ï¼Œè¡¨ç¤ºå·²ç»è¿‡æœŸ</span><br><span class="line">if (currentValueStr != null &amp;&amp; Long.parseLong(currentValueStr) &lt; System.currentTimeMillis()) &#123;</span><br><span class="line"></span><br><span class="line">         // é”å·²è¿‡æœŸï¼Œè·å–ä¸Šä¸€ä¸ªé”çš„è¿‡æœŸæ—¶é—´ï¼Œå¹¶è®¾ç½®ç°åœ¨é”çš„è¿‡æœŸæ—¶é—´</span><br><span class="line">        String oldValueStr = jedis.getSet(key_resource_id, expiresStr);</span><br><span class="line"></span><br><span class="line">        if (oldValueStr != null &amp;&amp; oldValueStr.equals(currentValueStr)) &#123;</span><br><span class="line">             // è€ƒè™‘å¤šçº¿ç¨‹å¹¶å‘çš„æƒ…å†µï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„è®¾ç½®å€¼å’Œå½“å‰å€¼ç›¸åŒï¼Œå®ƒæ‰å¯ä»¥åŠ é”</span><br><span class="line">             return true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    //å…¶ä»–æƒ…å†µï¼Œå‡è¿”å›åŠ é”å¤±è´¥</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸€æ–¹æ¡ˆå·§å¦™ç§»é™¤äº† expire å•ç‹¬è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ“ä½œï¼ŒæŠŠè¿‡æœŸæ—¶é—´æ”¾åˆ°äº† setnx çš„ value å€¼ä¸­ã€‚è§£å†³äº† å‘ç”Ÿå¼‚å¸¸é”å¾—ä¸åˆ°é‡Šæ”¾çš„é—®é¢˜ã€‚ä½†æ˜¯æ­¤æ–¹æ¡ˆä¹Ÿæœ‰è‡ªå·±çš„ç¼ºç‚¹ï¼š</p><ul><li><ul><li>è¿‡æœŸæ—¶é—´æ˜¯å®¢æˆ·ç«¯è‡ªå·±ç”Ÿæˆçš„ï¼ˆSystem.currentTimeMillis()æ˜¯å½“å‰ç³»ç»Ÿçš„æ—¶é—´ï¼‰ï¼Œå¿…é¡»è¦æ±‚åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯çš„æ—¶é—´å¿…é¡»åŒæ­¥ã€‚</li><li>å¦‚æœé”è¿‡æœŸçš„æ—¶å€™ï¼Œå¹¶å‘å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶è¯·æ±‚è¿‡æ¥ï¼Œéƒ½æ‰§è¡Œjedis.getSet()ï¼Œæœ€ç»ˆåªèƒ½æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯åŠ é”æˆåŠŸï¼Œä½†æ˜¯è¯¥å®¢æˆ·ç«¯é”çš„è¿‡æœŸæ—¶é—´ï¼Œå¯èƒ½è¢«åˆ«çš„å®¢æˆ·ç«¯è¦†ç›–</li><li>è¯¥é”æ²¡æœ‰ä¿å­˜æŒæœ‰è€…çš„å”¯ä¸€æ ‡è¯†ï¼Œå¯èƒ½è¢«åˆ«çš„å®¢æˆ·ç«¯é‡Šæ”¾&#x2F;è§£é”ã€‚</li></ul></li><li><p>set çš„æ‰©å±•å‘½ä»¤ï¼ˆset ex px nxï¼‰Redis çš„ set æ‰©å±•å‚æ•°ï¼ˆSET key value[EX seconds][PX milliseconds][NX|XX]ï¼‰æ˜¯åŸå­æ€§çš„ã€‚EX secondsï¼šè®¾å®škeyçš„è¿‡æœŸæ—¶é—´ï¼Œæ—¶é—´å•ä½æ˜¯ç§’ã€‚PX millisecondsï¼šè®¾å®škeyçš„è¿‡æœŸæ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’NXï¼šè¡¨ç¤ºkeyä¸å­˜åœ¨çš„æ—¶å€™ï¼Œæ‰èƒ½setæˆåŠŸï¼Œä¹Ÿå³ä¿è¯åªæœ‰ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯è¯·æ±‚æ‰èƒ½è·å–é”ï¼Œè€Œå…¶ä»–å®¢æˆ·ç«¯è¯·æ±‚åªèƒ½ç­‰èµ·é‡Šæ”¾é”ï¼Œæ‰èƒ½è·å–ã€‚XXï¼šä»…å½“keyå­˜åœ¨æ—¶è®¾ç½®å€¼</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ifï¼ˆjedis.set(key_resource_id, lock_value, &quot;NX&quot;, &quot;EX&quot;, 100s) == 1ï¼‰&#123; //åŠ é”</span><br><span class="line">    try &#123;</span><br><span class="line">        do something  //ä¸šåŠ¡å¤„ç†</span><br><span class="line">    &#125;catch()&#123;</span><br><span class="line">ã€€ã€€&#125;</span><br><span class="line">ã€€ã€€finally &#123;</span><br><span class="line">       jedis.del(key_resource_id); //é‡Šæ”¾é”</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯å‘¢ï¼Œè¿™ä¸ªæ–¹æ¡ˆè¿˜æ˜¯å¯èƒ½å­˜åœ¨é—®é¢˜ï¼šé—®é¢˜ä¸€ï¼š<strong>é”è¿‡æœŸé‡Šæ”¾äº†ï¼Œä¸šåŠ¡è¿˜æ²¡æ‰§è¡Œå®Œ</strong>ã€‚å‡è®¾çº¿ç¨‹aè·å–é”æˆåŠŸï¼Œä¸€ç›´åœ¨æ‰§è¡Œä¸´ç•ŒåŒºçš„ä»£ç ã€‚ä½†æ˜¯100sè¿‡å»åï¼Œå®ƒè¿˜æ²¡æ‰§è¡Œå®Œã€‚ä½†æ˜¯ï¼Œè¿™æ—¶å€™é”å·²ç»è¿‡æœŸäº†ï¼Œæ­¤æ—¶çº¿ç¨‹båˆè¯·æ±‚è¿‡æ¥ã€‚æ˜¾ç„¶çº¿ç¨‹bå°±å¯ä»¥è·å¾—é”æˆåŠŸï¼Œä¹Ÿå¼€å§‹æ‰§è¡Œä¸´ç•ŒåŒºçš„ä»£ç ã€‚é‚£ä¹ˆé—®é¢˜å°±æ¥äº†ï¼Œä¸´ç•ŒåŒºçš„ä¸šåŠ¡ä»£ç éƒ½ä¸æ˜¯ä¸¥æ ¼ä¸²è¡Œæ‰§è¡Œçš„å•¦ã€‚é—®é¢˜äºŒï¼š<strong>é”è¢«åˆ«çš„çº¿ç¨‹è¯¯åˆ </strong>ã€‚å‡è®¾çº¿ç¨‹aæ‰§è¡Œå®Œåï¼Œå»é‡Šæ”¾é”ã€‚ä½†æ˜¯å®ƒä¸çŸ¥é“å½“å‰çš„é”å¯èƒ½æ˜¯çº¿ç¨‹bæŒæœ‰çš„ï¼ˆçº¿ç¨‹aå»é‡Šæ”¾é”æ—¶ï¼Œæœ‰å¯èƒ½è¿‡æœŸæ—¶é—´å·²ç»åˆ°äº†ï¼Œæ­¤æ—¶çº¿ç¨‹bè¿›æ¥å æœ‰äº†é”ï¼‰ã€‚é‚£çº¿ç¨‹aå°±æŠŠçº¿ç¨‹bçš„é”é‡Šæ”¾æ‰äº†ï¼Œä½†æ˜¯çº¿ç¨‹bä¸´ç•ŒåŒºä¸šåŠ¡ä»£ç å¯èƒ½éƒ½è¿˜æ²¡æ‰§è¡Œå®Œå‘¢ã€‚</p><ul><li>set ex px nx + æ ¡éªŒå”¯ä¸€éšæœºå€¼ å†åˆ é™¤æ—¢ç„¶é”å¯èƒ½è¢«åˆ«çš„çº¿ç¨‹è¯¯åˆ ï¼Œé‚£æˆ‘ä»¬ç»™valueå€¼è®¾ç½®ä¸€ä¸ªæ ‡è®°å½“å‰çº¿ç¨‹å”¯ä¸€çš„éšæœºæ•°ï¼Œåœ¨åˆ é™¤çš„æ—¶å€™ï¼Œæ ¡éªŒä¸€ä¸‹ï¼Œä¸å°±OKäº†å˜›ã€‚ä¼ªä»£ç å¦‚ä¸‹ï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ifï¼ˆjedis.set(key_resource_id, uni_request_id, &quot;NX&quot;, &quot;EX&quot;, 100s) == 1ï¼‰&#123; //åŠ é”</span><br><span class="line">    try &#123;</span><br><span class="line">        do something  //ä¸šåŠ¡å¤„ç†</span><br><span class="line">    &#125;catch()&#123;</span><br><span class="line">ã€€ã€€&#125;</span><br><span class="line">ã€€ã€€finally &#123;</span><br><span class="line">       //åˆ¤æ–­æ˜¯ä¸æ˜¯å½“å‰çº¿ç¨‹åŠ çš„é”,æ˜¯æ‰é‡Šæ”¾</span><br><span class="line">       if (uni_request_id.equals(jedis.get(key_resource_id))) &#123;</span><br><span class="line">        jedis.del(lockKey); //é‡Šæ”¾é”</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œï¼Œ<strong>åˆ¤æ–­æ˜¯ä¸æ˜¯å½“å‰çº¿ç¨‹åŠ çš„é”</strong>å’Œ<strong>é‡Šæ”¾é”</strong>ä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œã€‚å¦‚æœè°ƒç”¨jedis.del()é‡Šæ”¾é”çš„æ—¶å€™ï¼Œå¯èƒ½è¿™æŠŠé”å·²ç»ä¸å±äºå½“å‰å®¢æˆ·ç«¯ï¼Œä¼šè§£é™¤ä»–äººåŠ çš„é”ã€‚å› ä¸º finally éƒ¨åˆ†æ‰§è¡Œæ—¶ä¸èƒ½ä¿è¯åŸå­æ€§ï¼Œä¸€èˆ¬ä¹Ÿæ˜¯ç”¨ luaè„šæœ¬ä»£æ›¿ã€‚</p><h4 id="6-1-2-Redisson-çš„è§£å†³æ–¹æ¡ˆ"><a href="#6-1-2-Redisson-çš„è§£å†³æ–¹æ¡ˆ" class="headerlink" title="6.1.2 Redisson çš„è§£å†³æ–¹æ¡ˆ"></a>6.1.2 Redisson çš„è§£å†³æ–¹æ¡ˆ</h4><p><strong>1. å•æœºæ–¹æ¡ˆ</strong></p><p>å…¶å®ä¸Šé¢çš„æ–¹æ¡ˆè¿˜æ˜¯ä¼šå­˜åœ¨ é”è¿‡æœŸé‡Šæ”¾ï¼Œä¸šåŠ¡æ²¡æœ‰æ‰§è¡Œå®Œçš„é—®é¢˜ã€‚æ‰€ä»¥å…¶å®æˆ‘ä»¬å¯ä»¥å¼€å¯ä¸€ä¸ªå®šæ—¶å®ˆæŠ¤çº¿ç¨‹ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´æ£€æŸ¥é”æ˜¯å¦è¿˜å­˜åœ¨ï¼Œå­˜åœ¨åˆ™å¯¹é”è¿‡æœŸæ—¶é—´å»¶é•¿ï¼Œé˜²æ­¢é”è¿‡æœŸæå‰é‡Šæ”¾ã€‚</p><p>åªè¦çº¿ç¨‹1åŠ é”æˆåŠŸï¼Œå°±ä¼šå¯åŠ¨ä¸€ä¸ª watch dogï¼Œå®ƒæ˜¯ä¸€ä¸ªåå°çº¿ç¨‹ï¼Œä¼šæ¯éš”10ç§’æ£€æŸ¥ä¸€ä¸‹é”ã€‚å¦‚æœçº¿ç¨‹1è¿˜æŒæœ‰é”ï¼Œé‚£ä¹ˆå°±ä¼šä¸æ–­çš„å»¶é•¿é”keyçš„è¿‡æœŸæ—¶é—´ã€‚å› æ­¤ Redission è§£å†³äº† ä¸šåŠ¡è¿˜æ²¡æ‰§è¡Œå®Œ é”å°±è¿‡æœŸé‡Šæ”¾çš„ é—®é¢˜ã€‚</p><p><strong>2. åŸºäºæ•…éšœè½¬ç§»çš„RedLockç®—æ³•</strong></p><p>ä¸Šé¢çš„æ‰€æœ‰çš„æ–¹æ¡ˆéƒ½æ˜¯åŸºäºå•æœºç‰ˆçš„ï¼Œç„¶è€Œå®é™…ä¸Šç”Ÿäº§ç¯å¢ƒrediséƒ½æ˜¯é›†ç¾¤éƒ¨ç½²ã€‚</p><p>ç›´æ¥åœ¨ redis ä¸»ä»é›†ç¾¤ä¸­ä½¿ç”¨ä¸Šé¢çš„æ–¹æ¡ˆï¼Œä¼šæœ‰å¦‚ä¸‹é—®é¢˜ï¼š</p><p>å®¢æˆ·ç«¯åœ¨ Redis çš„ master èŠ‚ç‚¹ä¸Šæ‹¿åˆ°äº† é”ï¼Œä½†æ˜¯è¿™ä¸ªé”è¿˜æ²¡æœ‰åŒæ­¥åˆ° slave èŠ‚ç‚¹ä¸Šï¼ŒmasterèŠ‚ç‚¹å°±å‘ç”Ÿäº†æ•…éšœã€‚ç„¶åè¿›è¡Œäº†æ•…éšœè½¬ç§»ï¼ŒslaveèŠ‚ç‚¹å‡çº§ä¸º masterèŠ‚ç‚¹ã€‚å› æ­¤ å®¢æˆ·ç«¯ åŠ çš„é”ä¸¢å¤±äº†ã€‚</p><p>å› æ­¤Redisä½œè€…antirezåŸºäºåˆ†å¸ƒå¼ç¯å¢ƒä¸‹æå‡ºäº†ä¸€ç§æ›´é«˜çº§çš„åˆ†å¸ƒå¼é”çš„å®ç°æ–¹å¼ï¼š<strong>Redlock</strong>ã€‚</p><p><strong>Redlockæ¶æ„å›¾</strong></p><p>åº”ç”¨å‰æï¼šåœ¨Redisçš„åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬å‡è®¾æœ‰Nä¸ªRedis masterã€‚è¿™äº›èŠ‚ç‚¹<strong>å®Œå…¨äº’ç›¸ç‹¬ç«‹ï¼Œä¸å­˜åœ¨ä¸»ä»å¤åˆ¶æˆ–è€…å…¶ä»–é›†ç¾¤åè°ƒæœºåˆ¶</strong>ã€‚æˆ‘ä»¬ç¡®ä¿å°†åœ¨Nä¸ªå®ä¾‹ä¸Šä½¿ç”¨ä¸åœ¨Rediså•å®ä¾‹ä¸‹ç›¸åŒæ–¹æ³•è·å–å’Œé‡Šæ”¾é”ã€‚ç°åœ¨æˆ‘ä»¬å‡è®¾æœ‰5ä¸ªRedis masterèŠ‚ç‚¹ï¼ŒåŒæ—¶æˆ‘ä»¬éœ€è¦åœ¨5å°æœåŠ¡å™¨ä¸Šé¢è¿è¡Œè¿™äº›Rediså®ä¾‹ï¼Œè¿™æ ·ä¿è¯ä»–ä»¬ä¸ä¼šåŒæ—¶éƒ½å®•æ‰ã€‚</p><p>å®ç°æ­¥éª¤ï¼š</p><ol><li>è·å–å½“å‰çš„æ—¶é—´æˆ³</li><li>ä¾æ¬¡å°è¯•å‘5ä¸ªå®ä¾‹ï¼Œä½¿ç”¨ç›¸åŒçš„ key å’Œ å…·æœ‰å”¯ä¸€æ€§çš„valueï¼ˆä¾‹å¦‚UUIDï¼‰è·å–é”ã€‚å®¢æˆ·ç«¯è¯·æ±‚å„å®ä¾‹è·å–é”æ—¶ï¼Œåº”æœ‰è®¾ç½®å“åº”è¶…æ—¶æ—¶é—´ã€‚å¹¶ä¸”è¿™ä¸ªå“åº”è¶…æ—¶æ—¶é—´å°½é‡è¿œå°äºé”çš„å¤±æ•ˆæ—¶é—´ã€‚å¦‚æ­¤è®¾è®¡çš„åŸå› ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬ä¸èƒ½åœ¨å·²ç»æŒ‚æ‰çš„masterä¸ŠèŠ±è´¹å¤ªå¤šæ—¶é—´ã€‚å¦‚æœèŠ±è´¹å¤ªå¤šæ—¶é—´ï¼Œä¼šé€ æˆè¿˜æ²¡å‘å…¨éƒ¨masterè¯·æ±‚å®Œï¼Œé”çš„å¤±æ•ˆæ—¶é—´å°±å·²ç»åˆ°äº†ã€‚å› æ­¤ å¦‚æœæœåŠ¡å™¨ç«¯æ²¡æœ‰åœ¨è§„å®šæ—¶é—´å†…å“åº”ï¼Œå®¢æˆ·ç«¯åº”è¯¥å°½å¿«å°è¯•å»å¦å¤–ä¸€ä¸ªRediså®ä¾‹è¯·æ±‚è·å–é”ã€‚</li><li>å®¢æˆ·ç«¯ä½¿ç”¨å½“å‰æ—¶é—´å‡å»å¼€å§‹è·å–é”çš„æ—¶é—´ï¼ˆæ­¥éª¤1è®°å½•çš„æ—¶é—´ï¼‰ï¼Œå°±å¯ä»¥å¾—åˆ° è·å–é” æ‰€ç”¨çš„æ—¶é—´ã€‚<strong>å½“ä¸”ä»…å½“ä»å¤§å¤šæ•°ï¼ˆN&#x2F;2+1ï¼Œè¿™é‡Œæ˜¯3ä¸ªèŠ‚ç‚¹ï¼‰çš„RedisèŠ‚ç‚¹éƒ½å–åˆ°é”ï¼Œå¹¶ä¸”æ•´ä¸ªè¿‡ç¨‹ä½¿ç”¨çš„æ—¶é—´å°äºé”å¤±æ•ˆæ—¶é—´æ—¶ï¼Œé”æ‰ç®—è·å–æˆåŠŸ</strong>ã€‚</li><li>å¦‚æœå–åˆ°äº†é”ï¼Œkeyçš„çœŸæ­£æœ‰æ•ˆæ—¶é—´ç­‰äºæœ‰æ•ˆæ—¶é—´å‡å»è·å–é”æ‰€ä½¿ç”¨çš„æ—¶é—´ï¼ˆæ­¥éª¤3è®¡ç®—çš„ç»“æœï¼‰ã€‚</li><li>å¦‚æœå› ä¸ºæŸäº›åŸå› ï¼Œè·å–é”å¤±è´¥ï¼ˆæ²¡æœ‰åœ¨è‡³å°‘N&#x2F;2+1ä¸ªRediså®ä¾‹å–åˆ°é”æˆ–è€…å–é”æ—¶é—´å·²ç»è¶…è¿‡äº†æœ‰æ•ˆæ—¶é—´ï¼‰ï¼Œå®¢æˆ·ç«¯åº”è¯¥åœ¨<strong>æ‰€æœ‰çš„Rediså®ä¾‹ä¸Šè¿›è¡Œè§£é”</strong>ï¼ˆå³ä¾¿æŸäº›Rediså®ä¾‹æ ¹æœ¬å°±æ²¡æœ‰åŠ é”æˆåŠŸï¼Œé˜²æ­¢æŸäº›èŠ‚ç‚¹è·å–åˆ°é”ä½†æ˜¯å®¢æˆ·ç«¯æ²¡æœ‰å¾—åˆ°å“åº”è€Œå¯¼è‡´æ¥ä¸‹æ¥çš„ä¸€æ®µæ—¶é—´ä¸èƒ½è¢«é‡æ–°è·å–é”ï¼‰ã€‚</li></ol><h2 id="ä¸ƒã€Redisåº”ç”¨é—®é¢˜"><a href="#ä¸ƒã€Redisåº”ç”¨é—®é¢˜" class="headerlink" title="ä¸ƒã€Redisåº”ç”¨é—®é¢˜"></a>ä¸ƒã€Redisåº”ç”¨é—®é¢˜</h2><h3 id="7-1-Redisä¸MySQLåŒå†™ä¸€è‡´æ€§å¦‚ä½•ä¿è¯ï¼Ÿ"><a href="#7-1-Redisä¸MySQLåŒå†™ä¸€è‡´æ€§å¦‚ä½•ä¿è¯ï¼Ÿ" class="headerlink" title="7.1 Redisä¸MySQLåŒå†™ä¸€è‡´æ€§å¦‚ä½•ä¿è¯ï¼Ÿ"></a>7.1 Redisä¸MySQLåŒå†™ä¸€è‡´æ€§å¦‚ä½•ä¿è¯ï¼Ÿ</h3><p>ä¸€æ—¦å‡ºç°æ•°æ®æ›´æ–°ï¼Œredisä¸æ•°æ®åº“ä¹‹é—´çš„æ•°æ®ä¸€è‡´æ€§é—®é¢˜å°±ä¼šå‡ºç°ã€‚</p><p>ä¸€è‡´æ€§å°±æ˜¯æ•°æ®ä¿æŒä¸€è‡´ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¯ä»¥ç†è§£ä¸ºå¤šä¸ªèŠ‚ç‚¹ä¸­æ•°æ®çš„å€¼æ˜¯ä¸€è‡´çš„ã€‚</p><ul><li><strong>å¼ºä¸€è‡´æ€§</strong>ï¼šè¿™ç§ä¸€è‡´æ€§çº§åˆ«æ˜¯æœ€ç¬¦åˆç”¨æˆ·ç›´è§‰çš„ï¼Œå®ƒè¦æ±‚ç³»ç»Ÿå†™å…¥ä»€ä¹ˆï¼Œè¯»å‡ºæ¥çš„ä¹Ÿä¼šæ˜¯ä»€ä¹ˆï¼Œç”¨æˆ·ä½“éªŒå¥½ï¼Œä½†å®ç°èµ·æ¥å¾€å¾€å¯¹ç³»ç»Ÿçš„æ€§èƒ½å½±å“å¤§</li><li><strong>å¼±ä¸€è‡´æ€§</strong>ï¼šè¿™ç§ä¸€è‡´æ€§çº§åˆ«çº¦æŸäº†ç³»ç»Ÿåœ¨å†™å…¥æˆåŠŸåï¼Œä¸æ‰¿è¯ºç«‹å³å¯ä»¥è¯»åˆ°å†™å…¥çš„å€¼ï¼Œä¹Ÿä¸æ‰¿è¯ºå¤šä¹…ä¹‹åæ•°æ®èƒ½å¤Ÿè¾¾åˆ°ä¸€è‡´ï¼Œä½†ä¼šå°½å¯èƒ½åœ°ä¿è¯åˆ°æŸä¸ªæ—¶é—´çº§åˆ«ï¼ˆæ¯”å¦‚ç§’çº§åˆ«ï¼‰åï¼Œæ•°æ®èƒ½å¤Ÿè¾¾åˆ°ä¸€è‡´çŠ¶æ€</li><li><strong>æœ€ç»ˆä¸€è‡´æ€§</strong>ï¼šæœ€ç»ˆä¸€è‡´æ€§æ˜¯å¼±ä¸€è‡´æ€§çš„ä¸€ä¸ªç‰¹ä¾‹ï¼Œç³»ç»Ÿä¼šä¿è¯åœ¨ä¸€å®šæ—¶é—´å†…ï¼Œèƒ½å¤Ÿè¾¾åˆ°ä¸€ä¸ªæ•°æ®ä¸€è‡´çš„çŠ¶æ€ã€‚è¿™é‡Œä¹‹æ‰€ä»¥å°†æœ€ç»ˆä¸€è‡´æ€§å•ç‹¬æå‡ºæ¥ï¼Œæ˜¯å› ä¸ºå®ƒæ˜¯å¼±ä¸€è‡´æ€§ä¸­éå¸¸æ¨å´‡çš„ä¸€ç§ä¸€è‡´æ€§æ¨¡å‹ï¼Œä¹Ÿæ˜¯ä¸šç•Œåœ¨å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ•°æ®ä¸€è‡´æ€§ä¸Šæ¯”è¾ƒæ¨å´‡çš„æ¨¡å‹</li></ul><p><strong>æ˜¯é€‰æ‹©æ›´æ–°ç¼“å­˜è¿˜æ˜¯åˆ é™¤ç¼“å­˜ï¼Ÿ</strong></p><p>å¦‚æœ çº¿ç¨‹Aå…ˆæ›´æ–°æ•°æ®åº“ï¼Œä¹‹åçº¿ç¨‹Bä¹Ÿå‘æ•°æ®åº“ä¸­æ›´æ–°åŒä¸€å€¼ï¼Œä½†æ˜¯Bè¯·æ±‚å¿«ï¼Œå…ˆå†™å…¥äº†ç¼“å­˜ï¼ŒAåå†™å…¥äº†ç¼“å­˜ã€‚é‚£ä¹ˆå®é™…ä¸Š ç¼“å­˜ä¸­è¿˜æ˜¯æ—§å€¼ï¼Œè€Œæ•°æ®åº“ä¸­æ˜¯Bæ›´æ”¹åçš„æ–°å€¼ã€‚å¯¼è‡´æ•°æ®æœ€ç»ˆä¸ä¸€è‡´ã€‚</p><p>ä½†æ˜¯ä½ é€‰æ‹©çš„æ˜¯åˆ é™¤ç¼“å­˜ã€‚é‚£ä¹ˆåœ¨æœ€åä¸€æ¬¡åˆ é™¤ç¼“å­˜åï¼Œè¯·æ±‚å†æ¥æ—¶ä¼šæŸ¥è¯¢æ•°æ®åº“æœ€æ–°æ•°æ®ã€‚é‚£ä¹ˆå°±é¿å…äº†è¿™ä¸ªé—®é¢˜ã€‚æ‰€ä»¥ æˆ‘ä»¬é€‰æ‹© åˆ é™¤ç¼“å­˜ã€‚</p><p>ä¸ç®¡æ˜¯å…ˆåˆ é™¤ç¼“å­˜å†æ›´æ–°æ•°æ®åº“ï¼Œè¿˜æ˜¯å…ˆæ›´æ–°æ•°æ®åº“å†åˆ é™¤ç¼“å­˜ï¼Œéƒ½æœ‰å¯èƒ½å­˜åœ¨æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚</p><ol><li><strong>å…ˆåˆ é™¤ç¼“å­˜å†æ›´æ–°æ•°æ®åº“</strong>ï¼šåœ¨åˆ é™¤ç¼“å­˜åï¼Œæ›´æ–°æ•°æ®åº“å‰ã€‚å°±å¯èƒ½ä¼šæœ‰ä¸ªè¯·æ±‚è·å–ç¼“å­˜ï¼Œæ­¤æ—¶ç¼“å­˜æ²¡æœ‰ï¼Œå®ƒå°±å»æŸ¥æ•°æ®åº“äº†ï¼Œå°±å¾—åˆ°äº†è„æ•°æ®ã€‚å¹¶å°†è„æ•°æ®å¡å…¥äº†ç¼“å­˜ä¸­ã€‚è¿™å°±å¯¼è‡´äº† ç¼“å­˜ä¸æ•°æ®åº“ æœ€ç»ˆä¸ä¸€è‡´ã€‚</li><li><strong>å…ˆæ›´æ–°æ•°æ®åº“å†åˆ é™¤ç¼“å­˜</strong>ï¼šåœ¨åˆ é™¤ç¼“å­˜ä¹‹å‰ï¼Œå»è¯»åˆ°çš„éƒ½æ˜¯ è„æ•°æ®ã€‚åœ¨å¹¶å‘å†™ä¸é«˜ã€redisåˆ é™¤å¤±è´¥æ¦‚ç‡ä¸å¤§æ—¶ï¼Œå¯ä»¥ä¸€å®šç¨‹åº¦å®ç° æœ€ç»ˆä¸€è‡´æ€§ã€‚ä½†æ˜¯åœ¨å¹¶å‘å†™è¾ƒé«˜ï¼Œå°±ä¼šå‡ºç°ä¸‹é¢çš„æƒ…å†µï¼š</li></ol><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682815161357-87e6efce-ca8a-4ce3-a1d2-592d9d2c7a6c-20250605100709115.png" alt="img"></p><p>æ­¤æ—¶ å†æœ‰çº¿ç¨‹è¿›æ¥è¯»å–ç¼“å­˜ï¼Œå°±ä¼šè¯»å–åˆ°å°±æ˜¯a&#x3D;2ï¼Œä½†æ˜¯å®é™… æ•°æ®åº“ä¸­ a&#x3D;3ã€‚è¿™å°±å¯¼è‡´äº†æ•°æ®æœ€ç»ˆä¸ä¸€è‡´ã€‚</p><p>æ­¤æ–¹æ¡ˆå¯ä»¥è€ƒè™‘åœ¨å†™å¹¶å‘æä½çš„æƒ…å†µä¸‹ä½¿ç”¨ã€‚</p><p>ä½†æ˜¯ç»¼åˆæ¥çœ‹ï¼Œä¸Šé¢ä¸¤ä¸ªæ–¹æ¡ˆå³ä½¿åœ¨ä¸è€ƒè™‘ åˆ é™¤key å¯èƒ½å¤±è´¥çš„æƒ…å†µï¼Œä¹Ÿä¸èƒ½ä¿è¯ ç¼“å­˜å’Œæ•°æ®åº“ æ•°æ®æœ€ç»ˆä¸€è‡´ã€‚</p><p><strong>3.å»¶è¿ŸåŒåˆ ï¼š</strong> </p><p>å»¶è¿ŸåŒåˆ å†ä¸Šé¢æ–¹æ¡ˆ1 çš„åŸºç¡€ä¸Šï¼Œå¢åŠ äº†ä¸€æ­¥ å»¶è¿Ÿä¸€å®šæ—¶é—´å å†åˆ é™¤ç¼“å­˜ã€‚ä»è€Œé¿å…æ–¹æ¡ˆ1ï¼Œé€ æˆçš„è„æ•°æ®å­˜åœ¨ç¼“å­˜ä¸­ã€‚è¾¾åˆ°ä¸‹é¢å·¦å›¾åˆ°æ•ˆæœ</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1684856079904-9a8380f7-4d84-40fc-88aa-a1efe58412d1-20250605100653159.png" alt="img"></p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1684856140846-5f64616b-c627-4b51-90e2-7cf9943c770d-20250605100659576.png" alt="img"></p><p>è¿™æ ·å°±å¯ä»¥å®ç° æ•°æ®æœ€ç»ˆä¸€è‡´æ€§ã€‚ä½†æ˜¯æˆ‘ä»¬ä¹Ÿå¯ä»¥æ¸…æ¥šçš„å‘ç°ï¼Œå¦‚æœå»¶è¿Ÿæ—¶é—´ä¸å¤Ÿï¼Œå¾ˆæœ‰å¯èƒ½ä¼šå‡ºç° Thread-2 çš„å†™å…¥ç¼“å­˜æ“ä½œ åœ¨Thread-1ç¬¬äºŒæ¬¡åˆ é™¤ç¼“å­˜ ä¹‹åå‘ç”Ÿã€‚é‚£ä¹ˆæ­¤æ—¶ï¼Œæ•°æ®åˆä¼šå‡ºç°ä¸ä¸€è‡´çš„æƒ…å†µã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬åº”å½“è®¾ç½®ä¸€ä¸ªåˆç†çš„ å»¶è¿Ÿæ—¶é—´ï¼Œä½†æ˜¯å³ä½¿åˆç†ï¼Œä¹Ÿä¸èƒ½è¯´ ä¸€å®šèƒ½ä¿è¯åœ¨ä»»ä½•æƒ…å†µä¸‹ Thread-2 å†™å…¥æ“ä½œéƒ½åœ¨ Thread-1 ç¬¬äºŒæ¬¡åˆ ç¼“å­˜ ä¹‹åã€‚</p><p><strong>4.å¼‚æ­¥æ›´æ–°ç¼“å­˜ï¼ˆåŸºäºCDCçš„åŒæ­¥æœºåˆ¶ï¼‰</strong></p><p>é€šè¿‡CDCï¼ˆæ•°æ®å˜æ›´è·Ÿè¸ªï¼‰å°†ç¼“å­˜ä¸æ•°æ®åº“çš„ä¸€è‡´æ€§åŒæ­¥ä»ä¸šåŠ¡ä¸­ç‹¬ç«‹å‡ºæ¥ç»Ÿä¸€å¤„ç†ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚</p><p>æ•´ä½“æ€è·¯ï¼š</p><ol><li>æ›´æ–°ã€å†™ æ•°æ®åº“åï¼Œä¼šäº§ç”Ÿæ•°æ®å˜æ›´è®°å½•ã€‚ï¼ˆMySQLä¸­æœ‰binlogæ—¥å¿—ï¼ŒSQLServerä¸­æœ‰CDCå˜æ›´è¡¨ï¼‰</li><li>é€šè¿‡æ•°æ®å˜æ›´è®°å½•æ¥æ›´æ–° Redisä¸­æ•°æ®</li></ol><p>è¿™é‡Œå¯ä»¥ä½¿ç”¨ï¼š1. FlinkCDC æ¥å®ç° å¯¹æ•°æ®åº“å˜æ›´æ•°æ®çš„è¿½è¸ªã€å¤„ç†ï¼›2. æ•°æ®å˜æ›´è®°å½• å­˜å…¥ æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¶ˆè´¹è€…æœ‰åºå®ç° Redis æ›´æ–°ã€‚</p><p>ä¸Šé¢çš„æ‰€æœ‰æ–¹æ¡ˆä¸­ï¼Œéƒ½æ²¡æœ‰è€ƒè™‘ åˆ é™¤ç¼“å­˜å¤±è´¥ çš„å¯èƒ½ï¼Œå¦‚æœè€ƒè™‘åˆ é™¤ç¼“å­˜å¤±è´¥ï¼Œå¯èƒ½æ‰€æœ‰æ–¹æ¡ˆéƒ½ä¿è¯ä¸äº† æ•°æ®æœ€ç»ˆä¸€è‡´æ€§ã€‚æ‰€ä»¥åœ¨ åˆ é™¤ç¼“å­˜ è¿™ä¸€æ“ä½œï¼Œå¯ä»¥è€ƒè™‘ å¤±è´¥é‡è¯• æˆ–è€… å°†éœ€è¦åˆ é™¤çš„keyå­˜å…¥æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œä¾æ¬¡ä¿è¯ åˆ é™¤ç¼“å­˜çš„æˆåŠŸã€‚</p><p>ä»æ•´ä¸ªå¤§å±€æ¥çœ‹ï¼Œæˆ‘ä»¬ä¼šå‘ç° å¦‚æœç¼“å­˜ä¸è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œæ˜¯æ¯”è¾ƒå®¹æ˜“é€ æˆ redisä¸æ•°æ®åº“ æœ€ç»ˆä¸€è‡´æ€§éš¾ä»¥ä¿è¯çš„ã€‚æœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯ è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œè¿™æ ·å³ä½¿è„æ•°æ®åœ¨ç¼“å­˜ä¸­ï¼Œä¹Ÿä¸ä¼šå­˜åœ¨å¾ˆä¹…ã€‚</p><p>ä¸ªäººçœ‹æ³•ï¼šå°å›¢é˜Ÿæˆ–è€…å°é¡¹ç›®å¯ä»¥è€ƒè™‘ ä½¿ç”¨æ–¹æ¡ˆ2+è®¾ç½®keyè¿‡æœŸæ—¶é—´ï¼Œè¾ƒå¤§é¡¹ç›®å¯ä»¥è€ƒè™‘ ä½¿ç”¨æ–¹æ¡ˆ4</p><h4 id=""><a href="#" class="headerlink" title=""></a></h4><h3 id="7-2-Redis-çš„å¤§keyå¦‚ä½•å¤„ç†ï¼Ÿ"><a href="#7-2-Redis-çš„å¤§keyå¦‚ä½•å¤„ç†ï¼Ÿ" class="headerlink" title="7.2 Redis çš„å¤§keyå¦‚ä½•å¤„ç†ï¼Ÿ"></a>7.2 Redis çš„å¤§keyå¦‚ä½•å¤„ç†ï¼Ÿ</h3><p>ä»€ä¹ˆæ˜¯ Redis å¤§key ï¼Ÿ</p><p>å¤§ key å¹¶ä¸æ˜¯æŒ‡ key çš„å€¼å¾ˆå¤§ï¼Œè€Œæ˜¯ key å¯¹åº”çš„ value å¾ˆå¤§ã€‚</p><p>ä¸€èˆ¬è€Œè¨€ï¼Œä¸‹é¢è¿™ä¸¤ç§æƒ…å†µè¢«ç§°ä¸ºå¤§ keyï¼š</p><ul><li>String ç±»å‹çš„å€¼å¤§äº 10 KBï¼›</li><li>Hashã€Listã€Setã€ZSet ç±»å‹çš„å…ƒç´ çš„ä¸ªæ•°è¶…è¿‡ 5000ä¸ªï¼›</li></ul><p>å¤§keyä¼šé€ æˆä»€ä¹ˆé—®é¢˜ï¼Ÿ</p><p>å¤§ key ä¼šå¸¦æ¥ä»¥ä¸‹å››ç§å½±å“ï¼š</p><ul><li><strong>å®¢æˆ·ç«¯è¶…æ—¶é˜»å¡ã€‚</strong>ç”±äº Redis æ‰§è¡Œå‘½ä»¤æ˜¯å•çº¿ç¨‹å¤„ç†ï¼Œç„¶ååœ¨æ“ä½œå¤§ key æ—¶ä¼šæ¯”è¾ƒè€—æ—¶ï¼Œé‚£ä¹ˆå°±ä¼šé˜»å¡ Redisï¼Œä»å®¢æˆ·ç«¯è¿™ä¸€è§†è§’çœ‹ï¼Œå°±æ˜¯å¾ˆä¹…å¾ˆä¹…éƒ½æ²¡æœ‰å“åº”ã€‚</li><li><strong>å¼•å‘ç½‘ç»œé˜»å¡ã€‚</strong>æ¯æ¬¡è·å–å¤§ key äº§ç”Ÿçš„ç½‘ç»œæµé‡è¾ƒå¤§ï¼Œå¦‚æœä¸€ä¸ª key çš„å¤§å°æ˜¯ 1 MBï¼Œæ¯ç§’è®¿é—®é‡ä¸º 1000ï¼Œé‚£ä¹ˆæ¯ç§’ä¼šäº§ç”Ÿ 1000MB çš„æµé‡ï¼Œè¿™å¯¹äºæ™®é€šåƒå…†ç½‘å¡çš„æœåŠ¡å™¨æ¥è¯´æ˜¯ç¾éš¾æ€§çš„ã€‚</li><li><strong>é˜»å¡å·¥ä½œçº¿ç¨‹ã€‚</strong>å¦‚æœä½¿ç”¨ del åˆ é™¤å¤§ key æ—¶ï¼Œä¼šé˜»å¡å·¥ä½œçº¿ç¨‹ï¼Œè¿™æ ·å°±æ²¡åŠæ³•å¤„ç†åç»­çš„å‘½ä»¤ã€‚</li><li><strong>å†…å­˜åˆ†å¸ƒä¸å‡ã€‚</strong>é›†ç¾¤æ¨¡å‹åœ¨ slot åˆ†ç‰‡å‡åŒ€æƒ…å†µä¸‹ï¼Œä¼šå‡ºç°æ•°æ®å’ŒæŸ¥è¯¢å€¾æ–œæƒ…å†µï¼Œéƒ¨åˆ†æœ‰å¤§ key çš„ Redis èŠ‚ç‚¹å ç”¨å†…å­˜å¤šï¼ŒQPS ä¹Ÿä¼šæ¯”è¾ƒå¤§ã€‚</li></ul><p>å¦‚ä½•æ‰¾åˆ°å¤§keyï¼Ÿ</p><ol><li>redis-cli â€“bigkeys æŸ¥æ‰¾å¤§key</li></ol><p>å¯ä»¥é€šè¿‡ redis-cli â€“bigkeys å‘½ä»¤æŸ¥æ‰¾å¤§ keyï¼š</p><p>ä½¿ç”¨çš„æ—¶å€™æ³¨æ„äº‹é¡¹ï¼š</p><ul><li><ul><li>æœ€å¥½é€‰æ‹©åœ¨ä»èŠ‚ç‚¹ä¸Šæ‰§è¡Œè¯¥å‘½ä»¤ã€‚å› ä¸ºä¸»èŠ‚ç‚¹ä¸Šæ‰§è¡Œæ—¶ï¼Œä¼šé˜»å¡ä¸»èŠ‚ç‚¹ï¼›</li><li>å¦‚æœæ²¡æœ‰ä»èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå¯ä»¥é€‰æ‹©åœ¨ Redis å®ä¾‹ä¸šåŠ¡å‹åŠ›çš„ä½å³°é˜¶æ®µè¿›è¡Œæ‰«ææŸ¥è¯¢ï¼Œä»¥å…å½±å“åˆ°å®ä¾‹çš„æ­£å¸¸è¿è¡Œï¼›æˆ–è€…å¯ä»¥ä½¿ç”¨ -i å‚æ•°æ§åˆ¶æ‰«æé—´éš”ï¼Œé¿å…é•¿æ—¶é—´æ‰«æé™ä½ Redis å®ä¾‹çš„æ€§èƒ½ã€‚</li></ul></li></ul><p>è¯¥æ–¹å¼çš„ä¸è¶³ä¹‹å¤„ï¼š</p><ul><li><ul><li>è¿™ä¸ªæ–¹æ³•åªèƒ½è¿”å›æ¯ç§ç±»å‹ä¸­æœ€å¤§çš„é‚£ä¸ª bigkeyï¼Œæ— æ³•å¾—åˆ°å¤§å°æ’åœ¨å‰ N ä½çš„ bigkeyï¼›</li><li>å¯¹äºé›†åˆç±»å‹æ¥è¯´ï¼Œè¿™ä¸ªæ–¹æ³•åªç»Ÿè®¡é›†åˆå…ƒç´ ä¸ªæ•°çš„å¤šå°‘ï¼Œè€Œä¸æ˜¯å®é™…å ç”¨çš„å†…å­˜é‡ã€‚ä½†æ˜¯ï¼Œä¸€ä¸ªé›†åˆä¸­çš„å…ƒç´ ä¸ªæ•°å¤šï¼Œå¹¶ä¸ä¸€å®šå ç”¨çš„å†…å­˜å°±å¤šã€‚å› ä¸ºï¼Œæœ‰å¯èƒ½æ¯ä¸ªå…ƒç´ å ç”¨çš„å†…å­˜å¾ˆå°ï¼Œè¿™æ ·çš„è¯ï¼Œå³ä½¿å…ƒç´ ä¸ªæ•°æœ‰å¾ˆå¤šï¼Œæ€»å†…å­˜å¼€é”€ä¹Ÿä¸å¤§ï¼›</li></ul></li></ul><ol><li>ä½¿ç”¨ SCAN å‘½ä»¤æŸ¥æ‰¾å¤§ key</li></ol><p>ä½¿ç”¨ SCAN å‘½ä»¤å¯¹æ•°æ®åº“æ‰«æï¼Œç„¶åç”¨ TYPE å‘½ä»¤è·å–è¿”å›çš„æ¯ä¸€ä¸ª key çš„ç±»å‹ã€‚</p><p>å¯¹äº String ç±»å‹ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ STRLEN å‘½ä»¤è·å–å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯å ç”¨çš„å†…å­˜ç©ºé—´å­—èŠ‚æ•°ã€‚</p><p>å¯¹äºé›†åˆç±»å‹æ¥è¯´ï¼Œæœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥è·å¾—å®ƒå ç”¨çš„å†…å­˜å¤§å°ï¼š</p><ul><li><ul><li>å¦‚æœèƒ½å¤Ÿé¢„å…ˆä»ä¸šåŠ¡å±‚çŸ¥é“é›†åˆå…ƒç´ çš„å¹³å‡å¤§å°ï¼Œé‚£ä¹ˆï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤è·å–é›†åˆå…ƒç´ çš„ä¸ªæ•°ï¼Œç„¶åä¹˜ä»¥é›†åˆå…ƒç´ çš„å¹³å‡å¤§å°ï¼Œè¿™æ ·å°±èƒ½è·å¾—é›†åˆå ç”¨çš„å†…å­˜å¤§å°äº†ã€‚List ç±»å‹ï¼šLLEN å‘½ä»¤ï¼›Hash ç±»å‹ï¼šHLEN å‘½ä»¤ï¼›Set ç±»å‹ï¼šSCARD å‘½ä»¤ï¼›Sorted Set ç±»å‹ï¼šZCARD å‘½ä»¤ï¼›</li><li>å¦‚æœä¸èƒ½æå‰çŸ¥é“å†™å…¥é›†åˆçš„å…ƒç´ å¤§å°ï¼Œå¯ä»¥ä½¿ç”¨ MEMORY USAGE å‘½ä»¤ï¼ˆéœ€è¦ Redis 4.0 åŠä»¥ä¸Šç‰ˆæœ¬ï¼‰ï¼ŒæŸ¥è¯¢ä¸€ä¸ªé”®å€¼å¯¹å ç”¨çš„å†…å­˜ç©ºé—´ã€‚</li></ul></li></ul><ol><li>ä½¿ç”¨ RdbTools å·¥å…·æŸ¥æ‰¾å¤§ key</li></ol><p>ä½¿ç”¨ RdbTools ç¬¬ä¸‰æ–¹å¼€æºå·¥å…·ï¼Œå¯ä»¥ç”¨æ¥è§£æ Redis å¿«ç…§ï¼ˆRDBï¼‰æ–‡ä»¶ï¼Œæ‰¾åˆ°å…¶ä¸­çš„å¤§ keyã€‚</p><p>æ¯”å¦‚ï¼Œä¸‹é¢è¿™æ¡å‘½ä»¤ï¼Œå°†å¤§äº 10 kb çš„  key  è¾“å‡ºåˆ°ä¸€ä¸ªè¡¨æ ¼æ–‡ä»¶ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rdb dump.rdb -c memory --bytes 10240 -f redis.csv</span><br></pre></td></tr></table></figure><p>å¦‚ä½•ä¼˜åŒ–å¤§keyï¼Ÿ</p><ul><li>å¯¹å¤§keyè¿›è¡Œæ‹†åˆ†å’Œå‹ç¼©</li></ul><p>ä¾‹å¦‚å°†å«æœ‰æ•°ä¸‡æˆå‘˜çš„ä¸€ä¸ªHASH Keyæ‹†åˆ†ä¸ºå¤šä¸ªHASH Keyï¼Œ<strong>ä½¿ç”¨multiGetæ–¹æ³•è·å¾—å€¼ï¼Œ</strong>å¹¶ç¡®ä¿æ¯ä¸ªKeyçš„æˆå‘˜æ•°é‡åœ¨åˆç†èŒƒå›´ã€‚<strong>è¿™æ ·çš„æ‹†åˆ†ä¸»è¦æ˜¯ä¸ºäº†å‡å°‘å•å°æ“ä½œçš„å‹åŠ›ï¼Œè€Œæ˜¯å°†å‹åŠ›å¹³æ‘Šåˆ°é›†ç¾¤å„ä¸ªå®ä¾‹ä¸­ï¼Œé™ä½å•å°æœºå™¨çš„IOæ“ä½œã€‚</strong></p><ul><li>å¯¹å¤§keyå¯ä»¥è¿›è¡Œæ¸…ç†</li></ul><p>å°†ä¸é€‚ç”¨Redisèƒ½åŠ›çš„æ•°æ®å­˜è‡³å…¶å®ƒå­˜å‚¨ï¼Œå¹¶åœ¨Redisä¸­åˆ é™¤æ­¤ç±»æ•°æ®ã€‚</p><ul><li>åœ¨Redisé›†ç¾¤æ¶æ„ä¸­å¯¹çƒ­Keyè¿›è¡Œå¤åˆ¶</li></ul><p>åœ¨Redisé›†ç¾¤æ¶æ„ä¸­ï¼Œç”±äºçƒ­Keyçš„è¿ç§»ç²’åº¦é—®é¢˜ï¼Œæ— æ³•å°†è¯·æ±‚åˆ†æ•£è‡³å…¶ä»–æ•°æ®åˆ†ç‰‡ï¼Œå¯¼è‡´å•ä¸ªæ•°æ®åˆ†ç‰‡çš„å‹åŠ›æ— æ³•ä¸‹é™ã€‚æ­¤æ—¶ï¼Œå¯ä»¥å°†å¯¹åº”çƒ­Keyè¿›è¡Œå¤åˆ¶å¹¶è¿ç§»è‡³å…¶ä»–æ•°æ®åˆ†ç‰‡ï¼Œä¾‹å¦‚å°†çƒ­Key fooå¤åˆ¶å‡º3ä¸ªå†…å®¹å®Œå…¨ä¸€æ ·çš„Keyå¹¶åä¸ºfoo2ã€foo3ã€foo4ï¼Œå°†è¿™ä¸‰ä¸ªKeyè¿ç§»åˆ°å…¶ä»–æ•°æ®åˆ†ç‰‡æ¥è§£å†³å•ä¸ªæ•°æ®åˆ†ç‰‡çš„çƒ­Keyå‹åŠ›ã€‚</p><ul><li>ä½¿ç”¨è¯»å†™åˆ†ç¦»æ¶æ„</li></ul><p>å¦‚æœçƒ­Keyçš„äº§ç”Ÿæ¥è‡ªäºè¯»è¯·æ±‚ï¼Œæ‚¨å¯ä»¥å°†å®ä¾‹æ”¹é€ æˆè¯»å†™åˆ†ç¦»æ¶æ„æ¥é™ä½æ¯ä¸ªæ•°æ®åˆ†ç‰‡çš„è¯»è¯·æ±‚å‹åŠ›ï¼Œç”šè‡³å¯ä»¥ä¸æ–­åœ°å¢åŠ ä»èŠ‚ç‚¹ã€‚ä½†æ˜¯è¯»å†™åˆ†ç¦»æ¶æ„åœ¨å¢åŠ ä¸šåŠ¡ä»£ç å¤æ‚åº¦çš„åŒæ—¶ï¼Œä¹Ÿä¼šå¢åŠ Redisé›†ç¾¤æ¶æ„å¤æ‚åº¦ã€‚</p><h3 id="7-3-å¦‚ä½•é€‰æ‹©æŒä¹…åŒ–ç­–ç•¥ï¼Ÿ"><a href="#7-3-å¦‚ä½•é€‰æ‹©æŒä¹…åŒ–ç­–ç•¥ï¼Ÿ" class="headerlink" title="7.3 å¦‚ä½•é€‰æ‹©æŒä¹…åŒ–ç­–ç•¥ï¼Ÿ"></a>7.3 å¦‚ä½•é€‰æ‹©æŒä¹…åŒ–ç­–ç•¥ï¼Ÿ</h3><p>RDB ä¼˜ç‚¹æ˜¯æ•°æ®æ¢å¤é€Ÿåº¦å¿«ï¼Œä½†æ˜¯å¿«ç…§çš„é¢‘ç‡ä¸å¥½æŠŠæ¡ã€‚é¢‘ç‡å¤ªä½ï¼Œä¸¢å¤±çš„æ•°æ®å°±ä¼šæ¯”è¾ƒå¤šï¼Œé¢‘ç‡å¤ªé«˜ï¼Œå°±ä¼šå½±å“æ€§èƒ½ã€‚</p><p>AOF ä¼˜ç‚¹æ˜¯ä¸¢å¤±æ•°æ®å°‘ï¼Œä½†æ˜¯æ•°æ®æ¢å¤ä¸å¿«ã€‚</p><p>ä¸ºäº†é›†æˆäº†ä¸¤è€…çš„ä¼˜ç‚¹ï¼Œ Redis 4.0 æå‡ºäº†<strong>æ··åˆä½¿ç”¨ AOF æ—¥å¿—å’Œå†…å­˜å¿«ç…§</strong>ï¼Œä¹Ÿå«æ··åˆæŒä¹…åŒ–ï¼Œæ—¢ä¿è¯äº† Redis é‡å¯é€Ÿåº¦ï¼Œåˆé™ä½æ•°æ®ä¸¢å¤±é£é™©ã€‚</p><p>æ··åˆæŒä¹…åŒ–å·¥ä½œåœ¨ <strong>AOF æ—¥å¿—é‡å†™è¿‡ç¨‹</strong>ï¼Œå½“å¼€å¯äº†æ··åˆæŒä¹…åŒ–æ—¶ï¼Œåœ¨ AOF é‡å†™æ—¥å¿—æ—¶ï¼Œfork å‡ºæ¥çš„é‡å†™å­è¿›ç¨‹ä¼šå…ˆå°†ä¸ä¸»çº¿ç¨‹å…±äº«çš„å†…å­˜æ•°æ®ä»¥ RDB æ–¹å¼å†™å…¥åˆ° AOF æ–‡ä»¶ï¼Œç„¶åä¸»çº¿ç¨‹å¤„ç†çš„æ“ä½œå‘½ä»¤ä¼šè¢«è®°å½•åœ¨é‡å†™ç¼“å†²åŒºé‡Œï¼Œé‡å†™ç¼“å†²åŒºé‡Œçš„å¢é‡å‘½ä»¤ä¼šä»¥ AOF æ–¹å¼å†™å…¥åˆ° AOF æ–‡ä»¶ï¼Œå†™å…¥å®Œæˆåé€šçŸ¥ä¸»è¿›ç¨‹å°†æ–°çš„å«æœ‰ RDB æ ¼å¼å’Œ AOF æ ¼å¼çš„ AOF æ–‡ä»¶æ›¿æ¢æ—§çš„çš„ AOF æ–‡ä»¶ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨äº†æ··åˆæŒä¹…åŒ–ï¼ŒAOF æ–‡ä»¶çš„<strong>å‰åŠéƒ¨åˆ†æ˜¯ RDB æ ¼å¼çš„å…¨é‡æ•°æ®ï¼ŒååŠéƒ¨åˆ†æ˜¯ AOF æ ¼å¼çš„å¢é‡æ•°æ®ã€‚</strong></p><p>è¿™æ ·çš„å¥½å¤„åœ¨äºï¼Œé‡å¯ Redis åŠ è½½æ•°æ®çš„æ—¶å€™ï¼Œç”±äºå‰åŠéƒ¨åˆ†æ˜¯ RDB å†…å®¹ï¼Œè¿™æ ·<strong>åŠ è½½çš„æ—¶å€™é€Ÿåº¦ä¼šå¾ˆå¿«</strong>ã€‚</p><p>åŠ è½½å®Œ RDB çš„å†…å®¹åï¼Œæ‰ä¼šåŠ è½½ååŠéƒ¨åˆ†çš„ AOF å†…å®¹ï¼Œè¿™é‡Œçš„å†…å®¹æ˜¯ Redis åå°å­è¿›ç¨‹é‡å†™ AOF æœŸé—´ï¼Œä¸»çº¿ç¨‹å¤„ç†çš„æ“ä½œå‘½ä»¤ï¼Œå¯ä»¥ä½¿å¾—<strong>æ•°æ®æ›´å°‘çš„ä¸¢å¤±ã€‚</strong></p><p><strong>æ··åˆæŒä¹…åŒ–ä¼˜ç‚¹ï¼š</strong></p><ul><li>æ··åˆæŒä¹…åŒ–ç»“åˆäº† RDB å’Œ AOF æŒä¹…åŒ–çš„ä¼˜ç‚¹ï¼Œå¼€å¤´ä¸º RDB çš„æ ¼å¼ï¼Œä½¿å¾— Redis å¯ä»¥æ›´å¿«çš„å¯åŠ¨ï¼ŒåŒæ—¶ç»“åˆ AOF çš„ä¼˜ç‚¹ï¼Œæœ‰å‡ä½äº†å¤§é‡æ•°æ®ä¸¢å¤±çš„é£é™©ã€‚</li></ul><p><strong>æ··åˆæŒä¹…åŒ–ç¼ºç‚¹ï¼š</strong></p><ul><li>AOF æ–‡ä»¶ä¸­æ·»åŠ äº† RDB æ ¼å¼çš„å†…å®¹ï¼Œä½¿å¾— AOF æ–‡ä»¶çš„å¯è¯»æ€§å˜å¾—å¾ˆå·®ï¼›</li><li>å…¼å®¹æ€§å·®ï¼Œå¦‚æœå¼€å¯æ··åˆæŒä¹…åŒ–ï¼Œé‚£ä¹ˆæ­¤æ··åˆæŒä¹…åŒ– AOF æ–‡ä»¶ï¼Œå°±ä¸èƒ½ç”¨åœ¨ Redis 4.0 ä¹‹å‰ç‰ˆæœ¬äº†ã€‚</li></ul><h2 id="å…«ã€Redis-æ¶‰åŠçš„ç®—æ³•"><a href="#å…«ã€Redis-æ¶‰åŠçš„ç®—æ³•" class="headerlink" title="å…«ã€Redis æ¶‰åŠçš„ç®—æ³•"></a>å…«ã€Redis æ¶‰åŠçš„ç®—æ³•</h2><h3 id="1-ä¸€è‡´æ€§Hash"><a href="#1-ä¸€è‡´æ€§Hash" class="headerlink" title="1.ä¸€è‡´æ€§Hash"></a>1.ä¸€è‡´æ€§Hash</h3><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779145889-e62ed280-3191-42c2-904d-1c8c373415eb-20250605100643333.png" alt="img"></p><h4 id="1-1-é—®é¢˜çš„ç”±æ¥"><a href="#1-1-é—®é¢˜çš„ç”±æ¥" class="headerlink" title="1.1 é—®é¢˜çš„ç”±æ¥"></a>1.1 é—®é¢˜çš„ç”±æ¥</h4><p>å¤§å¤šæ•°åº”ç”¨ï¼ŒèƒŒåè‚¯å®šä¸åªæœ‰ä¸€å°æœåŠ¡å™¨æä¾›æœåŠ¡ã€‚å› ä¸ºé«˜å¯ç”¨æˆ–å¹¶å‘é‡çš„éœ€è¦ï¼Œéƒ½ä¼šä½¿ç”¨å¤šå°æœåŠ¡å™¨ç»„æˆé›†ç¾¤å¯¹å¤–æä¾›æœåŠ¡ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œè¿™ä¹ˆå¤šæœåŠ¡å™¨ï¼Œè¦å¦‚ä½•åˆ†é…å®¢æˆ·ç«¯è¯·æ±‚å‘¢ï¼Ÿå…¶å®è¿™ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ è´Ÿè½½å‡è¡¡é—®é¢˜äº†ã€‚è§£å†³è´Ÿè½½å‡è¡¡é—®é¢˜çš„ç®—æ³•å¾ˆå¤šï¼Œä¸åŒçš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œé€‚ç”¨äºä¸åŒçš„åº”ç”¨åœºæ™¯å’Œéœ€æ±‚ã€‚ä¸€èˆ¬ï¼Œæœ€ç®€å•çš„æ–¹å¼ï¼Œå°±æ˜¯å¼•å…¥ä¸€ä¸ªä¸­é—´çš„è´Ÿè½½å‡è¡¡å±‚ï¼Œè®©å®ƒå°†å¤–ç•Œçš„è¯·æ±‚ â€œè½®æµâ€ è½¬å‘ç»™å†…éƒ¨çš„é›†ç¾¤ã€‚æ¯”å¦‚é›†ç¾¤æœ‰ä¸‰ä¸ªèŠ‚ç‚¹ï¼Œå¹¶æ”¶åˆ°äº†3ä¸ªè¯·æ±‚ï¼Œé‚£ä¹ˆæ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šå¤„ç†ä¸€ä¸ªè¯·æ±‚ã€‚</p><p>è€ƒè™‘åˆ°æ¯ä¸ªèŠ‚ç‚¹çš„ç¡¬ä»¶é…ç½®æœ‰åŒºåˆ«ï¼Œä¸€èˆ¬å¼•ç”¨æƒé‡å€¼ã€‚æŒ‰ä¸åŒèŠ‚ç‚¹çš„æƒé‡å€¼ï¼Œæ¥åˆ†é…è¯·æ±‚ï¼Œè®©å¤„ç†èƒ½åŠ›æ›´æŠ¢çš„èŠ‚ç‚¹ï¼Œåˆ†æ‹…æ›´å¤šè¯·æ±‚ã€‚</p><p>ä½†æ˜¯è¿™ç§åŠ æƒè½®è¯¢ä½¿ç”¨åœºæ™¯æ˜¯å»ºç«‹å‰æâ€”â€”æ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨çš„æ•°æ®éƒ½æ˜¯ç›¸åŒçš„ã€‚è¿™æ ·ï¼Œè®¿é—®ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥è·å–ç›¸åŒçš„ç»“æœã€‚ä½†æ˜¯ï¼Œè¿™å°±æ— æ³•åº”å¯¹ åˆ†å¸ƒå¼ç³»ç»Ÿã€‚å› ä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œæ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨çš„æ•°æ®æ˜¯ä¸åŒçš„ã€‚</p><p>æ¯”å¦‚ï¼šåˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿï¼Œä¸€èˆ¬ä¸ºäº†æé«˜ç³»ç»Ÿçš„å®¹é‡ï¼Œå°±ä¼šæŠŠæ•°æ®æ°´å¹³åˆ‡åˆ†åˆ°ä¸åŒçš„èŠ‚ç‚¹æ¥å­˜å‚¨ã€‚æ¯”å¦‚ Redisï¼ŒæŸä¸ªkeyåº”è¯¥åˆ°å“ªä¸ªæˆ–è€…é‚£äº›èŠ‚ç‚¹ä¸Šè·çš„ï¼Œåº”è¯¥æ˜¯ç¡®å®šçš„ã€‚è€Œä¸æ˜¯ä»»æ„è®¿é—®ä¸€ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥è·å– key å¯¹åº”çš„ valueã€‚</p><h4 id="1-2-ç›´æ¥ä½¿ç”¨å“ˆå¸Œç®—æ³•ï¼Ÿ"><a href="#1-2-ç›´æ¥ä½¿ç”¨å“ˆå¸Œç®—æ³•ï¼Ÿ" class="headerlink" title="1.2 ç›´æ¥ä½¿ç”¨å“ˆå¸Œç®—æ³•ï¼Ÿ"></a>1.2 ç›´æ¥ä½¿ç”¨å“ˆå¸Œç®—æ³•ï¼Ÿ</h4><p>å¾ˆå®¹æ˜“å°±ä¼šæƒ³åˆ° hashç®—æ³•ï¼Œå…¶å¯ä»¥é€šè¿‡ä¸€ä¸ª key è¿›è¡Œ å“ˆå¸Œè®¡ç®—ï¼Œæ¯æ¬¡éƒ½å¯ä»¥å¾—åˆ°ç›¸åŒçš„å€¼ã€‚è¿™æ ·å°±å¯ä»¥å°†æŸä¸ª key ç¡®å®šåˆ°ä¸€ä¸ªèŠ‚ç‚¹äº†ï¼Œå¯ä»¥æ»¡è¶³åˆ†å¸ƒå¼ç³»ç»Ÿçš„è´Ÿè½½å‡è¡¡éœ€æ±‚ã€‚</p><p>å“ˆå¸Œç®—æ³•æœ€ç®€å•çš„åšæ³•å°±æ˜¯è¿›è¡Œå–æ¨¡è¿ç®—ï¼Œæ¯”å¦‚åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æœ‰ 3 ä¸ªèŠ‚ç‚¹ï¼ŒåŸºäº hash(key) % 3 å…¬å¼å¯¹æ•°æ®è¿›è¡Œäº†æ˜ å°„ã€‚å¦‚æœå®¢æˆ·ç«¯è¦è·å–æŒ‡å®š key çš„æ•°æ®ï¼Œé€šè¿‡ä¸Šé¢çš„å…¬å¼å®šä½èŠ‚ç‚¹ã€‚</p><p>ä½†æ˜¯è¿™æœ‰ä¸€ä¸ªå¾ˆè‡´å‘½çš„é—®é¢˜ï¼šå¦‚æœèŠ‚ç‚¹æ•°æ®å‘ç”Ÿäº†å˜åŒ–ï¼Œä¹Ÿå°±æ˜¯åœ¨å¯¹ç³»ç»Ÿåšæ‰©å®¹æˆ–è€…ç¼©å®¹æ—¶ï¼Œå¯èƒ½é€ æˆå¤§éƒ¨åˆ†æ˜ å°„å…³ç³»æ”¹å˜ã€‚å¹¶ä¸”å¿…é¡»è¿ç§»æ”¹å˜äº†æ˜ å°„å…³ç³»çš„æ•°æ®ï¼Œå¦åˆ™ä¼šæŸ¥è¯¢ä¸åˆ°æ•°æ®çš„é—®é¢˜ã€‚å‡è®¾æ€»æ•°æ®æ¡æ•°ä¸º Mï¼Œå“ˆå¸Œç®—æ³•åœ¨é¢å¯¹èŠ‚ç‚¹æ•°é‡å˜åŒ–æ—¶ï¼Œæœ€åæƒ…å†µä¸‹æ‰€æœ‰æ•°æ®éƒ½éœ€è¦è¿ç§»ï¼Œæ‰€ä»¥å®ƒçš„æ•°æ®è¿ç§»è§„æ¨¡æ—¶ Oï¼ˆMï¼‰ï¼Œè¿™æ ·æ•°æ®è¿ç§»æˆæœ¬å¤ªé«˜ã€‚</p><h4 id="1-3-ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•æœ‰ä»€ä¹ˆé—®é¢˜"><a href="#1-3-ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•æœ‰ä»€ä¹ˆé—®é¢˜" class="headerlink" title="1.3 ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•æœ‰ä»€ä¹ˆé—®é¢˜?"></a>1.3 ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•æœ‰ä»€ä¹ˆé—®é¢˜?</h4><p>ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•å°±å¾ˆå¥½åœ°è§£å†³äº†åˆ†å¸ƒå¼ç³»ç»Ÿåœ¨æ‰©å®¹æˆ–è€…ç¼©å®¹æ—¶ï¼Œå‘ç”Ÿè¿‡å¤šçš„æ•°æ®è¿ç§»çš„é—®é¢˜ã€‚ä¸€è‡´å“ˆå¸Œç®—æ³•ä¹Ÿç”¨äº†å–æ¨¡è¿ç®—ï¼Œä½†äºå“ˆå¸Œç®—æ³•ä¸åŒçš„æ˜¯ï¼Œå“ˆå¸Œç®—æ³•æ˜¯å¯¹èŠ‚ç‚¹æ•°é‡è¿›è¡Œå–æ¨¡ï¼Œè€Œä¸€è‡´å“ˆå¸Œç®—æ³•æ˜¯å¯¹ 2^32 è¿›è¡Œå–æ¨¡è¿ç®—&#x3D;</p><p>ä»¬å¯ä»¥æŠŠä¸€è‡´å“ˆå¸Œç®—æ³•æ˜¯å¯¹ 2^32 è¿›è¡Œå–æ¨¡è¿ç®—çš„ç»“æœå€¼ç»„ç»‡æˆä¸€ä¸ªåœ†ç¯ã€‚è¿™ä¸ªåœ†æƒ³å¯ä»¥æƒ³è±¡æˆç”± 2^32 ä¸ªç‚¹ç»„æˆçš„åœ†ï¼Œè¿™ä¸ªåœ†ç¯è¢«ç§°ä¸º<strong>å“ˆå¸Œç¯</strong>ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779145911-113a608a-7f26-4b41-8eff-464c49c5cdb4-20250605100626223.png" alt="img"></p><p>ä¸€è‡´æ€§å“ˆå¸Œè¦è¿›è¡Œä¸¤æ­¥å“ˆå¸Œï¼š</p><ul><li>ç¬¬ä¸€æ­¥ï¼šå¯¹å­˜å‚¨èŠ‚ç‚¹è¿›è¡Œå“ˆå¸Œè®¡ç®—ï¼Œä¹Ÿå°±æ˜¯å¯¹å­˜å‚¨èŠ‚ç‚¹åšå“ˆå¸Œæ˜ å°„ï¼Œæ¯”å¦‚æ ¹æ®èŠ‚ç‚¹çš„ IP åœ°å€è¿›è¡Œå“ˆå¸Œï¼›</li><li>ç¬¬äºŒæ­¥ï¼šå½“å¯¹æ•°æ®è¿›è¡Œå­˜å‚¨æˆ–è®¿é—®æ—¶ï¼Œå¯¹æ•°æ®è¿›è¡Œå“ˆå¸Œæ˜ å°„ï¼›</li></ul><p>æ‰€ä»¥ï¼Œ<strong>ä¸€è‡´æ€§å“ˆå¸Œæ˜¯æŒ‡å°†ã€Œå­˜å‚¨èŠ‚ç‚¹ã€å’Œã€Œæ•°æ®ã€éƒ½æ˜ å°„åˆ°ä¸€ä¸ªé¦–å°¾ç›¸è¿çš„å“ˆå¸Œç¯ä¸Š</strong>ã€‚</p><p>é—®é¢˜æ¥äº†ï¼Œå¯¹ã€Œæ•°æ®ã€è¿›è¡Œå“ˆå¸Œæ˜ å°„å¾—åˆ°ä¸€ä¸ªç»“æœè¦æ€ä¹ˆæ‰¾åˆ°å­˜å‚¨è¯¥æ•°æ®çš„èŠ‚ç‚¹å‘¢ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯ï¼Œæ˜ å°„çš„ç»“æœå€¼å¾€<strong>é¡ºæ—¶é’ˆçš„æ–¹å‘çš„æ‰¾åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹</strong>ï¼Œå°±æ˜¯å­˜å‚¨è¯¥æ•°æ®çš„èŠ‚ç‚¹ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œæœ‰ 3 ä¸ªèŠ‚ç‚¹ç»è¿‡å“ˆå¸Œè®¡ç®—ï¼Œæ˜ å°„åˆ°äº†å¦‚ä¸‹å›¾çš„ä½ç½®ï¼š</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/35838370/1682779146288-40a6a0f2-c9c1-402e-b0b0-d5e849e93c80.png" alt="img"></p><p>æ¥ç€ï¼Œå¯¹è¦æŸ¥è¯¢çš„ key-01 è¿›è¡Œå“ˆå¸Œè®¡ç®—ï¼Œç¡®å®šæ­¤ key-01 æ˜ å°„åœ¨å“ˆå¸Œç¯çš„ä½ç½®ï¼Œç„¶åä»è¿™ä¸ªä½ç½®å¾€é¡ºæ—¶é’ˆçš„æ–¹å‘æ‰¾åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå°±æ˜¯å­˜å‚¨è¯¥ key-01 æ•°æ®çš„èŠ‚ç‚¹ã€‚</p><p>æ¯”å¦‚ï¼Œä¸‹å›¾ä¸­çš„ key-01 æ˜ å°„çš„ä½ç½®ï¼Œå¾€é¡ºæ—¶é’ˆçš„æ–¹å‘æ‰¾åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å°±æ˜¯èŠ‚ç‚¹ Aã€‚</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779148088-70cf5d37-5c2c-4798-9017-0b922282dfde-20250605100619239.png" alt="img"></p><p>æ‰€ä»¥ï¼Œå½“éœ€è¦å¯¹æŒ‡å®š key çš„å€¼è¿›è¡Œè¯»å†™çš„æ—¶å€™ï¼Œè¦é€šè¿‡ä¸‹é¢ 2 æ­¥è¿›è¡Œå¯»å€ï¼š</p><ul><li>é¦–å…ˆï¼Œå¯¹ key è¿›è¡Œå“ˆå¸Œè®¡ç®—ï¼Œç¡®å®šæ­¤ key åœ¨ç¯ä¸Šçš„ä½ç½®ï¼›</li><li>ç„¶åï¼Œä»è¿™ä¸ªä½ç½®æ²¿ç€é¡ºæ—¶é’ˆæ–¹å‘èµ°ï¼Œé‡åˆ°çš„ç¬¬ä¸€èŠ‚ç‚¹å°±æ˜¯å­˜å‚¨ key çš„èŠ‚ç‚¹ã€‚</li></ul><p>çŸ¥é“äº†ä¸€è‡´å“ˆå¸Œå¯»å€çš„æ–¹å¼ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ï¼Œå¦‚æœå¢åŠ ä¸€ä¸ªèŠ‚ç‚¹æˆ–è€…å‡å°‘ä¸€ä¸ªèŠ‚ç‚¹ä¼šå‘ç”Ÿå¤§é‡çš„æ•°æ®è¿ç§»å—ï¼Ÿ</p><p>å‡è®¾èŠ‚ç‚¹æ•°é‡ä» 3 å¢åŠ åˆ°äº† 4ï¼Œæ–°çš„èŠ‚ç‚¹ D ç»è¿‡å“ˆå¸Œè®¡ç®—åæ˜ å°„åˆ°äº†ä¸‹å›¾ä¸­çš„ä½ç½®ï¼š</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779148190-0c1b592b-c7fe-48c2-b1a3-809ba82d18c4-20250605100611637.png" alt="img"></p><p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œkey-01ã€key-03 éƒ½ä¸å—å½±å“ï¼Œåªæœ‰ key-02 éœ€è¦è¢«è¿ç§»èŠ‚ç‚¹ Dã€‚</p><p>å‡è®¾èŠ‚ç‚¹æ•°é‡ä» 3 å‡å°‘åˆ°äº† 2ï¼Œæ¯”å¦‚å°†èŠ‚ç‚¹ A ç§»é™¤ï¼š</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779149035-52942a34-67f3-4b3c-b460-711a9a5e35f8-20250605100604477.png" alt="img"></p><p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œkey-02 å’Œ key-03 ä¸ä¼šå—åˆ°å½±å“ï¼Œåªæœ‰ key-01 éœ€è¦è¢«è¿ç§»èŠ‚ç‚¹ Bã€‚</p><p>å› æ­¤ï¼Œ<strong>åœ¨ä¸€è‡´å“ˆå¸Œç®—æ³•ä¸­ï¼Œå¦‚æœå¢åŠ æˆ–è€…ç§»é™¤ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä»…å½±å“è¯¥èŠ‚ç‚¹åœ¨å“ˆå¸Œç¯ä¸Šé¡ºæ—¶é’ˆç›¸é‚»çš„åç»§èŠ‚ç‚¹ï¼Œå…¶å®ƒæ•°æ®ä¹Ÿä¸ä¼šå—åˆ°å½±å“</strong>ã€‚</p><p>ä¸Šé¢è¿™äº›å›¾ä¸­ 3 ä¸ªèŠ‚ç‚¹æ˜ å°„åœ¨å“ˆå¸Œç¯è¿˜æ˜¯æ¯”è¾ƒåˆ†æ•£çš„ï¼Œæ‰€ä»¥çœ‹èµ·æ¥è¯·æ±‚éƒ½ä¼šã€Œå‡è¡¡ã€åˆ°æ¯ä¸ªèŠ‚ç‚¹ã€‚</p><p>ä½†æ˜¯<strong>ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•å¹¶ä¸ä¿è¯èŠ‚ç‚¹èƒ½å¤Ÿåœ¨å“ˆå¸Œç¯ä¸Šåˆ†å¸ƒå‡åŒ€</strong>ï¼Œè¿™æ ·å°±ä¼šå¸¦æ¥ä¸€ä¸ªé—®é¢˜ï¼Œä¼šæœ‰å¤§é‡çš„è¯·æ±‚é›†ä¸­åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚</p><p>æ¯”å¦‚ï¼Œä¸‹å›¾ä¸­ 3 ä¸ªèŠ‚ç‚¹çš„æ˜ å°„ä½ç½®éƒ½åœ¨å“ˆå¸Œç¯çš„å³åŠè¾¹ï¼š</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779150974-f47dbce4-1f4a-4de3-a89c-46fe115a7c6e-20250605100557936.png" alt="img"></p><p>è¿™æ—¶å€™æœ‰ä¸€åŠä»¥ä¸Šçš„æ•°æ®çš„å¯»å€éƒ½ä¼šæ‰¾èŠ‚ç‚¹ Aï¼Œä¹Ÿå°±æ˜¯è®¿é—®è¯·æ±‚ä¸»è¦é›†ä¸­çš„èŠ‚ç‚¹ A ä¸Šï¼Œè¿™è‚¯å®šä¸è¡Œçš„å‘€ï¼Œè¯´å¥½çš„è´Ÿè½½å‡è¡¡å‘¢ï¼Œè¿™ç§æƒ…å†µä¸€ç‚¹éƒ½ä¸å‡è¡¡ã€‚</p><p>å¦å¤–ï¼Œåœ¨è¿™ç§èŠ‚ç‚¹åˆ†å¸ƒä¸å‡åŒ€çš„æƒ…å†µä¸‹ï¼Œè¿›è¡Œå®¹ç¾ä¸æ‰©å®¹æ—¶ï¼Œå“ˆå¸Œç¯ä¸Šçš„ç›¸é‚»èŠ‚ç‚¹å®¹æ˜“å—åˆ°è¿‡å¤§å½±å“ï¼Œå®¹æ˜“å‘ç”Ÿé›ªå´©å¼çš„è¿é”ååº”ã€‚</p><p>æ¯”å¦‚ï¼Œä¸Šå›¾ä¸­å¦‚æœèŠ‚ç‚¹ A è¢«ç§»é™¤äº†ï¼Œå½“èŠ‚ç‚¹ A å®•æœºåï¼Œæ ¹æ®ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•çš„è§„åˆ™ï¼Œå…¶ä¸Šæ•°æ®åº”è¯¥å…¨éƒ¨è¿ç§»åˆ°ç›¸é‚»çš„èŠ‚ç‚¹ B ä¸Šï¼Œè¿™æ ·ï¼ŒèŠ‚ç‚¹ B çš„æ•°æ®é‡ã€è®¿é—®é‡éƒ½ä¼šè¿…é€Ÿå¢åŠ å¾ˆå¤šå€ï¼Œä¸€æ—¦æ–°å¢çš„å‹åŠ›è¶…è¿‡äº†èŠ‚ç‚¹ B çš„å¤„ç†èƒ½åŠ›ä¸Šé™ï¼Œå°±ä¼šå¯¼è‡´èŠ‚ç‚¹ B å´©æºƒï¼Œè¿›è€Œå½¢æˆé›ªå´©å¼çš„è¿é”ååº”ã€‚</p><p>æ‰€ä»¥ï¼Œ<strong>ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•è™½ç„¶å‡å°‘äº†æ•°æ®è¿ç§»é‡ï¼Œä½†æ˜¯å­˜åœ¨èŠ‚ç‚¹åˆ†å¸ƒä¸å‡åŒ€çš„é—®é¢˜</strong>ã€‚</p><h4 id="1-3-é€šè¿‡è™šæ‹ŸèŠ‚ç‚¹æé«˜å‡è¡¡åº¦"><a href="#1-3-é€šè¿‡è™šæ‹ŸèŠ‚ç‚¹æé«˜å‡è¡¡åº¦" class="headerlink" title="1.3 é€šè¿‡è™šæ‹ŸèŠ‚ç‚¹æé«˜å‡è¡¡åº¦"></a>1.3 é€šè¿‡è™šæ‹ŸèŠ‚ç‚¹æé«˜å‡è¡¡åº¦</h4><p>è¦æƒ³è§£å†³èŠ‚ç‚¹èƒ½åœ¨ å“ˆå¸Œç¯ä¸Š åˆ†é…ä¸å‡åŒ€çš„é—®é¢˜ï¼Œå°±æ˜¯è¦æœ‰å¤§é‡çš„èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹è¶Šå¤šï¼Œå“ˆå¸Œç¯ä¸Šçš„èŠ‚ç‚¹åˆ†å¸ƒå°±è¶Šå‡åŒ€ã€‚ä½†é—®é¢˜æ˜¯ï¼Œå®é™…ä¸Šæˆ‘ä»¬æ²¡æœ‰é‚£ä¹ˆå¤šèŠ‚ç‚¹ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±åŠ å…¥è™šæ‹ŸèŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯å¯¹ä¸€ä¸ªçœŸå®èŠ‚ç‚¹åšå¤šä¸ªå‰¯æœ¬ã€‚</p><p>å…·ä½“åšæ³•æ˜¯ï¼Œä¸å†å°†çœŸå®èŠ‚ç‚¹æ˜ å°„åˆ°å“ˆå¸Œç¯ä¸Šï¼Œè€Œæ˜¯å°†è™šæ‹ŸèŠ‚ç‚¹æ˜ å°„åˆ°å“ˆå¸Œç¯ä¸Šï¼Œå¹¶å°†è™šæ‹ŸèŠ‚ç‚¹æ˜ å°„åˆ°å®é™…èŠ‚ç‚¹ã€‚æ‰€ä»¥è¿™é‡Œæœ‰ ä¸¤å±‚ æ˜ å°„å…³ç³»ã€‚</p><p>æ¯”å¦‚å¯¹æ¯ä¸ªèŠ‚ç‚¹åˆ†åˆ«è®¾ç½® 3 ä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼š</p><ul><li>å¯¹èŠ‚ç‚¹ A åŠ ä¸Šç¼–å·æ¥ä½œä¸ºè™šæ‹ŸèŠ‚ç‚¹ï¼šA-01ã€A-02ã€A-03</li><li>å¯¹èŠ‚ç‚¹ B åŠ ä¸Šç¼–å·æ¥ä½œä¸ºè™šæ‹ŸèŠ‚ç‚¹ï¼šB-01ã€B-02ã€B-03</li><li>å¯¹èŠ‚ç‚¹ C åŠ ä¸Šç¼–å·æ¥ä½œä¸ºè™šæ‹ŸèŠ‚ç‚¹ï¼šC-01ã€C-02ã€C-03</li></ul><p>å¼•å…¥è™šæ‹ŸèŠ‚ç‚¹åï¼ŒåŸæœ¬å“ˆå¸Œç¯ä¸Šåªæœ‰ 3 ä¸ªèŠ‚ç‚¹çš„æƒ…å†µï¼Œå°±ä¼šå˜æˆæœ‰ 9 ä¸ªè™šæ‹ŸèŠ‚ç‚¹æ˜ å°„åˆ°å“ˆå¸Œç¯ä¸Šï¼Œå“ˆå¸Œç¯ä¸Šçš„èŠ‚ç‚¹æ•°é‡å¤šäº† 3 å€ã€‚</p><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1682779151776-aaf4acdf-2263-4845-8949-6bcf82659d50-20250605100548993.png" alt="img"></p><p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œ<strong>èŠ‚ç‚¹æ•°é‡å¤šäº†åï¼ŒèŠ‚ç‚¹åœ¨å“ˆå¸Œç¯ä¸Šçš„åˆ†å¸ƒå°±ç›¸å¯¹å‡åŒ€äº†</strong>ã€‚è¿™æ—¶å€™ï¼Œå¦‚æœæœ‰è®¿é—®è¯·æ±‚å¯»å€åˆ°ã€ŒA-01ã€è¿™ä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼Œæ¥ç€å†é€šè¿‡ã€ŒA-01ã€è™šæ‹ŸèŠ‚ç‚¹æ‰¾åˆ°çœŸå®èŠ‚ç‚¹ Aï¼Œè¿™æ ·è¯·æ±‚å°±èƒ½è®¿é—®åˆ°çœŸå®èŠ‚ç‚¹ A äº†ã€‚</p><p>ä¸Šé¢ä¸ºäº†æ–¹ä¾¿ä½ ç†è§£ï¼Œæ¯ä¸ªçœŸå®èŠ‚ç‚¹ä»…åŒ…å« 3 ä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼Œè¿™æ ·èƒ½èµ·åˆ°çš„å‡è¡¡æ•ˆæœå…¶å®å¾ˆæœ‰é™ã€‚è€Œåœ¨å®é™…çš„å·¥ç¨‹ä¸­ï¼Œè™šæ‹ŸèŠ‚ç‚¹çš„æ•°é‡ä¼šå¤§å¾ˆå¤šï¼Œæ¯”å¦‚ Nginx çš„ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ï¼Œæ¯ä¸ªæƒé‡ä¸º 1 çš„çœŸå®èŠ‚ç‚¹å°±å«æœ‰160 ä¸ªè™šæ‹ŸèŠ‚ç‚¹ã€‚</p><p>å¦å¤–ï¼Œè™šæ‹ŸèŠ‚ç‚¹é™¤äº†ä¼šæé«˜èŠ‚ç‚¹çš„å‡è¡¡åº¦ï¼Œè¿˜ä¼šæé«˜ç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚<strong>å½“èŠ‚ç‚¹å˜åŒ–æ—¶ï¼Œä¼šæœ‰ä¸åŒçš„èŠ‚ç‚¹å…±åŒåˆ†æ‹…ç³»ç»Ÿçš„å˜åŒ–ï¼Œå› æ­¤ç¨³å®šæ€§æ›´é«˜</strong>ã€‚æ¯”å¦‚ï¼Œå½“æŸä¸ªèŠ‚ç‚¹è¢«ç§»é™¤æ—¶ï¼Œå¯¹åº” è¯¥èŠ‚ç‚¹çš„å¤šä¸ªè™šæ‹ŸèŠ‚ç‚¹å‡ä¼šç§»é™¤ï¼Œè€Œè¿™äº›è™šæ‹ŸèŠ‚ç‚¹æŒ‰é¡ºæ—¶é’ˆæ–¹å‘çš„ä¸‹ä¸€ä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼Œå¯èƒ½ä¼šå¯¹åº”ä¸åŒçš„çœŸå®èŠ‚ç‚¹ï¼Œå³è¿™äº›ä¸åŒçš„çœŸå®èŠ‚ç‚¹å…±åŒåˆ†æ‹…äº† èŠ‚ç‚¹è¢«ç§»é™¤ å¯¼è‡´çš„å‹åŠ›ã€‚</p><p>è€Œä¸”æœ‰è™šæ‹ŸèŠ‚ç‚¹çš„æ¦‚å¿µä¹Ÿæ–¹ä¾¿äº†ï¼Œå¯¹ä¸åŒèŠ‚ç‚¹è¿›è¡Œæƒé‡åŒºåˆ†ã€‚ç¡¬ä»¶é…ç½®æ›´å¥½çš„èŠ‚ç‚¹ï¼Œå¢åŠ æ›´å¤šè™šæ‹ŸèŠ‚ç‚¹ã€‚</p><h4 id="1-4-æ€»ç»“"><a href="#1-4-æ€»ç»“" class="headerlink" title="1.4 æ€»ç»“"></a>1.4 æ€»ç»“</h4><p>è½®è®­è¿™ç±»çš„ç­–ç•¥åªèƒ½é€‚ç”¨ä¸æ¯ä¸ªèŠ‚ç‚¹çš„æ•°æ®éƒ½æ˜¯ç›¸åŒçš„åœºæ™¯ï¼Œè®¿é—®ä»»æ„èŠ‚ç‚¹éƒ½èƒ½è¯·æ±‚åˆ°æ•°æ®ã€‚ä½†æ˜¯ä¸é€‚ç”¨åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå› ä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿæ„å‘³ç€æ•°æ®æ°´å¹³åˆ‡åˆ†åˆ°äº†ä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œè®¿é—®æ•°æ®çš„æ—¶å€™ï¼Œä¸€å®šè¦å¯»å€å­˜å‚¨è¯¥æ•°æ®çš„èŠ‚ç‚¹ã€‚</p><p>å“ˆå¸Œç®—æ³•è™½ç„¶èƒ½å»ºç«‹æ•°æ®å’ŒèŠ‚ç‚¹çš„æ˜ å°„å…³ç³»ï¼Œä½†æ˜¯æ¯æ¬¡åœ¨èŠ‚ç‚¹æ•°é‡å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œæœ€åæƒ…å†µä¸‹æ‰€æœ‰æ•°æ®éƒ½éœ€è¦è¿ç§»ï¼Œè¿™æ ·å¤ªéº»çƒ¦äº†ï¼Œæ‰€ä»¥ä¸é€‚ç”¨èŠ‚ç‚¹æ•°é‡å˜åŒ–çš„åœºæ™¯ã€‚</p><p>ä¸ºäº†å‡å°‘è¿ç§»çš„æ•°æ®é‡ï¼Œå°±å‡ºç°äº†ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ã€‚</p><p>ä¸€è‡´æ€§å“ˆå¸Œæ˜¯æŒ‡å°†ã€Œå­˜å‚¨èŠ‚ç‚¹ã€å’Œã€Œæ•°æ®ã€éƒ½æ˜ å°„åˆ°ä¸€ä¸ªé¦–å°¾ç›¸è¿çš„å“ˆå¸Œç¯ä¸Šï¼Œå¦‚æœå¢åŠ æˆ–è€…ç§»é™¤ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä»…å½±å“è¯¥èŠ‚ç‚¹åœ¨å“ˆå¸Œç¯ä¸Šé¡ºæ—¶é’ˆç›¸é‚»çš„åç»§èŠ‚ç‚¹ï¼Œå…¶å®ƒæ•°æ®ä¹Ÿä¸ä¼šå—åˆ°å½±å“ã€‚</p><p>ä½†æ˜¯ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ä¸èƒ½å¤Ÿå‡åŒ€çš„åˆ†å¸ƒèŠ‚ç‚¹ï¼Œä¼šå‡ºç°å¤§é‡è¯·æ±‚éƒ½é›†ä¸­åœ¨ä¸€ä¸ªèŠ‚ç‚¹çš„æƒ…å†µï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹è¿›è¡Œå®¹ç¾ä¸æ‰©å®¹æ—¶ï¼Œå®¹æ˜“å‡ºç°é›ªå´©çš„è¿é”ååº”ã€‚</p><p>ä¸ºäº†è§£å†³ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ä¸èƒ½å¤Ÿå‡åŒ€çš„åˆ†å¸ƒèŠ‚ç‚¹çš„é—®é¢˜ï¼Œå°±éœ€è¦å¼•å…¥è™šæ‹ŸèŠ‚ç‚¹ï¼Œå¯¹ä¸€ä¸ªçœŸå®èŠ‚ç‚¹åšå¤šä¸ªå‰¯æœ¬ã€‚ä¸å†å°†çœŸå®èŠ‚ç‚¹æ˜ å°„åˆ°å“ˆå¸Œç¯ä¸Šï¼Œè€Œæ˜¯å°†è™šæ‹ŸèŠ‚ç‚¹æ˜ å°„åˆ°å“ˆå¸Œç¯ä¸Šï¼Œå¹¶å°†è™šæ‹ŸèŠ‚ç‚¹æ˜ å°„åˆ°å®é™…èŠ‚ç‚¹ï¼Œæ‰€ä»¥è¿™é‡Œæœ‰ã€Œä¸¤å±‚ã€æ˜ å°„å…³ç³»ã€‚</p><p>å¼•å…¥è™šæ‹ŸèŠ‚ç‚¹åï¼Œå¯ä»¥ä¼šæé«˜èŠ‚ç‚¹çš„å‡è¡¡åº¦ï¼Œè¿˜ä¼šæé«˜ç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚æ‰€ä»¥ï¼Œå¸¦è™šæ‹ŸèŠ‚ç‚¹çš„ä¸€è‡´æ€§å“ˆå¸Œæ–¹æ³•ä¸ä»…é€‚åˆç¡¬ä»¶é…ç½®ä¸åŒçš„èŠ‚ç‚¹çš„åœºæ™¯ï¼Œè€Œä¸”é€‚åˆèŠ‚ç‚¹è§„æ¨¡ä¼šå‘ç”Ÿå˜åŒ–çš„åœºæ™¯ã€‚</p><hr><p>æ‘˜å½•æ–‡ç« ï¼š</p><p>Redis è®¾è®¡ä¸å®ç°ï¼ˆç¬¬ä¸€ç‰ˆï¼‰ï¼š<a href="https://redisbook.readthedocs.io/en/latest/index.html">https://redisbook.readthedocs.io/en/latest/index.html</a></p><p><a href="https://juejin.cn/post/6964531365643550751">ç¾å›¢äºŒé¢ï¼šRedisä¸MySQLåŒå†™ä¸€è‡´æ€§å¦‚ä½•ä¿è¯ï¼Ÿ</a></p>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>JVMæ–°ç”Ÿä»£åªæœ‰ä¸€ä¸ªEden+S0 å¯ä»¥å—</title>
      <link href="/2025/06/07/%E6%96%B0%E7%94%9F%E4%BB%A3%E5%8F%AA%E6%9C%89%E4%B8%80%E4%B8%AAEden+S0%20%E5%8F%AF%E4%BB%A5%E5%90%97/"/>
      <url>/2025/06/07/%E6%96%B0%E7%94%9F%E4%BB%A3%E5%8F%AA%E6%9C%89%E4%B8%80%E4%B8%AAEden+S0%20%E5%8F%AF%E4%BB%A5%E5%90%97/</url>
      
        <content type="html"><![CDATA[<h1 id="JVMæ–°ç”Ÿä»£åªæœ‰ä¸€ä¸ªEden-S0-å¯ä»¥å—"><a href="#JVMæ–°ç”Ÿä»£åªæœ‰ä¸€ä¸ªEden-S0-å¯ä»¥å—" class="headerlink" title="JVMæ–°ç”Ÿä»£åªæœ‰ä¸€ä¸ªEden+S0 å¯ä»¥å—"></a>JVMæ–°ç”Ÿä»£åªæœ‰ä¸€ä¸ªEden+S0 å¯ä»¥å—</h1><p><img src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/1742279689877-fe42aa96-5291-48a1-9804-ae55a6877eab.png" alt="img"></p><p>å…ˆç›´æ¥è¯´ç­”æ¡ˆï¼š<strong>ç†è®ºä¸Šå¯ä»¥ï¼Œä¹Ÿèƒ½å®ç°æ ‡è®°-å¤åˆ¶ç®—æ³•ã€‚ä½†å·¥ç¨‹ä¸Šä¸å¯ä»¥ï¼Œå› ä¸ºä¼šå¤§å¤§æµªè´¹ç©ºé—´ã€‚</strong></p><p>æ ‡è®°-å¤åˆ¶ç®—æ³•ä¸‹ï¼Œæ–°ç”Ÿä»£ä¸‰ä¸ªåŒºåŸŸæ˜¯æ€ä¹ˆä½¿ç”¨çš„ï¼š</p><ol><li>åˆå§‹æ—¶ï¼ŒEdenã€S0ã€S1 éƒ½æ˜¯ç©º</li><li>å¯¹è±¡éƒ½åˆ†é…åœ¨ EdenåŒºï¼Œå¦‚æœEdenåŒºå¿«æ»¡äº†å°±è§¦å‘åƒåœ¾å›æ”¶ï¼ŒæŠŠ EdenåŒºä¸­çš„å­˜æ´»å¯¹è±¡è½¬ç§»åˆ°ä¸€ä¸ªå—ç©ºçš„survivoråŒºï¼ˆS0ï¼‰ï¼Œç„¶å EdenåŒºæ¸…ç©ºã€‚ï¼ˆä¸€æ¬¡youngGCç»“æŸï¼‰</li><li>å†æ¬¡åˆ†é…æ–°å¯¹è±¡åˆ° Edenï¼Œå†æ¬¡è§¦å‘åƒåœ¾å›æ”¶ï¼ˆæ­¤æ—¶ä¸å…‰æ ‡è®° Edenï¼Œè¿˜éœ€è¦æ ‡è®°S0äº†ï¼‰ï¼Œç„¶åå°†è¿™ä¸¤ä¸ªåŒºåŸŸå­˜æ´»çš„è½¬ç§»åˆ° å¦ä¸€å—ç©ºçš„survivoråŒºï¼ˆS1ï¼‰ï¼Œæ¸…ç†S0ã€EdenåŒºï¼ˆä¸€æ¬¡youngGCç»“æŸï¼‰</li><li>å†æ¬¡åˆ†é…æ–°å¯¹è±¡åˆ° Edenï¼Œå†æ¬¡è§¦å‘åƒåœ¾å›æ”¶ï¼ˆæ­¤æ—¶ä¸å…‰æ ‡è®° Edenï¼Œè¿˜éœ€è¦æ ‡è®°S1äº†ï¼‰ï¼Œç„¶åå°†è¿™ä¸¤ä¸ªåŒºåŸŸå­˜æ´»çš„è½¬ç§»åˆ° å¦ä¸€å—ç©ºçš„survivoråŒºï¼ˆS0ï¼‰</li></ol><p>å› æ­¤é‡‡ç”¨ Eden+S0+S1ï¼ˆ8ï¼š1ï¼š1ï¼‰ï¼Œå¯ä»¥ä¿è¯JVMæ­£å¸¸è¿è¡Œæ—¶ï¼Œæ–°ç”Ÿä»£çš„ç©ºé—´æœ‰9æˆå¯ä»¥å­˜æ”¾å¯¹è±¡ï¼Œ1æˆæ˜¯ç©ºç€çš„ã€‚</p><p>å¦‚æœè¯´åªæœ‰ä¸¤ä¸ªåŒºåŸŸï¼Œæ¯”å¦‚ EdenåŒºå’ŒS0ã€‚é‚£ä¹ˆç”±äºæ ‡è®°å¤åˆ¶ç®—æ³•çš„é™åˆ¶ï¼ˆå¿…é¡»ç”±ä¸€å—åŒºåŸŸæ˜¯ç©ºçš„ï¼‰ã€‚æ¯æ¬¡åªæœ‰ä¸€ä¸ªåŒºåŸŸæ˜¯å­˜æ”¾youngGCæ´»ä¸‹æ¥çš„å¯¹è±¡ï¼Œä¸€ä¸ªåŒºåŸŸæ˜¯ç©ºçš„ã€‚</p><p>å› ä¸ºè¦è½®æµå­˜æ”¾å¯¹è±¡ï¼Œé‚£ä¹ˆæ¯”ä¾‹åº”è¯¥å°±æ˜¯1ï¼š1ã€‚é‚£ä¹ˆåœ¨æ­£å¸¸è¿è¡Œæ—¶ï¼Œ<strong>JVMæ–°ç”Ÿä»£ä¸­åªæœ‰ä¸€åŠçš„å†…å­˜å¯ä»¥åˆ†é…å¯¹è±¡ï¼Œå¦ä¸€åŠå¾—ç©ºç€</strong>ã€‚</p><p>å¦‚æœè¯´ä¸æƒ³è¦æœ‰åŒºåŸŸæ˜¯ç©ºç€çš„ï¼Œé‚£ä¹ˆå°±éœ€è¦ä½¿ç”¨ æ ‡è®°-æ¸…é™¤ç®—æ³•æˆ–è€…æ ‡è®°-æ•´ç†ç®—æ³•ï¼Œå°±ä¼šå­˜åœ¨ç¢ç‰‡å’Œæ•ˆç‡é—®é¢˜ã€‚è€Œè¿™ä¸ æ–°ç”Ÿä»£çš„è®¾è®¡åˆè¡·ç›¸è¿èƒŒï¼ˆæ–°ç”Ÿä»£ä¼šæ¯”è¾ƒé«˜é¢‘è¿›è¡Œåƒåœ¾å›æ”¶ï¼‰</p>]]></content>
      
      
      <categories>
          
          <category> åç«¯ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>è¶…ç»æ’å›¾ç½‘ç«™æ¨è</title>
      <link href="/2024/12/23/%E8%B6%85%E7%BB%9D%E6%8F%92%E5%9B%BE%E7%BD%91%E7%AB%99%E6%8E%A8%E8%8D%90/"/>
      <url>/2024/12/23/%E8%B6%85%E7%BB%9D%E6%8F%92%E5%9B%BE%E7%BD%91%E7%AB%99%E6%8E%A8%E8%8D%90/</url>
      
        <content type="html"><![CDATA[<p>ç›¸ä¿¡å¾ˆå¤šå°ä¼™ä¼´ï¼Œéƒ½è®¤è¯†åˆ°ä¸€ä¸ªå¥½çš„æ’å›¾ï¼Œå¯¹ç½‘ç«™&#x2F;app æˆ–è€…åšå®¢æ–‡ç« çš„é‡è¦æ€§äº†ã€‚æˆ‘å¸¸å¸¸ä¹Ÿéœ€è¦ä¸€äº›é«˜è´¨é‡æœ‰åˆ›æ„çš„æ’å›¾ï¼Œæ¥è£…é¥°ç½‘ç«™æˆ–appï¼Œè®©æ•´ä½“çœ‹èµ·æ¥éå¸¸å¾—åŠ²ã€‚è¿™é‡Œæ¨èå‡ ä¸ªæˆ‘è‡ªå·±ç”¨çš„</p><ul><li><p>pinterest</p><p>ç½‘ç«™åœ°å€ï¼š<a href="https://www.pinterest.com/%EF%BC%8C%E5%85%8D%E8%B4%B9%E6%B3%A8%E5%86%8C%E5%92%8C%E4%B8%8B%E8%BD%BD%E5%8E%9F%E5%9B%BE">https://www.pinterest.com/ï¼Œå…è´¹æ³¨å†Œå’Œä¸‹è½½åŸå›¾</a></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> å‰ç«¯ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>macå®‰è£… picgo æŠ¥é”™ æ–‡ä»¶æŸå</title>
      <link href="/2024/12/22/mac%E5%AE%89%E8%A3%85%20picgo%20%E6%8A%A5%E9%94%99%20%E6%96%87%E4%BB%B6%E6%8D%9F%E5%9D%8F/"/>
      <url>/2024/12/22/mac%E5%AE%89%E8%A3%85%20picgo%20%E6%8A%A5%E9%94%99%20%E6%96%87%E4%BB%B6%E6%8D%9F%E5%9D%8F/</url>
      
        <content type="html"><![CDATA[<h1 id="macå®‰è£…-picgo-æŠ¥é”™-æ–‡ä»¶æŸå"><a href="#macå®‰è£…-picgo-æŠ¥é”™-æ–‡ä»¶æŸå" class="headerlink" title="macå®‰è£… picgo æŠ¥é”™ æ–‡ä»¶æŸå"></a>macå®‰è£… picgo æŠ¥é”™ æ–‡ä»¶æŸå</h1><p>picgoä¸‹è½½åœ°å€ï¼š<a href="https://github.com/molunerfinn/picgo/releases">https://github.com/molunerfinn/picgo/releases</a></p><p>macå®‰è£…æŠ¥é”™ä¸æ˜¯å› ä¸º picgoç‰ˆæœ¬é—®é¢˜ï¼Œ</p>]]></content>
      
      
      <categories>
          
          <category> å¼€å‘/ç¯å¢ƒ/è½¯ä»¶é—®é¢˜ </category>
          
      </categories>
      
      
    </entry>
    
    
  
  
</search>
