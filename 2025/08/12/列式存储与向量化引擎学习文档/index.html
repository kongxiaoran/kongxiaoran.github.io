<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>深入理解列式存储与向量化引擎 | 凌霄的博客</title><meta name="keywords" content="密码学,非对称加密,数字签名,数字证书,CA"><meta name="author" content="XR"><meta name="copyright" content="XR"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="深入理解列式存储与向量化引擎"><meta name="application-name" content="深入理解列式存储与向量化引擎"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="深入理解列式存储与向量化引擎"><meta property="og:url" content="http://example.com/2025/08/12/%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%E4%B8%8E%E5%90%91%E9%87%8F%E5%8C%96%E5%BC%95%E6%93%8E%E5%AD%A6%E4%B9%A0%E6%96%87%E6%A1%A3/index.html"><meta property="og:site_name" content="凌霄的博客"><meta property="og:description" content="深入浅出地剖析数字签名与数字证书的核心原理。解释为什么需要签名与证书，它们如何保证通信的真实性、完整性和不可否认性，并详细拆解证书链（CA）的构建与验证过程。"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/20250801164133928.png"><meta property="article:author" content="XR"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/20250801164133928.png"><meta name="description" content="深入浅出地剖析数字签名与数字证书的核心原理。解释为什么需要签名与证书，它们如何保证通信的真实性、完整性和不可否认性，并详细拆解证书链（CA）的构建与验证过程。"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://example.com/2025/08/12/%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%E4%B8%8E%E5%90%91%E9%87%8F%E5%8C%96%E5%BC%95%E6%93%8E%E5%AD%A6%E4%B9%A0%E6%96%87%E6%A1%A3/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: undefined,
  greetingBox: undefined,
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  music_page_default: "nav_music",
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":["🤖️ 数码科技爱好者","🔍 分享与热心帮助","🧱 团队小组发动机"]},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: XR","link":"链接: ","source":"来源: 凌霄的博客","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: '凌霄的博客',
  title: '深入理解列式存储与向量化引擎',
  postAI: '',
  pageFillDescription: '深入理解列式存储与向量化引擎, 前言, 一、 列式存储（Columnar Storage）, 1.1 什么是列式存储？, 存储方式对比, 1.2 为什么需要列式存储？（与行式对比）, 1.3 为什么性能高？, 二、 向量化执行引擎（Vectorized Execution Engine）, 2.1 什么是向量化执行？, 执行模型对比：深入理解性能差异, 为什么传统行式模型开销大？, 2.2 核心概念解析：向量化如何战胜性能瓶颈, 2.2.1 SIMD：用一条指令干多个人的活, 2.2.2 掩码x2F位图：消灭 if 分支的艺术, 2.3 向量化引擎的设计原理, 2.3.1 核心技术：字典编码与延迟物化, 2.3.2 其他关键设计, 三、总结：, 参考资料深入理解列式存储与向量化引擎前言在现代数据分析领域性能是至关重要的为了处理海量数据并实现近乎实时的查询响应数据库和计算引擎的技术已经从传统的面向事务的设计演进到了以列式存储为基础以向量化执行为核心的新范式本文档将详细拆解这两项关键技术帮助你理解它们是什么为什么需要以及它们如何协同工作创造出数量级的性能提升一列式存储什么是列式存储列式存储是一种数据在磁盘或内存中按列连续组织和存放的策略为了直观理解我们来看一个简单的用户表示例整型字符串整型存储方式对比行式存储常用数据按行连续存放一行的数据紧挨在一起列式存储常用数据按列连续存放同一列的所有数据紧挨在一起为什么需要列式存储与行式对比特性行式存储列式存储适用场景在线事务处理频繁的增删改查通常按主键查整行例如订单系统银行交易在线分析处理海量数据的复杂查询聚合统计例如数据仓库报表特点读取整行高效一次即可获取一行所有数据但查询若只涉及少数几列会读取大量无关数据读取少数列高效只需读取查询所需列的数据极大减少了量这是场景性能提升的关键压缩效率较低一行内数据类型各异字符串数字日期相似度低难以高效压缩极高同一列数据类型相同业务含义相似数据重复度高非常适合压缩常用算法字典编码编码等为什么性能高列式存储的高性能主要源于以下三点最小化这是最核心的优势对于分析类查询如列式存储只需读取这一列的数据而行式存储则必须扫描每一行的所有数据包括和开销可能相差数十甚至数百倍高压缩率由于同列数据的高度同质性可以实现非常高的压缩比这意味着更少的磁盘空间占用和更低的带宽需求数据从磁盘加载到内存的时间也相应减少为向量化执行铺平道路数据按列连续存放在内存中这为高效处理数据创造了完美条件这种布局使得后续的向量化执行成为可能二向量化执行引擎如果说列式存储解决了瓶颈那么向量化执行则致力于解决计算瓶颈什么是向量化执行向量化执行是一种数据处理模型它一次处理一批数据一个列的片段称为向量或批而不是一次处理一行执行模型对比深入理解性能差异要理解两种模型的根本区别我们首先需要了解查询计划树当数据库执行一条时会先生成一个由多个操作符组成的执行蓝图数据从树的叶子节点如流向根节点最终结果数据流向显式定义子图内部的连接方向提高兼容性现在我们来看数据是如何在这棵树上流动的传统行式火山模型零售模式这是一个典型的拉动模型数据一次一行一个元组地在树中被拉着向上流动顶层操作符调用说给我下一行符合条件的数据操作符调用说给我下一行数据从表中读出一行数据返回给检查这一行是否满足条件如果满足就将这一行返回给如果不满足则回到第步继续向要下一行在这个模型中处理每一行数据都会触发一整条从上到下的方法调用链控制流开销巨大向量化执行模型批发模式向量化执行采用的也是拉动模型但拉动的是一次一块数据一个块由固定的一组元组记录组成它代表一组向量这些向量和列字段有一一对应的关系向量块是数据的基本单元它经由执行计划树从一个操作符流向另一个操作符顶层操作符调用说给我下一批符合条件的数据操作符调用说给我下一批数据从表中一次性读出一个数据块例如行形成一个返回给对这一整块数据进行批量处理例如使用掩码生成一个新的只包含符合条件数据的数据块然后返回给在这个模型中方法调用的开销被均摊到了一个批次的上千行数据上极大地降低了单位数据的处理成本为什么传统行式模型开销大看似简单的循环背后隐藏着巨大的性能开销大量的虚方法调用在或中算子通常是接口或基类如是一个虚方法对于一个包含多个算子扫描过滤投影聚合的复杂查询处理每一行数据都会触发一连串的虚方法调用这会阻碍编译器的内联优化并导致高昂的动态分派开销频繁的分支预测失败循环中的条件如会引入大量分支现代为了提高效率会进行分支预测提前执行它认为最可能的分支如果数据分布不均的结果时真时假就会频繁猜错每次猜错都会导致整个流水线被清空和重建这会浪费几十个甚至上百个周期缓存未命中行式数据在内存中通常不是连续的特别是包含变长字符串时在处理数据时需要进行指针追逐这会频繁导致缓存未命中被迫从慢得多的主内存中读取数据核心概念解析向量化如何战胜性能瓶颈向量化执行通过一系列精妙设计完美地规避了上述问题用一条指令干多个人的活即单指令多数据是现代提供的一种强大的并行计算能力是什么它允许用一条指令同时对多个数据执行相同的操作你可以把它想象成内部的一条流水线一次可以处理一整托盘的数据而不是一个一个地处理如何实现内部有特殊的向量寄存器如位的寄存器位的寄存器例如一个位的寄存器可以一次性装入个位整数或个位浮点数的一条加法指令就可以瞬间完成这个整数对的相加与向量化的关系列式数据在内存中连续存放完美契合了的工作模式引擎可以直接将一个列向量数组的一部分加载到向量寄存器中用指令进行计算性能提升是数量级的掩码位图消灭分支的艺术为了避免分支预测失败带来的巨大成本向量化引擎采用掩码或位图来处理条件逻辑这是一种将控制流依赖转换为数据流依赖的技巧是什么一个掩码位图就是一个布尔值数组或一个比特序列用于记录一批数据中哪些行符合条件如何实现生成掩码不再使用来逐个判断而是执行一个向量化的比较操作生成一个掩码例如对于引擎会一次性比较一批数据生成一个类似的布尔掩码应用掩码后续的算子根据这个掩码来只处理有效的数据例如聚合算子会根据掩码只累加那些对应位置为的值为什么性能高无分支整个过程没有跳转流水线可以顺畅地执行不会被打断友好生成掩码和应用掩码的过程本身也可以被指令高度优化向量化引擎的设计原理一个现代的向量化引擎通常包含以下关键设计核心技术字典编码与延迟物化这两项技术通常结合使用尤其是在处理字符串等变长比较耗时的数据类型时字典编码是什么一种高效的列压缩技术它会扫描一列数据如国家名称为所有不重复的值创建一个字典并用紧凑的整数来替换原始值示例原始列美国中国美国日本中国字典美国中国日本编码后的数据优势极大减少了内存占用更重要的是将耗时的字符串比较哈希操作转换成了极速的整数操作延迟物化是什么在整个查询执行过程中尽可能地推迟将数据从其压缩或编码形式如字典转换回原始值的过程示例执行美国时引擎首先将美国在字典中查询到其为然后它在编码后的整数数据上执行的过滤操作这个过程完全是整数比较速度极快优势只有在查询的最后一步当需要向用户展示结果时引擎才会根据如去字典里查找原始值美国所有中间的过滤聚合关联操作都在高效的编码数据上完成避免了对海量原始数据的昂贵操作其他关键设计批处理模型数据以或的形式在算子间流动一个包含多列每列包含一批数据如或行标准列式内存格式如为了实现高效的跨语言跨进程数据交换甚至是零拷贝业界广泛采用作为内存中的列式标准原生算子设计所有的计算算子如都必须重新设计使其能直接操作三总结列式存储和向量化执行是现代高性能分析引擎的两个核心支柱它们相辅相成缺一不可列式存储负责在宏观上磁盘减少数据读取量并提供一种对缓存和友好的内存布局向量化执行则在微观上计算充分利用这种数据布局通过批处理指令无分支计算和延迟物化等技术将的计算能力压榨到极致正是这种从存储到计算的全链路优化才使得像等现代数据系统能够实现惊人的查询性能参考资料列式数据库和向量化向量化引擎怎么提升数据库性能墨天轮',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-08-18 15:09:16',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">凌霄的博客</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/kongxiaoran/image-repo/blog20241226231130275.png" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://cdn.jsdelivr.net/gh/kongxiaoran/image-repo/blog20241226231130275.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/kongxiaoran/image-repo/blog20241226231143327.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://cdn.jsdelivr.net/gh/kongxiaoran/image-repo/blog20241226231143327.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Argon2/" style="font-size: 1.05rem;">Argon2<sup>1</sup></a><a href="/tags/DNS/" style="font-size: 1.05rem;">DNS<sup>2</sup></a><a href="/tags/HBase/" style="font-size: 1.05rem;">HBase<sup>1</sup></a><a href="/tags/HDFS/" style="font-size: 1.05rem;">HDFS<sup>4</sup></a><a href="/tags/HTTP/" style="font-size: 1.05rem;">HTTP<sup>1</sup></a><a href="/tags/Hadoop/" style="font-size: 1.05rem;">Hadoop<sup>4</sup></a><a href="/tags/Hive/" style="font-size: 1.05rem;">Hive<sup>1</sup></a><a href="/tags/HyperEnclave/" style="font-size: 1.05rem;">HyperEnclave<sup>5</sup></a><a href="/tags/Java/" style="font-size: 1.05rem;">Java<sup>8</sup></a><a href="/tags/Kubernetes/" style="font-size: 1.05rem;">Kubernetes<sup>1</sup></a><a href="/tags/Linux/" style="font-size: 1.05rem;">Linux<sup>5</sup></a><a href="/tags/Maven/" style="font-size: 1.05rem;">Maven<sup>1</sup></a><a href="/tags/RDD/" style="font-size: 1.05rem;">RDD<sup>2</sup></a><a href="/tags/SGX/" style="font-size: 1.05rem;">SGX<sup>2</sup></a><a href="/tags/Shuffle%E6%9C%BA%E5%88%B6/" style="font-size: 1.05rem;">Shuffle机制<sup>1</sup></a><a href="/tags/Spark/" style="font-size: 1.05rem;">Spark<sup>10</sup></a><a href="/tags/Spring/" style="font-size: 1.05rem;">Spring<sup>3</sup></a><a href="/tags/TDX/" style="font-size: 1.05rem;">TDX<sup>2</sup></a><a href="/tags/TEE/" style="font-size: 1.05rem;">TEE<sup>9</sup></a><a href="/tags/TME/" style="font-size: 1.05rem;">TME<sup>2</sup></a><a href="/tags/YARN/" style="font-size: 1.05rem;">YARN<sup>1</sup></a><a href="/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/" style="font-size: 1.05rem;">云原生<sup>1</sup></a><a href="/tags/%E4%BB%A3%E7%90%86/" style="font-size: 1.05rem;">代理<sup>1</sup></a><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/" style="font-size: 1.05rem;">分布式存储<sup>2</sup></a><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%A1%E7%AE%97/" style="font-size: 1.05rem;">分布式计算<sup>3</sup></a><a href="/tags/%E5%9C%B0%E7%90%86%E4%BD%8D%E7%BD%AE%E9%99%90%E5%88%B6/" style="font-size: 1.05rem;">地理位置限制<sup>1</sup></a><a href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/" style="font-size: 1.05rem;">大数据<sup>6</sup></a><a href="/tags/%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF/" style="font-size: 1.05rem;">学习路线<sup>1</sup></a><a href="/tags/%E5%AE%89%E5%85%A8/" style="font-size: 1.05rem;">安全<sup>2</sup></a><a href="/tags/%E5%AF%86%E7%A0%81%E5%93%88%E5%B8%8C/" style="font-size: 1.05rem;">密码哈希<sup>1</sup></a><a href="/tags/%E5%AF%86%E7%A0%81%E5%AD%A6/" style="font-size: 1.05rem;">密码学<sup>5</sup></a><a href="/tags/%E6%8A%80%E6%9C%AF%E4%B8%93%E6%A0%8F/" style="font-size: 1.05rem;">技术专栏<sup>1</sup></a><a href="/tags/%E6%9C%BA%E5%AF%86%E8%AE%A1%E7%AE%97/" style="font-size: 1.05rem;">机密计算<sup>2</sup></a><a href="/tags/%E6%B5%81%E5%AA%92%E4%BD%93%E8%A7%A3%E9%94%81/" style="font-size: 1.05rem;">流媒体解锁<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 1.05rem;">网络<sup>4</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C%E5%88%86%E6%9E%90/" style="font-size: 1.05rem;">网络分析<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" style="font-size: 1.05rem;">网络安全<sup>1</sup></a><a href="/tags/%E9%98%B2%E7%81%AB%E5%A2%99/" style="font-size: 1.05rem;">防火墙<sup>2</sup></a><a href="/tags/%E9%9A%90%E7%A7%81%E8%AE%A1%E7%AE%97/" style="font-size: 1.05rem;">隐私计算<sup>3</sup></a><a href="/tags/%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84/" style="font-size: 1.05rem;">集群架构<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/09/"><span class="card-archive-list-date">九月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/08/"><span class="card-archive-list-date">八月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">6</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/07/"><span class="card-archive-list-date">七月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">17</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/06/"><span class="card-archive-list-date">六月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">32</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/01/"><span class="card-archive-list-date">一月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/12/"><span class="card-archive-list-date">十二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%90%8E%E7%AB%AF/" itemprop="url">后端</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/%E5%AF%86%E7%A0%81%E5%AD%A6/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>密码学</span></a><a class="article-meta__tags" href="/tags/%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>非对称加密</span></a><a class="article-meta__tags" href="/tags/%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>数字签名</span></a><a class="article-meta__tags" href="/tags/%E6%95%B0%E5%AD%97%E8%AF%81%E4%B9%A6/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>数字证书</span></a><a class="article-meta__tags" href="/tags/CA/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>CA</span></a></span></div></div><h1 class="post-title" itemprop="name headline">深入理解列式存储与向量化引擎</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-08-12T11:00:00.000Z" title="发表于 2025-08-12 19:00:00">2025-08-12</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-08-18T07:09:16.797Z" title="更新于 2025-08-18 15:09:16">2025-08-18</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="深入理解列式存储与向量化引擎"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为杭州"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>杭州</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/20250801164133928.png"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://example.com/2025/08/12/%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%E4%B8%8E%E5%90%91%E9%87%8F%E5%8C%96%E5%BC%95%E6%93%8E%E5%AD%A6%E4%B9%A0%E6%96%87%E6%A1%A3/"><header><a class="post-meta-categories" href="/categories/%E5%90%8E%E7%AB%AF/" itemprop="url">后端</a><a href="/tags/%E5%AF%86%E7%A0%81%E5%AD%A6/" tabindex="-1" itemprop="url">密码学</a><a href="/tags/%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86/" tabindex="-1" itemprop="url">非对称加密</a><a href="/tags/%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D/" tabindex="-1" itemprop="url">数字签名</a><a href="/tags/%E6%95%B0%E5%AD%97%E8%AF%81%E4%B9%A6/" tabindex="-1" itemprop="url">数字证书</a><a href="/tags/CA/" tabindex="-1" itemprop="url">CA</a><h1 id="CrawlerTitle" itemprop="name headline">深入理解列式存储与向量化引擎</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">XR</span><time itemprop="dateCreated datePublished" datetime="2025-08-12T11:00:00.000Z" title="发表于 2025-08-12 19:00:00">2025-08-12</time><time itemprop="dateCreated datePublished" datetime="2025-08-18T07:09:16.797Z" title="更新于 2025-08-18 15:09:16">2025-08-18</time></header><h1 id="深入理解列式存储与向量化引擎"><a href="#深入理解列式存储与向量化引擎" class="headerlink" title="深入理解列式存储与向量化引擎"></a>深入理解列式存储与向量化引擎</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在现代数据分析（OLAP）领域，性能是至关重要的。为了处理海量数据并实现近乎实时的查询响应，数据库和计算引擎的技术已经从传统的面向事务（OLTP）的设计，演进到了以<strong>列式存储（Columnar Storage）</strong>为基础，以<strong>向量化执行（Vectorized Execution）</strong>为核心的新范式。</p>
<p>本文档将详细拆解这两项关键技术，帮助你理解它们是什么、为什么需要、以及它们如何协同工作，创造出数量级的性能提升。</p>
<h2 id="一、-列式存储（Columnar-Storage）"><a href="#一、-列式存储（Columnar-Storage）" class="headerlink" title="一、 列式存储（Columnar Storage）"></a>一、 列式存储（Columnar Storage）</h2><h3 id="1-1-什么是列式存储？"><a href="#1-1-什么是列式存储？" class="headerlink" title="1.1 什么是列式存储？"></a>1.1 什么是列式存储？</h3><p><strong>列式存储</strong>是一种数据在磁盘或内存中按<strong>列（Column）</strong>连续组织和存放的策略。</p>
<p>为了直观理解，我们来看一个简单的用户表示例：</p>
<table>
<thead>
<tr>
<th align="left">UserID (整型)</th>
<th align="left">Name (字符串)</th>
<th align="left">Age (整型)</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">Alice</td>
<td align="left">30</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">Bob</td>
<td align="left">25</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">Charlie</td>
<td align="left">35</td>
</tr>
</tbody></table>
<h4 id="存储方式对比"><a href="#存储方式对比" class="headerlink" title="存储方式对比"></a>存储方式对比</h4><ul>
<li><p><strong>行式存储（Row-based &#x2F; OLTP 常用）</strong><br>数据按行连续存放，一行的数据紧挨在一起。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[1, &#x27;Alice&#x27;, 30], [2, &#x27;Bob&#x27;, 25], [3, &#x27;Charlie&#x27;, 35]</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>列式存储（Column-based &#x2F; OLAP 常用）</strong><br>数据按列连续存放，同一列的所有数据紧挨在一起。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[1, 2, 3], [&#x27;Alice&#x27;, &#x27;Bob&#x27;, &#x27;Charlie&#x27;], [30, 25, 35]</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="1-2-为什么需要列式存储？（与行式对比）"><a href="#1-2-为什么需要列式存储？（与行式对比）" class="headerlink" title="1.2 为什么需要列式存储？（与行式对比）"></a>1.2 为什么需要列式存储？（与行式对比）</h3><table>
<thead>
<tr>
<th align="left">特性</th>
<th align="left">行式存储 (Row-based)</th>
<th align="left">列式存储 (Column-based)</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>适用场景</strong></td>
<td align="left">**OLTP (在线事务处理)**：频繁的增、删、改、查（通常按主键查整行）。例如：订单系统、银行交易。</td>
<td align="left">**OLAP (在线分析处理)**：海量数据的复杂查询、聚合、统计。例如：数据仓库、BI 报表。</td>
</tr>
<tr>
<td align="left"><strong>I&#x2F;O 特点</strong></td>
<td align="left"><strong>读取整行高效</strong>：一次 I&#x2F;O 即可获取一行所有数据。但查询若只涉及少数几列，会读取大量无关数据。</td>
<td align="left"><strong>读取少数列高效</strong>：只需读取查询所需列的数据，极大减少了 I&#x2F;O 量。这是 OLAP 场景性能提升的关键。</td>
</tr>
<tr>
<td align="left"><strong>压缩效率</strong></td>
<td align="left"><strong>较低</strong>：一行内数据类型各异（字符串、数字、日期），相似度低，难以高效压缩。</td>
<td align="left"><strong>极高</strong>：同一列数据类型相同、业务含义相似，数据重复度高，非常适合压缩。常用算法：字典编码、RLE、Delta 编码等。</td>
</tr>
</tbody></table>
<h3 id="1-3-为什么性能高？"><a href="#1-3-为什么性能高？" class="headerlink" title="1.3 为什么性能高？"></a>1.3 为什么性能高？</h3><p>列式存储的高性能主要源于以下三点：</p>
<ol>
<li><p><strong>最小化 I&#x2F;O</strong>：这是最核心的优势。对于分析类查询，如 <code>SELECT AVG(age) FROM users</code>，列式存储只需读取 <code>Age</code> 这一列的数据，而行式存储则必须扫描每一行的所有数据（包括 UserID 和 Name），I&#x2F;O 开销可能相差数十甚至数百倍。</p>
</li>
<li><p><strong>高压缩率</strong>：由于同列数据的高度同质性，可以实现非常高的压缩比。这意味着更少的磁盘空间占用和更低的 I&#x2F;O 带宽需求。数据从磁盘加载到内存的时间也相应减少。</p>
</li>
<li><p><strong>为向量化执行铺平道路</strong>：数据按列连续存放在内存中，这为 CPU 高效处理数据创造了完美条件。这种布局使得后续的向量化执行成为可能。</p>
</li>
</ol>
<h2 id="二、-向量化执行引擎（Vectorized-Execution-Engine）"><a href="#二、-向量化执行引擎（Vectorized-Execution-Engine）" class="headerlink" title="二、 向量化执行引擎（Vectorized Execution Engine）"></a>二、 向量化执行引擎（Vectorized Execution Engine）</h2><p>如果说列式存储解决了 <strong>I&#x2F;O 瓶颈</strong>，那么向量化执行则致力于解决 <strong>CPU 计算瓶颈</strong>。</p>
<h3 id="2-1-什么是向量化执行？"><a href="#2-1-什么是向量化执行？" class="headerlink" title="2.1 什么是向量化执行？"></a>2.1 什么是向量化执行？</h3><p><strong>向量化执行</strong>是一种数据处理模型，它<strong>一次处理一批数据（一个列的片段，称为“向量”或“批”）</strong>，而不是一次处理一行（Tuple-at-a-time）。</p>
<h4 id="执行模型对比：深入理解性能差异"><a href="#执行模型对比：深入理解性能差异" class="headerlink" title="执行模型对比：深入理解性能差异"></a>执行模型对比：深入理解性能差异</h4><p>要理解两种模型的根本区别，我们首先需要了解“<strong>查询计划树（Query Plan Tree）</strong>”。当数据库执行一条SQL时，会先生成一个由多个<strong>操作符（Operators）</strong>组成的执行蓝图，数据从树的叶子节点（如<code>Table Scan</code>）流向根节点（最终结果）。</p>
<pre class="mermaid">graph TD
    A[Aggregate] --> B[Filter]
    B --> C[Table Scan]
    
    subgraph 数据流向
        A
        B
        C
    end
    
    %% 显式定义子图内部的连接方向，提高兼容性
    A --> B
    B --> C</pre>

<p>现在，我们来看数据是如何在这棵树上流动的。</p>
<ul>
<li><p><strong>传统行式&#x2F;火山模型 (Tuple-at-a-time &#x2F; 零售模式)</strong><br>这是一个典型的“<strong>拉动（Pull-based）</strong>”模型，数据<strong>一次一行（一个元组）</strong>地在树中被“拉”着向上流动。</p>
<ol>
<li>顶层 <code>Aggregate</code> 操作符调用 <code>Filter.next()</code>，说：“给我下一行符合条件的数据”。</li>
<li><code>Filter</code> 操作符调用 <code>Table Scan.next()</code>，说：“给我下一行数据”。</li>
<li><code>Table Scan</code> 从表中读出<strong>一行</strong>数据，返回给 <code>Filter</code>。</li>
<li><code>Filter</code> 检查这一行是否满足条件。如果满足，就将这<strong>一行</strong>返回给 <code>Aggregate</code>；如果不满足，则回到第2步，继续向 <code>Table Scan</code> 要下一行。</li>
</ol>
<p>在这个模型中，<strong>处理每一行数据，都会触发一整条从上到下的方法调用链</strong>，控制流开销巨大。</p>
</li>
<li><p><strong>向量化执行模型 (Block-at-a-time &#x2F; 批发模式)</strong><br>向量化执行采用的也是“拉动”模型，但拉动的是<strong>“一次一块（Block-at-a-time）”</strong>数据。</p>
<blockquote>
<p>“一个块由固定的一组元组（记录）组成，它代表一组向量，这些向量和列 &#x2F; 字段有一一对应的关系。向量块是数据的基本单元，它经由执行计划树，从一个操作符流向另一个操作符。”</p>
</blockquote>
<ol>
<li>顶层 <code>Aggregate</code> 操作符调用 <code>Filter.nextBatch()</code>，说：“给我下一批符合条件的数据”。</li>
<li><code>Filter</code> 操作符调用 <code>Table Scan.nextBatch()</code>，说：“给我下一批数据”。</li>
<li><code>Table Scan</code> 从表中一次性读出<strong>一个数据块</strong>（例如1024行），形成一个 <code>ColumnarBatch</code>，返回给 <code>Filter</code>。</li>
<li><code>Filter</code> 对这<strong>一整块数据</strong>进行批量处理（例如使用掩码），生成一个新的、只包含符合条件数据的<strong>数据块</strong>，然后返回给 <code>Aggregate</code>。</li>
</ol>
<p>在这个模型中，方法调用的开销被<strong>均摊</strong>到了一个批次的上千行数据上，极大地降低了单位数据的处理成本。</p>
</li>
</ul>
<h4 id="为什么传统行式模型开销大？"><a href="#为什么传统行式模型开销大？" class="headerlink" title="为什么传统行式模型开销大？"></a>为什么传统行式模型开销大？</h4><p>看似简单的 <code>while</code> 循环背后，隐藏着巨大的性能开销：</p>
<ol>
<li><p><strong>大量的虚方法调用 (Virtual Function Calls)<strong>：在 Java 或 C++ 中，算子通常是接口或基类（如 <code>Operator</code>），<code>next()</code> 是一个虚方法。对于一个包含多个算子（扫描、过滤、投影、聚合）的复杂查询，</strong>处理每一行数据，都会触发一连串的虚方法调用</strong>。这会阻碍 JIT 编译器的内联优化，并导致高昂的动态分派开销。</p>
</li>
<li><p><strong>频繁的分支预测失败 (Branch Misprediction)<strong>：循环中的 <code>if</code> 条件（如 <code>WHERE amount &gt; 10</code>）会引入大量分支。现代 CPU 为了提高效率，会进行“分支预测”，提前执行它认为最可能的分支。如果数据分布不均（<code>amount &gt; 10</code> 的结果时真时假），CPU 就会频繁猜错。每次猜错，都会导致整个 CPU 流水线被清空和重建，这会</strong>浪费几十个甚至上百个 CPU 周期</strong>。</p>
</li>
<li><p>**缓存未命中 (Cache Miss)**：行式数据在内存中通常不是连续的（特别是包含变长字符串时），CPU 在处理数据时需要进行“指针追逐”，这会频繁导致缓存未命中，被迫从慢得多的主内存中读取数据。</p>
</li>
</ol>
<h3 id="2-2-核心概念解析：向量化如何战胜性能瓶颈"><a href="#2-2-核心概念解析：向量化如何战胜性能瓶颈" class="headerlink" title="2.2 核心概念解析：向量化如何战胜性能瓶颈"></a>2.2 核心概念解析：向量化如何战胜性能瓶颈</h3><p>向量化执行通过一系列精妙设计，完美地规避了上述问题。</p>
<h4 id="2-2-1-SIMD：用一条指令干多个人的活"><a href="#2-2-1-SIMD：用一条指令干多个人的活" class="headerlink" title="2.2.1 SIMD：用一条指令干多个人的活"></a>2.2.1 SIMD：用一条指令干多个人的活</h4><p>**SIMD (Single Instruction, Multiple Data)**，即“单指令，多数据”，是现代 CPU 提供的一种强大的并行计算能力。</p>
<ul>
<li><strong>是什么</strong>：它允许 CPU <strong>用一条指令同时对多个数据执行相同的操作</strong>。你可以把它想象成 CPU 内部的一条“流水线”，一次可以处理一整“托盘”的数据，而不是一个一个地处理。</li>
<li><strong>如何实现</strong>：CPU 内部有特殊的<strong>向量寄存器</strong>（如 128位的 SSE 寄存器、256位的 AVX 寄存器）。例如，一个 256 位的 AVX 寄存器可以一次性装入 <strong>8 个</strong> 32位整数，或 <strong>4 个</strong> 64位浮点数。CPU 的一条 SIMD 加法指令，就可以瞬间完成这 8 个整数对的相加。</li>
<li><strong>与向量化的关系</strong>：列式数据在内存中连续存放，完美契合了 SIMD 的工作模式。引擎可以直接将一个列向量（数组）的一部分加载到向量寄存器中，用 SIMD 指令进行计算，性能提升是数量级的。</li>
</ul>
<h4 id="2-2-2-掩码-位图：消灭-if-分支的艺术"><a href="#2-2-2-掩码-位图：消灭-if-分支的艺术" class="headerlink" title="2.2.2 掩码&#x2F;位图：消灭 if 分支的艺术"></a>2.2.2 掩码&#x2F;位图：消灭 <code>if</code> 分支的艺术</h4><p>为了避免分支预测失败带来的巨大成本，向量化引擎采用<strong>掩码（Mask）或位图（Bitmap）</strong>来处理条件逻辑，这是一种将“控制流依赖”转换为“数据流依赖”的技巧。</p>
<ul>
<li><p><strong>是什么</strong>：一个掩码&#x2F;位图就是一个布尔值数组或一个比特序列，用于记录一批数据中哪些行符合条件。</p>
</li>
<li><p><strong>如何实现</strong>：</p>
<ol>
<li><strong>生成掩码</strong>：不再使用 <code>if</code> 来逐个判断，而是执行一个向量化的比较操作，生成一个掩码。例如，对于 <code>amount &gt; 10</code>，引擎会一次性比较一批 <code>amount</code> 数据，生成一个类似 <code>[true, false, true, ...]</code> 的布尔掩码。</li>
<li><strong>应用掩码</strong>：后续的算子根据这个掩码来只处理有效的数据。例如，聚合算子会根据掩码，只累加那些对应位置为 <code>true</code> 的 <code>price</code> 值。</li>
</ol>
</li>
<li><p><strong>为什么性能高</strong>：</p>
<ul>
<li><strong>无分支</strong>：整个过程没有 <code>if</code> 跳转，CPU 流水线可以顺畅地执行，不会被打断。</li>
<li><strong>SIMD 友好</strong>：生成掩码和应用掩码的过程，本身也可以被 SIMD 指令高度优化。</li>
</ul>
</li>
</ul>
<h3 id="2-3-向量化引擎的设计原理"><a href="#2-3-向量化引擎的设计原理" class="headerlink" title="2.3 向量化引擎的设计原理"></a>2.3 向量化引擎的设计原理</h3><p>一个现代的向量化引擎通常包含以下关键设计：</p>
<h4 id="2-3-1-核心技术：字典编码与延迟物化"><a href="#2-3-1-核心技术：字典编码与延迟物化" class="headerlink" title="2.3.1 核心技术：字典编码与延迟物化"></a>2.3.1 核心技术：字典编码与延迟物化</h4><p>这两项技术通常结合使用，尤其是在处理字符串等变长、比较耗时的数据类型时。</p>
<ol>
<li><p><strong>字典编码 (Dictionary Encoding)</strong></p>
<ul>
<li><strong>是什么</strong>：一种高效的列压缩技术。它会扫描一列数据（如国家名称），为所有不重复的值创建一个“字典”，并用紧凑的整数ID来替换原始值。</li>
<li><strong>示例</strong>：<ul>
<li>原始列 <code>country</code>: <code>[&#39;美国&#39;, &#39;中国&#39;, &#39;美国&#39;, &#39;日本&#39;, &#39;中国&#39;]</code></li>
<li>字典: <code>&#123;0: &#39;美国&#39;, 1: &#39;中国&#39;, 2: &#39;日本&#39;&#125;</code></li>
<li>编码后的数据: <code>[0, 1, 0, 2, 1]</code></li>
</ul>
</li>
<li><strong>优势</strong>：极大减少了内存占用；更重要的是，将耗时的字符串比较&#x2F;哈希操作，转换成了极速的整数操作。</li>
</ul>
</li>
<li><p><strong>延迟物化 (Late Materialization)</strong></p>
<ul>
<li><strong>是什么</strong>：在整个查询执行过程中，尽可能地推迟将数据从其压缩或编码形式（如字典ID）转换回原始值的过程。</li>
<li><strong>示例</strong>：执行 <code>WHERE country = &#39;美国&#39;</code> 时，引擎首先将 <code>&#39;美国&#39;</code> 在字典中查询到其ID为 <code>0</code>。然后，它在编码后的整数数据 <code>[0, 1, 0, 2, 1]</code> 上执行 <code>ID == 0</code> 的过滤操作。这个过程完全是整数比较，速度极快。</li>
<li><strong>优势</strong>：只有在查询的最后一步，当需要向用户展示结果时，引擎才会根据ID（如 <code>0</code>）去字典里查找原始值（<code>&#39;美国&#39;</code>）。所有中间的过滤、聚合、关联操作都在高效的编码数据上完成，避免了对海量原始数据的昂贵操作。</li>
</ul>
</li>
</ol>
<h4 id="2-3-2-其他关键设计"><a href="#2-3-2-其他关键设计" class="headerlink" title="2.3.2 其他关键设计"></a>2.3.2 其他关键设计</h4><ul>
<li><p><strong>批处理模型（Batch Model）</strong></p>
<ul>
<li>数据以 <code>ColumnarBatch</code> 或 <code>RecordBatch</code> 的形式在算子间流动。一个 Batch 包含多列（<code>ColumnVector</code>），每列包含一批数据（如 1024 或 4096 行）。</li>
</ul>
</li>
<li><p><strong>标准列式内存格式（如 Apache Arrow）</strong></p>
<ul>
<li>为了实现高效的跨语言、跨进程数据交换（甚至是零拷贝），业界广泛采用 <strong>Apache Arrow</strong> 作为内存中的列式标准。</li>
</ul>
</li>
<li><p><strong>原生算子设计 (Native Operators)</strong></p>
<ul>
<li>所有的计算算子（如 Filter, Project, Aggregate, Join）都必须重新设计，使其能直接操作 <code>ColumnarBatch</code>。</li>
</ul>
</li>
</ul>
<h2 id="三、总结："><a href="#三、总结：" class="headerlink" title="三、总结："></a>三、总结：</h2><p><strong>列式存储</strong>和<strong>向量化执行</strong>是现代高性能分析引擎的两个核心支柱，它们相辅相成，缺一不可。</p>
<ul>
<li><strong>列式存储</strong>负责在宏观上（磁盘 I&#x2F;O）减少数据读取量，并提供一种对 CPU 缓存和 SIMD 友好的内存布局。</li>
<li><strong>向量化执行</strong>则在微观上（CPU 计算）充分利用这种数据布局，通过批处理、SIMD 指令、无分支计算和延迟物化等技术，将 CPU 的计算能力压榨到极致。</li>
</ul>
<p>正是这种从存储到计算的全链路优化，才使得像 Spark (with AQE)、StarRocks、ClickHouse 等现代数据系统能够实现惊人的查询性能。</p>
<hr>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ol>
<li><a target="_blank" rel="noopener" href="https://www.infoq.cn/article/columnar-databases-and-vectorization">《列式数据库和向量化》 - InfoQ</a></li>
<li><a target="_blank" rel="noopener" href="https://www.modb.pro/db/1721344266176389120">《向量化引擎怎么提升数据库性能》 - 墨天轮</a></li>
</ol>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">XR</div><div class="post-copyright__author_desc">一片叶、一朵云</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://example.com/2025/08/12/%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%E4%B8%8E%E5%90%91%E9%87%8F%E5%8C%96%E5%BC%95%E6%93%8E%E5%AD%A6%E4%B9%A0%E6%96%87%E6%A1%A3/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://example.com/2025/08/12/%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%E4%B8%8E%E5%90%91%E9%87%8F%E5%8C%96%E5%BC%95%E6%93%8E%E5%AD%A6%E4%B9%A0%E6%96%87%E6%A1%A3/')">深入理解列式存储与向量化引擎</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/kongxiaoran/image-repo/blog20241226231130275.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/kongxiaoran/image-repo/blog20241226231130275.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/kongxiaoran/image-repo/blog20241226231143327.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/kongxiaoran/image-repo/blog20241226231143327.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://example.com/2025/08/12/%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%E4%B8%8E%E5%90%91%E9%87%8F%E5%8C%96%E5%BC%95%E6%93%8E%E5%AD%A6%E4%B9%A0%E6%96%87%E6%A1%A3/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=深入理解列式存储与向量化引擎&amp;url=http://example.com/2025/08/12/%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%E4%B8%8E%E5%90%91%E9%87%8F%E5%8C%96%E5%BC%95%E6%93%8E%E5%AD%A6%E4%B9%A0%E6%96%87%E6%A1%A3/&amp;pic=https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/20250801164133928.png" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">凌霄的博客</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/%E5%AF%86%E7%A0%81%E5%AD%A6/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>密码学<span class="tagsPageCount">5</span></a><a class="post-meta__box__tags" href="/tags/%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>非对称加密<span class="tagsPageCount">3</span></a><a class="post-meta__box__tags" href="/tags/%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>数字签名<span class="tagsPageCount">4</span></a><a class="post-meta__box__tags" href="/tags/%E6%95%B0%E5%AD%97%E8%AF%81%E4%B9%A6/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>数字证书<span class="tagsPageCount">3</span></a><a class="post-meta__box__tags" href="/tags/CA/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>CA<span class="tagsPageCount">3</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/20250804092159955.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/08/10/Linux%20%E7%A3%81%E7%9B%98%E7%A9%BA%E9%97%B4%E5%BC%82%E5%B8%B8%E5%8D%A0%E7%94%A8%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E4%B8%8E%E8%A7%A3%E5%86%B3/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/20250804101048403.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Linux 磁盘空间异常占用排查：被删除文件仍被进程占用导致空间未释放</div></div></a></div><div class="next-post pull-right"><a href="/2025/08/18/HDFS-Kerberos%E8%AE%A4%E8%AF%81%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E6%96%87%E6%A1%A3/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/20250818155226461.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">HDFS Kerberos认证问题排查与解决</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2025/08/02/%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D%E4%B8%8E%E6%95%B0%E5%AD%97%E8%AF%81%E4%B9%A6%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/" title="数字签名与数字证书深度解析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/20250801164133928.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-08-02</div><div class="title">数字签名与数字证书深度解析</div></div></a></div><div><a href="/2025/08/03/%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D%E4%B8%8E%E8%AF%81%E4%B9%A6%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97/" title="数字签名与证书实战：使用OpenSSL亲手实验"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/20250803234800821.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-08-03</div><div class="title">数字签名与证书实战：使用OpenSSL亲手实验</div></div></a></div><div><a href="/2025/07/24/RSA_Explained/" title="深入理解RSA：加密与签名的艺术"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/0657f362c75db694f40e01dcca53753b.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-07-24</div><div class="title">深入理解RSA：加密与签名的艺术</div></div></a></div><div><a href="/2025/06/22/Argon2%E5%AF%86%E7%A0%81%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90%EF%BC%9A%E5%8E%9F%E7%90%86%E5%AE%9E%E7%8E%B0%E4%B8%8E%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8/" title="Argon2密码哈希算法深度解析：原理、实现与实战应用"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/20250624000019253.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-06-22</div><div class="title">Argon2密码哈希算法深度解析：原理、实现与实战应用</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">XR</h1><div class="author-info__desc">一片叶、一朵云</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/kongxiaoran" target="_blank" title="Github"></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%E4%B8%8E%E5%90%91%E9%87%8F%E5%8C%96%E5%BC%95%E6%93%8E"><span class="toc-number">1.</span> <span class="toc-text">深入理解列式存储与向量化引擎</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81-%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%EF%BC%88Columnar-Storage%EF%BC%89"><span class="toc-number">1.2.</span> <span class="toc-text">一、 列式存储（Columnar Storage）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E4%BB%80%E4%B9%88%E6%98%AF%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%EF%BC%9F"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.1 什么是列式存储？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E6%96%B9%E5%BC%8F%E5%AF%B9%E6%AF%94"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">存储方式对比</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%88%97%E5%BC%8F%E5%AD%98%E5%82%A8%EF%BC%9F%EF%BC%88%E4%B8%8E%E8%A1%8C%E5%BC%8F%E5%AF%B9%E6%AF%94%EF%BC%89"><span class="toc-number">1.2.2.</span> <span class="toc-text">1.2 为什么需要列式存储？（与行式对比）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E4%B8%BA%E4%BB%80%E4%B9%88%E6%80%A7%E8%83%BD%E9%AB%98%EF%BC%9F"><span class="toc-number">1.2.3.</span> <span class="toc-text">1.3 为什么性能高？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81-%E5%90%91%E9%87%8F%E5%8C%96%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%EF%BC%88Vectorized-Execution-Engine%EF%BC%89"><span class="toc-number">1.3.</span> <span class="toc-text">二、 向量化执行引擎（Vectorized Execution Engine）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E4%BB%80%E4%B9%88%E6%98%AF%E5%90%91%E9%87%8F%E5%8C%96%E6%89%A7%E8%A1%8C%EF%BC%9F"><span class="toc-number">1.3.1.</span> <span class="toc-text">2.1 什么是向量化执行？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E5%AF%B9%E6%AF%94%EF%BC%9A%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E6%80%A7%E8%83%BD%E5%B7%AE%E5%BC%82"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">执行模型对比：深入理解性能差异</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%A0%E7%BB%9F%E8%A1%8C%E5%BC%8F%E6%A8%A1%E5%9E%8B%E5%BC%80%E9%94%80%E5%A4%A7%EF%BC%9F"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">为什么传统行式模型开销大？</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E8%A7%A3%E6%9E%90%EF%BC%9A%E5%90%91%E9%87%8F%E5%8C%96%E5%A6%82%E4%BD%95%E6%88%98%E8%83%9C%E6%80%A7%E8%83%BD%E7%93%B6%E9%A2%88"><span class="toc-number">1.3.2.</span> <span class="toc-text">2.2 核心概念解析：向量化如何战胜性能瓶颈</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-SIMD%EF%BC%9A%E7%94%A8%E4%B8%80%E6%9D%A1%E6%8C%87%E4%BB%A4%E5%B9%B2%E5%A4%9A%E4%B8%AA%E4%BA%BA%E7%9A%84%E6%B4%BB"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">2.2.1 SIMD：用一条指令干多个人的活</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-%E6%8E%A9%E7%A0%81-%E4%BD%8D%E5%9B%BE%EF%BC%9A%E6%B6%88%E7%81%AD-if-%E5%88%86%E6%94%AF%E7%9A%84%E8%89%BA%E6%9C%AF"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">2.2.2 掩码&#x2F;位图：消灭 if 分支的艺术</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E5%90%91%E9%87%8F%E5%8C%96%E5%BC%95%E6%93%8E%E7%9A%84%E8%AE%BE%E8%AE%A1%E5%8E%9F%E7%90%86"><span class="toc-number">1.3.3.</span> <span class="toc-text">2.3 向量化引擎的设计原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-1-%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%EF%BC%9A%E5%AD%97%E5%85%B8%E7%BC%96%E7%A0%81%E4%B8%8E%E5%BB%B6%E8%BF%9F%E7%89%A9%E5%8C%96"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">2.3.1 核心技术：字典编码与延迟物化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-2-%E5%85%B6%E4%BB%96%E5%85%B3%E9%94%AE%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">2.3.2 其他关键设计</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%80%BB%E7%BB%93%EF%BC%9A"><span class="toc-number">1.4.</span> <span class="toc-text">三、总结：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">1.4.1.</span> <span class="toc-text">参考资料</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/09/13/%E4%B8%80%E7%AB%99%E5%BC%8F%E6%90%AD%E5%BB%BASpark-Hadoop%E9%9B%86%E7%BE%A4%E5%8F%8AZeppelin/" title="一站式搭建Spark-Hadoop集群及Zeppelin"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/20250804092159955.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="一站式搭建Spark-Hadoop集群及Zeppelin"/></a><div class="content"><a class="title" href="/2025/09/13/%E4%B8%80%E7%AB%99%E5%BC%8F%E6%90%AD%E5%BB%BASpark-Hadoop%E9%9B%86%E7%BE%A4%E5%8F%8AZeppelin/" title="一站式搭建Spark-Hadoop集群及Zeppelin">一站式搭建Spark-Hadoop集群及Zeppelin</a><time datetime="2025-09-13T09:00:00.000Z" title="发表于 2025-09-13 17:00:00">2025-09-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/11/Spark%E3%80%81Hadoop%E9%9B%86%E7%BE%A4%E5%8F%8AZeppelin%E7%9A%84%E9%95%9C%E5%83%8F%E5%85%B7%E4%BD%93%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B/" title="Spark、Hadoop集群及Zeppelin的镜像具体构建过程"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/20250804100847374.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Spark、Hadoop集群及Zeppelin的镜像具体构建过程"/></a><div class="content"><a class="title" href="/2025/09/11/Spark%E3%80%81Hadoop%E9%9B%86%E7%BE%A4%E5%8F%8AZeppelin%E7%9A%84%E9%95%9C%E5%83%8F%E5%85%B7%E4%BD%93%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B/" title="Spark、Hadoop集群及Zeppelin的镜像具体构建过程">Spark、Hadoop集群及Zeppelin的镜像具体构建过程</a><time datetime="2025-09-11T06:52:01.000Z" title="发表于 2025-09-11 14:52:01">2025-09-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/07/Zeppelin%20%E4%BD%BF%E7%94%A8%E4%BD%93%E9%AA%8C/" title="Zeppelin 使用体验"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/20250804092337513.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Zeppelin 使用体验"/></a><div class="content"><a class="title" href="/2025/09/07/Zeppelin%20%E4%BD%BF%E7%94%A8%E4%BD%93%E9%AA%8C/" title="Zeppelin 使用体验">Zeppelin 使用体验</a><time datetime="2025-09-07T14:00:00.000Z" title="发表于 2025-09-07 22:00:00">2025-09-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/08/30/%E5%AD%A6%E4%B9%A0Spark4.0%E6%BA%90%E7%A0%81%E3%80%901%E3%80%91%E2%80%94%E2%80%94%E4%B8%8B%E8%BD%BD%E5%B9%B6%E8%BF%90%E8%A1%8C%20spark,%E5%B9%B6%E8%BF%9B%E8%A1%8Cdebug%20/" title="学习Spark4.0源码【1】——下载并运行spark并进行debug"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/20250818155818848.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="学习Spark4.0源码【1】——下载并运行spark并进行debug"/></a><div class="content"><a class="title" href="/2025/08/30/%E5%AD%A6%E4%B9%A0Spark4.0%E6%BA%90%E7%A0%81%E3%80%901%E3%80%91%E2%80%94%E2%80%94%E4%B8%8B%E8%BD%BD%E5%B9%B6%E8%BF%90%E8%A1%8C%20spark,%E5%B9%B6%E8%BF%9B%E8%A1%8Cdebug%20/" title="学习Spark4.0源码【1】——下载并运行spark并进行debug">学习Spark4.0源码【1】——下载并运行spark并进行debug</a><time datetime="2025-08-30T06:00:00.000Z" title="发表于 2025-08-30 14:00:00">2025-08-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/08/18/HDFS-Kerberos%E8%AE%A4%E8%AF%81%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E6%96%87%E6%A1%A3/" title="HDFS Kerberos认证问题排查与解决"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://raw.githubusercontent.com/kongxiaoran/image-repo/main/blog/20250818155226461.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="HDFS Kerberos认证问题排查与解决"/></a><div class="content"><a class="title" href="/2025/08/18/HDFS-Kerberos%E8%AE%A4%E8%AF%81%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E6%96%87%E6%A1%A3/" title="HDFS Kerberos认证问题排查与解决">HDFS Kerberos认证问题排查与解决</a><time datetime="2025-08-18T11:00:00.000Z" title="发表于 2025-08-18 19:00:00">2025-08-18</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2024 - 2025 By <a class="footer-bar-link" href="/" title="XR" target="_blank">XR</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">61</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">87</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">7</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Argon2/" style="font-size: 0.88rem;">Argon2<sup>1</sup></a><a href="/tags/DNS/" style="font-size: 0.88rem;">DNS<sup>2</sup></a><a href="/tags/HBase/" style="font-size: 0.88rem;">HBase<sup>1</sup></a><a href="/tags/HDFS/" style="font-size: 0.88rem;">HDFS<sup>4</sup></a><a href="/tags/HTTP/" style="font-size: 0.88rem;">HTTP<sup>1</sup></a><a href="/tags/Hadoop/" style="font-size: 0.88rem;">Hadoop<sup>4</sup></a><a href="/tags/Hive/" style="font-size: 0.88rem;">Hive<sup>1</sup></a><a href="/tags/HyperEnclave/" style="font-size: 0.88rem;">HyperEnclave<sup>5</sup></a><a href="/tags/Java/" style="font-size: 0.88rem;">Java<sup>8</sup></a><a href="/tags/Kubernetes/" style="font-size: 0.88rem;">Kubernetes<sup>1</sup></a><a href="/tags/Linux/" style="font-size: 0.88rem;">Linux<sup>5</sup></a><a href="/tags/Maven/" style="font-size: 0.88rem;">Maven<sup>1</sup></a><a href="/tags/RDD/" style="font-size: 0.88rem;">RDD<sup>2</sup></a><a href="/tags/SGX/" style="font-size: 0.88rem;">SGX<sup>2</sup></a><a href="/tags/Shuffle%E6%9C%BA%E5%88%B6/" style="font-size: 0.88rem;">Shuffle机制<sup>1</sup></a><a href="/tags/Spark/" style="font-size: 0.88rem;">Spark<sup>10</sup></a><a href="/tags/Spring/" style="font-size: 0.88rem;">Spring<sup>3</sup></a><a href="/tags/TDX/" style="font-size: 0.88rem;">TDX<sup>2</sup></a><a href="/tags/TEE/" style="font-size: 0.88rem;">TEE<sup>9</sup></a><a href="/tags/TME/" style="font-size: 0.88rem;">TME<sup>2</sup></a><a href="/tags/YARN/" style="font-size: 0.88rem;">YARN<sup>1</sup></a><a href="/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/" style="font-size: 0.88rem;">云原生<sup>1</sup></a><a href="/tags/%E4%BB%A3%E7%90%86/" style="font-size: 0.88rem;">代理<sup>1</sup></a><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/" style="font-size: 0.88rem;">分布式存储<sup>2</sup></a><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%A1%E7%AE%97/" style="font-size: 0.88rem;">分布式计算<sup>3</sup></a><a href="/tags/%E5%9C%B0%E7%90%86%E4%BD%8D%E7%BD%AE%E9%99%90%E5%88%B6/" style="font-size: 0.88rem;">地理位置限制<sup>1</sup></a><a href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/" style="font-size: 0.88rem;">大数据<sup>6</sup></a><a href="/tags/%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF/" style="font-size: 0.88rem;">学习路线<sup>1</sup></a><a href="/tags/%E5%AE%89%E5%85%A8/" style="font-size: 0.88rem;">安全<sup>2</sup></a><a href="/tags/%E5%AF%86%E7%A0%81%E5%93%88%E5%B8%8C/" style="font-size: 0.88rem;">密码哈希<sup>1</sup></a><a href="/tags/%E5%AF%86%E7%A0%81%E5%AD%A6/" style="font-size: 0.88rem;">密码学<sup>5</sup></a><a href="/tags/%E6%8A%80%E6%9C%AF%E4%B8%93%E6%A0%8F/" style="font-size: 0.88rem;">技术专栏<sup>1</sup></a><a href="/tags/%E6%9C%BA%E5%AF%86%E8%AE%A1%E7%AE%97/" style="font-size: 0.88rem;">机密计算<sup>2</sup></a><a href="/tags/%E6%B5%81%E5%AA%92%E4%BD%93%E8%A7%A3%E9%94%81/" style="font-size: 0.88rem;">流媒体解锁<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 0.88rem;">网络<sup>4</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C%E5%88%86%E6%9E%90/" style="font-size: 0.88rem;">网络分析<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" style="font-size: 0.88rem;">网络安全<sup>1</sup></a><a href="/tags/%E9%98%B2%E7%81%AB%E5%A2%99/" style="font-size: 0.88rem;">防火墙<sup>2</sup></a><a href="/tags/%E9%9A%90%E7%A7%81%E8%AE%A1%E7%AE%97/" style="font-size: 0.88rem;">隐私计算<sup>3</sup></a><a href="/tags/%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84/" style="font-size: 0.88rem;">集群架构<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("12/26/2024 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2024 By 安知鱼 V1.6.14",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 XR 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaid.length === 0) return
  const runMermaid = () => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    Array.from($mermaid).forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
      const mermaidID = 'mermaid-' + index
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)

      const renderV10 = () => {
        renderFn.then(({svg}) => {
          mermaidSrc.insertAdjacentHTML('afterend', svg)
        })
      }

      const renderV9 = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      typeof renderFn === 'string' ? renderV9(renderFn) : renderV10()
    })
  }

  const loadMermaid = () => {
    window.loadMermaid ? runMermaid() : getScript('https://cdn.cbd.int/mermaid@10.2.4/dist/mermaid.min.js').then(runMermaid)
  }

  anzhiyu.addGlobalFn('themeChange', runMermaid, 'mermaid')

  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'cbSQtAqs68yENzUQ5wpQK826-MdYXbMMI',
      appKey: 'MR93sqmbPdh7Zm1bZzjXNvlm',
      avatar: 'mp',
      serverURLs: 'https://cbsqtaqs.api.lncldglobal.com',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.cbd.int/valine@1.5.1/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script src="https://cdn.cbd.int/blueimp-md5@2.19.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=mp'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://cbsqtaqs.api.lncldglobal.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": 'cbSQtAqs68yENzUQ5wpQK826-MdYXbMMI',
        "X-LC-Key": 'MR93sqmbPdh7Zm1bZzjXNvlm',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>